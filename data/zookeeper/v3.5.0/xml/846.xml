<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:50:40 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-846/ZOOKEEPER-846.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-846] zookeeper client doesn&apos;t shut down cleanly on the close call</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-846</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Using HBase 0.20.6 (with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2473&quot; title=&quot;Add to admin create table start and end key params and desired number of regions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2473&quot;&gt;&lt;del&gt;HBASE-2473&lt;/del&gt;&lt;/a&gt;) we encountered a situation where Regionserver&lt;br/&gt;
process was shutting down and seemed to hang.&lt;/p&gt;

&lt;p&gt;Here is the bottom of region server log:&lt;br/&gt;
&lt;a href=&quot;http://pastebin.com/YYawJ4jA&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://pastebin.com/YYawJ4jA&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;zookeeper-3.2.2 is used.&lt;/p&gt;

&lt;p&gt;Here is relevant portion from jstack - I attempted to attach jstack twice in my email to dev@hbase.apache.org but failed:&lt;/p&gt;

&lt;p&gt;&quot;DestroyJavaVM&quot; prio=10 tid=0x00002aabb849c800 nid=0x6c60 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000000000000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;/p&gt;

&lt;p&gt;&quot;regionserver/10.32.42.245:60020&quot; prio=10 tid=0x00002aabb84ce000 nid=0x6c81 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000043755000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x00002aaab76633c0&amp;gt; (a org.apache.zookeeper.ClientCnxn$Packet)&lt;br/&gt;
        at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1099)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaab76633c0&amp;gt; (a org.apache.zookeeper.ClientCnxn$Packet)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn.close(ClientCnxn.java:1077)&lt;br/&gt;
        at org.apache.zookeeper.ZooKeeper.close(ZooKeeper.java:505)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaabf5e0c30&amp;gt; (a org.apache.zookeeper.ZooKeeper)&lt;br/&gt;
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.close(ZooKeeperWrapper.java:681)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:654)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;main-EventThread&quot; daemon prio=10 tid=0x0000000043474000 nid=0x6c80 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00000000413f3000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (parking)&lt;br/&gt;
        at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x00002aaabf6e9150&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)&lt;br/&gt;
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
        at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:414)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12471442">ZOOKEEPER-846</key>
            <summary>zookeeper client doesn&apos;t shut down cleanly on the close call</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="phunt">Patrick Hunt</assignee>
                                    <reporter username="ted_yu">Ted Yu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Aug 2010 18:19:53 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:15 +0000</updated>
                            <resolved>Wed, 22 Sep 2010 07:39:00 +0100</resolved>
                                    <version>3.2.2</version>
                                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>java client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12897847" author="ted_yu" created="Thu, 12 Aug 2010 18:22:10 +0100"  >&lt;p&gt;jstack for Region Server&lt;/p&gt;</comment>
                            <comment id="12903843" author="mahadev" created="Sat, 28 Aug 2010 17:25:50 +0100"  >&lt;p&gt;We should fix this in 3.3.2 if this still exists.&lt;/p&gt;</comment>
                            <comment id="12907396" author="phunt" created="Wed, 8 Sep 2010 21:11:07 +0100"  >&lt;p&gt;might be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2966&quot; title=&quot;HBase client stuck on org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1278) holding regionLockObject lock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2966&quot;&gt;&lt;del&gt;HBASE-2966&lt;/del&gt;&lt;/a&gt;, upping priority&lt;/p&gt;</comment>
                            <comment id="12907523" author="phunt" created="Thu, 9 Sep 2010 06:28:33 +0100"  >&lt;p&gt;I believe I found the issue. Both this specific jira and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2966&quot; title=&quot;HBase client stuck on org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1278) holding regionLockObject lock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2966&quot;&gt;&lt;del&gt;HBASE-2966&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;During session close we set the &quot;closing&quot; flag, then later set the ZK state to CLOSED. zk client operations track outstanding&lt;br/&gt;
requests to the server on the &quot;outstandingqueue&quot;. There&apos;s a timing window where we can clear the outstanding&lt;br/&gt;
queue (caused by the &quot;closing&quot; flag being set AND an error occurs on the socket) and exit the sendthread.  Subsequent &lt;br/&gt;
to this if an operation runs before the ZK state is set to CLOSED it will queue additional packets to the outstandingqueue. &lt;br/&gt;
These packets will never be processed, and as a result the original operation will never complete.&lt;/p&gt;

&lt;p&gt;in queuepacket we need to check if closing is set before queueing a packet (we currently check the state only)&lt;/p&gt;

&lt;p&gt;I&apos;m working on a test/fix.&lt;/p&gt;</comment>
                            <comment id="12907541" author="thkoch" created="Thu, 9 Sep 2010 08:07:29 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-126&quot; title=&quot;zookeeper client close operation may block indefinitely&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-126&quot;&gt;ZOOKEEPER-126&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-846&quot; title=&quot;zookeeper client doesn&amp;#39;t shut down cleanly on the close call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-846&quot;&gt;&lt;del&gt;ZOOKEEPER-846&lt;/del&gt;&lt;/a&gt; both have the same cause.&lt;/p&gt;</comment>
                            <comment id="12909014" author="phunt" created="Mon, 13 Sep 2010 22:53:11 +0100"  >&lt;p&gt;This patch fixes the problem by adding a check for close in queuepacket.&lt;/p&gt;

&lt;p&gt;Note that this also moves the close=true into queuepacket (otw the closeSession would never be queued during a close.&lt;/p&gt;

&lt;p&gt;I spend &amp;gt; 1 day trying to craft a test for this, unfortunately due to the small size of the timing window I wasn&apos;t able to get a test that failed with this case. However by inspection it seems to address a clear bug. All tests are passing.&lt;/p&gt;</comment>
                            <comment id="12909634" author="hadoopqa" created="Wed, 15 Sep 2010 08:19:17 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12454491/ZOOKEEPER-846.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12454491/ZOOKEEPER-846.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 997192.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no tests are needed for this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/111/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/111/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/111/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/111/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/111/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/111/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12910018" author="breed" created="Thu, 16 Sep 2010 06:31:18 +0100"  >&lt;p&gt;+1 looks good pat! it&apos;s nice that the checking and setting of closing is in the same routine. i agreed about skipping the test case.&lt;/p&gt;</comment>
                            <comment id="12913422" author="phunt" created="Wed, 22 Sep 2010 07:40:01 +0100"  >&lt;p&gt;committed to trunk and branch33&lt;/p&gt;</comment>
                            <comment id="12913497" author="hudson" created="Wed, 22 Sep 2010 11:51:28 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #944 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/944/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/944/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-846&quot; title=&quot;zookeeper client doesn&amp;#39;t shut down cleanly on the close call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-846&quot;&gt;&lt;del&gt;ZOOKEEPER-846&lt;/del&gt;&lt;/a&gt;. zookeeper client doesn&apos;t shut down cleanly on the close call&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12403118">ZOOKEEPER-126</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12473529">HBASE-2966</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12454491" name="ZOOKEEPER-846.patch" size="1149" author="phunt" created="Mon, 13 Sep 2010 22:53:11 +0100"/>
                            <attachment id="12451927" name="rs-13.stack" size="9939" author="ted_yu" created="Thu, 12 Aug 2010 18:22:10 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 28 Aug 2010 16:25:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47577</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzu13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32849</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>