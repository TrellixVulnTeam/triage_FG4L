<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:47:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-464/ZOOKEEPER-464.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-464] Need procedure to garbage collect ledgers</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-464</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;An application using BookKeeper is likely to use a large number of ledgers over time. Such an application might not need all ledgers created over time and might want to delete some of these ledgers to free up some space on bookies. The idea of this jira is to implement a procedure that enables an application to garbage-collect unwanted ledgers.&lt;/p&gt;

&lt;p&gt;To garbage-collect a ledger, we need to delete the ledger metadata on ZooKeeper, and delete the ledger data on corresponding bookies. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12430279">ZOOKEEPER-464</key>
            <summary>Need procedure to garbage collect ledgers</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="erwin.tam">Erwin Tam</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Jul 2009 21:20:34 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:04 +0000</updated>
                            <resolved>Thu, 13 May 2010 21:24:49 +0100</resolved>
                                                    <fixVersion>3.4.0</fixVersion>
                                    <component>contrib-bookkeeper</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12848401" author="erwin.tam" created="Mon, 22 Mar 2010 22:26:50 +0000"  >&lt;p&gt;I&apos;m working on this enhancement now and just about ready to submit this as a patch.  Will see if Ben wants to review my changes first beforehand.&lt;/p&gt;</comment>
                            <comment id="12848934" author="erwin.tam" created="Tue, 23 Mar 2010 22:19:41 +0000"  >&lt;p&gt;Uploaded a patch for BK ledger deletes.  Could use more unit tests perhaps.  Known issues are with using the BufferedChannel currently when reading in the ledgers that make up the entry log files.  If the BufferedChannel is created for an already existing entry log file we want to read from (but not write to), it results in an infinite loop.&lt;/p&gt;</comment>
                            <comment id="12848950" author="hadoopqa" created="Tue, 23 Mar 2010 22:54:38 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12439615/ZOOKEEPER-464.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12439615/ZOOKEEPER-464.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 925362.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    -1 release audit.  The applied patch generated 26 release audit warnings (more than the trunk&apos;s current 24 warnings).&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/testReport/&lt;/a&gt;&lt;br/&gt;
Release audit warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/artifact/trunk/patchprocess/releaseAuditDiffWarnings.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/artifact/trunk/patchprocess/releaseAuditDiffWarnings.txt&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/37/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12849113" author="fpj" created="Wed, 24 Mar 2010 09:07:59 +0000"  >&lt;p&gt;This is great, Erwin! A few high-level comments:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Could you summarize the changes of this patch? For example, it would be nice to summarize how the garbage collector behaves with respect to removing entry logs;&lt;/li&gt;
	&lt;li&gt;The license text is missing in LedgerDeleteTest.java. That&apos;s why your patch got a -1 in release audits;&lt;/li&gt;
	&lt;li&gt;Could you detail the issue with BufferedChannel? Where is the problem exactly? Why can&apos;t we fix it?&lt;/li&gt;
	&lt;li&gt;We need documentation for these features. If we don&apos;t do it in this patch, then we need to open another jira and make sure that the documentation makes it to the same release as this patch. Right now it sounds like this feature will go into 3.4.0.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="12849421" author="erwin.tam" created="Wed, 24 Mar 2010 20:44:42 +0000"  >&lt;p&gt;Thanks for the feedback Flavio!&lt;br/&gt;
1. Where should I put the summary of the behavior?  What about documentation of this feature?  It does require changes to how you set up Bookie Servers (need to pass in the ZK servers list).  Should I put that in comments for this Jira?  Should I upload a text documentation too to describe the feature functionality?&lt;br/&gt;
2. I&apos;ll add the missing license text.  Forgot that I need that for new files.&lt;br/&gt;
3. I have a fix for the BufferedChannel issue and it can be done either in the BufferedChannel code or outside it from the callers.  The problem is when it is created on an existing File.  The FileChannels passed to the constructor need to set their position to the end of the file.  Otherwise, the write buffer&apos;s start position will default to 0, the start of the file.  That screws things up when you try to read from it.  This bug should already exist if you start up the Bookies with already existing entry logs and you try to read entries from there.  I don&apos;t think there are any unit tests that test that specifically.&lt;/p&gt;</comment>
                            <comment id="12849948" author="erwin.tam" created="Thu, 25 Mar 2010 23:34:26 +0000"  >&lt;p&gt;Revised patch for the entry log garbage collecting feature.  Description on a high level for how this works is included here. Only the major files modified will be listed.&lt;/p&gt;

&lt;p&gt;1. Client changes:&lt;br/&gt;
BookKeeper.java&lt;br/&gt;
LedgerDeleteOp.java&lt;br/&gt;
AsyncCallback.java&lt;/p&gt;

&lt;p&gt;Added BK client methods to delete a ledger, both synchronously and asynchronously.  Deleting a ledger from the client side is to just remove the ZK ledger metadata node for it (in the /ledgers/L&amp;lt;ledger id&amp;gt; path).&lt;/p&gt;

&lt;p&gt;2. Bookie Server changes:&lt;br/&gt;
EntryLogger.java&lt;br/&gt;
LedgerCache.java&lt;br/&gt;
Bookie.java&lt;/p&gt;

&lt;p&gt;BK servers now are also ZK clients so they can query ZK for the existing ledger nodes to see what the current active set of ledgers are.  Bookies when initialized will create the ZK client instance and register an ephemeral node in ZK for the server.  &lt;/p&gt;

&lt;p&gt;EntryLogger when initialized will try to extract all of the ledgers that make up the already existing entry logs (if any). We do not extract ledgers from the current active entry log that we are writing into since this will never be deleted.  When entry logs roll over, that&apos;s when we will read through old entry logs and extract the set of ledgers that make up all of the entries in the entry log (if it hasn&apos;t been done already).  This data is stored in memory as a mapping from entry log ID&apos;s to the set of ledger ID&apos;s that comprise them.  &lt;/p&gt;

&lt;p&gt;LedgerCache when initialized will read through all of the existing ledger index files (if any) and store them in memory as the set of active ledgers that the Bookie Server knows about.  When a new ledger index file is created (new ledger), we will add that to this in memory set mapping.&lt;/p&gt;

&lt;p&gt;The EntryLogger contains the Garbage Collector thread which runs periodically.  This first syncs with ZK, then reads the set of current active ledgers.  It compares this to the Bookie Server&apos;s LedgerCache&apos;s set of active ledgers that the Bookie Server knows about.  If there are any in that set but not in ZK, these are removed.  Then we loop though all of the older entry logs (other than the one we&apos;re writing into), see which ledgers make the entry log.  If any of those ledgers are deleted, we remove it from the entry log&apos;s ledgers set.  If any of these entry logs have no more active ledgers associated with them, then we delete the entry log.&lt;/p&gt;

&lt;p&gt;3. Unit tests:&lt;br/&gt;
LedgerDeleteTest.java&lt;br/&gt;
New unit test to test out entry logs being garbage collected. This test will write enough ledger entries to roll over the first entry log.  Then the ledgers are deleted from the client side and the BK server&apos;s garbage collecting thread will pick up these changes and delete the entry log file(s).  Two variations of this test for the initial case when the BK servers start up with no existing entry logs and a second where entry logs already exist.&lt;/p&gt;</comment>
                            <comment id="12852298" author="fpj" created="Thu, 1 Apr 2010 10:11:18 +0100"  >&lt;p&gt;Hi Erwin, It looks mostly fine. Here are a few suggestions and requests:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;When you upload a new patch, please don&apos;t delete the previous one. Also, I can&apos;t remember if we cancelled and re-summitted, but every time we submit a new version of the patch, we need to cancel the previous patch in the workflow, upload the new patch, and then submit again. This is to make sure that Hudson tests the patch.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;For documentation, the source files are under src/docs/src/documentation/content/xdocs. They are xml files that we compile with forrest to generate the documentation we have on the Web. If you can&apos;t figure out how to change the doc files and compile, then please open a jira and list the necessary modifications. It took me a while to get used to forrest, so don&apos;t worry too much if you can get it to work.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In LedgerDeleteTest, I would suggest to replace this excerpt of code:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (f.isFile() &amp;amp;&amp;amp; f.getName().equals(&quot;0.log&quot;)) {
    LOG.error(&quot;Found the entry log file (0.log) that should have been deleted in ledgerDirectory: &quot;
                            + ledgerDirectory);
    // This test has failed since we have found the entry Log
    // file that should have been deleted.
    assertTrue(false);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;assertFalse(f.isFile() &amp;amp;&amp;amp; f.getName().equals(&quot;0.log&quot;), &quot;Found the entry log file (0.log) that should have been deleted in ledgerDirectory: &quot; + ledgerDirectory);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe it is more compact and does the same, doesn&apos;t it?&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I&apos;d like to ask you to add javadocs to the new methods. I&apos;ve seen several new methods that have comments right before the method declaration using &quot;//&quot;. Also, please review the text of the methods as you change the syntax to javadoc as some of them do not parse correctly.&lt;/li&gt;
	&lt;li&gt;Doesn&apos;t access to the following data structures in LedgerCache.deleteLedger() need to be synchronized:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	
fileInfoCache
cleanLedgers
dirtyLedgers
openLedgers
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12852527" author="erwin.tam" created="Thu, 1 Apr 2010 21:10:38 +0100"  >&lt;p&gt;Thanks Flavio for the feedback!  I&apos;ll make the changes you suggested and will upload a new patch (without deleting the old one).  I&apos;ll bug Ben about the forrest xml documentation if I can&apos;t figure it out.&lt;/p&gt;</comment>
                            <comment id="12852972" author="erwin.tam" created="Fri, 2 Apr 2010 23:14:50 +0100"  >&lt;p&gt;Updated patch incorporating the feedback from Flavio.  Note that the documentation changes haven&apos;t been done yet here.  I might open a separate Jira for that once I figure out the forrest xml stuff.&lt;/p&gt;</comment>
                            <comment id="12853547" author="hadoopqa" created="Mon, 5 Apr 2010 22:31:53 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12440653/ZOOKEEPER-464.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12440653/ZOOKEEPER-464.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 929564.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/47/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/47/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/47/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/47/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/47/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/47/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12854031" author="fpj" created="Tue, 6 Apr 2010 17:00:07 +0100"  >&lt;p&gt;Hi Erwin, I still see several comments preceding new methods that we need to put in javadoc format. A more serious issue is that LedgerDeleteTest failed for me. I&apos;m attaching the output log. It essentially crashed because it ran out of heap space.&lt;/p&gt;</comment>
                            <comment id="12854123" author="erwin.tam" created="Tue, 6 Apr 2010 19:57:41 +0100"  >&lt;p&gt;Thanks Flavio.  I noticed that heap space problem intermittently too when running the junit tests.  It comes about  when we&apos;re reading through the entry logs but the format is off so the 4 byte entry length field is way too big.  We then try to allocate a huge buffer to read the entry from but something was mismatched already.  I noticed at times when running tests with small entry logs that the &quot;BKLO&quot; header doesn&apos;t get appended to it at times.  That would definitely screw things up when reading through it.  I&apos;ll see if I can reproduce this problem with the current configs in the tests and maybe exit more gracefully instead of allocating a huge amount of heap space for the buffers to read.  Obviously something must have been wrong when reading the entry log files.  I&apos;m not sure why this problem only shows up a small percentage of the time.&lt;/p&gt;

&lt;p&gt;Could you let me know which files still have the comments preceding new methods?  I thought I took this out already in the modified files but I must have missed some.&lt;/p&gt;

&lt;p&gt;With regards to the documentation changes, do you generally modify the xml content document files, use forest to generate the html and pdf files and then check in all 3 changes in the jira attachment?  Or is it just the xml changes you submit via the jira?  Can I submit another file attachment to this same jira for the documentation changes?  Can you merge the changes there with the code changes in the already submitted patch?  Thanks!&lt;/p&gt;</comment>
                            <comment id="12854985" author="erwin.tam" created="Thu, 8 Apr 2010 17:35:49 +0100"  >&lt;p&gt;Updated patch with documentation changes and fix so the unit tests for ledger deletes won&apos;t error out intermittently. The problem was a bug in the EntryLogger where the &quot;BKLO&quot; ByteBuffer header that is prepended to each entry log was defined as a static object.  If multiple Bookies within the JVM are running, a race condition can occur if they are rolling over entry logs and accessing this header at the same time.  The end result is, some entry logs are created without the header and that screws the entry log ledger extraction.&lt;/p&gt;

&lt;p&gt;All new methods should have proper javadoc comments before them now too.&lt;/p&gt;</comment>
                            <comment id="12854986" author="erwin.tam" created="Thu, 8 Apr 2010 17:36:25 +0100"  >&lt;p&gt;Latest version of the patch with documentation changes and fixes for some intermittent junit test errors.&lt;/p&gt;</comment>
                            <comment id="12855005" author="hadoopqa" created="Thu, 8 Apr 2010 17:58:52 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12441169/ZOOKEEPER-464.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12441169/ZOOKEEPER-464.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 929564.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/49/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/49/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/49/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/49/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/49/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/49/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12855117" author="fpj" created="Thu, 8 Apr 2010 20:51:32 +0100"  >&lt;p&gt;Thanks for the new patch, Erwin. Could you please tell me how you&apos;ve fixed the issue with the unit test?&lt;/p&gt;</comment>
                            <comment id="12855158" author="erwin.tam" created="Thu, 8 Apr 2010 22:19:25 +0100"  >&lt;p&gt;Flavio, my comments a couple of entries above talks about the EntryLogger&apos;s &quot;BKLO&quot; header that was causing the problem.  That was creating the issue in the junit test making it fail intermittently.  I sent you and Ben an email about this fix too in more detail but we could talk about it more if you want. Thanks!&lt;/p&gt;</comment>
                            <comment id="12855183" author="erwin.tam" created="Thu, 8 Apr 2010 23:06:33 +0100"  >&lt;p&gt;There was an intermittent problem with the ledger delete junit tests prior to the last patch uploaded (which resolved it).  I&apos;ll document the bug and the fix for that here.&lt;/p&gt;

&lt;p&gt;The ledger delete junit tests were failing intermittently and it was related to an issue I saw earlier when I was running unit tests with a very small entry log limit size (2K).  When the entry logs roll over, we create a new one by first writing the &quot;BKLO&quot; 1024 byte header to the beginning of the file.  The problem is, this byte buffer object is statically defined.  In our junit tests, we have multiple Bookie servers (and thus EntryLogger instances) in the same jvm.  If more than one EntryLogger is rolling over its current log and writing the next one, they are accessing the same entryLog file header buffer.  This creates problems since the static header isn&apos;t accessed in a synchronized way.  &lt;/p&gt;

&lt;p&gt;This header byte buffer is cleared first before writing it to the log file. Since it is static, one thread could clear it first, then another thread (from a second Bookie server) clears it at the same time. The first thread writes the header but when it is done, the header&apos;s byte buffer&apos;s internal pointers have it pointing to the end and aren&apos;t reset.  The second thread will then be reading the header buffer that has not been cleared/reset.  What ends up happening is the entry logs in the second Bookie are created without the header.  When we&apos;re reading through those files later on to figure out which ledgers make it up, it&apos;ll read incorrect values and try to allocate byte buffers based on an incorrect length segment (basically reading in junk random bytes).  This creates the java heap space error.&lt;/p&gt;

&lt;p&gt;The fix is simple and is to just make this logfile header a non-static variable, initializing it in the EntryLogger constructor.  In practice, we shouldn&apos;t be running multiple Bookies within the same jvm so we wouldn&apos;t run into this problem.&lt;/p&gt;</comment>
                            <comment id="12860970" author="fpj" created="Mon, 26 Apr 2010 17:06:34 +0100"  >&lt;p&gt;Hi Erwin, Sorry about the delay to review it. I think this patch is pretty much ready to get in. I have just a couple of tiny requests:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;I noticed that the two commands you modified in the documentation (bookkeeperStated.xml and bookkeeperConfig.xml) are going over the paper margin for the generated pdfs. Could you please break up the lines?&lt;/li&gt;
	&lt;li&gt;In LedgerDeleteTest, you&apos;re using &quot;//&quot; for multi-line comments. I believe we have been using &quot;/**/&quot; instead. This is just to keep it consistent with comments in other parts of the code.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Otherwise, it looks good.  If you fix these two things, then I think we will be able to get it in shortly after.&lt;/p&gt;</comment>
                            <comment id="12861116" author="erwin.tam" created="Mon, 26 Apr 2010 22:21:13 +0100"  >&lt;p&gt;Updated patch with formatting changes requested.&lt;/p&gt;</comment>
                            <comment id="12861117" author="erwin.tam" created="Mon, 26 Apr 2010 22:22:34 +0100"  >&lt;p&gt;Uploaded a new patch with the formatting changes.  Note that the generated pdf&apos;s previously already had the issue with a line going beyond the paper margin.  I modified this but let me know if it isn&apos;t done correctly.&lt;/p&gt;</comment>
                            <comment id="12861135" author="hadoopqa" created="Mon, 26 Apr 2010 23:00:57 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12442901/ZOOKEEPER-464.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12442901/ZOOKEEPER-464.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 938212.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/74/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/74/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/74/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/74/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/74/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/74/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12867106" author="fpj" created="Thu, 13 May 2010 11:43:22 +0100"  >&lt;p&gt;+1, this patch is ready to get in. Great job, Erwin! I&apos;ll be committing it shortly.&lt;/p&gt;</comment>
                            <comment id="12867239" author="fpj" created="Thu, 13 May 2010 21:24:49 +0100"  >&lt;p&gt;Committed revision 944003. Thanks, Erwin!&lt;/p&gt;</comment>
                            <comment id="12867431" author="fpj" created="Fri, 14 May 2010 08:05:29 +0100"  >&lt;p&gt;Erwin pointed out that I forgot to add two new files, so here they are: Committed revision 944140.&lt;/p&gt;</comment>
                            <comment id="12874194" author="hudson" created="Tue, 1 Jun 2010 20:39:04 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #831 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/831/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/831/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12442901" name="ZOOKEEPER-464.patch" size="45608" author="erwin.tam" created="Mon, 26 Apr 2010 22:21:12 +0100"/>
                            <attachment id="12441169" name="ZOOKEEPER-464.patch" size="44989" author="erwin.tam" created="Thu, 8 Apr 2010 17:35:49 +0100"/>
                            <attachment id="12440653" name="ZOOKEEPER-464.patch" size="39306" author="erwin.tam" created="Fri, 2 Apr 2010 23:14:50 +0100"/>
                            <attachment id="12439837" name="ZOOKEEPER-464.patch" size="38044" author="erwin.tam" created="Thu, 25 Mar 2010 23:34:26 +0000"/>
                            <attachment id="12440918" name="zookeeper-464-log.txt" size="94811" author="fpj" created="Tue, 6 Apr 2010 17:00:07 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 22 Mar 2010 22:26:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47799</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzxtr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33464</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>