<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:40:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1496/ZOOKEEPER-1496.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1496] Ephemeral node not getting cleared even after client has exited</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1496</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In one of the tests we performed, came across a case where the ephemeral node was not getting cleared from zookeeper though the client exited.&lt;/p&gt;

&lt;p&gt;Zk version: 3.4.3&lt;/p&gt;

&lt;p&gt;Ephemeral node still exists in Zookeeper: &lt;/p&gt;

&lt;p&gt;HOST-xx-xx-xx-55:/home/Jun25_LR/install/zookeeper/bin # date &lt;/p&gt;

&lt;p&gt;Tue Jun 26 16:07:04 IST 2012 &lt;br/&gt;
HOST-xx-xx-xx-55:/home/Jun25_LR/install/zookeeper/bin # ./zkCli.sh -server xx.xx.xx.55:2182 &lt;br/&gt;
Connecting to xx.xx.xx.55:2182 &lt;br/&gt;
Welcome to ZooKeeper! &lt;br/&gt;
JLine support is enabled &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;zk: xx.xx.xx.55:2182(CONNECTING) 0&amp;#93;&lt;/span&gt; &lt;br/&gt;
WATCHER:: &lt;/p&gt;

&lt;p&gt;WatchedEvent state:SyncConnected type:None path:null &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;zk: xx.xx.xx.55:2182(CONNECTED) 0&amp;#93;&lt;/span&gt; get /hadoop-ha/hacluster/ActiveStandbyElectorLock &lt;/p&gt;

&lt;p&gt;haclusternn2HOSt-xx-xx-xx-102 &#239;&#191;&#189;&#239;&#191;&#189; &lt;br/&gt;
cZxid = 0x200000075 &lt;br/&gt;
ctime = Tue Jun 26 13:10:19 IST 2012 &lt;br/&gt;
mZxid = 0x200000075 &lt;br/&gt;
mtime = Tue Jun 26 13:10:19 IST 2012 &lt;br/&gt;
pZxid = 0x200000075 &lt;br/&gt;
cversion = 0 &lt;br/&gt;
dataVersion = 0 &lt;br/&gt;
aclVersion = 0 &lt;br/&gt;
ephemeralOwner = 0x1382791d4e50004 &lt;br/&gt;
dataLength = 42 &lt;br/&gt;
numChildren = 0 &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;zk: xx.xx.xx.55:2182(CONNECTED) 1&amp;#93;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Grepped logs at ZK side for session &quot;0x1382791d4e50004&quot; - close session and later create coming before closesession processed. &lt;/p&gt;

&lt;p&gt;HOSt-xx-xx-xx-91:/home/Jun25_LR/install/zookeeper/logs # grep -E &quot;/hadoop-ha/hacluster/ActiveStandbyElectorLock|0x1382791d4e50004&quot; *|grep 0x200000074 &lt;br/&gt;
2012-06-26 13:10:18,834 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:3 cport:-1)::CommitProcessor@171&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x1382791d4e50004 type:closeSession cxid:0x0 zxid:0x200000074 txntype:-11 reqpath:n/a &lt;br/&gt;
2012-06-26 13:10:19,892 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:3 cport:-1)::Leader@716&amp;#93;&lt;/span&gt; - Proposing:: sessionid:0x1382791d4e50004 type:closeSession cxid:0x0 zxid:0x200000074 txntype:-11 reqpath:n/a &lt;br/&gt;
2012-06-26 13:10:19,919 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/xx.xx.xx.102:13846:CommitProcessor@161&amp;#93;&lt;/span&gt; - Committing request:: sessionid:0x1382791d4e50004 type:closeSession cxid:0x0 zxid:0x200000074 txntype:-11 reqpath:n/a &lt;br/&gt;
2012-06-26 13:10:20,608 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:3:FinalRequestProcessor@88&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x1382791d4e50004 type:closeSession cxid:0x0 zxid:0x200000074 txntype:-11 reqpath:n/a &lt;/p&gt;

&lt;p&gt;HOSt-xx-xx-xx-91:/home/Jun25_LR/install/zookeeper/logs # grep -E &quot;/hadoop-ha/hacluster/ActiveStandbyElectorLock|0x1382791d4e50004&quot; *|grep 0x200000075 &lt;br/&gt;
2012-06-26 13:10:19,893 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:3 cport:-1)::CommitProcessor@171&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x1382791d4e50004 type:create cxid:0x2 zxid:0x200000075 txntype:1 reqpath:n/a &lt;br/&gt;
2012-06-26 13:10:19,920 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:3 cport:-1)::Leader@716&amp;#93;&lt;/span&gt; - Proposing:: sessionid:0x1382791d4e50004 type:create cxid:0x2 zxid:0x200000075 txntype:1 reqpath:n/a &lt;br/&gt;
2012-06-26 13:10:20,278 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/xx.xx.xx.102:13846:CommitProcessor@161&amp;#93;&lt;/span&gt; - Committing request:: sessionid:0x1382791d4e50004 type:create cxid:0x2 zxid:0x200000075 txntype:1 reqpath:n/a &lt;br/&gt;
2012-06-26 13:10:20,752 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:3:FinalRequestProcessor@88&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x1382791d4e50004 type:create cxid:0x2 zxid:0x200000075 txntype:1 reqpath:n/a &lt;/p&gt;


&lt;p&gt; Close session and create requests coming almost parallely. &lt;/p&gt;


&lt;p&gt;Env:&lt;br/&gt;
Hadoop setup.&lt;br/&gt;
We were using Namenode HA with bookkeeper as shared storage and auto failover enabled.&lt;br/&gt;
NN102 was active and NN55 was standby. &lt;br/&gt;
FailoverController at 102 got shut down due to ZK connection error. &lt;br/&gt;
The lock-ActiveStandbyElectorLock created (ephemeral node) by this failovercontroller is not cleared from ZK&lt;/p&gt;</description>
                <environment></environment>
        <key id="12596235">ZOOKEEPER-1496</key>
            <summary>Ephemeral node not getting cleared even after client has exited</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh R</assignee>
                                    <reporter username="suja">suja s</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Jun 2012 11:24:35 +0100</created>
                <updated>Mon, 17 Sep 2012 12:02:06 +0100</updated>
                            <resolved>Mon, 17 Sep 2012 08:58:01 +0100</resolved>
                                    <version>3.4.3</version>
                                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13402985" author="suja" created="Thu, 28 Jun 2012 11:25:23 +0100"  >&lt;p&gt;Attaching logs&lt;/p&gt;</comment>
                            <comment id="13402997" author="rakeshr" created="Thu, 28 Jun 2012 11:49:17 +0100"  >&lt;p&gt;I&apos;ve gone through the issue and attaching the analysis. Apologies in advance for the length of this comment - I&apos;m trying to cover all the details.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Environment details:&lt;/b&gt;&lt;br/&gt;
ZK-91 -&amp;gt; Leader&lt;br/&gt;
ZK-55 -&amp;gt; Follower&lt;br/&gt;
ZK-102 -&amp;gt; Follower&lt;br/&gt;
ZKClient session timeout -&amp;gt; 5seconds&lt;br/&gt;
ZKClient side logic:- What I observed is, zclient is not waiting for any SyncConnected event before creating ephemeral znode &apos;ActiveStandbyElectorLock&apos;. Also, on every connectionloss it is creating the ephemeral znode &apos;ActiveStandbyElectorLock&apos;.&lt;/p&gt;


&lt;p&gt;&lt;b&gt;Root Cause:&lt;/b&gt; I&apos;m suspecting there is a race condition between session expiry and FinalRequestProcessor. I could see, the expiry logic is removing the SessionImpl and is raising the &apos;closesession&apos; request, other side FinalRequestProcessor is creating new SessionImpl into the SessionTracker for the &apos;createsession&apos; request.&lt;/p&gt;

&lt;p&gt;This case will come only if FinalRequestProcessor has some delay in processing the &apos;createsession&apos; and in between the same session is getting expired.&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;I&apos;ve done the analysis in perspective of Leader ZooKeeper server(ZK-91) and is as follows:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Stage-1)&lt;/b&gt; Client has sent connection request and the transaction id is &apos;0x200000070&apos;&lt;br/&gt;
Following log shows, the server has received connection request and after successful proposal, send committing request to the Follower. But the Leader side the transaction is in progress, as the request not reaches the FinalRequestProcessor.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-06-26 13:10:12,566 [myid:3] - DEBUG [ProcessThread(sid:3 cport:-1)::CommitProcessor@171] - Processing request:: sessionid:0x1382791d4e50004 type:createSession cxid:0x0 zxid:0x200000070 txntype:-10 reqpath:n/a

2012-06-26 13:10:13,001 [myid:3] - DEBUG [ProcessThread(sid:3 cport:-1)::Leader@716] - Proposing:: sessionid:0x1382791d4e50004 type:createSession cxid:0x0 zxid:0x200000070 txntype:-10 reqpath:n/a

2012-06-26 13:10:13,202 [myid:3] - DEBUG [LearnerHandler-/xx.xx.xx.102:13846:CommitProcessor@161] - Committing request:: sessionid:0x1382791d4e50004 type:createSession cxid:0x0 zxid:0x200000070 txntype:-10 reqpath:n/a
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;b&gt;Stage-2)&lt;/b&gt; Following log shows the Leader has&apos;nt seen any pings from 0x1382791d4e50004 and expiring the session by creating &apos;closesession&apos; request.&lt;br/&gt;
 If we see the SessionTrackerImpl, it is removing the SessionImpl corresponding to the 0x1382791d4e50004 before raising the expiry request. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     sessionsById.remove(s.sessionId);
     expirer.expire(s);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At the same time, zkclient has sent &apos;create&apos; command to the server - 0x200000072 transactionid, now the sessionTracker.checkSession(sessionId, owner) will not have the SessionImpl and get null then throwing the session expiry exception.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        SessionImpl session = sessionsById.get(sessionId);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (session == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || session.isClosing()) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KeeperException.SessionExpiredException();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-06-26 13:10:18,653 [myid:3] - INFO  [SessionTracker:ZooKeeperServer@325] - Expiring session 0x1382791d4e50004, timeout of 5000ms exceeded
2012-06-26 13:10:18,803 [myid:3] - INFO  [ProcessThread(sid:3 cport:-1)::PrepRequestProcessor@627] - Got user-level KeeperException when processing sessionid:0x1382791d4e50004 type:create cxid:0x1 zxid:0x200000072 txntype:-1 reqpath:/hadoop-ha/hacluster/ActiveStandbyElectorLock Error Path:null Error:KeeperErrorCode = Session expired
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;b&gt;Stage-3)&lt;/b&gt; Following message shows, &apos;closesession&apos; 0x200000074 has got enough Ack and committing. But it didn&apos;t reaches the FinalRequestProcessor, so the session info will exists in the sessionTracker except the &apos;SessionImpl&apos; object(as session is expired). &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-06-26 13:10:18,834 [myid:3] - INFO  [ProcessThread(sid:3 cport:-1)::PrepRequestProcessor@476] - Processed session termination for sessionid: 0x1382791d4e50004
2012-06-26 13:10:18,834 [myid:3] - DEBUG [ProcessThread(sid:3 cport:-1)::CommitProcessor@171] - Processing request:: sessionid:0x1382791d4e50004 type:closeSession cxid:0x0 zxid:0x200000074 txntype:-11 reqpath:n/a
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;b&gt;Stage-4)&lt;/b&gt; Following log shows, &apos;createSession&apos; 0x200000070 has reached FinalRequestProcessor and same time received a &apos;create&apos; request from the client.&lt;br/&gt;
Now, the FinalRequestProcessor is processing the transaction and adding the SessionImpl back to the SessionTrackerImpl. The &apos;create&apos; request is seeing this new SessionImpl and will continue successfully to next processor.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FinalRequestProcessor.java
rc = zks.processTxn(hdr, txn);       
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ZooKeeperServer.java&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ProcessTxnResult processTxn(TxnHeader hdr, Record txn) {
        ProcessTxnResult rc;
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; opCode = hdr.getType();
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sessionId = hdr.getClientId();
        rc = getZKDatabase().processTxn(hdr, txn);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (opCode == OpCode.createSession) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (txn &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CreateSessionTxn) {
                CreateSessionTxn cst = (CreateSessionTxn) txn;
                sessionTracker.addSession(sessionId, cst
                        .getTimeOut());
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;*****&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; Got &quot;&lt;/span&gt;
                        + txn.getClass() + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;
                        + txn.toString());
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (opCode == OpCode.closeSession) {
            sessionTracker.removeSession(sessionId);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; rc;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-06-26 13:10:19,886 [myid:3] - DEBUG [CommitProcessor:3:FinalRequestProcessor@88] - Processing request:: sessionid:0x1382791d4e50004 type:createSession cxid:0x0 zxid:0x200000070 txntype:-10 reqpath:n/a
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;b&gt;Stage-5)&lt;/b&gt; &apos;closesession&apos; 0x200000074 request has come to the FinalRequestProcessor and do the session closure&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-06-26 13:10:20,608 [myid:3] - DEBUG [CommitProcessor:3:FinalRequestProcessor@88] - Processing request:: sessionid:0x1382791d4e50004 type:closeSession cxid:0x0 zxid:0x200000074 txntype:-11 reqpath:n/a
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;b&gt;Stage-6)&lt;/b&gt; Now the &apos;create&apos; 0x200000075 command, reaches in FinalRequestProcessor and resulting the orphan ephmeral znode.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-06-26 13:10:19,893 [myid:3] - DEBUG [ProcessThread(sid:3 cport:-1)::CommitProcessor@171] - Processing request:: sessionid:0x1382791d4e50004 type:create cxid:0x2 zxid:0x200000075 txntype:1 reqpath:n/a
2012-06-26 13:10:20,278 [myid:3] - DEBUG [LearnerHandler-/xx.xx.xx.102:13846:CommitProcessor@161] - Committing request:: sessionid:0x1382791d4e50004 type:create cxid:0x2 zxid:0x200000075 txntype:1 reqpath:n/a
2012-06-26 13:10:20,752 [myid:3] - DEBUG [CommitProcessor:3:FinalRequestProcessor@88] - Processing request:: sessionid:0x1382791d4e50004 type:create cxid:0x2 zxid:0x200000075 txntype:1 reqpath:n/a
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;-Rakesh&lt;/p&gt;</comment>
                            <comment id="13403003" author="rakeshr" created="Thu, 28 Jun 2012 12:00:29 +0100"  >&lt;p&gt;When I go through the SessionTrackerImpl, removing the session just before expiring as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (set != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
   &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SessionImpl s : set.sessions) {
      sessionsById.remove(s.sessionId);
      expirer.expire(s);
   }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instead of sessionsById.remove(s.sessionId); will mark the session as closing s.isClosing = true&lt;br/&gt;
How does it sound?&lt;/p&gt;

&lt;p&gt;-Rakesh&lt;/p&gt;</comment>
                            <comment id="13403743" author="rakeshr" created="Fri, 29 Jun 2012 08:09:44 +0100"  >&lt;p&gt;Hi All,&lt;/p&gt;

&lt;p&gt;Attached the proposed fix based on my analysis, please help me to validate the proposal. &lt;/p&gt;

&lt;p&gt;I&apos;m trying to reproduce in my test case.&lt;/p&gt;</comment>
                            <comment id="13403753" author="fournc" created="Fri, 29 Jun 2012 08:33:01 +0100"  >&lt;p&gt;Rakesh, when you have a patch ready please hit the &quot;submit patch&quot; option on the JIRA, which will trigger the patch to be picked up by the automated build and run.&lt;/p&gt;

&lt;p&gt;I am on vacation and don&apos;t have time to look at this right now but will try to take a closer look in the next few days if no one else can.&lt;/p&gt;</comment>
                            <comment id="13403765" author="hadoopqa" created="Fri, 29 Jun 2012 09:04:30 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12533949/ZOOKEEPER-1496.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12533949/ZOOKEEPER-1496.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1353683.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1112//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1112//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1112//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1112//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1112//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1112//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13403864" author="rakeshr" created="Fri, 29 Jun 2012 13:11:51 +0100"  >&lt;p&gt;Thanks Camille for the interest. I&apos;ve attached an initial draft for reviewing the problem and proposed solution.&lt;/p&gt;</comment>
                            <comment id="13403872" author="hadoopqa" created="Fri, 29 Jun 2012 13:37:47 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12533973/ZOOKEEPER-1496.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12533973/ZOOKEEPER-1496.1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1353683.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1113//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1113//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1113//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1113//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1113//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1113//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13412655" author="hadoopqa" created="Thu, 12 Jul 2012 11:07:50 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12536199/ZOOKEEPER-1496.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12536199/ZOOKEEPER-1496.2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1357711.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1138//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1138//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1138//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1138//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1138//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1138//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13412663" author="rakeshr" created="Thu, 12 Jul 2012 11:15:39 +0100"  >&lt;p&gt;Attached the patch with test case. Please review the analysis and the proposed solution.&lt;/p&gt;

&lt;p&gt;In our NN-HA cluster, similar issue has been reported twice as the session expiry time is very small and default value is 5seconds.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rakesh&lt;/p&gt;</comment>
                            <comment id="13444673" author="mahadev" created="Thu, 30 Aug 2012 05:47:20 +0100"  >&lt;p&gt;This looks like a critical bugfix.&lt;/p&gt;</comment>
                            <comment id="13444834" author="rakeshr" created="Thu, 30 Aug 2012 10:42:47 +0100"  >&lt;p&gt;Thanks Mahadev for the interest. Could you please review the proposed fix, that I had made in the patch.&lt;/p&gt;</comment>
                            <comment id="13456758" author="mahadev" created="Mon, 17 Sep 2012 05:45:07 +0100"  >&lt;p&gt;Rakesh,&lt;br/&gt;
 I looked at the patch and it looks good, except for this one:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-                set = sessionSets.remove(nextExpirationTime);
+                SessionSet set = sessionSets.get(nextExpirationTime);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think the remove still needs to happen else the session sets will keep growing in the hashset.&lt;/p&gt;

&lt;p&gt;Also, &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (s != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
-            sessionSets.get(s.tickTime).sessions.remove(s);
+            SessionSet sessionSet = sessionSets.get(s.tickTime);
+            sessionSet.sessions.remove(s);
+            &lt;span class=&quot;code-comment&quot;&gt;// Cleanup sessionSets, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no session exists
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sessionSet.sessions.size() == 0) {
+                sessionSets.remove(s.tickTime);
+            }
         }
     }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I see that you are removing the sessionSet once the session cleans up but I think we need to still do the remove the session set when iterating for expiry.&lt;/p&gt;

&lt;p&gt;Does that make sense?&lt;/p&gt;</comment>
                            <comment id="13456852" author="rakeshr" created="Mon, 17 Sep 2012 08:18:52 +0100"  >&lt;p&gt;Thanks a lot Mahadev for the review.&lt;/p&gt;

&lt;p&gt;Yeah its true, attached latest patch addressing the comments. Also added one more test case for removeSession logic, as I feel its impacted.&lt;/p&gt;

&lt;p&gt;Could you please look at the latest one.&lt;/p&gt;</comment>
                            <comment id="13456860" author="mahadev" created="Mon, 17 Sep 2012 08:45:22 +0100"  >&lt;p&gt;Rakesh,&lt;br/&gt;
 The patch looks good to me. Ill wait for hudson to check this in. We are good to go for 3.4 RC now! Thanks Rakesh!&lt;/p&gt;</comment>
                            <comment id="13456863" author="hadoopqa" created="Mon, 17 Sep 2012 08:49:13 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12545370/ZOOKEEPER-1496.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12545370/ZOOKEEPER-1496.3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1385378.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1183//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1183//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1183//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1183//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1183//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1183//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13456866" author="mahadev" created="Mon, 17 Sep 2012 08:58:01 +0100"  >&lt;p&gt;Just committed this to trunk and 3.4 branch. Thanks Rakesh!&lt;/p&gt;</comment>
                            <comment id="13456939" author="hudson" created="Mon, 17 Sep 2012 12:02:06 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1682 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1682/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1682/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1496&quot; title=&quot;Ephemeral node not getting cleared even after client has exited&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1496&quot;&gt;&lt;del&gt;ZOOKEEPER-1496&lt;/del&gt;&lt;/a&gt;. Ephemeral node not getting cleared even after client has exited. (Rakesh R via mahadev) (Revision 1386496)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
mahadev : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1386496&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1386496&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/SessionTrackerTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12533800" name="Logs.rar" size="1583143" author="suja" created="Thu, 28 Jun 2012 11:25:23 +0100"/>
                            <attachment id="12533973" name="ZOOKEEPER-1496.1.patch" size="2290" author="rakeshr" created="Fri, 29 Jun 2012 13:08:59 +0100"/>
                            <attachment id="12536199" name="ZOOKEEPER-1496.2.patch" size="6918" author="rakeshr" created="Thu, 12 Jul 2012 10:38:07 +0100"/>
                            <attachment id="12545370" name="ZOOKEEPER-1496.3.patch" size="8486" author="rakeshr" created="Mon, 17 Sep 2012 08:15:50 +0100"/>
                            <attachment id="12533949" name="ZOOKEEPER-1496.patch" size="756" author="rakeshr" created="Fri, 29 Jun 2012 08:09:44 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 28 Jun 2012 10:49:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242205</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwdzb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12752</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>