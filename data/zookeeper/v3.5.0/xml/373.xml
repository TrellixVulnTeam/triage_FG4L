<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:50:39 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-373/ZOOKEEPER-373.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-373] One thread per bookie</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-373</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Currently, if a client is writing to multiple ledgers and these ledgers overlap on some bookie, there will be as many threads for such a bookie as the number of ledgers writing to it. Consequently, if a client writes to many ledgers simultaneously, it may end up with an undesirably large number of threads. I don&apos;t have a concrete proposal yet, but I suspect it is as simple as keeping an array of BookieHandle objects, one per bookie, and having each BookieHandle object shared by all ledgers.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12422484">ZOOKEEPER-373</key>
            <summary>One thread per bookie</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Junqueira</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Apr 2009 16:41:10 +0100</created>
                <updated>Wed, 8 Jul 2009 21:24:02 +0100</updated>
                            <resolved>Fri, 17 Apr 2009 22:29:34 +0100</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>contrib-bookkeeper</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12698390" author="fpj" created="Mon, 13 Apr 2009 14:46:02 +0100"  >&lt;p&gt;Preliminary patch. It does not contain a unit test for this issue.&lt;/p&gt;</comment>
                            <comment id="12699245" author="fpj" created="Wed, 15 Apr 2009 16:49:55 +0100"  >&lt;p&gt;Includes a new unit test.&lt;/p&gt;</comment>
                            <comment id="12699308" author="mahadev" created="Wed, 15 Apr 2009 19:33:02 +0100"  >&lt;p&gt;flavio,&lt;br/&gt;
 can you comment on the jira, what specific changes you made?&lt;/p&gt;</comment>
                            <comment id="12699341" author="fpj" created="Wed, 15 Apr 2009 20:53:32 +0100"  >&lt;p&gt;With this patch, a BookKeeper client has only one BookieHandle per Bookie. With the current trunk implementation, if a client creates writes to two ledgers simultaneously and they share a bookie, there will be two BookieHandle threads. This is not a problem for applications like the namenode that writes to one ledger at a time, but there might be applications that require clients writing to several ledgers concurrently. &lt;/p&gt;

&lt;p&gt;More specifically, with this patch, a BookKeeper object keeps a list of BookieHandle objects. When creating a ledger, LedgerHandle checks if there is a BookieHandle object available before instantiating BookieHandle through a call to BookKeeper::getBookieHandle. We then have to make sure that a BookieHandle keeps running as long as there is at least one reference to it. &lt;/p&gt;

</comment>
                            <comment id="12699426" author="breed" created="Wed, 15 Apr 2009 23:41:21 +0100"  >&lt;p&gt;looks good. the one trick piece is the refCounting. specifically decrementing the counter. in close when you decrement the counter and then do the remove you aren&apos;t in a synchronized method, so you have a race condition. one other place that could be problematic is the mac object. isn&apos;t it possible that two different threads going to two different ledgers use the same mac?&lt;/p&gt;</comment>
                            <comment id="12699577" author="fpj" created="Thu, 16 Apr 2009 09:12:24 +0100"  >&lt;p&gt;Canceling patch until we sort out all raised issues. &lt;/p&gt;</comment>
                            <comment id="12699590" author="fpj" created="Thu, 16 Apr 2009 10:11:43 +0100"  >&lt;p&gt;&amp;gt; the one trick piece is the refCounting. specifically decrementing &lt;br/&gt;
&amp;gt; the counter. in close when you decrement the counter and then &lt;br/&gt;
&amp;gt; do the remove you aren&apos;t in a synchronized method, so you have &lt;br/&gt;
&amp;gt; a race condition.&lt;/p&gt;

&lt;p&gt;That was a great catch. I have initially thought that making the counter volatile was sufficient given the code paths that we have, but I realized after your comment that this is not true, so I have re-structured a bit so that we don&apos;t have a race condition. &lt;/p&gt;

&lt;p&gt;I haven&apos;t made BookieHandle::incRefCount and BookieHandle::halt synchronized because they are currently only called from BookKeeper::getBookieHandle and BookKeeper::haltBookieHandles, respectively, and these two last methods are synchronized. To make it safe for future versions of BookKeeper, we could make the two BookieHandle methods synchronized, but if I&apos;m not mistaken, I don&apos;t think they have to be in the way I have implemented. It would be great if you could double-check. &lt;/p&gt;

&lt;p&gt;&amp;gt; one other place that could be problematic is the mac object. &lt;br/&gt;
&amp;gt; isn&apos;t it possible that two different threads going to two different&lt;br/&gt;
&amp;gt; ledgers use the same mac?&lt;/p&gt;

&lt;p&gt;This one doesn&apos;t seem to be a problem because each mac object is a variable of either BookieHandle (for writes) or BookieClient (for reads), and each of these classes extends Thread. Finally, the methods that use the mac objects are called from the Threads that own them. &lt;/p&gt;</comment>
                            <comment id="12699778" author="breed" created="Thu, 16 Apr 2009 18:39:47 +0100"  >&lt;p&gt;+1 looks good&lt;/p&gt;</comment>
                            <comment id="12699828" author="hadoopqa" created="Thu, 16 Apr 2009 20:59:49 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12405634/ZOOKEEPER-373.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12405634/ZOOKEEPER-373.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 764673.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/34/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/34/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/34/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/34/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/34/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/34/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12700334" author="mahadev" created="Fri, 17 Apr 2009 22:29:34 +0100"  >&lt;p&gt;I just commmitted this. thanks flavio!.&lt;/p&gt;</comment>
                            <comment id="12700663" author="hudson" created="Mon, 20 Apr 2009 07:11:58 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #284 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/284/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/284/&lt;/a&gt;)&lt;br/&gt;
    . One thread per bookie (flavio via mahadev)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12405634" name="ZOOKEEPER-373.patch" size="21893" author="fpj" created="Thu, 16 Apr 2009 10:01:04 +0100"/>
                            <attachment id="12405537" name="ZOOKEEPER-373.patch" size="21512" author="fpj" created="Wed, 15 Apr 2009 16:49:55 +0100"/>
                            <attachment id="12405321" name="ZOOKEEPER-373.patch" size="9833" author="fpj" created="Mon, 13 Apr 2009 14:46:02 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 15 Apr 2009 18:33:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47865</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzy13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33497</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>