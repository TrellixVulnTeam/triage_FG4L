<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:52:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1789/ZOOKEEPER-1789.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1789] 3.4.x observer causes NPE on 3.5.0 (trunk) participants</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1789</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;(assigning to Alex because this was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-107&quot; title=&quot;Allow dynamic changes to server cluster membership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-107&quot;&gt;&lt;del&gt;ZOOKEEPER-107&lt;/del&gt;&lt;/a&gt;, but will upload a patch as well.)&lt;/p&gt;

&lt;p&gt;I have a 5 participants cluster running what will be 3.5.0 (i.e.: trunk as of today) and an observer running 3.4 (trunk from 3.4 branch). When the observer tries to establish a connection to the participants I get:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Thread Thread[10.40.78.121:3888,5,main] died java.lang.NullPointerException at org.apache.zookeeper.server.quorum.QuorumCnxManager.receiveConnection(QuorumCnxManager.java:240)
        at org.apache.zookeeper.server.quorum.QuorumCnxManager$Listener.run(QuorumCnxManager.java:552)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at QuorumCnxManager.java:240:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            if (protocolVersion &amp;gt;= 0) { // this is a server id and not a protocol version                                                             
               sid = protocolVersion;
                electionAddr = self.getVotingView().get(sid).electionAddr;
            } else {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and self.getVotingView().get(sid) will be null for Observers.  So this block should cover that case.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12673328">ZOOKEEPER-1789</key>
            <summary>3.4.x observer causes NPE on 3.5.0 (trunk) participants</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shralex">Alexander Shraer</assignee>
                                    <reporter username="rgs">Raul Gutierrez Segales</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Oct 2013 00:10:54 +0100</created>
                <updated>Thu, 24 Jul 2014 12:22:01 +0100</updated>
                            <resolved>Wed, 23 Jul 2014 18:36:53 +0100</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13792123" author="shralex" created="Fri, 11 Oct 2013 00:56:01 +0100"  >&lt;p&gt;thanks once again Raul. Yeah, I guess it should be getView instead of getVotingView, or something similar. It is possible, however, that the sid is not there so the following code should deal with the case that electionAddr is null, perhaps by calling connectOne(sid) instead of connectOne(sid, electionAddr), but I&apos;m not completely sure.&lt;/p&gt;

&lt;p&gt;You may also want to look at ZK-1633. CnxManagerTest.java is where to look for test examples for this one.&lt;/p&gt;

&lt;p&gt;There seems to be a related bug - observers may not be declared in the view and have a special id (although if they fall within this &quot;if&quot; like you describe they have positive id so they should be in getView).  See the code below the one you quote in how it deals with special ObserverId = -1. &lt;/p&gt;

&lt;p&gt;It would be great if you can fix and test the bug you identified, dealing also with the case that electionAddr may be end up being null if the id is not in the view. I can then fix the remaining issue of special ObserverId.&lt;/p&gt;</comment>
                            <comment id="13841730" author="sebb@apache.org" created="Fri, 6 Dec 2013 21:28:32 +0000"  >&lt;p&gt;Revert unwarranted change by 3rd party&lt;/p&gt;</comment>
                            <comment id="13968848" author="shralex" created="Mon, 14 Apr 2014 22:11:50 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;Raul Gutierrez Segales&lt;/a&gt;, can you please take this one ?&lt;/p&gt;</comment>
                            <comment id="14067400" author="shralex" created="Sat, 19 Jul 2014 07:12:26 +0100"  >&lt;p&gt;Added a test and verified that it fails without the fix.&lt;/p&gt;

&lt;p&gt;Although this should resolve the current JIRA I still don&apos;t know whether or not there is a problem with anonymous observers that connect with id  OBSERVER_ID = Long.MAX_VALUE. Looking at the code of receiveConnection and connectOne in 3.4.6, I don&apos;t understand how a server receiving the connection attempt from such an observer would be able to connect back (is it in the view ? if not how where is its address coming from ?) &lt;/p&gt;</comment>
                            <comment id="14067417" author="hadoopqa" created="Sat, 19 Jul 2014 07:59:32 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12656705/ZOOKEEPER-1789.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12656705/ZOOKEEPER-1789.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1611846.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 87 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2201//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2201//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2201//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2201//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2201//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2201//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14067420" author="shralex" created="Sat, 19 Jul 2014 08:03:14 +0100"  >&lt;p&gt;failure is testHammer, unrelated to the patch&lt;/p&gt;</comment>
                            <comment id="14067608" author="rgs" created="Sat, 19 Jul 2014 18:47:51 +0100"  >&lt;p&gt;Thanks for the patch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;Alexander Shraer&lt;/a&gt;. One small question in:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+     * Tests a bug in QuorumCnxManager that causes a NPE when a negative 3.4.6
+     * observer connects to a 3.5.0 server. 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;what does negative mean in that context? or you meant &amp;lt; 3.4.6?&lt;/p&gt;

&lt;p&gt;Besides that, looks great to me.&lt;/p&gt;</comment>
                            <comment id="14067613" author="shralex" created="Sat, 19 Jul 2014 19:12:31 +0100"  >&lt;p&gt;Thanks Raul, it was a typo, leftover from another test&apos;s description where a negative value is sent. Removed this word, otherwise the patch is identical.&lt;/p&gt;</comment>
                            <comment id="14067635" author="hadoopqa" created="Sat, 19 Jul 2014 19:59:15 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12656740/ZOOKEEPER-1789.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12656740/ZOOKEEPER-1789.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1611846.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 87 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2203//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2203//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2203//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2203//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2203//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2203//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14067639" author="rgs" created="Sat, 19 Jul 2014 20:01:37 +0100"  >&lt;p&gt;awesome &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;Alexander Shraer&lt;/a&gt;, +1.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;Patrick Hunt&lt;/a&gt;: would be great to have this for the upcoming alpha release.&lt;/p&gt;</comment>
                            <comment id="14069014" author="phunt" created="Mon, 21 Jul 2014 19:38:07 +0100"  >&lt;p&gt;What&apos;s with the &quot;sleep(1000)&quot; in the test? (as well as some pretty low timeouts for other statements in that same test) That&apos;s usually a red flag. - meaning that tends to cause flakey tests on slow/underprovisioned hardware.&lt;/p&gt;</comment>
                            <comment id="14069028" author="shralex" created="Mon, 21 Jul 2014 19:47:33 +0100"  >&lt;p&gt;This is actually how most of the CnxManagerTest tests work - they start the QuorumConnectionManager and wait for a second before attempting to connect. I guess its because there are multiple threads running in QCM.&lt;/p&gt;</comment>
                            <comment id="14069489" author="fpj" created="Tue, 22 Jul 2014 00:12:24 +0100"  >&lt;p&gt;I think those sleep calls are there so that we are sure that the listener is listening before proceeding (it&apos;s a separate thread). Alex is right that other tests do the same. I&apos;m not sure how to check if the listener is already blocked on the accept before proceeding. Even if we use a boolean flag it isn&apos;t totally reliable.  &lt;/p&gt;</comment>
                            <comment id="14072005" author="phunt" created="Wed, 23 Jul 2014 18:36:53 +0100"  >&lt;p&gt;Looks good to me, thanks Alex! Committed to trunk.&lt;/p&gt;</comment>
                            <comment id="14073088" author="hudson" created="Thu, 24 Jul 2014 12:22:01 +0100"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2384 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2384/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2384/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1789&quot; title=&quot;3.4.x observer causes NPE on 3.5.0 (trunk) participants&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1789&quot;&gt;&lt;del&gt;ZOOKEEPER-1789&lt;/del&gt;&lt;/a&gt;. 3.4.x observer causes NPE on 3.5.0 (trunk) participants (Alex Shraer via phunt) (phunt: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1612885&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1612885&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/CnxManagerTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12656740" name="ZOOKEEPER-1789.patch" size="5083" author="shralex" created="Sat, 19 Jul 2014 19:12:31 +0100"/>
                            <attachment id="12656705" name="ZOOKEEPER-1789.patch" size="5092" author="shralex" created="Sat, 19 Jul 2014 07:12:26 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 10 Oct 2013 23:56:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352951</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzip2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353238</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>