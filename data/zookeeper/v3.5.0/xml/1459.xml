<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:48:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1459/ZOOKEEPER-1459.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1459] Standalone ZooKeeperServer is not closing the transaction log files on shutdown</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1459</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;When shutdown the standalone ZK server, its only clearing the zkdatabase and not closing the transaction log streams. When tries to delete the temporary files in unit tests on windows, its failing.&lt;br/&gt;
ZooKeeperServer.java&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        if (zkDb != null) {
            zkDb.clear();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Suggestion to close the zkDb as follows, this inturn will take care transaction logs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        if (zkDb != null) {
            zkDb.clear();
            try {
                zkDb.close();
            } catch (IOException ie) {
                LOG.warn(&quot;Error closing logs &quot;, ie);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12553315">ZOOKEEPER-1459</key>
            <summary>Standalone ZooKeeperServer is not closing the transaction log files on shutdown</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12683243">ZOOKEEPER-1833</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh R</assignee>
                                    <reporter username="rakeshr">Rakesh R</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Apr 2012 09:11:06 +0100</created>
                <updated>Tue, 20 May 2014 15:11:19 +0100</updated>
                            <resolved>Sat, 7 Dec 2013 10:19:12 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.6</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13264754" author="hadoopqa" created="Mon, 30 Apr 2012 10:41:54 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12525047/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12525047/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1331246.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1053//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1053//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1053//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1053//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1053//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1053//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13266346" author="rakeshr" created="Wed, 2 May 2012 05:49:48 +0100"  >&lt;p&gt;Canelling the patch, since it has few correction as per the report. Please help me to review the cause and suggested fix. I will try to upload a clean patch. Thanks.&lt;/p&gt;</comment>
                            <comment id="13785818" author="hadoopqa" created="Fri, 4 Oct 2013 03:11:23 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12525047/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12525047/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1529013.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1636//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1636//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1636//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1636//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1636//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1636//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13785823" author="fournc" created="Fri, 4 Oct 2013 03:16:03 +0100"  >&lt;p&gt;Unless we see a working patch from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt; I&apos;m not sure this belongs in the critical list for 3.4.6.&lt;/p&gt;</comment>
                            <comment id="13785865" author="rakeshr" created="Fri, 4 Oct 2013 04:13:24 +0100"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fournc&quot; class=&quot;user-hover&quot; rel=&quot;fournc&quot;&gt;Camille Fournier&lt;/a&gt; for the interest. I had wrongly closed the ZKDatabase in my first patch. Here it was failing in SyncRequestProcessor thread.  Please have a look at the latest patch.&lt;/p&gt;</comment>
                            <comment id="13785875" author="hadoopqa" created="Fri, 4 Oct 2013 04:43:13 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12606716/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12606716/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1529013.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1638//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1638//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1638//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1638//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1638//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1638//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13789357" author="fpj" created="Tue, 8 Oct 2013 17:32:12 +0100"  >&lt;p&gt;I&apos;m not sure what you mean with &quot;leaking&quot; in the description here, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt;. In fact, I was hoping that this patch would solve the problem of deleting temporary files in unit tests on windows, but it didn&apos;t.&lt;/p&gt;

&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fournc&quot; class=&quot;user-hover&quot; rel=&quot;fournc&quot;&gt;Camille Fournier&lt;/a&gt;, this is not a blocker for 3.4.6, but it is ok to have it if we can get a fix.&lt;/p&gt;</comment>
                            <comment id="13790101" author="rakeshr" created="Wed, 9 Oct 2013 08:03:30 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt; exactly unit test case is failing in windows. I&apos;ve modified the defect description and attached latest patch to fix the problem. Please see.&lt;/p&gt;</comment>
                            <comment id="13790123" author="hadoopqa" created="Wed, 9 Oct 2013 08:28:17 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12607524/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12607524/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1530166.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1667//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1667//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1667//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1667//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1667//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1667//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13805039" author="davidlao" created="Fri, 25 Oct 2013 06:02:27 +0100"  >&lt;p&gt;Hi. The Oct 8 patch does not actually close the transaction log. The log need to be closed explicitly via the FileTxnSnapLog handle that&apos;s passed into the ZooKeeperServer when bootstrapped through runFromConfig. I&apos;m attach a patch generated from release-3.4.5 source that fixes it.&lt;/p&gt;

&lt;p&gt;Please run a QA pass on it. Thanks.&lt;/p&gt;</comment>
                            <comment id="13805045" author="hadoopqa" created="Fri, 25 Oct 2013 06:12:44 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12610271/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12610271/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1535491.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1723//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1723//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13805061" author="rakeshr" created="Fri, 25 Oct 2013 06:33:25 +0100"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidlao&quot; class=&quot;user-hover&quot; rel=&quot;davidlao&quot;&gt;David Lao&lt;/a&gt;, Thanks for the review. Hope you are referring to the Oct 9th patch. Here I could see one case, it will fail to close the snapLog only when zkServer.shutdown(); throws an exception, are you pointing me to the same?&lt;/p&gt;</comment>
                            <comment id="13805162" author="davidlao" created="Fri, 25 Oct 2013 09:31:19 +0100"  >&lt;p&gt;Add patch for trunk so QA can build. In ZooKeeperServer, the transaction log handle is txnLogFactory rather than zkDb, so that needs to be closed explicitly in order for deleting temp directory to work on Windows. &lt;/p&gt;</comment>
                            <comment id="13805173" author="hadoopqa" created="Fri, 25 Oct 2013 09:43:09 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12610294/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12610294/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1535491.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1724//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1724//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13805249" author="rakeshr" created="Fri, 25 Oct 2013 13:00:46 +0100"  >&lt;blockquote&gt;&lt;p&gt;In ZooKeeperServer, the transaction log handle is txnLogFactory rather than zkDb&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Please see ServerCnxnFactory, here startup of the serverCnxn would create ZKDatabase by giving the txnLogFactory. I feel only if there is an exception in ZooKeeperServer startup, it can leave the txnLog as open. Attached latest patch where closed stream in finally block.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        zks.startdata();
        zks.startup();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Secondly, In the patch you are trying to close the txnLog in zk.shutdown. Initially I had tried similar approach(please refer my first patch) and faced few issues in FollowerZooKeeperServer quorum shutdown. If we look at QuorumPeer shutdown pattern, it is closing the ZooKeeperDatabase after shutting down the quorum at the last step. But with this patch, its closing the transactionlog within the shutdown.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ZooKeeperServer.java
+ &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (txnLogFactory != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
+              txnLogFactory.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13805270" author="hadoopqa" created="Fri, 25 Oct 2013 13:35:23 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12610310/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12610310/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1535491.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1725//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1725//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1725//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1725//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1725//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1725//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13805530" author="davidlao" created="Fri, 25 Oct 2013 19:02:11 +0100"  >&lt;p&gt;Bear with me a bit since I&apos;m new to the code base.. but I don&apos;t see ServerCnxnFactory closing the transaction log anywhere. My understanding is that ServerCnxnFactory deals only with socket connectivities. To your second point I agree the log closing is better done outside the server in runFromConfig. I&apos;ve verified the patch works on by Windows box.&lt;/p&gt;</comment>
                            <comment id="13806146" author="fpj" created="Sat, 26 Oct 2013 19:03:07 +0100"  >&lt;p&gt;Both patches, from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidlao&quot; class=&quot;user-hover&quot; rel=&quot;davidlao&quot;&gt;David Lao&lt;/a&gt;, hang on org.apache.zookeeper.server.ZxidRolloverTest for me. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidlao&quot; class=&quot;user-hover&quot; rel=&quot;davidlao&quot;&gt;David Lao&lt;/a&gt; is right that a lot of tests fail on Windows because we don&apos;t close the txn log. I don&apos;t observe the same on unix and it seems to be due to the semantics of file deletion.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidlao&quot; class=&quot;user-hover&quot; rel=&quot;davidlao&quot;&gt;David Lao&lt;/a&gt;, when you generate patches, the patch root should be the project root (e.g., src/java....).&lt;/p&gt;</comment>
                            <comment id="13806581" author="rakeshr" created="Mon, 28 Oct 2013 05:54:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidlao&quot; class=&quot;user-hover&quot; rel=&quot;davidlao&quot;&gt;David Lao&lt;/a&gt; You are right, ServerCnxnFactory is not closing the transaction log. Sorry for the confusion. I had commented by looking at your patch, its trying to fix the transaction log separately in ZooKeeperServer. This is not required as ZKDatabase is holding the reference to txnLogFactory and zkDatabase will close transaction log also.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;To your second point I agree the log closing is better done outside the server in runFromConfig. I&apos;ve verified the patch works on by Windows box.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidlao&quot; class=&quot;user-hover&quot; rel=&quot;davidlao&quot;&gt;David Lao&lt;/a&gt; for the testing effort.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Both patches, from Rakesh R and David Lao, hang on org.apache.zookeeper.server.ZxidRolloverTest for me. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt;, Thanks again for the reviews. In the latest patch I tried to fix the problem in ZooKeeperServerMain.java class. One thing I&apos;m not able to understand is, why this fix is affecting ZxidRolloverTest testcases. Because am not seeing any relation ship between ZxidRolloverTest and transaction log closure in ZooKeeperServerMain&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I hope you are looking at the latest patch which I attached on  &quot;Last Friday 17:244&quot;&lt;br/&gt;
For understanding the problem, it would be good if you can share logs, threaddumps etc. Is this consistently failiing and which test case in ZxidRolloverTest ?&lt;/p&gt;</comment>
                            <comment id="13806721" author="fpj" created="Mon, 28 Oct 2013 12:34:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;why this fix is affecting ZxidRolloverTest testcases.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&#180;t know, I just know that the test hangs on Windows. I haven&#180;t tested on Linux, but from the QA output I suppose it is not a problem. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it would be good if you can share logs, threaddumps etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok, I&#180;ll upload when I have a chance.&lt;/p&gt;</comment>
                            <comment id="13806729" author="rakeshr" created="Mon, 28 Oct 2013 12:41:16 +0000"  >&lt;p&gt;ok. I tried in Windows 7 env but couldn&apos;t simulate the problem. Is this consistently failiing in your env, also would like to know which test case in ZxidRolloverTest ?&lt;/p&gt;</comment>
                            <comment id="13834922" author="fpj" created="Thu, 28 Nov 2013 15:28:40 +0000"  >&lt;p&gt;Hi Rakesh, When you tried on Win 7, have you been able to get all tests to pass?&lt;/p&gt;

&lt;p&gt;Another thing, the patch does not apply cleanly to b3.4. I was thinking of including it in 3.4.6 if we can converge.&lt;/p&gt;</comment>
                            <comment id="13835209" author="rakeshr" created="Fri, 29 Nov 2013 06:47:01 +0000"  >&lt;p&gt;Thanks Flavio for the interest. I&apos;ve updated the branch3.4 patch. I&apos;m having few problems in my Windows env and not able to run all the test cases&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. But the test cases which uses ZooKeeperServerMain class are running fine. I think, this fix wont affect other test cases, as its closing the FileTxnSnapLog stream in finally block. Any thoughts?&lt;/p&gt;</comment>
                            <comment id="13835309" author="fpj" created="Fri, 29 Nov 2013 10:49:50 +0000"  >&lt;p&gt;It shouldn&apos;t be our goal to fix all test issues on windows here, so it is great if it already solves some. I&apos;ll have a look and check it in today, if I can&apos;t see any other issue. &lt;/p&gt;</comment>
                            <comment id="13835344" author="rakeshr" created="Fri, 29 Nov 2013 12:42:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;It shouldn&apos;t be our goal to fix all test issues on windows here&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yeah, thats true and I agree on this.&lt;/p&gt;</comment>
                            <comment id="13835653" author="fpj" created="Sat, 30 Nov 2013 10:45:03 +0000"  >&lt;p&gt;I&apos;m only going to suggest that we use tmpDir instead of rootDir to be consistent, but I&apos;ll make this change when committing. Otw, +1.&lt;/p&gt;

&lt;p&gt;If no one has a concern with this patch, I&apos;ll commit it soon.&lt;/p&gt;</comment>
                            <comment id="13836107" author="rgs" created="Sun, 1 Dec 2013 20:17:33 +0000"  >&lt;p&gt;One small nit:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+            if (!f.delete())
+                // double check for the file existence
+                if (f.exists()) {
+                    throw new IOException(&quot;Failed to delete file: &quot; + f);
+                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe all around ZK&apos;s source code if statements always have curly braces around their bodies, so:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+            if (!f.delete()) {
+                // double check for the file existence
+                if (f.exists()) {
+                    throw new IOException(&quot;Failed to delete file: &quot; + f);
+                }
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;would play nicer with the incumbent coding style. &lt;/p&gt;</comment>
                            <comment id="13836110" author="rgs" created="Sun, 1 Dec 2013 20:19:21 +0000"  >&lt;p&gt;And one last nit, {} string extrapolation is nicer than concatenating strings. So instead of:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+                    throw new IOException(&quot;Failed to delete file: &quot; + f);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;maybe:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+                    throw new IOException(&quot;Failed to delete file: {}&quot;, f);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;thanks. &lt;/p&gt;</comment>
                            <comment id="13836123" author="fpj" created="Sun, 1 Dec 2013 21:52:18 +0000"  >&lt;p&gt;Thanks for the comments, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;Raul Gutierrez Segales&lt;/a&gt;. There is no need to generate a new patch, I&apos;ll make these changes before committing.&lt;/p&gt;</comment>
                            <comment id="13836124" author="fpj" created="Sun, 1 Dec 2013 21:57:22 +0000"  >&lt;p&gt;Btw, the string extrapolation comment doesn&apos;t seem to be valid, it is not a log message.&lt;/p&gt;</comment>
                            <comment id="13837353" author="rakeshr" created="Tue, 3 Dec 2013 05:27:42 +0000"  >&lt;p&gt;Thank you for the comments. Yes, AFAIK lazy concatenation will be useful for efficient logging, where the string concatenation will only take place if the respective level is set/enabled. Here its throwing exception with err message and I also feel concatentation is fine.&lt;/p&gt;</comment>
                            <comment id="13838921" author="rakeshr" created="Wed, 4 Dec 2013 14:19:05 +0000"  >&lt;p&gt;Thanks Flavio, Raul for the reviews. I just got some time and reworked the patch by using &apos;tmpDir&apos;. Could you please have a look.&lt;/p&gt;</comment>
                            <comment id="13838953" author="hadoopqa" created="Wed, 4 Dec 2013 14:55:39 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12616986/ZOOKEEPER-1459.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12616986/ZOOKEEPER-1459.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1547702.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1816//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1816//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1816//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1816//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1816//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1816//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13838967" author="rgs" created="Wed, 4 Dec 2013 15:11:55 +0000"  >&lt;p&gt;In:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        } finally {
+            if (txnLog != null) {
+                txnLog.close();
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;close can throw IOException. Is there anything we need to do about that?&lt;/p&gt;</comment>
                            <comment id="13839511" author="fpj" created="Wed, 4 Dec 2013 23:59:03 +0000"  >&lt;p&gt;We can catch the exception and log the error, I don&apos;t think there is anything else we need to do. &lt;/p&gt;

&lt;p&gt;Also, please try to concentrate comments in a single post, every new comment generates a new iteration and delays the issue being resolved.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt;, if you don&apos;t have time, let me know and I can wrap this one up. &lt;/p&gt;</comment>
                            <comment id="13839795" author="rakeshr" created="Thu, 5 Dec 2013 04:24:41 +0000"  >&lt;p&gt;Thanks again for the help.&lt;/p&gt;

&lt;p&gt;Do we need to have a separate exception block for &apos;txnLog.close();&apos; ? &lt;br/&gt;
I could see ZooKeeperServerMain#main(String[] args) is already catching &apos;Exception&apos; and doing the necessary actions like, log the error and then exiting. In this case, mostly will throw IOException and this will fall into the invoker exception block. Whats your opinion.&lt;/p&gt;</comment>
                            <comment id="13840278" author="fpj" created="Thu, 5 Dec 2013 17:04:43 +0000"  >&lt;p&gt;Oops, you&apos;re right, runFromConfig already throws IOException, so I don&apos;t think we need to do anything else.&lt;/p&gt;</comment>
                            <comment id="13840280" author="fpj" created="Thu, 5 Dec 2013 17:06:19 +0000"  >&lt;p&gt;Also, are you planning on updating the 3.4 patch? Is it only the dir name rootDir -&amp;gt; tmpDir?&lt;/p&gt;</comment>
                            <comment id="13840322" author="rakeshr" created="Thu, 5 Dec 2013 17:41:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt; Attached branch 3.4 patch. Yes, I&apos;ve modified the rootDir -&amp;gt; tmpDir. Could you please have a look at it.&lt;/p&gt;</comment>
                            <comment id="13840324" author="hadoopqa" created="Thu, 5 Dec 2013 17:42:46 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12617195/ZOOKEEPER-1459-branch-3_4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12617195/ZOOKEEPER-1459-branch-3_4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1547702.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1817//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1817//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13840348" author="rakeshr" created="Thu, 5 Dec 2013 18:01:32 +0000"  >&lt;p&gt;As the &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1459&quot; title=&quot;Standalone ZooKeeperServer is not closing the transaction log files on shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1459&quot;&gt;&lt;del&gt;ZOOKEEPER-1459&lt;/del&gt;&lt;/a&gt;-branch-3_4.patch&quot; is prepared on branch 3.4, I feel this failure is expected. Please excuse.&lt;/p&gt;</comment>
                            <comment id="13841859" author="fpj" created="Fri, 6 Dec 2013 23:11:24 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt;, it looks good.&lt;/p&gt;</comment>
                            <comment id="13842169" author="fpj" created="Sat, 7 Dec 2013 10:19:12 +0000"  >&lt;p&gt;+1, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Trunk: Committed revision 1548825.&lt;br/&gt;
b3.4: Committed revision 1548826.&lt;/p&gt;</comment>
                            <comment id="13842171" author="hudson" created="Sat, 7 Dec 2013 10:33:22 +0000"  >&lt;p&gt;FAILURE: Integrated in ZooKeeper-trunk #2144 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2144/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2144/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1459&quot; title=&quot;Standalone ZooKeeperServer is not closing the transaction log files on shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1459&quot;&gt;&lt;del&gt;ZOOKEEPER-1459&lt;/del&gt;&lt;/a&gt;. Standalone ZooKeeperServer is not closing &lt;br/&gt;
  the transaction log files on shutdown (Rakesh R via fpj) (fpj: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1548825&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1548825&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/ZooKeeperServerMainTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13933796" author="fpj" created="Thu, 13 Mar 2014 18:17:14 +0000"  >&lt;p&gt;Closing issues after releasing 3.4.6.&lt;/p&gt;</comment>
                            <comment id="14003013" author="gzres" created="Tue, 20 May 2014 10:41:31 +0100"  >&lt;p&gt;Is this really fixed? I don&apos;t see the change here: &lt;a href=&quot;http://svn.apache.org/viewvc/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java?view=markup&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java?view=markup&lt;/a&gt;...&lt;/p&gt;

&lt;p&gt;regards&lt;br/&gt;
Grzegorz Grzybek&lt;/p&gt;</comment>
                            <comment id="14003098" author="rakeshr" created="Tue, 20 May 2014 12:12:39 +0100"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gzres&quot; class=&quot;user-hover&quot; rel=&quot;gzres&quot;&gt;Grzegorz Grzybek&lt;/a&gt;, &lt;br/&gt;
I think you are checking wrong file. Please see the below file to understand more,&lt;br/&gt;
&lt;a href=&quot;https://svn.apache.org/repos/asf/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14003106" author="gzres" created="Tue, 20 May 2014 12:27:35 +0100"  >&lt;p&gt;But shouldn&apos;t &lt;tt&gt;ZooKeeperServer&lt;/tt&gt;&apos;s &lt;tt&gt;shutdown&lt;/tt&gt; do the same? We use &lt;tt&gt;ZooKeeperServer&lt;/tt&gt; here: &lt;a href=&quot;https://github.com/grgrzybek/fabric8/blob/master/fabric/fabric-zookeeper/src/main/java/io/fabric8/zookeeper/bootstrap/ZooKeeperServerFactory.java#L176&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/grgrzybek/fabric8/blob/master/fabric/fabric-zookeeper/src/main/java/io/fabric8/zookeeper/bootstrap/ZooKeeperServerFactory.java#L176&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14003326" author="rakeshr" created="Tue, 20 May 2014 15:11:19 +0100"  >&lt;p&gt;This change would cause the following exception, I couldn&apos;t get the reason now. Please run the tests ReadOnlyModeTest#testReadOnlyClient and see it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-05-20 18:02:39,766 [myid:] - ERROR [SyncThread:1:ZooKeeperCriticalThread@47] - Severe unrecoverable error, from thread : SyncThread:1
java.nio.channels.ClosedChannelException
	at sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:88)
	at sun.nio.ch.FileChannelImpl.position(FileChannelImpl.java:243)
	at org.apache.zookeeper.server.persistence.Util.padLogFile(Util.java:215)
	at org.apache.zookeeper.server.persistence.FileTxnLog.padFile(FileTxnLog.java:239)
	at org.apache.zookeeper.server.persistence.FileTxnLog.append(FileTxnLog.java:217)
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.append(FileTxnSnapLog.java:372)
	at org.apache.zookeeper.server.ZKDatabase.append(ZKDatabase.java:542)
	at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:122)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve gone through your code. Since you have handle to &quot;FileTxnSnapLog ftxn&quot;, after the server#shutdown() please close ftxn.close() in your code. Could you use ZooKeeperServerMain#initializeAndRun() and ZooKeeperServerMain#shutdown() for embedding the standalone server ?&lt;/p&gt;

&lt;p&gt;I feel  &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1072&quot; title=&quot;Support for embedded ZooKeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1072&quot;&gt;ZOOKEEPER-1072&lt;/a&gt; could be addressed to define the interfaces clearly to the users.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12617195" name="ZOOKEEPER-1459-branch-3_4.patch" size="3479" author="rakeshr" created="Thu, 5 Dec 2013 17:38:04 +0000"/>
                            <attachment id="12616339" name="ZOOKEEPER-1459-branch-3_4.patch" size="3833" author="rakeshr" created="Fri, 29 Nov 2013 06:23:37 +0000"/>
                            <attachment id="12616986" name="ZOOKEEPER-1459.patch" size="3322" author="rakeshr" created="Wed, 4 Dec 2013 14:19:05 +0000"/>
                            <attachment id="12610310" name="ZOOKEEPER-1459.patch" size="3750" author="rakeshr" created="Fri, 25 Oct 2013 12:54:55 +0100"/>
                            <attachment id="12610294" name="ZOOKEEPER-1459.patch" size="3822" author="davidlao" created="Fri, 25 Oct 2013 09:32:08 +0100"/>
                            <attachment id="12610271" name="ZOOKEEPER-1459.patch" size="1438" author="davidlao" created="Fri, 25 Oct 2013 06:04:11 +0100"/>
                            <attachment id="12607524" name="ZOOKEEPER-1459.patch" size="3779" author="rakeshr" created="Wed, 9 Oct 2013 07:47:41 +0100"/>
                            <attachment id="12606716" name="ZOOKEEPER-1459.patch" size="1505" author="rakeshr" created="Fri, 4 Oct 2013 04:10:13 +0100"/>
                            <attachment id="12606715" name="ZOOKEEPER-1459.patch" size="1436" author="rakeshr" created="Fri, 4 Oct 2013 04:07:58 +0100"/>
                            <attachment id="12525047" name="ZOOKEEPER-1459.patch" size="592" author="rakeshr" created="Mon, 30 Apr 2012 10:16:28 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 30 Apr 2012 09:41:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237452</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10342"><![CDATA[Incompatible change]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwe6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12785</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>