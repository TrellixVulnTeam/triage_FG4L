<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:46:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-318/ZOOKEEPER-318.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-318] remove locking in zk_hashtable.c or add locking in collect_keys()</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-318</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;From a review of zk_hashtable.c it appears to me that all functions which manipulate the hashtables are called from the IO thread, and therefore any need for locking is obviated.&lt;/p&gt;

&lt;p&gt;If I&apos;m wrong about that, then I think at a minimum collect_keys() should acquire a lock in the same manner as collect_session_watchers().  Both iterate over hashtable contents (in the latter case using copy_table()).&lt;/p&gt;

&lt;p&gt;However, from what I can see, the only function (besides the init/destroy functions used when creating a zhandle_t) called from the completion thread is deliverWatchers(), which simply iterates over a &quot;delivery&quot; list created from the hashtables by collectWatchers().  The activateWatcher() function contains comments which describe it being called by the completion thread, but in fact it is called by the IO thread in zookeeper_process().&lt;/p&gt;

&lt;p&gt;I believe all calls to collectWatchers(), activateWatcher(), and collect_keys() are made by the IO thread in zookeeper_interest(), zookeeper_process(), check_events(), send_set_watches(), and handle_error().  Note that queue_session_event() is aliased as PROCESS_SESSION_EVENT, but appears only in handle_error() and check_events().&lt;/p&gt;

&lt;p&gt;Also note that handle_error() is called only in zookeeper_process() and handle_socket_error_msg(), which is used only by the IO thread, so far as I can see.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12414990">ZOOKEEPER-318</key>
            <summary>remove locking in zk_hashtable.c or add locking in collect_keys()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cdarroch">Chris Darroch</assignee>
                                    <reporter username="cdarroch">Chris Darroch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Feb 2009 20:52:02 +0000</created>
                <updated>Wed, 8 Jul 2009 21:24:00 +0100</updated>
                            <resolved>Fri, 6 Mar 2009 00:45:04 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.0.1</version>
                    <version>3.1.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12674354" author="cdarroch" created="Tue, 17 Feb 2009 20:54:44 +0000"  >&lt;p&gt;The attached patch file removes locking, and also marks a number of functions static as per &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-317&quot; title=&quot;avoid exporting functions which may be static&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-317&quot;&gt;ZOOKEEPER-317&lt;/a&gt;.  It further moves some private struct definitions into zk_hashtable.c and removes the unused count variable from collectWatchers() and the associated countList() function.&lt;/p&gt;

&lt;p&gt;These changes obviously remove from functions from the API and so should be considered in the light of the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-317&quot; title=&quot;avoid exporting functions which may be static&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-317&quot;&gt;ZOOKEEPER-317&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12675057" author="cdarroch" created="Thu, 19 Feb 2009 17:44:43 +0000"  >&lt;p&gt;Renamed patch file with issue key.&lt;/p&gt;</comment>
                            <comment id="12675468" author="cdarroch" created="Fri, 20 Feb 2009 20:41:57 +0000"  >&lt;p&gt;Note that this patch does not comprehensively deal with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-317&quot; title=&quot;avoid exporting functions which may be static&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-317&quot;&gt;ZOOKEEPER-317&lt;/a&gt;; there remain others functions that might be marked static and excluded from the exported symbols besides the ones dealt with in this patch.&lt;/p&gt;</comment>
                            <comment id="12676782" author="mahadev" created="Wed, 25 Feb 2009 21:05:42 +0000"  >&lt;p&gt;i looked thorugh the code and what you suggest looks right to me. Thoguh, did you see any performance impact from using the lcoks? if not, I would proabably leave the locks their, since it prevents against future changes (say we have two threads accessing the methods in zk_hashtable.c).. what do you think?&lt;/p&gt;</comment>
                            <comment id="12677147" author="cdarroch" created="Thu, 26 Feb 2009 21:33:27 +0000"  >&lt;p&gt;Well, my own take on things like this and &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-262&quot; title=&quot;unnecesssarily complex reentrant zookeeper_close() logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-262&quot;&gt;ZOOKEEPER-262&lt;/a&gt; is that it&apos;s always good to keep things clean and simple &amp;#8211; a good day of programming in my book is one that removes more lines of code than are created and yet keeps the same or better functionality.&lt;/p&gt;

&lt;p&gt;Aside from any incremental performance gains, I think the big win with both of these patches is that they make the purpose of the code that much more apparent.  A significant part of programming, I believe, is psychology.  A programmer who comes across a package laced with pthread_mutex_lock() statements immediately makes two pretty reasonable assumptions: the code is used in a multi-threaded context, and it&apos;s MT-safe.&lt;/p&gt;

&lt;p&gt;In this case, both assumptions are incorrect; the code isn&apos;t used in an MT context and if it were to be, collect_keys() appears to be lacking the necessary locks and I suspect it would be MT-unsafe.  There could always be other subtle MT-related bugs which haven&apos;t been shaken out too, should one start using it in MT code.&lt;/p&gt;

&lt;p&gt;Thus my own feeling is that it&apos;s better to simplify and remove these locks for a variety of reasons: it makes the code more self-documenting; easier to read, understand, and revise; and marginally faster.&lt;/p&gt;

&lt;p&gt;Should the hashtables need to be used in an MT context in the future, the existing code can always be recovered quickly from SVN.  If there&apos;s an explanatory note in the SVN log that mentions the collect_keys() issue, all the better; then whoever might need to do this work will be prompted to think that aspect through as well.&lt;/p&gt;

&lt;p&gt;That&apos;s just my two cents, of course.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12677592" author="mahadev" created="Fri, 27 Feb 2009 23:07:12 +0000"  >&lt;p&gt;your 2 cents are well received &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; .. &lt;br/&gt;
ill just explain where I come from. From my perspective, a multithreaded c code is the most difficult to debug (after ofcourse assembly language &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ) ... So, I get really uncomfortable removing locks from the c code (maybe i am a little paranoid). I would rather add locks and make it MT safe and be future problem resilient. But ofcourse thats my stand on it. I am not too biased on my opinion and would not like to reject any contributions on my own personal opinion. If you do want to contribute the patch as it is, Ill go ahead with that.&lt;/p&gt;</comment>
                            <comment id="12679440" author="mahadev" created="Fri, 6 Mar 2009 00:45:04 +0000"  >&lt;p&gt;I just committed this. Thnaks chris.&lt;/p&gt;</comment>
                            <comment id="12679633" author="cdarroch" created="Fri, 6 Mar 2009 16:20:11 +0000"  >&lt;p&gt;Cool, thanks.  Much appreciated.&lt;/p&gt;</comment>
                            <comment id="12680848" author="hudson" created="Wed, 11 Mar 2009 11:56:20 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #251 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/251/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/251/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12400532" name="ZOOKEEPER-318.patch" size="7065" author="cdarroch" created="Thu, 19 Feb 2009 17:44:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 25 Feb 2009 21:05:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47904</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzvsv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33136</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Marks some hashtable-related functions static and removes them from the public C API.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>