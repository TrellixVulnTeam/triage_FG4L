<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:44:57 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1504/ZOOKEEPER-1504.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1504] Multi-thread NIOServerCnxn</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1504</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;NIOServerCnxnFactory is single threaded, which doesn&apos;t scale well to large numbers of clients. This is particularly noticeable when thousands of clients connect. I propose multi-threading this code as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1   acceptor thread, for accepting new connections&lt;/li&gt;
	&lt;li&gt;1-N selector threads&lt;/li&gt;
	&lt;li&gt;0-M I/O worker threads&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Numbers of threads are configurable, with defaults scaling according to number of cores. Communication with the selector threads is handled via LinkedBlockingQueues, and connections are permanently assigned to a particular selector thread so that all potentially blocking SelectionKey operations can be performed solely by the selector thread. An ExecutorService is used for the worker threads.&lt;/p&gt;

&lt;p&gt;On a 32 core machine running Linux 2.6.38, achieved best performance with 4 selector threads and 64 worker threads for a 70% +/- 5% improvement in throughput.&lt;/p&gt;

&lt;p&gt;This patch incorporates and supersedes the patches for&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-517&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-517&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1444&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1444&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;New classes introduced in this patch are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ExpiryQueue (from &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1444&quot; title=&quot;Idle session-less connections never time out&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1444&quot;&gt;&lt;del&gt;ZOOKEEPER-1444&lt;/del&gt;&lt;/a&gt;): factor out the logic from SessionTrackerImpl used to expire sessions so that the same logic can be used to expire connections&lt;/li&gt;
	&lt;li&gt;RateLogger (from &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-517&quot; title=&quot;NIO factory fails to close connections when the number of file handles run out.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-517&quot;&gt;&lt;del&gt;ZOOKEEPER-517&lt;/del&gt;&lt;/a&gt;): rate limit error message logging, currently only used to throttle rate of logging &quot;out of file descriptors&quot; errors&lt;/li&gt;
	&lt;li&gt;WorkerService (also in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1505&quot; title=&quot;Multi-thread CommitProcessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1505&quot;&gt;&lt;del&gt;ZOOKEEPER-1505&lt;/del&gt;&lt;/a&gt;): ExecutorService wrapper that makes worker threads daemon threads and names then in an easily debuggable manner. Supports assignable threads (as used by CommitProcessor) and non-assignable threads (as used here).&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12597666">ZOOKEEPER-1504</key>
            <summary>Multi-thread NIOServerCnxn</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="thawan">Thawan Kooburat</assignee>
                                    <reporter username="shrauner">Jay Shrauner</reporter>
                        <labels>
                            <label>performance</label>
                            <label>scaling</label>
                    </labels>
                <created>Thu, 5 Jul 2012 23:53:46 +0100</created>
                <updated>Sat, 11 Apr 2015 23:02:28 +0100</updated>
                                            <version>3.4.3</version>
                    <version>3.4.4</version>
                    <version>3.5.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>16</watches>
                                                                <comments>
                            <comment id="13408087" author="shrauner" created="Fri, 6 Jul 2012 16:50:22 +0100"  >&lt;p&gt;Currently running in our production system. Actual code we&apos;re running has some slight differences due to us developing against 3.4.3 (so, eg, the cnxns set moved from NIOServerCnxnFactory to its parent ServerCnxnFactory post 3.4.3) and more extensive synchronization removals across the codebase in our branch. In particular as it relates to this patch, we&apos;ve very extensively rewritten SessionTrackerImpl, but I&apos;ve tried including in this patch only the portions needed here.&lt;/p&gt;</comment>
                            <comment id="13410181" author="hadoopqa" created="Tue, 10 Jul 2012 10:43:01 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12535701/ZOOKEEPER-1504.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12535701/ZOOKEEPER-1504.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1357711.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 4 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1130//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1130//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1130//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1130//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1130//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1130//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13410471" author="shrauner" created="Tue, 10 Jul 2012 17:13:07 +0100"  >&lt;p&gt;Address findbugs warnings&lt;/p&gt;</comment>
                            <comment id="13410520" author="hadoopqa" created="Tue, 10 Jul 2012 17:48:37 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12535861/ZOOKEEPER-1504.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12535861/ZOOKEEPER-1504.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1357711.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1131//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1131//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1131//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1131//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1131//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1131//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13423682" author="phunt" created="Fri, 27 Jul 2012 06:25:18 +0100"  >&lt;p&gt;Jay could you put this up for review on apache&apos;s reviewboard? &lt;a href=&quot;https://reviews.apache.org/dashboard/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/dashboard/&lt;/a&gt;  Thanks!&lt;/p&gt;</comment>
                            <comment id="13425984" author="shrauner" created="Tue, 31 Jul 2012 19:18:16 +0100"  >&lt;p&gt;Split connection expiration out into separate thread.&lt;/p&gt;</comment>
                            <comment id="13426021" author="hadoopqa" created="Tue, 31 Jul 2012 19:58:06 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12538587/ZOOKEEPER-1504.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12538587/ZOOKEEPER-1504.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1366784.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1147//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1147//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1147//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1147//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1147//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1147//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13426163" author="shrauner" created="Tue, 31 Jul 2012 22:54:39 +0100"  >&lt;p&gt;Posted to reviewboard&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/6256/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/6256/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13475309" author="shrauner" created="Fri, 12 Oct 2012 21:09:11 +0100"  >&lt;p&gt;Rebase&lt;/p&gt;</comment>
                            <comment id="13475337" author="hadoopqa" created="Fri, 12 Oct 2012 21:42:28 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12548950/ZOOKEEPER-1504.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12548950/ZOOKEEPER-1504.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1391526.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1220//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1220//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1220//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1220//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1220//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1220//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13526852" author="hadoopqa" created="Fri, 7 Dec 2012 23:05:04 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12548950/ZOOKEEPER-1504.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12548950/ZOOKEEPER-1504.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1415847.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1287//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1287//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1287//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1287//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1287//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1287//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13526956" author="phunt" created="Sat, 8 Dec 2012 01:27:53 +0000"  >&lt;p&gt;Updated the patch to apply cleanly after &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1505&quot; title=&quot;Multi-thread CommitProcessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1505&quot;&gt;&lt;del&gt;ZOOKEEPER-1505&lt;/del&gt;&lt;/a&gt;. Otherwise no other changes.&lt;/p&gt;</comment>
                            <comment id="13526976" author="hadoopqa" created="Sat, 8 Dec 2012 02:02:41 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12560001/ZOOKEEPER-1504.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12560001/ZOOKEEPER-1504.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1418555.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1289//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1289//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1289//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1289//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1289//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1289//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13526979" author="thawan" created="Sat, 8 Dec 2012 02:08:59 +0000"  >&lt;p&gt;We found that under extremely high workload (a few thousand clients creating short-lived connection), we ran into unix socket leakage issue. We suspected that it was this JDK bug (&lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7118373&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7118373&lt;/a&gt;). When we upgraded to JDK7u6, the problem is resolved.&lt;/p&gt;</comment>
                            <comment id="13532878" author="phunt" created="Sat, 15 Dec 2012 01:43:37 +0000"  >&lt;p&gt;In general looks great. I have been reviewing the code as well as doing other things - such as trying to compile as a dependency of HBase (which is fine btw).&lt;/p&gt;

&lt;p&gt;I noticed that the logs have errors for some tests:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-12-14 17:32:48,002 [myid:] - ERROR [SessionTracker:SessionTrackerImpl@135] - SessionTrackerImpl exited loop!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;due to this change:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-        LOG.info(&quot;SessionTrackerImpl exited loop!&quot;);
+        LOG.error(&quot;SessionTrackerImpl exited loop!&quot;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seems we should only be printing an ERROR in the log for error case, no?&lt;/p&gt;
</comment>
                            <comment id="13533077" author="phunt" created="Sat, 15 Dec 2012 16:40:49 +0000"  >&lt;p&gt;I&apos;ve looked at this over the last couple of weeks and while a complex set of changes it looks good to me. If no other issues are found I&apos;ll commit this on Monday (the logging issue I indentified has to be addressed).&lt;/p&gt;</comment>
                            <comment id="13533687" author="mahadev" created="Mon, 17 Dec 2012 06:55:02 +0000"  >&lt;p&gt;Thawan,&lt;br/&gt;
 I was looking at the patch and it looks like you always have one acceptor thread. Is one acceptor thread enough when we have 1000&apos;s of immediate connections to the ZK servers in case of bootstrap or network glitches? Did you never see an issue with this?&lt;/p&gt;

&lt;p&gt; Read through the patch as well. Looks good to me otherwise.&lt;/p&gt;</comment>
                            <comment id="13534211" author="thawan" created="Mon, 17 Dec 2012 19:35:38 +0000"  >&lt;p&gt;Currently, we haven&apos;t ran into issue where the acceptor is a bottleneck. However, we do see that logging become the bottleneck in those events (especially the log message printed by the acceptor). So I can change various log message to debug level to match our current production code&lt;/p&gt;

&lt;p&gt;Patrick, I think that we made that change by mistake, so I will reverted that line.  &lt;/p&gt;
</comment>
                            <comment id="13534227" author="phunt" created="Mon, 17 Dec 2012 19:47:42 +0000"  >&lt;p&gt;Thanks Thawan. Mahadev: I&apos;d suggest holding off on any further performance related changes (changing debug levels on acceptor logging for example) for a subsequent Jira.&lt;/p&gt;</comment>
                            <comment id="13534246" author="mahadev" created="Mon, 17 Dec 2012 20:03:08 +0000"  >&lt;p&gt;Pat,&lt;br/&gt;
 Makes sense. We can do it in a separate jira.&lt;/p&gt;</comment>
                            <comment id="13534689" author="phunt" created="Tue, 18 Dec 2012 06:12:37 +0000"  >&lt;p&gt;I reviewed the other LOG changes in the patch and they seem fine.&lt;/p&gt;</comment>
                            <comment id="13535772" author="thawan" created="Wed, 19 Dec 2012 08:15:45 +0000"  >&lt;p&gt;Revert log level change in SessionImpl and apply to current trunk&lt;/p&gt;</comment>
                            <comment id="13535785" author="hadoopqa" created="Wed, 19 Dec 2012 08:51:57 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12561664/ZOOKEEPER-1504.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12561664/ZOOKEEPER-1504.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1423778.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1311//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1311//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1311//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1311//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1311//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1311//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13536212" author="phunt" created="Wed, 19 Dec 2012 18:08:30 +0000"  >&lt;p&gt;Thanks Jay! Thanks Thawan! Committed to trunk.&lt;/p&gt;</comment>
                            <comment id="13536949" author="hudson" created="Thu, 20 Dec 2012 11:03:24 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1778 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1778/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1778/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1504&quot; title=&quot;Multi-thread NIOServerCnxn&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1504&quot;&gt;ZOOKEEPER-1504&lt;/a&gt;. Multi-thread NIOServerCnxn (Jay Shrauner via phunt) (Revision 1423990)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
phunt : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1423990&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1423990&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ExpiryQueue.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/RateLogger.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ServerCnxn.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ServerCnxnFactory.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/ServerCnxnTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13553396" author="shralex" created="Tue, 15 Jan 2013 01:46:44 +0000"  >&lt;p&gt;Hi Jay, Thawan,&lt;/p&gt;

&lt;p&gt;I&apos;m trying to adjust my ZK-107 patch to work with your change here, specifically the ability to dynamically modify the port used by servers to accept client connections. I had the following code in NioServerCnxnFactory, that now no longer works:&lt;/p&gt;

&lt;p&gt;+    public void reconfigure(InetSocketAddress addr){&lt;br/&gt;
+        ServerSocketChannel oldSS = ss;        &lt;br/&gt;
+        try &lt;/p&gt;
{
+           this.ss = ServerSocketChannel.open();
+           ss.socket().setReuseAddress(true);
+           LOG.info(&quot;binding to port &quot; + addr);
+           ss.socket().bind(addr);
+           ss.configureBlocking(false);
+           ss.register(selector, SelectionKey.OP_ACCEPT);
+           oldSS.close();
+        }
&lt;p&gt; catch(IOException e) &lt;/p&gt;
{
+           LOG.error(&quot;Error reconfiguring client port to &quot; + addr + &quot; &quot; + e.getMessage());
+        }
&lt;p&gt;+    }&lt;/p&gt;


&lt;p&gt;I&apos;m trying to do something similar with your new code, but its more complex because of the code in AcceptThread. I could change the port as above, create a new AcceptThread and the current AcceptThread would kill itself because the old socket is closed, but it would also take down the selectorthreads, which I don&apos;t think we wanna do in this case. Can you please add a &quot;reconfigure&quot; method to AcceptThread that gets a new ServerSocketChannel ss socket and changes the AcceptThread accordingly ? or please advise on how I can do this correctly.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Alex&lt;/p&gt;


</comment>
                            <comment id="13553515" author="thawan" created="Tue, 15 Jan 2013 05:37:03 +0000"  >&lt;p&gt;Not sure if it is possible, you might be able to modify AcceptThread such that it can be shutdown without calling NIOServerCnxnFactory.this.stop(). Then you can create a new socket and initialize a new AcceptThread but using the old selectorThreads.&lt;/p&gt;</comment>
                            <comment id="13553535" author="shrauner" created="Tue, 15 Jan 2013 06:07:21 +0000"  >&lt;p&gt;If you want to reconfigure the running AcceptThread, add a new API to the AcceptThread so you can signal it to close the old listen socket and open a new one on a new port. Add a new routine &quot;requestReconfig(int port)&quot; that toggles a boolean (&quot;reconfig=true&quot;) and call wakeup() on the AcceptThread. Its main loop currently only checks for pending new connections. Add so it also checks whether its been asked to reconfigure itself. If it has, call a new routine &quot;reconfigure()&quot; that closes the old socket and opens a new one-&lt;del&gt;basically the same code you had before for the opening of the new one. If you look at the selector threads, they do something similar, but much more complicated&lt;/del&gt;-they have a pair of message queues as well as the selector. You don&apos;t need an entire queue here.&lt;/p&gt;

&lt;p&gt;The other option is to toggle a boolean that tells the AcceptThread not to take the rest of the socket factory down with it when it shuts down. Then you could tell one thread to shutdown and fire up another, as Thawan says. The code should, I believe, with a little modification support multiple simultaneous listen sockets by creating an AcceptThread per listen socket but using the same set of selector threads across all of them. Maybe instead of a boolean, add a factor member variable AtomicInteger that counts the number of active AcceptThreads, and trigger the factory shutdown only when that count hits 0? Then for your reconfigure spin up the new AcceptThread/port first before shutting down the old one. I think I lean towards this latter solution simply because the work to support your reconfigure would be the same as for supporting multiple listen sockets, which might be kind of nice to have.&lt;/p&gt;</comment>
                            <comment id="13555142" author="shralex" created="Wed, 16 Jan 2013 15:50:01 +0000"  >&lt;p&gt;thanks guys.&lt;/p&gt;

&lt;p&gt;The following is working for me. Regarding &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1620&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1620&lt;/a&gt;, I can submit a patch to it, I&apos;m just not sure where&apos;s the best place to close the selector. Can you advise on this or fix the issue ? &lt;/p&gt;

&lt;p&gt;    private volatile boolean reconfiguring = false;&lt;br/&gt;
    ...&lt;br/&gt;
    if (!reconfiguring) NIOServerCnxnFactory.this.stop()          &lt;br/&gt;
    else reconfiguring = false;&lt;br/&gt;
    ...&lt;br/&gt;
    public void reconfigure(InetSocketAddress addr){&lt;br/&gt;
        ServerSocketChannel oldSS = ss;        &lt;br/&gt;
        try &lt;/p&gt;
{
           reconfiguring = true;
           this.ss = ServerSocketChannel.open();
           ss.socket().setReuseAddress(true);
           LOG.info(&quot;binding to port &quot; + addr);
           ss.socket().bind(addr);
           ss.configureBlocking(false);
           oldSS.close();           
           acceptThread.wakeupSelector();
           acceptThread = new AcceptThread(ss, addr, selectorThreads);
           acceptThread.start();
        }
&lt;p&gt; catch(IOException e) &lt;/p&gt;
{
           LOG.error(&quot;Error reconfiguring client port to &quot; + addr + &quot; &quot; + e.getMessage());
        }
&lt;p&gt;    }&lt;/p&gt;


</comment>
                            <comment id="13555686" author="thawan" created="Thu, 17 Jan 2013 00:49:45 +0000"  >&lt;p&gt;For AcceptThread, you add a flag so that it will exit after select() return.  Then you can wakeup the selector using wakeupSelector() and close the selector or, according to Java doc, selector.close() will wakeup the blocking select() and close the selector.&lt;/p&gt;</comment>
                            <comment id="13555709" author="shralex" created="Thu, 17 Jan 2013 01:10:10 +0000"  >&lt;p&gt;I don&apos;t think that I fully understand what you mean here.  I&apos;d appreciate it if you could do that and close this bug.&lt;/p&gt;</comment>
                            <comment id="13555716" author="thawan" created="Thu, 17 Jan 2013 01:19:01 +0000"  >&lt;p&gt;Oh sorry, I thought you were talking about closing the selector in the context of reconfiguration.  &lt;br/&gt;
I will comment in 1620 then about that bug. &lt;/p&gt;</comment>
                            <comment id="13555722" author="shralex" created="Thu, 17 Jan 2013 01:24:11 +0000"  >&lt;p&gt;thanks, Thawan! reconfiguration tests now pass locally for me after I&apos;ve fixed my implementation to match ZK-1504, but the tests still fail when I submit them to Hudson, hitting ZK-1620 (which I don&apos;t think is specific to reconfiguration).&lt;/p&gt;</comment>
                            <comment id="13858357" author="fpj" created="Sun, 29 Dec 2013 15:15:24 +0000"  >&lt;p&gt;ServerCnxnTest fails on solaris, check this out:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk-solaris/775/testReport/org.apache.zookeeper.test/ServerCnxnTest/testServerCnxnExpiry/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk-solaris/775/testReport/org.apache.zookeeper.test/ServerCnxnTest/testServerCnxnExpiry/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I suspect that it has something to do with the semantics of Socket#shutdownOutput on Solaris.&lt;/p&gt;</comment>
                            <comment id="13881640" author="thawan" created="Sat, 25 Jan 2014 03:41:07 +0000"  >&lt;p&gt;I don&apos;t have access to solaris platform.   It is possible to get access to build machine so I have dev/test environment?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="12536624">ZOOKEEPER-1347</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12627591">ZOOKEEPER-1620</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12561664" name="ZOOKEEPER-1504.patch" size="101367" author="thawan" created="Wed, 19 Dec 2012 08:15:45 +0000"/>
                            <attachment id="12560001" name="ZOOKEEPER-1504.patch" size="101449" author="phunt" created="Sat, 8 Dec 2012 01:27:53 +0000"/>
                            <attachment id="12548950" name="ZOOKEEPER-1504.patch" size="110516" author="shrauner" created="Fri, 12 Oct 2012 21:09:11 +0100"/>
                            <attachment id="12538587" name="ZOOKEEPER-1504.patch" size="110376" author="shrauner" created="Tue, 31 Jul 2012 19:18:16 +0100"/>
                            <attachment id="12535861" name="ZOOKEEPER-1504.patch" size="107588" author="shrauner" created="Tue, 10 Jul 2012 17:13:07 +0100"/>
                            <attachment id="12535701" name="ZOOKEEPER-1504.patch" size="107210" author="shrauner" created="Mon, 9 Jul 2012 18:40:28 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 10 Jul 2012 09:43:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>239696</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxun33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2559</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>There is a possibility of file descriptor leakage issue under high workload. Please upgrade to the latest version of JVM or the version that has a fix for this bug (&lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7118373&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7118373&lt;/a&gt;)</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>