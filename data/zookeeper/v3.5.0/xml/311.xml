<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:46:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-311/ZOOKEEPER-311.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-311] handle small path lengths in zoo_create()</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-311</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The synchronous completion for zoo_create() contains the following code:&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (sc-&amp;gt;u.str.str_len &amp;gt; strlen(res.path)) {
    len = strlen(res.path);
} else {
    len = sc-&amp;gt;u.str.str_len-1;
}
if (len &amp;gt; 0) {
    memcpy(sc-&amp;gt;u.str.str, res.path, len);
    sc-&amp;gt;u.str.str[len] = &apos;\0&apos;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the case where the max_realpath_len argument to zoo_create() is 0, none of this code executes, which is OK.  In the case where max_realpath_len is 1, a user might expect their buffer to be filled with a null terminator, but again, nothing will happen (even if strlen(res.path) is 0, which is unlikely since new node&apos;s will have paths longer than &quot;/&quot;).&lt;/p&gt;

&lt;p&gt;The name of the argument to zoo_create() is also a little misleading, as is its description (&quot;the maximum length of real path you would want&quot;) in zookeeper.h, and the example usage in the Programmer&apos;s Guide:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;int rc = zoo_create(zh,&quot;/xyz&quot;,&quot;value&quot;, 5, &amp;amp;CREATE_ONLY, ZOO_EPHEMERAL, buffer, sizeof(buffer)-1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In fact this value should be the actual length of the buffer, including space for the null terminator.  If the user supplies a max_realpath_len of 10 and a buffer of 11 bytes, and strlen(res.path) is 10, the code will truncate the returned value to 9 bytes and put the null terminator in the second-last byte, leaving the final byte of the buffer unused.&lt;/p&gt;

&lt;p&gt;It would be better, I think, to rename the realpath and max_realpath_len arguments to something like path_buffer and path_buffer_len, akin to zoo_set().  The path_buffer_len would be treated as the full length of the buffer (as the code does now, in fact, but the docs suggest otherwise).&lt;/p&gt;

&lt;p&gt;The code in the synchronous completion could then be changed as per the attached patch.&lt;/p&gt;

&lt;p&gt;Since this would change, slightly, the behaviour or &quot;contract&quot; of the API, I would be inclined to suggest waiting until 4.0.0 to implement this change.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12414695">ZOOKEEPER-311</key>
            <summary>handle small path lengths in zoo_create()</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cdarroch">Chris Darroch</assignee>
                                    <reporter username="cdarroch">Chris Darroch</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Feb 2009 20:03:36 +0000</created>
                <updated>Sat, 5 Sep 2009 23:36:19 +0100</updated>
                            <resolved>Thu, 6 Aug 2009 19:17:11 +0100</resolved>
                                    <version>3.0.0</version>
                    <version>3.0.1</version>
                    <version>3.1.0</version>
                    <version>3.1.1</version>
                    <version>3.2.0</version>
                                    <fixVersion>3.2.1</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12675059" author="cdarroch" created="Thu, 19 Feb 2009 17:50:38 +0000"  >&lt;p&gt;Renamed patch file with issue key.&lt;/p&gt;</comment>
                            <comment id="12675467" author="cdarroch" created="Fri, 20 Feb 2009 20:36:20 +0000"  >&lt;p&gt;Changes parameter names as suggested and revises C API documentation.&lt;/p&gt;</comment>
                            <comment id="12697949" author="breed" created="Fri, 10 Apr 2009 20:55:53 +0100"  >&lt;p&gt;this is really just a documentation bug. is there a reason you are changing logic?&lt;/p&gt;</comment>
                            <comment id="12697996" author="cdarroch" created="Fri, 10 Apr 2009 22:57:48 +0100"  >&lt;p&gt;Mostly because the existing logic is a little counter-intuitive.  I spent quite a bit of time looking at it while trying to determine it&apos;s behaviour in various cases &amp;#8212; e.g., what happens if my buffer is 1 byte long?  Because I was writing a wrapper library (Net::ZooKeeper) and not a client application, I didn&apos;t know what &quot;max path len&quot; the user might supply and I wanted to ensure consistent behaviour.&lt;/p&gt;

&lt;p&gt;Typical C functions that take a buffer and fill it (e.g., snprintf()) rarely do nothing if the buffer is 1 byte long; instead, they fill it with a null terminator.  So that&apos;s surprising and counterintuitive.&lt;/p&gt;

&lt;p&gt;What I ended up doing in Net::ZooKeeper was preventing users from supplying &quot;max path len&quot; values less than 2.&lt;/p&gt;

&lt;p&gt;My other concern is really just about future-proofing.  Suppose in a future release ZooKeeper returns null paths from create() calls for some reason &amp;#8212; because of some new feature (&quot;virtual nodes&quot;?) or whatever.  Anyway, in this case, the user might reasonably expect a 1-byte buffer to be (marginally) useful.  Or perhaps the code gets copied and re-used in another context where 1-byte buffers make more sense.&lt;/p&gt;

&lt;p&gt;The code rewrite, although simple, I think clarifies what&apos;s going on in a way that will help prevent buffer problems in the future &amp;#8212; always a sore point when coding in C.  First we calculate the len of the buffer that would be required for the full path, including space for the null terminator.  If that&apos;s longer than what we&apos;ve been given, we truncate to what we have.  If there&apos;s anything to do at this point (i.e., the supplied buffer had at least one byte), then we do it.&lt;/p&gt;</comment>
                            <comment id="12711316" author="breed" created="Wed, 20 May 2009 21:21:40 +0100"  >&lt;p&gt;i think we should commit this patch now. the only change in behavior is when the length of the buffer to receive the name is of length 1. it is a silly corner case, but really the fact that we don&apos;t put a null there should be considered a bug.&lt;/p&gt;</comment>
                            <comment id="12716328" author="breed" created="Thu, 4 Jun 2009 18:23:37 +0100"  >&lt;p&gt;i&apos;m ready to commit this, but we need a test case. it would be nice if it could test name buffers of size 0 to 3. can you do this chris, or do you need me to write it?&lt;/p&gt;</comment>
                            <comment id="12725297" author="cdarroch" created="Mon, 29 Jun 2009 19:15:39 +0100"  >&lt;p&gt;This revision is a good demonstration of why one should never trust a programmer, especially if there&apos;s a degree of hubris involved (&quot;It&apos;s just a small patch, what could go wrong?&quot;)  In testing, I found I had an off-by-one error when calculating where to put the trailing null.  Sigh.&lt;/p&gt;

&lt;p&gt;I agree this shouldn&apos;t be committed without some tests.  I&apos;m at virtually 100% capacity at the moment with just my paid work so it may take me a while to do this; it is my next to-do, though.  If someone else wants to write a few tests in the meantime, that would also be great.&lt;/p&gt;</comment>
                            <comment id="12730688" author="cdarroch" created="Tue, 14 Jul 2009 05:41:19 +0100"  >&lt;p&gt;Updated to current trunk, with some tests added for extra crunchy goodness.&lt;/p&gt;</comment>
                            <comment id="12732581" author="breed" created="Fri, 17 Jul 2009 16:45:19 +0100"  >&lt;p&gt;+1 great job chris! i likke your test cases. thanx.  now let me see if i can find out why qa isn&apos;t running...&lt;/p&gt;</comment>
                            <comment id="12732654" author="mahadev" created="Fri, 17 Jul 2009 19:09:07 +0100"  >&lt;p&gt;the qa isnt running because the nightly builds are failing. This should be fixed soon and we can get the patch process back on track.&lt;/p&gt;</comment>
                            <comment id="12737148" author="hadoopqa" created="Thu, 30 Jul 2009 16:51:13 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12413380/ZOOKEEPER-311.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12413380/ZOOKEEPER-311.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 798038.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/160/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/160/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/160/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/160/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/160/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/160/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12740180" author="breed" created="Thu, 6 Aug 2009 19:17:11 +0100"  >&lt;p&gt;commit to 3.2 branch: Committed revision 801756.&lt;br/&gt;
commit to trunk: Committed revision 801747.&lt;/p&gt;</comment>
                            <comment id="12740291" author="hudson" created="Thu, 6 Aug 2009 23:45:05 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #407 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/407/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/407/&lt;/a&gt;)&lt;br/&gt;
    . handle small path lengths in zoo_create()&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12413380" name="ZOOKEEPER-311.patch" size="5854" author="cdarroch" created="Tue, 14 Jul 2009 05:41:19 +0100"/>
                            <attachment id="12400626" name="ZOOKEEPER-311.patch" size="3549" author="cdarroch" created="Fri, 20 Feb 2009 20:36:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 10 Apr 2009 19:55:53 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47907</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10342"><![CDATA[Incompatible change]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzy5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33519</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The zoo_create() function is revised to take path_buffer and path_buffer_len arguments.  The path_buffer will be filled with as much of the actual path of the new node fits into the buffer, including a null terminator.  Unlike previous behavior, if path_buffer_len (formerly max_realpath_len) is 1, the buffer will be filled with a single null terminator.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>