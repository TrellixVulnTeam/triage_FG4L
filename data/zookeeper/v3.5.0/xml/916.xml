<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:40:16 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-916/ZOOKEEPER-916.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-916] Problem receiving messages from subscribed channels in c++ client </title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-916</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We see this bug with receiving messages from a subscribed channel.  This problem seems to happen with larger messages.  The flow is to first read at least 4 bytes from the socket channel. Extract the first 4 bytes to get the message size.  If we&apos;ve read enough data into the buffer already, we&apos;re done so invoke the messageReadCallbackHandler passing the channel and message size.  If not, then do an async read for at least the remaining amount of bytes in the message from the socket channel.  When done, invoke the messageReadCallbackHandler.&lt;/p&gt;

&lt;p&gt;The problem seems that when the second async read is done, the same sizeReadCallbackHandler is invoked instead of the messageReadCallbackHandler.  The result is that we then try to read the first 4 bytes again from the buffer.  This will get a random message size and screw things up.  I&apos;m not sure if it&apos;s an incorrect use of the boost asio async_read function or we&apos;re doing the boost bind to the callback function incorrectly.&lt;/p&gt;


&lt;p&gt;101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler system:0,512 channel(0x80b7a18)&lt;br/&gt;
101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler: size of buffer before reading message size: 512 channel(0x80b7a18)&lt;br/&gt;
101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler: size of incoming message 599, currently in buffer 508 channel(0x80b7a18)&lt;br/&gt;
101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler: Still have more data to read, 91 from channel(0x80b7a18)&lt;br/&gt;
101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler system:0, 91 channel(0x80b7a18)&lt;br/&gt;
101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler: size of buffer before reading message size: 599 channel(0x80b7a18)&lt;br/&gt;
101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler: size of incoming message 134287360, currently in buffer 595 channel(0x80b7a18)&lt;br/&gt;
101015 15:30:40.108 DEBUG hedwig.channel.cpp - DuplexChannel::sizeReadCallbackHandler: Still have more data to read, 134286765 from channel(0x80b7a18)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12478968">ZOOKEEPER-916</key>
            <summary>Problem receiving messages from subscribed channels in c++ client </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Nov 2010 09:10:22 +0000</created>
                <updated>Fri, 5 Nov 2010 10:52:47 +0000</updated>
                            <resolved>Fri, 5 Nov 2010 06:45:07 +0000</resolved>
                                                                    <component>contrib-hedwig</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12927799" author="ikelly" created="Wed, 3 Nov 2010 09:12:46 +0000"  >&lt;p&gt;The root cause is that startReceiving is called from both startDelivery and the connect callback. This is correct&lt;br/&gt;
because there are scenarios where it may be needed in both. The checking of the receiving flag is the correct way to&lt;br/&gt;
resolve this. &lt;/p&gt;

&lt;p&gt;However, this double call of startReceiving really happens &lt;b&gt;every&lt;/b&gt; time you use the c++ client to receive on a&lt;br/&gt;
subscription, so it wasn&apos;t clear why we&apos;ve only seen the problem now. &lt;/p&gt;

&lt;p&gt;Turns out that it only triggers when a partial message is received, so we only saw it when the messages were very big.&lt;br/&gt;
For example, if the message is 100 bytes, the 100 bytes will arrive to the c++ client at the same time&lt;br/&gt;
sizeReadCallbackHandler will read the size out of the buffer and since the whole message is already in the buffer will&lt;br/&gt;
call messageReadCallbackHandler directly instead of calling into asio to read more from the buffer. After&lt;br/&gt;
messageReadCallbackHandler has finished, there will be 0 bytes in the buffer, or another whole message in the buffer,&lt;br/&gt;
so the second invocation of sizeReadCallbackHandler will behave correctly. &lt;/p&gt;

&lt;p&gt;However, if the message is bigger than the MTU, then the first sizeReadCallbackHandler will run, which reads the&lt;br/&gt;
message size from the buffer. It then sees that the remaining bytes in the buffer are fewer than the size of the&lt;br/&gt;
message, so makes a call to async_read to get more, and the function end. At this point the second&lt;br/&gt;
sizeReadCallbackHandler runs, sees junk and craps out. &lt;/p&gt;</comment>
                            <comment id="12928518" author="breed" created="Fri, 5 Nov 2010 06:44:31 +0000"  >&lt;p&gt;+1 thanx for the fix ivan!&lt;/p&gt;</comment>
                            <comment id="12928519" author="breed" created="Fri, 5 Nov 2010 06:45:07 +0000"  >&lt;p&gt;Committed revision 1031453.&lt;/p&gt;</comment>
                            <comment id="12928559" author="hudson" created="Fri, 5 Nov 2010 10:52:47 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #991 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/991/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/991/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-916&quot; title=&quot;Problem receiving messages from subscribed channels in c++ client &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-916&quot;&gt;&lt;del&gt;ZOOKEEPER-916&lt;/del&gt;&lt;/a&gt;. Problem receiving messages from subscribed channels in c++ client&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12458726" name="ZOOKEEPER-916.patch" size="2922" author="ikelly" created="Wed, 3 Nov 2010 09:13:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 5 Nov 2010 06:44:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47549</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxztsv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32812</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>