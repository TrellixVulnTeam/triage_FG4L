<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:41:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1840/ZOOKEEPER-1840.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1840] Server tries to connect to itself during dynamic reconfig</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1840</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Submitted this bug on a suggestion of Alexander Shraer (see &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1691&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1691&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;How to reproduce:&lt;/p&gt;

&lt;p&gt;== Server 1 zoo.cfg:&lt;br/&gt;
standaloneEnabled=false&lt;br/&gt;
dynamicConfigFile=&amp;lt;path to&amp;gt;/confdyn1/zoo.cfg.dynamic&lt;/p&gt;

&lt;p&gt;== Server 1 zoo.cfg.dynamic:&lt;br/&gt;
server.1=localhost:2888:3888:participant;localhost:2181&lt;/p&gt;

&lt;p&gt;== Server 2 zoo.cfg:&lt;br/&gt;
standaloneEnabled=false&lt;br/&gt;
dynamicConfigFile=&amp;lt;path to&amp;gt;/confdyn2/zoo.cfg.dynamic&lt;/p&gt;

&lt;p&gt;== Server 2 zoo.cfg.dynamic (it is &quot;aware&quot; of the server 1, as mentioned in the Dynamic Reconfiguration - User Manual&lt;br/&gt;
that I should have read more carefully yesterday):&lt;br/&gt;
server.1=localhost:2888:3888:participant;localhost:2181&lt;br/&gt;
server.2=localhost:2889:3889:participant;localhost:2182&lt;/p&gt;

&lt;p&gt;Start server 1 &lt;br/&gt;
Start server 2 &lt;/p&gt;

&lt;p&gt;== use client 1 to issue a reconfig command on server 1:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;zk: localhost:2181(CONNECTED) 1&amp;#93;&lt;/span&gt; reconfig -add server.2=localhost:2889:3889:participant;localhost:2182&lt;br/&gt;
Committed new configuration:&lt;br/&gt;
server.1=localhost:2888:3888:participant;localhost:2181&lt;br/&gt;
server.2=localhost:2889:3889:participant;localhost:2182&lt;br/&gt;
version=100000003&lt;/p&gt;

&lt;p&gt;There are strange stack traces in both server consoles.&lt;/p&gt;

&lt;p&gt;Server 1:&lt;br/&gt;
2013-12-12 22:31:40,888 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1)::QuorumCnxManager@390&amp;#93;&lt;/span&gt; - Cannot open channel to 2 at election address localhost/127.0.0.1:3889&lt;br/&gt;
java.net.ConnectException: Connection refused: connect&lt;br/&gt;
at java.net.PlainSocketImpl.socketConnect(Native Method)&lt;br/&gt;
at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:351)&lt;br/&gt;
at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:213)&lt;br/&gt;
at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:200)&lt;br/&gt;
at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)&lt;br/&gt;
at java.net.Socket.connect(Socket.java:529)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:375)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumPeer.connectNewPeers(QuorumPeer.java:1252)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumPeer.setLastSeenQuorumVerifier(QuorumPeer.java:1272)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.Leader.propose(Leader.java:1071)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.ProposalRequestProcessor.processRequest(ProposalRequestProcessor.java:78)&lt;br/&gt;
at org.apache.zookeeper.server.PrepRequestProcessor.pRequest(PrepRequestProcessor.java:864)&lt;br/&gt;
at org.apache.zookeeper.server.PrepRequestProcessor.run(PrepRequestProcessor.java:144)&lt;br/&gt;
2013-12-12 22:31:41,919 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/127.0.0.1:52301:QuorumPeer@1259&amp;#93;&lt;/span&gt; - Restarting Leader Election&lt;br/&gt;
2013-12-12 22:31:41,920 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;localhost/127.0.0.1:3888:QuorumCnxManager$Listener@571&amp;#93;&lt;/span&gt; - Leaving listener&lt;br/&gt;
2013-12-12 22:31:41,920 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeerListener:QuorumCnxManager$Listener@544&amp;#93;&lt;/span&gt; - My election bind port: localhost/127.0.0.1:3888&lt;br/&gt;
2013-12-12 22:31:44,438 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - INFO [WorkerReceiver&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=1&amp;#93;&lt;/span&gt;:FastLeaderElection$Messenger$WorkerReceiver@410] - WorkerReceiver is down&lt;br/&gt;
2013-12-12 22:31:44,439 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - INFO [WorkerSender&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=1&amp;#93;&lt;/span&gt;:FastLeaderElection$Messenger$WorkerSender@442] - WorkerSender is down&lt;/p&gt;

&lt;p&gt;Server 2:&lt;br/&gt;
2013-12-12 22:31:41,894 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - WARN [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=2&amp;#93;&lt;/span&gt;/127.0.0.1:2182:QuorumCnxManager@390] - Cannot open channel to 2 at election address localhost/127.0.0.1:3889&lt;br/&gt;
java.net.ConnectException: Connection refused: connect&lt;br/&gt;
at java.net.PlainSocketImpl.socketConnect(Native Method)&lt;br/&gt;
at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:351)&lt;br/&gt;
at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:213)&lt;br/&gt;
at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:200)&lt;br/&gt;
at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)&lt;br/&gt;
at java.net.Socket.connect(Socket.java:529)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:375)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumPeer.connectNewPeers(QuorumPeer.java:1252)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumPeer.setLastSeenQuorumVerifier(QuorumPeer.java:1272)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.Follower.processPacket(Follower.java:131)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:89)&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:967)&lt;br/&gt;
2013-12-12 22:31:41,923 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - WARN [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=2&amp;#93;&lt;/span&gt;/127.0.0.1:2182:QuorumPeer@1259] - Restarting Leader Election&lt;br/&gt;
2013-12-12 22:31:41,924 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeerListener:QuorumCnxManager$Listener@544&amp;#93;&lt;/span&gt; - My election bind port: localhost/127.0.0.1:3889&lt;/p&gt;</description>
                <environment></environment>
        <key id="12684665">ZOOKEEPER-1840</key>
            <summary>Server tries to connect to itself during dynamic reconfig</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shralex">Alexander Shraer</assignee>
                                    <reporter username="bfreuden">Bruno Freudensprung</reporter>
                        <labels>
                    </labels>
                <created>Sat, 14 Dec 2013 11:53:47 +0000</created>
                <updated>Wed, 16 Apr 2014 12:07:14 +0100</updated>
                            <resolved>Wed, 16 Apr 2014 08:07:22 +0100</resolved>
                                    <version>3.5.0</version>
                                                    <component>quorum</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13970037" author="shralex" created="Tue, 15 Apr 2014 21:42:16 +0100"  >&lt;p&gt;This issue is not about reconfig, so I&apos;m renaming the JIRA. Its about whether or not to have an explicit connection from a server to in QuorumCnxManager.java&lt;/p&gt;

&lt;p&gt;It looks like in FLE we a server skips sending messages to itself by immediately putting the message in the receiving queue, so although a connection to itself exists it will not be used.&lt;/p&gt;

&lt;p&gt;But if I understand correctly a leader will explicitly send operations (proposals) to itself over an open connection. When a message is received it passes through several layers of request processors. So its not so clear to me on what layer we&apos;d want to enqueue a packet from the leader to itself if we want to avoid explicitly sending it. Alternatively we could jut explicitly call Leader.processAck(myself) before sending the packet to others. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=breed&quot; class=&quot;user-hover&quot; rel=&quot;breed&quot;&gt;Benjamin Reed&lt;/a&gt;, others, what do you think ? is this something we want to fix ?&lt;/p&gt;</comment>
                            <comment id="13970464" author="michim" created="Wed, 16 Apr 2014 06:52:44 +0100"  >&lt;p&gt;I&apos;m a bit confused by the summary. Aren&apos;t both server 1 and 2 trying to connect to server 2?&lt;/p&gt;</comment>
                            <comment id="13970484" author="shralex" created="Wed, 16 Apr 2014 07:18:53 +0100"  >&lt;p&gt;I just noticed that the specific error in the description is due to something else - when we reconfigure, we restart leader election, which involves shutting down QCM. I think this is why 1 can&apos;t connect to 2 momentarily. On the other hand 2 tries to connect to 1 from connectNewPeers, and the attached patch prevents this.&lt;/p&gt;

&lt;p&gt;I&apos;m still not sure whether QCM connects to itself by default when its created.&lt;/p&gt;</comment>
                            <comment id="13970485" author="shralex" created="Wed, 16 Apr 2014 07:19:49 +0100"  >&lt;p&gt;sorry I meant &quot;2 tries to connect to 2 from connectNewPeers&quot;&lt;/p&gt;</comment>
                            <comment id="13970491" author="michim" created="Wed, 16 Apr 2014 07:29:55 +0100"  >&lt;p&gt;QuorumCnxManager doesn&apos;t connect to itself by default.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java#L322&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java#L322&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13970496" author="shralex" created="Wed, 16 Apr 2014 07:36:45 +0100"  >&lt;p&gt;I found this line, but its used by FLE only, not leader -&amp;gt; follower. What about connections for sending the operation proposals ?&lt;/p&gt;</comment>
                            <comment id="13970511" author="michim" created="Wed, 16 Apr 2014 07:53:52 +0100"  >&lt;p&gt;If I understand it correctly, followers/observers connect to the leader by calling connectToLeader(). The leader accepts connections and initialize LearnerHandler objects. It doesn&apos;t use QuorumCnxManager, and the leader doesn&apos;t connect to itself.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L390&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L390&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13970516" author="shralex" created="Wed, 16 Apr 2014 07:59:52 +0100"  >&lt;p&gt;Thanks, you&apos;re right. I guess its too late here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I found how this works now - ProposalRequestProcessor on the leader invokes propose() that sends messages to all learners and then ProposalRequestProcessor hands it over to AckRequestProcessor that creates an ACK from the leader itself. Anyway, I changed the title back to what it was. I tried the patch, looks like it solves the issue - no message from 2 to 2 connection failure.&lt;/p&gt;</comment>
                            <comment id="13970518" author="hadoopqa" created="Wed, 16 Apr 2014 08:00:43 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12640396/ZOOKEEPER-1840.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12640396/ZOOKEEPER-1840.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1587812.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2045//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2045//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2045//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2045//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2045//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2045//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13970522" author="michim" created="Wed, 16 Apr 2014 08:06:40 +0100"  >&lt;p&gt;+1 Thanks Alex!&lt;/p&gt;</comment>
                            <comment id="13970523" author="michim" created="Wed, 16 Apr 2014 08:07:22 +0100"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1587818&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1587818&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13970672" author="hudson" created="Wed, 16 Apr 2014 12:07:14 +0100"  >&lt;p&gt;FAILURE: Integrated in ZooKeeper-trunk #2292 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2292/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2292/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1840&quot; title=&quot;Server tries to connect to itself during dynamic reconfig&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1840&quot;&gt;&lt;del&gt;ZOOKEEPER-1840&lt;/del&gt;&lt;/a&gt;. Server tries to connect to itself during dynamic reconfig (Alexander Shraer via michim) (michim: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1587818&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1587818&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12640396" name="ZOOKEEPER-1840.patch" size="864" author="shralex" created="Wed, 16 Apr 2014 07:21:49 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 15 Apr 2014 20:42:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363737</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzkjk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>364043</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>