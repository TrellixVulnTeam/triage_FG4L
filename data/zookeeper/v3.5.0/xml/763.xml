<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:49:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-763/ZOOKEEPER-763.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-763] Deadlock on close w/ zkpython / c client</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-763</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;deadlocks occur if we attempt to close a handle while there are any outstanding async requests (aget, acreate, etc). Normally on close both the io thread terminates and the completion thread are terminated and joined, however w\ith outstanding async requests, the completion thread won&apos;t be in a joinable state, and we effectively hang when the main thread does the join.&lt;/p&gt;

&lt;p&gt;afaics ideal behavior would be on close of a handle, to effectively clear out any remaining callbacks and let the completion thread terminate.&lt;/p&gt;

&lt;p&gt;i&apos;ve tried adding some bookkeeping to within a python client to guard against closing while there is an outstanding async completion request, but its an imperfect solution since even after the python callback is executed there is still a window for deadlock before the completion thread finishes the callback.&lt;/p&gt;

&lt;p&gt;a simple example to reproduce the deadlock is attached.&lt;/p&gt;</description>
                <environment>&lt;p&gt;ubuntu 10.04, zookeeper 3.3.0 and trunk&lt;/p&gt;</environment>
        <key id="12463663">ZOOKEEPER-763</key>
            <summary>Deadlock on close w/ zkpython / c client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henryr">Henry Robinson</assignee>
                                    <reporter username="kapilt">Kapil Thangavelu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 May 2010 14:09:43 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:44 +0000</updated>
                            <resolved>Wed, 5 May 2010 23:02:10 +0100</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>contrib-bindings</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12863803" author="kapilt" created="Tue, 4 May 2010 14:13:16 +0100"  >&lt;p&gt;a simple example that exhibits deadlock behavior on close.&lt;/p&gt;</comment>
                            <comment id="12864403" author="kapilt" created="Wed, 5 May 2010 18:01:34 +0100"  >&lt;p&gt;A gdb stack trace on the process after it deadlocks.&lt;/p&gt;</comment>
                            <comment id="12864429" author="henryr" created="Wed, 5 May 2010 19:06:43 +0100"  >&lt;p&gt;Hi Kapil - &lt;/p&gt;

&lt;p&gt;As seems to be the norm for me this week, I&apos;m struggling to reproduce &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; It does seem like your python script explicitly waits for a completion to be called before closing a handle. Is this enough to leave an outstanding completion on the queue?&lt;/p&gt;

&lt;p&gt;Can you capture the stacktrace for the completion thread? I think it must be getting stuck in process_completions but it would be very valuable to know where - if it&apos;s stuck on the callback into zkpython then that means the deadlock is in the python bindings and not solely in C-land.&lt;/p&gt;

&lt;p&gt;cheers,&lt;br/&gt;
Henry&lt;/p&gt;</comment>
                            <comment id="12864452" author="kapilt" created="Wed, 5 May 2010 20:08:18 +0100"  >&lt;p&gt;Hi Henry&lt;/p&gt;

&lt;p&gt;The issue with the example i sent is that when the condition notify happens in the python callback, the main process thread can start running before the callback has exited and the completion thread will still be running. It could probably make be made more explicit for reproducing by inserting a time.sleep(1) line into the callback after the notify.&lt;/p&gt;

&lt;p&gt;This is the stack trace for the completion thread on deadlock.&lt;/p&gt;

&lt;p&gt;#0  0x00cb8422 in __kernel_vsyscall ()&lt;br/&gt;
#1  0x00387245 in sem_wait@@GLIBC_2.1 () from /lib/tls/i686/cmov/libpthread.so.0&lt;br/&gt;
#2  0x0810abe8 in PyThread_acquire_lock ()&lt;br/&gt;
#3  0x080dcc11 in PyEval_EvalFrameEx ()&lt;br/&gt;
#4  0x080e2807 in PyEval_EvalCodeEx ()&lt;br/&gt;
#5  0x080e0c8b in PyEval_EvalFrameEx ()&lt;br/&gt;
#6  0x080e1bb0 in PyEval_EvalFrameEx ()&lt;br/&gt;
#7  0x080e2807 in PyEval_EvalCodeEx ()&lt;br/&gt;
#8  0x0816b2ac in ?? ()&lt;br/&gt;
#9  0x0806245a in PyObject_Call ()&lt;br/&gt;
#10 0x080db892 in PyEval_CallObjectWithKeywords ()&lt;br/&gt;
#11 0x080624f0 in PyObject_CallObject ()&lt;br/&gt;
#12 0x00a8dd95 in data_completion_dispatch (rc=0, value=0xa01dcd8 &quot;8\334\001\n\370\263N&quot;, value_len=0, stat=0xb773828c, data=0xa0035d0) at src/c/zookeeper.c:410&lt;br/&gt;
#13 0x00f33ecc in process_completions (zh=0xa024ab0) at src/zookeeper.c:1778&lt;br/&gt;
#14 0x00f4005b in do_completion (v=0xa024ab0) at src/mt_adaptor.c:333&lt;br/&gt;
#15 0x0038096e in start_thread () from /lib/tls/i686/cmov/libpthread.so.0&lt;br/&gt;
#16 0x00461a0e in clone () from /lib/tls/i686/cmov/libc.so.6&lt;/p&gt;

&lt;p&gt;thanks,&lt;br/&gt;
Kapil&lt;/p&gt;</comment>
                            <comment id="12864453" author="kapilt" created="Wed, 5 May 2010 20:13:22 +0100"  >&lt;p&gt;new version of the deadlock script that uses an explicit sleep to get a thread switch, instead of  looping around the function and hoping it happens.&lt;/p&gt;</comment>
                            <comment id="12864488" author="henryr" created="Wed, 5 May 2010 21:20:24 +0100"  >&lt;p&gt;Kapil - &lt;/p&gt;

&lt;p&gt;Thanks! Adding that sleep helped me understand what was going on. &lt;/p&gt;

&lt;p&gt;pyzoo_close has the GIL but blocks inside zookeeper_close, waiting for the completion thread to finish. However, if a completion is still inside Python, but has been pre-empted by the main thread which calls pyzoo_close, the completion can&apos;t get the GIL back to finish up executing, blocking the completions_thread for ever more. The fix is simple - relinquish the GIL during the zookeeper_close call, and then reacquire it straight after. There are even handy macros to do this:&lt;/p&gt;

&lt;p&gt;Py_BEGIN_ALLOW_THREADS&lt;br/&gt;
ret = zookeeper_close(zhandles&lt;span class=&quot;error&quot;&gt;&amp;#91;zkhid&amp;#93;&lt;/span&gt;);&lt;br/&gt;
Py_END_ALLOW_THREADS&lt;/p&gt;

&lt;p&gt;This same issue will affect any part of zkpython where a call to the C client is blocked on some work being completed in another Python thread - in practice, I think this means from callbacks. I&apos;ll audit the code to see if any other API calls are affected. Patch to fix this issue is following shortly - Kapil, I&apos;d be very grateful if you could help us by testing it. &lt;/p&gt;

&lt;p&gt;cheers,&lt;br/&gt;
Henry&lt;/p&gt;</comment>
                            <comment id="12864503" author="henryr" created="Wed, 5 May 2010 22:06:53 +0100"  >&lt;p&gt;Patch attached, with new test (note that test will hang if it fails, no obvious way to fix that - will open a JIRA to track).&lt;/p&gt;

&lt;p&gt;Also included is fix for type in acl_test.py; not sure how I allowed that to creep in :/&lt;/p&gt;</comment>
                            <comment id="12864508" author="hadoopqa" created="Wed, 5 May 2010 22:12:26 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12443765/ZOOKEEPER-763.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12443765/ZOOKEEPER-763.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 941473.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/83/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/83/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12864511" author="henryr" created="Wed, 5 May 2010 22:20:44 +0100"  >&lt;p&gt;Forgot --no-prefix again :/&lt;/p&gt;</comment>
                            <comment id="12864517" author="phunt" created="Wed, 5 May 2010 22:29:04 +0100"  >&lt;p&gt;This addressed the problem on my machine (ubuntu karmic)&lt;/p&gt;</comment>
                            <comment id="12864523" author="kapilt" created="Wed, 5 May 2010 22:36:29 +0100"  >&lt;p&gt;works for me on a couple of different zkpython apps (ubuntu lucid) , thanks! &lt;/p&gt;</comment>
                            <comment id="12864539" author="hadoopqa" created="Wed, 5 May 2010 22:48:35 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12443769/ZOOKEEPER-763.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12443769/ZOOKEEPER-763.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 941473.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/149/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/149/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/149/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/149/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/149/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/149/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12864546" author="phunt" created="Wed, 5 May 2010 22:59:32 +0100"  >&lt;p&gt;updated patch for 3.3 branch&lt;/p&gt;</comment>
                            <comment id="12864548" author="phunt" created="Wed, 5 May 2010 23:02:10 +0100"  >&lt;p&gt;+1, thanks Henry (and Kapil!)&lt;/p&gt;</comment>
                            <comment id="12864871" author="phunt" created="Thu, 6 May 2010 19:14:45 +0100"  >&lt;p&gt;For some reason I got confused on the 3.3 branch (may not have been up to date), the main patch applies to both just fine. Fixed this in svn.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12443769" name="ZOOKEEPER-763.patch" size="3209" author="henryr" created="Wed, 5 May 2010 22:20:44 +0100"/>
                            <attachment id="12443765" name="ZOOKEEPER-763.patch" size="2686" author="henryr" created="Wed, 5 May 2010 22:06:52 +0100"/>
                            <attachment id="12443579" name="deadlock.py" size="440" author="kapilt" created="Tue, 4 May 2010 14:13:16 +0100"/>
                            <attachment id="12443751" name="deadlock_v2.py" size="409" author="kapilt" created="Wed, 5 May 2010 20:13:22 +0100"/>
                            <attachment id="12443734" name="stack-trace-deadlock.txt" size="716" author="kapilt" created="Wed, 5 May 2010 18:01:34 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 May 2010 18:06:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47616</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzu8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32884</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>