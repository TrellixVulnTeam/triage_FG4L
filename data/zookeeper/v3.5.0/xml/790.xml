<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:52:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-790/ZOOKEEPER-790.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-790] Last processed zxid set prematurely while establishing leadership</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-790</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The leader code is setting the last processed zxid to the first of the new epoch even before connecting to a quorum of followers. Because the leader code sets this value before connecting to a quorum of followers (Leader.java:281) and the follower code throws an IOException (Follower.java:73) if the leader epoch is smaller, we have that when the false leader drops leadership and becomes a follower, it finds a smaller epoch and kills itself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12467595">ZOOKEEPER-790</key>
            <summary>Last processed zxid set prematurely while establishing leadership</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Junqueira</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Jun 2010 17:47:56 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:17 +0000</updated>
                            <resolved>Thu, 29 Jul 2010 22:11:57 +0100</resolved>
                                    <version>3.3.1</version>
                                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>quorum</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12881282" author="vishalmlst" created="Tue, 22 Jun 2010 19:21:40 +0100"  >
&lt;p&gt;I will try out the patch. I will try it out on 3.3.0 since that is the version we are currently using.&lt;/p&gt;

&lt;p&gt;-Vishal&lt;/p&gt;</comment>
                            <comment id="12885738" author="traviscrawford" created="Wed, 7 Jul 2010 00:36:32 +0100"  >&lt;p&gt;@vishal - How did your test go? I came across this issue while investigating an issue and believe this is the root cause.&lt;/p&gt;

&lt;p&gt;If your test went well I can also help test.&lt;/p&gt;</comment>
                            <comment id="12887941" author="vishalmlst" created="Tue, 13 Jul 2010 20:22:07 +0100"  >&lt;p&gt;Folks,&lt;/p&gt;

&lt;p&gt;Sorry to the delay. The patch did not work. Any other ideas? Thanks.&lt;/p&gt;

&lt;p&gt;-Vishal&lt;/p&gt;</comment>
                            <comment id="12887969" author="fpj" created="Tue, 13 Jul 2010 20:51:40 +0100"  >&lt;p&gt;Vishal, What exactly didn&apos;t work? Do you get the same error messages with the patch? Do you have a reliable way of reproducing it? In general, it would be useful if you could provide more detail.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12888119" author="vishalmlst" created="Wed, 14 Jul 2010 01:10:08 +0100"  >&lt;p&gt;copying comments from email to jira.&lt;/p&gt;

&lt;p&gt;Hi Flavio ,&lt;/p&gt;

&lt;p&gt;I got the same error messages. I can reproduce this quite easily. I will capture the logs again. Is there anything else you would like me to provide? Thanks.&lt;/p&gt;

&lt;p&gt;-Vishal&lt;/p&gt;</comment>
                            <comment id="12888121" author="vishalmlst" created="Wed, 14 Jul 2010 01:10:33 +0100"  >&lt;p&gt;copying comments from email to jira. &lt;/p&gt;

&lt;p&gt;I forgot if you have provided already a description of how you reproduce it. If you could point me out to that, I would appreciate.&lt;/p&gt;

&lt;p&gt;-Flavio&lt;/p&gt;
</comment>
                            <comment id="12888122" author="vishalmlst" created="Wed, 14 Jul 2010 01:13:38 +0100"  >&lt;p&gt;From &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-335&quot; title=&quot;zookeeper servers should commit the new leader txn to their logs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-335&quot;&gt;&lt;del&gt;ZOOKEEPER-335&lt;/del&gt;&lt;/a&gt;..&lt;/p&gt;

&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I enabled tracing and did some more debugging. Looks like the restarted peer (and trying to join the cluster) determines that it is a leader and increments its epoch. However, rest of the nodes don&apos;t acknowledge this node as the leader, and hence, have an older epoch. I will attache the log. Unfortunately, I don&apos;t have traces from other nodes. I will repeat the experiment later and attache logs from other nodes.&lt;/p&gt;

&lt;p&gt;Scenario:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Form a 3 node cluster. This is not just ZK cluster. It also involves our application cluster that uses ZK.&lt;/li&gt;
	&lt;li&gt;Kill one of the follower&lt;/li&gt;
	&lt;li&gt;After a minute or so restart follower&lt;/li&gt;
	&lt;li&gt;Follower rejects leader with &quot;Leader epoch y is less than our epoch y + 1&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;From logs:&lt;/p&gt;

&lt;p&gt;a) Peer X restarts and starts leader election.&lt;br/&gt;
a) For a small window of time, X thinks that it is the new leader! During this window, for some reason, rest of the nodes tell X that they are also trying to find a leader. I.e., all 3 nodes are in LOOKING state. After seeing that all 3 nodes are in LOOKING state, X decides to be a leader?&lt;/p&gt;

&lt;p&gt;155 2010-06-20 23:22:46,421 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerSender Thread:QuorumCnxManager@346&amp;#93;&lt;/span&gt; - Opening channel to server 1&lt;br/&gt;
156 2010-06-20 23:22:46,423 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerReceiver Thread:FastLeaderElection$Messenger$WorkerReceiver@214&amp;#93;&lt;/span&gt; - Receive new notification message. My id = 0&lt;br/&gt;
157 2010-06-20 23:22:46,424 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689&amp;#93;&lt;/span&gt; - Notification: 0, 77309411393, 1, 0, LOOKING, LOOKING, 0&lt;br/&gt;
158 2010-06-20 23:22:46,424 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@495&amp;#93;&lt;/span&gt; - id: 0, proposed id: 0, zxid: 77309411393, proposed zxid: 77309411393&lt;br/&gt;
159 2010-06-20 23:22:46,424 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@717&amp;#93;&lt;/span&gt; - Adding vote: From = 0, Proposed leader = 0, Porposed zxid = 77309411393, Proposed epoch = 1&lt;br/&gt;
160 2010-06-20 23:22:46,426 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerSender Thread:QuorumCnxManager@162&amp;#93;&lt;/span&gt; - Have smaller server identifier, so dropping the connection: (1, 0)&lt;br/&gt;
161 2010-06-20 23:22:46,426 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerSender Thread:QuorumCnxManager@346&amp;#93;&lt;/span&gt; - Opening channel to server 2&lt;br/&gt;
162 2010-06-20 23:22:46,427 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-1:QuorumCnxManager$Listener@445&amp;#93;&lt;/span&gt; - Connection request /192.168.1.182:46701&lt;br/&gt;
163 2010-06-20 23:22:46,427 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-1:QuorumCnxManager$Listener@448&amp;#93;&lt;/span&gt; - Connection request: 0&lt;br/&gt;
164 2010-06-20 23:22:46,428 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-1:QuorumCnxManager$SendWorker@504&amp;#93;&lt;/span&gt; - Address of remote peer: 1&lt;br/&gt;
165 2010-06-20 23:22:46,428 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerSender Thread:QuorumCnxManager@162&amp;#93;&lt;/span&gt; - Have smaller server identifier, so dropping the connection: (2, 0)&lt;br/&gt;
166 2010-06-20 23:22:46,431 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerReceiver Thread:FastLeaderElection$Messenger$WorkerReceiver@214&amp;#93;&lt;/span&gt; - Receive new notification message. My id = 0&lt;br/&gt;
167 2010-06-20 23:22:46,432 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689&amp;#93;&lt;/span&gt; - Notification: 1, 77309411372, 1, 0, LOOKING, LOOKING, 1&lt;br/&gt;
168 2010-06-20 23:22:46,432 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@495&amp;#93;&lt;/span&gt; - id: 1, proposed id: 0, zxid: 77309411372, proposed zxid: 77309411393&lt;br/&gt;
169 2010-06-20 23:22:46,432 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@717&amp;#93;&lt;/span&gt; - Adding vote: From = 1, Proposed leader = 1, Porposed zxid = 77309411372, Proposed epoch = 1&lt;br/&gt;
170 2010-06-20 23:22:46,436 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-1:QuorumCnxManager$Listener@445&amp;#93;&lt;/span&gt; - Connection request /192.168.1.183:44310&lt;br/&gt;
171 2010-06-20 23:22:46,436 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-1:QuorumCnxManager$Listener@448&amp;#93;&lt;/span&gt; - Connection request: 0&lt;br/&gt;
172 2010-06-20 23:22:46,436 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-1:QuorumCnxManager$SendWorker@504&amp;#93;&lt;/span&gt; - Address of remote peer: 2&lt;br/&gt;
173 2010-06-20 23:22:46,440 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerReceiver Thread:FastLeaderElection$Messenger$WorkerReceiver@214&amp;#93;&lt;/span&gt; - Receive new notification message. My id = 0&lt;br/&gt;
174 2010-06-20 23:22:46,440 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689&amp;#93;&lt;/span&gt; - Notification: 2, 73014444097, 1, 0, LOOKING, LOOKING, 2&lt;br/&gt;
175 2010-06-20 23:22:46,440 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@495&amp;#93;&lt;/span&gt; - id: 2, proposed id: 0, zxid: 73014444097, proposed zxid: 77309411393&lt;br/&gt;
176 2010-06-20 23:22:46,441 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@717&amp;#93;&lt;/span&gt; - Adding vote: From = 2, Proposed leader = 2, Porposed zxid = 73014444097, Proposed epoch = 1&lt;br/&gt;
177 2010-06-20 23:22:46,441 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:QuorumPeer@647&amp;#93;&lt;/span&gt; - LEADING&lt;/p&gt;

&lt;p&gt;b) As a result X increments its epoch. Worse, since this node decided to be a leader, it starts doing transactions. The first set of transactions start removing all ephemeral nodes. But these transactions are only done locally. Other peers do not ack these transactions since they know that this peer is not the leader.&lt;/p&gt;

&lt;p&gt;c) After a few seconds (8 secs), X relinquishes leadership since it does not receive any ack from rest of the peers&lt;br/&gt;
d) It starts leader election again. This time, rests of the peers respond correctly informing X that a leader already exists.&lt;br/&gt;
e) X determines that it should now follow the leader and starts handshake with the leader. However, X has incremented its epoch in the mean time. X thinks that the epoch sent by the leader during handshake is older than the epoch it has noticed before. X aborts connection with the leader.&lt;/p&gt;</comment>
                            <comment id="12888123" author="vishalmlst" created="Wed, 14 Jul 2010 01:16:26 +0100"  >&lt;p&gt;Hi Flavio,&lt;/p&gt;

&lt;p&gt;I think there are two additional related problems:&lt;/p&gt;

&lt;p&gt;1. Why are the other two nodes that have formed the cluster in LOOKING state? Both should reply with FOLLOWING&lt;br/&gt;
174 2010-06-20 23:22:46,440 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689&amp;#93;&lt;/span&gt; - Notification: 2, 73014444097, 1, 0, LOOKING, LOOKING, 2&lt;/p&gt;

&lt;p&gt;2. The node attempting to join goes in an infinite loop of join fails. We should add a delay.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Vishal&lt;/p&gt;</comment>
                            <comment id="12888304" author="fpj" created="Wed, 14 Jul 2010 12:49:56 +0100"  >&lt;p&gt;Hi Vishal, Thanks for all the information. I haven&apos;t been able to reproduce it yet, but here are some thoughts after looking over your logs again:&lt;/p&gt;

&lt;p&gt;1- It is not a problem that server 0 is declaring itself leader, even though there is another leader running. Server 0 will be ignored by the others and eventually will drop its leadership as you have observed;&lt;br/&gt;
2- The notifications of 1 and 2 say looking because they have been queued at the time 1 and 2 were looking for a leader. That&apos;s not an issue;&lt;br/&gt;
3- I don&apos;t understand why the patch doesn&apos;t work. Let me tell you how I&apos;m interpreting your run. Server 0 is receiving the notifications from 1 and 2, and deciding that it should be the leader. Because in the current trunk code we set the first zxid for the new epoch before hearing from a quorum, once server 0 drops leadership, it has a higher zxid than everyone else. Consequently, it correctly refuses to talk to the current leader. Now, setting the first epoch zxid prematurely is a problem, and the patch I have uploaded should fix it. The bottom line is that I can&apos;t understand why the patch I uploaded does not fix it. Have you made sure to apply it before running your new tests? Either way, I would appreciate if you could upload logs out of a run with the current 790 patch.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12888330" author="vishalmlst" created="Wed, 14 Jul 2010 14:38:08 +0100"  >&lt;p&gt;Hi Flavio,&lt;/p&gt;

&lt;p&gt;I am going to retry again with the patch. Thanks.&lt;/p&gt;

&lt;p&gt;-Vishal&lt;/p&gt;</comment>
                            <comment id="12888409" author="phunt" created="Wed, 14 Jul 2010 17:08:26 +0100"  >&lt;p&gt;Vishal, you might add some sort of log message to the code (in addition to the patch) to verify that the code you&apos;re running is the patched version.&lt;/p&gt;</comment>
                            <comment id="12888443" author="vishalmlst" created="Wed, 14 Jul 2010 18:31:33 +0100"  >&lt;p&gt;Hi Patrick,&lt;/p&gt;

&lt;p&gt;I had done that earlier. I will do it again to reconfirm. I would also help if Travis or Charity  can also try to verify the patch, if possible.&lt;/p&gt;

&lt;p&gt;-Vishal&lt;/p&gt;</comment>
                            <comment id="12888576" author="traviscrawford" created="Wed, 14 Jul 2010 23:20:49 +0100"  >&lt;p&gt;Sure, I&apos;ll help test this too.&lt;/p&gt;</comment>
                            <comment id="12888688" author="traviscrawford" created="Thu, 15 Jul 2010 04:28:11 +0100"  >&lt;p&gt;I accidentally posted this in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-335&quot; title=&quot;zookeeper servers should commit the new leader txn to their logs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-335&quot;&gt;&lt;del&gt;ZOOKEEPER-335&lt;/del&gt;&lt;/a&gt; &amp;#8211; reposting here. Sorry for the posting mixup &amp;#8211; the content is correct though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


&lt;p&gt;Unfortunately I still observed the &quot;Leader epoch&quot; issue and needed to manually force a leader election for the cluster to recover. This test was performed with the following base+patches, applied in the order listed.&lt;/p&gt;

&lt;p&gt;Zookeeper 3.3.1&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-744&quot; title=&quot;Add monitoring four-letter word&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-744&quot;&gt;&lt;del&gt;ZOOKEEPER-744&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-790&quot; title=&quot;Last processed zxid set prematurely while establishing leadership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-790&quot;&gt;&lt;del&gt;ZOOKEEPER-790&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-07-15 02:43:57,181 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FileSnap@82] - Reading snapshot /data/zookeeper/version-2/snapshot.2300001ac2
2010-07-15 02:43:57,384 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@649] - New election. My id =  1, Proposed zxid = 154618826848
2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 1, 154618826848, 4, 1, LOOKING, LOOKING, 1
2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@799] - Notification: 2, 146030952153, 3, 1, LOOKING, LEADING, 2
2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@799] - Notification: 2, 146030952153, 3, 1, LOOKING, FOLLOWING, 3
2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:QuorumPeer@642] - FOLLOWING
2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@151] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /data/zookeeper/txlog/version-2 snapdir /data/zookeeper/version-2
2010-07-15 02:43:57,387 - FATAL [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@71] - Leader epoch 23 is less than our epoch 24
2010-07-15 02:43:57,387 - WARN  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@82] - Exception when following the leader 
java.io.IOException: Error: Epoch of leader is lower
        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:73)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:644)
2010-07-15 02:43:57,387 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@166] - shutdown called 
java.lang.Exception: shutdown Follower
        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:648)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I followed the recipe @vishal provided for recreating.&lt;/p&gt;

&lt;p&gt;(a) Stop one follower in a three node cluster&lt;br/&gt;
(b) Get some tea while it falls behind&lt;br/&gt;
(c) Start the node stopped in (a).&lt;/p&gt;

&lt;p&gt;These timestamps show where the follower was stopped. It also shows when it was turned back on.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-07-15 02:35:36,398 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:NIOServerCnxn@1661] - Established session 0x229aa13cfc6276b with negotiated timeout 10000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.45.114:34562
2010-07-15 02:39:18,907 - INFO  [main:QuorumPeerConfig@90] - Reading configuration from: /etc/zookeeper/conf/zoo.cfg
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;This timestamp is the first ``Leader epoch`` line. Everything between these two points will be the interesting bits.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-07-15 02:39:43,339 - FATAL [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@71] - Leader epoch 23 is less than our epoch 24
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12888834" author="fpj" created="Thu, 15 Jul 2010 16:52:59 +0100"  >&lt;p&gt;Thank you both for all the information. I have been able to reproduce and find the source of the bug, but I don&apos;t have a patch yet. The problem is deeper than I thought originally. Let me show you what is going on:&lt;/p&gt;

&lt;p&gt;I&apos;m including an excerpt of logs from two runs: one good and one bad. The first run is good (see the excerpt below). I have killed the follower and restarted it as Vishal suggested. When it comes back, it declares itself as leader, also as Vishal and Travis observed.  However, different from what Vishal and Travis observed, it drops leadership and follows happily the leader right after.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@654] - LEADING
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LEADING (my state)
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@54] - TCP NoDelay set to: true
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:zookeeper.version=3.4.0--1, built on 07/15/2010 10:36 GMT
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:host.name=XXXXXXXXXX.com
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.version=1.6.0_04
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.vendor=Sun Microsystems Inc.
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.home=/usr/java/jdk1.6.0_04/jre
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.class.path=.XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.library.path= XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.io.tmpdir=/tmp
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.compiler=&amp;lt;NA&amp;gt;
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.name=Linux
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.arch=amd64
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.version=2.6.18-53.1.21.el5
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.name=XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.home=XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.dir=XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /XXXXXXXXX/zookeeper/version-2 snapdir /XXXXXXXX/zookeeper/version-2
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXX/zookeeper/version-2/snapshot.100113340
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXX/zookeeper/version-2/snapshot.100113340
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileTxnSnapLog@208] - Snapshotting: 10011f748
INFO  - [SessionTracker:ZooKeeperServer@315] - Expiring session 0x229d6a9e0ca0000, timeout of 10000ms exceeded
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@394] - Shutdown called
java.lang.Exception: shutdown Leader! reason: Waiting for a quorum of followers, only synced with: 2: 
        at org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:394)
        at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:317)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:657)
INFO  - [Thread-10:Leader$LearnerCnxAcceptor@243] - exception while shutting down acceptor: java.net.SocketException: Socket closed
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FinalRequestProcessor@378] - shutdown of request processor complete
INFO  - [SyncThread:2:SyncRequestProcessor@151] - SyncRequestProcessor exited!
INFO  - [CommitProcessor:2:CommitProcessor@148] - CommitProcessor exited loop!
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@620] - LOOKING
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXXX/zookeeper/version-2/snapshot.10011f748
INFO  - [SessionTracker:SessionTrackerImpl@158] - SessionTrackerImpl exited loop!
INFO  - [ProcessThread:-1:PrepRequestProcessor@385] - Processed session termination for sessionid: 0x229d6a9e0ca0000
ERROR - [ProcessThread:-1:NIOServerCnxn$Factory$1@87] - Thread Thread[ProcessThread:-1,5,main] died
java.lang.NullPointerException
        at org.apache.zookeeper.server.quorum.ProposalRequestProcessor.processRequest(ProposalRequestProcessor.java:71)
        at org.apache.zookeeper.server.PrepRequestProcessor.pRequest(PrepRequestProcessor.java:435)
        at org.apache.zookeeper.server.PrepRequestProcessor.run(PrepRequestProcessor.java:114)
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FastLeaderElection@663] - New election. My id =  2, Proposed zxid = 4296144712
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 2 (n.leader), 4296144712 (n.zxid), 2 (n.round), LOOKING (n.state), 2 (n.sid), LOOKING (my state)
INFO  - [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (3, 2)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 1 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 1 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 1 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@642] - FOLLOWING
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@72] - TCP NoDelay set to: true
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /XXXXXXXXX/zookeeper/version-2 snapdir /XXXXXXXXX/zookeeper/version-2
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@285] - Getting a snapshot from leader
FATAL - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@314] - Setting leader epoch 1
WARN  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@116] - Got zxid 0x100162711 expected 0x1
WARN  - [SyncThread:2:FileTxnLog@196] - Creating new log file: 100162711
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileTxnSnapLog@208] - Snapshotting: 100164c43
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Now, the following run is bad. I followed the same procedure, but this time we get the epoch problem. Looking carefully at the logs, you&apos;ll see that the main difference is that this time the zookeeper server created a new log file: log.200000001. This is bad because the zookeeper server will use the zxid in the latest txn log file to determine its last epoch. Given that the current leader is in epoch 1, it will correctly refuse to talk to the leader as we observe below.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@654] - LEADING
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@54] - TCP NoDelay set to: true
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:zookeeper.version=3.4.0--1, built on 07/15/2010 10:36 GMT
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:host.name=XXXXXXXX.com
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.version=1.6.0_05
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.vendor=Sun Microsystems Inc.
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.home=/usr/java/jdk1.6.0_05/jre
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.class.path=XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.library.path=XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.io.tmpdir=/tmp
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.compiler=&amp;lt;NA&amp;gt;
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.name=Linux
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.arch= amd64
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.version=2.6.18-92.1.13.el5.perfctr.2.6.36
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.name=XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.home=XXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.dir=XXXXXXXXX
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /xxxxxxx/zookeeper/version-2 snapdir /XXXXXXX/zookeeper/version-2
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXX/zookeeper/version-2/snapshot.1000469b4
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXX/zookeeper/version-2/snapshot.1000469b4
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileTxnSnapLog@208] - Snapshotting: 100055cec
INFO  - [SessionTracker:ZooKeeperServer@315] - Expiring session 0x129d6b61b5b0000, timeout of 10000ms exceeded
INFO  - [ProcessThread:-1:PrepRequestProcessor@385] - Processed session termination for sessionid: 0x129d6b61b5b0000
WARN  - [SyncThread:1:FileTxnLog@196] - Creating new log file: log.200000001
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@394] - Shutdown called
java.lang.Exception: shutdown Leader! reason: Waiting for a quorum of followers, only synced with: 1: 
        at org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:394)
        at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:317)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:657)
INFO  - [ProcessThread:-1:PrepRequestProcessor@119] - PrepRequestProcessor exited loop!
INFO  - [CommitProcessor:1:CommitProcessor@148] - CommitProcessor exited loop!
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FinalRequestProcessor@378] - shutdown of request processor complete
INFO  - [SyncThread:1:SyncRequestProcessor@151] - SyncRequestProcessor exited!
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@620] - LOOKING
INFO  - [Thread-8:Leader$LearnerCnxAcceptor@243] - exception while shutting down acceptor: java.net.SocketException: Socket closed
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXX/zookeeper/version-2/snapshot.100055cec
INFO  - [SessionTracker:SessionTrackerImpl@158] - SessionTrackerImpl exited loop!
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FastLeaderElection@663] - New election. My id =  1, Proposed zxid = 8589934593
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 1 (n.leader), 8589934593 (n.zxid), 2 (n.round), LOOKING (n.state), 1 (n.sid), LOOKING (my state)
INFO  - [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (2, 1)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)
INFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@642] - FOLLOWING
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@72] - TCP NoDelay set to: true
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /xxxxxxx/zookeeper/version-2 snapdir /xxxxxxx/zookeeper/version-2
FATAL - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@71] - Leader epoch 1 is less than our epoch 2
WARN  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@82] - Exception when following the leader
java.io.IOException: Error: Epoch of leader is lower
        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:73)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:644)
INFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@166] - shutdown called
java.lang.Exception: shutdown Follower
        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:648)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Fixing it is not as simple as setting the current zxid to 200000001 after we hear from a quorum because the request processor pipeline starts complaining about an attempt to commit a future proposal.&lt;/p&gt;</comment>
                            <comment id="12888842" author="traviscrawford" created="Thu, 15 Jul 2010 17:12:22 +0100"  >&lt;p&gt;Good find! I can certainly help test a patch, or collect more info if needed.&lt;/p&gt;</comment>
                            <comment id="12888843" author="vishalmlst" created="Thu, 15 Jul 2010 17:19:15 +0100"  >&lt;p&gt;Likewise.&lt;/p&gt;</comment>
                            <comment id="12889072" author="fpj" created="Fri, 16 Jul 2010 09:59:07 +0100"  >&lt;p&gt;Some additional information. We create a new transaction log when we try to append a transaction and there is no log file open. Consequently, we only create it when there is something to write. For the bad run above, here is the content of the log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ZooKeeper Transactional Log File with dbid 0 txnlog format version 2
7/15/10 5:27:45 PM CEST session 0x129d6b61b5b0000 cxid 0x0 zxid 0x200000001 closeSession
EOF reached after 1 txns.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12889218" author="fpj" created="Fri, 16 Jul 2010 17:26:30 +0100"  >&lt;p&gt;Hi! I&apos;m attaching a patch that works for my setup (and passes the unit tests as well), so I would appreciate if you could give it a try.&lt;/p&gt;</comment>
                            <comment id="12889225" author="vishalmlst" created="Fri, 16 Jul 2010 17:50:22 +0100"  >&lt;p&gt;great! I will give it a try. Thanks.&lt;/p&gt;</comment>
                            <comment id="12890427" author="fpj" created="Tue, 20 Jul 2010 21:30:14 +0100"  >&lt;p&gt;This patch is very simple: it moves two function calls such that a leader only starts up and sets the the last processed zxid after it has a quorum of supporters. It also includes a unit test. I had to make a few modifications here and there to be able to write this test. I tried to minimize changes as much as possible.&lt;/p&gt;</comment>
                            <comment id="12890451" author="hadoopqa" created="Tue, 20 Jul 2010 22:20:47 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12449972/ZOOKEEPER-790.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12449972/ZOOKEEPER-790.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 963957.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12890469" author="fpj" created="Tue, 20 Jul 2010 22:44:52 +0100"  >&lt;p&gt;Uploading patch for the 3.3 branch. I have also checked the results of Hudson, and I couldn&apos;t find any java test failure. The -1 on core tests seems to be unrelated to this patch.&lt;/p&gt;</comment>
                            <comment id="12890512" author="traviscrawford" created="Wed, 21 Jul 2010 01:24:58 +0100"  >&lt;p&gt;I tested this patch on a build with the following, applied in the listed order: 3.3.1 release + &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-744&quot; title=&quot;Add monitoring four-letter word&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-744&quot;&gt;&lt;del&gt;ZOOKEEPER-744&lt;/del&gt;&lt;/a&gt;.patch + &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-790&quot; title=&quot;Last processed zxid set prematurely while establishing leadership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-790&quot;&gt;&lt;del&gt;ZOOKEEPER-790&lt;/del&gt;&lt;/a&gt;-3.3.patch&lt;/p&gt;

&lt;p&gt;Looks good!&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-07-20 23:43:34,229 - INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-2545:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.21.181:53743 (no session established &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client)
2010-07-20 23:43:34,659 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129d3fcb5a6f60d, likely client has closed socket
2010-07-20 23:43:34,660 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.21.204:59727 which had sessionid 0x129d3fcb5a6f60d
2010-07-20 23:43:34,684 - INFO  [ProcessThread:-1:PrepRequestProcessor@385] - Processed session termination &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid: 0x329d3fcb6594e53
2010-07-20 23:52:14,522 - INFO  [main:QuorumPeerConfig@90] - Reading configuration from: /etc/zookeeper/conf/zoo.cfg
2010-07-20 23:52:14,529 - INFO  [main:QuorumPeerConfig@287] - Defaulting to majority quorums
2010-07-20 23:52:14,540 - INFO  [main:QuorumPeerMain@119] - Starting quorum peer
2010-07-20 23:52:14,562 - INFO  [main:NIOServerCnxn$Factory@149] - binding to port 0.0.0.0/0.0.0.0:2181
2010-07-20 23:52:14,578 - INFO  [main:QuorumPeer@818] - tickTime set to 2000
2010-07-20 23:52:14,579 - INFO  [main:QuorumPeer@829] - minSessionTimeout set to -1
2010-07-20 23:52:14,579 - INFO  [main:QuorumPeer@840] - maxSessionTimeout set to -1
2010-07-20 23:52:14,579 - INFO  [main:QuorumPeer@855] - initLimit set to 10
2010-07-20 23:52:14,798 - INFO  [main:FileSnap@82] - Reading snapshot /data/zookeeper/version-2/snapshot.2500197ee5
2010-07-20 23:52:15,660 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.45.76:57030
2010-07-20 23:52:15,661 - INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1:QuorumCnxManager$Listener@436] - My election bind port: 3888
2010-07-20 23:52:15,663 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@644] - Exception causing close of session 0x0 due to java.io.IOException: ZooKeeperServer not running
2010-07-20 23:52:15,664 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.45.76:57030 (no session established &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client)
2010-07-20 23:52:15,670 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:QuorumPeer@620] - LOOKING
2010-07-20 23:52:15,672 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@649] - New election. My id =  1, Proposed zxid = 158915472832
2010-07-20 23:52:15,674 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 1, 158915472832, 1, 1, LOOKING, LOOKING, 1
2010-07-20 23:52:15,674 - INFO  [WorkerSender &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (2, 1)
2010-07-20 23:52:15,675 - INFO  [WorkerSender &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (3, 1)
2010-07-20 23:52:15,676 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 2, 158915472832, 5, 1, LOOKING, LOOKING, 2
2010-07-20 23:52:15,676 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 3, 158915472832, 5, 1, LOOKING, LOOKING, 2
2010-07-20 23:52:15,676 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@711] - Updating proposal
2010-07-20 23:52:15,677 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@799] - Notification: 3, 158915472832, 5, 1, LOOKING, FOLLOWING, 2
2010-07-20 23:52:15,677 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 3, 158915472832, 5, 1, LOOKING, LOOKING, 3
2010-07-20 23:52:15,879 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:QuorumPeer@642] - FOLLOWING
2010-07-20 23:52:15,885 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Learner@72] - TCP NoDelay set to: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
2010-07-20 23:52:15,893 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:zookeeper.version=3.3.1-942149, built on 05/07/2010 17:14 GMT
2010-07-20 23:52:15,893 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:host.name=sjc1k029.twitter.com
2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.version=1.6.0_16
2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.vendor=Sun Microsystems Inc.
2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.home=/usr/java/jdk1.6.0_16/jre
2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.class.path=/etc/zookeeper/conf::/usr/local/zookeeper/../zookeeper-*.jar:/usr/local/zookeeper/../lib/*.jar:/usr/local/zookeeper/../src/java/lib/*.jar:/usr/local/zookeeper/jline-0.9.94.jar:/usr/local/zookeeper/log4j-1.2.15.jar:/usr/local/zookeeper/zookeeper-3.3.2-dev.jar
2010-07-20 23:52:15,895 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.library.path=/usr/java/jdk1.6.0_16/jre/lib/amd64/server:/usr/java/jdk1.6.0_16/jre/lib/amd64:/usr/java/jdk1.6.0_16/jre/../lib/amd64:/usr/java/packages/lib/amd64:/lib:/usr/lib
2010-07-20 23:52:15,895 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.io.tmpdir=/tmp
2010-07-20 23:52:15,895 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.compiler=&amp;lt;NA&amp;gt;
2010-07-20 23:52:15,896 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:os.name=Linux
2010-07-20 23:52:15,896 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:os.arch=amd64
2010-07-20 23:52:15,896 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:os.version=2.6.18-164.6.1.el5
2010-07-20 23:52:15,897 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:user.name=root
2010-07-20 23:52:15,897 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:user.home=/root
2010-07-20 23:52:15,897 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:user.dir=/
2010-07-20 23:52:15,899 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@151] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /data/zookeeper/txlog/version-2 snapdir /data/zookeeper/version-2
2010-07-20 23:52:15,911 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Learner@285] - Getting a snapshot from leader
2010-07-20 23:52:16,152 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Learner@315] - Setting leader epoch 26
2010-07-20 23:52:16,166 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FileTxnSnapLog@208] - Snapshotting: 260000195d
2010-07-20 23:52:16,200 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.21.181:49189
2010-07-20 23:52:16,200 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1314] - Processing stat command from /10.209.21.181:49189
2010-07-20 23:52:16,203 - INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-6:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.21.181:49189 (no session established &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client)
2010-07-20 23:52:16,446 - WARN  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@116] - Got zxid 0x260000195e expected 0x1
2010-07-20 23:52:16,446 - INFO  [SyncThread:1:FileTxnLog@197] - Creating &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; log file: log.260000195e
2010-07-20 23:52:19,205 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.21.181:49192
2010-07-20 23:52:19,205 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1314] - Processing stat command from /10.209.21.181:49192
2010-07-20 23:52:19,206 - INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-7:NIOServerCnxn$StatCommand@1167] - Stat command output
2010-07-20 23:52:19,208 - INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-7:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.21.181:49192 (no session established &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client)
2010-07-20 23:52:20,562 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.44.180:47281
2010-07-20 23:52:20,564 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@782] - Client attempting to establish &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; session at /10.209.44.180:47281
2010-07-20 23:52:20,574 - INFO  [CommitProcessor:1:NIOServerCnxn@1661] - Established session 0x129f245a01c0000 with negotiated timeout 10000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.44.180:47281
2010-07-20 23:52:20,581 - INFO  [CommitProcessor:1:PrepRequestProcessor@69] - zookeeper.skipACL==&lt;span class=&quot;code-quote&quot;&gt;&quot;yes&quot;&lt;/span&gt;, ACL checks will be skipped
2010-07-20 23:52:20,586 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129f245a01c0000, likely client has closed socket
2010-07-20 23:52:20,587 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.44.180:47281 which had sessionid 0x129f245a01c0000
2010-07-20 23:52:20,826 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.48.78:52838
2010-07-20 23:52:20,827 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@782] - Client attempting to establish &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; session at /10.209.48.78:52838
2010-07-20 23:52:20,829 - INFO  [CommitProcessor:1:NIOServerCnxn@1661] - Established session 0x129f245a01c0001 with negotiated timeout 10000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.48.78:52838
2010-07-20 23:52:20,832 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129f245a01c0001, likely client has closed socket
2010-07-20 23:52:20,833 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.48.78:52838 which had sessionid 0x129f245a01c0001
2010-07-20 23:52:22,210 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.21.181:49197
2010-07-20 23:52:22,210 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1314] - Processing stat command from /10.209.21.181:49197
2010-07-20 23:52:22,211 - INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-8:NIOServerCnxn$StatCommand@1167] - Stat command output
2010-07-20 23:52:22,227 - INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-8:NIOServerCnxn@1516] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.21.181:49197 (no session established &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client)
2010-07-20 23:52:22,551 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.45.104:42183
2010-07-20 23:52:22,552 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@782] - Client attempting to establish &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; session at /10.209.45.104:42183
2010-07-20 23:52:22,554 - INFO  [CommitProcessor:1:NIOServerCnxn@1661] - Established session 0x129f245a01c0002 with negotiated timeout 10000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.209.45.104:42183
2010-07-20 23:52:22,560 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129f245a01c0002, likely client has closed socket
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12890513" author="traviscrawford" created="Wed, 21 Jul 2010 01:36:31 +0100"  >&lt;p&gt;Just to double-check, I&apos;m really really sure the running jar was freshly built. For example, lsof says:&lt;/p&gt;

&lt;p&gt;java    4473 root  mem    REG              104,1  1012397  10092999 /usr/local/zookeeper/zookeeper-3.3.2-dev.jar&lt;/p&gt;

&lt;p&gt;Yes, the version number is 3.3.2, but this was built from the 3.3.1 release.&lt;/p&gt;

&lt;p&gt;Looking in the log we see:&lt;/p&gt;

&lt;p&gt;2010-07-20 23:52:15,893 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97&amp;#93;&lt;/span&gt; - Server environment:zookeeper.version=3.3.1-942149, built on 05/07/2010 17:14 GMT&lt;/p&gt;

&lt;p&gt;Should that say built this afternoon? I&apos;ve double &amp;amp; tripled checked and believe this is a newly built jar. Looking in the tarball we don&apos;t see zookeeper-3.3.2-dev.jar until after building.&lt;/p&gt;</comment>
                            <comment id="12890587" author="fpj" created="Wed, 21 Jul 2010 08:11:36 +0100"  >&lt;p&gt;I realized that while working on the patch I removed a private modifier and forgot to add it back for the trunk patch, so I&apos;m uploading an new patch. There is no other significant modification to the patch.&lt;/p&gt;</comment>
                            <comment id="12890588" author="fpj" created="Wed, 21 Jul 2010 08:12:09 +0100"  >&lt;p&gt;Just in case will cancel and resubmit.&lt;/p&gt;</comment>
                            <comment id="12891210" author="breed" created="Thu, 22 Jul 2010 16:14:10 +0100"  >&lt;p&gt;looks great flavio! the only nit i have is that the test case assumes that s1 is not the leader. you might want to check that.&lt;/p&gt;</comment>
                            <comment id="12891236" author="fpj" created="Thu, 22 Jul 2010 17:40:51 +0100"  >&lt;p&gt;Thank for reviewing, Ben. Resubmitting with the proposed fix.&lt;/p&gt;

&lt;p&gt;Thanks for testing the patch, Travis. I don&apos;t really know why you&apos;re observing the wrong dates, though. Anyone else?&lt;/p&gt;</comment>
                            <comment id="12891245" author="breed" created="Thu, 22 Jul 2010 18:08:05 +0100"  >&lt;p&gt;+1 great job flavio! thanx for your help travis and vishal.&lt;/p&gt;</comment>
                            <comment id="12891332" author="phunt" created="Thu, 22 Jul 2010 22:05:53 +0100"  >&lt;p&gt;I believe the problem found by Travis is a bug in the build for 3.3.1. If you d/l the latest release, patch it, and run &quot;ant jar&quot; this is included into the output:&lt;/p&gt;

&lt;p&gt;version-info:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; All version-related parameters must be valid integers!&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; Exception in thread &quot;main&quot; java.lang.NumberFormatException: For input string: &quot;2-dev&quot;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; 	at java.lang.NumberFormatException.forInputString(NumberFormatException.java:48)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; 	at java.lang.Integer.parseInt(Integer.java:458)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; 	at java.lang.Integer.parseInt(Integer.java:499)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; 	at org.apache.zookeeper.version.util.VerGen.main(VerGen.java:131)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; Java Result: 1&lt;/p&gt;

&lt;p&gt;the build doesn&apos;t fail as the generated Version.java exists in the release, as a result you get the original Version.java, and therefore the old date.&lt;/p&gt;

&lt;p&gt;You can see this better by doing a &quot;ant clean jar&quot;, which will fail as the Version.java is cleaned by running ant clean. You can get around this&lt;br/&gt;
problem by running &quot;ant -Dversion=3.3.2 clean jar&quot; (a valid version string), after which you should see the current date in the log.&lt;/p&gt;

&lt;p&gt;I&apos;ll fix this in the next rel.&lt;/p&gt;</comment>
                            <comment id="12891492" author="breed" created="Fri, 23 Jul 2010 07:33:44 +0100"  >&lt;p&gt;Committed revision 966960.&lt;br/&gt;
Committed revision 966984.&lt;/p&gt;</comment>
                            <comment id="12891559" author="hudson" created="Fri, 23 Jul 2010 12:23:24 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #884 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/884/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/884/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-790&quot; title=&quot;Last processed zxid set prematurely while establishing leadership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-790&quot;&gt;&lt;del&gt;ZOOKEEPER-790&lt;/del&gt;&lt;/a&gt;. Last processed zxid set prematurely while establishing leadership (fpj via breed)&lt;/p&gt;</comment>
                            <comment id="12892421" author="dorserg" created="Mon, 26 Jul 2010 20:23:00 +0100"  >&lt;p&gt;It seems this patch introduces a bug: followers get synchronized with leader and start serving clients before leader startups its own zk instance. &lt;br/&gt;
As the result, when a follower forward request to the leader, for example session revalidation request, it fails because leader&apos;s sessionTracker is null.&lt;/p&gt;

&lt;p&gt;Previously this was not the case because leader started its zk immediately after quorum peer is switched to LEADING state.&lt;/p&gt;

&lt;p&gt;See attached log.&lt;/p&gt;</comment>
                            <comment id="12892442" author="dorserg" created="Mon, 26 Jul 2010 21:01:52 +0100"  >&lt;p&gt;Easy way to reproduce: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;start 2 out of 3 peers&lt;/li&gt;
	&lt;li&gt;connect to the ensemble by zkCli.sh&lt;/li&gt;
	&lt;li&gt;shutdown a peer, wait a bit&lt;/li&gt;
	&lt;li&gt;start the peer&lt;br/&gt;
Due to NPE (which is not seen in logs however) servers can&apos;t form a quorum, and client is unable to reconnect.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12892478" author="vishalmlst" created="Mon, 26 Jul 2010 22:26:54 +0100"  >&lt;p&gt;Hi Flavio,&lt;/p&gt;

&lt;p&gt;Apologies for not trying the patch sooner. I will  try out the patch soon (altough Sergey has pointed out a potential problem).&lt;/p&gt;

&lt;p&gt;I am still not conviced why the other two nodes that have formed the cluster are in LOOKING state? &lt;br/&gt;
You mentioned that - &quot;The notifications of 1 and 2 say looking because they have been queued at the time 1 and 2 were looking for a leader. That&apos;s not an issue&quot;.&lt;/p&gt;

&lt;p&gt;However, in this case, we have failed a follower and not a leader. Why would failure of a follower cause the other two nodes (including the leader) to start looking for a leader?&lt;br/&gt;
Am I missing something?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;br/&gt;
-Vishal&lt;/p&gt;</comment>
                            <comment id="12892516" author="fpj" created="Mon, 26 Jul 2010 23:40:23 +0100"  >&lt;p&gt;Thanks for pointing this issue out, Sergei. It sounds like the previous patch solved the issue discussed without making sure that the leader was ready to process messages when learner handlers started to read them in. This v2 patch does a number of things:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;It moves the startup method to processAck. This way we make sure that start up the leader as soon as we have a quorum of acks for the newleader message;&lt;/li&gt;
	&lt;li&gt;It moves the initialization of the database in startup to a method startdata. There are two reasons for doing it. First, it didn&apos;t sound like a good idea to throw exceptions or catch exceptions in processAck, and they were only necessary because of the call to startup(). Second, the method startup() in ZooKeeperServer throws these exceptions because of loadData(), which is called separately in Leader.lead(), so it is not necessary to call it in processAck after hearing from a quorum;&lt;/li&gt;
	&lt;li&gt;It waits in LearnerHandler.run() until the leader ready before it starts the while(true) loop. I also had to receive an ack before executing the code to wait, otherwise the leader would never receive acks and form a quorum, thus causing the system to halt.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;To get some feedback on the changes implemented in this patch, I have discussed them with Ben. Thanks, Ben! &lt;/p&gt;

&lt;p&gt;Sergei, I would appreciate if you could give it a try, and if you could tell me if it works for you. &lt;/p&gt;</comment>
                            <comment id="12892520" author="fpj" created="Mon, 26 Jul 2010 23:47:43 +0100"  >&lt;p&gt;Hi VIshal, Thanks for testing as well. The issue you mention about the LOOKING state, if I understand correctly, is not about the state of the server, but the state reported in the notification. &lt;br/&gt;
If so, then it happens because we always repeat the last message sent. Such duplicate messages cause what you have observed, but they are supposed to be harmless, in the sense that&lt;br/&gt;
I do not expect them to lead to any inconsistency in the ZooKeeper service. Instead, it may only cause some periods in which some process believes incorrectly to be the leader, but again, &lt;br/&gt;
the service is robust to such scenarios. &lt;/p&gt;</comment>
                            <comment id="12892524" author="fpj" created="Mon, 26 Jul 2010 23:52:15 +0100"  >&lt;p&gt;The latest patch applies to both trunk and 3.3.&lt;/p&gt;</comment>
                            <comment id="12892526" author="phunt" created="Mon, 26 Jul 2010 23:53:26 +0100"  >&lt;p&gt;Great catch Sergei, thanks!&lt;/p&gt;</comment>
                            <comment id="12892528" author="phunt" created="Tue, 27 Jul 2010 00:00:31 +0100"  >&lt;p&gt;Would be great to have a test for this latest change.&lt;/p&gt;</comment>
                            <comment id="12892536" author="dorserg" created="Tue, 27 Jul 2010 00:15:50 +0100"  >&lt;p&gt;Hey Flavio,&lt;br/&gt;
Patch works ok: passes both manual testing and my unit test which was previously failing.&lt;br/&gt;
It looks conceptually correct, I&apos;d give it +1 if I&apos;d have such authority &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12892542" author="mahadev" created="Tue, 27 Jul 2010 00:32:14 +0100"  >&lt;p&gt;sergey,&lt;br/&gt;
 your +1 does count &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Also, can you please upload the testcase that was failing? It would be good to include the testcase with the patch as pat mentioned above.&lt;/p&gt;</comment>
                            <comment id="12892715" author="dorserg" created="Tue, 27 Jul 2010 11:46:44 +0100"  >&lt;p&gt;The test that was failing was the test for r/o mode, so it wouldn&apos;t apply here.&lt;/p&gt;

&lt;p&gt;I&apos;ve extracted necessary code from it and made it a test case in QuorumTest. It fails against current trunk but passes against latest patch. &lt;/p&gt;

&lt;p&gt;This test case uses QuorumUtil which I also extracted from my r/o mode patch. I made it for convenient quorum testing, it&apos;s more handy than current QuorumBase, and I plan to make QuorumBase a special case of it.&lt;/p&gt;</comment>
                            <comment id="12892721" author="dorserg" created="Tue, 27 Jul 2010 11:57:24 +0100"  >&lt;p&gt;btw, Flavio, there are a few lines with trailing whitespaces in your patch, fix them&lt;/p&gt;</comment>
                            <comment id="12892763" author="fpj" created="Tue, 27 Jul 2010 14:39:50 +0100"  >&lt;p&gt;Submitting a new patch right after.&lt;/p&gt;</comment>
                            <comment id="12892776" author="fpj" created="Tue, 27 Jul 2010 14:46:21 +0100"  >&lt;p&gt;Thanks for providing a code base for the test, Sergey. I liked QuorumUtil so much that I have reimplemented the previous test to use it. This is in fact aligned with a discussion Ben and I had the other day about refactoring QuorumBase. You have introduced pretty much all functionality I was looking for, which simplified the test code. &lt;/p&gt;

&lt;p&gt;I hope you don&apos;t mind that I have made some modifications to your original test. My proposed modifications are to make sure that we induce the right set of events. In the modified version, I have made sure that we have a client connecting to a follower and that we kill the leader so that we force a new election. In fact, the test was not always reliable for me in its original form.&lt;/p&gt;

&lt;p&gt;The patch works for me.&lt;/p&gt;</comment>
                            <comment id="12892777" author="fpj" created="Tue, 27 Jul 2010 14:47:51 +0100"  >&lt;p&gt;Need to generate a version for 3.3, but the one uploaded is ready to be reviewed for me.&lt;/p&gt;</comment>
                            <comment id="12892816" author="breed" created="Tue, 27 Jul 2010 16:16:23 +0100"  >&lt;p&gt;+1 excellent work you guys. i also like QuorumUtil sergey! thanx for implementing it.&lt;/p&gt;</comment>
                            <comment id="12893219" author="mahadev" created="Wed, 28 Jul 2010 16:53:18 +0100"  >&lt;p&gt;flavio, the patch looks good. Any reason you have this code in learnerhandler?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -475,6 +497,7 @@
         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
             LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Ignoring unexpected exception during socket close&quot;&lt;/span&gt;, e);
         }
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.interrupt();
         leader.removeLearnerHandler(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
     }
 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The interrupt? Why is this necessary?&lt;/p&gt;</comment>
                            <comment id="12893236" author="fpj" created="Wed, 28 Jul 2010 17:24:46 +0100"  >&lt;p&gt;Thanks for reviewing, Mahadev. The interrupt is necessary to guarantee that we will break this loop:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+            /*
+             * Wait until leader starts up
+             */
+            synchronized(leader.zk){
+                while(!leader.zk.isRunning()){
+                    leader.zk.wait(500);
+                }
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;when shutting down the learner handler.&lt;/p&gt;</comment>
                            <comment id="12893392" author="fpj" created="Wed, 28 Jul 2010 23:12:45 +0100"  >&lt;p&gt;Fixed issue pointed out by Mahadev. Submitting patch for 3.3 first.&lt;/p&gt;</comment>
                            <comment id="12893393" author="fpj" created="Wed, 28 Jul 2010 23:13:44 +0100"  >&lt;p&gt;Now uploading trunk version.&lt;/p&gt;</comment>
                            <comment id="12893776" author="vishalmlst" created="Thu, 29 Jul 2010 20:06:13 +0100"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I tested the patch and it works really well. I have a test that fails and restarts zookeeper server in a loop. I kept it going for 150 rounds and found no issues.&lt;br/&gt;
Thanks a lot.&lt;/p&gt;

&lt;p&gt;-Vishal&lt;/p&gt;</comment>
                            <comment id="12893816" author="mahadev" created="Thu, 29 Jul 2010 22:01:54 +0100"  >&lt;p&gt;+1 the patch looks good. I will go ahead and commit it.&lt;/p&gt;
</comment>
                            <comment id="12893826" author="mahadev" created="Thu, 29 Jul 2010 22:11:57 +0100"  >&lt;p&gt;I just committed this. thanks flavio and others!&lt;/p&gt;</comment>
                            <comment id="12894000" author="hudson" created="Fri, 30 Jul 2010 11:51:40 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #890 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/890/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/890/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-790&quot; title=&quot;Last processed zxid set prematurely while establishing leadership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-790&quot;&gt;&lt;del&gt;ZOOKEEPER-790&lt;/del&gt;&lt;/a&gt;.  Last processed zxid set prematurely while establishing leadership (flavio via mahadev)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12416126">ZOOKEEPER-335</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12450186" name="ZOOKEEPER-790-3.3.patch" size="12942" author="fpj" created="Thu, 22 Jul 2010 17:38:25 +0100"/>
                            <attachment id="12449980" name="ZOOKEEPER-790-3.3.patch" size="12765" author="fpj" created="Tue, 20 Jul 2010 22:44:52 +0100"/>
                            <attachment id="12450761" name="ZOOKEEPER-790-3.3.v2.patch" size="17520" author="fpj" created="Wed, 28 Jul 2010 23:12:45 +0100"/>
                            <attachment id="12450504" name="ZOOKEEPER-790-follower-request-NPE.log" size="16753" author="dorserg" created="Mon, 26 Jul 2010 20:23:00 +0100"/>
                            <attachment id="12450584" name="ZOOKEEPER-790-test.patch" size="10323" author="dorserg" created="Tue, 27 Jul 2010 11:46:44 +0100"/>
                            <attachment id="12450187" name="ZOOKEEPER-790.patch" size="13156" author="fpj" created="Thu, 22 Jul 2010 17:38:47 +0100"/>
                            <attachment id="12450033" name="ZOOKEEPER-790.patch" size="12969" author="fpj" created="Wed, 21 Jul 2010 08:11:36 +0100"/>
                            <attachment id="12449972" name="ZOOKEEPER-790.patch" size="13182" author="fpj" created="Tue, 20 Jul 2010 21:30:14 +0100"/>
                            <attachment id="12449676" name="ZOOKEEPER-790.patch" size="3400" author="fpj" created="Fri, 16 Jul 2010 17:26:30 +0100"/>
                            <attachment id="12447715" name="ZOOKEEPER-790.patch" size="1439" author="fpj" created="Tue, 22 Jun 2010 17:49:48 +0100"/>
                            <attachment id="12449533" name="ZOOKEEPER-790.travis.log.bz2" size="44747" author="traviscrawford" created="Thu, 15 Jul 2010 04:28:31 +0100"/>
                            <attachment id="12450762" name="ZOOKEEPER-790.v2.patch" size="17727" author="fpj" created="Wed, 28 Jul 2010 23:13:44 +0100"/>
                            <attachment id="12450598" name="ZOOKEEPER-790.v2.patch" size="17703" author="fpj" created="Tue, 27 Jul 2010 14:46:20 +0100"/>
                            <attachment id="12450534" name="ZOOKEEPER-790.v2.patch" size="4462" author="fpj" created="Mon, 26 Jul 2010 23:40:23 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 22 Jun 2010 18:21:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47599</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzu5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32868</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>