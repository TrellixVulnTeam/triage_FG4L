<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:50:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-733/ZOOKEEPER-733.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-733] use netty to handle client connections</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-733</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;we currently have our own asynchronous NIO socket engine to be able to handle lots of clients with a single thread. over time the engine has become more complicated. we would also like the engine to use multiple threads on machines with lots of cores. plus, we would like to be able to support things like SSL. if we switch to netty, we can simplify our code and get the previously mentioned benefits.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12461144">ZOOKEEPER-733</key>
            <summary>use netty to handle client connections</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="phunt">Patrick Hunt</assignee>
                                    <reporter username="breed">Benjamin Reed</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Apr 2010 15:44:46 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:01 +0000</updated>
                            <resolved>Wed, 18 Aug 2010 07:25:43 +0100</resolved>
                                                    <fixVersion>3.4.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="12853387" author="breed" created="Mon, 5 Apr 2010 15:51:20 +0100"  >&lt;p&gt;this is an initial cut at integrating netty. it is stale and still fails two tests, but i don&apos;t want to lose track of it.&lt;/p&gt;

&lt;p&gt;svn info gives the following:&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;https://svn.apache.org/repos/asf/hadoop/zookeeper/trunk/src/java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/hadoop/zookeeper/trunk/src/java&lt;/a&gt;&lt;br/&gt;
Repository Root: &lt;a href=&quot;https://svn.apache.org/repos/asf&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf&lt;/a&gt;&lt;br/&gt;
Repository UUID: 13f79535-47bb-0310-9956-ffa450edef68&lt;br/&gt;
Revision: 823252&lt;br/&gt;
Node Kind: directory&lt;br/&gt;
Schedule: normal&lt;br/&gt;
Last Changed Author: mahadev&lt;br/&gt;
Last Changed Rev: 817885&lt;br/&gt;
Last Changed Date: 2009-09-22 15:59:34 -0700 (Tue, 22 Sep 2009)&lt;/p&gt;</comment>
                            <comment id="12870696" author="phunt" created="Mon, 24 May 2010 17:44:40 +0100"  >&lt;p&gt;Updated the patch to compile against trunk (started with 632 errors! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ). This is a checkpoint and not a final patch.&lt;/p&gt;

&lt;p&gt;The tests almost all pass, however there are two issues in particular:&lt;/p&gt;

&lt;p&gt;1) ACLTest sometimes fails due to a timing issue (legacy looks like) where the server may send an auth response before sending the connect response (out of order from what the client sent)&lt;/p&gt;

&lt;p&gt;2) the session moved tests are failing - haven&apos;t dug into that yet but it looks like the tests themselves are broken - they don&apos;t account for the fact that the client will attempt to reconnect to the server when the server closes the connection (this is the &quot;original&quot; session, which was moved). Not sure how to solve this one yet and still have a valid test.&lt;/p&gt;

&lt;p&gt;Notes:&lt;/p&gt;

&lt;p&gt;1) the patch currently defaults to Netty as the server cnxn factory, this should not be the case in the final patch&lt;br/&gt;
2) javadoc needs significant cleanup&lt;br/&gt;
3) netty ignores max client connection (need to verify)&lt;br/&gt;
4) server side request throttling may be broken (session)&lt;br/&gt;
5) need to review all of the code moved out of nioservercnxn.java - may be missing some patches applied (the merge was crazy).&lt;br/&gt;
6) I have not yet tested NIO to ensure that it still works&lt;br/&gt;
7) need to add support for configuring the netty/factory knobs&lt;br/&gt;
8) docs still need to be added&lt;br/&gt;
9) need to review logging; correct levels on existing, what needs to be added etc (logging is rough right now, added a number of logs to track down bugs that I found while updating the patch)&lt;br/&gt;
10) need to add ssl support (configurable) in netty&lt;/p&gt;

&lt;p&gt;I added &quot;accessive.jar&quot; to enable testing of private vars (rather than exposing them in core code)&lt;br/&gt;
committer note: accessive.jar needs to be put into src/java/libtest&lt;/p&gt;</comment>
                            <comment id="12872065" author="breed" created="Thu, 27 May 2010 03:30:37 +0100"  >&lt;p&gt;i couldn&apos;t reproduce the move problem, but these two files should fix it.&lt;/p&gt;</comment>
                            <comment id="12872281" author="breed" created="Thu, 27 May 2010 17:36:00 +0100"  >&lt;p&gt;i figured out the timing issue for ACLTest. if you look at how NIOServerCnxn handles the readConnectRequest, you will notice that it disables the receipt of packets until the connect request is processed successfully. if you do that with netty, the ACLTest should work.&lt;/p&gt;</comment>
                            <comment id="12873097" author="phunt" created="Fri, 28 May 2010 19:25:19 +0100"  >&lt;p&gt;Ben that fixes SessionTest for me, but not QuorumTest. I modified QT to use that same mechanism but it still fails.&lt;/p&gt;

&lt;p&gt;For some reason the new session (using existing sessionid/pass) gets a moved exception. Note that these clients are connecting to diff servers. Perhaps that&apos;s the issue (timing)?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-05-28 11:10:25,419 - INFO  [main:JUnit4ZKTestRunner$LoggedInvokeMethod@49] - RUNNING TEST METHOD testSessionMoved
2010-05-28 11:10:25,420 - INFO  [main:ZooKeeper@375] - Initiating client connection, connectString=127.0.0.1:11354 sessionTimeout=30000 watcher=org.apache.zookeeper.test.QuorumTest$4@5c1d29c1
2010-05-28 11:10:25,421 - INFO  [main-SendThread():ClientCnxn$SendThread@1007] - Opening socket connection to server /127.0.0.1:11354
2010-05-28 11:10:25,442 - INFO  [main-SendThread(localhost:11354):ClientCnxn$SendThread@915] - Socket connection established to localhost/127.0.0.1:11354, initiating session
2010-05-28 11:10:25,443 - INFO  [New I/O server worker #51-1:ZooKeeperServer@795] - Client attempting to establish new session at /127.0.0.1:41741
2010-05-28 11:10:25,463 - WARN  [QuorumPeer:0.0.0.0/0.0.0.0:11354:Follower@120] - Got zxid 0x100000001 expected 0x1
2010-05-28 11:10:25,465 - WARN  [QuorumPeer:0.0.0.0/0.0.0.0:11357:Follower@120] - Got zxid 0x100000001 expected 0x1
2010-05-28 11:10:25,492 - WARN  [QuorumPeer:0.0.0.0/0.0.0.0:11355:Follower@120] - Got zxid 0x100000001 expected 0x1
2010-05-28 11:10:25,493 - WARN  [QuorumPeer:0.0.0.0/0.0.0.0:11356:Follower@120] - Got zxid 0x100000001 expected 0x1
2010-05-28 11:10:25,625 - INFO  [CommitProcessor:1:ZooKeeperServer@571] - Established session 0x128e01b97ab0000 with negotiated timeout 30000 for client /127.0.0.1:41741
2010-05-28 11:10:25,625 - INFO  [main-SendThread(localhost:11354):ClientCnxn$SendThread@685] - readConnectRestult 36 0x[0,0,0,0,0,0,75,30,1,28,ffffffe0,1b,ffffff97,ffffffab,0,0,0,0,0,10,ffffffd7,ffffffe2,ffffffd1,39,18,fffffff1,fffffff3,ffffff8c,d,3,ffffff9a,ffffffe8,21,43,ffffffef,13,]
2010-05-28 11:10:25,625 - INFO  [main-SendThread(localhost:11354):ClientCnxn$SendThread@708] - Session establishment complete on server localhost/127.0.0.1:11354, sessionid = 0x128e01b97ab0000, negotiated timeout = 30000
2010-05-28 11:10:25,647 - INFO  [main:ZooKeeper@438] - Initiating client connection, connectString=127.0.0.1:11355 sessionTimeout=30000 watcher=org.apache.zookeeper.test.QuorumTest$5@1cacd5d4 sessionId=128e01b97ab0000 sessionPasswd=&amp;lt;hidden&amp;gt;
2010-05-28 11:10:25,648 - INFO  [main-SendThread():ClientCnxn$SendThread@1007] - Opening socket connection to server /127.0.0.1:11355
2010-05-28 11:10:25,649 - INFO  [main-SendThread(localhost:11355):ClientCnxn$SendThread@915] - Socket connection established to localhost/127.0.0.1:11355, initiating session
2010-05-28 11:10:25,650 - INFO  [New I/O server worker #52-2:ZooKeeperServer@788] - Client attempting to renew session 0x128e01b97ab0000 at /127.0.0.1:45500
2010-05-28 11:10:25,654 - INFO  [ProcessThread:-1:PrepRequestProcessor@405] - Got user-level KeeperException when processing sessionid:0x128e01b97ab0000 type:setData cxid:0x1 zxid:0xfffffffffffffffe txntype:unknown reqpath:/ Error Path:null Error:KeeperErrorCode = Session moved
2010-05-28 11:10:25,691 - INFO  [main-SendThread(localhost:11355):ClientCnxn$SendThread@1125] - Unable to read additional data from server sessionid 0x128e01b97ab0000, likely server has closed socket, closing socket connection and attempting reconnect
2010-05-28 11:10:25,692 - INFO  [CommitProcessor:2:NettyServerCnxn@73] - close 128e01b97ab0000
2010-05-28 11:10:25,692 - INFO  [CommitProcessor:2:NettyServerCnxn@80] - close in progress 128e01b97ab0000
2010-05-28 11:10:25,794 - INFO  [main:JUnit4ZKTestRunner$LoggedInvokeMethod@53] - TEST METHOD FAILED testSessionMoved
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:90)
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:42)
	at org.apache.zookeeper.ZooKeeper.setData(ZooKeeper.java:1127)
	at org.apache.zookeeper.test.QuorumTest.testSessionMoved(QuorumTest.java:204)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;line 204 for me is &lt;/p&gt;

&lt;p&gt;            zknew.setData(&quot;/&quot;, new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, -1);&lt;/p&gt;
</comment>
                            <comment id="12873179" author="phunt" created="Sat, 29 May 2010 00:26:34 +0100"  >&lt;p&gt;QuorumTestFailed shows the session moved failure with TRACE logging turned on.&lt;/p&gt;</comment>
                            <comment id="12873790" author="phunt" created="Mon, 31 May 2010 22:26:08 +0100"  >&lt;p&gt;Updated the patch to include sessiontest session moved fix, also applied to quorumtest session moved tests.&lt;br/&gt;
Added more detail to some thread names to help debugging of QT failure.&lt;/p&gt;

&lt;p&gt;Based on further analysis it looks like QT is failing due to the flow control issue that&apos;s effecting ACLTest - the first client operation is fwd to the leader before the leader can update the session (owner) information for the (re)new client. Fixing the flow control should fix both acl and quorum tests.&lt;/p&gt;</comment>
                            <comment id="12874678" author="breed" created="Wed, 2 Jun 2010 18:23:54 +0100"  >&lt;p&gt;here is my cut at flowctl with netty. flow control seems to be happening, but it doesn&apos;t seem to fix the problem.&lt;/p&gt;</comment>
                            <comment id="12878607" author="kapilt" created="Mon, 14 Jun 2010 16:07:05 +0100"  >&lt;p&gt;Hi folks, I just wanted to note that we&apos;re really interested in the netty integration esp. to allow for secure communications. We don&apos;t have much by way of java developers, but we are available to help out with testing. We&apos;ve successfully run our client test suite against the netty patch applied to trunk.&lt;/p&gt;</comment>
                            <comment id="12878631" author="phunt" created="Mon, 14 Jun 2010 17:35:08 +0100"  >&lt;p&gt;Great, thanks for the fb Kapil. There&apos;s still one serious issue that we know about with the patch, it&apos;s due to the way &lt;br/&gt;
netty handles buffering. Our old server nio code does flow control by disabling read on the inbound sockets, but&lt;br/&gt;
netty aggressively buffers which means that the data&apos;s already been read by the time we disable read. We&apos;re working&lt;br/&gt;
on a solution for that. Subsequently we&apos;ll have some addl work re documentation and such. Also need to test out&lt;br/&gt;
encryption (ssl) support on the channels. It&apos;s in progress but I&apos;ve been distracted by other things (incl the upcoming&lt;br/&gt;
summit). After that we also need to add netty support on the java client side, I&apos;m not sure what we&apos;ll do on the c client&lt;br/&gt;
(to add ssl encrypt/cert support) but if you have any ideas on that we&apos;d appreciate the help.&lt;/p&gt;</comment>
                            <comment id="12878710" author="niemeyer" created="Mon, 14 Jun 2010 20:25:05 +0100"  >&lt;p&gt;Hi Patrick,&lt;/p&gt;

&lt;p&gt;Our most pressing need is actually on securing the client=&amp;gt;server communication indeed.  The basic need is simply to require a specific certificate to connect and communicate securely with the server.  Any clients which don&apos;t hold the certificate should be denied access.&lt;/p&gt;

&lt;p&gt;We&apos;re certainly available for debating on any open issues you&apos;d like to debate on around this.&lt;/p&gt;</comment>
                            <comment id="12886639" author="phunt" created="Fri, 9 Jul 2010 08:14:36 +0100"  >&lt;p&gt;This latest patch ports the prior patches to the latest trunk.&lt;/p&gt;

&lt;p&gt;I also incorporated Ben&apos;s flow control ideas, I had to fix a number of issues as part of this but in general it seems to be working.&lt;/p&gt;

&lt;p&gt;At this point all the tests seem to be working. Still alot of work to do (this patch is a WIP, esp have added a number of logging messages to help debug a number of flow control issues).&lt;/p&gt;

&lt;p&gt;One issue remains with the tests - I&apos;m ignoring the sessionmoved tests for the time being. Still need to debug those.&lt;/p&gt;

&lt;p&gt;Looking pretty good at this point. Need to verify nio, docs, etc... but in general netty on the server side seems to be working.&lt;/p&gt;</comment>
                            <comment id="12887587" author="phunt" created="Tue, 13 Jul 2010 00:36:44 +0100"  >&lt;p&gt;This latest patch fixed throttling in netty and also addresses some pieces that &quot;went missing&quot; in the NIO code. All tests in netty &amp;amp; nio now pass.&lt;/p&gt;

&lt;p&gt;Note: session moved tests are currently ignored since they fail in netty. this seems due to a timing issue (even with the latest changes to these tests) due to the zk client getting a disco watch event before they are able to run an operation (the operation which should be failing due to moved). &lt;/p&gt;</comment>
                            <comment id="12888127" author="phunt" created="Wed, 14 Jul 2010 01:24:00 +0100"  >&lt;p&gt;this latest patch cleans up the logging a bit more it also adds Nio client -&amp;gt; Netty server based unit tests - these are a subset of the base tests but using the netty server cnxn factory.&lt;/p&gt;</comment>
                            <comment id="12888497" author="phunt" created="Wed, 14 Jul 2010 20:13:25 +0100"  >&lt;p&gt;let&apos;s have hudson give it a whack.&lt;/p&gt;</comment>
                            <comment id="12888500" author="hadoopqa" created="Wed, 14 Jul 2010 20:24:15 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12449407/ZOOKEEPER-733.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12449407/ZOOKEEPER-733.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 963957.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 68 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 4 new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/144/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/144/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/144/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/144/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/144/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/144/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12888555" author="phunt" created="Wed, 14 Jul 2010 22:40:15 +0100"  >&lt;p&gt;Updated patch to address issues findbugs found, also removed some duplicated code that I also found while tracking down the findbugs issues. Also addressed some issues that creeped in to the quorum code (fixes that went missing during the many patch porting efforts)&lt;/p&gt;

&lt;p&gt;core tests will never pass since this patch relies on a new jar file that&apos;s not available from maven - attached the jar eariler, be sure to use/commit that. (see my notes on that in comments)&lt;/p&gt;</comment>
                            <comment id="12888562" author="hadoopqa" created="Wed, 14 Jul 2010 22:52:54 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12449488/ZOOKEEPER-733.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12449488/ZOOKEEPER-733.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 963957.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 73 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/145/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/145/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12888587" author="phunt" created="Wed, 14 Jul 2010 23:42:59 +0100"  >&lt;p&gt;that previous diff was bad, this is the right latest diff - includes documentation as well.&lt;/p&gt;</comment>
                            <comment id="12888597" author="hadoopqa" created="Wed, 14 Jul 2010 23:54:04 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12449497/ZOOKEEPER-733.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12449497/ZOOKEEPER-733.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 963957.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 68 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/146/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/146/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/146/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/146/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/146/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/146/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12889909" author="phunt" created="Mon, 19 Jul 2010 17:30:15 +0100"  >&lt;p&gt;while testing I did notice a problem - closed client connections are staying in &quot;time_wait&quot; state for a long period of time.&lt;/p&gt;

&lt;p&gt;this test was done by starting the server, then connecting a java NIO based client using the shell, then quitting the shell using &quot;quit&quot;. Is this the shell or Netty?&lt;/p&gt;

&lt;p&gt;In netty factory we are setting the linger time to 2 sec, however this doesn&apos;t seem to be used? According to netstat the socket is held in time_wait for much longer than 2 sec.&lt;/p&gt;</comment>
                            <comment id="12893025" author="breed" created="Wed, 28 Jul 2010 02:21:45 +0100"  >&lt;p&gt;i ran this on 40 machines simulating 900 clients. the benchmark went well without problems. the results don&apos;t show any real significant performance improvements (or degradations).&lt;/p&gt;</comment>
                            <comment id="12893027" author="hammer" created="Wed, 28 Jul 2010 02:24:35 +0100"  >&lt;p&gt;Hey Ben,&lt;/p&gt;

&lt;p&gt;One motivation for the move to Netty was performance-related:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we would also like the engine to use multiple threads on machines with lots of cores.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Did your benchmarks run on a machine with multiple cores? Any evidence of utilization of multiple cores would be of interest to me.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Jeff&lt;/p&gt;</comment>
                            <comment id="12893272" author="phunt" created="Wed, 28 Jul 2010 18:39:20 +0100"  >&lt;p&gt;I&apos;m surprised there was no change.&lt;/p&gt;

&lt;p&gt;Keep in mind that the default is to continue to use NIO, so if you want to test with Netty you need&lt;br/&gt;
to set the correct factory:&lt;/p&gt;

&lt;p&gt;+        &amp;lt;para&amp;gt;Prior to version 3.4 ZooKeeper has always used NIO&lt;br/&gt;
+            directly, however in versions 3.4 and later Netty is&lt;br/&gt;
+            supported as an option to NIO (replaces). NIO continues to&lt;br/&gt;
+            be the default, however Netty based communication can be&lt;br/&gt;
+            used in place of NIO by setting the environment variable&lt;br/&gt;
+            &quot;zookeeper.serverCnxnFactory&quot; to&lt;br/&gt;
+            &quot;org.apache.zookeeper.server.NettyServerCnxnFactory&quot;. &lt;/p&gt;

&lt;p&gt;Regardless - verify which is being used by checking the logs.&lt;/p&gt;

&lt;p&gt;One potential problem with netty is that we don&apos;t bound the worker thread pool size - it would be interesting to see how this&lt;br/&gt;
effects the test. There are probably a few of these variables which we should provide configuration parameters for...&lt;/p&gt;</comment>
                            <comment id="12894667" author="hadoopqa" created="Mon, 2 Aug 2010 20:37:28 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12449497/ZOOKEEPER-733.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12449497/ZOOKEEPER-733.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 980576.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 68 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/100/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h7.grid.sp2.yahoo.net/100/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12896504" author="dorserg" created="Mon, 9 Aug 2010 12:19:02 +0100"  >&lt;p&gt;I would like to update my read-only mode patch to apply correctly on top of this one.&lt;br/&gt;
The problem is, I can&apos;t apply this patch to trunk. Could you re-generate it against current trunk?&lt;/p&gt;</comment>
                            <comment id="12896573" author="breed" created="Mon, 9 Aug 2010 16:00:02 +0100"  >&lt;p&gt;+1 if you would re-generate the patch, i&apos;d like to get it committed.&lt;/p&gt;</comment>
                            <comment id="12896713" author="phunt" created="Mon, 9 Aug 2010 23:28:10 +0100"  >&lt;p&gt;This patch resolves conflicts with the latest trunk. That is all.&lt;/p&gt;</comment>
                            <comment id="12896996" author="dorserg" created="Tue, 10 Aug 2010 19:43:47 +0100"  >&lt;p&gt;I noticed that NettyServerCnxn class contains big copy-paste of all 4-letter commands and checkFourLetterWord method is also almost identical to one in NIOServerCnxn. The only difference is: &lt;br/&gt;
1) commands in NettyCnxn don&apos;t extendThread &lt;br/&gt;
2) checkFourLetterWord methods differ in I/O a bit. But big &quot;if (len==someCmd) &lt;/p&gt;
{ start someCmd }
&lt;p&gt;&quot; part is the same.&lt;/p&gt;

&lt;p&gt;So, questions:&lt;br/&gt;
1) is there any practical reason for commands in NIOCnxn being Threads? If no, they are identical with ones from NettyCnxn, so we could move all commands to ServerCnxn superclass &lt;br/&gt;
2) big part of checkFourLetterWord (IO-unrelated one, described above) could also be moved to superclass&lt;/p&gt;
</comment>
                            <comment id="12897832" author="breed" created="Thu, 12 Aug 2010 17:49:55 +0100"  >&lt;p&gt;+1 looks good to commit. Sergey raises a valid point, but i think it should be addressed in a separate jira given the size of this patch.&lt;/p&gt;</comment>
                            <comment id="12899046" author="phunt" created="Mon, 16 Aug 2010 20:41:21 +0100"  >&lt;p&gt;Def some refactorings that would be done. wrt issue 1) that sergey raised the issue is that when using nio we can &quot;hand off&quot; the socket to the thread, which uses blocking io to ensure that the client&lt;br/&gt;
receives the results before we close the socket. With Netty we don&apos;t have this option, so we can&apos;t process the request as a subthread. Also notice that netty is spawning workers as necessary (up to some limit)&lt;br/&gt;
so in that case we don&apos;t spawn a thread - although it&apos;s questionable whether this is a good idea as the total pool size is limited (in real production case).&lt;/p&gt;</comment>
                            <comment id="12899047" author="phunt" created="Mon, 16 Aug 2010 20:42:18 +0100"  >&lt;p&gt;Ben, did you make changes to allow the max worker limit to be configured? If so can you either update the patch or create a new jira with the changes?&lt;/p&gt;</comment>
                            <comment id="12899101" author="breed" created="Mon, 16 Aug 2010 22:28:33 +0100"  >&lt;p&gt;we should commit the patch as is. trying to add features to it and maintain the patch fresh is too unwieldy!&lt;/p&gt;</comment>
                            <comment id="12899141" author="phunt" created="Mon, 16 Aug 2010 23:31:03 +0100"  >&lt;p&gt;That&apos;s fine, but in that case create a JIRA to track (if you have a patch all the better), so we don&apos;t lose the thought. thanks.&lt;/p&gt;</comment>
                            <comment id="12899754" author="phunt" created="Wed, 18 Aug 2010 07:25:43 +0100"  >&lt;p&gt;committed to 3.4.0&lt;/p&gt;</comment>
                            <comment id="12909607" author="hudson" created="Wed, 15 Sep 2010 07:19:56 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #936 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/936/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/936/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12469662">ZOOKEEPER-823</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12471438">ZOOKEEPER-845</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12455505">AVRO-405</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12445824" name="QuorumTestFailed_sessionmoved_TRACE_LOG.txt.gz" size="763543" author="phunt" created="Sat, 29 May 2010 00:26:34 +0100"/>
                            <attachment id="12451631" name="ZOOKEEPER-733.patch" size="249750" author="phunt" created="Mon, 9 Aug 2010 23:28:10 +0100"/>
                            <attachment id="12449497" name="ZOOKEEPER-733.patch" size="249809" author="phunt" created="Wed, 14 Jul 2010 23:42:59 +0100"/>
                            <attachment id="12449488" name="ZOOKEEPER-733.patch" size="323339" author="phunt" created="Wed, 14 Jul 2010 22:40:14 +0100"/>
                            <attachment id="12449407" name="ZOOKEEPER-733.patch" size="254052" author="phunt" created="Wed, 14 Jul 2010 01:24:00 +0100"/>
                            <attachment id="12449304" name="ZOOKEEPER-733.patch" size="249083" author="phunt" created="Tue, 13 Jul 2010 00:36:44 +0100"/>
                            <attachment id="12449061" name="ZOOKEEPER-733.patch" size="243318" author="phunt" created="Fri, 9 Jul 2010 08:14:35 +0100"/>
                            <attachment id="12445963" name="ZOOKEEPER-733.patch" size="220086" author="phunt" created="Mon, 31 May 2010 22:26:07 +0100"/>
                            <attachment id="12445347" name="ZOOKEEPER-733.patch" size="213743" author="phunt" created="Mon, 24 May 2010 17:44:40 +0100"/>
                            <attachment id="12440757" name="ZOOKEEPER-733.patch" size="103551" author="breed" created="Mon, 5 Apr 2010 15:51:20 +0100"/>
                            <attachment id="12445348" name="accessive.jar" size="20879" author="phunt" created="Mon, 24 May 2010 17:44:40 +0100"/>
                            <attachment id="12446159" name="flowctl.zip" size="8110" author="breed" created="Wed, 2 Jun 2010 18:23:54 +0100"/>
                            <attachment id="12445613" name="moved.zip" size="4918" author="breed" created="Thu, 27 May 2010 03:30:36 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>13.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 24 May 2010 16:44:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47629</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzxfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33401</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>