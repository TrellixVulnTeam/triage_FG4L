<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:40:35 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1124/ZOOKEEPER-1124.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1124] Multiop submitted to non-leader always fails due to timeout</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1124</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The new Multiop support added under zookeeper-965 fails every single time if the multiop is submitted to a non-leader in quorum mode. In standalone mode it always works properly and this bug only presents itself in quorum mode (with 2 or more nodes). After 12 hours of debugging (&lt;b&gt;sigh&lt;/b&gt;) it turns out to be a really simple fix. There are a couple of missing case statements inside FollowerRequestProcessor.java and ObserverRequestProcessor.java to ensure that multiop is forwarded to the leader for commit. I&apos;ve attached a patch that fixes this problem.&lt;/p&gt;

&lt;p&gt;It&apos;s probably worth nothing that zookeeper-965 has already been committed to trunk. But this is a fatal flaw that will prevent multiop support from working properly and as such needs to get committed to 3.4.0 as well. Is there a way to tie these two cases together in some way?&lt;/p&gt;</description>
                <environment>&lt;p&gt;all&lt;/p&gt;</environment>
        <key id="12513948">ZOOKEEPER-1124</key>
            <summary>Multiop submitted to non-leader always fails due to timeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marshall">Marshall McMullen</assignee>
                                    <reporter username="marshall">Marshall McMullen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Jul 2011 17:17:58 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:26 +0000</updated>
                            <resolved>Fri, 15 Jul 2011 05:51:26 +0100</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13064671" author="marshall" created="Wed, 13 Jul 2011 17:19:56 +0100"  >&lt;p&gt;Patch to add OpCode.multi case statements into FollowerRequestProcessor.java and ObserverRequestProcessor.java.&lt;/p&gt;</comment>
                            <comment id="13064681" author="tdunning" created="Wed, 13 Jul 2011 17:36:29 +0100"  >&lt;p&gt;This bug is a defect in the committed version of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-965&quot; title=&quot;Need a multi-update command to allow multiple znodes to be updated safely&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-965&quot;&gt;&lt;del&gt;ZOOKEEPER-965&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13064683" author="tdunning" created="Wed, 13 Jul 2011 17:37:24 +0100"  >&lt;p&gt;Marshall,&lt;/p&gt;

&lt;p&gt;This fix is clearly important. Do you have any tests?&lt;/p&gt;

&lt;p&gt;The role of these tests is not just to verify this bug, but also to provide a prototype for any later implementors of new operations.&lt;/p&gt;</comment>
                            <comment id="13064684" author="tdunning" created="Wed, 13 Jul 2011 17:38:31 +0100"  >&lt;p&gt;All,&lt;/p&gt;

&lt;p&gt;Is there a way to restructure the code so that naive implementors don&apos;t run into this situation?  Essentially, the code as it stands is default-fail and it would be nice to make it be default-succeed in the presence of new ops.&lt;/p&gt;

&lt;p&gt;Or is the addition of new ops rare enough that this doesn&apos;t matter?&lt;/p&gt;</comment>
                            <comment id="13064689" author="hadoopqa" created="Wed, 13 Jul 2011 17:44:29 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12486329/multi-non-observer.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12486329/multi-non-observer.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1146025.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/390//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/390//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/390//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/390//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/390//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/390//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13064707" author="marshall" created="Wed, 13 Jul 2011 18:20:16 +0100"  >&lt;p&gt;I wrote unit tests in our own local test harness to verify the fix. I also tested manually to verify the fix.&lt;/p&gt;

&lt;p&gt;I wasn&apos;t able to figure out how to write a proper zookeeper unit test in either the C or Java unit tests as I couldn&apos;t find a single example where we spawn off multiple zookeeper servers in quorum mode. Is there an example of this somewhere that I&apos;ve missed? I see lots of examples of starting up one zookeeper server, and various mock instances of servers, but nowhere that I could find where we start multiple real servers.&lt;/p&gt;</comment>
                            <comment id="13064710" author="marshall" created="Wed, 13 Jul 2011 18:22:17 +0100"  >&lt;p&gt;I agree with Ted&apos;s comment regarding the default here is to fail (drop on floor) when new op types are added. I thought of throwing an exception if it wasn&apos;t in the switch so it would fail at runtime instead of silently failing as it does now. But perhaps the better answer is to instead of enumerating all op types, just pass them all through to the appropriate Observer/Follower. Then let it deal with throwing an exception if the type isn&apos;t supported. That or if there are explicit types not supported by an observer/follower, deal with those explicitly then assume the rest are valid and pass them along.&lt;/p&gt;</comment>
                            <comment id="13064727" author="fournc" created="Wed, 13 Jul 2011 18:50:00 +0100"  >&lt;p&gt;The QuorumBase and associated tests are probably what you want, Marshall. Those tests can be used to set up a quorum of ZKs, and if you look at tests that extend it tehy will show you how to figure out if you are connected to a leader or follower.&lt;/p&gt;</comment>
                            <comment id="13064805" author="marshall" created="Wed, 13 Jul 2011 20:44:28 +0100"  >&lt;p&gt;Thanks for the suggestion Camille. I&apos;ll try to add a unit test this evening that verifies behavior.&lt;/p&gt;</comment>
                            <comment id="13064830" author="mahadev" created="Wed, 13 Jul 2011 21:49:34 +0100"  >&lt;p&gt;Marshall, take a look at QuorumTest to see how to start a real quorom set of servers.&lt;/p&gt;</comment>
                            <comment id="13064831" author="mahadev" created="Wed, 13 Jul 2011 21:49:41 +0100"  >&lt;p&gt;Marshall, take a look at QuorumTest to see how to start a real quorom set of servers.&lt;/p&gt;</comment>
                            <comment id="13065034" author="marshall" created="Thu, 14 Jul 2011 04:45:29 +0100"  >&lt;p&gt;Replacing this patch with an updated one with a proper unit test.&lt;/p&gt;</comment>
                            <comment id="13065036" author="marshall" created="Thu, 14 Jul 2011 04:51:01 +0100"  >&lt;p&gt;Replacing earlier patch with a better one that contains a unit test that exhibits the fix works properly. The unit test essentially connects to a follower, then submits a multiop to the follower. It then verifies that the multiop succeeded properly. &lt;/p&gt;

&lt;p&gt;When I run this unit test WITHOUT the required fixes in FollowerRequestProcessor.java and ObserverRequestProcessor.java, then I get a nice failure that correctly replicates the failures I&apos;ve seen in our integration of multi:&lt;/p&gt;

&lt;p&gt;Testcase: testMultiToFollower took 28.451 sec                                                                                                                                                                                                                                 &lt;br/&gt;
    Caused an ERROR                                                                                                                                                                                                                                                           &lt;br/&gt;
KeeperErrorCode = ConnectionLoss                                                                                                                                                                                                                                              &lt;br/&gt;
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss                                                                                                                                                                                &lt;br/&gt;
    at org.apache.zookeeper.KeeperException.create(KeeperException.java:99)                                                                                                                                                                                                   &lt;br/&gt;
    at org.apache.zookeeper.ZooKeeper.multiInternal(ZooKeeper.java:886)                                                                                                                                                                                                       &lt;br/&gt;
    at org.apache.zookeeper.ZooKeeper.multi(ZooKeeper.java:876)                                                                                                                                                                                                               &lt;br/&gt;
    at org.apache.zookeeper.test.QuorumTest.testMultiToFollower(QuorumTest.java:89)                                                                                                                                                                                           &lt;br/&gt;
    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:52)     &lt;/p&gt;

&lt;p&gt;WITH the fixes in the included patch, the unit test passes correctly.&lt;/p&gt;</comment>
                            <comment id="13065043" author="hadoopqa" created="Thu, 14 Jul 2011 05:24:36 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12486402/ZOOKEEPER-1124.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12486402/ZOOKEEPER-1124.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1146025.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/394//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/394//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/394//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/394//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/394//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/394//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13065695" author="breed" created="Fri, 15 Jul 2011 04:37:15 +0100"  >&lt;p&gt;looks great. this is ready to go. the only thing that needs to be fixed is the import org.apache.zookeeper.*; we never import *, so it needs to be expanded.&lt;/p&gt;</comment>
                            <comment id="13065713" author="breed" created="Fri, 15 Jul 2011 05:51:26 +0100"  >&lt;p&gt;+1 i resolved the imports before checking in the patch. thanks for the patch marshall!&lt;/p&gt;

&lt;p&gt;Committed revision 1146961.&lt;/p&gt;</comment>
                            <comment id="13065716" author="marshall" created="Fri, 15 Jul 2011 05:58:21 +0100"  >&lt;p&gt;Thanks for fixing the imports Benjamin, totally appreciate it. I was just sitting down to fix that, so I was happy to see an email from you that you&apos;d already taken care of it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="13065866" author="hudson" created="Fri, 15 Jul 2011 12:30:50 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1244 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1244/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1244/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1124&quot; title=&quot;Multiop submitted to non-leader always fails due to timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1124&quot;&gt;&lt;del&gt;ZOOKEEPER-1124&lt;/del&gt;&lt;/a&gt;. Multiop submitted to non-leader always fails due to timeout&lt;/p&gt;

&lt;p&gt;breed : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1146961&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1146961&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/FollowerRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/QuorumTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/ObserverRequestProcessor.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12494148">ZOOKEEPER-965</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12486402" name="ZOOKEEPER-1124.patch" size="4365" author="marshall" created="Thu, 14 Jul 2011 04:51:01 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 13 Jul 2011 16:36:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3990</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzt5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32708</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>