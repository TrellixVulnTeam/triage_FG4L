<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:49:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1412/ZOOKEEPER-1412.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1412] java client watches inconsistently triggered on reconnect</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1412</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;I&apos;ve observed an inconsistent behavior in java client watches. The inconsistency relates to the behavior after the client reconnects to the zookeeper ensemble.&lt;/p&gt;

&lt;p&gt;After the client reconnects to the ensemble only those watches should trigger which should have been triggered also if the connections was not lost. This means if I watch for changes in node /foo and there is no change there than my watch should not be triggered on reconnecting to the ensemble.&lt;br/&gt;
This is not always the case in the java client.&lt;/p&gt;

&lt;p&gt;I&apos;ve debugged the issues and I could locate the case when the watch is always triggered on reconnect. This is consistently happening if I connect to a follower in the ensemble and I don&apos;t do any operation which goes through the leader.&lt;br/&gt;
Looking at the code I see that the client stores the lastzxid and sends that with its request. This is 0 on startup and will be updated everytime from the server replies. This lastzxid is also sent to the server after reconnect together with watches. The server decides which watch to trigger based on this lastzxid probably because that should mean the last known state of the client. If this lastzxid is 0 than all the watches are triggered.&lt;br/&gt;
I&apos;ve checked why is this lastzxid 0. I thought it shouldn&apos;t be since there was already a request to the server to set the watch and in the reply the server could have sent back the zxid but it turns out that it sends just 0. Looking at the server code I see that for requests which doesn&apos;t go through the leader the follower server just sends back the same zxid that the client sent.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12546069">ZOOKEEPER-1412</key>
            <summary>java client watches inconsistently triggered on reconnect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="phunt">Patrick Hunt</assignee>
                                    <reporter username="botond.hejj">Botond Hejj</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Mar 2012 09:13:24 +0000</created>
                <updated>Tue, 5 Jun 2012 00:33:58 +0100</updated>
                            <resolved>Thu, 15 Mar 2012 17:06:13 +0000</resolved>
                                    <version>3.3.3</version>
                    <version>3.3.4</version>
                    <version>3.4.0</version>
                    <version>3.4.1</version>
                    <version>3.4.2</version>
                    <version>3.4.3</version>
                                    <fixVersion>3.3.5</fixVersion>
                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13227692" author="phunt" created="Mon, 12 Mar 2012 17:10:02 +0000"  >&lt;p&gt;This is a serious issue, although it does have a pretty straightforward workaround. I&apos;ll respin a new 3.3.5 rc that includes a fix for this (I&apos;m working on it).&lt;/p&gt;</comment>
                            <comment id="13227907" author="phunt" created="Mon, 12 Mar 2012 21:12:33 +0000"  >&lt;p&gt;These three patches fix the issue on the respective branches. I verified the tests failed before the fix, and passed subsequent to the fix. All tests are passing for me on the three branches.&lt;/p&gt;

&lt;p&gt;I believe accessing/returning the lastzxid as I do in FinalRequestProcessor is valid, but it took me some time to convince myself. Please double check that the lastzxid I send back to the client is the one corresponding to the zxid at the time the read was performed&lt;/p&gt;</comment>
                            <comment id="13227932" author="phunt" created="Mon, 12 Mar 2012 21:35:21 +0000"  >&lt;p&gt;On second thought it does look like this there&apos;s a problem with this approach. If the follower sees a commit subsequent to doing the read op, but prior to getting the lastzxid in FRP the client will end up getting an invalid lastzxid. I&apos;ll have to look at how to handle this a different way. Canceling for now. Any ideas? For the write case the leader is updating the request zxid, perhaps we need to do that here. The alternative is to have the read ops return the lastzxid, but that&apos;s going to be pretty disruptive...&lt;/p&gt;</comment>
                            <comment id="13227960" author="hadoopqa" created="Mon, 12 Mar 2012 21:56:57 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12518091/ZOOKEEPER-1412_trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12518091/ZOOKEEPER-1412_trunk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1297740.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/990//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/990//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/990//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/990//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/990//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/990//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13227994" author="breed" created="Mon, 12 Mar 2012 22:23:33 +0000"  >&lt;p&gt;+1 looks good pat. my one small comment is that you comment one of the methods in TestableZooKeeper, but not the other. since it is kind of a public interface it might be good to comment both.&lt;/p&gt;</comment>
                            <comment id="13228005" author="mahadev" created="Mon, 12 Mar 2012 22:29:35 +0000"  >&lt;p&gt;Looks good. +1 for the patch (pending fixing ben&apos;s comments &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;</comment>
                            <comment id="13228021" author="phunt" created="Mon, 12 Mar 2012 22:54:04 +0000"  >&lt;p&gt;Ok, updated with comments. Good to see I was right (at least initially). thanks.&lt;/p&gt;</comment>
                            <comment id="13228049" author="hadoopqa" created="Mon, 12 Mar 2012 23:26:16 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12518111/ZOOKEEPER-1412_trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12518111/ZOOKEEPER-1412_trunk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1297740.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/991//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/991//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/991//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/991//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/991//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/991//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13228278" author="botond.hejj" created="Tue, 13 Mar 2012 08:47:55 +0000"  >&lt;p&gt;Thanks for the patch Patrick.&lt;/p&gt;

&lt;p&gt;As I mentioned in my second mail I see a difference between java and c client in regards how they update lastzxid. The c client updates it for all operations and java not. This bug was not surfacing when c client was used because c client updates the lastzxid on every ping. &lt;/p&gt;

&lt;p&gt;Do you see any problem with this inconsistency between the c and java client? Is it worth changing one to behave like the other?&lt;/p&gt;</comment>
                            <comment id="13228483" author="breed" created="Tue, 13 Mar 2012 16:16:33 +0000"  >&lt;p&gt;i agree with botond that we should also fix the java client to update lastzxid on every message. it might be worth doing in a separate jira.&lt;/p&gt;</comment>
                            <comment id="13228518" author="phunt" created="Tue, 13 Mar 2012 17:01:27 +0000"  >&lt;p&gt;Honestly I didn&apos;t have time to look into all of these scenarios, but I have a concern wrt introducing this change into 3.3 code line, I&apos;d be more comfortable look at such a change for 3.4 or 3.5. For example, if we did introduce this further changes, is there any chance to get a ping response which updates the lastzxid, then disconnect from the server before getting a notification that would then be missed on reconnect?&lt;/p&gt;

&lt;p&gt;I&apos;d like to cut a 3.3.5 with what I have so far, which clearly fixes the issue identified (and 3.3.5 fixes another critical issues to get in user&apos;s hands). We can then look at further improvements in a separate jira. Make sense?&lt;/p&gt;</comment>
                            <comment id="13228740" author="mahadev" created="Tue, 13 Mar 2012 21:46:16 +0000"  >&lt;p&gt;I think its ok to go with the current patch for 3.3 line and update the patch to match the zxid&apos;s for 3.4 and trunk. I agree with Pat on keeping the changes minimal for 3.3 line. &lt;/p&gt;</comment>
                            <comment id="13231063" author="hudson" created="Fri, 16 Mar 2012 11:07:48 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1493 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1493/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1493/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1412&quot; title=&quot;java client watches inconsistently triggered on reconnect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1412&quot;&gt;&lt;del&gt;ZOOKEEPER-1412&lt;/del&gt;&lt;/a&gt;. java client watches inconsistently triggered on reconnect (phunt) (Revision 1301089)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
phunt : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1301089&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1301089&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/ClientCnxn.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/FinalRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/TestableZooKeeper.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/FollowerResyncConcurrencyTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13288551" author="calvarez" created="Mon, 4 Jun 2012 14:36:38 +0100"  >&lt;p&gt;Once applied this fix, a NodeDataChanged is received instead of a NodeCreated.&lt;br/&gt;
More information in user mailing list thread &quot;Unexpected NodeCreated with 3.4.3?&quot;&lt;br/&gt;
Affected versions: 3.3.5 and 3.4.3 + ZK-1412&lt;/p&gt;</comment>
                            <comment id="13288987" author="phunt" created="Tue, 5 Jun 2012 00:33:58 +0100"  >&lt;p&gt;Hi C&#233;sar, I just tried reproducing using the java cli (zk shell) client and was unable (iirc I was able to reproduce previously) using the latest on branch-3.4 (includes this fix).&lt;/p&gt;

&lt;p&gt;started client against a follower (3 server ensemble)&lt;/p&gt;

&lt;p&gt;WatchedEvent state:SyncConnected type:None path:null&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;zk: (CONNECTED) 0&amp;#93;&lt;/span&gt; ls /foo 1&lt;/p&gt;

&lt;p&gt;killed the server&lt;br/&gt;
WatchedEvent state:Disconnected type:None path:null&lt;/p&gt;

&lt;p&gt;restarted the server&lt;br/&gt;
WatchedEvent state:SyncConnected type:None path:null&lt;/p&gt;

&lt;p&gt;that was it&lt;/p&gt;

&lt;p&gt;I then started a second client and deleted /foo, which caused&lt;/p&gt;

&lt;p&gt;WatchedEvent state:SyncConnected type:NodeDeleted path:/foo&lt;/p&gt;

&lt;p&gt;so afaict it looks right to me.&lt;/p&gt;

&lt;p&gt;If you still see issues please open a separate jira. A test that reproduces this would also be useful.&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12546618">ZOOKEEPER-1417</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12518109" name="ZOOKEEPER-1412_br33.patch" size="6603" author="phunt" created="Mon, 12 Mar 2012 22:52:21 +0000"/>
                            <attachment id="12518088" name="ZOOKEEPER-1412_br33.patch" size="6524" author="phunt" created="Mon, 12 Mar 2012 21:05:46 +0000"/>
                            <attachment id="12518110" name="ZOOKEEPER-1412_br34.patch" size="8304" author="phunt" created="Mon, 12 Mar 2012 22:52:21 +0000"/>
                            <attachment id="12518089" name="ZOOKEEPER-1412_br34.patch" size="8225" author="phunt" created="Mon, 12 Mar 2012 21:05:46 +0000"/>
                            <attachment id="12518111" name="ZOOKEEPER-1412_trunk.patch" size="8199" author="phunt" created="Mon, 12 Mar 2012 22:54:04 +0000"/>
                            <attachment id="12518091" name="ZOOKEEPER-1412_trunk.patch" size="8120" author="phunt" created="Mon, 12 Mar 2012 21:12:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 12 Mar 2012 17:10:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231227</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwchj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12510</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>