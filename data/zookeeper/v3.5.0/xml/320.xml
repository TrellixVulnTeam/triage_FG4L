<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:45:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-320/ZOOKEEPER-320.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-320] call auth completion in free_completions()</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-320</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;If a client calls zoo_add_auth() with an invalid scheme (e.g., &quot;foo&quot;) the ZooKeeper server will mark their session expired and close the connection.  However, the C client has returned immediately after queuing the new auth data to be sent with a ZOK return code.&lt;/p&gt;

&lt;p&gt;If the client then waits for their auth completion function to be called, they can wait forever, as no session event is ever delivered to that completion function.  All other completion functions are notified of session events by free_completions(), which is called by cleanup_bufs() in handle_error() in handle_socket_error_msg().&lt;/p&gt;

&lt;p&gt;In actual fact, what can happen (about 50% of the time, for me) is that the next call by the IO thread to flush_send_queue() calls send() from within send_buffer(), and receives a SIGPIPE signal during this send() call.  Because the ZooKeeper C API is a library, it properly does not catch that signal.  If the user&apos;s code is not catching that signal either, they experience an abort caused by an untrapped signal.  If they are ignoring the signal &amp;#8211; which is common in context I&apos;m working in, the Apache httpd server &amp;#8211; then flush_send_queue()&apos;s error return code is EPIPE, which is logged by handle_socket_error_msg(), and all non-auth completion functions are notified of a session event.  However, if the caller is waiting for their auth completion function, they wait forever while the IO thread tries repeatedly to reconnect and is rejected by the server as having an expired session.&lt;/p&gt;

&lt;p&gt;So, first of all, it would be useful to document in the C API portion of the programmer&apos;s guide that trapping or ignoring SIGPIPE is important, as this signal may be generated by the C API.&lt;/p&gt;

&lt;p&gt;Next, the two attached patches call the auth completion function, if any, in free_completions(), which fixes this problem for me.  The second attached patch includes auth lock/unlock function, as per &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-319&quot; title=&quot;add locking around auth info in zhandle_t&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-319&quot;&gt;&lt;del&gt;ZOOKEEPER-319&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12415001">ZOOKEEPER-320</key>
            <summary>call auth completion in free_completions()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cdarroch">Chris Darroch</assignee>
                                    <reporter username="cdarroch">Chris Darroch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Feb 2009 22:48:01 +0000</created>
                <updated>Wed, 8 Jul 2009 21:24:00 +0100</updated>
                            <resolved>Fri, 27 Feb 2009 20:05:19 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.0.1</version>
                    <version>3.1.0</version>
                                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12674385" author="cdarroch" created="Tue, 17 Feb 2009 22:50:36 +0000"  >&lt;p&gt;This patch does not include locking for the auth data, as per &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-319&quot; title=&quot;add locking around auth info in zhandle_t&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-319&quot;&gt;&lt;del&gt;ZOOKEEPER-319&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12674387" author="cdarroch" created="Tue, 17 Feb 2009 22:51:56 +0000"  >&lt;p&gt;This patch includes auth data locking as per &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-319&quot; title=&quot;add locking around auth info in zhandle_t&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-319&quot;&gt;&lt;del&gt;ZOOKEEPER-319&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12674452" author="cdarroch" created="Wed, 18 Feb 2009 04:57:09 +0000"  >&lt;p&gt;I should perhaps clarify that the reason one might want to unconditionally wait on the auth completion after calling zoo_add_auth() is so as to provide one&apos;s own sync version of that function.  The various sync functions such as zoo_wget(), zoo_set2(), etc. are just wrappers of the async versions followed by an unconditional wait on the relevant completion.  Similarly, in a context which must be exclusively sync-only, zoo_add_auth() needs to be followed by a wait on its completion.&lt;/p&gt;</comment>
                            <comment id="12674806" author="cdarroch" created="Wed, 18 Feb 2009 22:10:13 +0000"  >&lt;p&gt;This version avoids holding the auth lock while calling the user&apos;s auth completion function (which may run for a long time; we don&apos;t know).&lt;/p&gt;</comment>
                            <comment id="12676825" author="mahadev" created="Thu, 26 Feb 2009 00:22:07 +0000"  >&lt;p&gt;+1 for the second patch.&lt;/p&gt;</comment>
                            <comment id="12677143" author="cdarroch" created="Thu, 26 Feb 2009 21:18:29 +0000"  >&lt;p&gt;Updated with a NULL initialization as per the comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-319&quot; title=&quot;add locking around auth info in zhandle_t&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-319&quot;&gt;&lt;del&gt;ZOOKEEPER-319&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-319#action_12676824&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-319#action_12676824&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Out of interest &amp;#8212; what compiler gives these errors?  My gcc 4.1.2 with -Wall doesn&apos;t report any troubles.&lt;/p&gt;</comment>
                            <comment id="12677144" author="cdarroch" created="Thu, 26 Feb 2009 21:20:08 +0000"  >&lt;p&gt;Also, please note my suggestion that the docs mention the need to catch, ignore, or otherwise be aware of SIGPIPE signals.&lt;/p&gt;</comment>
                            <comment id="12677169" author="mahadev" created="Thu, 26 Feb 2009 23:15:57 +0000"  >&lt;p&gt;my compiler is gcc 3.4.4&lt;/p&gt;</comment>
                            <comment id="12677501" author="mahadev" created="Fri, 27 Feb 2009 20:05:19 +0000"  >&lt;p&gt;I just committed this. Thanks chris.&lt;/p&gt;</comment>
                            <comment id="12677686" author="hudson" created="Sat, 28 Feb 2009 15:15:49 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #243 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/243/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/243/&lt;/a&gt;)&lt;br/&gt;
    . call auth completion in free_completions(). (chris darroch via mahadev)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12401068" name="ZOOKEEPER-320-319.patch" size="818" author="cdarroch" created="Thu, 26 Feb 2009 21:18:28 +0000"/>
                            <attachment id="12400456" name="ZOOKEEPER-320-319.patch" size="811" author="cdarroch" created="Wed, 18 Feb 2009 22:10:13 +0000"/>
                            <attachment id="12400360" name="ZOOKEEPER-320.patch" size="435" author="cdarroch" created="Tue, 17 Feb 2009 22:50:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 26 Feb 2009 00:22:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47902</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzvsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33134</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>