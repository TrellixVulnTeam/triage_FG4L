<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:48:40 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-897/ZOOKEEPER-897.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-897] C Client seg faults during close</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-897</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We observed a crash while closing our c client.  It was in the do_io() thread that was processing as during the close() call.&lt;/p&gt;

&lt;p&gt;#0  queue_buffer (list=0x6bd4f8, b=0x0, add_to_front=0) at src/zookeeper.c:969&lt;br/&gt;
#1  0x000000000046234e in check_events (zh=0x6bd480, events=&amp;lt;value optimized out&amp;gt;) at src/zookeeper.c:1687&lt;br/&gt;
#2  0x0000000000462d74 in zookeeper_process (zh=0x6bd480, events=2) at src/zookeeper.c:1971&lt;br/&gt;
#3  0x0000000000469c34 in do_io (v=0x6bd480) at src/mt_adaptor.c:311&lt;br/&gt;
#4  0x00007ffff7bc59ca in start_thread () from /lib/libpthread.so.0&lt;br/&gt;
#5  0x00007ffff6f706fd in clone () from /lib/libc.so.6&lt;br/&gt;
#6  0x0000000000000000 in ?? ()&lt;/p&gt;

&lt;p&gt;We tracked down the sequence of events, and the cause is that input_buffer is being freed from a thread other than the do_io thread that relies on it:&lt;/p&gt;

&lt;p&gt;1. do_io() call check_events()&lt;br/&gt;
2. if(events&amp;amp;ZOOKEEPER_READ) branch executes&lt;br/&gt;
3. if (rc &amp;gt; 0) branch executes&lt;br/&gt;
4. if (zh-&amp;gt;input_buffer != &amp;amp;zh-&amp;gt;primer_buffer) branch executes&lt;br/&gt;
.....in the meantime......&lt;br/&gt;
     5. zookeeper_close() called&lt;br/&gt;
     6. if (inc_ref_counter(zh,0)!=0) branch executes&lt;br/&gt;
     7. cleanup_bufs() is called&lt;br/&gt;
     8. input_buffer is freed at the end&lt;br/&gt;
..... back to check_events().........&lt;br/&gt;
9. queue_events() is called on a NULL buffer.&lt;/p&gt;

&lt;p&gt;I believe the patch is to only call free_completions() in zookeeper_close() and not cleanup_bufs().  The original reason cleanup_bufs() was added was to call any outstanding synhcronous completions, so only free_completions (which is guarded) is needed.  I will submit a patch for review with this change.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12477390">ZOOKEEPER-897</key>
            <summary>C Client seg faults during close</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jaredc">Jared Cantwell</assignee>
                                    <reporter username="jaredc">Jared Cantwell</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Oct 2010 20:26:06 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:21 +0000</updated>
                            <resolved>Thu, 28 Oct 2010 17:25:53 +0100</resolved>
                                                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12921092" author="jaredc" created="Thu, 14 Oct 2010 20:28:38 +0100"  >&lt;p&gt;Patch that only calls free_completions in zookeeper_close() instead of cleanup_bufs().&lt;/p&gt;</comment>
                            <comment id="12922246" author="jaredc" created="Mon, 18 Oct 2010 21:44:02 +0100"  >&lt;p&gt;Updated patch format and spelling.&lt;/p&gt;</comment>
                            <comment id="12924744" author="mahadev" created="Mon, 25 Oct 2010 22:53:37 +0100"  >&lt;p&gt;jared,&lt;br/&gt;
  The patch that you provided leaks memory for the zookeeper client. We have to clean up the tosend and to process buffers on close and free them. Did you observe the problem with which release?&lt;/p&gt;

&lt;p&gt;I had tried to fix all the issues with zookeeper_close() in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-591&quot; title=&quot;The C Client cannot exit properly in some situation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-591&quot;&gt;&lt;del&gt;ZOOKEEPER-591&lt;/del&gt;&lt;/a&gt;. Also, michi has fixed a couple other issues in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-804&quot; title=&quot;c unit tests failing due to &amp;quot;assertion cptr failed&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-804&quot;&gt;&lt;del&gt;ZOOKEEPER-804&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;what version of code are you running? Also, can you provide some test case which causes this issue? (I know its hard to reproduce but even a test that reproduces it once in 10-20 times is good enough).&lt;/p&gt;</comment>
                            <comment id="12924748" author="jaredc" created="Mon, 25 Oct 2010 23:02:13 +0100"  >&lt;p&gt;we are using the 3.3.2 release.  i don&apos;t think the patch leaks memory because destroy() will eventually get called (by the reentrant call to zookeeper_close()), which calls cleanup_bufs() and frees those buffers, right?  Also, i had a test that reproduced this error, but it was easiest to reproduce if i injected artificial sleeps into the zookeeper.c file.  If that&apos;s ok, then I can submit that.  Otherwise, i&apos;ll see if i can devise a test that can reproduce it otherwise.&lt;/p&gt;</comment>
                            <comment id="12925594" author="mahadev" created="Wed, 27 Oct 2010 23:55:20 +0100"  >&lt;p&gt;You are right Jared. The patch looks good to me. I am trying to rerun the cpp unit tests a couple of times to reverify that the client close doesnt create any problems. It would be great if you could rerun the cppunit tests couple of times to endorse the fix.&lt;/p&gt;</comment>
                            <comment id="12925835" author="jaredc" created="Thu, 28 Oct 2010 16:26:57 +0100"  >&lt;p&gt;I wasn&apos;t able to figure out how to write a test for this scenario without injecting some helper code into zookeeper.c.  I ran the cpp unittests ~20 times locally and no issues.  Also, I&apos;ve temporarily been using this in our test environment for ~2 weeks and no issues there either.&lt;/p&gt;</comment>
                            <comment id="12925846" author="phunt" created="Thu, 28 Oct 2010 16:53:57 +0100"  >&lt;p&gt;perhaps we should rely on existing testing for this one, but enter a new jira to refactor the client, specifically to allow testing? (ie a way to inject the helper code w/o needing to edit zookeeper.c directly)&lt;/p&gt;</comment>
                            <comment id="12925858" author="mahadev" created="Thu, 28 Oct 2010 17:18:00 +0100"  >&lt;p&gt;jared, pat,&lt;br/&gt;
 I am ok without a test case for this one, because its a quite hard to create one. I just wanted someone else to run the tests on there machines just to verify (since I rarely see any problems in c tests on my machine). I will go ahead and commit this patch for now.&lt;/p&gt;</comment>
                            <comment id="12925862" author="mahadev" created="Thu, 28 Oct 2010 17:25:53 +0100"  >&lt;p&gt;I just committed this. thanks jared!&lt;/p&gt;</comment>
                            <comment id="12926007" author="hudson" created="Fri, 29 Oct 2010 00:49:27 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #983 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/983/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/983/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-897&quot; title=&quot;C Client seg faults during close&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-897&quot;&gt;&lt;del&gt;ZOOKEEPER-897&lt;/del&gt;&lt;/a&gt;. C Client seg faults during close (jared cantwell via mahadev)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457181" name="ZOOKEEEPER-897.diff" size="404" author="jaredc" created="Thu, 14 Oct 2010 20:28:38 +0100"/>
                            <attachment id="12457477" name="ZOOKEEPER-897.patch" size="541" author="jaredc" created="Mon, 18 Oct 2010 21:44:02 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 25 Oct 2010 21:53:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxztuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32821</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>