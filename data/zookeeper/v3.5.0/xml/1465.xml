<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:46:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1465/ZOOKEEPER-1465.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1465] Cluster availability following new leader election takes a long time with large datasets - is correlated to dataset size</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1465</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;When re-electing a new leader of a cluster, it takes a long time for the cluster to become available if the dataset is large&lt;/p&gt;

&lt;p&gt;Test Data&lt;br/&gt;
----------&lt;br/&gt;
650mb snapshot size&lt;br/&gt;
20k nodes of varied size &lt;br/&gt;
3 member cluster &lt;/p&gt;

&lt;p&gt;On 3.4.x branch (&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/branches/branch-3.4?r=1244779&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/branches/branch-3.4?r=1244779&lt;/a&gt;)&lt;br/&gt;
------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Takes 3-4 minutes to bring up a cluster from cold &lt;br/&gt;
Takes 40-50 secs to recover from a leader failure &lt;br/&gt;
Takes 10 secs for a new follower to join the cluster &lt;/p&gt;

&lt;p&gt;Using the 3.3.5 release on the same hardware with the same dataset&lt;br/&gt;
-----------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Takes 10-20 secs to bring up a cluster from cold &lt;br/&gt;
Takes 10 secs to recover from a leader failure &lt;br/&gt;
Takes 10 secs for a new follower to join the cluster &lt;/p&gt;

&lt;p&gt;I can see from the logs in 3.4.x that once a new leader is elected, it pushes a new snapshot to each of the followers who need to save it before they ack the leader who can then mark the cluster as available. &lt;/p&gt;

&lt;p&gt;The kit being used is a low spec vm so the times taken are not relevant per se - more the fact that a snapshot is always sent even through there is no difference between the persisted state on each peer.&lt;br/&gt;
No data is being added to the cluster while the peers are being restarted.&lt;/p&gt;





</description>
                <environment></environment>
        <key id="12554690">ZOOKEEPER-1465</key>
            <summary>Cluster availability following new leader election takes a long time with large datasets - is correlated to dataset size</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fournc">Camille Fournier</assignee>
                                    <reporter username="alexgvozdenovic">Alex Gvozdenovic</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 May 2012 15:47:11 +0100</created>
                <updated>Wed, 18 Jul 2012 01:33:19 +0100</updated>
                            <resolved>Thu, 5 Jul 2012 17:50:09 +0100</resolved>
                                    <version>3.4.3</version>
                                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>leaderElection</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                <comments>
                            <comment id="13279846" author="fournc" created="Sun, 20 May 2012 20:05:39 +0100"  >&lt;p&gt;When there are no uncommitted proposals and no diff between leader and follower, leader will send a snap due to the fact that this logic:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; if (peerLastZxid == leaderLastZxid) {&lt;br/&gt;
                    LOG.debug(&quot;Leader and follower are in sync, sending empty diff. zxid=0x{}&quot;,&lt;br/&gt;
                            Long.toHexString(leaderLastZxid));&lt;br/&gt;
                    // We are in sync so we&apos;ll do an empty diff&lt;br/&gt;
                    packetToSend = Leader.DIFF;&lt;br/&gt;
                    zxidToSend = leaderLastZxid;&lt;br/&gt;
                }&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Will never return true. I&apos;m trying to figure out a test for this now.&lt;/p&gt;</comment>
                            <comment id="13279850" author="fournc" created="Sun, 20 May 2012 21:08:54 +0100"  >&lt;p&gt;One basic attempt. The Zab1_0 tests should be changed to reflect that we send DIFFs not SNAP. Might want additional tests though.&lt;/p&gt;</comment>
                            <comment id="13279857" author="hadoopqa" created="Sun, 20 May 2012 21:38:30 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12528348/ZOOKEEPER-1465.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12528348/ZOOKEEPER-1465.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1337029.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1082//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1082//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1082//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1082//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1082//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1082//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13281679" author="marshall" created="Wed, 23 May 2012 16:43:07 +0100"  >&lt;p&gt;How confident are we in the fix for this bug? I&apos;m patching our local zookeeper and we&apos;ve definitely observed this bug ourselves. Would like to incorporate it into our next patched version but would love some feedback on this fix...Thanks!&lt;/p&gt;</comment>
                            <comment id="13282134" author="fournc" created="Thu, 24 May 2012 03:21:32 +0100"  >&lt;p&gt;I think it&apos;s pretty decent, but it would be good if someone else double-checked my work. Ben or Flavio maybe, do either of you have time to check this out? &lt;br/&gt;
It&apos;d also be great if you tried running this in staging and see if it helps Marshall, and I would appreciate your eyes on the code if you want to take a look.&lt;/p&gt;</comment>
                            <comment id="13282142" author="fpj" created="Thu, 24 May 2012 03:44:58 +0100"  >&lt;p&gt;I&apos;ll have a look into it.&lt;/p&gt;</comment>
                            <comment id="13285336" author="thawan" created="Wed, 30 May 2012 03:03:18 +0100"  >&lt;p&gt;Even if there are committed proposal but learner is already in-sync, we still have bug due to this line&lt;br/&gt;
// skip the proposals the peer already has&lt;br/&gt;
if (propose.packet.getZxid() &amp;lt;= peerLastZxid) &lt;/p&gt;
{
  prevProposalZxid = propose.packet.getZxid();
  continue;
}

&lt;p&gt;If this is the last proposal, it will exit the loop and never setup the DIFF packet. So it will send out the entire snapshot. &lt;/p&gt;

&lt;p&gt;This patch seems to work in this case as well. &lt;/p&gt;</comment>
                            <comment id="13286764" author="fpj" created="Thu, 31 May 2012 18:37:20 +0100"  >&lt;p&gt;Here is a summary of my progress so far. The patch essentially proposes this change:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-                if (peerLastZxid == leaderLastZxid) {
+                if (peerLastZxid == leaderLastZxid || peerLastZxid == maxCommittedLog) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This tells me that the problem is that we need to set packetToSend to Leader.DIFF when &quot;peerLastZxid == maxCommittedLog&quot;, but &quot;peerLastZxid == leaderLastZxid&quot; does not hold and packetToSend is set to Leader.SNAP. If peerLastZxid &amp;lt;&amp;gt; leaderLastZxid, then the leader possibly has proposals that the learner doesn&apos;t, but I can&apos;t convince myself that it must be the case. If it does have proposals that the learner doesn&apos;t, then packetToSend should have been set to DIFF in the previous if/for block, no? &lt;/p&gt;

&lt;p&gt;I&apos;ll keep looking, but if anyone sees a flaw here or has extra information that might help, please let me know.   &lt;/p&gt;</comment>
                            <comment id="13287042" author="thawan" created="Fri, 1 Jun 2012 00:54:26 +0100"  >&lt;p&gt;Here is my current understanding of the problem. Essentially, the leader uses 3 lists to sync with follower: committedLog, toBeApplied and outstandingProposals.&lt;/p&gt;

&lt;p&gt;What I believe that the existing logic intend to do is that, if follower missed the committedLog (either committedLog is empty or peerLastZxid is not in range), then we send snapshot and follow by transactions in toBeApplied and outstandingProposals.&lt;/p&gt;

&lt;p&gt;However, the problem that we see here is that the follower doesn&#8217;t missed the committedLog, but the logic below fail to setup DIFF packet correctly because peerLastZxid == maxCommittedLog (last element in commitedLog).&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                        for (Proposal propose: proposals) {
                            // skip the proposals the peer already has
                            if (propose.packet.getZxid() &amp;lt;= peerLastZxid) {
                                prevProposalZxid = propose.packet.getZxid();
                                continue;
                            } else {
                                // If we are sending the first packet, figure out whether to trunc
                                // in case the follower has some proposals that the leader doesn&apos;t
                                if (firstPacket) {
                                    firstPacket = false;
                                    // Does the peer have some proposals that the leader hasn&apos;t seen yet
                                    if (prevProposalZxid &amp;lt; peerLastZxid) {
                                        // send a trunc message before sending the diff
                                        packetToSend = Leader.TRUNC;
                                        LOG.info(&quot;Sending TRUNC&quot;);
                                        zxidToSend = prevProposalZxid;
                                        updates = zxidToSend;
                                    }
                                    else {
                                        // Just send the diff
                                        packetToSend = Leader.DIFF;
                                        LOG.info(&quot;Sending diff&quot;);
                                        zxidToSend = maxCommittedLog;
                                    }

                                }
                                queuePacket(propose.packet);
                                QuorumPacket qcommit = new QuorumPacket(Leader.COMMIT, propose.packet.getZxid(),
                                        null, null);
                                queuePacket(qcommit);
                            }
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;I believe that if we fix the problem at the root cause, we can remove the code below completely since deciding whether to send DIFF packet is based on the fact that follower miss the committedLog or not. The startForwarding() method should handle inflight transactions correctly.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                if (peerLastZxid == leaderLastZxid) {
                    LOG.debug(&quot;Leader and follower are in sync, sending empty diff. zxid=0x{}&quot;,
                            Long.toHexString(leaderLastZxid));
                    // We are in sync so we&apos;ll do an empty diff
                    packetToSend = Leader.DIFF;
                    zxidToSend = leaderLastZxid;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The proposed fix minimizes code changes, but should we fix the problem at the root?&lt;/p&gt;</comment>
                            <comment id="13287226" author="fpj" created="Fri, 1 Jun 2012 08:51:06 +0100"  >&lt;p&gt;I was wondering the same thing, if that &quot;if&quot; block is needed in the case the decision logic for SNAP, DIFF, TRUNC is correct. Once we determine that &quot;(maxCommittedLog &amp;gt;= peerLastZxid) &amp;amp;&amp;amp; (minCommittedLog &amp;lt;= peerLastZxid)&quot; holds, then we know that it is either DIFF or TRUNC, so we should not leave that if block with packetToSend = Leader.SNAP. If we fix that, I believe that we will be fixing the issue of this jira. Does it sound right?&lt;/p&gt;

&lt;p&gt;I also trying to think if there is a case in which &quot;proposals.size() == 0&quot; and we end up sending a snapshot unnecessarily. &quot;proposals&quot; will be empty if the log is empty, but I think we could have the situation in which the leader and the follower have the same snapshot, but the transaction log of the leader has been pruned. Does it make sense? If it does, then we need to keep that last block. &lt;/p&gt;</comment>
                            <comment id="13287321" author="fpj" created="Fri, 1 Jun 2012 11:51:47 +0100"  >&lt;p&gt;More about &quot;proposals&quot; being empty. It sounds like it can happen if dt.lastProcessedZxid is the last logged transaction. In this case, &quot;listener.onTxnLoaded(hdr, itr.getTxn())&quot; won&apos;t be called in &quot;FileTxnSnapLog.restore()&quot; and &quot;ZKDatabase.addCommittedProposal()&quot; won&apos;t be invoked, leaving the committedLog empty upon a restore. Recall that &quot;proposals = leader.zk.getZKDatabase().getCommittedLog()&quot;.&lt;/p&gt;

&lt;p&gt;If this is right, then I&apos;m actually thinking that there might be a corner case to this change:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+                if (peerLastZxid == leaderLastZxid || peerLastZxid == maxCommittedLog) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Suppose that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;peerLastZxid == 0;&lt;/li&gt;
	&lt;li&gt;committed log is empty (maxCommittedLog==0);&lt;/li&gt;
	&lt;li&gt;leaderLastZxid &amp;gt; 0 and leader has a snapshot to send.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If this case can happen, then the leader would fail to send the snapshot. Do you see a problem with the scenario I&apos;m suggesting, Thawan, Camille?&lt;/p&gt;</comment>
                            <comment id="13287436" author="fournc" created="Fri, 1 Jun 2012 15:19:06 +0100"  >&lt;p&gt;Thawan, that&apos;s a good idea. It&apos;s not a bigger change to change the packetToSend=DIFF when we enter the if((maxCommittedLog &amp;gt;=peerLastZxid) &amp;amp;&amp;amp; (minCommittedLog &amp;lt;= peerLastZxid)) instead of putting the hack where I stuck it. Do you want to modify my patch and see if it still works?&lt;/p&gt;


&lt;p&gt;Flavio, I&apos;m not sure how we can have a snapshot to send when we don&apos;t have a committedLog. Can you clarify? Either the requests are committed, or they should be in the toBeApplied list on the Leader and so the peer will get them when startForwarding is called with the peer&apos;s last zxid.&lt;/p&gt;</comment>
                            <comment id="13287515" author="fpj" created="Fri, 1 Jun 2012 17:23:48 +0100"  >&lt;p&gt;I must say that I haven&apos;t been able to convince myself completely that it can happen, but this is how I see it at the moment. The leader restores its database from a snapshot and the last transaction in the log is the same as the last processed, so committedLog is empty. If there are operations in flight when the learner handler code we are talking about is executed, then the ones in toBeApplied will be sent, but the learner might still need the snapshot. &lt;/p&gt;</comment>
                            <comment id="13287657" author="thawan" created="Fri, 1 Jun 2012 21:54:41 +0100"  >&lt;p&gt;My version of the patch&lt;/p&gt;</comment>
                            <comment id="13287666" author="thawan" created="Fri, 1 Jun 2012 22:10:29 +0100"  >&lt;p&gt;This introduces a lot more changes. I found that there are 2 conditions that we will incorrectly send a snap even though it is not necessary&lt;/p&gt;

&lt;p&gt;1. lastPeerZxid == maxCommittedLog&lt;br/&gt;
2. committedLog is empty but both leader and follower db is already sync. This can happen when the leader restart after it just take a snapshot. Easy case to produce this is to restart the quorum 2 times in row.&lt;/p&gt;

&lt;p&gt;I am also working a patch &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1413&quot; title=&quot;Use on-disk transaction log for learner sync up&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1413&quot;&gt;&lt;del&gt;ZOOKEEPER-1413&lt;/del&gt;&lt;/a&gt; that will allow the leader to look back into on-disk txnlog, so that the need for doing snapshot transfer is further reduced.  &lt;/p&gt;</comment>
                            <comment id="13287679" author="hadoopqa" created="Fri, 1 Jun 2012 22:27:41 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12530600/ZOOKEEPER-1465.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12530600/ZOOKEEPER-1465.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1337029.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1085//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1085//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1085//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1085//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1085//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1085//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13287689" author="fpj" created="Fri, 1 Jun 2012 22:34:29 +0100"  >&lt;p&gt;Thanks, it looks good in general, Thawan. One question, if you remove this &quot;if (peerLastZxid == leaderLastZxid)&quot; block, then are we going to be sending a snapshot in the case that committedLog is empty (proposals is empty) and peerLastZxid == leaderLastZxid? leaderLastZxid is not necessarily equal to leader.zk.getZKDatabase().getDataTreeLastProcessedZxid().&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2. committedLog is empty but both leader and follower db is already sync. This can happen when the leader restart after it just take a snapshot. Easy case to produce this is to restart the quorum 2 times in row.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This case is essentially the same I was pointing out above. if it is simple to reproduce, it might be a good idea to have a test.&lt;/p&gt;</comment>
                            <comment id="13287690" author="fpj" created="Fri, 1 Jun 2012 22:35:08 +0100"  >&lt;p&gt;Cancelling until we sort out comments.&lt;/p&gt;</comment>
                            <comment id="13287729" author="thawan" created="Fri, 1 Jun 2012 23:15:05 +0100"  >&lt;p&gt;This is my current understanding:&lt;br/&gt;
leaderLastZxid is essentially lastProposed on the leader. (peerLastZxid == leaderLastZxid) will be true only if there is no in-flight txn on the leader when follower is syncing. &lt;/p&gt;

&lt;p&gt;As I explained earlier, the decision to decided whether to send a DIFF is based solely if follower miss the committedLog or not. Other case is just a special case that should be covered if we got that logic right. Please correct me if this assumption is not true.&lt;/p&gt;

&lt;p&gt;On the other hand, when committedLog is empty there is nothing we can do except the special case that I added in (2)&lt;/p&gt;

</comment>
                            <comment id="13287872" author="fpj" created="Sat, 2 Jun 2012 08:47:11 +0100"  >&lt;p&gt;I agree with this case, but I&apos;m asking about this one:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;committedLog is empty&lt;/li&gt;
	&lt;li&gt;leaderLastZxid &amp;gt; leader.zk.getZKDatabase().getDataTreeLastProcessedZxid()&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;leaderLastZxid is lastProposed as you say, but it can be greater than leader.zk.getZKDatabase().getDataTreeLastProcessedZxid(), right?&lt;/p&gt;</comment>
                            <comment id="13287873" author="fpj" created="Sat, 2 Jun 2012 09:21:28 +0100"  >&lt;p&gt;About my previous comment, even though leaderLastZxid can be greater than leader.zk.getZKDatabase().getDataTreeLastProcessedZxid(), in the case that leaderLastZxid == peerLastZxid, it must be the case that leaderLastZxid == leader.zk.getZKDatabase().getDataTreeLastProcessedZxid().&lt;/p&gt;

&lt;p&gt;I believe we have this invariant that it can&apos;t be that &quot;leaderLastZxid &amp;gt;= peerLastZxid &amp;gt; leader.zk.getZKDatabase().getDataTreeLastProcessedZxid()&quot;. The case that &quot;leaderLastZxid &amp;gt;= peerLastZxid == leader.zk.getZKDatabase().getDataTreeLastProcessedZxid()&quot; is allowed, though, but already covered in your patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;As I explained earlier, the decision to decided whether to send a DIFF is based solely if follower miss the committedLog or not. Other case is just a special case that should be covered if we got that logic right. Please correct me if this assumption is not true.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The assumption is correct.&lt;/p&gt;

&lt;p&gt;About a test for your second case, do you think you can work on one? I can try to think of one as well.&lt;/p&gt;</comment>
                            <comment id="13288683" author="thawan" created="Mon, 4 Jun 2012 18:05:51 +0100"  >&lt;p&gt;Please feel free to add a test if you have time to work on it&lt;/p&gt;</comment>
                            <comment id="13295605" author="fpj" created="Fri, 15 Jun 2012 12:49:27 +0100"  >&lt;p&gt;New patch adds a new test case as dicussed.&lt;/p&gt;</comment>
                            <comment id="13295606" author="fpj" created="Fri, 15 Jun 2012 12:51:51 +0100"  >&lt;p&gt;I&apos;ve added a test case to reproduce the case of commitedLog being empty and follower and leader being in sync. Please have a look and let me know if it works for you.&lt;/p&gt;</comment>
                            <comment id="13295638" author="hadoopqa" created="Fri, 15 Jun 2012 13:58:35 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12532186/ZOOKEEPER-1465.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12532186/ZOOKEEPER-1465.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1337029.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1096//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1096//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1096//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1096//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1096//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1096//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13295652" author="fpj" created="Fri, 15 Jun 2012 14:31:58 +0100"  >&lt;p&gt;Improvements over the previous patch. The essence is still the same, though. I have simply generalized the method to populate the database.&lt;/p&gt;</comment>
                            <comment id="13295654" author="fpj" created="Fri, 15 Jun 2012 14:32:48 +0100"  >&lt;p&gt;Rerun Jenkins...&lt;/p&gt;</comment>
                            <comment id="13295675" author="hadoopqa" created="Fri, 15 Jun 2012 15:08:40 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12532193/ZOOKEEPER-1465.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12532193/ZOOKEEPER-1465.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1337029.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1097//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1097//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1097//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1097//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1097//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1097//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13404100" author="phunt" created="Fri, 29 Jun 2012 19:33:08 +0100"  >&lt;p&gt;Where are we with this? Consensus is that it&apos;s ready or should we push it out to 3.4.5 to allow it to bake more? Anyone has tested this to any extent outside of the unit tests?&lt;/p&gt;</comment>
                            <comment id="13404105" author="fpj" created="Fri, 29 Jun 2012 19:38:48 +0100"  >&lt;p&gt;I&apos;m not aware of anyone trying this in a real setting, but the issue is legitimate and we have verified both through reasoning and tests. It is +1 for me.&lt;/p&gt;</comment>
                            <comment id="13404202" author="thawan" created="Fri, 29 Jun 2012 21:48:33 +0100"  >&lt;p&gt;lastProcessedZxid==peerZxid is quite a common issue that we see in our production. We are planning to deploy a variant of this patch in our production soon.&lt;/p&gt;</comment>
                            <comment id="13404267" author="fpj" created="Fri, 29 Jun 2012 23:07:54 +0100"  >&lt;p&gt;Thawan, Out of curiosity, why a variant and not this patch?&lt;/p&gt;</comment>
                            <comment id="13404282" author="thawan" created="Fri, 29 Jun 2012 23:27:01 +0100"  >&lt;p&gt;Our internal version also use on-disk txnlog together with committedLog to sync with follower. So the logic for learner handler is our version is a bit different. &lt;/p&gt;</comment>
                            <comment id="13405947" author="fournc" created="Tue, 3 Jul 2012 19:04:31 +0100"  >&lt;p&gt;Now that I can finally get onto jira I&apos;m going to run this in a small testing env I have here to make sure it looks good.&lt;/p&gt;</comment>
                            <comment id="13406051" author="fournc" created="Tue, 3 Jul 2012 22:10:07 +0100"  >&lt;p&gt;So I&apos;m seeing a log message that one of the followers is snapshotting twice in rapid succession, and I&apos;m worried that it&apos;s caused by this patch. Tracking it down now.&lt;/p&gt;</comment>
                            <comment id="13406059" author="fournc" created="Tue, 3 Jul 2012 22:21:33 +0100"  >&lt;p&gt;OK this appears to be an unrelated minor bug in the new Zab1.0 logic. Other than that, my testing looks good for this patch.&lt;/p&gt;</comment>
                            <comment id="13406069" author="phunt" created="Tue, 3 Jul 2012 22:33:54 +0100"  >&lt;p&gt;Camille you tried this with trunk or branch3.4? Could you verify it against branch3.4 as well? Thanks!&lt;/p&gt;</comment>
                            <comment id="13406081" author="fournc" created="Tue, 3 Jul 2012 22:44:02 +0100"  >&lt;p&gt;Actually just tried it with 3.4, didn&apos;t try trunk at all.&lt;/p&gt;</comment>
                            <comment id="13407225" author="fournc" created="Thu, 5 Jul 2012 16:56:17 +0100"  >&lt;p&gt;OK I tried this with both trunk and 3.4 and it&apos;s looking pretty good to me. I am going to check this in today.&lt;/p&gt;</comment>
                            <comment id="13407256" author="hudson" created="Thu, 5 Jul 2012 17:38:59 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1604 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1604/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1604/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1465&quot; title=&quot;Cluster availability following new leader election takes a long time with large datasets - is correlated to dataset size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1465&quot;&gt;&lt;del&gt;ZOOKEEPER-1465&lt;/del&gt;&lt;/a&gt;. Cluster availability following new leader election &lt;br/&gt;
    takes a long time with large datasets - is correlated to dataset size&lt;br/&gt;
    (fpj and Thawan Kooburat via camille) (Revision 1357711)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
camille : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1357711&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1357711&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13407264" author="fournc" created="Thu, 5 Jul 2012 17:49:56 +0100"  >&lt;p&gt;Checked in to trunk and 3.4.&lt;/p&gt;</comment>
                            <comment id="13416766" author="fournc" created="Wed, 18 Jul 2012 01:33:19 +0100"  >&lt;p&gt;patch from the 3.4 branch&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12532193" name="ZOOKEEPER-1465.patch" size="13399" author="fpj" created="Fri, 15 Jun 2012 14:31:58 +0100"/>
                            <attachment id="12532186" name="ZOOKEEPER-1465.patch" size="12892" author="fpj" created="Fri, 15 Jun 2012 12:49:27 +0100"/>
                            <attachment id="12530600" name="ZOOKEEPER-1465.patch" size="6590" author="thawan" created="Fri, 1 Jun 2012 21:54:41 +0100"/>
                            <attachment id="12528348" name="ZOOKEEPER-1465.patch" size="2244" author="fournc" created="Sun, 20 May 2012 21:08:54 +0100"/>
                            <attachment id="12536929" name="ZOOKEEPER-1465_br34.patch" size="13941" author="fournc" created="Wed, 18 Jul 2012 01:33:19 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 20 May 2012 19:05:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>238940</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwcfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12502</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>