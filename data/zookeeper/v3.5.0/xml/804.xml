<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:45:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-804/ZOOKEEPER-804.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-804] c unit tests failing due to &quot;assertion cptr failed&quot;</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-804</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;I&apos;m seeing this frequently:&lt;/p&gt;

&lt;p&gt;     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; Zookeeper_simpleSystem::testPing : elapsed 18006 : OK&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; Zookeeper_simpleSystem::testAcl : elapsed 1022 : OK&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; Zookeeper_simpleSystem::testChroot : elapsed 3145 : OK&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; Zookeeper_simpleSystem::testAuth ZooKeeper server started : elapsed 25687 : OK&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; zktest-mt: /home/phunt/dev/workspace/gitzk/src/c/src/zookeeper.c:1952: zookeeper_process: Assertion `cptr&apos; failed.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; make: *** &lt;span class=&quot;error&quot;&gt;&amp;#91;run-check&amp;#93;&lt;/span&gt; Aborted&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; Zookeeper_simpleSystem::testHangingClient&lt;/p&gt;

&lt;p&gt;Mahadev can you take a look?&lt;/p&gt;</description>
                <environment>&lt;p&gt;gcc 4.4.3, ubuntu lucid lynx, dual core laptop (intel)&lt;/p&gt;</environment>
        <key id="12468586">ZOOKEEPER-804</key>
            <summary>c unit tests failing due to &quot;assertion cptr failed&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="michim">Michi Mutsuzaki</assignee>
                                    <reporter username="phunt">Patrick Hunt</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Jul 2010 21:35:49 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:40 +0000</updated>
                            <resolved>Wed, 20 Oct 2010 17:27:44 +0100</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12885716" author="mahadev" created="Tue, 6 Jul 2010 23:25:31 +0100"  >&lt;p&gt;this is the same issue as &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-707&quot; title=&quot;c client close can crash with cptr null&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-707&quot;&gt;ZOOKEEPER-707&lt;/a&gt;. It should be very hard to reproduce. THis is surely a bug. I will upload a patch soon and we can get this in 3.3.2.&lt;/p&gt;</comment>
                            <comment id="12885722" author="phunt" created="Tue, 6 Jul 2010 23:47:55 +0100"  >&lt;p&gt;I ran the c tests 3 times and it failed with the same error each time. Let me know if I can help you verify the fix.&lt;/p&gt;</comment>
                            <comment id="12885725" author="mahadev" created="Tue, 6 Jul 2010 23:56:42 +0100"  >&lt;p&gt;great... I cant reproduce it on my machine. I rarely see this error.&lt;/p&gt;</comment>
                            <comment id="12903260" author="michim" created="Fri, 27 Aug 2010 07:38:04 +0100"  >&lt;p&gt;I haven&apos;t been able to reproduce it, but it looks like we shouldn&apos;t assert(cptr) if zookeeper_close has been called (zookeeper.c line 1950). Can we do something like:&lt;/p&gt;

&lt;p&gt;completion_list_t *cptr = dequeue_completion(&amp;amp;zh-&amp;gt;sent_requests);&lt;br/&gt;
if (zh-&amp;gt;close_requested == 1) {&lt;br/&gt;
    // zookeeper_close has been called. No need to assert cptr. Just free it if it&apos;s not NULL&lt;br/&gt;
    if (cptr) &lt;/p&gt;
{
        destroy_completion_entry(cptr);
    }
&lt;p&gt;   // some more cleanup?&lt;br/&gt;
   return ZINVALIDSTATE;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;// zookeeper_close hadn&apos;t been called when we called dequeue_completion. cptr must not be NULL. &lt;br/&gt;
assert(cptr);&lt;/p&gt;

&lt;p&gt;--Michi&lt;/p&gt;</comment>
                            <comment id="12908985" author="michim" created="Mon, 13 Sep 2010 21:35:12 +0100"  >&lt;p&gt;This patch modifies zookeeper_process() function. After dequeue_completion() is called, it checks if zookeeper_close has been called. If it has been called, it returns ZINVALIDSTATE.&lt;/p&gt;

&lt;p&gt;--Michi&lt;/p&gt;</comment>
                            <comment id="12918112" author="mahadev" created="Tue, 5 Oct 2010 19:39:38 +0100"  >&lt;p&gt;+1 for the patch. Pat can you please try it out and see it fixes the test cases? I will go ahead and commit if it passes for you.&lt;/p&gt;</comment>
                            <comment id="12918216" author="phunt" created="Tue, 5 Oct 2010 22:33:42 +0100"  >&lt;p&gt;+1 &amp;#8211; I ran this a number of times (~10) and it passed each time. Ship it.&lt;/p&gt;</comment>
                            <comment id="12918293" author="mahadev" created="Tue, 5 Oct 2010 23:48:04 +0100"  >&lt;p&gt;I just committed this. thanks michi!&lt;/p&gt;</comment>
                            <comment id="12918466" author="hudson" created="Wed, 6 Oct 2010 11:51:37 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #958 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/958/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/958/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-804&quot; title=&quot;c unit tests failing due to &amp;quot;assertion cptr failed&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-804&quot;&gt;&lt;del&gt;ZOOKEEPER-804&lt;/del&gt;&lt;/a&gt;. c unit tests failing due to &quot;assertion cptr failed&quot; (michi mutsuzaki via mahadev)&lt;/p&gt;</comment>
                            <comment id="12920307" author="jaredc" created="Tue, 12 Oct 2010 20:03:25 +0100"  >&lt;p&gt;Should the return statement of this patch be:&lt;/p&gt;

&lt;p&gt;return api_epilog(zh,ZINVALIDSTATE);&lt;/p&gt;

&lt;p&gt;Otherwise, it seems possible that the reference counting could get off in this case.&lt;/p&gt;</comment>
                            <comment id="12920644" author="phunt" created="Wed, 13 Oct 2010 17:35:50 +0100"  >&lt;p&gt;Reopening due to issue raised with the patch (see earlier comment).&lt;/p&gt;

&lt;p&gt;Is this an issue that should be addressed or ok to resolve?&lt;/p&gt;</comment>
                            <comment id="12920689" author="jaredc" created="Wed, 13 Oct 2010 18:55:00 +0100"  >&lt;p&gt;It seems like zookeeper_process unnecessarily calls api_prolog() and api_epilog() to begin with.  But given that api_prolog() is called at the beginning, if this new code path executes while a close is requested, then the threads will successfully exit, but the final part of zookeeper_close that releases the memory on the last reference will not execute (since the last reference will never be reached).  Unless I&apos;m missing something, this will leak the zkhandle.&lt;/p&gt;</comment>
                            <comment id="12921500" author="jaredc" created="Fri, 15 Oct 2010 20:03:42 +0100"  >&lt;p&gt;Not sure what the protocol is here, but I&apos;m gonna go ahead and attach a revised patch.&lt;/p&gt;</comment>
                            <comment id="12921558" author="michim" created="Fri, 15 Oct 2010 22:22:56 +0100"  >&lt;p&gt;Jared, thank you for volunteering to fix this. I haven&apos;t had a chance to take care of it.&lt;/p&gt;

&lt;p&gt;--Michi&lt;/p&gt;</comment>
                            <comment id="12921573" author="phunt" created="Fri, 15 Oct 2010 23:18:07 +0100"  >&lt;p&gt;Thanks Jared, I missed your question on IRC (you had quit before I got back). What you&apos;ve submitted is fine, in general though you should  just submit a patch against the current svn (so a diff against code which already had the original patch committed to it).&lt;/p&gt;

&lt;p&gt;Michi, can you (also ben/mahadev) review this and let me know if it&apos;s ok to commit, I&apos;ll commit it if you guys sign off. Thanks all!&lt;/p&gt;</comment>
                            <comment id="12921583" author="michim" created="Fri, 15 Oct 2010 23:54:22 +0100"  >&lt;p&gt;The patch looks good, but I can&apos;t seem to apply it. Has anybody seen this error?&lt;/p&gt;

&lt;p&gt;$ cd branch-3.3&lt;br/&gt;
$ patch -p0 &amp;lt;  &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-804&quot; title=&quot;c unit tests failing due to &amp;quot;assertion cptr failed&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-804&quot;&gt;&lt;del&gt;ZOOKEEPER-804&lt;/del&gt;&lt;/a&gt;.patch &lt;br/&gt;
patching file src/c/src/zookeeper.c&lt;br/&gt;
Hunk #1 FAILED at 1947.&lt;br/&gt;
1 out of 1 hunk FAILED &amp;#8211; saving rejects to file src/c/src/zookeeper.c.rej&lt;/p&gt;

&lt;p&gt;--Michi&lt;/p&gt;</comment>
                            <comment id="12921690" author="jaredc" created="Sat, 16 Oct 2010 14:44:18 +0100"  >&lt;p&gt;That probably failed because the first patch is already applied, so this patch doesn&apos;t exactly apply to your trunk.  I can open a new bug and submit a patch that way if its preferred.&lt;/p&gt;</comment>
                            <comment id="12921923" author="michim" created="Mon, 18 Oct 2010 00:24:34 +0100"  >&lt;p&gt;+1.&lt;/p&gt;

&lt;p&gt;&amp;gt; I can open a new bug and submit a patch that way if its preferred. &lt;/p&gt;

&lt;p&gt;No worry, it&apos;s not a big deal since this is a one line change. &lt;/p&gt;

&lt;p&gt;Thanks again, Jared!&lt;br/&gt;
--Michi&lt;/p&gt;</comment>
                            <comment id="12923029" author="phunt" created="Wed, 20 Oct 2010 17:02:36 +0100"  >&lt;p&gt;Updated patch to apply against latest trunk (hopefully branch too).&lt;/p&gt;</comment>
                            <comment id="12923039" author="phunt" created="Wed, 20 Oct 2010 17:27:44 +0100"  >&lt;p&gt;+1 on the second patch. Tested and it seems fine, committed to trunk/branch33 both.&lt;/p&gt;</comment>
                            <comment id="12923116" author="hudson" created="Wed, 20 Oct 2010 20:26:10 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #973 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/973/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/973/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-804&quot; title=&quot;c unit tests failing due to &amp;quot;assertion cptr failed&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-804&quot;&gt;&lt;del&gt;ZOOKEEPER-804&lt;/del&gt;&lt;/a&gt;. c unit tests failing due to &quot;assertion cptr failed&quot; (second patch)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12459462">ZOOKEEPER-707</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12457674" name="ZOOKEEPER-804-1.patch" size="513" author="phunt" created="Wed, 20 Oct 2010 17:02:36 +0100"/>
                            <attachment id="12457282" name="ZOOKEEPER-804-1.patch" size="848" author="jaredc" created="Fri, 15 Oct 2010 20:03:42 +0100"/>
                            <attachment id="12454482" name="ZOOKEEPER-804.patch" size="833" author="michim" created="Mon, 13 Sep 2010 21:35:12 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 Jul 2010 22:25:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzu3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32860</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>