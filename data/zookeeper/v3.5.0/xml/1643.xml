<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:41:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1643/ZOOKEEPER-1643.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1643] Windows: fetch_and_add not 64bit-compatible, may not be correct</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1643</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Note: While I am using a really old version of ZK, I did do enough &quot;SVN Blame&quot; operations to realize that this code hasn&apos;t changed.&lt;/p&gt;

&lt;p&gt;I am currently attempting to compile the C client under MSVC 2005 arch=x64.  There are three things I can see with fetch_and_add() inside of /src/c/src/mt_adapter.c&lt;/p&gt;

&lt;p&gt;(1) MSVC 2005 64bit will not compile inline _asm sections.  I&apos;m moderately sure this code is x86-specific so I&apos;m unsure whether it should attempt to either.&lt;/p&gt;

&lt;p&gt;(2) The Windows intrinsic InterlockedExchangeAdd &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/windows/desktop/ms683597(v=vs.85).aspx&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://msdn.microsoft.com/en-us/library/windows/desktop/ms683597(v=vs.85).aspx&lt;/a&gt; appears to do the same thing this code is attempting to do&lt;/p&gt;

&lt;p&gt;(3) I&apos;m really rusty on my assembly, but why are we doing two separate XADD operations here, and is the code as-written anything approaching atomicity?&lt;/p&gt;

&lt;p&gt;If you want an official patch I likely can do an SVN checkout and submit a patch the replaces the entire #else on lines 495-505 with a &quot;return InterlockedExchangeAdd(operand, incr);&quot;&lt;/p&gt;

&lt;p&gt;Usually when I&apos;m scratching my head this badly there&apos;s something I&apos;m missing though.  As far as I can tell there has been no prior discussion on this code.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 7&lt;br/&gt;
Microsoft Visual Studio 2005&lt;/p&gt;</environment>
        <key id="12631546">ZOOKEEPER-1643</key>
            <summary>Windows: fetch_and_add not 64bit-compatible, may not be correct</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="odysseus654">Erik Anderson</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Feb 2013 01:44:26 +0000</created>
                <updated>Wed, 20 Feb 2013 11:02:13 +0000</updated>
                            <resolved>Wed, 20 Feb 2013 05:26:47 +0000</resolved>
                                    <version>3.3.3</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13575593" author="breed" created="Mon, 11 Feb 2013 01:45:42 +0000"  >&lt;p&gt;i think it would be great to use intrinsics here! michi is the one that wrote that code. the first lock addl with an operand of 0 is interesting. i&apos;m not sure why that is needed. do you know michi? it is not incorrect though. the lock makes the operation atomic.&lt;/p&gt;</comment>
                            <comment id="13575594" author="breed" created="Mon, 11 Feb 2013 01:46:31 +0000"  >&lt;p&gt;we should also use __sync_fetch_and_add in the non windows case &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13575599" author="odysseus654" created="Mon, 11 Feb 2013 02:36:28 +0000"  >&lt;p&gt;Do the two LOCKs combine together to make the whole thing atomic overall?&lt;/p&gt;

&lt;p&gt;If they don&apos;t, I guess the worst case scenario is that two callers would get the same return value while the value would still be incremented by two.&lt;/p&gt;</comment>
                            <comment id="13575628" author="breed" created="Mon, 11 Feb 2013 06:03:14 +0000"  >&lt;p&gt;i really think you only need the one. (that is the case for non-windows.) you&apos;ll notice that the first xadd is adding 0, so there is no double add.&lt;/p&gt;</comment>
                            <comment id="13575629" author="odysseus654" created="Mon, 11 Feb 2013 06:12:26 +0000"  >&lt;p&gt;Yah, I did notice that. The first xadd appears to be used to retrieve the end-return value, where the second is actually doing the work (unless I really read the asm wrong, I don&apos;t have it in front of me right now).&lt;/p&gt;

&lt;p&gt;I&apos;m seeing a potential non-atomic operation with the current formulation and two simultaneous callers, where both callers trade off on the &quot;LOCK XADD 0&quot; pulling the same return result, then both trade off on the &quot;LOCK XADD n&quot;.  The two operations are still individually atomic and the variable still gets bumped by the proper amount, but the return value for one of the callers would be wrong.&lt;/p&gt;

&lt;p&gt;In any case, it would be good to get something a little less processor-specific here.  I&apos;m actually surprised that no one has tried to compile this on a non-intel linux machine yet...&lt;/p&gt;</comment>
                            <comment id="13575632" author="breed" created="Mon, 11 Feb 2013 06:27:33 +0000"  >&lt;p&gt;ah you are correct. the comment // result = ebx is correct, but i think the actual code mov result, ecx is incorrect as you point out. the fix/simplification is to use the intrinsic. we should probably also use __sync_fetch_and_add in the non windows case.&lt;/p&gt;</comment>
                            <comment id="13576008" author="michim" created="Mon, 11 Feb 2013 19:21:52 +0000"  >&lt;p&gt;I didn&apos;t write the code, but I agree with Erik and Ben.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;For windows, we should use InterlockedExchangeAdd.&lt;/li&gt;
	&lt;li&gt;For non-windows, we should use  __sync_fetch_and_ad&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Erik, would you be interested in providing a patch?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
--Michi&lt;/p&gt;</comment>
                            <comment id="13577682" author="odysseus654" created="Wed, 13 Feb 2013 16:25:34 +0000"  >&lt;p&gt;Just an FYI, still here but a bit busy.  I hope to have a patch by the end of the week.&lt;/p&gt;</comment>
                            <comment id="13581787" author="odysseus654" created="Wed, 20 Feb 2013 00:07:38 +0000"  >&lt;p&gt;first version proposed patch&lt;/p&gt;</comment>
                            <comment id="13581959" author="michim" created="Wed, 20 Feb 2013 05:23:21 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Thanks for the patch, Erik. The code looks much nicer now.&lt;/p&gt;</comment>
                            <comment id="13581965" author="michim" created="Wed, 20 Feb 2013 05:26:47 +0000"  >&lt;p&gt;Merged to trunk.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1448007&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1448007&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13582097" author="hudson" created="Wed, 20 Feb 2013 11:02:13 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1840 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1840/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1840/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1643&quot; title=&quot;Windows: fetch_and_add not 64bit-compatible, may not be correct&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1643&quot;&gt;&lt;del&gt;ZOOKEEPER-1643&lt;/del&gt;&lt;/a&gt;. Windows: fetch_and_add not 64bit-compatible, may not be correct (Erik Anderson via michim) (Revision 1448007)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
michim : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1448007&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1448007&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/c/src/mt_adaptor.c&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12570030" name="mt_adaptor.c.patch" size="919" author="odysseus654" created="Wed, 20 Feb 2013 00:07:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 11 Feb 2013 01:45:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312042</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzbp87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312388</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>