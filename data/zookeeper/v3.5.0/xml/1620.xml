<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:41:51 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1620/ZOOKEEPER-1620.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1620] NIOServerCnxnFactory (new code introduced in ZK-1504) opens selectors but never closes them</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1620</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;New code (committed in ZK-1504) opens selectors but doesn&apos;t close them.&lt;br/&gt;
Specifically AbstractSelectThread in its constructor does &lt;/p&gt;

&lt;p&gt;this.selector = Selector.open();&lt;/p&gt;

&lt;p&gt;But possibly also elsewhere. Tests fail for me with the following message:&lt;/p&gt;

&lt;p&gt;java.io.IOException: Too many open files&lt;br/&gt;
	at sun.nio.ch.EPollArrayWrapper.epollCreate(Native Method)&lt;br/&gt;
	at sun.nio.ch.EPollArrayWrapper.&amp;lt;init&amp;gt;(EPollArrayWrapper.java:69)&lt;br/&gt;
	at sun.nio.ch.EPollSelectorImpl.&amp;lt;init&amp;gt;(EPollSelectorImpl.java:52)&lt;br/&gt;
	at sun.nio.ch.EPollSelectorProvider.openSelector(EPollSelectorProvider.java:18)&lt;br/&gt;
	at java.nio.channels.Selector.open(Selector.java:209)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxnFactory$AbstractSelectThread.&amp;lt;init&amp;gt;(NIOServerCnxnFactory.java:128)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxnFactory$AcceptThread.&amp;lt;init&amp;gt;(NIOServerCnxnFactory.java:177)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxnFactory.configure(NIOServerCnxnFactory.java:663)&lt;br/&gt;
	at org.apache.zookeeper.server.ServerCnxnFactory.createFactory(ServerCnxnFactory.java:127)&lt;br/&gt;
	at org.apache.zookeeper.server.quorum.QuorumPeer.&amp;lt;init&amp;gt;(QuorumPeer.java:709)&lt;br/&gt;
	at org.apache.zookeeper.test.QuorumBase.startServers(QuorumBase.java:177)&lt;br/&gt;
	at org.apache.zookeeper.test.QuorumBase.setUp(QuorumBase.java:113)&lt;br/&gt;
	at org.apache.zookeeper.test.QuorumBase.setUp(QuorumBase.java:71)&lt;br/&gt;
	at org.apache.zookeeper.test.ReconfigTest.setUp(ReconfigTest.java:56)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12627591">ZOOKEEPER-1620</key>
            <summary>NIOServerCnxnFactory (new code introduced in ZK-1504) opens selectors but never closes them</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thawan">Thawan Kooburat</assignee>
                                    <reporter username="shralex">Alexander Shraer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Jan 2013 04:18:52 +0000</created>
                <updated>Thu, 2 May 2013 03:30:00 +0100</updated>
                            <resolved>Fri, 25 Jan 2013 06:47:12 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13555763" author="shrauner" created="Thu, 17 Jan 2013 02:28:58 +0000"  >&lt;p&gt;Have you tried running the tests in an unmodified branch? I think you are encountering this because of changes in your branch, because in the upstream branch we don&apos;t see the tests fail like this.&lt;/p&gt;

&lt;p&gt;That being said, you are right we could do a better job of cleaning up the selector. I&apos;d suggest adding a closeSelector() method to the AbstractSelectThread&lt;/p&gt;

&lt;p&gt;protected void closeSelector() {&lt;br/&gt;
  try {&lt;br/&gt;
    selector.close();&lt;br/&gt;
  catch (IOException e) &lt;/p&gt;
{
    // Ignore
  }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;and then adding calls to closeSelector() right before the NIOServerCnxnFactory.this.stop() calls in the finally block of the run methods for the AcceptThread and SelectorThread.&lt;/p&gt;</comment>
                            <comment id="13555770" author="shralex" created="Thu, 17 Jan 2013 02:38:26 +0000"  >&lt;p&gt;Thanks Jay. The tests that fail are related to reconfiguration, but the issue I think is not specific to reconfiguration, that&apos;s why I opened it as a separate bug. Let me make the change you suggest in my ZK-107 patch first to see if it solves the issue, and then we can submit it as a separate patch here.&lt;/p&gt;</comment>
                            <comment id="13555800" author="thawan" created="Thu, 17 Jan 2013 03:22:22 +0000"  >&lt;p&gt;Fix fd leakage with unit test (for unix-based system)&lt;/p&gt;</comment>
                            <comment id="13555818" author="hadoopqa" created="Thu, 17 Jan 2013 03:57:35 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12565253/ZOOKEEPER-1620.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12565253/ZOOKEEPER-1620.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1433651.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    -1 release audit.  The applied patch generated 25 release audit warnings (more than the trunk&apos;s current 24 warnings).&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//testReport/&lt;/a&gt;&lt;br/&gt;
Release audit warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1339//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13555829" author="thawan" created="Thu, 17 Jan 2013 04:19:08 +0000"  >&lt;p&gt;Add missing license header&lt;/p&gt;</comment>
                            <comment id="13555851" author="hadoopqa" created="Thu, 17 Jan 2013 04:47:41 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12565259/ZOOKEEPER-1620.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12565259/ZOOKEEPER-1620.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1433651.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1340//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1340//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1340//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1340//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1340//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1340//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13556457" author="shralex" created="Thu, 17 Jan 2013 18:45:28 +0000"  >&lt;p&gt;looks good, thanks Thawan&lt;/p&gt;</comment>
                            <comment id="13557317" author="shralex" created="Fri, 18 Jan 2013 16:13:22 +0000"  >&lt;p&gt;on second thought, this still has a problem.&lt;br/&gt;
when running it on my Mac the test fails with &quot;End fdcount is: 340&quot;&lt;/p&gt;</comment>
                            <comment id="13557331" author="shralex" created="Fri, 18 Jan 2013 16:38:27 +0000"  >&lt;p&gt;Thawan, I suggest that you change the last assertion to &quot;(endFdCount - startFdCount) &amp;lt; 2)&quot;&lt;br/&gt;
and in NIOServerCnxnFactory.stop() add thread.closeSelector() right before or right after thread.wakeupSelector()&lt;/p&gt;</comment>
                            <comment id="13557334" author="shralex" created="Fri, 18 Jan 2013 16:43:32 +0000"  >&lt;p&gt;actually it would be good to reduce this to &amp;lt; 1, but I haven&apos;t found the remaining open selector.&lt;/p&gt;</comment>
                            <comment id="13557405" author="shrauner" created="Fri, 18 Jan 2013 17:58:13 +0000"  >&lt;p&gt;You shouldn&apos;t need to do that (explicitly call closeSelector inside factory.stop()), and it&apos;s preferable if you don&apos;t. The reason it&apos;s preferable not to do it is to allow the system to do a graceful shutdown. The reason you shouldn&apos;t need to do that is that the shutdown call joins on the accept and selector threads, so it&apos;s not going to return until those threads exit.&lt;/p&gt;

&lt;p&gt;The unit tests create and destroy the factories/threads/selectors in a pretty tight loop. I&apos;m not sure how long it takes the system to close fd&apos;s associated with the selector, but maybe this is something like how closed sockets can linger. I might try to put a lengthier sleep after the factory.shutdown() call.&lt;/p&gt;

&lt;p&gt;There have been known issues with file descriptor leaks when calling selector.close(), so we might check JDK versions we&apos;re each running. I found the following bug affecting JDK5u28/6u30/7u5&lt;br/&gt;
&lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7118373&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7118373&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13557435" author="thawan" created="Fri, 18 Jan 2013 18:23:14 +0000"  >&lt;p&gt;Thanks Jay, I was about to mention that bug as well. For our environment, we already switched to jdk7u6. I believe we ran into this JDK bug in our production, after upgrading to a newer JDK, the problem is gone.&lt;/p&gt;</comment>
                            <comment id="13557437" author="shralex" created="Fri, 18 Jan 2013 18:23:38 +0000"  >&lt;p&gt;Hi Jay,&lt;/p&gt;

&lt;p&gt;and yet with this change my test in ZK-107 now passes. Here&apos;s the failure that I was getting yesterday, even after calling closeSelector where you previously suggested:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1342//testReport/org.apache.zookeeper.test/ReconfigTest/testQuorumSystemChange/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1342//testReport/org.apache.zookeeper.test/ReconfigTest/testQuorumSystemChange/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;when I add the closeSelector inside factory.stop, this error goes away. &lt;/p&gt;

&lt;p&gt;I still got a failure because endFdCount - startFdCount is 1 on my Mac but 4 on Hudson. &lt;/p&gt;</comment>
                            <comment id="13557607" author="shralex" created="Fri, 18 Jan 2013 21:12:14 +0000"  >&lt;p&gt;sorry, its actually my mistake - I didn&apos;t notice the second closeSelector() in Thawan&apos;t patch, which has the same effect as what I was suggesting above. so no changes necessary to the patch.&lt;/p&gt;</comment>
                            <comment id="13562467" author="phunt" created="Fri, 25 Jan 2013 06:47:12 +0000"  >&lt;p&gt;Committed to trunk. Thanks Thawan.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12597666">ZOOKEEPER-1504</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12401266">ZOOKEEPER-107</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12565259" name="ZOOKEEPER-1620.patch" size="4517" author="thawan" created="Thu, 17 Jan 2013 04:19:08 +0000"/>
                            <attachment id="12565253" name="ZOOKEEPER-1620.patch" size="3691" author="thawan" created="Thu, 17 Jan 2013 03:22:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 17 Jan 2013 02:28:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>304375</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz1gpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>252551</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>