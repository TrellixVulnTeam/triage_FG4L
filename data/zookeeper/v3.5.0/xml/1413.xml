<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:49:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1413/ZOOKEEPER-1413.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1413] Use on-disk transaction log for learner sync up</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1413</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Motivation:&lt;br/&gt;
The learner syncs up with leader by retrieving committed log from the leader. Currently, the leader only keeps 500 entries of recently committed log in memory. If the learner falls behind more than 500 updates, the leader will send the entire snapshot to the learner. &lt;/p&gt;

&lt;p&gt;With the size of the snapshot for some of our Zookeeper deployments (~10G), it is prohibitively expensive to send the entire snapshot over network. Additionally, our Zookeeper may serve more than 4K updates per seconds. As a result, a network hiccups for less than a second will cause the learner to use snapshot transfer.&lt;/p&gt;

&lt;p&gt;Design:&lt;br/&gt;
Instead of looking only at committed log in memory, the leader will also look at transaction log on disk. The amount of transaction log kept on disk is configurable and the current default is 100k. This will allow Zookeeper to tolerate longer temporal network failure before initiating the snapshot transfer.  &lt;/p&gt;

&lt;p&gt;Implementation:&lt;br/&gt;
We plan to add interface to the persistence layer will can be use to retrieve proposals from on-disk transaction log. These proposals can then be used to send to the learner using existing protocol. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12546312">ZOOKEEPER-1413</key>
            <summary>Use on-disk transaction log for learner sync up</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thawan">Thawan Kooburat</assignee>
                                    <reporter username="thawan">Thawan Kooburat</reporter>
                        <labels>
                            <label>performance</label>
                            <label>quorum</label>
                    </labels>
                <created>Tue, 13 Mar 2012 21:42:20 +0000</created>
                <updated>Mon, 14 Oct 2013 16:55:30 +0100</updated>
                            <resolved>Mon, 1 Jul 2013 18:22:41 +0100</resolved>
                                    <version>3.4.3</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13234558" author="thawan" created="Wed, 21 Mar 2012 17:33:20 +0000"  >&lt;p&gt;The attached patch implements what described in the issue.&lt;/p&gt;

&lt;p&gt;However, we also add simple threshold to determine if it is better to send txnlog or entire snapshot. Currently, we only use txlong if on-disk size of the log is less than one third of the last snapshot.&lt;/p&gt;</comment>
                            <comment id="13234573" author="hadoopqa" created="Wed, 21 Mar 2012 17:41:45 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12519268/ZOOKEEPER-1413.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12519268/ZOOKEEPER-1413.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1302736.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1004//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1004//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13287665" author="thawan" created="Fri, 1 Jun 2012 22:09:44 +0100"  >&lt;p&gt;Found some bug with the current implementation, so I will submit a new one after fixing it.&lt;/p&gt;</comment>
                            <comment id="13650959" author="fpj" created="Tue, 7 May 2013 16:23:10 +0100"  >&lt;p&gt;This a nice feature, the patch here is currently stale and doesn&apos;t apply cleanly to trunk. One simple comment about the patch: please don&apos;t leave TODOs in the code, create jira issues instead.&lt;/p&gt;</comment>
                            <comment id="13661210" author="thawan" created="Sat, 18 May 2013 02:28:16 +0100"  >&lt;p&gt;Will post to review board when all tests passed&lt;/p&gt;</comment>
                            <comment id="13661218" author="hadoopqa" created="Sat, 18 May 2013 02:56:47 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12583715/ZOOKEEPER-1413.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12583715/ZOOKEEPER-1413.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1483440.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1483//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1483//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1483//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1483//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1483//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1483//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13661237" author="thawan" created="Sat, 18 May 2013 04:03:45 +0100"  >&lt;p&gt;Add missing unit test &lt;/p&gt;</comment>
                            <comment id="13661255" author="hadoopqa" created="Sat, 18 May 2013 04:42:29 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12583719/ZOOKEEPER-1413.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12583719/ZOOKEEPER-1413.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1483440.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 12 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1484//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1484//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1484//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1484//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1484//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1484//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13661789" author="thawan" created="Mon, 20 May 2013 06:40:23 +0100"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/11231/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/11231/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13662415" author="thawan" created="Mon, 20 May 2013 23:27:06 +0100"  >&lt;p&gt;Let me know if you need me to explain anything about this patch.  The high level design documented in this JIRA is still valid.  There is a lot of corner cases in synchronization logic, but there is a lot of comments in the code.  &lt;/p&gt;

&lt;p&gt;During the development of this patch, I continuously ran FollowerResyncConcurrencyTest for a few days. So the enhancement in that test is to get rid of false positive and aid debugging. &lt;/p&gt;

&lt;p&gt;The current code match what we have been using in our prod for more than half a year.&lt;/p&gt;</comment>
                            <comment id="13662438" author="fpj" created="Tue, 21 May 2013 00:04:52 +0100"  >&lt;p&gt;Hi Thawan, Thanks for the patch, I&apos;ll review it. I really like this feature.&lt;/p&gt;</comment>
                            <comment id="13662440" author="fpj" created="Tue, 21 May 2013 00:07:04 +0100"  >&lt;p&gt;Also, do you have by any chance numbers showing the difference it makes to the recovery time? If you happen to have, I&apos;d be interested in seeing them.&lt;/p&gt;</comment>
                            <comment id="13662605" author="thawan" created="Tue, 21 May 2013 03:42:03 +0100"  >&lt;p&gt;The main benefit of this patch is to reduce the chance that the leader need to send a snapshot to the learner. So it tries to fix various corner cases in synchronization logic as reported in JIRAs like &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1465&quot; title=&quot;Cluster availability following new leader election takes a long time with large datasets - is correlated to dataset size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1465&quot;&gt;&lt;del&gt;ZOOKEEPER-1465&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt; (I just found this one) &lt;/p&gt;

&lt;p&gt;The most common corner case that cause the leader to send a snapshot to learners is when the learner fall behind by more than 1 epoch. This is possible if the leader fail to form a quorum and move to a new epoch in a quick succession (let say you have situation like &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1697&quot; title=&quot;large snapshots can cause continuous quorum failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1697&quot;&gt;&lt;del&gt;ZOOKEEPER-1697&lt;/del&gt;&lt;/a&gt;).     &lt;/p&gt;

&lt;p&gt;For us, it is prohibitively expensive to send a snapshot because we have a large number of observers and sending a snapshot will kick-out client sessions on RO-observers (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1607&quot; title=&quot;Read-only Observer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1607&quot;&gt;ZOOKEEPER-1607&lt;/a&gt;). I don&apos;t have a concrete number at the moment, but this is one of the critical feature that kept our infrastructure running.  &lt;/p&gt;

</comment>
                            <comment id="13665342" author="fpj" created="Thu, 23 May 2013 17:48:48 +0100"  >&lt;p&gt;I had forgotten about that issue, good call. I was wondering if we should consider incorporating some of the work, for example, test cases.&lt;/p&gt;

&lt;p&gt;Note that I&apos;ve marking it so that this jira contains &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt;, so it supersedes that jira. To confirm, is it the case?&lt;/p&gt;</comment>
                            <comment id="13665870" author="fpj" created="Fri, 24 May 2013 01:21:24 +0100"  >&lt;p&gt;I have gone through the patch on the review board, but I still need to contrast the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt; against this one. If you already have thoughts about it, let me know.&lt;/p&gt;</comment>
                            <comment id="13665998" author="thawan" created="Fri, 24 May 2013 05:36:57 +0100"  >&lt;p&gt;I haven&apos;t looked at  &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt; in details but I believe this patch address all of the problem mentioned in the description. If there is any case not covered by LearnerHandlerTest, then I can add it&lt;/p&gt;</comment>
                            <comment id="13666000" author="thawan" created="Fri, 24 May 2013 05:51:38 +0100"  >&lt;p&gt;About snapshotSizeFactor, this parameter need to be tuned in conjunction with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1709&quot; title=&quot;Limit the size of txnlog file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1709&quot;&gt;ZOOKEEPER-1709&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Let says your snapshot size is 600MB, but the most recent txnlog file is 2GB. We don&apos;t want to load txnlog at all since it is slower than sending a snapshot even if the learner may only need to a few txn at the end of the txnlog file.  &lt;/p&gt;

&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1709&quot; title=&quot;Limit the size of txnlog file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1709&quot;&gt;ZOOKEEPER-1709&lt;/a&gt;, you can limit the size of the most recent txnlog to 200MB.  If snapshot factor is configured at 1/3. The leader will use txnlog if it only needs to load 1 txnlog file.&lt;/p&gt;

&lt;p&gt;I haven&apos;t done extensive testing to figure out the optimal setting. In our prod, the txnlog size limit should be small enough that the leader don&apos;t overload if a large number of learners try to synchronize at once. And the snapshot factor is configured such that the leader try to use at least 1 txnlog. &lt;/p&gt;
</comment>
                            <comment id="13673574" author="fpj" created="Mon, 3 Jun 2013 22:10:52 +0100"  >&lt;p&gt;I have tried this patch with the test case of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt; and the test fails. Here are a couple of lines in the output log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-06-03 22:42:25,396 [myid:] - INFO  [LearnerHandler-/127.0.0.1:61449:LearnerHandler@583] - Synchronizing with Follower sid: 3 maxCommittedLog=0x100000005 minCommittedLog=0x100000001 lastProcessedZxid=0x100000005 peerLastZxid=0x0
2013-06-03 22:42:25,396 [myid:] - INFO  [LearnerHandler-/127.0.0.1:61450:LearnerHandler@583] - Synchronizing with Follower sid: 4 maxCommittedLog=0x100000005 minCommittedLog=0x100000001 lastProcessedZxid=0x100000005 peerLastZxid=0x100000005
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is a server with id 5 that is he leader and 5 ends up sending a snapshot to server 3 although the committedLog contains all txns it needs:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-06-03 22:42:25,401 [myid:] - INFO  [LearnerHandler-/127.0.0.1:61449:LearnerHandler@368] - Sending snapshot last zxid of peer is 0x0 zxid of leader is 0x200000000 sent zxid of db as 0x100000005
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and this message seems to be related:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-06-03 22:42:25,398 [myid:] - WARN  [LearnerHandler-/127.0.0.1:61449:ZKDatabase@307] - Unable to find proposals from txnlog for zxid: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13673872" author="thawan" created="Tue, 4 Jun 2013 01:36:51 +0100"  >&lt;p&gt;You are using DiffOnRecoverTest right? &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-06-03 22:42:25,398 [myid:] - WARN  [LearnerHandler-/127.0.0.1:61449:ZKDatabase@307] - Unable to find proposals from txnlog for zxid: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The leader will use DIFF to sync with a learner only if it has more history than what the learner request. In this case, it has never seen any txn prior to zxid==0, so it fall back to use a snapshot.   &lt;/p&gt;

&lt;p&gt;This case is already covered by LearnerHandlerTest.testNewEpochZxid()&lt;/p&gt;</comment>
                            <comment id="13674207" author="fpj" created="Tue, 4 Jun 2013 10:24:22 +0100"  >&lt;p&gt;Something must be failing in my reasoning. The test (DiffOnRecover) simply simulates a server starting from scratch while the leader has all the necessary txns in the committedLog. If I get what you&apos;re saying, your point is that because the follower is in a previous epoch (in this particular case, there is no previous epoch), it must receive a snapshot and I don&apos;t understand why you think this is the case.&lt;/p&gt;</comment>
                            <comment id="13674634" author="thawan" created="Tue, 4 Jun 2013 19:08:29 +0100"  >&lt;p&gt;It doesn&apos;t need to get a snapshot but I don&apos;t add a logic to handle this special case, since I thought it wasn&apos;t a common case. &lt;/p&gt;

&lt;p&gt;Currently, queueCommittedProposal() will try to use DIFF or TRUNC only if it saw at least 1 txn older than what the learner ask for, so we need to modify it a bit to handle this case. &lt;/p&gt;


</comment>
                            <comment id="13674652" author="thawan" created="Tue, 4 Jun 2013 19:18:26 +0100"  >&lt;p&gt;Actually, this fails at db.getProposalsFromTxnLog() as shown in the log. The method return a list of proposal starting for zxid X only if the list of proposal start from zxid X or lower. &lt;/p&gt;

&lt;p&gt;Again this is to help simplify queueCommittedProposal() since it needs to enforce the constraint that I mentioned above.  &lt;/p&gt;</comment>
                            <comment id="13674699" author="fpj" created="Tue, 4 Jun 2013 19:49:10 +0100"  >&lt;p&gt;Since it is a performance issue and not a correctness issue, I can go either way. In the case we don&apos;t add the logic to handle the case &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt; supposedly does, we need to to decide what to do with that issue. &lt;/p&gt;
</comment>
                            <comment id="13679892" author="thawan" created="Mon, 10 Jun 2013 21:52:05 +0100"  >&lt;p&gt;I was thinking about this.  I think my design where is the leader is required to have a older history than the learner might be too strict in some cases, given that Zab guaranteed continuous history. &lt;/p&gt;

&lt;p&gt;Anyway, I don&apos;t think this case is common enough that we need to handle it. If there is additional change request, I will create another revision so we can review it.&lt;/p&gt;</comment>
                            <comment id="13679911" author="fpj" created="Mon, 10 Jun 2013 22:10:57 +0100"  >&lt;p&gt;There is something odd about your comment and it might be a problem with my interpretation. When you say that the leader must have an older history compared to a learner, I&apos;m not sure what that means. A prospective leader must be such that its highest zxid is higher than the highest zxid of any member of a quorum. The history of a learner might include some zxids that the leader doesn&apos;t have, in which case the leader either tells the learner to truncate or it sends a snapshot.&lt;/p&gt;

&lt;p&gt;About &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt;, are you suggesting that we resolve it as &quot;won&apos;t fix&quot; for now? &lt;/p&gt;

&lt;p&gt;I was also thinking that you&apos;re going to generate a new patch to include some of the comments we agreed upon in the review board. Perhaps I have misunderstood it or you simply haven&apos;t had time to do it. &lt;/p&gt;</comment>
                            <comment id="13690003" author="thawan" created="Fri, 21 Jun 2013 05:02:25 +0100"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Address comments&lt;/li&gt;
	&lt;li&gt;Move to SLF4J 1.7.5&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13690713" author="thawan" created="Fri, 21 Jun 2013 21:56:46 +0100"  >&lt;p&gt;Hmm, why didn&apos;t Hadoop QA ran. I thought I only need to attach a new patch file to trigger it&lt;/p&gt;</comment>
                            <comment id="13690734" author="thawan" created="Fri, 21 Jun 2013 22:22:59 +0100"  >&lt;p&gt;upload the patch again&lt;/p&gt;</comment>
                            <comment id="13690811" author="michim" created="Fri, 21 Jun 2013 23:17:08 +0100"  >&lt;p&gt;You might need to cancel the patch and submit the patch again to trigger the pre-commit build.&lt;/p&gt;</comment>
                            <comment id="13690872" author="michim" created="Sat, 22 Jun 2013 00:07:17 +0100"  >&lt;p&gt;Sorry I was wrong. You shouldn&apos;t have to cancel and resubmit. From &lt;a href=&quot;https://builds.apache.org/job/PreCommit-Admin/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-Admin/&lt;/a&gt; :&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The easiest way to rerun testing of a patch is to upload a new patch (with the same filename is fine) to the same Jira. The combination of a Jira being in Patch Available state AND having a new attachment that has never been processed by this system is what will trigger a new test of the patch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It looks like the last 2 pre-commit builds timed out. Not sure if it&apos;s because of the patch or something is wrong with the buildbot.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13691738" author="thawan" created="Mon, 24 Jun 2013 07:56:36 +0100"  >&lt;p&gt;Fix bug&lt;/p&gt;</comment>
                            <comment id="13691750" author="hadoopqa" created="Mon, 24 Jun 2013 08:32:57 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12589375/ZOOKEEPER-1413.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12589375/ZOOKEEPER-1413.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1495522.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 12 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1505//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1505//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1505//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1505//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1505//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1505//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13691861" author="fpj" created="Mon, 24 Jun 2013 11:07:45 +0100"  >&lt;p&gt;+1, thanks, Thawan. There is one caveat, though, the license header seems to be missing in TxnLogProposalIterator. The one who commits it needs to remember to add the license header, and upload the patch that has been committed. &lt;/p&gt;

&lt;p&gt;Do you want to try to commit this one to check that your accounting setting is ok, Thawan? Please don&apos;t forget to edit CHANGES.txt and to add new files.&lt;/p&gt;

&lt;p&gt;Also, it would be good if we decide what to do with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-876&quot; title=&quot;Unnecessary snapshot transfers between new leader and followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-876&quot;&gt;&lt;del&gt;ZOOKEEPER-876&lt;/del&gt;&lt;/a&gt;. My take is that we should resolve it and explain there that there is a corner case that we are not covering in here.&lt;/p&gt;</comment>
                            <comment id="13695240" author="thawan" created="Fri, 28 Jun 2013 04:27:43 +0100"  >&lt;p&gt;Add missing license header&lt;/p&gt;</comment>
                            <comment id="13695247" author="hadoopqa" created="Fri, 28 Jun 2013 05:03:05 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12589992/ZOOKEEPER-1413.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12589992/ZOOKEEPER-1413.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1495522.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 12 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1507//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1507//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1507//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1507//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1507//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1507//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13696092" author="hudson" created="Sat, 29 Jun 2013 12:00:07 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1975 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1975/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1975/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1413&quot; title=&quot;Use on-disk transaction log for learner sync up&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1413&quot;&gt;&lt;del&gt;ZOOKEEPER-1413&lt;/del&gt;&lt;/a&gt;. Use on-disk transaction log for learner sync up (thawan) (Revision 1497929)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
thawan : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1497929&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1497929&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/ivy.xml&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/TxnLogProposalIterator.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZKDatabase.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/persistence/TxnLog.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/LearnerHandlerTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/FollowerResyncConcurrencyTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/GetProposalFromTxnTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/LoadFromLogTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13696979" author="thawan" created="Mon, 1 Jul 2013 18:22:41 +0100"  >&lt;p&gt;Flavio, thanks for help reviewing this patch&lt;/p&gt;</comment>
                            <comment id="13793947" author="abranzyck" created="Mon, 14 Oct 2013 07:28:26 +0100"  >&lt;p&gt;Please consider applying this fix also to branch 3.4.&lt;br/&gt;
It fixes a few problems in the synchronization of servers in the quorum.&lt;br/&gt;
E.g. it solves problems when using TRUNC.&lt;br/&gt;
Without this patch if a peer tries to connect to a leader with a higher epoch, it will end up in an infinite loop.&lt;/p&gt;</comment>
                            <comment id="13793949" author="abranzyck" created="Mon, 14 Oct 2013 07:31:47 +0100"  >&lt;p&gt;I am very sorry, I started updating this issue in order to propose the patch for branch 3.4 (which is already prepared and attached), and now I don&apos;t know if I should reopen the issue or not. It is already fixed in trunk and I don&apos;t think that opening a new issue makes sense.&lt;br/&gt;
Please help me!&lt;/p&gt;</comment>
                            <comment id="13793958" author="abranzyck" created="Mon, 14 Oct 2013 07:47:13 +0100"  >&lt;p&gt;Forgot to do &quot;svn add&quot; for two new test classes.&lt;/p&gt;</comment>
                            <comment id="13794179" author="fpj" created="Mon, 14 Oct 2013 16:14:04 +0100"  >&lt;p&gt;This is currently marked as a bug, but I don&apos;t think it is a bug, it&apos;s an improvement. I&apos;d rather leave this one out of 3.4.6.&lt;/p&gt;</comment>
                            <comment id="13794230" author="abranzyck" created="Mon, 14 Oct 2013 16:55:30 +0100"  >&lt;p&gt;I changed it from Improvement to Bug this morning. Now it is back to what it was.&lt;br/&gt;
The problem that I see without this patch is that sometimes the new peer and the leader end up in an infinite loop.&lt;br/&gt;
I have seen this when there is a new peer that has a higher epoch than the leader.&lt;br/&gt;
Should that be reported in a different JIRA?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="12474695">ZOOKEEPER-876</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12671758">ZOOKEEPER-1777</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12648279">ZOOKEEPER-1709</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12648280">ZOOKEEPER-1710</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12608247" name="ZOOKEEPER-1413-3.4.patch" size="90428" author="abranzyck" created="Mon, 14 Oct 2013 07:47:13 +0100"/>
                            <attachment id="12608244" name="ZOOKEEPER-1413-3.4.patch" size="62563" author="abranzyck" created="Mon, 14 Oct 2013 07:28:26 +0100"/>
                            <attachment id="12589992" name="ZOOKEEPER-1413.patch" size="89970" author="thawan" created="Fri, 28 Jun 2013 04:27:43 +0100"/>
                            <attachment id="12589375" name="ZOOKEEPER-1413.patch" size="89143" author="thawan" created="Mon, 24 Jun 2013 07:56:36 +0100"/>
                            <attachment id="12589158" name="ZOOKEEPER-1413.patch" size="89129" author="thawan" created="Fri, 21 Jun 2013 22:22:59 +0100"/>
                            <attachment id="12588995" name="ZOOKEEPER-1413.patch" size="89129" author="thawan" created="Fri, 21 Jun 2013 05:02:25 +0100"/>
                            <attachment id="12583719" name="ZOOKEEPER-1413.patch" size="89039" author="thawan" created="Sat, 18 May 2013 04:03:45 +0100"/>
                            <attachment id="12583715" name="ZOOKEEPER-1413.patch" size="72159" author="thawan" created="Sat, 18 May 2013 02:28:16 +0100"/>
                            <attachment id="12519268" name="ZOOKEEPER-1413.patch" size="23483" author="thawan" created="Wed, 21 Mar 2012 17:29:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 21 Mar 2012 17:41:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231470</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy1ecf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41975</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>