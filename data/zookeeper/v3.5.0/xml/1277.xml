<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:44:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1277/ZOOKEEPER-1277.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1277] servers stop serving when lower 32bits of zxid roll over</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1277</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;When the lower 32bits of a zxid &quot;roll over&quot; (zxid is a 64 bit number, however the upper 32 are considered the epoch number) the epoch number (upper 32 bits) are incremented and the lower 32 start at 0 again.&lt;/p&gt;

&lt;p&gt;This should work fine, however in the current 3.3 branch the followers see this as a NEWLEADER message, which it&apos;s not, and effectively stop serving clients. Attached clients seem to eventually time out given that heartbeats (or any operation) are no longer processed. The follower doesn&apos;t recover from this.&lt;/p&gt;

&lt;p&gt;I&apos;ve tested this out on 3.3 branch and confirmed this problem, however I haven&apos;t tried it on 3.4/3.5. It may not happen on the newer branches due to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-335&quot; title=&quot;zookeeper servers should commit the new leader txn to their logs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-335&quot;&gt;&lt;del&gt;ZOOKEEPER-335&lt;/del&gt;&lt;/a&gt;, however there is certainly an issue with updating the &quot;acceptedEpoch&quot; files contained in the datadir. (I&apos;ll enter a separate jira for that)&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12529896">ZOOKEEPER-1277</key>
            <summary>servers stop serving when lower 32bits of zxid roll over</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="phunt">Patrick Hunt</assignee>
                                    <reporter username="phunt">Patrick Hunt</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Nov 2011 16:46:01 +0000</created>
                <updated>Fri, 28 Feb 2014 10:20:02 +0000</updated>
                            <resolved>Thu, 15 Mar 2012 16:55:14 +0000</resolved>
                                    <version>3.3.3</version>
                                    <fixVersion>3.3.5</fixVersion>
                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13142282" author="phunt" created="Wed, 2 Nov 2011 16:46:58 +0000"  >&lt;p&gt;I&apos;m thinking a simple fix for this in 3.3 is to skip 0x00000000 xid and go right to 0x00000001. That&apos;s a simple change, but testing out the various cases will be tougher. I&apos;m working on that.&lt;/p&gt;</comment>
                            <comment id="13148917" author="phunt" created="Sat, 12 Nov 2011 01:09:52 +0000"  >&lt;p&gt;This patch is against branch 3.3 so expect it to fail qa bot.&lt;/p&gt;

&lt;p&gt;I&apos;ve added a number of tests to try and verify that the rollover will both work, and that subsequently any restarts of various quorum members will return consistent results. afaict it&apos;s all working.&lt;/p&gt;</comment>
                            <comment id="13148924" author="hadoopqa" created="Sat, 12 Nov 2011 01:34:25 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12503459/ZOOKEEPER-1277_br33.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12503459/ZOOKEEPER-1277_br33.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1201045.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/787//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/787//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/787//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/787//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/787//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/787//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13149935" author="fpj" created="Mon, 14 Nov 2011 21:24:45 +0000"  >&lt;p&gt;Hi Pat, This is not correct. The correct thing to do here is to have the leader dropping leadership once it is about to wrap around the epoch counter and force a leader election. This approach will also move the ensemble to a new epoch as you&apos;re proposing, but it will correctly move to this new epoch by running the recovery phases.&lt;/p&gt;</comment>
                            <comment id="13149943" author="phunt" created="Mon, 14 Nov 2011 21:30:00 +0000"  >&lt;p&gt;I thought about that but it seemed like a bad idea for 2 reasons I could think of:&lt;br/&gt;
1) it would cause all of the clients to disconnect and reconnect unnecessarily, perhaps introducing instability in the process.&lt;br/&gt;
2) can we guarantee that the leader will give up leadership? ie how to effect this, exit the JVM on the leader?&lt;/p&gt;

&lt;p&gt;In talking with Ben about it in the past (perhaps he&apos;s since changed his mind) he seemed to think that rolling over to a new epoch number (with no leader re-election) was OK.&lt;/p&gt;</comment>
                            <comment id="13149973" author="fpj" created="Mon, 14 Nov 2011 21:54:55 +0000"  >&lt;p&gt;The scenario I have in mind to say this is incorrect is more or less the following:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Leader L is currently in epoch 3 and it moves to epoch 4 in the way this patch proposes by simply adding 2 to hzxid. The leader proposes a transaction with zxid &amp;lt;4,1&amp;gt;, which is acknowledged by some follower F, but not a quorum;&lt;/li&gt;
	&lt;li&gt;Concurrently, a new leader L&apos; arises and selects 4 as its epoch (it hasn&apos;t talked to L or F);&lt;/li&gt;
	&lt;li&gt;L&apos; proposes a transaction with zxid &amp;lt;4,1&amp;gt;, which is different from the transaction L proposed with the same zxid and this transaction is acknowledged by a quorum;&lt;/li&gt;
	&lt;li&gt;L eventually gives up on leadership after noticing that it is not supported by a quorum;&lt;/li&gt;
	&lt;li&gt;L&apos; crashes;&lt;/li&gt;
	&lt;li&gt;A new leader arises and its highest zxid is &amp;lt;4,1&amp;gt;. It doesn&apos;t have to synchronize with any of the followers because they all have highest zxid &amp;lt;4,1&amp;gt;. We have servers that have different transaction values for the same zxid, which constitutes an inconsistent state.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13149982" author="phunt" created="Mon, 14 Nov 2011 22:03:32 +0000"  >&lt;p&gt;I see. Yes that would be bad. I&apos;ll try reworking the patch to drop leadership. Any suggestions on were to look to make that happen?&lt;/p&gt;</comment>
                            <comment id="13150047" author="fpj" created="Mon, 14 Nov 2011 22:59:48 +0000"  >&lt;p&gt;For a quorum setup, it sounds like a good place would be in ProposalRequestProcessor.proposeRequest(). For standalone, it sounds like we should be doing something along the lines of what you proposed in your patch. &lt;/p&gt;</comment>
                            <comment id="13150066" author="phunt" created="Mon, 14 Nov 2011 23:17:02 +0000"  >&lt;p&gt;I&apos;ll rework the patch and get back. Thanks for the feedback Flavio.&lt;/p&gt;</comment>
                            <comment id="13151204" author="breed" created="Wed, 16 Nov 2011 13:55:58 +0000"  >&lt;p&gt;the problem is that we need to also worry about getting the accepted and current epochs correct when the rollover happens, so we have to do a bit of handshaking when the rollover happens. dropping leadership is the easiest and safest thing to do. the problem i have with special handling for rollover to make the epoch change faster is that the code path would almost never get hit and the path is non-trivial, so it would never be hardened. i would prefer to change the zxid to a long, long before trying to add special logic to handle that case.&lt;/p&gt;</comment>
                            <comment id="13229404" author="phunt" created="Wed, 14 Mar 2012 17:29:10 +0000"  >&lt;p&gt;A second attempt to fix this based on Flavio/Ben&apos;s feedback. &lt;/p&gt;

&lt;p&gt;This is just the initial patch, I&apos;m still working on the testing but I wanted to have you take a look before I spend a bunch of time on it again and not have it work out. If you could take a look/comment that would be great.&lt;/p&gt;

&lt;p&gt;org.apache.zookeeper.server.quorum.Leader.propose(Request)&lt;/p&gt;

&lt;p&gt;is the interesting bit, the rest is just some plumbing changes to carry up the exception.&lt;/p&gt;</comment>
                            <comment id="13229656" author="fpj" created="Wed, 14 Mar 2012 21:38:00 +0000"  >&lt;p&gt;Ok, I only looked at propose() as you suggested, Pat. That method sounds right: it forces a leader election when we reach the limit. However, I&apos;m not sure how we guarantee that Zab will work correctly under this exception. It is an invariant of the protocol that a follower won&apos;t go back to a previous epoch; if we roll over, then followers will have to go back to a previous epoch, no? How do we make sure that it doesn&apos;t break the protocol implementation? &lt;/p&gt;</comment>
                            <comment id="13229668" author="fpj" created="Wed, 14 Mar 2012 21:55:22 +0000"  >&lt;p&gt;Offline discussion with Pat: the check in propose() is only for the zxid, so the issue I raised about epochs does not apply.&lt;/p&gt;</comment>
                            <comment id="13229672" author="phunt" created="Wed, 14 Mar 2012 21:59:09 +0000"  >&lt;p&gt;That&apos;s correct, based on the feedback I got from the previous attempt it was clear that we cannot continue without a re-election. In this case I&apos;m looking for the &quot;just about to occur rollover&quot; and I&apos;m dropping leadership at that point. The re-election will then happen, a new epoch chosen, and the lower 32bit thereby reset.&lt;/p&gt;</comment>
                            <comment id="13229680" author="breed" created="Wed, 14 Mar 2012 22:07:30 +0000"  >&lt;p&gt;this looks good to me as well. the new exception makes it look a bit more complicated than it should, but i see why you do it.&lt;/p&gt;</comment>
                            <comment id="13229693" author="mahadev" created="Wed, 14 Mar 2012 22:19:23 +0000"  >&lt;p&gt;Sorry coming in a little late. Looks good to me as well. Would have wanted to avoid the property even though its just for testing. Here is when refactoring for testing would have made sense &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13229704" author="phunt" created="Wed, 14 Mar 2012 22:26:57 +0000"  >&lt;p&gt;haha, yea I hear you. This is not for unit test testing though. I use setZxid for that (see the original test). &lt;/p&gt;

&lt;p&gt;The system property is to allow QA to test this on a real cluster. I&apos;ve used this for the first level of verification - I started a 3 node cluster with this system property and used a std client to force the re-election (by creating znodes for example). I can then see that the real servers are operating properly and handle this case - without waiting for a month of writes to go through the system. That make more sense? (I&apos;ll update the comment)&lt;/p&gt;</comment>
                            <comment id="13229708" author="mahadev" created="Wed, 14 Mar 2012 22:32:19 +0000"  >&lt;p&gt;Ahh... That makes more sense! Updated comments would be good. Thanks!&lt;/p&gt;</comment>
                            <comment id="13229763" author="phunt" created="Wed, 14 Mar 2012 23:39:23 +0000"  >&lt;p&gt;This is basically the same patch, but with the tests working/passing and the comment updated that Mahadev highlighted.&lt;/p&gt;

&lt;p&gt;I&apos;ve verified this in br33 using both the tests and testing manually using the system property to force quicker rolloer.&lt;/p&gt;</comment>
                            <comment id="13229906" author="hadoopqa" created="Thu, 15 Mar 2012 05:25:07 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12518421/ZOOKEEPER-1277_trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12518421/ZOOKEEPER-1277_trunk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1297740.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/993//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/993//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/993//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/993//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/993//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/993//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13229918" author="phunt" created="Thu, 15 Mar 2012 05:46:05 +0000"  >&lt;p&gt;addressed the findbugs issue.&lt;/p&gt;</comment>
                            <comment id="13229937" author="hadoopqa" created="Thu, 15 Mar 2012 06:28:56 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12518426/ZOOKEEPER-1277_trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12518426/ZOOKEEPER-1277_trunk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1297740.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/994//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/994//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/994//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/994//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/994//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/994//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13229941" author="mahadev" created="Thu, 15 Mar 2012 06:47:34 +0000"  >&lt;p&gt;+1 on the patches. Looked through all 3. Good to go! Thanks Pat!&lt;/p&gt;</comment>
                            <comment id="13231062" author="hudson" created="Fri, 16 Mar 2012 11:07:48 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1493 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1493/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1493/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1277&quot; title=&quot;servers stop serving when lower 32bits of zxid roll over&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1277&quot;&gt;&lt;del&gt;ZOOKEEPER-1277&lt;/del&gt;&lt;/a&gt;. servers stop serving when lower 32bits of zxid roll over (phunt) (Revision 1301079)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
phunt : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1301079&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1301079&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/RequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/SyncRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/ProposalRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/ReadOnlyRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/ZxidRolloverTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/ClientBase.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13633420" author="davelatham" created="Tue, 16 Apr 2013 22:48:38 +0100"  >&lt;p&gt;We recently experienced an HBase outage that I believe was caused by this issue.  Running on ZK 3.4.4, the log for the leader shows this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-04-12 17:46:25,894 INFO org.apache.zookeeper.server.quorum.Leader: Have quorum of supporters; starting up and setting last processed zxid: 0x1a00000004
2013-04-12 17:46:25,895 WARN org.apache.zookeeper.server.FinalRequestProcessor: Zxid outstanding 111669149696 is less than current 111669149697
2013-04-12 17:46:25,895 WARN org.apache.zookeeper.server.quorum.LearnerHandler: ******* GOODBYE /10.0.1.100:34796 ********
2013-04-12 17:46:25,896 ERROR org.apache.zookeeper.server.NIOServerCnxnFactory: Thread LearnerHandler Socket[addr=/10.0.1.100,port=34796,localport=2888] tickOfLastAck:897811 synced?:true queuedPacketLength:0 died
java.lang.IllegalThreadStateException
	at java.lang.Thread.start(Thread.java:638)
	at org.apache.zookeeper.server.quorum.LeaderZooKeeperServer.startSessionTracker(LeaderZooKeeperServer.java:87)
	at org.apache.zookeeper.server.ZooKeeperServer.startup(ZooKeeperServer.java:394)
	at org.apache.zookeeper.server.quorum.Leader.processAck(Leader.java:531)
	at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:497)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Immediately after this one of the followers had a new election and became a follower again.  Also, the heap on the leader immediately climbed until the process became stuck spending most of its time in GC.  At this point HBase region servers started dropping like flies and then the ZK node was killed.&lt;/p&gt;

&lt;p&gt;I&apos;m adding this comment now for two purposes.  First, so that if other people see the same symptom in their logs they may find this issue faster.  Second, I&apos;d love to hear from anyone more familiar with ZooKeeper if this issue does indeeed explain the observations I wrote and mentioned above.&lt;/p&gt;</comment>
                            <comment id="13633423" author="davelatham" created="Tue, 16 Apr 2013 22:49:09 +0100"  >&lt;p&gt;Excuse me, we were running 3.4.3, not 3.4.4&lt;/p&gt;</comment>
                            <comment id="13633563" author="phunt" created="Wed, 17 Apr 2013 00:42:39 +0100"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davelatham&quot; class=&quot;user-hover&quot; rel=&quot;davelatham&quot;&gt;Dave Latham&lt;/a&gt;, it seems unlikely to me. Are you only running hbase against ZK? Because in that case the number of changes to zk are going to be &amp;lt;&amp;lt;&amp;lt;&amp;lt; than 4billion (the amount necessary to roll over the lower 32 bits), hbase just doesn&apos;t generate that much traffic. I&apos;ve only seen the rollover case with 10k&apos;s of clients doing large numbers of operations per second. hbase just doesn&apos;t drive that much traffic - it&apos;s mainly for failover and table management.&lt;/p&gt;

&lt;p&gt;You might have hit an issue with 3.4 that was fixed in a subsequent release. However the symptoms you mentioned don&apos;t ring a bell either....&lt;/p&gt;</comment>
                            <comment id="13633565" author="davelatham" created="Wed, 17 Apr 2013 00:46:00 +0100"  >&lt;p&gt;Thanks for the response, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;Patrick Hunt&lt;/a&gt;.  It is only HBase, but there are 1000 region servers and are using replication which puts much greater load on ZK.  Taking a recent sample I see the zxid going up by thousands per second.&lt;/p&gt;</comment>
                            <comment id="13633580" author="phunt" created="Wed, 17 Apr 2013 00:58:54 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davelatham&quot; class=&quot;user-hover&quot; rel=&quot;davelatham&quot;&gt;Dave Latham&lt;/a&gt; this could be it then. 1k&apos;s/sec means ~ a month before rollover.&lt;/p&gt;</comment>
                            <comment id="13915635" author="lanyufu" created="Fri, 28 Feb 2014 10:20:02 +0000"  >&lt;p&gt;when the zixd roll over, the epoch++ ; a new leader arises ,the epoch += 2.  this way can avoid throw Exception ?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12529897">ZOOKEEPER-1278</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12518424" name="ZOOKEEPER-1277_br33.patch" size="22843" author="phunt" created="Thu, 15 Mar 2012 05:45:41 +0000"/>
                            <attachment id="12518400" name="ZOOKEEPER-1277_br33.patch" size="22829" author="phunt" created="Wed, 14 Mar 2012 23:39:23 +0000"/>
                            <attachment id="12518345" name="ZOOKEEPER-1277_br33.patch" size="20420" author="phunt" created="Wed, 14 Mar 2012 17:29:09 +0000"/>
                            <attachment id="12503459" name="ZOOKEEPER-1277_br33.patch" size="11882" author="phunt" created="Sat, 12 Nov 2011 01:08:32 +0000"/>
                            <attachment id="12518425" name="ZOOKEEPER-1277_br34.patch" size="26680" author="phunt" created="Thu, 15 Mar 2012 05:45:41 +0000"/>
                            <attachment id="12518420" name="ZOOKEEPER-1277_br34.patch" size="26666" author="phunt" created="Thu, 15 Mar 2012 04:52:52 +0000"/>
                            <attachment id="12518426" name="ZOOKEEPER-1277_trunk.patch" size="25967" author="phunt" created="Thu, 15 Mar 2012 05:46:03 +0000"/>
                            <attachment id="12518421" name="ZOOKEEPER-1277_trunk.patch" size="25953" author="phunt" created="Thu, 15 Mar 2012 04:53:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 12 Nov 2011 01:34:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>215755</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwchr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12511</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Workaround: there is a simple workaround for this issue. Force a leader re-election before the lower 32bits reach 0xffffffff&lt;br/&gt;
&lt;br/&gt;
Most users won&amp;#39;t even see this given the number of writes on a typical installation - say you are doing 500 writes/second, you&amp;#39;d see this after ~3 months if the quorum is stable, any changes (such as upgrading the server software) would cause the xid to be reset, thereby staving off this issue for another period.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>