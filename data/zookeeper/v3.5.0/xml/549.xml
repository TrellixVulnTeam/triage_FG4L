<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:46:19 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-549/ZOOKEEPER-549.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-549] Refactor Followers and related classes into a Peer-&gt;Follower hierarchy in preparation for Observers</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-549</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;For the Observers patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-368&quot; title=&quot;Observers: core functionality &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-368&quot;&gt;&lt;del&gt;ZOOKEEPER-368&lt;/del&gt;&lt;/a&gt;), a lot of functionality is shared between Followers and Observers. To avoid copying code, it makes sense to push the common code into a parent Peer class and specialise it for Followers and Observers. At the same time, some of the lengthier methods in Follower can be broken up to make the code more readable. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12437660">ZOOKEEPER-549</key>
            <summary>Refactor Followers and related classes into a Peer-&gt;Follower hierarchy in preparation for Observers</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henryr">Henry Robinson</assignee>
                                    <reporter username="henryr">Henry Robinson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Oct 2009 00:19:58 +0100</created>
                <updated>Fri, 26 Mar 2010 17:25:02 +0000</updated>
                            <resolved>Fri, 30 Oct 2009 16:20:58 +0000</resolved>
                                    <version>3.2.1</version>
                                    <fixVersion>3.3.0</fixVersion>
                                    <component>quorum</component>
                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12764572" author="henryr" created="Mon, 12 Oct 2009 07:37:07 +0100"  >&lt;p&gt;This patch refactors Followers into a Peer-&amp;gt;Follower hierarchy in preparation for the upcoming Observers patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-368&quot; title=&quot;Observers: core functionality &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-368&quot;&gt;&lt;del&gt;ZOOKEEPER-368&lt;/del&gt;&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;There&apos;s no new functionality in this patch, save for the introduction of the getView API in QuorumPeer which is tested by two tests in QuorumTest. All tests pass when this patch is applied against trunk.&lt;/p&gt;

&lt;p&gt;For ease of review, I&apos;ve listed the main changes below:&lt;/p&gt;

&lt;p&gt;1. A Peer class has been introduced which is a superclass of Follower (and, eventually, Observer). Functionality common to all peers has been moved into this class.&lt;br/&gt;
2. Follower.followLeader has been refactored into a driver for three methods contained in Peer. These three methods are: connectToLeader(InetSocketAddress), registerWithLeader(int pktType) and syncWithLeader(long newLeaderzxid). Observers will contain their own driver method which calls these three methods in the superclass.&lt;br/&gt;
3. Similarly, FollowerZooKeeperHandler has been refactored into PeerZooKeeperHandler and FollowerZooKeeperHandler.&lt;br/&gt;
4. FollowerHandler has been renamed PeerHandler. The sock variable has been made protected and is accessed via getSocket().&lt;br/&gt;
5. ZooKeeperServer.getTouchSnapshot has been made protected as it is not called outside its own class.&lt;br/&gt;
6. FollowerCnxAcceptor has been renamed PeerCnxAcceptor&lt;br/&gt;
7. QuorumPeer has a new getView API which returns the internally held map of QuorumPeers, plus a viewContains method to determine if a server is in that map.&lt;/p&gt;
</comment>
                            <comment id="12764577" author="hadoopqa" created="Mon, 12 Oct 2009 07:55:32 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12421844/ZOOKEEPER-549.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12421844/ZOOKEEPER-549.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 823371.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 2 new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/21/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/21/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/21/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/21/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/21/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/21/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12764847" author="henryr" created="Mon, 12 Oct 2009 22:31:28 +0100"  >&lt;p&gt;Both findbugs warnings were, I think, present in previous builds - they&apos;ve just moved. &lt;/p&gt;

&lt;p&gt;One is the use of System.exit(13), and the other is an unused SessionExpirer member.&lt;/p&gt;
</comment>
                            <comment id="12764858" author="phunt" created="Mon, 12 Oct 2009 22:45:30 +0100"  >&lt;p&gt;No, the current build has 0 findbugs warnings (and we want to keep it that way) &amp;#8211; if you use the exclusion list that&apos;s in svn. &lt;/p&gt;

&lt;p&gt;It may be the case that the exclusion matcher is no longer matching, if you say, moved some code around. You may need to update&lt;br/&gt;
the findbugs exclusion list as part of the patch.&lt;/p&gt;</comment>
                            <comment id="12764929" author="henryr" created="Tue, 13 Oct 2009 03:44:08 +0100"  >&lt;p&gt;Updated findbugs.xml to mask these warnings. Findbugs goes back to 0 for me locally.&lt;/p&gt;</comment>
                            <comment id="12764969" author="hadoopqa" created="Tue, 13 Oct 2009 07:15:29 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12421942/ZOOKEEPER-549.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12421942/ZOOKEEPER-549.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 823371.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/22/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/22/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/22/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/22/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/22/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/22/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12766096" author="fpj" created="Thu, 15 Oct 2009 16:37:42 +0100"  >&lt;p&gt;Thanks, Henry, the patch looks good. I have a couple of high level comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think we should call &quot;Peer*&quot; classes something else because calling them Peer gives the idea that it contains functionality that belongs to leaders, followers, and observers. Leader does not extend Peer, though. Also, we already have a QuorumPeer class (and related classes), which makes it. In my interpretation, the common functionality between followers and observers is that they commit (learn) transactions, so we could call it a Committer or a Learner. I personally prefer the latter, and I&apos;m obviously interested in other suggestions;&lt;/li&gt;
	&lt;li&gt;Most likely this should be a separate jira, but I&apos;d like to propose that split the package structure further, in particular for the quorum package. I suggest: quorum.leader, quorum.peer, quorum.learner, quorum.le.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12766716" author="mahadev" created="Fri, 16 Oct 2009 22:33:41 +0100"  >&lt;p&gt;henry,&lt;br/&gt;
 good to see this. This is much needed refactoring. Some comments/questions-&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;+1 on flavio&apos;s suggestion. I couldnt find a better name then Peer though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. We do have to keep the Followers as Followers because that we use for the ones that have a say in the proposals!&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;there is an unwanted import in Follower.java and more in other classes like FollowerZooKeepeerServer and maybe others.
  &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.zookeeper.txn.TxnHeader;
  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;downcast operations in Follower.java for downcasting to FollowerZooKeeperServer. Its done on each and every read of packet and processing. There is some cost to it.&lt;/li&gt;
&lt;/ul&gt;


  &lt;blockquote&gt;
&lt;p&gt;  Downcast operations (also called narrowing conversions in the Java Language Specification) convert an ancestor class reference to a subclass reference. This casting operation creates execution overhead, since Java requires that the cast be checked at runtime to make sure that it&apos;s valid.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt; from javaworld.&lt;br/&gt;
 I think you should be able to downcast once and use that object from then on?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;other then that, we might want to consider refactoring all the classes into subpackages like flavio suggested&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;also, we should make sure we do enough testing because this is a lot of refactoring.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12766724" author="henryr" created="Fri, 16 Oct 2009 22:52:41 +0100"  >&lt;p&gt;Mahadev / Flavio -  &lt;/p&gt;

&lt;p&gt;Thanks for the comments!&lt;/p&gt;

&lt;p&gt;I agree about renaming from Peer; Learner isn&apos;t a bad name. If no-one has a better suggestion, I&apos;ll do that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Good point on the downcasts, I&apos;ll remove the unnecessary ones. Also good catch on the imports; I rely on Eclipse to catch them and it sometimes doesn&apos;t. &lt;/p&gt;

&lt;p&gt;Definitely agree on the testing; but since this is a rearrangement of code it&apos;s not clear how to write many more functional tests since we already have some coverage. Is anyone running a stress test workload? I&apos;ve just got my hands on some resources to do something similar, but setting it up would take a bit of time. &lt;/p&gt;

&lt;p&gt;I think there are a host of refactorings that could still stand to be done on this code and elsewhere. I agree on the package split, that probably belongs in this JIRA.&lt;/p&gt;



</comment>
                            <comment id="12768096" author="henryr" created="Wed, 21 Oct 2009 06:54:14 +0100"  >&lt;p&gt;This patch renames the Peer* classes to Learner*, fixes the downcast issue and removes some unused imports. I haven&apos;t moved the packages around, just to keep this patch manageable. &lt;/p&gt;
</comment>
                            <comment id="12768106" author="hadoopqa" created="Wed, 21 Oct 2009 07:14:42 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12422770/ZOOKEEPER-549.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12422770/ZOOKEEPER-549.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 826787.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 2 new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/32/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/32/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/32/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/32/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/32/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/32/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12768110" author="henryr" created="Wed, 21 Oct 2009 07:30:23 +0100"  >&lt;p&gt;Argh, renamed the files that the findbugs exclusions were in, but didn&apos;t update the findbugs xml file. Sorry, hudson, try again. &lt;/p&gt;</comment>
                            <comment id="12768116" author="hadoopqa" created="Wed, 21 Oct 2009 07:54:42 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12422775/ZOOKEEPER-549.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12422775/ZOOKEEPER-549.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 826787.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/33/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/33/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/33/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/33/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/33/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/33/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12768250" author="fpj" created="Wed, 21 Oct 2009 15:09:43 +0100"  >&lt;p&gt;Nice job, Henry! I have just a quick question about FOLLOWERINFO. I&apos;ve noticed that in your patch one of the Learner methods is registerWithLeader(), and this method takes a packet type. I&apos;m assuming that you have not replaced FOLLOWERINFO with LEARNERINFO, and that registerWithLeader takes a packet type as parameter because observers will send something like OBSERVERINFO?&lt;/p&gt;

&lt;p&gt;Assuming that what I said is correct, what if learners send LEARNERINFO, and the leader verifies the status of the server against its configuration?&lt;/p&gt;

&lt;p&gt;I apologize if I&apos;m mixing jiras here. I&apos;m just trying to understand why FOLLOWERINFO hasn&apos;changed.&lt;/p&gt;</comment>
                            <comment id="12768344" author="henryr" created="Wed, 21 Oct 2009 18:36:35 +0100"  >&lt;p&gt;You&apos;re right - the observers patch will introduce OBSERVERINFO which is the way that the leader learns to distinguish observers from followers. &lt;/p&gt;

&lt;p&gt;It&apos;s also possible that the Leader check its configuration and assigns the appropriate role to the Learner. However, I&apos;d still like to have the role negotiated between Learner and Leader and run-time (otherwise we&apos;d have to check for misconfiguration all throughout the code because an observer would silently be treated like a follower, never vote and that would be hard to debug). &lt;/p&gt;

&lt;p&gt;In the observers patch, I&apos;ll add some code so that if the Leader receives OBSERVERINFO or FOLLOWERINFO it checks that this is the expected type from that particular peer.&lt;/p&gt;
</comment>
                            <comment id="12768386" author="fpj" created="Wed, 21 Oct 2009 20:51:03 +0100"  >&lt;p&gt;I originally thought that by using LEANERINFO for both observers and followers, we would make the protocol backward compatible. I now realize that it makes no difference. &lt;/p&gt;

&lt;p&gt;Once we add observers, if we have an observer trying to connect to an old leader, even if we use LEANERINFO (with the same value 11 we have for FOLLOWERINFO in trunk), it won&apos;t work because the leader will expect acks from that observer. An old server can also connect as a follower to a new leader without a problem if we keep FOLLOWERINFO as is. We would have a problem if the follower were configured as an observer on the leader, but I suppose this is a configuration error.&lt;/p&gt;

&lt;p&gt;My conclusion is that I don&apos;t see an issue with using OBSERVERINFO or FOLLOWERINFO regarding backward compatibility. The only issue I see is that having OBSERVERINFO creates yet another message and there is a way around it. I personally don&apos;t think it is a big deal to add another message, but some folks might not like it.&lt;/p&gt;

&lt;p&gt;On my end, +1 for the patch. We can continue the discussion on adding OBSERVERINFO or not in the observer jira. For this patch, I think it is good as is.&lt;/p&gt;</comment>
                            <comment id="12768450" author="mahadev" created="Wed, 21 Oct 2009 21:58:00 +0100"  >&lt;p&gt;the patch looks good but I am getting confused with the OBSERVERINFO/FOLLOWERINFO discussion above... As of this patch is the above discussion relavant? As far as I can tell its just a refactoring and the servers before and after this patch should be able to work with each other ... right?&lt;/p&gt;</comment>
                            <comment id="12768458" author="phunt" created="Wed, 21 Oct 2009 22:07:20 +0100"  >&lt;p&gt;To put a fine point on that - ensure that the refactored code is b/w compatible with the original code. That should&lt;br/&gt;
be a general goal as well as an item in the patch reviewers checklist.&lt;/p&gt;</comment>
                            <comment id="12768466" author="henryr" created="Wed, 21 Oct 2009 22:20:44 +0100"  >&lt;p&gt;Mahadev - yes, the FOLLOWERINFO discussion really applies to the observer patch. I think that we should push that specific backwards compatibility discussion onto the observers jira. &lt;/p&gt;

&lt;p&gt;I believe backwards compatibility is completely preserved by this patch: there aren&apos;t any protocol changes. &lt;/p&gt;
</comment>
                            <comment id="12768622" author="fpj" created="Thu, 22 Oct 2009 10:50:05 +0100"  >&lt;p&gt;Just to make my position clear. I initially questioned why the patch doesn&apos;t replace FOLLOWERINFO with LEARNERINFO (which would be b/w compatible given that we keep the same value for the constant), and I was trying to understand why Henry didn&apos;t do it. After our discussion (above), it became clear that we should leave it for the observer jira.&lt;/p&gt;
</comment>
                            <comment id="12771676" author="mahadev" created="Thu, 29 Oct 2009 23:00:27 +0000"  >&lt;p&gt;I tried a bunch of permutations of the new code (after this patch) servers and old code  servers just to make sure we are backwards compatible. It all works fine. I will try committing this ASAP after a final review.&lt;/p&gt;</comment>
                            <comment id="12771747" author="mahadev" created="Fri, 30 Oct 2009 03:07:19 +0000"  >&lt;p&gt;+1 this looks good.... Ill commit this tonight... &lt;/p&gt;</comment>
                            <comment id="12771983" author="mahadev" created="Fri, 30 Oct 2009 16:20:58 +0000"  >&lt;p&gt;I just committed this. thanks henry.&lt;/p&gt;</comment>
                            <comment id="12772231" author="hudson" created="Sat, 31 Oct 2009 10:57:14 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #514 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/514/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/514/&lt;/a&gt;)&lt;br/&gt;
    . Refactor Followers and related classes into a Peer-&amp;gt;Follower hierarchy in preparation for Observers (henry robinson via mahadev)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12422775" name="ZOOKEEPER-549.patch" size="110315" author="henryr" created="Wed, 21 Oct 2009 07:30:23 +0100"/>
                            <attachment id="12422770" name="ZOOKEEPER-549.patch" size="110309" author="henryr" created="Wed, 21 Oct 2009 06:54:14 +0100"/>
                            <attachment id="12421942" name="ZOOKEEPER-549.patch" size="108753" author="henryr" created="Tue, 13 Oct 2009 03:44:08 +0100"/>
                            <attachment id="12421844" name="ZOOKEEPER-549.patch" size="107507" author="henryr" created="Mon, 12 Oct 2009 07:36:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 12 Oct 2009 06:55:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47738</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzxp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33443</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Refactor followers code into Learner from which followers and observers will inherit.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>