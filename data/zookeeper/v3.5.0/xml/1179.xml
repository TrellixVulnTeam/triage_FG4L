<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:44:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1179/ZOOKEEPER-1179.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1179] NettyServerCnxn does not properly close socket on 4 letter word requests</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1179</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;When calling a 4-letter-word to a server configured to use NettyServerCnxnFactory, the factory will not properly cancel all the keys and close the socket after sending the response for the 4lw. The close request will throw this exception, and the thread will not shut down:&lt;br/&gt;
2011-09-13 12:14:17,546 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;New I/O server worker #1-1:NettyServerCnxnFactory$CnxnChannelHandler@117&amp;#93;&lt;/span&gt; - Exception caught &lt;span class=&quot;error&quot;&gt;&amp;#91;id: 0x009300cc, /1.1.1.1:38542 =&amp;gt; /139.172.114.138:2181&amp;#93;&lt;/span&gt; EXCEPTION: java.io.IOException: A non-blocking socket operation could not be completed immediately&lt;br/&gt;
java.io.IOException: A non-blocking socket operation could not be completed immediately&lt;br/&gt;
	at sun.nio.ch.SocketDispatcher.close0(Native Method)&lt;br/&gt;
	at sun.nio.ch.SocketDispatcher.preClose(SocketDispatcher.java:44)&lt;br/&gt;
	at sun.nio.ch.SocketChannelImpl.implCloseSelectableChannel(SocketChannelImpl.java:684)&lt;br/&gt;
	at java.nio.channels.spi.AbstractSelectableChannel.implCloseChannel(AbstractSelectableChannel.java:201)&lt;br/&gt;
	at java.nio.channels.spi.AbstractInterruptibleChannel.close(AbstractInterruptibleChannel.java:97)&lt;br/&gt;
	at org.jboss.netty.channel.socket.nio.NioWorker.close(NioWorker.java:593)&lt;br/&gt;
	at org.jboss.netty.channel.socket.nio.NioServerSocketPipelineSink.handleAcceptedSocket(NioServerSocketPipelineSink.java:119)&lt;br/&gt;
	at org.jboss.netty.channel.socket.nio.NioServerSocketPipelineSink.eventSunk(NioServerSocketPipelineSink.java:76)&lt;br/&gt;
	at org.jboss.netty.channel.Channels.close(Channels.java:720)&lt;br/&gt;
	at org.jboss.netty.channel.AbstractChannel.close(AbstractChannel.java:208)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxn.close(NettyServerCnxn.java:116)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxn.cleanupWriterSocket(NettyServerCnxn.java:241)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxn.access$0(NettyServerCnxn.java:231)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxn$CommandThread.run(NettyServerCnxn.java:314)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxn$CommandThread.start(NettyServerCnxn.java:305)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxn.checkFourLetterWord(NettyServerCnxn.java:674)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxn.receiveMessage(NettyServerCnxn.java:791)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxnFactory$CnxnChannelHandler.processMessage(NettyServerCnxnFactory.java:217)&lt;br/&gt;
	at org.apache.zookeeper.server.NettyServerCnxnFactory$CnxnChannelHandler.messageReceived(NettyServerCnxnFactory.java:141)&lt;br/&gt;
	at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:274)&lt;br/&gt;
	at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:261)&lt;br/&gt;
	at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:350)&lt;br/&gt;
	at org.jboss.netty.channel.socket.nio.NioWorker.processSelectedKeys(NioWorker.java:281)&lt;br/&gt;
	at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:201)&lt;br/&gt;
	at org.jboss.netty.util.internal.IoWorkerRunnable.run(IoWorkerRunnable.java:46)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12522922">ZOOKEEPER-1179</key>
            <summary>NettyServerCnxn does not properly close socket on 4 letter word requests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh R</assignee>
                                    <reporter username="fournc">Camille Fournier</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Sep 2011 17:20:56 +0100</created>
                <updated>Thu, 13 Mar 2014 18:17:01 +0000</updated>
                            <resolved>Wed, 12 Feb 2014 01:18:49 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.6</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13855274" author="rakeshr" created="Sun, 22 Dec 2013 20:58:39 +0000"  >&lt;p&gt;Please have a look at NETTY-412, which is discussing the same scenario and is still an open issue in the netty. Also, when fixing the zookeeper windows build, this case has been again discovered and please see comments obout &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1833?focusedCommentId=13855267&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13855267&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;test case failure in ZOOKEEPER-1833 &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please review the attached patch, where I skipped the duplicate closure in CnxnChannelHandler#exceptionCaught. Thanks&lt;/p&gt;</comment>
                            <comment id="13855276" author="rakeshr" created="Sun, 22 Dec 2013 21:09:53 +0000"  >&lt;p&gt;Please see link for &lt;a href=&quot;https://issues.jboss.org/browse/NETTY-412&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.jboss.org/browse/NETTY-412&lt;/a&gt; jira issue&lt;/p&gt;</comment>
                            <comment id="13855286" author="hadoopqa" created="Sun, 22 Dec 2013 21:24:02 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12620105/ZOOKEEPER-1179.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12620105/ZOOKEEPER-1179.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1552946.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1859//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1859//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1859//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1859//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1859//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1859//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13855298" author="abranzyck" created="Sun, 22 Dec 2013 22:03:26 +0000"  >&lt;p&gt;Good catch!&lt;br/&gt;
It seems to me that NettyServerCnxn.close() is already protected against duplicated calls, isn&apos;t it? It first removes the pointer from a list in the factory, and only if the pointer was in the list proceeds with the close. However, in this point:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@@ -215,6 +223,7 @@
     @Override
     public void sendBuffer(ByteBuffer sendBuffer) {
         if (sendBuffer == ServerCnxnFactory.closeConn) {
+            isClosing.set(true);
             channel.close();
             return;
         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... you found a place where it is done in another way, and that brakes the principle. I think that the problem should be fixed just by replacing &quot;channel.close()&quot; above with a call to NettyServerCnxn.close(). Does that make sense?&lt;/p&gt;</comment>
                            <comment id="13855459" author="rakeshr" created="Mon, 23 Dec 2013 07:17:21 +0000"  >&lt;p&gt;Thanks for reviewing the patch. IMO, the problem exists in the following way:&lt;br/&gt;
While closing the channel, it hits an exception and enters into the exceptionCaught logic. Here this is again trying to close the channel and is causing the issue. The stacktrace given in the description is also showing the same, please see once. As this is an open issue from netty code &lt;span class=&quot;error&quot;&gt;&amp;#91;NETTY-412&amp;#93;&lt;/span&gt;, workaround would be to skip the closure in exceptionCaught if it was occured from channel#close. Whats your opinion?&lt;/p&gt;

&lt;p&gt;Also, I observed channel.close(); will generate ChannelDisconnected event, here the NettyServerCnxn#close is invoked and doing the cleanup. &lt;br/&gt;
As an improvement let me check, NettyServerCnxn#close instead of channel.close() in the NettyServerCnxn.sendBuffer(),  but this won&apos;t fix the above mentioned case.&lt;/p&gt;</comment>
                            <comment id="13855472" author="abranzyck" created="Mon, 23 Dec 2013 07:37:57 +0000"  >&lt;p&gt;Thanks a lot for the explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt;.&lt;br/&gt;
This is how I understand it:&lt;br/&gt;
If we hit an exception when closing the channel, then we are in the final part of method NettyServerCnxn#close. If we are there, then we have already removed &quot;this&quot; NettyServerCnxn object from the list in the corresponding NettyServerCnxnFactory. That means that if the exception handling makes another call to NettyServerCnxn#close, it will have no effect since it will not pass the check where there is the comment &quot;// if this is not in cnxns then it&apos;s already closed&quot; in that method.&lt;br/&gt;
Please tell me if this reasoning doesn&apos;t look good to you.&lt;/p&gt;</comment>
                            <comment id="13855504" author="rakeshr" created="Mon, 23 Dec 2013 08:59:31 +0000"  >&lt;p&gt;Yeah German, I understood your thoughts. Now only the possibility of occuring the case is in NettyServerCnxn#sendBuffer, where it directly closing the channel reference. As you told earlier, this should be replaced with NettyServerCnxn.close().&lt;/p&gt;</comment>
                            <comment id="13855758" author="fpj" created="Mon, 23 Dec 2013 16:56:36 +0000"  >&lt;p&gt;Is any of you proposing a new patch based on the agreement I&apos;m just reading here? I haven&apos;t had a chance to check it carefully, but so far sounds right.&lt;/p&gt;</comment>
                            <comment id="13855900" author="abranzyck" created="Mon, 23 Dec 2013 20:15:47 +0000"  >&lt;p&gt;Proposing the patch is not a problem. Adding a test case is not that easy at all, at least for me.&lt;/p&gt;</comment>
                            <comment id="13855904" author="fpj" created="Mon, 23 Dec 2013 20:21:49 +0000"  >&lt;p&gt;Let&apos;s try to think of a test case, and if we can&apos;t come up with anything that is reasonable, I&apos;ll +1 it without the test. Testing races is often difficult, so I&apos;m not surprised that there is no obvious way. Perhaps someone else has an idea for how to do it, though.&lt;/p&gt;</comment>
                            <comment id="13855924" author="hadoopqa" created="Mon, 23 Dec 2013 20:54:37 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12620251/ZOOKEEPER-1179.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12620251/ZOOKEEPER-1179.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1552946.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1860//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1860//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1860//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1860//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1860//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1860//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13856147" author="rakeshr" created="Tue, 24 Dec 2013 05:04:57 +0000"  >&lt;p&gt;Thanks a lot Flavio/German for the help. I&apos;ve tried simulating a case, where it tests the possibility of duplicate closure. Please have a look at the latest patch.&lt;/p&gt;</comment>
                            <comment id="13856158" author="hadoopqa" created="Tue, 24 Dec 2013 05:34:07 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12620307/ZOOKEEPER-1179.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12620307/ZOOKEEPER-1179.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1552946.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1862//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1862//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1862//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1862//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1862//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1862//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13856175" author="abranzyck" created="Tue, 24 Dec 2013 06:14:10 +0000"  >&lt;p&gt;+1 from my side. Excellent test case for this.&lt;/p&gt;</comment>
                            <comment id="13857486" author="fpj" created="Fri, 27 Dec 2013 13:29:58 +0000"  >&lt;p&gt;+1, thanks guys! &lt;/p&gt;

&lt;p&gt;B3.4: Committed revision 1553672.&lt;/p&gt;</comment>
                            <comment id="13857514" author="fpj" created="Fri, 27 Dec 2013 14:57:41 +0000"  >&lt;p&gt;Trunk: Committed revision 1553681.&lt;/p&gt;</comment>
                            <comment id="13857556" author="fpj" created="Fri, 27 Dec 2013 16:53:21 +0000"  >&lt;p&gt;I have made a couple of small fixes to the javadoc of NettyCnxnServerTest, that&apos;s the reason of the two commits after resolving the issue, there is no change to the patch code.&lt;/p&gt;

&lt;p&gt;trunk: Committed revision 1553693.&lt;br/&gt;
b3.4: Committed revision 1553694.&lt;/p&gt;</comment>
                            <comment id="13857998" author="hudson" created="Sat, 28 Dec 2013 11:07:49 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2168 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2168/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2168/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1179&quot; title=&quot;NettyServerCnxn does not properly close socket on 4 letter word requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1179&quot;&gt;&lt;del&gt;ZOOKEEPER-1179&lt;/del&gt;&lt;/a&gt;.  NettyServerCnxn does not properly close socket on 4 letter word requests (Rakesh R, Germ&#225;n Blanco via fpj) (fpj: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1553693&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1553693&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1179&quot; title=&quot;NettyServerCnxn does not properly close socket on 4 letter word requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1179&quot;&gt;&lt;del&gt;ZOOKEEPER-1179&lt;/del&gt;&lt;/a&gt;. NettyServerCnxn does not properly close socket on &lt;br/&gt;
  4 letter word requests (Rakesh R, Germ&#225;n Blanco via fpj) (fpj: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1553681&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1553681&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13858459" author="fpj" created="Sun, 29 Dec 2013 22:07:06 +0000"  >&lt;p&gt;It looks like this patch didn&apos;t completely solve the problem. I was checking the output of the last ZooKeeper-3.4-WinVS2008_java build, and I found the following in the output of testFourLetterWords:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit] 2013-12-29 20:21:43,920 [myid:] - WARN  [New I/O worker #258:NettyServerCnxnFactory$CnxnChannelHandler@111] - Exception caught [id: 0x6e402644, /127.0.0.1:51003 =&amp;gt; /127.0.0.1:11271] EXCEPTION: java.io.IOException: A non-blocking socket operation could not be completed immediately
    [junit] java.io.IOException: A non-blocking socket operation could not be completed immediately
    [junit] 	at sun.nio.ch.SocketDispatcher.close0(Native Method)
    [junit] 	at sun.nio.ch.SocketDispatcher.preClose(SocketDispatcher.java:62)
    [junit] 	at sun.nio.ch.SocketChannelImpl.implCloseSelectableChannel(SocketChannelImpl.java:819)
    [junit] 	at java.nio.channels.spi.AbstractSelectableChannel.implCloseChannel(AbstractSelectableChannel.java:228)
    [junit] 	at java.nio.channels.spi.AbstractInterruptibleChannel.close(AbstractInterruptibleChannel.java:115)
    [junit] 	at org.jboss.netty.channel.socket.nio.AbstractNioWorker.close(AbstractNioWorker.java:354)
    [junit] 	at org.jboss.netty.channel.socket.nio.NioServerSocketPipelineSink.handleAcceptedSocket(NioServerSocketPipelineSink.java:81)
    [junit] 	at org.jboss.netty.channel.socket.nio.NioServerSocketPipelineSink.eventSunk(NioServerSocketPipelineSink.java:36)
    [junit] 	at org.jboss.netty.channel.Channels.close(Channels.java:812)
    [junit] 	at org.jboss.netty.channel.AbstractChannel.close(AbstractChannel.java:197)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxn.close(NettyServerCnxn.java:114)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxn.cleanupWriterSocket(NettyServerCnxn.java:242)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxn.access$000(NettyServerCnxn.java:57)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxn$CommandThread.run(NettyServerCnxn.java:315)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxn$CommandThread.start(NettyServerCnxn.java:306)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxn.checkFourLetterWord(NettyServerCnxn.java:658)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxn.receiveMessage(NettyServerCnxn.java:791)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxnFactory$CnxnChannelHandler.processMessage(NettyServerCnxnFactory.java:211)
    [junit] 	at org.apache.zookeeper.server.NettyServerCnxnFactory$CnxnChannelHandler.messageReceived(NettyServerCnxnFactory.java:135)
    [junit] 	at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268)
    [junit] 	at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255)
    [junit] 	at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88)
    [junit] 	at org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:109)
    [junit] 	at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:312)
    [junit] 	at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:90)
    [junit] 	at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)
    [junit] 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
    [junit] 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
    [junit] 	at java.lang.Thread.run(Thread.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13881822" author="rakeshr" created="Sat, 25 Jan 2014 11:37:04 +0000"  >&lt;p&gt;Hi Flavio,&lt;/p&gt;

&lt;p&gt;After merging &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1238&quot; title=&quot;when the linger time was changed for NIO the patch missed Netty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1238&quot;&gt;&lt;del&gt;ZOOKEEPER-1238&lt;/del&gt;&lt;/a&gt; in 3.4 branch, I&apos;ve observed ZooKeeper-3.4-WinVS2008_java jenkins report from &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-3.4-WinVS2008_java/407/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;build#407 &lt;/a&gt; to the latest &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-3.4-WinVS2008_java/417/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;build#417 &lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;Now &quot;java.io.IOException: A non-blocking socket operation could not be completed immediately&quot; is not occuring any more. If agrees, can we close this one?&lt;/p&gt;</comment>
                            <comment id="13933731" author="fpj" created="Thu, 13 Mar 2014 18:17:01 +0000"  >&lt;p&gt;Closing issues after releasing 3.4.6.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12683243">ZOOKEEPER-1833</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12684468">ZOOKEEPER-1839</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12620307" name="ZOOKEEPER-1179.patch" size="5334" author="rakeshr" created="Tue, 24 Dec 2013 04:56:21 +0000"/>
                            <attachment id="12620251" name="ZOOKEEPER-1179.patch" size="587" author="abranzyck" created="Mon, 23 Dec 2013 20:15:47 +0000"/>
                            <attachment id="12620105" name="ZOOKEEPER-1179.patch" size="2479" author="rakeshr" created="Sun, 22 Dec 2013 20:45:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 22 Dec 2013 20:58:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2390</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzsz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32678</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thanks Rakesh, you are right, this error is not happening anymore. Flavio, I&amp;#39;m closing this.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>