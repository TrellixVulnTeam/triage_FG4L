<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:45:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1683/ZOOKEEPER-1683.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1683] ZooKeeper client NPE when updating server list on disconnected client</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1683</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;2013-04-04 22:16:15,872 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-4-thread-1&amp;#93;&lt;/span&gt; com.netflix.curator.ConnectionState.getZooKeeper (ConnectionState.java:84) - Background exception caught&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.zookeeper.client.StaticHostProvider.updateServerList(StaticHostProvider.java:161) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ZooKeeper.updateServerList(ZooKeeper.java:183) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.netflix.curator.HandleHolder$1$1.setConnectionString(HandleHolder.java:121) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;curator-client-1.3.5-SNAPSHOT.jar:?&amp;#93;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;The duff code is this:&lt;/p&gt;

&lt;p&gt;ClientCnxnSocket clientCnxnSocket = cnxn.sendThread.getClientCnxnSocket();&lt;br/&gt;
InetSocketAddress currentHost = (InetSocketAddress) clientCnxnSocket.getRemoteSocketAddress();&lt;br/&gt;
boolean reconfigMode = hostProvider.updateServerList(serverAddresses, currentHost);&lt;/p&gt;

&lt;p&gt;Now, currentHost might be null, if we&apos;re not yet connected. But StaticHostProvider.updateServerList indirects on it unconditionally.&lt;/p&gt;

&lt;p&gt;This would be caught by findbugs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12640884">ZOOKEEPER-1683</key>
            <summary>ZooKeeper client NPE when updating server list on disconnected client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shralex">Alexander Shraer</assignee>
                                    <reporter username="arren">Shevek</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Apr 2013 23:20:38 +0100</created>
                <updated>Fri, 18 Jul 2014 12:35:00 +0100</updated>
                            <resolved>Thu, 17 Jul 2014 21:58:04 +0100</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>java client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13624039" author="arren" created="Fri, 5 Apr 2013 21:39:04 +0100"  >&lt;p&gt;This may be caused by ClientCnxnSocketNIO.java:&lt;/p&gt;

&lt;p&gt;    void registerAndConnect(SocketChannel sock, InetSocketAddress addr) &lt;br/&gt;
    throws IOException {&lt;br/&gt;
        sockKey = sock.register(selector, SelectionKey.OP_CONNECT);&lt;br/&gt;
        boolean immediateConnect = sock.connect(addr);&lt;br/&gt;
        if (immediateConnect) &lt;/p&gt;
{
            sendThread.primeConnection();
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;In the immediate case, there are several bugs:&lt;/p&gt;

&lt;p&gt;a) updateSocketAddresses() is never called, as it is when the select-loop in doTransport(). This means that clientCnxnSocket.getRemoteSocketAddress() will return null for the lifetime of this socket?&lt;br/&gt;
b) CONNECT still in the interest set for the socket.&lt;br/&gt;
c) updateLastSendAndHeard() is never called either.&lt;/p&gt;</comment>
                            <comment id="13624042" author="arren" created="Fri, 5 Apr 2013 21:42:32 +0100"  >&lt;p&gt;Note that since connect() is called by SendThread, if connect() is NOT immediate ClientCnxn.start() may return immediately, and so the following call sequence will return null:&lt;br/&gt;
zk = new ZooKeeper(...)&lt;br/&gt;
zk.&lt;span class=&quot;error&quot;&gt;&amp;#91;....&amp;#93;&lt;/span&gt;.getRemoteSocketAddress()&lt;/p&gt;

&lt;p&gt;So I think this breaks on both code paths. Perhaps the immediate-case above is a strictly separate bug.&lt;/p&gt;</comment>
                            <comment id="13624048" author="shralex" created="Fri, 5 Apr 2013 21:53:57 +0100"  >&lt;p&gt;Thanks Shevek. I&apos;d like to focus on the bug in updateServerList(), so I think its a good idea to split the other issue into a separate jira.&lt;/p&gt;

&lt;p&gt;For updateServerList() I was at first thinking to treat the case of currentHost being null similarly to the case where the currentHost is not in the new list of servers. But then I realized that this will create imbalance. Now I&apos;m thinking maybe we should look on the server to which the client should have been connected as currentHost and run the algorithm from there. Or maybe if we consider the null case to be very rare we could ignore the imbalance that it can create &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;m still looking into it.&lt;/p&gt;</comment>
                            <comment id="13624086" author="arren" created="Fri, 5 Apr 2013 22:36:11 +0100"  >&lt;p&gt;The trouble is that there&apos;s hidden state in flight. The question is, what is the state of the ZooKeeper client when the constructor returns.&lt;/p&gt;

&lt;p&gt;If it is determined that it has a remote socket address, i.e. updateServerList should be callable as-written, and be safe, then ClientCnxn needs to SYNCHRONOUSLY, i.e. not via SendThread.start() record the &quot;intended&quot; target connection address.&lt;/p&gt;

&lt;p&gt;If we follow the proposal to allow the address to be null in updateServerList, then either:&lt;br/&gt;
a) We nulls (treat it as always in the list), in which case the &quot;invisible&quot; state of the intended server address of the in-flight connect may still allow us to connect to a &quot;wrong&quot; server.&lt;br/&gt;
b) We say a null is never in the list, in which case repeated fast calls to updateServerList could cause a denial of service of the ZooKeeper client.&lt;/p&gt;

&lt;p&gt;The difficulty, I think, is that the state of the client when &quot;new ZooKeeper&quot; returns is defined by a race condition. The INTENT of the connection needs to be recorded in &apos;new ClientCnxn&apos; before SendThread.start() goes asynchronous.&lt;/p&gt;

&lt;p&gt;A somewhat uglier hack might be to make StaticHostProvider cache the previously returned value and give the ClientCnxn a kicking if the cached value was removed from the list. While this would also work, I feel that it would contribute negatively to the overall complexity and coupledness of the code.&lt;/p&gt;</comment>
                            <comment id="13624089" author="arren" created="Fri, 5 Apr 2013 22:39:18 +0100"  >&lt;p&gt;TL;DR: It should never be null. That&apos;s the bug. When &quot;new ZooKeeper()&quot; returns, we know which host we intend to connect to. We just don&apos;t have that information due to a sequence of bugs and races.&lt;/p&gt;</comment>
                            <comment id="13624773" author="shralex" created="Sun, 7 Apr 2013 08:35:45 +0100"  >&lt;p&gt;The patch fixes the problem of currentHost being null and also handles the case of updateServerList being called twice, without migration completing in between the calls. This case wasn&apos;t previously handled.&lt;/p&gt;

&lt;p&gt;The idea is that if migration hasn&apos;t completed yet, and updateServerList is called again, we need to complete it &quot;virtually&quot; - we don&apos;t need to connect to the new server, but we should figure out where we should connect to. This is the case whether or not currentHost is null.&lt;/p&gt;

&lt;p&gt;If migration is not in progress, and currentHost is null, we should look on the last host to which the client was connected, or the first host in the list in case it hasn&apos;t connected to any host yet. &lt;/p&gt;</comment>
                            <comment id="13624784" author="hadoopqa" created="Sun, 7 Apr 2013 09:15:57 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12577438/ZOOKEEPER-1683.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12577438/ZOOKEEPER-1683.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1463329.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 3 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1447//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1447//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1447//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1447//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1447//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1447//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13624992" author="hadoopqa" created="Sun, 7 Apr 2013 19:35:30 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12577457/ZOOKEEPER-1683-ver1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12577457/ZOOKEEPER-1683-ver1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1463329.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1448//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1448//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1448//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1448//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1448//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1448//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13625596" author="arren" created="Mon, 8 Apr 2013 18:52:25 +0100"  >&lt;p&gt;+       		if (lastIndex &amp;gt;=0) {&lt;br/&gt;
+            	// take the last server to which we were connected&lt;br/&gt;
+       			myServer = this.serverAddresses.get(lastIndex);&lt;/p&gt;

&lt;p&gt;I don&apos;t see why this is guaranteed not to throw an IndexOutOfBoundsException. There is no relationship between lastIndex from the previous server list, and serverAddresses, the new server list.&lt;/p&gt;</comment>
                            <comment id="13625598" author="arren" created="Mon, 8 Apr 2013 18:54:56 +0100"  >&lt;p&gt;Withdraw that; it&apos;s the previous server list.&lt;/p&gt;</comment>
                            <comment id="13625605" author="shralex" created="Mon, 8 Apr 2013 19:03:16 +0100"  >&lt;p&gt;exactly. thanks for reviewing, Shevek!&lt;/p&gt;</comment>
                            <comment id="13627493" author="arren" created="Wed, 10 Apr 2013 06:23:51 +0100"  >&lt;p&gt;Actual testing failed, when first connected to invalid server, then attempting to update to valid server.&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxnSocketNIO.testableCloseSocket(ClientCnxnSocketNIO.java:376) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ZooKeeper.updateServerList(ZooKeeper.java:187) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="13627495" author="arren" created="Wed, 10 Apr 2013 06:26:10 +0100"  >&lt;p&gt;sockKey == null, because previously:&lt;/p&gt;

&lt;p&gt;2013-04-10 05:19:52,787 WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;main-SendThread(localhost:2181)&amp;#93;&lt;/span&gt; org.apache.zookeeper.ClientCnxn$SendThread.run (ClientCnxn.java:1122&lt;br/&gt;
) - Session 0x0 for server null, unexpected error, closing socket connection and attempting reconnect&lt;br/&gt;
java.net.ConnectException: Connection refused&lt;br/&gt;
        at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.6.0_24&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:592) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.6.0_24&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:353) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1101) &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-04-10 05:19:52,788 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;main-SendThread(localhost:2181)&amp;#93;&lt;/span&gt; org.apache.zookeeper.ClientCnxnSocketNIO.cleanup (ClientCnxnSocketNI&lt;br/&gt;
O.java:193) - Ignoring exception during shutdown input&lt;br/&gt;
java.nio.channels.ClosedChannelException&lt;br/&gt;
        at sun.nio.ch.SocketChannelImpl.shutdownInput(SocketChannelImpl.java:656) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.6.0_24&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at sun.nio.ch.SocketAdaptor.shutdownInput(SocketAdaptor.java:378) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.6.0_24&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxnSocketNIO.cleanup(ClientCnxnSocketNIO.java:190) &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$SendThread.cleanup(ClientCnxn.java:1190) &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1130) &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-04-10 05:19:52,789 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;main-SendThread(localhost:2181)&amp;#93;&lt;/span&gt; org.apache.zookeeper.ClientCnxnSocketNIO.cleanup (ClientCnxnSocketNI&lt;br/&gt;
O.java:200) - Ignoring exception during shutdown output&lt;br/&gt;
java.nio.channels.ClosedChannelException&lt;br/&gt;
        at sun.nio.ch.SocketChannelImpl.shutdownOutput(SocketChannelImpl.java:667) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.6.0_24&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at sun.nio.ch.SocketAdaptor.shutdownOutput(SocketAdaptor.java:386) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.6.0_24&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxnSocketNIO.cleanup(ClientCnxnSocketNIO.java:197) &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$SendThread.cleanup(ClientCnxn.java:1190) &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1130) &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-3.5.0.jar:3.5.0--1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;thus clearing sockKey.&lt;/p&gt;</comment>
                            <comment id="13628075" author="marshall" created="Wed, 10 Apr 2013 19:28:17 +0100"  >&lt;p&gt;I reviewed these changes as well and they look good to me. A few observations:&lt;/p&gt;

&lt;p&gt;1) I definitely like the additional tests. &lt;br/&gt;
2) Is there any documentation in the doxygen regarding selection of the next server that needs to be updated? &lt;br/&gt;
3) Have you looked at Shevek&apos;s real-world testing failure he saw above?&lt;br/&gt;
4) I&apos;m going to look at the related C code now to see if the same problems exist over there.&lt;/p&gt;

</comment>
                            <comment id="13628094" author="marshall" created="Wed, 10 Apr 2013 19:37:21 +0100"  >&lt;p&gt;The C client code doesn&apos;t suffer from this bug. It already deals gracefully with the current host being null and for zoo_set_servers being called twice before the reconfig completes. So I think we&apos;re good in the C client side already.&lt;/p&gt;</comment>
                            <comment id="13628603" author="shralex" created="Thu, 11 Apr 2013 03:23:24 +0100"  >&lt;p&gt;thanks Shevek and Marshall!&lt;/p&gt;

&lt;p&gt;seems like first sockkey is set, then remoteSocketAddress is set.&lt;br/&gt;
should we be checking for both before attempting to close the socket or just for sockkey != null ?&lt;/p&gt;</comment>
                            <comment id="13628622" author="arren" created="Thu, 11 Apr 2013 04:03:12 +0100"  >&lt;p&gt;I think you can&apos;t just check isConnected() / sockKey != null because it&apos;s being set to null on a different thread, so then there will be a race for the NPE instead of just an NPE.&lt;/p&gt;

&lt;p&gt;One of the other issues with this thread contract, where values are set within an object which is accessible to more than one thread is that JSR133 says that assignments performed in constructors do not happen-before the constructor returns unless the variable being assigned is final. Since ClientCnxnNIO is accessible to more than one thread at the point variables like sockKey are initialized, I suspect the code violates the JMM anyway.&lt;/p&gt;

&lt;p&gt;A much better solution would be to use more immutable variables, and discard and reconstruct objects rather than attempting to modify them. An ideal solution would be to use something like netty, which is designed to handle and abstract all these cases.&lt;/p&gt;</comment>
                            <comment id="13628640" author="shralex" created="Thu, 11 Apr 2013 04:45:22 +0100"  >&lt;p&gt;I see. There&apos;s actually a comment there in the code &quot;should this be synchronized?&quot; and the answer is probably yes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;How about making sockKey volatile ?&lt;/p&gt;</comment>
                            <comment id="13628652" author="arren" created="Thu, 11 Apr 2013 05:12:02 +0100"  >&lt;p&gt;volatile causes a write-read pair of the variable to form a transitive happen-before relationship in the JMM. It does not solve the race - we (A) could check sockKey != null, then the close() (B) could clear it, then we (A) indirect on it, and we have an ABA race.&lt;/p&gt;

&lt;p&gt;Personally, I would probably change testableCloseSocket to load sockKey into a temporary local, then test for nullness of the local before indirecting on that. No synchronization needed, and pointer assignment is always atomic, even in 64-bit JVMs.&lt;/p&gt;</comment>
                            <comment id="13628654" author="shralex" created="Thu, 11 Apr 2013 05:17:10 +0100"  >&lt;p&gt;you&apos;re right of course. do you mind adding your proposed solution to my patch ?&lt;/p&gt;</comment>
                            <comment id="13629780" author="arren" created="Fri, 12 Apr 2013 05:26:39 +0100"  >&lt;p&gt;It&apos;s going to be a while, I&apos;m afraid; I&apos;m flying every other day for a bit. Right now, I just catch the NPE in upstream code and reset totally, ditching the session. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13630860" author="shralex" created="Sat, 13 Apr 2013 02:42:18 +0100"  >&lt;p&gt;addresses the race using a local variable as suggested&lt;/p&gt;</comment>
                            <comment id="13630868" author="hadoopqa" created="Sat, 13 Apr 2013 03:21:38 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12578570/ZOOKEEPER-1683-ver2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12578570/ZOOKEEPER-1683-ver2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1463329.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1457//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1457//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1457//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1457//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1457//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1457//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13630869" author="shralex" created="Sat, 13 Apr 2013 03:24:55 +0100"  >&lt;p&gt;resubmitting as previous test result hits &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1629&quot; title=&quot;testTransactionLogCorruption occasionally fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1629&quot;&gt;&lt;del&gt;ZOOKEEPER-1629&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13630903" author="hadoopqa" created="Sat, 13 Apr 2013 04:03:39 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12578573/ZOOKEEPER-1683-ver2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12578573/ZOOKEEPER-1683-ver2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1463329.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1458//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1458//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1458//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1458//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1458//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1458//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13630952" author="hadoopqa" created="Sat, 13 Apr 2013 06:45:47 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12578583/ZOOKEEPER-1683-ver2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12578583/ZOOKEEPER-1683-ver2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1463329.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1459//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1459//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1459//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1459//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1459//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1459//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13633751" author="shralex" created="Wed, 17 Apr 2013 05:19:38 +0100"  >&lt;p&gt;Shevek, can you please see if it looks ok / solves the bug ?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Alex&lt;/p&gt;</comment>
                            <comment id="13634365" author="arren" created="Wed, 17 Apr 2013 21:01:14 +0100"  >&lt;p&gt;I think it looks OK.&lt;/p&gt;

&lt;p&gt;We put the code into production on several clusters on Monday afternoon, and we&apos;re waiting on results. It&apos;s a bit early to promise anything from tests.&lt;/p&gt;

&lt;p&gt;I&apos;m still somewhat unhappy with the client code overall, as I don&apos;t think the contracts of many of the states are clear enough to definitively claim correctness.&lt;/p&gt;</comment>
                            <comment id="13634385" author="shralex" created="Wed, 17 Apr 2013 21:32:47 +0100"  >&lt;p&gt;very glad to hear you&apos;re running client-side reconfiguration in production!!&lt;/p&gt;</comment>
                            <comment id="13704154" author="shralex" created="Wed, 10 Jul 2013 04:10:32 +0100"  >&lt;p&gt;Shevek, did this patch resolve the issue ?&lt;/p&gt;</comment>
                            <comment id="14045036" author="fournc" created="Thu, 26 Jun 2014 20:15:55 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;Alexander Shraer&lt;/a&gt; This looks like a +1 to me, since you created the original patch do you want to check this in?&lt;/p&gt;</comment>
                            <comment id="14045089" author="hadoopqa" created="Thu, 26 Jun 2014 21:02:15 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12578583/ZOOKEEPER-1683-ver2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12578583/ZOOKEEPER-1683-ver2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1605517.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2154//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2154//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2154//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2154//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2154//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2154//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14051821" author="shralex" created="Thu, 3 Jul 2014 20:02:48 +0100"  >&lt;p&gt;rebasing for trunk&lt;/p&gt;</comment>
                            <comment id="14051855" author="hadoopqa" created="Thu, 3 Jul 2014 20:51:55 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12653978/ZOOKEEPER-1683-ver3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12653978/ZOOKEEPER-1683-ver3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1607525.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 2 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2171//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2171//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2171//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2171//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2171//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2171//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14051925" author="hadoopqa" created="Thu, 3 Jul 2014 22:21:14 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12653989/ZOOKEEPER-1683-ver5.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12653989/ZOOKEEPER-1683-ver5.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1607525.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2172//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2172//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2172//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2172//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2172//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2172//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14052017" author="shralex" created="Fri, 4 Jul 2014 00:53:06 +0100"  >&lt;p&gt;tests pass locally, trying to trigger hudson tests again&lt;/p&gt;</comment>
                            <comment id="14052052" author="hadoopqa" created="Fri, 4 Jul 2014 01:41:28 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12654013/ZOOKEEPER-1683-ver5.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12654013/ZOOKEEPER-1683-ver5.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1607525.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2174//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2174//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2174//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2174//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2174//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2174//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14052058" author="hadoopqa" created="Fri, 4 Jul 2014 01:51:14 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12654014/ZOOKEEPER-1683-ver6.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12654014/ZOOKEEPER-1683-ver6.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1607525.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2175//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2175//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2175//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2175//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2175//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2175//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14052064" author="shralex" created="Fri, 4 Jul 2014 02:03:59 +0100"  >&lt;p&gt;Looks fine now, not sure but perhaps the failure was related to zktest-mt failures we&apos;ve been seeing.&lt;br/&gt;
In any case, I added a more meaningful message so that if this fails in the same place we have more info.&lt;br/&gt;
Any objections that I commit this ? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fournc&quot; class=&quot;user-hover&quot; rel=&quot;fournc&quot;&gt;Camille Fournier&lt;/a&gt; can you please have another look ?&lt;/p&gt;</comment>
                            <comment id="14052952" author="rakeshr" created="Sat, 5 Jul 2014 20:47:25 +0100"  >&lt;p&gt;Sorry for pitch in late. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;Alexander Shraer&lt;/a&gt; for the patch. Could you please correct the code format too.&lt;/p&gt;

&lt;p&gt;1) &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; +        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tmp!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;could be &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tmp != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2) &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastIndex &amp;gt;=0) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;could be  &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastIndex &amp;gt;= 0) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3) Moved the sync block to method level. I hope you have skipped the formatting of this code section just to reduce the changes in patch, but I&apos;d prefer to correct this section too.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4) &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; addr.getAddress()!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; myServer.getAddress()!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;could be &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; addr.getAddress() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; myServer.getAddress() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5) I could see tabs in many places, please use spaces instead of this. Below is one such case.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the client is not currently connected to any server
&lt;/span&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (myServer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+        	&lt;span class=&quot;code-comment&quot;&gt;// reconfigMode = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; (next shouldn&apos;t &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).       	
&lt;/span&gt;+       		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastIndex &amp;gt;=0) {
+            	&lt;span class=&quot;code-comment&quot;&gt;// take the last server to which we were connected
&lt;/span&gt;+       			myServer = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverAddresses.get(lastIndex);
+       		}
+       		&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+       			&lt;span class=&quot;code-comment&quot;&gt;// take the first server on the list
&lt;/span&gt;+       			myServer = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverAddresses.get(0);
+       		}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;6) Also, I could see many whitespaces in the patch. Kindly remove these. Below are few such cases:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        
+        InetSocketAddress myServer = currentHost;
+        
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+            lastIndex = currentIndex;              
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        newList = getServerAddresses((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) 9);
+        
+        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; numClients; i++) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14054170" author="shralex" created="Mon, 7 Jul 2014 22:38:16 +0100"  >&lt;p&gt;Thanks Rakesh. Attaching another patch that addresses most of the formatting issues.&lt;/p&gt;</comment>
                            <comment id="14054242" author="hadoopqa" created="Mon, 7 Jul 2014 23:21:51 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12654378/ZOOKEEPER-1683-ver7.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12654378/ZOOKEEPER-1683-ver7.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1607774.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2178//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2178//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2178//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2178//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2178//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2178//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14065539" author="michim" created="Thu, 17 Jul 2014 21:58:04 +0100"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1611474&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1611474&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14066285" author="hudson" created="Fri, 18 Jul 2014 12:35:00 +0100"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2376 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2376/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2376/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1683&quot; title=&quot;ZooKeeper client NPE when updating server list on disconnected client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1683&quot;&gt;&lt;del&gt;ZOOKEEPER-1683&lt;/del&gt;&lt;/a&gt;. ZooKeeper client NPE when updating server list on disconnected client (shralex via michim) (michim: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1611474&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1611474&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/c/tests/TestReconfig.cc&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/client/StaticHostProvider.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/StaticHostProviderTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12641134">ZOOKEEPER-1684</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12537824">ZOOKEEPER-1355</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12639227">CURATOR-7</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12642354">CURATOR-15</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12577457" name="ZOOKEEPER-1683-ver1.patch" size="13800" author="shralex" created="Sun, 7 Apr 2013 18:55:02 +0100"/>
                            <attachment id="12578583" name="ZOOKEEPER-1683-ver2.patch" size="14631" author="shralex" created="Sat, 13 Apr 2013 06:09:34 +0100"/>
                            <attachment id="12578573" name="ZOOKEEPER-1683-ver2.patch" size="14631" author="shralex" created="Sat, 13 Apr 2013 03:24:55 +0100"/>
                            <attachment id="12654013" name="ZOOKEEPER-1683-ver5.patch" size="14461" author="shralex" created="Fri, 4 Jul 2014 00:53:06 +0100"/>
                            <attachment id="12653989" name="ZOOKEEPER-1683-ver5.patch" size="14461" author="shralex" created="Thu, 3 Jul 2014 21:40:00 +0100"/>
                            <attachment id="12654014" name="ZOOKEEPER-1683-ver6.patch" size="15332" author="shralex" created="Fri, 4 Jul 2014 01:09:32 +0100"/>
                            <attachment id="12654378" name="ZOOKEEPER-1683-ver7.patch" size="19855" author="shralex" created="Mon, 7 Jul 2014 22:38:16 +0100"/>
                            <attachment id="12577438" name="ZOOKEEPER-1683.patch" size="13174" author="shralex" created="Sun, 7 Apr 2013 08:35:45 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 5 Apr 2013 20:53:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>321343</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzdamn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>321688</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>