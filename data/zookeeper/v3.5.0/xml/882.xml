<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:45:18 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-882/ZOOKEEPER-882.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-882] Startup loads last transaction from snapshot</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-882</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;On startup, the server first loads the latest snapshot, and then loads from the log starting at the last transaction in the snapshot.  It should begin from one past that last transaction in the log.  I will attach a possible patch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12475365">ZOOKEEPER-882</key>
            <summary>Startup loads last transaction from snapshot</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jaredc">Jared Cantwell</assignee>
                                    <reporter username="jaredc">Jared Cantwell</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Sep 2010 00:46:36 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:29 +0000</updated>
                            <resolved>Thu, 23 Dec 2010 12:43:17 +0000</resolved>
                                                    <fixVersion>3.3.3</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12915972" author="jaredc" created="Wed, 29 Sep 2010 00:48:31 +0100"  >&lt;p&gt;A simple patch for consideration.&lt;/p&gt;</comment>
                            <comment id="12916065" author="fpj" created="Wed, 29 Sep 2010 08:50:46 +0100"  >&lt;p&gt;Hi Jared, Thanks for bringing this up. It doesn&apos;t look like that extra call to next() is necessary. If there is another file to process, then the call to next will return true and we will keep processing transactions, no? &lt;/p&gt;</comment>
                            <comment id="12916070" author="fpj" created="Wed, 29 Sep 2010 09:13:43 +0100"  >&lt;p&gt;I&apos;m also not clear on your second point. If you check FileTxnIterator.init(), then it seems to me that the zxid passed as a parameter should be included, so not dt.lastProcessedZxid+1. What am I missing?&lt;/p&gt;</comment>
                            <comment id="12916122" author="jaredc" created="Wed, 29 Sep 2010 13:42:06 +0100"  >&lt;p&gt;Maybe I am misunderstanding the FileTxnLog.next() call, but I interpret the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Based on its usage, the next() call should prepare the next hdr and record, and return true if it did this successfully, and false otherwise.&lt;/li&gt;
	&lt;li&gt;if the catch() executes, it means that we couldn&apos;t prepare from the current file, so we need to move to the next&lt;/li&gt;
	&lt;li&gt;goToNextLog() simply swaps the log file, but does not prepare hdr and record, so the current ones will remain current and get processed a second time&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If any of this is wrong, than my patch probably doesn&apos;t make sense, so please let me know.&lt;/p&gt;

&lt;p&gt;As far as the second point, I agree that init() is inclusive.  So you want to pass in as a parameter something that has not yet been processed.  So, if we pass in lastProcessedZxid (which is already in the snapshot), then that will be read from the log also since init() starts at that transaction, not one past it.  Is that right?&lt;/p&gt;</comment>
                            <comment id="12916145" author="fpj" created="Wed, 29 Sep 2010 14:47:40 +0100"  >&lt;p&gt;I agree with your description of the behavior of next, and sounds right to me that we should be setting hdr and calling &quot;return next();&quot; at the end of the catch block.&lt;/p&gt;

&lt;p&gt;Regarding init(), we first use the value of zxid to determine which log files to read: all log files tagged with a value higher than zxid and the last log file that is less than zxid. Next we iterate over the log files until hdr.getZxid() is greater or equal to zxid (should be zxid really). This guarantees that the next call to next(), after init() returns, will return zxid+1. Does it sound right to you?&lt;/p&gt;</comment>
                            <comment id="12916150" author="jaredc" created="Wed, 29 Sep 2010 14:58:07 +0100"  >&lt;p&gt;On second look, I agree with the way that works.  I think the bug in fact is later in FileSnapLog.restore() because next() is never called before the loop starts executing, so the first transaction processed is the one that TxnLog was initialized with.  Do you see that also?&lt;/p&gt;</comment>
                            <comment id="12916164" author="jaredc" created="Wed, 29 Sep 2010 15:51:34 +0100"  >&lt;p&gt;Maybe restore() should look like the attached (not a diff) instead.  &lt;/p&gt;</comment>
                            <comment id="12916410" author="fpj" created="Thu, 30 Sep 2010 09:29:25 +0100"  >&lt;p&gt;(I meant to post a comment yesterday, but jira decided to re-index right at the time)&lt;/p&gt;

&lt;p&gt;I like the way you structured the restore loop, it is simpler and easier to read, and I can&apos;t find any problem with it. About the severity of the bug, my interpretation is that it is harmless to re-execute the transaction, but still worth proposing a patch.&lt;/p&gt;</comment>
                            <comment id="12921146" author="jaredc" created="Thu, 14 Oct 2010 23:00:25 +0100"  >&lt;p&gt;Patch to incorporate recommended changes.&lt;/p&gt;</comment>
                            <comment id="12927640" author="fpj" created="Tue, 2 Nov 2010 21:58:43 +0000"  >&lt;p&gt;Hi Jared, I was wondering if you can add a test case to your patch.&lt;/p&gt;</comment>
                            <comment id="12927904" author="jaredc" created="Wed, 3 Nov 2010 17:09:34 +0000"  >&lt;p&gt;Sure Flavio.  I have a test ready, but I have a question for you.  In order to make the test illustrate the bug in the current version, it needs to be changed slightly (~3 lines).  Otherwise, it will still fail with the current version, but for the wrong reason.  It does, however, verify that transactions are loaded correctly, and once, with the patch.  How should I handle this?  I was thinking about posting a version of the test for people to verify that this truly is a bug, and then submitting the real test with the patch.  How does that sound?&lt;/p&gt;</comment>
                            <comment id="12927909" author="fpj" created="Wed, 3 Nov 2010 17:33:23 +0000"  >&lt;p&gt;If I understand correctly what you&apos;re proposing, I think it won&apos;t be necessary to submit two separate patches. To verify that the test fails without the patch, I can simply add the test without applying any other modification in the patch file, and then run the test. After applying the modifications to the code base, I&apos;d be able to verify that the test does not fail any longer. Does it sound right to you?&lt;/p&gt;</comment>
                            <comment id="12927912" author="jaredc" created="Wed, 3 Nov 2010 17:38:16 +0000"  >&lt;p&gt;Sorry, I don&apos;t think I was clear.  That makes sense, but I was saying that if you only apply the test then it will fail (as expected), but for the wrong reason.  Due to the loop restructuring, and the semantics of the change, a test to illustrate the current bug would need to be slightly different (~3 lines) than the test I would submit to illustrate correct functionality after the patch.  &lt;/p&gt;</comment>
                            <comment id="12928013" author="fpj" created="Wed, 3 Nov 2010 21:34:13 +0000"  >&lt;p&gt;Ok, got it. I agree that it makes sense to submit both. Just name the patch file including the verification test differently and explain the difference in the jira.&lt;/p&gt;</comment>
                            <comment id="12928227" author="jaredc" created="Thu, 4 Nov 2010 14:41:43 +0000"  >&lt;p&gt;Submitting a unit test that illustrates the bug and confirms that transactions are loaded multiple times when moving to the next log file.  This test ignores FileTxnSnapLog and focuses on the behavior of FileTxnLog for the moment.  &lt;/p&gt;</comment>
                            <comment id="12972548" author="fpj" created="Fri, 17 Dec 2010 17:19:27 +0000"  >&lt;p&gt;Hi Jared, What&apos;s the status of this patch? Do you think you can produce a patch for review and submit it?&lt;/p&gt;</comment>
                            <comment id="12972553" author="jaredc" created="Fri, 17 Dec 2010 17:33:44 +0000"  >&lt;p&gt;Flavio,  I hit a wall with this a few weeks ago and haven&apos;t had a chance to look at it again.  I have almost everything in place, except I remember there being an issue on the very first log.  I&apos;ll look at it again and report back soon.&lt;/p&gt;</comment>
                            <comment id="12972667" author="jaredc" created="Fri, 17 Dec 2010 22:11:10 +0000"  >&lt;p&gt;Flavio, so I figured out what was holding me up before.  In an earlier comment you said the following, &quot;Regarding init(), we first use the value of zxid to determine which log files to read: all log files tagged with a value higher than zxid and the last log file that is less than zxid. Next we iterate over the log files until hdr.getZxid() is greater or equal to zxid (should be zxid really). This guarantees that the next call to next(), after init() returns, will return zxid+1.&quot;  This is true almost all the time.  It is true when we have the requested zxid in our log, but NOT if the very first log entry is zxid+1, which can easily be the case in almost any startup scenario.  I am betting that the loop in restore() was originally planned to be coded as you stated (by initializing with last lastProcessedTxnID and then calling next()), but then the issue I mentioned came up and it was decided it was ok to just use the first header, and call next afterward.  Without rewriting parts of the TxnIterator, I don&apos;t think restructuring that loop in restore() is simple.  Therefore, I propose that we simply request lastProcessedZxid+1 from the log initially (which is guaranteed to either be present, or have no entries at all in the log).  I am about to submit a patch, with a unittest for this.&lt;/p&gt;</comment>
                            <comment id="12972668" author="jaredc" created="Fri, 17 Dec 2010 22:11:58 +0000"  >&lt;p&gt;Attaching patch described in previous comment.&lt;/p&gt;</comment>
                            <comment id="12972680" author="hadoopqa" created="Fri, 17 Dec 2010 22:42:49 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12466505/ZOOKEEPER-882.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12466505/ZOOKEEPER-882.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1049401.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 9 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://hudson.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/70//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/70//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://hudson.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/70//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/70//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://hudson.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/70//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/70//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12972685" author="jaredc" created="Fri, 17 Dec 2010 23:06:45 +0000"  >&lt;p&gt;Also, somewhat related to this patch, I think the TxnIterator should implement java.util.Iterator, not its own strange version of it. A call to next() should return a TxnFileEntry which wraps the TxnHeader and Record.  That&apos;s probably for another patch and a later version though, but just wanted to mention it.&lt;/p&gt;</comment>
                            <comment id="12974582" author="fpj" created="Thu, 23 Dec 2010 09:26:47 +0000"  >&lt;p&gt;+1, looks good, Jared. On the Iterator issue you mention, would you mind creating a jira for it?&lt;/p&gt;</comment>
                            <comment id="12974609" author="fpj" created="Thu, 23 Dec 2010 12:43:16 +0000"  >&lt;p&gt;Committed revision 1052244.&lt;/p&gt;

&lt;p&gt;Thanks again, Jared.&lt;/p&gt;</comment>
                            <comment id="12974890" author="hudson" created="Fri, 24 Dec 2010 10:52:27 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1046 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/1046/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/ZooKeeper-trunk/1046/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-882&quot; title=&quot;Startup loads last transaction from snapshot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-882&quot;&gt;&lt;del&gt;ZOOKEEPER-882&lt;/del&gt;&lt;/a&gt;. Startup loads last transaction from snapshot (jared via fpj)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12455887" name="882.diff" size="1407" author="jaredc" created="Wed, 29 Sep 2010 00:48:31 +0100"/>
                            <attachment id="12458819" name="FailureTest-882.patch" size="4811" author="jaredc" created="Thu, 4 Nov 2010 14:41:43 +0000"/>
                            <attachment id="12466505" name="ZOOKEEPER-882.patch" size="6398" author="jaredc" created="Fri, 17 Dec 2010 22:11:58 +0000"/>
                            <attachment id="12457196" name="ZOOKEEPER-882.patch" size="1988" author="jaredc" created="Thu, 14 Oct 2010 23:00:24 +0100"/>
                            <attachment id="12455920" name="restore" size="840" author="jaredc" created="Wed, 29 Sep 2010 15:51:34 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Sep 2010 07:50:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47565</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxztxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>