<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:40:15 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1702/ZOOKEEPER-1702.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1702] ZooKeeper client may write operation packets before receiving successful response to connection request, can cause TCP RST</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1702</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The problem occurs when a connection attempt is pending and there are multiple outbound packets in the queue for other operations.  In &lt;tt&gt;ClientCnxnSocketNIO#doIO&lt;/tt&gt;, it is possible to receive notification that the socket is writable for the next operation packet before receiving notification that the socket is readable for the connection response from the server.  If the server decides that the session is expired, then it responds by immediately closing the socket on its side.  If the client has written packets after the server has closed its end of the socket, then the TCP stack may choose to abort the connection with an RST.  When this happens, the client doesn&apos;t receive an orderly shutdown, and ultimately it fails to deliver a session expired event to the application.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646860">ZOOKEEPER-1702</key>
            <summary>ZooKeeper client may write operation packets before receiving successful response to connection request, can cause TCP RST</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cnauroth">Chris Nauroth</assignee>
                                    <reporter username="cnauroth">Chris Nauroth</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 May 2013 21:24:17 +0100</created>
                <updated>Thu, 13 Mar 2014 18:17:13 +0000</updated>
                            <resolved>Tue, 2 Jul 2013 00:24:41 +0100</resolved>
                                    <version>3.4.2</version>
                                    <fixVersion>3.4.6</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>java client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13653144" author="cnauroth" created="Thu, 9 May 2013 21:26:12 +0100"  >&lt;p&gt;The last several paragraphs here explain the general problem pretty well:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://docs.oracle.com/javase/6/docs/technotes/guides/net/articles/connection_release.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://docs.oracle.com/javase/6/docs/technotes/guides/net/articles/connection_release.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For whatever reason, I&apos;m having a much easier time reproducing the ultimate problem (the TCP RST) on Windows instead of Linux or OS X.  In Hadoop Common, we see test failures on Windows pretty consistently in test suites like &lt;tt&gt;TestActiveStandbyElectorRealZK&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13653148" author="cnauroth" created="Thu, 9 May 2013 21:27:12 +0100"  >&lt;p&gt;I&apos;m attaching a patch that disables write interest on the client socket&apos;s selection key right after sending the initial connection request packet.  Write interest gets restored later after successful completion of the connection.  With this patch in place, the failing tests in Hadoop Common pass consistently on mutliple platforms: OS X, Linux, and Windows.&lt;/p&gt;

&lt;p&gt;I tried to write a test for this.  Unfortunately, none of my attempts at a functional test were able to reproduce the problem, and my attempt at mocking broke down when I discovered that &lt;tt&gt;SocketChannel#register&lt;/tt&gt; is final and therefore can&apos;t be mocked.  Existing test suites passed for me after the patch.&lt;/p&gt;

&lt;p&gt;The same patch can apply to both trunk and branch-3.4.&lt;/p&gt;</comment>
                            <comment id="13653202" author="hadoopqa" created="Thu, 9 May 2013 22:05:17 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12582508/ZOOKEEPER-1702.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12582508/ZOOKEEPER-1702.1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1463329.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1475//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1475//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1475//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1475//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1475//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1475//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13653288" author="cnauroth" created="Thu, 9 May 2013 23:03:12 +0100"  >&lt;blockquote&gt;
&lt;p&gt;-1 tests included. The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
Please justify why no new tests are needed for this patch.&lt;br/&gt;
Also please list what manual steps were performed to verify this patch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;See earlier comment.  I couldn&apos;t come up with a functional test that could repro the problem, and some of the internal classes involved can&apos;t be mocked.  This patch does get some failing tests in Hadoop Common to pass consistently.&lt;/p&gt;</comment>
                            <comment id="13653329" author="phunt" created="Thu, 9 May 2013 23:37:14 +0100"  >&lt;p&gt;Nice one, thanks Chris. Is this issue something we should consider for the C client as well, or is it java specific?&lt;/p&gt;</comment>
                            <comment id="13653397" author="cnauroth" created="Fri, 10 May 2013 00:59:42 +0100"  >&lt;p&gt;Thanks, Patrick.  I hadn&apos;t considered the C client until now.  This is more of a general socket programming issue than a Java-specific issue, so in theory the bug could be there too.&lt;/p&gt;

&lt;p&gt;From a very quick glance at the C code, I couldn&apos;t find the bug there.  I&apos;m basing that statement on the fact that &lt;tt&gt;zookeeper_interest&lt;/tt&gt; only turns on write interest while connecting or after fully connected:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        /* we are interested in a write &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are connected and have something
         * to send, or we are waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a connect to finish. */
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((zh-&amp;gt;to_send.head &amp;amp;&amp;amp; (zh-&amp;gt;state == ZOO_CONNECTED_STATE))
        || zh-&amp;gt;state == ZOO_CONNECTING_STATE) {
            *interest |= ZOOKEEPER_WRITE;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And it only enters &lt;tt&gt;ZOO_CONNECTED_STATE&lt;/tt&gt; after successful negotation of connection and checking session inside &lt;tt&gt;check_events&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                oldid = zh-&amp;gt;client_id.client_id;
                newid = zh-&amp;gt;primer_storage.sessionId;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldid != 0 &amp;amp;&amp;amp; oldid != newid) {
                    zh-&amp;gt;state = ZOO_EXPIRED_SESSION_STATE;
                    errno = ESTALE;
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; handle_socket_error_msg(zh,__LINE__,ZSESSIONEXPIRED,
                            &lt;span class=&quot;code-quote&quot;&gt;&quot;sessionId=%#llx has expired.&quot;&lt;/span&gt;,oldid);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    zh-&amp;gt;recv_timeout = zh-&amp;gt;primer_storage.timeOut;
                    zh-&amp;gt;client_id.client_id = newid;
                 
                    memcpy(zh-&amp;gt;client_id.passwd, &amp;amp;zh-&amp;gt;primer_storage.passwd,
                           sizeof(zh-&amp;gt;client_id.passwd));
                    zh-&amp;gt;state = ZOO_CONNECTED_STATE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Therefore, I don&apos;t think the C client has the bug.  At least that&apos;s my very naive take on it after a whole 10 minutes reading the code.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;On the Java side, the logic was different in that it would immediately turn on both read and write interest in &lt;tt&gt;ClientCnxn#SendThread#primeConnection&lt;/tt&gt;, and leave write interest on until the outgoing queue got drained.&lt;/p&gt;</comment>
                            <comment id="13688406" author="cnauroth" created="Wed, 19 Jun 2013 21:26:32 +0100"  >&lt;p&gt;I&apos;m interested in getting this patch into a ZooKeeper release and upgrading to that release in Hadoop core to enable some functionality that&apos;s currently broken on Windows.  Is there anything more I can do to help move this patch forward?  Thanks!&lt;/p&gt;</comment>
                            <comment id="13688487" author="phunt" created="Wed, 19 Jun 2013 22:29:39 +0100"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;Chris Nauroth&lt;/a&gt; I&apos;ll see what I can do - I added this to my toreview list.&lt;/p&gt;</comment>
                            <comment id="13688515" author="hadoopqa" created="Wed, 19 Jun 2013 22:59:06 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12582508/ZOOKEEPER-1702.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12582508/ZOOKEEPER-1702.1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1490358.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1502//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1502//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1502//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1502//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1502//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1502//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13688583" author="cnauroth" created="Wed, 19 Jun 2013 23:46:23 +0100"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;Patrick Hunt&lt;/a&gt;.  I appreciate it!&lt;/p&gt;</comment>
                            <comment id="13697323" author="phunt" created="Tue, 2 Jul 2013 00:24:41 +0100"  >&lt;p&gt;Committed to 3.4.6 and trunk. Thanks Chris!&lt;/p&gt;</comment>
                            <comment id="13697689" author="hudson" created="Tue, 2 Jul 2013 12:05:56 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1978 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1978/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1978/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1702&quot; title=&quot;ZooKeeper client may write operation packets before receiving successful response to connection request, can cause TCP RST&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1702&quot;&gt;&lt;del&gt;ZOOKEEPER-1702&lt;/del&gt;&lt;/a&gt;. ZooKeeper client may write operation packets before receiving successful response to connection request, can cause TCP RST (Chris Nauroth via phunt) (Revision 1498732)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
phunt : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1498732&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1498732&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13697982" author="cnauroth" created="Tue, 2 Jul 2013 18:03:21 +0100"  >&lt;p&gt;Thanks very much for reviewing and committing this, Patrick!&lt;/p&gt;</comment>
                            <comment id="13933788" author="fpj" created="Thu, 13 Mar 2014 18:17:13 +0000"  >&lt;p&gt;Closing issues after releasing 3.4.6.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12646864">HADOOP-9556</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12646863">HADOOP-9555</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12582508" name="ZOOKEEPER-1702.1.patch" size="1513" author="cnauroth" created="Thu, 9 May 2013 21:27:12 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 9 May 2013 21:05:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327217</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzeauf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327561</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>