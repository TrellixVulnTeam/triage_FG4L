<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:42:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-712/ZOOKEEPER-712.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-712] Bookie recovery</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-712</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Recover the ledger fragments of a bookie once it crashes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12459531">ZOOKEEPER-712</key>
            <summary>Bookie recovery</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="erwin.tam">Erwin Tam</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Mar 2010 15:39:08 +0000</created>
                <updated>Wed, 23 Nov 2011 19:22:39 +0000</updated>
                            <resolved>Sat, 19 Feb 2011 04:01:22 +0000</resolved>
                                                    <fixVersion>3.3.3</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>contrib-bookkeeper</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12879550" author="erwin.tam" created="Wed, 16 Jun 2010 23:28:19 +0100"  >&lt;p&gt;First pass at implementing bookie recovery as an admin tool.  The patch uploaded has two new files:&lt;br/&gt;
BookieRecoveryTest.java and BookKeeperTools.java (with a corresponding new directory under bookkeeper/tools).&lt;/p&gt;

&lt;p&gt;The main API that BookKeeperTools.java implements is the following:&lt;br/&gt;
    public void asyncRecoverBookieData(final InetSocketAddress bookieSrc, final InetSocketAddress bookieDest,&lt;br/&gt;
            final RecoverCallback cb, final Object context);&lt;/p&gt;

&lt;p&gt;The synchronous version of this API is here:&lt;br/&gt;
    public void recoverBookieData(final InetSocketAddress bookieSrc, final InetSocketAddress bookieDest)&lt;br/&gt;
            throws InterruptedException;&lt;/p&gt;

&lt;p&gt;This is to recover all of the bookie ledger data that was present on a dead input bookieSrc.  The other input &apos;bookieDest&apos; is optional and if passed, we will recover all data to that bookie server specifically.  Otherwise for each ledger being recovered that was stored on the bookieSrc, we choose one of the other available bookie servers and re-replicate the ledger fragment entries to there.&lt;/p&gt;

&lt;p&gt;A command line way to invoke this is done via a main method in BookKeeperTools which expects the following 2-3 input parameters.&lt;br/&gt;
&quot;USAGE: BookKeeperTools zkServers bookieSrc &lt;span class=&quot;error&quot;&gt;&amp;#91;bookieDest&amp;#93;&lt;/span&gt;&quot;&lt;br/&gt;
zkServers is a comma separated list of host:port pairs for the ZooKeeper servers in the cluster.&lt;br/&gt;
bookieSrc is the host:port for the bookie server we are recovering data from.&lt;br/&gt;
bookieDest is the host:port (optional) for the bookie server we want to recover the data to.&lt;/p&gt;

&lt;p&gt;Current limitations: There is no way to know what each ledger&apos;s digest type or key/password are.  That metadata isn&apos;t stored anywhere we can access readily.  Thus for now, we are assuming that all ledgers to be recovered have been created with the same digest type and password.  These values are set via java system properties called &quot;digestType&quot; and &quot;passwd&quot;.  Once we have  a way to store and retrieve this information (via ZK most likely and stored by the Bookie servers when new ledgers are created), we can modify this aspect of the bookie recovery tool.&lt;/p&gt;

&lt;p&gt;Pseudocode:&lt;br/&gt;
Inputs: &lt;br/&gt;
zkServers - Used to create a ZK client so we can read in all of the BK metadata needed to perform the bookie recovery.&lt;br/&gt;
bookieSrc - Used to match against ledger metadata indicating which bookie servers comprise the ensembles that make up a ledger.&lt;br/&gt;
bookieDest - Optionally used to write the recovered ledger data to directly.&lt;/p&gt;

&lt;p&gt;1. Sync with ZK&lt;br/&gt;
2. Read from ZK to get all available bookie servers (only if bookieDest was not passed).&lt;br/&gt;
3. Read from ZK to get all active ledgers.&lt;br/&gt;
4. For each ledger, open it to obtain the LedgerHandle.&lt;br/&gt;
5. For each ledger fragment, see if the dead input bookieSrc is a part of the ensemble for it.&lt;br/&gt;
6. For each ledger fragment that needs to be recovered, find the entries that were actually stored on the bookieSrc. Since we stripe data across bookies in the ensemble, not all ledger entries in the fragment would have been stored on the bookieSrc.&lt;br/&gt;
7. For each of the ledger entries in the fragment that were stored on the bookieSrc, use the BookKeeper client to read it.  Using the client will take care of choosing one of the other bookies where this data is available since the bookieSrc server is dead.&lt;br/&gt;
8. Choosing a new bookieDest (either passed in explicitly or chosen at random currently among the available bookie servers), write this ledger entry directly to there using the BookieClient (the layer that talks to the bookie servers directly).&lt;br/&gt;
9. Once all ledger entries for all fragments for a ledger have been recovered and re-replicated, update ZK so the ledger&apos;s metadata now points to the new bookie server where this data has been re-replicated to.  We choose a single new bookie for each ledger to store the recovered data.&lt;/p&gt;</comment>
                            <comment id="12880785" author="hadoopqa" created="Mon, 21 Jun 2010 12:12:58 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12447283/ZOOKEEPER-712.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12447283/ZOOKEEPER-712.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 953041.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/118/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/118/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/118/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/118/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/118/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/118/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12886873" author="breed" created="Fri, 9 Jul 2010 21:42:12 +0100"  >&lt;p&gt;there are some hardcoded assumptions in the code that can be removed once &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-2&quot; title=&quot;bookkeeper does not put enough meta-data in to do recovery properly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-2&quot;&gt;&lt;del&gt;ZOOKEEPER-807&lt;/del&gt;&lt;/a&gt; is addressed.&lt;/p&gt;</comment>
                            <comment id="12886878" author="breed" created="Fri, 9 Jul 2010 21:48:35 +0100"  >&lt;p&gt;+1 looks good. thanx erwin!&lt;/p&gt;</comment>
                            <comment id="12886891" author="breed" created="Fri, 9 Jul 2010 22:18:55 +0100"  >&lt;p&gt;Committed revision 962697.&lt;/p&gt;</comment>
                            <comment id="12890524" author="hudson" created="Wed, 21 Jul 2010 02:43:29 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #881 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/881/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/881/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="12993600" author="fpj" created="Fri, 11 Feb 2011 17:30:43 +0000"  >&lt;p&gt;Uploading a patch for 3.3.&lt;/p&gt;</comment>
                            <comment id="12996013" author="mahadev" created="Thu, 17 Feb 2011 19:59:50 +0000"  >&lt;p&gt;I just pushed this to 3.3 branch. thanks flavio!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12468954">BOOKKEEPER-2</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12470878" name="ZOOKEEPER-712-3.3.patch" size="57984" author="fpj" created="Fri, 11 Feb 2011 17:31:27 +0000"/>
                            <attachment id="12447283" name="ZOOKEEPER-712.patch" size="57932" author="erwin.tam" created="Wed, 16 Jun 2010 23:08:30 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 16 Jun 2010 22:28:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47639</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzxgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33405</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>