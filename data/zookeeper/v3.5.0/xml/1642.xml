<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:47:20 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1642/ZOOKEEPER-1642.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1642] Leader loading database twice</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1642</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The leader server currently loads the database before running leader election when trying to figure out the zxid it needs to use for the election and again when it starts leading. This is problematic for larger databases so we should remove the redundant load if possible. &lt;/p&gt;

&lt;p&gt;The code references are:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;getLastLoggedZxid() in QuorumPeer;&lt;/li&gt;
	&lt;li&gt;loadData() in ZooKeeperServer.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12631421">ZOOKEEPER-1642</key>
            <summary>Leader loading database twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Junqueira</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Feb 2013 10:30:06 +0000</created>
                <updated>Thu, 13 Mar 2014 18:17:11 +0000</updated>
                            <resolved>Thu, 16 May 2013 18:33:30 +0100</resolved>
                                                    <fixVersion>3.4.6</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13574371" author="fpj" created="Fri, 8 Feb 2013 10:39:37 +0000"  >&lt;p&gt;I would be interested in the opinion of folks that have worked on this part of the code. Is there anything I&apos;m overlooking? In any case, I&apos;m uploading a simple preliminary patch with an idea for solving this.&lt;/p&gt;</comment>
                            <comment id="13574767" author="thawan" created="Fri, 8 Feb 2013 19:48:58 +0000"  >&lt;p&gt;Not sure if my understanding is correct, but with this change I think ZK the server will load database only once during its entire process life-cycle since quorum peer is going to use the same db instance to initialize ZK server when there is a new leader election.  We once considered this optimization but haven&apos;t done it yet. &lt;/p&gt;

</comment>
                            <comment id="13574830" author="fpj" created="Fri, 8 Feb 2013 21:15:30 +0000"  >&lt;p&gt;For leader election, we check if the zkDb instance has been initialized, so it is as you say already. I&apos;m essentially applying the same approach when loading the database after the leader is elected. Right now, I can&apos;t see a problem with it, can you? &lt;/p&gt;

&lt;p&gt;I&apos;ve run the tests and they all pass, not sufficient, but a positive sign.&lt;/p&gt;</comment>
                            <comment id="13575048" author="thawan" created="Sat, 9 Feb 2013 02:22:00 +0000"  >&lt;p&gt;I think we probably want to make sure that ZkDb has the correct data when a peer transition between leader and follower.  I think the current implementation will work correctly but not sure if we want to add a unit test to make sure that it behave correctly moving forward.&lt;/p&gt;

&lt;p&gt;One of the place that I can think of is the committedLog. When a follower get elected as a leader in a new epoch. It will reuse committedLog populated since it was a follower in the old epoch. So we can add a unit test to verify the integrity of the committedLog even though it should behave correctly at the moment. &lt;/p&gt;</comment>
                            <comment id="13576109" author="fpj" created="Mon, 11 Feb 2013 20:49:25 +0000"  >&lt;p&gt;Here is how I currently see it. The leader doesn&apos;t have to change its database instance after being elected, but a follower might need to change it, though. ZKDatabase is actually cleared in Learner#syncWithLeader(), ZooKeeperServer#shutdown(), ZKDatabase#deserializeSnapshot(), ZKDatabase#truncateLog(). In the case the follower requires changes, it will end up clearing the database and reloading it with the corresponding changes.&lt;/p&gt;

&lt;p&gt;About committedLog(), it is cleared in ZKDatabase#clear() and ZKDatabase#addCommittedProposal(). addCommittedProposal is invoked in ZKDatabase#loadDatabase() and FinalRequestProcessor#processRequest(). With the patch I&apos;m proposing, these methods would be invoked in the same way when a follower needs to snap, take a diff, or truncate, so I don&apos;t expect a change of behavior. &lt;/p&gt;

&lt;p&gt;About a test, I&apos;m happy to have it, but I&apos;m still not very sure about what to test. Should we test that a server contains all commits it should? If so, I&apos;m sure we have tests that do it already. Should we instead just check for the content of the committedLog?&lt;/p&gt;
</comment>
                            <comment id="13576906" author="thawan" created="Tue, 12 Feb 2013 19:17:56 +0000"  >&lt;p&gt;committeLog is just for optimization, if the follower doesn&apos;t have it when it elected as a leader, the system still behave correctly. The bug that I saw previously is that if loadDatabase() is called twice without clearing the committedLog, it will have duplicate txns which may or may not cause the problem. But in the patch that you proposed, it shouldn&apos;t happen.&lt;/p&gt;

&lt;p&gt;Since we are just checking the flag before loading the db which we already do something similar in ZooKeeperServer#startData(), we might not need a test if the scope of the patch is what mentioned in the title.   &lt;/p&gt;

&lt;p&gt;Now that we know that ZooKeeper#shutdown() will clear the DB, so I guess the db will need to be reloaded again during leader election after leader failure. I think the optimization of keeping the db across leader election (except when getting a SNAP or TRUNC) is worth doing, but that can be in a separate JIRA.&lt;/p&gt;

</comment>
                            <comment id="13577093" author="fpj" created="Tue, 12 Feb 2013 22:11:26 +0000"  >&lt;p&gt;Thanks for the feedback, Thawan. I think I haven&apos;t made myself very clear. Let me try to add some more detail about this comment you&apos;ve made:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the optimization of keeping the db across leader election (except when getting a SNAP or TRUNC) is worth doing, but that can be in a separate JIRA.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;QuorumPeer#getLastLoggedZxid is invoked in FLE#lookForLeader to set zxid of the initial vote. To get the zxid, we load the database in getLastLoggedZxid, and my understanding is that it must be loaded because it has been cleared with the shutdown when transitioning from LEADING/FOLLOWING to LOOKING. The change I&apos;m proposing prevents a new leader from loading the database a second time when it starts executing Leader#lead(), more concretely when it calls loadData. &lt;/p&gt;

&lt;p&gt;Does it make more sense now?&lt;/p&gt;</comment>
                            <comment id="13577294" author="thawan" created="Wed, 13 Feb 2013 02:40:01 +0000"  >&lt;p&gt;Ah sorry. Then, I think this patch should do what it is intended to do. I think the rest is just adding comments about why the checking is added. Since it is not clear from the code why the DB can be initialized before reaching that point.&lt;/p&gt;</comment>
                            <comment id="13577414" author="fpj" created="Wed, 13 Feb 2013 08:45:06 +0000"  >&lt;p&gt;Added an explanation of why we are doing this initialization check.&lt;/p&gt;</comment>
                            <comment id="13577415" author="fpj" created="Wed, 13 Feb 2013 08:45:58 +0000"  >&lt;p&gt;I&apos;ve added an explanation as you suggest, Thawan.&lt;/p&gt;</comment>
                            <comment id="13577429" author="hadoopqa" created="Wed, 13 Feb 2013 09:19:42 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12569163/ZOOKEEPER-1642.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12569163/ZOOKEEPER-1642.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1441922.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1388//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1388//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1388//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1388//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1388//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1388//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13577435" author="fpj" created="Wed, 13 Feb 2013 09:31:49 +0000"  >&lt;p&gt;We agreed so far on not having tests, so the QA result is expected.&lt;/p&gt;</comment>
                            <comment id="13577857" author="thawan" created="Wed, 13 Feb 2013 19:36:58 +0000"  >&lt;p&gt;Thanks Flavio, The patch looks good&lt;br/&gt;
+1 for me&lt;/p&gt;</comment>
                            <comment id="13659683" author="fournc" created="Thu, 16 May 2013 17:34:56 +0100"  >&lt;p&gt;Flavio is this ready to go? It looks ok with me, if so I can check it in.&lt;/p&gt;</comment>
                            <comment id="13659692" author="fpj" created="Thu, 16 May 2013 17:43:16 +0100"  >&lt;p&gt;Yes, ready to go. Thanks, Camille.&lt;/p&gt;</comment>
                            <comment id="13659743" author="hudson" created="Thu, 16 May 2013 18:30:23 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1928 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1928/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1928/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1642&quot; title=&quot;Leader loading database twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1642&quot;&gt;&lt;del&gt;ZOOKEEPER-1642&lt;/del&gt;&lt;/a&gt;. Leader loading database twice (fpj via camille) (Revision 1483440)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
camille : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1483440&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1483440&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13933779" author="fpj" created="Thu, 13 Mar 2014 18:17:11 +0000"  >&lt;p&gt;Closing issues after releasing 3.4.6.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12569163" name="ZOOKEEPER-1642.patch" size="1701" author="fpj" created="Wed, 13 Feb 2013 08:45:06 +0000"/>
                            <attachment id="12568552" name="ZOOKEEPER-1642.patch" size="827" author="fpj" created="Fri, 8 Feb 2013 10:39:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 8 Feb 2013 19:48:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311917</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzbogn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312263</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>