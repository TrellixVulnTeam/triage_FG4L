<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:44:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1136/ZOOKEEPER-1136.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1136] NEW_LEADER should be queued not sent to match the Zab 1.0 protocol on the twiki</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1136</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;the NEW_LEADER message was sent at the beginning of the sync phase in Zab pre1.0, but it must be at the end in Zab 1.0. if the protocol is 1.0 or greater we need to queue rather than send the packet.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12515429">ZOOKEEPER-1136</key>
            <summary>NEW_LEADER should be queued not sent to match the Zab 1.0 protocol on the twiki</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="breed">Benjamin Reed</assignee>
                                    <reporter username="breed">Benjamin Reed</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jul 2011 17:58:51 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:08 +0000</updated>
                            <resolved>Wed, 14 Sep 2011 07:59:35 +0100</resolved>
                                                    <fixVersion>3.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13071788" author="mahadev" created="Wed, 27 Jul 2011 16:12:10 +0100"  >&lt;p&gt;Ben, are you working on this?&lt;/p&gt;</comment>
                            <comment id="13071855" author="breed" created="Wed, 27 Jul 2011 17:57:32 +0100"  >&lt;p&gt;yes, hoping to have a patch today.&lt;/p&gt;</comment>
                            <comment id="13084214" author="hadoopqa" created="Fri, 12 Aug 2011 17:01:40 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12490258/ZOOKEEPER-1136.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12490258/ZOOKEEPER-1136.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1156845.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/454//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/454//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/454//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/454//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/454//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/454//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13084862" author="mahadev" created="Sun, 14 Aug 2011 17:43:24 +0100"  >&lt;p&gt;ben, could you please take a look at the failing test?&lt;/p&gt;</comment>
                            <comment id="13087532" author="breed" created="Fri, 19 Aug 2011 05:56:07 +0100"  >&lt;p&gt;the LETest had a tick time of 2ms, which is much too small. since the NEWLEADER is at the end of the state transfer rather than the beginning, it takes slightly longer. (evidently more than 4ms on slow machines.)&lt;/p&gt;</comment>
                            <comment id="13087544" author="hadoopqa" created="Fri, 19 Aug 2011 06:24:41 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12490918/ZOOKEEPER-1136.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12490918/ZOOKEEPER-1136.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1159432.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/467//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/467//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/467//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/467//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/467//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/467//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13087782" author="fpj" created="Fri, 19 Aug 2011 17:11:16 +0100"  >&lt;p&gt;Great that you&apos;ve been able to spot the problem, Ben. A few quick comments:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;I don&apos;t understand why you&apos;re checking if a snapshot has been taken. Is it for backward compatibility?&lt;/li&gt;
	&lt;li&gt;There are two blocks in LearnerHandler that seem to be doing only reformatting. Do we want to have those changes too?&lt;/li&gt;
	&lt;li&gt;There is no test, but it sounds like a good idea to have one, no?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13088295" author="breed" created="Sun, 21 Aug 2011 02:07:49 +0100"  >&lt;p&gt;1. yes, i&apos;ll put a comment to that effect in the patch&lt;br/&gt;
2. it is only reformatting. the previous patch was checked in with tabs&lt;br/&gt;
3. yes, we should add a test. let me see what i can do.&lt;/p&gt;</comment>
                            <comment id="13093490" author="mahadev" created="Tue, 30 Aug 2011 08:07:08 +0100"  >&lt;p&gt;Ben,&lt;br/&gt;
 Any update on this? &lt;/p&gt;</comment>
                            <comment id="13096812" author="breed" created="Sun, 4 Sep 2011 05:45:13 +0100"  >&lt;p&gt;Added tests and comments suggested by flavio&lt;/p&gt;</comment>
                            <comment id="13096814" author="hadoopqa" created="Sun, 4 Sep 2011 06:13:29 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12492950/ZOOKEEPER-1136.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12492950/ZOOKEEPER-1136.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1164758.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/498//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/498//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/498//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/498//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/498//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/498//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13104289" author="mahadev" created="Wed, 14 Sep 2011 07:24:28 +0100"  >&lt;p&gt;The patch looks good to me, but there are changes that werent necessary in the patch, like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+            sock.setSoTimeout(leader.self.getTickTime()*leader.self.getInitLimit());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in LearnerHandler.java and also the ByteBufferOutputStream changes.&lt;/p&gt;

&lt;p&gt;We should enumerate the list of changes made in a patch so that its easier for others to reason about the changes.&lt;/p&gt;

&lt;p&gt;I will go ahead and commit this for now.&lt;/p&gt;</comment>
                            <comment id="13104310" author="mahadev" created="Wed, 14 Sep 2011 07:59:21 +0100"  >&lt;p&gt;Just committed this to trunk only. The patch doesnt apply to 3.3 branch. Also, I think its a tricky change for the 3.3 branch. We should skip this change in 3.3.&lt;/p&gt;</comment>
                            <comment id="13105267" author="hudson" created="Thu, 15 Sep 2011 11:56:35 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1304 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1304/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1304/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1136&quot; title=&quot;NEW_LEADER should be queued not sent to match the Zab 1.0 protocol on the twiki&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1136&quot;&gt;&lt;del&gt;ZOOKEEPER-1136&lt;/del&gt;&lt;/a&gt;. NEW_LEADER should be queued not sent to match the Zab 1.0 protocol on the twiki (breed via mahadev)&lt;/p&gt;

&lt;p&gt;mahadev : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1170452&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1170452&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ByteBufferInputStream.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ByteBufferOutputStream.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/DataTree.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/FinalRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/Learner.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13141234" author="fournc" created="Tue, 1 Nov 2011 15:24:04 +0000"  >&lt;p&gt;This change causes a concurrency bug. Specifically:&lt;br/&gt;
1. Follower rejoins, gets snap from leader&lt;br/&gt;
2. Follower gets NEWLEADER message and takes a snapshot&lt;br/&gt;
3. Follower gets some additional tranactions forwarded from leader, applies these directly to data tree&lt;br/&gt;
4. Follower gets an UPTODATE message, does not take a snapshot&lt;br/&gt;
5. Follower starts following, writes some new transactions to its log, and is killed before it takes another snapshot&lt;br/&gt;
6. Follower restarts and gets a DIFF from the leader&lt;/p&gt;

&lt;p&gt;The transactions that came in between NEWLEADER and UPTODATE are lost because they never go anywhere but the internal data tree, and if that tree isn&apos;t snapshotted and the follower restarts with only a DIFF, the follower will lose these transactions.&lt;/p&gt;

&lt;p&gt;I think the proper thing to do is snapshot after UPTODATE, but I&apos;m not sure why we changed this to snapshot after NEWLEADER instead. The wiki doesn&apos;t seem to explain that clearly. If one of you could check on &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1264&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1264&lt;/a&gt; and let me know the reasoning, that would be helpful.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12492950" name="ZOOKEEPER-1136.patch" size="36116" author="breed" created="Sun, 4 Sep 2011 05:45:13 +0100"/>
                            <attachment id="12490918" name="ZOOKEEPER-1136.patch" size="8819" author="breed" created="Fri, 19 Aug 2011 05:56:07 +0100"/>
                            <attachment id="12490258" name="ZOOKEEPER-1136.patch" size="7900" author="breed" created="Fri, 12 Aug 2011 16:33:40 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Jul 2011 15:12:10 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3985</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzt3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32700</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>