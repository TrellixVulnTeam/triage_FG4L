<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:47:44 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-737/ZOOKEEPER-737.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-737] some 4 letter words may fail with netcat (nc)</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-737</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;nc closes the write channel as soon as it&apos;s sent it&apos;s information, for example &quot;echo stat|nc localhost 2181&quot;&lt;br/&gt;
in general this is fine, however the server code will close the socket as soon as it receives notice that nc has&lt;br/&gt;
closed it&apos;s write channel. if not all the 4 letter word result has been written back to the client yet, this will cause&lt;br/&gt;
some or all of the result to be lost - ie the client will not see the full result. this was introduced in 3.3.0 as part&lt;br/&gt;
of a change to reduce blocking of the selector by long running 4letter words.&lt;/p&gt;

&lt;p&gt;here&apos;s an example of the logs from the server during this&lt;/p&gt;

&lt;p&gt;echo -n stat | nc localhost 2181&lt;br/&gt;
2010-04-09 21:55:36,124 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@251&amp;#93;&lt;/span&gt; - Accepted socket connection from /127.0.0.1:42179&lt;br/&gt;
2010-04-09 21:55:36,124 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@968&amp;#93;&lt;/span&gt; - Processing stat command from /127.0.0.1:42179&lt;br/&gt;
2010-04-09 21:55:36,125 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@606&amp;#93;&lt;/span&gt; - EndOfStreamException: Unable to read additional data from client sessionid 0x0, likely client has closed socket&lt;br/&gt;
2010-04-09 21:55:36,125 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1286&amp;#93;&lt;/span&gt; - Closed socket connection for client /127.0.0.1:42179 (no session established for client)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;phunt@gsbl90850 zookeeper-3.3.0&amp;#93;&lt;/span&gt;$ 2010-04-09 21:55:36,126 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-15:NIOServerCnxn@422&amp;#93;&lt;/span&gt; - Unexpected Exception: &lt;br/&gt;
java.nio.channels.CancelledKeyException&lt;br/&gt;
	at sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:55)&lt;br/&gt;
	at sun.nio.ch.SelectionKeyImpl.interestOps(SelectionKeyImpl.java:59)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn.sendBuffer(NIOServerCnxn.java:395)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$SendBufferWriter.checkFlush(NIOServerCnxn.java:907)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$SendBufferWriter.flush(NIOServerCnxn.java:945)&lt;br/&gt;
	at java.io.BufferedWriter.flush(BufferedWriter.java:236)&lt;br/&gt;
	at java.io.PrintWriter.flush(PrintWriter.java:276)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$2.run(NIOServerCnxn.java:1089)&lt;br/&gt;
2010-04-09 21:55:36,126 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-15:NIOServerCnxn$Factory$1@82&amp;#93;&lt;/span&gt; - Thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-15,5,main&amp;#93;&lt;/span&gt; died&lt;br/&gt;
java.nio.channels.CancelledKeyException&lt;br/&gt;
	at sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:55)&lt;br/&gt;
	at sun.nio.ch.SelectionKeyImpl.interestOps(SelectionKeyImpl.java:64)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$SendBufferWriter.wakeup(NIOServerCnxn.java:927)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$SendBufferWriter.checkFlush(NIOServerCnxn.java:909)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$SendBufferWriter.flush(NIOServerCnxn.java:945)&lt;br/&gt;
	at java.io.BufferedWriter.flush(BufferedWriter.java:236)&lt;br/&gt;
	at java.io.PrintWriter.flush(PrintWriter.java:276)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$2.run(NIOServerCnxn.java:1089)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12461726">ZOOKEEPER-737</key>
            <summary>some 4 letter words may fail with netcat (nc)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mahadev">Mahadev konar</assignee>
                                    <reporter username="phunt">Patrick Hunt</reporter>
                        <labels>
                    </labels>
                <created>Sat, 10 Apr 2010 22:13:23 +0100</created>
                <updated>Thu, 29 Dec 2011 23:08:07 +0000</updated>
                            <resolved>Tue, 4 May 2010 22:51:42 +0100</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12855644" author="phunt" created="Sat, 10 Apr 2010 22:14:47 +0100"  >&lt;p&gt;fyi, typically this is not an issue for 4 letter word clients as they open the socket, write the request, read the response&lt;br/&gt;
then close the socket. However it seems nc is closing the write channel as soon as it sends all it has to send (before it&lt;br/&gt;
necess. reads). As a result you get this timing issue with nc.&lt;/p&gt;</comment>
                            <comment id="12859108" author="mahadev" created="Tue, 20 Apr 2010 23:49:21 +0100"  >&lt;p&gt;this patch fixes the issue.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it removes the selection key from the selector via calling selectionkey.cancel()&lt;/li&gt;
	&lt;li&gt;sends the output of the stat command via the socket and does not use the selector for sending it&lt;/li&gt;
	&lt;li&gt;closes the socket appropriately after the server is done sending the response to the client&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12859110" author="mahadev" created="Tue, 20 Apr 2010 23:50:20 +0100"  >&lt;p&gt;please try this patch out with all kinds of commands.&lt;/p&gt;

&lt;p&gt;also, pat do you have a testcase for four letter words that I can add a testcase to?&lt;/p&gt;</comment>
                            <comment id="12859119" author="phunt" created="Wed, 21 Apr 2010 00:13:07 +0100"  >&lt;p&gt;Yes, there are 2 sets of tests, one for standalone and one for quorum.&lt;/p&gt;

&lt;p&gt;FourLetterWordsQuorumTest.java&lt;br/&gt;
FourLetterWordsTest.java&lt;/p&gt;

&lt;p&gt;However there is a flaw in these tests. They use a socket to do the test, ie connect, send, verify resp, close socket&lt;/p&gt;

&lt;p&gt;This is not what NC does, it does a connect, send, close write channel, verify resp, close socket&lt;/p&gt;

&lt;p&gt;and that&apos;s why nc fails while everything else was fine.&lt;/p&gt;

&lt;p&gt;I&apos;d suggest adding a new set of tests that not only do the old test, but also replicate nc. It would also be good to verify&lt;br/&gt;
that the connection count stays the same (ie that we don&apos;t leak connections).&lt;/p&gt;

&lt;p&gt;Should I do the changes for the tests or do you want to?&lt;/p&gt;</comment>
                            <comment id="12859121" author="hadoopqa" created="Wed, 21 Apr 2010 00:15:30 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12442363/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12442363/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 934312.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no tests are needed for this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/58/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/58/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/58/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/58/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/58/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/58/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12859194" author="mahadev" created="Wed, 21 Apr 2010 05:50:11 +0100"  >&lt;p&gt;this patch fixes the issue. The problem was the cons wasnt returning anything if there are only 4 letters commands as connections. This fixes the issue to return stats for that.&lt;/p&gt;

&lt;p&gt;I will be adding test case shortly.&lt;/p&gt;</comment>
                            <comment id="12859201" author="hadoopqa" created="Wed, 21 Apr 2010 06:18:11 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12442394/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12442394/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 934312.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no tests are needed for this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/59/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/59/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/59/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/59/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/59/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/59/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12859456" author="phunt" created="Wed, 21 Apr 2010 19:07:50 +0100"  >&lt;p&gt;This updated patch verifies that we can support the case where the write channel is closed (client perspective) before the server has fully responded. This fails prior to Mahadev&apos;s fix being applied.&lt;/p&gt;</comment>
                            <comment id="12859478" author="hadoopqa" created="Wed, 21 Apr 2010 19:41:16 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12442455/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12442455/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 934312.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/60/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/60/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/60/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/60/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/60/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/60/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12859515" author="mahadev" created="Wed, 21 Apr 2010 21:28:03 +0100"  >&lt;p&gt;changed (0x0) for interest ops to be (0), to keep it consistent with how we print interest ops.&lt;/p&gt;
</comment>
                            <comment id="12859638" author="hadoopqa" created="Thu, 22 Apr 2010 04:23:58 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12442478/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12442478/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 934312.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    -1 contrib tests.  The patch failed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/61/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/61/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/61/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/61/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/61/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/61/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12859927" author="hadoopqa" created="Thu, 22 Apr 2010 19:02:17 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12442478/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12442478/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 936624.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/68/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/68/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/68/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/68/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/68/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/68/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12861044" author="phunt" created="Mon, 26 Apr 2010 19:45:37 +0100"  >&lt;p&gt;Mahadev, this looks great, a few issues I noticed:&lt;/p&gt;

&lt;p&gt;If the pwriter flush/close calls fail for any reason we will not close the socket. In cleanupWriterSocket I think you should have a try/finally around the pwriter conditional block. This will ensure that no matter what happens we will close the socket.&lt;/p&gt;

&lt;p&gt;What happens if cancel key fails? Is this really a debug level message? What would happen if cancel fails but later the socket is explicitly closed (after command returns)?&lt;/p&gt;

&lt;p&gt;+        if (k != null) {&lt;br/&gt;
+            try &lt;/p&gt;
{
+                k.cancel();
+            }
&lt;p&gt; catch(Exception e) &lt;/p&gt;
{
+                LOG.debug(&quot;Error cancelling command selection key &quot;, e);
+            }


&lt;p&gt;Are these errors or info messages? Seems like both are LOG.error? (ie we&apos;d really want to know if this happened)&lt;/p&gt;

&lt;p&gt;LOG.info(&quot;Error sending data synchronously &quot;, ie);&lt;br/&gt;
LOG.info(&quot;Error closing a command socket &quot;, e);&lt;/p&gt;</comment>
                            <comment id="12861126" author="mahadev" created="Mon, 26 Apr 2010 22:39:57 +0100"  >&lt;p&gt;addressed pat&apos;s comments on the logging and try and finally block.&lt;/p&gt;

&lt;p&gt;If cancel key fails, the socket will be closed later to make sure there is no resource leak.&lt;/p&gt;
</comment>
                            <comment id="12861138" author="hadoopqa" created="Mon, 26 Apr 2010 23:08:32 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12442903/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12442903/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 938212.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/148/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/148/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/148/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/148/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/148/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/148/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12861147" author="phunt" created="Mon, 26 Apr 2010 23:29:16 +0100"  >&lt;p&gt;Seems like this could infinite loop in some bad cases:&lt;/p&gt;

&lt;p&gt;sendbuffersync&lt;br/&gt;
               while(bb.remaining() != 0) {&lt;br/&gt;
                   if (sock != null) &lt;/p&gt;
{
                       sock.write(bb);
                   }
&lt;p&gt;               }&lt;/p&gt;

&lt;p&gt;say the client requests, then never reads the response (and the response is very large, so it fills up the tcp buffers and such).&lt;/p&gt;</comment>
                            <comment id="12861156" author="mahadev" created="Mon, 26 Apr 2010 23:59:09 +0100"  >&lt;p&gt;this issue could be possible only if the client&apos;s tcp buffer is filled up and the write buffer is also filled up. The defaults for WAN specifications are:&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;tcp read/write sysctl config&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;min&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;default&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;max&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;net.ipv4.tcp_rmem&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4096&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;87380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;174760&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;net.ipv4.tcp_wmem&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4096&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;16384&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;131072&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;In a non WAN tcp connection the read buffer should be atleast 87KB and write buffer should be 16KB, which gives us a total of 100KB, which should be good enough (except for huge ephemeral dumps on a large tree). Even in that case according to my calculation we should be able to support  50, 000 ephemeral nodes, in which case the client will not be reading the data but the server is still writitng it out!&lt;/p&gt;

&lt;p&gt;Also,  much more importantly all commands will be called via nc/telnet which should not be malformed (not reading off the socket). &lt;/p&gt;</comment>
                            <comment id="12861558" author="mahadev" created="Tue, 27 Apr 2010 22:37:17 +0100"  >&lt;p&gt;Updated the patch to use blocking IO for commands so that we dont have any spinning issues with the socket channels.&lt;/p&gt;</comment>
                            <comment id="12861570" author="hadoopqa" created="Tue, 27 Apr 2010 22:58:24 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12443006/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12443006/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 938212.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/75/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/75/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/75/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/75/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/75/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/75/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12861592" author="phunt" created="Tue, 27 Apr 2010 23:32:53 +0100"  >&lt;p&gt;Looks good to me, +1. Tests pass on my system. Would be a good idea to get a review from another commiter though.&lt;/p&gt;</comment>
                            <comment id="12861594" author="mahadev" created="Tue, 27 Apr 2010 23:36:48 +0100"  >&lt;p&gt;ben, would you be able to review this patch? &lt;/p&gt;</comment>
                            <comment id="12862393" author="breed" created="Thu, 29 Apr 2010 21:29:01 +0100"  >&lt;p&gt;-1 we have a problem for the cases when a thread isn&apos;t spawned to handle the command. in those cases the send could block which would block the NIO thread.&lt;/p&gt;</comment>
                            <comment id="12862401" author="mahadev" created="Thu, 29 Apr 2010 21:37:23 +0100"  >&lt;p&gt;very good point ben...... &lt;/p&gt;</comment>
                            <comment id="12862806" author="mahadev" created="Fri, 30 Apr 2010 19:59:56 +0100"  >&lt;p&gt;this patch makes all commands to run as threads. Also, this includes refactoring of the command code into seperate classes. I am really looking forward to Netty, this is just getting too hairy in NIOServerCnxn!&lt;/p&gt;</comment>
                            <comment id="12862863" author="hadoopqa" created="Fri, 30 Apr 2010 21:58:50 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12443310/ZOOKEEPER-737.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12443310/ZOOKEEPER-737.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 939172.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/80/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/80/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/80/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/80/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/80/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/80/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12863538" author="phunt" created="Mon, 3 May 2010 23:04:16 +0100"  >&lt;p&gt;+1 latest patch looks good to me. Did a bunch of system testing and it was working fine (used netstat to verify).&lt;/p&gt;</comment>
                            <comment id="12863562" author="mahadev" created="Tue, 4 May 2010 00:15:35 +0100"  >&lt;p&gt;ben, can you take a look at it? We should commit this ASAP, since 3.3.1 is waiting on it.&lt;/p&gt;</comment>
                            <comment id="12863649" author="breed" created="Tue, 4 May 2010 05:07:46 +0100"  >&lt;p&gt;+1 great job mahadev&lt;/p&gt;</comment>
                            <comment id="12864029" author="mahadev" created="Tue, 4 May 2010 22:51:42 +0100"  >&lt;p&gt;I just committed this to trunk and 3.3 branch. &lt;/p&gt;</comment>
                            <comment id="13102715" author="fournc" created="Mon, 12 Sep 2011 15:59:33 +0100"  >&lt;p&gt;Hey guys,&lt;/p&gt;

&lt;p&gt;I&apos;m still seeing this problem when using telnet to get 4 letter word results. This is on servers running 3.3.3. I&apos;m at a loss for how to debug this problem, does anyone have any suggestion? It&apos;s causing the zk dashboard to fail when there are more than 100 or so connections on a far DC server. &lt;/p&gt;</comment>
                            <comment id="13102866" author="breed" created="Mon, 12 Sep 2011 19:08:30 +0100"  >&lt;p&gt;telnet works a bit different than nc. are you using it in an interactive way? (in other words, are you typing the commands?)&lt;/p&gt;

&lt;p&gt;is the problem that the results are getting truncated? i assume the problem is reproducible correct?&lt;/p&gt;</comment>
                            <comment id="13102882" author="fournc" created="Mon, 12 Sep 2011 19:26:46 +0100"  >&lt;p&gt;Yeah, I don&apos;t know anything about the difference between nc or telnet, or what zkdashboard is using, but this is with telnet interactive (reproducing a problem we see in zkdashboard). It&apos;s reproducible but tricky. If I run stat/dump from a remote server into a leader with a lot of connections/ephemerals, it reliably fails. It prints out some of the data and closes the connection suddenly. For example, the end of a dump command:&lt;br/&gt;
14 expire at Mon Sep 12 14:14:04 EDT 2011:&lt;br/&gt;
        0x1325208b8c90089&lt;br/&gt;
        0x2325208b8c30099&lt;br/&gt;
        0x4325208b8ca0113&lt;br/&gt;
        0x1325208b8c900cd&lt;br/&gt;
        0x2325208b8c3009d&lt;br/&gt;
        0x5325211469900ae&lt;br/&gt;
        0x2325208b8c30091&lt;br/&gt;
        0x4325208b8ca00b7&lt;br/&gt;
        0x1325208b8c90094&lt;br/&gt;
        0x1325208b8c90090&lt;br/&gt;
        0x5325211469900d7&lt;br/&gt;
        0x5325211469900a4&lt;br/&gt;
        0x2325208b8c3009e&lt;br/&gt;
        0x2325208b8c3009c&lt;br/&gt;
0 expire at Mon Sep 12 14:14:10 EDT 2011:Connection closed by foreign host.&lt;/p&gt;

&lt;p&gt;I tried a bit of debugging against the running server. Breakpoints anywhere inside the dump thread before the exit of closeSock() will cause the problem not to occur. But a breakpoint at the exit of closeSock() will still show the problem. &lt;/p&gt;

&lt;p&gt;This is &quot;a lot&quot; of ephemerals/sessions in that we&apos;re talking about ~120 sessions and 88 ephemerals. Hardly thousands.&lt;/p&gt;</comment>
                            <comment id="13103078" author="fournc" created="Mon, 12 Sep 2011 22:33:34 +0100"  >&lt;p&gt;One more thing to add, when I run this with &quot;interactive&quot; netcat, I see the same problem:&lt;br/&gt;
nc foo 2181&lt;br/&gt;
dump&lt;br/&gt;
SessionTracker dump:&lt;br/&gt;
Session Sets (8):&lt;br/&gt;
0 expire at Mon Sep 12 17:31:12 EDT 2011:&lt;br/&gt;
0 expire at Mon Sep 12 17:31:14 EDT 2011:&lt;br/&gt;
0 expire at Mon Sep 12 17:31:16 EDT 2011:&lt;br/&gt;
....&lt;br/&gt;
        0x23259a57465000a&lt;br/&gt;
        0x33259a5746d0009&lt;br/&gt;
        0x33259a5746-bash-3.2$&lt;/p&gt;

&lt;p&gt;Does work ok if I do echo -n dump | nc foo 2181&lt;/p&gt;</comment>
                            <comment id="13103130" author="breed" created="Mon, 12 Sep 2011 23:25:26 +0100"  >&lt;p&gt;i&apos;m wondering if it is the linger... would you be able to patch a server with:&lt;/p&gt;


&lt;p&gt;diff --git src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java&lt;br/&gt;
index 1e8c68e..5f943e9 100644&lt;br/&gt;
&amp;#8212; src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java&lt;br/&gt;
+++ src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java&lt;br/&gt;
@@ -494,6 +494,9 @@ public class NIOServerCnxn extends ServerCnxn {&lt;br/&gt;
         public void run() {&lt;br/&gt;
             try {&lt;br/&gt;
                 commandRun();&lt;br/&gt;
+                if (sock != null) &lt;/p&gt;
{
+                    sock.socket().setSoLinger(true, 15);
+                }
&lt;p&gt;             } catch (IOException ie) &lt;/p&gt;
{
                 LOG.error(&quot;Error in running command &quot;, ie);
             }
&lt;p&gt; finally {&lt;/p&gt;

&lt;p&gt;and see if it still happens?&lt;/p&gt;</comment>
                            <comment id="13103157" author="fournc" created="Mon, 12 Sep 2011 23:54:57 +0100"  >&lt;p&gt;That seems to maybe fix telnet, but not nc interactive. Does that matter?&lt;br/&gt;
Feels like yet another reason to get to Netty.&lt;/p&gt;</comment>
                            <comment id="13103215" author="breed" created="Tue, 13 Sep 2011 01:34:28 +0100"  >&lt;p&gt;does everything work ok with netty?&lt;/p&gt;</comment>
                            <comment id="13103677" author="fournc" created="Tue, 13 Sep 2011 16:03:27 +0100"  >&lt;p&gt;Netty is apparently even worse, as it hangs the connection and I can&apos;t even ctrl-c out of it in telnet.&lt;/p&gt;</comment>
                            <comment id="13103862" author="phunt" created="Tue, 13 Sep 2011 19:25:39 +0100"  >&lt;p&gt;which version of nc are you using? The newer (ubuntu pkging) openbsd or &quot;traditional&quot;? You might try both.&lt;/p&gt;

&lt;p&gt;We got it to work well with traditional, then ubuntu went and made openbsd the default:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;phunt@ubuntu:~$ nc
This is nc from the netcat-openbsd package. An alternative nc is available
in the netcat-traditional package.
usage: nc [-46DdhklnrStUuvzC] [-i interval] [-P proxy_username] [-p source_port]
	  [-s source_ip_address] [-T ToS] [-w timeout] [-X proxy_protocol]
	  [-x proxy_address[:port]] [hostname] [port[s]]
phunt@ubuntu:~$ ls /bin/nc.*
/bin/nc.openbsd*  /bin/nc.traditional*
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13103912" author="fournc" created="Tue, 13 Sep 2011 20:07:16 +0100"  >&lt;p&gt;I have no idea, this isn&apos;t on ubuntu though, I suspect it&apos;s traditional.&lt;br/&gt;
Should I make a ticket for this fix? I don&apos;t feel like I fully understand the problem myself but if you guys think that just extending the SO_LINGER for the 4lws is the right way to go for the NIO version, I&apos;m happy to make a patch and test it out.&lt;/p&gt;</comment>
                            <comment id="13104041" author="fournc" created="Tue, 13 Sep 2011 23:15:15 +0100"  >&lt;p&gt;So here&apos;s an interesting observation: If I do nothing but set the socket SoLinger to&lt;br/&gt;
 sock.socket().setSoLinger(false, -1);&lt;/p&gt;

&lt;p&gt;everything actually seems to work. Except nc interactive, which still fails, but I don&apos;t care about that. I&apos;m going to suggest we add the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1049&quot; title=&quot;Session expire/close flooding renders heartbeats to delay significantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1049&quot;&gt;&lt;del&gt;ZOOKEEPER-1049&lt;/del&gt;&lt;/a&gt; into 3.3.4. We still need to fix netty.&lt;/p&gt;</comment>
                            <comment id="13104214" author="breed" created="Wed, 14 Sep 2011 04:38:36 +0100"  >&lt;p&gt;that is weird, since we should have already done setSoLinger(false, -1) when the socket was accepted. (see the constructor for NIOServerCnxn.) perhaps the slight delay of invoking the setsolinger gives the packets enough time to get out...&lt;/p&gt;</comment>
                            <comment id="13104513" author="fournc" created="Wed, 14 Sep 2011 15:06:56 +0100"  >&lt;p&gt;I was doing a mixture of testing against 3.4 (for netty) and 3.3 (for everything else). The soLinger change didn&apos;t make it into 3.3.3. Should I put it into there? I think that is the right solution.&lt;/p&gt;</comment>
                            <comment id="13104692" author="phunt" created="Wed, 14 Sep 2011 18:27:47 +0100"  >&lt;p&gt;Sounds like a good fix for 3.3.4. Is there any automated testing (can you add to existing), or just manual?&lt;/p&gt;</comment>
                            <comment id="13104776" author="fournc" created="Wed, 14 Sep 2011 19:49:14 +0100"  >&lt;p&gt;Let me see what I can do.&lt;/p&gt;</comment>
                            <comment id="13109067" author="fournc" created="Wed, 21 Sep 2011 00:03:28 +0100"  >&lt;p&gt;I&apos;ve taken a lot of wrong steps on this one, but I think I have a solution.&lt;/p&gt;

&lt;p&gt;Here&apos;s the problem as I see it: We can&apos;t cancel that selector key, because if we do that, the socket close will cut off the connection to the client before all the data has flushed through the network. I have validated that the data is all flushed to the byte buffer, but it never gets to the client if there is network slowness and it can&apos;t all successfully arrive before the CommandThread gets to the call to close. This can happen even in nc noninteractive mode (as we have observed with several false weekend alerts).&lt;/p&gt;

&lt;p&gt;However, if we don&apos;t cancel the selector key, we&apos;ll potentially see a cancelled key exception or an EOF exception in our selector loops in non-interactive netcat, and that will preemptively close the socket.&lt;/p&gt;

&lt;p&gt;So we need to keep the key from being cancelled by our processes to ensure the data gets completely sent, but we also need to ignore errors from selecting this key in the case of a 4lw. &lt;/p&gt;

&lt;p&gt;Right now, my solution is a total ugly hack that looks something like:&lt;/p&gt;

&lt;p&gt;create a boolean in NIOServerCnxn called &quot;ignoreClose&quot;, initally set to false. In checkFourLetterWord, set this boolean to true. In the Factory run loop, if we get a CancelledKeyException, with a NIOServerCnxn attachment, and the boolean set to true, ignore the exception. In doIO, if we get an EOFException (possibly any exception) and this boolean is set to true, ignore the exception. This lets us ignore the effects of a cancelled/closed incoming connection from nc without losing data on the socket for times when a 4lw needs a lot of data to be sent or a distance to send it.&lt;/p&gt;

&lt;p&gt;Thoughts on this? It has been a bit of a nightmare to figure out, and my googling seems to indicate that netty won&apos;t support nc at all ( &lt;a href=&quot;https://issues.jboss.org/browse/NETTY-236&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.jboss.org/browse/NETTY-236&lt;/a&gt; ). &lt;/p&gt;</comment>
                            <comment id="13126020" author="phunt" created="Wed, 12 Oct 2011 19:27:28 +0100"  >&lt;p&gt;How&apos;s this? &lt;/p&gt;

&lt;p&gt;One option that would make this a lot less ugly would be to deprecate support for 4letterwords on the client port in 3.5.0 (dep, not remove, although provide an option to turn off via config), we&apos;d designate a new port specifically for 4letterwords. We&apos;d fix this problem on the new port, the old port would have the existing limitations.&lt;/p&gt;

&lt;p&gt;3.6.0 we would remove 4lw on client port entirely.&lt;/p&gt;

&lt;p&gt;This is good for a number of reasons IMO &amp;#8211; one is that having 4lw on the client port is a bit of a security issue in some customers - as any client has access to this port and it cannot by definition be firewalled. Many admins would like to firewall this.&lt;/p&gt;

&lt;p&gt;In the process we could:&lt;br/&gt;
1) make the new port fully b/w compatible with the existing functionality&lt;br/&gt;
2) enable long lived sessions rather than polling&lt;br/&gt;
3) provide support for &quot;extended command syntax&quot; which would enhance 4lw features (for example to control the format of the output)&lt;br/&gt;
4) etc...&lt;/p&gt;

&lt;p&gt;I realize this doesn&apos;t fix the existing, but it does provide for a reasonable way forward &amp;#8211; we&apos;ll pay off some debt.&lt;/p&gt;</comment>
                            <comment id="13126025" author="phunt" created="Wed, 12 Oct 2011 19:29:52 +0100"  >&lt;p&gt;4) use netty to implement this (no nio)&lt;/p&gt;</comment>
                            <comment id="13126179" author="fournc" created="Wed, 12 Oct 2011 22:40:33 +0100"  >&lt;p&gt;I think that makes sense. We should be very clear about the fact that we can&apos;t support nc non-interactive with netty unless netty actually starts to support it. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12468677">ZOOKEEPER-805</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12536622">ZOOKEEPER-1346</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12443310" name="ZOOKEEPER-737.patch" size="24933" author="mahadev" created="Fri, 30 Apr 2010 19:59:56 +0100"/>
                            <attachment id="12443006" name="ZOOKEEPER-737.patch" size="8641" author="mahadev" created="Tue, 27 Apr 2010 22:37:17 +0100"/>
                            <attachment id="12442903" name="ZOOKEEPER-737.patch" size="8525" author="mahadev" created="Mon, 26 Apr 2010 22:39:57 +0100"/>
                            <attachment id="12442478" name="ZOOKEEPER-737.patch" size="8332" author="mahadev" created="Wed, 21 Apr 2010 21:28:03 +0100"/>
                            <attachment id="12442455" name="ZOOKEEPER-737.patch" size="9061" author="phunt" created="Wed, 21 Apr 2010 19:07:50 +0100"/>
                            <attachment id="12442394" name="ZOOKEEPER-737.patch" size="7717" author="mahadev" created="Wed, 21 Apr 2010 05:50:10 +0100"/>
                            <attachment id="12442363" name="ZOOKEEPER-737.patch" size="7619" author="mahadev" created="Tue, 20 Apr 2010 23:49:21 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 20 Apr 2010 22:49:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47626</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzubj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32896</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>