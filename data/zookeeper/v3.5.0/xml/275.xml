<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:40:41 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-275/ZOOKEEPER-275.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-275] Bug in FastLeaderElection</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-275</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;I found an execution in which leader election does not make progress. Here is the problematic scenario:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We have an ensemble of 3 servers, and we start only 2;&lt;/li&gt;
	&lt;li&gt;We let them elect a leader, and then crash the one with lowest id, say S_1 (call the other S_2);&lt;/li&gt;
	&lt;li&gt;We restart the crashed server.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Upon restarting S_1, S_2 has its logical clock more advanced, and S_1 has its logical clock set to 1. Once S_1 receives a notification from S_2, it notices that it is in the wrong round and it advances its logical clock to the same value as S_1. Now, the problem comes exactly in this point because in the current code S_1 resets its vote to its initial vote (its own id and zxid). Since S_2 has already notified S_1, it won&apos;t do it again, and we are stuck. The patch I&apos;m submitting fixes this problem by setting the vote of S_1 to the one received if it satisfies the total order predicate (&quot;received zxid&quot; is higher or &quot;received zxid is the same and received id is higher&quot;).&lt;/p&gt;

&lt;p&gt;Related to this problem, I noticed that by trying to avoid unnecessary notification duplicates, there could be scenarios in which a server fails before electing a leader and restarts before leader election succeeds. This could happen, for example, when there isn&apos;t enough servers available and one available crashes and restarts. I fixed this problem in the attached patch by allowing a server to send a new batch of notifications if there is at least one outgoing queue of pending notifications empty. This is ok because we space out consecutive batches of notifications. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12412495">ZOOKEEPER-275</key>
            <summary>Bug in FastLeaderElection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Junqueira</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Jan 2009 15:18:00 +0000</created>
                <updated>Fri, 13 Feb 2009 21:18:54 +0000</updated>
                            <resolved>Thu, 29 Jan 2009 23:11:41 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.0.1</version>
                                    <fixVersion>3.1.0</fixVersion>
                                    <component>leaderElection</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12664133" author="fpj" created="Thu, 15 Jan 2009 15:22:34 +0000"  >&lt;p&gt;Patch for the problems described. Includes a unit test for the first case. The second case is difficult and I still don&apos;t have a good idea of how to write a unit test for it. In particular, I haven&apos;t been able to crash and restart a peer in a unit test because when I kill the listener of QuorumCnxManager and try to create another instance, it complains that the port is in use. I tried using setReuseAddress(true) before binding, but it still doesn&apos;t work. &lt;/p&gt;</comment>
                            <comment id="12666786" author="phunt" created="Fri, 23 Jan 2009 23:39:19 +0000"  >&lt;p&gt;What do you mean by &quot;kill qcnxmanager&quot;? During the &quot;kill&quot; is the code explicitly closing the port? It might be that the socket isn&apos;t being closed explicitly? (relies on gc?)&lt;/p&gt;

&lt;p&gt;Ensure that the code will explicitly close the port if &quot;killed&quot;.&lt;/p&gt;

&lt;p&gt;If you&apos;re done on this issue you might consider submitting the patch for review.&lt;/p&gt;</comment>
                            <comment id="12666934" author="fpj" created="Sat, 24 Jan 2009 14:18:53 +0000"  >&lt;p&gt;&quot;kills&quot; means calling the shutdown method of QuorumCnxManager.Listener. I referred to &quot;kill&quot; because this is how I reproduce the problem out of unit tests, by just killing the server (ctrl-c). Now, we do close the socket there, but from I found on the net, calling close and having it returning doesn&apos;t mean that the port is released.&lt;/p&gt;

&lt;p&gt;This patch is good for me, but it doesn&apos;t include the unit test for the case we are discussing. Although I think it is trivial the correction to the problem pointed out, having a unit tests would prevent us from making the same mistake in the future. So, I&apos;d like to submit the current patch for review and perhaps open another JIRA for the unit test if you think it is worth having it.   &lt;/p&gt;</comment>
                            <comment id="12668576" author="mahadev" created="Thu, 29 Jan 2009 19:55:39 +0000"  >&lt;p&gt;the patch does not apply any mroe. I tried creating a new patch but its a little tricky so I didnt want to mess up the patch. Can you regenerate the patch Flavio?&lt;/p&gt;</comment>
                            <comment id="12668608" author="mahadev" created="Thu, 29 Jan 2009 21:16:58 +0000"  >&lt;p&gt;the patch looks good. Here are my comments - &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it adds a lot of LOG.info messages to FastLeaderElection and QuorumCnxn. Do we really need that? It introduces a lot of noise in the logs. I probably think we should mark them as debug messages&lt;/li&gt;
	&lt;li&gt;also
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  408.               LOG.info(&quot;My election bind port: &quot; + port);
  409.             LOG.warn(&quot;My election bind port: &quot; + port);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;should be fixed.&lt;/p&gt;</comment>
                            <comment id="12668647" author="mahadev" created="Thu, 29 Jan 2009 22:34:47 +0000"  >&lt;p&gt;fixed some log.info to be log.debug and fixed the duplicated log messages as well.&lt;/p&gt;</comment>
                            <comment id="12668651" author="mahadev" created="Thu, 29 Jan 2009 22:52:46 +0000"  >&lt;p&gt;the last patches fail with compile-test since one of the test uses an old api.&lt;/p&gt;</comment>
                            <comment id="12668658" author="mahadev" created="Thu, 29 Jan 2009 23:11:41 +0000"  >&lt;p&gt;I just committed this. Thanks flavio.&lt;/p&gt;</comment>
                            <comment id="12669568" author="hudson" created="Mon, 2 Feb 2009 11:49:18 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #217 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/217/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/217/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12399056" name="ZOOKEEPER-275.patch" size="13745" author="mahadev" created="Thu, 29 Jan 2009 22:52:46 +0000"/>
                            <attachment id="12399054" name="ZOOKEEPER-275.patch" size="13798" author="mahadev" created="Thu, 29 Jan 2009 22:34:47 +0000"/>
                            <attachment id="12399040" name="ZOOKEEPER-275.patch" size="13704" author="fpj" created="Thu, 29 Jan 2009 20:53:13 +0000"/>
                            <attachment id="12397974" name="ZOOKEEPER-275.patch" size="13707" author="fpj" created="Thu, 15 Jan 2009 15:22:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 23 Jan 2009 23:39:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47927</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzvwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33152</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>