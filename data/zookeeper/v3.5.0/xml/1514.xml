<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:48:20 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1514/ZOOKEEPER-1514.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1514] FastLeaderElection - leader ignores the round information when joining a quorum</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1514</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In the following case we have a 3 server ensemble.&lt;/p&gt;

&lt;p&gt;Initially all is well, zk3 is the leader.&lt;/p&gt;

&lt;p&gt;However zk3 fails, restarts, and rejoins the quorum as the new leader (was the old leader, still the leader after re-election)&lt;/p&gt;

&lt;p&gt;The existing two followers, zk1 and zk2 rejoin the new quorum again as followers of zk3.&lt;/p&gt;

&lt;p&gt;zk1 then fails, the datadirectory is deleted (so it has no state whatsoever) and restarted. However zk1 can never rejoin the quorum (even after an hour). During this time zk2 and zk3 are serving properly.&lt;/p&gt;

&lt;p&gt;Later all three servers are later restarted and properly form a functional quourm.&lt;/p&gt;


&lt;p&gt;Here are some interesting log snippets. Nothing else of interest was seen in the logs during this time:&lt;/p&gt;

&lt;p&gt;zk3. This is where it becomes the leader after failing initially (as the leader). Notice the &quot;round&quot; is ahead of zk1 and zk2:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-07-18 17:19:35,423 - INFO  [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@663] - New election. My id =  3, Proposed zxid = 77309411648
2012-07-18 17:19:35,423 - INFO  [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 77309411648 (n.zxid), 832 (n.round), LOOKING (n.state), 3 (n.sid), LOOKING (my state)
2012-07-18 17:19:35,424 - INFO  [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 73014444480 (n.zxid), 831 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)
2012-07-18 17:19:35,424 - INFO  [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 73014444480 (n.zxid), 831 (n.round), FOLLOWING (n.state), 1 (n.sid), LOOKING (my state)
2012-07-18 17:19:35,424 - INFO  [QuorumPeer:/0.0.0.0:2181:QuorumPeer@655] - LEADING
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;zk1 which won&apos;t come back. Notice that zk3 is reporting the round as 831, while zk2 thinks that the round is 832:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-07-18 17:31:12,015 - INFO  [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 1 (n.leader), 77309411648 (n.zxid), 1 (n.round), LOOKING (n.state), 1 (n.sid), LOOKING (my state)
2012-07-18 17:31:12,016 - INFO  [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 73014444480 (n.zxid), 831 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)
2012-07-18 17:31:12,017 - INFO  [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 77309411648 (n.zxid), 832 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)
2012-07-18 17:31:15,219 - INFO  [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@697] - Notification time out: 6400
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12599561">ZOOKEEPER-1514</key>
            <summary>FastLeaderElection - leader ignores the round information when joining a quorum</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Junqueira</assignee>
                                    <reporter username="phunt">Patrick Hunt</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jul 2012 01:52:33 +0100</created>
                <updated>Fri, 3 Aug 2012 11:55:21 +0100</updated>
                            <resolved>Thu, 2 Aug 2012 23:29:52 +0100</resolved>
                                    <version>3.3.4</version>
                                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>quorum</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13419431" author="fpj" created="Fri, 20 Jul 2012 19:49:21 +0100"  >&lt;p&gt;Patch to fix this issue including test.&lt;/p&gt;</comment>
                            <comment id="13419465" author="hadoopqa" created="Fri, 20 Jul 2012 20:19:06 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12537385/ZOOKEEPER-1514.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12537385/ZOOKEEPER-1514.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1362660.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    -1 release audit.  The applied patch generated 25 release audit warnings (more than the trunk&apos;s current 24 warnings).&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//testReport/&lt;/a&gt;&lt;br/&gt;
Release audit warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1140//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13419763" author="fpj" created="Sat, 21 Jul 2012 09:30:03 +0100"  >&lt;p&gt;Ooops, small glitch, forgot to add the license header.&lt;/p&gt;</comment>
                            <comment id="13419766" author="fpj" created="Sat, 21 Jul 2012 09:36:32 +0100"  >&lt;p&gt;Added missing license header.&lt;/p&gt;</comment>
                            <comment id="13419776" author="hadoopqa" created="Sat, 21 Jul 2012 10:08:29 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12537441/ZOOKEEPER-1514.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12537441/ZOOKEEPER-1514.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1362660.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1142//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1142//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1142//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1142//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1142//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1142//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13420379" author="henryr" created="Mon, 23 Jul 2012 02:06:49 +0100"  >&lt;p&gt;Hey Flavio - &lt;/p&gt;

&lt;p&gt;Thanks for fixing this so quickly! Patch looks really nice, a few nits:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I don&apos;t think you need to duplicate &lt;tt&gt;createMsg&lt;/tt&gt; in &lt;tt&gt;FLEBackwardElectionRound&lt;/tt&gt;, since it&apos;s now in &lt;tt&gt;FLETestUtils&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Could you add a comment to &lt;tt&gt;FLEBackwardElectionRound.testBackwardElectionRound&lt;/tt&gt; describing the bug it&apos;s testing for, and I guess referencing this JIRA?&lt;/li&gt;
	&lt;li&gt;If &lt;tt&gt;listener&lt;/tt&gt; is &lt;tt&gt;null&lt;/tt&gt; for &lt;tt&gt;QuorumCnxManager.Listener listener = cnxManagers&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.listener;&lt;/tt&gt; and similar, shouldn&apos;t the test fail straight away? Under what circumstances would this be true?&lt;/li&gt;
	&lt;li&gt;There&apos;s a small typo - &apos;instace&apos; -&amp;gt; &apos;instance&apos;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13420487" author="fpj" created="Mon, 23 Jul 2012 08:44:29 +0100"  >&lt;p&gt;Thanks for the review, Henry. There is one comment that we need to discuss quickly, the others are straightforward to fix.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If listener is null for &lt;tt&gt;QuorumCnxManager.Listener listener = cnxManagers&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.listener;&lt;/tt&gt; and similar, shouldn&apos;t the test fail straight away? Under what circumstances would this be true?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We have these checks in other tests too, so I&apos;m wondering if it could be that we introduced the null checks for listeners due to findbugs warnings. I see no particular reason for having it null, though.&lt;/p&gt;

&lt;p&gt;As for failing the test, it is not really that the test has failed if the listener is null, it is an error. Should we throw an exception in this case instead of failing the test?  &lt;/p&gt;</comment>
                            <comment id="13423443" author="henryr" created="Thu, 26 Jul 2012 21:39:05 +0100"  >&lt;p&gt;I&apos;m not sure that removing the null checks would mean findbugs warnings (easy to try!) - and if the listener is null, the test will throw an NPE and fail anyhow which seems like the right thing to do. So I would suggest just removing the null checks. What do you think?&lt;/p&gt;</comment>
                            <comment id="13423776" author="fpj" created="Fri, 27 Jul 2012 11:06:17 +0100"  >&lt;p&gt;I used blame to track where we have introduced the check in tests for the first time. I believe it started with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-480&quot; title=&quot;FLE should perform leader check when node is not leading and add vote of follower&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-480&quot;&gt;&lt;del&gt;ZOOKEEPER-480&lt;/del&gt;&lt;/a&gt;, and we were essentially trying to implement a mock server. If you check QuorumPeer.createElectionAlgorithm(), this is essentially what we are doing there. I&apos;d rather leave as is, and if you feel we need to revisit the way we are starting the listener, then perhaps we need to create another jira for it, since it touches other parts of the code base.&lt;/p&gt;

&lt;p&gt;I&apos;ll upload a patch with the other modifications you suggested, so that if you agree with my assessment, then we can move forward with that one. &lt;/p&gt;</comment>
                            <comment id="13423789" author="hadoopqa" created="Fri, 27 Jul 2012 11:48:30 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12538144/ZOOKEEPER-1514.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12538144/ZOOKEEPER-1514.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1362660.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1145//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1145//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1145//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1145//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1145//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1145//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13424286" author="henryr" created="Sat, 28 Jul 2012 07:43:10 +0100"  >&lt;p&gt;Flavio - this looks fine. The point I am trying to make about this bit of code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(listener != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;){
    listener.start();
  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Null listener when initializing cnx manager&quot;&lt;/span&gt;);
    Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to create cnx manager&quot;&lt;/span&gt;);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;is that there&apos;s no need for the null check, since if &lt;tt&gt;listener&lt;/tt&gt; is null, there&apos;ll be an NPE thrown which will fail the test anyhow. Plus, looking at &lt;tt&gt;QuorumCnxManager.java:153&lt;/tt&gt;, I can&apos;t see any way in which &lt;tt&gt;listener&lt;/tt&gt; can be null, because it&apos;s unambiguously assigned to a &lt;tt&gt;new Listener()&lt;/tt&gt;. Is there a case that I&apos;m missing?&lt;/p&gt;

&lt;p&gt;I know this doesn&apos;t really affect the functionality of the patch, but if these checks aren&apos;t necessary, it will be confusing to the reader in the future. &lt;/p&gt;</comment>
                            <comment id="13424388" author="fpj" created="Sat, 28 Jul 2012 18:36:48 +0100"  >&lt;p&gt;Hi Henry, I believe I understand the point you&apos;re raising, so perhaps I&apos;m not making myself clear. Let me try to add more detail.&lt;/p&gt;

&lt;p&gt;This null check:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  if(listener != null){
    listener.start();
  } else {
    LOG.error(&quot;Null listener when initializing cnx manager&quot;);
    Assert.fail(&quot;Failed to create cnx manager&quot;);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;appears in a number of places in the code, essentially every time we use the listener. The first time it appeared was in QuorumPeer.createElectionAlgorithm() due to findbugs warnings as I mentioned before (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-407&quot; title=&quot;address all findbugs warnings in org.apache.zookeeper.server.quorum.** packages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-407&quot;&gt;&lt;del&gt;ZOOKEEPER-407&lt;/del&gt;&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;When we created a mock server for FLELostMessageTest, we simply copied that part that starts a listener. Currently, it appears in at least a couple of places, and if I remove from this patch, we should also remove from the other places. But, removing it from the other parts of the code is not part of this issue, so if you feel strongly about this change, I suggest we leave the patch with this check in and discuss removing the null check in another jira so that we make uniform changes across the code, not mixing the issues.  &lt;/p&gt;

</comment>
                            <comment id="13425397" author="henryr" created="Tue, 31 Jul 2012 00:43:20 +0100"  >&lt;p&gt;Hi Flavio - &lt;/p&gt;

&lt;p&gt;I don&apos;t really mind the check, it&apos;s just completely unnecessary (since listener == null =&amp;gt; NPE =&amp;gt; failed test). Let&apos;s keep it in if you think it is important. &lt;/p&gt;

&lt;p&gt;What is a problem, and I agree not worth fixing here, is that this is yet another example of class members not being hidden behind getters / setters that maintain correct invariants. Anyone can set listener to null, because it&apos;s a non-final public member, so every read of that variable in code that mustn&apos;t crash has to defensively check that it&apos;s not null, when we should be relying on the class to do this for us. &lt;/p&gt;

&lt;p&gt;Anyhow, this looks ok to me - +1, happy to commit. &lt;/p&gt;</comment>
                            <comment id="13426138" author="fpj" created="Tue, 31 Jul 2012 22:16:42 +0100"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t really mind the check, it&apos;s just completely unnecessary (since listener == null =&amp;gt; NPE =&amp;gt; failed test). Let&apos;s keep it in if you think it is important. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds fine, I&apos;ll remove the check from both tests and upload a new patch. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What is a problem, and I agree not worth fixing here, is that this is yet another example of class members not being hidden behind getters / setters that maintain correct invariants. Anyone can set listener to null, because it&apos;s a non-final public member, so every read of that variable in code that mustn&apos;t crash has to defensively check that it&apos;s not null, when we should be relying on the class to do this for us. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I totally agree. I think we did not expect the listener object to be called in multiple places and were a bit lazy. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="13426172" author="hadoopqa" created="Tue, 31 Jul 2012 23:14:48 +0100"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12538623/ZOOKEEPER-1514.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12538623/ZOOKEEPER-1514.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1366784.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1148//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1148//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1148//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1148//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1148//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1148//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13427679" author="henryr" created="Thu, 2 Aug 2012 23:29:53 +0100"  >&lt;p&gt;I just committed this to branch-3.4 and trunk. Thanks Flavio!&lt;/p&gt;

&lt;p&gt;Unfortunately the patch does not apply nicely to 3.3, because electionEpoch was introduced in a commit that&apos;s not in branch 3.3 (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1082&quot; title=&quot;modify leader election to correctly take into account current epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1082&quot;&gt;&lt;del&gt;ZOOKEEPER-1082&lt;/del&gt;&lt;/a&gt;). I&apos;m comfortable leaving this as a known issue in branch 3.3, since I think it crops up only in a uncommon scenario, and has a workaround.&lt;/p&gt;</comment>
                            <comment id="13427988" author="hudson" created="Fri, 3 Aug 2012 11:55:21 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1635 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1635/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1635/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1514&quot; title=&quot;FastLeaderElection - leader ignores the round information when joining a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1514&quot;&gt;&lt;del&gt;ZOOKEEPER-1514&lt;/del&gt;&lt;/a&gt;. FastLeaderElection - leader ignores the round information when joining a quorum (flavio via henryr) (Revision 1368737)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
henry : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1368737&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1368737&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/FLEBackwardElectionRoundTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/FLELostMessageTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/FLETestUtils.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12538623" name="ZOOKEEPER-1514.patch" size="14192" author="fpj" created="Tue, 31 Jul 2012 22:29:11 +0100"/>
                            <attachment id="12538144" name="ZOOKEEPER-1514.patch" size="14251" author="fpj" created="Fri, 27 Jul 2012 11:17:12 +0100"/>
                            <attachment id="12537441" name="ZOOKEEPER-1514.patch" size="13791" author="fpj" created="Sat, 21 Jul 2012 09:35:14 +0100"/>
                            <attachment id="12537385" name="ZOOKEEPER-1514.patch" size="12781" author="fpj" created="Fri, 20 Jul 2012 19:49:21 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 20 Jul 2012 18:49:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242192</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwdwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12739</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>