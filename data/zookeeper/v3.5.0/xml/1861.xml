<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:48:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1861/ZOOKEEPER-1861.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1861] ConcurrentHashMap isn&apos;t used properly in QuorumCnxManager</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1861</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;queueSendMap is a ConcurrentHashMap.&lt;br/&gt;
At line 210:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!queueSendMap.containsKey(sid)) {
                queueSendMap.put(sid, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayBlockingQueue&amp;lt;ByteBuffer&amp;gt;(
                        SEND_CAPACITY));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;By the time control enters if block, there may be another concurrent put with same sid to the ConcurrentHashMap.&lt;br/&gt;
putIfAbsent() should be used.&lt;/p&gt;

&lt;p&gt;Similar issue occurs at line 307 as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12688419">ZOOKEEPER-1861</key>
            <summary>ConcurrentHashMap isn&apos;t used properly in QuorumCnxManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhihyu@ebaysf.com">Ted Yu</assignee>
                                    <reporter username="yuzhihong@gmail.com">Ted Yu</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Jan 2014 23:50:07 +0000</created>
                <updated>Fri, 14 Feb 2014 03:03:33 +0000</updated>
                            <resolved>Fri, 14 Feb 2014 03:03:33 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13869840" author="michim" created="Mon, 13 Jan 2014 19:06:54 +0000"  >&lt;p&gt;Thank you for the bug report Ted. Would it be ok if I assign the ticket to you?&lt;/p&gt;</comment>
                            <comment id="13869923" author="yuzhihong@gmail.com" created="Mon, 13 Jan 2014 20:20:59 +0000"  >&lt;p&gt;Sure.&lt;/p&gt;

&lt;p&gt;Here is the patch.&lt;/p&gt;</comment>
                            <comment id="13870003" author="michim" created="Mon, 13 Jan 2014 21:21:28 +0000"  >&lt;p&gt;Thank you for the patch Ted. Here are my comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This patch only fixes the issue at line 210, but not the one at 307.&lt;/li&gt;
	&lt;li&gt;There is a similar issue at 338, though this one is slightly more complicated since it does more than putting something in a map inside the containsKey block.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13870037" author="hadoopqa" created="Mon, 13 Jan 2014 21:54:24 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12622695/zookeeper-1861-v1.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12622695/zookeeper-1861-v1.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1556976.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1881//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1881//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1881//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1881//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1881//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1881//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13870040" author="yuzhihong@gmail.com" created="Mon, 13 Jan 2014 21:55:13 +0000"  >&lt;p&gt;Patch v2 addresses Michi&apos;s comments&lt;/p&gt;</comment>
                            <comment id="13870072" author="hadoopqa" created="Mon, 13 Jan 2014 22:33:55 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12622714/zookeeper-1861-v2.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12622714/zookeeper-1861-v2.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1556976.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1882//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1882//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1882//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1882//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1882//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1882//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13870966" author="yuzhihong@gmail.com" created="Tue, 14 Jan 2014 17:52:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michim&quot; class=&quot;user-hover&quot; rel=&quot;michim&quot;&gt;Michi Mutsuzaki&lt;/a&gt;:&lt;br/&gt;
Can you take a look at patch v2 ?&lt;/p&gt;</comment>
                            <comment id="13871180" author="michim" created="Tue, 14 Jan 2014 21:08:06 +0000"  >&lt;p&gt;With this patch, we allocate bq even when we don&apos;t use it. I&apos;m not sure if we want to do that. I&apos;ll let somebody more familiar with the code base review the patch.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
--Michi&lt;/p&gt;</comment>
                            <comment id="13871657" author="yuzhihong@gmail.com" created="Wed, 15 Jan 2014 05:12:26 +0000"  >&lt;p&gt;To avoid allocating extra ArrayBlockingQueue, I am thinking of the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;create a singleton ArrayBlockingQueue which serves as marker&lt;/li&gt;
	&lt;li&gt;if queueSendMap.putIfAbsent(sid, singleton) returns null, create the real ArrayBlockingQueue, named bq, and call queueSendMap.replace(sid, bq)&lt;/li&gt;
	&lt;li&gt;if queueSendMap.putIfAbsent(sid, singleton) returns non-null value, check whether the return is singleton, if so, wait till queueSendMap.get(sid) returns a value which is not singleton.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13872288" author="yuzhihong@gmail.com" created="Wed, 15 Jan 2014 17:16:51 +0000"  >&lt;p&gt;The above suggestion would involve more complex logic.&lt;/p&gt;

&lt;p&gt;Maybe the first two hunks in patch v2 can be integrated first ?&lt;/p&gt;</comment>
                            <comment id="13897335" author="yuzhihong@gmail.com" created="Tue, 11 Feb 2014 00:27:40 +0000"  >&lt;p&gt;Further review on this would be appreciated.&lt;/p&gt;</comment>
                            <comment id="13897356" author="rgs" created="Tue, 11 Feb 2014 00:44:20 +0000"  >&lt;p&gt;How are the first hunks different? They also do the allocation even though you might not need them as well, no? I think that to avoid eagerly allocating and solve the concurrency issues you could put the check/set bits in a synchronized method and call that instead. &lt;/p&gt;</comment>
                            <comment id="13898187" author="yuzhihong@gmail.com" created="Tue, 11 Feb 2014 19:24:25 +0000"  >&lt;p&gt;How about patch v3 ?&lt;/p&gt;</comment>
                            <comment id="13898342" author="hadoopqa" created="Tue, 11 Feb 2014 21:33:56 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12628301/zookeeper-1861-v3.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12628301/zookeeper-1861-v3.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1566748.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1923//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1923//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1923//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1923//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1923//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1923//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13898627" author="fournc" created="Wed, 12 Feb 2014 01:28:55 +0000"  >&lt;p&gt;Need to fix the formatting on that new method. Other than that, looks ok to me.&lt;/p&gt;</comment>
                            <comment id="13898637" author="fournc" created="Wed, 12 Feb 2014 01:37:29 +0000"  >&lt;p&gt;Actually, I&apos;m going to go back on this. The whole point of using a concurrent data structure is so we don&apos;t synchronize on this operation. Which means we have to allocate potentially unnecessarily.&lt;br/&gt;
I prefer patch v2. If you really want to try and not worry about allocation, check for existence, then create, and put if not absent, but meh. I don&apos;t know that I care about an (unlikely) extra allocation.&lt;/p&gt;</comment>
                            <comment id="13898727" author="yuzhihong@gmail.com" created="Wed, 12 Feb 2014 03:11:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;I prefer patch v2&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree.&lt;/p&gt;

&lt;p&gt;Patch v3 basically makes the map a HashMap.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;then create, and put if not absent&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I guess you meant &apos;put if absent&apos;&lt;/p&gt;

&lt;p&gt;The chance of extra allocation should be low.&lt;/p&gt;</comment>
                            <comment id="13899478" author="fournc" created="Wed, 12 Feb 2014 19:34:07 +0000"  >&lt;p&gt;Yup. I&apos;m gonna put in patch v2 unless someone else has a comment.&lt;/p&gt;</comment>
                            <comment id="13901065" author="hudson" created="Fri, 14 Feb 2014 02:59:35 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2217 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2217/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2217/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1861&quot; title=&quot;ConcurrentHashMap isn&amp;#39;t used properly in QuorumCnxManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1861&quot;&gt;&lt;del&gt;ZOOKEEPER-1861&lt;/del&gt;&lt;/a&gt;. ConcurrentHashMap isn&apos;t used properly in QuorumCnxManager (Ted Yu via camille) (camille: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1568176&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1568176&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12622695" name="zookeeper-1861-v1.txt" size="765" author="yuzhihong@gmail.com" created="Mon, 13 Jan 2014 20:20:59 +0000"/>
                            <attachment id="12622714" name="zookeeper-1861-v2.txt" size="2259" author="yuzhihong@gmail.com" created="Mon, 13 Jan 2014 21:55:13 +0000"/>
                            <attachment id="12628301" name="zookeeper-1861-v3.txt" size="2586" author="yuzhihong@gmail.com" created="Tue, 11 Feb 2014 19:24:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 13 Jan 2014 19:06:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367438</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzl6nr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367747</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>