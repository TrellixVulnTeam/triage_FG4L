<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:47:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-251/ZOOKEEPER-251.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-251] NullPointerException stopping and starting Zookeeper servers</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-251</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;See the following thread for the original report:&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/hadoop-zookeeper-user/200812.mbox/browser&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/hadoop-zookeeper-user/200812.mbox/browser&lt;/a&gt;&lt;br/&gt;
Steps to reproduce:&lt;br/&gt;
1) Start a replicated zookeeper service consisting of 3 zookeeper (3.0.1) servers all running on the same host (of course, all using their own ports and log directories)&lt;br/&gt;
2) Create one znode in this ensemble (using the zookeeper client console, I issued &apos;create /node1 node1data&apos;).&lt;br/&gt;
3) Stop, then restart a single zookeeper server; moving onto the next one a few seconds later. &lt;br/&gt;
4) Go back to 3. After 4-5 iterations, the following should occur, with the failing server exiting:&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:447)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.init(FileTxnLog.java:358)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.&amp;lt;init&amp;gt;(FileTxnLog.java:333)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnLog.read(FileTxnLog.java:250)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:102)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.ZooKeeperServer.loadData(ZooKeeperServer.java:183)&lt;br/&gt;
        at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:245)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:421)&lt;br/&gt;
2008-12-08 14:14:24,880 - INFO  &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:/0:0:0:0:0:0:0:0:2183:Leader@336&amp;#93;&lt;/span&gt; - Shutdown called&lt;br/&gt;
java.lang.Exception: shutdown Leader! reason: Forcing shutdown&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:336)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:427)&lt;br/&gt;
Exception in thread &quot;QuorumPeer:/0:0:0:0:0:0:0:0:2183&quot; &lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:339)&lt;br/&gt;
        at &lt;br/&gt;
org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:427)&lt;/p&gt;

&lt;p&gt;The inputStream field is null, apparently because next is being called &lt;br/&gt;
at line 358 even after next returns false. Having very little knowledge &lt;br/&gt;
about the implementation, I don&apos;t know if the existence of hdr.getZxid() &lt;br/&gt;
 &amp;gt;= zxid is supposed to be an invariant across all invocations of the &lt;br/&gt;
server; however the following change to FileTxnLog.java seems to make &lt;br/&gt;
the problem go away.&lt;br/&gt;
diff FileTxnLog.java /tmp/FileTxnLog.java&lt;br/&gt;
358c358,359&lt;br/&gt;
&amp;lt;                 next();&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
 &amp;gt;               if (!next())&lt;br/&gt;
 &amp;gt;                   return;&lt;br/&gt;
447c448,450&lt;br/&gt;
&amp;lt;                 inputStream.close();&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
 &amp;gt;               if (inputStream != null) &lt;/p&gt;
{
 &amp;gt;                   inputStream.close();
 &amp;gt;               }</description>
                <environment>&lt;p&gt;Tested with JDK 1.5, Solaris, but I suspect it is not relevant in this case.&lt;/p&gt;</environment>
        <key id="12410220">ZOOKEEPER-251</key>
            <summary>NullPointerException stopping and starting Zookeeper servers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mahadev">Mahadev konar</assignee>
                                    <reporter username="vinodjohnson">Thomas Vinod Johnson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Dec 2008 21:29:01 +0000</created>
                <updated>Fri, 13 Feb 2009 21:18:53 +0000</updated>
                            <resolved>Wed, 10 Dec 2008 21:55:46 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.0.1</version>
                                    <fixVersion>3.1.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12654583" author="phunt" created="Mon, 8 Dec 2008 21:35:03 +0000"  >&lt;p&gt;Looks to me like the issue is in the while loop:&lt;/p&gt;

&lt;p&gt;            goToNextLog();&lt;br/&gt;
            if (!next())&lt;br/&gt;
                return;&lt;br/&gt;
            while (hdr.getZxid() &amp;lt; zxid) &lt;/p&gt;
{
                next();  // ISSUE IS HERE
            }

&lt;p&gt;we aren&apos;t checking the next return value, we will call next again, which will fail if next previously returned false (ia will not be null but inputstream might be)&lt;/p&gt;

&lt;p&gt;The question in my mind is what Thomas asked - why is hdr zxid &amp;lt; zxid and next returning false? Is this ok, or signalling a problem elsewhere?&lt;/p&gt;</comment>
                            <comment id="12654617" author="mahadev" created="Mon, 8 Dec 2008 22:45:13 +0000"  >&lt;p&gt;i found the problem. The problem occurs when the snapshots are well ahead of the logs. That would be the case when the server is brought up and down and there are not trasactions on it. So there are no new logs to be applied to the snapshot. This is due to the bug that&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;while (hdr.getZxid() &amp;lt; zxid) {
               next()) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;does not check the value of next() &lt;/p&gt;

&lt;p&gt;and also &lt;/p&gt;

&lt;p&gt;next() itself does not keep ia and inputstream syncrhonous.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  } catch (EOFException e) {
                LOG.info(&quot;EOF exception &quot;, e);
                inputStream.close();
                inputStream = null;
                // thsi means that the file has ended 
                // we shoud go to the next file
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should be &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  } catch (EOFException e) {
                LOG.info(&quot;EOF exception &quot;, e);
                inputStream.close();
                inputStream = null;
                ia = null;
                // thsi means that the file has ended 
                // we shoud go to the next file
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="12654618" author="mahadev" created="Mon, 8 Dec 2008 22:45:50 +0000"  >&lt;p&gt;ill file a patch shortly with a testcase.... thanks thomas&lt;/p&gt;</comment>
                            <comment id="12654627" author="mahadev" created="Mon, 8 Dec 2008 23:02:26 +0000"  >&lt;p&gt;also  this does not seem to happen in a quorum... i think i know the reason why ... but will update the jira with my findings... &lt;/p&gt;</comment>
                            <comment id="12654664" author="mahadev" created="Tue, 9 Dec 2008 00:24:06 +0000"  >&lt;p&gt;can you try this patch out thomas?&lt;br/&gt;
adding a test might be a little hard since the situation arises after switching from quorum to standalone. let me try and see if I can reproduce this as a junit test... &lt;/p&gt;</comment>
                            <comment id="12654811" author="vinodjohnson" created="Tue, 9 Dec 2008 14:46:41 +0000"  >&lt;p&gt;Thank you. Post patch, I don&apos;t see the exceptions. To clear up confusion on my part, when you say &quot;the situation arises after switching from quorum to standalone&quot;, you are referring to the single server that is stopped and started, and not the ensemble as a whole? I believe that throughout the test, I was maintaining quorum by having at least 2 out of 3 servers running and communicating to each other.&lt;/p&gt;</comment>
                            <comment id="12654870" author="mahadev" created="Tue, 9 Dec 2008 17:54:04 +0000"  >&lt;p&gt;sorry i must have been confused. I though the servers were started as quorum and then one of them pulled out of quorum and started as a standalone server. This will actually create the problem quote easily. The 3 quorum servers and killing one at a time is another way to do it (now that i realize it).&lt;/p&gt;</comment>
                            <comment id="12654947" author="mahadev" created="Tue, 9 Dec 2008 20:26:42 +0000"  >&lt;p&gt;this patch adds a test. IT was difficult to create a test that can recreate the problem. The attaches test sometimes fails without the patch but passes the tests with the patch.&lt;/p&gt;</comment>
                            <comment id="12655379" author="phunt" created="Wed, 10 Dec 2008 21:55:46 +0000"  >&lt;p&gt;+1 - looks good, tests pass.&lt;/p&gt;

&lt;p&gt;Committed revision 725454.&lt;/p&gt;</comment>
                            <comment id="12655603" author="hudson" created="Thu, 11 Dec 2008 11:06:41 +0000"  >&lt;p&gt;Integrated in ZooKeeper-trunk #169 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/169/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/169/&lt;/a&gt;)&lt;br/&gt;
    . NullPointerException stopping and starting Zookeeper servers&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12395675" name="ZOOKEEPER-251.patch" size="5589" author="mahadev" created="Tue, 9 Dec 2008 20:26:42 +0000"/>
                            <attachment id="12395608" name="ZOOKEEPER-251.patch" size="877" author="mahadev" created="Tue, 9 Dec 2008 00:24:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 8 Dec 2008 21:35:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47945</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzvzb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33165</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>