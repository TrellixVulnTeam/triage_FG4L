<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:46:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-127/ZOOKEEPER-127.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-127] Use of non-standard election ports in config breaks services</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-127</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In QuorumCnxManager.toSend there is a call to create a connection as follows:&lt;br/&gt;
    channel = SocketChannel.open(new InetSocketAddress(addr, port));&lt;/p&gt;

&lt;p&gt;Unfortunately &quot;addr&quot; is the ip address of a remote server while &quot;port&quot; is the electionPort of &lt;b&gt;this&lt;/b&gt; server.&lt;br/&gt;
As an example, given this configuration (taken from my zoo.cfg)&lt;br/&gt;
  server.1=10.20.9.254:2881&lt;br/&gt;
  server.2=10.20.9.9:2882&lt;br/&gt;
  server.3=10.20.9.254:2883&lt;br/&gt;
Server 3 was observed trying to make a connection to host 10.20.9.9 on port 2883 and obviously failing.&lt;/p&gt;

&lt;p&gt;In tests where all machines use the same electionPort this bug would not manifest itself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12403150">ZOOKEEPER-127</key>
            <summary>Use of non-standard election ports in config breaks services</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Junqueira</assignee>
                                    <reporter username="markh">Mark Harwood</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Aug 2008 14:18:34 +0100</created>
                <updated>Thu, 12 Nov 2009 15:23:30 +0000</updated>
                            <resolved>Wed, 1 Oct 2008 09:40:15 +0100</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>quorum</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12626107" author="fpj" created="Wed, 27 Aug 2008 14:25:05 +0100"  >&lt;p&gt;Thanks for pointing it out, Mark. If I recall correctly, electionPort is the port that all peers use for leader election, so in the currently implementation &quot;electionPort&quot; doesn&apos;t mean the port of this peer, but instead the port that all peers use for leader election. If we allow a different port for each peer, then we would need a line in the configuration file for each peer for leader election, right? &lt;/p&gt;</comment>
                            <comment id="12626139" author="markh" created="Wed, 27 Aug 2008 15:38:23 +0100"  >&lt;p&gt;Thanks for the quick response, Flavio.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;If we allow a different port for each peer, then we would need a line in the configuration file for each peer for leader election, right?&lt;/p&gt;

&lt;p&gt;I currently do that. The config file allows you to specify an &quot;electionPort&quot; property which is read by QuorumPeerConfig. &lt;br/&gt;
The javadocs for QuorumPeer don&apos;t document this but my assumption was that this was a legitimate setting and I could choose different values for each server as long as they all tied up OK.&lt;br/&gt;
This worked out OK for me using the sourceforge 2.2.1 version.&lt;/p&gt;

&lt;p&gt;The main reason for me wanting to mess around with ports in this way was to allow me to test Zookeeper services out on my single development machine where I could fire up and kill individual processes. I imagine it may not be uncommon for people starting with Zookeeper to want to do this so I would suggest doing one of the following:&lt;/p&gt;

&lt;p&gt;1) Documenting clearly that electionPorts must be the same on all machines (but this would disallow my scenario of single-machine testing of multiple QuorumPeerMain processes)&lt;br/&gt;
2) Fixing the code to allow multiple electionPorts to be used.&lt;/p&gt;

&lt;p&gt;Am I understanding this correctly?&lt;br/&gt;
Thanks,&lt;br/&gt;
Mark&lt;/p&gt;



</comment>
                            <comment id="12626243" author="breed" created="Wed, 27 Aug 2008 19:45:20 +0100"  >&lt;p&gt;This needs to be fixed. I&apos;m not sure how the tests are passing since all the peers are going to bind to the same port.&lt;/p&gt;

&lt;p&gt;I would propose removing the electionPort property and adding a port to the server configuration line:  server.X=addr:quorum_port:le_port&lt;/p&gt;

&lt;p&gt;so &lt;br/&gt;
  server.1=10.20.9.254:2881&lt;br/&gt;
  server.2=10.20.9.9:2882&lt;br/&gt;
  server.3=10.20.9.254:2883&lt;/p&gt;

&lt;p&gt;becomes&lt;br/&gt;
  server.1=10.20.9.254:2881:3881&lt;br/&gt;
  server.2=10.20.9.9:2882:3882&lt;br/&gt;
  server.3=10.20.9.254:2883:3883&lt;/p&gt;

&lt;p&gt;for example.&lt;/p&gt;

&lt;p&gt;If the le_port isn&apos;t specified should we assume to le_port is one more than the quorum port? server.1=10.20.9.254:2881 is the same as server.1=10.20.9.254:2881:2882?&lt;/p&gt;

&lt;p&gt;The first order of business should probably be to figure out why the test cases are not broken...&lt;/p&gt;</comment>
                            <comment id="12626251" author="breed" created="Wed, 27 Aug 2008 19:56:18 +0100"  >&lt;p&gt;Actually Pat showed me that the tests are passing because we don&apos;t use configuration files and instead instantiate QuorumPeers directly. It would probably be good to change the tests to use configuration files to get a more end-to-end test.&lt;/p&gt;</comment>
                            <comment id="12626635" author="markh" created="Thu, 28 Aug 2008 17:08:30 +0100"  >&lt;p&gt;Not good news on this I think.&lt;br/&gt;
I got as far as changing the QuoromPeerConfig parsing code and replacing the &quot;addr&quot; property in QuorumServer with electionAddress and qourumAddress for use around the place.&lt;/p&gt;

&lt;p&gt;The main issue I ran into is that the code in QuorumCnxManager seems to rely solely on ip address (without port) in many cases. As initially pointed out here, QuorumCnxManager uses its &lt;b&gt;own&lt;/b&gt; choice of election port and combines it with IP address to talk to remote servers (a problem if they happen to use different election ports e.g. required when running on the same machine). &lt;br/&gt;
To address this I started off with the assumption that all existing references to INetAddress in this class should probably be substituted for INetSocketAddress to more correctly identify the references to each service.&lt;/p&gt;

&lt;p&gt;While I was able to change most code to use InetSocketAddress in place of INetAddress (e.g. in senderWorkerMap) I found that this was not possible in RecvWorker. In its constructor it is reliant on using the IP address of the connecting client to identify the caller and is therefore unaware of the electionPort that might be needed to differentiate between more than one QuorumPeer running on the same machine when calling back. To get around this the server id (from myid) is probably required to be passed as part of the communication protocols in order to authenticate different callers.&lt;/p&gt;

&lt;p&gt;Ick!&lt;/p&gt;</comment>
                            <comment id="12626935" author="fpj" created="Fri, 29 Aug 2008 12:15:45 +0100"  >&lt;p&gt;Mark, It is excellent that you&apos;re working on this patch. Many thanks!&lt;/p&gt;

&lt;p&gt;Now, with respect to your comment, it seems to me just you just have to modify the calls to SocketChannel.open(), and it only appears in two places: receiveConnection and toSend. More concretely, you have to replace the variable port in the constructor of InetSocketAddress with the port value that you read from the configuration. &lt;/p&gt;

&lt;p&gt;What I had in mind is fairly simple. When we parse the configuration file, we could create another hashmap that maps server id to port, and we could simply replace the port variable in the constructor of InetSocketAddress with a call to get() on the hashmap.&lt;/p&gt;</comment>
                            <comment id="12626939" author="markh" created="Fri, 29 Aug 2008 12:36:58 +0100"  >&lt;p&gt;Did you see my comment about RecvWorker in my last post?&lt;br/&gt;
It relies solely on INetAddress to identify the caller. This is stored in the Message class and subsequently used in toSend messages generated by WorkerReceiver when sending back notifications.&lt;br/&gt;
Unfortunately RecvWorker currently is not in a position to uniquely identify which QuourumPeer is accessing it via the channel passed in it&apos;s constructor. It knows which &lt;b&gt;machine&lt;/b&gt; is accessing it but has no idea which QuorumPeer of potentitally several running on that machine, and therefore which port that particular peer has chosen to use for its election port.&lt;br/&gt;
At least that&apos;s how it looks to me from a quick scan of the code....&lt;/p&gt;</comment>
                            <comment id="12626975" author="fpj" created="Fri, 29 Aug 2008 14:58:48 +0100"  >&lt;p&gt;You&apos;re right, we need more changes. Here is what I think.&lt;/p&gt;

&lt;p&gt;We&apos;d have to change the type of &lt;ins&gt;addr&lt;/ins&gt; in &lt;ins&gt;QuorumCnxManager.Message&lt;/ins&gt; to &lt;ins&gt;InetSocketAddress&lt;/ins&gt;, and all the comparisons of addresses that we make across &lt;ins&gt;QuorumCnxManager&lt;/ins&gt;. For example, in &lt;ins&gt;QuorumCnxManager.toSend&lt;/ins&gt;, we use an &lt;ins&gt;InetAddress&lt;/ins&gt; object to determine if there is a connection to a peer. Alternatively, we could try to map server id to connection, which sounds like a cleaner way of doing it. We would also have to change the type of &lt;ins&gt;addr&lt;/ins&gt; in &lt;ins&gt;FastLeaderElection.Notification&lt;/ins&gt; to &lt;ins&gt;InetSocketAddress&lt;/ins&gt;. That&apos;s all I could pinpoint so far. &lt;/p&gt;</comment>
                            <comment id="12626996" author="markh" created="Fri, 29 Aug 2008 15:59:58 +0100"  >&lt;p&gt;This is a snapshot of the changes I had been thinking of making.&lt;/p&gt;

&lt;p&gt;Note: this DOES NOT COMPILE!&lt;/p&gt;

&lt;p&gt;If you apply the patch you can see the compile error at the point in RecvWorker where this ran out of steam. &lt;br/&gt;
It seems that in order to know which QourumPeer was talking to another you would need to pass &quot;myid&quot; as part of the comms protocol - there would be no other way of server A knowing if server B or server C had connected to it if we allow &amp;gt;1 Quorum peer per machine - the source IP address obtained from SocketChannel.socket().getInetAddress() is not sufficient to distinguish between them.&lt;/p&gt;

&lt;p&gt;That seems like a much bigger change that I don&apos;t feel particularly well equipped to take on just yet.&lt;/p&gt;</comment>
                            <comment id="12627075" author="fpj" created="Fri, 29 Aug 2008 20:09:09 +0100"  >&lt;p&gt;No worries, I&apos;ll work on it, but it&apos;d be great to have your feedback once I have a patch.&lt;/p&gt;</comment>
                            <comment id="12631070" author="fpj" created="Mon, 15 Sep 2008 18:04:04 +0100"  >&lt;p&gt;This patch removes the restriction of a single port for leader election. This patch changes the configuration file so that to specify a server, we have do as follows:&lt;/p&gt;


&lt;p&gt;server.1=myserver:11111:3182&lt;/p&gt;

&lt;p&gt;Note that this patch changes the procedure to parse a configuration file on QuorumPeerConfig.java.&lt;/p&gt;

&lt;p&gt;On QuorumCnxManager and FastLeaderElection/AuthFastLeaderElection, this patch replaces all references to InetAddress objects to server id values. That is, now we identify peers by their server id.&lt;/p&gt;</comment>
                            <comment id="12631182" author="mahadev" created="Tue, 16 Sep 2008 00:18:10 +0100"  >&lt;p&gt;just reviewd the code here are my comments &amp;#8211; &lt;/p&gt;

&lt;p&gt;1) why is the server id Long and not Integer?&lt;/p&gt;

&lt;p&gt;2) we have two ways of specifying the quorum list now &amp;#8211; one is quorumserver arraylist and the other is the hashcode list &amp;#8211; can we combine these two and just keep the hash aary? Do we require these two to be different?&lt;/p&gt;

&lt;p&gt;3) I do not see nay changes to QuorumPeerMain class? Shouldnt this be changed now to create a new contructor for QuorumPeer with the hashmap?&lt;/p&gt;

</comment>
                            <comment id="12631194" author="mahadev" created="Tue, 16 Sep 2008 00:35:32 +0100"  >&lt;p&gt;cancelling the patch for addressing review comments... &lt;/p&gt;</comment>
                            <comment id="12631319" author="fpj" created="Tue, 16 Sep 2008 11:15:11 +0100"  >&lt;p&gt;Mahadev, thanks for reviewing the patch. Here are my answers to your points:&lt;/p&gt;

&lt;p&gt;1- Server ID has always been a long in QuorumPeer and QuorumPeerConfig, so it was not my choice, and I&apos;ve only followed what was in place already. If you feel that there is a need to make server ID an integer all over, then I suggest that you open a JIRA to discuss it;&lt;br/&gt;
2- We can combine if we create a new data structure to hold both the quorum address and the election address, so that we have either an array of this new data structure or a hashmap from server id to this new data structure. I prefer the way it is in the patch;&lt;br/&gt;
3- That&apos;s a good point, I&apos;ll fix it. Also, the version I generated the patch agains is stale (QuorumPeer.java has changed), so I&apos;ll have to regenerate the patch anyway. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="12631356" author="fpj" created="Tue, 16 Sep 2008 13:10:29 +0100"  >&lt;p&gt;Ok, I reviewed the code, and I think you meant to say for point 2 that I could just add another field to QuorumServer. I&apos;ll do it, but it implies changes across more files. Hopefully this is ok. &lt;/p&gt;</comment>
                            <comment id="12631592" author="fpj" created="Wed, 17 Sep 2008 00:09:46 +0100"  >&lt;p&gt;This patch chenges the way we pass in the configuration file the port number used for leader election. It also changes the references to servers on QuorumCnxManager from InetAddress to their server ids. I have them changed the challenge mechanism to use the server id instead, simplifying the mechanism.&lt;/p&gt;

&lt;p&gt;I have also implemented some of the modifications proposed in JIRA 140.&lt;/p&gt;</comment>
                            <comment id="12631707" author="fpj" created="Wed, 17 Sep 2008 10:35:37 +0100"  >&lt;p&gt;There is compilation problem with the previous patch I submitted, so consider this new one instead.&lt;/p&gt;</comment>
                            <comment id="12631718" author="fpj" created="Wed, 17 Sep 2008 11:02:18 +0100"  >&lt;p&gt;Cleanup code like this to use logging instead of printstacktrace.&lt;/p&gt;

&lt;p&gt;         try &lt;/p&gt;
{
             mySocket = new DatagramSocket(port);
             // mySocket.setSoTimeout(20000);
         }
&lt;p&gt; catch (SocketException e1) {&lt;br/&gt;
             e1.printStackTrace();&lt;br/&gt;
             throw new Runtime....&lt;/p&gt;

&lt;p&gt;(Thanks for pointing it out, Pat)&lt;/p&gt;</comment>
                            <comment id="12632099" author="austin" created="Thu, 18 Sep 2008 06:51:31 +0100"  >&lt;p&gt;Applying the patch (from 9/17) to the latest trunk (r696563) now passes our leader election unit tests using algorithm 3. This is great.&lt;/p&gt;

&lt;p&gt;Two minor issues I noticed:&lt;/p&gt;

&lt;p&gt;1. The default constructor for QuorumPeer should call setStatsProvider, rather than the attribute-passing constructor. Since QuorumPeerMain calls the default constructor, echo stat | nc ... requests are returning invalid data because no provider is set.&lt;/p&gt;

&lt;p&gt;2. In QuorumPeerConfig.java:105 where parts.length is checked the operator should be &amp;amp;&amp;amp; instead of ||.&lt;/p&gt;</comment>
                            <comment id="12632111" author="austin" created="Thu, 18 Sep 2008 07:31:42 +0100"  >&lt;p&gt;After several more runs of our unit test using the patched algorithm 3, the test hangs as the service repeatedly tries to reelect the killed leader. This behavior is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-131&quot; title=&quot;Old leader election can elect a dead leader over and over again&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-131&quot;&gt;&lt;del&gt;ZOOKEEPER-131&lt;/del&gt;&lt;/a&gt; which we had experienced using algorithms 0 and 1.&lt;/p&gt;

&lt;p&gt;Server 10 is 10.50.65.40 and has been explicitly killed. The following log is from server 5, which mirrors logs on all the other servers.&lt;/p&gt;

&lt;p&gt;Any idea what&apos;s happening here?&lt;/p&gt;

&lt;p&gt;2008-09-18 00:28:20,029 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:QuorumPeer@394&amp;#93;&lt;/span&gt; - LOOKING&lt;br/&gt;
2008-09-18 00:28:20,029 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:ZooKeeperServer@198&amp;#93;&lt;/span&gt; - unable to parse zxid string into long: txt&lt;br/&gt;
2008-09-18 00:28:20,029 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:FastLeaderElection@493&amp;#93;&lt;/span&gt; - New election: 8589935405&lt;br/&gt;
2008-09-18 00:28:20,031 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;WorkerSender Thread:QuorumCnxManager@381&amp;#93;&lt;/span&gt; - Cannot open channel to 10( java.net.ConnectException: Connection refused)&lt;br/&gt;
2008-09-18 00:28:20,031 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:QuorumPeer@403&amp;#93;&lt;/span&gt; - FOLLOWING&lt;br/&gt;
2008-09-18 00:28:20,031 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:ZooKeeperServer@166&amp;#93;&lt;/span&gt; - Created server with dataDir:/zookeeper_data/5_data dataLogDir:/zookeeper_data/5_data tickT&lt;br/&gt;
ime:2000&lt;br/&gt;
2008-09-18 00:28:20,031 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:Follower@128&amp;#93;&lt;/span&gt; - Following /10.50.65.40:2888&lt;/p&gt;

&lt;p&gt;[[[ exception below repeats 5 times ]]]&lt;/p&gt;

&lt;p&gt;2008-09-18 00:28:20,032 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:Follower@145&amp;#93;&lt;/span&gt; - Unexpected exception&lt;br/&gt;
java.net.ConnectException: Connection refused&lt;br/&gt;
        at java.net.PlainSocketImpl.socketConnect(Native Method)&lt;br/&gt;
        at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:333)&lt;br/&gt;
        at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:195)&lt;br/&gt;
        at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:182)&lt;br/&gt;
        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)&lt;br/&gt;
        at java.net.Socket.connect(Socket.java:519)&lt;br/&gt;
        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:137)&lt;br/&gt;
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:405)&lt;/p&gt;

&lt;p&gt;[[[ then the follower is restarted ]]]&lt;/p&gt;

&lt;p&gt;2008-09-18 00:28:24,049 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;QuorumPeer:Follower@370&amp;#93;&lt;/span&gt; - FIXMSG&lt;br/&gt;
java.lang.Exception: shutdown Follower&lt;br/&gt;
        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:370)&lt;br/&gt;
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:409)&lt;/p&gt;

&lt;p&gt;[[[ at this point the log repeats from the beginning ]]]&lt;/p&gt;</comment>
                            <comment id="12632118" author="mahadev" created="Thu, 18 Sep 2008 07:58:06 +0100"  >&lt;p&gt;flavio, just a reminder, the patch should be generated against the trunk and also ^M characters (line delimiters in windows) should not be there in the patch... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12632171" author="fpj" created="Thu, 18 Sep 2008 12:18:00 +0100"  >&lt;p&gt;It happens typically that a follower starts up its follower code before the leader is available as a leader, so we get this connection refused exception. However, getting it 5 times means that there has been 5 attempts and no success, so the follower gave up and started a new leader election.  &lt;/p&gt;

&lt;p&gt;By design, the situation that happens with LE 0 should not happen with LEs 1, 2, or 3, since we use a logical clock to prevent a peer from using stale information on potential leaders.  In more detail, if a peer p1 starts a new leader election, and asks a peer p2 that believes that 10 is still the leader, then peer p1 shouldn&apos;t take p2&apos;s vote because it corresponds to the value decided in a previous election round. Moreover, because 10 is dead, we know that is can&apos;t vote, so the vote must come from another peer that believes that 10 is the leader. &lt;/p&gt;

&lt;p&gt;There must be a bug in the leader election code then, so I&apos;ll check the code. &lt;/p&gt;</comment>
                            <comment id="12632211" author="phunt" created="Thu, 18 Sep 2008 14:41:14 +0100"  >&lt;p&gt;Austin, when you say &quot;our leader election unit tests&quot; is that something you could contribute back to the Apache ZK community? If so please create a new jira and attach a patch because I&apos;d love to include them. Thanks.&lt;/p&gt;</comment>
                            <comment id="12632325" author="fpj" created="Thu, 18 Sep 2008 19:20:06 +0100"  >&lt;p&gt;This new patch also addresses a race condition in FastLeaderElection. Without this patch, it is possible that one of the worker threads reads the value of either proposedLeader, proposedZxid, or logicalclock in an inconsistent fashion. I have created two synchronized methods and added one synchronized block to have threads reading consistent values.&lt;/p&gt;

&lt;p&gt;I have also addressed the points that Austin pointed out. Thanks, Austin!&lt;/p&gt;
</comment>
                            <comment id="12632794" author="fpj" created="Fri, 19 Sep 2008 21:06:07 +0100"  >&lt;p&gt;Because 131 was committed, I had to regenerate this patch. Also, it gave me time to write a unit test for FastLeaderElection. I used the one Ben wrote for the old leader election as a basis. &lt;/p&gt;

&lt;p&gt;This patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fixes issues with QuorumCnxManager, in particular, servers can have different ports for leader election, and QuorumCnxManager uses server id to identify peers instead of IP address;&lt;/li&gt;
	&lt;li&gt;Remove the challenge used in QuorumCnxManager. QuorumCnxManager uses a randomly generated challenge to decide whether to keep or not to keep a connection. This patch eliminates this challenge, and uses server id instead. As server id is supposed to be unique, it serves the same purpose, although it is simpler, and more reliable;&lt;/li&gt;
	&lt;li&gt;Does a general cleanup of QuorumCnxManager. I have tried to address the comments of Austin;&lt;/li&gt;
	&lt;li&gt;Changes the format of the ZooKeeper configuration file. Now we specify the leader election port as the third parameter of a server specification, as described in the initial description of this jira;&lt;/li&gt;
	&lt;li&gt;Fixes a bug in FastLeaderElection. Because it uses multiple threads, there is currently the possibility that a peer sends inconsistent information to other peers;&lt;/li&gt;
	&lt;li&gt;Adds a unit test to FastLeaderElection based on the one Ben wrote;&lt;/li&gt;
	&lt;li&gt;Finally, because of the patch of jira 131, it touch some other parts, like LETest.java to comply with my changes.&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="12633875" author="phunt" created="Tue, 23 Sep 2008 21:14:07 +0100"  >&lt;p&gt;Both the fle and le tests are failing on my machine:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.zookeeper.test.FLETest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 62.084 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Test org.apache.zookeeper.test.FLETest FAILED&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.zookeeper.test.LETest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 0.397 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Test org.apache.zookeeper.test.LETest FAILED&lt;/p&gt;

&lt;p&gt;------------- Standard Error -----------------&lt;br/&gt;
Exception in thread &quot;Thread-23&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.zookeeper.test.FLETest$LEThread.run(FLETest.java:55)&lt;br/&gt;
Exception in thread &quot;Thread-1&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.zookeeper.test.FLETest$LEThread.run(FLETest.java:55)&lt;br/&gt;
Exception in thread &quot;Thread-13&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.zookeeper.test.FLETest$LEThread.run(FLETest.java:55)&lt;br/&gt;
Exception in thread &quot;Thread-3&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.zookeeper.test.FLETest$LEThread.run(FLETest.java:55)&lt;br/&gt;
------------- ---------------- ---------------&lt;/p&gt;

&lt;p&gt;Testcase: testLE took 62.064 sec&lt;br/&gt;
	FAILED&lt;br/&gt;
Threads didn&apos;t join&lt;br/&gt;
junit.framework.AssertionFailedError: Threads didn&apos;t join&lt;br/&gt;
	at org.apache.zookeeper.test.FLETest.testLE(FLETest.java:121)&lt;/p&gt;




&lt;p&gt;LETEST&lt;/p&gt;

&lt;p&gt;Testcase: testLE took 0.377 sec&lt;br/&gt;
	Caused an ERROR&lt;br/&gt;
Address already in use&lt;br/&gt;
java.net.BindException: Address already in use&lt;br/&gt;
	at sun.nio.ch.Net.bind(Native Method)&lt;br/&gt;
	at sun.nio.ch.ServerSocketChannelImpl.bind(ServerSocketChannelImpl.java:119)&lt;br/&gt;
	at sun.nio.ch.ServerSocketAdaptor.bind(ServerSocketAdaptor.java:59)&lt;br/&gt;
	at sun.nio.ch.ServerSocketAdaptor.bind(ServerSocketAdaptor.java:52)&lt;br/&gt;
	at org.apache.zookeeper.server.NIOServerCnxn$Factory.&amp;lt;init&amp;gt;(NIOServerCnxn.java:89)&lt;br/&gt;
	at org.apache.zookeeper.server.quorum.QuorumPeer.&amp;lt;init&amp;gt;(QuorumPeer.java:327)&lt;br/&gt;
	at org.apache.zookeeper.test.LETest.testLE(LETest.java:105)&lt;/p&gt;</comment>
                            <comment id="12634410" author="fpj" created="Thu, 25 Sep 2008 09:34:18 +0100"  >&lt;p&gt;This last patch improves the FLE unit test, and deals with a couple of corner cases in the FastLeaderElection implementation. &lt;/p&gt;</comment>
                            <comment id="12635022" author="fpj" created="Fri, 26 Sep 2008 22:12:09 +0100"  >&lt;p&gt;Two minor changes. I have replaced an import on FLETest.java and LETest.java to comply with changes of JIRA 21. I have asked Pat to do it here, otherwise it would be more work to regenerate the patch. &lt;/p&gt;

&lt;p&gt;======&lt;/p&gt;

&lt;p&gt;I have actually removed this patch because I realized that the import is necessary in this patch, and the two unit tests do not compile without the imports&lt;/p&gt;</comment>
                            <comment id="12635974" author="breed" created="Wed, 1 Oct 2008 09:38:10 +0100"  >&lt;p&gt;+1 looks good&lt;/p&gt;</comment>
                            <comment id="12635976" author="breed" created="Wed, 1 Oct 2008 09:40:15 +0100"  >&lt;p&gt;Committed revision 700714.&lt;/p&gt;</comment>
                            <comment id="12636325" author="hudson" created="Thu, 2 Oct 2008 11:46:01 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #101 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/101/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/101/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="12636510" author="stuhood" created="Fri, 3 Oct 2008 02:24:45 +0100"  >&lt;p&gt;This patch has been committed, but the changes are not documented at all. Servers will fail to start (with a NPE) if using the old config format with only 1 port per server.&lt;/p&gt;</comment>
                            <comment id="12636511" author="mahadev" created="Fri, 3 Oct 2008 02:29:44 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-151&quot; title=&quot;Document change to server configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-151&quot;&gt;&lt;del&gt;ZOOKEEPER-151&lt;/del&gt;&lt;/a&gt;  has been created to fix that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;... we should change our example config file format at well.. &lt;/p&gt;</comment>
                            <comment id="12636512" author="mahadev" created="Fri, 3 Oct 2008 02:30:33 +0100"  >&lt;p&gt;though failing with a NPE is obiously bad &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ... please create a jira for it &lt;/p&gt;</comment>
                            <comment id="12636632" author="phunt" created="Fri, 3 Oct 2008 14:25:12 +0100"  >&lt;p&gt;re stu&apos;s npe comment, is that true? I thought I had seen some code in the config processing that indicated that we allowed both host:port and host:port:port, does it npe if host:port is used?&lt;/p&gt;

&lt;p&gt;Flavio please look into this and also ensure that the documentation is updated to reflect.&lt;/p&gt;</comment>
                            <comment id="12636633" author="phunt" created="Fri, 3 Oct 2008 14:26:08 +0100"  >&lt;p&gt;are there tests for these cases?&lt;/p&gt;

&lt;p&gt;host:port and host:port:port? we should verify both cases (even if one is illegal - verify handled appropriately)&lt;/p&gt;</comment>
                            <comment id="12642725" author="phunt" created="Sun, 26 Oct 2008 01:10:42 +0000"  >&lt;p&gt;3.0.0 has been released, closing issues.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12404291">ZOOKEEPER-140</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12404370">ZOOKEEPER-141</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12390908" name="ZOOKEEPER-127.patch" size="96878" author="fpj" created="Thu, 25 Sep 2008 09:34:18 +0100"/>
                            <attachment id="12390532" name="ZOOKEEPER-127.patch" size="64781" author="fpj" created="Fri, 19 Sep 2008 21:06:07 +0100"/>
                            <attachment id="12390398" name="ZOOKEEPER-127.patch" size="53814" author="fpj" created="Thu, 18 Sep 2008 19:20:06 +0100"/>
                            <attachment id="12390250" name="ZOOKEEPER-127.patch" size="50722" author="fpj" created="Wed, 17 Sep 2008 10:35:37 +0100"/>
                            <attachment id="12390229" name="ZOOKEEPER-127.patch" size="50216" author="fpj" created="Wed, 17 Sep 2008 00:09:46 +0100"/>
                            <attachment id="12390122" name="ZOOKEEPER-127.patch" size="33906" author="fpj" created="Mon, 15 Sep 2008 18:04:04 +0100"/>
                            <attachment id="12389174" name="mhPortChanges.patch" size="19700" author="markh" created="Fri, 29 Aug 2008 15:59:58 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Aug 2008 13:25:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>48039</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzwbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33220</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>