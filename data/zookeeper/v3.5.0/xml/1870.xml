<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:47:36 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1870/ZOOKEEPER-1870.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1870] flakey test in StandaloneDisabledTest.startSingleServerTest</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1870</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;I&apos;m seeing lots of the following failure. Seems like a flakey test (passes every so often).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit.framework.AssertionFailedError: client could not connect to reestablished quorum: giving up after 30+ seconds.
	at org.apache.zookeeper.test.ReconfigTest.testNormalOperation(ReconfigTest.java:143)
	at org.apache.zookeeper.server.quorum.StandaloneDisabledTest.startSingleServerTest(StandaloneDisabledTest.java:75)
	at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:52)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve found 3 problems:&lt;/p&gt;

&lt;p&gt;1. QuorumCnxManager.Listener.run() leaks the socket depending on when the shutdown flag gets set.&lt;br/&gt;
2. QuorumCnxManager.halt() doesn&apos;t wait for the listener to terminate.&lt;br/&gt;
3. QuorumPeer.shuttingDownLE flag doesn&apos;t get reset when restarting the leader election.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12691695">ZOOKEEPER-1870</key>
            <summary>flakey test in StandaloneDisabledTest.startSingleServerTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="helen">Helen Hastings</assignee>
                                    <reporter username="phunt">Patrick Hunt</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jan 2014 18:45:43 +0000</created>
                <updated>Thu, 28 Aug 2014 17:50:13 +0100</updated>
                            <resolved>Thu, 28 Aug 2014 17:49:39 +0100</resolved>
                                    <version>3.4.6</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13884412" author="phunt" created="Tue, 28 Jan 2014 18:46:45 +0000"  >&lt;p&gt;recent failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk-jdk7/767/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk-jdk7/767/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13884414" author="phunt" created="Tue, 28 Jan 2014 18:47:58 +0000"  >&lt;p&gt;looks like this was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1691&quot; title=&quot;Add a flag to disable standalone mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1691&quot;&gt;&lt;del&gt;ZOOKEEPER-1691&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13884552" author="michim" created="Tue, 28 Jan 2014 20:22:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;Alexander Shraer&lt;/a&gt;, could you take a look?&lt;/p&gt;</comment>
                            <comment id="13884765" author="michim" created="Tue, 28 Jan 2014 22:09:45 +0000"  >&lt;p&gt;Reassigning it to Helen.&lt;/p&gt;</comment>
                            <comment id="13929780" author="michim" created="Tue, 11 Mar 2014 00:23:30 +0000"  >&lt;p&gt;I see a lot of log messages like this whenever this test fails:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-03-10 23:51:28,550 [myid:1] - INFO  [WorkerSender[myid=1]:QuorumCnxManager@195] - Have smaller server identifier, so dropping the connection: (2, 1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the recent mailing list discussion, it looks like this is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1805&quot; title=&quot;&amp;quot;Don&amp;#39;t care&amp;quot; value in ZooKeeper election breaks rolling upgrades&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1805&quot;&gt;&lt;del&gt;ZOOKEEPER-1805&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1810&quot; title=&quot;Add version to FLE notifications for trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1810&quot;&gt;&lt;del&gt;ZOOKEEPER-1810&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/zookeeper-user/201402.mbox/%3CCAEH-zfq4uxUqi9D4KrD8EvPaU3MxDUt7WHQKDPNCPDQoYAbP6g@mail.gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/zookeeper-user/201402.mbox/%3CCAEH-zfq4uxUqi9D4KrD8EvPaU3MxDUt7WHQKDPNCPDQoYAbP6g@mail.gmail.com%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13929784" author="michim" created="Tue, 11 Mar 2014 00:24:57 +0000"  >&lt;p&gt;Unassigned this ticket from Helen since it doesn&apos;t seem like the failure is directly caused by the disable-standalone mode.&lt;/p&gt;</comment>
                            <comment id="13929866" author="helen" created="Tue, 11 Mar 2014 01:53:13 +0000"  >&lt;p&gt;Thanks Michi.  However, I also see this error happen every once in a while when the test succeeds. I believe the reason it happens more often when the test fails is because over 50 seconds are spent trying to get servers 1 and 2 to connect (we get all the way to here):&lt;/p&gt;

&lt;p&gt;2014-02-28 02:30:39,673 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=2&amp;#93;&lt;/span&gt;/127.0.0.1:11227:FastLeaderElection@846] - Notification time out: 51200&lt;/p&gt;

&lt;p&gt;so there is just more time/opportunity for the error to happen, as opposed to the success case when the servers are able to connect within a second or faster.&lt;/p&gt;

&lt;p&gt;This could still be related even though it happens in both the success and failure case.  Either way I&apos;ll continue looking into it on my own as well.&lt;/p&gt;</comment>
                            <comment id="13929869" author="michim" created="Tue, 11 Mar 2014 01:59:13 +0000"  >&lt;p&gt;Does this test fail even with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1805&quot; title=&quot;&amp;quot;Don&amp;#39;t care&amp;quot; value in ZooKeeper election breaks rolling upgrades&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1805&quot;&gt;&lt;del&gt;ZOOKEEPER-1805&lt;/del&gt;&lt;/a&gt; applied?&lt;/p&gt;</comment>
                            <comment id="13932696" author="djagtap" created="Thu, 13 Mar 2014 00:30:44 +0000"  >&lt;p&gt;Hi Michi,&lt;/p&gt;

&lt;p&gt;On my setup StandaloneDisabledTest fails even without 1805 patch.&lt;br/&gt;
I checkout revision 1574686 and build shows StandaloneDisabledTest consitently fails.&lt;br/&gt;
It also fails with 1805 patch applied.&lt;/p&gt;

&lt;p&gt;Thanks &amp;amp; Regards,&lt;br/&gt;
Deepak&lt;/p&gt;</comment>
                            <comment id="13932702" author="michim" created="Thu, 13 Mar 2014 00:40:08 +0000"  >&lt;p&gt;Ok thank you for the update Deepak. I was hoping &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1805&quot; title=&quot;&amp;quot;Don&amp;#39;t care&amp;quot; value in ZooKeeper election breaks rolling upgrades&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1805&quot;&gt;&lt;del&gt;ZOOKEEPER-1805&lt;/del&gt;&lt;/a&gt; would fix this issue. I&apos;m assigning this back to Helen.&lt;/p&gt;</comment>
                            <comment id="13936282" author="michim" created="Sat, 15 Mar 2014 19:52:43 +0000"  >&lt;p&gt;Ok I think I know what the problem is. There is race between QuorumCnxManager.Listener.run() and QuorumCnxManager.Listener.halt() that causes the socket to leak.&lt;/p&gt;

&lt;p&gt;1. &lt;tt&gt;QuorumCnxManager.Listener.run()&lt;/tt&gt; goes into the while loop &lt;tt&gt;while((!shutdown) &amp;amp;&amp;amp; (numRetries &amp;lt; 3))&lt;/tt&gt;&lt;br/&gt;
2. &lt;tt&gt;QuorumCnxManager.halt()&lt;/tt&gt; gets called, sets &lt;tt&gt;shutdown&lt;/tt&gt; to &lt;tt&gt;true&lt;/tt&gt; and calls &lt;tt&gt;QuorumCnxManager.Listener.halt()&lt;/tt&gt;.&lt;br/&gt;
3. &lt;tt&gt;QuorumCnxManager.Listener.halt()&lt;/tt&gt; closes the socket.&lt;br/&gt;
4. &lt;tt&gt;QuorumCnxManager.Listener.run()&lt;/tt&gt; binds the socket and breaks out of the while loop since the shutdown flag is set.&lt;/p&gt;

&lt;p&gt;I&apos;ll upload a patch.&lt;/p&gt;</comment>
                            <comment id="13936433" author="phunt" created="Sun, 16 Mar 2014 05:11:55 +0000"  >&lt;p&gt;fwiw I&apos;m still seeing this alot on my setup (once a day at least, it&apos;s the most common cause of CI job failure for me). Thanks for making it a priority!&lt;/p&gt;</comment>
                            <comment id="13937243" author="michim" created="Sun, 16 Mar 2014 18:09:32 +0000"  >&lt;p&gt;There is another problem: QuorumPeer.restartLeaderElection() doesn&apos;t clear the shuttingDownLE flag.&lt;/p&gt;</comment>
                            <comment id="13937303" author="hadoopqa" created="Sun, 16 Mar 2014 19:39:36 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12635000/ZOOKEEPER-1870.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12635000/ZOOKEEPER-1870.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1577756.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1964//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1964//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1964//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1964//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1964//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1964//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13937305" author="michim" created="Sun, 16 Mar 2014 19:41:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/19269/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/19269/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13937311" author="hadoopqa" created="Sun, 16 Mar 2014 19:47:10 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12635000/ZOOKEEPER-1870.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12635000/ZOOKEEPER-1870.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1577756.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1965//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1965//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1965//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1965//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1965//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1965//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13939916" author="shralex" created="Tue, 18 Mar 2014 22:45:29 +0000"  >&lt;p&gt;+1, thanks Michi!&lt;/p&gt;

&lt;p&gt;if possible, please update the description of the jira to reflect the problems you found (as you did on reviewboard)&lt;/p&gt;</comment>
                            <comment id="13939918" author="shralex" created="Tue, 18 Mar 2014 22:47:55 +0000"  >&lt;p&gt;on second thought it looks like some C tests are failing ?&lt;/p&gt;</comment>
                            <comment id="13939924" author="michim" created="Tue, 18 Mar 2014 22:52:56 +0000"  >&lt;p&gt;I think it&apos;s another flaky test that&apos;s not related to this patch. I ran the test on my box like 100 times and they all passed. Let me run the build again to see if it fails again.&lt;/p&gt;</comment>
                            <comment id="13939959" author="hadoopqa" created="Tue, 18 Mar 2014 23:30:06 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12635000/ZOOKEEPER-1870.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12635000/ZOOKEEPER-1870.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1577756.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1966//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1966//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1966//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1966//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1966//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1966//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13939988" author="helen" created="Tue, 18 Mar 2014 23:54:45 +0000"  >&lt;p&gt;Ran it here 100 times as well and they all passed.  Thank you Michi, +1!&lt;/p&gt;</comment>
                            <comment id="13941226" author="rgs" created="Thu, 20 Mar 2014 00:14:20 +0000"  >&lt;p&gt;I just got a failure with this patch after 44 iterations:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit.run:
    [junit] WARNING: multiple versions of ant detected in path for junit 
    [junit]          jar:file:/usr/share/java/ant/ant.jar!/org/apache/tools/ant/Project.class
    [junit]      and jar:file:/usr/share/ant/lib/ant.jar!/org/apache/tools/ant/Project.class
    [junit] Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding=utf8
    [junit] Running org.apache.zookeeper.server.quorum.StandaloneDisabledTest
    [junit] Tests run: 2, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 61.398 sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was running without -Dtest.output=yes, alas &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Will run again with -Dtest.output=yes. &lt;/p&gt;</comment>
                            <comment id="13941227" author="rgs" created="Thu, 20 Mar 2014 00:15:32 +0000"  >&lt;p&gt;Also, I was &lt;b&gt;only&lt;/b&gt; running that test not the whole suite. I.e.:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;while :; do ant -Dtestcase=StandaloneDisabledTest test-core-java ; done | tee test.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13941249" author="michim" created="Thu, 20 Mar 2014 01:00:33 +0000"  >&lt;p&gt;Thanks for running the test Raul. It seems like there are more things to fix. The log file should be under build/test/logs/ even without the -Dtest.output=yes option. Which platform are you using?&lt;/p&gt;

&lt;p&gt;--Michi&lt;/p&gt;</comment>
                            <comment id="13941250" author="rgs" created="Thu, 20 Mar 2014 01:03:24 +0000"  >&lt;p&gt;Hi Michi,&lt;/p&gt;

&lt;p&gt;Platform is Fedora Linux, with 3.13 Kernel on x86_64:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ uname -r
3.13.6-200.fc20.x86_64
$ arch
x86_64
$ cat /etc/fedora-release 
Fedora release 20 (Heisenbug)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is mostly out of trunk plus some other patches that I had (but mostly unrelated). I&apos;ll run again out of pure trunk. &lt;/p&gt;</comment>
                            <comment id="13941252" author="rgs" created="Thu, 20 Mar 2014 01:04:54 +0000"  >&lt;p&gt;Oh, and it fails with:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] 2014-03-19 17:50:42,869 [myid:] - INFO  [main:ZKTestCase$1@66] - FAILED startSingleServerTest
    [junit] java.lang.AssertionError: Server 1 is not up
    [junit] 	at org.junit.Assert.fail(Assert.java:93)
    [junit] 	at org.junit.Assert.assertTrue(Assert.java:43)
  ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13941271" author="hadoopqa" created="Thu, 20 Mar 2014 01:18:19 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12635699/test.log&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12635699/test.log&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1577756.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 15 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1967//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1967//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13941321" author="michim" created="Thu, 20 Mar 2014 02:24:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;Alexander Shraer&lt;/a&gt;, it looks like the problem is in FastLeaderElection. WorkerReceiver.run() doesn&apos;t get out of the while loop after calling self.getElectionAlg().shutdown(), and the node 1 is becoming the leader when it shouldn&apos;t. Should we put break after self.getElectionAlg().shutdown() so that the rest of the logic doesn&apos;t get executed when restarting the leader election?&lt;/p&gt;</comment>
                            <comment id="13941360" author="shralex" created="Thu, 20 Mar 2014 03:33:04 +0000"  >&lt;p&gt;yes, looks like you&apos;re right. It sets stop to true but then there&apos;s a bunch of code that may still be executed in the remainder of the loop, so break sounds like a good idea. &lt;/p&gt;</comment>
                            <comment id="13941363" author="michim" created="Thu, 20 Mar 2014 03:39:10 +0000"  >&lt;p&gt;Another change I added was to reset proposedLeader to -1 in FastLeaderElection.shutdown(). I&apos;ll run the test 200 times before uploading the patch this time &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13941367" author="shralex" created="Thu, 20 Mar 2014 03:52:03 +0000"  >&lt;p&gt;thanks Michi!&lt;/p&gt;</comment>
                            <comment id="13941917" author="michim" created="Thu, 20 Mar 2014 16:32:17 +0000"  >&lt;p&gt;3 additional changes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Reset proposedLeader to -1 in FastLeaderElection.shutdown().&lt;/li&gt;
	&lt;li&gt;Get out of the WorkerReceiver.run() loop after calling self.getElectionAlg().shutdown().&lt;/li&gt;
	&lt;li&gt;Make FastLeaderElection.getVote() public for unit test. Let me know if making this method public is ok with you guys.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13941987" author="hadoopqa" created="Thu, 20 Mar 2014 17:17:38 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12635811/ZOOKEEPER-1870.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12635811/ZOOKEEPER-1870.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1577756.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1970//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1970//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1970//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1970//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1970//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1970//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13942159" author="rgs" created="Thu, 20 Mar 2014 19:12:26 +0000"  >&lt;p&gt;The last patch is passing every time so far (66 runs thus far). &lt;/p&gt;</comment>
                            <comment id="13942479" author="michim" created="Thu, 20 Mar 2014 23:05:06 +0000"  >&lt;p&gt;Thank you for running the test again Raul. &lt;/p&gt;</comment>
                            <comment id="13943368" author="michim" created="Fri, 21 Mar 2014 18:41:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;Patrick Hunt&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt;, could one of you take a look at the patch?&lt;/p&gt;</comment>
                            <comment id="13949559" author="fpj" created="Thu, 27 Mar 2014 16:45:09 +0000"  >&lt;p&gt;I&apos;ll have a look today.&lt;/p&gt;</comment>
                            <comment id="13950173" author="fpj" created="Thu, 27 Mar 2014 23:58:14 +0000"  >&lt;p&gt;This looks good to me. I was just wondering if there is a concrete reason for setting proposedLeader to -1 when we shut it down. Is it necessary or just good to have?&lt;/p&gt;

&lt;p&gt;I was also wondering if we should check this into the 3.4 branch as well as trunk.&lt;/p&gt;</comment>
                            <comment id="13950432" author="michim" created="Fri, 28 Mar 2014 06:18:31 +0000"  >&lt;p&gt;I can&apos;t reproduce it now, but I think there was a case where the quorum peer incorrectly became a leader after shutdown got called if the proposedLeader wasn&apos;t set to -1. I&apos;m guessing it could happen if shutdown() gets called right before this block of code gets executed. Maybe there is a way to shutdown the leader election more cleanly?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/*
 * This predicate is true once we don&apos;t read any new
 * relevant message from the reception queue
 */
if (n == null) {
    self.setPeerState((proposedLeader == self.getId()) ?
            ServerState.LEADING: learningState());

    Vote endVote = new Vote(proposedLeader,
            proposedZxid, proposedEpoch);
    leaveInstance(endVote);
    return endVote;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yes, I think we should fix this in 3.4. I&apos;ll upload a separate patch for 3.4.&lt;/p&gt;</comment>
                            <comment id="14043416" author="fpj" created="Wed, 25 Jun 2014 14:08:09 +0100"  >&lt;p&gt;+1, committed to trunk: Committed revision 1605380.&lt;/p&gt;</comment>
                            <comment id="14043422" author="fpj" created="Wed, 25 Jun 2014 14:15:30 +0100"  >&lt;p&gt;I&apos;ve made a minor change to the patch... We are missing the 3.4 patch, that&apos;s why I haven&apos;t resolved this issue.&lt;/p&gt;</comment>
                            <comment id="14043429" author="hadoopqa" created="Wed, 25 Jun 2014 14:22:19 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12652411/ZOOKEEPER-1870.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12652411/ZOOKEEPER-1870.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1605380.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2147//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2147//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14044571" author="hudson" created="Thu, 26 Jun 2014 12:19:07 +0100"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2347 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2347/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2347/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1870&quot; title=&quot;flakey test in StandaloneDisabledTest.startSingleServerTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1870&quot;&gt;&lt;del&gt;ZOOKEEPER-1870&lt;/del&gt;&lt;/a&gt;. flakey test in StandaloneDisabledTest.startSingleServerTest (Helen Hastings via fpj) (fpj: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1605380&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1605380&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/test/FLETest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12642600">ZOOKEEPER-1691</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12677796">ZOOKEEPER-1810</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12676539">ZOOKEEPER-1805</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12652411" name="ZOOKEEPER-1870.patch" size="6787" author="fpj" created="Wed, 25 Jun 2014 14:15:30 +0100"/>
                            <attachment id="12635811" name="ZOOKEEPER-1870.patch" size="6759" author="michim" created="Thu, 20 Mar 2014 16:32:17 +0000"/>
                            <attachment id="12635000" name="ZOOKEEPER-1870.patch" size="4787" author="michim" created="Sun, 16 Mar 2014 19:01:06 +0000"/>
                            <attachment id="12635699" name="test.log" size="174316" author="rgs" created="Thu, 20 Mar 2014 01:03:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 28 Jan 2014 20:22:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370440</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzlp5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370761</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>