<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:39:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/ZOOKEEPER-1144/ZOOKEEPER-1144.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[ZOOKEEPER-1144] ZooKeeperServer not starting on leader due to a race condition</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1144</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;I have found one problem that is causing QuorumPeerMainTest:testQuorum to fail. This test uses 2 ZK servers. &lt;/p&gt;

&lt;p&gt;The test is failing because leader is not starting ZooKeeperServer after leader election. so everything halts.&lt;/p&gt;

&lt;p&gt;With the new changes, the server is now started in Leader.processAck() which is called from LeaderHandler. processAck() starts ZooKeeperServer if majority have acked NEWLEADER. The leader puts its ack in the the ackSet in Leader.lead(). Since processAck() is called from LearnerHandler it can happen that the learner&apos;s ack is processed before the leader is able to put its ack in the ackSet. When LearnerHandler invokes processAck(), the ackSet for newLeaderProposal will not have quorum (in this case 2). As a result, the ZooKeeperServer is never started on the Leader.&lt;/p&gt;

&lt;p&gt;The leader needs to ensure that its ack is put in ackSet before starting LearnerCnxAcceptor or invoke processAck() itself after adding to ackSet. I haven&apos;t had time to go through the ZAB2 changes so I am not too familiar with the code. Can Ben/Flavio fix this?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12517863">ZOOKEEPER-1144</key>
            <summary>ZooKeeperServer not starting on leader due to a race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vishalmlst">Vishal Kher</assignee>
                                    <reporter username="vishalmlst">Vishal Kher</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Aug 2011 23:35:49 +0100</created>
                <updated>Wed, 23 Nov 2011 19:22:46 +0000</updated>
                            <resolved>Thu, 11 Aug 2011 19:10:08 +0100</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13079094" author="ekoontz" created="Wed, 3 Aug 2011 23:44:08 +0100"  >&lt;p&gt;Vishal Kher writes to dev list:&lt;br/&gt;
&quot;Error looks similar to what I have been seeing. I reported the cause of the problem here: &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1144&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1144&lt;/a&gt;&lt;br/&gt;
&quot;.&lt;/p&gt;</comment>
                            <comment id="13079095" author="ekoontz" created="Wed, 3 Aug 2011 23:44:51 +0100"  >&lt;p&gt;Thanks Vishal, hopefully this is the same problem with the same solution.&lt;/p&gt;</comment>
                            <comment id="13079096" author="vishalmlst" created="Wed, 3 Aug 2011 23:46:02 +0100"  >&lt;p&gt;adding links to test failures likely caused by this bugs&lt;/p&gt;</comment>
                            <comment id="13080615" author="vishalmlst" created="Sun, 7 Aug 2011 19:24:05 +0100"  >&lt;p&gt;Fix looks to be very simple. Running tests now, will submit patch if tests succeed.&lt;/p&gt;</comment>
                            <comment id="13080622" author="vishalmlst" created="Sun, 7 Aug 2011 19:51:17 +0100"  >&lt;p&gt;Attaching patch. All tests passed for me after this fix.&lt;/p&gt;</comment>
                            <comment id="13080624" author="vishalmlst" created="Sun, 7 Aug 2011 19:53:26 +0100"  >&lt;p&gt;Submitting patch for trunk.&lt;/p&gt;</comment>
                            <comment id="13082880" author="hadoopqa" created="Thu, 11 Aug 2011 04:22:18 +0100"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12489635/ZOOKEEPER-1144.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12489635/ZOOKEEPER-1144.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1152141.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/437//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/437//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/437//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/437//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/437//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/437//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13083112" author="vishalmlst" created="Thu, 11 Aug 2011 14:42:18 +0100"  >&lt;p&gt;Existing tests were enough to catch the problem and also to verify the fix.&lt;/p&gt;</comment>
                            <comment id="13083137" author="fournc" created="Thu, 11 Aug 2011 15:39:29 +0100"  >&lt;p&gt;Vishal, can you just explain quickly why moving the ackSet.add to its new location (above waitForEpochAck but below the LearnerCnxAcceptor start) will fix the bug as you described it in the bug report? I&apos;m not super familiar with this part of the code, but if you can just point it out to me I&apos;m happy to +1 this and check it in asap so our builds will stop failing.&lt;/p&gt;</comment>
                            <comment id="13083143" author="fournc" created="Thu, 11 Aug 2011 15:52:45 +0100"  >&lt;p&gt;Actually I think I see. If we set up the epoch first, the LearnerHandler thread can complete to processAck before the leader thread completes to add itself to the ack set, causing the bug. Good fix. +1 from me, will check this in.&lt;/p&gt;</comment>
                            <comment id="13083157" author="fournc" created="Thu, 11 Aug 2011 16:20:21 +0100"  >&lt;p&gt;Committed to trunk, rev 115664&lt;/p&gt;</comment>
                            <comment id="13083303" author="hudson" created="Thu, 11 Aug 2011 19:08:17 +0100"  >&lt;p&gt;Integrated in ZooKeeper-trunk #1261 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/1261/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/1261/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1144&quot; title=&quot;ZooKeeperServer not starting on leader due to a race condition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1144&quot;&gt;&lt;del&gt;ZOOKEEPER-1144&lt;/del&gt;&lt;/a&gt;: ZooKeeperServer not starting on leader due to a race condition (Vishal K via camille)&lt;/p&gt;

&lt;p&gt;camille : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156649&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156649&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13083376" author="vishalmlst" created="Thu, 11 Aug 2011 19:49:55 +0100"  >&lt;blockquote&gt;&lt;p&gt;Actually I think I see. If we set up the epoch first, the LearnerHandler thread can complete to processAck before the leader thread completes to add itself to the ack set, causing the bug. Good fix. +1 from me, will check this in.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, in addition, per my understanding, waitForEpochAck() which is called by LearnerHandler before calling processAck() ensures correctness per the ZAB 1.0 design.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12513982">ZOOKEEPER-1125</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12517864">ZOOKEEPER-1145</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12489635" name="ZOOKEEPER-1144.patch" size="1158" author="vishalmlst" created="Sun, 7 Aug 2011 19:51:17 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 3 Aug 2011 22:44:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3978</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzt2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32693</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>