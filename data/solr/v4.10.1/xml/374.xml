<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:25:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-374/SOLR-374.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-374] use IndexReader.reopen</title>
                <link>https://issues.apache.org/jira/browse/SOLR-374</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Take advantage of  IndexReader.reopen(): &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-743&quot; title=&quot;IndexReader.reopen()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-743&quot;&gt;&lt;del&gt;LUCENE-743&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12379786">SOLR-374</key>
            <summary>use IndexReader.reopen</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Sat, 6 Oct 2007 01:33:27 +0100</created>
                <updated>Thu, 13 Aug 2009 15:17:47 +0100</updated>
                            <resolved>Wed, 17 Sep 2008 22:51:41 +0100</resolved>
                                                    <fixVersion>1.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12622399" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 01:03:15 +0100"  >&lt;p&gt;I may be missing something but this one is pretty simple right?&lt;/p&gt;

&lt;p&gt;The biggest issue I see is that some tests rely on getting a new Reader reference whether its needed or not (the index hasn&apos;t changed) after a commit. So while I&apos;d like to just return the searcher when the Reader hasnt changed, those tests would have to be changed. As is, a small change should actually be cheaper than no change I think.&lt;/p&gt;</comment>
                            <comment id="12622406" author="yseeley@gmail.com" created="Thu, 14 Aug 2008 01:55:31 +0100"  >&lt;p&gt;It would not have been easy in the past, but with all of the recent changes, it should be simple.&lt;br/&gt;
This patch has couple off issues though:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a race condition: the reader could be closed between the time you get it and the time you try to call reopen().&lt;/li&gt;
	&lt;li&gt;descriptor leak: you pass closeReader=false, but no one else will close this reader.&lt;/li&gt;
	&lt;li&gt;the last reader to be opened is the one that should be re-opened, not necessarily the currently registered one&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;See the getNewestSearcher() method I recently added to fix both #1 and #3&lt;br/&gt;
Also, I think that any test that expects the reader to be different should be changed.&lt;/p&gt;</comment>
                            <comment id="12622420" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 03:13:22 +0100"  >&lt;ul&gt;
	&lt;li&gt;a race condition: the reader could be closed between the time you get it and the time you try to call reopen().&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ah, because of no incref...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;descriptor leak: you pass closeReader=false, but no one else will close this reader.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Dumb mistake here - made a private method public just so I could pass true and then still passed false...&lt;/p&gt;

&lt;p&gt;   &amp;gt;&amp;gt;Also, I think that any test that expects the reader to be different should be changed.&lt;br/&gt;
   Alright, easy enough, just two I think: elevation and function tests, using the reader as a key in a map or something.&lt;/p&gt;

&lt;p&gt;   If thats all for the reopen, I&apos;ve got that looking good I think, just have to take care of the tests.&lt;/p&gt;</comment>
                            <comment id="12622425" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 03:39:48 +0100"  >&lt;p&gt;Hmmm...looks like I was wrong about those tests failing just because of the same Reader - looked that way, and the expected fix worked, but doing things correctly as directed by yonik, now all the tests pass no problem.&lt;/p&gt;</comment>
                            <comment id="12622430" author="yseeley@gmail.com" created="Thu, 14 Aug 2008 04:30:59 +0100"  >&lt;p&gt;You&apos;ve involved yourself in one of the more complicated methods in Solr &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Latest patch has a new race condition: _searcher.incref() may be called after a final _searcher.decref() closes the searcher/reader.&lt;/li&gt;
	&lt;li&gt;we shouldn&apos;t need to check if _searcher==null or not... there may be searchers open that have not yet been registered.&lt;/li&gt;
	&lt;li&gt;if the reader from the &lt;b&gt;newest&lt;/b&gt; searcher is equal to it&apos;s reopen, you return the registered searcher (which may actually be different from the newest searcher)&lt;/li&gt;
	&lt;li&gt;returning a RefCounted&amp;lt;SolrIndexSearcher&amp;gt; immediately can expose it before it was supposed to be used (before warming has completed, etc)&lt;/li&gt;
	&lt;li&gt;returning a RefCounted&amp;lt;SolrIndexSearcher&amp;gt; is not always the right thing to do - it depends on the parameters to the function.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There are really two different optimizations here:&lt;br/&gt;
1) call IndexReader.reopen() and share parts of the most recently opened IndexReader&lt;br/&gt;
2) if the IndexReader didn&apos;t change, avoid going through warming, autowarming, etc and just reuse the same searcher&lt;/p&gt;

</comment>
                            <comment id="12622648" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 20:11:27 +0100"  >

&lt;ul&gt;
	&lt;li&gt;Latest patch has a new race condition: _searcher.incref() may be called after a final _searcher.decref() closes the searcher/reader.&lt;br/&gt;
     Right...since I shouldn&apos;t even be returning _searcher, that goes away I think&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;we shouldn&apos;t need to check if _searcher==null or not... there may be searchers open that have not yet been registered.&lt;br/&gt;
     Right....gone.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;if the reader from the newest searcher is equal to it&apos;s reopen, you return the registered searcher (which may actually be different from the newest searcher)&lt;br/&gt;
     Right....gone.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;returning a RefCounted&amp;lt;SolrIndexSearcher&amp;gt; immediately can expose it before it was supposed to be used (before warming has completed, etc)&lt;br/&gt;
     Right....gone.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;returning a RefCounted&amp;lt;SolrIndexSearcher&amp;gt; is not always the right thing to do - it depends on the parameters to the function.&lt;br/&gt;
    Good point &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So I guess the key on this patch (as you pointed out) is that it is two optimizations, and the not doing anything if the Reader hasn&apos;t changed optimization really makes things more difficult - dropping it for now, I think solves pretty much each of these issues.&lt;/p&gt;

&lt;p&gt;I was right about the Reader and the tests as well...things passed because they were still wrong - so I have adjusted the two tests to actually change the index instead of just commit.&lt;/p&gt;


&lt;p&gt;I think this does just the reopen correctly but I am still scanning and checking. I definitely missed were the first sync on the search lock was closing in the earlier patch...soo many braces.&lt;/p&gt;

</comment>
                            <comment id="12622655" author="yseeley@gmail.com" created="Thu, 14 Aug 2008 20:31:28 +0100"  >&lt;p&gt;Looking pretty good now... but there is a reference leak.  decref() should always be called for any RefCounted instances (preferably in a finally block)&lt;/p&gt;</comment>
                            <comment id="12622684" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 21:51:17 +0100"  >&lt;p&gt;Okay. Not sure how kosher taking ownership of the Reader form SolrIndexSearcher is, but it seems the thing to do then.&lt;/p&gt;</comment>
                            <comment id="12622696" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 22:01:40 +0100"  >&lt;p&gt;Hmmm...probably need a searcher lock  around taking reader ownership....&lt;/p&gt;

&lt;p&gt;or not...the incref will keep it from being closed. NM.&lt;/p&gt;</comment>
                            <comment id="12622704" author="yseeley@gmail.com" created="Thu, 14 Aug 2008 22:17:42 +0100"  >&lt;blockquote&gt;&lt;p&gt;or not...the incref will keep it from being closed. NM.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right.  I think all you need to add is a decref()&lt;/p&gt;</comment>
                            <comment id="12622707" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 22:19:21 +0100"  >&lt;p&gt;I&apos;ve got the decref on the newestSearcher in a finally block there - miss it? or did I botch it?&lt;/p&gt;</comment>
                            <comment id="12622717" author="yseeley@gmail.com" created="Thu, 14 Aug 2008 22:35:48 +0100"  >&lt;p&gt;I missed the last patch (I wish JIRA defaulted to &quot;All&quot;).&lt;/p&gt;

&lt;p&gt;It seems like that if reopen() returns us the same reader, we should just incRef it... (or is that in a slightly later version of Lucene?)&lt;br/&gt;
Trying to steal the reader instead seems hard to get right (seems like another thread could try to open another searcher, but our searcher doesn&apos;t have it and neither does the old one, so your exception might be triggered.)&lt;/p&gt;</comment>
                            <comment id="12622724" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 23:12:04 +0100"  >&lt;p&gt;Man...nothing is ever simple &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; A search lock around the ownership change would solve that right? The incref on the Reader is way cleaner though - from what I can tell solr Lucene is a bit too old though. Worth it to wait I think - much better than a sync.&lt;/p&gt;</comment>
                            <comment id="12624396" author="markrmiller@gmail.com" created="Thu, 21 Aug 2008 16:26:00 +0100"  >&lt;p&gt;I&apos;m still firming up my knowledge of this class, but I think this is right. Just switched to the incref rather than Reader ownership change.&lt;/p&gt;</comment>
                            <comment id="12631970" author="yseeley@gmail.com" created="Wed, 17 Sep 2008 22:51:41 +0100"  >&lt;p&gt;Committed.  Thanks Mark!&lt;/p&gt;

&lt;p&gt;This did cause a test failure on windows, but it&apos;s the test that needs fixing: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-775&quot; title=&quot;DirectUpdateHandlerOptimizeTest needs diff way to test for num segments.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-775&quot;&gt;&lt;del&gt;SOLR-775&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12388676" name="SOLR-374.patch" size="3627" author="markrmiller@gmail.com" created="Thu, 21 Aug 2008 16:26:00 +0100"/>
                            <attachment id="12388278" name="SOLR-374.patch" size="4566" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 21:51:17 +0100"/>
                            <attachment id="12388271" name="SOLR-374.patch" size="3176" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 20:11:27 +0100"/>
                            <attachment id="12388200" name="SOLR-374.patch" size="1888" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 03:39:48 +0100"/>
                            <attachment id="12388193" name="SOLR-374.patch" size="1902" author="markrmiller@gmail.com" created="Thu, 14 Aug 2008 01:03:15 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 14 Aug 2008 00:03:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7221</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxrpz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20810</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>