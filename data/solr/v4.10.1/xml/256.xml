<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:22:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-256/SOLR-256.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-256] Stats via JMX</title>
                <link>https://issues.apache.org/jira/browse/SOLR-256</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;This patch adds JMX capability to get statistics from all the SolrInfoMBean.&lt;/p&gt;

&lt;p&gt;The implementation is done such a way to minimize code changes. &lt;br/&gt;
In SolrInfoRegistry, I have overloaded Map&apos;s  put and remove methods to register and unregister SolrInfoMBean in MBeanServer. &lt;/p&gt;

&lt;p&gt;Later on, I am planning to use register and unregister methods in SolrInfoRegistry and removing getRegistry() method (Hiding the map instance to other classes)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12371116">SOLR-256</key>
            <summary>Stats via JMX</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalinmangar">Shalin Shekhar Mangar</assignee>
                                    <reporter username="sharad">Sharad Agarwal</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Jun 2007 08:58:19 +0100</created>
                <updated>Fri, 10 May 2013 11:40:03 +0100</updated>
                            <resolved>Tue, 29 Jul 2008 19:15:22 +0100</resolved>
                                                    <fixVersion>1.3</fixVersion>
                                    <component>search</component>
                    <component>update</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="12502258" author="sharad" created="Thu, 7 Jun 2007 09:06:38 +0100"  >&lt;p&gt;It uses Dynamic MBean to expose all SolrInfoMBean getStatistics() NameList keys as String getters.&lt;/p&gt;</comment>
                            <comment id="12503723" author="sharad" created="Tue, 12 Jun 2007 05:40:34 +0100"  >&lt;p&gt;-Corrected line wrap to 80 columns&lt;br/&gt;
-Used the original LinkedHashMap (when jmx monitoring in not enabled)&lt;/p&gt;</comment>
                            <comment id="12507659" author="hossman" created="Sun, 24 Jun 2007 07:06:17 +0100"  >&lt;p&gt;update of previous patch that works against trunk (r550170)&lt;/p&gt;</comment>
                            <comment id="12507660" author="hossman" created="Sun, 24 Jun 2007 07:21:23 +0100"  >&lt;p&gt;Sharad: JMX is one of those things i don&apos;t really understand very well, but i tried out the patch and played around with jconsole and it&apos;s really cool.&lt;/p&gt;

&lt;p&gt;one thing i&apos;m not clear on (forgive my jmx ignorance) when trying to figure out how jconsole worked, i found some info saying that to enable JMX in a java app, you use &quot;-Dcom.sun.management.jmxremote&quot; option on the java command line ... doing that even without this patch allowed jconsole to &quot;autodetect&quot; that the &quot;start.jar&quot; process on my local machine supported JMX and gave me some interesting stats on things like memory and thread usage info from the jetty instance (including MBeans for the java.util.Logger&apos;s SOlr creates).&lt;/p&gt;

&lt;p&gt;With the patch, it doesn&apos;t seem to matter wether i use that commandline option or not i can only get access to the new solr specific stats if i tell jconsole to explicitly connect to the service:jmx:... url that shows up in the log.  but in this case it can&apos;t get access to the other interesting stats from before (memory, thread, etc...) ... it seems like i can make two seperates &quot;sessions&quot; (forgive me if my terminology is wrong) to get this info, but not in the same session&lt;/p&gt;

&lt;p&gt;Is there a way to &quot;register&quot; the SOlr MBeans with the JVMs main JMX instance so all of hte info is available together?&lt;/p&gt;

&lt;p&gt;also: if we&apos;re going to have options for specifying the port for remove JMX connections, shoudl we also have options for the user/pass to connect with?&lt;/p&gt;
</comment>
                            <comment id="12507777" author="sharad" created="Mon, 25 Jun 2007 07:09:59 +0100"  >&lt;p&gt;Hoss, thanks for having given a look at the patch.&lt;/p&gt;

&lt;p&gt;Via -Dcom.sun.management.jmxremote jvm &quot;local&quot; platform monitoring gets enabled; and you get to see all jvm statistics.&lt;/p&gt;

&lt;p&gt;This patch actually starts its own mbean registry (called MBeanServer).  &lt;br/&gt;
    mbeanServer = MBeanServerFactory.createMBeanServer();&lt;br/&gt;
        java.lang.String serviceUrl = &quot;service:jmx:rmi:///jndi/rmi://&quot;&lt;br/&gt;
            + InetAddress.getLocalHost().getHostAddress().toString() + &quot;:&quot;&lt;br/&gt;
            + jmxPort + &quot;/solr&quot;;&lt;br/&gt;
        JMXConnectorServer cs = JMXConnectorServerFactory&lt;br/&gt;
            .newJMXConnectorServer(new JMXServiceURL(serviceUrl), null,&lt;br/&gt;
                mbeanServer);&lt;br/&gt;
        cs.start();&lt;/p&gt;

&lt;p&gt;Instead of starting its own, other alternative (as you have pointed out) could be to use platform registry itself. In that case:&lt;br/&gt;
MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();&lt;br/&gt;
Register all solr mbean into platform mbeanserver itself. In this case all info would be available together. &lt;/p&gt;

&lt;p&gt;Remote monitoring and access control could be set up using appropriate com.sun.management.jmxremote.port, com.sun.management.jmxremote.password.file, com.sun.management.jmxremote.ssl options. I found &lt;a href=&quot;http://java.sun.com/j2se/1.5.0/docs/guide/management/agent.html#properties&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/j2se/1.5.0/docs/guide/management/agent.html#properties&lt;/a&gt; pretty handy.&lt;/p&gt;

&lt;p&gt;I agree with you that having solr stats along with jvm stats makes more sense as it will require just one registry to manage.(setting up ports and access control). I can work on the patch to have that in place.&lt;/p&gt;



</comment>
                            <comment id="12507998" author="hossman" created="Mon, 25 Jun 2007 22:17:19 +0100"  >&lt;p&gt;&amp;gt; Instead of starting its own, other alternative (as you have pointed out) could be to use platform registry itself. In that &amp;gt; case:&lt;br/&gt;
&amp;gt; MBeanServer mbs = ManagementFactory.getPlatformMBeanServer(); &lt;/p&gt;

&lt;p&gt;that seems like the way to go.&lt;/p&gt;

&lt;p&gt; the one thing i&apos;m not clear on is if there is simple  programmaticly way to tell when JMX monitoring is already enabled so we can still do the check you have in the static block and only use the JMXified impls if we need them (i&apos;m assuming you put that in because there is some overhead we want to avoid if JMX is not needed)&lt;/p&gt;

&lt;p&gt;the javadocs for ManagementFactory.getPlatformMBeanServer() indicate that it creates on first use ... so testing that won&apos;t work ... we could test for the system properties ourselves, but i &lt;b&gt;think&lt;/b&gt; servlet containers like jetty and tomcat have their own config file syntax for enabling JMX and then call the neccessary underlying methods , so just becuase those properties aren&apos;t set doesn&apos;t neccessarily mean anything right?&lt;/p&gt;

&lt;p&gt;do you know if my guess about servlet containers programmaticly turning JMX on even without the standard system properties being set is true? do you have any suggestions on how to deal with this?  &lt;/p&gt;</comment>
                            <comment id="12508053" author="sharad" created="Tue, 26 Jun 2007 05:43:55 +0100"  >&lt;p&gt;ArrayList list = MBeanServerFactory.findMBeanServer(null);&lt;br/&gt;
gives all registered mbeanserver. It could be used to figure out programitically whether jmx is enabled or not.&lt;/p&gt;

</comment>
                            <comment id="12511983" author="sharad" created="Thu, 12 Jul 2007 07:26:49 +0100"  >&lt;p&gt;Update of patch to work on standard JAVA_OPTS to enable JMX. &lt;/p&gt;

&lt;p&gt;Now standard JMX properties (refer &lt;a href=&quot;http://java.sun.com/j2se/1.5.0/docs/guide/management/agent.html#properties&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/j2se/1.5.0/docs/guide/management/agent.html#properties&lt;/a&gt;) are used to configure JMX.&lt;/p&gt;

&lt;p&gt;To test the patch &lt;br/&gt;
set -Dcom.sun.management.jmxremote in JAVA_OPTS environment variable&lt;br/&gt;
then try using jconsole.&lt;/p&gt;
</comment>
                            <comment id="12514115" author="hossman" created="Fri, 20 Jul 2007 07:32:59 +0100"  >&lt;p&gt;Sharad: my concern with your most recent patch is that if a servlet container uses it&apos;s own config to drive programmatic JMX Server creation (jetty plus appears to do this past on the example jetty-jmx.xml config file, but i haven&apos;t actually confirmed this), then Solr won&apos;t detect it  because it&apos;s looking explicitly for the system properties.&lt;/p&gt;

&lt;p&gt;based on the javadocs your findMBeanServer(null) idea seems right on the money ... i&apos;m attaching a tweak to your patch that uses this appraoch, and it seems to work great, what do you think?&lt;/p&gt;

&lt;p&gt;(was there a reason you decided to look for the properties explicitly instead of try this appraoch?)&lt;/p&gt;

&lt;p&gt;Any JMX experts want to chime in whether we should be doing something differently? &lt;/p&gt;</comment>
                            <comment id="12514588" author="sharad" created="Mon, 23 Jul 2007 09:40:27 +0100"  >&lt;p&gt;I earlier tried with findMBeanServer(null) with tomcat; and it always return me non-empty list of mbeanservers irrespective of JMX enabled or not. In tomcat it gets enabled via system properties.&lt;br/&gt;
So to me it seems that having mbean server instance may not really confirm that JMX is enabled or not. &lt;/p&gt;

&lt;p&gt;Saying that, i think it may be OK to have the MonitoredMap even when JMX is not enabled. (dont think any overhead in using MonitoredMap); whenever JMX is enabled by either of the ways (standard system properties or via jetty config), both would work fine.&lt;/p&gt;
</comment>
                            <comment id="12514884" author="hossman" created="Tue, 24 Jul 2007 08:09:06 +0100"  >&lt;p&gt;Hmmm... some quick poking around makes it seem that tomcat always uses MBeanServers to manage things &amp;#8211; regardless of whether you explicitly turn on JMX monitoring or not (there seems to be an assumption that of course you want to monitor you server &amp;#8211; i can&apos;t really argue with that)&lt;/p&gt;

&lt;p&gt;i don&apos;t really know enough about JMX to know if there really is any sort of overhead here &amp;#8211; i suppose it wouldn&apos;t hurt to only use the MOnitoredMap if an explicit option is set (but we shouldn&apos;t startup our own MBeanServer like hte orriginal patch &amp;#8211; just use the main one)  but i&apos;m also fine committing the patch as is. &lt;/p&gt;

&lt;p&gt;any tomcat/jmx experts want to chime in here?&lt;/p&gt;</comment>
                            <comment id="12528595" author="samokk" created="Tue, 18 Sep 2007 23:33:56 +0100"  >&lt;p&gt;Hoss: It would probably be interesting to look at how Spring Framework solved the problem.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://static.springframework.org/spring/docs/2.0.x/reference/jmx.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://static.springframework.org/spring/docs/2.0.x/reference/jmx.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Spring JMX allows to export beans using JMX, and has an autodetection of the MBeanServer..  (&quot;locateExistingServerIfPossible&quot;). So, their code should probably either be linked, or reused to achieve similar effect...&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Sami Dalouche&lt;/p&gt;</comment>
                            <comment id="12528615" author="hossman" created="Wed, 19 Sep 2007 01:23:52 +0100"  >&lt;p&gt;Sami: thanks for the pointer to the spring docs ... both because it&apos;s informative and because it made me realize this issue is still open, i thought i&apos;d committed this a long time ago ... doh!&lt;/p&gt;

&lt;p&gt;Spring&apos;s approach to figuring out if there is an MBeanServer is basically the same as what we&apos;ve been looking at doing: call MBeanServerFactory.findMBeanServer and see what we get ... they just put some more bells and whistles on it to warn you if more then one is found and you haven&apos;t configured the agentId of the one you want (which is a good idea)&lt;/p&gt;

&lt;p&gt;the general approach spring takes to JMX as a whole however is subtly different then what we&apos;ve been talking about:  so far we&apos;ve discussed:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;having Solr specific configs for creating a Solr specific MBeanServer and if those are set, then wrap all of our info registry stuff so they are MBean aware.&lt;br/&gt;
...OR...&lt;/li&gt;
	&lt;li&gt;having no Solr specific config options and wrapping the info registry stuff in MBeans if we detect an MBeanServer already running.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Spring&apos;s appraoch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;have spring specific configs that specify things should be wraped in MBeans&lt;/li&gt;
	&lt;li&gt;have spring specific configs that specify if a spring specific MBeanServer should be created, and if not which existing MBeanServer to try and use by agentId.&lt;/li&gt;
	&lt;li&gt;if the first config option is set, but not the second, then register those MBeans with whatever MBeanServer you can find.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...this seems like the right way to go.  people that don&apos;t want any JMX at all won&apos;t get it.  people who want JMX if-and-only-if they&apos;ve activate an MBeanServer via the servlet container can configure the MBean wrapping option.  people that want Solr to do it all can configure solr with that info as well.&lt;/p&gt;

&lt;p&gt;basically it&apos;s a merge of both styles of patches so far.&lt;/p&gt;

&lt;p&gt;Unfortunately most of the existing patches are now unusable because of the Multi-core refactoring ... but i will try to work on a new patch (not sure when though, so if anyone else is gung ho don&apos;t let me stop you)&lt;/p&gt;
</comment>
                            <comment id="12528851" author="hossman" created="Wed, 19 Sep 2007 19:30:09 +0100"  >&lt;p&gt;proposed solrconfig.xml syntax...&lt;/p&gt;

&lt;p&gt;&amp;lt;jmx /&amp;gt;&lt;/p&gt;

&lt;p&gt;...wraps the solr registry stuff in MBeans, adds them to the first MBeanSearver it finds (if any) but will not create one.&lt;/p&gt;

&lt;p&gt;&amp;lt;jmx agentId=&quot;foo&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;...wraps the solr registry stuff in MBeans, adds them to the first MBeanServer it finds matching that agentId, error if MBeanServer can&apos;t be found.&lt;/p&gt;

&lt;p&gt;&amp;lt;jmx serviceurl=&quot;service:jmx:rmi:///jndi/rmi://localhost:9999/solr&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;...wraps the solr registry stuff in MBeans, foracbly spins up a new MBeanServer exposed for remote monitoring at the specific service url, if the JMXConnectorServer can&apos;t be started (probably because the serviceurl is bad) then error.&lt;/p&gt;

&lt;p&gt;(we can punt on the issue of security &amp;#8211; if users want Solr to manage their JMX remote debuging then it&apos;s wide open; if you want password files or ssl, then configure that with the JVM system properties for remote debugging and just tell solr &quot;&amp;lt;jmx /&amp;gt;&quot;)&lt;/p&gt;
</comment>
                            <comment id="12589504" author="shalinmangar" created="Wed, 16 Apr 2008 12:34:50 +0100"  >&lt;p&gt;A new patch which incorporates Hoss&apos;s proposed syntax. All three syntax such as jmx, jmx with agentId and jmx with serviceUrl are supported.&lt;/p&gt;

&lt;p&gt;SolrConfig is modified to load JMX configuration. A new class called JmxManager is introduced which intializes JMX support and registers all SolrInfoMBeans (using core.getInfoRegistry). JmxManager is created per core in the SolrCore constructor. It is destroyed in the SolrCore.close() method.&lt;/p&gt;</comment>
                            <comment id="12589545" author="shalinmangar" created="Wed, 16 Apr 2008 14:20:09 +0100"  >&lt;p&gt;Fixed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-256&quot; title=&quot;Stats via JMX&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-256&quot;&gt;&lt;del&gt;SOLR-256&lt;/del&gt;&lt;/a&gt;.patch to avoid NullPointerException during core shutdown when JMX is not enabled.&lt;/p&gt;</comment>
                            <comment id="12589836" author="shalinmangar" created="Thu, 17 Apr 2008 07:18:57 +0100"  >&lt;p&gt;Changes&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Changed the type of the SolrInfoMBeans to the key specified in registry. Previously, I had used the SolrInfoMBean class&apos;s simple name which lead to duplicate registration of LRUCache (which is used as filterCache, queryResultCache and documentCache).&lt;/li&gt;
	&lt;li&gt;Fixed the parent name of the MBeans to solr (if using single cores). With multicores, the parent name is solr/core-name&lt;/li&gt;
	&lt;li&gt;Throws an exception if no server is found with the given agentId&lt;/li&gt;
	&lt;li&gt;Removed code I had added for debugging&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also, I&apos;ve added &amp;lt;jmx /&amp;gt; in the example solrconfig.xml to turn on JMX by default.&lt;/p&gt;</comment>
                            <comment id="12590025" author="shalinmangar" created="Thu, 17 Apr 2008 14:30:34 +0100"  >&lt;p&gt;No changes, just synchronizing with the changes in SolrCore made by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-509&quot; title=&quot;Event Listeners called before request handlers are informed of SolrCore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-509&quot;&gt;&lt;del&gt;SOLR-509&lt;/del&gt;&lt;/a&gt; commit&lt;/p&gt;</comment>
                            <comment id="12596288" author="shalinmangar" created="Tue, 13 May 2008 06:56:39 +0100"  >&lt;p&gt;No changes. Just synchronizing the patch with the latest trunk code.&lt;/p&gt;</comment>
                            <comment id="12596369" author="gsingers" created="Tue, 13 May 2008 13:04:20 +0100"  >&lt;p&gt;Is it possible to write JUnit tests for this?  I don&apos;t know much about JMX, but was thinking it still makes sense to have tests.&lt;/p&gt;

&lt;p&gt;If not, what is the best way to test?  &lt;/p&gt;

&lt;p&gt;FWIW, the latest patch applies cleanly and all current tests pass.&lt;/p&gt;</comment>
                            <comment id="12596494" author="mgod" created="Tue, 13 May 2008 19:55:40 +0100"  >&lt;p&gt;Tested the latest patch against the trunk. Almost everything works great. I get one warning:&lt;/p&gt;

&lt;p&gt;WARNING: Could not getStatistics on info bean org.apache.solr.handler.admin.AdminHandlers&lt;/p&gt;

&lt;p&gt;It seems to work fine, but I&apos;m new to both Solr and JMX.&lt;/p&gt;

&lt;p&gt;Thanks for the updated patch Shalin&lt;br/&gt;
Marshall&lt;/p&gt;</comment>
                            <comment id="12596677" author="shalinmangar" created="Wed, 14 May 2008 10:04:12 +0100"  >&lt;p&gt;Marshall - Thank you for trying the patch. I&apos;ve noticed those warnings too. I&apos;ll take a look into it.&lt;/p&gt;

&lt;p&gt;Grant - Yes, I believe we can write JUnit tests for this (or at least a part of the functionality). I&apos;ll try to submit a new patch with tests by the end of this week.&lt;/p&gt;</comment>
                            <comment id="12598843" author="hossman" created="Wed, 21 May 2008 23:54:59 +0100"  >&lt;p&gt;skimming the patch, i think it&apos;s worth trying to get this in 1.3 assuming Shalin is able to ad some unit tests.&lt;/p&gt;

&lt;p&gt;Shalin: the three things that jumped out at me when reading the patch (unfortunately didn&apos;t have time to try testing it) is...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;not sure why the separate init method is needed in the JmxManager class ... particularly since hte rest of hte constructor should be skipped if the init method doesn&apos;t set server ... seems simpler to just put lal of that in the constructor.&lt;/li&gt;
	&lt;li&gt;we should think about the situation when new &quot;stuff&quot; is dynamical registered after the SolrCore starts up ... SolrCore.registerRequestHandler for example can be called at any time.  We may need to sprinkle some more hooks in SolrCore to call JmxManager.register (and to make JmxManager.register more resilient in case it gets called on an already register object, or when JMX is disabled anyway)&lt;/li&gt;
	&lt;li&gt;we should be careful about documenting what &lt;tt&gt;&amp;lt;jmx /&amp;gt;&lt;/tt&gt; does ... i think in the example config you said it turns JMX monitoring on by default, but that&apos;s not true &amp;#8211; it turns it on if and only if an existing MBeanServer is found ... we should be clear about that.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12599207" author="shalinmangar" created="Thu, 22 May 2008 22:57:22 +0100"  >&lt;p&gt;Hoss &amp;#8211; I agree on all three points. I would like to see it in 1.3 too. I can take this up after I&apos;m finished with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-572&quot; title=&quot;Spell Checker as a Search Component&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-572&quot;&gt;&lt;del&gt;SOLR-572&lt;/del&gt;&lt;/a&gt;. If someone else wants to work on this, please go ahead.&lt;/p&gt;</comment>
                            <comment id="12607189" author="shalinmangar" created="Mon, 23 Jun 2008 12:33:42 +0100"  >&lt;p&gt;I&apos;m taking a look again at this feature. Hope to have a patch ready soon.&lt;/p&gt;

&lt;p&gt;A few issues I found was that apart from SolrCore.registerRequestHandler, the SolrIndexSearcher is also dynamic and needs to be handled. I also found other issues like SolrIndexSearcher puts the cache objects into the InfoRegistry map but that they are never removed from the map. The SolrCore#closeSearcher calls:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;infoRegistry.remove(&lt;span class=&quot;code-quote&quot;&gt;&quot;currentSearcher&quot;&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; but the SolrIndexSearcher adds/removes itself using its name. I think we should use &quot;currentSearcher&quot; itself as the key instead of name because the name changes after commits and that would make it very difficult to setup monitoring for SolrIndexSearcher using JMX.&lt;/p&gt;

&lt;p&gt;To handle dynamic registration and unregistration, I think we should use the approach that Sharad used in his original patch which was to create a class which extends Map and overrides the put and remove methods. That will make sure that SolrInfoMBeans are automatically registered and unregistered and will keep the JMX related code in one place.&lt;/p&gt;</comment>
                            <comment id="12607480" author="shalinmangar" created="Tue, 24 Jun 2008 06:57:28 +0100"  >&lt;p&gt;&lt;b&gt;Changes&lt;/b&gt;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Updated the documentation in example solrconfig.xml as per Hoss&apos;s suggestion&lt;/li&gt;
	&lt;li&gt;Renamed JmxManager to JmxMonitoredMap which extends a ConcurrentHashMap and overrides put, remove and clear methods&lt;/li&gt;
	&lt;li&gt;The JmxMonitoredMap is used to hold the infoRegistry (String-&amp;gt;SolrInfoMBean) so that registration and unregistration is done automatically (which takes care of dynamic registration of request handlers, lazy loading, new SolrIndexSearchers etc.)&lt;/li&gt;
	&lt;li&gt;The SolrIndexSearcher is added with the name &quot;searcher&quot; to the map so that the name of the MBean doesn&apos;t change which helps setup monitoring&lt;/li&gt;
	&lt;li&gt;Instead of removing SolrIndexSearcher from the registry, it is simply replaced when SolrIndexSearcher#register method is called. This makes sure that the searcher registered with JMX is the current searcher (with a small margin of error)&lt;/li&gt;
	&lt;li&gt;Added two tests
	&lt;ul&gt;
		&lt;li&gt;TestJmxMonitoredMap passes a service url syntax to JmxMonitoredMap and uses a mocked SolrInfoMBean to test the put, remove and clear methods. Note that this test uses a hard-coded port number &amp;#8211; unavailability of this port will fail the test.&lt;/li&gt;
		&lt;li&gt;TestJmxIntegration uses the AbstractSolrTestCase with the platform MBeanServer to test availability of Solr MBeans and tests for its updation by adding a document.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12610272" author="shalinmangar" created="Thu, 3 Jul 2008 17:28:39 +0100"  >&lt;p&gt;Syncing the patch with trunk. No other changes in the code base.&lt;/p&gt;

&lt;p&gt;I&apos;ve created a wiki page to document the configuration, functionality and usage of this feature at &lt;a href=&quot;http://wiki.apache.org/solr/SolrJmx&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/SolrJmx&lt;/a&gt; (work in progress)&lt;/p&gt;</comment>
                            <comment id="12615609" author="shalinmangar" created="Tue, 22 Jul 2008 13:39:57 +0100"  >&lt;p&gt;Syncing the patch with the trunk code.&lt;/p&gt;

&lt;p&gt;It seems that the Query.instanceOf method that I was using in TestJmxIntegration was added only in Java 6. Strangely, eclipse did not complain about it even though the compiler in eclipse was set to 5.0. The test has been changed and uses an alternate 5.0 compatible way.&lt;/p&gt;</comment>
                            <comment id="12617205" author="shalinmangar" created="Sat, 26 Jul 2008 19:51:34 +0100"  >&lt;p&gt;Syncronizing with the trunk code. No other changes.&lt;/p&gt;

&lt;p&gt;Hoss &amp;#8211; Is there anything else we need to do to commit this?&lt;/p&gt;</comment>
                            <comment id="12617632" author="hossman" created="Tue, 29 Jul 2008 02:07:04 +0100"  >&lt;p&gt;Shalin:&lt;/p&gt;

&lt;p&gt;I&apos;m really sorry, I&apos;m way behind schedule on my &quot;patch review&quot; responsibilities.&lt;/p&gt;

&lt;p&gt;skimming the patch, I see no red flags.&lt;/p&gt;

&lt;p&gt;Some minor misc nitpicks... &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I&apos;d prefer if we removed the hard coded port number in TestJmxMonitoredMap (hard coded stuff like that has caused us nothing but problems in the past).  If i&apos;m understanding the JMXServiceURL javadocs correctly, let&apos;s hardcode port=0 for the url constructed by the test ... then add a getJMXServiceURL() to JmxMonitoredMap that the test can then call and pass to to the JMXConnectorFactory ... that should give us either a random port that isn&apos;t in use by anyone else, right?&lt;/li&gt;
	&lt;li&gt;it seems like it would be a little cleaner if SolrIndexSearcher.register() registered itself before it registered it&apos;s subcomponents .. not sure that it really matters, but it certain reads a little weird.&lt;/li&gt;
	&lt;li&gt;SolrIndexSearcher.register() is logging &apos;&quot;Registering new searcher: &quot; + System.currentTimeMillis()&apos; for every cache it registers ... that seems like a cut/paste mistake.&lt;/li&gt;
	&lt;li&gt;is there any reason not to have the searcher&apos;s add/remove themselves using their true name on register()/close() &lt;b&gt;and&lt;/b&gt; have register() call  put(&quot;searcher&quot;, this) like you have it now? ... that way you&apos;d get the benefits you mentioned before (continuous monitoring of the current searcher) but you could also get information about how many &quot;live&quot; searchers there currently are, and what their stats look like (so you could, for example, notice when there is a really old Searcher hanging around for some inexplicable reason, probably a bug.)&lt;/li&gt;
	&lt;li&gt;couldn&apos;t we completely eliminate any overhead of JMX for people who haven&apos;t enabled it by adding an &quot;isEnabled()&quot; method to JmxMonitoredMap that returns true if server!=null and then make the SolrCore changes look like...
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     &lt;span class=&quot;code-comment&quot;&gt;//Initialize Registry w/JMX &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; enabled
&lt;/span&gt;     JmxMonitoredMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,SolrInfoMBean&amp;gt; tmp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JmxMonitoredMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,SolrInfoMBean&amp;gt;(name, config.jmxConfig);
     infoRegistry = (tmp.isEnabled() ? tmp : &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,SolrInfoMBean&amp;gt;() );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12617635" author="hossman" created="Tue, 29 Jul 2008 02:08:49 +0100"  >&lt;p&gt;Shalin&apos;s been doing all the work on this puppy, no reason for it to be assigned to me anymore.&lt;/p&gt;

&lt;p&gt;Commit whenever you&apos;re ready dude.&lt;/p&gt;</comment>
                            <comment id="12617771" author="shalinmangar" created="Tue, 29 Jul 2008 12:57:12 +0100"  >&lt;p&gt;Hoss, thanks for the comments.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Specifying port=0 to ServiceUrl does not work, it blindly tries to connect to localhost on port 0 and fails with a java.rmi.ConnectException. We can try to do something like this:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ServerSocket server = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServerSocket(0);
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; port = server.getLocalPort();
server.close();
&lt;span class=&quot;code-comment&quot;&gt;// Use the port&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However it will not be reliable on every environment. I can put this into a loop and retry a fixed number of times before failing. That should be good enough.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Agreed&lt;/li&gt;
	&lt;li&gt;Copy/paste error &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;That&apos;s a very good idea.&lt;/li&gt;
	&lt;li&gt;Not sure if it really matters but that&apos;s very easy to do.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I shall give a patch shortly.&lt;/p&gt;</comment>
                            <comment id="12617884" author="shalinmangar" created="Tue, 29 Jul 2008 19:00:00 +0100"  >&lt;p&gt;Incorporates Hoss&apos;s suggestions as per comment above.&lt;/p&gt;

&lt;p&gt;Another change is that the UpdateHandler constructor adds itself to the infoRegistry. This leads to an NullPointerException in DirectUpdateHandler2#getStatistics because when JmxMonitoredMap tries to read the statistics, the instance variables of DUH2 haven&apos;t been initialized yet. The call to infoRegistry.put has now been moved to SolrCore constructor right after it creates the UpdateHandler.&lt;/p&gt;

&lt;p&gt;I shall commit this shortly.&lt;/p&gt;</comment>
                            <comment id="12617892" author="shalinmangar" created="Tue, 29 Jul 2008 19:15:22 +0100"  >&lt;p&gt;Committed revision 680795.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12387120" name="SOLR-256.patch" size="27930" author="shalinmangar" created="Tue, 29 Jul 2008 19:00:00 +0100"/>
                            <attachment id="12386961" name="SOLR-256.patch" size="27273" author="shalinmangar" created="Sat, 26 Jul 2008 19:51:34 +0100"/>
                            <attachment id="12386627" name="SOLR-256.patch" size="27218" author="shalinmangar" created="Tue, 22 Jul 2008 13:39:57 +0100"/>
                            <attachment id="12385216" name="SOLR-256.patch" size="26943" author="shalinmangar" created="Thu, 3 Jul 2008 17:28:39 +0100"/>
                            <attachment id="12384563" name="SOLR-256.patch" size="26590" author="shalinmangar" created="Tue, 24 Jun 2008 06:57:27 +0100"/>
                            <attachment id="12381928" name="SOLR-256.patch" size="14455" author="shalinmangar" created="Tue, 13 May 2008 06:56:39 +0100"/>
                            <attachment id="12380392" name="SOLR-256.patch" size="14444" author="shalinmangar" created="Thu, 17 Apr 2008 14:30:34 +0100"/>
                            <attachment id="12380368" name="SOLR-256.patch" size="15345" author="shalinmangar" created="Thu, 17 Apr 2008 07:18:57 +0100"/>
                            <attachment id="12380277" name="SOLR-256.patch" size="14091" author="shalinmangar" created="Wed, 16 Apr 2008 14:20:09 +0100"/>
                            <attachment id="12380269" name="SOLR-256.patch" size="14051" author="shalinmangar" created="Wed, 16 Apr 2008 12:34:49 +0100"/>
                            <attachment id="12362198" name="jmx.patch" size="7099" author="hossman" created="Fri, 20 Jul 2007 07:32:59 +0100"/>
                            <attachment id="12361645" name="jmx.patch" size="6937" author="sharad" created="Thu, 12 Jul 2007 07:26:49 +0100"/>
                            <attachment id="12360408" name="jmx.patch" size="7669" author="hossman" created="Sun, 24 Jun 2007 07:06:17 +0100"/>
                            <attachment id="12359462" name="jmx.patch" size="7662" author="sharad" created="Tue, 12 Jun 2007 05:40:33 +0100"/>
                            <attachment id="12359154" name="jmx.patch" size="7400" author="sharad" created="Thu, 7 Jun 2007 09:06:38 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>15.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 24 Jun 2007 06:06:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7333</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxsg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20928</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>