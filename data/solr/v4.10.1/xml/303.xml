<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:25:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-303/SOLR-303.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-303] Distributed Search over HTTP</title>
                <link>https://issues.apache.org/jira/browse/SOLR-303</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Searching over multiple shards and aggregating results.&lt;br/&gt;
Motivated by &lt;a href=&quot;http://wiki.apache.org/solr/DistributedSearch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/DistributedSearch&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12373878">SOLR-303</key>
            <summary>Distributed Search over HTTP</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="sharad">Sharad Agarwal</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Jul 2007 09:35:54 +0100</created>
                <updated>Fri, 10 May 2013 11:38:58 +0100</updated>
                            <resolved>Tue, 22 Jul 2008 00:00:55 +0100</resolved>
                                                    <fixVersion>1.3</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>14</votes>
                                    <watches>18</watches>
                                                                <comments>
                            <comment id="12512892" author="sharad" created="Mon, 16 Jul 2007 09:41:09 +0100"  >&lt;p&gt;To do a quick test of the patch, try adding:&lt;br/&gt;
shards=local,localhost:8080&lt;br/&gt;
as a request parameter to the search url&lt;/p&gt;</comment>
                            <comment id="12512983" author="yseeley@gmail.com" created="Mon, 16 Jul 2007 19:01:24 +0100"  >&lt;p&gt;Thanks for kicking this off Sharad!&lt;/p&gt;

&lt;p&gt;&amp;gt; &quot;Index view consistency between multiple requests&quot; requirement is relaxed in this implementation. &lt;/p&gt;

&lt;p&gt;Do you have plans to remedy that?  Or do you think that most people are OK with inconsistencies that could arise?&lt;/p&gt;

&lt;p&gt;&amp;gt; Load-balancing and Fail-over taken care by VIP as usual&lt;/p&gt;

&lt;p&gt;In a static configuration, this works OK, but it might be nice to support a more dynamic environment where extra shards could be easily added.  It might also be the case that a custom partitioning function could be implemented (such as improving caching by partitioning queries, etc) or it may be more efficient to do the second phase of a query on the same shard copy as the first phase.&lt;br/&gt;
In that case it might make sense load balancing across shards from Solr . The  VIP solution would map to the simplest case of a single copy of each shard, thus a LB could still be used if desired.&lt;/p&gt;

&lt;p&gt;&amp;gt; STEP 1: The query is built, terms are extracted. &lt;/p&gt;

&lt;p&gt;Where are terms extracted from (some queries require index access)?  This should be delegated to the shards, no?  It can be the same step that gets the docFreqs from the shards (pass the query, &lt;b&gt;not&lt;/b&gt; the terms).  Step 1 should also be optional for those that can make do with local idf factors.&lt;/p&gt;

&lt;p&gt;In order to facilitate custom logic in a distributed environment,&lt;br/&gt;
I think we should base the solution on something like&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-281&lt;/a&gt;&lt;br/&gt;
With additional hooks for distributed search.&lt;br/&gt;
This should allow relatively independent parts of query processing to piggyback in the same network request (for example, the first steps to querying and faceting can be added to a single request, and highlighting and stored field retrieval can be done in conjunction).&lt;/p&gt;

&lt;p&gt;Any thoughts on RMI vs HTTP for the searcher-subsearcher interface?  &lt;/p&gt;
</comment>
                            <comment id="12513167" author="sharad" created="Tue, 17 Jul 2007 08:25:24 +0100"  >&lt;p&gt;&amp;gt; &quot;Index view consistency between multiple requests&quot; requirement is relaxed in this implementation.&lt;br/&gt;
&amp;gt;&amp;gt;Do you have plans to remedy that? Or do you think that most people are OK with inconsistencies that could arise?&lt;br/&gt;
The thing to note here is that currently multi phase execution is based on document unique fields, NOT on doc internal ids. So there wont be much inconsistencies between requests; as it does not depend on changing internal doc ids. &lt;br/&gt;
The possibility is that a particular document may have been deleted when the second phase executes.; which in my opinion should be OK to live with.&lt;br/&gt;
Other possibility could be the document is changed and original query terms are not present in the document anymore. This can be solved by doing a AND with the original query and uniq field document query.&lt;/p&gt;

&lt;p&gt;If people think it is really crucial to have index view consistency, then it should be easy to implement &quot;Consistency via Retry&quot; as mentioned in &lt;a href=&quot;http://wiki.apache.org/solr/FederatedSearch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/FederatedSearch&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;It might also be the case that a custom partitioning function could be implemented (such as improving caching by partitioning queries, etc) or it may &amp;gt;&amp;gt;be more efficient to do the second phase of a query on the same shard copy as the first phase.&lt;br/&gt;
&amp;gt;&amp;gt;In that case it might make sense load balancing across shards from Solr. &lt;br/&gt;
For second phase of a query to execute on the same shard copy, third party &quot;Sticky load balancers&quot; can be used. I believe Apache already does that. All copies of a single partition can sit behind the Apache load balancer (doing the &quot;Sticky&quot;). The merger just needs to know about the Load-balancer ip/port for each partition. Now based on the query, merger can search the appropriate partitions only.&lt;/p&gt;

&lt;p&gt;To improve the caching, Solr itself has to do the load balancing. Other option could be to introduce the query result cache at the merger itself.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;Where are terms extracted from (some queries require index access)? This should be delegated to the shards, no?It can be the same step that gets &amp;gt;&amp;gt;the docFreqs from the shards (pass the query, &lt;b&gt;not&lt;/b&gt; the terms). &lt;br/&gt;
yes, if thats the case, should be easy to implement as you have suggested.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;I think we should base the solution on something like &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-281&lt;/a&gt; &lt;br/&gt;
cool, I was looking for something like this. This looks like the way to go.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;Any thoughts on RMI vs HTTP for the searcher-subsearcher interface? &lt;br/&gt;
RMI could be supported as an option by enhancing the ResponseParser (better name ??) interface. The remote search server can directly return the SolrQueryResponse object. I understand that there will be some performance benefit if doing the native java marshalling/unmarshalling of object; instead of Solr response writing and then parsing (if done the HTTP way). The question we need to answer is: Is the effort/complexity worth it?&lt;/p&gt;

&lt;p&gt;In our organization we made a conscious decision to go for HTTP. The operation folks like HTTP as it is standard stuff, load balancing, monitoring etc. Lot of tools already available for it. With RMI, I am not sure external Sticky load-balancing is possible; the merger itself has to build the logic.&lt;br/&gt;
Moreover, I think HTTP fits more naturally with Solr in its Request handler model.&lt;/p&gt;


</comment>
                            <comment id="12513488" author="sharad" created="Wed, 18 Jul 2007 09:48:20 +0100"  >&lt;p&gt;Making this issue blocked by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12516651" author="sharad" created="Tue, 31 Jul 2007 10:05:09 +0100"  >&lt;p&gt;Added support for sorting.&lt;/p&gt;</comment>
                            <comment id="12523925" author="klaasm" created="Thu, 30 Aug 2007 21:10:40 +0100"  >&lt;p&gt;Great stuff!&lt;/p&gt;

&lt;p&gt;I think asynchronous/parallel requests are a central feature to this kind of result aggregator.  In my similar python implementation, I fire off all the requests and collect the responses in a select() loop.  Threads are possible but get somewhat weighty when you have many shards (I&apos;ve used up to 90).  An easier alternative to select() is to simply fire off all the requests and then wait for the responses sequentially (assuming java has an api that allows this).  This is almost as good as the select() loop but does not have the same complexity.&lt;/p&gt;</comment>
                            <comment id="12523996" author="sharad" created="Fri, 31 Aug 2007 05:25:39 +0100"  >&lt;p&gt;Recently I have added a feature of parallel requests to shards using a thread pool. (not yet uploaded the patch)&lt;br/&gt;
Async IO would be the next thing but dont want to bring in its complexity so early.&lt;br/&gt;
Perhaps, we can benchmark the performance of the thread pool/parallel requests implementation. Later based on the numbers, work towards having Async IO.&lt;/p&gt;</comment>
                            <comment id="12526563" author="stuhood" created="Tue, 11 Sep 2007 20:11:55 +0100"  >&lt;p&gt;Sharad, what Solr revision have you applied the latest copy of this this patch against? I know that the r573893 commit caused all kinds of havoc in the source tree, but I&apos;d really like to try it out, and I don&apos;t mind using an older revision to get it working.&lt;/p&gt;

&lt;p&gt;Also, do you have any newer versions of the patch?&lt;/p&gt;

&lt;p&gt;Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="12526669" author="sharad" created="Wed, 12 Sep 2007 06:00:19 +0100"  >&lt;p&gt;Updated to do following:&lt;br/&gt;
1. Fed search query being executed via different components&lt;br/&gt;
-GlobalCollectionStatComponent (optional)&lt;br/&gt;
-FirstQPhaseComponent&lt;br/&gt;
-SecondQPhaseComponent (optional)&lt;br/&gt;
The user can use &apos;skip&apos; request param to tell which component to skip&lt;/p&gt;

&lt;p&gt;2. Sub searcher requests are executed in parallel threads using thread pool.&lt;/p&gt;

&lt;p&gt;3. work against the trunk revision 574785.&lt;/p&gt;

&lt;p&gt;I am working on further refactoring the code and make it work with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt;, which should make the code really clean with pluggable components.&lt;/p&gt;</comment>
                            <comment id="12527570" author="stuhood" created="Fri, 14 Sep 2007 18:01:04 +0100"  >&lt;p&gt;Thanks Sharad, the last patch applied cleanly as you said.&lt;/p&gt;

&lt;p&gt;I&apos;ve run into some errors that should be quick fixes for your next revision:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I had to modify the code not to assume that shard names end in &apos;/solr&apos; so that I could specify an instance name, like: &apos;blah.com:8080/instance_name&apos;.&lt;/li&gt;
	&lt;li&gt;The parameters for your subqueries are not (always?) getting escaped. My document ids contain some colons (&apos;:&apos;), and so its throwing a null pointer error during the SecondQueryphase, and then again in SolrCore execute.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Thanks a lot for your work!&lt;/p&gt;</comment>
                            <comment id="12527637" author="stuhood" created="Fri, 14 Sep 2007 22:22:14 +0100"  >&lt;p&gt;For the second issue above, I did the following:&lt;/p&gt;

&lt;p&gt;*Added &apos;static String escape(string, field, schema)&apos; to QueryParsing, that uses SolrQueryParser&apos;s escape method. I run this across all key values as they are being iterated in the beginning of &apos;SecondQPhaseComponent.createSecondPhaseParams&apos;&lt;/p&gt;</comment>
                            <comment id="12527647" author="stuhood" created="Fri, 14 Sep 2007 23:08:18 +0100"  >&lt;p&gt;I&apos;m also seeing the following issue, but I haven&apos;t have time to investigate:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;WARNING: Exception while querying shard crc10:8080/solr_postfix09092000-09112000 :java.lang.ClassCastException: com.sun.org.apache.xerces.internal.dom.DeferredTextImpl cannot be cast to org.w3c.dom.Element&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="12528083" author="stuhood" created="Mon, 17 Sep 2007 15:40:47 +0100"  >&lt;p&gt;I was trying to use the PHP serialized response writer with the federate search patch, and ran into some trouble. Then I noticed that you had made some changes in XMLWriter to support the federated.ResponseDocs class.&lt;/p&gt;

&lt;p&gt;Is there any way ResponseDocs could extend Doclist so that all of the writers don&apos;t need to be modified?&lt;/p&gt;</comment>
                            <comment id="12528253" author="sharad" created="Tue, 18 Sep 2007 06:20:10 +0100"  >&lt;p&gt;&amp;gt;Is there any way ResponseDocs could extend Doclist so that all of the writers don&apos;t need to be modified?&lt;br/&gt;
ResonseDocs are based on document unique key while DocList is based on internal doc id. &lt;br/&gt;
The purpose of ResponseDocs is to represent documents lying in remote index while DocList are meant for local internal doc id.&lt;/p&gt;

&lt;p&gt;I dont think there is an easy way to avoid modifying writers. Currently writers retrieve document data based on local internal doc id. But for remote index, this has to be done differently.&lt;/p&gt;</comment>
                            <comment id="12528260" author="stuhood" created="Tue, 18 Sep 2007 06:50:20 +0100"  >&lt;p&gt;Yea, that is a bit of a problem isn&apos;t it...&lt;/p&gt;

&lt;p&gt;It looks like if you subclassed SolrIndexSearcher and DocList, you could generate fake Lucene document ids that map back to actual unique keys. Unfortunately, SolrIndexSearcher is intimidatingly long, so depending on how people feel about adding to the writers, it might not be necessary to modify it.&lt;/p&gt;</comment>
                            <comment id="12528494" author="hossman" created="Tue, 18 Sep 2007 19:27:06 +0100"  >&lt;p&gt;FWIW: I haven&apos;t really been able to follow this issue much (it&apos;s way out of my area of expertise) but seeing some comments go by in email i wanted to mention two things...&lt;/p&gt;

&lt;p&gt;&amp;gt; ResonseDocs are based on document unique key while DocList is based on internal doc id.&lt;br/&gt;
&amp;gt; The purpose of ResponseDocs is to represent documents lying in remote index while DocList are&lt;br/&gt;
&amp;gt; meant for local internal doc id.&lt;/p&gt;

&lt;p&gt;One thing to keep in mind is the way MultiReader deals with this in Lucene ... if you know the maxDoc of each of your sub-indexes, then you can compute internal docIds ... that may be one way to preserve the DocList abstraction (and allow for supporting schemas without uniqueKey fields) when dealing with federated search  (allthough it may open up new problems if you need to rely on havingsome form of an identifier that doesn&apos;t change .. i&apos;m not sure if the approach being taken makes multiple requests to the shards)&lt;/p&gt;

&lt;p&gt;That said...&lt;/p&gt;

&lt;p&gt;Federated Search is a complex enough concept that if it requires additions to the ResponseWriter API to be done effeciently, I don&apos;t think that would be the end of the world &amp;#8211; the key thing would be to find ways to minimize the impact on existing clients &amp;#8211; if things work for you now, they should keep working for you; if you want to start using federated search, then it&apos;s fair to expect that you may have to change a few things, or deal with a few limitations.  Off hte top of my head: one option may be to add a FederatableResponseWriter subclass such that if a request is federated, then the writer being used must implement that interface or it&apos;s a runtime error.&lt;/p&gt;</comment>
                            <comment id="12528593" author="stuhood" created="Tue, 18 Sep 2007 23:24:53 +0100"  >&lt;p&gt;I&apos;ve been working with the most recent version of the patch some more, and have run into some more issues. Since I&apos;m sure that you have been working on the patch on your own, I don&apos;t want you to have to dig through my changes as a diff. Instead I&apos;ll just try and point them out for your revision.&lt;/p&gt;

&lt;p&gt;We have a few fields that are indexed as strings that contain characters like &apos;@&apos; and &apos;:&apos;. There are still a few places having to do with the &apos;df&apos; parameter where these need to be escaped/worked around, but here is what I&apos;ve found so far:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;During the iteration over the document&apos;s uniqFields in SecondQPhaseComponent.createSecondPhaseParams
	&lt;ul&gt;
		&lt;li&gt;Surrounded the value in &quot;quotes&quot;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;During the iteration over strTerms in MultiSearchRequestHandler.buildQuery
	&lt;ul&gt;
		&lt;li&gt;Modified the split on &apos;@&apos; to only split on the last &apos;@&apos; in the string.&lt;/li&gt;
		&lt;li&gt;Modified the split on &apos;:&apos; to split into a maximum of 2 pieces.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;During the iteration over extractedTerms in GlobalCollectionStatComponent.calcuateGlobalCollectionStat
	&lt;ul&gt;
		&lt;li&gt;Modified the split on &apos;:&apos; to split into a maximum of 2 pieces.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;I also ran into some problems in other areas:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;XMLResponseParser.parse(url, params) fails to parse a response if it is indented using the &apos;indent=on&apos; parameter, which gets passed through to the subqueries
	&lt;ul&gt;
		&lt;li&gt;Stripped out &apos;indent&apos; during the iteration over the params (but there is probably a better solution to this issue)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;SecondQPhaseComponent.createSecondPhaseParams passes the &apos;start&apos; parameter through to the subqueries, which leads to a null pointer when we are querying for specific unique ids.
	&lt;ul&gt;
		&lt;li&gt;Stripped out &apos;start&apos; during the iteration over the params&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;I&apos;ll keep looking for the last few &apos;df&apos; issues. Thanks a lot for the patch!&lt;/p&gt;</comment>
                            <comment id="12528674" author="sharad" created="Wed, 19 Sep 2007 07:55:41 +0100"  >&lt;p&gt;Thanks much Stu for pointing the issues. Will take care of these in next update.&lt;/p&gt;</comment>
                            <comment id="12528837" author="stuhood" created="Wed, 19 Sep 2007 18:35:32 +0100"  >&lt;p&gt;I got the rest of the DF issues resolved: please refer to the attached and ignore my earlier comments (some of them were faulty).&lt;/p&gt;

&lt;p&gt;Here is a patch that is very similar to your last patch, but with my fixes included. If you `diff fedsearch.stu.patch fedsearch.patch` you should be able to see what I did.&lt;/p&gt;

&lt;p&gt;The final (minor) issue I&apos;ve found, is that when I strip the &apos;start&apos; parameter in SecondQPhaseComponent.createSecondPhaseParams, it gets stripped from the response that is returned to the user as well (although it is honored in the results).&lt;/p&gt;

&lt;p&gt;Thanks again!&lt;/p&gt;</comment>
                            <comment id="12529559" author="stuhood" created="Fri, 21 Sep 2007 22:35:04 +0100"  >&lt;p&gt;Here is another revision of the latest patch (I&apos;ve still only tried it with r574785: I&apos;m a bit crunched for time).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Resolved issues:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We were forgetting to increment a counter during the last step in SecondQPhaseComponent.process, and so we weren&apos;t getting results from all shards.&lt;/li&gt;
	&lt;li&gt;SecondQPhaseComponent.merge was throwing away any fields that already existed in a document, and so it was throwing away parts of multi-value fields. Fixing this exposed the first issue listed below.&lt;/li&gt;
	&lt;li&gt;MultiSearchRequestHandler was creating non-daemon threads (the default) for the thread pool. This meant that when the JVM died, the threads were sticking around. I added a ThreadFactory that creates daemonized threads.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Open issues:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The &apos;local&apos; shard is ignoring the &apos;FL&apos; parameter during the FirstQueryPhase, and returning the entire document. We then try and merge the document into itself in SecondQPhaseComponent.merge, causing a ConcurrectMod exception. For now, I put a check for &quot;newDoc != oldDoc&quot;, but I think we need to figure out why the local query is returning full documents.&lt;/li&gt;
	&lt;li&gt;Range queries are broken (probably due to the extract terms phase failing)&lt;/li&gt;
	&lt;li&gt;&apos;start&apos; and &apos;numfound&apos; are incorrect when returned to the user
	&lt;ul&gt;
		&lt;li&gt;start is getting wiped out somewhere&lt;/li&gt;
		&lt;li&gt;numfound is counting all copies of matches for a uniqKey towards the total&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;MultiSearchRequestHandler.THREAD_POOL_SIZE and MultiSearchRequestHandler.REQUEST_TIME_OUT_IN_MS should be configuration parameters in solrconfig.xml.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="12531419" author="sharad" created="Mon, 1 Oct 2007 07:52:31 +0100"  >&lt;p&gt;Hi Stu, I have merged the issues fixed by you in my version of patch.&lt;/p&gt;

&lt;p&gt;Also the following changes:&lt;/p&gt;

&lt;p&gt;-&amp;gt;Based the solution on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt;. Got away with the MultiSearchRequestHandler base class. Now federated features are just pure components which can be plugged along with other regular components like QueryComponent, HighlightComponent etc.&lt;br/&gt;
This way it would be very easy to override the core federated functionality.&lt;/p&gt;

&lt;p&gt;-&amp;gt;Renamed the Federated components to :&lt;br/&gt;
GlobalCollectionStatComponent&lt;br/&gt;
MainQPhaseComponent&lt;br/&gt;
AuxiliaryQPhaseComponent&lt;/p&gt;

&lt;p&gt;-&amp;gt; Doing url encoding for the request params in XMLResponseParser&lt;/p&gt;


</comment>
                            <comment id="12531565" author="stuhood" created="Mon, 1 Oct 2007 18:01:06 +0100"  >&lt;blockquote&gt;
&lt;p&gt;-&amp;gt;Based the solution on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt;. Got away with the MultiSearchRequestHandler base class.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Does this mean that this patch requires &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt; to be applied first? Also, what revision should it be applied to, or will HEAD work?&lt;/p&gt;


&lt;blockquote&gt;
&lt;p&gt;-&amp;gt; Doing url encoding for the request params in XMLResponseParser&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ah yea, I ran into that one a few days ago as well. Additionally, I had XMLResponseParser strip the &quot;WT&quot; parameter off its queries: &apos;extractterms&apos; was passing through the user&apos;s wt, which caused the XML parsing to fail (obviously =) ).&lt;/p&gt;


&lt;p&gt;Can&apos;t wait to try it out... Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="12531997" author="sharad" created="Wed, 3 Oct 2007 05:27:49 +0100"  >&lt;p&gt;&amp;gt;&amp;gt; Does this mean that this patch requires &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt; to be applied first?&lt;br/&gt;
No. Current patch has all files. When &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt; gets in to the trunk then this patch needs to be reworked.&lt;/p&gt;</comment>
                            <comment id="12534213" author="stuhood" created="Fri, 12 Oct 2007 05:06:34 +0100"  >&lt;p&gt;I really like where you are headed with the &apos;componentized&apos; version of the patch: it much more elegant.&lt;/p&gt;

&lt;p&gt;But: I&apos;m still having the problem where multi-valued fields only get one value returned. During AuxiliaryQPhaseComponent.merge(SolrQueryResponse rsp, SolrQueryResponse auxPhaseRes), you check whether the field already exists before adding it, but multi-value fields can exist multiple times.&lt;/p&gt;

&lt;p&gt;Also, I&apos;m considering disabling the AuxiliaryQPhase and just letting the MainQPhase fetch the document fields. All of my documents are small ( &amp;lt; 1k on average with 10ish fields), so I think making another call across the network to fetch the remaining fields is probably a waste for our indexes. What do you think?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12534268" author="sharad" created="Fri, 12 Oct 2007 11:48:26 +0100"  >&lt;p&gt;&amp;gt;&amp;gt;But: I&apos;m still having the problem where multi-valued fields only get one value returned. During AuxiliaryQPhaseComponent.merge(SolrQueryResponse rsp, SolrQueryResponse auxPhaseRes), you check whether the field already exists before adding it, but multi-value fields can exist multiple times.&lt;/p&gt;

&lt;p&gt;yeah, may be I have missed those scenarios. If you have the fix, pl feel free to update the patch.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;Also, I&apos;m considering disabling the AuxiliaryQPhase and just letting the MainQPhase fetch the document fields. All of my documents are small ( &amp;lt; 1k on average with 10ish fields), so I think making another call across the network to fetch the remaining fields is probably a waste for our indexes. What do you think?&lt;br/&gt;
Having AuxiliaryQPhase saves primarily on following counts:-&lt;br/&gt;
1) fetching doc fields &lt;br/&gt;
2) generating snippets &lt;br/&gt;
3) more like this query etc&lt;br/&gt;
-&amp;gt; for only the merged docs.&lt;/p&gt;

&lt;p&gt;From my experience generating snippets is very CPU intensive and if the no of shards are large, there would be lot of CPU wastage (if snippets are generated in MainQPhase) =&amp;gt; CPU wastage proportional to (n-1)/n  =&amp;gt; n being no of shards&lt;br/&gt;
So, having extra network calls saves on CPU. Hence there being trade-off between two.&lt;/p&gt;</comment>
                            <comment id="12534731" author="stuhood" created="Mon, 15 Oct 2007 05:44:55 +0100"  >&lt;blockquote&gt;
&lt;p&gt;yeah, may be I have missed those scenarios. If you have the fix, pl feel free to update the patch.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Unfortunately, my fix was more of a workaround: I allow any field that is not the unique key to be added multiple times. But, the local shard always returns all the fields  of the document, so if the local shard is queried directly, some fields are duplicated. And so I don&apos;t query the local shard directly =/&lt;/p&gt;</comment>
                            <comment id="12536064" author="stuhood" created="Thu, 18 Oct 2007 22:55:56 +0100"  >&lt;p&gt;I&apos;m still working on wrapping my head around the fedsearch phases, but I noticed the following stacktrace showing up in the logs every now and then:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SEVERE: java.lang.NullPointerException
        at org.apache.solr.handler.federated.component.GlobalCollectionStatComponent.prepare(GlobalCollectionStatComponent.java:81)
        at org.apache.solr.handler.SearchHandler.handleRequestBody(SearchHandler.java:116)
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:78)
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:807)
        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:206)
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:174)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:175)
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:128)
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:263)
        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:844)
        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:584)
        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:447)
        at java.lang.Thread.run(Thread.java:619)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... that is probably caused by the following statements around line 81 in GlobalCollectionStatComponent.prepare. We only enter the if statement if terms is null, and then we dereference it...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; terms = req.getParams().get(ResponseBuilder.DOCFREQS);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (numDocs != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; terms == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-comment&quot;&gt;// the build query has to be over-written to take into
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;//account global numDocs and docFreqs
&lt;/span&gt;
      &lt;span class=&quot;code-comment&quot;&gt;//extract the numDocs and docFreqs from request params
&lt;/span&gt;      Map&amp;lt;Term, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; dfMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;Term, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;();
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] strTerms = terms.split(&lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12543551" author="dalals" created="Mon, 19 Nov 2007 13:08:19 +0000"  >&lt;p&gt;I have updated the patch to remove the code pertaining to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt;, because 281 has been committed.&lt;/p&gt;</comment>
                            <comment id="12543553" author="dalals" created="Mon, 19 Nov 2007 13:10:46 +0000"  >&lt;p&gt;I mean i removed the files pertaining to 281. If you follow the development above, the files pertaining to 281 were added to this patch to make it easier to apply this patch.&lt;/p&gt;</comment>
                            <comment id="12543774" author="yseeley@gmail.com" created="Tue, 20 Nov 2007 04:57:24 +0000"  >&lt;p&gt;I&apos;m really just starting to dig into this again, but here are a couple of thoughts:&lt;/p&gt;

&lt;p&gt;It looks like there is a monolithic main federated query component that does all the work... It would be nice if there were a way to turn this around so that a user could write a query component that could participate in a distributed search call.  It seems like query info should be able to be gathered from multiple components and then a single request to a shard could be made.  This entails multiple methods on QueryComponent for use in a distributed request.&lt;/p&gt;

&lt;p&gt;Another observation is that the number of &quot;phases&quot; may be unpredictable.  For example when faceting, if one wants &quot;exact&quot; results, more information may be required from certain nodes.  This means that components need a way to say if they are done or not, and a way to send different requests to different shards.  Then when responses are received, it should be possible to optionally handle them one-by-one as they come in, or alternately all at once to merge the results.&lt;/p&gt;
</comment>
                            <comment id="12543931" author="hossman" created="Tue, 20 Nov 2007 16:16:19 +0000"  >&lt;p&gt;Note: there has been discussion recently about the terminology distinction between &quot;federated search&quot; and &quot;distributed search&quot; (which ken recently updated on the wiki) ... this issue is tracking &quot;distributed search&quot; and not &quot;federated search&quot; correct?&lt;/p&gt;

&lt;p&gt;if so, the issue summary should be updated&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/solr/FederatedSearch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/FederatedSearch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://wiki.apache.org/solr/DistributedSearch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/DistributedSearch&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="12543936" author="yseeley@gmail.com" created="Tue, 20 Nov 2007 16:31:10 +0000"  >&lt;p&gt;Original description by Sharad, moved to this comment because a JIRA &quot;Description&quot; is sent to the email list &lt;b&gt;every time&lt;/b&gt; there is an update to the issue.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Motivated by &lt;a href=&quot;http://wiki.apache.org/solr/DistributedSearch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/DistributedSearch&lt;/a&gt;&lt;br/&gt;
&quot;Index view consistency between multiple requests&quot; requirement is relaxed in this implementation.&lt;/p&gt;

&lt;p&gt;Does the federated search query side. Update not yet done.&lt;/p&gt;

&lt;p&gt;Tries to achieve:-&lt;br/&gt;
------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The client applications are totally agnostic to federated search. The federated search and merging of results are totally behind the scene in Solr in request handler . Response format remains the same after merging of results.&lt;br/&gt;
The response from individual shard is deserialized into SolrQueryResponse object. The collection of SolrQueryResponse objects are merged to produce a single SolrQueryResponse object. This enables to use the Response writers as it is; or with minimal change.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Efficient query processing with highlighting and fields getting generated only for merged documents. The query is executed in 2 phases. First phase gets the doc unique keys with sort criteria. Second phase brings all requested fields and highlighting information. This saves lot of CPU in case there are good number of shards and highlighting info is requested.&lt;br/&gt;
Should be easy to customize the query execution. For example: user can specify to execute query in just 1 phase itself. (For some queries when highlighting info is not required and number of fields requested are small; this can be more efficient.)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ability to easily overwrite the default Federated capability by appropriate plugins and request parameters. As federated search is performed by the RequestHandler itself, multiple request handlers can easily be pre-configured with different federated search settings in solrconfig.xml&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Global weight calculation is done by querying the terms&apos; doc frequencies from all shards.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Federated search works on Http transport. So individual shard&apos;s VIP can be queried. Load-balancing and Fail-over taken care by VIP as usual.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-Sub-searcher response parsing as a plugin interface. Different implementation could be written based on JSON, xml SAX etc. Current one based on XML DOM.&lt;/p&gt;


&lt;p&gt;HOW:&lt;br/&gt;
-------&lt;br/&gt;
A new RequestHandler called MultiSearchRequestHandler does the federated search on multiple sub-searchers, (referred as &quot;shards&quot; going forward). It extends the RequestHandlerBase. handleRequestBody method in RequestHandlerBase has been divided into query building and execute methods. This has been done to calculate global numDocs and docFreqs; and execute the query efficiently on multiple shards.&lt;br/&gt;
All the &quot;search&quot; request handlers are expected to extend MultiSearchRequestHandler class in order to enable federated capability for the handler. StandardRequestHandler and DisMaxRequestHandler have been changed to extend this class.&lt;/p&gt;

&lt;p&gt;The federated search kicks in if &quot;shards&quot; is present in the request parameter. Otherwise search is performed as usual on the local index. eg. shards=local,host1:port1,host2:port2 will search on the local index and 2 remote indexes. The search response from all 3 shards are merged and serviced back to the client. &lt;/p&gt;

&lt;p&gt;The search request processing on the set of shards is performed as follows:&lt;/p&gt;

&lt;p&gt;STEP 1: The query is built, terms are extracted. Global numDocs and docFreqs are calculated by requesting all the shards and adding up numDocs and docFreqs from each shard.&lt;/p&gt;

&lt;p&gt;STEP 2: (FirstQueryPhase) All shards are queried. Global numDocs and docFreqs are passed as request parameters. All document fields are NOT requested, only document uniqFields and sort fields are requested. MoreLikeThis and Highlighting information are NOT requested.&lt;/p&gt;

&lt;p&gt;STEP 3: Responses from FirstQueryPhase are merged based on &quot;sort&quot;, &quot;start&quot; and &quot;rows&quot; params. Merged doc uniqField and sort fields are collected. Other information like facet and debug is also merged.&lt;/p&gt;

&lt;p&gt;STEP 4: (SecondQueryPhase) Merged doc uniqFields and sort fields are grouped based on shards. All shards in the grouping are queried for the merged doc uniqFields (from FirstQueryPhase), highlighting and moreLikeThis info.&lt;/p&gt;

&lt;p&gt;STEP 5: Responses from all shards from SecondQueryPhase are merged.&lt;/p&gt;

&lt;p&gt;STEP 6: Document fields , highlighting and moreLikeThis info from SecondQueryPhase are merged into FirstQueryPhase response.&lt;/p&gt;




&lt;p&gt;TODO:&lt;br/&gt;
-Support sort field other than default score&lt;br/&gt;
-Support ResponseDocs in writers other than XMLWriter&lt;br/&gt;
-Http connection timeouts&lt;/p&gt;

&lt;p&gt;OPEN ISSUES;&lt;br/&gt;
-Merging of facets by &quot;top n terms of field f&quot; &lt;/p&gt;

&lt;p&gt;Scope for Performance optimization:-&lt;br/&gt;
-Search shards in parallel threads&lt;br/&gt;
-Http connection Keep-Alive ?&lt;br/&gt;
-Cache global numDocs and docFreqs&lt;br/&gt;
-Cache Query objects in handlers ??&lt;/p&gt;

&lt;p&gt;Would appreciate feedback on my approach. I understand that there would be lot things I might have over-looked. &lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="12544684" author="sunrise1984" created="Thu, 22 Nov 2007 03:21:56 +0000"  >&lt;p&gt;to Sabyasachi Dalal:&lt;br/&gt;
I update solr trunk to version 597284. And I patch it cleanly.But it does&apos;t work,just like it doesn&apos;t support distributed search.&lt;br/&gt;
Alternately,it works when I used Sharad Agarwal &apos;s patch.I don&apos;t know what&apos;s wrong, or maybe you change anything?&lt;/p&gt;</comment>
                            <comment id="12545143" author="dalals" created="Sat, 24 Nov 2007 02:00:02 +0000"  >&lt;p&gt;Can you please some more details about the error ? Are you seeing&lt;br/&gt;
any exceptions ? How are your partitions set up and what is the&lt;br/&gt;
request you are sending ?&lt;/p&gt;</comment>
                            <comment id="12545154" author="yseeley@gmail.com" created="Sat, 24 Nov 2007 04:16:07 +0000"  >&lt;p&gt;It doesn&apos;t seem like there is any request handler set up that references the distributed search components.&lt;/p&gt;</comment>
                            <comment id="12548032" author="yseeley@gmail.com" created="Mon, 3 Dec 2007 22:58:02 +0000"  >&lt;p&gt;I&apos;ve been prototyping distributed search in python...&lt;br/&gt;
The current methods I have for a component are something like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-comment&quot;&gt;// returns the current stage &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; component is at... stage starts at -1 and the next stage is the minimum returned
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// by all components on the previous calls to process()
&lt;/span&gt;  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; process(RequestBuilder rb, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; stage);

   &lt;span class=&quot;code-comment&quot;&gt;// callback &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a single response received (optional... &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; could be left out)
&lt;/span&gt;   &lt;span class=&quot;code-comment&quot;&gt;// all components have &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; called, regardless of who queued the request
&lt;/span&gt;   void singleResponse(ResponseBuilder rb, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; stage, Request req, Response rsp);

   &lt;span class=&quot;code-comment&quot;&gt;// callback when all responses (from all shards) to a request have been received
&lt;/span&gt;   void allResponses(ResponseBuilder rb, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; stage, Request req);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Any of these methods can add another request to the outgoing queue.  The current stage is only over after all&lt;br/&gt;
requests have been sent, responses received, and the outgoing queue is empty.&lt;br/&gt;
When all components return maxint from process(), we are done.&lt;/p&gt;</comment>
                            <comment id="12548044" author="ryantxu" created="Mon, 3 Dec 2007 23:22:04 +0000"  >&lt;p&gt;Are you suggesting changing the main control loop from:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;( SearchComponent c : components ) {
        c.process( req, rsp );
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to something that knows &quot;stages&quot;? &lt;/p&gt;

&lt;p&gt;Or are you discussing something that would happen within a single &apos;c.process( req, rsp );?&lt;/p&gt;</comment>
                            <comment id="12549573" author="yseeley@gmail.com" created="Fri, 7 Dec 2007 22:04:05 +0000"  >&lt;p&gt;Yes, I&apos;m suggesting changing the main control loop.&lt;br/&gt;
Normal non-distributed requests don&apos;t necessarily need stages (but could be added to be more consistent with the distributed methods... with stages, I don&apos;t think there would be a &quot;prepare&quot; method).&lt;br/&gt;
Right now, my private copy of SearchComponent looks like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; class SearchComponent &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; SolrInfoMBean
{
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; void prepare( SolrQueryRequest req, SolrQueryResponse rsp ) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, ParseException;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; void process( SolrQueryRequest req, SolrQueryResponse rsp ) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; distributedProcess(ResponseBuilder rb) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ResponseBuilder.STAGE_END;
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleResponses(ResponseBuilder rb, ShardRequest sreq) {
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12549970" author="dalals" created="Mon, 10 Dec 2007 08:54:35 +0000"  >&lt;p&gt;I fixed the issue with the patch and it works with version 594268. &lt;br/&gt;
Now, i am trying to make it work with the latest trunk.  I am facing a problem. The  FedSearchComponent needs a handle to the &quot;handler&quot; in order to execute on the local shard. I am trying to figure out how to pass the handler during component initialization.&lt;/p&gt;</comment>
                            <comment id="12550896" author="dalals" created="Wed, 12 Dec 2007 10:03:48 +0000"  >&lt;p&gt;I made a mistake and uploaded the wrong patch file. Now uploading the correct file.&lt;/p&gt;

&lt;p&gt;I have fixed and updated the patch with trunk version 600419. It is integrated with the re-opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-281&quot; title=&quot;Search Components (plugins)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-281&quot;&gt;&lt;del&gt;SOLR-281&lt;/del&gt;&lt;/a&gt; patch.&lt;br/&gt;
I have added the configuration for the three distributed-search components in the solrconfig.xml, under &quot;/search&quot; request handler. So, the distributed search works with /search request only.&lt;/p&gt;

&lt;p&gt;Couple of issues :&lt;br/&gt;
1. The dist search components need the reference to the SearchHandler. So for now , i have hard coded the &quot;/search&quot; pattern in the FedSearchComponent.&lt;br/&gt;
2. Need a clean way to load common init params for the dist search components, such as timeout, thread pool size and search handler pattern.&lt;/p&gt;</comment>
                            <comment id="12551225" author="dalals" created="Thu, 13 Dec 2007 06:02:15 +0000"  >&lt;p&gt;Removed the commented line from SolrCore.loadSearchComponents and couple of debug statements.&lt;/p&gt;</comment>
                            <comment id="12551457" author="gereon" created="Thu, 13 Dec 2007 10:20:29 +0000"  >&lt;p&gt;I started experimenting with this patch and have a couple of issues.&lt;/p&gt;

&lt;p&gt;First, the patch did not apply cleanly to the latest trunk (603869), so I reverted to 600419 - no big deal.&lt;/p&gt;

&lt;p&gt;I then set up two separate tomcat/solr instances using identical schemas (on ports 8080 and 8090) and tried querying both using solr/search requests and can&apos;t any of my queries to work.&lt;/p&gt;

&lt;p&gt;For example, there is a document with field &quot;id&quot; = 1527426 in the database on port 8090. &quot;id&quot; is defined as a &quot;sint&quot; field. The 8080 instance has no such id.&lt;br/&gt;
When querying &quot;http://localhost/8080/solr/search?q=id:1527426&amp;amp;shards=local,localhost:8090/solr&quot;, I get the following in the tomcat logs:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;catalina.out on the 8080 instance:

Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.component.ResponseBuilder &amp;lt;init&amp;gt;
INFO: ### *** shards len 2
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent extractTerms
INFO: --------Extract terms starting----------- :
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent extractTerms
INFO: ### *** is shards null false
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent extractTerms
INFO: ### *** SHARDS len 2
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.XMLResponseParser parse
INFO: -&amp;gt;Request http://localhost:8090/solr/select?q=id%3A1527426&amp;amp;shards=local%2Clocalhost%3A8090%2Fsolr&amp;amp;eqt=true&amp;amp;
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent execute
WARNING: Exception while querying shard localhost:8090/solr :java.lang.NullPointerException
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent calcuateGlobalCollectionStat
INFO: --------getGlobalCollectionStat starting----------- :
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.XMLResponseParser parse
INFO: -&amp;gt;Request http://localhost:8090/solr/federated/collectionstats?terms=id%3A%C2%80%C5%B4%E0%BA%82%2C&amp;amp;
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values nd : java.lang.Integer
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values tdf : org.apache.solr.common.util.NamedList
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.MainQPhaseComponent process
INFO: --------MainQPhaseComponent starting----------- :
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.FedSearchComponent executeOnLocal
INFO: -&amp;gt;Local request params: {fl=id,score,,q=id:1527426,nd=74621,tdf=id:&#372;&#3714;@1,,fsv=true}
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.search.DocSlice
Dec 13, 2007 10:55:04 AM org.apache.solr.core.SolrCore execute
INFO: null nd=74621&amp;amp;fsv=true&amp;amp;tdf=id:&#372;&#3714;@1,&amp;amp;q=id:1527426&amp;amp;fl=id,score, 0 1
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.XMLResponseParser parse
INFO: -&amp;gt;Request http://localhost:8090/solr/select?fl=id%2Cscore%2C&amp;amp;q=id%3A1527426&amp;amp;nd=74621&amp;amp;tdf=id%3A%C2%80%C5%B4%E0%BA%82%401%2C&amp;amp;fsv=true&amp;amp;
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.MainQPhaseComponent process
WARNING: Exception while querying shard localhost:8090/solr :java.lang.ClassCastException: java.lang.Integer
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.handler.federated.ResponseDocs
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.handler.federated.ResponseDocs
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.federated.component.AuxiliaryQPhaseComponent process
INFO: --------AuxiliaryQPhaseComponent starting----------- :
Dec 13, 2007 10:55:04 AM org.apache.solr.core.SolrCore execute
INFO: /search q=id:1527426&amp;amp;shards=local,localhost:8090/solr 0 60
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;catalina.out on the 8090 instance

Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 10:55:04 AM org.apache.solr.handler.component.ResponseBuilder &amp;lt;init&amp;gt;
INFO: ### *** shards len 2
Dec 13, 2007 10:55:04 AM org.apache.solr.core.SolrCore execute
INFO: /select q=id:1527426&amp;amp;eqt=true&amp;amp;shards=local,localhost:8090/solr 0 3
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values nd : java.lang.Integer
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values tdf : org.apache.solr.common.util.NamedList
Dec 13, 2007 10:55:04 AM org.apache.solr.core.SolrCore execute
INFO: /federated/collectionstats terms=id:&#372;&#3714;, 0 3
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 10:55:04 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.search.DocSlice
Dec 13, 2007 10:55:04 AM org.apache.solr.core.SolrCore execute
INFO: /select nd=74621&amp;amp;fsv=true&amp;amp;fl=id,score,&amp;amp;q=id:1527426&amp;amp;tdf=id:&#372;&#3714;@1, 0 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the request does reach the 8090 instance, but triggers a CastException on the 8080 instance. The XML output is&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;response&amp;gt;
&amp;lt;lst name=&quot;responseHeader&quot;&amp;gt;
  &amp;lt;int name=&quot;status&quot;&amp;gt;0&amp;lt;/int&amp;gt;
  &amp;lt;int name=&quot;QTime&quot;&amp;gt;135&amp;lt;/int&amp;gt;
  &amp;lt;lst name=&quot;params&quot;&amp;gt;
    &amp;lt;str name=&quot;q&quot;&amp;gt;id:1527426&amp;lt;/str&amp;gt;
    &amp;lt;str name=&quot;shards&quot;&amp;gt;local,localhost:8090/solr&amp;lt;/str&amp;gt;
  &amp;lt;/lst&amp;gt;
&amp;lt;/lst&amp;gt;
&amp;lt;result name=&quot;response&quot; numFound=&quot;0&quot; start=&quot;0&quot;/&amp;gt;
  &amp;lt;lst name=&quot;responseHeader&quot;&amp;gt;
    &amp;lt;lst name=&quot;local&quot;&amp;gt;
      &amp;lt;int name=&quot;status&quot;&amp;gt;0&amp;lt;/int&amp;gt;
      &amp;lt;int name=&quot;QTime&quot;&amp;gt;4&amp;lt;/int&amp;gt;
      &amp;lt;lst name=&quot;params&quot;&amp;gt;
      &amp;lt;str name=&quot;nd&quot;&amp;gt;74621&amp;lt;/str&amp;gt;
      &amp;lt;str name=&quot;fsv&quot;&amp;gt;true&amp;lt;/str&amp;gt;
      &amp;lt;str name=&quot;tdf&quot;&amp;gt;id:&#128;&#372;&#3714;@1,&amp;lt;/str&amp;gt;
      &amp;lt;str name=&quot;q&quot;&amp;gt;id:1527426&amp;lt;/str&amp;gt;
      &amp;lt;str name=&quot;fl&quot;&amp;gt;id,score,&amp;lt;/str&amp;gt;
    &amp;lt;/lst&amp;gt;
  &amp;lt;/lst&amp;gt;
&amp;lt;/lst&amp;gt;
&amp;lt;/response&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &quot;reverse&quot; request for &quot;http://localhost:8090/solr/search?q=id:1527426&amp;amp;shards=local,localhost:8080/solr&quot; produces an HTTP Status 500 - null java.lang.NullPointerException response, the logs are:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;catalina.out on the 8080 instance

Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.component.ResponseBuilder &amp;lt;init&amp;gt;
INFO: ### *** shards len 2
Dec 13, 2007 11:07:33 AM org.apache.solr.core.SolrCore execute
INFO: /select q=id:1527426&amp;amp;eqt=true&amp;amp;shards=local,localhost:8080/solr 0 2
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values nd : java.lang.Integer
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values tdf : org.apache.solr.common.util.NamedList
Dec 13, 2007 11:07:33 AM org.apache.solr.core.SolrCore execute
INFO: /federated/collectionstats terms=id:&#372;&#3714;, 0 5
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.search.DocSlice
Dec 13, 2007 11:07:33 AM org.apache.solr.core.SolrCore execute
INFO: /select nd=74621&amp;amp;fsv=true&amp;amp;fl=id,score,&amp;amp;q=id:1527426&amp;amp;tdf=id:&#372;&#3714;@1, 0 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;catalina.out on the 8090 instance

Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.component.ResponseBuilder &amp;lt;init&amp;gt;
INFO: ### *** shards len 2
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent extractTerms
INFO: --------Extract terms starting----------- :
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent extractTerms
INFO: ### *** is shards null false
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent extractTerms
INFO: ### *** SHARDS len 2
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.XMLResponseParser parse
INFO: -&amp;gt;Request http://localhost:8080/solr/select?q=id%3A1527426&amp;amp;shards=local%2Clocalhost%3A8080%2Fsolr&amp;amp;eqt=true&amp;amp;
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent execute
WARNING: Exception while querying shard localhost:8080/solr :java.lang.NullPointerException
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.GlobalCollectionStatComponent calcuateGlobalCollectionStat
INFO: --------getGlobalCollectionStat starting----------- :
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.XMLResponseParser parse
INFO: -&amp;gt;Request http://localhost:8080/solr/federated/collectionstats?terms=id%3A%C2%80%C5%B4%E0%BA%82%2C&amp;amp;
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values nd : java.lang.Integer
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values tdf : org.apache.solr.common.util.NamedList
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.MainQPhaseComponent process
INFO: --------MainQPhaseComponent starting----------- :
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.XMLResponseParser parse
INFO: -&amp;gt;Request http://localhost:8080/solr/select?fl=id%2Cscore%2C&amp;amp;q=id%3A1527426&amp;amp;nd=74621&amp;amp;tdf=id%3A%C2%80%C5%B4%E0%BA%82%401%2C&amp;amp;fsv=true&amp;amp;
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.FedSearchComponent executeOnLocal
INFO: -&amp;gt;Local request params: {fl=id,score,,q=id:1527426,nd=74621,tdf=id:&#372;&#3714;@1,,fsv=true}
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.search.DocSlice
Dec 13, 2007 11:07:33 AM org.apache.solr.core.SolrCore execute
INFO: null nd=74621&amp;amp;fsv=true&amp;amp;tdf=id:&#372;&#3714;@1,&amp;amp;q=id:1527426&amp;amp;fl=id,score, 0 4
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.handler.federated.ResponseDocs
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.handler.federated.ResponseDocs
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values response : org.apache.solr.handler.federated.ResponseDocs
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.NamedList
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.AuxiliaryQPhaseComponent process
INFO: --------AuxiliaryQPhaseComponent starting----------- :
Dec 13, 2007 11:07:33 AM org.apache.solr.handler.federated.component.FedSearchComponent executeOnLocal
INFO: -&amp;gt;Local request params: {dq=id:&quot;&#372;&#3714;&quot; ,q=id:1527426}
Dec 13, 2007 11:07:33 AM org.apache.solr.request.SolrQueryResponse add
INFO: adding into values responseHeader : org.apache.solr.common.util.SimpleOrderedMap
Dec 13, 2007 11:07:33 AM org.apache.solr.common.SolrException log
SEVERE: java.lang.NumberFormatException: For input string: &quot;&#372;&#3714;&quot;
        at java.lang.NumberFormatException.forInputString(NumberFormatException.java:48)
        at java.lang.Integer.parseInt(Integer.java:447)
        at java.lang.Integer.parseInt(Integer.java:497)
        at org.apache.solr.util.NumberUtils.int2sortableStr(NumberUtils.java:36)
        at org.apache.solr.schema.SortableIntField.toInternal(SortableIntField.java:52)
        at org.apache.solr.schema.FieldType$DefaultAnalyzer$1.next(FieldType.java:315)
        at org.apache.lucene.queryParser.QueryParser.getFieldQuery(QueryParser.java:437)
        at org.apache.solr.search.SolrQueryParser.getFieldQuery(SolrQueryParser.java:97)
        at org.apache.lucene.queryParser.QueryParser.getFieldQuery(QueryParser.java:515)
        at org.apache.lucene.queryParser.QueryParser.Term(QueryParser.java:1227)
        at org.apache.lucene.queryParser.QueryParser.Clause(QueryParser.java:979)
        at org.apache.lucene.queryParser.QueryParser.Query(QueryParser.java:907)
        at org.apache.lucene.queryParser.QueryParser.TopLevelQuery(QueryParser.java:896)
        at org.apache.lucene.queryParser.QueryParser.parse(QueryParser.java:146)
        at org.apache.solr.search.QueryParsing.parseQuery(QueryParsing.java:101)
        at org.apache.solr.handler.federated.component.AuxiliaryQPhaseComponent.prepare(AuxiliaryQPhaseComponent.java:71)
        at org.apache.solr.handler.SearchHandler.handleRequestBody(SearchHandler.java:152)
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:117)
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:866)
        at org.apache.solr.handler.federated.component.FedSearchComponent.executeOnLocal(FedSearchComponent.java:87)
        at org.apache.solr.handler.federated.component.AuxiliaryQPhaseComponent$1.call(AuxiliaryQPhaseComponent.java:115)
        at org.apache.solr.handler.federated.component.AuxiliaryQPhaseComponent$1.call(AuxiliaryQPhaseComponent.java:114)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:269)
        at java.util.concurrent.FutureTask.run(FutureTask.java:123)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:417)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:269)
        at java.util.concurrent.FutureTask.run(FutureTask.java:123)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:65)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:168)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)
        at java.lang.Thread.run(Thread.java:595)

Dec 13, 2007 11:07:33 AM org.apache.solr.core.SolrCore execute
INFO: null q=id:1527426&amp;amp;dq=id:&quot;&#372;&#3714;&quot;+ 0 2
Dec 13, 2007 11:07:33 AM org.apache.solr.common.SolrException log
SEVERE: java.lang.NullPointerException
        at org.apache.solr.handler.federated.SearchResponseMerger.mergeResponseDocs_NoSort(SearchResponseMerger.java:215)
        at org.apache.solr.handler.federated.SearchResponseMerger.merge(SearchResponseMerger.java:83)
        at org.apache.solr.handler.federated.component.AuxiliaryQPhaseComponent.process(AuxiliaryQPhaseComponent.java:156)
        at org.apache.solr.handler.SearchHandler.handleRequestBody(SearchHandler.java:158)
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:117)
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:866)
        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:206)
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:174)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:215)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:188)
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:210)
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:174)
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:117)
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:108)
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:151)
        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:870)
        at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:665)
        at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:528)
        at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:81)
        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:685)
        at java.lang.Thread.run(Thread.java:595)

Dec 13, 2007 11:07:33 AM org.apache.solr.core.SolrCore execute
INFO: /search q=id:1527426&amp;amp;shards=local,localhost:8080/solr 0 95
Dec 13, 2007 11:07:33 AM org.apache.solr.common.SolrException log
SEVERE: java.lang.NullPointerException
        at org.apache.solr.handler.federated.SearchResponseMerger.mergeResponseDocs_NoSort(SearchResponseMerger.java:215)
        at org.apache.solr.handler.federated.SearchResponseMerger.merge(SearchResponseMerger.java:83)
        at org.apache.solr.handler.federated.component.AuxiliaryQPhaseComponent.process(AuxiliaryQPhaseComponent.java:156)
        at org.apache.solr.handler.SearchHandler.handleRequestBody(SearchHandler.java:158)
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:117)
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:866)
        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:206)
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:174)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:215)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:188)
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:210)
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:174)
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:117)
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:108)
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:151)
        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:870)
        at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:665)
        at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:528)
        at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:81)
        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:685)
        at java.lang.Thread.run(Thread.java:595)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="12551514" author="yseeley@gmail.com" created="Thu, 13 Dec 2007 14:22:20 +0000"  >&lt;p&gt;Bear with me... I&apos;m working on this from a bit of a different angle.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;multiple stages, defined by components themselves, and a stage doesn&apos;t end until an outgoing request queue is empty.&lt;/li&gt;
	&lt;li&gt;making components responsible for turning on/off their own options in the query phases, rather than having the distributed search component have to know all the different options.&lt;/li&gt;
	&lt;li&gt;using SolrJ/HttpClient for communication&lt;/li&gt;
	&lt;li&gt;organizational: moved SearchHandler into the component package, along with distributed search stuff.  It&apos;s all related and allows us to keep things private that should be kept private.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I understand the original author is no longer involved with this issue, so I&apos;m basing things on his code in some places, but not others.  Hopefully I&apos;ll have something &lt;/p&gt;</comment>
                            <comment id="12553838" author="stuhood" created="Fri, 21 Dec 2007 01:08:45 +0000"  >&lt;p&gt;I recognize the advantage of the AuxiliaryQPhase, but I&apos;m not quite sure about GlobalCollectionStat. Is its purpose just to normalize weights from the shards?&lt;/p&gt;

&lt;p&gt;I had to make some changes to the MainQPhase parameter building, and to the PriorityQueue that SearchResponseMerger uses to get sorting working properly. Yonik, if you aren&apos;t planning on re-writing those from scratch, would you prefer a patch, or an explanation of what I needed to change?&lt;/p&gt;</comment>
                            <comment id="12553841" author="yseeley@gmail.com" created="Fri, 21 Dec 2007 01:42:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not quite sure about GlobalCollectionStat. Is its purpose just to normalize weights from the shards?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s to make a distributed search score the same as it would if everything was in a single index.&lt;br/&gt;
idf (inverse document frequency) is part of the scoring, so that component essentially does a distributed idf.&lt;/p&gt;

&lt;p&gt;I still use the PriorityQueue, but it&apos;s been modified since SolrJ returns objects rather than strings.&lt;br/&gt;
I&apos;ll try to post a draft soon... if you understood the old code, it will be great for you to look at the new stuff to see what I&apos;m missing.&lt;/p&gt;</comment>
                            <comment id="12554145" author="yseeley@gmail.com" created="Sat, 22 Dec 2007 19:07:53 +0000"  >&lt;p&gt;OK, here is a &lt;b&gt;draft&lt;/b&gt; that mostly works for searches and highlighting.&lt;/p&gt;

&lt;p&gt;There are stages in the request:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_START           = 0;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_PARSE_QUERY     = 1000;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_EXECUTE_QUERY   = 2000;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_GET_FIELDS      = 3000;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_DONE            = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When a component wants to send a request, it adds it to &quot;outgoing&quot; queue.&lt;br/&gt;
Other components can inspect and modify these shard requests.&lt;br/&gt;
All components get a callback when the shard response is received.&lt;/p&gt;

&lt;p&gt;All shard responses purposes (to aid in both correlation and inspection/modification by other components).&lt;br/&gt;
This is what a ShardRequest looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class ShardRequest {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] ALL_SHARDS = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_PRIVATE         = 0x01;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_GET_TERM_DFS    = 0x02;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_GET_TOP_IDS     = 0x04;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_REFINE_TOP_IDS  = 0x08;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_GET_FACETS      = 0x10;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_REFINE_FACETS   = 0x20;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_GET_FIELDS      = 0x40;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PURPOSE_GET_HIGHLIGHTS  = 0x80;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; purpose;  &lt;span class=&quot;code-comment&quot;&gt;// the purpose of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; request
&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] shards;  &lt;span class=&quot;code-comment&quot;&gt;// the shards &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; request should be sent to
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// TODO: how to request a specific shard address?
&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ModifiableSolrParams params;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;ShardResponse&amp;gt; responses = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;ShardResponse&amp;gt;();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Components are responsible for themselves... the highlighting component is responsible for turning itself on/off at the appropriate time... the query component has no knowledge of the highlight component.  This will make it so that custom components can be developed that can work in a distributed environment w/o explicit support for that component baked into the other components.&lt;/p&gt;
</comment>
                            <comment id="12554322" author="yseeley@gmail.com" created="Tue, 25 Dec 2007 04:40:54 +0000"  >&lt;p&gt;attaching updated patch (distributed.patch) that fixes some sorting issues.&lt;/p&gt;</comment>
                            <comment id="12554446" author="stuhood" created="Wed, 26 Dec 2007 18:19:24 +0000"  >&lt;p&gt;Thanks for the new patch Yonik! It doesn&apos;t apply cleanly because of the way you generated the test files, but after those have been removed, it looks good. It seems you figured out the sorting issue that I had mentioned: thanks.&lt;/p&gt;</comment>
                            <comment id="12554513" author="ryantxu" created="Thu, 27 Dec 2007 03:57:50 +0000"  >&lt;p&gt;I just took a quick look...  a few observations:&lt;/p&gt;

&lt;p&gt;We should extract out a few simple things and commit them quickly to make this go more smoothly:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;move SearchHandler to o.a.s.handler.component &amp;#8211; I vote you go ahead and commit that change.&lt;/li&gt;
	&lt;li&gt;Create a separate issue for adding SolrDocument to XMLWriter&lt;/li&gt;
	&lt;li&gt;Move solrj into the main source tree.  I&apos;m not sure the best way to do this, but I don&apos;t think solrj should sit in its own source folder if the core depends on it.&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;Is there a good reason to use the same handler for distributed search?  Why not have a DistributedSearchHandler that extends SearchHandler and skip the if {} else {} checking?  Likewise, I wonder if a DistributedResponseBuilder could/should extend ResponseBuilding and add the necessary logic.&lt;/p&gt;
</comment>
                            <comment id="12554519" author="yseeley@gmail.com" created="Thu, 27 Dec 2007 04:43:53 +0000"  >&lt;p&gt;{quote}}We should extract out a few simple things and commit them quickly to make this go more smoothly:&lt;/p&gt;

&lt;p&gt;   1. move SearchHandler to o.a.s.handler.component - I vote you go ahead and commit that change.&lt;br/&gt;
   2. Create a separate issue for adding SolrDocument to XMLWriter&lt;br/&gt;
   3. Move solrj into the main source tree. I&apos;m not sure the best way to do this, but I don&apos;t think solrj should sit in its own source folder if the core depends on it.&lt;br/&gt;
&lt;blockquote&gt;

&lt;p&gt;Definitely agree on #1 and #2.&lt;br/&gt;
For #3, are there SolrJ parts (or future parts) that we wouldn&apos;t want automatically bundled with Solr?&lt;/p&gt;
&lt;/blockquote&gt;Is there a good reason to use the same handler for distributed search?&lt;blockquote&gt;&lt;/blockquote&gt;&lt;/p&gt;

&lt;p&gt;It seems like a single search component should be able to handle distributed search.&lt;br/&gt;
If that&apos;s the case, what separates a handler that is distributed and one that isn&apos;t?&lt;br/&gt;
The first thing that occured to me was to just detect the presence of shards[] after the prepare phase.&lt;br/&gt;
There is a side benefit in that a component can control whether a request is distributed or not (all solrconfig could be the same for systems in a cluster, with some sort of external system controlling topology). &lt;/p&gt;

&lt;p&gt;One could have a distributed handler that could delegate or handle non-distributed requests, but it seems to amount to the same thing (a single handler that can do both on the fly).&lt;/p&gt;

&lt;p&gt;Saving an if() doesn&apos;t seem too compelling (the current code could certainly be refactored to be cleaner anyway).  Are there other benefits to having a separate DistributedSearchHandler though?&lt;br/&gt;
.&lt;/p&gt;
</comment>
                            <comment id="12554524" author="ryantxu" created="Thu, 27 Dec 2007 05:31:27 +0000"  >
&lt;blockquote&gt;
&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
For #3, are there SolrJ parts (or future parts) that we wouldn&apos;t want automatically bundled with Solr?
&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think so.  The thing I want to make sure is still possible is that solrj can be distributed independently (without the lucene dependencies)&lt;/p&gt;

&lt;p&gt;The existing artifact topology makes sense as is: common, solrj, core.  &lt;/p&gt;

&lt;p&gt;Currently we have:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ common
  + solrj
  + core
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;we need&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ common
  + solrj  
      +core
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ common &amp;amp; solrj  
  + core
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This issue is essentially independent of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-303&quot; title=&quot;Distributed Search over HTTP&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-303&quot;&gt;&lt;del&gt;SOLR-303&lt;/del&gt;&lt;/a&gt;, but we should try to make our source directory structures consistent with standard practice. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
Saving an if() doesn&apos;t seem too compelling (the current code could certainly be refactored to be cleaner anyway). Are there other benefits to having a separate DistributedSearchHandler though?
&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If there is a good reason to keep it the &lt;b&gt;same&lt;/b&gt; handler then that is a reason enough.  &lt;/p&gt;

&lt;p&gt;I just looked at it  (without really grocking how it works) and it seemed a bit bloated with distribution lifecycle stuff.  As long as the non-distributed request cycle isn&apos;t tied to the distributed stuff, I&apos;m sure it is fine.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;BTW, where does the term &quot;shard&quot; come from?  What specifically does it refer to?&lt;/p&gt;</comment>
                            <comment id="12554534" author="otis" created="Thu, 27 Dec 2007 06:38:55 +0000"  >&lt;p&gt;Shard is what you call a small(er) index that is a part of a large(r) cluster of indices.  These smaller shards together form one large logical index.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://www.scribd.com/doc/312186/THE-GOOGLE-CLUSTER-ARCHITECTURE&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.scribd.com/doc/312186/THE-GOOGLE-CLUSTER-ARCHITECTURE&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I wish Nutch used the same (shard) nomenclature instead of using &quot;segments&quot;, so there is no confusion with Lucene index segments.... but that&apos;s another issue.&lt;/p&gt;</comment>
                            <comment id="12555711" author="yseeley@gmail.com" created="Thu, 3 Jan 2008 23:21:41 +0000"  >&lt;p&gt;Small update, mostly to sorting&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This changes sorting to get values from the Sort comparators (thus supporting custom sorts)&lt;/li&gt;
	&lt;li&gt;uses external values that can be supported by XML, also nicer for debugging&lt;/li&gt;
	&lt;li&gt;returns sort field values in an array per-field 
{price=[10,20,30,40,50]}&lt;/li&gt;
	&lt;li&gt;merging should be faster... lookup of sort values is by index number instead of searching&lt;br/&gt;
  for the field name.&lt;/li&gt;
	&lt;li&gt;merging short-circuits comparisons for docs in the same shard&lt;/li&gt;
	&lt;li&gt;sorting null values now works &amp;amp; respects sortMissingFirst/Last, etc&lt;/li&gt;
	&lt;li&gt;if a shard request, don&apos;t pre-fetch docs for highlighter&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12556575" author="gereon" created="Mon, 7 Jan 2008 14:52:48 +0000"  >&lt;p&gt;Yonik, no matter what I try, I keep getting exceptions when querying anything that uses shards. &lt;br/&gt;
Is the correct query URL still what I&apos;ve used in my previous comment?&lt;/p&gt;

&lt;p&gt;Excerpt from my logs:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SEVERE: org.apache.solr.client.solrj.SolrServerException: Error executing query
        at org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:86)
[...]
Caused by: org.apache.solr.common.SolrException: /select

/select

request: http://localhost:8090/select?echoParams=explicit&amp;amp;q=id:1527426&amp;amp;start=0&amp;amp;rows=10&amp;amp;fsv=true&amp;amp;fl=id,score&amp;amp;isShard=true&amp;amp;wt=xml&amp;amp;version=2.2
        at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:243)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12556612" author="yseeley@gmail.com" created="Mon, 7 Jan 2008 16:26:15 +0000"  >&lt;p&gt;There is currently no &quot;local&quot; shard... is that causing your problem?&lt;br/&gt;
Use something like shards=localhost:8983/solr,localhost:8080/solr&lt;/p&gt;</comment>
                            <comment id="12556644" author="pjaol" created="Mon, 7 Jan 2008 18:07:17 +0000"  >&lt;p&gt;Hey Yonik&lt;/p&gt;

&lt;p&gt;Are you applying the federated search patch first before the distributed search?&lt;br/&gt;
The patch itself won&apos;t apply cleanly against trunk &lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
P&lt;/p&gt;</comment>
                            <comment id="12556881" author="gereon" created="Tue, 8 Jan 2008 12:34:12 +0000"  >&lt;p&gt;Yonik - thanks, that&apos;s what caused it.&lt;/p&gt;

&lt;p&gt;Patrick - as far as I can tell, you can ignore the error messages from patch.&lt;/p&gt;</comment>
                            <comment id="12556949" author="pjaol" created="Tue, 8 Jan 2008 17:14:08 +0000"  >&lt;p&gt;This might help, merged the distributed &amp;amp; federated patchs with trunk last night, fixed the rejects. Appears to work.&lt;br/&gt;
The only things not included are the distributed searcher unit tests from the previous patch. Only the deltas were in the patch, so I had no way to rebuild them.&lt;/p&gt;

&lt;p&gt;Hope this helps&lt;br/&gt;
P&lt;/p&gt;</comment>
                            <comment id="12556950" author="yseeley@gmail.com" created="Tue, 8 Jan 2008 17:23:09 +0000"  >&lt;p&gt;I&apos;m in the middle of implementing some distributed faceting... but I&apos;ll try to get a better patch the next time around.&lt;br/&gt;
I think some of Ryan&apos;s suggestions are good (a separate patch to move SearchHandler, put solrj in core, implement ResponseWriter support for SolrJ objects).&lt;/p&gt;
</comment>
                            <comment id="12557012" author="pjaol" created="Tue, 8 Jan 2008 20:03:33 +0000"  >&lt;p&gt;Was missing a file from an svn add, so the patch I put in there misses out on SolrFieldSortedHitQueue&lt;br/&gt;
I&apos;ll remove it to reduce confusion.&lt;/p&gt;</comment>
                            <comment id="12557017" author="ryantxu" created="Tue, 8 Jan 2008 20:19:59 +0000"  >&lt;p&gt;yonik, if you say &quot;go&quot;, I&apos;ll add &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-446&quot; title=&quot;TextResponseWriter should be able to work with SolrDocument and SolrDocumentList&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-446&quot;&gt;&lt;del&gt;SOLR-446&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12557324" author="pjaol" created="Wed, 9 Jan 2008 16:57:49 +0000"  >&lt;p&gt;Small thing but if you update org.apache.solr.handler.component.ResponseBuilder&lt;br/&gt;
and set the stages to final, you can use a switch statement in the distributedProcess phase.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class ResponseBuilder 
{
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_START           = 0;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_PARSE_QUERY     = 1000;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_EXECUTE_QUERY   = 2000;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_GET_FIELDS      = 3000;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; STAGE_DONE            = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12557332" author="yseeley@gmail.com" created="Wed, 9 Jan 2008 17:15:39 +0000"  >&lt;p&gt;WRT a switch, I left room for other components to insert stages between the well defined ones.&lt;br/&gt;
I&apos;m not sure if this will be useful in the future or not.  Much of that seems like it would depend on the contracts between the components and the ResponseBuilder, and thus how other unknown custom coponents would be able to change things. That&apos;s still very immature, as I&apos;ve really just been focusing on getting things working.&lt;/p&gt;</comment>
                            <comment id="12557522" author="yseeley@gmail.com" created="Thu, 10 Jan 2008 02:39:14 +0000"  >&lt;p&gt;OK, this version patches cleanly and includes some distributed faceting code.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;facet.query and facet.field sorted by count is mostly handled&lt;/li&gt;
	&lt;li&gt;breaking ties by natural (index) sort order is not yet implemented&lt;/li&gt;
	&lt;li&gt;date faceting and unsorted (index order) facet.field is not implemented&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Assuming the user asks for the top 10 terms of a field:&lt;br/&gt;
1) The first facet queries piggyback on the queries to get the top ids and sort field values.&lt;br/&gt;
2) counts are merged, and new &quot;refinement&quot; requests are send out for those terms in the top 10 where a count was not received from some shards.  Also, for terms below the top 10, we calculate the maximum it could have based on shards we have not heard from, and if that boosts it into the top 10, we include that term for &quot;refinement&quot;.&lt;br/&gt;
3) refinement responses are used to adjust the counts, and we are done.&lt;/p&gt;

&lt;p&gt;Note that it is theoretically possible to miss terms.  A term could be just below the threshold of each shard (and thus not returned by any shard), but the total count could boost it in the top.  This could be rectified by retrieving &lt;b&gt;all&lt;/b&gt; terms above a specified count, but it could be expensive.  The counts that are currently returned are exact.&lt;/p&gt;
</comment>
                            <comment id="12557525" author="yseeley@gmail.com" created="Thu, 10 Jan 2008 02:42:14 +0000"  >&lt;p&gt;Note that for a normal facet query, this could result in 3 waves of requests.&lt;br/&gt;
1) query + facet&lt;br/&gt;
2) facet refinements&lt;br/&gt;
3) retrieve stored fields + highlight&lt;/p&gt;

&lt;p&gt;We probably want to allow #2 to piggyback on #3 requests, provided that nothing needs final facet values before retrieving the stored fields.&lt;/p&gt;</comment>
                            <comment id="12557531" author="hossman" created="Thu, 10 Jan 2008 03:09:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;OK, this version patches cleanly and includes some distributed faceting code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t looked at it ... but holy freaking cow that&apos;s cool.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Note that it is theoretically possible to miss terms. A term could be just below the threshold of each shard (and thus not returned by any shard), but the total count could boost it in the top. This could be rectified by retrieving all terms above a specified count, but it could be expensive. The counts that are currently returned are exact.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;one solution i&apos;ve seen to mitigate problems like this in the past is to compute a higher &quot;limit&quot; when querying the individual shards, someone somewhere suggested that n**2 is a good approach (but they may have been talking out of their ass) so if the initial request says facet.limit=5, the individual shards would be queried with facet.limit=25 ... but you&apos;d also still want to use refinement requests.&lt;/p&gt;
</comment>
                            <comment id="12557533" author="iholsman" created="Thu, 10 Jan 2008 03:32:17 +0000"  >&lt;p&gt;Hoss.. &lt;/p&gt;

&lt;p&gt;I&apos;m not sure about n**2. &lt;/p&gt;

&lt;p&gt;I would think it would be n * number of shards.&lt;/p&gt;</comment>
                            <comment id="12557535" author="yseeley@gmail.com" created="Thu, 10 Jan 2008 03:44:54 +0000"  >&lt;p&gt;&amp;gt; one solution i&apos;ve seen to mitigate problems like this in the past is to compute a higher &quot;limit&quot; when querying the individual shards&lt;/p&gt;

&lt;p&gt;Yep.  Eventually should be configurable too.  We should definitely do some &quot;over requesting&quot; for very small limits.  Expanding the limit too much can be expensive though (CPU cost partially depends on the algorithm).  I think users should even be able to disable refinement queries if they just want an estimate.&lt;/p&gt;

&lt;p&gt;Note that it&apos;s possible to tell if there even could be stealth terms out there... we maintain the smallest count we get from each shard, so that serves as the largest count any unknown term could have.  Add all those together to see if it&apos;s possible an unknown term could make it to the top terms.   This means you could do a request with a smaller limit, and then re-request with a larger limit if necessary.&lt;/p&gt;

&lt;p&gt;Beyond that, it becomes unclear what the best strategy is.  Worst case scenario: If the top N facets get down to a count of 1, then &lt;b&gt;any&lt;/b&gt; unknown term could bump another higher.  Requesting all terms with count&amp;gt;=1 from each shard isn&apos;t something I want to ponder. &lt;/p&gt;

&lt;p&gt;Anyway, a colleague informs me that this is the way at least one other major search vendor does things (counts are exact for terms shown, but it is theoretically possible to miss a term). &lt;/p&gt;</comment>
                            <comment id="12557537" author="yseeley@gmail.com" created="Thu, 10 Jan 2008 03:59:00 +0000"  >&lt;p&gt;&amp;gt; I would think it would be n * number of shards.&lt;/p&gt;

&lt;p&gt;That would make the number of terms to transfer over the network and to merge O(n_shards**2)... not great for scalability &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12557554" author="yseeley@gmail.com" created="Thu, 10 Jan 2008 06:21:15 +0000"  >&lt;p&gt;New patch attached...&lt;/p&gt;

&lt;p&gt;I just discovered that refinement queries weren&apos;t working because filter.query doesn&apos;t accept the new query syntax I was using to avoid having to escape field values: &amp;lt;!field f=myfield&amp;gt;value&lt;br/&gt;
(this should probably be committed separately, but it&apos;s in this patch for now).&lt;/p&gt;

&lt;p&gt;I put in code to over-request facet.field limit, but then commented it out for now since it too easily covers up bugs because it often prevents any refinement query logic from being exercized.&lt;/p&gt;

&lt;p&gt;Also corrected the code that always used the last element as the max possible missing count.  If we requested 10 terms and only got 6, then we know that the max possible missing count is zero.&lt;/p&gt;</comment>
                            <comment id="12557899" author="yseeley@gmail.com" created="Fri, 11 Jan 2008 04:52:00 +0000"  >&lt;p&gt;Now patch attached... this one implements count tiebreaking by index order (to match the non-distributed faceting).&lt;/p&gt;</comment>
                            <comment id="12559259" author="dbrodsky" created="Tue, 15 Jan 2008 22:41:58 +0000"  >&lt;p&gt;Hey,&lt;/p&gt;

&lt;p&gt;Quick question from a solr newbie.  I&apos;d love to be able to play/test out the distributed functionality of this patch.  Are there some user level instructions as to how to configure and run?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
ttyl&lt;br/&gt;
Dima&lt;/p&gt;
</comment>
                            <comment id="12559269" author="pjaol" created="Tue, 15 Jan 2008 22:55:16 +0000"  >&lt;p&gt;Hey Yonik&lt;br/&gt;
Needed to make a couple of updates to ShardDoc as the nested outer classes were preventing me from using the patch.&lt;br/&gt;
Also included &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-457&quot; title=&quot;A multi threaded implementation for solrJ&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-457&quot;&gt;&lt;del&gt;SOLR-457&lt;/del&gt;&lt;/a&gt;, with a multi threaded implementation of solrj to query the shards.&lt;br/&gt;
with this patch.&lt;/p&gt;

&lt;p&gt;P&lt;/p&gt;</comment>
                            <comment id="12563701" author="yseeley@gmail.com" created="Tue, 29 Jan 2008 22:34:06 +0000"  >&lt;p&gt;This update adds parallel requests.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a singleton communications thread pool (executor) is added... currently static, but it should be &lt;b&gt;per core&lt;/b&gt; and have a way of shutting down.&lt;/li&gt;
	&lt;li&gt;a singleton HttpClient for use by all SolrServer instances, currently static, probably fine to remain so (unless there needs to be core specific config?)&lt;/li&gt;
	&lt;li&gt;an exception causes everything to be aborted&lt;/li&gt;
	&lt;li&gt;all requests in a phase are sent out in parallel&lt;/li&gt;
	&lt;li&gt;a completion service is used for grabbing completed requests, so the first requests back can start being processed.&lt;/li&gt;
	&lt;li&gt;while receiving responses, if any new requests are put on the outgoing queue, they are immediately sent out before waiting for any further responses.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12565638" author="yseeley@gmail.com" created="Tue, 5 Feb 2008 04:33:23 +0000"  >&lt;p&gt;Updated patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;face refinement requests piggyback on the requests to retrieve stored fields where possible.&lt;/li&gt;
	&lt;li&gt;fixed bug when requesting scores... don&apos;t include scores even if requested if they are not in the given DocList&lt;/li&gt;
	&lt;li&gt;fixed HTTP error codes for query parse errirs&lt;/li&gt;
	&lt;li&gt;added double/long support in sorting since we&apos;ve upgraded to lucene 2.3, and changed aggregate numFound to handle long&lt;/li&gt;
	&lt;li&gt;escape&amp;amp;unescape comma separated &quot;ids&quot; string using backslash escaping (used to specify docs from each shard to retrieve)&lt;/li&gt;
	&lt;li&gt;other misc cleanups&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12567953" author="pjaol" created="Tue, 12 Feb 2008 04:47:18 +0000"  >&lt;p&gt;It looks pretty good, I really need the ShardDoc&apos;s classes to be split up into public classes so I can use&lt;br/&gt;
them. &lt;br/&gt;
It would also be fantastic to open up QueryComponent, my component only needs to over ride&lt;br/&gt;
a few functions, and it would so much cleaner to just extend QueryComponent rather than duplicate the code.&lt;/p&gt;

&lt;p&gt;Also through testing, it might be worth while to apply a few negative edge cases.&lt;br/&gt;
e.g. duplicate documents in different shards. As systems get larger this is a huge possibility. Only fixed hash indexing could ensure you don&apos;t get duplicates, but if you try to have an extend-able  environment that might not be an option.&lt;/p&gt;

&lt;p&gt;Took me a while to realize I had duplicated documents during indexing, but it causes NPEs in the query response writers, so not obvious or easy to figure out.&lt;/p&gt;

&lt;p&gt;A solution would be to maintain map of unique fields as adding the ShardDocs to the priority queue, and continue on duplicates. You might also want to put some logic in there to ensure same shard doc is used for each duplicate doc, simple because the scores for identical doc&apos;s will be different across shards, and could change based upon order of which Shard responds first. This should eliminate that&lt;/p&gt;


&lt;p&gt;So something like&lt;br/&gt;
QueryComponent.mergeIds&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; uniqueDoc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;();
      
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ShardResponse srsp : sreq.responses) {
        SolrDocumentList docs = srsp.rsp.getResults();
         ................
         ................
         &lt;span class=&quot;code-comment&quot;&gt;// go through every doc in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; response, construct a ShardDoc, and
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// put it in the priority queue so it can be ordered.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt;docs.size(); i++) {
          SolrDocument doc = docs.get(i);
          ..................
          ..................
          &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; uniqueField = doc.getFieldValue(uniqueKeyField.getName());
          
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(! uniqueDoc.containsKey(uniqueField)) {
        	  shardDoc.setId(uniqueField);
        	  uniqueDoc.put(uniqueField, shardDoc.shard);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;{
        	  numFound--;
        	  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(uniqueDoc.get(uniqueField).compareTo(shardDoc.shard) &amp;gt;0){
        		 &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
        	  }
          }

          ..........................
          queue.insert(shardDoc);
        } &lt;span class=&quot;code-comment&quot;&gt;// end &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-each-doc-in-response
&lt;/span&gt;      } &lt;span class=&quot;code-comment&quot;&gt;// end &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-each-response&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12569711" author="yseeley@gmail.com" created="Sun, 17 Feb 2008 15:47:27 +0000"  >&lt;p&gt;updated patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;refactored some distributed search code to make things easier (added modifyRequest, etc)&lt;/li&gt;
	&lt;li&gt;added merging of debugging info timing info (including timing info, via generic recursive merging)&lt;/li&gt;
	&lt;li&gt;merge explain info, drops internal id from explain key for easier merging&lt;/li&gt;
	&lt;li&gt;Many small changes: don&apos;t return scores if they aren&apos;t requested (even if needed for shard requests to merge), return maxScore&lt;br/&gt;
  if scores are requested, enable escaping for shards parameter.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12569712" author="yseeley@gmail.com" created="Sun, 17 Feb 2008 15:59:22 +0000"  >&lt;p&gt;&amp;gt; I really need the ShardDoc&apos;s classes to be split up into public classes&lt;/p&gt;

&lt;p&gt;ShardDoc is public already... can you elaborate?&lt;/p&gt;

&lt;p&gt;&amp;gt; It would also be fantastic to open up QueryComponent, my component only needs to override a few functions&lt;/p&gt;

&lt;p&gt;What is yours trying to accomplish?&lt;/p&gt;

&lt;p&gt;&amp;gt; A solution would be to maintain map of unique fields as adding the ShardDocs to the priority queue, and continue on duplicates.&lt;/p&gt;

&lt;p&gt;Agree.  It should fall into the category of robustness though, rather than a duplicates detection feature (since it will mean that facets will be off, and it will be possible to get fewer docs than requested if duplicates do exist).&lt;/p&gt;

&lt;p&gt;We also need to be robust in the face of a commit on a shard happening between phases of a request (a doc that we request info for may no longer exist, etc).  That would probably cause us to blow up currently.&lt;/p&gt;

&lt;p&gt;Hopefully this can be committed after some basic tests are added, and that will make it much easier for others to contribute patches.  In the future maybe we should try a branch for changes this large.&lt;/p&gt;</comment>
                            <comment id="12569717" author="yseeley@gmail.com" created="Sun, 17 Feb 2008 17:01:27 +0000"  >&lt;p&gt;New patch attached... last one had an unfinished change that prevented compilation (using the generic SolrResponse instead of SolrQueryResponse).&lt;/p&gt;</comment>
                            <comment id="12569728" author="yseeley@gmail.com" created="Sun, 17 Feb 2008 17:36:58 +0000"  >&lt;p&gt;fixed test cases that relied on parsing previous explain format&lt;/p&gt;</comment>
                            <comment id="12571992" author="yseeley@gmail.com" created="Mon, 25 Feb 2008 00:19:05 +0000"  >&lt;p&gt;Patrick, I&apos;ve reproduced your null pointer exception on accidental duplicates (I&apos;ve been working on tests).  I&apos;ll look into a fix along the lines of what you suggested.&lt;/p&gt;</comment>
                            <comment id="12572261" author="yseeley@gmail.com" created="Mon, 25 Feb 2008 21:53:16 +0000"  >&lt;p&gt;New patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;test framework using multiple embedded jetty servers that adds documents to multiple servers, and also to a control server, then executes both distributed and non-distributed queries and compares the results.&lt;/li&gt;
	&lt;li&gt;fixed merging for non-string uniqueKeyFields&lt;/li&gt;
	&lt;li&gt;fixed issue when id field was not selected by client&lt;/li&gt;
	&lt;li&gt;break facet count ties by label&lt;/li&gt;
	&lt;li&gt;added rudimentary duplicate detection in case one accidentally adds the same doc to different shards&lt;/li&gt;
	&lt;li&gt;add code to handle index changes between query phases (docs may no longer exist)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Given that most of this is new functionality, I think things are in good enough shape to commit now (making it much easier for others to generate patches against it).&lt;/p&gt;</comment>
                            <comment id="12572542" author="ryantxu" created="Tue, 26 Feb 2008 16:12:33 +0000"  >
&lt;blockquote&gt;&lt;p&gt;Given that most of this is new functionality, I think things are in good enough shape to commit now (making it much easier for others to generate patches against it).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 (But have only checked that it does not break anything I&apos;m working with) &amp;#8211; I think this should get committed soon.  Since it is large and mostly discrete from existing functions, it will be much easier to refine with smaller patches.&lt;/p&gt;</comment>
                            <comment id="12572633" author="yseeley@gmail.com" created="Tue, 26 Feb 2008 20:02:12 +0000"  >&lt;p&gt;OK, I&apos;ve committed this!  Thanks everyone!&lt;br/&gt;
I&apos;ll leave this bug open for now as a place to accumulate patches.&lt;/p&gt;

&lt;p&gt;Some things that are missing (but optional and not currently high on my TODO list):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;field faceting when facet.sort=false&lt;/li&gt;
	&lt;li&gt;distributed idf... this has a performance cost, and should matter little in a well mixed index.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12574984" author="henrib" created="Tue, 4 Mar 2008 13:18:22 +0000"  >&lt;p&gt;Nothing functional , just noticed reading the code that Shard&lt;/p&gt;
{Doc,Request}
&lt;p&gt; are missing the Apache license header.&lt;/p&gt;</comment>
                            <comment id="12579926" author="jayson.minard" created="Tue, 18 Mar 2008 17:04:48 +0000"  >&lt;p&gt;Attached patch to fix issue with distributed search.  If you specified a facet.field that was valid for the schema but not contained in a shard, an unintentional exception (array index out of bounds) would be thrown instead of returning the facet as empty.&lt;/p&gt;</comment>
                            <comment id="12579931" author="yseeley@gmail.com" created="Tue, 18 Mar 2008 17:15:20 +0000"  >&lt;p&gt;I just committed this bugfix... thanks Jayson!&lt;/p&gt;</comment>
                            <comment id="12579966" author="jayson.minard" created="Tue, 18 Mar 2008 18:06:48 +0000"  >&lt;p&gt;A few more tests to show intended behavior when facets differ between shards which is likely in the wild (missing from all but valid in schema, missing from some, and invalid field not in schema).  The last test  is just to ensure error behavior matches non-distributed searches.&lt;/p&gt;</comment>
                            <comment id="12580024" author="yseeley@gmail.com" created="Tue, 18 Mar 2008 19:40:22 +0000"  >&lt;p&gt;committed addition tests... thanks!&lt;/p&gt;</comment>
                            <comment id="12580188" author="jayson.minard" created="Wed, 19 Mar 2008 00:18:20 +0000"  >&lt;p&gt;Would it be interesting to others to have an extended response format for distributed queries that would bring back the list of shards numbered, and then code each element of the response with the source list of shards that contributed to the element appearing in the results?  For example, which shard was the source of a document?  Or which shards had the facet value present?  And so on.&lt;/p&gt;

&lt;p&gt;In really high shard counts it is more efficient if you can trim follow-on queries and pivots to only shards that matter.  This information would help that effort.  &lt;/p&gt;

&lt;p&gt;Regardless, it is useful for debugging.&lt;/p&gt;</comment>
                            <comment id="12580392" author="timmsc" created="Wed, 19 Mar 2008 14:43:14 +0000"  >&lt;p&gt;Jayson--&lt;/p&gt;

&lt;p&gt;I agree.  I&apos;ve been meaning to recommend that be added.  We&apos;ve found it invaluable in the past (mostly with debugging) when doing federated and distributed search.  I would like to see a &quot;shard&quot; field added which would contain the base URI of the shard where the result originated as provided in the request.  The index of each result is less important to me, but I can see how that would be useful.&lt;/p&gt;</comment>
                            <comment id="12580403" author="jayson.minard" created="Wed, 19 Mar 2008 15:22:31 +0000"  >&lt;p&gt;I&apos;ll see if I can work up a patch tonight on the extended response...&lt;/p&gt;</comment>
                            <comment id="12581747" author="stuhood" created="Tue, 25 Mar 2008 00:44:56 +0000"  >&lt;p&gt;Because the subqueries to Solr shards use GET requests (via SolrJ), they are limited in the number of documents they can request during the second phase by the maximum length of the query string.&lt;/p&gt;

&lt;p&gt;One (API preserving) solution would be to modify SolrJ to use a POST request for queries if the query string is longer than some constant value.&lt;/p&gt;</comment>
                            <comment id="12581885" author="tpeuss" created="Tue, 25 Mar 2008 11:57:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;they are limited in the number of documents they can request during the second phase by the maximum length of the query string.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For Tomcat you can increase the allowed length of the query string by adding for example &lt;em&gt;maxHttpHeaderSize=&quot;65536&quot;&lt;/em&gt; to the Connector entries in server.xml. This increases the max. allowed GET request size to 64KB (standard is 4KB).&lt;/p&gt;</comment>
                            <comment id="12593196" author="yseeley@gmail.com" created="Wed, 30 Apr 2008 02:17:09 +0100"  >&lt;p&gt;Attaching shards_qt.patch, which uses &quot;shards.qt&quot; as &quot;qt&quot; for sub-requests to avoid infinite recursion when setting &quot;shards&quot; as a default in the request handler.&lt;/p&gt;</comment>
                            <comment id="12593574" author="yseeley@gmail.com" created="Thu, 1 May 2008 17:38:10 +0100"  >&lt;p&gt;I just committed shards_qt.patch&lt;/p&gt;</comment>
                            <comment id="12598230" author="larsko" created="Tue, 20 May 2008 10:32:59 +0100"  >&lt;p&gt;I&apos;ve had a couple of issues with the current version. First, the facet queries which are sent to the other shards are posted in the URL, but aren&apos;t URL encoded, i.e. during the refine stage anything non-ascii results in facet counts for &quot;new&quot; values (i.e. the garbled version) coming back and causing NPEs when trying to update the counts.&lt;/p&gt;

&lt;p&gt;Furthermore, facet.limit=&amp;lt;negative value&amp;gt; isn&apos;t working as expected, i.e. instead of all facets it returns none. Also facet.sort is not automatically enabled for negative values.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached &quot;solr-dist-faceting-non-ascii-all.patch&quot; which fixes the above issues. Somebody who understands what everything is supposed to do should have a look over it though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
For example I&apos;ve found two linked hash maps in FacetInfo, topFacets and listFacets, which seem to serve the same purpose. Therefore I replaced them by a single hash map. It seems to work just fine this way.&lt;/p&gt;</comment>
                            <comment id="12598548" author="larsko" created="Wed, 21 May 2008 05:06:37 +0100"  >&lt;p&gt;On closer inspection of the code, are the fields &quot;sort&quot; and &quot;prefix&quot; of FieldFacet used anywhere at all? They don&apos;t seem to be referenced anywhere in the code and just removing them doesn&apos;t seem to have any obvious effect.&lt;/p&gt;</comment>
                            <comment id="12598826" author="hossman" created="Wed, 21 May 2008 23:20:33 +0100"  >&lt;p&gt;marking as intended for 1.3 ... i&apos;m not overly familiar with the state of this issue, but i do know that large chunks of functionality have already been committed, so i want to make sure that before 1.3 is released someone conciously decides between:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&quot;DONE&quot; ...resolving this issue&lt;/li&gt;
	&lt;li&gt;&quot;NOT DONE BUT OK&quot; ... leaving the issue unresolved and removing the 1.3 designation&lt;/li&gt;
	&lt;li&gt;&quot;NOT DONE AND NOT OK&quot; ... rolling back any/all committed code that is considered detrimental for the 1.3 release.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12605650" author="bwhitman" created="Tue, 17 Jun 2008 17:38:08 +0100"  >&lt;p&gt;When I give the following request:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select?shards=localhost:8983/solr,localhost:8984/solr&amp;amp;q=woof&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select?shards=localhost:8983/solr,localhost:8984/solr&amp;amp;q=woof&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;With no server running on 8984 I get a error 500 (naturally.)&lt;/p&gt;

&lt;p&gt;But shouldn&apos;t there be an option to skip over servers that aren&apos;t responding or time out? Envisioning a scenario in which this is used to search across possibly redundant uniqueIDs and a server being down is not cause for exception.&lt;/p&gt;

</comment>
                            <comment id="12605653" author="otis" created="Tue, 17 Jun 2008 17:48:27 +0100"  >&lt;p&gt;Ah, yes, I agree with Brian.  I did see this, too, fut forgot to report it as a problem that needs a fix.&lt;/p&gt;</comment>
                            <comment id="12605660" author="yseeley@gmail.com" created="Tue, 17 Jun 2008 18:03:40 +0100"  >&lt;p&gt;&amp;gt; But shouldn&apos;t there be an option to skip over servers that aren&apos;t responding or time out?&lt;/p&gt;

&lt;p&gt;That does sound like it would be a useful option (but I think it should be false by default though).&lt;/p&gt;

&lt;p&gt;FYI, I&apos;m currently looking into Lars&apos; facet changes.&lt;/p&gt;</comment>
                            <comment id="12605666" author="timmsc" created="Tue, 17 Jun 2008 18:28:28 +0100"  >&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-502&quot; title=&quot;Add search time out support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-502&quot;&gt;&lt;del&gt;SOLR-502&lt;/del&gt;&lt;/a&gt;, there is the notion of partialResults.  It seems that the same flag could be used in this case.  Perhaps a string should also be added indicating why all results were not able to be returned.&lt;/p&gt;</comment>
                            <comment id="12605670" author="yseeley@gmail.com" created="Tue, 17 Jun 2008 18:33:31 +0100"  >&lt;p&gt;Lars: I committed your fix to the facet.limit value sent to shards, and instead of changing ntop when facet.limit&amp;lt;=0, I simply short-circuited checking if refinement is needed at all.&lt;/p&gt;

&lt;p&gt;Next up: investigate this URL encoding (or lack of it) in the POST body.&lt;/p&gt;</comment>
                            <comment id="12605699" author="yseeley@gmail.com" created="Tue, 17 Jun 2008 20:18:41 +0100"  >&lt;p&gt;Lars: I&apos;m not yet able to reproduce an issue with SolrJ not encoding the parameters properly.&lt;/p&gt;

&lt;p&gt;The following code finds the sample solr document:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    SolrServer server = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CommonsHttpSolrServer(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr&quot;&lt;/span&gt;);
&lt;/span&gt;    ModifiableSolrParams params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModifiableSolrParams();
    params.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;echoParams&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;all&quot;&lt;/span&gt;);
    params.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;+h\u00E9llo&quot;&lt;/span&gt;);
    QueryRequest req = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QueryRequest(params);
    req.setMethod(SolrRequest.METHOD.POST);
     &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(server.request(req));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And netcat confirms the encoding looks good, and is in fact using POST&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ nc -l -p 8983
POST /solr/select HTTP/1.1
User-Agent: Solr[org.apache.solr.client.solrj.impl.CommonsHttpSolrServer] 1.0
Host: localhost:8983
Content-Length: 53
Content-Type: application/x-www-form-urlencoded

echoParams=all&amp;amp;q=%2Bh%C3%A9llo&amp;amp;wt=javabin&amp;amp;version=2.2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll see if I can reproduce anything with TestDistributedSearch&lt;/p&gt;</comment>
                            <comment id="12605868" author="larsko" created="Wed, 18 Jun 2008 07:58:33 +0100"  >&lt;p&gt;Yonik, thanks for taking a look at it.&lt;/p&gt;

&lt;p&gt;I&apos;ve investigated this issue further and I believe I know what the root cause is now. The line&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;o.a.s.client.solrj.impl.CommonsHttpSolrServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
post.getParams().setContentCharset(&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;tells the &lt;b&gt;sender&lt;/b&gt; to encode the data as UTF-8. The way the &lt;b&gt;receiver&lt;/b&gt; decodes the data depends on whatever is set as charset in the Content-Type header. This header is currently automatically added by httpclient and, as you can see in the netcat log, &quot;application/x-www-form-urlencoded&quot;, i.e. without a charset. The default charset is ISO-8859-1 (cf. &lt;a href=&quot;http://hc.apache.org/httpclient-3.x/charencodings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hc.apache.org/httpclient-3.x/charencodings.html&lt;/a&gt;). So the data is &lt;b&gt;encoded&lt;/b&gt; as UTF-8 but &lt;b&gt;decoded&lt;/b&gt; as ISO-8859-1, which causes the effect I described earlier.&lt;/p&gt;

&lt;p&gt;I tried to reproduce this with TestDistributedSearch myself, but for some reason it seems to be fine. Perhaps the Jetty configuration is different to my Tomcat configuration. I didn&apos;t find any parameter to tell Tomcat the default encoding if the Content-Type header doesn&apos;t specify one though.&lt;/p&gt;

&lt;p&gt;The minimal change I had to make to make it work was add a line to set the Content-Type header explicitly, i.e.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;o.a.s.client.solrj.impl.CommonsHttpSolrServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
post.getParams().setContentCharset(&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;);
post.setRequestHeader(&lt;span class=&quot;code-quote&quot;&gt;&quot;Content-Type&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;&lt;/span&gt;);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This probably won&apos;t work with multi-part requests though. I&apos;m not sure what the right way to handle this would be. The stub Content-Type header is set by httpclient when the method is executed, i.e. there&apos;s no way to let httpclient figure out the first part and then append the charset in CommonsHttpSolrServer.&lt;/p&gt;

&lt;p&gt;Some other things I&apos;ve noticed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Just before the content charset is set, the parameters of the POST request are populated. If the value for a parameter is null, the code attempts to to add a null parameter. This however will cause an IllegalArgumentException from httpclient (cf. &lt;a href=&quot;http://hc.apache.org/httpclient-3.x/apidocs/org/apache/commons/httpclient/methods/PostMethod.html#addParameter(java.lang.String, java.lang.String)&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hc.apache.org/httpclient-3.x/apidocs/org/apache/commons/httpclient/methods/PostMethod.html#addParameter(java.lang.String, java.lang.String)&lt;/a&gt;).&lt;/li&gt;
	&lt;li&gt;TestDistributedSearch does not exercise the code to refine facet counts. Adding another facet request with facet.limit=1 redresses this.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12605931" author="yseeley@gmail.com" created="Wed, 18 Jun 2008 14:08:33 +0100"  >&lt;p&gt;I forgot we&apos;ve already gone a few rounds on charset in POST bodies:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-443&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-443&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://markmail.org/message/gtzbtwzqa6zranur?q=POST+body+charset#query:POST%20body%20charset+page:1+mid:fkragfatbox5fff5+state:results&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://markmail.org/message/gtzbtwzqa6zranur?q=POST+body+charset#query:POST%20body%20charset+page:1+mid:fkragfatbox5fff5+state:results&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12606242" author="larsko" created="Thu, 19 Jun 2008 05:20:18 +0100"  >&lt;p&gt;Making this issue depend on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-443&quot; title=&quot;POST queries don&amp;#39;t declare its charset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-443&quot;&gt;&lt;del&gt;SOLR-443&lt;/del&gt;&lt;/a&gt; as distributed faceting of non-ascii values won&apos;t work properly without it. Please also see my comment on that issue.&lt;/p&gt;</comment>
                            <comment id="12607097" author="bwhitman" created="Sun, 22 Jun 2008 15:38:06 +0100"  >&lt;p&gt;If the user is going to be splitting their index over N shards, it&apos;s going to be crucial to have the distributed search (optionally) return the docid-&amp;gt;shard map in the response. Is that tricky to add as part of this issue? &lt;/p&gt;</comment>
                            <comment id="12607106" author="bwhitman" created="Sun, 22 Jun 2008 17:48:10 +0100"  >&lt;p&gt;Putting &amp;amp;debugQuery on a query with shards that returns 0 results will NPE:&lt;/p&gt;

&lt;p&gt;(removing NPE code block so it stops wrapping the page)&lt;/p&gt;</comment>
                            <comment id="12611230" author="yseeley@gmail.com" created="Mon, 7 Jul 2008 17:46:52 +0100"  >&lt;p&gt;Fixed &quot;debugQuery on a query with shards that returns 0 results will NPE&quot;.&lt;br/&gt;
There are still some issues with debugQuery=true, but it&apos;s not critical since it is just debugging.  I&apos;ll open another issue for that.&lt;/p&gt;</comment>
                            <comment id="12611368" author="bwhitman" created="Mon, 7 Jul 2008 22:50:08 +0100"  >&lt;p&gt;Anyone notice something like this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select?shards=&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select?shards=&lt;/a&gt;&lt;/p&gt;
{4 shards}
&lt;p&gt;&amp;amp;q=&lt;b&gt;:&lt;/b&gt;&amp;amp;start=5000&amp;amp;rows=1000&lt;/p&gt;

&lt;p&gt;Seems to request &amp;amp;rows=6000 from all the shards? (likewise, start=10000&amp;amp;rows=1000 sends rows=11000 to all the shards?) &lt;/p&gt;

&lt;p&gt;The shards all say:&lt;br/&gt;
INFO: webapp=/solr path=/select params=&lt;/p&gt;
{fl=id,score&amp;amp;start=0&amp;amp;q=*:*&amp;amp;isShard=true&amp;amp;wt=javabin&amp;amp;fsv=true&amp;amp;rows=6000&amp;amp;version=2.2}
&lt;p&gt; hits=6000 status=0 QTime=175 &lt;/p&gt;

&lt;p&gt;And the host I called select on says:&lt;br/&gt;
INFO: webapp=/solr path=/search params=&lt;/p&gt;
{start=5000&amp;amp;q=*:*&amp;amp;rows=1000}
&lt;p&gt; status=0 QTime=1192 &lt;/p&gt;

&lt;p&gt;And the QTime goes up the higher &amp;amp;start goes. (QTime for start=5000 was 200, QTime for start=50000 was 4500, start=500000 had 35000!)&lt;/p&gt;

&lt;p&gt;Bug or feature?&lt;/p&gt;
</comment>
                            <comment id="12611372" author="yseeley@gmail.com" created="Mon, 7 Jul 2008 23:08:20 +0100"  >&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select?shards=[4&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select?shards=[4&lt;/a&gt; shards]&amp;amp;q=&lt;b&gt;:&lt;/b&gt;&amp;amp;start=5000&amp;amp;rows=1000&lt;br/&gt;
Seems to request &amp;amp;rows=6000 from all the shards?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s a feature.&lt;/p&gt;

&lt;p&gt;To retrieve documents 5000-6000, one must find the first 6000 documents then take the last 1000.&lt;br/&gt;
Since it&apos;s possible that all top 6000 documents could come from a single shard, the top 6000 documents must be collected from each and merged.&lt;/p&gt;

&lt;p&gt;There are alternatives:&lt;br/&gt;
1) Optimistically request less than 6000 documents per shard and re-query if we are wrong&lt;br/&gt;
2) Add an optional mode that treats documents across shards in the same position as equal, so if you had 10 shards, you would simply get the top 100 docs starting at 500.  This might be OK for some applications.&lt;/p&gt;

&lt;p&gt;In general, search engines are optimized at retrieving the top 10 of something, and bad at retrieving the top 10 starting at a big number.  Limit the depth people can page, or restructure queries to avoid the latter case.&lt;/p&gt;</comment>
                            <comment id="12611376" author="bwhitman" created="Mon, 7 Jul 2008 23:15:45 +0100"  >&lt;p&gt;Understood. Can I suggest a third alternative?&lt;/p&gt;

&lt;p&gt;two new params: named &amp;amp;d.rows and &amp;amp;d.start with the implication that these get sent unchanged to each of the shards. You may get back up to N*d.rows, where N is the # of shards. That leaves the paging management up to the client.&lt;/p&gt;

&lt;p&gt;Our use case is millions of documents across many shards, and we often do queries that are &quot;get all document of type X.&quot; There may be 5m type X documents. Doing a &amp;amp;rows=5000000 is unpredictable so we&apos;ve previously done a loop of incrementing start by a 1000 and getting 1000 rows each time. But with this distributed setup, each successive batch query takes slightly longer, and by the time we&apos;ve gotten to the 5,001,000 batch queries are timing out and breaking anyway. &lt;/p&gt;


</comment>
                            <comment id="12611414" author="bwhitman" created="Tue, 8 Jul 2008 01:41:07 +0100"  >&lt;p&gt;Attaching patch to add a &amp;amp;shards.start and &amp;amp;shards.rows optional parameter. If set, they override distributed search&apos;s intelligence on setting start and rows per shard. If you set &amp;amp;shards.start=10 and &amp;amp;shards.rows=10, each shard will be queried with &amp;amp;start=10 and &amp;amp;rows=10 and you&apos;ll get back N*10 results (set &amp;amp;rows on the main query to get it all.)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Not a java developer, my patch works but may violate good taste/style&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="12611758" author="timmsc" created="Tue, 8 Jul 2008 20:19:22 +0100"  >&lt;p&gt;Another option is to pass state on the number of documents and positions retrieved from each shard.  I have  a client layer that can do that, so it works, but it is complicated, maintaining state is messy, and the vast majority of requests are first page requests so in practice we almost never use that feature, but instead do exactly as is implemented here and request the full document count from each shard.&lt;/p&gt;</comment>
                            <comment id="12613969" author="bwhitman" created="Wed, 16 Jul 2008 15:26:42 +0100"  >&lt;p&gt;Getting &quot;Form too large&quot; from jetty while doing normal but large rows= (40000) shards requests. Is this related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-612&quot; title=&quot;solrj should (optionally?) use POST for queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-612&quot;&gt;&lt;del&gt;SOLR-612&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;

&lt;p&gt;Query was : &lt;a href=&quot;http://x.x.x.x/solr/search?q=*:*&amp;amp;sort=indexed%20desc&amp;amp;fl=indexed&amp;amp;rows=40000&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://x.x.x.x/solr/search?q=*:*&amp;amp;sort=indexed%20desc&amp;amp;fl=indexed&amp;amp;rows=40000&lt;/a&gt; , where x.x.x.x is a single shard and /search has the shards ivars mapped to it in solrconfig.&lt;/p&gt;

&lt;p&gt;(Sorry for the mess, but that&apos;s how it appears)&lt;/p&gt;

&lt;p&gt;Form_too_large_&lt;em&gt;javalangIllegalStateException&lt;/em&gt;&lt;br/&gt;
Form_too_large_&lt;em&gt;at_orgmortbayjettyRequestextractParametersRequestjava1273&lt;/em&gt;&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyRequestgetParameterMapRequestjava650_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgapachesolrrequestServletSolrParamsinitServletSolrParamsjava29_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgapachesolrservletStandardRequestParserparseParamsAndFillStreamsSolrRequestParsersjava392_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgapachesolrservletSolrRequestParsersparseSolrRequestParsersjava113_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgapachesolrservletSolrDispatchFilterdoFilterSolrDispatchFilterjava240_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyservletServletHandler$CachedChaindoFilterServletHandlerjava1089_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyservletServletHandlerhandleServletHandlerjava365_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettysecuritySecurityHandlerhandleSecurityHandlerjava216_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyservletSessionHandlerhandleSessionHandlerjava181_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyhandlerContextHandlerhandleContextHandlerjava712_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettywebappWebAppContexthandleWebAppContextjava405_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyhandlerContextHandlerCollectionhandleContextHandlerCollectionjava211_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyhandlerHandlerCollectionhandleHandlerCollectionjava114_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyhandlerHandlerWrapperhandleHandlerWrapperjava139_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyServerhandleServerjava285_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyHttpConnectionhandleRequestHttpConnectionjava502_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyHttpConnection$RequestHandlercontentHttpConnectionjava835_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyHttpParserparseNextHttpParserjava641_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyHttpParserparseAvailableHttpParserjava202_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettyHttpConnectionhandleHttpConnectionjava378_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbayjettybioSocketConnector$ConnectionrunSocketConnectorjava226_&lt;em&gt;at&lt;/em&gt;&lt;br/&gt;
orgmortbaythreadBoundedThreadPool$PoolThreadrunBoundedThreadPooljava442_&lt;/p&gt;

&lt;p&gt;request: &lt;a href=&quot;http://x.x.x.x.y/solr/select&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://x.x.x.x.y/solr/select&lt;/a&gt; (ed: this was a different shard than the one I called)&lt;/p&gt;

&lt;p&gt;request: &lt;a href=&quot;http://x.x.x.y/solr/select&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://x.x.x.y/solr/select&lt;/a&gt;&lt;br/&gt;
	at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:343)&lt;br/&gt;
	at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:183)&lt;br/&gt;
	at org.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:371)&lt;br/&gt;
	at org.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:345)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</comment>
                            <comment id="12614181" author="larsko" created="Thu, 17 Jul 2008 02:16:07 +0100"  >&lt;p&gt;The default limit for form submissions is 200000 bytes with Jetty. I&apos;m not sure why Solr is trying to send such large amounts of data to the shards though, the only case I&apos;ve seen this happening is with faceting &amp;#8211; Solr has to request facet counts for specific values from the shards to get exact counts. Maybe because of the sorting?&lt;/p&gt;

&lt;p&gt;Anyway, you can change the limit by setting the org.mortbay.http.HttpRequest.maxFormContentSize system property.&lt;/p&gt;</comment>
                            <comment id="12614186" author="yseeley@gmail.com" created="Thu, 17 Jul 2008 02:24:36 +0100"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure why Solr is trying to send such large amounts of data to the shards though&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Specifying 40,000 ids to be retrieved I imagine.  The average id length must be over 50 bytes.&lt;/p&gt;

&lt;p&gt;Brian: if ordering isn&apos;t important for some of these big bulk queries, you might want to consider directly querying the shards.&lt;/p&gt;</comment>
                            <comment id="12614397" author="bwhitman" created="Thu, 17 Jul 2008 16:38:01 +0100"  >&lt;p&gt;Yonik, sure-- but I think we should probably handle the case better than a 500 error. maybe a solr warning about per-shard row limits?&lt;/p&gt;

&lt;p&gt;Lars &amp;#8211; I am having trouble getting that maxFormContentSize property set. I am running jetty like:&lt;/p&gt;

&lt;p&gt;/usr/local/java/bin/java -Dorg.mortbay.http.HttpRequest.maxFormContentSize=1000000 -Xmx7000m -Xms1024m -jar start.jar&lt;/p&gt;

&lt;p&gt;(I&apos;ve also tried 0 and -1, per the jetty docs this means &quot;unlimited.&quot;) &lt;/p&gt;

&lt;p&gt;but the same distributed query gives the same error. How are you setting that property?&lt;/p&gt;
</comment>
                            <comment id="12614400" author="yseeley@gmail.com" created="Thu, 17 Jul 2008 16:45:54 +0100"  >&lt;blockquote&gt;&lt;p&gt;but I think we should probably handle the case better than a 500 error. maybe a solr warning about per-shard row limits?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a jetty limit you hit, the exception was understandable, and an unknown exception like that (from solr&apos;s perspective) seems like it should map to a 500 error code.&lt;/p&gt;</comment>
                            <comment id="12614402" author="larsko" created="Thu, 17 Jul 2008 16:51:10 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think we should probably handle the case better than a 500 error. maybe a solr warning about per-shard row limits?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s specific to the configuration of your container, I think there&apos;s nothing that Solr can do about it.&lt;/p&gt;

&lt;p&gt;As for the form content size, I haven&apos;t actually tried that myself I must admit. I&apos;m running Tomcat and just got that parameter from the Jetty documentation. I&apos;d take a wiredump with something like tcpdump to see what the actual size of the request is. Maybe it&apos;s even larger than 1000000 bytes?&lt;/p&gt;</comment>
                            <comment id="12614410" author="bwhitman" created="Thu, 17 Jul 2008 17:17:16 +0100"  >&lt;p&gt;My ids are 32-character MD5s, and the break happens around 23000 rows. The maxFormContentSize doesn&apos;t seem to make any difference whether I set it or not-- with it set at 0, -1, 10000000 or not set at all I can query &amp;amp;rows=22300 but not &amp;amp;rows=22400. Obviously this is an edge case but I&apos;m posting this here for the next person who runs into this... but since I can work around it I&apos;ll stop messing with it.&lt;/p&gt;
</comment>
                            <comment id="12614602" author="larsko" created="Fri, 18 Jul 2008 03:01:32 +0100"  >&lt;p&gt;Which version of Jetty are you using? The org.mortbay.http.HttpRequest.maxFormContentSize system property seems to be specific to Jetty 5 &amp;#8211; I didn&apos;t find any information on how to set the limit with Jetty 6 (or indeed if it exists at all).&lt;/p&gt;</comment>
                            <comment id="12614708" author="bwhitman" created="Fri, 18 Jul 2008 13:19:50 +0100"  >&lt;p&gt;Lars- I&apos;m using the jetty that comes with solr-trunk, jetty-6.1.3.&lt;/p&gt;

&lt;p&gt;I found this: &lt;a href=&quot;http://webteam.archive.org/jira/browse/HER-1173#action_14736&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://webteam.archive.org/jira/browse/HER-1173#action_14736&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Which indicates the Jetty 6 concordant property is org.mortbay.jetty.Request.maxFormContentSize.&lt;/p&gt;

&lt;p&gt;I set that to 1000000, restarted my shards, and queries of &amp;amp;rows=40000 works. So for those who have this problem, start jetty with:&lt;/p&gt;

&lt;p&gt;java -Dorg.mortbay.jetty.Request.maxFormContentSize=1000000 -jar start.jar&lt;/p&gt;

&lt;p&gt;I would suggest only that the jetty.xml included in the solr example somehow get this parameter hardcoded (I don&apos;t know how personally.) I understand this is not a solr issue but it does cause a non-obvious result to an obvious query.&lt;/p&gt;

</comment>
                            <comment id="12615461" author="yseeley@gmail.com" created="Tue, 22 Jul 2008 00:00:55 +0100"  >&lt;p&gt;Closing this issue (finally!).  Specific bugs or improvements can get their own new issues.&lt;br/&gt;
Thanks to everyone who contributed to this!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12372788">SOLR-281</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12385234">SOLR-446</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12405232">SOLR-788</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12391793">SOLR-507</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12397650">SOLR-592</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12385100">SOLR-443</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12376452" name="distributed.patch" size="132006" author="yseeley@gmail.com" created="Mon, 25 Feb 2008 21:53:16 +0000"/>
                            <attachment id="12375797" name="distributed.patch" size="117097" author="yseeley@gmail.com" created="Sun, 17 Feb 2008 17:36:58 +0000"/>
                            <attachment id="12375793" name="distributed.patch" size="116105" author="yseeley@gmail.com" created="Sun, 17 Feb 2008 17:01:27 +0000"/>
                            <attachment id="12375791" name="distributed.patch" size="115822" author="yseeley@gmail.com" created="Sun, 17 Feb 2008 15:47:27 +0000"/>
                            <attachment id="12374735" name="distributed.patch" size="102678" author="yseeley@gmail.com" created="Tue, 5 Feb 2008 04:33:22 +0000"/>
                            <attachment id="12374298" name="distributed.patch" size="100809" author="yseeley@gmail.com" created="Tue, 29 Jan 2008 22:34:05 +0000"/>
                            <attachment id="12372957" name="distributed.patch" size="88723" author="yseeley@gmail.com" created="Fri, 11 Jan 2008 04:52:00 +0000"/>
                            <attachment id="12372875" name="distributed.patch" size="88723" author="yseeley@gmail.com" created="Thu, 10 Jan 2008 06:21:15 +0000"/>
                            <attachment id="12372867" name="distributed.patch" size="85345" author="yseeley@gmail.com" created="Thu, 10 Jan 2008 02:39:14 +0000"/>
                            <attachment id="12372472" name="distributed.patch" size="137911" author="yseeley@gmail.com" created="Thu, 3 Jan 2008 23:21:41 +0000"/>
                            <attachment id="12372179" name="distributed.patch" size="125685" author="yseeley@gmail.com" created="Tue, 25 Dec 2007 04:40:54 +0000"/>
                            <attachment id="12372134" name="distributed.patch" size="125152" author="yseeley@gmail.com" created="Sat, 22 Dec 2007 19:07:53 +0000"/>
                            <attachment id="12378146" name="distributed_add_tests_for_intended_behavior.patch" size="2759" author="jayson.minard" created="Tue, 18 Mar 2008 18:06:48 +0000"/>
                            <attachment id="12378136" name="distributed_facet_count_bugfix.patch" size="1527" author="jayson.minard" created="Tue, 18 Mar 2008 17:04:48 +0000"/>
                            <attachment id="12373211" name="distributed_pjaol.patch" size="94947" author="pjaol" created="Tue, 15 Jan 2008 22:55:15 +0000"/>
                            <attachment id="12371581" name="fedsearch.patch" size="138292" author="dalals" created="Thu, 13 Dec 2007 06:02:04 +0000"/>
                            <attachment id="12371501" name="fedsearch.patch" size="138611" author="dalals" created="Wed, 12 Dec 2007 10:03:48 +0000"/>
                            <attachment id="12369782" name="fedsearch.patch" size="111348" author="dalals" created="Mon, 19 Nov 2007 13:08:19 +0000"/>
                            <attachment id="12366830" name="fedsearch.patch" size="166128" author="sharad" created="Mon, 1 Oct 2007 07:52:31 +0100"/>
                            <attachment id="12365612" name="fedsearch.patch" size="88509" author="sharad" created="Wed, 12 Sep 2007 06:00:18 +0100"/>
                            <attachment id="12362862" name="fedsearch.patch" size="74186" author="sharad" created="Tue, 31 Jul 2007 10:05:09 +0100"/>
                            <attachment id="12361878" name="fedsearch.patch" size="58432" author="sharad" created="Mon, 16 Jul 2007 09:41:09 +0100"/>
                            <attachment id="12366389" name="fedsearch.stu.patch" size="96215" author="stuhood" created="Fri, 21 Sep 2007 22:35:04 +0100"/>
                            <attachment id="12366220" name="fedsearch.stu.patch" size="94591" author="stuhood" created="Wed, 19 Sep 2007 18:35:32 +0100"/>
                            <attachment id="12385455" name="shards.start_rows.patch" size="3290" author="bwhitman" created="Tue, 8 Jul 2008 01:41:07 +0100"/>
                            <attachment id="12381157" name="shards_qt.patch" size="796" author="yseeley@gmail.com" created="Wed, 30 Apr 2008 02:17:09 +0100"/>
                            <attachment id="12382364" name="solr-dist-faceting-non-ascii-all.patch" size="6234" author="larsko" created="Tue, 20 May 2008 10:32:59 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 16 Jul 2007 18:01:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7287</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxs5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20881</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>