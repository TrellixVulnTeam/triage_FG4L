<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:18:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-80/SOLR-80.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-80] negative filter queries</title>
                <link>https://issues.apache.org/jira/browse/SOLR-80</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;There is a need for negative filter queries to avoid long filter generation times and large caching requirements.&lt;/p&gt;

&lt;p&gt;Currently, if someone wants to filter out a small number of documents, they must specify the complete set of documents to express those negative conditions against.  &lt;/p&gt;

&lt;p&gt;q=foo&amp;amp;fq=id:&lt;span class=&quot;error&quot;&gt;&amp;#91;* TO *&amp;#93;&lt;/span&gt; -id:101&lt;/p&gt;

&lt;p&gt;In this example, to filter out a single document, the complete set of documents (minus one) is generated, and a large bitset is cached.  You could also add the restriction to the main query, but that doesn&apos;t work with the dismax handler which doesn&apos;t have a facility for this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12358345">SOLR-80</key>
            <summary>negative filter queries</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Dec 2006 22:59:58 +0000</created>
                <updated>Fri, 10 May 2013 11:38:44 +0100</updated>
                            <resolved>Mon, 22 Jan 2007 21:42:21 +0000</resolved>
                                                    <fixVersion>1.2</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12457565" author="yseeley@gmail.com" created="Tue, 12 Dec 2006 02:47:55 +0000"  >&lt;p&gt;One potential issue to watch out for...&lt;br/&gt;
DocSet(&quot;&lt;b&gt;:&lt;/b&gt; -id:foo&quot;)  is not the same as not(DocSet(id:foo))&lt;br/&gt;
That&apos;s normally fine, depending on how the set is used.&lt;/p&gt;</comment>
                            <comment id="12457898" author="paul.elschot@xs4all.nl" created="Tue, 12 Dec 2006 21:56:11 +0000"  >&lt;p&gt;With Lucene filters as Matchers:&lt;br/&gt;
&lt;a href=&quot;http://issues.apache.org/jira/browse/LUCENE-584&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/LUCENE-584&lt;/a&gt;&lt;br/&gt;
and  the possibility to add a Matcher to a Lucene BooleanQuery&lt;br/&gt;
as excluded for a negative filter (or as required for a positive filter),&lt;br/&gt;
this could be implemented efficiently in Lucene&apos;s BooleanQuery.&lt;/p&gt;</comment>
                            <comment id="12457904" author="hossman" created="Tue, 12 Dec 2006 22:07:55 +0000"  >
&lt;p&gt;With ConstantScoreQuery and QueryFilter it&apos;s basically possible to do any negating clauses as either a boolean clause or as a filter ... the big trade off decission really comes down to how big is the negated set, and is it worth caching independently of the main query.&lt;/p&gt;

&lt;p&gt;if you&apos;re trying to exclude only a handful of items by ID, then BooleanClauses make a lot of sense based on the way the BooleanQuery Scorers work ... but if you are trying to exclude 9/10ths of the documents in your index using a complicated query expression, it starts being more worth while to generate that set once and cache it for reuse as a Filter &amp;#8211; but there are still trade off questions to be asked about wether or not caching the set -A is as efficient as caching the set A (from a memory standpoint)&lt;/p&gt;
</comment>
                            <comment id="12465857" author="yseeley@gmail.com" created="Thu, 18 Jan 2007 20:15:09 +0000"  >&lt;p&gt;From an interface point of view, I&apos;m heavily leaning toward getting rid of the restriction of lucene queries having to be all negative.  This would allow using a negative-only query anywhere one currently can use a positive query.&lt;/p&gt;

&lt;p&gt;One could simply and naturally do fq=-id:10 to filter out a single document.&lt;/p&gt;</comment>
                            <comment id="12466307" author="yseeley@gmail.com" created="Sun, 21 Jan 2007 07:33:23 +0000"  >&lt;p&gt;attached draft (it doesn&apos;t work yet, and there isn&apos;t any test code).&lt;/p&gt;</comment>
                            <comment id="12466365" author="yseeley@gmail.com" created="Sun, 21 Jan 2007 22:05:25 +0000"  >&lt;p&gt;New working version attached with tests.&lt;br/&gt;
Negative queries (like -id:10) should now work everywhere for filters and queries.&lt;/p&gt;</comment>
                            <comment id="12466395" author="klaasm" created="Mon, 22 Jan 2007 06:20:10 +0000"  >&lt;p&gt;Took a close look at the patch and I think it all looks good!&lt;/p&gt;

&lt;p&gt;The query==absQuery test for query negativity reads just mysteriously enough that it might be worth putting in a small comment when it is used (or at least once in SOlrIndexSearch.java).&lt;/p&gt;</comment>
                            <comment id="12466576" author="yseeley@gmail.com" created="Mon, 22 Jan 2007 21:42:21 +0000"  >&lt;p&gt;committed.&lt;br/&gt;
Thanks for the review Mike!&lt;/p&gt;</comment>
                            <comment id="12466607" author="hossman" created="Tue, 23 Jan 2007 01:20:35 +0000"  >&lt;p&gt;i think there may be a caching bugwith this... if you load up the example schema, populate it, and then stop/start the port so all of the caches are empty, and hit this URL...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select/?q=cat%3Aelectronics&amp;amp;version=2.2&amp;amp;start=0&amp;amp;fl=score,name&amp;amp;fq=samsung&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select/?q=cat%3Aelectronics&amp;amp;version=2.2&amp;amp;start=0&amp;amp;fl=score,name&amp;amp;fq=samsung&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;you see that the lookup/insert/size for both the queryResultsCache and filterCaches are 1 (as expected)&lt;/p&gt;

&lt;p&gt;if you then hit this URL...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select/?q=cat%3Aelectronics&amp;amp;version=2.2&amp;amp;start=0&amp;amp;fl=score,name&amp;amp;fq=-samsung&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select/?q=cat%3Aelectronics&amp;amp;version=2.2&amp;amp;start=0&amp;amp;fl=score,name&amp;amp;fq=-samsung&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;the queryResultCache changes predictably to a size of 2 (because the filters are part of the cache key) but the size of the filterCache has also grown to 2 ... which doesn&apos;t make sense since the patch is suppose to be caching the inverse of negative queries (fq=samsung and fq=-samsung should be a cahce hit right?)&lt;/p&gt;

&lt;p&gt;if you stop/start the port and only hit this URL...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select/?q=cat%3Aelectronics&amp;amp;version=2.2&amp;amp;start=0&amp;amp;fl=score,name&amp;amp;fq=-samsung&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select/?q=cat%3Aelectronics&amp;amp;version=2.2&amp;amp;start=0&amp;amp;fl=score,name&amp;amp;fq=-samsung&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...you&apos;ll see that the filterCache gets 2 lookups, and 2 insertions.&lt;/p&gt;


&lt;p&gt;I wouldn&apos;t think this is wrong, except that the patch explicitly says &quot;// cache negative queries as positive&quot;&lt;/p&gt;
</comment>
                            <comment id="12466611" author="yseeley@gmail.com" created="Tue, 23 Jan 2007 01:39:28 +0000"  >&lt;p&gt;You are seeing a MatchAllDocsQuery filter.&lt;/p&gt;

&lt;p&gt;If getDocSet(List&amp;lt;Query&amp;gt;) is called with a single negative query, or&lt;br/&gt;
 or getDocSet(Query, Filter) is called with a null filter and a negative query, we call getDocSet(MatchAllDocsQuery)&lt;br/&gt;
to use as a base to andNot the passed query.&lt;/p&gt;

&lt;p&gt;If you continue your example with fq=+memory and fq=-memory, you will see what you expect (only one new filter).&lt;/p&gt;</comment>
                            <comment id="12466612" author="klaasm" created="Tue, 23 Jan 2007 01:39:33 +0000"  >&lt;p&gt;I think this is due to the last line of this fragment of the patch:&lt;/p&gt;

&lt;p&gt;   protected DocSet getDocSet(List&amp;lt;Query&amp;gt; queries) throws IOException {&lt;br/&gt;
+    if (queries==null) return null;&lt;br/&gt;
+    if (queries.size()==1) return getDocSet(queries.get(0));&lt;br/&gt;
     DocSet answer=null;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (queries==null) return null;&lt;/li&gt;
	&lt;li&gt;for (Query q : queries) {&lt;/li&gt;
	&lt;li&gt;if (answer==null) {&lt;/li&gt;
	&lt;li&gt;answer = getDocSet(q);&lt;br/&gt;
+&lt;br/&gt;
+    boolean[] neg = new boolean&lt;span class=&quot;error&quot;&gt;&amp;#91;queries.size()&amp;#93;&lt;/span&gt;;&lt;br/&gt;
+    DocSet[] sets = new DocSet&lt;span class=&quot;error&quot;&gt;&amp;#91;queries.size()&amp;#93;&lt;/span&gt;;&lt;br/&gt;
+&lt;br/&gt;
+    int smallestIndex = -1;&lt;br/&gt;
+    int smallestCount = Integer.MAX_VALUE;&lt;br/&gt;
+    for (int i=0; i&amp;lt;sets.length; i++) {&lt;br/&gt;
+      Query q = queries.get&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
+      Query posQuery = QueryUtils.getAbs(q);&lt;br/&gt;
+      sets&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = getPositiveDocSet(posQuery);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;getPositiveDocSet() caches all docsets returned, so both the query part and the filter part would be cached in the filterCache.&lt;/p&gt;</comment>
                            <comment id="12466616" author="hossman" created="Tue, 23 Jan 2007 01:51:42 +0000"  >&lt;p&gt;I was strating to think the same thing as Mike: but doing more testing i seee what yonik&apos;s refering to (note to self: test more then one query when doing cache testing) ... only the first use of a negative query results in the double insert .. afterthat every thing is golden.&lt;/p&gt;

&lt;p&gt;Mike: i think the key is that unless faceting is turned on, the StandardRequestHandler only calls getDocList, not getDocListAndSet ... so by the time the call makes it to getDocListC the falgs never contain GET_DOCSET, so the main query isn&apos;t included in the list passed to getDocSet.&lt;/p&gt;</comment>
                            <comment id="12466617" author="klaasm" created="Tue, 23 Jan 2007 01:51:55 +0000"  >&lt;p&gt;Surely Hoss&apos; example doesn&apos;t use matchAllDocs--he has a positive query in both cases.&lt;/p&gt;</comment>
                            <comment id="12466621" author="klaasm" created="Tue, 23 Jan 2007 01:56:56 +0000"  >&lt;p&gt;Hoss: thanks for the explanation.  &lt;/p&gt;

&lt;p&gt;I might throw this in our production code this week and see how it fares.&lt;/p&gt;</comment>
                            <comment id="12589314" author="hossman" created="Wed, 16 Apr 2008 00:44:45 +0100"  >&lt;p&gt;This bug was modified as part of a bulk update using the criteria...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Marked (&quot;Resolved&quot; or &quot;Closed&quot;) and &quot;Fixed&quot;&lt;/li&gt;
	&lt;li&gt;Had no &quot;Fix Version&quot; versions&lt;/li&gt;
	&lt;li&gt;Was listed in the CHANGES.txt for 1.2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The Fix Version for all 39 issues found was set to 1.2, email notification&lt;br/&gt;
was suppressed to prevent excessive email.&lt;/p&gt;

&lt;p&gt;For a list of all the issues modified, search jira comments for this&lt;br/&gt;
(hopefully) unique string: 20080415hossman2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12349349" name="negative_filters.patch" size="20911" author="yseeley@gmail.com" created="Sun, 21 Jan 2007 22:02:54 +0000"/>
                            <attachment id="12349327" name="negative_filters.patch" size="11426" author="yseeley@gmail.com" created="Sun, 21 Jan 2007 07:32:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 12 Dec 2006 21:56:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7502</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxtiv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21102</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>