<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:16:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-617/SOLR-617.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-617] Allow configurable deletion policy</title>
                <link>https://issues.apache.org/jira/browse/SOLR-617</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Lucene API provides means to configure deletion policy. Solr should be able to expose it through configuration in solrconfig.xml. Moreover the new replication (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-561&quot; title=&quot;Solr replication by Solr (for windows also)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-561&quot;&gt;&lt;del&gt;SOLR-561&lt;/del&gt;&lt;/a&gt;) strategy is going to rely on this .&lt;/p&gt;

&lt;p&gt;I propose the configuration go into the &amp;lt;mainIndex&amp;gt;  section&lt;/p&gt;

&lt;p&gt;sample configuration&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;solrconfig.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;mainIndex&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!-- configure deletion policy here--&amp;gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;deletionPolicy&amp;gt;&lt;/span&gt;
       &amp;lt;!-- Store only the commits with optimize.Non optimized commits will get deleted by lucene when 
               the last IndexWriter/IndexReader using this commit point is closed  --&amp;gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;keepOptimizedOnly&amp;gt;&lt;/span&gt;true&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/keepOptimizedOnly&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!--Maximum no: of commit points stored . Older ones will be cleaned when they go out of scope--&amp;gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;maxCommitsToKeep&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/maxCommitsToKeep&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!-- max age of a stored commit--&amp;gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;maxCommitAge&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/maxCommitAge&amp;gt;&lt;/span&gt;    
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/deletionPolicy&amp;gt;&lt;/span&gt;
    
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/mainIndex&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</description>
                <environment></environment>
        <key id="12399693">SOLR-617</key>
            <summary>Allow configurable deletion policy</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalinmangar">Shalin Shekhar Mangar</assignee>
                                    <reporter username="noble.paul">Noble Paul</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jul 2008 07:18:52 +0100</created>
                <updated>Thu, 2 May 2013 03:29:15 +0100</updated>
                            <resolved>Mon, 29 Sep 2008 04:38:14 +0100</resolved>
                                    <version>1.4</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>search</component>
                    <component>update</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12625339" author="akshay" created="Mon, 25 Aug 2008 13:50:21 +0100"  >&lt;p&gt;This patch adds support for the configuration described in the issue description.&lt;/p&gt;</comment>
                            <comment id="12626572" author="shalinmangar" created="Thu, 28 Aug 2008 15:11:15 +0100"  >&lt;p&gt;Thanks for the patch Akshay!&lt;/p&gt;

&lt;p&gt;I think we should allow a user to specify his custom IndexDeletionPolicy too. We can provide a default implementation with all the options specified in the issue description. So I propose that we have the following syntax:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;deletionPolicy class=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.MyDeletionPolicy&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The default implementation will be SolrIndexDeletionPolicy which can be configured through a NamedList. Any custom deletion policy will be initialized with a NamedList if it implements NamedListInitializedPlugin.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!-- configure deletion policy here--&amp;gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;deletionPolicy class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.SolrIndexDeletionPolicy&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &amp;lt;!--  Store only the commits with optimize.Non optimized commits will get deleted by lucene when
            the last IndexWriter/IndexReader using this commit point is closed  --&amp;gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;keepOptimizedOnly&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;true&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!--Maximum no: of commit points stored . Older ones will be cleaned when they go out of scope--&amp;gt;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;maxCommitsToKeep&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!-- max age of a stored commit--&amp;gt;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;maxCommitAge&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/deletionPolicy&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To facilitate replication, we can have a wrapper over the IndexDeletionPolicy which can provide us the features needed for replication (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-561&quot; title=&quot;Solr replication by Solr (for windows also)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-561&quot;&gt;&lt;del&gt;SOLR-561&lt;/del&gt;&lt;/a&gt;). We need access to a list of non-deleted IndexCommit instances, a way to lookup IndexCommit given a version as well as the latest commit point. &lt;/p&gt;</comment>
                            <comment id="12627510" author="akshay" created="Mon, 1 Sep 2008 19:17:33 +0100"  >&lt;p&gt;Attached is a patch with SolrDeletionPolicy class as the default deletion policy, with configuration as in Shalin&apos;s comment above, except that &amp;lt;str&amp;gt; is used for all the parameters in the named list. IndexDeletionPolicyWrapper class over IndexDeletionPolicy to enable access to commit details. Currently &amp;lt;maxCommitAge&amp;gt; named list parameter is not considered in the implementation of SolrDeletionPolicy.&lt;/p&gt;</comment>
                            <comment id="12627640" author="shalinmangar" created="Tue, 2 Sep 2008 12:58:45 +0100"  >&lt;p&gt;This is looking great. Thanks!&lt;/p&gt;

&lt;p&gt;We need a few tests for this. With the recent changes in Lucene trunk, we can get rid of the wrapper over IndexCommit. We need to support maxCommitAge too so that users who do a lot commits can reliably replicate without storing too many generations.&lt;/p&gt;</comment>
                            <comment id="12627750" author="yseeley@gmail.com" created="Tue, 2 Sep 2008 18:17:21 +0100"  >&lt;p&gt;I think the deletion policy should be able to support true reservation... see the prototype patch I put together in &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12383728/deletion_policy.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12383728/deletion_policy.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Lucene has added more capabilities since then, so we should be able to simplify it.&lt;/p&gt;</comment>
                            <comment id="12627770" author="shalinmangar" created="Tue, 2 Sep 2008 19:12:24 +0100"  >&lt;p&gt;We have two options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Do not reserve a commit point &amp;#8211; If it gets deleted due to a newer commit, let an in-flight replication fail so that the slave re-polls and gets a fresher commit point.&lt;/li&gt;
	&lt;li&gt;Let an in-flight replication reserve a commit point &amp;#8211; The slave would start another replication immediately after the previous one because the master now has a newer commit point that what it had just pulled.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;m more in favor of the first approach. Here, the onus of keeping a commit point for reliable replication will fall on the user supplying configuration according to his commit frequency (the maxAge condition will be handy).&lt;/p&gt;

&lt;p&gt;Also, wouldn&apos;t implementing a reserve method limit us to only the default SolrDeletionPolicy?&lt;/p&gt;</comment>
                            <comment id="12627881" author="yseeley@gmail.com" created="Wed, 3 Sep 2008 02:06:16 +0100"  >&lt;p&gt;#1 and #2 can both lead to starvation.  I think the default should finish grabbing an index even if a newer version is available.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Here, the onus of keeping a commit point for reliable replication will fall on the user supplying configuration&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we can make it such that it just works, regardless of network speed, index size, etc, then I think we should.  A reservation mechanism would easily enable this.&lt;/p&gt;</comment>
                            <comment id="12627900" author="noble.paul" created="Wed, 3 Sep 2008 05:49:02 +0100"  >&lt;p&gt;The IndexDeletionPolicyWrapper should be able to support the reserve feature even if the user provided IndexDeletionPolicy does not do it because it is wrapping the IndexCommit object. &lt;br/&gt;
the config can be as follows&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &amp;lt;deletionPolicy class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.SolrIndexDeletionPolicy&quot;&lt;/span&gt; &amp;gt;
    &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; value will be honoured by the wrapper itself irrespective of the underlying implementation
&lt;/span&gt;     &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;reserve&quot;&lt;/span&gt;&amp;gt;10&amp;lt;/str&amp;gt;
&amp;lt;/deletionPolicy&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12629159" author="akshay" created="Mon, 8 Sep 2008 14:38:12 +0100"  >&lt;p&gt;Patch synced with trunk.&lt;/p&gt;</comment>
                            <comment id="12633649" author="akshay" created="Tue, 23 Sep 2008 08:54:18 +0100"  >&lt;p&gt;This patch has:&lt;br/&gt;
1. maxCommitAge configuration support&lt;br/&gt;
2. Reservation mechanism is added in the ReplicationHandler configuration. Code for the same is in the latest patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-561&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-561&lt;/a&gt;&lt;br/&gt;
3. Test cases.&lt;/p&gt;</comment>
                            <comment id="12634258" author="shalinmangar" created="Wed, 24 Sep 2008 20:03:12 +0100"  >&lt;p&gt;The patch looks good. I think this covers all the features we wanted to have.&lt;/p&gt;

&lt;p&gt;A few minor nitpicks&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The latestCommit and maxCommitAgeMillis variables in SolrDeletionPolicy are assigned but never used.&lt;/li&gt;
	&lt;li&gt;The additional logging in onInit and onCommit in SolrDeletionPolicy can be removed &amp;#8211; the same message is logged in FINE and INFO both&lt;/li&gt;
	&lt;li&gt;The defaults in solrconfig.xml should mimic the previous behavior i.e. keep only the last commit point&lt;/li&gt;
	&lt;li&gt;Javadocs on IndexDeletionPolicyWrapper#setReserveDuration will be helpful&lt;/li&gt;
	&lt;li&gt;IndexDeletionPolicyWrapper#getCommits should return the generic version of the Map&lt;/li&gt;
	&lt;li&gt;IndexDeletionPolicyWrapper#getConfiguredDeletionPolicy can be called getWrappedDeletionPolicy or just getDeletionPolicy&lt;/li&gt;
	&lt;li&gt;Slight mistake in the logging, the info message should be in the same block
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(keepOptimizedOnly){
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!commit.isOptimized())
            commit.delete();
          log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Marking unoptimized index &quot;&lt;/span&gt;+getId(commit)+ &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deletion.&quot;&lt;/span&gt;);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;The getter methods in SolrDeletionPolicy should be named more appropriately e.g. isKeepOptimizedOnly, getMaxCommitAge, getMaxCommitsToKeep&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The tests look good. Thanks for all the work, Akshay &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12634264" author="shalinmangar" created="Wed, 24 Sep 2008 20:34:06 +0100"  >&lt;p&gt;Also, we need to use slf4j instead of the JDK Logger in the patch.&lt;/p&gt;</comment>
                            <comment id="12634972" author="akshay" created="Fri, 26 Sep 2008 20:13:16 +0100"  >&lt;p&gt;Patch with changes suggested by Shalin and logging using slf4j.&lt;/p&gt;</comment>
                            <comment id="12635023" author="shalinmangar" created="Fri, 26 Sep 2008 22:15:56 +0100"  >&lt;p&gt;Updated with more javadocs and comments in solrconfig.xml&lt;/p&gt;

&lt;p&gt;I think this is ready to go in. I&apos;ll commit this in a day or two if there are no objection.&lt;/p&gt;</comment>
                            <comment id="12635278" author="shalinmangar" created="Mon, 29 Sep 2008 04:38:14 +0100"  >&lt;p&gt;Committed revision 699975.&lt;/p&gt;

&lt;p&gt;Thanks Yonik, Noble and Akshay!&lt;/p&gt;</comment>
                            <comment id="12775512" author="gsingers" created="Tue, 10 Nov 2009 15:51:43 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12395304">SOLR-561</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12389306" name="617.patch" size="19173" author="akshay" created="Mon, 1 Sep 2008 19:17:33 +0100"/>
                            <attachment id="12391055" name="solr-617.patch" size="66236" author="shalinmangar" created="Fri, 26 Sep 2008 22:15:56 +0100"/>
                            <attachment id="12391044" name="solr-617.patch" size="55456" author="akshay" created="Fri, 26 Sep 2008 20:13:16 +0100"/>
                            <attachment id="12390723" name="solr-617.patch" size="56402" author="akshay" created="Tue, 23 Sep 2008 08:54:18 +0100"/>
                            <attachment id="12389677" name="solr-617.patch" size="18943" author="akshay" created="Mon, 8 Sep 2008 14:38:12 +0100"/>
                            <attachment id="12388842" name="solr-617.patch" size="19824" author="akshay" created="Mon, 25 Aug 2008 13:50:21 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 25 Aug 2008 12:50:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6994</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxq8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20571</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>