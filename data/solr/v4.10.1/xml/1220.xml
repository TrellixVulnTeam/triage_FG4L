<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:17:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-1220/SOLR-1220.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-1220] UnInvertedField performance improvement on fields with an extremely large number of values</title>
                <link>https://issues.apache.org/jira/browse/SOLR-1220</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Our setup is :&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;about 34M lucene documents of bibliographic and full text content&lt;/li&gt;
	&lt;li&gt;index currently 115GB, will at least double over next 6 months&lt;/li&gt;
	&lt;li&gt;moving to support real-time-ish updates (maybe 5 min delay)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We facet on 8 fields, 6 of which are &quot;normal&quot; with small numbers of&lt;br/&gt;
distinct values.  But 2 faceted fields, creator and subject, are huge,&lt;br/&gt;
with 18M and 9M terms respectively.  &lt;/p&gt;

&lt;p&gt;On a server with 2xquad core AMD 2382 processors and 64GB memory, java&lt;br/&gt;
1.6.0_13-b03, 64 bit run with &quot;-Xmx15192M -Xms6000M -verbose:gc&quot;, with&lt;br/&gt;
the index on Intel X25M SSD, on start-up the elapsed time to create&lt;br/&gt;
the 8 facets is 306 seconds (best time).  Following an index reopen,&lt;br/&gt;
the time to recreate them in 318 seconds (best time).&lt;/p&gt;

&lt;p&gt;[We have made an independent experimental change to create the facets&lt;br/&gt;
with 3 async threads, that is, in parallel, and also to decouple them&lt;br/&gt;
from the underlying index, so our facets lag the index changes by the&lt;br/&gt;
time to recreate the facets.  With our setup, the 3 threads reduced&lt;br/&gt;
facet creation elapsed time from about 450 secs to around 320 secs,&lt;br/&gt;
but this will depend a lot on IO capabilities of the device containing&lt;br/&gt;
the index, amount of file system caching, load, etc]&lt;/p&gt;

&lt;p&gt;Anyway, we noticed that huge amounts of garbage were being collected&lt;br/&gt;
during facet generation of the creator and subject fields, and tracked&lt;br/&gt;
it down to this decision in UnInvertedField univert():&lt;/p&gt;

&lt;p&gt;     if (termNum &amp;gt;= maxTermCounts.length) &lt;/p&gt;
{
       // resize, but conserve memory by not doubling
       // resize at end??? we waste a maximum of 16K (average of 8K)
       int[] newMaxTermCounts = new int[maxTermCounts.length+4096];
       System.arraycopy(maxTermCounts, 0, newMaxTermCounts, 0, termNum);
       maxTermCounts = newMaxTermCounts;
     }

&lt;p&gt;So, we tried the obvious thing:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;allocate 10K terms initially, rather than 1K&lt;/li&gt;
	&lt;li&gt;extend by doubling the current size, rather than adding a fixed 4K&lt;/li&gt;
	&lt;li&gt;free unused space at the end (but only if unused space is&lt;br/&gt;
&quot;significant&quot;) by reallocating the array to the exact required size&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And also:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;created a static HashMap lookup keyed on field name which remembers&lt;br/&gt;
the previous allocated size for maxTermCounts for that field, and&lt;br/&gt;
initially allocates that size + 1000 entries&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The second change is a minor optimisation, but the first change, by&lt;br/&gt;
eliminating thousands of array reallocations and copies, greatly&lt;br/&gt;
improved load times, down from 306 to 124 seconds on the initial load&lt;br/&gt;
and from 318 to 134 seconds on reloads after index updates.  About&lt;br/&gt;
60-70 secs is still spend in GC, but it is a significant improvement.&lt;/p&gt;

&lt;p&gt;Unless you have very large numbers of facet values, this change won&apos;t&lt;br/&gt;
have any positive benefit.&lt;/p&gt;

&lt;p&gt;The core part of our change is reflected by this diff against revision 785058:&lt;/p&gt;

&lt;p&gt;***************&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;222,232 ****&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;        int termNum = te.getTermNumber();&lt;/p&gt;

&lt;p&gt;        if (termNum &amp;gt;= maxTermCounts.length) &lt;/p&gt;
{
!         // resize, but conserve memory by not doubling
!         // resize at end??? we waste a maximum of 16K (average of 8K)
!         int[] newMaxTermCounts = new int[maxTermCounts.length+4096];
          System.arraycopy(maxTermCounts, 0, newMaxTermCounts, 0, termNum);
          maxTermCounts = newMaxTermCounts;
        }

&lt;p&gt;&amp;#8212; 222,232 ----&lt;/p&gt;

&lt;p&gt;        int termNum = te.getTermNumber();&lt;/p&gt;

&lt;p&gt;        if (termNum &amp;gt;= maxTermCounts.length) &lt;/p&gt;
{
!         // resize by doubling - for very large number of unique terms, expanding
!         // by 4K and resultant GC will dominate uninvert times.  Resize at end if material
!         int[] newMaxTermCounts = new int[maxTermCounts.length*2];
          System.arraycopy(maxTermCounts, 0, newMaxTermCounts, 0, termNum);
          maxTermCounts = newMaxTermCounts;
        }

&lt;p&gt;***************&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;331,338 ****&lt;/li&gt;
		&lt;/ul&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;331,346 ----&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;      numTermsInField = te.getTermNumber();&lt;br/&gt;
      te.close();&lt;/p&gt;

&lt;p&gt;+     // free space if outrageously wasteful (tradeoff memory/cpu)&lt;br/&gt;
+&lt;br/&gt;
+     if ((maxTermCounts.length - numTermsInField) &amp;gt; 1024) &lt;/p&gt;
{ // too much waste!
+       int[] newMaxTermCounts = new int[numTermsInField];
+       System.arraycopy(maxTermCounts, 0, newMaxTermCounts, 0, numTermsInField);
+       maxTermCounts = newMaxTermCounts;
+    }
&lt;p&gt;+&lt;br/&gt;
      long midPoint = System.currentTimeMillis();&lt;/p&gt;

&lt;p&gt;      if (termInstances == 0) {&lt;br/&gt;
        // we didn&apos;t invert anything&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12427961">SOLR-1220</key>
            <summary>UnInvertedField performance improvement on fields with an extremely large number of values</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kent fitch">Kent Fitch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jun 2009 04:32:16 +0100</created>
                <updated>Tue, 10 Nov 2009 15:52:08 +0000</updated>
                            <resolved>Tue, 16 Jun 2009 16:41:52 +0100</resolved>
                                    <version>1.4</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12719924" author="yseeley@gmail.com" created="Tue, 16 Jun 2009 05:50:20 +0100"  >&lt;p&gt;Thanks Kent, but the patch was mangled by JIRA.&lt;br/&gt;
The normal procedure is to do an &quot;svn diff &amp;gt; SOLR-NNN.patch&quot; and attach that file to the issue via &quot;attachFile&quot;.&lt;br/&gt;
That also allows you to click the &quot;grant license to ASF&quot; button to help us with our intellectual property tracking.&lt;/p&gt;</comment>
                            <comment id="12719952" author="kent fitch" created="Tue, 16 Jun 2009 08:00:42 +0100"  >&lt;p&gt;Hi Yonik, attached patch as requested&lt;/p&gt;</comment>
                            <comment id="12720195" author="yseeley@gmail.com" created="Tue, 16 Jun 2009 16:41:52 +0100"  >&lt;p&gt;Committed. Thanks Kent!&lt;/p&gt;

&lt;p&gt;A future little optimization could collect a list of byte[] for maxTermCount and then do a single resize at the end.&lt;/p&gt;</comment>
                            <comment id="12775773" author="gsingers" created="Tue, 10 Nov 2009 15:52:08 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12410760" name="Udiff.txt" size="1354" author="kent fitch" created="Tue, 16 Jun 2009 07:58:47 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 16 Jun 2009 04:50:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6428</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxmkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19977</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>