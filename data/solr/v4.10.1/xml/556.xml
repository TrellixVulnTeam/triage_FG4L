<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:16:48 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-556/SOLR-556.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-556] Highlighting of multi-valued fields returns snippets which span multiple different values</title>
                <link>https://issues.apache.org/jira/browse/SOLR-556</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When highlighting multi-valued fields, the highlighter sometimes returns snippets which span multiple values, e.g. with values &quot;foo&quot; and &quot;bar&quot; and search term &quot;ba&quot; the highlighter will create the snippet &quot;foo&amp;lt;em&amp;gt;ba&amp;lt;/em&amp;gt;r&quot;. Furthermore it sometimes returns smaller snippets than it should, e.g. with value &quot;foobar&quot; and search term &quot;oo&quot; it will create the snippet &quot;&amp;lt;em&amp;gt;oo&amp;lt;/em&amp;gt;&quot; regardless of hl.fragsize.&lt;/p&gt;

&lt;p&gt;I have been unable to determine the real cause for this, or indeed what actually goes on at all. To reproduce the problem, I&apos;ve used the following steps:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;create an index with multi-valued fields, one document should have at least 3 values for these fields (in my case strings of length between 5 and 15 Japanese characters &amp;#8211; as far as I can tell plain old ASCII should produce the same effect though)&lt;/li&gt;
	&lt;li&gt;search for part of a value in such a field with highlighting enabled, the additional parameters I use are hl.fragsize=70, hl.requireFieldMatch=true, hl.mergeContiguous=true (changing the parameters does not seem to have any effect on the result though)&lt;/li&gt;
	&lt;li&gt;highlighted snippets should show effects described above&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Tomcat 5.5&lt;/p&gt;</environment>
        <key id="12395185">SOLR-556</key>
            <summary>Highlighting of multi-valued fields returns snippets which span multiple different values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klaasm">Mike Klaas</assignee>
                                    <reporter username="larsko">Lars Kotthoff</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 May 2008 10:41:47 +0100</created>
                <updated>Fri, 25 Jul 2008 03:01:29 +0100</updated>
                            <resolved>Tue, 8 Jul 2008 00:53:36 +0100</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.3</fixVersion>
                                    <component>highlighter</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12593753" author="larsko" created="Fri, 2 May 2008 10:45:36 +0100"  >&lt;p&gt;Patch against SVN HEAD to treat multi valued fields like single valued fields when highlighting by looping over the field values and accumulating the highlighted snippets.&lt;/p&gt;

&lt;p&gt;This corrects the behaviour I&apos;ve described and simplifies the code. The downside is that it may impose a performance penalty for large numbers of snippets. The code breaks out of the loop when enough snippets have been found without considering the other values of the fields, which means that the returned snippets may not be the best ones.&lt;/p&gt;</comment>
                            <comment id="12595104" author="larsko" created="Thu, 8 May 2008 02:14:32 +0100"  >&lt;p&gt;The previous patch caused ArrayIndexOutOfBoundsExceptions in some cases. This is corrected with this patch.&lt;/p&gt;</comment>
                            <comment id="12596925" author="otis" created="Wed, 14 May 2008 21:20:33 +0100"  >&lt;p&gt;Lars - could you please try the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-553&quot; title=&quot;Highlighter does not match phrase queries correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-553&quot;&gt;&lt;del&gt;SOLR-553&lt;/del&gt;&lt;/a&gt; and see if it fixes the problem you described here?&lt;/p&gt;</comment>
                            <comment id="12596999" author="larsko" created="Thu, 15 May 2008 05:25:38 +0100"  >&lt;p&gt;I&apos;ve applied &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-553&quot; title=&quot;Highlighter does not match phrase queries correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-553&quot;&gt;&lt;del&gt;SOLR-553&lt;/del&gt;&lt;/a&gt; and confirmed that this problem is not fixed, regardless of the setting of usePhraseHighlighter.&lt;/p&gt;</comment>
                            <comment id="12597010" author="larsko" created="Thu, 15 May 2008 06:15:22 +0100"  >&lt;p&gt;Attaching test file with example document, relevant part of schema.xml and example query.&lt;/p&gt;</comment>
                            <comment id="12597226" author="klaasm" created="Thu, 15 May 2008 19:50:43 +0100"  >&lt;p&gt;Thanks for the report, Lars.  I&apos;ll take a look at this shortly.&lt;/p&gt;</comment>
                            <comment id="12598935" author="larsko" created="Thu, 22 May 2008 08:41:21 +0100"  >&lt;p&gt;Attaching new patch which checks the fragments returned by Lucene properly. The getBestTextFragments method sometimes returns fragments which do not contain the search term at all (with a score of 0), which I wasn&apos;t aware of. The new patch checks whether the score of a fragment is &amp;gt; 0 before adding it to the list of fragments. It also removes the intermediate list of TextFragments and only accumulates a list of Strings, since this is the only information that&apos;s returned anyway.&lt;/p&gt;

&lt;p&gt;With the new patch the unit tests (which I finally convinced to run at all in Eclipse) succeed.&lt;/p&gt;</comment>
                            <comment id="12598944" author="larsko" created="Thu, 22 May 2008 09:32:27 +0100"  >&lt;p&gt;Sorry for all the noise. Attaching yet another new version of the patch which makes sure that for multi-valued field the &lt;b&gt;best&lt;/b&gt; fragments are returned, rather than the &lt;b&gt;first&lt;/b&gt; fragments with score &amp;gt; 0 as before.&lt;/p&gt;

&lt;p&gt;Added a unit test to verify this behaviour.&lt;/p&gt;</comment>
                            <comment id="12602541" author="klaasm" created="Thu, 5 Jun 2008 06:04:39 +0100"  >&lt;p&gt;Ah, I see what the problem is:  Although it is impossible for tokens from different values to appear in the same fragment (due to the semantics of MultiValuedTokenFilter), the non-token text (typically, punctuation) from different values can bleed into the same fragment, since lucene&apos;s highlighter can only create a new fragment on token boundaries.&lt;/p&gt;

&lt;p&gt;Unfortunately &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-553&quot; title=&quot;Highlighter does not match phrase queries correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-553&quot;&gt;&lt;del&gt;SOLR-553&lt;/del&gt;&lt;/a&gt; was committed a day after you submitted your patch, and rearranges the code slightly so that it no longer applies.  Could you sync the patch with trunk?  I think the basic approach is sound.&lt;/p&gt;</comment>
                            <comment id="12602571" author="larsko" created="Thu, 5 Jun 2008 08:43:44 +0100"  >&lt;p&gt;Attaching new patch which should apply cleanly to current HEAD. Also verified that it doesn&apos;t break anything fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-553&quot; title=&quot;Highlighter does not match phrase queries correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-553&quot;&gt;&lt;del&gt;SOLR-553&lt;/del&gt;&lt;/a&gt; by running the unit test.&lt;/p&gt;</comment>
                            <comment id="12603780" author="klaasm" created="Tue, 10 Jun 2008 07:09:48 +0100"  >&lt;p&gt;Thanks for the patch, Lars.  I think that the basic approach is sound, though I am a little nervous about the performance implications (especially in the case of phrase highlighting, where we spin up an entirely new spanhighlighter for each value in a multi-valued field).  I wonder if I am the only one who highlights large text fields composed of dozens of individual values?&lt;/p&gt;

</comment>
                            <comment id="12603782" author="larsko" created="Tue, 10 Jun 2008 07:20:49 +0100"  >&lt;p&gt;In the setup I&apos;ve been testing it with (one large single-valued &quot;text&quot; field and several multi-valued fields) it didn&apos;t seem to have any serious performance implications &amp;#8211; i.e. the randomness of my test queries was enough to mask any loss of performance &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
The length of the multi-valued fields is in the order of 10-20 characters on average though and there&apos;re not many multiple different values.&lt;/p&gt;

&lt;p&gt;I personally think that returning correct data is more important than performance in this case, but that may just be because my particular setup doesn&apos;t suffer any significant loss of performance. I didn&apos;t see any other way to correct the behaviour of the current trunk code, but if anybody else has a better idea how to do it, please let us know!&lt;/p&gt;</comment>
                            <comment id="12603785" author="klaasm" created="Tue, 10 Jun 2008 07:27:54 +0100"  >&lt;p&gt;Hey Lars,&lt;/p&gt;

&lt;p&gt;Yeah, I&apos;m talking about highlighting 15kB of text in 100-200 character chunks.  Maybe I can whip up a perf test for this soon.&lt;/p&gt;

&lt;p&gt;The reason we probably see this issue differently is that the incorrect behaviour is quite minor for most users (perhaps a bit of punctuation leaking from value to value at most).  Once way to correct what you are seeing is to use a tokenizer that creates tokens out of the CJK characters, or things on boundaries.  In your case, inserting a fake token when encountering a right bracket &lt;span class=&quot;error&quot;&gt;&amp;#91;)&amp;#93;&lt;/span&gt; would fix the problem, I think.&lt;/p&gt;

&lt;p&gt;Nevertheless, I think I will probably end up committing your patch after pondering it some more.&lt;/p&gt;
</comment>
                            <comment id="12603787" author="larsko" created="Tue, 10 Jun 2008 07:38:33 +0100"  >&lt;p&gt;Hi Mike,&lt;/p&gt;

&lt;p&gt;In my opinion the most important reason for committing the patch is that the current implementation breaks the multi-valued field abstraction. There&apos;s no way to assert that tokenizers will always produce tokens suitable for the current implementation. It also makes for a very hard to find bug, because there&apos;re no error messages. I just found it by chance. And even if you notice that something is wrong, fixing it is non-trivial and requires quite some knowlegde how Solr does highlighting of multi-valued fields.&lt;/p&gt;

&lt;p&gt;So the other option is to add a page to the wiki with a workaround like you&apos;ve suggested, but I think that&apos;s rather going to scare people evaluating Solr for use with CJK text away &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12611407" author="klaasm" created="Tue, 8 Jul 2008 00:53:36 +0100"  >&lt;p&gt;committed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-610&quot; title=&quot;Add support for hl.maxAnalyzedChars=-1 to highlight the whole field&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-610&quot;&gt;&lt;del&gt;SOLR-610&lt;/del&gt;&lt;/a&gt;.  thanks Lars!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12399149">SOLR-610</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12383439" name="SOLR-556-highlight-multivalued.patch" size="10171" author="larsko" created="Thu, 5 Jun 2008 08:43:44 +0100"/>
                            <attachment id="12382089" name="solr-highlight-multivalued-example.xml" size="1011" author="larsko" created="Thu, 15 May 2008 06:15:22 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 14 May 2008 20:20:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7051</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxqm7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20631</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>