<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:19:24 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-173/SOLR-173.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-173] &quot;too many open files&quot; with posting to update handler</title>
                <link>https://issues.apache.org/jira/browse/SOLR-173</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;From brian:&lt;/p&gt;

&lt;p&gt;1) Download trunk/nightly&lt;br/&gt;
2) Change line 347 of example/solr/conf/solrconfig.xml to   &amp;lt;requestHandler name=&quot;/update&quot; class=&quot;solr.XmlUpdateRequestHandler&quot;&amp;gt;&lt;br/&gt;
3) java -jar start.jar...&lt;br/&gt;
3) Run post.sh a bunch of times on the same xml file... (in a shell script or whatever)&lt;br/&gt;
4) After a few seconds/minutes jetty will crash with &quot;too many open files&quot;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;- - - -&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;all you&apos;ve got to do is&lt;/p&gt;

&lt;p&gt;apache-solr-nightly/example/exampledocs ryan$ while [ 0 -lt 1 ]; do ./post.sh hd.xml; done&lt;/p&gt;

&lt;p&gt;with the request handler pointing to /update. Use&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;lsof | grep solr | wc -l&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;to watch the fdescs fly.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12363564">SOLR-173</key>
            <summary>&quot;too many open files&quot; with posting to update handler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Hoss Man</assignee>
                                    <reporter username="ryantxu">Ryan McKinley</reporter>
                        <labels>
                    </labels>
                <created>Sat, 24 Feb 2007 21:19:51 +0000</created>
                <updated>Fri, 10 May 2013 11:40:48 +0100</updated>
                            <resolved>Mon, 26 Feb 2007 19:42:49 +0000</resolved>
                                    <version>1.2</version>
                                    <fixVersion>1.2</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12475661" author="ryantxu" created="Sat, 24 Feb 2007 22:43:32 +0000"  >&lt;p&gt;This is not a real &apos;fix&apos; but it does make the problem go away.  I don&apos;t understand how or why.  Essentially if you use the QueryResponseWriter it runs out of open files - if you write the output directly, it is fine.&lt;/p&gt;

&lt;p&gt;It does not seem to make any difference what is in the response.&lt;/p&gt;

&lt;p&gt;Anyone have any idea what could be going on?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;- - -&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;to make post.sh work with the update handler stuff, you will need to add the content type to &amp;lt;commit/&amp;gt;&lt;/p&gt;

&lt;p&gt;curl $URL --data-binary &apos;&amp;lt;commit/&amp;gt;&apos; -H &apos;Content-type:text/xml; charset=utf-8&apos;&lt;/p&gt;</comment>
                            <comment id="12475664" author="bdelacretaz" created="Sat, 24 Feb 2007 23:14:08 +0000"  >&lt;p&gt;After making the change shown above in solrconfig.xml, a commit is enough to make the number of open file handles grow:&lt;/p&gt;

&lt;p&gt;  curl &lt;a href=&quot;http://localhost:8983/solr/update&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/update&lt;/a&gt; --data-binary &apos;&amp;lt;commit/&amp;gt;&apos;  -H &apos;Content-type:text/xml; charset=utf-8&apos;&lt;/p&gt;

&lt;p&gt;lsof shows that many of these file handles point to files in data/index, which have been deleted during the commit: &lt;/p&gt;

&lt;p&gt;  lsof -p 9563 | grep data/index | wc -l           (where 9563 is my solr&apos;s process ID)&lt;/p&gt;

&lt;p&gt;shows 398 file handles after a few commits, although my data/index dir contains only 47 files.&lt;/p&gt;

&lt;p&gt;So it looks like something is keeping useless open handles to &quot;old&quot; index files after a commit.&lt;/p&gt;
</comment>
                            <comment id="12475668" author="yseeley@gmail.com" created="Sun, 25 Feb 2007 00:03:26 +0000"  >&lt;p&gt;The problem is the use of the response writers for something they weren&apos;t originally indended for.&lt;/p&gt;

&lt;p&gt;Requests are pretty much always associated with an index searcher.  The searcher is grabbed on-demand and used for the remainder of the request&apos;s lifetime.  This is important (lucene docids can change, etc).  At the end of the lifetime of a request, close() &lt;b&gt;must&lt;/b&gt; be called to decrement the reference count and close the searcher if necessary.  An open searcher holds the files of the index open (so it&apos;s view of the index never changes).&lt;/p&gt;

&lt;p&gt;Problem #1: it doesn&apos;t look like doFilter() closes the request object.&lt;br/&gt;
Problem #2: update handlers should not request a searcher in the first place... the response writers need to be modified to call getSearcher() on-demand.&lt;/p&gt;</comment>
                            <comment id="12475671" author="ryantxu" created="Sun, 25 Feb 2007 00:29:51 +0000"  >&lt;p&gt;this patch takes care of Problem #1, it does not touch #2&lt;/p&gt;

&lt;p&gt;closing the request object keeps the open files from stacking up.&lt;/p&gt;

&lt;p&gt;thanks Yonik&lt;/p&gt;</comment>
                            <comment id="12475672" author="ryantxu" created="Sun, 25 Feb 2007 00:42:44 +0000"  >&lt;p&gt;modifying for problem #2 was easier then i expected, it only touches &lt;br/&gt;
 JSONResponseWriter.java&lt;br/&gt;
 TextResponseWriter.java&lt;br/&gt;
 XMLWriter.java&lt;/p&gt;

&lt;p&gt;rather then initalize the searcher in the constructor, they load a local SolrIndexSearcher inside the writeDocList() function&lt;/p&gt;</comment>
                            <comment id="12475964" author="hossman" created="Mon, 26 Feb 2007 19:31:35 +0000"  >&lt;p&gt;this patch changes the public API of XMLWriter in a way that isn&apos;t backwards compatible if anyone was using it in their own plugin ... but i&apos;m guessing the number of people doing that is fairly low (if any) and the added safety it provides seems worth while ... doing some sanity testing and then i&apos;ll commit.&lt;/p&gt;</comment>
                            <comment id="12475969" author="hossman" created="Mon, 26 Feb 2007 19:42:49 +0000"  >&lt;p&gt;commited&lt;/p&gt;</comment>
                            <comment id="12589299" author="hossman" created="Wed, 16 Apr 2008 00:44:42 +0100"  >&lt;p&gt;This bug was modified as part of a bulk update using the criteria...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Marked (&quot;Resolved&quot; or &quot;Closed&quot;) and &quot;Fixed&quot;&lt;/li&gt;
	&lt;li&gt;Had no &quot;Fix Version&quot; versions&lt;/li&gt;
	&lt;li&gt;Was listed in the CHANGES.txt for 1.2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The Fix Version for all 39 issues found was set to 1.2, email notification&lt;br/&gt;
was suppressed to prevent excessive email.&lt;/p&gt;

&lt;p&gt;For a list of all the issues modified, search jira comments for this&lt;br/&gt;
(hopefully) unique string: 20080415hossman2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12351974" name="SOLR-173-open-files-bug.patch" size="5372" author="ryantxu" created="Sun, 25 Feb 2007 00:42:44 +0000"/>
                            <attachment id="12351973" name="SOLR-173-open-files-bug.patch" size="1951" author="ryantxu" created="Sun, 25 Feb 2007 00:29:51 +0000"/>
                            <attachment id="12351967" name="SOLR-173-open-files-bug.patch" size="2568" author="ryantxu" created="Sat, 24 Feb 2007 22:43:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 24 Feb 2007 23:14:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7412</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxsy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21009</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>