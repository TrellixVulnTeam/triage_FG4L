<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:18:09 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-829/SOLR-829.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-829] replication Compression</title>
                <link>https://issues.apache.org/jira/browse/SOLR-829</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;From a discussion on the mailing list solr-user, it would be useful to have an option to compress the files sent between servers for replication purposes.&lt;/p&gt;

&lt;p&gt;Files sent across between indexes can be compressed by a large margin allowing for easier replication between sites.&lt;/p&gt;

&lt;p&gt;...Noted by Noble Paul &lt;/p&gt;

&lt;p&gt;we will use a gzip on both ends of the pipe . On the slave side you can say &amp;lt;str name=&quot;zip&quot;&amp;gt;true&amp;lt;str&amp;gt; as an extra option to compress and send data from server &lt;/p&gt;


&lt;p&gt;Other thoughts on issue: &lt;/p&gt;

&lt;p&gt;Do keep in mind that compression is a CPU intensive process so it is a trade off between CPU utilization and network bandwidth.  I have see cases where compressing the data before a network transfer ended up being slower than without compression because the cost of compression and un-compression was more than the gain in network transfer.&lt;/p&gt;

&lt;p&gt;Why invent something when compression is standard in HTTP? --wunder&lt;/p&gt;</description>
                <environment></environment>
        <key id="12407422">SOLR-829</key>
            <summary>replication Compression</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalinmangar">Shalin Shekhar Mangar</assignee>
                                    <reporter username="scollins">Simon Collins</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Oct 2008 14:57:10 +0000</created>
                <updated>Thu, 13 Aug 2009 15:18:23 +0100</updated>
                            <resolved>Tue, 25 Nov 2008 14:19:49 +0000</resolved>
                                                    <fixVersion>1.4</fixVersion>
                                    <component>replication (java)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12643508" author="scollins" created="Wed, 29 Oct 2008 14:58:57 +0000"  >&lt;p&gt;email thread discussing the issue&lt;/p&gt;</comment>
                            <comment id="12643541" author="noble.paul" created="Wed, 29 Oct 2008 17:38:17 +0000"  >&lt;p&gt;email thread &lt;a href=&quot;http://markmail.org/message/rmxywrgdlnz4vbwe&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://markmail.org/message/rmxywrgdlnz4vbwe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12646476" author="akshay" created="Tue, 11 Nov 2008 05:35:02 +0000"  >&lt;p&gt;Patch with following changes:&lt;br/&gt;
Zip configuration parameter in replicationhandler (on slave):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;zip&quot;&lt;/span&gt;&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/str&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Have tested it with replication across two data centres with an index size of 1.1G.&lt;br/&gt;
Time taken for replicating with gzipping is 1012 seconds (17 mins) compared to 1250 seconds (21 mins) with replication without gzipping.&lt;/p&gt;</comment>
                            <comment id="12646478" author="shalinmangar" created="Tue, 11 Nov 2008 05:40:56 +0000"  >&lt;p&gt;Thanks Akshay&lt;/p&gt;

&lt;p&gt;Hoss, do you know of a GzipServlet which we can borrow? Until that is in place, we can probably go ahead with this patch. Anyway, the configuration will not change, only the internal implementation needs to change (client sending Accept-Encoding in place of zip=true)&lt;/p&gt;</comment>
                            <comment id="12646486" author="noble.paul" created="Tue, 11 Nov 2008 06:04:08 +0000"  >&lt;p&gt;Do we really need a zipping for any other response? Assuming that Solr clients mostly make the requests from the same LAN using CPU instead of Bandwidth looks like an overkill to me. (Probably we need a perf comparison). If the wt==javabin we may achieve very little compression. &lt;/p&gt;</comment>
                            <comment id="12646657" author="ryantxu" created="Tue, 11 Nov 2008 20:24:44 +0000"  >&lt;p&gt;I have used the &lt;a href=&quot;http://ehcache.sourceforge.net/ehcache-constructs/documentation/javadoc/net/sf/ehcache/constructs/web/filter/GzipFilter.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;GzipFilter&lt;/a&gt; from ehcache for a few years and never had any troubles...&lt;/p&gt;

&lt;p&gt;There may be something smaller out there though.&lt;/p&gt;

&lt;p&gt;Re &quot;Do we really need a zipping for any other response?&quot;...  The point of using standards based approach is that the client can decide.  Essentially we could enable gzip for the whole web application and let each request say if the response should be gzipped.&lt;/p&gt;</comment>
                            <comment id="12648079" author="noble.paul" created="Mon, 17 Nov 2008 04:40:09 +0000"  >&lt;p&gt;The server(Replicationhandler is agnostic of compression. The client (SnapPuller) sets appropriate header  before sending the request . Use appropriate filter or front-end the master w/ an apache to handle compression&lt;/p&gt;</comment>
                            <comment id="12648149" author="noble.paul" created="Mon, 17 Nov 2008 12:18:27 +0000"  >&lt;p&gt;After a lot of discussions on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-856&quot; title=&quot;Support for &amp;quot;Accept-Encoding : gzip&amp;quot; in SolrDispatchFilter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-856&quot;&gt;&lt;del&gt;SOLR-856&lt;/del&gt;&lt;/a&gt; I realize that it is not straight forward to provide a &apos;container independent&apos; means to provide compression. We have to document different ways for different containers to ensure that it works properly. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;How important is it to use HTTP standards to achieve this? Consider the fact that nothing else in the whole solution is complying with any standard&lt;/li&gt;
	&lt;li&gt;For this feature , compression is a critical  . It can mean huge differences in replication time&lt;/li&gt;
	&lt;li&gt;I am not very comfortable with complex configuration documentation saying do this if you use jetty or do this if you use resin and this for glassfish etc etc.&lt;/li&gt;
	&lt;li&gt;How about giving both the options to users and let them choose what they want. This also gives them the flexibility of doing compression only for replication&lt;/li&gt;
	&lt;li&gt;Power users can use their own favorite configuration to do the compression.&lt;br/&gt;
Something like
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;slave&quot;&lt;/span&gt;&amp;gt;
  &amp;lt;!-- values can be internal|external . --&amp;gt; 
  &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;compression&quot;&lt;/span&gt;&amp;gt;internal&amp;lt;/str&amp;gt;
&amp;lt;/lst&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12648507" author="hossman" created="Tue, 18 Nov 2008 06:21:46 +0000"  >&lt;p&gt;Let&apos;s keep this issue focused on one thing: making it possible to configure a &quot;slave&quot; solr instance so that it indicates it can &quot;Accept-Encoding&quot; compressed responses during replication (discussion of what the &quot;master&quot; does with that information are a separate matter)&lt;/p&gt;

&lt;p&gt;From my (naive) reading of the current patch, a few things jump out at me...&lt;/p&gt;

&lt;p&gt;1) the &quot;FastOutputStream&quot; changes in ReplicationHandler looks like an unintentional part of the patch.&lt;br/&gt;
2) why does setting the ZIP option to true disable checksums?  i&apos;m not sure when/how checksums are currently computed/compared, but if it can be done with a raw i/o streams right now, it can be done with a GZIP i/o streams if the response is compressed.&lt;br/&gt;
3) the behavior of checkCompressed doesn&apos;t seem right. A Content-Encoding header is used to indicate that the orriginal content has been compressed in order to transfer over HTTP, but the Content-Type header is used to identify the true type of the payload.  we shouldn&apos;t silently uncompress files just because they happen to have a mime type of &quot;application/x-gzip-compressed&quot;.  we might be able to get away with it in dealing with replication, but we shouldn&apos;t need it (and unless i&apos;m severaly mistaken, this will break in the event that gzip content is sent &lt;b&gt;with&lt;/b&gt; additional gzip Content-Encoding.&lt;/p&gt;</comment>
                            <comment id="12648517" author="shalinmangar" created="Tue, 18 Nov 2008 07:12:03 +0000"  >&lt;ol&gt;
	&lt;li&gt;Yes, the constructor call is moved to a different line, that&apos;s all.&lt;/li&gt;
	&lt;li&gt;We disable checksum because if GZIP does checksums internally, so we do not need to do it again. However, deflate does not use checksums and when we use the InflaterInputStream, we should do checksums. This is not in the patch right now.&lt;/li&gt;
	&lt;li&gt;That code is exactly copied from CommonsHttpSolrServer. In this case, if we are getting a compressed stream from the master, it should be decompressed and written to the filesystem as it is. We do not need to worry about the type of the response. This patch is only for this particular use-case.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I don&apos;t think this patch is in sync with Noble&apos;s latest proposal. A new one will be needed.&lt;/p&gt;</comment>
                            <comment id="12649435" author="akshay" created="Thu, 20 Nov 2008 18:10:50 +0000"  >&lt;p&gt;Patch with additional configuration in replicationhandler as suggested by Noble.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;slave&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!-- values can be internal|external. --&amp;gt;&lt;/span&gt;&lt;/span&gt; 
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;compression&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;internal&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/lst&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If internal compression is used InflaterInputStream and DeflaterOutputStream Java apis are used for data transfer from master to slaves. &lt;/p&gt;

&lt;p&gt;If external compression is used Accept-Encoding header value is set to &quot;gzip,deflate&quot; before making request to the master. And the container has to be configured with appropriate setting. E.g. In case of Tomcat, following settings are to be done in the Connector section to use Tomcat&apos;s compression mechanism:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&amp;lt;Connector .... compression=on 
compressableMimeType=&lt;span class=&quot;code-quote&quot;&gt;&quot;application/octet-stream,text/html,text/xml,text/plain&quot;&lt;/span&gt; 
compressionMinSize=&lt;span class=&quot;code-quote&quot;&gt;&quot;somePreferredValue&quot;&lt;/span&gt;/&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12649622" author="shalinmangar" created="Fri, 21 Nov 2008 07:53:01 +0000"  >&lt;p&gt;Changes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Fixes a possible connection leak in FileFetcher#getStream method.&lt;/li&gt;
	&lt;li&gt;A single HttpClient is created with MultiThreadedHttpConnectionManager in SnapPuller and is re-used for every operation&lt;/li&gt;
	&lt;li&gt;Idle connections are closed in SnapPull#destroy method&lt;/li&gt;
	&lt;li&gt;Release connection and stream closing is not done in a separate thread anymore&lt;/li&gt;
	&lt;li&gt;ReplicationHandler does a snappull command in a new thread so that an API call for this command is not kept waiting until the operation completes. The admin jsp which used to make a call to this method in another thread is also changed to remove the thread creation.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ll commit this in a day or two if there are no problems.&lt;/p&gt;</comment>
                            <comment id="12650574" author="shalinmangar" created="Tue, 25 Nov 2008 14:19:49 +0000"  >&lt;p&gt;Committed revision 720502.&lt;/p&gt;

&lt;p&gt;Thanks Simon, Noble, Hoss and Akshay!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12408488">SOLR-856</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12395304">SOLR-561</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12392991" name="email discussion.txt" size="5924" author="scollins" created="Wed, 29 Oct 2008 14:58:56 +0000"/>
                            <attachment id="12394405" name="solr-829.patch" size="18370" author="shalinmangar" created="Fri, 21 Nov 2008 07:53:01 +0000"/>
                            <attachment id="12394359" name="solr-829.patch" size="6680" author="akshay" created="Thu, 20 Nov 2008 18:10:50 +0000"/>
                            <attachment id="12394039" name="solr-829.patch" size="5303" author="noble.paul" created="Mon, 17 Nov 2008 04:40:09 +0000"/>
                            <attachment id="12393685" name="solr-829.patch" size="3530" author="akshay" created="Tue, 11 Nov 2008 05:35:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Oct 2008 17:38:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6797</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxoyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20362</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>