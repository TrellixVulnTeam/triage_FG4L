<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:20:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-951/SOLR-951.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-951] Distributed query fails with tag / exclude pattern used for facets that are multi-valued.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-951</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Running this query:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;http:&lt;span class=&quot;code-comment&quot;&gt;//testserver:8985/solr/select/?q=*%3A*&amp;amp;version=2.2&amp;amp;start=0&amp;amp;rows=10&amp;amp;indent=on&amp;amp;facet=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;
&lt;/span&gt;facet.field={!ex=t1}SubjectTerms_mfacet&amp;amp;fq={!tag=t1}SubjectTerms_mfacet:(testvalue)&amp;amp;
shards=test1:8985/solr,test2:8985/solr
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;causes this exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException
	at org.apache.solr.handler.component.FacetComponent.refineFacets(FacetComponent.java:330)
	at org.apache.solr.handler.component.FacetComponent.handleResponses(FacetComponent.java:231)
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:266)
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131)
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:1325)
	at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:303)
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:232)
	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1089)
	at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:365)
	at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)
	at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)
	at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:712)
	at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:405)
	at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:211)
	at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)
	at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:139)
	at org.mortbay.jetty.Server.handle(Server.java:285)
	at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:502)
	at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:821)
	at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:513)
	at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:208)
	at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:378)
	at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:226)
	at org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:442)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which is at this area of the code in the aggregator, but not the root cause...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void refineFacets(ResponseBuilder rb, ShardRequest sreq) {
    FacetInfo fi = rb._facetInfo;

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ShardResponse srsp: sreq.responses) {
      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; shardNum = rb.getShardNum(srsp.shard);
&lt;/span&gt;      NamedList facet_counts = (NamedList)srsp.getSolrResponse().getResponse().get(&lt;span class=&quot;code-quote&quot;&gt;&quot;facet_counts&quot;&lt;/span&gt;);
      NamedList facet_fields = (NamedList)facet_counts.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;facet_fields&quot;&lt;/span&gt;);      

      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt;facet_fields.size(); i++) {  &lt;span class=&quot;code-comment&quot;&gt;// !!!!!!!!!!!!!!!!! EXCEPTION LINE 330 !!!!!!!!!!!!!!!!!!!! 
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = facet_fields.getName(i);
        DistribFieldFacet dff = (DistribFieldFacet)fi.facets.get(key);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dff == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;

        NamedList shardCounts = (NamedList)facet_fields.getVal(i);

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j=0; j&amp;lt;shardCounts.size(); j++) {
          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = shardCounts.getName(j);
          &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; count = ((&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;)shardCounts.getVal(j)).longValue();
          ShardFacetCount sfc = dff.counts.get(name);
          sfc.count += count;
        }
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The shard actually has an error on it, which is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Jan 9, 2009 6:15:31 AM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/solr path=/select params={facet=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;f.SubjectTerms_mfacet.facet.limit=160&amp;amp;wt=javabin&amp;amp;rows=10&amp;amp;
version=2.2&amp;amp;fl=id,score&amp;amp;start=0&amp;amp;q=*:*&amp;amp;
facet.field={!ex%3Dt1}SubjectTerms_mfacet&amp;amp;isShard=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;fq={!tag%3Dt1}SubjectTerms_mfacet:(testvalue)&amp;amp;
fsv=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;} hits=0 status=0 QTime=265 
Jan 9, 2009 6:15:31 AM org.apache.solr.common.SolrException log
SEVERE: Exception during facet counts:org.apache.lucene.queryParser.ParseException: Expected identifier at pos 37 str=&apos;{!terms=$SubjectTerms_mfacet__termsex=t1}SubjectTerms_mfacet&apos;
	at org.apache.solr.search.QueryParsing$StrParser.getId(QueryParsing.java:564)
	at org.apache.solr.search.QueryParsing.parseLocalParams(QueryParsing.java:135)
	at org.apache.solr.search.QueryParsing.getLocalParams(QueryParsing.java:191)
	at org.apache.solr.request.SimpleFacets.parseParams(SimpleFacets.java:91)
	at org.apache.solr.request.SimpleFacets.getFacetFieldCounts(SimpleFacets.java:275)
	at org.apache.solr.request.SimpleFacets.getFacetCounts(SimpleFacets.java:170)
	at org.apache.solr.handler.component.FacetComponent.process(FacetComponent.java:71)
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:171)
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131)
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:1325)
	at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:303)
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:232)
	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1089)
	at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:365)
	at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)
	at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)
	at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:712)
	at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:405)
	at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:211)
	at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)
	at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:139)
	at org.mortbay.jetty.Server.handle(Server.java:285)
	at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:502)
	at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:835)
	at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:641)
	at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:202)
	at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:378)
	at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:226)
	at org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:442)

Jan 9, 2009 6:15:31 AM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/solr path=/select params={facet=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;q=*:*&amp;amp;
facet.field={!terms%3D$SubjectTerms_mfacet__termsex%3Dt1}SubjectTerms_mfacet&amp;amp;isShard=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;
wt=javabin&amp;amp;
fq={!tag%3Dt1}SubjectTerms_mfacet:(testvalue)&amp;amp;
rows=0&amp;amp;
SubjectTerms_mfacet__terms=mathematical+models,mathematical+analysis&amp;amp;
version=2.2} hits=0 status=0 QTime=2 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Other related information:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The facet being selected is a multi-valued field&lt;/li&gt;
	&lt;li&gt;The facet is a dynamic field and passes a dynamic rule&lt;/li&gt;
	&lt;li&gt;The facet exists and the log shows the 2nd follow-on querying asking for shard values&lt;/li&gt;
	&lt;li&gt;When running a query for a single valued field it seems to work fine, only multi-valued fields seem to fail.  Not completely verified, but a few tests hint at this.&lt;/li&gt;
	&lt;li&gt;Tried facet names that were simple such as &quot;ISBN&quot; and if multi-valued, produces same error.&lt;/li&gt;
	&lt;li&gt;Tried facet names with underscores to see if that was at issue, and if single valued, it succeeded.&lt;/li&gt;
	&lt;li&gt;In a non-distributed search, the tag/exclude works fine for the same facets.&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="12412021">SOLR-951</key>
            <summary>Distributed query fails with tag / exclude pattern used for facets that are multi-valued.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalinmangar">Shalin Shekhar Mangar</assignee>
                                    <reporter username="jminard">Jayson Minard</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Jan 2009 11:30:37 +0000</created>
                <updated>Tue, 10 Nov 2009 15:50:34 +0000</updated>
                            <resolved>Mon, 12 Jan 2009 09:09:49 +0000</resolved>
                                    <version>1.4</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12662336" author="jminard" created="Fri, 9 Jan 2009 11:40:03 +0000"  >&lt;p&gt;Added whitespace to snippets to break long lines.&lt;/p&gt;</comment>
                            <comment id="12662344" author="jminard" created="Fri, 9 Jan 2009 12:03:37 +0000"  >&lt;p&gt;ok so if the string being parsed is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{!terms=$SubjectTerms_mfacet__termsex=t1}SubjectTerms_mfacet
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this enters parseLocalParams() in QueryParsing...&lt;/p&gt;

&lt;p&gt;It would see the &quot;&lt;/p&gt;
{!&quot; and then start parsing the remainder &quot;terms=$SubjectTerms_mfacet__termsex=t1}
&lt;p&gt;SubjectTerms_mfacet&quot; using the first getId call which succeeds and finds &quot;terms&quot; and then the &quot;=&quot; via the peek, and then enters the if that sees the &quot;$&quot; and decides to dereference the parameter.  It immediately calls getId() again which pulls out &quot;$SubjectTerms_mfacet__termsex&quot; and then loops to the top of the loop and calls getId() a second time picking up the final &quot;=&quot; which is then an error.  So, something is missing in the parameters.  Is &quot;ex=t1&quot; another parameter and should have a delimiter?  Ah, it should have a space between there somewhere.  So the parsing is fine, but the creation of the string isn&apos;t.  Searching upwards the stack trace now.&lt;/p&gt;</comment>
                            <comment id="12662349" author="jminard" created="Fri, 9 Jan 2009 12:15:45 +0000"  >&lt;p&gt;Ok,  FacetComponent.java creates the parameter that is passed down and adds the &quot;__terms&quot; that is at the end of the original tag.  Just below that on line 108 is the place where it appends the new parameters to the existing.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dff.localParams != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            facetCommand = commandPrefix+termsKey+dff.facetStr.substring(2);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            facetCommand = commandPrefix+termsKey+&apos;}&apos;+dff.field;
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should have white space between the params, such as...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dff.localParams != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            facetCommand = commandPrefix+termsKey+&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;+dff.facetStr.substring(2);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            facetCommand = commandPrefix+termsKey+&apos;}&apos;+dff.field;
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I tested this fix and it no longer throws an exception, I have not tested that it ensures the tag/exclude feature still works though.&lt;/p&gt;</comment>
                            <comment id="12662908" author="shalinmangar" created="Mon, 12 Jan 2009 08:42:35 +0000"  >&lt;ol&gt;
	&lt;li&gt;Modified TestDistributedSearch to reproduce the bug&lt;/li&gt;
	&lt;li&gt;Fixed bug in FacetComponent&apos;s refinement query generation for local params&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ll commit this shortly.&lt;/p&gt;</comment>
                            <comment id="12662913" author="shalinmangar" created="Mon, 12 Jan 2009 09:09:49 +0000"  >&lt;p&gt;Committed revision 733656.&lt;/p&gt;

&lt;p&gt;Thanks Jayson!&lt;/p&gt;</comment>
                            <comment id="12775460" author="gsingers" created="Tue, 10 Nov 2009 15:50:34 +0000"  >&lt;p&gt;Bulk close Solr 1.4 issues&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12397676" name="SOLR-951.patch" size="3500" author="shalinmangar" created="Mon, 12 Jan 2009 08:42:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 12 Jan 2009 08:42:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6682</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxo73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20239</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>