<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:15:55 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-1169/SOLR-1169.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-1169] SortedIntDocSet</title>
                <link>https://issues.apache.org/jira/browse/SOLR-1169</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;A DocSet type that can skip to support &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1165&quot; title=&quot;use skipping on filters to improve search performance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-1165&quot;&gt;&lt;del&gt;SOLR-1165&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12425527">SOLR-1169</key>
            <summary>SortedIntDocSet</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 May 2009 22:38:42 +0100</created>
                <updated>Tue, 10 Nov 2009 15:52:05 +0000</updated>
                            <resolved>Wed, 20 May 2009 17:08:10 +0100</resolved>
                                                    <fixVersion>1.4</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12709605" author="yseeley@gmail.com" created="Thu, 14 May 2009 22:51:49 +0100"  >&lt;p&gt;We need skipping in our DocSets in order to be able to pass them as filters and improve search performance.&lt;br/&gt;
One could Sort a HashDocSet every time it&apos;s used.... but that&apos;s not desirable.&lt;/p&gt;

&lt;p&gt;The way Lucene now uses filters, random access performance is no longer important, but being able to efficiently skip is.&lt;br/&gt;
Intersection performance is very important to Solr of course, so if we can get SortedIntDocSet performance fast enough then it would make sense for it to replace HashDocSet.&lt;/p&gt;

&lt;p&gt;I&apos;ve already started working on this, and the results look promising.  I&apos;ll post a draft soon.&lt;/p&gt;</comment>
                            <comment id="12709645" author="klaasm" created="Fri, 15 May 2009 01:23:11 +0100"  >&lt;p&gt;sweet.  intersecting sorted int dicts should be faster in the general case.  HashSet will of course win when one set is very small, but I expect this to still be pretty fast anyway.&lt;/p&gt;</comment>
                            <comment id="12709692" author="yseeley@gmail.com" created="Fri, 15 May 2009 04:54:19 +0100"  >&lt;p&gt;Draft patch attached.  It&apos;s not &quot;hooked in&quot; to Solr yet... just the performance tests, which I&apos;m doing now.&lt;/p&gt;</comment>
                            <comment id="12709713" author="yseeley@gmail.com" created="Fri, 15 May 2009 06:33:05 +0100"  >&lt;p&gt;The first results are in, and it&apos;s looking good.&lt;/p&gt;

&lt;p&gt;Algorithm:&lt;br/&gt;
For intersectionSize (and intersection), if the sets are near in size, we do a linear scan.  A little micro-optimization there got us an extra 13% speedup... just for rearranging the order of comparisons base on the fact that one was more likely to be true than the other (based on the set sizes).  When the set sizes differ by a factor of 8 or more, we use a modified binary search.  The first modification keeps track of the lower bound rather than resetting to 0... a big win (an obvious optimization... I didn&apos;t measure the benefit).  Then second modification probes closer to the lower bound (rather than using the midpoint) based on the relative size difference of the sets, and leads to a 40% performance increase.&lt;/p&gt;

&lt;p&gt;Performance results of intersectionSize:&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DocSet sizes&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Advantage&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Percent&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;comments&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1-200 x 1-200                            &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Int &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;53%&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; random sized DocSets from 1-200 in size intersected with other DocSets of size 1-200&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1-3000 x 1-3000                       &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;    Int &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;33% &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3000 is the current default upper bound of HashDocSet&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1-3000 x 1-3000                       &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   Int &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;130% &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-client instead of -server&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2000-3000 x 2000-3000         &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Int &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;60% &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; only big sets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;20000-30000 x 20000-30000&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Int &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;54% &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  only bigger sets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;100-200 x 1000-2000              &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Hash &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;87% &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; small sets with big sets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1-10000 x 20000-30000         &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Int  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;74% &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; smaller sets intersected with BitDocSets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1-30000 x 1-30000                  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Int &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;80% &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; docsets over maxDoc/64 are BitDocSets (maxDoc=1M)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;So to sum up, only small sets intersected with big sets are slower.... but given that big sets intersected with big sets take a majority of the time, we get a nice net win.  It gets more dramatic when intersecting a small set with a BitDocSet... these affects are probably due to nicer treatment of the memory subsystem when accessing memory in order.  I think these intersections tend to be bound by memory bandwidth.&lt;/p&gt;

&lt;p&gt;The improvements will also allow us to bump up the max size of the &quot;small set&quot; implementation.  From a memory consumption point of view, the break-even point is maxDoc/32.  When I tested using SortedIntDocSets with maxDoc/64, there was always a net speedup over maxDoc/32 and maxDoc/100, so this seems to be a good balance between performance and saving memory.&lt;/p&gt;

&lt;p&gt;Memory savings: SortedIntDocSet is more efficient than HashDocSet at storing the same amount of data, and it can be used at larger sizes (relative to maxDoc) before performance decreases (another memory win).&lt;/p&gt;

&lt;p&gt;Other savings: Faster set creation - Lucene currently delivers docs in order, hence so sorting step is needed after collection.&lt;/p&gt;

&lt;p&gt;Other notes: I tried a cool partitioning algorithm that I thought would be superior - take the middle element of the big set and use it to partition the small set.  Say you have set sizes of 100 and 10000... you do a single binary search on the small set, and now for all 100 elements you have half the big set size to search.  Recurse on the corresponding lower and upper partitions until they are small enough to use a different method such as a modified binary search.  This approach worked, but it wasn&apos;t able to beat the modified binary search alone once I put in all the optimizations... &lt;b&gt;shrugs&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="12711205" author="yseeley@gmail.com" created="Wed, 20 May 2009 17:08:10 +0100"  >&lt;p&gt;committed.&lt;/p&gt;</comment>
                            <comment id="12775744" author="gsingers" created="Tue, 10 Nov 2009 15:52:05 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12425384">SOLR-1165</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12408217" name="SOLR-1169.patch" size="21537" author="yseeley@gmail.com" created="Fri, 15 May 2009 04:54:19 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 15 May 2009 00:23:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6475</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxmvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20026</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>