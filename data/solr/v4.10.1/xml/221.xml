<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:25:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-221/SOLR-221.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-221] faceting memory and performance improvement</title>
                <link>https://issues.apache.org/jira/browse/SOLR-221</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;1) compare minimum count currently needed to the term df and avoid unnecessary intersection count&lt;br/&gt;
2) set a minimum term df in order to use the filterCache, otherwise iterate over TermDocs&lt;/p&gt;</description>
                <environment></environment>
        <key id="12368276">SOLR-221</key>
            <summary>faceting memory and performance improvement</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Sun, 29 Apr 2007 04:39:26 +0100</created>
                <updated>Fri, 10 May 2013 11:39:30 +0100</updated>
                            <resolved>Sat, 19 May 2007 23:48:40 +0100</resolved>
                                                    <fixVersion>1.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12492543" author="yseeley@gmail.com" created="Sun, 29 Apr 2007 06:00:17 +0100"  >&lt;p&gt;The results are slightly surprising.&lt;/p&gt;

&lt;p&gt;I made up an index, and each document contained 4 random numbers between 1 and 500,000&lt;br/&gt;
This is not the distribution one would expect to see in a real index. but we can still learn much.&lt;/p&gt;

&lt;p&gt;The synthetic index:&lt;br/&gt;
 maxDoc=500,000&lt;br/&gt;
 numDocs=393,566&lt;br/&gt;
 number of segments = 5&lt;br/&gt;
 number of unique facet terms = 490903&lt;br/&gt;
 filterCache max size = 1,000,000 entries (more than enough)&lt;br/&gt;
 JVM=1.5.0_09 -server -Xmx200M&lt;br/&gt;
 System=WinXP, 3GHz P4, hyperthreaded, 1GB dual channel RAM&lt;br/&gt;
 facet type = facet.field, facet.sort=true, facet.limit=10&lt;br/&gt;
 maximum df of any term = 15&lt;br/&gt;
 warming times were not included... queries were run many times and the lowest time recorded.&lt;/p&gt;

&lt;p&gt;Number of documents that match test &quot;base&quot; queries (for example, base query #1 matches 175K docs):&lt;br/&gt;
1) 175000,  &lt;br/&gt;
2) 43000&lt;br/&gt;
3) 8682&lt;br/&gt;
4) 2179&lt;br/&gt;
5) 422&lt;br/&gt;
6) 1&lt;/p&gt;

&lt;p&gt;WITHOUT PATCH (milliseconds to facet each base query):&lt;br/&gt;
1578, 1578, 1547, 1485, 1484,1422&lt;/p&gt;

&lt;p&gt;WITH PATCH (min df comparison w/ term df,  minDfFilterCache=0) (all field cache)&lt;br/&gt;
 984,  1203, 1391, 1437, 1484, 1420&lt;/p&gt;

&lt;p&gt;WITH PATCH (min df comp, minDfFilterCache=30)  (no fieldCache at all)&lt;br/&gt;
1406, 2344, 3125, 3015, 3172, 3172&lt;/p&gt;

&lt;p&gt;CONCLUSION1: min df comparison increases faceting speed 60% when the base query matches many documents.  With a real term distribution, this could be even greater.&lt;/p&gt;

&lt;p&gt;CONCLUSION2: opting to not use the fieldCache for smaller df terms can save a lot of memory, but it hurts performance up to 200% for our non-optimized index.&lt;/p&gt;

&lt;p&gt;CONCLUSION3: using the field cache less can significantly speed up warming time (times not shown, but a full warming of the fieldCache took 33 sec)&lt;/p&gt;

&lt;p&gt;======== now the same index, but optimized ===========&lt;br/&gt;
WITH PATCH (optimized, min df comparison w/ term df,  minDfFilterCache=0) (all field cache)&lt;br/&gt;
 172,  312,  485,  578,  610,  656&lt;/p&gt;

&lt;p&gt;WITH PATCH (optimized, min df comp, minDfFilterCache=30)  (no fieldCache at all)&lt;br/&gt;
 265,  344,  422,  468,  500,  484  &lt;/p&gt;

&lt;p&gt;CONCLUSION3: An optimized index increased performance 200-500%&lt;/p&gt;

&lt;p&gt;CONCLUSION4:  The fact that an all-fieldcache option was significantly faster on an optimized probably cannot totally be explained by accurate dfs (no deleted documents to inflate the term df values), means that just iterating over the terms is &lt;b&gt;much&lt;/b&gt; faster in an optimized index (a potential Lucene area to look into)&lt;/p&gt;</comment>
                            <comment id="12492579" author="yseeley@gmail.com" created="Sun, 29 Apr 2007 17:00:35 +0100"  >&lt;p&gt;Perhaps minDfFilterCache could be automatically tuned depending on if the index is optimized or not...&lt;br/&gt;
Could allow specification of both in solrconfig.xml perhaps...&lt;/p&gt;

&lt;p&gt;&amp;lt;faceting&amp;gt;&lt;br/&gt;
  &amp;lt;minDfFilterCache&amp;gt;0&amp;lt;/minDfFilterCache&amp;gt;  &amp;lt;!-- always use filterCache in non-optimized index --&amp;gt;&lt;br/&gt;
  &amp;lt;minDfFilterCache index=&quot;optimized&quot;&amp;gt;50&amp;lt;/minDfFilterCache&amp;gt;  &amp;lt;!-- if optimized, only use filterCache when df&amp;gt;=50 --&amp;gt;&lt;br/&gt;
&amp;lt;/faceting&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12495204" author="hossman" created="Sat, 12 May 2007 00:33:10 +0100"  >&lt;p&gt;it might be worth trying to clarify if the performance cliff really results from being &lt;b&gt;optimized&lt;/b&gt; or if it&apos;s just a result of one of the two traits of an optimized index: being a single segment, having no deletions.&lt;/p&gt;

&lt;p&gt;tuning the behavior based on either of those traits is just as easy as tuning based on both traits.&lt;/p&gt;


&lt;p&gt;Minor point: if we&apos;re going to add facet config options, i&apos;d prefer they stay as standard standard SolrParms that can be defaulted i the handler config (and theoretically overridden per request)  it just seems cleaner to have all options in one place, and there&apos;s not a lot of reason not to when dealing with options tha don&apos;t *need8 to be identicle for every request.&lt;/p&gt;</comment>
                            <comment id="12495222" author="yseeley@gmail.com" created="Sat, 12 May 2007 03:15:34 +0100"  >&lt;p&gt;&amp;gt; it might be worth trying to clarify if the performance cliff really results from being &lt;b&gt;optimized&lt;/b&gt; or if it&apos;s just a result of one of the two traits of an optimized index: being a single segment, having no deletions. &lt;/p&gt;

&lt;p&gt;The large performance differences even when TermDocs weren&apos;t used (all fieldcache) strongly suggests that it&apos;s a SegmentReader vs MultiReader issue more than deleted docs, since I doubt the larger maxDoc would account for much time.   It would be nice to know for sure though.&lt;/p&gt;

&lt;p&gt;&amp;gt; Minor point: if we&apos;re going to add facet config options, i&apos;d prefer they stay as standard standard SolrParms&lt;/p&gt;

&lt;p&gt;I think we may need to look at it on a per-option basis (but I agree, these look like a candidate).  Once 1.2 gets out the door, I&apos;ll probably get back to my facet cache work, and that will have some parameters that &lt;b&gt;don&apos;t&lt;/b&gt; make sense to be able to tune per-request (or wouldn&apos;t even be possible).&lt;/p&gt;</comment>
                            <comment id="12495844" author="yseeley@gmail.com" created="Tue, 15 May 2007 03:59:17 +0100"  >&lt;p&gt;So for configuration, how about a SolrParam of&lt;br/&gt;
facet.minDfFilterCache  (can anyone think of a better name?), probably per-field.&lt;br/&gt;
We can defer more complex configuration in order to fit this into Solr 1.2, as long as we don&apos;t think this single parameter is a mistake.&lt;/p&gt;</comment>
                            <comment id="12496046" author="skeptikos" created="Tue, 15 May 2007 17:32:35 +0100"  >&lt;p&gt;Clearly Solr is going to end up with more than 2 algorithms for computing facets, and there&apos;s no reason to think they won&apos;t be able to happily coexist in SimpleFacets.  And we will surely need additional control parameters even for the 2.5 (with your patch) algorithms now in place.  So I think we should establish a convention for separating algorithm-specific parameters so we don&apos;t end up with a jumble of top-level parameters.&lt;/p&gt;

&lt;p&gt;So rather than facet.minDfFilterCache, how about:&lt;br/&gt;
    facet.enum.cache.minDF (enable term enum cache for terms with docFreq &amp;gt; minDF)&lt;br/&gt;
    f.&amp;lt;field&amp;gt;.facet.enum.cache.minDF&lt;/p&gt;

&lt;p&gt;Might it not be useful to turn off term enum caching when the number of terms was above a certain maximum, even if the minDF criterion is met, to trade cycles for memory when neither the field cache nor filter cache is practicable?  In that case, it could be:&lt;br/&gt;
    facet.enum.cache.maxTerm  (enable term enum cache for fields where numTerms &amp;lt;= maxTerm)&lt;/p&gt;</comment>
                            <comment id="12496374" author="yseeley@gmail.com" created="Wed, 16 May 2007 20:04:56 +0100"  >&lt;p&gt;Yeah, facet.enum.cache.minDf seems reasonable (if a bit long).&lt;/p&gt;

&lt;p&gt;&amp;gt; Might it not be useful to turn off term enum caching when the number of terms was above a certain maximum  &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;  trade cycles for memory&lt;/p&gt;

&lt;p&gt;If one expects a really high number of terms, I think the right approach is to pick a minDf to cut down the cache size (and trade cycles for memory).  Also, Solr doesn&apos;t currently know the number of terms in a field unless it&apos;s traversed all of them.&lt;/p&gt;</comment>
                            <comment id="12496404" author="yseeley@gmail.com" created="Wed, 16 May 2007 21:53:59 +0100"  >&lt;p&gt;Changed config to a SolrParam facet.enum.cache.minDf&lt;br/&gt;
and added some tests.&lt;/p&gt;</comment>
                            <comment id="12496409" author="yseeley@gmail.com" created="Wed, 16 May 2007 22:17:38 +0100"  >&lt;p&gt;TODO: after committed, document warming tips due to change #1 &quot;compare minimum count currently needed to the term df and avoid unnecessary intersection count&quot;&lt;/p&gt;</comment>
                            <comment id="12589326" author="hossman" created="Wed, 16 Apr 2008 00:44:45 +0100"  >&lt;p&gt;This bug was modified as part of a bulk update using the criteria...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Marked (&quot;Resolved&quot; or &quot;Closed&quot;) and &quot;Fixed&quot;&lt;/li&gt;
	&lt;li&gt;Had no &quot;Fix Version&quot; versions&lt;/li&gt;
	&lt;li&gt;Was listed in the CHANGES.txt for 1.2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The Fix Version for all 39 issues found was set to 1.2, email notification&lt;br/&gt;
was suppressed to prevent excessive email.&lt;/p&gt;

&lt;p&gt;For a list of all the issues modified, search jira comments for this&lt;br/&gt;
(hopefully) unique string: 20080415hossman2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12357496" name="facet.patch" size="12494" author="yseeley@gmail.com" created="Wed, 16 May 2007 21:53:59 +0100"/>
                            <attachment id="12356473" name="facet.patch" size="3206" author="yseeley@gmail.com" created="Sun, 29 Apr 2007 04:51:27 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 11 May 2007 23:33:10 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7367</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxsnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20962</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>