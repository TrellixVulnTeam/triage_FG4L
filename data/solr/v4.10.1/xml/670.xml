<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:23:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-670/SOLR-670.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-670] UpdateHandler must provide a rollback feature</title>
                <link>https://issues.apache.org/jira/browse/SOLR-670</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Lucene IndexWriter already has a rollback method. There should be a counterpart for the same in &lt;em&gt;UpdateHandler&lt;/em&gt;  so that users can do a rollback over http &lt;/p&gt;</description>
                <environment></environment>
        <key id="12401377">SOLR-670</key>
            <summary>UpdateHandler must provide a rollback feature</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="koji">Koji Sekiguchi</assignee>
                                    <reporter username="noble.paul">Noble Paul</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Jul 2008 05:30:33 +0100</created>
                <updated>Tue, 10 Nov 2009 15:51:46 +0000</updated>
                            <resolved>Mon, 12 Oct 2009 17:06:23 +0100</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12636873" author="koji" created="Sun, 5 Oct 2008 08:55:55 +0100"  >&lt;p&gt;A patch supports the rollback feature.&lt;/p&gt;

&lt;p&gt;One question comes up. Is it worthy to have postRollback() method in SolrEventListener? Because SolrEventListener is an interface, if we add the method, it will break back-compat.&lt;/p&gt;</comment>
                            <comment id="12637470" author="koji" created="Tue, 7 Oct 2008 14:15:19 +0100"  >&lt;p&gt;Updated patch which includes commit and rollback test. The test looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;pseudo code&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testUncommit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;));
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt; should not be found.
&lt;/span&gt;  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testAddCommit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;));
    commit();
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt; should be found.
&lt;/span&gt;  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testDeleteCommit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;));
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;));
    commit();
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A OR B&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt; and &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt; should be found.
&lt;/span&gt;    delete(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;));
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A OR B&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt; and &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt; should be found.
&lt;/span&gt;    commit();
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A OR B&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt; should not be found.
&lt;/span&gt;  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testAddRollback() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;));
    commit();
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;));
    rollback();
    commit();
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A OR B&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt; should not be found.
&lt;/span&gt;  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testDeleteRollback() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;));
    add(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;));
    commit();
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A OR B&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt; and &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt; should be found.
&lt;/span&gt;    delete(doc(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;));
    rollback();
    commit();
    search(&lt;span class=&quot;code-quote&quot;&gt;&quot;A OR B&quot;&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt; and &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt; should be found.
&lt;/span&gt;  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12639775" author="shalinmangar" created="Wed, 15 Oct 2008 10:21:36 +0100"  >&lt;p&gt;Thanks for the patch Koji. Updated with a few changes:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;CSVRequestHandler#handleRequestBody should call handleRollback if streams is null just like it calls handleCommit&lt;/li&gt;
	&lt;li&gt;XmlUpdateRequestHandler#handleRequestBody should call handleRollback if streams is null just like it calls handleCommit&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Let us think about SolrEventListener changes if users ask for it. Off hand, I can&apos;t think of a use-case.&lt;/p&gt;

&lt;p&gt;I shall commit this shortly.&lt;/p&gt;</comment>
                            <comment id="12639779" author="shalinmangar" created="Wed, 15 Oct 2008 10:30:55 +0100"  >&lt;p&gt;Forgot to upload the patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12639794" author="shalinmangar" created="Wed, 15 Oct 2008 11:40:06 +0100"  >&lt;p&gt;Committed revision 704853.&lt;/p&gt;

&lt;p&gt;Thanks Noble and Koji!&lt;/p&gt;</comment>
                            <comment id="12672441" author="otis" created="Tue, 10 Feb 2009 22:50:20 +0000"  >&lt;p&gt;Is it possible that the new rollback causes the IndexWriter to be closed on error, which then causes the following error next time you try to add a (valid) document?&lt;/p&gt;

&lt;p&gt;Feb 10, 2009 5:46:28 PM org.apache.solr.update.processor.LogUpdateProcessor finish&lt;br/&gt;
INFO: {} 0 1&lt;br/&gt;
Feb 10, 2009 5:46:28 PM org.apache.solr.common.SolrException log&lt;br/&gt;
SEVERE: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:397)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:402)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2108)&lt;br/&gt;
	at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:218)&lt;br/&gt;
	at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:60)&lt;br/&gt;
	at org.apache.solr.handler.XMLLoader.processUpdate(XMLLoader.java:140)&lt;br/&gt;
	at org.apache.solr.handler.XMLLoader.load(XMLLoader.java:69)&lt;br/&gt;
	at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:54)&lt;br/&gt;
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131)&lt;br/&gt;
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:1313)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:303)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:232)&lt;br/&gt;
	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1089)&lt;br/&gt;
	at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:365)&lt;br/&gt;
	at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)&lt;br/&gt;
	at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)&lt;br/&gt;
	at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:712)&lt;br/&gt;
	at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:405)&lt;br/&gt;
	at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:211)&lt;br/&gt;
	at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)&lt;br/&gt;
	at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:139)&lt;br/&gt;
	at org.mortbay.jetty.Server.handle(Server.java:285)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:502)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:835)&lt;br/&gt;
	at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:641)&lt;br/&gt;
	at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:202)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:378)&lt;br/&gt;
	at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:226)&lt;br/&gt;
	at org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:442)&lt;/p&gt;

&lt;p&gt;After rollback is invoked, is one supposed to execute some other command to get Solr in a healthy state?&lt;/p&gt;</comment>
                            <comment id="12672513" author="shalinmangar" created="Wed, 11 Feb 2009 05:31:09 +0000"  >&lt;p&gt;Otis, which Solr version are you using or more specifically what is the revision of Lucene jars? Did you call commit after the rollback?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is it possible that the new rollback causes the IndexWriter to be closed on error, which then causes the following error next time you try to add a (valid) document? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The javadocs for IndexWriter#rollback do not say anything like that, I&apos;ll try to reproduce the problem with trunk.&lt;/p&gt;</comment>
                            <comment id="12672523" author="otis" created="Wed, 11 Feb 2009 06:28:55 +0000"  >&lt;p&gt;That was with Solr trunk (svn up-ed right before trying).&lt;br/&gt;
I did not call commit after rollback when that happened, though I &lt;b&gt;think&lt;/b&gt; I tried adding commit, too, and that didn&apos;t do anything either.&lt;/p&gt;</comment>
                            <comment id="12672526" author="shalinmangar" created="Wed, 11 Feb 2009 06:52:00 +0000"  >&lt;p&gt;I commented out the commit in DirectUpdateHandlerTest#testAddRollback and I saw the same exception.&lt;/p&gt;

&lt;p&gt;org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:410)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:415)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2170)&lt;br/&gt;
	at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:234)&lt;br/&gt;
	at org.apache.solr.update.DirectUpdateHandlerTest.addSimpleDoc(DirectUpdateHandlerTest.java:254)&lt;br/&gt;
	at org.apache.solr.update.DirectUpdateHandlerTest.testAddRollback(DirectUpdateHandlerTest.java:188)&lt;/p&gt;

&lt;p&gt;Now that I&apos;m looking at this again, I don&apos;t see why a commit should be necessary at all. If DUH2#rollbackWriter sets writer=null, then we wouldn&apos;t need to call commit at all and we don&apos;t really need to refresh the IndexSearcher because the index does not change. I&apos;ll re-open the issue and attach a patch.&lt;/p&gt;</comment>
                            <comment id="12672527" author="shalinmangar" created="Wed, 11 Feb 2009 06:52:14 +0000"  >&lt;p&gt;Re-opening per above comment&lt;/p&gt;</comment>
                            <comment id="12672531" author="shalinmangar" created="Wed, 11 Feb 2009 07:05:56 +0000"  >&lt;ol&gt;
	&lt;li&gt;Set writer=null in a finally block in DUH2#rollbackWriter so that there is no need to call commit after a rollback&lt;/li&gt;
	&lt;li&gt;Update DirectUpdateHandlerTest to not call commit and to make sure we can still add documents.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="12672571" author="koji" created="Wed, 11 Feb 2009 10:05:35 +0000"  >&lt;p&gt;Thank you guys. I didn&apos;t recall why I didn&apos;t set writer=null in the finally block when I wrote the first patch... I&apos;d like to try Shalin&apos;s patch, but I couldn&apos;t apply it:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[koji@macbook SOLR-670]$ patch -p0 --dry-run &amp;lt; SOLR-670.patch 
patching file src/test/org/apache/solr/update/DirectUpdateHandlerTest.java
Hunk #1 FAILED at 173.
Hunk #2 FAILED at 183.
Hunk #3 FAILED at 229.
Hunk #4 FAILED at 236.
4 out of 4 hunks FAILED -- saving rejects to file src/test/org/apache/solr/update/DirectUpdateHandlerTest.java.rej
patching file src/java/org/apache/solr/update/DirectUpdateHandler2.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12672574" author="shalinmangar" created="Wed, 11 Feb 2009 10:17:08 +0000"  >&lt;p&gt;There was some problem with the previous patch.&lt;/p&gt;

&lt;p&gt;Koji, can you please try this one?&lt;/p&gt;</comment>
                            <comment id="12672613" author="koji" created="Wed, 11 Feb 2009 12:27:37 +0000"  >&lt;p&gt;Shalin, the patch looks fine. +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12672653" author="shalinmangar" created="Wed, 11 Feb 2009 15:18:56 +0000"  >&lt;p&gt;Committed revision 743359.&lt;/p&gt;

&lt;p&gt;I&apos;ll update the wiki with more details on the rollback command.&lt;/p&gt;</comment>
                            <comment id="12764683" author="koji" created="Mon, 12 Oct 2009 14:48:27 +0100"  >&lt;p&gt;Rollback should reset not only adds/deletesById/deletesByQuery counts but also cumulative counts of them.&lt;/p&gt;</comment>
                            <comment id="12764699" author="koji" created="Mon, 12 Oct 2009 15:40:42 +0100"  >&lt;p&gt;The fix and test case. I&apos;ll commit soon.&lt;/p&gt;</comment>
                            <comment id="12764731" author="koji" created="Mon, 12 Oct 2009 17:06:23 +0100"  >&lt;p&gt;Committed revision 824380.&lt;/p&gt;</comment>
                            <comment id="12775520" author="gsingers" created="Tue, 10 Nov 2009 15:51:46 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12421876" name="SOLR-670-revert-cumulative-counts.patch" size="3817" author="koji" created="Mon, 12 Oct 2009 15:40:42 +0100"/>
                            <attachment id="12400002" name="SOLR-670.patch" size="2641" author="shalinmangar" created="Wed, 11 Feb 2009 10:17:08 +0000"/>
                            <attachment id="12399986" name="SOLR-670.patch" size="2666" author="shalinmangar" created="Wed, 11 Feb 2009 07:05:56 +0000"/>
                            <attachment id="12392171" name="SOLR-670.patch" size="23354" author="shalinmangar" created="Wed, 15 Oct 2008 10:30:54 +0100"/>
                            <attachment id="12391629" name="SOLR-670.patch" size="23432" author="koji" created="Tue, 7 Oct 2008 14:15:19 +0100"/>
                            <attachment id="12391487" name="SOLR-670.patch" size="16944" author="koji" created="Sun, 5 Oct 2008 08:55:55 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 5 Oct 2008 07:55:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6944</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxpxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20519</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>