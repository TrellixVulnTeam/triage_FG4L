<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:25:08 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-1394/SOLR-1394.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-1394] HTML stripper is splitting tokens</title>
                <link>https://issues.apache.org/jira/browse/SOLR-1394</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The Solr HTML stripper is replacing any removed HTML with whitespace. This is to keep offsets correct for highlighting.&lt;/p&gt;

&lt;p&gt;However, as was already pointed out in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-42&quot; title=&quot;Highlighting problems with HTMLStripWhitespaceTokenizerFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-42&quot;&gt;&lt;del&gt;SOLR-42&lt;/del&gt;&lt;/a&gt;, this means that any token containing an HTML entity will be split into several tokens. That makes the HTML stripper completely unreliable for international text (and any text is potentially interantional).&lt;/p&gt;

&lt;p&gt;The current code is actually deficient for BOTH highlighting and indexing, where the previous incarnation (that did not insert spaces) only had problems with highlighting.&lt;/p&gt;

&lt;p&gt;The only workaround is to not use entities at all, which is impossible in some situations and inconvenient in most situations. If the client is required to transform entities before handing it to Solr, it might as well be required to also strip tags, and then the HTML stripper would not be needed at all.&lt;/p&gt;

&lt;p&gt;Today, we have a better solution that can be used: offset correction. We can then avoid inserting extra whitespace, but still get correct offsets. The attached patch implements just that.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12434353">SOLR-1394</key>
            <summary>HTML stripper is splitting tokens</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="andersm">Anders Melchiorsen</reporter>
                        <labels>
                    </labels>
                <created>Sat, 29 Aug 2009 15:25:22 +0100</created>
                <updated>Tue, 10 Nov 2009 15:52:14 +0000</updated>
                            <resolved>Fri, 16 Oct 2009 23:22:14 +0100</resolved>
                                    <version>1.4</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>Schema and Analysis</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12749153" author="andersm" created="Sat, 29 Aug 2009 15:31:59 +0100"  >&lt;p&gt;Proof-of-concept fixes. I don&apos;t expect them to be perfect.&lt;/p&gt;

&lt;p&gt;There is one test that still breaks. I think the test does not make sense with my changes, but I did not remove it.&lt;/p&gt;

&lt;p&gt;Also, the new functionality (offset correction) is not tested. I don&apos;t know how to do it.&lt;/p&gt;</comment>
                            <comment id="12749193" author="andersm" created="Sat, 29 Aug 2009 23:18:25 +0100"  >&lt;p&gt;Right version of patch file.&lt;/p&gt;</comment>
                            <comment id="12753911" author="jasonrutherglen" created="Fri, 11 Sep 2009 01:09:26 +0100"  >&lt;p&gt;I&apos;m also seeing this problem and will try out the patch (after a number of other issues are fixed!)&lt;/p&gt;</comment>
                            <comment id="12753913" author="jasonrutherglen" created="Fri, 11 Sep 2009 01:13:28 +0100"  >&lt;p&gt;Here&apos;s the exception:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Caused by: java.io.IOException: Mark invalid&lt;br/&gt;
	at java.io.BufferedReader.reset(BufferedReader.java:485)&lt;br/&gt;
	at org.apache.solr.analysis.HTMLStripReader.restoreState(HTMLStripReader.java:171)&lt;br/&gt;
	at org.apache.solr.analysis.HTMLStripReader.read(HTMLStripReader.java:728)&lt;br/&gt;
	at org.apache.solr.analysis.HTMLStripReader.read(HTMLStripReader.java:742)&lt;br/&gt;
	at org.apache.lucene.analysis.CharReader.read(CharReader.java:51)&lt;br/&gt;
	at org.apache.lucene.analysis.standard.StandardTokenizerImpl.zzRefill(StandardTokenizerImpl.java:451)&lt;br/&gt;
	at org.apache.lucene.analysis.standard.StandardTokenizerImpl.getNextToken(StandardTokenizerImpl.java:637)&lt;br/&gt;
	at org.apache.lucene.analysis.standard.StandardTokenizer.next(StandardTokenizer.java:198)&lt;br/&gt;
	at org.apache.lucene.analysis.standard.StandardFilter.next(StandardFilter.java:84)&lt;br/&gt;
	at org.apache.lucene.analysis.LowerCaseFilter.next(LowerCaseFilter.java:53)&lt;br/&gt;
	at org.apache.solr.analysis.EnglishPorterFilter.next(EnglishPorterFilterFactory.java:108)&lt;br/&gt;
	at org.apache.lucene.analysis.StopFilter.next(StopFilter.java:245)&lt;br/&gt;
	at org.apache.lucene.index.DocInverterPerField.processFields(DocInverterPerField.java:162)&lt;/p&gt;
&lt;/blockquote&gt;</comment>
                            <comment id="12754032" author="andersm" created="Fri, 11 Sep 2009 08:33:15 +0100"  >&lt;p&gt;In which situation do you get this exception?&lt;/p&gt;</comment>
                            <comment id="12754215" author="jasonrutherglen" created="Fri, 11 Sep 2009 18:02:30 +0100"  >&lt;blockquote&gt;&lt;p&gt;In which situation do you get this exception? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We need to log the HTML.  I&apos;ll post it when we implement the logging.&lt;/p&gt;</comment>
                            <comment id="12755421" author="andersm" created="Tue, 15 Sep 2009 09:22:27 +0100"  >&lt;p&gt;Jason, did you get that exception with (and not without) my patch? You said that you had other problems as well, so I just want to make sure that it is a problem with the patch ...&lt;/p&gt;</comment>
                            <comment id="12755600" author="jasonrutherglen" created="Tue, 15 Sep 2009 18:40:16 +0100"  >&lt;p&gt;Anders, The error occurs with the existing HTML stripper code in Solr&apos;s trunk.&lt;/p&gt;</comment>
                            <comment id="12757676" author="yseeley@gmail.com" created="Sat, 19 Sep 2009 17:31:54 +0100"  >&lt;p&gt;What&apos;s clear is that the html stripper still has problems - less clear to me is if this patch as it currently exists is better than what&apos;s in trunk.... if people think it is, we could commit it quickly for 1.4&lt;/p&gt;</comment>
                            <comment id="12757686" author="andersm" created="Sat, 19 Sep 2009 19:39:05 +0100"  >&lt;p&gt;To me (the author), things are much better with the patch, and I have seen no ill effects. The exception that Jason reported happens &lt;b&gt;without&lt;/b&gt; the patch.&lt;/p&gt;

&lt;p&gt;My problem is that I cannot really vouch for the patch, as I have no previous experience with the Solr code. So, it would be really nice if someone with the experience could take fifteen minutes to review the three tiny modifications.&lt;/p&gt;

&lt;p&gt;When replacing read() with next() in one of the patches, I noted that I was not sure why it worked better. I have later figured out that read() is the external interface, so it should (probably?) not be used internally by the stripper.&lt;/p&gt;</comment>
                            <comment id="12758519" author="jasonrutherglen" created="Wed, 23 Sep 2009 01:54:54 +0100"  >&lt;p&gt;Anders, &lt;/p&gt;

&lt;p&gt;We&apos;re seeing the error again, we&apos;re going to try this patch and&lt;br/&gt;
HTMLStripReader and we&apos;ll see what happens. Here&apos;s the latest&lt;br/&gt;
stacktrace, which is pretty much the same as the last one:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SEVERE: java.io.IOException: Mark invalid
	at java.io.BufferedReader.reset(BufferedReader.java:485)
	at org.apache.lucene.analysis.CharReader.reset(CharReader.java:63)
	at org.apache.solr.analysis.HTMLStripCharFilter.restoreState(HTMLStripCharFilter.java:170)
	at org.apache.solr.analysis.HTMLStripCharFilter.read(HTMLStripCharFilter.java:727)
	at org.apache.solr.analysis.HTMLStripCharFilter.read(HTMLStripCharFilter.java:741)
	at org.apache.lucene.analysis.standard.StandardTokenizerImpl.zzRefill(StandardTokenizerImpl.java:451
)
	at org.apache.lucene.analysis.standard.StandardTokenizerImpl.getNextToken(StandardTokenizerImpl.java
:637)
	at org.apache.lucene.analysis.standard.StandardTokenizer.incrementToken(StandardTokenizer.java:174)
	at org.apache.lucene.analysis.standard.StandardFilter.incrementToken(StandardFilter.java:50)
	at org.apache.lucene.analysis.LowerCaseFilter.incrementToken(LowerCaseFilter.java:38)
	at org.apache.solr.analysis.SnowballPorterFilter.incrementToken(SnowballPorterFilterFactory.java:116
)
	at org.apache.lucene.analysis.TokenStream.next(TokenStream.java:401)
	at org.apache.solr.analysis.BufferedTokenStream.read(BufferedTokenStream.java:94)
	at org.apache.solr.analysis.BufferedTokenStream.next(BufferedTokenStream.java:80)
	at org.apache.lucene.analysis.TokenStream.incrementToken(TokenStream.java:316)
	at org.apache.lucene.analysis.StopFilter.incrementToken(StopFilter.java:224)
	at org.apache.lucene.index.DocInverterPerField.processFields(DocInverterPerField.java:138)
	at org.apache.lucene.index.DocFieldProcessorPerThread.processDocument(DocFieldProcessorPerThread.jav
a:244)
	at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:772)
	at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:755)
	at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2611)
	at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2583)
	at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:241)
	at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:61)
	at org.apache.solr.handler.XMLLoader.processUpdate(XMLLoader.java:140)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12764768" author="andersm" created="Mon, 12 Oct 2009 19:00:06 +0100"  >&lt;p&gt;A reworked patch that should be easier to review.&lt;/p&gt;

&lt;p&gt;Now also includes a few new tests to show the problems that this patch is fixing.&lt;/p&gt;</comment>
                            <comment id="12765490" author="andersm" created="Wed, 14 Oct 2009 10:44:37 +0100"  >&lt;p&gt;Clarifying the description, the original report was just a pasted e-mail.&lt;/p&gt;</comment>
                            <comment id="12766727" author="yseeley@gmail.com" created="Fri, 16 Oct 2009 22:58:35 +0100"  >&lt;p&gt;I&apos;ve been testing this with a bunch of different HTML, and I don&apos;t see any places where this is worse, and it prevents splitting of tokens when it shouldn&apos;t.&lt;br/&gt;
Given that the splitting is clearly a bug, and that changes to this filter won&apos;t affect the rest of Solr, I plan on committing this shortly.&lt;/p&gt;

&lt;p&gt;Things still aren&apos;t perfect as far as offsets and highlighting, but this patch makes it no worse.&lt;/p&gt;

&lt;p&gt;I modified the solr.xml document to escape the &apos;&amp;amp;&apos;  and then added the strip char filter to the text field.&lt;br/&gt;
The query was h&#233;llo OR hello OR unicode&lt;br/&gt;
Before this patch:  Good &amp;lt;em&amp;gt;unicode&amp;lt;/em&amp;gt; support: h&amp;#xE9;llo &amp;lt;em&amp;gt;(hell&amp;lt;/em&amp;gt;o with an accent over the e)&lt;br/&gt;
After this patch: Good &amp;lt;em&amp;gt;unicode&amp;lt;/em&amp;gt; support: &amp;lt;em&amp;gt;h&amp;#xE9;ll&amp;lt;/em&amp;gt;o &amp;lt;em&amp;gt;(hell&amp;lt;/em&amp;gt;o with &#233; accent over the e)&lt;/p&gt;</comment>
                            <comment id="12766735" author="andersm" created="Fri, 16 Oct 2009 23:17:36 +0100"  >&lt;p&gt;Thanks, that sounds great.&lt;/p&gt;

&lt;p&gt;There is an existing off-by-one error in the numWhitespace calculation with hexadecimal numeric entities.&lt;/p&gt;

&lt;p&gt;I noticed that while reworking the patch, but did not bother to report it in here because I was annoyed from being ignored. Now you got me in a better mood, so I can fix that error if you like?&lt;/p&gt;</comment>
                            <comment id="12766738" author="yseeley@gmail.com" created="Fri, 16 Oct 2009 23:22:14 +0100"  >&lt;p&gt;Committed.  Thanks Anders!&lt;/p&gt;</comment>
                            <comment id="12766739" author="yseeley@gmail.com" created="Fri, 16 Oct 2009 23:25:12 +0100"  >&lt;blockquote&gt;&lt;p&gt;Now you got me in a better mood, so I can fix that error if you like?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Didn&apos;t see your message before the commit - yes, a patch would be great! Could possibly make it into 1.4 still if you&apos;re quick &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12766744" author="andersm" created="Fri, 16 Oct 2009 23:27:32 +0100"  >&lt;p&gt;I did not even test that this patch compiles, but it should show what I had in mind.&lt;/p&gt;

&lt;p&gt;I will not have time to work on this during the weekend.&lt;/p&gt;</comment>
                            <comment id="12766952" author="yseeley@gmail.com" created="Sat, 17 Oct 2009 20:56:29 +0100"  >&lt;p&gt;It works!  I added some tests, and committed.  Thanks again!&lt;/p&gt;</comment>
                            <comment id="12775860" author="gsingers" created="Tue, 10 Nov 2009 15:52:14 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12421885" name="SOLR-1394.patch" size="15440" author="andersm" created="Mon, 12 Oct 2009 19:00:06 +0100"/>
                            <attachment id="12418075" name="SOLR-1394.patch" size="6735" author="andersm" created="Sat, 29 Aug 2009 23:18:25 +0100"/>
                            <attachment id="12422409" name="hex-entity.patch" size="1710" author="andersm" created="Fri, 16 Oct 2009 23:27:32 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 11 Sep 2009 00:09:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6258</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxlj3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>