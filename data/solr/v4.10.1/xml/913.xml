<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:25:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-913/SOLR-913.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-913] org/apache/solr/handler/SnapPuller.java  - Expensive Pattern object made static (HttpClient object too ) </title>
                <link>https://issues.apache.org/jira/browse/SOLR-913</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In the class -  org.apache.solr.handler.SnapPuller - there seems to be an expensive Pattern object created locally in the method &lt;/p&gt;

&lt;p&gt;  static Integer readInterval(String interval) ; &lt;/p&gt;

&lt;p&gt;Pattern instances are better created as static objects and reused.&lt;/p&gt;

&lt;p&gt;The same is true for HttpClient instances. These are one per core right now. We can make that static too.&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Tomcat 6, JRE 6 &lt;/p&gt;</environment>
        <key id="12410658">SOLR-913</key>
            <summary>org/apache/solr/handler/SnapPuller.java  - Expensive Pattern object made static (HttpClient object too ) </summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalinmangar">Shalin Shekhar Mangar</assignee>
                                    <reporter username="kaykay.unique">Karthik K</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Dec 2008 17:14:39 +0000</created>
                <updated>Fri, 19 Dec 2008 19:21:20 +0000</updated>
                            <resolved>Wed, 17 Dec 2008 12:07:15 +0000</resolved>
                                                    <fixVersion>1.4</fixVersion>
                                    <component>replication (java)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <timeoriginalestimate seconds="7200">2h</timeoriginalestimate>
                            <timeestimate seconds="7200">2h</timeestimate>
                                        <comments>
                            <comment id="12656414" author="kaykay.unique" created="Sun, 14 Dec 2008 17:16:56 +0000"  >&lt;p&gt;Pattern object is a static object instead of being created locally in a function since the regex pattern object is very expensive to create. &lt;/p&gt;</comment>
                            <comment id="12656419" author="noble.paul" created="Sun, 14 Dec 2008 17:43:23 +0000"  >&lt;p&gt;this object is used only in the startup a couple of times  It is better to use it and throw away rather than holding on to the reference forever&lt;/p&gt;</comment>
                            <comment id="12656422" author="shalinmangar" created="Sun, 14 Dec 2008 17:50:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;this object is used only in the startup a couple of times It is better to use it and throw away rather than holding on to the reference forever&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I just committed this, too trigger happy you see &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;But I see your point, this method is used on startup only. Is it worth reverting this change?&lt;/p&gt;</comment>
                            <comment id="12656423" author="shalinmangar" created="Sun, 14 Dec 2008 18:01:46 +0000"  >&lt;p&gt;Marking as won&apos;t fix because the readInterval method is called only on core startup and it is better to create and throw away Pattern object rather then keep it in static.&lt;/p&gt;

&lt;p&gt;Thanks for going through the code Kay, please keep the suggestions coming &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12656426" author="kaykay.unique" created="Sun, 14 Dec 2008 18:09:20 +0000"  >&lt;p&gt;The bigger problem that we are trying to address on our end is a fast SolrCore shutdown and restart and this is part of the bigger picture. &lt;/p&gt;

&lt;p&gt;Pattern objects are notoriously heavy to create. &lt;/p&gt;

&lt;p&gt;If necessary - they could be wrapped around as a resource handler that can set the static reference to null after the last use so that the static reference does not take up the space.  &lt;/p&gt;

&lt;p&gt;Allowing this to persist because we have 2 calls might affect the scalability as some other piece of code , inadvertently uses the same. &lt;/p&gt;</comment>
                            <comment id="12656429" author="shalinmangar" created="Sun, 14 Dec 2008 18:15:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;The bigger problem that we are trying to address on our end is a fast SolrCore shutdown and restart and this is part of the bigger picture.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This does not cause longer shutdowns. If it is used only once in the lifetime of a core, why would we need to keep it around all the time?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If necessary - they could be wrapped around as a resource handler that can set the static reference to null after the last use so that the static reference does not take up the space.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As Noble pointed out, it is not used more than once. Keeping it static and then nulling the reference after the only use, serves no purpose.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Allowing this to persist because we have 2 calls might affect the scalability as some other piece of code , inadvertently uses the same.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I do not understand this point at all.&lt;/p&gt;</comment>
                            <comment id="12656432" author="kaykay.unique" created="Sun, 14 Dec 2008 18:28:54 +0000"  >&lt;p&gt;It causes longer time to restart in terms of recreating the heavy Pattern object once again. &lt;/p&gt;

&lt;p&gt;There is a difference between keeping a static reference pointing to a live object and setting it to null . In the case of the latter - it definitely frees up the memory on a good implementation. &lt;/p&gt;

&lt;p&gt;I meant to say  that - if there were to be another piece of code , that inadvertently - calls this piece of code  once again by creating additional Pattern objects would be suicidal. These are not random starting pain points that I am encountering in the startup but rather in the descending order of the time from profiling the shutdown / startup process. &lt;/p&gt;

&lt;p&gt;While I believe the concern about static Pattern object is misplaced - we can implement a global ResourceMap with Key as String, Object and the users of the Resources removing entries from the Map after they are used . This is pretty standard across projects in the sense it addresses the issue of duplicate creation of resources and the issue of releasing the resources after the last use. &lt;/p&gt;</comment>
                            <comment id="12656434" author="noble.paul" created="Sun, 14 Dec 2008 18:35:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;if there were to be another piece of code , that inadvertently - calls this piece of code once again by creating additional Pattern objects would be suicidal&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;there is no other piece of code currently calling it inside Solr.&lt;/p&gt;

&lt;p&gt;There is a tradeoff of complexity Vs. perf advantage&lt;/p&gt;

&lt;p&gt;Maintaining a large system such as Solr is hard as it is. So we have to keep in mind that we keep the code simpler. Unless there is a known issue let us not solve it now and add complexity&lt;/p&gt;
</comment>
                            <comment id="12656469" author="kaykay.unique" created="Sun, 14 Dec 2008 21:40:02 +0000"  >&lt;p&gt;As mentioned earlier - this is a bottleneck got from profiling.   By providing better abstractions - we can move make complex systems more tractable.  Performance advantage, for something as big as a regex object, is  not something that should not be sacrificed here in this case. &lt;/p&gt;
</comment>
                            <comment id="12656485" author="ryantxu" created="Sun, 14 Dec 2008 22:25:09 +0000"  >&lt;p&gt;How many cores how often?   Does changing it to static make any mesurable difference?&lt;/p&gt;

&lt;p&gt;A bottleneck has to be &lt;b&gt;somewhere&lt;/b&gt; &amp;#8211; perhaps it is not really an issue (i don&apos;t know if it is or is not) &amp;#8211; it sounds like this was designed thinking the function is called infrequently while your use case is different...&lt;/p&gt;</comment>
                            <comment id="12656534" author="noble.paul" created="Mon, 15 Dec 2008 03:25:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;As mentioned earlier - this is a bottleneck got from profiling&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Profiling tools alone cannot be used to make a judgment because they are dumb and just spits out suggestions on the basis of a few rules. While it is useful, we need to study the environment in which the code is run and  a it is good to have better understanding of a system to make relevant changes. &lt;br/&gt;
It is also worthwhile to run the system and see the real-world impact .&lt;/p&gt;

</comment>
                            <comment id="12656571" author="noble.paul" created="Mon, 15 Dec 2008 08:17:34 +0000"  >&lt;p&gt;Is it true that you have a large no:of cores and you start/stop them very frequently and the start/stop performance is a concern for you?&lt;/p&gt;</comment>
                            <comment id="12656711" author="kaykay.unique" created="Mon, 15 Dec 2008 19:28:25 +0000"  >&lt;p&gt; &amp;gt; Is it true that you have a large no:of cores and you start/stop them very frequently and the start/stop performance is a concern for you? &lt;/p&gt;

&lt;p&gt;Unfortunately yes. Hence my focus has been primarily on profiling the code path to start the solr system  and hence to stress this. I agree with your concern about having static objects being live (after their intended use ) affecting memory but may be that could be grouped under ResourceMap but recreating the Pattern object , internally with all the NFA graph compilation would be better to be optimized as against the memory constraint.&lt;/p&gt;</comment>
                            <comment id="12656872" author="noble.paul" created="Tue, 16 Dec 2008 03:58:28 +0000"  >&lt;p&gt;OK. In that case this is a valid concern . It is better off to make it a static object so that every core startup can reuse the same instance. &lt;/p&gt;</comment>
                            <comment id="12656888" author="shalinmangar" created="Tue, 16 Dec 2008 05:41:03 +0000"  >&lt;p&gt;HttpClient can be made static too in that case.&lt;/p&gt;</comment>
                            <comment id="12656892" author="shalinmangar" created="Tue, 16 Dec 2008 05:51:39 +0000"  >&lt;p&gt;Attached patch changes HttpClient to static as well so that connections may be shared in cases of multiple cores.&lt;/p&gt;</comment>
                            <comment id="12657017" author="kaykay.unique" created="Tue, 16 Dec 2008 15:26:08 +0000"  >&lt;p&gt;Shalin - the new patch looks good. Thanks for helping with it. &lt;/p&gt;

&lt;p&gt;Thanks everybody in the thread for the discussions regarding this. &lt;/p&gt;</comment>
                            <comment id="12657361" author="shalinmangar" created="Wed, 17 Dec 2008 12:07:15 +0000"  >&lt;p&gt;Committed revision 727354.&lt;/p&gt;

&lt;p&gt;Thanks Kay!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12396158" name="SOLR-913.patch" size="2062" author="shalinmangar" created="Tue, 16 Dec 2008 05:51:39 +0000"/>
                            <attachment id="12396034" name="SOLR-913.patch" size="1099" author="kaykay.unique" created="Sun, 14 Dec 2008 17:16:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 14 Dec 2008 17:43:23 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6720</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxofr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20278</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>