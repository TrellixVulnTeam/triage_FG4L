<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:22:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-65/SOLR-65.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-65] Multithreaded DirectUpdateHandler2</title>
                <link>https://issues.apache.org/jira/browse/SOLR-65</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Basic implementation of autoCommi functionality, plus overhaul of DUH2 threading to reduce contention&lt;/p&gt;</description>
                <environment></environment>
        <key id="12354643">SOLR-65</key>
            <summary>Multithreaded DirectUpdateHandler2</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klaasm">Mike Klaas</assignee>
                                    <reporter username="klaasm">Mike Klaas</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Nov 2006 01:28:23 +0000</created>
                <updated>Fri, 10 May 2013 11:40:39 +0100</updated>
                            <resolved>Thu, 9 Nov 2006 00:46:04 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12446791" author="klaasm" created="Fri, 3 Nov 2006 01:32:14 +0000"  >&lt;p&gt;Basic autocommit implementation.&lt;/p&gt;

&lt;p&gt;Not complete: this patch still requires a scheduled call to checkCommit() to have the correct semantics--it is something I&apos;m working on.&lt;/p&gt;

&lt;p&gt;I posted this patch to get feedback on the thread synchronization strategy.  I eliminated all synchronized blocks, and instead am using a reader/writer lock from java.util.concurrent for synchro.  Virtually everything is serialized using the writer lock (like the old strategy), but document adding degrades its lock to a lowered-contention reader lock before adding hte document to the index.&lt;/p&gt;</comment>
                            <comment id="12447010" author="yseeley@gmail.com" created="Fri, 3 Nov 2006 17:00:37 +0000"  >&lt;p&gt;The multithreaded stuff looks very nice!&lt;/p&gt;

&lt;p&gt;I like the idea of separating out the autoCommit functionallity into a tracker.&lt;/p&gt;

&lt;p&gt;I notice that in closeWriter() you call tracker.didCommit()... but I think of a commit more as making sure everything is on stable storage, and making those changes visible.  closeWriter() is also currently called as an implementation side effect of delete-by-query.&lt;/p&gt;

&lt;p&gt;There are some different uses for commit control that I can think of:&lt;br/&gt;
 1) users don&apos;t want to manually send commits, and want to ensure that any changes made to the index will be visible within a certain amount of time.&lt;br/&gt;
 2) in the event of multiple updaters all calling commit often, the index owner wants to limit the commit frequency to avoid search degredation (or OOM errors from too many overlapping on-deck searchers).&lt;br/&gt;
 3) there are infrequent single updates to an index, but when they happen a commit should be done ASAP to lower the latency till visibility.  Subject to limitations in (2)&lt;/p&gt;

&lt;p&gt;It&apos;s possible people might even want tuning on the fly.&lt;br/&gt;
For instance, if you are about to do a compete index rebuild, it would be nice to be able to turn off any autocommitting or commits alltogether to avoid partial indexes being visible.  This could be done with special update commands, or perhaps flags on the &amp;lt;add&amp;gt; command?&lt;/p&gt;</comment>
                            <comment id="12447101" author="klaasm" created="Sat, 4 Nov 2006 00:18:26 +0000"  >&lt;p&gt;&amp;gt; The multithreaded stuff looks very nice! &lt;/p&gt;

&lt;p&gt;Thanks &amp;#8211; the new concurrent package is quite cool (it much better fits my mental model of thread synchro).&lt;/p&gt;

&lt;p&gt;About the closeWriter() -&amp;gt; absolutely correct.  I had totally forgotten about the importance of opening a new searcher as part of the commit.&lt;/p&gt;

&lt;p&gt;1) sounds good.  &lt;br/&gt;
2) does this include explicit commits received?  Might this make it tricky to test (both on solr&apos;s side and in userland)?  Perhaps the default commit could be an absolute directive, but could accept an optional parameter that allows the commit to be cancelled by the intervalLowerBound parameter.  Something like &amp;lt;commit hint=&quot;true&quot;/&amp;gt;.  Or it could be a new command &amp;lt;softcommit/&amp;gt;.  autocommits would also fall into that category.  &lt;br/&gt;
3) would this case be covered by the client sending an &amp;lt;add&amp;gt; followed by &amp;lt;softcommit/&amp;gt;?&lt;/p&gt;

&lt;p&gt;The on-the-fly tuning is possible for maxDocs autocommit but isn&apos;t practical for maxTime, since the time-based auto-commit is a system-wide property (whereas maxDocs are only checked within the context of a given request, so it is trivial to turn off checking locally).  It might be better to have some sort of global parameter tuning possible here (jmx??).&lt;/p&gt;

&lt;p&gt;-Mike &lt;/p&gt;</comment>
                            <comment id="12447104" author="hossman" created="Sat, 4 Nov 2006 01:07:45 +0000"  >&lt;p&gt;Thining about this purely from a configuration standpoint, without any regard to implimentation complexity, the most general pupose options i can think of would be:&lt;/p&gt;

&lt;p&gt;   commitFrequencyHardMin (milliseconds)&lt;br/&gt;
   commitFrequencySoftMin (milliseconds greater then commitFrequencyHardMin)&lt;br/&gt;
   commitFrequencyTestDelay (milliseconds)&lt;br/&gt;
   commitFrequencySoftMax (milliseconds greater then commitFrequencySoftMin)&lt;br/&gt;
   commitFrequencyHardMax (milliseconds greater then commitFrequencySoftMax)&lt;br/&gt;
   autoCommitDocs (integer)&lt;/p&gt;

&lt;p&gt;...assuming timeSinceLastCommit, timeSinceLastAddOrDelete, and numDocsAddedSinceLastCommit are available to is, these are the situations in which a commit would happen...&lt;/p&gt;

&lt;p&gt;   a) commitFrequencyHardMax &amp;lt;= timeSinceLastCommit&lt;br/&gt;
   b) commitFrequencySoftMax &amp;lt;= timeSinceLastCommit &amp;lt; commitFrequencyHardMax&lt;br/&gt;
       &amp;amp;&amp;amp; commitFrequencyTestDelay &amp;lt;= timeSinceLastAddOrDelete&lt;br/&gt;
   c) commitFrequencySoftMin &amp;lt;= timeSinceLastCommit &amp;lt; commitFrequencySoftMax&lt;br/&gt;
       &amp;amp;&amp;amp; &lt;span class=&quot;error&quot;&gt;&amp;#91;commit command recieved&amp;#93;&lt;/span&gt;&lt;br/&gt;
   d) commitFrequencyHardMin &amp;lt;= timeSinceLastCommit &amp;lt; commitFrequencySoftMin&lt;br/&gt;
       &amp;amp;&amp;amp; commitFrequencyTestDelay &amp;lt;= timeSinceLastAddOrDelete &lt;br/&gt;
       &amp;amp;&amp;amp; &lt;span class=&quot;error&quot;&gt;&amp;#91;commit command recieved&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The situation where autoCommitDocs &amp;lt;= numDocsAddedSinceLastCommit would be generate a commit command (just as if a user had issued it)&lt;/p&gt;

&lt;p&gt;I &lt;b&gt;think&lt;/b&gt; that various usages of those params (assuming they could be modified on the lfy using JMX or some new command) would cover all of the use cases yonik described, as well as all the ones i can think of.&lt;/p&gt;

&lt;p&gt;(implimenting that may be overkill however)&lt;/p&gt;</comment>
                            <comment id="12447118" author="klaasm" created="Sat, 4 Nov 2006 04:23:02 +0000"  >&lt;p&gt;It certainly appears that there is far more to this functionality than I have put thought into (mostly as the usage patterns are rather different from my usage of solr), and I&apos;m inclined to think that this functionality is better implemented by someone with more time/motivation (especially considering we have a volunteer).&lt;/p&gt;

&lt;p&gt;The important part of this patch for me is the multi-threaded indexing, and a max-doc autocommit would also be nice.  I also think that these two items are the least controversial.  How about I reduce the scope of the patch to those two items, leaving potential for more autocommit constraints?&lt;/p&gt;</comment>
                            <comment id="12447196" author="yseeley@gmail.com" created="Sat, 4 Nov 2006 21:10:07 +0000"  >&lt;p&gt;&amp;gt; How about I reduce the scope of the patch to those two items, leaving potential for more autocommit constraints?&lt;br/&gt;
Sounds good.&lt;/p&gt;</comment>
                            <comment id="12447609" author="klaasm" created="Tue, 7 Nov 2006 02:40:22 +0000"  >&lt;p&gt;New patch.&lt;/p&gt;

&lt;p&gt;First, the locking semantics actually were wrong.  Since ever addDoc call grabbed the commit lock and downgraded to access lock, subsequent calls would block on the commit.  I tried a few vastly different schemes, and it took a while to figure out something that allowed concurrency but also gave the same protections as before.  I finally settled on using the read/write commit lock as the principal lock, with a touch of synchronization to protect the addDoc calls.&lt;/p&gt;

&lt;p&gt;That finally enabled concurrency, but other bottlenecks emerged.  checkCommit() was grabbing the commit lock, which created a barrier at the end of every addDoc call which  was forced to wait for all pending addDoc calls.  Switched to synchro on the tracker (synchronizing on DUH2 would provoke a potential deadlock).&lt;/p&gt;

&lt;p&gt;Finally, there was significant contention on the lock for the logger output stream.  When merging wasn&apos;t occuring, the doc rate could reach 200-300 dps, and each docId was being logged.  I modified the bulk add code to log the docid of all documents in a single log statement.  While I was at it, I converted the &amp;lt;result&amp;gt; output for multi-adds to a single xml element.  Was more information going to be added to this?&lt;/p&gt;

&lt;p&gt;The gains of multi-threaded indexing for my application are modest.  The cpu usage is &amp;gt;100% consistently; it drops a bit during medium merges and drops a lot during large merges (merges effectively serialize adding documents).  Still, the throughput gain is about 20-30%.  In retrospect, this isn&apos;t terribly surprising, as our analysis is relatively modest.  Applications with heavier analysis needs would see more gains. &lt;/p&gt;</comment>
                            <comment id="12447614" author="klaasm" created="Tue, 7 Nov 2006 03:21:51 +0000"  >&lt;p&gt;This is the issue that the patch belongs to. sorry.&lt;/p&gt;</comment>
                            <comment id="12447622" author="klaasm" created="Tue, 7 Nov 2006 04:19:11 +0000"  >&lt;p&gt;The last patch has a screwup which causes a few tests to fail... this will be fixed in the next version.&lt;/p&gt;</comment>
                            <comment id="12448024" author="klaasm" created="Wed, 8 Nov 2006 04:16:03 +0000"  >&lt;p&gt;This version removes the attempt at parsing the rest of the xml if an error occurs during document update.  &lt;/p&gt;

&lt;p&gt;It has mostly already been reviewed, but to summarize, this patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;improves concurrency during multi-threaded document update&lt;/li&gt;
	&lt;li&gt;potentially optimizes huge commits (may prevent a stall if memory is constrained)&lt;/li&gt;
	&lt;li&gt;eliminates the edge cases of document update (esp. multi-doc update) which causes&lt;br/&gt;
   solr to return xml that couldn&apos;t be parsed as a single document (should also solve &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2&quot; title=&quot;adding multiple docs at the same time does not produce a well formed response&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2&quot;&gt;&lt;del&gt;SOLR-2&lt;/del&gt;&lt;/a&gt;; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-54&quot; title=&quot;Invalid XML response returned when adding a  document with a field not declared in solrconfig.xml&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-54&quot;&gt;&lt;del&gt;SOLR-54&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If no-one has objections, I&apos;ll commit the patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="12448273" author="yseeley@gmail.com" created="Wed, 8 Nov 2006 21:06:20 +0000"  >&lt;p&gt;Everything looks good to me.&lt;/p&gt;

&lt;p&gt;&amp;gt; While I was at it, I converted the &amp;lt;result&amp;gt; output for multi-adds to a single xml element. Was more information going to be added to this?&lt;/p&gt;

&lt;p&gt;I don&apos;t think so.&lt;/p&gt;

&lt;p&gt;&amp;gt; Still, the throughput gain is about 20-30%.&lt;/p&gt;

&lt;p&gt;Not too bad... is that for a dual CPU machine?  The number of cores per chip and cores per server are going up (quad cores, Sun niagra, etc), so these types of optimizations will grow in importance.&lt;/p&gt;

&lt;p&gt;I wonder what kind of gains could be had if Lucene could overlap adding of documents (via buffering) with merging of segments.&lt;/p&gt;</comment>
                            <comment id="12448318" author="klaasm" created="Wed, 8 Nov 2006 23:32:43 +0000"  >
&lt;p&gt;   [[ Old comment, sent from unregistered email on Wed, 8 Nov 2006 13:43:59 -0800 ]]&lt;/p&gt;


&lt;p&gt;Yep, that&apos;s a 2-cpu machine.&lt;/p&gt;


&lt;p&gt;A good question--it is definitely possible to test such a scenario by&lt;br/&gt;
manually creating ram segments and adding them (now that&lt;br/&gt;
addIndicesNoOptimize exists).&lt;/p&gt;

&lt;p&gt;It still might be possible to improve parallelism on the solr end by&lt;br/&gt;
allows doc adds and doDeletions to run concurrently, but if that was a&lt;br/&gt;
major bottleneck then the commit frequency could be reduced anyway.&lt;/p&gt;

&lt;p&gt;Thanks for the review,&lt;br/&gt;
-Mike&lt;/p&gt;
</comment>
                            <comment id="12448332" author="klaasm" created="Thu, 9 Nov 2006 00:46:04 +0000"  >&lt;p&gt;Checked in patch r472720&lt;/p&gt;</comment>
                            <comment id="12589360" author="hossman" created="Wed, 16 Apr 2008 00:56:45 +0100"  >&lt;p&gt;This bug was modified as part of a bulk update using the criteria...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Marked (&quot;Resolved&quot; or &quot;Closed&quot;) and &quot;Fixed&quot;&lt;/li&gt;
	&lt;li&gt;Had no &quot;Fix Version&quot; versions&lt;/li&gt;
	&lt;li&gt;Was listed in the CHANGES.txt for 1.1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The Fix Version for all 38 issues found was set to 1.1, email notification&lt;br/&gt;
was suppressed to prevent excessive email.&lt;/p&gt;

&lt;p&gt;For a list of all the issues modified, search jira comments for this&lt;br/&gt;
(hopefully) unique string: 20080415hossman3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12329806">SOLR-2</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12374680">SOLR-320</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12353123">SOLR-54</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12344535" name="autocommit_patch.diff" size="36980" author="klaasm" created="Wed, 8 Nov 2006 04:10:14 +0000"/>
                            <attachment id="12344441" name="autocommit_patch.diff" size="34132" author="klaasm" created="Tue, 7 Nov 2006 03:21:51 +0000"/>
                            <attachment id="12344438" name="autocommit_patch.diff" size="32249" author="klaasm" created="Tue, 7 Nov 2006 02:40:22 +0000"/>
                            <attachment id="12344256" name="autocommit_patch.diff" size="24827" author="klaasm" created="Fri, 3 Nov 2006 01:32:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Nov 2006 17:00:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7517</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxtm7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21117</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>