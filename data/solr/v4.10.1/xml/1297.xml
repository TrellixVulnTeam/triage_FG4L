<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:26:41 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-1297/SOLR-1297.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-1297] Enable sorting by Function Query</title>
                <link>https://issues.apache.org/jira/browse/SOLR-1297</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;It would be nice if one could sort by FunctionQuery.  See also &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-773&quot; title=&quot;Incorporate Local Lucene/Solr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-773&quot;&gt;&lt;del&gt;SOLR-773&lt;/del&gt;&lt;/a&gt;, where this was first mentioned by Yonik as part of the generic solution to geo-search&lt;/p&gt;</description>
                <environment></environment>
        <key id="12431021">SOLR-1297</key>
            <summary>Enable sorting by Function Query</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="gsingers">Grant Ingersoll</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Jul 2009 14:19:12 +0100</created>
                <updated>Wed, 30 Mar 2011 16:45:52 +0100</updated>
                            <resolved>Thu, 20 Jan 2011 00:40:44 +0000</resolved>
                                                    <fixVersion>3.1</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>11</watches>
                                                                <comments>
                            <comment id="12777972" author="gsingers" created="Sat, 14 Nov 2009 17:19:59 +0000"  >&lt;p&gt;Note, there is a temporary workaround for this:  (main query)^0 func(...)&lt;/p&gt;</comment>
                            <comment id="12789551" author="gsingers" created="Fri, 11 Dec 2009 21:45:26 +0000"  >&lt;p&gt;For this, I think we want to be able to do things like:&lt;/p&gt;

&lt;p&gt;Just functions&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sort=dist(2,x,y, point(0,0)) desc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Multiple sort params, some functions, some fields&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sort=weight asc,dist(2,x,y, point(0,0)) asc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If and when a function result cache exists, we should be able to take advantage of that too, but that is an implementation detail.&lt;/p&gt;</comment>
                            <comment id="12789738" author="gsingers" created="Sat, 12 Dec 2009 13:37:36 +0000"  >&lt;p&gt;First crack at a patch.  I think it&apos;s in pretty good shape, but I had to rewrite QueryParsing.parseSort(), so it bears some extra scrutiny (although I put tests in place first).&lt;/p&gt;

&lt;p&gt;Added a bunch of new tests for both parsing and for search (see QueryParsingTest and SortByFunctionTest).  All existing and new tests pass.&lt;/p&gt;
</comment>
                            <comment id="12789811" author="gsingers" created="Sat, 12 Dec 2009 23:04:32 +0000"  >&lt;p&gt;Committed revision 889997.&lt;/p&gt;</comment>
                            <comment id="12835795" author="yseeley@gmail.com" created="Fri, 19 Feb 2010 16:09:44 +0000"  >&lt;p&gt;Just curious - what were the reasons behind adding a getSortField() method to ValueSource?&lt;/p&gt;</comment>
                            <comment id="12835796" author="gsingers" created="Fri, 19 Feb 2010 16:14:43 +0000"  >&lt;p&gt;See the processSort() method in QueryParsing.  Seemed like the logical way for the ValueSource to be able to define how sorting should work for the ValueSource, essentially mirroring getSortField from the FieldType.&lt;/p&gt;</comment>
                            <comment id="12835855" author="yseeley@gmail.com" created="Fri, 19 Feb 2010 17:57:10 +0000"  >&lt;p&gt;function queries aren&apos;t weighted... reopening to track this problem.&lt;/p&gt;</comment>
                            <comment id="12836394" author="gsingers" created="Sun, 21 Feb 2010 16:43:15 +0000"  >&lt;p&gt;Not following. What do I need to fix?&lt;/p&gt;</comment>
                            <comment id="12836398" author="yseeley@gmail.com" created="Sun, 21 Feb 2010 16:54:46 +0000"  >&lt;p&gt;Function queries can contain normal queries, which need weighting to produce correct scores and work properly.  This may not be straightforward to get right, hence I&apos;ve just left this issue open for now.&lt;/p&gt;</comment>
                            <comment id="12839598" author="koji" created="Mon, 1 Mar 2010 08:36:03 +0000"  >&lt;p&gt;When I set &lt;b&gt;bit&lt;/b&gt; complex function to sort parameter, I got the error:&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Must declare sort field or function&lt;br/&gt;
org.apache.solr.common.SolrException: Must declare sort field or function&lt;br/&gt;
	at org.apache.solr.search.QueryParsing.processSort(QueryParsing.java:376)&lt;br/&gt;
	at org.apache.solr.search.QueryParsing.parseSort(QueryParsing.java:281)&lt;br/&gt;
	at org.apache.solr.search.QueryParsingTest.testSort(QueryParsingTest.java:105)&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Attached the fix and the test case.&lt;/p&gt;</comment>
                            <comment id="12842480" author="yseeley@gmail.com" created="Sun, 7 Mar 2010 20:27:01 +0000"  >&lt;p&gt;Finally got a chance to check this out a little more... here are the current issues I think:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;functions need to be weighted (as previously noted)&lt;/li&gt;
	&lt;li&gt;parseSort needs to actually parse the function query with the real function query parsing code, rather than trying to parse it itself first - two sets of parsing code for the same thing will always lead to subtle bugs.  For example, things like query($qq) fail to parse, as do functions with string literals that contain markup like parens.&lt;/li&gt;
	&lt;li&gt;parseFunction is called (that should really be deprecated) which doesn&apos;t use the right QParser (it just constructs a local one with the incorrect core - SolrCore.getSolrCore())&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12842491" author="gsingers" created="Sun, 7 Mar 2010 22:09:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;parseSort needs to actually parse the function query with the real function query parsing code, rather than trying to parse it itself first - two sets of parsing code for the same thing will always lead to subtle bugs. For example, things like query($qq) fail to parse, as do functions with string literals that contain markup like parens.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not sure I understand this, I didn&apos;t write any new parsing code.&lt;/p&gt;</comment>
                            <comment id="12842493" author="yseeley@gmail.com" created="Sun, 7 Mar 2010 22:16:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Not sure I understand this, I didn&apos;t write any new parsing code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You may not be producing a ValueSource, but you added parsing code to parseSort()  to tell if something was a function query and find the end of it.  And I verified it doesn&apos;t work for a couple of cases (the query($qq) and string literals with markup).  We should really just use the actual value source parser itself.&lt;/p&gt;</comment>
                            <comment id="12872581" author="hossman" created="Thu, 27 May 2010 23:08:14 +0100"  >&lt;p&gt;Bulk updating 240 Solr issues to set the Fix Version to &quot;next&quot; per the process outlined in this email...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/lucene-dev/201005.mbox/%3Calpine.DEB.1.10.1005251052040.24672@radix.cryptio.net%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/lucene-dev/201005.mbox/%3Calpine.DEB.1.10.1005251052040.24672@radix.cryptio.net%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Selection criteria was &quot;Unresolved&quot; with a Fix Version of 1.5, 1.6, 3.1, or 4.0.  email notifications were suppressed.&lt;/p&gt;

&lt;p&gt;A unique token for finding these 240 issues in the future: hossversioncleanup20100527&lt;/p&gt;</comment>
                            <comment id="12872679" author="hossman" created="Fri, 28 May 2010 00:01:07 +0100"  >&lt;p&gt;Correcting Fix Version based on CHANGES.txt, see this thread for more details...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/lucene-dev/201005.mbox/%3Calpine.DEB.1.10.1005251052040.24672@radix.cryptio.net%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/lucene-dev/201005.mbox/%3Calpine.DEB.1.10.1005251052040.24672@radix.cryptio.net%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12884373" author="gsingers" created="Thu, 1 Jul 2010 19:26:12 +0100"  >&lt;p&gt;Here&apos;s some more unit tests.&lt;/p&gt;</comment>
                            <comment id="12909013" author="skister" created="Mon, 13 Sep 2010 22:49:38 +0100"  >&lt;p&gt;Bug report on this feature, if there is a wildcard entry in schema.xml such as the following.&lt;/p&gt;

&lt;p&gt;    &amp;lt;!-- Ignore any fields that don&apos;t already match an existing field name --&amp;gt;&lt;br/&gt;
    &amp;lt;dynamicField name=&quot;*&quot; type=&quot;ignored&quot; multiValued=&quot;true&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;then this feature does not work and an error is returned, ie&lt;/p&gt;

&lt;p&gt;GET &apos;http://localhost:8983/solr/select?q=&lt;b&gt;:&lt;/b&gt;&amp;amp;sort=sum(1,2)+asc&apos;&lt;br/&gt;
Error 400 can not sort on unindexed field: sum(1,2)&lt;/p&gt;</comment>
                            <comment id="12916516" author="yseeley@gmail.com" created="Thu, 30 Sep 2010 16:29:40 +0100"  >&lt;p&gt;Here&apos;s a patch that re-implements the sort parsing such that arbitrarily complex function queries can be parsed.&lt;/p&gt;

&lt;p&gt;This does &lt;b&gt;not&lt;/b&gt; address the weighting issue (which isn&apos;t a parsing issue) that causes relevancy queries not  not work correctly.&lt;/p&gt;</comment>
                            <comment id="12916740" author="hossman" created="Fri, 1 Oct 2010 01:27:38 +0100"  >&lt;p&gt;FYI: with Yonik&apos;s latest commit (#1003107) the problem that Scott mentioned is no longer an issue &amp;#8211; but the reason is that Yonik&apos;s changes severly limit the set of field names that can legally be sorted on to those that meat the same requirements as a java identifier (ie: &quot;1_s&quot; is no longer a field name that can be sorted on)&lt;/p&gt;

&lt;p&gt;An idea that has been floating around in my head since i saw Scott&apos;s comment is that instead of trying to parse a field name first, and then doing function parsing second, we should reverse the order: try to parse as a function first, then as a field name (because we don&apos;t allow wild card style function names, but we do allow dynamic field names)&lt;/p&gt;

&lt;p&gt;After looking at Yonik&apos;s commit, i brought this up with him on IRC and we came to a consensus that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we should discourage people from having crazy field names&lt;/li&gt;
	&lt;li&gt;it might be expensive to try and parse every sort param as a function if it then turned out to be a simple field name - particularly since some FieldTypes might support SortField but not ValueSource (so trying to parse as a function first would likely result in an exception)&lt;/li&gt;
	&lt;li&gt;we should optimize for the simple common case of simple field names&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So with that in mind, i came up with the attached patch which leaves in the quick short circuit for field names that are really simple, then tries to parse as a function, then as a last resort uses the same basic parsing that Solr 1.4 did: treats everything up to the first whitespace as a potential field name.&lt;/p&gt;

&lt;p&gt;Attached patch shows some new tests that it fixes (i also included some other test additions related to the general concept of localparams in the sort param to ensure i didn&apos;t break them)&lt;/p&gt;</comment>
                            <comment id="12916746" author="hossman" created="Fri, 1 Oct 2010 01:38:22 +0100"  >&lt;p&gt;In dependent of my previous patch, there is one other nuance i discoverd today that i wanted to bring up...&lt;/p&gt;

&lt;p&gt;The way localparams are currently supported in the sort param, they are independent for each &quot;segment&quot; of the sort.  The easiest way to make sense of this is to look at the following contrived example URL (you can try it against the example data on trunk) ...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;?q=*:*&amp;amp;fl=price,id&amp;amp;foo=0&amp;amp;sort={!foo=2}sum($foo,0)+asc,+mul($foo,price)+desc,+id+asc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...that URL (currently) results in a sort which is equivalent to &quot;id asc&quot; .. the localParam value of &quot;foo=2&quot; at the begining of the sort param is only in scope for the first segment...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{!foo=2}sum($foo,0) asc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;..the second segment of the sort param winds up getting the &quot;global&quot; value of &quot;foo=0&quot; ...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mul($foo,price) desc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...so it becomes a NOOP (multiplication by zero)&lt;/p&gt;

&lt;p&gt;This limited scoping of localParams in the sort param seems counter intuitive to me.  I don&apos;t know that i have a better suggestion for how it &lt;b&gt;should&lt;/b&gt; work, but i wanted to draw attention to it in case other folks had any ideas&lt;/p&gt;</comment>
                            <comment id="12928303" author="yseeley@gmail.com" created="Thu, 4 Nov 2010 18:47:46 +0000"  >&lt;p&gt;Last patch looks good (aside from the javadoc typos &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12966392" author="gsingers" created="Fri, 3 Dec 2010 02:04:40 +0000"  >&lt;p&gt;Hoss, you going to commit?  Please backport to 3.x, too, as all of the other stuff has been.&lt;/p&gt;</comment>
                            <comment id="12970919" author="hossman" created="Mon, 13 Dec 2010 17:47:44 +0000"  >&lt;p&gt;Sorry, finally circled back on my &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1297&quot; title=&quot;Enable sorting by Function Query&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-1297&quot;&gt;&lt;del&gt;SOLR-1297&lt;/del&gt;&lt;/a&gt;.better.field.support.patch ...&lt;/p&gt;

&lt;p&gt;trunk: Committed revision 1045253.&lt;br/&gt;
3x: Committed revision 1045256.&lt;/p&gt;</comment>
                            <comment id="12983919" author="yseeley@gmail.com" created="Wed, 19 Jan 2011 22:47:35 +0000"  >&lt;p&gt;Here&apos;s a patch for trunk that fixes the issue with function queries used as sorts not being weighted.&lt;/p&gt;</comment>
                            <comment id="12983955" author="yseeley@gmail.com" created="Thu, 20 Jan 2011 00:40:44 +0000"  >&lt;p&gt;Committed to trunk and backported to 3x.&lt;br/&gt;
I think that was the last thing holding this issue open.&lt;/p&gt;</comment>
                            <comment id="13013207" author="gsingers" created="Wed, 30 Mar 2011 16:45:52 +0100"  >&lt;p&gt;Bulk close for 3.1.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12443178">SOLR-1650</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12404381">SOLR-773</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12437462" name="SOLR-1297-2.patch" size="1841" author="koji" created="Mon, 1 Mar 2010 08:36:02 +0000"/>
                            <attachment id="12456076" name="SOLR-1297.better.field.support.patch" size="13533" author="hossman" created="Fri, 1 Oct 2010 01:27:38 +0100"/>
                            <attachment id="12456017" name="SOLR-1297.patch" size="32373" author="yseeley@gmail.com" created="Thu, 30 Sep 2010 16:29:40 +0100"/>
                            <attachment id="12448512" name="SOLR-1297.patch" size="4094" author="gsingers" created="Thu, 1 Jul 2010 19:26:12 +0100"/>
                            <attachment id="12427821" name="SOLR-1297.patch" size="24585" author="gsingers" created="Sat, 12 Dec 2009 13:37:36 +0000"/>
                            <attachment id="12468791" name="SOLR-1297_weightSorts.patch" size="17368" author="yseeley@gmail.com" created="Wed, 19 Jan 2011 22:47:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 19 Feb 2010 16:09:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6350</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxm3r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19900</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>