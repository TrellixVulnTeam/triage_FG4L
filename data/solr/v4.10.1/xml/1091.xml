<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:15:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-1091/SOLR-1091.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-1091] &quot;phps&quot; (serialized PHP) writer produces invalid output</title>
                <link>https://issues.apache.org/jira/browse/SOLR-1091</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The serialized PHP output writer can outputs invalid string lengths for certain (unusual) input values.  Specifically, I had a document containing the following 6 byte character sequence: \xED\xAF\x80\xED\xB1\xB8&lt;/p&gt;

&lt;p&gt;I was able to create a document in the index containing this value without issue; however, when fetching the document back out using the serialized PHP writer, it returns a string like the following:&lt;/p&gt;

&lt;p&gt;s:4:&quot;&#237;&#175;&#8364;&#237;&#177;&#184;&quot;;&lt;/p&gt;

&lt;p&gt;Note that the string length specified is 4, while the string is actually 6 bytes long.&lt;/p&gt;

&lt;p&gt;When using PHP&apos;s native serialize() function, it correctly sets the length to 6:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;php -r &apos;var_dump(serialize(&quot;\xED\xAF\x80\xED\xB1\xB8&quot;));&apos;&lt;br/&gt;
string(13) &quot;s:6:&quot;&#237;&#175;&#8364;&#237;&#177;&#184;&quot;;&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The &quot;wt=php&quot; writer, which produces output to be parsed with eval(), doesn&apos;t have any trouble with this string.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Sun JRE 1.6.0 on Centos 5&lt;/p&gt;</environment>
        <key id="12419683">SOLR-1091</key>
            <summary>&quot;phps&quot; (serialized PHP) writer produces invalid output</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="frankfarmer">frank farmer</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Mar 2009 22:24:15 +0000</created>
                <updated>Tue, 10 Nov 2009 15:52:00 +0000</updated>
                            <resolved>Tue, 15 Sep 2009 23:20:57 +0100</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12693517" author="djimenez" created="Sun, 29 Mar 2009 05:42:27 +0100"  >&lt;p&gt;I haven&apos;t look at the java code, but my guess would be its setting string length as the character length (which is encoding dependent) where serialized php actually uses the byte length so it can be binary safe (independent of encodings used for textual strings).&lt;/p&gt;</comment>
                            <comment id="12706260" author="yseeley@gmail.com" created="Wed, 6 May 2009 01:00:59 +0100"  >&lt;p&gt;Is this valid unicode?  The serialized PHP writer already calculates the size of the UTF-8 encoded string, so it&apos;s difficult to see what&apos;s going on.&lt;/p&gt;</comment>
                            <comment id="12706458" author="djimenez" created="Wed, 6 May 2009 16:31:56 +0100"  >&lt;p&gt;the character sequence specified seems to be windows 1252 - based on just getting it to look like what&apos;s in the description in a text editor. &lt;/p&gt;

&lt;p&gt;I see it getting the utf-8 byte length now, but is the output writer guaranteed to be outputting in utf-8? sorry if it&apos;s a naive question, I do see the content-type is text/plain; charset=utf-8 - does that change the output writer&apos;s encoding?&lt;/p&gt;

&lt;p&gt;if it IS guaranteed, then maybe its how the character data is added - i.e. the add xml was interpreted utf-8 but the data was actually windows-1252 or similar.&lt;/p&gt;</comment>
                            <comment id="12740971" author="yseeley@gmail.com" created="Sat, 8 Aug 2009 22:17:05 +0100"  >&lt;p&gt;Does anyone know if there is actually a bug here, and if so, how it should be fixed?&lt;/p&gt;</comment>
                            <comment id="12748160" author="yseeley@gmail.com" created="Wed, 26 Aug 2009 22:26:37 +0100"  >&lt;p&gt;If someone can give a URL that demonstrates incorrect behavior before 1.4 is released, we can look at it.&lt;/p&gt;

&lt;p&gt;Since parameters are echoed back by default, please provide something of the following form to help us reproduce:&lt;br/&gt;
&lt;a href=&quot;http://localhost:8983/solr/select?q=abcdef&amp;amp;a=problematic_string&amp;amp;wt=phps&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select?q=abcdef&amp;amp;a=problematic_string&amp;amp;wt=phps&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12748165" author="frankfarmer" created="Wed, 26 Aug 2009 22:36:18 +0100"  >&lt;p&gt;&lt;a href=&quot;http://localhost:8983/solr/select?q=abcdef&amp;amp;a=%ED%AF%80%ED%B1%B8&amp;amp;wt=phps&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8983/solr/select?q=abcdef&amp;amp;a=%ED%AF%80%ED%B1%B8&amp;amp;wt=phps&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Clearly 6 bytes, but again solr&apos;s output claims only 4.&lt;/p&gt;</comment>
                            <comment id="12748169" author="yseeley@gmail.com" created="Wed, 26 Aug 2009 22:48:35 +0100"  >&lt;p&gt;Thanks Frank, do you know what unicode code points this input corresponds to?&lt;br/&gt;
I&apos;m still not sure if those bytes are valid UTF8 (which would explain why you don&apos;t get 6 chars back) - if the input is incorrectly encoded, the output may not be what you expect.&lt;/p&gt;</comment>
                            <comment id="12748172" author="yseeley@gmail.com" created="Wed, 26 Aug 2009 22:53:12 +0100"  >&lt;p&gt;Looking closer at the byte sequence, this really looks like invalid UTF8 since the 8th bit is set on every byte. The decoder is probably just doing the best that it can with this, but the result isn&apos;t going to be what you want in any case.&lt;/p&gt;</comment>
                            <comment id="12748174" author="frankfarmer" created="Wed, 26 Aug 2009 22:54:09 +0100"  >&lt;p&gt;As far as I know, the string is garbage.  However, PHP&apos;s serialize() operates on bytes, not characters.  So any 6 byte string of data (whether those bytes are valid unicode, or just binary gibberish) should always be preceded by &quot;s:6:&quot;.  &lt;/p&gt;

&lt;p&gt;6 bytes in, 6 bytes out &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12748184" author="frankfarmer" created="Wed, 26 Aug 2009 23:11:43 +0100"  >&lt;p&gt;My concern is not that solr do anything specific with this garbled data, only that wt=phps always returns a string that can be run through unserialize() without error.&lt;/p&gt;

&lt;p&gt;Here&apos;s the exact case in which I encountered this bug, which may help explain why I reported this issue in the first place:&lt;/p&gt;

&lt;p&gt;1) Somehow, a user inserted the aforementioned sequence of bytes in some user-editable content in my application.&lt;br/&gt;
2) My code blindly passed that data directly into solr (in retrospect, I should probably be filtering anything that&apos;s not valid UTF-8)&lt;br/&gt;
3) Users ran queries which included the affected document&lt;br/&gt;
4) My code tried to unserialize() the output, and failed with a PHP error (simply replacing the offending &quot;s:4:&quot; with &quot;s:6:&quot; caused the output to unserialize without issue, however).  This caused my users to be unable to retrieve results for many queries.&lt;/p&gt;

&lt;p&gt;Long story short, if you let users insert arbitrary byte sequences into your index (which I&apos;ll admit is naive, but I&apos;m sure I&apos;m not the only one who&apos;s done this), and you use wt=phps, a malicious user can effectively cause a DoS.&lt;/p&gt;

&lt;p&gt;Again, I don&apos;t care about actually getting these bytes back out of solr unmangled.  I only care that the output of wt=phps make it through unserialize() without causing a PHP error.&lt;/p&gt;</comment>
                            <comment id="12748212" author="yseeley@gmail.com" created="Thu, 27 Aug 2009 01:00:01 +0100"  >&lt;p&gt;Hmmm, I thought this might be a decoding error.  Instead it perhaps looks like the JVM not handling UTF8 encoding the same as Jetty.&lt;/p&gt;

&lt;p&gt;As one can see by this:&lt;br/&gt;
$ curl --trace - &apos;http://localhost:8983/solr/select?q=abcdef&amp;amp;a=%ED%AF%80%ED%B1%B8&amp;amp;wt=phps&apos;&lt;/p&gt;

&lt;p&gt;The ascii portion of the dump looks like:&lt;br/&gt;
s:4:&quot;......&quot;;&lt;/p&gt;

&lt;p&gt;So the JVM is telling us that the string will serialize to 4 bytes, and when Jetty actually does the serialization, it comes out to 6.&lt;/p&gt;

&lt;p&gt;Java&apos;s String.getBytes() does have the following warning:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt; The behavior of this method when this string cannot be encoded in&lt;/li&gt;
	&lt;li&gt;the given charset is unspecified.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12748228" author="yseeley@gmail.com" created="Thu, 27 Aug 2009 02:04:13 +0100"  >&lt;p&gt;Echoing the param from the python writer (which escapes chars outside the ascii range) shows that the internal UTF-16 string after decoding the invalid UTF8 is \udbc0\udc78&lt;/p&gt;

&lt;p&gt;This represents unicode code point 1048696, which encoded into UTF8 should be&lt;br/&gt;
f4 80 81 b8  (4 bytes).&lt;/p&gt;

&lt;p&gt;Thus, I&apos;m thinking that it&apos;s perhaps a jetty bug in not being able to handle characters outside the BMP?&lt;/p&gt;</comment>
                            <comment id="12748403" author="yseeley@gmail.com" created="Thu, 27 Aug 2009 16:23:11 +0100"  >&lt;p&gt;Confirmed - it&apos;s jetty.  The latest version of Jetty exhibits the same behavior - it produces incorrect UT8 for code points outside the BMP.  I tried with LucidWorks/Solr (Tomcat based) and it works correctly by only outputting 4 bytes.&lt;/p&gt;</comment>
                            <comment id="12748419" author="frankfarmer" created="Thu, 27 Aug 2009 17:17:38 +0100"  >&lt;p&gt;Thanks for looking in to this.  I take it this issue can be closed, and I should go open a ticket against Jetty?&lt;/p&gt;</comment>
                            <comment id="12748447" author="yseeley@gmail.com" created="Thu, 27 Aug 2009 18:06:57 +0100"  >&lt;p&gt;Here&apos;s a patch that can handle the modified UTF8 that Jetty puts out, as well as speeding up the normal UTF8 case using Lucene&apos;s UTF8 encoding.&lt;/p&gt;

&lt;p&gt;modified UTF8 support is switched on if the jetty.home property is set (jetty does this by default).&lt;/p&gt;</comment>
                            <comment id="12748943" author="yseeley@gmail.com" created="Fri, 28 Aug 2009 20:02:53 +0100"  >&lt;p&gt;committed.&lt;/p&gt;</comment>
                            <comment id="12754714" author="yseeley@gmail.com" created="Sun, 13 Sep 2009 17:05:40 +0100"  >&lt;p&gt;Additional patch that allows overriding of the CESU-8 guess with the CESU8 system property. &lt;/p&gt;</comment>
                            <comment id="12755727" author="hossman" created="Tue, 15 Sep 2009 22:59:06 +0100"  >&lt;p&gt;reopening because of discssion on list and yonik&apos;s new patch.&lt;/p&gt;

&lt;p&gt;Yonik: this looks good, but i would suggest changing the system property to &quot;solr.phps.cesu8&quot; so people don&apos;t set it and then later forget what it&apos;s for. &lt;/p&gt;

&lt;p&gt;The javadoc are also a little abiguous about what people should set it to, how about...&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
In order to support PHP Serialized strings with a proper &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; count, This ResponseWriter 
must know &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the Writers passed to it will result in an output of CESU-8 (UTF-8 w/o support 
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; large code points outside of the BMP)

Currently Solr assumes that all Jetty servlet containers (detected using the &lt;span class=&quot;code-quote&quot;&gt;&quot;jetty.home&quot;&lt;/span&gt; 
system property) use CESU-8 instead of UTF-8 (verified to the current release of 6.1.20).

In installations where Solr auto-detects incorrectly, the Solr Administrator should set the
&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.phps.cesu8&quot;&lt;/span&gt; system property to either &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; or &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; accordingly.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12755740" author="yseeley@gmail.com" created="Tue, 15 Sep 2009 23:20:57 +0100"  >&lt;p&gt;committed suggestions.&lt;/p&gt;</comment>
                            <comment id="12775701" author="gsingers" created="Tue, 10 Nov 2009 15:52:00 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12419425" name="SOLR-1091.patch" size="3077" author="yseeley@gmail.com" created="Sun, 13 Sep 2009 17:05:40 +0100"/>
                            <attachment id="12417898" name="SOLR-1091.patch" size="2710" author="yseeley@gmail.com" created="Thu, 27 Aug 2009 18:06:57 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 29 Mar 2009 04:42:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6546</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxncf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20101</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>