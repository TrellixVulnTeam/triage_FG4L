<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:23:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-764/SOLR-764.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-764] Support facet.sort=false (index order) with distributed search</title>
                <link>https://issues.apache.org/jira/browse/SOLR-764</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Distributed search does not currently support sorting facets by index order (facet.sort=false).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12404095">SOLR-764</key>
            <summary>Support facet.sort=false (index order) with distributed search</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="wojtekpia">Wojtek Piaseczny</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Sep 2008 17:44:14 +0100</created>
                <updated>Thu, 13 Aug 2009 15:19:55 +0100</updated>
                            <resolved>Sun, 1 Mar 2009 16:29:57 +0000</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12629874" author="anithian" created="Wed, 10 Sep 2008 18:34:43 +0100"  >&lt;p&gt;Are you purposely trying to disable facet results? Why not simply pass in facet=false parameter?&lt;/p&gt;</comment>
                            <comment id="12629880" author="larsko" created="Wed, 10 Sep 2008 18:42:20 +0100"  >&lt;p&gt;Have you tried a version which incorporates &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-755&quot; title=&quot;facet.limit=-1 does not work in distributed search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-755&quot;&gt;&lt;del&gt;SOLR-755&lt;/del&gt;&lt;/a&gt;? This should have been fixed in that issue.&lt;/p&gt;</comment>
                            <comment id="12629887" author="wojtekpia" created="Wed, 10 Sep 2008 18:58:17 +0100"  >&lt;p&gt;I&apos;m trying to get all facets from all shards, ordered alphabetically. I&apos;m not trying to disable facets.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-755&quot; title=&quot;facet.limit=-1 does not work in distributed search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-755&quot;&gt;&lt;del&gt;SOLR-755&lt;/del&gt;&lt;/a&gt; solves the case where facet.limit=-1 and facet.sort=true, but not where facet.sort=false. A comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-755&quot; title=&quot;facet.limit=-1 does not work in distributed search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-755&quot;&gt;&lt;del&gt;SOLR-755&lt;/del&gt;&lt;/a&gt; states:&lt;/p&gt;

&lt;p&gt;&quot;Note that one must add facet.sorted=true in conjunction with facet.limit=-1 since it defaults to unsorted (or sorted-by-term), and this is currently unsupported by distributed search.&quot;&lt;/p&gt;</comment>
                            <comment id="12629890" author="larsko" created="Wed, 10 Sep 2008 19:02:59 +0100"  >&lt;p&gt;Ah, right. Sorry, I missed that part. Out of interest, what is your use case that requires facet.sort=false?&lt;/p&gt;</comment>
                            <comment id="12629892" author="wojtekpia" created="Wed, 10 Sep 2008 19:11:54 +0100"  >&lt;p&gt;I want to show dynamic ranges for numeric facets. My (and probably most??) implementation for building dynamic ranges requires the numbers to be sorted by facet name rather than by occurrences.&lt;/p&gt;</comment>
                            <comment id="12629930" author="larsko" created="Wed, 10 Sep 2008 20:49:26 +0100"  >&lt;p&gt;Patch implementing support for facet.sort=false with distributed search.&lt;/p&gt;

&lt;p&gt;Simplified the existing code by removing things that weren&apos;t used and added an additional method to sort facets by term number. Note that this implementation is flawed &amp;#8211; there are no distributed term numbers, therefore it&apos;s possible that several facet values have the same term number because they come from different shards. In that case the lexicographic order of the value will be used to break the tie. It is possible that facet values are returned in a different order for distributed and local setups.&lt;/p&gt;

&lt;p&gt;The patch also adds a unit test, commented out because of the issues described above.&lt;/p&gt;</comment>
                            <comment id="12629949" author="wojtekpia" created="Wed, 10 Sep 2008 21:30:24 +0100"  >&lt;p&gt;I notice this patch consolidates the FacetInfo class&apos; &apos;topFacets&apos; &amp;amp; &apos;listFacets&apos; into a single collection. Do you know why these were ever separate? I had guessed it was because when &apos;listFacets&apos; was being populated (only when facet.sort=false), it was being populated with data that was already ordered correctly per shard, and that combining the data (while maintaining sort order) from each shard could be optimized beyond calling Arrays.sort(). &lt;/p&gt;

&lt;p&gt;Shouldn&apos;t the getTermSorted method always use name instead of term number? &lt;/p&gt;</comment>
                            <comment id="12630136" author="larsko" created="Thu, 11 Sep 2008 10:22:03 +0100"  >&lt;p&gt;As far as I could see, &quot;listFacets&quot; wasn&apos;t used anywhere in the code &amp;#8211; everything was put into &quot;topFacets&quot; (which behaved exactly the same as &quot;listFacets&quot;) and sorted in the final stage. I guess the idea was to have a data structure which automatically sorts entries as new ones are inserted. Optimising the combining of sorted data from the shards can&apos;t be done in the general case, as e.g. for sort by count the data returned affects the order &amp;#8211; merging the results from 2 shards can change the order completely compared because you&apos;re adding up the counts.&lt;/p&gt;

&lt;p&gt;If you specify facet.sort=false in a non-distributed setup, the facet values are ordered by term number as well &amp;#8211; which happens to be the lexicographic order. Also, sorting by term name only really makes sense for string or text fields.&lt;/p&gt;</comment>
                            <comment id="12630285" author="wojtekpia" created="Thu, 11 Sep 2008 19:20:10 +0100"  >&lt;p&gt;Do you think it&apos;s worth keeping lexicographically sorted facets separate (i.e. in listFacets) and optimizing the combining code specifically for that case? &lt;/p&gt;

&lt;p&gt;I misunderstood what term number meant, thanks for clarifying.&lt;/p&gt;</comment>
                            <comment id="12630291" author="larsko" created="Thu, 11 Sep 2008 19:28:26 +0100"  >&lt;p&gt;My gut feeling is that it&apos;s probably not worth the effort. Usually the number of facets will be very small and sorting the list will be very quick. For large numbers of facets, everything else will slow down as well. I don&apos;t think that sorting the list will become a bottleneck.&lt;/p&gt;

&lt;p&gt;Of course, you can make some real measurements and prove me wrong &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Unless the gain is significant, I&apos;d prefer keeping the code as simple as possible.&lt;/p&gt;</comment>
                            <comment id="12630309" author="yseeley@gmail.com" created="Thu, 11 Sep 2008 20:00:07 +0100"  >&lt;p&gt;I separated out topFacets from listFacets because I assumed the merging logic would be different .&lt;br/&gt;
list facet refinement seems pretty different than top facet refinement.&lt;/p&gt;
</comment>
                            <comment id="12630320" author="larsko" created="Thu, 11 Sep 2008 20:21:01 +0100"  >&lt;p&gt;How is the refinement different? It seems to me that both methods operate on the same list, which is just sorted according to different criteria. Facets with less than the minimum count etc. still need to be filtered out the same way.&lt;/p&gt;</comment>
                            <comment id="12630397" author="wojtekpia" created="Thu, 11 Sep 2008 23:08:49 +0100"  >&lt;p&gt;I measured how long the sort takes in my case: for collections of up to about 1100 items it took less than 1 ms. Compared with my average response times (~1000 ms), it truly is insignificant.&lt;/p&gt;</comment>
                            <comment id="12630423" author="yseeley@gmail.com" created="Fri, 12 Sep 2008 00:56:30 +0100"  >&lt;blockquote&gt;&lt;p&gt;How is the refinement different? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The lists are merged by sorting, then a window is selected to return.&lt;/p&gt;

&lt;p&gt;For facets sorted by count, the counts (and thus the order) may not be correct.  Facet terms outside the window may actually be inside the window (or above it, changing the order).  The code calculates what terms (out of all those returned) could possibly change what the window looks like, taking into account the maximum value it could have for each shard based on what it saw from each.&lt;/p&gt;

&lt;p&gt;For facets sorted by index order, the window into the list will not change based on any facet refinements.  Actually, we should remove any amount of &quot;over-requesting&quot; when sorting by index order.  The counts could be off though... we may not have the counts from certain shards.  So we only have to request counts when:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the term is in the window to be returned&lt;/li&gt;
	&lt;li&gt;the term is missing from a shard, &lt;b&gt;and&lt;/b&gt; that term comes &lt;b&gt;after&lt;/b&gt; the last term the shard returned.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12630527" author="larsko" created="Fri, 12 Sep 2008 10:08:09 +0100"  >&lt;p&gt;I think we still need the over-requesting, regardless of the sort order. Through the facet.mincount parameter the count influences the window to be returned even if we&apos;re sorting by term order. We do need to get the exact counts. We can only relax this if facet.mincount isn&apos;t specified.&lt;/p&gt;</comment>
                            <comment id="12630578" author="yseeley@gmail.com" created="Fri, 12 Sep 2008 15:36:29 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think we still need the over-requesting, regardless of the sort order.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good point Lars.  There are some special cases that we probably want to optimize for, esp if they are the usual cases.  if mincount&amp;lt;=1 and sort==false it seems we can safely avoid any over-request.&lt;/p&gt;</comment>
                            <comment id="12630793" author="larsko" created="Sat, 13 Sep 2008 17:45:05 +0100"  >&lt;p&gt;Attaching new patch which, as per Yonik&apos;s suggestion, doesn&apos;t refine facet counts when minCount &amp;lt;=1 and sort == false.&lt;/p&gt;

&lt;p&gt;Regarding the term order problem, I think it might be best to redesign the whole thing. Term order as such probably doesn&apos;t make a lot of sense, it&apos;s really used to get the terms in alphabetical order. So why not drop term order altogether and introduce lexicographic order instead. This probably also means changing the facet.sort parameter from a boolean to a string &amp;#8211; &quot;count&quot; or &quot;lex&quot;.&lt;/p&gt;

&lt;p&gt;This would mean that the same query will return the same results for both distributed and non-distributed setups. The downside is that the facets always need to be sorted (i.e. more computation), but according to Wojtek&apos;s measurements this seems to be neglible.&lt;/p&gt;

&lt;p&gt;If this seems like the right direction to go to, we should probably open another issue for this.&lt;/p&gt;</comment>
                            <comment id="12662662" author="larsko" created="Sat, 10 Jan 2009 14:31:18 +0000"  >&lt;p&gt;I think this is fixed with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-781&quot; title=&quot;Change facet.sort from boolean to string and specify sort method explicitely&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-781&quot;&gt;&lt;del&gt;SOLR-781&lt;/del&gt;&lt;/a&gt; and can be closed. Can anybody confirm?&lt;/p&gt;</comment>
                            <comment id="12670949" author="wojtekpia" created="Thu, 5 Feb 2009 23:21:22 +0000"  >&lt;p&gt;I found one small issue: sorting lexicographically gives the wrong order when the field type is a sortable number (e.g. sint). I think the fix is to change DistribFieldFacet.getLexSorted() to compare on term number instead of name. &lt;/p&gt;

&lt;p&gt;(maybe this should be a comment on SOLR 781 instead).&lt;/p&gt;</comment>
                            <comment id="12671470" author="larsko" created="Sat, 7 Feb 2009 14:05:24 +0000"  >&lt;p&gt;What do you mean by wrong order? When sorting lexicographically, I would expect it to return something like 1, 10, 11, 2, 20, 3, 4, 5 etc. as this is the lexicographic order. Ordering those by numeric value should probably be a new parameter, like &quot;facet.sort=numeric&quot;.&lt;/p&gt;</comment>
                            <comment id="12671496" author="wojtekpia" created="Sat, 7 Feb 2009 17:34:55 +0000"  >&lt;p&gt;In the new implementation, sort=false and sort=lex are the same. In the previous implementation, specifying sort=false would sort sortable-numbers (like sint) numerically, rather lexicographically. So there&apos;s a slight inconsistency between the new and old implementation. I like the idea of adding a numeric sort order.&lt;/p&gt;</comment>
                            <comment id="12677132" author="yseeley@gmail.com" created="Thu, 26 Feb 2009 20:22:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would expect it to return something like 1, 10, 11, 2, 20, 3, 4, 5 etc. as this is the lexicographic order&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not for a field like sint, which is manipulated so that the lexicographic order is equal to the numeric order.&lt;br/&gt;
Looks like we need to do FieldType.toInternal() to go back to the indexed form before doing string compares.&lt;/p&gt;</comment>
                            <comment id="12677411" author="yseeley@gmail.com" created="Fri, 27 Feb 2009 16:31:02 +0000"  >&lt;p&gt;How about this patch to fix the sort order ?  It should make distributed search lex sort equal to what one would get for non-distributed search.&lt;/p&gt;</comment>
                            <comment id="12677447" author="larsko" created="Fri, 27 Feb 2009 18:25:59 +0000"  >&lt;p&gt;Looks good. I still think that the (semantically) better solution would be to make it explicit with a new parameter &amp;#8211; which was one of the reasons for changing facet.sort from true/false to count/lex.&lt;/p&gt;

&lt;p&gt;That said, we could also simply change &quot;lex&quot; to &quot;field&quot;, meaning &quot;sort it by field value&quot; and Solr just does the right thing for the different field types.&lt;/p&gt;</comment>
                            <comment id="12677454" author="yseeley@gmail.com" created="Fri, 27 Feb 2009 18:36:32 +0000"  >&lt;p&gt;&quot;lex&quot; originally made sense to me because it is index order, which is lexicographic for the indexed tokens (but not for the human-readable values).&lt;br/&gt;
So an &quot;integer&quot; field will sort the terms as 0,100,2&lt;br/&gt;
while an &quot;sint&quot; field will show 0,2,100&lt;/p&gt;

&lt;p&gt;It&apos;s not as simple to just &quot;do the right thing&quot; since it would carry a significant performance penalty (and that&apos;s something we shouldn&apos;t cover up or just automatically do).&lt;/p&gt;

&lt;p&gt;Perhaps a better name for &quot;lex&quot; would be &quot;index&quot;?&lt;/p&gt;</comment>
                            <comment id="12677490" author="larsko" created="Fri, 27 Feb 2009 19:32:55 +0000"  >&lt;p&gt;When I said &quot;do the right thing&quot; I basically meant what your patch does already &amp;#8211; sort according to the field type. I agree that &quot;index&quot; is a better name for it though.&lt;/p&gt;</comment>
                            <comment id="12677525" author="yseeley@gmail.com" created="Fri, 27 Feb 2009 21:01:57 +0000"  >&lt;p&gt;Revised patch that switches &quot;lex&quot; to &quot;index&quot; to avoid confusion about which lex (the invisible indexed token, or the human readable label).&lt;/p&gt;

&lt;p&gt;TODO: update wiki when this patch is committed&lt;/p&gt;</comment>
                            <comment id="12677820" author="yseeley@gmail.com" created="Sun, 1 Mar 2009 16:29:57 +0000"  >&lt;p&gt;committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12401130" name="SOLR-764.patch" size="11999" author="yseeley@gmail.com" created="Fri, 27 Feb 2009 21:01:57 +0000"/>
                            <attachment id="12401122" name="SOLR-764.patch" size="2725" author="yseeley@gmail.com" created="Fri, 27 Feb 2009 16:31:02 +0000"/>
                            <attachment id="12390058" name="SOLR-764.patch" size="6250" author="larsko" created="Sat, 13 Sep 2008 17:45:05 +0100"/>
                            <attachment id="12389858" name="SOLR-764.patch" size="6188" author="larsko" created="Wed, 10 Sep 2008 20:49:26 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 10 Sep 2008 17:34:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6856</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxpcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20426</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>