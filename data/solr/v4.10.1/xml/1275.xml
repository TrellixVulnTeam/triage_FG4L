<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:17:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-1275/SOLR-1275.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-1275] Add expungeDeletes to DirectUpdateHandler2</title>
                <link>https://issues.apache.org/jira/browse/SOLR-1275</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;expungeDeletes is a useful method somewhat like optimize is offered by IndexWriter that can be implemented in DirectUpdateHandler2.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12430305">SOLR-1275</key>
            <summary>Add expungeDeletes to DirectUpdateHandler2</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jasonrutherglen">Jason Rutherglen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jul 2009 00:22:10 +0100</created>
                <updated>Tue, 10 Nov 2009 15:52:10 +0000</updated>
                            <resolved>Thu, 10 Sep 2009 15:53:30 +0100</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="12731302" author="noble.paul" created="Wed, 15 Jul 2009 07:31:32 +0100"  >&lt;p&gt;So , this should be an extra option in the CommitUpdateComand ?&lt;/p&gt;</comment>
                            <comment id="12731801" author="noble.paul" created="Thu, 16 Jul 2009 05:55:12 +0100"  >&lt;p&gt;Untested patch. for review&lt;/p&gt;</comment>
                            <comment id="12731999" author="otis" created="Thu, 16 Jul 2009 16:52:52 +0100"  >&lt;p&gt;Patch looks good to me (also not tested it)&lt;/p&gt;</comment>
                            <comment id="12732032" author="jasonrutherglen" created="Thu, 16 Jul 2009 18:24:11 +0100"  >&lt;p&gt;I can add some tests? (would like to get familiar with Solr&apos;s test framework)&lt;/p&gt;</comment>
                            <comment id="12738942" author="noble.paul" created="Tue, 4 Aug 2009 13:29:23 +0100"  >&lt;p&gt;jason, is there a way to test if expungeDeletes is indeed called?&lt;/p&gt;
</comment>
                            <comment id="12739744" author="jasonrutherglen" created="Wed, 5 Aug 2009 21:56:29 +0100"  >&lt;p&gt;Sure, I&apos;ll have time at some point to post it, we can use the one from Lucene.  Basically create deletes in multiple segments, then call expungeDeletes, check the number of segments left.  &lt;/p&gt;</comment>
                            <comment id="12740972" author="yseeley@gmail.com" created="Sat, 8 Aug 2009 22:21:10 +0100"  >&lt;p&gt;Pushing this off to 1.5 given that it&apos;s very expert use, and it&apos;s not even clear what the use cases are.&lt;/p&gt;</comment>
                            <comment id="12740992" author="jasonrutherglen" created="Sat, 8 Aug 2009 23:42:40 +0100"  >&lt;p&gt;Given the simplicity of the functionality I don&apos;t see a reason to put this off.  expungeDeletes has been in INdexWriter since 2.4?  &lt;/p&gt;</comment>
                            <comment id="12740994" author="yseeley@gmail.com" created="Sun, 9 Aug 2009 00:04:43 +0100"  >&lt;p&gt;Apologies - my brain went the wrong way when I saw &quot;expungeDeletes&quot; and I temporarily thought it meant throwing away the deletedDocs BitVector (i.e. undeleting all previously deleted documents).  So there are definitely use cases for this.  Seems simple enough, I&apos;ll move it back to 1.4&lt;/p&gt;</comment>
                            <comment id="12744897" author="jasonrutherglen" created="Wed, 19 Aug 2009 06:32:34 +0100"  >&lt;ul&gt;
	&lt;li&gt;Added DirectUpdateHandlerTest.testExpungeDeletes which creates&lt;br/&gt;
a bunch of docs (i.e. several segments), terms known to be in&lt;br/&gt;
specific segments are found and deleted. Expunge deletes is&lt;br/&gt;
called, the segments are fewer and the segments with the deleted&lt;br/&gt;
terms no longer exist.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Added expungeDeletes functionality to DirectUpdateHandler2&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The patch randomly didn&apos;t create enough of the expected&lt;br/&gt;
segments, this could be due to ConcurrentMergeScheduler. I&lt;br/&gt;
couldn&apos;t reproduce consistently.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12744951" author="noble.paul" created="Wed, 19 Aug 2009 09:09:43 +0100"  >&lt;p&gt;The patch looks fine to me . I plan to commit this shortly&lt;/p&gt;</comment>
                            <comment id="12745031" author="noble.paul" created="Wed, 19 Aug 2009 13:22:17 +0100"  >&lt;p&gt;committed: r805774&lt;br/&gt;
thanks Jason&lt;/p&gt;</comment>
                            <comment id="12745128" author="noble.paul" created="Wed, 19 Aug 2009 18:07:16 +0100"  >&lt;p&gt;the testcase fails&lt;/p&gt;</comment>
                            <comment id="12745135" author="noble.paul" created="Wed, 19 Aug 2009 18:13:12 +0100"  >&lt;p&gt;committed r805888&lt;/p&gt;

&lt;p&gt;The test passes now.&lt;/p&gt;</comment>
                            <comment id="12745150" author="noble.paul" created="Wed, 19 Aug 2009 18:56:51 +0100"  >&lt;p&gt;The tests are passing ,but for the time being I wish to keep this open . Let us review the change in DUH2#commit() once again and ensure that the fix is right&lt;/p&gt;</comment>
                            <comment id="12745172" author="jasonrutherglen" created="Wed, 19 Aug 2009 20:07:14 +0100"  >&lt;ul&gt;
	&lt;li&gt;Added solrconfig-serialms.xml which uses a&lt;br/&gt;
SerialMergeScheduler (instead of ConcurrentMergeScheduler).&lt;br/&gt;
Otherwise we get inconsistent numbers of segments at variable&lt;br/&gt;
times (because the merging is happening asynchronously)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Commit is called every 500 docs to insure we get enough&lt;br/&gt;
segments&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Test passes&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12745214" author="yseeley@gmail.com" created="Wed, 19 Aug 2009 22:31:36 +0100"  >&lt;p&gt;The standard solrconfig.xml in the test directory has a LogDocMergePolicy and maxBufferedDocs=10 to generate more segments.&lt;br/&gt;
In some other Solr tests, I add a few docs, then do a commit, add a few docs, then do another commit to get 2 segments for example.  Shouldn&apos;t that work to get a fixed number of segments?&lt;/p&gt;</comment>
                            <comment id="12745249" author="jasonrutherglen" created="Thu, 20 Aug 2009 01:14:09 +0100"  >&lt;p&gt;Because maxBufferedDocs=10, and the previous patch was creating&lt;br/&gt;
3000 docs, a lot of merging was happening in the background. SMS&lt;br/&gt;
gives predictable merging for any number of documents which is&lt;br/&gt;
more suitable for testing.&lt;/p&gt;</comment>
                            <comment id="12745467" author="yseeley@gmail.com" created="Thu, 20 Aug 2009 17:00:39 +0100"  >&lt;p&gt;How about this much simpler test that&apos;s faster to execute, and should be very easy to fix if/when behavior changes in the future (which it certainly could with NRT stuff).  It also tests more of the complete loop too by going through the XML update command.&lt;/p&gt;</comment>
                            <comment id="12745468" author="yseeley@gmail.com" created="Thu, 20 Aug 2009 17:02:16 +0100"  >&lt;p&gt;Hmmm, it&apos;s harder to see in diff format... the test just boils down to this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testExpungeDeletes() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;));
    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;));
    assertU(commit());

    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt;));
    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;));
    assertU(adoc(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;4&quot;&lt;/span&gt;));
    assertU(commit());

    SolrQueryRequest sr = req(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);
    SolrIndexReader r = sr.getSearcher().getReader();
    assertTrue(r.maxDoc() &amp;gt; r.numDocs());   &lt;span class=&quot;code-comment&quot;&gt;// should have deletions
&lt;/span&gt;    assertTrue(r.getLeafReaders().length &amp;gt; 1);  &lt;span class=&quot;code-comment&quot;&gt;// more than 1 segment
&lt;/span&gt;    sr.close();

    assertU(commit(&lt;span class=&quot;code-quote&quot;&gt;&quot;expungeDeletes&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;));

    sr = req(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);
    r = sr.getSearcher().getReader();
    assertEquals(r.maxDoc(), r.numDocs());  &lt;span class=&quot;code-comment&quot;&gt;// no deletions
&lt;/span&gt;    assertTrue(r.getLeafReaders().length &amp;gt; 1);  &lt;span class=&quot;code-comment&quot;&gt;// still more than 1 segment
&lt;/span&gt;    sr.close();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12745643" author="jasonrutherglen" created="Thu, 20 Aug 2009 22:04:34 +0100"  >&lt;p&gt;I like using XML, I was wondering why in&lt;br/&gt;
TermVectorComponentTest.testDistributed we&apos;re manually creating&lt;br/&gt;
the distributed part? I&apos;m currently picking art&lt;br/&gt;
TestDistributedSearch to test out a distributed component (a bit&lt;br/&gt;
of work). &lt;/p&gt;

&lt;p&gt;expungeDeletes is supposed to remove segments that contains&lt;br/&gt;
deletes. The patch posted does this by checking the segment&lt;br/&gt;
names. This will work fine with NRT.&lt;/p&gt;</comment>
                            <comment id="12745695" author="yseeley@gmail.com" created="Thu, 20 Aug 2009 23:16:47 +0100"  >&lt;p&gt;Isn&apos;t it much simpler to just check that the segments have no deletes after expungeDeletes is called?&lt;br/&gt;
Is there something my proposed patch doesn&apos;t test that you think it should?&lt;/p&gt;</comment>
                            <comment id="12745717" author="jasonrutherglen" created="Fri, 21 Aug 2009 00:08:25 +0100"  >&lt;p&gt;&amp;gt; Isn&apos;t it much simpler &lt;/p&gt;

&lt;p&gt;Calling SR.undelete would remove the deletes and the test would&lt;br/&gt;
pass?&lt;/p&gt;</comment>
                            <comment id="12745731" author="jasonrutherglen" created="Fri, 21 Aug 2009 00:48:18 +0100"  >&lt;p&gt;I&apos;ll check in a new patch that&apos;s faster (i.e. indexes fewer docs).&lt;/p&gt;</comment>
                            <comment id="12745952" author="yseeley@gmail.com" created="Fri, 21 Aug 2009 13:58:43 +0100"  >&lt;blockquote&gt;&lt;p&gt;Calling SR.undelete would remove the deletes and the test would pass?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Simple to fix... check against the exact number of documents instead of checking that there are no deletes.&lt;/p&gt;</comment>
                            <comment id="12747120" author="jasonrutherglen" created="Mon, 24 Aug 2009 23:44:09 +0100"  >&lt;ul&gt;
	&lt;li&gt;Reduced the num docs indexed to make the test faster&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;expungeDeletes merges away segments with deletes, if we don&apos;t&lt;br/&gt;
  test to insure the segments with deletes are in fact gone, we&apos;re &lt;br/&gt;
  unfortunately not testing the functionality of the method&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Incorporated Yonik&apos;s additions&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;commit(&quot;expungeDeletes&quot;,&quot;true&quot;);  // doesn&apos;t work&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12747446" author="yseeley@gmail.com" created="Tue, 25 Aug 2009 15:44:08 +0100"  >&lt;blockquote&gt;&lt;p&gt;if we don&apos;t test to insure the segments with deletes are in fact gone, we&apos;re unfortunately not testing the functionality of the method.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do we need to?  We should be testing that the method is called and look for evidence that it has done it&apos;s work.  All of the corner cases of testing if it did it&apos;s work correctly would seem to belong in Lucene unit tests?&lt;/p&gt;</comment>
                            <comment id="12747788" author="noble.paul" created="Wed, 26 Aug 2009 06:41:31 +0100"  >&lt;blockquote&gt;&lt;p&gt;Do we need to? We should be testing that the method is called and look for evidence that it has done it&apos;s work.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I guess , we should only test if the message indeed got called . Whether the call really does the work need not be tested&lt;/p&gt;</comment>
                            <comment id="12752696" author="gsingers" created="Tue, 8 Sep 2009 20:51:49 +0100"  >&lt;p&gt;What&apos;s the status on this one?&lt;/p&gt;</comment>
                            <comment id="12752880" author="noble.paul" created="Wed, 9 Sep 2009 04:29:54 +0100"  >&lt;p&gt;here is some confusion on whether the testcase is right/good enough. Yonik may have a final word on this&lt;/p&gt;</comment>
                            <comment id="12753132" author="yseeley@gmail.com" created="Wed, 9 Sep 2009 16:47:24 +0100"  >&lt;blockquote&gt;&lt;p&gt;Yonik may have a final word on this &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hey, there aren&apos;t any benevolent dictators around here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Arguments should stand on their own.&lt;/p&gt;

&lt;p&gt;I was just confused why the test was so complicated, and didn&apos;t look forward to maintaining it in the face of future changes.  But I guess we can always cross that bridge when we come to it.&lt;/p&gt;

&lt;p&gt;Are the current tests failing for anyone?&lt;/p&gt;</comment>
                            <comment id="12753142" author="markrmiller@gmail.com" created="Wed, 9 Sep 2009 17:14:00 +0100"  >&lt;blockquote&gt;&lt;p&gt;Hey, there aren&apos;t any benevolent dictators around here&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I always suspected we were being guided by selfish dictators &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12753179" author="noble.paul" created="Wed, 9 Sep 2009 18:36:06 +0100"  >&lt;p&gt;the tests never failed in my box or in the nightly builds. &lt;br/&gt;
Jason , did you observe it failing?&lt;/p&gt;</comment>
                            <comment id="12753628" author="gsingers" created="Thu, 10 Sep 2009 15:03:32 +0100"  >&lt;p&gt;Tests pass for me, Noble, can this be resolved now?&lt;/p&gt;</comment>
                            <comment id="12753646" author="noble.paul" created="Thu, 10 Sep 2009 15:53:30 +0100"  >&lt;p&gt;marking this as resolved. let us open another issue if the testcase needs to be changed&lt;/p&gt;</comment>
                            <comment id="12755234" author="jasonrutherglen" created="Tue, 15 Sep 2009 00:09:15 +0100"  >&lt;p&gt;The DirectUpdateHandlerTest fails as solrconfig-serialms.xml didn&apos;t make it into trunk.  Which patch was committed?&lt;/p&gt;</comment>
                            <comment id="12755322" author="noble.paul" created="Tue, 15 Sep 2009 04:31:51 +0100"  >&lt;p&gt;solrconfig-serialms.xml is not in the trunk. which testcase and patch has this?&lt;/p&gt;</comment>
                            <comment id="12755339" author="jasonrutherglen" created="Tue, 15 Sep 2009 05:51:27 +0100"  >&lt;p&gt;The latest patch dated 2009-08-24 03:44 PM.&lt;/p&gt;</comment>
                            <comment id="12775805" author="gsingers" created="Tue, 10 Nov 2009 15:52:10 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12417542" name="SOLR-1275.patch" size="20701" author="jasonrutherglen" created="Mon, 24 Aug 2009 23:44:09 +0100"/>
                            <attachment id="12417268" name="SOLR-1275.patch" size="5175" author="yseeley@gmail.com" created="Fri, 21 Aug 2009 14:08:51 +0100"/>
                            <attachment id="12417144" name="SOLR-1275.patch" size="5118" author="yseeley@gmail.com" created="Thu, 20 Aug 2009 17:00:38 +0100"/>
                            <attachment id="12417046" name="SOLR-1275.patch" size="19656" author="jasonrutherglen" created="Wed, 19 Aug 2009 20:07:13 +0100"/>
                            <attachment id="12416973" name="SOLR-1275.patch" size="10418" author="jasonrutherglen" created="Wed, 19 Aug 2009 06:32:34 +0100"/>
                            <attachment id="12413630" name="SOLR-1275.patch" size="5028" author="noble.paul" created="Thu, 16 Jul 2009 05:55:12 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 15 Jul 2009 06:31:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6372</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxm8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19922</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>