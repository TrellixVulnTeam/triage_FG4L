<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:23:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-1458/SOLR-1458.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-1458] Java Replication error: NullPointerException SEVERE: SnapPull failed on 2009-09-22 nightly</title>
                <link>https://issues.apache.org/jira/browse/SOLR-1458</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;After finally figuring out the new Java based replication, we have started both the slave and the master and issued optimize to all master Solr instances. This triggered some replication to go through just fine, but it looks like some of it is failing.&lt;/p&gt;

&lt;p&gt;Here&apos;s what I&apos;m getting in the slave logs, repeatedly for each shard:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
SEVERE: SnapPull failed 
java.lang.NullPointerException
        at org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:271)
        at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:258)
        at org.apache.solr.handler.SnapPuller$1.run(SnapPuller.java:159)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:181)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:205)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;If I issue an optimize again on the master to one of the shards, it then triggers a replication and replicates OK. I have a feeling that these SnapPull failures appear later on but right now I don&apos;t have enough to form a pattern.&lt;/p&gt;

&lt;p&gt;Here&apos;s replication.properties on one of the failed slave instances.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cat data/replication.properties 
#Replication details
#Wed Sep 23 19:35:30 PDT 2009
replicationFailedAtList=1253759730020,1253759700018,1253759670019,1253759640018,1253759610018,1253759580022,1253759550019,1253759520016,1253759490026,1253759460016
previousCycleTimeInSeconds=0
timesFailed=113
indexReplicatedAtList=1253759730020,1253759700018,1253759670019,1253759640018,1253759610018,1253759580022,1253759550019,1253759520016,1253759490026,1253759460016
indexReplicatedAt=1253759730020
replicationFailedAt=1253759730020
lastCycleBytesDownloaded=0
timesIndexReplicated=113
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and another&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cat data/replication.properties 
#Replication details
#Wed Sep 23 18:42:01 PDT 2009
replicationFailedAtList=1253756490034,1253756460169
previousCycleTimeInSeconds=1
timesFailed=2
indexReplicatedAtList=1253756521284,1253756490034,1253756460169
indexReplicatedAt=1253756521284
replicationFailedAt=1253756490034
lastCycleBytesDownloaded=22932293
timesIndexReplicated=3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Some relevant configs:&lt;br/&gt;
In solrconfig.xml:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;!-- For docs see http:&lt;span class=&quot;code-comment&quot;&gt;//wiki.apache.org/solr/SolrReplication --&amp;gt;
&lt;/span&gt;  &amp;lt;requestHandler name=&lt;span class=&quot;code-quote&quot;&gt;&quot;/replication&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.ReplicationHandler&quot;&lt;/span&gt; &amp;gt;
    &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;master&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;enable&quot;&lt;/span&gt;&amp;gt;${enable.master:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}&amp;lt;/str&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;replicateAfter&quot;&lt;/span&gt;&amp;gt;optimize&amp;lt;/str&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;backupAfter&quot;&lt;/span&gt;&amp;gt;optimize&amp;lt;/str&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;commitReserveDuration&quot;&lt;/span&gt;&amp;gt;00:00:20&amp;lt;/str&amp;gt;
    &amp;lt;/lst&amp;gt;
    &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;slave&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;enable&quot;&lt;/span&gt;&amp;gt;${enable.slave:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}&amp;lt;/str&amp;gt;

        &amp;lt;!-- url of master, from properties file --&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;masterUrl&quot;&lt;/span&gt;&amp;gt;${master.url}&amp;lt;/str&amp;gt;

        &amp;lt;!-- how often to check master --&amp;gt;
        &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;pollInterval&quot;&lt;/span&gt;&amp;gt;00:00:30&amp;lt;/str&amp;gt;
    &amp;lt;/lst&amp;gt;
  &amp;lt;/requestHandler&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The slave then has this in solrcore.properties:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
enable.slave=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
master.url=URLOFMASTER/replication
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the master has&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
enable.master=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;d be glad to provide more details but I&apos;m not sure what else I can do.  &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-926&quot; title=&quot;Exception in Replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-926&quot;&gt;&lt;del&gt;SOLR-926&lt;/del&gt;&lt;/a&gt; may be relevant.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS x64&lt;br/&gt;
8GB RAM&lt;br/&gt;
Tomcat, running with 7G max memory; memory usage is &amp;lt;2GB, so it&apos;s not the problem&lt;/p&gt;


&lt;p&gt;Host a: master&lt;br/&gt;
Host b: slave&lt;/p&gt;

&lt;p&gt;Multiple single core Solr instances, using JNDI.&lt;/p&gt;

&lt;p&gt;Java replication&lt;/p&gt;</environment>
        <key id="12436479">SOLR-1458</key>
            <summary>Java Replication error: NullPointerException SEVERE: SnapPull failed on 2009-09-22 nightly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="archon810">Artem Russakovskii</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Sep 2009 03:42:41 +0100</created>
                <updated>Tue, 10 Nov 2009 15:52:16 +0000</updated>
                            <resolved>Fri, 9 Oct 2009 19:36:34 +0100</resolved>
                                    <version>1.4</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>replication (java)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12758998" author="noble.paul" created="Thu, 24 Sep 2009 04:50:41 +0100"  >&lt;p&gt;can you hit the master with the filelist command  and see the output. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/solr/SolrReplication#line-155&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/SolrReplication#line-155&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12758999" author="noble.paul" created="Thu, 24 Sep 2009 04:56:00 +0100"  >&lt;p&gt;log the error if no file list available&lt;/p&gt;</comment>
                            <comment id="12759001" author="yseeley@gmail.com" created="Thu, 24 Sep 2009 05:08:52 +0100"  >&lt;p&gt;Why would there not be a filelist? Any idea what the underlying error is?&lt;/p&gt;</comment>
                            <comment id="12759003" author="noble.paul" created="Thu, 24 Sep 2009 05:17:24 +0100"  >&lt;p&gt;isn&apos;t it possible that by the time filelist is invoked the indexcommit of the version is gone ? In that case no files would be available&lt;/p&gt;</comment>
                            <comment id="12759004" author="noble.paul" created="Thu, 24 Sep 2009 05:21:01 +0100"  >&lt;p&gt;and we don&apos;t reserve the commit after an indexversion command . should we reserve the commitpoint if after an indexversion command?&lt;/p&gt;</comment>
                            <comment id="12759021" author="noble.paul" created="Thu, 24 Sep 2009 06:50:34 +0100"  >&lt;p&gt;reserve commits in indexversion command&lt;/p&gt;</comment>
                            <comment id="12759179" author="yseeley@gmail.com" created="Thu, 24 Sep 2009 18:12:17 +0100"  >&lt;p&gt;The best way to eliminate some of these race conditions would seem to be combine it into a single command.&lt;br/&gt;
&quot;what is your current index version?  if greater than 5, please give me the list of new files since then and please reserve them for x milliseconds&quot;&lt;/p&gt;

&lt;p&gt;But at this point (close to 1.4) I guess your patch is the most straightforward fix.&lt;/p&gt;</comment>
                            <comment id="12759247" author="archon810" created="Thu, 24 Sep 2009 21:49:15 +0100"  >&lt;p&gt;Re: hit the master with the filelist command.&lt;/p&gt;

&lt;p&gt;First of all, this may have been a really late night for the person who wrote the wiki:&lt;br/&gt;
&quot;Get list of lucene files present in the index: &lt;a href=&quot;http://host:port/solr/replication?command=filelist&amp;amp;indexversion=&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://host:port/solr/replication?command=filelist&amp;amp;indexversion=&lt;/a&gt;&amp;lt;index-version-number&amp;gt; . The version number can be obtained using the indexversion calmmand&quot;&lt;br/&gt;
The last word there ;-]&lt;/p&gt;

&lt;p&gt;Now, I hit the master with the following: MASTER/replication/?command=indexversion, get back&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;response&amp;gt; 
&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;indexversion&quot;&lt;/span&gt;&amp;gt;1253136035158&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;
&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;generation&quot;&lt;/span&gt;&amp;gt;4447&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt; 
&amp;lt;/response&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I use this in the following query: MASTER/replication/?command=filelist&amp;amp;indexversion=1253136035158&lt;/p&gt;

&lt;p&gt;but I get back&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;response&amp;gt;
&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;&amp;gt;invalid indexversion&amp;lt;/str&amp;gt;
&amp;lt;/response&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I tried the same against an another instance that doesn&apos;t have the NullPointerException replication problem and still get the same error, then I tried another one, which had no documents indexed into yet, and it returned&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;response&amp;gt; 
&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;arr name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filelist&quot;&lt;/span&gt;&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;segments_1&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253136032000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;32&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/arr&amp;gt; 
&amp;lt;/response&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here&apos;s what I see in the logs.&lt;/p&gt;

&lt;p&gt;On the master:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_08 path=/replication params={command=indexversion&amp;amp;wt=javabin} status=0 QTime=0 
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_04 path=/replication params={command=indexversion&amp;amp;wt=javabin} status=0 QTime=0 
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_10 path=/replication params={command=indexversion&amp;amp;wt=javabin} status=0 QTime=0 
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_02 path=/replication params={command=indexversion&amp;amp;wt=javabin} status=0 QTime=0 
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_12 path=/replication params={command=indexversion&amp;amp;wt=javabin} status=0 QTime=0 
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_06 path=/replication params={command=indexversion&amp;amp;wt=javabin} status=0 QTime=0 
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_08 path=/replication params={indexversion=1253136074767&amp;amp;command=filelist&amp;amp;wt=javabin} status=0 QTime=0 
Sep 24, 2009 1:56:30 PM org.apache.solr.core.SolrCore execute
INFO: [] webapp=/events_2009_06 path=/replication params={indexversion=1253136077032&amp;amp;command=filelist&amp;amp;wt=javabin} status=0 QTime=0 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the slave:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Slave in sync with master.
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Slave in sync with master.
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Master&apos;s version: 1253136074767, generation: 40983
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Master&apos;s version: 1253136077032, generation: 42291
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Slave&apos;s version: 1253136076722, generation: 41981
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Starting replication process
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Slave in sync with master.
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Slave&apos;s version: 1253136074452, generation: 40668
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Starting replication process
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.SnapPuller fetchLatestIndex
INFO: Slave in sync with master.
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.ReplicationHandler doFetch
SEVERE: SnapPull failed 
java.lang.NullPointerException
        at org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:271)
        at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:258)
        at org.apache.solr.handler.SnapPuller$1.run(SnapPuller.java:159)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:181)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:205)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
Sep 24, 2009 2:01:00 PM org.apache.solr.handler.ReplicationHandler doFetch
SEVERE: SnapPull failed 
java.lang.NullPointerException
        at org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:271)
        at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:258)
        at org.apache.solr.handler.SnapPuller$1.run(SnapPuller.java:159)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:181)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:205)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Suggestions?&lt;/p&gt;</comment>
                            <comment id="12759290" author="archon810" created="Thu, 24 Sep 2009 23:26:00 +0100"  >&lt;p&gt;Also, after an optimize is issued to the master, the problem goes away. For a while, and then starts again. I do optimizes every hour, and commits are ongoing every minute.&lt;/p&gt;

&lt;p&gt;For instance, after an optimize on the master:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;response&amp;gt; 
&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;&amp;gt;0&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;arr name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filelist&quot;&lt;/span&gt;&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.frq&amp;lt;/str&amp;gt;
&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826921000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;67855561&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.nrm&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826921000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;2515184&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.tii&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826921000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;581824&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.fnm&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826906000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;132&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.fdt&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826906000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;7805294&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.tis&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826921000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;43326001&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.fdx&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826906000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;4024292&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;_1bx2.prx&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826921000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;47213429&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;&amp;gt;segments_19jy&amp;lt;/str&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; 
name=&lt;span class=&quot;code-quote&quot;&gt;&quot;lastmodified&quot;&lt;/span&gt;&amp;gt;1253826922000&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;size&quot;&lt;/span&gt;&amp;gt;287&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/arr&amp;gt; 
&amp;lt;/response&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And another thing worth mentioning, I updated the solr.war from 8/25/09 nightly to 9/22/09 nightly but I hope that doesn&apos;t cause problems.&lt;/p&gt;</comment>
                            <comment id="12759361" author="noble.paul" created="Fri, 25 Sep 2009 04:35:35 +0100"  >&lt;p&gt;Thanks, Artem.&lt;br/&gt;
You have been quite accommodating w/ my requests. I am already looking into it.&lt;/p&gt;</comment>
                            <comment id="12759366" author="noble.paul" created="Fri, 25 Sep 2009 05:10:50 +0100"  >&lt;p&gt;diagnosis: commits keep happening and the optimized commits were getting removed by lucene because there were normal commits after the optimized commits&lt;/p&gt;

&lt;p&gt;immediete fix (probable): &lt;/p&gt;

&lt;p&gt;you may add the following snippet to your solrconfig.xml &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;mainIndex&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;deletionPolicy class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.SolrDeletionPolicy&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;	
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;keepOptimizedOnly&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;true&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;maxCommitsToKeep&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;3&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/str&amp;gt;&lt;/span&gt;		
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/deletionPolicy&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/mainIndex&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;real fix:&lt;/p&gt;

&lt;p&gt;if only replicateAfter optimize is present, ReplicationHandler should ensure that the optimized commit does not get deleted (even after normal commits happen). either by reserving it or by changing the policy&lt;/p&gt;
</comment>
                            <comment id="12759367" author="noble.paul" created="Fri, 25 Sep 2009 05:27:04 +0100"  >&lt;p&gt;for any IndexCommit kept with the ReplicationHandler , reserve it for infinity. ensure that it gets cleaned up after ReplicationHandler no longer refers to it.&lt;/p&gt;

&lt;p&gt;yonik : Please review . &lt;/p&gt;</comment>
                            <comment id="12759392" author="archon810" created="Fri, 25 Sep 2009 06:50:24 +0100"  >&lt;p&gt;Paul - I&apos;m just glad you guys are so fast to respond and eager to fix. Love OSS :-]&lt;/p&gt;</comment>
                            <comment id="12759405" author="noble.paul" created="Fri, 25 Sep 2009 07:43:34 +0100"  >&lt;p&gt;added 2 new methods to  IndexDeletionPolicyWrapper. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void reserveCommitPoint(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; indexCommitVersion)

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void releaseCommmitPoint(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; indexCommitVersion)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;every commit point held by ReplicationHandler should be reserved for ever till it is  released&lt;/p&gt;</comment>
                            <comment id="12759546" author="yseeley@gmail.com" created="Fri, 25 Sep 2009 15:41:48 +0100"  >&lt;p&gt;Shouldn&apos;t there be some kind of option on the deletion policy... say &quot;keepLastOptimized&quot;?&lt;br/&gt;
Then the ReplicationHandler would only have to flip it on (if it weren&apos;t already on).  It doesn&apos;t seem like the ReplicationHandler should be the one to pick which commit points to &quot;reserve forever&quot;.&lt;/p&gt;</comment>
                            <comment id="12759671" author="yseeley@gmail.com" created="Fri, 25 Sep 2009 19:16:25 +0100"  >&lt;p&gt;Looking into this more, I think this should be the deletion policy that keeps around the last optimized commit point if necessary.&lt;br/&gt;
Also, in checking out SolrDeletionPolicy again, it doesn&apos;t seem like the maxCommitsToKeep logic will work if keepOptimizedOnly is true.&lt;br/&gt;
I&apos;m going to take a whack at rewriting updateCommits()&lt;/p&gt;</comment>
                            <comment id="12759698" author="yseeley@gmail.com" created="Fri, 25 Sep 2009 19:58:16 +0100"  >&lt;p&gt;Here&apos;s a partial patch - only to SolrDeletionPolicy that rewrites that logic so that all of the options hopefully work correctly.  Now if keepOptimizedOnly==true and maxCommitsToKeep==1, then there should always be one optimized index commit point.&lt;/p&gt;

&lt;p&gt;Should we just document that keepOptimizedOnly needs to be true if you&apos;re doing replication on optimized commit points only?&lt;/p&gt;

&lt;p&gt;Alternately, the replication handler could set parameters on the deletion policy - the problem being that the current parameters don&apos;t lend themselves to being manipulated.  For example if the policy has keepOptimizedOnly=false and maxCommitsToKeep==5.... then if the replication handler changed keepOptimizedOnly to true, we would end up keeping 5 optimized commit points!  It would be more flexible to be able to specify a separate count for optimized commit points.&lt;/p&gt;</comment>
                            <comment id="12759721" author="yseeley@gmail.com" created="Fri, 25 Sep 2009 21:04:16 +0100"  >&lt;p&gt;Updated patch that implements a maxOptimizedCommitsToKeep parameter - this would allow the replication handler to raise it to 1 if necessary.&lt;/p&gt;</comment>
                            <comment id="12759784" author="archon810" created="Fri, 25 Sep 2009 23:24:16 +0100"  >&lt;p&gt;I haven&apos;t changed any configs yet, and this probably doesn&apos;t come as a shock to you guys, but the master just ran out of space. Upon inspection, I found 30+ snapshot dirs sitting around in /data.&lt;/p&gt;

&lt;p&gt;Paul, adding your deletionPolicy fix didn&apos;t delete the files, even after optimize. Is that expected?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
drwxrwxr-x  2 bla bla  4096 Sep 23 18:42 snapshot.20090923064214
drwxrwxr-x  2 bla bla  4096 Sep 23 19:15 snapshot.20090923071530
drwxrwxr-x  2 bla bla  4096 Sep 23 19:45 snapshot.20090923074535
drwxrwxr-x  2 bla bla  4096 Sep 23 20:15 snapshot.20090923081531
drwxrwxr-x  2 bla bla  4096 Sep 23 21:15 snapshot.20090923091531
drwxrwxr-x  2 bla bla  4096 Sep 23 22:15 snapshot.20090923101532
drwxrwxr-x  2 bla bla  4096 Sep 23 23:15 snapshot.20090923111533
drwxrwxr-x  2 bla bla  4096 Sep 24 01:15 snapshot.20090924011501
drwxrwxr-x  2 bla bla  4096 Sep 24 13:15 snapshot.20090924011535
drwxrwxr-x  2 bla bla  4096 Sep 24 02:15 snapshot.20090924021501
drwxrwxr-x  2 bla bla  4096 Sep 24 14:15 snapshot.20090924021534
drwxrwxr-x  2 bla bla  4096 Sep 24 15:15 snapshot.20090924031501
drwxrwxr-x  2 bla bla  4096 Sep 24 03:15 snapshot.20090924031502
drwxrwxr-x  2 bla bla  4096 Sep 24 04:15 snapshot.20090924041501
drwxrwxr-x  2 bla bla  4096 Sep 24 16:15 snapshot.20090924041536
drwxrwxr-x  2 bla bla  4096 Sep 24 05:15 snapshot.20090924051501
drwxrwxr-x  2 bla bla  4096 Sep 24 17:15 snapshot.20090924051537
drwxrwxr-x  2 bla bla  4096 Sep 24 06:15 snapshot.20090924061501
drwxrwxr-x  2 bla bla  4096 Sep 24 18:15 snapshot.20090924061534
drwxrwxr-x  2 bla bla  4096 Sep 24 07:15 snapshot.20090924071501
drwxrwxr-x  2 bla bla  4096 Sep 24 19:15 snapshot.20090924071533
drwxrwxr-x  2 bla bla  4096 Sep 24 08:15 snapshot.20090924081534
drwxrwxr-x  2 bla bla  4096 Sep 24 20:15 snapshot.20090924081535
drwxrwxr-x  2 bla bla  4096 Sep 24 09:15 snapshot.20090924091501
drwxrwxr-x  2 bla bla  4096 Sep 24 21:15 snapshot.20090924091532
drwxrwxr-x  2 bla bla  4096 Sep 24 10:15 snapshot.20090924101501
drwxrwxr-x  2 bla bla  4096 Sep 24 22:15 snapshot.20090924101533
drwxrwxr-x  2 bla bla  4096 Sep 24 11:15 snapshot.20090924111501
drwxrwxr-x  2 bla bla  4096 Sep 24 23:15 snapshot.20090924111532
drwxrwxr-x  2 bla bla  4096 Sep 24 12:15 snapshot.20090924121532
drwxrwxr-x  2 bla bla  4096 Sep 24 00:15 snapshot.20090924121533
drwxrwxr-x  2 bla bla  4096 Sep 25 01:15 snapshot.20090925011533
drwxrwxr-x  2 bla bla  4096 Sep 25 13:15 snapshot.20090925011540
drwxrwxr-x  2 bla bla  4096 Sep 25 02:15 snapshot.20090925021534
drwxrwxr-x  2 bla bla  4096 Sep 25 14:15 snapshot.20090925021540
drwxrwxr-x  2 bla bla  4096 Sep 25 03:15 snapshot.20090925031535
drwxrwxr-x  2 bla bla  4096 Sep 25 15:15 snapshot.20090925031540
drwxrwxr-x  2 bla bla  4096 Sep 25 15:29 snapshot.20090925032931
drwxrwxr-x  2 bla bla  4096 Sep 25 04:15 snapshot.20090925041535
drwxrwxr-x  2 bla bla  4096 Sep 25 05:15 snapshot.20090925051539
drwxrwxr-x  2 bla bla  4096 Sep 25 06:15 snapshot.20090925061538
drwxrwxr-x  2 bla bla  4096 Sep 25 07:15 snapshot.20090925071539
drwxrwxr-x  2 bla bla  4096 Sep 25 08:15 snapshot.20090925081539
drwxrwxr-x  2 bla bla  4096 Sep 25 09:15 snapshot.20090925091538
drwxrwxr-x  2 bla bla  4096 Sep 25 09:52 snapshot.20090925095213
drwxrwxr-x  2 bla bla  4096 Sep 25 10:15 snapshot.20090925101540
drwxrwxr-x  2 bla bla  4096 Sep 25 11:15 snapshot.20090925111538
drwxrwxr-x  2 bla bla  4096 Sep 25 00:15 snapshot.20090925121534
drwxrwxr-x  2 bla bla  4096 Sep 25 12:15 snapshot.20090925121538
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12759825" author="yseeley@gmail.com" created="Sat, 26 Sep 2009 01:12:34 +0100"  >&lt;p&gt;Hmmm... just happened onto this bit of odd code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  void refreshCommitpoint() {
    IndexCommit commitPoint = core.getDeletionPolicy().getLatestCommit();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(replicateOnCommit &amp;amp;&amp;amp; !commitPoint.isOptimized()){
      indexCommitPoint = commitPoint;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(replicateOnOptimize &amp;amp;&amp;amp; commitPoint.isOptimized()){
      indexCommitPoint = commitPoint;
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;edit: Looks like a bug... refreshCommitPoint isn&apos;t set for optimized indexes if only replicateOnCommit is set.&lt;/p&gt;
</comment>
                            <comment id="12759849" author="yseeley@gmail.com" created="Sat, 26 Sep 2009 03:12:22 +0100"  >&lt;p&gt;Here&apos;s a draft of a full patch.... but&lt;br/&gt;
I&apos;m getting some relatively non-reproducible test failures in a bunch of places - not sure what&apos;s up yet.&lt;/p&gt;</comment>
                            <comment id="12759851" author="lancenorskog" created="Sat, 26 Sep 2009 03:37:47 +0100"  >&lt;p&gt;I reported &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1383&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SOLR-1383&lt;/a&gt; a few weeks ago. It is one edge case of what you&apos;re all working on.  &lt;/p&gt;

&lt;p&gt;Short version: running &quot;add 1 document/commit/replicate&quot; continuously is a reliable way to cause the deletion policy to misfire.&lt;/p&gt;

&lt;p&gt;Try the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1383?focusedCommentId=12749190&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12749190&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;detailed test scenario&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12759859" author="shalinmangar" created="Sat, 26 Sep 2009 07:08:04 +0100"  >&lt;blockquote&gt;&lt;p&gt;I haven&apos;t changed any configs yet, and this probably doesn&apos;t come as a shock to you guys, but the master just ran out of space. Upon inspection, I found 30+ snapshot dirs sitting around in /data.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Artem, the Java replication does not make use of snapshot directories. They are generated if you have &quot;backupAfter&quot; in your configuration. That feature is only there for people who were using the script replication&apos;s snapshot directories for backup purposes. If you don&apos;t need it, just remove &quot;backupAfter&quot;.&lt;/p&gt;</comment>
                            <comment id="12759898" author="yseeley@gmail.com" created="Sat, 26 Sep 2009 15:01:06 +0100"  >&lt;p&gt;Strange stuff - the last error I just saw was a corrupted index exception from the spellchecker - couldn&apos;t load the segments_n file.&lt;br/&gt;
But the spellcheck building code is Lucene code - Solr&apos;s deletion policy should have no effect... weird.&lt;/p&gt;</comment>
                            <comment id="12759900" author="shalinmangar" created="Sat, 26 Sep 2009 15:08:35 +0100"  >&lt;blockquote&gt;&lt;p&gt;bq. I think this should be the deletion policy that keeps around the last optimized commit point if necessary.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yonik, shouldn&apos;t ReplicationHandler be the one to reserve commit points? Also, if we go down this way (having SolrDeletionPolicy decide these things), would a custom deletion policy play nicely with Solr?&lt;/p&gt;</comment>
                            <comment id="12759927" author="archon810" created="Sat, 26 Sep 2009 18:54:38 +0100"  >&lt;p&gt;Shalin, I&apos;ve taken the backupAfter line directly from the SolrReplication wiki which talks about Java based replication: &lt;a href=&quot;http://wiki.apache.org/solr/SolrReplication&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/solr/SolrReplication&lt;/a&gt;. I realize now it says in the comment above that line it&apos;s for backup only but why is it there in the first place? It threw me off a bit.&lt;/p&gt;</comment>
                            <comment id="12759937" author="yseeley@gmail.com" created="Sat, 26 Sep 2009 20:30:03 +0100"  >&lt;blockquote&gt;&lt;p&gt;Yonik, shouldn&apos;t ReplicationHandler be the one to reserve commit points? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It does... that part doesn&apos;t change, but replication handler requests short term reservations based on use.&lt;br/&gt;
The existing SolrDeletionPolicy already had the functionality of always keeping an optimized commit point around, and so this actually isn&apos;t new.&lt;/p&gt;</comment>
                            <comment id="12759952" author="yseeley@gmail.com" created="Sat, 26 Sep 2009 22:01:16 +0100"  >&lt;p&gt;Testing Update: I rebooted my ubuntu box, did a clean solr checkout, re-applied the patch, and got a much higher rate of test passes.  Looks like it was Gremlins.&lt;/p&gt;

&lt;p&gt;Last night I set it up to build continuously in a loop - and got about a 25% failure rate.  Problem is, I didn&apos;t have it copy out failed tests for inspection,&lt;br/&gt;
 so I don&apos;t know why it failed, and it may be as simple as a loss of internet connectivity or DNS service, or apache going down, etc (yes we have tests&lt;br/&gt;
 that rely on external networks - that&apos;s a pain).&lt;/p&gt;

&lt;p&gt;I&apos;m re-running tests now, with a stop on a test failure so I can figure out if anything is actually related to this proposed patch!&lt;/p&gt;</comment>
                            <comment id="12759957" author="yseeley@gmail.com" created="Sat, 26 Sep 2009 22:47:13 +0100"  >&lt;p&gt;Update: OK... my failures in DirectUpdateHandlerTest turned out to be testExpungeDeletes().  I&apos;ve committed simpler test code previously attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1275&quot; title=&quot;Add expungeDeletes to DirectUpdateHandler2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-1275&quot;&gt;&lt;del&gt;SOLR-1275&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
I was initially thrown off by seeing exceptions in building the spell check index... but the actual test failure was caused by testExpungeDeletes.&lt;/p&gt;

&lt;p&gt;So - is there a really bug lurking in the spellchecker component? I&apos;m at a loss of how the old testExpungeDeletes code could trigger these exceptions (or of they did/do).  It&apos;s also possible that these spellcheck exceptions spuriously happened before but they don&apos;t cause the test to fail.&lt;/p&gt;</comment>
                            <comment id="12760051" author="yseeley@gmail.com" created="Sun, 27 Sep 2009 17:42:08 +0100"  >&lt;p&gt;I&apos;ve committed this patch.  I&apos;m occasionally getting errors in TestReplicationHandler... but I also get occasional errors there w/o this patch!&lt;/p&gt;

&lt;p&gt;Artem, it would be great if you could test trunk and see if your problems are fixed.&lt;/p&gt;</comment>
                            <comment id="12760325" author="archon810" created="Mon, 28 Sep 2009 19:35:41 +0100"  >&lt;p&gt;Is the fix included in the latest nightly? 9/28/09 one.&lt;/p&gt;</comment>
                            <comment id="12760354" author="yseeley@gmail.com" created="Mon, 28 Sep 2009 20:21:43 +0100"  >&lt;blockquote&gt;&lt;p&gt;Is the fix included in the latest nightly? 9/28/09 one. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep.&lt;/p&gt;</comment>
                            <comment id="12760799" author="archon810" created="Wed, 30 Sep 2009 02:12:52 +0100"  >&lt;p&gt;Yonik, everything has been running for a day+ now and replication works as expected.&lt;/p&gt;

&lt;p&gt;On a side note, I did think that the replication notes are not very clear on the what replicateAfter on the master and pollInterval on the slave are for and what each does. I now understand what each is for but I think they could be explained more clearly. Just a suggestion.&lt;/p&gt;</comment>
                            <comment id="12760802" author="yseeley@gmail.com" created="Wed, 30 Sep 2009 02:25:51 +0100"  >&lt;blockquote&gt;&lt;p&gt;Yonik, everything has been running for a day+ now and replication works as expected.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Cool!  Resolving this issue.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;On a side note, I did think that the replication notes are not very clear on the what replicateAfter on the master and pollInterval on the slave are for and what each does. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;To be honest, I&apos;ve not looked at the actual docs on the wiki &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Concrete suggestions for changes are very welcome though.&lt;/p&gt;</comment>
                            <comment id="12760891" author="noble.paul" created="Wed, 30 Sep 2009 12:58:13 +0100"  >&lt;p&gt;isn&apos;t this a wrong fix.? It removes an existing functionality (one can&apos;t set a custom deletion policy when replicateAfterCOmmit is set)&lt;/p&gt;

&lt;p&gt;What was wrong with my latest patch?&lt;/p&gt;</comment>
                            <comment id="12761288" author="yseeley@gmail.com" created="Thu, 1 Oct 2009 19:06:24 +0100"  >&lt;p&gt;Since SolrDeletionPolicy already had the needed functionallity, it seemed like the most straightforward fix.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It removes an existing functionality (one can&apos;t set a custom deletion policy when replicateAfterCOmmit is set) &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True - I hadn&apos;t considered that.  Of course I was confused why we allowed custom deletion policies in the first place.&lt;br/&gt;
It&apos;s a dangerous place to mess around, and there haven&apos;t been any identifiable use cases, right?&lt;/p&gt;</comment>
                            <comment id="12761916" author="yseeley@gmail.com" created="Sat, 3 Oct 2009 18:12:52 +0100"  >&lt;p&gt;Seems like if you want to replicate only optimized indexes, we should recommend the user configure SolrDeletionPolicy to always keep an optimized commit point around.&lt;br/&gt;
If you rely on the replication handler to reserve it, it won&apos;t work across a reboot, right?&lt;/p&gt;

&lt;p&gt;Although I see no reason for custom delete policies, I&apos;m not really against adding support for that in the replication handler as long as people are confident the changes don&apos;t introduce any new bugs.&lt;br/&gt;
Regardless, I think the separate count for optimized commit points that I added to SolrDeletionPolicy should remain (esp since it fixed other bugs too).&lt;/p&gt;</comment>
                            <comment id="12762127" author="noble.paul" created="Mon, 5 Oct 2009 10:37:41 +0100"  >&lt;p&gt;added methods to reserve and unreserve to IndexDeletionPolicyWrapper&lt;/p&gt;</comment>
                            <comment id="12762129" author="noble.paul" created="Mon, 5 Oct 2009 10:44:08 +0100"  >&lt;p&gt;we need to ensure that any component which is using a commit point should reserve it till it is done. After that it should be unreserved.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If you rely on the replication handler to reserve it, it won&apos;t work across a reboot, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is a problem with the current configuration &lt;/p&gt;

&lt;p&gt;example&lt;/p&gt;

&lt;p&gt;set&lt;br/&gt;
replicateAfter=optimize&lt;/p&gt;

&lt;p&gt;This means that if the master is restarted soon after an optimize , the slaves will not get the new commit point&lt;br/&gt;
set&lt;br/&gt;
replicateAfter=optimize&lt;br/&gt;
replicateAfter=startup&lt;/p&gt;

&lt;p&gt;This means that the replication will pick up the latest commit point after a master restart. not necessarily an optimized one.&lt;/p&gt;

&lt;p&gt;So the solution should be , if replicateAfter=commit is absent,  then pickup the latest optimized commitpoint &lt;/p&gt;


</comment>
                            <comment id="12762145" author="noble.paul" created="Mon, 5 Oct 2009 11:39:06 +0100"  >&lt;p&gt;I guess this should work. We need a testcase for only replicateAfter=optimize and replicateAfter=startup&lt;/p&gt;</comment>
                            <comment id="12762524" author="noble.paul" created="Tue, 6 Oct 2009 07:10:59 +0100"  >&lt;p&gt;I plan to commit this shortly,&lt;br/&gt;
Please comment  if there is any concern&lt;/p&gt;</comment>
                            <comment id="12764147" author="yseeley@gmail.com" created="Fri, 9 Oct 2009 19:36:34 +0100"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added the logic to actually check the saved commits in delete()... wouldn&apos;t have worked w/o that.&lt;/li&gt;
	&lt;li&gt;added protection against a NPE if no searcher had been opened in inform()&lt;/li&gt;
	&lt;li&gt;changed reservedCommits to savedCommits since we already use &quot;reserve&quot; to describe short term reservations&lt;/li&gt;
	&lt;li&gt;added getUserData() to the commit point wrapper&lt;/li&gt;
	&lt;li&gt;added @Override to commit point wrapper to more easily detect future changes&lt;/li&gt;
	&lt;li&gt;a little javadoc for the new methods&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12775887" author="gsingers" created="Tue, 10 Nov 2009 15:52:16 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12436853">SOLR-1475</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12421274" name="SOLR-1458.patch" size="5289" author="noble.paul" created="Mon, 5 Oct 2009 11:39:06 +0100"/>
                            <attachment id="12420622" name="SOLR-1458.patch" size="11433" author="yseeley@gmail.com" created="Sat, 26 Sep 2009 03:12:22 +0100"/>
                            <attachment id="12420530" name="SOLR-1458.patch" size="4760" author="noble.paul" created="Fri, 25 Sep 2009 07:43:34 +0100"/>
                            <attachment id="12420525" name="SOLR-1458.patch" size="3396" author="noble.paul" created="Fri, 25 Sep 2009 05:27:04 +0100"/>
                            <attachment id="12420436" name="SOLR-1458.patch" size="1853" author="noble.paul" created="Thu, 24 Sep 2009 06:50:34 +0100"/>
                            <attachment id="12420433" name="SOLR-1458.patch" size="758" author="noble.paul" created="Thu, 24 Sep 2009 04:56:00 +0100"/>
                            <attachment id="12420598" name="SolrDeletionPolicy.patch" size="5690" author="yseeley@gmail.com" created="Fri, 25 Sep 2009 21:04:15 +0100"/>
                            <attachment id="12420595" name="SolrDeletionPolicy.patch" size="2819" author="yseeley@gmail.com" created="Fri, 25 Sep 2009 19:58:16 +0100"/>
                            <attachment id="12421268" name="reserve.patch" size="1784" author="noble.paul" created="Mon, 5 Oct 2009 10:37:41 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 24 Sep 2009 03:50:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6196</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxl53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19744</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>