<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:22:12 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-68/SOLR-68.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-68] Custom ClassLoader for &quot;plugins&quot;</title>
                <link>https://issues.apache.org/jira/browse/SOLR-68</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;After beating my head against my desk for a few hours yesterday trying to document how to load custom plugins (ie: Analyzers, RequestHandlers, Similarities, etc...) in the various Servlet Containers &amp;#8211; only to discover that it is aparently impossible unless you use Resin, it occured to me in the wee hours of last night that since the only time we ever need to load &quot;pluggable&quot; classes is when explicitly lookup the class by name, we could make out own ClassLoader and use it ... so i whiped together a little patch to Config.java that would load JARs out of $solr.home}/lib and was seriously suprised to discover that it seemed to work.&lt;/p&gt;

&lt;p&gt;In the clod light of day, I am again suprised that I still think this might be a good idea, but i&apos;m not very familiar with ClassLoader semantics, so i&apos;m not sure if what i&apos;ve done is an abomination or not &amp;#8211; or if the idea is sound, but the implimentation is crap.  &lt;/p&gt;

&lt;p&gt;I&apos;m also not sure if it works in all cases: more testing of various Containers would be good, as well as testing more complex sitautions (ie: what if a class explicitly named as a plugin and loaded by this new classloader then uses reflection to load another class from the same Jar using Thread.currentThread().getContextClassLoader() ... will that fail?)&lt;/p&gt;


&lt;p&gt;So far I&apos;ve quick and dirty testing with my apachecon JAR under apache-tomcat-5.5.17, the jetty start.jar we use for the example, resin-3.0.21 and jettyplus-5.1.11-- all of which seemed to work fine except for jettyplus-5.1.11 &amp;#8211; but that may have been because of some other configuration problem I had.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12354968">SOLR-68</key>
            <summary>Custom ClassLoader for &quot;plugins&quot;</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Hoss Man</assignee>
                                    <reporter username="hossman">Hoss Man</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Nov 2006 19:10:14 +0000</created>
                <updated>Fri, 10 May 2013 11:40:28 +0100</updated>
                            <resolved>Tue, 14 Nov 2006 02:06:42 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12447893" author="hossman" created="Tue, 7 Nov 2006 19:11:40 +0000"  >&lt;p&gt;patch that creates a new classloader containing any JARs found in $&lt;/p&gt;
{solr.home}
&lt;p&gt;/lib and uses that class loader anytime class names read from a config file.&lt;/p&gt;</comment>
                            <comment id="12447932" author="funtick" created="Tue, 7 Nov 2006 21:44:24 +0000"  >&lt;p&gt;It was done in Eclipse, for instance. Nutch project also has huge &apos;plugins&apos;-supporting codebase which are automatically loaded and &apos;wired&apos; together without explicit XML definitions, they did it Eclipse-way...&lt;/p&gt;

&lt;p&gt;I mean if you use explicit XML like &lt;br/&gt;
&amp;lt;filter class=&quot;org.zzz.my.solr.filters.LowerCaseFilter&quot;/&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;you don&apos;t need to design smth like Eclipse or Nutch... A lot of headache just to replace strings like &quot;org.apache.nutch.parse.html.HtmlParser&quot; by&lt;br/&gt;
  &amp;lt;name&amp;gt;plugin.includes&amp;lt;/name&amp;gt;&lt;br/&gt;
  &amp;lt;value&amp;gt;protocol-http|urlfilter-regex|parse-(text|html|js)|index-basic|query-(basic|site|url)|summary-basic|scoring-opic&amp;lt;/value&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here, &quot;parse-(text|html|js)&quot; will look for a jar file with ID &quot;parse-html&quot; in plugin.xml file (inside the jar file):&lt;br/&gt;
&amp;lt;plugin&lt;br/&gt;
   id=&quot;parse-html&quot;&lt;br/&gt;
   name=&quot;Html Parse Plug-in&quot;&lt;br/&gt;
   version=&quot;1.0.0&quot;&lt;br/&gt;
   provider-name=&quot;nutch.org&quot;&amp;gt;&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;The main reason for such design: to avoid explicit names &quot;org.apache.nutch.parse.html.HtmlParser&quot; in main configuration XML, to allow third-parties to develop compatible plugins (which could have very different complicated extension points and implementations with specific settings, not defined in main Solr schema.xml file)...&lt;/p&gt;

&lt;p&gt;I don&apos;t think it would work in WebLogic without some explicit settings; and JEE does not easily allow direct access to a file system, especially to load a class &apos;from a different context&apos;  (security considerations)...&lt;/p&gt;</comment>
                            <comment id="12447942" author="funtick" created="Tue, 7 Nov 2006 22:23:47 +0000"  >&lt;p&gt;&amp;gt;...is when explicitly lookup the class by name, we could make out own ClassLoader and use it...&lt;/p&gt;

&lt;p&gt;The simplest way is to create a Class object is:&lt;br/&gt;
  Class fooClass = Class.forName(&quot;Foo&quot;)&lt;br/&gt;
which is equivalent to: &lt;br/&gt;
  Class.forName(&quot;Foo&quot;, true, this.getClass().getClassLoader())&lt;/p&gt;

&lt;p&gt;Then,&lt;br/&gt;
   Foo fooObject = fooClass.newInstance()&lt;/p&gt;

&lt;p&gt;and we don&apos;t need an explicit instance of a ClassLoader at all... just put JARs in a classpath... and it works in all containers, because we use &apos;parent&apos; classloader with inherited permissions instead of touching the &apos;container-managed&apos; Thread...&lt;/p&gt;

&lt;p&gt;Sorry, still trying to understand why we would need that method:&lt;br/&gt;
   public static Class findClass(String cname, String... subpackages)&lt;br/&gt;
even here, we can loop in &lt;span class=&quot;error&quot;&gt;&amp;#91;subpackage+&amp;quot;.&amp;quot;+cname&amp;#93;&lt;/span&gt; using Class.forName()...&lt;/p&gt;</comment>
                            <comment id="12447947" author="funtick" created="Tue, 7 Nov 2006 22:43:28 +0000"  >&lt;p&gt;why do you need URLClassLoader? &lt;/p&gt;

&lt;p&gt;1) public class URLClassLoader extends SecureClassLoader&lt;br/&gt;
2) &quot;The classes that are loaded are by default granted permission only to access the URLs specified when the URLClassLoader was created.&quot;&lt;/p&gt;

&lt;p&gt;we need to create an instance defined in XML... just call Class.forName(&quot;org.zzz.Foo&quot;).newInstance()... it will throw an exception ClassNotFoundException if a class can&apos;t be found in a path, or NoClassDefFoundError in case of unresolved nested dependencies (am I right?)...&lt;/p&gt;</comment>
                            <comment id="12447950" author="hossman" created="Tue, 7 Nov 2006 22:54:54 +0000"  >
&lt;p&gt;&amp;gt; and we don&apos;t need an explicit instance of a ClassLoader at all... just put JARs in a classpath... and it works in &lt;br/&gt;
&amp;gt; all containers, because we use &apos;parent&apos; classloader with inherited permissions instead of touching the &lt;br/&gt;
&amp;gt; &apos;container-managed&apos; Thread...&lt;/p&gt;

&lt;p&gt;...it&apos;s not that easy.  If you need to load a class which refrences another class defined in the webapp itself, your approach breaks because the ClassLoader won&apos;t wlk back down the ClassLoader hierarchy to try and find it.&lt;/p&gt;

&lt;p&gt;Ie: if you create a &quot;CustomRequestHandler implements SolrRequestHandler&quot; and put it in a JAR which you then put in the &quot;shared&quot; lib dir for Tomcat, you&apos;ll get a class not found error for something like SolrQueryRequest when CustomRequestHandler is loaded, because SolrQueryRequest is defined in the WAR and &quot;shared&quot; class loader higher doesn&apos;t have access to those classes...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://tomcat.apache.org/tomcat-5.5-doc/class-loader-howto.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://tomcat.apache.org/tomcat-5.5-doc/class-loader-howto.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...hence my idea to create a new ClassLoader instance which was a &quot;child&quot; of the class loader being used for the webapp itself, so when it delegates on classes it doesn&apos;t recognize, it delegates &quot;up&quot; to the solr.war class loader.&lt;/p&gt;


&lt;p&gt;Regarding your previous comment about the Nutch/Eclipse plugin model ... i&apos;m not sure if that configuration syntax really fits for us ... it assumes a specific set of extension points, such that a single plugin might map to multiple points, and (as far as i can tell) each extension point is either bound to a single plugin, or hte plugins &quot;chain&quot; themselves.&lt;/p&gt;

&lt;p&gt;This doesn&apos;t really fit our use case, where you might want dozens of differnet analyzers used in differnet fields &amp;#8211; ideally someone should be able to pull any jar out of the lucene/contrib directory containing an analyzer or a Similarity class they want to use, drop that jar into a specified location, and put the name of the schema where they want to use it.&lt;/p&gt;

&lt;p&gt;As for &lt;b&gt;how&lt;/b&gt; Nutch does this ... they seem to be doing roughly the same thing as I&apos;m trying for in this patch, except the more specific meaning of &quot;plugin&quot; allows them to have a seperate ClassLoader per plugin, that loads the exact jars enumerated in the plugins &quot;manifest&quot; (an xml config file; not a jar MANIFEST) .. but again i&apos;m not sure if/how they deal with the possibility of a plugin loaded class using reflection to try and load another class later on.&lt;/p&gt;

</comment>
                            <comment id="12448229" author="funtick" created="Wed, 8 Nov 2006 18:49:28 +0000"  >&lt;p&gt;understood, thanks...&lt;br/&gt;
As I understood (functional requirement): we need to be able to easily add plugins without making changes to solr.war, and this patch fixes that. (plugin depends on solr classes AND plugin is physically outside of solr.war); the most &apos;naive&apos; solution could be separate shared solr.jar in the same classpath/classloader as plugins... &lt;/p&gt;</comment>
                            <comment id="12448230" author="hossman" created="Wed, 8 Nov 2006 19:01:27 +0000"  >
&lt;p&gt;&amp;gt;&amp;gt; the most &apos;naive&apos; solution could be separate shared solr.jar in the same classpath/classloader as plugins...&lt;/p&gt;

&lt;p&gt;Yeah, I considered that briefly, but I had two big reservations about attempting that approach...&lt;/p&gt;

&lt;p&gt;1) Complicates installation in the &quot;simple&quot; case.  right now users that wnat an &quot;out of hte box&quot; experience just need to drop a WAR file in place and create two config files.  seperating the classes into an external JAR would complicate that by requiring them to put that JAR in their containers shared/common classpath.&lt;/p&gt;

&lt;p&gt;2) I&apos;m 90% certain that would eliminate the ability to run multiple solr instances in the same servlet container, because of the way the SolrCore and much of hte COnfig information is implimented via Singletons ... if those classes were loaded by a common classloader, there would be only one instance per container &amp;#8211; not one instance per webapp.&lt;/p&gt;</comment>
                            <comment id="12448278" author="hossman" created="Wed, 8 Nov 2006 21:15:55 +0000"  >&lt;p&gt;FYI: I just did a fresh install of jetty-5.1.11 and confirmed that (for my simple test case of some self contained request handlers in a single JAR) it works with jetty and jettyplus.&lt;/p&gt;

&lt;p&gt;I&apos;d like to do some more testing with just dropping lucene contrib JARs in, and having multiple JARs ... but assuming no suprises pop up, I think i may just not worry about some of the more extreme situtions i brought up on the mailing list since:&lt;br/&gt;
  1) those situations will hopefully be rare&lt;br/&gt;
  2) i&apos;m not even sure if those situations will cause a problem&lt;br/&gt;
  3) if one of those situations does cause a problem, we can allways re-address the specifics of the ClassLoader independent of the overall &quot;API&quot; of having a $&lt;/p&gt;
{solr.home}
&lt;p&gt;/lib directory&lt;br/&gt;
  4) if someone relaly does have a situation we can&apos;t address because of some specific quirks in the ClassLoader of their servlet container, nothing in this approach procludes then from unwrapping the WAR and ading their classes directly (which is the only option at the moment)&lt;/p&gt;
</comment>
                            <comment id="12448296" author="otis" created="Wed, 8 Nov 2006 22:29:22 +0000"  >&lt;p&gt;Hoss, Mortbay guys releases Jetty 6.0 and even 6.1 (or 6.0.1, not sure any more) a few weeks ago.  Jetty 5.* is getting obsoleted, to it would be best to try Jetty 6.* with your class loader.&lt;/p&gt;</comment>
                            <comment id="12448319" author="klaasm" created="Wed, 8 Nov 2006 23:32:47 +0000"  >
&lt;p&gt;   [[ Old comment, sent from unregistered email on Wed, 8 Nov 2006 14:40:07 -0800 ]]&lt;/p&gt;

&lt;p&gt;Just wanted to comment that I&apos;m +1 on the idea--getting this workign&lt;br/&gt;
with jetty was an annoyance.  I&apos;m not really qualified to comment on&lt;br/&gt;
the approach, but it sounds reasonable.&lt;/p&gt;
</comment>
                            <comment id="12448926" author="hossman" created="Sat, 11 Nov 2006 02:25:31 +0000"  >&lt;p&gt;FYI: the same simple test with jetty-6.0.1 worked. ... still haven&apos;t had a chance to try out any more involved tests with multiple jars&lt;/p&gt;</comment>
                            <comment id="12449536" author="hossman" created="Tue, 14 Nov 2006 02:06:42 +0000"  >&lt;p&gt;I did some more testing with tomcat and some contrib jars from Lucene Java ... didn&apos;t have any problems so i added a bit of javadoc and commited.&lt;/p&gt;</comment>
                            <comment id="12589354" author="hossman" created="Wed, 16 Apr 2008 00:56:44 +0100"  >&lt;p&gt;This bug was modified as part of a bulk update using the criteria...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Marked (&quot;Resolved&quot; or &quot;Closed&quot;) and &quot;Fixed&quot;&lt;/li&gt;
	&lt;li&gt;Had no &quot;Fix Version&quot; versions&lt;/li&gt;
	&lt;li&gt;Was listed in the CHANGES.txt for 1.1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The Fix Version for all 38 issues found was set to 1.1, email notification&lt;br/&gt;
was suppressed to prevent excessive email.&lt;/p&gt;

&lt;p&gt;For a list of all the issues modified, search jira comments for this&lt;br/&gt;
(hopefully) unique string: 20080415hossman3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12344503" name="classloader.patch" size="2444" author="hossman" created="Tue, 7 Nov 2006 19:11:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Nov 2006 21:44:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7514</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxtlj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21114</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>