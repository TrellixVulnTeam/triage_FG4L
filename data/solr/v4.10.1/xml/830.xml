<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:21:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-830/SOLR-830.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-830] snappuller picks bad snapshot name</title>
                <link>https://issues.apache.org/jira/browse/SOLR-830</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;as mentioned on the mailing list...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/FileNotFoundException-on-slave-after-replication---script-bug--to20111313.html#a20111313&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/FileNotFoundException-on-slave-after-replication---script-bug--to20111313.html#a20111313&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;We&apos;re seeing strange behavior on one of our slave nodes after replication. 
When the new searcher is created we see FileNotFoundExceptions in the log
and the index is strangely invalid/corrupted.

We may have identified the root cause but wanted to run it by the community. 
We figure there is a bug in the snappuller shell script, line 181:

snap_name=`ssh -o StrictHostKeyChecking=no ${master_host} &quot;ls
${master_data_dir}|grep &apos;snapshot\.&apos;|grep -v wip|sort -r|head -1&quot;` 

This line determines the directory name of the latest snapshot to download
to the slave from the master.  Problem with this line is that it grab the
temporary work directory of a snapshot in progress.  Those temporary
directories are prefixed with  &quot;temp&quot; and as far as I can tell should never
get pulled from the master so its easy to disambiguate.  It seems that this
temp directory, if it exists will be the newest one so if present it will be
the one replicated: FAIL.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12407424">SOLR-830</key>
            <summary>snappuller picks bad snapshot name</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="billa">Bill Au</assignee>
                                    <reporter username="hossman">Hoss Man</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Oct 2008 15:12:14 +0000</created>
                <updated>Tue, 10 Nov 2009 15:51:50 +0000</updated>
                            <resolved>Thu, 20 Nov 2008 14:14:29 +0000</resolved>
                                    <version>1.2</version>
                    <version>1.3</version>
                                    <fixVersion>1.4</fixVersion>
                                    <component>replication (scripts)</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12643512" author="hossman" created="Wed, 29 Oct 2008 15:19:40 +0000"  >&lt;p&gt;while i haven&apos;t noticed this bug myself, and i&apos;m not very &quot;shell script smart&quot;, it does seem like it would be a problem ... prior to r529471 snappuller used a find command that required the filenames start with &quot;snapshot.&quot; where as the current grep just requires that it contain &quot;snapshot.&quot;&lt;/p&gt;

&lt;p&gt;the original poster had the following suggested fix...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;We&apos;ve tweaked the line to exclude any directories starting with &quot;temp&quot;:
snap_name=`ssh -o StrictHostKeyChecking=no ${master_host} &quot;ls
${master_data_dir}|grep &apos;snapshot\.&apos;|grep -v wip|grep -v temp|sort -r|head
-1&quot;` 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...my first reaction would be to change the grep to use an anchored regex, but i&apos;m not sure how portable that is - so perhaps the &quot;grep -v temp&quot; is the way to go.  I&apos;ll leave it to people who understand shell scripts better.&lt;/p&gt;</comment>
                            <comment id="12644004" author="billa" created="Thu, 30 Oct 2008 15:48:48 +0000"  >
&lt;p&gt;I think we should use a regular expression and match against the naming convention of the snapshot (snapshot.YYYYmmddHHMMss).  Here is what I propose:&lt;/p&gt;

&lt;p&gt;snap_name=`ssh -o StrictHostKeyChecking=no $&lt;/p&gt;
{master_host}
&lt;p&gt; &quot;ls&lt;br/&gt;
$&lt;/p&gt;
{master_data_dir}
&lt;p&gt;|egrep &apos;^snapshot\.&lt;span class=&quot;error&quot;&gt;&amp;#91;123456789&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt;&lt;/p&gt;
{13}
&lt;p&gt;$&apos;|sort -r|head&lt;br/&gt;
-1&quot;`&lt;/p&gt;</comment>
                            <comment id="12644011" author="hossman" created="Thu, 30 Oct 2008 16:09:09 +0000"  >&lt;p&gt;that&apos;s kind of what i thinking, but i wasn&apos;t sure how portable egrep is.&lt;/p&gt;</comment>
                            <comment id="12644037" author="steve_rowe" created="Thu, 30 Oct 2008 16:59:39 +0000"  >&lt;p&gt;From the egrep(1) man page:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Traditional egrep did not support the { metacharacter, and some egrep
implementations  support \{ instead, so portable scripts should avoid {
in egrep patterns and should use [{] to match a literal {.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Perl is pretty portable, and has a stable regex language - how about (untested):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
snap_name=`ssh -o StrictHostKeyChecking=no ${master_host} \
&lt;span class=&quot;code-quote&quot;&gt;&quot;perl -e &apos;chdir q/${master_data_dir}/; print ((sort grep {/^snapshot[.][1-9][0-9]{13}\$/} &amp;lt;*&amp;gt;)[-1])&apos;&quot;&lt;/span&gt;`
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12647331" author="billa" created="Thu, 13 Nov 2008 16:43:59 +0000"  >&lt;p&gt;Steve, thanks for the perl code.  I need to get rid of the &quot;\&quot; before the &quot;$&quot; in order to get it to work for me:&lt;/p&gt;

&lt;p&gt;perl -e &apos;chdir q/$&lt;/p&gt;
{master_data_dir}
&lt;p&gt;/; print ((sort grep {/^snapshot&lt;span class=&quot;error&quot;&gt;&amp;#91;.&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1-9&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt;&lt;/p&gt;
{13}
&lt;p&gt;$/} &amp;lt;*&amp;gt;)&lt;span class=&quot;error&quot;&gt;&amp;#91;-1&amp;#93;&lt;/span&gt;)&apos;&lt;/p&gt;


&lt;p&gt;I have tested this on Linux and FreeBSD.  I will test on Mac OS X tonight.  It will be good if someone can do a quick test on Solaris.  You really don&apos;t need a full brown Solr installation to test it.  Just create some dummy directory with various names like:&lt;/p&gt;

&lt;p&gt;snapshot.00080527124131&lt;br/&gt;
snapshot.20080527124131&lt;br/&gt;
snapshot.20080527124131-wip&lt;br/&gt;
snapshot.20080527140518&lt;br/&gt;
snapshot.20080527140610&lt;br/&gt;
snapshot.20081113113700&lt;br/&gt;
snapshot.2080527124131&lt;br/&gt;
temp-snapshot.20080527124131&lt;/p&gt;

&lt;p&gt;and then run the perl command to make sure the right one is returned.  With the data set above, you should get:&lt;/p&gt;

&lt;p&gt;snapshot.20081113113700&lt;/p&gt;</comment>
                            <comment id="12647345" author="steve_rowe" created="Thu, 13 Nov 2008 17:42:28 +0000"  >&lt;p&gt;Bill, I ran the following script on a Linux box against a remote Solaris 2.8 box, with Perl 5.8.0 installed, on which I created the set of empty directories you listed:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
master_host=remotesolaris
master_data_dir=/tmp/solrtest
snap_name=`ssh -o StrictHostKeyChecking=no ${master_host} \
&lt;span class=&quot;code-quote&quot;&gt;&quot;perl -e &apos;chdir q|${master_data_dir}|; print ((sort grep {/^snapshot[.][1-9][0-9]{13}$/} &amp;lt;*&amp;gt;)[-1])&apos;&quot;&lt;/span&gt;`
echo ${snap_name}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;N.B.: I had to change the quoting boundary character around $&lt;/p&gt;
{master_data_dir}, from &apos;/&apos; to &apos;|&apos;, since ${master_data_dir}
&lt;p&gt; contains &apos;/&apos; characters &amp;#8211; I think &apos;|&apos; is really unlikely to be a pathname component.&lt;/p&gt;

&lt;p&gt;It worked for me both with and without the &apos;\&apos; before the &apos;$&apos; &amp;#8211; I get the following output from the script:&lt;/p&gt;

&lt;p&gt;snapshot.20081113113700&lt;/p&gt;</comment>
                            <comment id="12647384" author="billa" created="Thu, 13 Nov 2008 20:20:26 +0000"  >&lt;p&gt;Steven, thanks for testing on Solaris.  It looks like on Linux and FreeBSD that the &apos;\&apos; in front of &apos;$&apos; escape the special meaning of &apos;$&apos; so it is trying to match against the literal &apos;$&apos; after all the digits (ie snapshot.20080527124131$).  Unless this does not work on Mac OS X, I will go with perl without the &apos;\&apos; before the &apos;$&apos;.  I will attach a patch here after I test on my Mac tonight.&lt;/p&gt;</comment>
                            <comment id="12648260" author="billa" created="Mon, 17 Nov 2008 19:12:14 +0000"  >&lt;p&gt;It works on Mac OS X.&lt;/p&gt;</comment>
                            <comment id="12648261" author="billa" created="Mon, 17 Nov 2008 19:13:27 +0000"  >&lt;p&gt;patch to use perl regular expression to improve accuracy in finding latest snapshot.&lt;/p&gt;</comment>
                            <comment id="12649375" author="billa" created="Thu, 20 Nov 2008 14:14:28 +0000"  >&lt;p&gt;Patch committed:&lt;/p&gt;

&lt;p&gt;Sending        CHANGES.txt&lt;br/&gt;
Sending        src/scripts/snappuller&lt;br/&gt;
Transmitting file data ..&lt;br/&gt;
Committed revision 719233.&lt;/p&gt;</comment>
                            <comment id="12775562" author="gsingers" created="Tue, 10 Nov 2009 15:51:50 +0000"  >&lt;p&gt;Bulk close for Solr 1.4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12394089" name="solr-830.patch" size="651" author="billa" created="Mon, 17 Nov 2008 19:13:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 30 Oct 2008 15:48:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6796</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxoy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20361</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>