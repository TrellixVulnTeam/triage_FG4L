<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:14:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/SOLR-915/SOLR-915.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[SOLR-915] SolrCore;close()  - scope to exploit parallelism among the number of closeHooks </title>
                <link>https://issues.apache.org/jira/browse/SOLR-915</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In SolrCore: close() - all the way towards the end of the function - there seems to be a sequential list of close method invocation. &lt;/p&gt;

&lt;p&gt;    if( closeHooks != null ) {&lt;br/&gt;
       for( CloseHook hook : closeHooks ) &lt;/p&gt;
{
         hook.close( this );
      }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;I believe this has scope to be parallelized ( actually the entire sequence of close operations , updateHandler,close() etc.) - by means of launching them in separate threads from an ExecutorService , for a much faster shutdown as the process definitely does not need to be sequential. &lt;/p&gt;

&lt;p&gt;This becomes all the more important in the multi-core context when we might want to shutdown and restart a SolrCore altogether. &lt;/p&gt;</description>
                <environment>&lt;p&gt;Tomcat 6, JRE 6&lt;/p&gt;</environment>
        <key id="12410660">SOLR-915</key>
            <summary>SolrCore;close()  - scope to exploit parallelism among the number of closeHooks </summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ryantxu">Ryan McKinley</assignee>
                                    <reporter username="kaykay.unique">Karthik K</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Dec 2008 17:55:29 +0000</created>
                <updated>Fri, 19 Dec 2008 19:21:50 +0000</updated>
                            <resolved>Tue, 16 Dec 2008 19:13:58 +0000</resolved>
                                                    <fixVersion>1.4</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <timeoriginalestimate seconds="345600">96h</timeoriginalestimate>
                            <timeestimate seconds="345600">96h</timeestimate>
                                        <comments>
                            <comment id="12656428" author="kaykay.unique" created="Sun, 14 Dec 2008 18:14:57 +0000"  >&lt;p&gt;multi-core , as in multi-core processors specifically , where this process can complete much faster than what is currently now. We are running a 4-core box ( pretty expensive !! ) and would like to utilize the cpu cycles as much as possible. &lt;/p&gt;</comment>
                            <comment id="12656437" author="noble.paul" created="Sun, 14 Dec 2008 18:40:53 +0000"  >&lt;p&gt;before exploring the possiblity of parallelizing some code can we explain the problem statement?&lt;/p&gt;

&lt;p&gt;In the entire codebase there are very few instances of closeHook usages. So the problem is not as grave as you point out it to be&lt;/p&gt;

&lt;p&gt;are we trying to solve an imaginary problem? &lt;/p&gt;



</comment>
                            <comment id="12656470" author="kaykay.unique" created="Sun, 14 Dec 2008 21:43:00 +0000"  >&lt;p&gt;The problem statement (hardly is imaginary ), is for a faster shutdown and reinitialization of the SolrCore.  Hence the need to parallelize the code.  It is not just about closeHook , but also the other sequence of steps performed at close. All of them can have a better performance gain by parallelizing the code. Again , adding some well-abstracted code, should make things more maintainable. &lt;/p&gt;</comment>
                            <comment id="12656482" author="ryantxu" created="Sun, 14 Dec 2008 22:17:16 +0000"  >&lt;p&gt;Faster startup and shutdown sounds great. &lt;/p&gt;

&lt;p&gt;Have you run tests to see if this gets faster when run in parallel?  I imagine you are talking about many cores before this would make any difference.&lt;/p&gt;</comment>
                            <comment id="12656535" author="shalinmangar" created="Mon, 15 Dec 2008 03:36:52 +0000"  >&lt;p&gt;Kay, I guess all we are trying to avoid is the &lt;a href=&quot;http://people.apache.org/~hossman/#xyproblem&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;XY problem&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We just want to make sure that we are solving the right problem. Do you mind telling us about your use-case on solr-user because the solution you have adopted is not something the code was written for. Perhaps there are alternate ways of achieving the goals? There are lots of people on these lists who have done some very heavy lifting with Solr and might be able to offer suggestions.&lt;/p&gt;</comment>
                            <comment id="12656679" author="kaykay.unique" created="Mon, 15 Dec 2008 18:13:16 +0000"  >&lt;p&gt;Yes-  We are having a system with multiple cores , for different (Lucene) indexes in memory .  Also - we have a much less-frequent writer and high-frequency multiple readers for the same directory. &lt;/p&gt;

&lt;p&gt;The tests that I have run uses threadpools ( FixedPools for now). We also a couple of custom handlers , that are SolrCoreAware , that adds closehooks ( addCloseHook() in SolrCore ) through the inform method.  The closehooks do some io heavylifting - which I believe has scope to be exploited.  Solr, as much as being a server, also serves the purpose of an API , for custom request handlers to be extended. So - my concern here is that the close() for a single SolrCore instance also takes significant importance, even though it is all about unwinding resource acquisition. &lt;/p&gt;

&lt;p&gt;ps: I am not a big fan of running multiple SolrCore on a single app server since architecturally (also from the point of deploying it ) - it is not intuitive / scalable. But until we move towards separating out - this is something we need to live with. &lt;/p&gt;</comment>
                            <comment id="12656696" author="ryantxu" created="Mon, 15 Dec 2008 18:54:53 +0000"  >&lt;p&gt;I see &amp;#8211; so this becomes important when you have many cores and the code in hook.close( this ) takes a while.&lt;/p&gt;

&lt;p&gt;Behavior wise, we should make sure that core.close() does not return until all the closeHooks are finished.&lt;/p&gt;

&lt;p&gt;Can you submit a patch with your fix?&lt;/p&gt;</comment>
                            <comment id="12656702" author="kaykay.unique" created="Mon, 15 Dec 2008 19:17:28 +0000"  >&lt;p&gt;I agree on the behavior (may be using a CountdownLatch). Let me submit the patch soon for the same. &lt;/p&gt;</comment>
                            <comment id="12656744" author="kaykay.unique" created="Mon, 15 Dec 2008 20:45:11 +0000"  >&lt;p&gt;1. New class- SolrExecutor, providing an abstraction of the Executor framework for all threads across the SolrSystem. &lt;/p&gt;

&lt;p&gt;2. SolrCore: &lt;/p&gt;

&lt;p&gt;. List&amp;lt;closeHooks&amp;gt; changed to Collection&amp;lt;CloseHook&amp;gt; as the order does not matter when they are launched in independent threads. &lt;/p&gt;


&lt;p&gt;3. More comments added to CloseHook explaining the context of the same. &lt;/p&gt;</comment>
                            <comment id="12656752" author="ryantxu" created="Mon, 15 Dec 2008 21:06:28 +0000"  >&lt;p&gt;Overall looks reasonable...&lt;/p&gt;

&lt;p&gt;But I&apos;m weary of adding static classes (we just spent so much time getting rid of them!)&lt;/p&gt;

&lt;p&gt;Rather then adding a static SolrExecutor class, perhaps we could add a &quot;getExecutor()&quot; method to to CoreContainer?  This would allow it to be modified if necessary.  It would also allow it to be loaded lazily so it does not affect the memory footprint (not sure that is a big deal or not)&lt;/p&gt;</comment>
                            <comment id="12656756" author="kaykay.unique" created="Mon, 15 Dec 2008 21:11:57 +0000"  >&lt;p&gt;Sure - That is fine with me. &lt;/p&gt;

&lt;p&gt;My objective is to have a static method somewhere that returns an Executor , that could be used to launch various threads. Also - at the same time - keeping the abstraction of Executor creation away from the user so that it could be tweaked depending on the startup memory constraints. &lt;/p&gt;
</comment>
                            <comment id="12656757" author="kaykay.unique" created="Mon, 15 Dec 2008 21:19:35 +0000"  >&lt;p&gt;1) Removed SolrExecutor. &lt;/p&gt;

&lt;p&gt;2) Added Executor to CoreContainer . &lt;/p&gt;</comment>
                            <comment id="12656759" author="kaykay.unique" created="Mon, 15 Dec 2008 21:26:46 +0000"  >&lt;p&gt;Just thought about the case in which the closeHook can thrown unchecked Exceptions.  As such with current implementation - close() would hang - (because the latch counter would not have decremented). &lt;/p&gt;

&lt;p&gt;Revised code would be bound in a try block as below - while giving the guarantee that close() definitely does complete even if there is an erroneous closeHook attached to the service. &lt;/p&gt;

&lt;p&gt;       solrExecutor.execute(new Runnable() {&lt;br/&gt;
          public void run() {&lt;br/&gt;
            try &lt;/p&gt;
{ 
              hook.close(SolrCore.this);
            }
&lt;p&gt; finally &lt;/p&gt;
{ 
              latch.countDown();
            }
&lt;p&gt;          } &lt;/p&gt;

&lt;p&gt;The question is - do we want this ? &lt;/p&gt;</comment>
                            <comment id="12656764" author="ryantxu" created="Mon, 15 Dec 2008 21:45:39 +0000"  >&lt;p&gt;How do you feel about this version?&lt;/p&gt;

&lt;p&gt;Rather then make a public static function on CoreContainer &amp;#8211; it has a package protected member.&lt;/p&gt;

&lt;p&gt;-------&lt;/p&gt;

&lt;p&gt;Looking over this again, I don&apos;t see how this helps the problem of having lots of cores.  If I follow correctly, this just helps if you have lots of long running shutdown hooks.&lt;/p&gt;

&lt;p&gt;If you call core1.close(), core2.close() sequentially it will still block for one to finish before core2...&lt;/p&gt;

&lt;p&gt;Do we we really want the parallel part in CoreContainer.shutdown()?&lt;/p&gt;</comment>
                            <comment id="12656771" author="kaykay.unique" created="Mon, 15 Dec 2008 21:58:10 +0000"  >&lt;p&gt;The version that I had initially was to just launch the threads for closeHooks ( excluding the CountDownLatch , so SolrCore::close() returns after invoking all the hooks ). &lt;/p&gt;

&lt;p&gt;As far as the behavior of SolrCore::close() &lt;br/&gt;
1) do we want  the guarantee that the closehooks are called for the same in separate threads and eventually execute, or &lt;br/&gt;
2) do we also want the guarantee that the closehooks have completed as well. &lt;/p&gt;


&lt;p&gt;As far as the Executor is concerned - the motivation is that , other potential new threads / existing threads ( I could see 4 instances of new Thread() { }.start() in the code ) can use a common executor so that the executor handles the cleanup / reuse of thread from the thread pools. While the thread pool policy might vary - it would be useful to have as minimum executors as possible to be re-used in other cases as well. &lt;/p&gt;</comment>
                            <comment id="12656777" author="ryantxu" created="Mon, 15 Dec 2008 22:25:25 +0000"  >&lt;p&gt;Can we back up a bit...  what problem exactly are you having?&lt;/p&gt;

&lt;p&gt;We need to see if there is a good minimal-impact solution with back compatibility.  In the end, we want the existing behavior to work as it does now: you close a core and all the closeHooks are executed.&lt;/p&gt;

&lt;p&gt;Where is the blocking you are hitting?  Are  you calling CoreContainer.shutdown()?  are you calling the close() function programatically or via the webapp?  &lt;/p&gt;

&lt;p&gt;--------&lt;/p&gt;

&lt;p&gt;As for new Thread() vs using a ThreadPool &amp;#8211; can we open that as a new issue/discussion.  It seems to make sense, but I have not thought about the consequences too much.  If we are adding a container wide ThreadPool it would be good to do that explicitly rather then as a side effect of an edge case (slow shutdown hooks)&lt;/p&gt;</comment>
                            <comment id="12656876" author="yseeley@gmail.com" created="Tue, 16 Dec 2008 04:11:41 +0000"  >&lt;p&gt;Another issue with calling close hooks in parallel is thread safety and race conditions which could cause double closes or null pointer exceptions, etc.&lt;/p&gt;</comment>
                            <comment id="12657081" author="kaykay.unique" created="Tue, 16 Dec 2008 17:37:29 +0000"  >&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Another issue with calling close hooks in parallel is thread safety and race conditions which could cause double closes or null pointer exceptions, etc.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Ideally the close hooks should all be independent of each other without any order among them. When we register multiple handlers (through &amp;lt;requesthandler&amp;gt; in solrconfig.xml ) - they might register their own closehooks as necessary. In that case - the order becomes totally irrelevant ( so the member of CloseHooks is better defined as a Collection , rather than a List, irrespective of if we have parallelism or not ).  Maintaining the same order as the order of definition in solrconfig.xml is not very intuitive since it is possible for people to move around content in the .xml file. &lt;/p&gt;

&lt;p&gt;If they were going to totally parallel - then there is not much scope for race conditions since they do not share any object ( closeHook.close() has no objects ) and it merely serves as a notification to a hook . &lt;/p&gt;

&lt;p&gt;doubleCloses, are not possible since there seems to be an AtomicInteger right at the beginning of close() which executes only if the counter is set to 0 . &lt;/p&gt;

&lt;p&gt;I did not understand the part about NPE , though. &lt;/p&gt;</comment>
                            <comment id="12657083" author="kaykay.unique" created="Tue, 16 Dec 2008 17:41:35 +0000"  >&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; As for new Thread() vs using a ThreadPool - can we open that as a new issue/discussion. It seems to make sense, but I have not thought about the consequences too much. If we are adding a container wide ThreadPool it would be good to do that explicitly rather then as a side effect of an edge case (slow shutdown hooks)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;



&lt;p&gt;I have opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-922&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-922&lt;/a&gt; for a web-app wide ThreadPool design , which I agree - is independent of this issue. Started a &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/200812.mbox/%3C4947DE46.6030909@gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/lucene-solr-user/200812.mbox/%3C4947DE46.6030909@gmail.com%3E&lt;/a&gt; in the mailing list ( solr-user ) about the problem. &lt;/p&gt;</comment>
                            <comment id="12657087" author="ryantxu" created="Tue, 16 Dec 2008 17:44:59 +0000"  >&lt;p&gt;I don&apos;t see any issue with Collection vs List.&lt;/p&gt;

&lt;p&gt;However I still don&apos;t see how making closeHook execution parallel helps your problem.  close() still returns when the core and all its hooks have closed.&lt;/p&gt;

&lt;p&gt;Perhaps you just want to add a single closeHook that starts up a Thead for your long running operations?  &lt;/p&gt;</comment>
                            <comment id="12657091" author="kaykay.unique" created="Tue, 16 Dec 2008 17:51:51 +0000"  >&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  I don&apos;t see any issue with Collection vs List.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;List, by default implies ordering and Collection does not. Making it a collection is more intuitive since there is really not a specific order ( at least intuitively) that could be obvious to the programmer . Since - there could be multiple plugins registering themselves as SolrCoreAware and adding closeHooks , Hence a Collection intuitively reflects what the underlying use case is. &lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Perhaps you just want to add a single closeHook that starts up a Thead for your long running operations?&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Sure - I could. But I believe by nature of being a closeHook - it should not interfere with the actual close process , but act as a plugin to the process that is guaranteed to be notified when the process happens. &lt;/p&gt;</comment>
                            <comment id="12657092" author="ryantxu" created="Tue, 16 Dec 2008 18:10:06 +0000"  >&lt;p&gt;sorry, i should have said, &quot;I have no objection to changing List -&amp;gt; Collection&quot;&lt;/p&gt;

&lt;p&gt;So this issue is really about changing the semantics of closeHook &amp;#8211; you are suggesting changing the meaning so that it is just a notification, not code inserted in the shutdown cycle.&lt;/p&gt;

&lt;p&gt;To me, the existing logic makes the most sense &amp;#8211; the close hook is called when the core shuts down; after core.close() returns you know that all the hooks have been called.  In the case where you want to fire a long running process, the close hook can start its own thread.   &lt;/p&gt;

&lt;p&gt;The existing process makes &lt;b&gt;both&lt;/b&gt; options possible, the way you are proposing forces everyone to run the hook asynchronously (even existing code that assumes it won&apos;t be).&lt;/p&gt;

&lt;p&gt;I am -1 on a change like that...&lt;/p&gt;</comment>
                            <comment id="12657097" author="kaykay.unique" created="Tue, 16 Dec 2008 18:27:41 +0000"  >&lt;p&gt;Ok - then let me submit a revised patch with List change to Collection and some javadoc added to CloseHook explaining why it needs to be short-lived. &lt;/p&gt;</comment>
                            <comment id="12657099" author="kaykay.unique" created="Tue, 16 Dec 2008 18:34:59 +0000"  >&lt;p&gt;1) Add comment to CloseHook.close() &lt;/p&gt;

&lt;p&gt;2) SolrCore.closeHooks ( change it from a List to a Collection interface. )&lt;/p&gt;</comment>
                            <comment id="12657120" author="ryantxu" created="Tue, 16 Dec 2008 19:13:58 +0000"  >&lt;p&gt;check: rev 727122&lt;/p&gt;

&lt;p&gt;thanks Kay&lt;/p&gt;</comment>
                            <comment id="12657130" author="kaykay.unique" created="Tue, 16 Dec 2008 19:33:54 +0000"  >&lt;p&gt;Thanks Ryan for helping with the fix. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12396222" name="SOLR-915.patch" size="1261" author="kaykay.unique" created="Tue, 16 Dec 2008 18:34:59 +0000"/>
                            <attachment id="12396130" name="SOLR-915.patch" size="4614" author="ryantxu" created="Mon, 15 Dec 2008 21:45:39 +0000"/>
                            <attachment id="12396128" name="SOLR-915.patch" size="4472" author="kaykay.unique" created="Mon, 15 Dec 2008 21:19:35 +0000"/>
                            <attachment id="12396124" name="SOLR-915.patch" size="5253" author="kaykay.unique" created="Mon, 15 Dec 2008 20:45:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 14 Dec 2008 18:40:53 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxxofb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20276</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>