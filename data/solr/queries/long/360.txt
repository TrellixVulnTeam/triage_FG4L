we were doing some performance testing for the updating aspects of solr and ran into what seems to be a large problem.  we're creating small documents with an id and one field of 1 term only submitting them in batches of 200 with commits every 5000 docs.  when we run the client with 1 thread everything is fine.  when we run it win >1 threads things go south (stack trace is below).  i've attached the junit test which shows the problem.  this happens on both a mac and a pc and when running solr in both jetty and tomcat.  i'll create a junit issue if necessary but i thought i'd see if anyone else had run into this problem first.   

also, the problem does not seem to surface under solr1.2

(RyanM suggested it might be related to SOLR-215)

(output from junit test)
Started thread: 0
Started thread: 1
org.apache.solr.common.SolrException: Current_state_is_not_among_the_states_START_ELEMENT_ATTRIBUTEvalid_for_getAttributeCountjavalangIllegalStateException_Current_state_is_not_among_the_states_START_ELEMENTATTRIBUTEvalid_for_getAttributeCountat_comsunorgapachexercesinternalimplXMLStreamReaderImplgetAttributeCountXMLStreamReaderImpljava598at_orgapachesolrhandlerXmlUpdateRequestHandlerreadDocXmlUpdateRequestHandlerjava335at_orgapachesolrhandlerXmlUpdateRequestHandlerprocessUpdateXmlUpdateRequestHandlerjava181at_orgapachesolrhandlerXmlUpdateRequestHandlerhandleRequestBodyXmlUpdateRequestHandlerjava109at_orgapachesolrhandlerRequestHandlerBasehandleRequestRequestHandlerBasejava78at_orgapachesolrcoreSolrCoreexecuteSolrCorejava804at_orgapachesolrservletSolrDispatchFilterexecuteSolrDispatchFilterjava193at_orgapachesolrservletSolrDispatchFilterdoFilterSolrDispatchFilterjava161at_orgmortbayjettyservletServletHandler$CachedChaindoFilterServletHandlerjava1089at_orgmortbayjettyservletServletHandlerhandleServletHandlerjava365at_orgmortbayjettysecuritySecurityHandlerhandleSecurityHandlerjava216at_orgmortbayjettyservletSessionHandlerhandleSessionHandlerjava181at_orgmortbayjettyhandlerContextHandlerhandleContextHandlerjava712at_orgmortbayjettywebappWebAppContexthandleWebAppContextjava405at_orgmortbayjettyhandlerContextHandlerCollectionhandleContextHandlerCollectionjava211at_orgmortbayjettyhandlerHandlerCollectionhandleHandlerCollectionjava114at_orgmortbayjettyhandlerHandlerWrapperhandleHandlerWrapperjava139at_orgmortbayjettyServerhandleServerjava285at_orgmortbayjettyHttpConnectionhandleRequestHttpConnectionjava502at_orgmortbayjettyHttpConnection$RequestHandlercontentHttpConnectionjava835at_orgmortbayjettyHttpParserparseNextHttpParserjava641at_orgmortbayjettyHttpParserparseAvailableHttpParserjava208_at_orgmortbayje

Current_state_is_not_among_the_states_START_ELEMENT_ATTRIBUTEvalid_for_getAttributeCountjavalangIllegalStateException_Current_state_is_not_among_the_states_START_ELEMENTATTRIBUTEvalid_for_getAttributeCountat_comsunorgapachexercesinternalimplXMLStreamReaderImplgetAttributeCountXMLStreamReaderImpljava598at_orgapachesolrhandlerXmlUpdateRequestHandlerreadDocXmlUpdateRequestHandlerjava335at_orgapachesolrhandlerXmlUpdateRequestHandlerprocessUpdateXmlUpdateRequestHandlerjava181at_orgapachesolrhandlerXmlUpdateRequestHandlerhandleRequestBodyXmlUpdateRequestHandlerjava109at_orgapachesolrhandlerRequestHandlerBasehandleRequestRequestHandlerBasejava78at_orgapachesolrcoreSolrCoreexecuteSolrCorejava804at_orgapachesolrservletSolrDispatchFilterexecuteSolrDispatchFilterjava193at_orgapachesolrservletSolrDispatchFilterdoFilterSolrDispatchFilterjava161at_orgmortbayjettyservletServletHandler$CachedChaindoFilterServletHandlerjava1089at_orgmortbayjettyservletServletHandlerhandleServletHandlerjava365at_orgmortbayjettysecuritySecurityHandlerhandleSecurityHandlerjava216at_orgmortbayjettyservletSessionHandlerhandleSessionHandlerjava181at_orgmortbayjettyhandlerContextHandlerhandleContextHandlerjava712at_orgmortbayjettywebappWebAppContexthandleWebAppContextjava405at_orgmortbayjettyhandlerContextHandlerCollectionhandleContextHandlerCollectionjava211at_orgmortbayjettyhandlerHandlerCollectionhandleHandlerCollectionjava114at_orgmortbayjettyhandlerHandlerWrapperhandleHandlerWrapperjava139at_orgmortbayjettyServerhandleServerjava285at_orgmortbayjettyHttpConnectionhandleRequestHttpConnectionjava502at_orgmortbayjettyHttpConnection$RequestHandlercontentHttpConnectionjava835at_orgmortbayjettyHttpParserparseNextHttpParserjava641at_orgmortbayjettyHttpParserparseAvailableHttpParserjava208_at_orgmortbayje

request: http://localhost:8983/solr/update?wt=xml&version=2.2
	at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:230)
	at org.apache.solr.client.solrj.request.UpdateRequest.process(UpdateRequest.java:199)
	at org.apache.solr.client.solrj.impl.BaseSolrServer.add(BaseSolrServer.java:46)
	at org.apache.solr.client.solrj.impl.BaseSolrServer.add(BaseSolrServer.java:61)
	at org.apache.solr.client.solrj.embedded.TestJettyLargeVolume$DocThread.run(TestJettyLargeVolume.java:69)
Exception in thread "DocThread-0" java.lang.AssertionError: DocThread-0---Current_state_is_not_among_the_states_START_ELEMENT_ATTRIBUTEvalid_for_getAttributeCountjavalangIllegalStateException_Current_state_is_not_among_the_states_START_ELEMENTATTRIBUTEvalid_for_getAttributeCountat_comsunorgapachexercesinternalimplXMLStreamReaderImplgetAttributeCountXMLStreamReaderImpljava598at_orgapachesolrhandlerXmlUpdateRequestHandlerreadDocXmlUpdateRequestHandlerjava335at_orgapachesolrhandlerXmlUpdateRequestHandlerprocessUpdateXmlUpdateRequestHandlerjava181at_orgapachesolrhandlerXmlUpdateRequestHandlerhandleRequestBodyXmlUpdateRequestHandlerjava109at_orgapachesolrhandlerRequestHandlerBasehandleRequestRequestHandlerBasejava78at_orgapachesolrcoreSolrCoreexecuteSolrCorejava804at_orgapachesolrservletSolrDispatchFilterexecuteSolrDispatchFilterjava193at_orgapachesolrservletSolrDispatchFilterdoFilterSolrDispatchFilterjava161at_orgmortbayjettyservletServletHandler$CachedChaindoFilterServletHandlerjava1089at_orgmortbayjettyservletServletHandlerhandleServletHandlerjava365at_orgmortbayjettysecuritySecurityHandlerhandleSecurityHandlerjava216at_orgmortbayjettyservletSessionHandlerhandleSessionHandlerjava181at_orgmortbayjettyhandlerContextHandlerhandleContextHandlerjava712at_orgmortbayjettywebappWebAppContexthandleWebAppContextjava405at_orgmortbayjettyhandlerContextHandlerCollectionhandleContextHandlerCollectionjava211at_orgmortbayjettyhandlerHandlerCollectionhandleHandlerCollectionjava114at_orgmortbayjettyhandlerHandlerWrapperhandleHandlerWrapperjava139at_orgmortbayjettyServerhandleServerjava285at_orgmortbayjettyHttpConnectionhandleRequestHttpConnectionjava502at_orgmortbayjettyHttpConnection$RequestHandlercontentHttpConnectionjava835at_orgmortbayjettyHttpParserparseNextHttpParserjava641at_orgmortbayjettyHttpParserparseAvailableHttpParserjava208_at_orgmortbayje

Current_state_is_not_among_the_states_START_ELEMENT_ATTRIBUTEvalid_for_getAttributeCountjavalangIllegalStateException_Current_state_is_not_among_the_states_START_ELEMENTATTRIBUTEvalid_for_getAttributeCountat_comsunorgapachexercesinternalimplXMLStreamReaderImplgetAttributeCountXMLStreamReaderImpljava598at_orgapachesolrhandlerXmlUpdateRequestHandlerreadDocXmlUpdateRequestHandlerjava335at_orgapachesolrhandlerXmlUpdateRequestHandlerprocessUpdateXmlUpdateRequestHandlerjava181at_orgapachesolrhandlerXmlUpdateRequestHandlerhandleRequestBodyXmlUpdateRequestHandlerjava109at_orgapachesolrhandlerRequestHandlerBasehandleRequestRequestHandlerBasejava78at_orgapachesolrcoreSolrCoreexecuteSolrCorejava804at_orgapachesolrservletSolrDispatchFilterexecuteSolrDispatchFilterjava193at_orgapachesolrservletSolrDispatchFilterdoFilterSolrDispatchFilterjava161at_orgmortbayjettyservletServletHandler$CachedChaindoFilterServletHandlerjava1089at_orgmortbayjettyservletServletHandlerhandleServletHandlerjava365at_orgmortbayjettysecuritySecurityHandlerhandleSecurityHandlerjava216at_orgmortbayjettyservletSessionHandlerhandleSessionHandlerjava181at_orgmortbayjettyhandlerContextHandlerhandleContextHandlerjava712at_orgmortbayjettywebappWebAppContexthandleWebAppContextjava405at_orgmortbayjettyhandlerContextHandlerCollectionhandleContextHandlerCollectionjava211at_orgmortbayjettyhandlerHandlerCollectionhandleHandlerCollectionjava114at_orgmortbayjettyhandlerHandlerWrapperhandleHandlerWrapperjava139at_orgmortbayjettyServerhandleServerjava285at_orgmortbayjettyHttpConnectionhandleRequestHttpConnectionjava502at_orgmortbayjettyHttpConnection$RequestHandlercontentHttpConnectionjava835at_orgmortbayjettyHttpParserparseNextHttpParserjava641at_orgmortbayjettyHttpParserparseAvailableHttpParserjava208_at_orgmortbayje

request: http://localhost:8983/solr/update?wt=xml&version=2.2
	at org.junit.Assert.fail(Assert.java:71)
	at org.apache.solr.client.solrj.embedded.TestJettyLargeVolume$DocThread.run(TestJettyLargeVolume.java:92)