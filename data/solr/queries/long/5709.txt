In a sharded (non-SolrCloud) deployment, if you index a document with the same unique key value into more than one shard, and then try to highlight grouped docs with more than one doc per group, where the grouped docs contain at least one duplicate doc pair, you get an AIOOBE.

Here's the stack trace I got from such a situation, with 1 doc indexed into each shard in a 2-shard index, with group.limit=2:


ERROR null:java.lang.ArrayIndexOutOfBoundsException: 1
		at org.apache.solr.handler.component.HighlightComponent.finishStage(HighlightComponent.java:185)
		at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:328)
		at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
		at org.apache.solr.core.SolrCore.execute(SolrCore.java:1916)
		at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:758)
		at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:412)
		at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:202)
		at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)
		at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:136)
		at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)
		at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)
		at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:229)
		at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)
		at org.eclipse.jetty.server.handler.GzipHandler.handle(GzipHandler.java:301)
		at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1077)
		at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)
		at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)
		at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)
		at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)
		at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)
		at org.eclipse.jetty.server.Server.handle(Server.java:368)
		at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)
		at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)
		at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)
		at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)
		at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)
		at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82)
		at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:628)
		at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:52)
		at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)
		at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)
		at java.lang.Thread.run(Thread.java:724)

