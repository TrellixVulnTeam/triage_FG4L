Factor out core discovery and persistence logic