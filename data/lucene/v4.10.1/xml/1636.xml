<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:12:57 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1636/LUCENE-1636.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[LUCENE-1636] TokenFilters with a null value in the constructor fail</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1636</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                    <description>&lt;p&gt;While migrating from 2.4.x to 2.9-dev I found a lot of failing unittests.&lt;br/&gt;
One problem is with TokenFilters that do a super(null) in the constructor.&lt;br/&gt;
I fixed it by changing the constructor to super(new EmptyTokenStream())&lt;br/&gt;
This will cause problems and frustration to others while migrating to 2.9.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12425426">LUCENE-1636</key>
            <summary>TokenFilters with a null value in the constructor fail</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="mikemccand">Michael McCandless</assignee>
                                    <reporter username="wheijke">Wouter Heijke</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 May 2009 08:52:07 +0100</created>
                <updated>Thu, 8 Oct 2009 00:29:22 +0100</updated>
                            <resolved>Fri, 22 May 2009 14:53:19 +0100</resolved>
                                    <version>2.9</version>
                                    <fixVersion>2.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12709348" author="mikemccand" created="Thu, 14 May 2009 11:22:31 +0100"  >&lt;p&gt;Hmm... that&apos;s no good.&lt;/p&gt;

&lt;p&gt;Can you give some more specifics here?  Which TokenFilter(s) are doing super(null)?&lt;/p&gt;

&lt;p&gt;What other unit tests are failing?&lt;/p&gt;</comment>
                            <comment id="12709353" author="wheijke" created="Thu, 14 May 2009 11:45:42 +0100"  >&lt;p&gt;My own filters and my own tests.&lt;br/&gt;
It is just that the behaviour of Lucene has changed in such cases.&lt;/p&gt;</comment>
                            <comment id="12709369" author="thetaphi" created="Thu, 14 May 2009 12:34:05 +0100"  >&lt;p&gt;Hi Wouter,&lt;br/&gt;
I tend to say, this is Won&apos;t fix:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You use TokenFilter in an undocumented way. I suspect, that you set the delegate stream later, correct? To prevent this, the protected &quot;input&quot; member should normally be &quot;final&quot;, as this is not possible (but worked with old analyzers) - ok, this was an error, to not make the delegate strean final (but we shoudl fix this &lt;b&gt;now&lt;/b&gt;)&lt;/li&gt;
	&lt;li&gt;The main problem of changing the non-final delegate stream later lies in the fact, that with 2.9 a new TokenStream API (setUseNewAPI()) was added. This new API does not use the Token class anymore, but uses Attributes. The stream&apos;s attributes list must be reused in the TokenFilters. If you initialize a TokenFilter with a specific delegate, the attribute instances are copied. If you change the delegate stream later, the filter still uses the attributes of the original stream and will update the wrong ones, it will not work anymore.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So we cannot support this wrong behaviour of TokenFilter anymore. But we should fix the final accessor of &quot;input&quot;, I will attach a patch.&lt;/p&gt;</comment>
                            <comment id="12709370" author="thetaphi" created="Thu, 14 May 2009 12:34:42 +0100"  >&lt;p&gt;This patch prevents changing the delegate stream.&lt;/p&gt;</comment>
                            <comment id="12709371" author="wheijke" created="Thu, 14 May 2009 12:37:27 +0100"  >&lt;p&gt;Here&apos;s an example&lt;br/&gt;
before: &lt;br/&gt;
private MyFilter myFilter = new MyFilter(null);&lt;/p&gt;

&lt;p&gt;after:&lt;br/&gt;
private MyFilter myFilter = new MyFilter(new EmptyTokenStream());&lt;/p&gt;</comment>
                            <comment id="12709372" author="wheijke" created="Thu, 14 May 2009 12:40:35 +0100"  >&lt;p&gt;Whatever cause it was, it was behaving this way for a long time, changing it to the new way in 3.0 seems more acceptable to me then in 2.9 to me.&lt;/p&gt;</comment>
                            <comment id="12709374" author="thetaphi" created="Thu, 14 May 2009 12:40:54 +0100"  >&lt;p&gt;If you do not use a delegate TokenStream, extend TokenStream instead of TokenFilter. If you want to later set the delegate, see my comment (and patch to prevent this incorrect usage) above.&lt;/p&gt;</comment>
                            <comment id="12709375" author="thetaphi" created="Thu, 14 May 2009 12:42:33 +0100"  >&lt;p&gt;What do you want to do with an filter without a delegate? Calling next() would simply NPE, too!&lt;/p&gt;</comment>
                            <comment id="12711704" author="mikemccand" created="Thu, 21 May 2009 18:21:48 +0100"  >&lt;p&gt;I think we should change this in 2.9, for the reasons Uwe pointed out, to disallow changing the delegate after construction.&lt;/p&gt;</comment>
                            <comment id="12711915" author="wheijke" created="Fri, 22 May 2009 02:27:55 +0100"  >&lt;p&gt;I only hope users will understand this and they realize that 2.9 is not backwards compatible to previous versions! This code in our codebase was added by knowledgeable Lucene developers!&lt;/p&gt;</comment>
                            <comment id="12711919" author="thetaphi" created="Fri, 22 May 2009 02:47:41 +0100"  >&lt;p&gt;Hi Wouter,&lt;br/&gt;
I still want to find out, what you are trying to do with a TokenFilter without a delegate! Can you explain, why you want to initialize with super(null)?&lt;br/&gt;
If it is because you want to change it later to something non-null, it will not work anymore (this is why I want to make the delgate stream final). So please explain!&lt;/p&gt;</comment>
                            <comment id="12711920" author="thetaphi" created="Fri, 22 May 2009 02:50:46 +0100"  >&lt;p&gt;Mike:&lt;br/&gt;
Would this affect backwards compatibility? If we make it final and nobody changes the stream, everything is ok. Is this also the case, when using lucene.jar as a dropin-replacement without recompilation? Will changing a final variable from code, compiled before finalization, be detected by the JVM? Is the compiled code with final still binary compatible to code compiled againt non-final members?&lt;br/&gt;
I think, we should try this out before committing!&lt;/p&gt;</comment>
                            <comment id="12711933" author="wheijke" created="Fri, 22 May 2009 03:45:10 +0100"  >&lt;p&gt;I&apos;m on holiday now, but as far as I recollect (as I was not the author of the code) it was done on some filters that would be used in another situation (similar to a filter) to use the filter&apos;s functionality. Also it was used with filters that could not be extended, so a new filter was created, also here the orignal filter&apos;s public methods would be called.&lt;/p&gt;

&lt;p&gt;In a way it doesn&apos;t matter, it could be done with the api without any problems with the latest few releases that i know of.&lt;/p&gt;

&lt;p&gt;A more elegant way if one would like to introduce this new behaviour is to at least log some kind of error message in the 2.9 release so users would be alarmed that they use the Lucene api in a way that is not supported anymore.&lt;/p&gt;</comment>
                            <comment id="12712008" author="mikemccand" created="Fri, 22 May 2009 10:52:03 +0100"  >&lt;p&gt;Good questions Uwe!&lt;/p&gt;

&lt;p&gt;I tested the back-compat by adding this to TestAnalyzers temporarily&lt;br/&gt;
in my local checkout:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; class TestFilter &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TokenFilter {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TestFilter() {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WhitespaceTokenizer(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;));
  }
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testChangeTokenFilterInput() {
  TokenFilter tf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestFilter();
  &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;tf.input = &quot;&lt;/span&gt; + tf.input);
  tf.input = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, &lt;tt&gt;ant test-tag -Dtestcase=TestAnalyzers&lt;/tt&gt; results in:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit] ------------- Standard Output ---------------
[junit] tf.input = (start=0,end=0,term=)
[junit] ------------- ---------------- ---------------
[junit] Testcase: testChangeTokenFilterInput(org.apache.lucene.analysis.TestAnalyzers):	Caused an ERROR
[junit] &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
[junit] java.lang.IllegalAccessError
[junit] 	at org.apache.lucene.analysis.TestAnalyzers.testChangeTokenFilterInput(TestAnalyzers.java:143)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, 1) it doesn&apos;t break JAR drop-in-abilility when one references&lt;br/&gt;
input, and 2) indeed at runtime final-ness is enforced by the JRE.  So&lt;br/&gt;
I think we should proceed with the change?  It is a back-compat break&lt;br/&gt;
for those users who change input after creating a TokenFilter, but&lt;br/&gt;
such a use case was not legal usage of the API, and will specifically&lt;br/&gt;
not work like it did in the past (so back-compat was already broken,&lt;br/&gt;
just in a much more sneaky manner).&lt;/p&gt;</comment>
                            <comment id="12712021" author="thetaphi" created="Fri, 22 May 2009 11:47:27 +0100"  >&lt;p&gt;Thanks, I am still in Japan and had no time to check this out myself. So it seems good. I would suggest to add this to changes.txt with a warning about the change in backwards compatibility.&lt;br/&gt;
The issue itsself should be closed as wont-fix, as the usage of Filters with a null delegate is not specified in API and is not correct.&lt;br/&gt;
The case, Wouter explained, is just a workaround for incorrect usage of filters. He wants to reuse some methods of the filter somewhere else and wants to construct a &quot;dummy&quot; instance for that. He should not do this and better move the code accessible outside of the TokenFilter to a separate class.&lt;br/&gt;
Maybe we should add a special ==null test to the constructor, that early throws a NPE with a short notice, that this usage is no longer supported.&lt;/p&gt;</comment>
                            <comment id="12712025" author="thetaphi" created="Fri, 22 May 2009 12:02:55 +0100"  >&lt;p&gt;Oh, you already committed this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12712076" author="mikemccand" created="Fri, 22 May 2009 14:05:48 +0100"  >&lt;p&gt;OK I&apos;ll add a null check in AttributeSource&apos;s ctor.&lt;/p&gt;</comment>
                            <comment id="12712660" author="wheijke" created="Mon, 25 May 2009 09:45:30 +0100"  >&lt;p&gt;A good example of this &apos;abuse&apos; is in ShingleMatrixFilter.java in one of it&apos;s constructors.&lt;br/&gt;
Here also the input is not used and replaced by an EmptyTokenStream:&lt;/p&gt;

&lt;p&gt;    // set the input to be an empty token stream, we already have the data.&lt;br/&gt;
    this.input = new EmptyTokenStream();&lt;/p&gt;


</comment>
                            <comment id="12712671" author="thetaphi" created="Mon, 25 May 2009 10:33:22 +0100"  >&lt;blockquote&gt;&lt;p&gt;A good example of this &apos;abuse&apos; is in ShingleMatrixFilter.java in one of it&apos;s constructors.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This class extends TokenStream not TokenFilter! As the input instance member of TokenFilter is now final, it would not even compile. Please note, this is one of the contrib packages, not yet using the new API, so with useNewApi set to true, this TokenStream would fail (see &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1460&quot; title=&quot;Change all contrib TokenStreams/Filters to use the new TokenStream API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-1460&quot;&gt;&lt;del&gt;LUCENE-1460&lt;/del&gt;&lt;/a&gt;). The change, you have the problem with, is caused by the new TokenStream API, and so NULL delegates are not possible!&lt;/p&gt;</comment>
                            <comment id="12762281" author="mbennett" created="Mon, 5 Oct 2009 19:04:04 +0100"  >&lt;p&gt;(trouble posting, forgive if duplicate)&lt;br/&gt;
This change also broke the Japanese morphological SEN / Lucene integration code in lucene-ja.  Since Solr 1.4 is based on Lucene 2.9, this will also effectively break SEN for Solr users who upgrade to 1.4.&lt;/p&gt;

&lt;p&gt;I&apos;m not complaining.  Reading the above comments, the change was probably the &quot;right&quot; thing to do.  I&apos;ve contacted the author of lucene-ja, and I hope to work on a rewrite to address this.&lt;/p&gt;

&lt;p&gt;I would be interested in any comments you folks might have about the lucene-ja code.&lt;/p&gt;

&lt;p&gt;Class org.apache.lucene.analysis.ja.POSFilter&lt;br/&gt;
Extends org.apache.lucene.analysis.TokenFilter&lt;/p&gt;

&lt;p&gt;Offending code in lucene-ja&apos;s POSFilter&lt;br/&gt;
    public POSFilter(TokenStream in, Hashtable posTable) &lt;/p&gt;
{
        super(in);
        input = in; // &amp;lt;&amp;lt;==== this is a member field of parent TokenFilter
        table = posTable;
    }
&lt;p&gt;This is done in several classes.&lt;/p&gt;</comment>
                            <comment id="12762387" author="thetaphi" created="Mon, 5 Oct 2009 22:24:05 +0100"  >&lt;p&gt;This change is also noted in the backwards compatibility section of Lucene 2.9.&lt;/p&gt;

&lt;p&gt;The assignment of filter in the ctor is totally useless, as the super ctor does it already, so it the problem of this third party software that used the API in an undocumented way. I am sorry for your problems, but the author of lucene-ja should provide a fix, if you have the source code available, it is a less important problem, if it is closed source, you have to ask the author to fix it soon.&lt;/p&gt;</comment>
                            <comment id="12763303" author="mbennett" created="Thu, 8 Oct 2009 00:29:22 +0100"  >&lt;p&gt;Uwe,&lt;/p&gt;

&lt;p&gt;Your comments were a home run, thanks!&lt;/p&gt;

&lt;p&gt;There are 6 places in the code where constructors needlessly try to assign that.  Commenting them all out fixes that problem.&lt;/p&gt;

&lt;p&gt;There&apos;s some other stuff to clean up and I&apos;m chatting with the author.&lt;/p&gt;

&lt;p&gt;Thanks again,&lt;br/&gt;
Mark&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12408127" name="LUCENE-1636.patch" size="589" author="thetaphi" created="Thu, 14 May 2009 12:34:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 14 May 2009 10:22:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12122</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Lucene Fields</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxyqaf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26410</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>