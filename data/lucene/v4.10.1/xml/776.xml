<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:06:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-776/LUCENE-776.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[LUCENE-776] Use WeakHashMap instead of Hashtable in FSDirectory</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-776</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                    <description>&lt;p&gt;I was just reading the FSDirectory java code, then I found this :&lt;/p&gt;

&lt;p&gt;  /** This cache of directories ensures that there is a unique Directory&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;instance per path, so that synchronization on the Directory can be used to&lt;/li&gt;
	&lt;li&gt;synchronize access between readers and writers.&lt;br/&gt;
   *&lt;/li&gt;
	&lt;li&gt;This should be a WeakHashMap, so that entries can be GC&apos;d, but that would&lt;/li&gt;
	&lt;li&gt;require Java 1.2.  Instead we use refcounts...&lt;br/&gt;
   */&lt;br/&gt;
  private static final Hashtable DIRECTORIES = new Hashtable();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Since Lucene is now requiring at least 1.2 (for ThreadLocal for instance, which is using BTW some WeakHashMap), maybe it is time to change ?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12360470">LUCENE-776</key>
            <summary>Use WeakHashMap instead of Hashtable in FSDirectory</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="mikemccand">Michael McCandless</assignee>
                                    <reporter username="hibou">Nicolas Lalev&#233;e</reporter>
                        <labels>
                    </labels>
                <created>Sat, 13 Jan 2007 17:02:09 +0000</created>
                <updated>Tue, 27 Feb 2007 18:10:39 +0000</updated>
                            <resolved>Sun, 14 Jan 2007 22:14:28 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12464589" author="mikemccand" created="Sun, 14 Jan 2007 12:07:05 +0000"  >&lt;p&gt;Good catch!  And thanks for opening this.&lt;/p&gt;

&lt;p&gt;But: how would we actually use WeakHashMap here?&lt;/p&gt;

&lt;p&gt;With WeakHashMap, it&apos;s the keys that are the weak reference, so we&apos;d&lt;br/&gt;
need to have our FSDirectory instance be the keys (I think?).  But&lt;br/&gt;
then I don&apos;t see how we could cleanly &quot;look up&quot; a given key to see if&lt;br/&gt;
we already have an FSDirectory instance for the incoming canonical&lt;br/&gt;
path?&lt;/p&gt;

&lt;p&gt;Maybe instead we could keep the current Hashtable, but instead of&lt;br/&gt;
using the FSDirectory instance directly as the value, wrap it in a&lt;br/&gt;
WeakReference (and unwap on looking it up, later)?&lt;/p&gt;

&lt;p&gt;One other small concern is: the current &quot;reference counting&quot; approach&lt;br/&gt;
has nice &quot;immediacy&quot;.  Meaning once the final close() occurs on the&lt;br/&gt;
FSDirectory instance, it is immediately removed from the DIRECTORIES&lt;br/&gt;
hashtable.  Whereas, with a WeakReference, it would generally be a&lt;br/&gt;
much slower thing (I think?) because it&apos;s up to GC to decide when it&lt;br/&gt;
will actually be removed once only weak references remain?&lt;/p&gt;

&lt;p&gt;Though: even with the &quot;immediacy&quot; of reference counting, we still must&lt;br/&gt;
then wait for GC to actually clean up the FSDirectory instance we had&lt;br/&gt;
removed.  Worse, if that path is re-opened we would create another&lt;br/&gt;
FSDirectory instance (ie more garbage to be collected).  So, since we&lt;br/&gt;
must wait for GC anyway with our current reference counting solution,&lt;br/&gt;
I guess it is in fact better to have a WeakReference so that if a&lt;br/&gt;
given path is re-used, and it hasn&apos;t been GC&apos;d yet, we would re-use&lt;br/&gt;
it?&lt;/p&gt;</comment>
                            <comment id="12464601" author="karl.wettin" created="Sun, 14 Jan 2007 18:05:54 +0000"  >&lt;p&gt;Michael McCandless &lt;span class=&quot;error&quot;&gt;&amp;#91;14/Jan/07 04:07 AM&amp;#93;&lt;/span&gt;&lt;br/&gt;
&amp;gt; Good catch! And thanks for opening this.&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; But: how would we actually use WeakHashMap here?&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; With WeakHashMap, it&apos;s the keys that are the weak reference, so we&apos;d&lt;br/&gt;
&amp;gt; need to have our FSDirectory instance be the keys (I think?). But&lt;br/&gt;
&amp;gt; then I don&apos;t see how we could cleanly &quot;look up&quot; a given key to see if&lt;br/&gt;
&amp;gt; we already have an FSDirectory instance for the incoming canonical&lt;br/&gt;
&amp;gt; path? &lt;/p&gt;

&lt;p&gt;Not sure if this helps, but I just posted a SoftReferenceMap&amp;lt;K,V&amp;gt;.java in issue 550. Need to take a look at the license though, as it is based on something I found on the net. URL is in the javadoc. &lt;/p&gt;</comment>
                            <comment id="12464610" author="hibou" created="Sun, 14 Jan 2007 19:24:10 +0000"  >&lt;p&gt;I think you&apos;ve describe the problem completely Michael. When submitting this issue, I thought that the weak object in a WeakHashMap was the value of the map. So it appears that it is not done for that. About your last though, it is accurate because I think that most of the time, Lucene-based application are opening their directories at the same place.&lt;br/&gt;
My turn of though : we might have an issue if the table holds some reference that are not yet GCed. A directory is closed, &quot;manually&quot; cleaned up, and reopened with a different lock factory : this will fail with the IOException because of the still cached directory, conflicting because of its different lock factory. So the current design might be the best one in fact.&lt;/p&gt;</comment>
                            <comment id="12464626" author="mikemccand" created="Sun, 14 Jan 2007 22:10:14 +0000"  >&lt;p&gt;Karl, thanks for the offer, but we&apos;re still on JDK 1.4.x so far, so we&lt;br/&gt;
can&apos;t use that SoftReferenceMap&amp;lt;K,V&amp;gt; directly just yet (but it sounds&lt;br/&gt;
neat!).&lt;/p&gt;

&lt;p&gt;Oh good point Nicolas.  If we make this change it&apos;s actually a&lt;br/&gt;
semantic difference in the API in that previously you would get a&lt;br/&gt;
brand new FSDirectory but with this change you would get a &quot;recycled&quot;&lt;br/&gt;
one.  I agree it&apos;s safer to not do this.  I will update the comment to&lt;br/&gt;
remove the tantalizing reference to a WeakHashMap and then resolve.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="12464627" author="mikemccand" created="Sun, 14 Jan 2007 22:14:28 +0000"  >&lt;p&gt;Just updated the javadoc for FSDirectory.DIRECTORIES.&lt;/p&gt;</comment>
                            <comment id="12476284" author="mikemccand" created="Tue, 27 Feb 2007 18:10:39 +0000"  >&lt;p&gt;Closing all issues that were resolved for 2.1.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 14 Jan 2007 12:07:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12977</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Lucene Fields</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxyvlz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27272</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>