Fix exception handling and thread safety in realtime branch