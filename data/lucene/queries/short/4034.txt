improve functionquery tests, fix some minor bugs