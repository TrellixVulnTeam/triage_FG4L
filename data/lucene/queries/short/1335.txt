Correctly handle concurrent calls to addIndexes, optimize, commit