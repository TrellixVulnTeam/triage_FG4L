<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:24:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/MAHOUT-353/MAHOUT-353.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[MAHOUT-353] java.lang.NullPointerException in RecommenderMapper</title>
                <link>https://issues.apache.org/jira/browse/MAHOUT-353</link>
                <project id="12310751" key="MAHOUT">Mahout</project>
                    <description>&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.mahout.cf.taste.hadoop.item.RecommenderMapper$CooccurrenceCache.get(RecommenderMapper.java:169)&lt;br/&gt;
	at org.apache.mahout.cf.taste.hadoop.item.RecommenderMapper$CooccurrenceCache.get(RecommenderMapper.java:154)&lt;br/&gt;
	at org.apache.mahout.cf.taste.impl.common.Cache.getAndCacheValue(Cache.java:125)&lt;br/&gt;
	at org.apache.mahout.cf.taste.impl.common.Cache.get(Cache.java:94)&lt;br/&gt;
	at org.apache.mahout.cf.taste.hadoop.item.RecommenderMapper.map(RecommenderMapper.java:111)&lt;br/&gt;
	at org.apache.mahout.cf.taste.hadoop.item.RecommenderMapper.map(RecommenderMapper.java:52)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:50)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:358)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:307)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child.main(Child.java:170)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12460701">MAHOUT-353</key>
            <summary>java.lang.NullPointerException in RecommenderMapper</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srowen">Sean Owen</assignee>
                                    <reporter username="huiwenhan">Han Hui Wen </reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Mar 2010 14:48:05 +0100</created>
                <updated>Sun, 31 Oct 2010 15:49:17 +0000</updated>
                            <resolved>Thu, 1 Apr 2010 12:20:24 +0100</resolved>
                                    <version>0.4</version>
                                    <fixVersion>0.4</fixVersion>
                                    <component>Collaborative Filtering</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12851465" author="srowen" created="Tue, 30 Mar 2010 18:04:28 +0100"  >&lt;p&gt;I can fix the NPE (just did) but I think there is still an issue here. It&apos;s not able to load a column vector that was previously generated. Try it again now to gather more information as I look into it.&lt;/p&gt;</comment>
                            <comment id="12851525" author="everest" created="Tue, 30 Mar 2010 20:26:37 +0100"  >&lt;p&gt;My theory:&lt;/p&gt;

&lt;p&gt;The error happens at get(RecommenderMapper.java:169) &quot;value = map.get(key, columnVector).get();&quot; because columnVector is still unassigned.&lt;/p&gt;

&lt;p&gt;The columnVector init typically happens in the configure(JobConf jobConf) method of RecommenderMapper class.&lt;/p&gt;

&lt;p&gt;Reference to map(RecommenderMapper.java:111) is from run(MapRunner.java:50).&lt;/p&gt;

&lt;p&gt;Closer inspection of MapRunner.java shows the use of a mapper of class Mapper which RecommenderMapper implements. However, the method configure(JobConf jobConf) is never invoked on this mapper and hence the columnVector is never initialized. This would lead to NPE finally.&lt;/p&gt;

&lt;p&gt;Suggested modification: A check for cooccurrenceColumnCache==null in the map(RecommenderMapper.java:52)&lt;br/&gt;
OR&lt;br/&gt;
suitable corrections to MapRunner.java code.&lt;/p&gt;</comment>
                            <comment id="12851558" author="srowen" created="Tue, 30 Mar 2010 21:11:20 +0100"  >&lt;p&gt;It&apos;s not quite that &amp;#8211; columnVector is assigned in the constructor and is never null, so can&apos;t cause the NPE. It would be inside the call to get() anyhow if that&apos;s the case. columnVector is not initialized in configure(). configure() is def. called by the framework though I don&apos;t know exactly where. MapRunner isn&apos;t within our code in any event.&lt;/p&gt;</comment>
                            <comment id="12851581" author="everest" created="Tue, 30 Mar 2010 21:51:27 +0100"  >&lt;p&gt;columnVector is initialized in the CooccurrenceCache constructor which in turn in invoked in the configure() of RecommenderMapper at line 90 and used later as &quot;retriever&quot; in cooccurrencecache (which is of type Cache).&lt;/p&gt;

&lt;p&gt;So assuming that configure() IS invoked (without which columnVector wont be initialized), your observation of &quot;not able to load a column vector that was previously generated&quot; can be possibly inspected at the invocation of: cooccurrenceColumnCache = new Cache&amp;lt;IntWritable,Vector&amp;gt;(new CooccurrenceCache(cooccurrenceColumnMap), 100);&lt;/p&gt;

&lt;p&gt;Maybe decoupling this statement as below might help:&lt;br/&gt;
cocache = new CooccurrenceCache(cooccurrenceColumnMap);&lt;br/&gt;
cooccurrenceColumnCache = new Cache&amp;lt;IntWritable,Vector&amp;gt;(cooccurencecache, 100);&lt;/p&gt;

&lt;p&gt;where cocache be a class variable of RecommenderMapper of type CooccurrenceCache.&lt;/p&gt;

&lt;p&gt;Again, this is just a hunch! Sorry to disturb if it doesnt work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12851781" author="huiwenhan" created="Wed, 31 Mar 2010 10:02:59 +0100"  >&lt;p&gt;I run a few times ,get following error:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.mahout.cf.taste.impl.common.FastMap.put(FastMap.java:178)&lt;br/&gt;
	at org.apache.mahout.cf.taste.impl.common.Cache.getAndCacheValue(Cache.java:127)&lt;br/&gt;
	at org.apache.mahout.cf.taste.impl.common.Cache.get(Cache.java:94)&lt;br/&gt;
	at org.apache.mahout.cf.taste.hadoop.item.RecommenderMapper.map(RecommenderMapper.java:111)&lt;br/&gt;
	at org.apache.mahout.cf.taste.hadoop.item.RecommenderMapper.map(RecommenderMapper.java:52)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:50)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:358)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:307)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child.main(Child.java:170)&lt;/p&gt;
</comment>
                            <comment id="12851789" author="huiwenhan" created="Wed, 31 Mar 2010 10:38:09 +0100"  >&lt;p&gt;org.apache.mahout.cf.taste.impl.common.Cache&lt;/p&gt;

&lt;p&gt;  private V getAndCacheValue(K key) throws TasteException {&lt;br/&gt;
    V value = retriever.get(key);   //we may get null here,if so ,we can not put the value to cache (FastMap).&lt;br/&gt;
    synchronized (cache) &lt;/p&gt;
{
      cache.put(key, value);
    }&lt;br/&gt;
    return value;&lt;br/&gt;
  }&lt;br/&gt;
&lt;br/&gt;
so we need :&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
in  org.apache.mahout.cf.taste.impl.common.Cache&lt;br/&gt;
&lt;br/&gt;
  private V getAndCacheValue(K key) throws TasteException {&lt;br/&gt;
    V value = retriever.get(key);   //we may get null here,if so ,we can not put the value to cache (FastMap).&lt;br/&gt;
    if (value == null)&lt;br/&gt;
   {
       return null;
   }&lt;br/&gt;
    synchronized (cache) {
      cache.put(key, value);
    }
&lt;p&gt;    return value;&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;in RecommenderMapper:&lt;br/&gt;
   while (userVectorIterator.hasNext()) {&lt;br/&gt;
      Vector.Element element = userVectorIterator.next();&lt;br/&gt;
      int index = element.index();&lt;br/&gt;
      double value = element.get();&lt;br/&gt;
      Vector columnVector;&lt;br/&gt;
      try &lt;/p&gt;
{
        columnVector = cooccurrenceColumnCache.get(new IntWritable(index));
      }
&lt;p&gt; catch (TasteException te) {&lt;br/&gt;
        if (te.getCause() instanceof IOException) &lt;/p&gt;
{
          throw (IOException) te.getCause();
        }
&lt;p&gt; else &lt;/p&gt;
{
          throw new IOException(te.getCause());
        }
&lt;p&gt;      }&lt;br/&gt;
     if (columnVector !=null)&lt;/p&gt;
    {
         columnVector.times(value).addTo(recommendationVector);
    }

&lt;p&gt;    }&lt;/p&gt;</comment>
                            <comment id="12851815" author="srowen" created="Wed, 31 Mar 2010 11:58:44 +0100"  >&lt;p&gt;I can change Cache to handle null values, but I think it&apos;s just disguising another problem. The cache should never be unable to load the column vector, since it should have generated a column vector for all. This is the underlying issue.&lt;/p&gt;

&lt;p&gt;Actually... my implementation of Retriever in RecommenderMapper is wrong. It should never return null. It should treat this situation as an error and throw an exception, which would be clearer. I should really change it to do that.&lt;/p&gt;

&lt;p&gt;That doesn&apos;t solve the problem, but it makes it clearer where the problem is:&lt;/p&gt;

&lt;p&gt;I think there is perhaps some issue in MapFilesMap? If I had to guess, this is where the issue is. It should be reading from all the intermediate map files that an earlier stage outputs to find column vectors. The fact that it&apos;s not finding them suggests that&apos;s where the issue is.&lt;/p&gt;

&lt;p&gt;I don&apos;t have your data or your setup so have some difficulty debugging from here. If you are in a position to look into the code, can you examine whether MapFilesMap seems to find all of those map files correctly, read them, etc.?&lt;/p&gt;</comment>
                            <comment id="12851828" author="huiwenhan" created="Wed, 31 Mar 2010 12:52:35 +0100"  >&lt;p&gt;there has one situation:&lt;/p&gt;

&lt;p&gt;some user only has one item,&lt;br/&gt;
so in UserVectorToCooccurrenceMapper class&lt;br/&gt;
there is no output for this item ,&lt;/p&gt;

&lt;p&gt;so can not Retrieve the similar item for this item in RecommenderMapper.&lt;/p&gt;

&lt;p&gt;am I&#12288;right? &lt;/p&gt;</comment>
                            <comment id="12852317" author="srowen" created="Thu, 1 Apr 2010 11:19:52 +0100"  >&lt;p&gt;Ah... I think you are correct. Let me construct another fix tonight.&lt;/p&gt;</comment>
                            <comment id="12852343" author="srowen" created="Thu, 1 Apr 2010 12:20:24 +0100"  >&lt;p&gt;Tentatively resolving with Hui&apos;s final suggested change (just allow null column vector).&lt;/p&gt;</comment>
                            <comment id="12852704" author="huiwenhan" created="Fri, 2 Apr 2010 05:49:39 +0100"  >&lt;p&gt;it works now, very thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 30 Mar 2010 17:04:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9712</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxy5n3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23065</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>