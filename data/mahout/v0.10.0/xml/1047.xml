<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:21:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/MAHOUT-1047/MAHOUT-1047.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[MAHOUT-1047] CVB hangs after completion</title>
                <link>https://issues.apache.org/jira/browse/MAHOUT-1047</link>
                <project id="12310751" key="MAHOUT">Mahout</project>
                    <description>&lt;p&gt;After running the new LDA CVB implementation, it hangs and does not terminate the process like every other time I run Mahout&lt;/p&gt;

&lt;p&gt;Terminal output:&lt;/p&gt;


&lt;p&gt;12/07/19 11:38:49 INFO mapred.LocalJobRunner: &lt;br/&gt;
12/07/19 11:38:49 INFO mapred.Task: Task &apos;attempt_local_0022_m_000000_0&apos; done.&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:  map 100% reduce 0%&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient: Job complete: job_local_0022&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient: Counters: 8&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:   File Output Format Counters &lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     Bytes Written=2247793&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:   File Input Format Counters &lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     Bytes Read=1920337&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:   FileSystemCounters&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     FILE_BYTES_READ=1342812616&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     FILE_BYTES_WRITTEN=1326092302&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:   Map-Reduce Framework&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     Map input records=2772&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     Spilled Records=0&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     SPLIT_RAW_BYTES=140&lt;br/&gt;
12/07/19 11:38:49 INFO mapred.JobClient:     Map output records=2772&lt;br/&gt;
12/07/19 11:38:49 INFO driver.MahoutDriver: Program took 4089950 ms (Minutes: 68.16583333333334)&lt;/p&gt;

&lt;p&gt;$MAHOUT_HOME/mahout cvb -i /home/seth/Scripted/mahout_data/vectors/vectors/vectors-for-cvb/ -o /home/seth/Scripted/mahout_data/clusters/ -ow -k 90 -dt /home/seth/Scripted/mahout_data/distributions -dict /home/seth/Scripted/mahout_data/vectors/vectors/dictionary.file-0 -mt /home/seth/Scripted/mahout_data/temp/ -x 20 -cd 0.05&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu&lt;/p&gt;</environment>
        <key id="12599556">MAHOUT-1047</key>
            <summary>CVB hangs after completion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="smarthi">Suneel Marthi</assignee>
                                    <reporter username="seth">seth boyles</reporter>
                        <labels>
                            <label>cvb</label>
                            <label>lda</label>
                    </labels>
                <created>Fri, 20 Jul 2012 01:10:46 +0100</created>
                <updated>Mon, 3 Feb 2014 08:05:53 +0000</updated>
                            <resolved>Sat, 1 Jun 2013 19:21:02 +0100</resolved>
                                    <version>0.7</version>
                                    <fixVersion>0.8</fixVersion>
                                    <component>Clustering</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13419289" author="hazen" created="Fri, 20 Jul 2012 17:04:45 +0100"  >&lt;p&gt;Hey Seth, Thanks for the report. This is somewhat expected behavior, though it is definitely a bug-- There is a thread pool within the CVB implementation whose threads are not daemon threads and aren&apos;t halted cleanly at the end of a run, causing the jvm to hang after the main thread has terminated.&lt;/p&gt;</comment>
                            <comment id="13624758" author="kanjilal" created="Sun, 7 Apr 2013 07:58:43 +0100"  >&lt;p&gt;I&apos;d like to help out on this issue and will begin trying to repro and troubleshoot.&lt;/p&gt;</comment>
                            <comment id="13631091" author="jake.mannix" created="Sat, 13 Apr 2013 17:51:31 +0100"  >&lt;p&gt;So this should be in either ModelTrainer or TopicModel - both have thread pools, and I&apos;m not sure which one is causing the hang due to non-daemonization / cleanup.&lt;/p&gt;</comment>
                            <comment id="13633992" author="isabel" created="Wed, 17 Apr 2013 13:50:47 +0100"  >&lt;p&gt;Attached a hack^Wpatch that might help re-produce the issue:&lt;/p&gt;

&lt;p&gt;com.carrotsearch.randomizedtesting-runner tracks threads spawned during unit tests. I added RandomizedTest as parent class to our Mahout Test class, marked it such to not complain about leaking threads (there are a few test classes that do not join threads), enabled thread leakage tracking only for the TestCVBModelTrainer.&lt;/p&gt;

&lt;p&gt;The hack about the patch is adding the randomizedtesting-runner dependency to compile instead of to test scope in mahout/math.&lt;/p&gt;

&lt;p&gt;To use the patch: make sure you have compiled Mahout trunk at least once with &quot;mvn install&quot;, apply the patch with -p1. Than from the project root build at least mahout/math with &quot;mvn --projects math install&quot;, after that execute the tweaked test with &quot;mvn --projects core  -Dtest=TestCVBModelTrainer test&quot;. You should see complaints like the following in the output:&lt;/p&gt;

&lt;p&gt;Tests in error: &lt;br/&gt;
   &#187; ThreadLeak 32 threads leaked from TEST scope at testInMemoryCVB0(org.apache...&lt;br/&gt;
   &#187; ThreadLeak There are still zombie threads that couldn&apos;t be terminated:&lt;br/&gt;
   1...&lt;br/&gt;
   &#187; ThreadLeak 32 threads leaked from SUITE scope at org.apache.mahout.clusteri...&lt;br/&gt;
   &#187; ThreadLeak There are still zombie threads that couldn&apos;t be terminated:&lt;br/&gt;
   1...&lt;/p&gt;</comment>
                            <comment id="13640425" author="isabel" created="Wed, 24 Apr 2013 14:17:07 +0100"  >&lt;p&gt;Saikat, any luck with re-producing the issue?&lt;/p&gt;</comment>
                            <comment id="13640512" author="kanjilal" created="Wed, 24 Apr 2013 15:52:15 +0100"  >&lt;p&gt;My apologies, I&apos;ve been out on vacation, just getting back today,  I tried but cant seem to repro it locally with small dictionary files, will try to use your patch and larger disctionary files.  Also I noticed that in trunk I am running into errors when trying a clean install with maven, the only way to get past this is skipping tests,  have you gotten all tests to run successfully?&lt;/p&gt;</comment>
                            <comment id="13640684" author="isabel" created="Wed, 24 Apr 2013 18:28:27 +0100"  >&lt;p&gt;No need for apologies - just wanted to see if anything is blocking you.&lt;/p&gt;

&lt;p&gt;About the build - according to the last jenkings build (&amp;lt;&lt;a href=&quot;https://builds.apache.org/job/Mahout-Quality/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/Mahout-Quality/&lt;/a&gt;&amp;gt;) all should be fine. Which tests are failing for you?&lt;/p&gt;</comment>
                            <comment id="13640723" author="amartgon" created="Wed, 24 Apr 2013 18:55:56 +0100"  >&lt;p&gt;Hi,&lt;br/&gt;
I was trying cvb with the Reuters collection in local mode and it was hanging everytime. I looked into the problem for a while and then I found this bug report.&lt;br/&gt;
The problem was with TopicModel&apos;s pool, because it never got shutdown. This patch passes tests and Reuters clustering is not hanging anymore in my machine. Take it with some caution though, because I do not have a complete understanding of the cvb implementation yet.&lt;br/&gt;
Also, I did not mean to change the issue status, I was just trying to upload the patch...&lt;/p&gt;</comment>
                            <comment id="13640753" author="kanjilal" created="Wed, 24 Apr 2013 19:25:48 +0100"  >&lt;p&gt;Never mind, build is working again for me in trunk.   Angel I will apply your patch and retry locally , Isabel is it possible to test Angel&apos;s patch outside of a local environment on a hadoop cluster before it gets to Jenkins?&lt;/p&gt;</comment>
                            <comment id="13640832" author="jake.mannix" created="Wed, 24 Apr 2013 20:37:12 +0100"  >&lt;p&gt;So in general, I think this is the right approach, but looking in a little bit reminds me that in mapreduce mode (as in the original bug report status output at the top), &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;code&amp;#93;&lt;/span&gt;&lt;br/&gt;
public void train(VectorIterable matrix, VectorIterable docTopicCounts) {&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;code&amp;#93;&lt;/span&gt;&lt;br/&gt;
isn&apos;t used.  Instead, if you look in &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/mahout/blob/trunk/core/src/main/java/org/apache/mahout/clustering/lda/cvb/CachingCVB0Mapper.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/mahout/blob/trunk/core/src/main/java/org/apache/mahout/clustering/lda/cvb/CachingCVB0Mapper.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;you see that the ModelTrainer is instantiated and start()&apos;ed in mapper setup, then train() is called per document, then modelTrainer.stop() is called in cleanup.  So just like in this patch, where you call writeModel.stop(); this is probably necessary in the mapper too, or maybe a better place is inside of ModelTrainer.stop() - just make sure we delegate down the calls to stop() on the read/write models when the trainer is stopped too.&lt;/p&gt;</comment>
                            <comment id="13641084" author="amartgon" created="Wed, 24 Apr 2013 23:33:39 +0100"  >&lt;p&gt;Maybe I am missing something, but TopicModel.stop() is called inside ModelTrainer.stop(), just as you say.&lt;/p&gt;</comment>
                            <comment id="13641097" author="jake.mannix" created="Wed, 24 Apr 2013 23:40:08 +0100"  >&lt;p&gt;Ah yes.  So the critical new lines are:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;code&amp;#93;&lt;/span&gt;&lt;br/&gt;
+++ core/src/main/java/org/apache/mahout/clustering/lda/cvb/TopicModel.java&lt;/p&gt;

&lt;p&gt;+  public void stop() {&lt;br/&gt;
     for (Updater updater : updaters) &lt;/p&gt;
{
       updater.shutdown();
     }
&lt;p&gt;+    threadPool.shutdown();&lt;br/&gt;
+    try {&lt;br/&gt;
+      if (!threadPool.awaitTermination(60, TimeUnit.SECONDS)) &lt;/p&gt;
{
+        log.warn(&quot;Threadpool timed out on await termination - jobs still running!&quot;);
+      }
&lt;p&gt;+    } catch (InterruptedException e) &lt;/p&gt;
{
+        log.error(&quot;Interrupted shutting down!&quot;, e);
+    }
&lt;p&gt;   }&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;code&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;right?&lt;/p&gt;</comment>
                            <comment id="13641118" author="amartgon" created="Wed, 24 Apr 2013 23:59:36 +0100"  >&lt;p&gt;Yes, and then this new stop method is called for the readModel and the writeModel inside ModelTrainer.stop().&lt;br/&gt;
The readModel is reused as writeModel in the next iteration, and TopicModel.reset() is necessary for that.&lt;/p&gt;</comment>
                            <comment id="13641140" author="jake.mannix" created="Thu, 25 Apr 2013 00:14:23 +0100"  >&lt;p&gt;Well, the iterations are only when ModelTrainer#train(VectorIterable) is used, which is never in hadoop-mode, but yes, for InMemoryCollapsedVariationalBayes0, that would be useful.  Actually, is that method even used there.&lt;/p&gt;</comment>
                            <comment id="13641153" author="amartgon" created="Thu, 25 Apr 2013 00:26:02 +0100"  >&lt;p&gt;I added writeModel.reset() inside ModelTrainer.start(). This is unnecessary in hadoop-mode, but I think it does no harm. It is needed for InMemoryCollapsedVariationalBayes0.&lt;/p&gt;</comment>
                            <comment id="13641450" author="kanjilal" created="Thu, 25 Apr 2013 06:42:02 +0100"  >&lt;p&gt;I tested the initial patch implementation locally and tests work fine, however am wondering whether or not local testing by itself is sufficient for submitting this, let me know if I can help debug further or run more tests with a new patch.&lt;/p&gt;</comment>
                            <comment id="13672186" author="smarthi" created="Sat, 1 Jun 2013 19:04:08 +0100"  >&lt;p&gt;Tested this patch and committing to trunk.&lt;/p&gt;</comment>
                            <comment id="13672261" author="hudson" created="Sat, 1 Jun 2013 22:53:37 +0100"  >&lt;p&gt;Integrated in Mahout-Quality #2026 (See &lt;a href=&quot;https://builds.apache.org/job/Mahout-Quality/2026/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/Mahout-Quality/2026/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/MAHOUT-1047&quot; title=&quot;CVB hangs after completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAHOUT-1047&quot;&gt;&lt;del&gt;MAHOUT-1047&lt;/del&gt;&lt;/a&gt;: CVB hangs after completion (Revision 1488552)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
smarthi : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/mahout/trunk/CHANGELOG&lt;/li&gt;
	&lt;li&gt;/mahout/trunk/core/src/main/java/org/apache/mahout/clustering/lda/cvb/ModelTrainer.java&lt;/li&gt;
	&lt;li&gt;/mahout/trunk/core/src/main/java/org/apache/mahout/clustering/lda/cvb/TopicModel.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12579121" name="MAHOUT-1047-Show-Leak.patch" size="2903" author="isabel" created="Wed, 17 Apr 2013 13:50:47 +0100"/>
                            <attachment id="12580323" name="MAHOUT-1047.patch" size="3394" author="amartgon" created="Wed, 24 Apr 2013 18:55:56 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 20 Jul 2012 16:04:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243566</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxy1ef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22378</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>