<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:21:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/MAHOUT-1147/MAHOUT-1147.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[MAHOUT-1147] CVB Bug in CVB0Driver causes doc/topic distributions to be trained on random matrix</title>
                <link>https://issues.apache.org/jira/browse/MAHOUT-1147</link>
                <project id="12310751" key="MAHOUT">Mahout</project>
                    <description>&lt;p&gt;Problem:&lt;br/&gt;
When training doc/topic model no paths for the term/topic model found (outputs null).&lt;br/&gt;
These paths are set using setModelPaths in CVB0Driver.&lt;/p&gt;


&lt;p&gt;Reason for Problem:&lt;br/&gt;
Variety of Job instances call this method. &lt;br/&gt;
The Job is passed to the method instead of the Configuration object given to the Job.&lt;br/&gt;
The configuration is retrieved from the Job instance itself.&lt;br/&gt;
I believe that this Configuration instance is a clone of the original.&lt;br/&gt;
This is a problem as the variable MODEL_PATHS is set on the clone which is then discarded when the given Job is complete.&lt;br/&gt;
The original Configuration has no MODEL_PATHS String set and therefore returns null.&lt;br/&gt;
The code stipulates that if it cannot find a model to use a new random matrix. This happens every time as MODEL_PATHS is not set for the Configuration instance used.&lt;/p&gt;

&lt;p&gt;Solution:&lt;br/&gt;
Do not pass the Job to the setModels method, but pass the Configuration instance passed into the method which created the Job.&lt;br/&gt;
i.e.&lt;br/&gt;
change from:&lt;br/&gt;
setModelPaths(Job job, Path modelPath)&lt;/p&gt;

&lt;p&gt;to:&lt;br/&gt;
setModelPaths(Configuration conf, Path modelPath)&lt;/p&gt;

&lt;p&gt;And change all calling methods accordingly (obviously).&lt;/p&gt;

&lt;p&gt;So far what little testing I have done appears to solve this problem.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Eclipse IDE&lt;br/&gt;
Java code base&lt;br/&gt;
CVB0Driver Class&lt;br/&gt;
setModelPaths(Job job, Path modelPath) - method&lt;/p&gt;</environment>
        <key id="12630588">MAHOUT-1147</key>
            <summary>CVB Bug in CVB0Driver causes doc/topic distributions to be trained on random matrix</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jake.mannix">Jake Mannix</assignee>
                                    <reporter username="jp242@sussex.ac.uk">Jack Pay</reporter>
                        <labels>
                            <label>bug</label>
                            <label>cvb</label>
                            <label>fix</label>
                            <label>suggestion</label>
                    </labels>
                <created>Sun, 3 Feb 2013 21:17:10 +0000</created>
                <updated>Mon, 3 Feb 2014 08:06:05 +0000</updated>
                            <resolved>Tue, 11 Jun 2013 06:44:26 +0100</resolved>
                                    <version>0.7</version>
                                    <fixVersion>0.8</fixVersion>
                                    <component>Clustering</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="13618689" author="twinsken" created="Mon, 1 Apr 2013 09:12:53 +0100"  >&lt;p&gt;I&apos;ve made a patch for this issue&lt;/p&gt;</comment>
                            <comment id="13618774" author="jp242@sussex.ac.uk" created="Mon, 1 Apr 2013 14:35:14 +0100"  >&lt;p&gt;Fantastic. Thank you&lt;/p&gt;

</comment>
                            <comment id="13672557" author="robinanil" created="Sun, 2 Jun 2013 16:06:33 +0100"  >&lt;p&gt;Jake, this is on your side of the woods.&lt;/p&gt;</comment>
                            <comment id="13672604" author="jake.mannix" created="Sun, 2 Jun 2013 18:17:57 +0100"  >&lt;p&gt;Excellent, I&apos;ll look this over later tonight.&lt;/p&gt;</comment>
                            <comment id="13679174" author="gsingers" created="Sun, 9 Jun 2013 22:38:09 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jp242%40sussex.ac.uk&quot; class=&quot;user-hover&quot; rel=&quot;jp242@sussex.ac.uk&quot;&gt;Jack Pay&lt;/a&gt; Do you happen to have a test case that verifies this?&lt;/p&gt;</comment>
                            <comment id="13679184" author="gsingers" created="Sun, 9 Jun 2013 22:55:17 +0100"  >&lt;p&gt;I can&apos;t completely speak to correctness, but here&apos;s an updated patch that fixes formatting and handles the DistributedCache better.  &lt;/p&gt;

&lt;p&gt;Overall, the patch looks good, but I would like to see a test for it.&lt;/p&gt;</comment>
                            <comment id="13679777" author="jake.mannix" created="Mon, 10 Jun 2013 20:01:12 +0100"  >&lt;p&gt;So I&apos;m running cluster-reuters.sh with this patch added now, and unrelated to this patch, I&apos;m seeing that since I have a pseudo-distributed setup (hadoop running for real on my laptop), I&apos;m seeing that cluster-reuters.sh totally breaks in a silent and lame way: it unpacks the reuters data to a local directory, but then when it runs the vectorization jobs, they&apos;re running on hadoop, assuming that the paths which were unpacked locally with reuters data exist, but while /tmp/mahout-work-jake/reuters-out exists on the real FS, it isn&apos;t on HDFS, and the job &quot;tokenizes&quot; a bunch of empty vectors, creates an empty dictionary, and then tries to run LDA on the empty matrix, producing a bunch of empty topic models.  Silent empty failure.  Way lame.&lt;/p&gt;

&lt;p&gt;Appears to be running better now that I manually ran &quot;hadoop dfs -put /tmp/mahout-work-jake/reuters-out /tmp/mahout-work-jake&quot; before rerunning.&lt;/p&gt;</comment>
                            <comment id="13679817" author="gsingers" created="Mon, 10 Jun 2013 20:46:28 +0100"  >&lt;p&gt;Jake, are you up to date?  I fixed a bunch of things related to cluster-reuters.  Also, do you have HADOOP-HOME set?  Or MAHOUT-LOCAL?&lt;/p&gt;</comment>
                            <comment id="13679829" author="jake.mannix" created="Mon, 10 Jun 2013 20:52:51 +0100"  >&lt;p&gt;Totally fresh checkout, HADOOP_HOME is set (I can see that because it successfully runs on the &quot;cluster&quot; once I&apos;ve pushed reuters-out onto local HDFS.&lt;/p&gt;</comment>
                            <comment id="13679843" author="jake.mannix" created="Mon, 10 Jun 2013 21:11:22 +0100"  >&lt;p&gt;Hmmm:&lt;/p&gt;

&lt;p&gt;13/06/10 12:58:44 INFO cvb.CVB0Driver: About to run: Writing final topic/term distributions from /tmp/mahout-work-jake/reuters-lda-model/model-20 to /tmp/mahout-work-jake/reuters-lda&lt;br/&gt;
13/06/10 12:58:45 INFO input.FileInputFormat: Total input paths to process : 10&lt;br/&gt;
13/06/10 12:58:46 INFO cvb.CVB0Driver: About to run: Writing final document/topic inference from /tmp/mahout-work-jake/reuters-out-matrix/matrix to /tmp/mahout-work-jake/reuters-lda-topics&lt;br/&gt;
13/06/10 12:58:47 INFO input.FileInputFormat: Total input paths to process : 1&lt;br/&gt;
13/06/10 12:58:52 INFO mapred.JobClient: Running job: job_201306101136_0057&lt;br/&gt;
13/06/10 12:58:53 INFO mapred.JobClient:  map 0% reduce 0%&lt;br/&gt;
13/06/10 12:59:50 INFO mapred.JobClient:  map 20% reduce 0%&lt;br/&gt;
13/06/10 12:59:56 INFO mapred.JobClient:  map 40% reduce 0%&lt;br/&gt;
13/06/10 12:59:59 INFO mapred.JobClient:  map 60% reduce 0%&lt;br/&gt;
13/06/10 13:00:02 INFO mapred.JobClient:  map 80% reduce 0%&lt;br/&gt;
13/06/10 13:00:05 INFO mapred.JobClient:  map 100% reduce 0%&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient: Job complete: job_201306101136_0057&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient: Counters: 6&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:   Job Counters &lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:     Launched map tasks=10&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:     Data-local map tasks=10&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:   FileSystemCounters&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:     HDFS_BYTES_READ=6690610&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:     HDFS_BYTES_WRITTEN=6690610&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:   Map-Reduce Framework&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:     Map input records=20&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient:     Spilled Records=0&lt;br/&gt;
13/06/10 13:00:08 INFO mapred.JobClient: Running job: job_201306101136_0058&lt;br/&gt;
13/06/10 13:00:09 INFO mapred.JobClient:  map 0% reduce 0%&lt;br/&gt;
13/06/10 13:00:12 INFO mapred.JobClient:  map 100% reduce 0%&lt;br/&gt;
13/06/10 13:10:17 INFO mapred.JobClient: Task Id : attempt_201306101136_0058_m_000000_0, Status : FAILED&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.mahout.clustering.lda.cvb.CVB0DocInferenceMapper.cleanup(CVB0DocInferenceMapper.java:99)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:146)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:583)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:305)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child.main(Child.java:170)&lt;/p&gt;

&lt;p&gt;Task attempt_201306101136_0058_m_000000_0 failed to report status for 602 seconds. Killing!&lt;br/&gt;
13/06/10 13:10:18 INFO mapred.JobClient:  map 0% reduce 0%&lt;br/&gt;
13/06/10 13:10:27 INFO mapred.JobClient:  map 100% reduce 0%&lt;/p&gt;</comment>
                            <comment id="13679855" author="gsingers" created="Mon, 10 Jun 2013 21:19:00 +0100"  >&lt;p&gt;Hmm, I tested k-means cluster-reuters.sh last night on Hadoop single node and it worked fine.  I added a step to copy the reuters-out up to HDFS.  Let me make sure I pushed (see &lt;a href=&quot;https://issues.apache.org/jira/browse/MAHOUT-1247&quot; title=&quot;cluster-reuters doesn&amp;#39;t work on Hadoop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAHOUT-1247&quot;&gt;&lt;del&gt;MAHOUT-1247&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13679858" author="gsingers" created="Mon, 10 Jun 2013 21:19:55 +0100"  >&lt;p&gt;Do you see:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Extracting Reuters&quot;&lt;/span&gt;
    $MAHOUT org.apache.lucene.benchmark.utils.ExtractReuters ${WORK_DIR}/reuters-sgm ${WORK_DIR}/reuters-out
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; [ &lt;span class=&quot;code-quote&quot;&gt;&quot;$HADOOP_HOME&quot;&lt;/span&gt; != &lt;span class=&quot;code-quote&quot;&gt;&quot;&quot; ] &amp;amp;&amp;amp; [ &quot;&lt;/span&gt;$MAHOUT_LOCAL&lt;span class=&quot;code-quote&quot;&gt;&quot; == &quot;&lt;/span&gt;&quot; ] ; then
        echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Copying Reuters data to Hadoop&quot;&lt;/span&gt;
        set +e
        $HADOOP dfs -rmr ${WORK_DIR}/reuters-sgm
        $HADOOP dfs -rmr ${WORK_DIR}/reuters-out
        set -e
        $HADOOP dfs -put ${WORK_DIR}/reuters-sgm ${WORK_DIR}/reuters-sgm
        $HADOOP dfs -put ${WORK_DIR}/reuters-out ${WORK_DIR}/reuters-out
    fi
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, I&apos;m on #mahout on IRC if that helps us resolve this faster.&lt;/p&gt;</comment>
                            <comment id="13680218" author="jake.mannix" created="Tue, 11 Jun 2013 06:28:12 +0100"  >&lt;p&gt;So it looks like I&apos;ve got the bits you mention above, Grant, so you&apos;re right, it should have properly copied the data to HDFS.  I&apos;ll try again once I figure out the main bug of this ticket.&lt;/p&gt;</comment>
                            <comment id="13680230" author="jake.mannix" created="Tue, 11 Jun 2013 06:43:05 +0100"  >&lt;p&gt;Ok, this bug is totally reproducible, but also much easier to fix than the patch on this ticket, as it&apos;s a one-liner: the MODEL_PATH needs to be set on the Configuration for the job, right?  It&apos;s not that it&apos;s set on the wrong conf, it&apos;s just not set on this one at all:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: core/src/main/java/org/apache/mahout/clustering/lda/cvb/CVB0Driver.java
===================================================================
--- core/src/main/java/org/apache/mahout/clustering/lda/cvb/CVB0Driver.java	(revision 1491684)
+++ core/src/main/java/org/apache/mahout/clustering/lda/cvb/CVB0Driver.java	(working copy)
@@ -459,6 +459,7 @@
         modelUris[i] = statuses[i].getPath().toUri();
       }
       DistributedCache.setCacheFiles(modelUris, conf);
+      setModelPaths(job, modelInput);
     }
     FileInputFormat.addInputPath(job, corpus);
     FileOutputFormat.setOutputPath(job, output);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After stepping this through the debugger running in MAHOUT_LOCAL mode, I can verify that this correctly points the model paths in the right place for running doc-topic inference, and cluster_reuters does what we&apos;d like it too.&lt;/p&gt;</comment>
                            <comment id="13680232" author="jake.mannix" created="Tue, 11 Jun 2013 06:44:26 +0100"  >&lt;p&gt;Committed revision 1491694&lt;/p&gt;</comment>
                            <comment id="13680237" author="hudson" created="Tue, 11 Jun 2013 07:06:17 +0100"  >&lt;p&gt;Integrated in Mahout-Quality #2073 (See &lt;a href=&quot;https://builds.apache.org/job/Mahout-Quality/2073/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/Mahout-Quality/2073/&lt;/a&gt;)&lt;br/&gt;
    Fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/MAHOUT-1147&quot; title=&quot;CVB Bug in CVB0Driver causes doc/topic distributions to be trained on random matrix&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAHOUT-1147&quot;&gt;&lt;del&gt;MAHOUT-1147&lt;/del&gt;&lt;/a&gt;.  Just had to set the MODEL_PATHS on the doc-topic inference job (Revision 1491694)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
jmannix : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/mahout/trunk/core/src/main/java/org/apache/mahout/clustering/lda/cvb/CVB0Driver.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12586987" name="MAHOUT-1147.patch" size="4404" author="gsingers" created="Sun, 9 Jun 2013 22:55:17 +0100"/>
                            <attachment id="12576349" name="MAHOUT-1147.patch" size="4182" author="twinsken" created="Mon, 1 Apr 2013 09:12:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 1 Apr 2013 08:12:53 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311084</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzbjbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311432</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>