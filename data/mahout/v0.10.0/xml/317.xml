<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:22:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/MAHOUT-317/MAHOUT-317.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[MAHOUT-317] Collocations: Eliminate in-memory frequency calculation</title>
                <link>https://issues.apache.org/jira/browse/MAHOUT-317</link>
                <project id="12310751" key="MAHOUT">Mahout</project>
                    <description>&lt;p&gt;see: &lt;a href=&quot;http://www.lucidimagination.com/search/document/ae484d53e969250e/who_owns_mahout_bucket_on_s3&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.lucidimagination.com/search/document/ae484d53e969250e/who_owns_mahout_bucket_on_s3&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The collocation code currently uses maps in the CollocCombiner and CollocReducer to perform frequency calculations which can cause the process to exceed the heap space if a large number of ngrams exist for any given subgram.&lt;/p&gt;

&lt;p&gt;Convert the code to use a composite key / secondary sort to avoid the need for in-memory map for frequency calculations. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12457696">MAHOUT-317</key>
            <summary>Collocations: Eliminate in-memory frequency calculation</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="drew.farris">Drew Farris</assignee>
                                    <reporter username="drew.farris">Drew Farris</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 Mar 2010 05:21:31 +0000</created>
                <updated>Thu, 11 Mar 2010 02:14:48 +0000</updated>
                            <resolved>Sat, 6 Mar 2010 16:39:36 +0000</resolved>
                                    <version>0.3</version>
                                    <fixVersion>0.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12839553" author="drew.farris" created="Mon, 1 Mar 2010 05:27:24 +0000"  >&lt;p&gt;This patch addresses the original problem by using the Partitioner/OutputValueGroupingComparator to ensure that subgrams and ngrams are processed in the proper order in which to avoid having to store values in a hash when calculating frequencies.&lt;/p&gt;

&lt;p&gt;Submitting this patch to capture the current state of the fix. I suspect there&apos;s a optimization to be performed to reduce the output of CollocMapper, but in its current state this patch works and should address the problem.&lt;/p&gt;</comment>
                            <comment id="12839557" author="robinanil" created="Mon, 1 Mar 2010 05:50:22 +0000"  >&lt;p&gt;GramTuple class is missing in the patch&lt;/p&gt;</comment>
                            <comment id="12839668" author="drew.farris" created="Mon, 1 Mar 2010 13:03:28 +0000"  >&lt;p&gt;oops. &lt;/p&gt;

&lt;p&gt;Attached is the fixed patch.  &lt;/p&gt;

&lt;p&gt;In the light of day it becomes clear that this is pretty inefficient. GramTuple isn&apos;t the right way to do this. The compound key used in the first pass doesn&apos;t need to hold the value at all, simply the original key which will be grouped upon in the reducer and something else (a byte) to specify the secondary sort order. The compound key and group comparator should also implement binary comparable to avoid the need to unmarshal to compare.&lt;/p&gt;

&lt;p&gt;I will work this up submit another patch, I&apos;m merely including this one for reference.&lt;/p&gt;</comment>
                            <comment id="12839688" author="ankur" created="Mon, 1 Mar 2010 14:28:46 +0000"  >&lt;p&gt;You can also make some gains by using a simple Combiner to reduce the amount on ngrams and subgrams from the mappers. The OutputValueGroupingComparator is not applied in the map-phase so Combiner gets all the values for a particular ngrams/subgram. Package o.a.m.cf.taste.hadoop.cooccurence has a Bigram class that implements binary comparison.&lt;/p&gt;</comment>
                            <comment id="12839998" author="drew.farris" created="Tue, 2 Mar 2010 03:51:09 +0000"  >&lt;p&gt;Replaced GramTuple with GramKey which achieves the same end in a more efficient manner; it implements BinaryComparable.&lt;/p&gt;

&lt;p&gt;There doesn&apos;t seem to be a good way around including the full string in the key for the secondary sort, in this patch it is stored in a alongside the string from the primary gram in a single byte[]. Separate offsets are maintained for the end of the primary key and the full length to support grouping.&lt;/p&gt;

&lt;p&gt;Ankur mentioned the use of a combiner, but one is already included in the patch, Ankur if what you have is mind is substantially different from what&apos;s already there, please elaborate.&lt;/p&gt;


</comment>
                            <comment id="12840434" author="robinanil" created="Wed, 3 Mar 2010 02:58:42 +0000"  >&lt;p&gt;When i profile it I see more time spent in the spill thread, in sort and gramKey.readfields.&lt;br/&gt;
My dictionary seems to have increased 10x in size. from 2 to 20 MB for all bigrams with llr &amp;gt; 1&lt;br/&gt;
I also see some junk tokens &quot;01.01&quot; upto &quot;0.9.99&quot;  in the output. I dont think they are from the reuters dataset. &lt;/p&gt;</comment>
                            <comment id="12840456" author="robinanil" created="Wed, 3 Mar 2010 04:38:45 +0000"  >&lt;p&gt;The increase in size was because minSupport pruning wasnt there. I added it. Still at the same setting the output seems a bit different from the earlier one. (some hundred words more @ ~1.2MB dictionary size) &lt;br/&gt;
The spill thread problem is still there&lt;/p&gt;</comment>
                            <comment id="12840462" author="ankur" created="Wed, 3 Mar 2010 04:55:55 +0000"  >&lt;p&gt;&amp;gt; Ankur mentioned the use of a combiner, &lt;br/&gt;
Aah! I missed that it was there already. Sorry, please ignore my comments.&lt;/p&gt;</comment>
                            <comment id="12840468" author="ankur" created="Wed, 3 Mar 2010 05:14:10 +0000"  >&lt;p&gt;To minimize the spill issuse you&apos;ll have to play with &lt;/p&gt;

&lt;p&gt;1. Increasing the JVM max heap size of the mapper.&lt;br/&gt;
2. Increasing sort buffer size (io.sort.mb, typically defaults to 256 MB). This can be increased to a larger size if user&apos;s mapper does not consume too much memory. &lt;br/&gt;
3. Increasing spill threshold (io.sort.spill.percent, typically defaults to 80% of the above bufer). Try setting in to 90 %.&lt;/p&gt;</comment>
                            <comment id="12840597" author="drew.farris" created="Wed, 3 Mar 2010 12:00:52 +0000"  >&lt;p&gt;Thanks for trying it out Robin. I&apos;ll take a closer look.&lt;/p&gt;</comment>
                            <comment id="12841052" author="drew.farris" created="Thu, 4 Mar 2010 04:32:58 +0000"  >&lt;p&gt;re-added missing minSupport, thanks for pointing this out Robin.&lt;/p&gt;

&lt;p&gt;Fixed a bug that was causing the new code to produce different output from the original. Performed a regression test on the 20news dataset &amp;#8211; the output produced by the original code and the output produced by the new code is now identical.&lt;/p&gt;

</comment>
                            <comment id="12842273" author="drew.farris" created="Sat, 6 Mar 2010 16:39:36 +0000"  >&lt;p&gt;Committed in r919798&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12437843" name="MAHOUT-317.patch" size="46352" author="drew.farris" created="Thu, 4 Mar 2010 04:32:58 +0000"/>
                            <attachment id="12437571" name="MAHOUT-317.patch" size="45818" author="drew.farris" created="Tue, 2 Mar 2010 03:51:09 +0000"/>
                            <attachment id="12437479" name="MAHOUT-317.patch" size="36191" author="drew.farris" created="Mon, 1 Mar 2010 13:03:28 +0000"/>
                            <attachment id="12437443" name="MAHOUT-317.patch" size="26143" author="drew.farris" created="Mon, 1 Mar 2010 05:27:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 1 Mar 2010 05:50:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9748</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxy5v3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23101</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>