This is the large patch I promised/threatened on the mahout-dev mailing list.