<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:45:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-562/OPENJPA-562.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-562] NPE when trying to invoke FieldMetada.getOrders() when a PersistenCollection field is being loaded.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-562</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Consider the following snippet of an entity definition:&lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;Entity used to test parsing of @OrderBy.&amp;lt;/p&amp;gt;&lt;br/&gt;
 *&lt;/li&gt;
	&lt;li&gt;@author Abe White&lt;br/&gt;
 */&lt;br/&gt;
@Entity&lt;br/&gt;
public class OrderByEntity 
{

    @Id
    private long id;
    private String string;

    @PersistentCollection
    @OrderBy
    private List&amp;lt;String&amp;gt; strings = new ArrayList();

}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The @PersistentCollection annotation maps the declaration to the default collection table named orderbyentity_strings. The join column name in the container table is also defaulted to orderbyentity_id and the name of the Element column name is defaulted to element. &lt;/p&gt;

&lt;p&gt;The test code initially added string elements to the strings list and persisted it.&lt;/p&gt;

&lt;p&gt;        OrderByEntity pc = new OrderByEntity();&lt;br/&gt;
        pc.setId(1L);&lt;br/&gt;
        pc.getStrings().add(&quot;2&quot;);&lt;br/&gt;
        pc.getStrings().add(&quot;1&quot;);&lt;br/&gt;
        pc.getStrings().add(&quot;3&quot;);&lt;/p&gt;

&lt;p&gt;On a subsequent load of the persistent collection data by executing the following code, we hit into an NPE.&lt;/p&gt;

&lt;p&gt;        pc = em.find(OrderByEntity.class, 1L);&lt;br/&gt;
        List&amp;lt;String&amp;gt; strings = pc.getStrings();&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
at org.apache.openjpa.meta.FieldMetaData.getOrders(FieldMetaData.java:1127)&lt;br/&gt;
at org.apache.openjpa.jdbc.meta.strats.StoreCollectionFieldStrategy.selectEager(StoreCollectionFieldStrategy.java:207)&lt;br/&gt;
at org.apache.openjpa.jdbc.meta.strats.StoreCollectionFieldStrategy.selectEagerJoin(StoreCollectionFieldStrategy.java:171)&lt;br/&gt;
at org.apache.openjpa.jdbc.meta.FieldMapping.selectEagerJoin(FieldMapping.java:713)&lt;br/&gt;
at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.select(JDBCStoreManager.java:927)&lt;br/&gt;
at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.load(JDBCStoreManager.java:503)&lt;br/&gt;
at org.apache.openjpa.kernel.DelegatingStoreManager.load(DelegatingStoreManager.java:116)&lt;br/&gt;
at org.apache.openjpa.datacache.DataCacheStoreManager.load(DataCacheStoreManager.java:368)&lt;br/&gt;
at org.apache.openjpa.kernel.DelegatingStoreManager.load(DelegatingStoreManager.java:116)&lt;br/&gt;
at org.apache.openjpa.kernel.ROPStoreManager.load(ROPStoreManager.java:78)&lt;br/&gt;
at org.apache.openjpa.kernel.StateManagerImpl.loadFields(StateManagerImpl.java:2911)&lt;br/&gt;
at org.apache.openjpa.kernel.StateManagerImpl.loadField(StateManagerImpl.java:2989)&lt;br/&gt;
at kodo.kernel.ProfilingStateManager.loadField(ProfilingStateManager.java:68)&lt;br/&gt;
at org.apache.openjpa.kernel.StateManagerImpl.beforeAccessField(StateManagerImpl.java:1489)&lt;br/&gt;
at kodo.kernel.ProfilingStateManager.beforeAccessField(ProfilingStateManager.java:49)&lt;br/&gt;
at org.apache.openjpa.kernel.StateManagerImpl.accessingField(StateManagerImpl.java:1474)&lt;/p&gt;

&lt;p&gt;This problem is reported with OpenJPA version:&lt;/p&gt;

&lt;p&gt;$ java org.apache.openjpa.conf.OpenJPAVersion&lt;br/&gt;
OpenJPA 1.1.0-SNAPSHOT&lt;br/&gt;
version id: openjpa-1.1.0-SNAPSHOT-r420667:634150&lt;br/&gt;
Apache svn revision: 420667:634150&lt;/p&gt;

&lt;p&gt;os.name: Windows XP&lt;br/&gt;
os.version: 5.1&lt;br/&gt;
os.arch: x86&lt;/p&gt;

&lt;p&gt;java.version: 1.6.0_05&lt;br/&gt;
java.vendor: BEA Systems, Inc.&lt;/p&gt;

&lt;p&gt;The NPE occurs when the FieldMetadata.getOrders() method is invoked when trying to load the data in the strings collection field. The code is trying to get the ClassMetadata for the element type and then check the FieldMetadata is present in the declared fields. It fails because the element data type is java.lang.String and there is no ClassMetadata for it. By simply adding a null check for the returned class metadata this issue I could fix locally.&lt;/p&gt;

&lt;p&gt;Here is the outout of the svn diff command.&lt;/p&gt;

&lt;p&gt;C:\apache_openjpa_project\openjpa&amp;gt;svn diff&lt;br/&gt;
Index: openjpa-kernel/src/main/java/org/apache/openjpa/meta/FieldMetaData.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; openjpa-kernel/src/main/java/org/apache/openjpa/meta/FieldMetaData.java&lt;br/&gt;
(revision 643944)&lt;br/&gt;
+++ openjpa-kernel/src/main/java/org/apache/openjpa/meta/FieldMetaData.java&lt;br/&gt;
(working copy)&lt;br/&gt;
@@ -1124,9 +1124,11 @@&lt;br/&gt;
                     //set &quot;isUsedInOrderBy&quot; to the field&lt;br/&gt;
                     ClassMetaData elemCls = getElement()&lt;br/&gt;
                         .getDeclaredTypeMetaData();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FieldMetaData fmd = elemCls.getDeclaredField(decs&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;);&lt;/li&gt;
	&lt;li&gt;if (fmd != null)&lt;/li&gt;
	&lt;li&gt;fmd.setUsedInOrderBy(true);&lt;br/&gt;
+                    if (elemCls != null) 
{
+                      FieldMetaData fmd = elemCls.getDeclaredField(decs[i]);
+                      if (fmd != null)
+                        fmd.setUsedInOrderBy(true);
+                    }
&lt;p&gt;                 }&lt;br/&gt;
                 _orders = orders;&lt;br/&gt;
             }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>This error occured on Microsoft Windows XP SP2, Java version = 1.6.0 with mySQL 5.0 Database.</environment>
        <key id="12393460">OPENJPA-562</key>
            <summary>NPE when trying to invoke FieldMetada.getOrders() when a PersistenCollection field is being loaded.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sandeeps@bea.com">Sandeep Shrivastava</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Apr 2008 22:35:42 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:49 +0000</updated>
                            <resolved>Tue, 8 Apr 2008 23:36:41 +0100</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="12586973" author="sandeeps@bea.com" created="Tue, 8 Apr 2008 22:41:37 +0100"  >&lt;p&gt;The patch containing the fix for this issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12379687" name="openjpa-1.1.0-SNAPSHOT-r420667.634150.patch" size="1042" author="sandeeps@bea.com" created="Tue, 8 Apr 2008 22:41:37 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160878</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyswt3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202663</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>