<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:38:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-497/OPENJPA-497.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-497] Incorect handling of temporal parameters in queries</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-497</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;The entity:&lt;br/&gt;
For an entity:&lt;br/&gt;
@Entity&lt;br/&gt;
class Log{&lt;br/&gt;
	protected Timestamp startTime;&lt;br/&gt;
}&lt;br/&gt;
given the query&lt;br/&gt;
SELECT al FROM Log al WHERE al.startTime BETWEEN :start AND :end ORDER BY al.id ASC&lt;br/&gt;
If the query is used as:&lt;br/&gt;
query.setParameter(&quot;start&quot;, start, TemporalType.TIMESTAMP);&lt;br/&gt;
query.setParameter(&quot;end&quot;, end, TemporalType.TIMESTAMP);&lt;br/&gt;
where start and end are of type java.util.Date, an exception will be thrown:&lt;/p&gt;

&lt;p&gt;org.apache.openjpa.persistence.ArgumentException: The parameter&lt;br/&gt;
&quot;start&quot; is of type &quot;java.util.Date&quot;, but the declaration in the query&lt;br/&gt;
is for type &quot;java.sql.Timestamp&quot;.&lt;br/&gt;
	at org.apache.openjpa.persistence.QueryImpl.validateParameter(QueryImpl.java:270)&lt;br/&gt;
	at org.apache.openjpa.persistence.QueryImpl.validateParameters(QueryImpl.java:257)&lt;/p&gt;

&lt;p&gt;OpenJPA appears to ignore the temporal indications in setParameter because QueryImpl is as this:&lt;br/&gt;
public OpenJPAQuery setParameter(int position, Date value,&lt;br/&gt;
   TemporalType type) {&lt;br/&gt;
   return setParameter(position, value);&lt;br/&gt;
}&lt;br/&gt;
The Date parameter should be converted to Timestamp inside setParameter method.&lt;/p&gt;</description>
                <environment>Java 1.6&lt;br/&gt;
Glassfish v2&lt;br/&gt;
openjpa-1.0.1-r420667</environment>
        <key id="12386583">OPENJPA-497</key>
            <summary>Incorect handling of temporal parameters in queries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ppoddar@apache.org">Pinaki Poddar</assignee>
                                    <reporter username="likewise">Mircea Lazar</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Jan 2008 08:11:05 +0000</created>
                <updated>Thu, 22 Apr 2010 21:32:45 +0100</updated>
                            <resolved>Sat, 2 Aug 2008 15:00:01 +0100</resolved>
                                    <version>1.0.1</version>
                                    <fixVersion>1.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12560432" author="allee8285" created="Fri, 18 Jan 2008 15:27:40 +0000"  >&lt;p&gt;java.sql.Timestamp extends java.util.Date.  You can use a Timestamp as if it is a Date object but not the other way around because there are other attributes in Timestamp object that  Date object does not have.  Declare start and end as java.sql.Timestamp and try again.&lt;/p&gt;

&lt;p&gt;Albert Lee.&lt;/p&gt;</comment>
                            <comment id="12560661" author="likewise" created="Sat, 19 Jan 2008 06:51:42 +0000"  >&lt;p&gt;The query works as is in other JPA providers(Reference implementation, Hibernate). If not for conversion, what would be the purpose of that TemporalType param then? The reason of this conversion is to not have the business code depending on java.sql but rather on java.util.Date .&lt;/p&gt;

&lt;p&gt;Mircea&lt;/p&gt;</comment>
                            <comment id="12560715" author="clr" created="Sat, 19 Jan 2008 17:17:01 +0000"  >&lt;p&gt;Hi Mircea,&lt;/p&gt;

&lt;p&gt;I agree with your interpretation of the purpose of that TemporalType param. OpenJPA should convert the parameter given to the appropriate TemporalType.&lt;/p&gt;

&lt;p&gt;Of course, it would be nice if the specification were a bit more discursive on this topic. And if the TCK had a test.&lt;/p&gt;</comment>
                            <comment id="12560738" author="clr" created="Sat, 19 Jan 2008 22:19:42 +0000"  >&lt;p&gt;This patch doesn&apos;t fix the problem but reorganizes the code for a fix.&lt;/p&gt;

&lt;p&gt;The method convertTemporalType probably belongs in a utility package, but which one? It uses the TemporalType class which is defined in JPA but the implementation will depend on the JDBC type package. There doesn&apos;t seem to be any good place for the utility method. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;So, should convertTemporalType be moved to the JPA JDBC project, or should the method refer to utility functions in the JPA JDBC project? Or something else?&lt;/p&gt;

&lt;p&gt;Index: trunk/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; trunk/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java	(revision 613460)&lt;br/&gt;
+++ trunk/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java	(working copy)&lt;br/&gt;
@@ -416,15 +416,19 @@&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     public OpenJPAQuery setParameter(int position, Calendar value,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TemporalType t) {&lt;/li&gt;
	&lt;li&gt;return setParameter(position, value);&lt;br/&gt;
+        TemporalType type) 
{
+        return setParameter(position, convertTemporalType(value, type));
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public OpenJPAQuery setParameter(int position, Date value,&lt;br/&gt;
         TemporalType type) &lt;/p&gt;
{
-        return setParameter(position, value);
+        return setParameter(position, convertTemporalType(value, type));
     }

&lt;p&gt;+    protected Object convertTemporalType(Object parameter, TemporalType type) &lt;/p&gt;
{
+        return parameter;
+    }
&lt;p&gt;+&lt;br/&gt;
     public OpenJPAQuery setParameter(int position, Object value) {&lt;br/&gt;
         _query.assertOpen();&lt;br/&gt;
         _em.assertNotCloseInvoked();&lt;/p&gt;
</comment>
                            <comment id="12561114" author="clr" created="Mon, 21 Jan 2008 20:14:08 +0000"  >&lt;p&gt;Please review this patch.&lt;/p&gt;

&lt;p&gt;I don&apos;t know if the conversion method belongs here or in a different utility class. &lt;/p&gt;

&lt;p&gt;The specification is unclear as to what the appropriate conversions should be, but what&apos;s done here seems to be consistent with what other implementations do.&lt;/p&gt;

&lt;p&gt;I haven&apos;t written any tests to check for correctness. Where should the tests go?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12381890">OPENJPA-434</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12383754">OPENJPA-457</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12373699" name="openjpa-497.patch" size="4303" author="clr" created="Mon, 21 Jan 2008 20:14:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 18 Jan 2008 15:27:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160814</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7kwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>288357</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>