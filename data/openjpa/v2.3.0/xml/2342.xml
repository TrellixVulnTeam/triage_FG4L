<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:43:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2342/OPENJPA-2342.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2342] Consider modifying PCEnhancer.run to use serp.bytecode.BCClass.getDeclaredInterfaceNames instead of getDeclaredInterfaceTypes.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2342</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Caused by: &amp;lt;openjpa-2.2.2-SNAPSHOT-r422266:1446295 nonfatal general error&amp;gt; org.apache.openjpa.util.GeneralException: An error occurred while enhancing itemjpa.ItemJPA. Exception message: java.lang.ClassNotFoundException: org.apache.aries.proxy.weaving.WovenProxy&lt;br/&gt;
&#160;&#160;&#160; at org.apache.openjpa.enhance.PCEnhancer.run(PCEnhancer.java:578)&lt;br/&gt;
&#160;&#160;&#160; at org.apache.openjpa.enhance.PCClassFileTransformer.transform0(PCClassFileTransformer.java:153)&lt;br/&gt;
&#160;&#160;&#160; at org.apache.openjpa.enhance.PCClassFileTransformer.transform(PCClassFileTransformer.java:126)&lt;br/&gt;
&#160;&#160;&#160; at org.apache.openjpa.persistence.PersistenceProviderImpl$ClassTransformerImpl.transform(PersistenceProviderImpl.java:290)&lt;br/&gt;
&#160;&#160;&#160; at org.apache.aries.jpa.container.weaving.impl.WrappingTransformer.transform(WrappingTransformer.java:80)&lt;br/&gt;
&#160;&#160;&#160; at org.apache.aries.jpa.container.weaving.impl.JPAWeavingHook.weave(JPAWeavingHook.java:71)&lt;br/&gt;
&#160;&#160;&#160; ... 48 more&lt;br/&gt;
Caused by: java.lang.IllegalArgumentException: java.lang.ClassNotFoundException: org.apache.aries.proxy.weaving.WovenProxy&lt;br/&gt;
&#160;&#160;&#160; at serp.util.Strings.toClass(Strings.java:164)&lt;br/&gt;
&#160;&#160;&#160; at serp.util.Strings.toClass(Strings.java:108)&lt;br/&gt;
&#160;&#160;&#160; at serp.bytecode.BCClass.getDeclaredInterfaceTypes(BCClass.java:740)&lt;br/&gt;
&#160;&#160;&#160; at org.apache.openjpa.enhance.PCEnhancer.run(PCEnhancer.java:537)&lt;br/&gt;
&#160;&#160;&#160; ... 53 more&lt;/p&gt;

&lt;p&gt;This issue occurs when the Apache Aries Proxy weaving hook gets called before the Apache Aries JPA weaving hook. Proxy weaves the class with the WovenProxy interface and adds the necessary dynamic package imports. JPA then gets called and uses PCEnhancer which, in turn, calls BCClass.getDeclaredInterfaceTypes, which ultimately calls Class.forName using the woven interface&apos;s name. The class loader is from the bundle whose class is being woven. Per the OSGi spec, dynamic imports do not take effect until after the entire weaving process is complete. Consequently, the bundle&apos;s class loader does not yet have visibility to the class.&lt;/p&gt;

&lt;p&gt;One solution to this, at least in the Aries case, is to order the weaving hook calls using the osgi service ranking property. However, all weaving hook services with potential conflicts may not be under the control of the same entity.&lt;/p&gt;

&lt;p&gt;Basically, PCEnhancer.run is using the information from BCClass to determine whether or not the class has already been woven. It&apos;s only interested in knowing if the PersistenceCapable interface is there. It seems that BCClass.getDeclaredInterfaceNames avoids the Class.forName call and could be used instead, particularly considering that only the class names are compared.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12634444">OPENJPA-2342</key>
            <summary>Consider modifying PCEnhancer.run to use serp.bytecode.BCClass.getDeclaredInterfaceNames instead of getDeclaredInterfaceTypes.</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwsutter">Kevin Sutter</assignee>
                                    <reporter username="jwross@us.ibm.com">John Ross</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Feb 2013 16:58:11 +0000</created>
                <updated>Mon, 15 Apr 2013 21:22:35 +0100</updated>
                            <resolved>Mon, 15 Apr 2013 21:22:35 +0100</resolved>
                                    <version>2.2.2</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Enhance</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13588797" author="kwsutter" created="Wed, 27 Feb 2013 21:34:03 +0000"  >&lt;p&gt;Nice debugging effort on this JIRA.  Thanks.  The change you are suggesting sounds benign.  The code in this area is a little confusing, since we get access to the ClassLoader, but then never seem to use it except as a parameter for Trace logging.  Even the processing in the getDeclaredInterfaceTypes() when it does the classloading doesn&apos;t use the ClassLoader from the caller.&lt;/p&gt;

&lt;p&gt;Since none of us know the complete history of this part and what the original intent of this processing was, I&apos;m a little hesitant on making this change without more testing.  So far, the JUnit bucket is looking good.  Let me think about it a bit more and get back with you.&lt;/p&gt;

&lt;p&gt;I would feel more comfortable with making this change in trunk (2.3.0-SNAPSHOT) and let it go through some cycles first.  Would that work for you?  Thanks.&lt;/p&gt;</comment>
                            <comment id="13590178" author="jwross@us.ibm.com" created="Fri, 1 Mar 2013 02:08:52 +0000"  >&lt;p&gt;Yes, that&apos;s fine. Thank you.&lt;/p&gt;</comment>
                            <comment id="13597885" author="struberg" created="Sat, 9 Mar 2013 08:45:19 +0000"  >&lt;p&gt;Another option would be to use build time enhancement with the openjpa-maven-plugin. At least until there is a final solution.&lt;/p&gt;

&lt;p&gt;I did some hacking on the SERP part in the past and I&apos;d say we should (long term) completely drop it and use ASM instead.&lt;br/&gt;
We know how the target classes shall look like (by using a java decompiler) and it&apos;s not that complex.&lt;/p&gt;</comment>
                            <comment id="13615560" author="jira-bot" created="Wed, 27 Mar 2013 18:00:03 +0000"  >&lt;p&gt;Commit 1461751 from kwsutter&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1461751&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1461751&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-2342&quot; title=&quot;Consider modifying PCEnhancer.run to use serp.bytecode.BCClass.getDeclaredInterfaceNames instead of getDeclaredInterfaceTypes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-2342&quot;&gt;&lt;del&gt;OPENJPA-2342&lt;/del&gt;&lt;/a&gt;.  Changed to use the getDeclaredInterfaceNames instead of getDeclaredInterfaceTypes.  All testing is looking good and should alleviate the problem of the classloading.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12572623" name="openjpa-2342.patch" size="944" author="kwsutter" created="Thu, 7 Mar 2013 22:06:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Feb 2013 21:34:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314937</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzc73b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315281</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>