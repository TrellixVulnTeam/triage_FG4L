<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:41:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-679/OPENJPA-679.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-679] java.lang.ArrayIndexOutOfBoundsException may occur when a relation field is annotated as a primary key and a foreign key</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-679</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;&amp;lt;openjpa-1.2.0-SNAPSHOT-rexported nonfatal general error&amp;gt;&lt;br/&gt;
org.apache.openjpa.persistence.PersistenceException: 0&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:196)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.kernel.DelegatingBrokerFactory.newBroker(DelegatingBrokerFactory.java:142)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:192)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:145)&lt;br/&gt;
....&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.ArrayIndexOutOfBoundsException: 0&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.jdbc.sql.DBDictionary.getForeignKeyConstraintSQL(DBDictionary.java:3373)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.jdbc.sql.DBDictionary.getAddForeignKeySQL(DBDictionary.java:3252)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.jdbc.schema.SchemaTool.addForeignKey(SchemaTool.java:1066)&lt;br/&gt;
    at org.apache.openjpa.jdbc.schema.SchemaTool.add(SchemaTool.java:604)&lt;br/&gt;
    at org.apache.openjpa.jdbc.schema.SchemaTool.add(SchemaTool.java:344)&lt;br/&gt;
    at org.apache.openjpa.jdbc.schema.SchemaTool.run(SchemaTool.java:321)&lt;br/&gt;
    at org.apache.openjpa.jdbc.meta.MappingTool.record(MappingTool.java:501)&lt;br/&gt;
    at org.apache.openjpa.jdbc.meta.MappingTool.record(MappingTool.java:453)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.jdbc.kernel.JDBCBrokerFactory.synchronizeMappings(JDBCBrokerFactory.java:159)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.jdbc.kernel.JDBCBrokerFactory.newBrokerImpl(JDBCBrokerFactory.java:119)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:189)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12401930">OPENJPA-679</key>
            <summary>java.lang.ArrayIndexOutOfBoundsException may occur when a relation field is annotated as a primary key and a foreign key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="faywang">Fay Wang</assignee>
                                    <reporter username="faywang">Fay Wang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Aug 2008 22:32:30 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:55 +0000</updated>
                            <resolved>Tue, 24 Mar 2009 00:51:39 +0000</resolved>
                                                    <fixVersion>1.2.1</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12620757" author="faywang" created="Thu, 7 Aug 2008 22:38:26 +0100"  >&lt;p&gt;This problem is found by Gopalakrishnan U. A JIRA is open on behalf on him. This problem may happen when a relation field is annotated as both a primary key and a foreign key. When Openjpa resolves the class matedata, it first resolves the primary keys of all the entities in the persistent unit. After the primary keys of all the entities are resolved, it then goes ahead to resolve the non-relation field. It is normally in the stage of resolving non-relation fields that the foreign key is constructed.&lt;/p&gt;

&lt;p&gt;Since  a relation field is a primary key, it gets resolved in the first stage. However, since it is also a relation field, the foreign key construction is triggered when setting the strategy  to this field. If the primary key information of the parent entity is not yet available, some of the foreign key fields will be missing. If it happens that the primary key information of the parent entity is already resolved (just as some experiment shows by manipulating the entity class name so that the primary key of the parent entity gets resolved first before the child entity), then the foreign key constructed in this stage will be good and complete.&lt;/p&gt;
</comment>
                            <comment id="12620769" author="faywang" created="Thu, 7 Aug 2008 23:06:22 +0100"  >&lt;p&gt;The attached patch will force the field mapping in question to be resolved again after the primary keys of all the entities in the persistent unit are resolved. Any comments are mostly appreciated. A test case will be attached shortly.&lt;/p&gt;</comment>
                            <comment id="12621102" author="faywang" created="Sat, 9 Aug 2008 01:20:30 +0100"  >&lt;p&gt;The patch is based on the most updated ClassMapping.java&lt;/p&gt;</comment>
                            <comment id="12621546" author="fancy" created="Mon, 11 Aug 2008 19:46:07 +0100"  >&lt;p&gt;Hi All,&lt;br/&gt;
Attaching a test scenario provided by Gopalakrishnan U that  reproduced the ArrayIndexOutOfBoundsException in OpenJPA .&lt;/p&gt;

&lt;p&gt;The problem is in resolving foreignkey for the following annotation in CM class of the testcase:&lt;/p&gt;

&lt;p&gt;@Entity&lt;br/&gt;
@IdClass(CM.CMId.class)&lt;br/&gt;
public class CM {&lt;/p&gt;

&lt;p&gt;    @ManyToOne&lt;br/&gt;
    @ForeignKey&lt;br/&gt;
    @Id&lt;br/&gt;
    private E e;&lt;/p&gt;

&lt;p&gt;Notice that the ManyToOne relation is annotated as @ForeignKey and @Id,  &lt;br/&gt;
OpenJpa failed in resolving the  foreignKey mapping for CM entity.&lt;/p&gt;

&lt;p&gt;Gopal worked around this problem by &lt;br/&gt;
rename class C to class WC&lt;br/&gt;
rename class CM to WCM&lt;/p&gt;

&lt;p&gt;OpenJPA revolves class mapping in the alphabetic order of entity names.&lt;br/&gt;
As you see that by renaming C to WC and CM to WCM, the entity class E gets resolved first, hence, the forigenKey field e in CM gets resolved correctly.&lt;/p&gt;

&lt;p&gt;Fay&apos;s patch is to making sure that foreignKey mapping is resolved no matter to in what  the order we resolve the entities.&lt;/p&gt;
</comment>
                            <comment id="12621565" author="faywang" created="Mon, 11 Aug 2008 20:42:00 +0100"  >&lt;p&gt;The attached openjpa test case is based on the original test case provided by Gopalakrishnan U.&lt;/p&gt;</comment>
                            <comment id="12621697" author="fancy" created="Tue, 12 Aug 2008 06:17:46 +0100"  >&lt;p&gt;Fix checked in under r685042&lt;/p&gt;</comment>
                            <comment id="12679998" author="mikedd" created="Sun, 8 Mar 2009 18:04:00 +0000"  >&lt;p&gt;This issue causes problems with the reverse mapping tool. To reproduce the problem just run the reversemapping example..&lt;/p&gt;

&lt;p&gt;I&apos;m reopening the issue to either fix the problem or revert to the original behavior. &lt;/p&gt;</comment>
                            <comment id="12680375" author="faywang" created="Tue, 10 Mar 2009 04:37:46 +0000"  >&lt;p&gt;This patch will fix the ReverseMappingTool problem.&lt;/p&gt;</comment>
                            <comment id="12680476" author="mikedd" created="Tue, 10 Mar 2009 14:36:28 +0000"  >&lt;p&gt;Thanks for the updated patch Fay. I&apos;m testing the fix on 1.2.1 now. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12401802" name="OPENJPA-679.patch" size="3314" author="faywang" created="Tue, 10 Mar 2009 04:37:46 +0000"/>
                            <attachment id="12387977" name="identifying_rel_test.zip" size="26821" author="fancy" created="Mon, 11 Aug 2008 19:46:07 +0100"/>
                            <attachment id="12387773" name="openjpa_679.patch" size="4278" author="faywang" created="Thu, 7 Aug 2008 23:06:22 +0100"/>
                            <attachment id="12387860" name="openjpa_679_1.patch" size="4272" author="faywang" created="Sat, 9 Aug 2008 01:20:29 +0100"/>
                            <attachment id="12387984" name="testcase_679.patch" size="27071" author="faywang" created="Mon, 11 Aug 2008 20:42:00 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 11 Aug 2008 18:46:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160991</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt25r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>203530</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>