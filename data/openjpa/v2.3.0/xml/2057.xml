<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:31:24 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2057/OPENJPA-2057.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2057] Rethinking ClassLoading architecture </title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2057</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;This issue proposes an overhaul of the classloading architecture.&lt;/p&gt;

&lt;p&gt;Background:&lt;br/&gt;
------------------&lt;br/&gt;
OpenJPA runtime needs to load classes and resources at various time points in its life cycle and employs various classloading strategies at different parts of its code base. &lt;br/&gt;
These are few broad categories of classes/resources OpenJPA needs to load&lt;br/&gt;
1. Resources: user-specified resources such as persistence.xml or orm.xml&lt;br/&gt;
2. Persistent Domain classes&lt;br/&gt;
3. Native Plug-ins: Implementation of interfaces e.g. UpdateManager that are supplied by OpenJPA and packaged in its own distribution&lt;br/&gt;
4. User Plug-ins: Implementation of interfaces e.g. MappingStrategy or ValueHandlers that the user has supplied via configuration and packaged in deployed units&lt;br/&gt;
5. Temporary classloader for java agent or weaving code loading domain classes to enhance them prior to their use&lt;/p&gt;

&lt;p&gt;To load these different artifacts by their name, OpenJPA at different places employ available classloaders such as &lt;br/&gt;
   i) the current thread&apos;s context class loader &lt;br/&gt;
   ii) the clasloader that loaded OpenJPA native classes/interfaces &lt;br/&gt;
  iii) the classloader that loaded a deployed application which can vary based on the container (Spring, OSGi, JEE) environment&lt;br/&gt;
  iv) system classloader   &lt;/p&gt;

&lt;p&gt;The problem is the decision about which classloader is appropriate in a given context is quite scattered. This weakness appears in numerous places where a method is supplied with a ClassLoader and if the supplied loader is null, the method chooses a classloader (often the context classloader) or a class has its own classforname() method that tries a series of classloaders etc. &lt;/p&gt;

&lt;p&gt;This is a perennial problem and manifested in several reported bugs whose resolutions often introduced further localized logic to account for the point defects, thereby  accentuating the same trends that I believe is the root cause of the problem itself. &lt;/p&gt;

&lt;p&gt;Proposed solution/design:&lt;br/&gt;
-------------------------------------&lt;br/&gt;
Unify classloading decision in a singular abstraction. &lt;br/&gt;
Allow that abstraction to cope with classloading regimes of different containers (Spring, OSGi, JEE etc). &lt;/p&gt;

&lt;p&gt;The natural candidate for unifying classloading is existing Configuration object. This object is a per persistence unit singleton and available throughout the runtime. &lt;br/&gt;
However, certain class/resource loading must take place even before a Configuration instance is instantiated. For example, to locate and load the persistence.xml itself. &lt;br/&gt;
Also note that the persistence.xml or orm.xml may contain fully-qualified names of persistent domain classes or  plug-in names (both native and custom/user variety) and they can occur either by their  fully-qualified class name or registered alias. The specialized parsers often has to load the class given their parsed string names or aliases. &lt;/p&gt;

&lt;p&gt;The bootstrap sequence of OpenJPA runtime is to construct a specific ConfigurationProvider and a series of specialized parsers to parse meta-data of various sorts (annotations, mapping xml, persistence.xml). These ConfigurationProviders are responsibilities of ProductDerivation &amp;#8211; the core mechanics that contributes their individual aspects to build up a Configuration. &lt;/p&gt;

&lt;p&gt;Given this existing well-designed bootstrap strategy, here is a proposal&lt;br/&gt;
  1. Let each ProductDerivation make their decision on how they will load whatever they need to load using whatever classloader they may need. For example, a OSGi ProductDerivation will use a bundle classloader to load its relevant resources. This phase occurs &lt;b&gt;before&lt;/b&gt; a persistence unit (i.e. EntityManagerFactory) is constructed.&lt;br/&gt;
  2. Once the ProductDerivations have finished their loading using their own ConfigurationProvider, they transfer the accumulated information to a Configuration instance which essentially becomes the holder of entire runtime information for an EntityManagerFactory. During this transfer phase, let the ProductDerivations set the classloader as well into the Configuration instance.&lt;br/&gt;
  3. Once the Configuration instance has the classloader, this classloader is used throughout the codebase.&lt;/p&gt;

&lt;p&gt;But what kind of classloader is used by the Configuration that will suit complex needs of class/resource loading? &lt;br/&gt;
OpenJPA already has a powerful abstraction called MultiClassLoader which can employ an ordered series of (possibly unrelated) classloaders. So that MultiClassLoader is the correct classloader for Configuration instance. The ProductDerivation or ConfigurationProvider can add/remove their contributions. &lt;/p&gt;

&lt;p&gt;I understand that a change of this nature could be destabilizing in short-term. Also the change is difficult to validate across various container environments. I hope the community users will help by suggesting and testing such an overhaul to streamline OpenJPA classloading for long-term sustainability and maintenance. &lt;/p&gt;


</description>
                <environment></environment>
        <key id="12526684">OPENJPA-2057</key>
            <summary>Rethinking ClassLoading architecture </summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="ppoddar@apache.org">Pinaki Poddar</assignee>
                                    <reporter username="ppoddar@apache.org">Pinaki Poddar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Oct 2011 17:09:16 +0100</created>
                <updated>Tue, 11 Nov 2014 14:51:59 +0000</updated>
                                                                            <component>kernel</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13144738" author="curtisr7" created="Sat, 5 Nov 2011 16:16:42 +0000"  >&lt;p&gt;This change broke a number of our internal tests.... I spoke with Pinaki, and we agreed that I would back this change out while we investigate the failures.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="13182258" author="struberg" created="Sun, 8 Jan 2012 17:58:01 +0000"  >&lt;p&gt;Rick, Pinaki, is there a branch where this got applied?&lt;br/&gt;
I basically think that we need to do this step at some point.&lt;br/&gt;
Do you plan to continue working on this?&lt;/p&gt;</comment>
                            <comment id="13182624" author="curtisr7" created="Mon, 9 Jan 2012 16:53:04 +0000"  >&lt;p&gt;Mark -&lt;/p&gt;

&lt;p&gt;I had to back these changes out of trunk because it broke lots of internal tests and we didn&apos;t have the time to investigate all of them. I believe the intent is to put these changes back in sometime after we cut a 2.2.x branch.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="13615330" author="curtisr7" created="Wed, 27 Mar 2013 14:43:51 +0000"  >&lt;p&gt;Assigning back to Pinaki.... hopefully we can get to this piece of work in the near future.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12754473">OPENJPA-2542</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 5 Nov 2011 16:16:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59325</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz0plj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248154</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>