<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:36:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2149/OPENJPA-2149.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2149] Criteria.function adds wrong casts to parameters making it unsuable</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2149</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Criteria.function will generate an SQL with only the last parameter casted and to the wrong type.&lt;br/&gt;
		Expression&amp;lt;String&amp;gt; stPointFunc = cb.function(&lt;br/&gt;
				&quot;db2gse.st_point&quot;, &lt;br/&gt;
				String.class,&lt;br/&gt;
				cb.literal(0.0),&lt;br/&gt;
				cb.literal(0.0),&lt;br/&gt;
				cb.literal(1003));&lt;/p&gt;

&lt;p&gt;		Expression&amp;lt;Double&amp;gt; distanceFunc = cb.function(&lt;br/&gt;
				&quot;db2gse.st_distance&quot;, &lt;br/&gt;
				Double.class, &lt;br/&gt;
				stPointFunc, &lt;br/&gt;
				usersLocations.get(&quot;location&quot;));&lt;/p&gt;

&lt;p&gt;		criteriaQuery.select(usersLocations).where(cb.lessThan(distanceFunc, cb.literal(50.0)));&lt;/p&gt;

&lt;p&gt;Will generate the following SQL:&lt;br/&gt;
(db2gse.st_distance(db2gse.st_point(?, ?, CAST(? AS DOUBLE)), t0.LOCATION) &amp;lt; ?)&lt;/p&gt;

&lt;p&gt;Notice the 3rd parameter is an Integer and its being cast as Double.&lt;br/&gt;
The problem is in org.apache.openjpa.jdbc.kernel.exps.DatastoreFunction#appendTo&lt;/p&gt;

&lt;p&gt;Line 54:  args.appendTo(sel, ctx, state, sql, 0);&lt;br/&gt;
Will append 3 ? to the sql buffer: &quot;(db2gse.st_distance(db2gse.st_point(?, ?, ?&quot;&lt;/p&gt;

&lt;p&gt;Then the loop in line 56-58&lt;br/&gt;
            for (int i = 1; i &amp;lt; vals.length; i++) &lt;/p&gt;
{
                sql.addCastForParam(getOperator(), vals[i]);
            }
&lt;p&gt;It becomes: &quot;(db2gse.st_distance(db2gse.st_point(?, ?, CAST(? AS DOUBLE)&quot;&lt;/p&gt;


&lt;p&gt;Starts with 1 (second parameter and not the first one), whil sql.addCastForParam only works for the last ? in the sql buffer, meaning the cast for the param at index 1 is added to the last ? and the method will not do anything else.&lt;/p&gt;

&lt;p&gt;This issue leaves Criteria.function useless to me, I tried extending my DBDictionary to remove all the cast as a work around but the function became ambiguous.&lt;/p&gt;

&lt;p&gt;Thanks in advance.&lt;/p&gt;

&lt;p&gt;Found a temporary (working but ugly) workaround:&lt;br/&gt;
		Expression&amp;lt;String&amp;gt; stPointFunc = cb.function(&lt;br/&gt;
				&quot;db2gse.st_point&quot;, &lt;br/&gt;
				String.class,&lt;br/&gt;
				cb.coalesce(cb.literal(0.0), cb.literal(0.0)),&lt;br/&gt;
				cb.coalesce(cb.literal(1.0), cb.literal(1.0)),&lt;br/&gt;
				cb.coalesce(cb.literal(1003), cb.literal(1003)));&lt;/p&gt;

&lt;p&gt;coalesce uses raw value instead of parameters and makes it work (the same value twice becuase if I put cb.nullLiteral I get a NullPointerException, might be another bug)&lt;/p&gt;</description>
                <environment>Standalone 2.0.0 and 2.0.1 downloaded from openjpa website, and on WebSphere 7 JPA2 feature pack 1.0.0.5 (contains OpenJPA 2.0.2)</environment>
        <key id="12545137">OPENJPA-2149</key>
            <summary>Criteria.function adds wrong casts to parameters making it unsuable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="allee8285">Albert Lee</assignee>
                                    <reporter username="aviramsegal">Aviram Segal</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Mar 2012 07:50:18 +0000</created>
                <updated>Fri, 24 Aug 2012 03:35:00 +0100</updated>
                            <resolved>Fri, 24 Aug 2012 03:34:53 +0100</resolved>
                                    <version>2.0.1</version>
                    <version>2.0.2</version>
                    <version>2.1.1</version>
                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>criteria</component>
                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                        <attachments>
                            <attachment id="12531985" name="OPENJPA-2149-2.0.x.patch" size="3563" author="allee8285" created="Wed, 13 Jun 2012 16:38:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230323</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysr8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>201761</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>