<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:45:21 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-285/OPENJPA-285.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-285] Multiple deploy/undeploy leaks memory in PCRegistry</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-285</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Kevin Miller reported:&lt;br/&gt;
Geronimo is running out of PermGen space in some simple deploy/ undeploy scenarios involving OpenJPA. The cause of the problem seems to be the _metas table in PCRegistry. _metas is a ConcurrentReferenceHashMap with WEAK reference keys and HARD reference values. The keys are the PersistenceCapable classes. While the values are the metadata for these classes which are maintained by the internal Meta class.&lt;/p&gt;

&lt;p&gt;The cause of the ClassLoader memory leak is simple &amp;#8211; if any of the objects/classes held by the Meta class (e.g. fieldTypes) have also been loaded by the same ClassLoader used to load the PersistenceCapable class, the PersistenceCapable class (the weak key) will never be GCed. The value of the HashMap entry will always maintain a hard reference to the ClassLoader. Since the ClassLoader will never be GC&apos;ed, the the the pcClass Class object will never be GC&apos;able...&lt;/p&gt;

&lt;p&gt;The problem can be easily recreated using current Geronimo trunk and the Geronimo Daytrader application.&lt;/p&gt;

&lt;p&gt;Patrick Linskey suggested:&lt;br/&gt;
Change PCRegistry.fieldTypes to be String[] instead of Class[], and dematerialize them as needed.&lt;/p&gt;

&lt;p&gt;Robert Burrell Donkin/Marc Prud&apos;hommeaux  both pointed out that alternatives such as to&lt;br/&gt;
listen for the death of a ClassLoader and manually unregistering metadata would be more costly in terms of complexity.&lt;/p&gt;

&lt;p&gt;This patch follows Patrick&apos;s suggestion.&lt;br/&gt;
1. Changes the Meta.fieldTypes to String[] from Class[]&lt;br/&gt;
2. Adapts the enhanced bytecode accordingly to the modified method signatures&lt;br/&gt;
3. PCRegistry getFieldTypes() load the fields&apos; declared type using the same loader that loaded the owner pc class. &lt;/p&gt;

&lt;p&gt;Note: For a class C and its field f,  CL(c) == CL(f) is not always true. (Kevin Miller)&lt;br/&gt;
          But CL(c) will be able to load declared type of f  either directly or via one of its parent (Craig Russel)&lt;/p&gt;</description>
                <environment>Geronimo 2.0</environment>
        <key id="12373956">OPENJPA-285</key>
            <summary>Multiple deploy/undeploy leaks memory in PCRegistry</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwsutter">Kevin Sutter</assignee>
                                    <reporter username="ppoddar@apache.org">Pinaki Poddar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jul 2007 07:29:30 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:36 +0000</updated>
                            <resolved>Wed, 1 Aug 2007 23:03:50 +0100</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.0.0</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12513164" author="ppoddar@apache.org" created="Tue, 17 Jul 2007 07:35:59 +0100"  >&lt;p&gt;This patch &lt;br/&gt;
1. Changes Meta.fieldTypes from Class[] to String[]&lt;br/&gt;
2. Adjusts PCEnhancer to the modified method signature&lt;br/&gt;
3. Loads each field&apos;s type in PCRegistry.getFieldTypes() using the classloader of pc class &lt;/p&gt;

&lt;p&gt;Tested for regression against OpenJPA testcases.&lt;br/&gt;
Performance hit is a concern.&lt;/p&gt;
</comment>
                            <comment id="12513301" author="ppoddar@apache.org" created="Tue, 17 Jul 2007 18:45:33 +0100"  >&lt;p&gt;Would it be possible to run this patch in Geronimo environment?&lt;/p&gt;

&lt;p&gt;This patch &lt;br/&gt;
1. changes all field types of Class to String in PCRegistry$Meta&lt;br/&gt;
2. Retains all method signature the same. The constructor of Meta translates all input Class arguments to their stringfied form &lt;br/&gt;
3. Reverts all changes of the earlier patch in PCEnhancer&lt;br/&gt;
4. The class names held in PCRegistry$Meta are converted to Classes in PCRegistry. The classloader used to load these classes is always the same classloader that loaded the user-defined persistence capable class.  &lt;/p&gt;

</comment>
                            <comment id="12516181" author="kevan" created="Sat, 28 Jul 2007 21:30:26 +0100"  >&lt;p&gt;I&apos;m attaching a potential fix for this problem. It adds a PCRegistry.deRegister(ClassLoader) method. It allows Geronimo to inform OpenJPA when a ClassLoader is no longer valid. deRegister() simply iterates through all entries in the _metas map and removes all entries whose keys were loaded by the associated ClassLoader. If you don&apos;t like iterating though all of the _metas tables, it&apos;s a simple matter to maintain a set of Classes associated with each ClassLoader. I like the simplicity of it iterating. ClassLoaders are removed on an infrequent basis.&lt;/p&gt;

&lt;p&gt;I&apos;ve tested this change along with associated Geronimo changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/GERONIMO-3326&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GERONIMO-3326&lt;/a&gt;. I&apos;ve been through 100&apos;s of deploy/undeploy cycles without a problem...&lt;/p&gt;

&lt;p&gt;The problem with other solutions (WeakReferences or Stringified Class names) is that PCRegistry$Meta.pc must be a hard reference. It is your only reference to the PersistenceCapable object. If it is a WeakReference, the PersistenceCapable object will be GC&apos;ed and bad things start to happen... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;There&apos;s one other solution, which could be considered: Allow embedders to be notified when you&apos;ve created PersistenceCapable objects. Embedders could maintain the strong references to these objects and delete the references when a ClassLoader has been deleted. PCRegistry references could then be WeakReferences.&lt;/p&gt;
</comment>
                            <comment id="12516183" author="kevan" created="Sat, 28 Jul 2007 21:38:20 +0100"  >&lt;p&gt;Found another ClassLoader memory leak caused by ImplHelper. This one is pretty straight forward.&lt;/p&gt;

&lt;p&gt;Will be doing a bit more testing...&lt;/p&gt;</comment>
                            <comment id="12516869" author="drwoods" created="Wed, 1 Aug 2007 06:08:50 +0100"  >&lt;p&gt;Is there any chance we can get this into the 1.0.0 stream before 8/3, which is when we will start the final TCK runs for Geronimo 2.0?&lt;/p&gt;</comment>
                            <comment id="12517091" author="kwsutter" created="Wed, 1 Aug 2007 23:00:41 +0100"  >&lt;p&gt;Don and Kevan,&lt;br/&gt;
I just went ahead with the integration of Kevan&apos;s patches into OpenJPA.  Per the e-mail conversation that we had about these changes, I am still a little hesitant with the new PCRegistry.deRegister() method.  But, as you have pointed out, there haven&apos;t been any other solutions suggested that resolve the problem.  Although this solution puts the responsibility on the embedder of OpenJPA, it does provide the necessary communication between the Embedder and OpenJPA that this particular class loader is no longer required.&lt;/p&gt;

&lt;p&gt;I have no concerns with Kevan&apos;s other patch for the ImplHelper to use a ConcurrentReferenceHashMap.&lt;/p&gt;

&lt;p&gt;Thanks for digging into these problems and providing these patches.&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12517092" author="kwsutter" created="Wed, 1 Aug 2007 23:03:49 +0100"  >&lt;p&gt;Resolved per the discussion on the dev mailing list (&lt;a href=&quot;http://www.nabble.com/PCRegistry-ClassLoader-memory-leak-tf4091308.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/PCRegistry-ClassLoader-memory-leak-tf4091308.html&lt;/a&gt;) and this Issue.&lt;/p&gt;</comment>
                            <comment id="12517094" author="kwsutter" created="Wed, 1 Aug 2007 23:05:41 +0100"  >&lt;p&gt;Also, the two other patches attached to this Issue (JIRA-285.patch.txt and JIRA-285.patch.2.txt) are not being included in this commit processing.  Neither of these were deemed to resolve the problem as originally reported.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12362727" name="ImplHelperClassLoaderMemoryLeak.patch" size="833" author="kevan" created="Sat, 28 Jul 2007 21:38:20 +0100"/>
                            <attachment id="12361993" name="JIRA-285.patch.2.txt" size="5262" author="ppoddar@apache.org" created="Tue, 17 Jul 2007 18:45:33 +0100"/>
                            <attachment id="12361957" name="JIRA-285.patch.txt" size="7474" author="ppoddar@apache.org" created="Tue, 17 Jul 2007 07:35:59 +0100"/>
                            <attachment id="12362726" name="PCRegistryClassLoaderMemoryLeak.patch" size="1036" author="kevan" created="Sat, 28 Jul 2007 21:30:25 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 28 Jul 2007 20:30:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>42051</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyswcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>