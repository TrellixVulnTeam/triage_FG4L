<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:30:19 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-557/OPENJPA-557.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-557] Primary key sequences broken with postgres schemas</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-557</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;as per &lt;a href=&quot;http://www.nabble.com/forum/ViewPost.jtp?post=15460899&amp;amp;framed=y&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/forum/ViewPost.jtp?post=15460899&amp;amp;framed=y&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;OpenJPA issues a SELECT currval(&apos;user_id_seq&apos;); query to get the current PK value on postgres. This should &lt;b&gt;not&lt;/b&gt; execute correctly when using a schema. The correct query is SELECT currval(&apos;schemaname.user_id_seq&apos;);&lt;/p&gt;</description>
                <environment></environment>
        <key id="12393093">OPENJPA-557</key>
            <summary>Primary key sequences broken with postgres schemas</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rogerkeays">Roger Keays</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Apr 2008 08:13:41 +0100</created>
                <updated>Tue, 9 Mar 2010 18:31:01 +0000</updated>
                            <resolved>Wed, 24 Dec 2008 00:23:45 +0000</resolved>
                                    <version>1.0.2</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0-M2</fixVersion>
                                    <component>jdbc</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12585428" author="rogerkeays" created="Fri, 4 Apr 2008 08:14:48 +0100"  >&lt;p&gt;Here is my patch for OpenJPA 1.0.2. You might prefer to move the code to the superclass though.&lt;/p&gt;

&lt;p&gt;Index: openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java      (revision 641780)&lt;br/&gt;
+++ openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java      (working copy)&lt;br/&gt;
@@ -149,6 +149,21 @@&lt;br/&gt;
             &quot;STORE&quot;, &quot;VACUUM&quot;, &quot;VERBOSE&quot;, &quot;VERSION&quot;,&lt;br/&gt;
         }));&lt;br/&gt;
     }&lt;br/&gt;
+    &lt;br/&gt;
+    /**&lt;br/&gt;
+     * Prepend schema names to sequence names if there is one. This&lt;br/&gt;
+     * method does not escape reserved words in the schema name or&lt;br/&gt;
+     * sequence name.&lt;br/&gt;
+     */&lt;br/&gt;
+    protected String getGeneratedKeySequenceName(Column col) {&lt;br/&gt;
+        String sequence = super.getGeneratedKeySequenceName(col);&lt;br/&gt;
+        String schema = col.getSchemaName();&lt;br/&gt;
+        if (schema != null &amp;amp;&amp;amp; schema.length() &amp;gt; 0) &lt;/p&gt;
{
+            return schema + &quot;.&quot; + sequence;
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            return sequence;
+        }
&lt;p&gt;+    }&lt;/p&gt;

&lt;p&gt;     public Date getDate(ResultSet rs, int column)&lt;br/&gt;
         throws SQLException { &lt;/p&gt;

&lt;p&gt;This patch has been fine in production for me over the last week.&lt;/p&gt;

&lt;p&gt;Adam Hardy also adds:&lt;/p&gt;

&lt;p&gt;You might want to make that schema.toLowerCase()&lt;/p&gt;

&lt;p&gt;Postgres diverges from the JDBC spec by making everything lower case and it&lt;br/&gt;
won&apos;t find an upper case schema. &lt;/p&gt;</comment>
                            <comment id="12649089" author="mihbor@wp.pl" created="Wed, 19 Nov 2008 16:48:40 +0000"  >&lt;p&gt;I experienced this bug in geronimo 2.1.3&lt;/p&gt;

&lt;p&gt;I checked out openjpa tag 1.0.3 sources, applied the patch, compiled and substituted the class file in openjpa-1.0.3.jar in geronimo 2.1.3 repository.&lt;br/&gt;
I confirm the patch works.&lt;/p&gt;

&lt;p&gt;This issue is very important and I hope someone applies it to trunk soon &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks for the patch Roger!&lt;/p&gt;</comment>
                            <comment id="12658380" author="milosz" created="Sun, 21 Dec 2008 11:58:37 +0000"  >&lt;p&gt;The patch attached fixes the problem as suggested by Mehmet in &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-582&quot; title=&quot;when updating postgresql sequences last generated key query does not account for schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-582&quot;&gt;&lt;del&gt;OPENJPA-582&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;lastGeneratedKeyQuery = &quot;SELECT CURRVAL(&apos;&apos;&lt;/p&gt;
{1}
&lt;p&gt;_&lt;/p&gt;
{0}
&lt;p&gt;_seq&apos;&apos;)&quot;;&lt;/p&gt;

&lt;p&gt;This reflects well how PostgreSQL is creating implicit sequences for SERIAL (auto-increment) columns &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. Lower casing is already handled in DBDictionary.convertSchemaCase(String) method.&lt;/p&gt;

&lt;p&gt;I have updated the TestMultipleSchemaNames test case to make the issue visible. Previously the test case was failing in the beginning on PostgreSQL because of schema handling. Derby and DB2 create schema automatically in CREATE TABLE if schema does not exist. PostgreSQL requires explicit schema creation. I have added this to the test case. If we run the test case on Oracle or MySQL, the things are even worse because Oracle treats what we call schema a user name and MySQL treats it as database name.&lt;/p&gt;

&lt;p&gt;I added two DogX classes and removed comments from some others as I found them misleading.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://www.postgresql.org/docs/8.3/interactive/datatype-numeric.html#DATATYPE-SERIAL&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.postgresql.org/docs/8.3/interactive/datatype-numeric.html#DATATYPE-SERIAL&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12658381" author="milosz" created="Sun, 21 Dec 2008 12:02:36 +0000"  >&lt;p&gt;Applying the patch and running the test suite reveals another problem with schema handling in PostgreSQL. I will open a separate JIRA issue.&lt;/p&gt;</comment>
                            <comment id="12659008" author="fancy" created="Wed, 24 Dec 2008 00:23:45 +0000"  >&lt;p&gt;Patch provided by Milosz Tylenda has been checked in under svn trunk r729180 and branch 1.3.x r729181.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12394834">OPENJPA-582</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12396561" name="OPENJPA-557.patch" size="14440" author="milosz" created="Sun, 21 Dec 2008 11:58:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Nov 2008 16:48:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160873</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyswjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202621</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>