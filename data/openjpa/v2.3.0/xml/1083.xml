<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:39:20 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1083/OPENJPA-1083.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1083] org.apache.openjpa.persistence.kernel.TestEJBState fails with two exceptions ORA-00904 and ORA-02275 against oracleDB.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1083</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description></description>
                <environment></environment>
        <key id="12425321">OPENJPA-1083</key>
            <summary>org.apache.openjpa.persistence.kernel.TestEJBState fails with two exceptions ORA-00904 and ORA-02275 against oracleDB.</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12414167">OPENJPA-904</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikedd">Michael Dick</assignee>
                                    <reporter username="rpalache">Ravi P Palacherla</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 May 2009 12:15:56 +0100</created>
                <updated>Tue, 9 Mar 2010 18:31:15 +0000</updated>
                            <resolved>Wed, 10 Jun 2009 08:50:34 +0100</resolved>
                                    <version>2.0.0-M2</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0-M3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12708886" author="rpalache" created="Wed, 13 May 2009 12:18:31 +0100"  >&lt;p&gt;TestEJBState  fails with  ORA-00904 .&lt;/p&gt;

&lt;p&gt;After applying the patch on &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-946&quot; title=&quot;Oracle create table(s) exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-946&quot;&gt;&lt;del&gt;OPENJPA-946&lt;/del&gt;&lt;/a&gt; , ORA-00904 is fixed and now I get the following exception:&lt;/p&gt;

&lt;p&gt;&quot;Caused by: org.apache.openjpa.lib.jdbc.ReportingSQLException: ORA-02275: such a referential constrai&lt;br/&gt;
nt already exists in the table&lt;br/&gt;
 &lt;/p&gt;
{stmnt 25798515 ALTER TABLE DEPFIELDPC ADD FOREIGN KEY (OWNER_ID) REFERENCES DEPFIELDPC (ID) DEFERR
ABLE}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=2275, state=42000&amp;#93;&lt;/span&gt;&quot;&lt;/p&gt;</comment>
                            <comment id="12708888" author="rpalache" created="Wed, 13 May 2009 12:21:59 +0100"  >&lt;p&gt;Attached is a proposed fix.&lt;br/&gt;
Please review and commit if it is fine.&lt;/p&gt;

&lt;p&gt;Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-946&quot; title=&quot;Oracle create table(s) exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-946&quot;&gt;&lt;del&gt;OPENJPA-946&lt;/del&gt;&lt;/a&gt;  should be applied before applying this fix.&lt;/p&gt;</comment>
                            <comment id="12708936" author="mikedd" created="Wed, 13 May 2009 15:13:21 +0100"  >&lt;p&gt;Ravi, is this something that only happens with Oracle? Or is Oracle is the only database that throws an exception? &lt;/p&gt;

&lt;p&gt;Either way this patch looks like it will work, but I&apos;d like to know why we&apos;re getting a duplicate FK relationship. I believe some of the unit tests use similar entities (same table name) - if that&apos;s the case then qualifying the table name is a better approach. &lt;/p&gt;</comment>
                            <comment id="12708987" author="rpalache" created="Wed, 13 May 2009 17:14:27 +0100"  >&lt;p&gt;Michael,&lt;/p&gt;

&lt;p&gt;Thanks a lot for reviewing it.&lt;/p&gt;

&lt;p&gt;I think the above exception will occur in any database that will not allow executing the same SQL statement to add same foreign key more than once.&lt;br/&gt;
I tested it against Derby and oracle only.&lt;/p&gt;

&lt;p&gt;E.g:  If you execute both the following statements (same statement twice)&lt;br/&gt;
ALTER TABLE DEPFIELDPC ADD FOREIGN KEY (OWNER_ID) REFERENCES DEPFIELDPC&lt;br/&gt;
ALTER TABLE DEPFIELDPC ADD FOREIGN KEY (OWNER_ID) REFERENCES DEPFIELDPC&lt;/p&gt;

&lt;p&gt;Execution of above two statement will be successful in Derby ( hence test case passes in Derby) .&lt;br/&gt;
The second statement will fail in oracle with the ORA-02275 exception.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;Why we are getting duplicate FK ?&lt;/p&gt;

&lt;p&gt;In getDeleteTableContentsSQL() of DBDictionary.java,&lt;br/&gt;
while trying to delete the contents of table , openJPA tries to&lt;br/&gt;
 a. remove FK &lt;br/&gt;
 b. delete rows and then&lt;br/&gt;
 c. add FK back&lt;/p&gt;

&lt;p&gt;When there is no FK name then we are not removing it but still trying to add it.&lt;br/&gt;
The attached patch will not add FK unless we remove it.&lt;/p&gt;

&lt;p&gt;Please let me know of any suggestions.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Ravi.&lt;/p&gt;</comment>
                            <comment id="12709486" author="mikedd" created="Thu, 14 May 2009 18:49:45 +0100"  >&lt;p&gt;Hi Ravi,&lt;/p&gt;

&lt;p&gt;I think there&apos;s a larger problem here. We&apos;re able to create a FK without a name but unable to remove one. The relevant methods are getDropForeignKeySQL and getForeignKeyConstraintSQL().. &lt;/p&gt;

&lt;p&gt;Either it should be impossible to have an unnamed FK constraint when we call getDropFKSQL or we need to make those two methods consistent.. &lt;/p&gt;

&lt;p&gt;As far as the patch goes the approach will work for the getDeleteTableContentsSQL method, but we may still have a (potentially) larger problem to solve. &lt;/p&gt;</comment>
                            <comment id="12709526" author="rpalache" created="Thu, 14 May 2009 19:51:47 +0100"  >&lt;p&gt;Hi Michael,&lt;/p&gt;

&lt;p&gt;Thanks a lot for looking into it.&lt;/p&gt;

&lt;p&gt;Yes I agree with you, the actual issue is &quot;We&apos;re able to create a FK without a name but unable to remove one. &quot;&lt;/p&gt;

&lt;p&gt;When trying to add FK with out a name then the DB will use a system generated name.&lt;/p&gt;

&lt;p&gt;There are couple of options that I can think of in fixing the issue:&lt;br/&gt;
1)&lt;br/&gt;
While trying to remove the FK ( getDropForeignKeySQL ) if there is no foreign key name then I will try to get the FK name from DB and use it in the drop FK statement.&lt;/p&gt;

&lt;p&gt;2)&lt;br/&gt;
While adding a constraint, openJPA should give a default name to constraint, unless already specified by app or testcase.&lt;br/&gt;
In this case we may have to handle the duplicate constraint name on a table just like column names.&lt;/p&gt;

&lt;p&gt;I will start working on it, unless you have objection with any one of them (or both).&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Ravi.&lt;/p&gt;</comment>
                            <comment id="12710812" author="rpalache" created="Tue, 19 May 2009 19:01:28 +0100"  >&lt;p&gt;Hi Michael,&lt;/p&gt;

&lt;p&gt;I spent last couple of days on this issue and came up with a solution as described in #1 in my previous comment.&lt;br/&gt;
That is to retrieve the FK name from DB while deleting the FK constraint.&lt;br/&gt;
Even though this solution works fine it could be costly as it involves going to DB to fetch the FK name.&lt;br/&gt;
So I am still researching on a less expensive solution.&lt;/p&gt;

&lt;p&gt;Can you commit my attached changes on this JIRA as it fixed the testcase and I will open a new JIRA to handle the actual foreign key issue.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Ravi.&lt;/p&gt;</comment>
                            <comment id="12712100" author="rpalache" created="Fri, 22 May 2009 15:12:20 +0100"  >&lt;p&gt;Hi Michael, &lt;/p&gt;

&lt;p&gt;option#1 and option#2 patches are uploaded.&lt;br/&gt;
You do not need both patches, either one of them should work.&lt;/p&gt;

&lt;p&gt;TestEJBState will work only with patch &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-946&quot; title=&quot;Oracle create table(s) exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-946&quot;&gt;&lt;del&gt;OPENJPA-946&lt;/del&gt;&lt;/a&gt; and the current patch.&lt;br/&gt;
My current patch handles the foreign key problem.&lt;/p&gt;

&lt;p&gt;option#1 :&lt;br/&gt;
Every time I try to delete a FK, I will check the FKname.&lt;br/&gt;
If it does not exist then I go to DB and fetch the FKName.&lt;/p&gt;

&lt;p&gt;If option#1 is not preferable for any reason then you can try option2.&lt;/p&gt;

&lt;p&gt;option#2 :&lt;br/&gt;
Every time I try to add a FK. &lt;br/&gt;
I will check in the Mappings if FKName exists.&lt;br/&gt;
If it does not exist then a default name will be given.&lt;br/&gt;
The default name is local table name + column name of FK.&lt;/p&gt;

&lt;p&gt;The only issue with option#2 is that it will work on a new clean database.&lt;br/&gt;
So running &quot;mvn clean test -DfailIfNoTests=false&quot; will run fine with out any issues.&lt;/p&gt;

&lt;p&gt;If the tables are already created then it will not work because openJPA will think that the default name FK &lt;br/&gt;
is new FK and will try to add the existing FK with the new default name.&lt;/p&gt;

&lt;p&gt;I think it is an existing issue, same behavior for columns , tables etc...&lt;/p&gt;

&lt;p&gt;Please let me know if option#2 is preferable, but my changes are not acceptable because it does not work with existing database. I can add the logic of making it work on existing database also.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Ravi.&lt;/p&gt;</comment>
                            <comment id="12713559" author="mikedd" created="Wed, 27 May 2009 14:02:14 +0100"  >&lt;p&gt;Hi Ravi,&lt;/p&gt;

&lt;p&gt;I prefer option 1. It shouldn&apos;t affect existing tables (say if you migrate from 1.2 to 2.0) and it should work with your testcase.&lt;/p&gt;</comment>
                            <comment id="12713995" author="mikedd" created="Thu, 28 May 2009 15:51:48 +0100"  >&lt;p&gt;Some comments on the patch for option 1. &lt;/p&gt;

&lt;p&gt;It seems like the logic to obtain the foreign key name from the database belongs in the ForeignKey or Constraint class. Adding a method called loadName() or something similar seems cleaner. &lt;/p&gt;

&lt;p&gt;That being said it&apos;s not obvious where we read the name from the database. &lt;/p&gt;

&lt;p&gt;I also noticed that the patch always removes the FK from localTable (DBDictionary.getDropForeignKeySQL) but only adds it if it wasn&apos;t found. &lt;/p&gt;

&lt;p&gt;The last suggestion I&apos;d make is to add some sort of unit test just for this change. I know it shows up in other testcases on Oracle, but it&apos;d be nice to just validate this part of the change. &lt;/p&gt;</comment>
                            <comment id="12714015" author="mikedd" created="Thu, 28 May 2009 16:36:19 +0100"  >&lt;p&gt;Forgot to finish my earlier comment. On the whole this is a good patch and thanks for putting it all together Ravi!&lt;/p&gt;</comment>
                            <comment id="12714388" author="milosz" created="Fri, 29 May 2009 11:21:21 +0100"  >&lt;p&gt;Hi Ravi &amp;amp; Mike,&lt;/p&gt;

&lt;p&gt;Just wondering whether we need to modify the regex in TestParentChild to account for an optional &quot;DEFFERABLE&quot; clause? The syntax can be seen in the first comment to this issue. I remember failures of this tests, OracleDictionary has supportsDeferredConstraints = true. Is this test passing for you?&lt;/p&gt;</comment>
                            <comment id="12714449" author="rpalache" created="Fri, 29 May 2009 14:37:55 +0100"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Thanks for your comments.&lt;/p&gt;

&lt;p&gt;It is supposed to be handled as part of&lt;br/&gt;
&lt;a href=&quot;http://issues.apache.org/jira/browse/OPENJPA-907&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/OPENJPA-907&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There is a patch attached to it (I was a bit liberal with the RegEx).&lt;br/&gt;
I will correct it and ask for commiting the patch, once I am done with this.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Ravi.&lt;/p&gt;</comment>
                            <comment id="12714575" author="rpalache" created="Fri, 29 May 2009 21:12:15 +0100"  >&lt;p&gt;Hi Mike,&lt;/p&gt;

&lt;p&gt;Attached patch includes all the suggestions in your previous comment.&lt;/p&gt;

&lt;p&gt;Major changes:&lt;br/&gt;
a. Moved the logic of getting FK name from DB to ForeignKey.java&lt;br/&gt;
b. Added a test case to validate loadNameFromDB() of ForeignKey.java&lt;br/&gt;
c. My patch( ForeignKey. loadNameFromDB() ) no more removes all the FKs. &lt;br/&gt;
    It will only remove the newly added FK.&lt;/p&gt;

&lt;p&gt;Please review it and let me know of any further changes.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Ravi.&lt;/p&gt;</comment>
                            <comment id="12716344" author="mikedd" created="Thu, 4 Jun 2009 18:53:30 +0100"  >&lt;p&gt;Thanks for the patch Ravi. I did a little cleanup for compiler warnings and formatting - nothing major. &lt;/p&gt;</comment>
                            <comment id="12716856" author="milosz" created="Sat, 6 Jun 2009 10:48:09 +0100"  >&lt;p&gt;I am afraid the change causes a crash with MySQL:&lt;/p&gt;

&lt;p&gt;&amp;lt;openjpa-2.0.0-SNAPSHOT-r422266:782132 nonfatal general error&amp;gt; org.apache.openjpa.persistence.PersistenceException: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &apos;CONSTRAINT DEPFIELDPC_ibfk_1&apos; at line 1 &lt;/p&gt;
{stmnt 15864952 ALTER TABLE DEPFIELDPC DROP CONSTRAINT DEPFIELDPC_ibfk_1}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=1064, state=42000&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingTool.record(MappingTool.java:553)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Probably MySQL requires DROP FOREIGN KEY instead of DROP CONSTRAINT.&lt;/p&gt;

&lt;p&gt;Other databases should also be checked.&lt;/p&gt;</comment>
                            <comment id="12717216" author="milosz" created="Mon, 8 Jun 2009 11:06:58 +0100"  >&lt;p&gt;I have checked the latest docs of DB2, Derby, Firebird, MySQL, Oracle, PostgreSQL, SQL Server and Sybase 11and it seems that only MySQL does not like DROP CONSTRAINT and needs DROP FOREIGN KEY key_name.&lt;/p&gt;

&lt;p&gt;Maybe this issue could be closed and a new one created for updating MySQL dictionary.&lt;/p&gt;

&lt;p&gt;Since MySQL does not understand DROP CONSTRAINT at all, we might also need to override getDropPrimaryKeySQL. On the other hand, getDropPrimaryKeySQL seems not to be used with PK name != null. Is there a way for an application to specify PK constraint name?&lt;/p&gt;

</comment>
                            <comment id="12717248" author="rpalache" created="Mon, 8 Jun 2009 14:30:34 +0100"  >&lt;p&gt;Hi Milosz,&lt;/p&gt;

&lt;p&gt;The bug you mentioned exists even before the fix for this JIRA went in.&lt;/p&gt;

&lt;p&gt;The cause of the issue is inside DBDictionary.getDropForeignKeySQL() where it tries to use DROP constraint instead of DROP FK.&lt;/p&gt;

&lt;p&gt;The reason for why this issue appears now is because before the fix for this JIRA , getDropForeignKeySQL() was not dropping the foreignkey if FK name is null.&lt;/p&gt;

&lt;p&gt;The fix in this JIRA makes sure that the FKs are dropped properly before clearing table contents and hence you are seeing this issue now.&lt;/p&gt;

&lt;p&gt;So, I guess a new JIRA would be appropriate to fix the issue. Please let me know if you think otherwise.&lt;/p&gt;

&lt;p&gt;Also we may have to make getDropPrimaryKeySQL()  consistent with getDropForeignKeySQL().&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Ravi.&lt;/p&gt;</comment>
                            <comment id="12717973" author="milosz" created="Wed, 10 Jun 2009 08:50:34 +0100"  >&lt;p&gt;I will open a new issue to deal with MySQL requirements.&lt;/p&gt;</comment>
                            <comment id="12773252" author="techhusky" created="Tue, 3 Nov 2009 22:36:47 +0000"  >&lt;p&gt;I&apos;ve been working on an Oracle test failure(TestRelationFieldAsPrimaryKeyAndForeignKey.testQuery) in trunk that is identical to this issue.  I thought this fix would have corrected the problem, but I discovered that the fix works great for single column foreign keys, but does not work with multi-column keys.  I have an addendum to the original fix that I&apos;ll be committing to trunk shortly.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12427582">OPENJPA-1132</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12407985" name="OPENJPA-1083.patch" size="930" author="rpalache" created="Wed, 13 May 2009 12:21:58 +0100"/>
                            <attachment id="12408805" name="OPENJPA-1083_option1.patch" size="5871" author="rpalache" created="Fri, 22 May 2009 15:12:20 +0100"/>
                            <attachment id="12408806" name="OPENJPA-1083_option2.patch" size="3240" author="rpalache" created="Fri, 22 May 2009 15:12:20 +0100"/>
                            <attachment id="12409414" name="OPENJPA-1083_trunk.patch" size="13900" author="rpalache" created="Fri, 29 May 2009 21:12:15 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 13 May 2009 14:13:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161373</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt69b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204194</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>