<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:30:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-513/OPENJPA-513.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-513] No schema validation with Sun JDK</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-513</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Now that I have a resolution (JDK patch) for &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-429&quot; title=&quot;Recent changes have caused problems building with IBM JDK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-429&quot;&gt;&lt;del&gt;OPENJPA-429&lt;/del&gt;&lt;/a&gt;, when I run a 1.1.0 build, I am getting some errors from the test phase of openjpa-persistence-jdbc.  The following tests are failing according to the surefire report:&lt;/p&gt;

&lt;p&gt;Results :&lt;/p&gt;

&lt;p&gt;Tests in error:&lt;br/&gt;
  testEntityListeners(org.apache.openjpa.persistence.callbacks.TestEntityListeners)&lt;br/&gt;
  testGlobalListeners(org.apache.openjpa.persistence.callbacks.TestEntityListeners)&lt;br/&gt;
  testPersistenceUnitWithoutXSD(org.apache.openjpa.persistence.xml.TestPersistenceUnitWithoutXSD)&lt;br/&gt;
  testEnhancementOfAllPUsWithinAResource(org.apache.openjpa.enhance.TestEnhancementWithMultiplePUs)&lt;/p&gt;

&lt;p&gt;Tests run: 568, Failures: 0, Errors: 4, Skipped: 0&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12388277">OPENJPA-513</key>
            <summary>No schema validation with Sun JDK</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12381666">OPENJPA-429</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="kwsutter">Kevin Sutter</assignee>
                                    <reporter username="kwsutter">Kevin Sutter</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Feb 2008 20:28:25 +0000</created>
                <updated>Fri, 15 May 2009 21:13:26 +0100</updated>
                                            <version>1.0.2</version>
                    <version>1.1.0</version>
                    <version>1.2.1</version>
                    <version>1.3.0</version>
                    <version>2.0.0-M2</version>
                                                    <component>build / infrastructure</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12567365" author="kwsutter" created="Sat, 9 Feb 2008 21:11:05 +0000"  >&lt;p&gt;It looks like the final problem is due to the testcase introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-503&quot; title=&quot;XSD validation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-503&quot;&gt;OPENJPA-503&lt;/a&gt;.  It seems that the Sun JDK&apos;s SAX parser must be non-validating, while the IBM JDK SAX parser needs to validate the persistence.xml.  That&apos;s why the other three test failures were not being detected by the Sun JDK.&lt;/p&gt;

&lt;p&gt;Why do we think that it is valid to have a persistence.xml file without the xsd specified?  According to the JPA spec, the specification of the xsd is a requirement:&lt;/p&gt;

&lt;p&gt;&amp;lt;xsd:documentation&amp;gt;&amp;lt;![CDATA[&lt;br/&gt;
This is the XML Schema for the persistence configuration file.&lt;br/&gt;
The file must be named &quot;META-INF/persistence.xml&quot; in the persistence archive.&lt;br/&gt;
Persistence configuration files must indicate the persistence schema by using the persistence namespace:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://java.sun.com/xml/ns/persistence&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/xml/ns/persistence&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and indicate the version of the schema by using the version element as shown below:&lt;/p&gt;

&lt;p&gt;&amp;lt;persistence xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot;&lt;br/&gt;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;br/&gt;
  xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/persistence&lt;br/&gt;
  &lt;a href=&quot;http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd&lt;/a&gt;&quot;&lt;br/&gt;
  version=&quot;1.0&quot;&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
&amp;lt;/persistence&amp;gt;&lt;br/&gt;
]]&amp;gt;&amp;lt;/xsd:documentation&amp;gt;&lt;/p&gt;

&lt;p&gt;So, is the TestPersistenceUnitWithoutXSD testcase valid?&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12568714" author="pcl" created="Wed, 13 Feb 2008 20:50:28 +0000"  >&lt;p&gt;I believe that it is valid to do this because it is much easier to create an XML document by hand without an XSD. Without an XSD, I can type up a persistence.xml file free-form; with the XSD; I need to find that horrible five-line chunk of text to put at the top of the file every time.&lt;/p&gt;

&lt;p&gt;Surely there is some way to turn off validation in the IBM parser, right?&lt;/p&gt;</comment>
                            <comment id="12568758" author="mikedd" created="Wed, 13 Feb 2008 23:59:31 +0000"  >&lt;p&gt;I think the spec is being a bit draconian - I could do without those 5 lines too. The problem is that the spec does require it so we have to live with it. &lt;/p&gt;

&lt;p&gt;Tests in the openjpa-persistence modules should include the XSD infomation, but we should be able to move the tests to the kernel module and test it with a Broker. &lt;/p&gt;

&lt;p&gt;I&apos;m not sure that disabling the IBM JDK&apos;s validation is the right way to go, if nothing else it helps to show any cases where we have invalid tags. &lt;/p&gt;
</comment>
                            <comment id="12568782" author="pcl" created="Thu, 14 Feb 2008 01:57:25 +0000"  >&lt;p&gt;&amp;gt; I&apos;m not sure that disabling the IBM JDK&apos;s validation is the right way to go,&lt;br/&gt;
&amp;gt; if nothing else it helps to show any cases where we have invalid tags.&lt;/p&gt;

&lt;p&gt;... except that the test that is failing is one that explicitly tests OpenJPA&apos;s ability to parse a persistence.xml that does not have an XSD.&lt;/p&gt;</comment>
                            <comment id="12569324" author="kwsutter" created="Fri, 15 Feb 2008 17:19:04 +0000"  >&lt;p&gt;After a bit more digging, here&apos;s the scoop on the xml validation...&lt;/p&gt;

&lt;p&gt;By default, our OpenJPA code wants to validate the persistence.xml file when we read it in.  In the PersistenceProductDerivation$ConfigurationParser, we set the validation to true:&lt;/p&gt;

&lt;p&gt;        public ConfigurationParser(Map map) &lt;/p&gt;
{
            _map = map;
            setCaching(false);
            setValidating(true);
            setParseText(true);
        }

&lt;p&gt;But, later in the static initializer for the XMLMetaDataParser, there is a check for the Sun Xerxes parser.  This sets _schemaBug to true:&lt;/p&gt;

&lt;p&gt;    static {&lt;br/&gt;
        try &lt;/p&gt;
{
            // check for Xerces version 2.0.2 to see if we need to disable
            // schema validation, which works around the bug reported at:
            // http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4708859
            _schemaBug = &quot;Xerces-J 2.0.2&quot;.equals(Class.forName
                (&quot;org.apache.xerces.impl.Version&quot;).getField(&quot;fVersion&quot;).
                get(null));
        }
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
            // Xerces might not be available
            _schemaBug = false;
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;So, then when we determine what type of parser (validating or not), we end up running without validation for the Sun JDK ALL THE TIME:&lt;/p&gt;

&lt;p&gt;        if (schemaSource != null &amp;amp;&amp;amp; _schemaBug) &lt;/p&gt;
{
            if (_log != null &amp;amp;&amp;amp; _log.isTraceEnabled())
                _log.trace(_loc.get(&quot;parser-schema-bug&quot;));
            schemaSource = null;
        }
&lt;p&gt;        boolean validating = _validating &amp;amp;&amp;amp; (getDocType() != null &lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; schemaSource != null);&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;So, as soon as Sun&apos;s Xerxes parser gets updated with this fix, then this same testcase will fail with the Sun JDK.  Which brings me back to my original point of this not being a valid test for standard JPA.&lt;/p&gt;

&lt;p&gt;It looks like we (OpenJPA) wanted to run with a validating parser.  But, due to the bug in the Sun Xerxes parser, we&apos;ve been running without validation for the Sun JDK and with validation for all other JDK&apos;s (including the IBM JDK).  Since it looks like we want a validating parser, then I think this TestPersistenceUnitWithoutXSD should be removed.  And, maybe we should look at providing a switch to run with or without validation.&lt;/p&gt;

&lt;p&gt;Comments?&lt;br/&gt;
Kevin&lt;/p&gt;</comment>
                            <comment id="12569386" author="pcl" created="Fri, 15 Feb 2008 19:41:00 +0000"  >&lt;p&gt;I think that OpenJPA should parse XML documents that do not have an XSD.&lt;/p&gt;

&lt;p&gt;I believe that a sufficient switch should be whether or not the XML document has an XSD in it. If it has an XSD, clearly the user wants validation; if not, clearly the user does not want to specify one.&lt;/p&gt;</comment>
                            <comment id="12569416" author="kwsutter" created="Fri, 15 Feb 2008 21:11:28 +0000"  >&lt;p&gt;&amp;gt; I believe that a sufficient switch should be whether or not the XML document has an XSD in it. If it has an XSD, clearly the user wants validation; if not, clearly the user does not want to specify one.&lt;/p&gt;

&lt;p&gt;Nice idea, Patrick.  I&apos;ll see if we can easily detect this and set validation appropriately.  Thanks!&lt;/p&gt;</comment>
                            <comment id="12592740" author="pcl" created="Mon, 28 Apr 2008 06:20:35 +0100"  >&lt;p&gt;Where do things stand on this issue?&lt;/p&gt;</comment>
                            <comment id="12592803" author="kwsutter" created="Mon, 28 Apr 2008 14:11:05 +0100"  >&lt;p&gt;Patrick,&lt;br/&gt;
The problem is still &quot;unresolved&quot;.  From an IBM JDK environment viewpoint, the problem still exists.  From a Sun JDK viewpoint, the problem would still exist if we didn&apos;t have that special code in the XMLMetaDataParser initializer which bypasses validation.  So, as my previous remarks indicated, we are running without validation for the Sun JDK and with validation for all other JDKs.  If that Xerces parser problem would ever get resolved in the Sun JDK, then we&apos;d be hitting the same problem with the Sun JDK.&lt;/p&gt;

&lt;p&gt;The testcase in question has been &quot;disabled&quot; since mid-Feb 2008.&lt;/p&gt;

&lt;p&gt;Technically, it&apos;s still an open Issue.&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12617910" author="mikedd" created="Tue, 29 Jul 2008 20:10:25 +0100"  >&lt;p&gt;Moving to next release&lt;/p&gt;</comment>
                            <comment id="12618411" author="mikedd" created="Wed, 30 Jul 2008 17:16:55 +0100"  >&lt;p&gt;Moving to next release&lt;/p&gt;</comment>
                            <comment id="12709945" author="drwoods" created="Fri, 15 May 2009 20:54:52 +0100"  >&lt;p&gt;Confirmed that Sun 1.5.0_16 and 1.6.0_07 on MacOSX still has the parser bug, with an almost endless loop of -&lt;br/&gt;
. . .&lt;br/&gt;
	at org.apache.xerces.impl.xs.XMLSchemaLoader.processJAXPSchemaSource(XMLSchemaLoader.java:588)&lt;br/&gt;
	at org.apache.xerces.impl.xs.XMLSchemaLoader.loadSchema(XMLSchemaLoader.java:489)&lt;br/&gt;
. . .&lt;/p&gt;</comment>
                            <comment id="12709948" author="drwoods" created="Fri, 15 May 2009 21:12:06 +0100"  >&lt;p&gt;Failed whether the schemaLocation was there or not in persistence.xml.&lt;br/&gt;
Failed whether I pointed to the persistence_2_0.xsd (which is no on the Sun website yet but we include internally) or the 1_0.xsd (which is on the Sun website...)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12401185">OPENJPA-668</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12387003">OPENJPA-503</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 13 Feb 2008 20:50:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160830</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7kv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>288350</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>