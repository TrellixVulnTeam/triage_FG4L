<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:30:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-684/OPENJPA-684.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-684] Merge fails with context closed exception only when using load time &quot;enhancement&quot;</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-684</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;A test class with four test methods passes when the model classes are enhanced at compile time.  Three of the four test methods pass and one fails when the classes are enhanced at load time.  The failure occurs when a context is closed exception is thrown:&lt;/p&gt;

&lt;p&gt;&amp;lt;openjpa-1.1.0-r422266:657916 fatal user error&amp;gt; org.apache.openjpa.persistence.InvalidStateException: The context has been closed.  The stack trace at which the context was closed is held in the embedded exception.&lt;br/&gt;
FailedObject: java.lang.IllegalStateException&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.assertOpen(BrokerImpl.java:4360)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.beginOperation(BrokerImpl.java:1763)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.find(BrokerImpl.java:793)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.find(BrokerImpl.java:774)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.load(JDBCStoreManager.java:811)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.AbstractResult.load(AbstractResult.java:258)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.SelectImpl$SelectResult.load(SelectImpl.java:2228)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.RelationToManyTableFieldStrategy.loadElement(RelationToManyTableFieldStrategy.java:82)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.RelationCollectionTableFieldStrategy.loadElement(RelationCollectionTableFieldStrategy.java:75)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.StoreCollectionFieldStrategy.load(StoreCollectionFieldStrategy.java:479)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.FieldMapping.load(FieldMapping.java:802)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.load(JDBCStoreManager.java:520)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingStoreManager.load(DelegatingStoreManager.java:116)&lt;br/&gt;
	at org.apache.openjpa.kernel.ROPStoreManager.load(ROPStoreManager.java:78)&lt;br/&gt;
	at org.apache.openjpa.kernel.StateManagerImpl.loadFields(StateManagerImpl.java:2911)&lt;br/&gt;
	at org.apache.openjpa.kernel.StateManagerImpl.loadField(StateManagerImpl.java:2989)&lt;br/&gt;
	at org.apache.openjpa.kernel.StateManagerImpl.fetchObjectField(StateManagerImpl.java:2238)&lt;br/&gt;
	at org.apache.openjpa.kernel.StateManagerImpl.fetchField(StateManagerImpl.java:775)&lt;br/&gt;
	at org.apache.openjpa.kernel.StateManagerImpl.fetch(StateManagerImpl.java:737)&lt;br/&gt;
	at org.apache.openjpa.enhance.RedefinitionHelper$1.invoke(RedefinitionHelper.java:230)&lt;br/&gt;
	at $Proxy12.isEmpty(Unknown Source)&lt;br/&gt;
	at org.apache.openjpa.kernel.AttachStrategy.replaceCollection(AttachStrategy.java:292)&lt;br/&gt;
	at org.apache.openjpa.kernel.AttachStrategy.attachField(AttachStrategy.java:221)&lt;br/&gt;
	at org.apache.openjpa.kernel.VersionAttachStrategy.attach(VersionAttachStrategy.java:161)&lt;br/&gt;
	at org.apache.openjpa.kernel.AttachManager.attach(AttachManager.java:241)&lt;br/&gt;
	at org.apache.openjpa.kernel.AttachManager.attach(AttachManager.java:101)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.attach(BrokerImpl.java:3206)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBroker.attach(DelegatingBroker.java:1158)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerImpl.merge(EntityManagerImpl.java:769)&lt;br/&gt;
	at org.apache.openjpa.persistence.spring.LibServiceImpl.returnBook(LibServiceImpl.java:188)&lt;br/&gt;
	at org.apache.openjpa.persistence.spring.TestLibService.testReturnBook(TestLibService.java:196)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at junit.framework.TestCase.runTest(TestCase.java:168)&lt;br/&gt;
	at junit.framework.TestCase.runBare(TestCase.java:134)&lt;br/&gt;
	at junit.framework.TestResult$1.protect(TestResult.java:110)&lt;br/&gt;
	at junit.framework.TestResult.runProtected(TestResult.java:128)&lt;br/&gt;
	at junit.framework.TestResult.run(TestResult.java:113)&lt;br/&gt;
	at junit.framework.TestCase.run(TestCase.java:124)&lt;br/&gt;
	at junit.framework.TestSuite.runTest(TestSuite.java:232)&lt;br/&gt;
	at junit.framework.TestSuite.run(TestSuite.java:227)&lt;br/&gt;
	at org.junit.internal.runners.OldTestClassRunner.run(OldTestClassRunner.java:76)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:45)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)&lt;br/&gt;
Caused by: java.lang.IllegalStateException&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.free(BrokerImpl.java:4138)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.close(BrokerImpl.java:4068)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBroker.close(DelegatingBroker.java:1298)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerImpl.close(EntityManagerImpl.java:1106)&lt;br/&gt;
	at org.apache.openjpa.persistence.spring.LibServiceImpl.closeEM(LibServiceImpl.java:42)&lt;br/&gt;
	at org.apache.openjpa.persistence.spring.LibServiceImpl.findBorrowerByName(LibServiceImpl.java:129)&lt;br/&gt;
	at org.apache.openjpa.persistence.spring.TestLibService.testReturnBook(TestLibService.java:188)&lt;/p&gt;

&lt;p&gt;Debugging reveals that the issue is apparent confusion about which entity manager to use when merging the detached entities.  The entity manager that makes the call to merge is not the entity manager used when the failure occurs, but rather an entity manager that was used previously and closed as expected.&lt;/p&gt;

&lt;p&gt;What is interesting about this test case is that it mimics the behavior of containers (including the Spring Framework) that inject an entity manager at the beginning of each business method (effectively) and close it at the end of the method.  Transactions are, of course, handled within the short lifetime of the entity manager.&lt;/p&gt;</description>
                <environment>Version 1.1.0, 1.x head, as of revision 684077.  Using Sun JVM version 1.5.0_14 and 1.6.0_05.</environment>
        <key id="12402029">OPENJPA-684</key>
            <summary>Merge fails with context closed exception only when using load time &quot;enhancement&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dezzio">David Ezzio</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Aug 2008 20:34:45 +0100</created>
                <updated>Fri, 29 Aug 2008 16:36:32 +0100</updated>
                                                                            <component>jdbc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12621029" author="dezzio" created="Fri, 8 Aug 2008 20:50:03 +0100"  >&lt;p&gt;Working test case (compile time enhancement) submitted at 684066.&lt;/p&gt;</comment>
                            <comment id="12621030" author="dezzio" created="Fri, 8 Aug 2008 20:53:23 +0100"  >&lt;p&gt;Failing test case (load time enhancement)&lt;/p&gt;</comment>
                            <comment id="12621031" author="dezzio" created="Fri, 8 Aug 2008 20:55:39 +0100"  >&lt;p&gt;The zip for the failing test case is a patch that should be submittable as soon as the code is fixed to allow the test to pass.&lt;/p&gt;</comment>
                            <comment id="12627011" author="dezzio" created="Fri, 29 Aug 2008 16:34:04 +0100"  >&lt;p&gt;I&apos;ve run into the same test case failing with the same domain model in a different context under different conditions. I have not debugged the failure to determine whether it appears to be the same reason for the failure. Using WebLogic Server, with the service deployed in a stateless session bean and the domain deployed as a PU contained within the bean, the failure occurs even when both the server classes and the client classes have been enhanced by the OpenJPA enhancer immediately after compilation. To make the test case pass, I have found that I must add the property&lt;/p&gt;

&lt;p&gt;&amp;lt;property name=&quot;openjpa.DetachState&quot; value=&quot;loaded(DetachedStateField=true)&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;to persistence.xml.&lt;/p&gt;

&lt;p&gt;I tested all eight combinations of these three 2-value conditions. My results are attached.&lt;/p&gt;</comment>
                            <comment id="12627014" author="dezzio" created="Fri, 29 Aug 2008 16:36:32 +0100"  >&lt;p&gt;Results of testing with openjpa.DetachState on WebLogic Server 10.3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12387846" name="OPENJPA-684-Failing-Test-Case.zip" size="6870" author="dezzio" created="Fri, 8 Aug 2008 20:53:23 +0100"/>
                            <attachment id="12389177" name="results.zip" size="392" author="dezzio" created="Fri, 29 Aug 2008 16:36:32 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160996</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7lc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>288427</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>