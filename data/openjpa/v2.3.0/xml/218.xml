<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:36:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-218/OPENJPA-218.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-218] pcNewInstance and ApplicationId</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-218</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;When using an application id class containing a reference to another entity (example given below) a NPE is thrown when merging/reattaching the instance to an entity manager. &lt;br/&gt;
The problem is caused by the involved AttachStrategy where on line 89 (pc.pcNewInstance(null, appId, false)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; the call to pcNewInstance is null for the first parameter (StateManager). This statemanager is used to retrieve the object reference when reattaching using the method pcCopyKeyFieldsFromObjectId in the pcNewInstance method.&lt;/p&gt;

&lt;p&gt;Source for this bug:&lt;/p&gt;

&lt;p&gt;@Entity&lt;br/&gt;
@Table(name = &quot;domain_record&quot;)&lt;br/&gt;
@IdClass(DomainRecord.DomainRecordId.class)&lt;br/&gt;
public class DomainRecord implements Serializable {&lt;/p&gt;

&lt;p&gt;	private static final long serialVersionUID = 2966781630801201103L;&lt;/p&gt;

&lt;p&gt;	public static class DomainRecordId implements Serializable {&lt;/p&gt;

&lt;p&gt;		private static final long serialVersionUID = 3629556841694516032L;&lt;/p&gt;

&lt;p&gt;		private String zone;&lt;/p&gt;

&lt;p&gt;		private String name;&lt;/p&gt;

&lt;p&gt;		private Type type;&lt;/p&gt;

&lt;p&gt;		private String data;&lt;/p&gt;

&lt;p&gt;		public DomainRecordId() {&lt;br/&gt;
		}&lt;/p&gt;

&lt;p&gt;		public DomainRecordId(DomainRecord record) &lt;/p&gt;
{
			this.zone = record.zone.getName();
			this.name = record.name;
			this.type = record.type;
			this.data = record.data;
		}

&lt;p&gt;		public DomainRecordId(String zone, String name, Type type, String data) &lt;/p&gt;
{
			this.zone = zone;
			this.name = name;
			this.type = type;
			this.data = data;
		}

&lt;p&gt;		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@see java.lang.Object#hashCode()&lt;br/&gt;
		 */&lt;br/&gt;
		@Override&lt;br/&gt;
		public int hashCode() 
{
			final int PRIME = 31;
			int result = 1;
			result = PRIME * result + ((data == null) ? 0 : data.hashCode());
			result = PRIME * result + ((name == null) ? 0 : name.hashCode());
			result = PRIME * result + ((type == null) ? 0 : type.hashCode());
			result = PRIME * result + ((zone == null) ? 0 : zone.hashCode());
			return result;
		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@see java.lang.Object#equals(java.lang.Object)&lt;br/&gt;
		 */&lt;br/&gt;
		@Override&lt;br/&gt;
		public boolean equals(Object obj) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {			if (this == obj)				return true;			if (obj == null)				return false;			if (getClass() != obj.getClass())				return false;			final DomainRecordId other = (DomainRecordId) obj;			if (data == null) {
				if (other.data != null)
					return false;
			} else if (!data.equals(other.data))				return false;			if (name == null) {
				if (other.name != null)
					return false;
			} else if (!name.equals(other.name))				return false;			if (type == null) {
				if (other.type != null)
					return false;
			} else if (!type.equals(other.type))				return false;			if (zone == null) {
				if (other.zone != null)
					return false;
			} else if (!zone.equals(other.zone))				return false;			return true;		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;	}&lt;/p&gt;

&lt;p&gt;	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@author markusw&lt;/li&gt;
	&lt;li&gt;@version $Revision$&lt;br/&gt;
	 */&lt;br/&gt;
	public enum Type 
{
		A, AAAA, ALIAS, CNAME, HINFO, MX, NAPTR, NS, PTR, RP, SRV, TXT
	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;	@Id&lt;br/&gt;
	@ManyToOne(fetch = FetchType.LAZY, cascade = &lt;/p&gt;
{ CascadeType.ALL }
&lt;p&gt;)&lt;br/&gt;
	@JoinColumn(name = &quot;domain&quot;, referencedColumnName = &quot;name&quot;)&lt;br/&gt;
	private Domain zone;&lt;/p&gt;

&lt;p&gt;	@Id&lt;br/&gt;
	@Column(length = 64)&lt;br/&gt;
	private String name;&lt;/p&gt;

&lt;p&gt;	@Id&lt;br/&gt;
	@Enumerated(EnumType.STRING)&lt;br/&gt;
	private Type type;&lt;/p&gt;

&lt;p&gt;	@Id&lt;br/&gt;
	@Column(length = 128)&lt;br/&gt;
	private String data;&lt;br/&gt;
...&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment>Java 6</environment>
        <key id="12367383">OPENJPA-218</key>
            <summary>pcNewInstance and ApplicationId</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="knisterpeter">Markus Wolf</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Apr 2007 15:39:12 +0100</created>
                <updated>Tue, 9 Mar 2010 18:31:00 +0000</updated>
                            <resolved>Thu, 2 Apr 2009 21:08:31 +0100</resolved>
                                    <version>0.9.6</version>
                    <version>0.9.7</version>
                                    <fixVersion>2.0.0-M2</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12489418" author="knisterpeter" created="Tue, 17 Apr 2007 15:51:07 +0100"  >&lt;p&gt;To be more complete I&apos;ll attach the NPE stacktrace:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at de.esw.services.model.DomainRecord.pcCopyKeyFieldsFromObjectId(DomainRecord.java)&lt;br/&gt;
	at de.esw.services.model.DomainRecord.pcNewInstance(DomainRecord.java)&lt;br/&gt;
	at org.apache.openjpa.kernel.AttachStrategy.persist(AttachStrategy.java:89)&lt;br/&gt;
	at org.apache.openjpa.kernel.VersionAttachStrategy.attach(VersionAttachStrategy.java:85)&lt;br/&gt;
	at org.apache.openjpa.kernel.AttachManager.attach(AttachManager.java:236)&lt;br/&gt;
	at org.apache.openjpa.kernel.AttachManager.attach(AttachManager.java:97)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.attach(BrokerImpl.java:3124)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBroker.attach(DelegatingBroker.java:1120)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerImpl.merge(EntityManagerImpl.java:591)&lt;br/&gt;
	at org.springframework.orm.jpa.JpaTemplate$6.doInJpa(JpaTemplate.java:272)&lt;br/&gt;
	at org.springframework.orm.jpa.JpaTemplate.execute(JpaTemplate.java:191)&lt;br/&gt;
	at org.springframework.orm.jpa.JpaTemplate.merge(JpaTemplate.java:270)&lt;br/&gt;
	at de.esw.services.domain.DomainRecordProcessorImpl.update(DomainRecordProcessorImpl.java:53)&lt;/p&gt;</comment>
                            <comment id="12694622" author="faywang" created="Wed, 1 Apr 2009 18:09:12 +0100"  >&lt;p&gt;I tried the following scenario to reproduce this problem without success:&lt;/p&gt;

&lt;p&gt;(1) create an EntityManager: em&lt;br/&gt;
(2) create a DomainRecord: record&lt;br/&gt;
(3) call persist: em.persist(record)&lt;br/&gt;
(4) em.flush()&lt;br/&gt;
(5) commit&lt;br/&gt;
(6) em.clear()&lt;br/&gt;
(7) em.merge(record)&lt;/p&gt;

&lt;p&gt;This situation can only be reproduced in the following scenario:&lt;br/&gt;
(1) create an EntityManager: em&lt;br/&gt;
(2) create a DomainRecord: record&lt;br/&gt;
(3) em.merge(record)&lt;/p&gt;

&lt;p&gt;When merge is called on the record, this record does not have StateManagerImpl yet, causing NPE.&lt;/p&gt;</comment>
                            <comment id="12694732" author="faywang" created="Wed, 1 Apr 2009 21:52:29 +0100"  >&lt;p&gt;The patch is to fix PCEnhancer to guard against null StateManagerImpl:&lt;/p&gt;

&lt;p&gt;Before the patch:&lt;br/&gt;
-----------------------&lt;br/&gt;
  public void pcCopyKeyFieldsFromObjectId(Object paramObject)&lt;/p&gt;
  {
    ChildId localChildId = (ChildId)((ObjectId)paramObject).getId();
    this.id = localChildId.id;
    Child tmp28_27 = this;
    tmp28_27.parent = ((Parent)tmp28_27.pcStateManager.getPCPrimaryKey(localChildId, 2 + pcInheritedFieldCount));
  }

&lt;p&gt;After the patch:&lt;br/&gt;
--------------------&lt;br/&gt;
  public void pcCopyKeyFieldsFromObjectId(Object paramObject)&lt;/p&gt;
  {
    ChildId localChildId = (ChildId)((ObjectId)paramObject).getId();
    this.id = localChildId.id;
    if (this.pcStateManager == null)
      return;
    Child tmp28_27 = this;
    tmp28_27.parent = ((Parent)tmp28_27.pcStateManager.getPCPrimaryKey(localChildId, 2 + pcInheritedFieldCount));
  }

&lt;p&gt;After the patch, the test case to merge new entity with IdClass works fine. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12404386" name="OPENJPA-218-testcase.patch" size="13913" author="faywang" created="Wed, 1 Apr 2009 22:28:57 +0100"/>
                            <attachment id="12404377" name="OPENJPA-218.patch" size="1116" author="faywang" created="Wed, 1 Apr 2009 21:52:29 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 1 Apr 2009 17:09:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160549</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysw2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202544</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>