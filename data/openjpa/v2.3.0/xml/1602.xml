<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:31:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1602/OPENJPA-1602.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1602] Query with lock mode set to PESSIMISTIC_WRITE does not have for update clause attached to the sql when runs twice</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1602</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;The following test case executes query two times. &lt;/p&gt;

&lt;p&gt;The sql generated for the first time:&lt;br/&gt;
sql = SELECT t0.KEYNAME, t0.KEYVAL FROM KEYGEN t0 WHERE (t0.KEYNAME = ?)  optimize for 1 row FOR READ ONLY WITH RR USE AND KEEP UPDATE LOCKS&lt;/p&gt;

&lt;p&gt;The sql generated for the second time:&lt;br/&gt;
sql = SELECT t0.KEYNAME, t0.KEYVAL FROM KEYGEN t0 WHERE (t0.KEYNAME = ?)&lt;/p&gt;


&lt;p&gt;   public void testKeyGen() {&lt;br/&gt;
        EntityManager em = emf.createEntityManager();&lt;br/&gt;
        KeyGenEntity key = null;&lt;br/&gt;
        em.getTransaction().begin();&lt;br/&gt;
        for (int i = 0;i &amp;lt; 2; i++) {&lt;br/&gt;
            Query q = em.createNamedQuery(&quot;getStationKeyForUpdate&quot;);&lt;br/&gt;
            q.setLockMode(LockModeType.PESSIMISTIC_WRITE);&lt;br/&gt;
            q.setParameter(&quot;keyname&quot;, keyName);&lt;br/&gt;
            try &lt;/p&gt;
{
                key = (KeyGenEntity) q.getSingleResult();
                em.refresh(key);
            }
&lt;p&gt;            catch (NoResultException e) &lt;/p&gt;
{
                // No keys found for this name - create a new one
                int keyVal = 0;
                key = new KeyGenEntity(keyName, keyVal);
                em.persist(key);
                em.lock(key, LockModeType.PESSIMISTIC_WRITE);
            }

&lt;p&gt;            int keyVal = key.getKeyval();&lt;br/&gt;
            key.setKeyval(keyVal +  1);&lt;br/&gt;
        }&lt;br/&gt;
        em.getTransaction().commit();&lt;br/&gt;
    }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12460578">OPENJPA-1602</key>
            <summary>Query with lock mode set to PESSIMISTIC_WRITE does not have for update clause attached to the sql when runs twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ppoddar@apache.org">Pinaki Poddar</assignee>
                                    <reporter username="faywang">Fay Wang</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Mar 2010 19:04:45 +0100</created>
                <updated>Thu, 22 Apr 2010 21:30:09 +0100</updated>
                            <resolved>Wed, 7 Apr 2010 17:26:40 +0100</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>jdbc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12851056" author="faywang" created="Mon, 29 Mar 2010 20:41:59 +0100"  >&lt;p&gt;The following is the KeyGenEntity.java:&lt;/p&gt;

&lt;p&gt;import javax.persistence.Column;&lt;br/&gt;
import javax.persistence.Entity;&lt;br/&gt;
import javax.persistence.Id;&lt;br/&gt;
import javax.persistence.NamedQuery;&lt;br/&gt;
import javax.persistence.Table;&lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Handles key gen generation for a number of cases.&lt;br/&gt;
 *&lt;br/&gt;
 */&lt;br/&gt;
@Entity&lt;br/&gt;
@Table(name=&quot;KEYGEN&quot;)&lt;br/&gt;
@NamedQuery(name=&quot;getStationKeyForUpdate&quot;,&lt;br/&gt;
query=&quot;select kg from KeyGenEntity as kg where kg.keyname = :keyname&quot;)&lt;br/&gt;
public class KeyGenEntity {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@Id&lt;br/&gt;
@Column(name=&quot;KEYNAME&quot;)&lt;br/&gt;
private String keyname;&lt;br/&gt;
@Column(name=&quot;KEYVAL&quot;)&lt;br/&gt;
private int keyval;&lt;/p&gt;

&lt;p&gt;public String getKeyname() &lt;/p&gt;
{
return keyname;
}

&lt;p&gt;public void setKeyname(String keyname) &lt;/p&gt;
{
this.keyname = keyname;
}

&lt;p&gt;public int getKeyval() &lt;/p&gt;
{
return keyval;
}

&lt;p&gt;public void setKeyval(int keyval) &lt;/p&gt;
{
this.keyval = keyval;
}

&lt;p&gt;public KeyGenEntity() {&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;public KeyGenEntity(String keyname, int keyval) &lt;/p&gt;
{
super();
this.keyname = keyname;
this.keyval = keyval;
}
&lt;p&gt;} &lt;/p&gt;</comment>
                            <comment id="12851524" author="drwoods" created="Tue, 30 Mar 2010 20:24:58 +0100"  >&lt;p&gt;showing as affects/fix for 2.0.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 30 Mar 2010 19:24:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161864</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysqzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>201720</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>