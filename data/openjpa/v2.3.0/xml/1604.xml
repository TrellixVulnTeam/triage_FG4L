<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:32:51 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1604/OPENJPA-1604.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1604] Setting PessimisticLockManager fails to append &quot;for update clause&quot; to the select statement</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1604</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt; I ran a testcase against openjpa 1.2, and found that the &quot;for update&quot; clause is appended to the SQL when&lt;/p&gt;

&lt;p&gt; 		&amp;lt;property name=&quot;openjpa.LockManager&quot; value=&quot;pessimistic&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;	is added to the persistence.xml without calling: &lt;/p&gt;

&lt;p&gt;		 q.setLockMode(LockModeType.PESSIMISTIC_WRITE);&lt;/p&gt;

&lt;p&gt;However, this behavior changes when running against trunk level code&lt;/p&gt;</description>
                <environment></environment>
        <key id="12460738">OPENJPA-1604</key>
            <summary>Setting PessimisticLockManager fails to append &quot;for update clause&quot; to the select statement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curtisr7">Rick Curtis</assignee>
                                    <reporter username="faywang">Fay Wang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Mar 2010 21:44:32 +0100</created>
                <updated>Wed, 30 Jun 2010 22:00:29 +0100</updated>
                            <resolved>Sat, 10 Apr 2010 18:41:04 +0100</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="12851933" author="ppoddar@apache.org" created="Wed, 31 Mar 2010 17:31:35 +0100"  >&lt;p&gt;The setting of lock modes based on current lock manager seems to be ambiguous at few places both in usage and in design/code.&lt;/p&gt;

&lt;p&gt;From a usage point of view, &lt;br/&gt;
  a) setting a specific lock manager be it pessimistic or optimistic should impose a specific default read and write lock level for all queries. &lt;br/&gt;
  b) that default level can be overwritten by &lt;br/&gt;
       i) setting query.setLockMode()&lt;br/&gt;
      ii) setting lockMode attribute of @NamedQuery&lt;br/&gt;
     iii) setting query hints&lt;br/&gt;
      iv) passing lock properties in find() etc.&lt;/p&gt;

&lt;p&gt;  c) the semantics of a joint specification such as &lt;br/&gt;
        &amp;lt;property name=&quot;openjpa.LockManager&quot; value=&quot;pessimistic&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;property name=&quot;openjpa.Optimistc&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
      also appears confusing/contradictory. We should either detect specification that are contradictory or clarify what such apparently contradictory specifications imply.&lt;/p&gt;

&lt;p&gt;From a design/code point of view,&lt;br/&gt;
   a) setting a FetchPlan.Lock hint during annotation parsing does not look good to me. We have reasonable data structures to capture meta information on a query and that seems to be the right place for lock information rather than a fetch plan hint.&lt;br/&gt;
   b) the default read/write lock levels should be dictated by the currently active lock manager. LockManager.beginTransaction() seems to be one correct place to populate the fetch configuration with these levels. Outside transaction, fetch plan initialization should take current Lock Manager into consideration to set its read/write lock levels.&lt;br/&gt;
   c) OpenJPAConfiguration should impose consistency between LockManager and setOptimistic() &lt;/p&gt;
</comment>
                            <comment id="12855073" author="curtisr7" created="Thu, 8 Apr 2010 19:34:00 +0100"  >&lt;p&gt;After digging into this problem I concur with Pinaki&apos;s assessment that the lock modes / lock configuration has numerous issues. I&apos;m posting a patch that will only address the backward compatibility issue. &lt;/p&gt;

&lt;p&gt;The root issue at hand is that in JPA 1.0 a named query had a default lock mode of READ (by OpenJPA&apos;s definition, not the spec), but per the 2.0 spec the default lock mode is NONE.&lt;/p&gt;

&lt;p&gt;Ideally when we are parsing annotations in AnnotationPersistenceMetaDataParser we could differentiate between a named query which has specified the lockMode vs a default lockMode. Since that doesn&apos;t seem to be possible, I&apos;m proposing that if we detect that we&apos;re using a pessimistic lock manager and the lockMode is none, we will promote that lock to a READ lock.&lt;/p&gt;

&lt;p&gt;This approach will restore backward compatibility, but will exclude one use case. When using a pessimistic lock manager on 2.0 you will be unable to configure a NamedQuery with the lockMode of NONE. &lt;/p&gt;</comment>
                            <comment id="12855087" author="curtisr7" created="Thu, 8 Apr 2010 19:55:39 +0100"  >&lt;p&gt;I just noticed that my patch still has some test debug in it... I&apos;ll update it shortly.&lt;/p&gt;</comment>
                            <comment id="12855455" author="ppoddar@apache.org" created="Fri, 9 Apr 2010 17:19:04 +0100"  >&lt;p&gt;Some of the tests such as executing a NamedQuery with lock outside a transaction should raise an error has been @AllowFailured.&lt;br/&gt;
Please add the reason/explanatory texts to @AllowFailure why that is done/required. &lt;/p&gt;</comment>
                            <comment id="12855612" author="drwoods" created="Sat, 10 Apr 2010 18:41:04 +0100"  >&lt;p&gt;Code checked into 2.0.0, so marking it resolved for the release notes.&lt;br/&gt;
If more work is required, please open a new issue and link it to this one.&lt;/p&gt;</comment>
                            <comment id="12855988" author="curtisr7" created="Mon, 12 Apr 2010 15:40:42 +0100"  >&lt;p&gt;@Pinaki &amp;#8211; See &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1629&quot; title=&quot;Executing a named query with a lock mode greater than NONE throws the wrong exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1629&quot;&gt;OPENJPA-1629&lt;/a&gt; regarding the @AllowFailure.&lt;/p&gt;</comment>
                            <comment id="12861068" author="techhusky" created="Mon, 26 Apr 2010 20:53:14 +0100"  >&lt;p&gt;Attaching a patch for 2.0.x which takes into account the Optimistic setting when calculating the default lock mode to apply to a named query.  This must occur in order to maintain 1.x behavior.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12468294">OPENJPA-1714</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12461828">OPENJPA-1629</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12441199" name="OPENJPA-1604-2.0.x.patch" size="13939" author="curtisr7" created="Thu, 8 Apr 2010 20:05:49 +0100"/>
                            <attachment id="12441198" name="OPENJPA-1604-trunk.patch" size="14274" author="curtisr7" created="Thu, 8 Apr 2010 20:05:49 +0100"/>
                            <attachment id="12442891" name="OPENJPA-1604_optimistic_fix_2.0.x.patch" size="8451" author="techhusky" created="Mon, 26 Apr 2010 20:53:14 +0100"/>
                    </attachments>
                <subtasks>
                            <subtask id="12462700">OPENJPA-1638</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 31 Mar 2010 16:31:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161866</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyss6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>201914</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>