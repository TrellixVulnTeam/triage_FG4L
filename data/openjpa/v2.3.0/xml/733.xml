<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:44:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-733/OPENJPA-733.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-733] Entity contains pseudo-attached embeddable after detach</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-733</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Problem reported by Chris Tillman on user forum and can be easily reproduced with the code provided:&lt;/p&gt;

&lt;p&gt;When upgrading a standalone Java application from OpenJPA 1.1 to 1.2 i ran&lt;br/&gt;
into a problem regarding embedded classes.&lt;/p&gt;

&lt;p&gt;Accessing a field from an embedded class (say, Address) in a detached entity&lt;br/&gt;
(Customer) doesn&apos;t seem to work anymore. OpenJPA 1.2 throws an&lt;br/&gt;
InvalidStateException. It worked fine with OpenJPA 1.1.&lt;/p&gt;

&lt;p&gt;The field (street) contains the correct value as loaded from the database,&lt;br/&gt;
but when the getter is used, e.g. customer.getAddress().getStreet(), the ISE&lt;br/&gt;
is thrown:&lt;/p&gt;

&lt;p&gt;org.apache.openjpa.persistence.InvalidStateException: The context has been&lt;br/&gt;
closed.&lt;br/&gt;
       at org.apache.openjpa.kernel.BrokerImpl.assertOpen(BrokerImpl.java:4367)&lt;br/&gt;
       at&lt;br/&gt;
org.apache.openjpa.kernel.BrokerImpl.beginOperation(BrokerImpl.java:1766)&lt;br/&gt;
       at org.apache.openjpa.kernel.BrokerImpl.isActive(BrokerImpl.java:1736)&lt;br/&gt;
       at&lt;br/&gt;
org.apache.openjpa.kernel.StateManagerImpl.beforeRead(StateManagerImpl.java:941)&lt;br/&gt;
       at&lt;br/&gt;
org.apache.openjpa.kernel.StateManagerImpl.accessingField(StateManagerImpl.java:1476)&lt;br/&gt;
       at org.test.Address.pcGetstreet(Address.java)&lt;br/&gt;
       at org.test.Address.getStreet(Address.java:22)&lt;br/&gt;
       at org.test.Test.main(Test.java:30)&lt;/p&gt;

&lt;p&gt;Upon investigation, it seems to work OK in OpenJPA 1.2 using runtime&lt;br/&gt;
enhancement (Java 6) but not using compile-time enhancement. However, in&lt;br/&gt;
OpenJPA 1.1 it&apos;s the other way around.&lt;/p&gt;

&lt;p&gt;OpenJPA 1.1 with compile-time enhancement uses a DetachedStateManager for&lt;br/&gt;
both the entity and the embeddable. As can be seen from the stacktrace,&lt;br/&gt;
OpenJPA 1.2 uses a StateManagerImpl instead for the embeddable.&lt;/p&gt;

&lt;p&gt;Is this a regression in OpenJPA 1.2?&lt;/p&gt;

&lt;p&gt;Test code below:&lt;br/&gt;
//-------------------------&lt;/p&gt;

&lt;p&gt;package org.test;&lt;/p&gt;

&lt;p&gt;import java.util.List;&lt;/p&gt;

&lt;p&gt;import javax.persistence.*;&lt;/p&gt;

&lt;p&gt;public class Test {&lt;br/&gt;
       public static void main(String[] args) {&lt;br/&gt;
               EntityManagerFactory factory = Persistence&lt;br/&gt;
                               .createEntityManagerFactory(&quot;test&quot;);&lt;/p&gt;

&lt;p&gt;               Customer customer = new Customer();&lt;br/&gt;
               Address address = new Address();&lt;/p&gt;

&lt;p&gt;               customer.setLastName(&quot;Doe&quot;);&lt;br/&gt;
               address.setStreet(&quot;Main Street&quot;);&lt;br/&gt;
               customer.setAddress(address);&lt;/p&gt;

&lt;p&gt;               try &lt;/p&gt;
{
                       persistCustomer(factory, customer);

                       customer = queryCustomers(factory,
                                       &quot;select customer from Customer customer&quot; +
                                       &quot; where customer.lastName = &apos;Doe&apos;&quot;)
                                       .get(0);

                       System.out.println(customer.getLastName());
                       System.out.println(customer.getAddress().getStreet());

                       factory.close();
               }
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
                       t.printStackTrace();
               }
&lt;p&gt;       }&lt;/p&gt;

&lt;p&gt;       static void persistCustomer(EntityManagerFactory factory, Customer&lt;br/&gt;
customer)&lt;br/&gt;
                       throws Exception {&lt;br/&gt;
               final EntityManager em = factory.createEntityManager();&lt;br/&gt;
               final EntityTransaction tx = em.getTransaction();&lt;/p&gt;

&lt;p&gt;               tx.begin();&lt;/p&gt;

&lt;p&gt;               try &lt;/p&gt;
{
                       em.persist(customer);

                       tx.commit();
               }
&lt;p&gt; finally {&lt;br/&gt;
                       if (!tx.isActive()) &lt;/p&gt;
{
                               em.close();
                       }&lt;br/&gt;
               }&lt;br/&gt;
       }&lt;br/&gt;
&lt;br/&gt;
       public static List&amp;lt;Customer&amp;gt; queryCustomers(EntityManagerFactory factory,&lt;br/&gt;
                       String query) throws Exception {&lt;br/&gt;
               final EntityManager em = factory.createEntityManager();&lt;br/&gt;
               final EntityTransaction tx = em.getTransaction();&lt;br/&gt;
&lt;br/&gt;
               tx.begin();&lt;br/&gt;
&lt;br/&gt;
               try {
                       final List&amp;lt;Customer&amp;gt; list = (List&amp;lt;Customer&amp;gt;) em.createQuery(query)
                                       .getResultList();

                       tx.commit();

                       return list;
               } finally {&lt;br/&gt;
                       if (!tx.isActive()) {                               em.close();                       }
&lt;p&gt;               }&lt;br/&gt;
       }&lt;br/&gt;
}&lt;br/&gt;
//-------------------------&lt;/p&gt;

&lt;p&gt;package org.test;&lt;/p&gt;

&lt;p&gt;import javax.persistence.*;&lt;/p&gt;

&lt;p&gt;@Entity&lt;br/&gt;
public class Customer {&lt;br/&gt;
       @Id @GeneratedValue long id;&lt;/p&gt;

&lt;p&gt;       @Basic String lastName;&lt;/p&gt;

&lt;p&gt;       @Embedded Address address;&lt;/p&gt;

&lt;p&gt;       public String getLastName() &lt;/p&gt;
{
               return lastName;
       }

&lt;p&gt;       public void setLastName(String lastName) &lt;/p&gt;
{
               this.lastName = lastName;
       }

&lt;p&gt;       public Address getAddress() &lt;/p&gt;
{
               return address;
       }

&lt;p&gt;       public void setAddress(Address address) &lt;/p&gt;
{
               this.address = address;
       }
&lt;p&gt;}&lt;br/&gt;
//-------------------------&lt;/p&gt;

&lt;p&gt;package org.test;&lt;/p&gt;

&lt;p&gt;import javax.persistence.*;&lt;/p&gt;

&lt;p&gt;@Embeddable&lt;br/&gt;
public class Address {&lt;br/&gt;
       @Basic String street;&lt;/p&gt;

&lt;p&gt;       public String getStreet() &lt;/p&gt;
{
               return street;
       }

&lt;p&gt;       public void setStreet(String street) &lt;/p&gt;
{
               this.street = street;
       }
&lt;p&gt;}&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12405163">OPENJPA-733</key>
            <summary>Entity contains pseudo-attached embeddable after detach</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="techhusky">Jeremy Bauer</assignee>
                                    <reporter username="techhusky">Jeremy Bauer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Sep 2008 18:29:55 +0100</created>
                <updated>Fri, 7 Jan 2011 14:21:47 +0000</updated>
                            <resolved>Mon, 6 Oct 2008 18:40:20 +0100</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.1</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12635557" author="techhusky" created="Mon, 29 Sep 2008 23:01:39 +0100"  >&lt;p&gt;Attaching a preliminary patch for trunk.  I&apos;ve only tested with the submitted test case.  I still need to run the full unit test suite.  If all tests pass, will convert submitted test to OpenJPA jUnit and commit code changes.&lt;/p&gt;

&lt;p&gt;In summary, embeddables were not being added to the L1 cache as the result of a query so they were not processed as part of the detach operation.  The StateManagerImpl.getObjectId is a bit misleading since it returns the oid of the owner, not the embeddable.  The owner was already in the L1 cache, so the embeddable was not loaded.  Modified the logic to check the L1 for the embeddable oid.&lt;/p&gt;</comment>
                            <comment id="12637148" author="techhusky" created="Mon, 6 Oct 2008 18:40:20 +0100"  >&lt;p&gt;Chris applied the patch and it corrected the problem.  Committed in revision 700563.  Marking issue as resolved.&lt;/p&gt;</comment>
                            <comment id="12637161" author="mikedd" created="Mon, 6 Oct 2008 19:13:37 +0100"  >&lt;p&gt;Considering for 1.2.1&lt;/p&gt;</comment>
                            <comment id="12637198" author="techhusky" created="Mon, 6 Oct 2008 20:40:53 +0100"  >&lt;p&gt;Attaching clean patches (no EOL issue) for StateManagerImpl and TestEmbedded.  I created them with trunk, but was able to successfully apply them to 1.2.x.&lt;/p&gt;</comment>
                            <comment id="12638632" author="techhusky" created="Fri, 10 Oct 2008 20:44:05 +0100"  >&lt;p&gt;Here is a link to forum conversation on nabble for reference:  &lt;a href=&quot;http://n2.nabble.com/Problem-with-detaching-embedded-class-in-OpenJPA-1.2-using-compile-time-enhancement-td1117628.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://n2.nabble.com/Problem-with-detaching-embedded-class-in-OpenJPA-1.2-using-compile-time-enhancement-td1117628.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12638640" author="techhusky" created="Fri, 10 Oct 2008 21:11:18 +0100"  >&lt;p&gt;The change to StateManagerImpl in &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-209&quot; title=&quot;Query returning 2 entities w/unidir 1-1 relationship gets openjpa.persistence.ArgumentException: Address with the same id already exists in the L1 cache.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-209&quot;&gt;&lt;del&gt;OPENJPA-209&lt;/del&gt;&lt;/a&gt; caused this regression.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12494947">OPENJPA-1919</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12366750">OPENJPA-209</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12391167" name="OPENJPA-733.patch" size="736" author="techhusky" created="Mon, 29 Sep 2008 23:01:39 +0100"/>
                            <attachment id="12391568" name="OPENJPA-733_smimpl.patch" size="771" author="techhusky" created="Mon, 6 Oct 2008 20:40:53 +0100"/>
                            <attachment id="12391569" name="OPENJPA-733_test.patch" size="3050" author="techhusky" created="Mon, 6 Oct 2008 20:40:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 6 Oct 2008 18:13:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161042</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyswxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202684</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>