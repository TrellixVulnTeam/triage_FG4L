<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:41:55 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1381/OPENJPA-1381.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1381] IllegalStateException on query method call after named query is created twice.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1381</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;When a query method is called (e.g. setLockMode) on a named query that has been created twice, an IllegalStateException is thrown:&lt;/p&gt;

&lt;p&gt;  Query q1 = em.createNamedQuery(&quot;xxxx&quot;);&lt;br/&gt;
  ,,,,&lt;br/&gt;
  Query q2 = em.createNamedQuery(&quot;xxxx&quot;);&lt;br/&gt;
  q2.setLockMode(READ);&lt;/p&gt;


&lt;p&gt;11078  test  TRACE  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-4&amp;#93;&lt;/span&gt; Tests - Caught exception and continue: java.lang.IllegalStateException: Query is neither a JPQL SELECT nor a Criteria API query.&lt;br/&gt;
11078  test  TRACE  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-4&amp;#93;&lt;/span&gt; DumpStack - java.lang.IllegalStateException: Query is neither a JPQL SELECT nor a Criteria API query.&lt;br/&gt;
	at org.apache.openjpa.persistence.QueryImpl.assertJPQLOrCriteriaQuery(QueryImpl.java:377)&lt;br/&gt;
	at org.apache.openjpa.persistence.QueryImpl.setLockMode(QueryImpl.java:396)&lt;br/&gt;
	at org.apache.openjpa.persistence.QueryImpl.setLockMode(QueryImpl.java:1)&lt;br/&gt;
	at org.apache.openjpa.persistence.lockmgr.SequencedActionsTest.launchCommonSequence(SequencedActionsTest.java:409)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12440421">OPENJPA-1381</key>
            <summary>IllegalStateException on query method call after named query is created twice.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ppoddar@apache.org">Pinaki Poddar</assignee>
                                    <reporter username="allee8285">Albert Lee</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Nov 2009 15:53:47 +0000</created>
                <updated>Tue, 9 Mar 2010 18:31:24 +0000</updated>
                            <resolved>Mon, 18 Jan 2010 19:50:34 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0-beta</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12776486" author="allee8285" created="Wed, 11 Nov 2009 16:01:12 +0000"  >&lt;p&gt;The problem is in PreparedQueryImpl, in which getLanauge() always return QueryLanguages.LANG_PREPARED_SQL regardless of the source of the cached Query. It is not sensitive to the query source.&lt;/p&gt;

&lt;p&gt;In EntityManagerImpl.createNamedQuery:&lt;/p&gt;

&lt;p&gt;    public OpenJPAQuery createNamedQuery(String name) {&lt;br/&gt;
        try {&lt;br/&gt;
            ....&lt;br/&gt;
            PreparedQuery pq = JPQLParser.LANG_JPQL.equals(meta.getLanguage())&lt;br/&gt;
                ? getPreparedQuery(qid) : null;&lt;br/&gt;
            org.apache.openjpa.kernel.Query del = (pq == null)&lt;br/&gt;
                ? _broker.newQuery(meta.getLanguage(), meta.getQueryString())&lt;br/&gt;
                : _broker.newQuery(pq.getLanguage(), pq);&lt;/p&gt;

&lt;p&gt;The first time the named query is created, there is no query cached, a new Query is created using the metadata&apos;s language attribute (i.e. JPQL). The second time the named query is created, it is found in query cache, and the preparedQuery&apos;s language is used, which is ALWAYS SQL, that caused the ISEx when tested in the setLockMode() call path.&lt;/p&gt;
</comment>
                            <comment id="12776536" author="allee8285" created="Wed, 11 Nov 2009 17:51:41 +0000"  >&lt;p&gt;Work around of this limitation is to specify query hint &quot;openjpa.hint.IgnorePreparedQuery&quot; to true.&lt;/p&gt;

&lt;p&gt;What is the reason cached query is treated as SQL and subsequently does not allow query methods that requires JPQL/Criteria API as the source language?&lt;/p&gt;</comment>
                            <comment id="12776626" author="allee8285" created="Wed, 11 Nov 2009 20:06:03 +0000"  >&lt;p&gt;The limitation/requirement of using the query cache is documented in the manual.&lt;/p&gt;

&lt;p&gt;The query cache is enabled by default, which is a problem for a JPA compliance application that has the reported usage pattern.&lt;/p&gt;

&lt;p&gt;Pinaki agrees using this JIRA to either:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;make the Query cache disabled by default.&lt;/li&gt;
	&lt;li&gt;invalidate the cache at the appropriate call path&lt;/li&gt;
	&lt;li&gt;potentially using QueryImpl.ignorePreparedQuery() to automatically by-pass the problem.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Albert Lee.&lt;/p&gt;</comment>
                            <comment id="12776851" author="allee8285" created="Thu, 12 Nov 2009 05:30:45 +0000"  >&lt;p&gt;The IllegalStateException semantics also apply to the Query.getLockMode() method call, per spec.  Similar usage of the ignorePreparedQuery() can be applied to getLockMode(), however it will lose the effectiveness of the cache (i.e. invalidate and rebuild) since getLockMode does not change the query&apos;s structure.&lt;/p&gt;</comment>
                            <comment id="12776881" author="ppoddar@apache.org" created="Thu, 12 Nov 2009 07:24:55 +0000"  >&lt;p&gt;Albert, see if this works. Otherwise I will reopen.&lt;/p&gt;</comment>
                            <comment id="12777015" author="allee8285" created="Thu, 12 Nov 2009 15:10:08 +0000"  >&lt;p&gt;Pinaki,&lt;/p&gt;

&lt;p&gt;The fix works for setLockMode() but still need implementation to protect getLockMode(). See my previous comment.&lt;/p&gt;

&lt;p&gt;Thanks for getting this in so quickly.&lt;br/&gt;
Albert Lee. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 12 Nov 2009 07:24:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161648</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt5of:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204100</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>