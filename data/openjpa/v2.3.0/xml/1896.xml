<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:42:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1896/OPENJPA-1896.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1896] OpenJPA cannot store POJOs if a corresponding record already exists</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1896</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;If a POJO is created using a java constructor, merge() cannot store the newly constructed object&apos;s data if this means updating a pre-existing record with a matching identity.&lt;/p&gt;

&lt;p&gt;This is a major bug since it means applications where the objects have a natural key cannot use OpenJPA. In my case the example was a filesystem; each crawl of the filesystem generates its own data objects with file path as the natural key. These objects then need to be stored into the database. Previous crawls may have encountered the same files, and the merge operation should cause the latest data from the POJO to be stored in the pre-existing record.&lt;/p&gt;

&lt;p&gt;Instead, any attempt to execute either merge() or persist() on an independently constructed object with a matching record identity in the database triggers the same error in the database layer, since OpenJPA attempts to execute an insert for a pre-existing primary key, throwing...&lt;br/&gt;
org.apache.openjpa.lib.jdbc.ReportingSQLException: ERROR: duplicate key value violates unique constraint &quot;file_pkey&quot; &lt;/p&gt;
{prepstmnt 32879825 INSERT INTO file (locationString, location, version, folder) VALUES (?, ?, ?, ?)  [params=?, ?, ?, ?]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=0, state=23505&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;From discussion with Rick Curtis on the users@openjpa.apache.org list, this is because the version field on a POJO which is unmanaged is not yet set. &lt;/p&gt;

&lt;p&gt;An ASSUMPTION seems to be made that no such record exists in the database already since it wasn&apos;t loaded from the database in the first place, so a persist is attempted. Instead, I recommend the database is QUERIED TO FIND OUT if such a record already exists, and the version field is set correspondingly before attempting the merge() &lt;/p&gt;

&lt;p&gt;Here is the corresponding thread containing Ricks comments and links to an example in Github which can recreate the problem.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://bit.ly/hfPjTI&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://bit.ly/hfPjTI&lt;/a&gt;&lt;/p&gt;</description>
                <environment>Eclipse, Sun Java 1.6, Ubuntu Lucid, Guice JPAPersistModule, build-time enhance.xml</environment>
        <key id="12480685">OPENJPA-1896</key>
            <summary>OpenJPA cannot store POJOs if a corresponding record already exists</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curtisr7">Rick Curtis</assignee>
                                    <reporter username="cefn">Cefn Hoile</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Nov 2010 16:32:43 +0000</created>
                <updated>Thu, 2 Feb 2012 17:01:24 +0000</updated>
                            <resolved>Mon, 10 Jan 2011 22:11:27 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.1.0</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12934883" author="cefn" created="Tue, 23 Nov 2010 16:37:19 +0000"  >&lt;p&gt;I&apos;ve changed the link to the mailing list thread above to be something which Jira&apos;s smart formatting doesn&apos;t break through incompetent parsing. &lt;/p&gt;

&lt;p&gt;So...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://bit.ly/hfPjTI&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://bit.ly/hfPjTI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...was previously...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/openjpa-users/201011.mbox/%3CAANLkTi=tzs-nB6+NQQJmUcfbpCF_kzPnhOtLkYHvH+bM@mail.gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/openjpa-users/201011.mbox/%3CAANLkTi=tzs-nB6+NQQJmUcfbpCF_kzPnhOtLkYHvH+bM@mail.gmail.com%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12973367" author="curtisr7" created="Mon, 20 Dec 2010 21:22:48 +0000"  >&lt;p&gt;Cefn -&lt;/p&gt;

&lt;p&gt;Please try to merge this patch on top of your current openjpa jar. Please let me know if this fixes your problem... I&apos;m not very excited about this approach, but I&apos;ll think about it while you try it out.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="12973548" author="cefn" created="Tue, 21 Dec 2010 10:38:17 +0000"  >&lt;p&gt;Sorry to let you down, Rick. I can&apos;t easily verify the patch. I no longer have a codebase incorporating OpenJPA as I switched to Hibernate. This bug just seemed too major to me, and made me wonder what else I would discover if I relied on OpenJPA.&lt;/p&gt;

&lt;p&gt;I appreciate the work you&apos;ve put in, and I hope it helps supporting other OpenJPA users who want to use POJOs with natural keys as the project gets wider adoption. I like a lot of the features which OpenJPA adds on top of JPA, but standards conformance is more important for the future of our project (switching easily between persistence frameworks). &lt;/p&gt;

&lt;p&gt;Focusing just on JPA functionality I found the OpenJPA enhancement process really complex and likely to introduce issues in deployment, (Hibernate just worked). However, this merge bug was the clincher because of the domain we&apos;re working on.&lt;/p&gt;</comment>
                            <comment id="12974211" author="curtisr7" created="Wed, 22 Dec 2010 14:21:59 +0000"  >&lt;p&gt;Cefn -&lt;/p&gt;

&lt;p&gt;Well that sucks that you&apos;re leaving for hibernate... but I understand that you have a job that needs to get done. I&apos;ll be sure to have this one fixed so things are working when you give us another try in the future. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="12974341" author="curtisr7" created="Wed, 22 Dec 2010 19:17:33 +0000"  >&lt;p&gt;This required two changes to get everything working :&lt;/p&gt;

&lt;p&gt;1.] I updated the enhancer (PCEnhancer) so that when we are writing pcIsDetached() if we can&apos;t make a definitive answer, to return null. When merging an Entity and we don&apos;t know if it is detached, we will query for the Entity to see if we need to issue an UPDATE or an INSERT.&lt;/p&gt;

&lt;p&gt;2.] *Note - This is the part that I&apos;m not very excited about.... &lt;/p&gt;

&lt;p&gt;This change is required for an Entity which has a primitive @Version field. After applying fix &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; we now query the DB to see if these Entities exist. Now that we know that we&apos;re going to need to do an update, we look at the version field to see if the value is different than those in the DB. In the case of a non-primitive version field, it will be null and we know that it wasn&apos;t set. &lt;/p&gt;

&lt;p&gt;In the case of a primitive field, it will be initialized to the types default value. If the current version is greater than the default for the type we will incorrectly throw on optimistic lock exception. To fix the problem I was able to peer inside the Entity and check the value of the pcVersionInit field(added by the Enhancer to detect whether the version field was set, or if it is a default value). Unfortunately the value of this field isn&apos;t exposed on the PersistenceCapeable interface, so I had to use reflection.&lt;/p&gt;

&lt;p&gt;After thinking some more about this, I have an edge case that I can&apos;t fix...&lt;/p&gt;

&lt;p&gt;Lets say I have an Entity with an int version column and for whatever reason the value is 0. Now we find an Entity and stream it out to client 1. Next another client modifies that row so the version gets incremented to 1. Client 1 updates that data and sends it back to the server. At this time we have no state manager and we try to merge it back into the persistence context. This is the problem. We &lt;b&gt;should&lt;/b&gt; get an OLE here because the current Entity has a version of 0 but the DB has a version of 1. We don&apos;t get an OLE because we will assume that the value of the version column is a defaulted value, not one that was actually set there. Make sense?&lt;/p&gt;

&lt;p&gt;The net of this is that we should tell users to either make sure their version columns start with a value greater than 0, or to use non primitive types.&lt;/p&gt;</comment>
                            <comment id="12980280" author="curtisr7" created="Tue, 11 Jan 2011 19:31:47 +0000"  >&lt;p&gt;Committed changes to 2.1.x and trunk.&lt;/p&gt;</comment>
                            <comment id="13198954" author="allee8285" created="Thu, 2 Feb 2012 17:01:24 +0000"  >&lt;p&gt;Close issue in preparation for 2.2.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12466659" name="openjpa-1896.jar" size="125109" author="curtisr7" created="Mon, 20 Dec 2010 21:22:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 20 Dec 2010 21:22:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>162125</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7oyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>289013</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>