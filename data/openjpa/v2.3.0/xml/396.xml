<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:31:08 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-396/OPENJPA-396.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-396] Cloning Calendar proxies doesn&apos;t detach from StateManager</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-396</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;This problem was first discussed on our dev mailing list:  &lt;a href=&quot;http://www.nabble.com/Cloning-Calendar-proxies-tf4571181.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Cloning-Calendar-proxies-tf4571181.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Per the discussion on that thread, I am proposing to modify the generated proxy code to override the clone() method.  This clone() method will do the necessary copying of data from the original object, but then also null out the sm (StateManager) and zero out the field attributes.  This action detaches the cloned object from the StateManager (and associated EntityManager).&lt;/p&gt;

&lt;p&gt;Instead of limiting this action to the Calendar proxy, I am adding the clone() method implementation to all of our proxy objects that we generate.  Granted, some of the object types do not directly support the clone() method, but that will be detected when or if anybody attempts to use the clone() method on these types (compiler generated error message).&lt;/p&gt;

&lt;p&gt;I&apos;ll be posting a patch shortly and I plan to commit the changes later today (unless there is opposition).&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Kevin&lt;/p&gt;</description>
                <environment></environment>
        <key id="12379870">OPENJPA-396</key>
            <summary>Cloning Calendar proxies doesn&apos;t detach from StateManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwsutter">Kevin Sutter</assignee>
                                    <reporter username="kwsutter">Kevin Sutter</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Oct 2007 15:14:22 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:40 +0000</updated>
                            <resolved>Tue, 9 Oct 2007 15:29:38 +0100</resolved>
                                    <version>1.0.0</version>
                    <version>1.0.1</version>
                    <version>1.1.0</version>
                                    <fixVersion>1.0.1</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>kernel</component>
                        <due>Mon, 8 Oct 2007 07:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12533137" author="kwsutter" created="Mon, 8 Oct 2007 15:52:09 +0100"  >&lt;p&gt;Proposed patch for OpenJPA-396.  It was built against the 1.0.x branch, but also seems to work with the trunk (1.1.0).&lt;/p&gt;

&lt;p&gt;When testing this patch, I found that TestProxyManager had a couple of problems that needed correcting.  After these changes were made, I had to re-factor a few of the &quot;assert&quot; methods so that we were testing for proper equality when copying vs cloning.  That&apos;s why the patch for TestProxyManager looks larger than expected.&lt;/p&gt;

&lt;p&gt;I plan to commit these changes later today unless concerns are raised with the patch.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Kevin&lt;/p&gt;</comment>
                            <comment id="12533167" author="clr" created="Mon, 8 Oct 2007 18:25:05 +0100"  >&lt;p&gt;Hi Kevin,&lt;/p&gt;

&lt;p&gt;One question. In the generated clone method, after calling super.clone(), why do you not simply invoke stateManager = null; pcState = 0; instead of calling the setOwner(null, 0) method?&lt;/p&gt;

&lt;p&gt;Seems like there is additional code in setOwner that you want to avoid because there is not yet any relationship between the owner and the sco. The effect of calling this method from the clone might be to disassociate the original sco.&lt;/p&gt;</comment>
                            <comment id="12533169" author="kwsutter" created="Mon, 8 Oct 2007 18:52:42 +0100"  >&lt;p&gt;[ Show &#187; ]&lt;br/&gt;
Craig Russell - 08/Oct/07 10:25 AM Hi Kevin, One question. In the generated clone method, after calling super.clone(), why do you not simply invoke stateManager = null; pcState = 0; instead of calling the setOwner(null, 0) method? Seems like there is additional code in setOwner that you want to avoid because there is not yet any relationship between the owner and the sco. The effect of calling this method from the clone might be to disassociate the original sco.&lt;/p&gt;

&lt;p&gt;Craig,&lt;br/&gt;
The original reason is that I couldn&apos;t figure out the proper serp invocations to just set those two fields.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Then, I found the setOwner method on the Proxy (also generated code) that did just what I was looking for.  So, it was more straight-forward to just call this method than to repeat the same code.&lt;/p&gt;

&lt;p&gt;As far as I can tell, the setOwner has no other side effects.  I am calling setOwner on the Proxy, not the StateManager.  The code is generated in the ProxyManagerImpl class (addProxyMethods method).  And, the javadoc for this method is as follows:&lt;/p&gt;

&lt;p&gt;    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Reset the state of the proxy, and set the owning instance of the&lt;/li&gt;
	&lt;li&gt;proxy and the name of the field it is assigned to. Set to null to&lt;/li&gt;
	&lt;li&gt;indicate that the proxy is no longer managed.&lt;br/&gt;
     */&lt;br/&gt;
    public void setOwner(OpenJPAStateManager sm, int field);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12533175" author="clr" created="Mon, 8 Oct 2007 19:08:36 +0100"  >&lt;p&gt;&amp;gt; As far as I can tell, the setOwner has no other side effects.&lt;/p&gt;

&lt;p&gt;I hope someone else can comment on this, as it doesn&apos;t seem right. You don&apos;t want to &amp;lt;allow&amp;gt; any code in the clone to access the StateManager, since the StateManager knows about the original and can&apos;t tell from the APIs which proxy is calling it.&lt;/p&gt;

&lt;p&gt;I think we&apos;re asking for trouble, either now or in future if we call this method from the clone.&lt;/p&gt;</comment>
                            <comment id="12533191" author="clr" created="Mon, 8 Oct 2007 20:38:57 +0100"  >&lt;p&gt;One other comment:&lt;/p&gt;

&lt;p&gt;In openjpa-kernel/src/test/java/org/apache/openjpa/util/TestProxyManager.java,&lt;/p&gt;

&lt;p&gt;+    private static void assertSortedSetsEquals(SortedSet s1, SortedSet s2) {&lt;br/&gt;
...&lt;br/&gt;
+        assertTrue(s1.equals(s2));&lt;/p&gt;

&lt;p&gt;I&apos;m curious what this is testing, after you verified that the comparators are equivalent, the sizes are the same, and the contents are identical. What else is being tested here, except that the equals method is implemented correctly? Is that it? &lt;/p&gt;</comment>
                            <comment id="12533193" author="kwsutter" created="Mon, 8 Oct 2007 20:54:22 +0100"  >&lt;p&gt;[ Show &#187; ]&lt;br/&gt;
Craig Russell - 08/Oct/07 12:38 PM One other comment: In openjpa-kernel/src/test/java/org/apache/openjpa/util/TestProxyManager.java, + private static void assertSortedSetsEquals(SortedSet s1, SortedSet s2) { ... + assertTrue(s1.equals(s2)); I&apos;m curious what this is testing, after you verified that the comparators are equivalent, the sizes are the same, and the contents are identical. What else is being tested here, except that the equals method is implemented correctly? Is that it?&lt;/p&gt;

&lt;p&gt;Correct.  The original problem surfaced because of a .equals() invocation between two Calendar objects.  So, even though the Javadoc explains what attributes of a given Calendar, Date, Time, etc object are examined for .equals(), I just wanted to ensure that we didn&apos;t hit this problem again in the future because some JVM decided to change their implementation.&lt;/p&gt;</comment>
                            <comment id="12533375" author="kwsutter" created="Tue, 9 Oct 2007 15:29:38 +0100"  >&lt;p&gt;Resolved via svn revision #582974 for both the 1.0.1 and 1.1.0 branches.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12367265" name="OPENJPA-396.patch" size="7056" author="kwsutter" created="Mon, 8 Oct 2007 15:52:09 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 8 Oct 2007 17:25:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt60f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204154</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>