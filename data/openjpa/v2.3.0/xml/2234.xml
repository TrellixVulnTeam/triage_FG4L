<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:35:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2234/OPENJPA-2234.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2234] EntityManager instance creation needs TX activity</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2234</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;While working with Spring Data, we came across a potential bug in OpenJPA.&lt;/p&gt;

&lt;p&gt;The bug was provoked by a query lookup module in Spring Data JPA, but it has its roots in AbstractBrokerFactory class, which seems to require transaction existence in order to create EntityManager (which is contrary to JPA spec).&lt;/p&gt;

&lt;p&gt;I have already been in touch with Spring Data JPA author (where I filed a bug against Spring Data JPA) who actually pointed me to file a bug here.&lt;/p&gt;

&lt;p&gt;I have extensively documented my findings on this thread (&lt;a href=&quot;http://stackoverflow.com/questions/10688040/spring-data-jpa-fails-to-invoke-jtatransactionmanager&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://stackoverflow.com/questions/10688040/spring-data-jpa-fails-to-invoke-jtatransactionmanager&lt;/a&gt;), so I&apos;ll rather post the link, instead of repeating the whole thing here.&lt;/p&gt;

&lt;p&gt;All that being said, I am not entirely sure what actually happened and am no authority whatsoever on JPA spec.&lt;/p&gt;</description>
                <environment>- JDK 1.5&lt;br/&gt;
- Spring 3.1.1.RELEASE&lt;br/&gt;
- Spring Data JPA 1.1 GA (issue confirmed on version 1.0.3)&lt;br/&gt;
- Atomikos 3.7.0&lt;br/&gt;
- OpenJPA 2.0.1&lt;br/&gt;
- DB2 9.7&lt;br/&gt;
</environment>
        <key id="12599438">OPENJPA-2234</key>
            <summary>EntityManager instance creation needs TX activity</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curtisr7">Rick Curtis</assignee>
                                    <reporter username="erikkis">Erik Kis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Jul 2012 11:06:09 +0100</created>
                <updated>Tue, 16 Oct 2012 22:32:56 +0100</updated>
                            <resolved>Tue, 16 Oct 2012 22:32:56 +0100</resolved>
                                    <version>2.0.1</version>
                                    <fixVersion>2.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13418289" author="curtisr7" created="Thu, 19 Jul 2012 14:47:12 +0100"  >&lt;p&gt;Erik -&lt;/p&gt;

&lt;p&gt;Thanks for the thorough SO writeup. Unfortunately I think you&apos;re assessment of where the problems lies isn&apos;t quite correct. If you were to look at the OpenJPA code: &lt;/p&gt;

&lt;p&gt;    boolean syncWithManagedTransaction(BrokerImpl broker, boolean begin) {&lt;br/&gt;
        Transaction trans;&lt;br/&gt;
        try {&lt;br/&gt;
            ManagedRuntime mr = broker.getManagedRuntime();&lt;br/&gt;
            TransactionManager tm = mr.getTransactionManager();&lt;br/&gt;
            trans = tm.getTransaction(); &amp;lt;&amp;lt;&amp;lt; line 720&lt;/p&gt;

&lt;p&gt;you will notice that the NPE is coming from not having a TransactionManager, not that you don&apos;t have a transaction.&lt;/p&gt;


&lt;p&gt;I see the following line in your persistence configuration :&lt;/p&gt;

&lt;p&gt;&amp;lt;entry key=&quot;openjpa.ManagedRuntime&quot; value=&quot;invocation(TransactionManagerMethod=com.atomikos.icatch.jta.TransactionManagerImp.getTransactionManager)&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;We can start out with an easy one, is the getTransactionManager method static? If not, try changing that.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="13419104" author="erikkis" created="Fri, 20 Jul 2012 13:59:09 +0100"  >&lt;p&gt;Hello, Rick, thanks for your quick response.&lt;/p&gt;

&lt;p&gt;Regarding persistence configuration, I&apos;ve checked - getTransactionManager() method &lt;em&gt;is&lt;/em&gt; static.&lt;/p&gt;

&lt;p&gt;Regarding problem assessment - I agree with you; I&apos;ve actually noticed that Spring doesn&apos;t set the TransactionManager (PlatformTransactionManager&apos;s setter is not invoked), hence we get NPE@line 720. The problem happens while bootstrapping Spring application context - more specifically, while Spring Data JPA performs query lookup. Now, if you were to check comments in SO writeup, you&apos;ll notice that in correspondence with Oliver Gierke (Spring Data JPA project lead), he had stated that OpenJPA is actually not conforming here to JPA specification, since by JPA spec, no tx activity is needed during query creation (i.e. while executing entityManager.createQuery(...)).&lt;/p&gt;

&lt;p&gt;As I said, I am far from understanding every nook and cranny in any of the participating modules (be it OpenJPA, Spring Data JPA or the JPA2 specification itself), however, his arguments do seem convincing, at least to me.&lt;/p&gt;

&lt;p&gt;Is there anything else we could try?&lt;/p&gt;</comment>
                            <comment id="13419259" author="curtisr7" created="Fri, 20 Jul 2012 16:32:21 +0100"  >&lt;p&gt;The root issue is that you configured OpenJPA to call com.atomikos.icatch.jta.TransactionManagerImp.getTransactionManager() to get a TransactionManager instance and that method returned null. &lt;/p&gt;

&lt;p&gt;The OpenJPA runtime requires that we have a TransactionManager (Not a transaction, just a manager) to function properly. I believe Oliver is incorrect in stating that we&apos;re in violation of the spec in this regards.&lt;/p&gt;

&lt;p&gt;&amp;gt; Is there anything else we could try? &lt;br/&gt;
Perhaps Oliver could help you/us understand why you have the configuration you do, and why it is returning a null TransactionManager?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="13455059" author="oliver.gierke" created="Thu, 13 Sep 2012 18:47:45 +0100"  >&lt;p&gt;I didn&apos;t suspect OpenJPA to violate the spec. All I was stumbling above was that apparently the EntityManagerFactory bootstrap code tries to access a TransactionManager which effectively can&apos;t be in place at that time as usually the Txmanager works with the EntityManagerFactory in turn. At least OpenJPA behaves very different compared to other JPA providers and I wondered why this early TxManager lookup is required.&lt;/p&gt;</comment>
                            <comment id="13457144" author="curtisr7" created="Mon, 17 Sep 2012 17:50:21 +0100"  >&lt;p&gt;&amp;gt; that apparently the EntityManagerFactory bootstrap code tries to access a TransactionManager which effectively can&apos;t be in place at that time as usually the Txmanager works with the EntityManagerFactory in turn.&lt;br/&gt;
I don&apos;t follow your comment? The exception occurs at EntityManager creation, not EntityManagerFactory.&lt;/p&gt;</comment>
                            <comment id="13472296" author="curtisr7" created="Tue, 9 Oct 2012 13:13:43 +0100"  >&lt;p&gt;Closing as invalid. Please reopen with additional data if you disagree.&lt;/p&gt;</comment>
                            <comment id="13472349" author="oliver.gierke" created="Tue, 9 Oct 2012 14:07:33 +0100"  >&lt;p&gt;How is the TransactionManager expected to be set on the EntityManagerFactory then? I cannot see any API on EntityManagerFactoryImpl which could have been invoked. I&apos;d also argue that the implementation should shield against the transaction manager being null more explicitly if it is mandatory rather than throwing a generic NPE. There seems to be a configuration/setup error by the user and that should be communicated.&lt;/p&gt;</comment>
                            <comment id="13472358" author="romain.manni-bucau" created="Tue, 9 Oct 2012 14:18:56 +0100"  >&lt;p&gt;Hi Olivier, it is done thanks to the managed runtime&lt;/p&gt;

&lt;p&gt;just configure &amp;lt;entry key=&quot;openjpa.ManagedRuntime&quot; value=&quot;invocation(TransactionManagerMethod=foo.TxMgrHolder.getTransactionManager)&quot; /&amp;gt; &lt;/p&gt;

&lt;p&gt;for spring you can return a proxy which will get the tx mgr from the app ctx - btw then you&apos;ll need to deal with spring/openjpa lifecycle&lt;/p&gt;</comment>
                            <comment id="13472373" author="curtisr7" created="Tue, 9 Oct 2012 14:44:22 +0100"  >&lt;p&gt;&amp;gt; I&apos;d also argue that the implementation should shield against the transaction manager being null more explicitly if it is mandatory rather than throwing a generic NPE.&lt;br/&gt;
Agreed. I&apos;ll add that sometime this morning.&lt;/p&gt;</comment>
                            <comment id="13472381" author="erikkis" created="Tue, 9 Oct 2012 14:52:13 +0100"  >&lt;p&gt;&amp;gt; Hi Olivier, it is done thanks to the managed runtime....&lt;/p&gt;

&lt;p&gt;Hello, Romain, if you check the StackOverflow link in the problem description, you&apos;ll notice that ManagedRuntime property has indeed been set, but had not prevented NPE from being thrown.&lt;/p&gt;</comment>
                            <comment id="13472385" author="romain.manni-bucau" created="Tue, 9 Oct 2012 14:55:55 +0100"  >&lt;p&gt;this means spring is not started, just need to be started before&lt;/p&gt;</comment>
                            <comment id="13472421" author="curtisr7" created="Tue, 9 Oct 2012 15:25:09 +0100"  >&lt;p&gt;Committed revision 1396043 to trunk.&lt;/p&gt;

&lt;p&gt;Now we&apos;ll throw the following exception when we encounter a nullTransactionManager.&lt;/p&gt;

&lt;p&gt;&amp;lt;openjpa-2.3.0-SNAPSHOT-r422266:1393779M fatal internal error&amp;gt; org.apache.openjpa.util.InternalException: Received a null javax.transaction.TransactionManager from the openjpa.ManagedRuntime &quot;org.apache.openjpa.ee.TestNullTransactionManagerFromRuntime$ManagedRuntimeNullTransactionManager@64686468&quot;.&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.syncWithManagedTransaction(AbstractBrokerFactory.java:727)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.initialize(BrokerImpl.java:391)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.initialize(BrokerImpl.java:325)&lt;/p&gt;</comment>
                            <comment id="13472524" author="erikkis" created="Tue, 9 Oct 2012 17:35:52 +0100"  >&lt;p&gt;Thx, Rick for this - I just wonder is there any way to recover from this exception? Also, is there any chance of backporting this to 2.0.x branch?&lt;/p&gt;</comment>
                            <comment id="13472626" author="curtisr7" created="Tue, 9 Oct 2012 19:48:15 +0100"  >&lt;p&gt;Erik - Honestly, I&apos;m not aware of any way to recover. I suspect I could log a warning, but other parts of the runtime would blow chunks with a similar NPE due to the missing TM. It seemed safer to detect this condition and fail fast.&lt;/p&gt;

&lt;p&gt;It is unlikely that this change will make it into 2.0.x as that is a WebSphere managed branch... but I&apos;ll shoot a note to the branch owner to see what he thinks.&lt;/p&gt;</comment>
                            <comment id="13477369" author="curtisr7" created="Tue, 16 Oct 2012 22:32:49 +0100"  >&lt;p&gt;I talked with the branch owner and he said that to get this change into 2.0.x you&apos;d need to go through WebSphere support and get PMR opened to get the thumbs up to merge this change.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 19 Jul 2012 13:47:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240132</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxus27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3365</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>