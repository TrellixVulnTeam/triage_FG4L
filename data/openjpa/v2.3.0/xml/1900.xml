<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:38:24 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1900/OPENJPA-1900.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1900] ClassCastException when serializing an entity if DetachedStateField=true</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1900</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;When using &lt;/p&gt;

&lt;p&gt;&amp;lt;property name=&quot;openjpa.DetachState&quot; value=&quot;fetch-groups(DetachedStateField=true)&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;serializing an entity leads to the following Exception:&lt;/p&gt;

&lt;p&gt;java.lang.ClassCastException: org.apache.openjpa.kernel.StateManagerImpl cannot be cast to org.apache.openjpa.kernel.DetachedStateManager&lt;br/&gt;
	at org.apache.openjpa.util.Proxies.writeReplace(Proxies.java:147)&lt;br/&gt;
	at org.apache.openjpa.util.java$util$Date$proxy.writeReplace(Unknown Source)&lt;br/&gt;
	at sun.reflect.GeneratedMethodAccessor176.invoke(Unknown Source)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at java.io.ObjectStreamClass.invokeWriteReplace(ObjectStreamClass.java:1032)&lt;br/&gt;
	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1107)&lt;br/&gt;
	at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:326)&lt;br/&gt;
	at org.apache.openjpa.kernel.SingleFieldManager.serialize(SingleFieldManager.java:545)&lt;br/&gt;
	at org.apache.openjpa.kernel.StateManagerImpl.writeDetached(StateManagerImpl.java:1478)&lt;br/&gt;
	at at.ac.tuwien.tiss.curriculum.be.entities.CurriculumVersion.writeExternal(CurriculumVersion.java)&lt;br/&gt;
	at java.io.ObjectOutputStream.writeExternalData(ObjectOutputStream.java:1421)&lt;/p&gt;

&lt;p&gt;This seems related to &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1597&quot; title=&quot;Need Compatibility setting for new OPENJPA-1097 Proxies and DetachedStateField behavior&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1597&quot;&gt;&lt;del&gt;OPENJPA-1597&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12491624">OPENJPA-1900</key>
            <summary>ClassCastException when serializing an entity if DetachedStateField=true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curtisr7">Rick Curtis</assignee>
                                    <reporter username="struberg">Mark Struberg</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Nov 2010 09:20:13 +0000</created>
                <updated>Thu, 2 Feb 2012 17:02:01 +0000</updated>
                            <resolved>Fri, 17 Dec 2010 12:20:45 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.1.0</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12965662" author="struberg" created="Wed, 1 Dec 2010 11:16:05 +0000"  >&lt;p&gt;I was still not able to reproduce this in a unit test, but from debugging my real world app it seems to happen when lazy loaded entities get serialized.&lt;/p&gt;</comment>
                            <comment id="12966067" author="struberg" created="Thu, 2 Dec 2010 11:19:07 +0000"  >&lt;p&gt;I tried to reproduce my problem with an unit test but had no luck so far. But the test now crashes with another issue.&lt;/p&gt;

&lt;p&gt;testSerialization(org.apache.openjpa.persistence.proxy.TestEntitySerialize)  Time elapsed: 14.822 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.openjpa.persistence.proxy.TestEntitySerialize.testSerialization(TestEntitySerialize.java:104)&lt;/p&gt;


&lt;p&gt;The situation:&lt;br/&gt;
I added a &apos;previousAnnuity&apos; to reflect the existence of a annuity predecessor. &lt;br/&gt;
The data I create is a FixedAnnuity which gets superceeded by an EquityAnnuity.&lt;br/&gt;
I then load the last annuity (the EquityAnnuity) in one transaction. While having the EntityManager open, the previousAnnuity is available. But if I close the EntityManager, it suddenly dissapears (field get&apos;s reset to null).&lt;/p&gt;

&lt;p&gt;Is this a spec like behaviour that entity members get deleted while closing the EntityManager?&lt;/p&gt;</comment>
                            <comment id="12966085" author="struberg" created="Thu, 2 Dec 2010 12:24:49 +0000"  >&lt;p&gt;actually it was my error, forgot to @OneToOne the field ... &lt;b&gt;slap&lt;/b&gt;,  &lt;b&gt;coffeerefill&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="12966249" author="struberg" created="Thu, 2 Dec 2010 19:53:27 +0000"  >&lt;p&gt;think I know the difference between the openjpa-persistence-jdbc and my projects config. I use the openjpa-maven-plugin for enhancing my project and I get the Externalizable interface generated into my enhanced classes. This doesn&apos;t happen with the Annuity entities.&lt;/p&gt;

&lt;p&gt;But the problem above only happens if StateManagerImpl#writeDetached get&apos;s invoked on an entity which is linked to multiple other entites...&lt;/p&gt;

&lt;p&gt;Question: why do I get the Externalizable interface in my entities?&lt;/p&gt;</comment>
                            <comment id="12966269" author="struberg" created="Thu, 2 Dec 2010 20:31:31 +0000"  >&lt;p&gt;The Externalizable field gets added if I use the openjpa.DetachStage fetch-groups(DetachStateField=true)&lt;/p&gt;

&lt;p&gt;This is an issues in our test suite currently - it uses different persistence.xml for enhancing ($&lt;/p&gt;
{project.build.testOutputDirectory}
&lt;p&gt;/META-INF/nopriv_persistence.xml) and running the tests (org/apache/openjpa/persistence/proxy/persistence1.xml)&lt;/p&gt;

&lt;p&gt;Thus my test currently succeeds but only because this isn&apos;t a real world scenario.&lt;/p&gt;

&lt;p&gt;PS: took me a while to figure this, but at least I&apos;m now pretty deep into OpenJPA internals &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12966271" author="struberg" created="Thu, 2 Dec 2010 20:40:48 +0000"  >&lt;p&gt;this small patch fixes the behaviour. This needs a review of course, because I might have overseen some side effects... &lt;/p&gt;</comment>
                            <comment id="12971881" author="curtisr7" created="Wed, 15 Dec 2010 23:00:50 +0000"  >&lt;p&gt;Good work on this one. I just looked at your patches and you had to dig pretty deep to figure this out out. &lt;/p&gt;

&lt;p&gt;I have a few comments for you. I was able to recreate the CCE, but after applying the code fix I fail with a NPE coming from test code&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. I&apos;m not sure why that field is null but I&apos;m guessing it has something to do with the DetachState setting. If I change fgs to loaded the NPE goes away.... Are you seeing the same benaviour?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;:407 ann.getPreviousAnnuity().setApprovedAt( new Date() ); &amp;#8211; getPreviousAnnuity() returns null&lt;/p&gt;</comment>
                            <comment id="12972128" author="curtisr7" created="Thu, 16 Dec 2010 16:10:28 +0000"  >&lt;p&gt;Mark -&lt;/p&gt;

&lt;p&gt;It looks like I should have read through all of your comments... I added @OneToOne to Annuity.getPreviousAnnuity() and things are looking better now.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="12972130" author="struberg" created="Thu, 16 Dec 2010 16:12:53 +0000"  >&lt;p&gt;Hi Rick! I&apos;m currently compiling, so gimme an hour &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I&apos;m online in #openjpa on freenode.&lt;/p&gt;</comment>
                            <comment id="12972462" author="curtisr7" created="Fri, 17 Dec 2010 12:20:45 +0000"  >&lt;p&gt;Resolved in 2.1.x and trunk.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Mark!&lt;/p&gt;</comment>
                            <comment id="13198956" author="allee8285" created="Thu, 2 Feb 2012 17:02:01 +0000"  >&lt;p&gt;Close issue in preparation for 2.2.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12465166" name="OPENJPA-1900-fix.patch" size="804" author="struberg" created="Thu, 2 Dec 2010 20:40:48 +0000"/>
                            <attachment id="12465129" name="OPENJPA-1900-test-1.patch" size="14477" author="struberg" created="Thu, 2 Dec 2010 11:19:07 +0000"/>
                            <attachment id="12466397" name="OPENJPA-1900.patch" size="16956" author="curtisr7" created="Thu, 16 Dec 2010 18:07:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 15 Dec 2010 23:00:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>162127</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7oy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>289012</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>