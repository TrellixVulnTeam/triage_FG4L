<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:35:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1483/OPENJPA-1483.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1483] count (Distinct e) in JPQL gives wrong result when the id field is a compound primary key</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1483</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;This is a fundamental problem with count when compound primary key is involved. &lt;/p&gt;

&lt;p&gt;	(1) If no relation navigation is involved:&lt;br/&gt;
	String jpql = &quot;SELECT COUNT (DISTINCT e) FROM G2 e&quot;;&lt;/p&gt;

&lt;p&gt;	With the property below:&lt;br/&gt;
	&amp;lt;property name=&quot;openjpa.jdbc.DBDictionary&quot;&lt;br/&gt;
		value=&quot;db2(useWildCardForCount=true)&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;	Openjpa will generate the following sql and return the correct count:&lt;/p&gt;

&lt;p&gt;	SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM G2 t0  optimize for 1 row&lt;/p&gt;

&lt;p&gt;	(2) If there is relation navigation invloved:&lt;br/&gt;
	String jpql = &quot;SELECT COUNT (DISTINCT f1.g2) FROM F1 f1&quot;;&lt;/p&gt;

&lt;p&gt;	The property of useWildCardForCount will not generate correct sql with right result. However, given the object-relational impedance mismatch, there is no corresponding SQL construct for count of multiple primary keys, and there is no clean and generic solution to solve this problem. The only workaround is to use native SQL with table expression:&lt;/p&gt;

&lt;p&gt;	SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
	FROM (SELECT DISTINCT G1.G1PK, G1.G2PK 	FROM F1 t0 INNER JOIN G2 t1 ON t0.G1PK = t1.G1PK AND t0.G2PK = t1.G2PK)) TX;	&lt;/p&gt;

&lt;p&gt;	Rather than giving a wrong answer, OpenJPA should give an Unsupported exception.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12446713">OPENJPA-1483</key>
            <summary>count (Distinct e) in JPQL gives wrong result when the id field is a compound primary key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="faywang">Fay Wang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jan 2010 18:36:06 +0000</created>
                <updated>Mon, 3 May 2010 17:16:46 +0100</updated>
                            <resolved>Tue, 9 Feb 2010 18:30:11 +0000</resolved>
                                    <version>2.0.0-beta</version>
                                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0-beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12805976" author="faywang" created="Thu, 28 Jan 2010 16:38:52 +0000"  >&lt;p&gt;Limited support for count(distinct compound key) will be supported when count(compound primary key) appears in the projection list. This projection list will have only one projection item, ie, count, in it.  OpenJPA will use generate the following SQL: &lt;/p&gt;

&lt;p&gt;(1) &lt;br/&gt;
String jpql = &quot;SELECT COUNT (DISTINCT e) FROM G2 e&quot;;&lt;br/&gt;
generated SQL: &lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM G2 t0&lt;/p&gt;

&lt;p&gt;(2) &lt;br/&gt;
String jpql = &quot;SELECT COUNT (DISTINCT f1.g2) FROM F1 f1&quot;; &lt;br/&gt;
generated SQL:&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM (SELECT DISTINCT G1.G1PK, G1.G2PK FROM F1 t0 INNER JOIN G2 t1 ON t0.G1PK = t1.G1PK AND t0.G2PK = t1.G2PK) &lt;/p&gt;

&lt;p&gt;For count(compound key), OpenJPA will generate count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; in the SQL.&lt;/p&gt;

&lt;p&gt;An unsupported exception will be thrown in all other situations.&lt;/p&gt;</comment>
                            <comment id="12806583" author="faywang" created="Sat, 30 Jan 2010 00:43:09 +0000"  >&lt;p&gt;The patch will produce the following sql:&lt;/p&gt;

&lt;p&gt;(1) &quot;select count (distinct f1) from F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM (SELECT  DISTINCT t0.F1PK, t0.F2PK FROM F1 t0 ) s  optimize for 1 row&lt;/p&gt;

&lt;p&gt;(2) &quot;select count (distinct f1.pk) from F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM (SELECT  DISTINCT t0.F1PK, t0.F2PK FROM F1 t0 ) s  optimize for 1 row&lt;/p&gt;

&lt;p&gt;(3)&quot;SELECT COUNT (DISTINCT f1.g2) FROM F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM (SELECT  DISTINCT t1.G1PK, t1.G2PK FROM F1 t0 INNER JOIN G2 t1 ON t0.G1PK = t1.G1PK AND t0.G2PK = t1.G2PK ) s  optimize for 1 row&lt;/p&gt;

&lt;p&gt;(4) &quot;SELECT COUNT (DISTINCT f1.g2.pk) FROM F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM (SELECT  DISTINCT t1.G1PK, t1.G2PK FROM F1 t0 INNER JOIN G2 t1 ON t0.G1PK = t1.G1PK AND t0.G2PK = t1.G2PK ) s  optimize for 1 row&lt;/p&gt;

&lt;p&gt;(5)&quot;select count (f1) from F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM F1 t0  optimize for 1 row&lt;/p&gt;

&lt;p&gt;(6)&quot;select count (f1.pk) from F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM F1 t0  optimize for 1 row&lt;/p&gt;

&lt;p&gt;(7) &quot;SELECT COUNT (f1.g2) FROM F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM F1 t0 INNER JOIN G2 t1 ON t0.G1PK = t1.G1PK AND t0.G2PK = t1.G2PK  optimize for 1 row&lt;/p&gt;

&lt;p&gt;(8)&quot;SELECT COUNT (f1.g2.pk) FROM F1 f1&quot;,&lt;br/&gt;
SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM F1 t0 INNER JOIN G2 t1 ON t0.G1PK = t1.G1PK AND t0.G2PK = t1.G2PK  optimize for 1 row&lt;/p&gt;</comment>
                            <comment id="12806724" author="milosz" created="Sat, 30 Jan 2010 19:45:16 +0000"  >&lt;p&gt;Hi Fay, does your patch make useWildCardForCount property obsolete? I understand your description that with the patch we would always use wild card in SELECT COUNT. If so, we could remove the useWildCardForCount property in 2.1.0.&lt;/p&gt;</comment>
                            <comment id="12806777" author="faywang" created="Sun, 31 Jan 2010 02:58:15 +0000"  >&lt;p&gt;Since not all databases support common table expression, a DBDictioinary attribute &quot;supportsCommonTableExpression&quot; is introduced. A test case is also included to run on DB2. For those databases that do not support common table expression, openjpa will throw UnsupportedException instead of giving a misleading result for Count (Distinct compound PK).  &lt;/p&gt;</comment>
                            <comment id="12806778" author="faywang" created="Sun, 31 Jan 2010 03:02:15 +0000"  >&lt;p&gt;Hi Milosz,  no, we will not &lt;b&gt;always&lt;/b&gt; use Count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  for select count in all scenarios. The Count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; will be used only when  SELECT COUNT(compound PK). Could you please review  &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1483&quot; title=&quot;count (Distinct e) in JPQL gives wrong result when the id field is a compound primary key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1483&quot;&gt;&lt;del&gt;OPENJPA-1483&lt;/del&gt;&lt;/a&gt;-2.patch. Thanks!  &lt;/p&gt;</comment>
                            <comment id="12806792" author="milosz" created="Sun, 31 Jan 2010 08:35:41 +0000"  >&lt;p&gt;Hi Fay, of course, my question was wrong. I forgot you stated it clearly even in issue description that the problem is only with compound PKs. Sorry for the confusion.&lt;/p&gt;

&lt;p&gt;As for the reviewing the new patch - yes, I reviewed it but since this is you who is the expert in that matter, I am learning from the patch rather than judging &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I would only think these small issues:&lt;/p&gt;

&lt;p&gt;1. I think that by &quot;common table expression&quot; people usually mean &quot;WITH cte_name ... SELECT ... FROM cte_name ...&quot; syntax where this cte can also be recursive. What we need for counting compund PKs, is the database ability to execute subqueries in FROM clause. Thus, I would name the new property &quot;supportsSubselectInFrom&quot;. What do you think?&lt;/p&gt;

&lt;p&gt;2. We should document the new property in the user manual.&lt;/p&gt;

&lt;p&gt;3. When the patch is applied, it would be good to open a new issue to investigate the value of the new property for other databases. I believe quite many of them support subqueries in FROM clause.&lt;/p&gt;

&lt;p&gt;4. In the test case I would change&lt;/p&gt;

&lt;p&gt;+        if (!(dict instanceof DB2Dictionary)) &lt;br/&gt;
+            return;&lt;/p&gt;

&lt;p&gt;to testing the value of the new property. That way, the test case will automatically be executed also on other databases which have the support.&lt;/p&gt;
</comment>
                            <comment id="12828186" author="faywang" created="Mon, 1 Feb 2010 17:36:55 +0000"  >&lt;p&gt;Hi Milosz, thank you for pointing out this. Common table expression and table expression semantically are the same, but syntactically, they are quite different. For cte, you can define once and use it multiple times. it is like a function definition of a program. In this JIRA, it is table expression, but not common table expression that is required:&lt;/p&gt;

&lt;p&gt;SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
FROM (SELECT DISTINCT G1.G1PK, G1.G2PK&lt;br/&gt;
FROM F1 t0 INNER JOIN G2 t1 ON t0.G1PK = t1.G1PK AND t0.G2PK = t1.G2PK)) TX;&lt;/p&gt;
</comment>
                            <comment id="12828262" author="fancy" created="Mon, 1 Feb 2010 20:37:12 +0000"  >&lt;p&gt;Hi Fay,&lt;br/&gt;
1. for newly added unsupported messages, could you add message id to  localizer.properties ?&lt;br/&gt;
2. could you move the block of the code in JDBCStoreQuery that handles the isCountDistinctMultiCols to SelectConstructor.evaluate() so that kernel.exp.Count visibility remains private at package level ?&lt;/p&gt;</comment>
                            <comment id="12862930" author="jpaheath" created="Sat, 1 May 2010 00:39:40 +0100"  >&lt;p&gt;Added &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1483&quot; title=&quot;count (Distinct e) in JPQL gives wrong result when the id field is a compound primary key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1483&quot;&gt;&lt;del&gt;OPENJPA-1483&lt;/del&gt;&lt;/a&gt;-1.2.x.patch.txt for 1.2.x code and &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1483&quot; title=&quot;count (Distinct e) in JPQL gives wrong result when the id field is a compound primary key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1483&quot;&gt;&lt;del&gt;OPENJPA-1483&lt;/del&gt;&lt;/a&gt;-1.3.x.patch.txt for 1.3.x code, as their names imply. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12443346" name="OPENJPA-1483-1.2.x.patch.txt" size="26527" author="jpaheath" created="Sat, 1 May 2010 00:39:40 +0100"/>
                            <attachment id="12443347" name="OPENJPA-1483-1.3.x.patch.txt" size="25800" author="jpaheath" created="Sat, 1 May 2010 00:39:40 +0100"/>
                            <attachment id="12431896" name="OPENJPA-1483-2.patch" size="17351" author="faywang" created="Sun, 31 Jan 2010 02:58:15 +0000"/>
                            <attachment id="12431841" name="OPENJPA-1483.patch" size="12896" author="faywang" created="Sat, 30 Jan 2010 00:43:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 30 Jan 2010 19:45:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161747</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt4ev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>203895</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>