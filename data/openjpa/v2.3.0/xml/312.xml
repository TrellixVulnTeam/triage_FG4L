<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:40:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-312/OPENJPA-312.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-312] derby fails with duplicate primary key(s) in group by list</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-312</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;derby fails with duplicate primary key(s) in group by list&lt;/p&gt;

&lt;p&gt;With query &quot;select o.customer, avg(o.amount) from Order o group by o.customer&quot; the push-down query contains duplicate columns in the group by clause.  This is okay when DB2 and other DB that tolerate the duplicates but Derby returns error.&lt;/p&gt;

&lt;p&gt;Of course, we can ask fix on Derby but we can also easy fix in OpenJPA to avoid duplicates in the group by list.  Please refer to the following for the error result and the attach patch for the fix.&lt;/p&gt;

&lt;p&gt;Output from running the query that generate duplicate in the group by list:&lt;br/&gt;
6429  demo  TRACE  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; openjpa.Query - Executing query: select o.customer, avg(o.amount) from Order o group by o.customer&lt;br/&gt;
6639  demo  TRACE  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; openjpa.jdbc.SQL - &amp;lt;t 1094861122, conn 1639735740&amp;gt; executing prepstmnt 1405375428 SELECT t1.countryCode, t1.id, t1.version, t1.city, t1.state, t1.street, t1.zip, t1.creditRating, t1.name, AVG(t0.amount) FROM Order t0 INNER JOIN Customer t1 ON t0.customer_countryCode = t1.countryCode AND t0.customer_id = t1.id GROUP BY t1.countryCode, t1.id, t1.version, t1.countryCode, t1.id, t1.city, t1.state, t1.street, t1.zip, t1.countryCode, t1.id, t1.creditRating, t1.name &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12375716">OPENJPA-312</key>
            <summary>derby fails with duplicate primary key(s) in group by list</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dtlee">Daniel Lee</assignee>
                                    <reporter username="dtlee">Daniel Lee</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Aug 2007 02:43:10 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:37 +0000</updated>
                            <resolved>Thu, 16 Aug 2007 14:59:39 +0100</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.0.0</fixVersion>
                                    <component>sql</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12518889" author="dtlee" created="Fri, 10 Aug 2007 02:45:57 +0100"  >&lt;p&gt;The fix for OpenJPA-312.&lt;/p&gt;</comment>
                            <comment id="12519064" author="kwsutter" created="Fri, 10 Aug 2007 17:57:58 +0100"  >&lt;p&gt;Daniel,&lt;br/&gt;
The basic idea of the patch looks okay, but the code changes do not look consistent.  In some cases, you use &quot;sql&quot; and in others, you are using &quot;sql.getSQL()&quot;.  I would prefer just using &quot;sql&quot;.&lt;/p&gt;

&lt;p&gt;Also, you check for an empty _grouping after you check if the desired group sub-string is already present in the _grouping.  This seems backwards.  I know it&apos;s only being used to determine whether to use a comma or not.  So, instead of doing these extra empty checks, could we do something along the following.  I think this accomplishes the same goal.&lt;/p&gt;

&lt;p&gt;         getJoins(joins, true);&lt;br/&gt;
         if (_grouping == null) &lt;/p&gt;
{
             _grouping = new SQLBuffer(_dict);
             _grouping.append(sql);
        }
&lt;p&gt;        else if (_grouping.getSQL().indexOf(sql) &amp;lt; 0) &lt;br/&gt;
             _grouping.append(&quot;, &quot; + sql);&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Kevin&lt;/p&gt;
</comment>
                            <comment id="12519171" author="dtlee" created="Sat, 11 Aug 2007 01:00:39 +0100"  >&lt;p&gt;new fix&lt;/p&gt;</comment>
                            <comment id="12519456" author="kwsutter" created="Mon, 13 Aug 2007 17:20:39 +0100"  >&lt;p&gt;Daniel,&lt;br/&gt;
The code is much cleaner now.  Thanks.  But, I don&apos;t think the performance of StringTokenizer is worth any advantages it might provide.  Is there some reason why the previous mechanism of just using indexOf() wasn&apos;t sufficient?  I like the idea of isolating this check to a single boolean method like you have, but I would like to see a better performing implementation.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Kevin&lt;/p&gt;</comment>
                            <comment id="12520068" author="dtlee" created="Wed, 15 Aug 2007 20:14:45 +0100"  >&lt;p&gt;Per discussion conclusion, attached here is the patch of fix using a ListArray to keep track of the columns in _grouping.  StringTokenizer has been removed.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Daniel&lt;/p&gt;</comment>
                            <comment id="12520116" author="kwsutter" created="Wed, 15 Aug 2007 23:49:13 +0100"  >&lt;p&gt;Daniel, Thanks for the updated patch.  Per our side discussion, I am making a couple of slight changes to your patch, but the intent is still there.  Thanks for resolving this issue.  I will be committing the changes shortly.&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12520254" author="kwsutter" created="Thu, 16 Aug 2007 14:59:39 +0100"  >&lt;p&gt;Resolved via r566381.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12363879" name="OPENJPA-312.patch" size="3583" author="dtlee" created="Wed, 15 Aug 2007 20:15:38 +0100"/>
                            <attachment id="12363642" name="OPENJPA-312.patch" size="3534" author="dtlee" created="Sat, 11 Aug 2007 01:00:38 +0100"/>
                            <attachment id="12363548" name="OPENJPA-312.patch" size="2531" author="dtlee" created="Fri, 10 Aug 2007 02:45:57 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 10 Aug 2007 16:57:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160638</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7k9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>288252</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>