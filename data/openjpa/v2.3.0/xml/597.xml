<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:42:45 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-597/OPENJPA-597.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-597] JPQL delete query with an alias for tablename and without any further clauses gives an error on MySQL</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-597</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;If we have a JPQL query like this:&lt;br/&gt;
int countDeleted = em.createQuery(&apos;Delete from Person o&apos;).executeUpdate();&lt;/p&gt;

&lt;p&gt;We get an exception on MySQL because the converted SQL with an alias gives a syntax error :&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;testlogic&amp;#93;&lt;/span&gt; java.lang.Exception: org.apache.openjpa.lib.jdbc.ReportingSQLException: &lt;br/&gt;
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version &lt;br/&gt;
for the right syntax to use near &apos;&apos; at line 1 &lt;/p&gt;
{prepstmnt 2137108 DELETE FROM DYN_DESC_PERSON t0 [reused=0]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=1064, state=42000&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;testlogic&amp;#93;&lt;/span&gt; 	at org.apache.openjpa.util.Exceptions.replaceNestedThrowables(Exceptions.java:242)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;testlogic&amp;#93;&lt;/span&gt; 	at org.apache.openjpa.persistence.PersistenceException.writeObject(PersistenceException.java:100)&lt;/p&gt;

&lt;p&gt;For mySQL version 5.0 the MySQLDBDictionary defaults for supportsSubselect and allowsAliasInBulkClause are both true. For these params the DBDictionary.toBulkOperation() generates a sql like DELETE FROM DYN_DESC_PERSON t0 which does not work in mySQL. &lt;/p&gt;

&lt;p&gt;The syntax for DELETE statements that use table aliases changed between MySQL 4.0 and 4.1. In MySQL 4.0, you should use the true table name to refer to any table from which rows should be deleted: &lt;/p&gt;

&lt;p&gt;DELETE test FROM test AS t1, test2 WHERE ...&lt;br/&gt;
In MySQL 4.1, if you declare an alias for a table, you must use the alias when referring to the table: &lt;/p&gt;

&lt;p&gt;DELETE t1 FROM test AS t1, test2 WHERE ...&lt;/p&gt;</description>
                <environment>OpenJPA 1.1.0-SNAPSHOT&lt;br/&gt;
version id: openjpa-1.1.0-SNAPSHOT-r422266:653008&lt;br/&gt;
Apache svn revision: 422266:653008&lt;br/&gt;
&lt;br/&gt;
os.name: Windows XP&lt;br/&gt;
os.version: 5.1&lt;br/&gt;
os.arch: x86&lt;br/&gt;
&lt;br/&gt;
java.version: 1.6.0_05&lt;br/&gt;
java.vendor: BEA Systems, Inc.</environment>
        <key id="12395679">OPENJPA-597</key>
            <summary>JPQL delete query with an alias for tablename and without any further clauses gives an error on MySQL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sandeeps@bea.com">Sandeep Shrivastava</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 May 2008 04:03:56 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:51 +0000</updated>
                            <resolved>Fri, 16 May 2008 21:55:32 +0100</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>jdbc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="12595456" author="sandeeps@bea.com" created="Fri, 9 May 2008 04:09:42 +0100"  >&lt;p&gt;Patch to optionally include either the table names or the aliass as the delete targets in the DELETE sql that is generated based on the requiresTargetForDelete that defaults to false and set to true in the mysql dictionary.&lt;/p&gt;</comment>
                            <comment id="12595624" author="mikedd" created="Fri, 9 May 2008 15:57:28 +0100"  >&lt;p&gt;Will the resulting SQL work for all versions of MySQL (3.0, 4.0, 4.1 and 5.0)?  From the description it looks like we should generate different SQL for 4.0 and 4.1, but I don&apos;t see any code to do that in the patch. &lt;/p&gt;

&lt;p&gt;If the resulting SQL will work with all supported versions of MySQL then I&apos;m fine with that - if it will only work with 5.0 and 4.1 (for example) then I think we should be smart enough to detect which version we&apos;re dealing with and initialize MySQLDictionary appropriately. &lt;/p&gt;</comment>
                            <comment id="12596135" author="sandeeps@bea.com" created="Mon, 12 May 2008 18:11:39 +0100"  >&lt;p&gt;Yes it will work with all versions of mySQL.  The following snippet in the getDeleteTargets() method generates:&lt;/p&gt;

&lt;p&gt;For 4.1 and higher: DELETE t0 FROM DYN_DESC_PERSON t0 &lt;br/&gt;
For earlier versions:  DELETE DYN_DESC_PERSON FROM DYN_DESC_PERSON&lt;/p&gt;

&lt;p&gt;if (allowsAliasInBulkClause) &lt;/p&gt;
{
+            deleteTargets.append(tableAlias.substring(spaceIndex + 1));
+          }
&lt;p&gt; else &lt;/p&gt;
{
+            deleteTargets.append(tableAlias.substring(0, spaceIndex));
+          }

&lt;p&gt;The MySQLDictionary sets the allowsAliasInBulkClause propety to false for in the connectedConfiguration method for mysql version earlier than 4.1, the default value for this property is true which is valid for version 4.1 and higher.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12381732" name="OPENJPA-597.patch" size="3632" author="sandeeps@bea.com" created="Fri, 9 May 2008 04:09:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 9 May 2008 14:57:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160913</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyswu7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202668</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>