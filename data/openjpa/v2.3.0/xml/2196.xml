<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:32:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2196/OPENJPA-2196.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2196] Create Sequence Postgres 9.1</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2196</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Sorry my bad english ..&lt;/p&gt;

&lt;p&gt;when annotated a entity with @SequenceGenerator and with allocationSize = 1 and initialValue = 1, the method DBDictionary.commonCreateAlterSequenceSQL is creating a alter sequence sql invalid for Postgres 9.1.&lt;br/&gt;
Despite the documentation of postgres inform you that the other parameters are optional (&lt;a href=&quot;http://www.postgresql.org/docs/9.1/static/sql-altersequence.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.postgresql.org/docs/9.1/static/sql-altersequence.html&lt;/a&gt;), an error occurs in executing the sql below.&lt;/p&gt;

&lt;p&gt;Eg: ALTER SEQUENCE schema_experimento.usuario_sq (no other attributes)&lt;/p&gt;

&lt;p&gt;Even the method NativeJDBCSeq.udpateSql being fault tolerant, the connection is marked for rollback and not allowing run the next val of sequence.&lt;/p&gt;

&lt;p&gt;H&#234;ndi Marcos&lt;/p&gt;</description>
                <environment>OpenJPA-2.2.0&lt;br/&gt;
Transaction-type JTA&lt;br/&gt;
Postgres 9.1&lt;br/&gt;
JBoss 6.1</environment>
        <key id="12555953">OPENJPA-2196</key>
            <summary>Create Sequence Postgres 9.1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="allee8285">Albert Lee</assignee>
                                    <reporter username="hendimarcos">Hendi Marcos Ramos Silva</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 May 2012 05:41:22 +0100</created>
                <updated>Fri, 8 Nov 2013 20:47:55 +0000</updated>
                            <resolved>Wed, 25 Jul 2012 19:40:33 +0100</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>2.2.1.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>jdbc</component>
                    <component>jpa</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <timeoriginalestimate seconds="14400">4h</timeoriginalestimate>
                            <timeestimate seconds="14400">4h</timeestimate>
                                        <comments>
                            <comment id="13397505" author="kwsutter" created="Wed, 20 Jun 2012 14:45:49 +0100"  >&lt;p&gt;Through another discussion on the OpenJPA mailing list (&lt;a href=&quot;http://openjpa.208410.n2.nabble.com/Postgres-sequence-current-transaction-is-aborted-td7580299.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://openjpa.208410.n2.nabble.com/Postgres-sequence-current-transaction-is-aborted-td7580299.html&lt;/a&gt;), we&apos;ve come to the bottom of this issue.  The creation of this &quot;alter sequence..&quot; statement stops prematurely when it&apos;s discovered that the sequence allocation size is not greater than 1.  I think this conditional should be greater than 0 (instead of 1).  Regardless, we have to be smarter with creating these &quot;create/alter sequence..&quot; statements so that they are complete before attempting to execute.&lt;/p&gt;</comment>
                            <comment id="13397508" author="kwsutter" created="Wed, 20 Jun 2012 14:47:21 +0100"  >&lt;p&gt;Albert, I&apos;m going to assign to you since this issue is in the area of the sequence updates you did via openjpa-1376 and openjpa-2069.  Good luck!&lt;/p&gt;</comment>
                            <comment id="13397619" author="kwsutter" created="Wed, 20 Jun 2012 17:35:59 +0100"  >&lt;p&gt;Since the title of this JIRA is generic enough, I&apos;m also going to post the other issue that came about due to the discussion on the mailing list (&lt;a href=&quot;http://openjpa.208410.n2.nabble.com/Postgres-sequence-current-transaction-is-aborted-td7580299.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://openjpa.208410.n2.nabble.com/Postgres-sequence-current-transaction-is-aborted-td7580299.html&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;We have an issue with the permissions required to alter a database sequence with Postgres.  Or, at least, that&apos;s the only database that seems to be reporting this error.  With the changes introduced by OpenJPA-1376 and OpenJPA-2069, we are now blindly attempting to issue an &quot;alter sequence..&quot;.  This is not good for Postgres users since only the owner of the Sequence can alter it.  So far, we must be lucking out with the other databases.&lt;/p&gt;

&lt;p&gt;A couple of things that need to be re-looked at for this Sequence update.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13404076" author="snortasprocket" created="Fri, 29 Jun 2012 19:03:28 +0100"  >&lt;p&gt;Consider, also, this scenario, where OpenJPA is using PostgreSQL and the owner of sequence is not the same user of the client (but client does have the &lt;tt&gt;USAGE&lt;/tt&gt; grant on the sequence to call nextval, etc.). Let i be the initial starting value of the database sequence.&lt;/p&gt;

&lt;p&gt;1. An OpenJPA application connects to the database, and inserts n records into the database where n &amp;gt; 1 and n &amp;lt; allocationSize. On the first insert, the &lt;tt&gt;ALTER SEQUENCE&lt;/tt&gt; call is made fails silently (although PostgreSQL will log an error serverside, but since the exception is swallowed by the client, no one is the wiser &amp;#8211; including the code that &quot;thinks&quot; it has the next allocationSize ids cached. The database, however, still thinks that next sequence number is i+1.&lt;/p&gt;

&lt;p&gt;2. If the application is stopped and restarted, the next insert will fail due to a duplicate key violation (because, since the first ALTER SEQUENCE failed, the database still thinks its current sequence is i+1, but OpenJPA allowed that record to be inserted in the first run.&lt;/p&gt;

&lt;p&gt;I&apos;m not seeing the behavior where the ALTER SEQUENCE call marks the transaction for rollback, though. I &lt;b&gt;think&lt;/b&gt; I&apos;m in a JTA-managed transaction, too... so not sure about that. Looking at the code in NativeJDBCSeq.allocateInternal, it appears that a new connection is grabbed from the store; not sure that connection is under JTA.&lt;/p&gt;

&lt;p&gt;At minimum, I think that OpenJPA should detect the failure to ALTER SEQUENCE and not cache allocationSize values (perhaps logging to WARN level the first time this happens per session per sequence). Additionally, the original DBDictionary.commonCreateAlterSequenceSQL should always specify INCREMENT BY even if it is set to 1, as that breaks the &quot;workaround&quot; for users who wish emulate previous OpenJPA behavior using useNativeSequenceCache=False.&lt;/p&gt;</comment>
                            <comment id="13409478" author="snortasprocket" created="Mon, 9 Jul 2012 14:58:15 +0100"  >&lt;p&gt;This patch works around the case where the ALTER SEQUENCE statement fails to execute (which will happen on PostgreSQL if the sequence is not owned by the current connection&apos;s user). A warning message is logged for each sequence indicating that the sequence was not modified and that sequence values are not cached.&lt;/p&gt;</comment>
                            <comment id="13422491" author="allee8285" created="Wed, 25 Jul 2012 19:40:33 +0100"  >&lt;p&gt;I only commit the fix in trunk (2.3.0). If you need fixes in 2.2.x, you need to work with the release manager for inclusion.  2.2.x is a maintenance release for WebSphere, one can request a service call to the WebSphere product, if needed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12439900">OPENJPA-1376</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12530384">OPENJPA-2069</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12678313">OPENJPA-2450</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12535673" name="OPENJPA-2196-2.2.0.patch" size="4179" author="snortasprocket" created="Mon, 9 Jul 2012 14:58:15 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 20 Jun 2012 13:45:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240170</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxusan:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3403</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>