<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:46:19 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1562/OPENJPA-1562.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1562] EntityManager:Refresh on Removed entity does not trigger IllegalArgumentException</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1562</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;My application unit tests turned up some unexpected behavior from basic OpenJPA entity manager functions.  It appears, for instance, that a detached entity can still be refreshed.  I decided to write a few basic tests (attached) which report five potential errors.  This does not go into the testing of cascading behavior which would require additional work.&lt;/p&gt;</description>
                <environment>Mac OS X, OpenJPA 2.0.0-beta2, Spring 3.0</environment>
        <key id="12458836">OPENJPA-1562</key>
            <summary>EntityManager:Refresh on Removed entity does not trigger IllegalArgumentException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dianner">Dianne Richards</assignee>
                                    <reporter username="no1uno">Jerry Carter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Mar 2010 17:52:56 +0000</created>
                <updated>Thu, 25 Mar 2010 03:44:21 +0000</updated>
                            <resolved>Wed, 24 Mar 2010 17:34:06 +0000</resolved>
                                    <version>2.0.0-beta2</version>
                                    <fixVersion>2.0.0-beta3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12844151" author="no1uno" created="Thu, 11 Mar 2010 17:53:36 +0000"  >&lt;p&gt;Here are the test cases and their output.&lt;/p&gt;</comment>
                            <comment id="12844197" author="no1uno" created="Thu, 11 Mar 2010 19:45:11 +0000"  >&lt;p&gt;Basic unit test showing the failure.  Note that there is a parallel email thread in which Fay Wang could not reproduce the issue. &amp;lt;&lt;a href=&quot;http://n2.nabble.com/Refreshing-detached-entities-tp4717312p4718095.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://n2.nabble.com/Refreshing-detached-entities-tp4717312p4718095.html&lt;/a&gt;&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12844198" author="drwoods" created="Thu, 11 Mar 2010 19:46:54 +0000"  >&lt;p&gt;Which Spec level did you specify in your persistence.xml and what properties did you set?&lt;br/&gt;
A JPA 1.0 level persistence.xml will automatically use compatibility settings to behave like OpenJPA 1.x -&lt;br/&gt;
&lt;a href=&quot;http://openjpa.apache.org/builds/latest/docs/manual/ref_guide_remote.html#ref_guide_detach&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://openjpa.apache.org/builds/latest/docs/manual/ref_guide_remote.html#ref_guide_detach&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12844200" author="drwoods" created="Thu, 11 Mar 2010 19:48:06 +0000"  >&lt;p&gt;Add post 2.0.0-beta2, the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1097&quot; title=&quot;Detachment processing of our proxied mutable types (Date, Timestamp, etc) needs to be consistent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1097&quot;&gt;&lt;del&gt;OPENJPA-1097&lt;/del&gt;&lt;/a&gt; has been integrated, which fixes a bug where EM.clear() was not removing some $proxy class wrappers from the entities....&lt;/p&gt;</comment>
                            <comment id="12844216" author="no1uno" created="Thu, 11 Mar 2010 20:08:37 +0000"  >&lt;p&gt;Donald: interesting suggestions.  My persistence.xml file is pulling in the 2.0 namespace and specifies version 2.0.  I am now running against the OpenJPA-2.0.0.SNAPSHOT.jar and the behavior is unchanged.&lt;/p&gt;</comment>
                            <comment id="12844302" author="no1uno" created="Fri, 12 Mar 2010 00:48:28 +0000"  >&lt;p&gt;Donald: I think you are on the right track.  At DEBUG level, I see &apos;PersistenceVersion=1.0&apos; during OpenJPA initialization.  Now to figure out why.&lt;/p&gt;</comment>
                            <comment id="12844339" author="no1uno" created="Fri, 12 Mar 2010 02:34:07 +0000"  >&lt;p&gt;Spring 3.0 is reporting the wrong version (1.0) for the PersistenceVersion.  &amp;lt;&lt;a href=&quot;http://jira.springframework.org/browse/SPR-6975&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://jira.springframework.org/browse/SPR-6975&lt;/a&gt;&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12844350" author="no1uno" created="Fri, 12 Mar 2010 04:05:32 +0000"  >&lt;p&gt;Considerable progress.  Now only one of the twenty tests fails.&lt;/p&gt;

&lt;p&gt;TestEntity refreshRemoved = new TestEntity(&quot;refresh removed&quot;);&lt;br/&gt;
em.persist(refreshRemoved);&lt;br/&gt;
em.flush();&lt;br/&gt;
em.remove(refreshRemoved);&lt;br/&gt;
em.flush();&lt;br/&gt;
em.refresh(refreshRemoved);&lt;/p&gt;

&lt;p&gt;This should throw an IllegalArgumentException, but does not.&lt;/p&gt;</comment>
                            <comment id="12844566" author="dianner" created="Fri, 12 Mar 2010 16:57:29 +0000"  >&lt;p&gt;I have reproduced this latest problem with remove/refresh and am looking into it.&lt;/p&gt;</comment>
                            <comment id="12844786" author="no1uno" created="Sat, 13 Mar 2010 01:01:41 +0000"  >&lt;p&gt;Revised the bug description to reflect the narrowed scope and changed the state to minor as there are clear workarounds.&lt;/p&gt;</comment>
                            <comment id="12845401" author="dianner" created="Mon, 15 Mar 2010 16:44:46 +0000"  >&lt;p&gt;Attached patch for this problem.&lt;/p&gt;</comment>
                            <comment id="12845538" author="mikedd" created="Mon, 15 Mar 2010 21:31:55 +0000"  >&lt;p&gt;Thanks for the patch Dianne, but I have a couple of questions. &lt;/p&gt;

&lt;p&gt;1. The javadoc for lock() and refresh() is very similar regarding detached entities : &lt;/p&gt;

&lt;p&gt;For lock() :&lt;br/&gt;
     @throws IllegalArgumentException if the instance is not an&lt;/p&gt;

&lt;p&gt;             entity or is a detached entity&lt;/p&gt;

&lt;p&gt;For refresh() : &lt;br/&gt;
     @throws IllegalArgumentException if the instance is not&lt;/p&gt;

&lt;p&gt;             an entity or the entity is not managed&lt;/p&gt;

&lt;p&gt;Seems like we&apos;d want to the same thing for refresh and lock (basically the if check for REFRESH can be removed).&lt;/p&gt;

&lt;p&gt;2. This is more of a general question - your patch didn&apos;t introduce it but the assertValidAttchedEntity() method is very similar to contains(). There is a subtle difference in that contains checks whether the type is managed by this persistence context, and assertValidAttachedEntity checks whether the StateManager is persistent. There&apos;s also a slight difference in the exceptions thrown. Still it seems like we&apos;d want to reuse the logic, and rather than duplicating the code.&lt;/p&gt;</comment>
                            <comment id="12845673" author="dianner" created="Tue, 16 Mar 2010 03:01:14 +0000"  >&lt;p&gt;Thanks for reviewing this patch Mike.&lt;/p&gt;

&lt;p&gt;For question #1:&lt;/p&gt;

&lt;p&gt;When I first made the change and ran all of the tests, one set of lock tests failed because of remove followed by lock.&lt;/p&gt;

&lt;p&gt;So, I searched through the spec related to this. Section 3.2.5 says, for a refresh operation, &quot;If X is a new, detched, or removed entity, the IllegalArgumentException is thrown.&quot; In other parts of the spec  (including the javadoc that you quoted), it says an IllegalArgumentException is thrown for a Lock request on a &quot;detached&quot; entity. But, I couldn&apos;t find any such statement fot a &quot;removed&quot; entity.&lt;/p&gt;

&lt;p&gt;For question #2&lt;/p&gt;

&lt;p&gt;At this point, I don&apos;t have an answer. I&apos;ll do a little digging.&lt;/p&gt;</comment>
                            <comment id="12845911" author="mikedd" created="Tue, 16 Mar 2010 14:15:25 +0000"  >&lt;p&gt;Hi Dianne, you&apos;re right per the spec a managed entity is one that has a persistent identity and is associated with the persistence context. A removed entity fits that description. &lt;/p&gt;

&lt;p&gt;I still think we can be a bit smarted about code reuse, but that&apos;s secondary to this issue - consider both my questions answered &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12846021" author="techhusky" created="Tue, 16 Mar 2010 17:41:25 +0000"  >&lt;p&gt;Committed patch.txt dated 2010-03-15 04:44 PM for Dianne under revision 923849.&lt;/p&gt;</comment>
                            <comment id="12849297" author="no1uno" created="Wed, 24 Mar 2010 17:28:23 +0000"  >&lt;p&gt;The patch works for me.  I tested with beta3 build from the staging area.&lt;/p&gt;</comment>
                            <comment id="12849584" author="mikedd" created="Thu, 25 Mar 2010 03:44:21 +0000"  >&lt;p&gt;Closing on Jerry&apos;s behalf. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12438534" name="openjpa1562.tar.zip" size="7212" author="no1uno" created="Thu, 11 Mar 2010 20:08:37 +0000"/>
                            <attachment id="12438840" name="patch.txt" size="6087" author="dianner" created="Mon, 15 Mar 2010 16:44:45 +0000"/>
                            <attachment id="12438524" name="simple_entity_tests.txt" size="9365" author="no1uno" created="Thu, 11 Mar 2010 17:53:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 11 Mar 2010 19:46:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161825</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7nyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>288852</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>