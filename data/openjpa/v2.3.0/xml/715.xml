<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:42:24 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-715/OPENJPA-715.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-715] OpenJpa does not generate IDs properly. &quot;duplicate key value in a unique or primary key constraint&quot; while merging object tree.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-715</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;While merging object A in following relationship [ A (&lt;b&gt;&lt;del&gt;&lt;/b&gt;) B (1&lt;/del&gt;*) C ] we get the following error. The test case is attached and I tested it with openjpa 1.0.0, 1.1.0 and 1.2.0 official releases with same error. The main problem is the error does not occur if there are just 1 or 2 C objects attached to B. If we add more C to B the probability of getting the error increases (sad but true). You can see a for loop in the test case and a constant named &quot;MAGICAL_NUMBER&quot;. If we set the magical number to 3 or less than we don&apos;t get this error and all objects are persisted just fine. But if we increase it to 50 (to be sure) we get the error below. &lt;/p&gt;

&lt;p&gt;There is also strange a workaround on line 63 of the test case. If we uncomment line 63 and just get the IDs of new C objects just after merge(A) but before commit () we can display proper IDs and the operation will be committed successfully. Otherwise the IDs of new C objects stay &quot;0&quot;  (again sad but true &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  Maybe this hint can help on understanding and solving the issue.&lt;/p&gt;

&lt;p&gt;The test case is created depending on a real life scenario. We get the same error with derby and mysql.&lt;/p&gt;

&lt;p&gt;Here is the error after running the test case:&lt;br/&gt;
Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 3.433 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
testChainEntities(org.apache.openjpa.persistence.relations.TestChainEntities)  Time elapsed: 3.362 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!&lt;br/&gt;
&amp;lt;openjpa-1.1.0-r422266:659716 fatal store error&amp;gt; org.apache.openjpa.persistence.RollbackException: The transaction has been rolled back.  See the nested exceptions for details on the errors that occurred.&lt;br/&gt;
        at org.apache.openjpa.persistence.EntityManagerImpl.commit(EntityManagerImpl.java:523)&lt;br/&gt;
        at org.apache.openjpa.persistence.relations.TestChainEntities.chainUpdate(TestChainEntities.java:64)&lt;br/&gt;
        at org.apache.openjpa.persistence.relations.TestChainEntities.testChainEntities(TestChainEntities.java:32)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
        at junit.framework.TestCase.runTest(TestCase.java:154)&lt;br/&gt;
        at junit.framework.TestCase.runBare(TestCase.java:127)&lt;br/&gt;
        at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
        at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
        at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
        at junit.framework.TestCase.run(TestCase.java:118)&lt;br/&gt;
        at org.apache.openjpa.persistence.test.PersistenceTestCase.run(PersistenceTestCase.java:122)&lt;br/&gt;
        at junit.framework.TestSuite.runTest(TestSuite.java:208)&lt;br/&gt;
        at junit.framework.TestSuite.run(TestSuite.java:203)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
        at org.apache.maven.surefire.junit.JUnitTestSet.execute(JUnitTestSet.java:213)&lt;br/&gt;
        at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.executeTestSet(AbstractDirectoryTestSuite.java:140)&lt;br/&gt;
        at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.execute(AbstractDirectoryTestSuite.java:127)&lt;br/&gt;
        at org.apache.maven.surefire.Surefire.run(Surefire.java:177)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
        at org.apache.maven.surefire.booter.SurefireBooter.runSuitesInProcess(SurefireBooter.java:334)&lt;br/&gt;
        at org.apache.maven.surefire.booter.SurefireBooter.main(SurefireBooter.java:980)&lt;br/&gt;
Caused by: &amp;lt;openjpa-1.1.0-r422266:659716 fatal general error&amp;gt; org.apache.openjpa.persistence.PersistenceException: The transaction has been rolled back.  See the nested exceptions for details on the errors that occurred.&lt;br/&gt;
        at org.apache.openjpa.kernel.BrokerImpl.newFlushException(BrokerImpl.java:2160)&lt;br/&gt;
        at org.apache.openjpa.kernel.BrokerImpl.flush(BrokerImpl.java:2007)&lt;br/&gt;
        at org.apache.openjpa.kernel.BrokerImpl.flushSafe(BrokerImpl.java:1905)&lt;br/&gt;
        at org.apache.openjpa.kernel.BrokerImpl.beforeCompletion(BrokerImpl.java:1823)&lt;br/&gt;
        at org.apache.openjpa.kernel.LocalManagedRuntime.commit(LocalManagedRuntime.java:81)&lt;br/&gt;
        at org.apache.openjpa.kernel.BrokerImpl.commit(BrokerImpl.java:1347)&lt;br/&gt;
        at org.apache.openjpa.kernel.DelegatingBroker.commit(DelegatingBroker.java:877)&lt;br/&gt;
        at org.apache.openjpa.persistence.EntityManagerImpl.commit(EntityManagerImpl.java:512)&lt;br/&gt;
        ... 29 more&lt;br/&gt;
Caused by: &amp;lt;openjpa-1.1.0-r422266:659716 nonfatal general error&amp;gt; org.apache.openjpa.persistence.PersistenceException: The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or unique index identified by &apos;SQL080903042502080&apos; defined on &apos;CHAINENTITYC&apos;. &lt;/p&gt;
{prepstmnt 18739556 INSERT INTO ChainEntityC (cId, chainEntityBId, name, optLock, CHAINENTITYB_BID) VALUES (?, ?, ?, ?, ?) [params=(long) 0, (long) 0, (String) Test_C_48, (int) 1, (long) 3651]} &lt;span class=&quot;error&quot;&gt;&amp;#91;code=20000, state=23505&amp;#93;&lt;/span&gt;&lt;br/&gt;
FailedObject: org.apache.openjpa.persistence.relations.ChainEntityC@f6f1b6&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.SQLExceptions.narrow(SQLExceptions.java:146)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.DBDictionary.newStoreException(DBDictionary.java:4150)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.SQLExceptions.getStore(SQLExceptions.java:102)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.SQLExceptions.getStore(SQLExceptions.java:72)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.flushAndUpdate(PreparedStatementManagerImpl.java:131)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.BatchingPreparedStatementManagerImpl.flushAndUpdate(BatchingPreparedStatementManagerImpl.java:82)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.flushInternal(PreparedStatementManagerImpl.java:89)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.flush(PreparedStatementManagerImpl.java:72)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.ConstraintUpdateManager.flush(ConstraintUpdateManager.java:543)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.ConstraintUpdateManager.flush(ConstraintUpdateManager.java:105)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.BatchingConstraintUpdateManager.flush(BatchingConstraintUpdateManager.java:56)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.AbstractUpdateManager.flush(AbstractUpdateManager.java:89)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.AbstractUpdateManager.flush(AbstractUpdateManager.java:72)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.flush(JDBCStoreManager.java:549)&lt;br/&gt;
        at org.apache.openjpa.kernel.DelegatingStoreManager.flush(DelegatingStoreManager.java:130)&lt;br/&gt;
        ... 36 more&lt;br/&gt;
Caused by: org.apache.openjpa.lib.jdbc.ReportingSQLException: The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or unique index identified by &apos;SQL080903042502080&apos; defined on &apos;CHAINENTITYC&apos;. {prepstmnt 18739556 INSERT INTO ChainEntityC (cId, chainEntityBId, name, optLock, CHAINENTITYB_BID) VALUES (?, ?, ?, ?, ?) [params=(long) 0, (long) 0, (String) Test_C_48, (int) 1, (long) 3651]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=20000, state=23505&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator.wrap(LoggingConnectionDecorator.java:192)&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator.access$700(LoggingConnectionDecorator.java:57)&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator$LoggingConnection$LoggingPreparedStatement.executeUpdate(LoggingConnectionDecorator.java:866)&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.DelegatingPreparedStatement.executeUpdate(DelegatingPreparedStatement.java:269)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.JDBCStoreManager$CancelPreparedStatement.executeUpdate(JDBCStoreManager.java:1398)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.executeUpdate(PreparedStatementManagerImpl.java:151)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.flushAndUpdate(PreparedStatementManagerImpl.java:120)&lt;br/&gt;
        ... 46 more&lt;/p&gt;


&lt;p&gt;Results :&lt;/p&gt;

&lt;p&gt;Tests in error:&lt;br/&gt;
  testChainEntities(org.apache.openjpa.persistence.relations.TestChainEntities)&lt;/p&gt;

&lt;p&gt;Tests run: 1, Failures: 0, Errors: 1, Skipped: 0&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; BUILD FAILURE&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; There are test failures.&lt;/p&gt;</description>
                <environment>Fedora 6&lt;br/&gt;
java version &amp;quot;1.5.0_11&amp;quot;</environment>
        <key id="12403677">OPENJPA-715</key>
            <summary>OpenJpa does not generate IDs properly. &quot;duplicate key value in a unique or primary key constraint&quot; while merging object tree.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="faywang">Fay Wang</assignee>
                                    <reporter username="ekinsokmen">Ekin Sokmen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Sep 2008 14:07:03 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:55 +0000</updated>
                            <resolved>Thu, 18 Sep 2008 16:41:09 +0100</resolved>
                                    <version>1.0.0</version>
                    <version>1.1.0</version>
                    <version>1.2.0</version>
                                    <fixVersion>1.0.4</fixVersion>
                    <fixVersion>1.2.1</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12628334" author="ekinsokmen" created="Thu, 4 Sep 2008 14:10:51 +0100"  >&lt;p&gt;You can run test case by copying files to openjpa-persistence-jdbc module and running&lt;br/&gt;
mvn test -Dtest=TestChainEntities&lt;/p&gt;</comment>
                            <comment id="12628451" author="faywang" created="Thu, 4 Sep 2008 21:44:07 +0100"  >&lt;p&gt;The duplicate key problem is due to the fact that the primary key for ChainEntityC is only generated for the first two ChainEntityC objects in the collection. Starting from the third ChainEntityC object, the logic in openjpa is such that the object id will not be generated at all (it then assumes the default value of 0). That is why if the test caes has more than 3 ChainEntityC objects in the collection in ChainEntityB, we will see duplicate key error as more than one ChainEntityC has primary key = 0.  The attached patch fixes this problem. Any comment is mostly appreciated.&lt;/p&gt;</comment>
                            <comment id="12628516" author="faywang" created="Fri, 5 Sep 2008 00:23:10 +0100"  >&lt;p&gt;As Kevin pointed out, sometimes the test case works fine with MAGICAL_NUMBER = 4 or 5 or 6 or .... In other words, the result is unpredictable. This is because during flush, the BrokerImpl will flush an un-ordered set of transactional objects. If the order of the flush is such that any C instance is flushed after A is flushed, that C instance will have valid object id. If all the C instances are flushed before A, then only the first 2 C instances will have valid object id.  &lt;/p&gt;

&lt;p&gt;Specifically, right after A is done flushing, only the first 2 C instances have valid object id. If there are any C to be flushed in BrokerImpl, the beforeFlush of its state, PNewState, will be invoked, and assignObjectId will be called to generate valid object id. &lt;/p&gt;</comment>
                            <comment id="12628664" author="ekinsokmen" created="Fri, 5 Sep 2008 17:10:21 +0100"  >&lt;p&gt;I applied and tested the patch. The issue is solved. Thanks.&lt;/p&gt;</comment>
                            <comment id="12629302" author="kwsutter" created="Mon, 8 Sep 2008 22:37:54 +0100"  >&lt;p&gt;Resolved in 1.2.x and 1.3.0 (trunk).&lt;/p&gt;</comment>
                            <comment id="12632250" author="kwsutter" created="Thu, 18 Sep 2008 16:29:13 +0100"  >&lt;p&gt;Re-opening to migrate the fix back to the 1.0.x service stream.  A user requested this via private e-mail.&lt;/p&gt;</comment>
                            <comment id="12632254" author="kwsutter" created="Thu, 18 Sep 2008 16:41:09 +0100"  >&lt;p&gt;Migrated change back to 1.0.x.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12389538" name="openjpa-715.patch" size="1560" author="faywang" created="Thu, 4 Sep 2008 21:44:07 +0100"/>
                            <attachment id="12389497" name="testcase_jira715.zip" size="3250" author="ekinsokmen" created="Thu, 4 Sep 2008 14:08:47 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 4 Sep 2008 20:44:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161025</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyswxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202682</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>