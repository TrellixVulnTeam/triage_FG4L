<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:33:16 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-539/OPENJPA-539.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-539] Can&apos;t create a table with a field of java type &quot;Map&quot; in Derby.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-539</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;When a Map field is defined in an entity, the push-down SQL contains  Derby reserved word &quot;key&quot;, causing the execution to fail. For example:&lt;/p&gt;

&lt;p&gt;// Map Type&lt;br/&gt;
@ManyToMany&lt;br/&gt;
@JoinTable(name=&quot;MMCTEA_GMT&quot;)&lt;br/&gt;
private Map&amp;lt;Integer, MMContainerTypeEntityB&amp;gt; genericizedMapType;&lt;/p&gt;

&lt;p&gt;The following SQL will be generated:&lt;/p&gt;

&lt;p&gt;CREATE TABLE MMCTEA_GMT (MMCONTAINERTYPEENTITYA_ID INTEGER, key INTEGER, VALUE0_id INTEGER)&lt;/p&gt;

&lt;p&gt;Its execution fails with exception stack trace below:&lt;/p&gt;

&lt;p&gt;&amp;lt;openjpa-0.0.0-rnull nonfatal general error&amp;gt; org.apache.openjpa.persistence.PersistenceException: Syntax error: Encountered &quot;key&quot; at line 1, column 61.&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingTool.record(MappingTool.java:553)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingTool.record(MappingTool.java:453)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCBrokerFactory.synchronizeMappings(JDBCBrokerFactory.java:159)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCBrokerFactory.newBrokerImpl(JDBCBrokerFactory.java:119)&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:187)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBrokerFactory.newBroker(DelegatingBrokerFactory.java:142)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:192)&lt;br/&gt;
	at com.ibm.ws.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:42)&lt;br/&gt;
	at com.ibm.ws.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:1)&lt;br/&gt;
	at suite.r70.base.jpaspec.relationships.manyXmany.service.impl.jse.JSEManyXManyEntityService.initializeService(JSEManyXManyEntityService.java:51)&lt;br/&gt;
	at suite.r70.base.jpaspec.relationships.manyXmany.service.impl.jse.JSEManyXManyEntityService.&amp;lt;init&amp;gt;(JSEManyXManyEntityService.java:40)&lt;br/&gt;
	at suite.r70.base.jpaspec.relationships.manyXmany.tests.jse.JUnitManyXManyContainerTest.setUpTestCase(JUnitManyXManyContainerTest.java:60)&lt;br/&gt;
	at suite.r70.base.jpaspec.relationships.manyXmany.tests.jse.JUnitManyXManyContainerTest.setUp(JUnitManyXManyContainerTest.java:45)&lt;br/&gt;
	at junit.framework.TestCase.runBare(TestCase.java:125)&lt;br/&gt;
	at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
	at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
	at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
	at junit.framework.TestCase.run(TestCase.java:118)&lt;br/&gt;
	at junit.framework.TestSuite.runTest(TestSuite.java:208)&lt;br/&gt;
	at junit.framework.TestSuite.run(TestSuite.java:203)&lt;br/&gt;
	at org.junit.internal.runners.OldTestClassRunner.run(OldTestClassRunner.java:35)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:38)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)&lt;br/&gt;
Caused by: java.sql.SQLException: Syntax error: Encountered &quot;key&quot; at line 1, column 61.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(Unknown Source)&lt;br/&gt;
	at org.apache.commons.dbcp.DelegatingStatement.executeUpdate(DelegatingStatement.java:225)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.DelegatingStatement.executeUpdate(DelegatingStatement.java:114)&lt;br/&gt;
	at org.apache.openjpa.jdbc.schema.SchemaTool.executeSQL(SchemaTool.java:1185)&lt;br/&gt;
	at org.apache.openjpa.jdbc.schema.SchemaTool.createTable(SchemaTool.java:949)&lt;br/&gt;
	at org.apache.openjpa.jdbc.schema.SchemaTool.add(SchemaTool.java:526)&lt;br/&gt;
	at org.apache.openjpa.jdbc.schema.SchemaTool.add(SchemaTool.java:344)&lt;br/&gt;
	at org.apache.openjpa.jdbc.schema.SchemaTool.run(SchemaTool.java:321)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingTool.record(MappingTool.java:501)&lt;br/&gt;
	... 26 more&lt;/p&gt;

&lt;p&gt;This is because in HandlerRelationMapTableFieldStrategy.map method, the following method&lt;br/&gt;
is called with &quot;key&quot; hardcoded to be the column name:&lt;/p&gt;

&lt;p&gt;       _kcols = HandlerStrategies.map(key, &quot;key&quot;, _kio, adapt);&lt;/p&gt;

&lt;p&gt;The proposed change is to concatenate field name (in this case, &quot;genericizedMapType&quot;)&lt;br/&gt;
with &quot;_key&quot; to make the resulting column name a non-reserved word in any&lt;br/&gt;
database:&lt;/p&gt;

&lt;p&gt;       _kcols = HandlerStrategies.map(key, field.getName + &quot;_key&quot;, _kio, adapt);&lt;/p&gt;</description>
                <environment>Derby</environment>
        <key id="12391913">OPENJPA-539</key>
            <summary>Can&apos;t create a table with a field of java type &quot;Map&quot; in Derby.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fancy">Catalina Wei</assignee>
                                    <reporter username="faywang">Fay Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Mar 2008 20:31:23 +0000</created>
                <updated>Tue, 9 Mar 2010 18:32:49 +0000</updated>
                            <resolved>Fri, 21 Mar 2008 18:38:54 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>jdbc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12580547" author="faywang" created="Wed, 19 Mar 2008 20:37:33 +0000"  >&lt;p&gt;The attached patch resolves the reserved word problem in the push-down SQL with Derby when a field of java type Map is defined in an entity.&lt;/p&gt;</comment>
                            <comment id="12580551" author="mikedd" created="Wed, 19 Mar 2008 20:44:33 +0000"  >&lt;p&gt;Hi Fay,&lt;/p&gt;

&lt;p&gt;Having a column named _key will cause other errors with Derby. I think a better fix would be to call getValidColumnName on the DBDictionary that is being used. That way the column name will only be changed for databases need it. &lt;/p&gt;</comment>
                            <comment id="12580790" author="faywang" created="Thu, 20 Mar 2008 15:24:44 +0000"  >&lt;p&gt;The propoesd fix is not to use &quot;_key&quot;, but to concatenate the field name with &quot;_key&quot;. However, Mike&apos;s suggestion is more comprehensive and more systematic.  I will  attach a new patch based on his suggestion..&lt;/p&gt;</comment>
                            <comment id="12580799" author="faywang" created="Thu, 20 Mar 2008 15:48:38 +0000"  >&lt;p&gt;This patch is per Mike&apos;s suggestion, which calls DBDictionary.getValidColumnName to replace hard-coded &quot;key&quot;. This solution also resolves Derby&apos;s reserved word problem.&lt;/p&gt;</comment>
                            <comment id="12581137" author="mikedd" created="Fri, 21 Mar 2008 17:33:12 +0000"  >&lt;p&gt;We still need a testcase for the problem, but other than that Fay&apos;s proposed patch looks good.&lt;/p&gt;</comment>
                            <comment id="12581155" author="mikedd" created="Fri, 21 Mar 2008 18:38:54 +0000"  >&lt;p&gt;Thanks for committing the changes Catalina. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12378320" name="OPENJPA-539.patch" size="997" author="faywang" created="Thu, 20 Mar 2008 15:48:38 +0000"/>
                            <attachment id="12378270" name="OPENJPA-539.patch" size="794" author="faywang" created="Wed, 19 Mar 2008 20:37:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Mar 2008 20:44:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160856</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt1y7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>203496</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>