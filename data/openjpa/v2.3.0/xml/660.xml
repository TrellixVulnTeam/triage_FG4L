<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:42:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-660/OPENJPA-660.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-660] ClassCastException when using OneToMany Relation and collection is subclass using Discriminator with SINGLE_TABLE strategy.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-660</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;If the entity has OneToMany relation and collection is declared as subclass which uses SINGLE_TABLE inheritance strategy, it fetches all rows irrespective of Discriminator value and throws ClassCastException.&lt;/p&gt;

&lt;p&gt;There is entity Department (table dept) having OneToMany relation with another entity FullTimeEmployee. &lt;/p&gt;

&lt;p&gt;  @OneToMany (mappedBy=&quot;dept&quot;, cascade=CascadeType.ALL)&lt;br/&gt;
  private Collection&amp;lt;FullTimeEmployee&amp;gt; fullTimeEmployees;&lt;/p&gt;

&lt;p&gt;There is abstract class Employee with&lt;br/&gt;
@Inheritance(strategy=InheritanceType.SINGLE_TABLE)&lt;br/&gt;
@DiscriminatorColumn(name=&quot;TYPE&quot;)&lt;/p&gt;

&lt;p&gt;There are two entity classes FullTimeEmployee and PartTimeEmployee which extends Employee (table emp) with Discriminator values &apos;F&apos; and &apos;P&apos; respectively.&lt;/p&gt;

&lt;p&gt;Now, suppose emp table contains 2 rows of PartTimeEmployee and 2 rows of FullTimeEmployee and if test class fetches Department object and calls dept.getFullTimeEmployees(), it throws ClassCastException as it gets 4 rows and doesn&apos;t use discriminator and subclass type while generating SQL query.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12400364">OPENJPA-660</key>
            <summary>ClassCastException when using OneToMany Relation and collection is subclass using Discriminator with SINGLE_TABLE strategy.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ppoddar@apache.org">Pinaki Poddar</assignee>
                                    <reporter username="vbhatia">Vikram Bhatia</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Jul 2008 11:09:58 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:54 +0000</updated>
                            <resolved>Fri, 25 Jul 2008 21:50:29 +0100</resolved>
                                    <version>1.0.0</version>
                    <version>1.0.1</version>
                    <version>1.0.2</version>
                    <version>1.0.3</version>
                    <version>1.0.4</version>
                    <version>1.1.0</version>
                    <version>1.1.1</version>
                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>jpa</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12613900" author="vbhatia" created="Wed, 16 Jul 2008 11:12:57 +0100"  >&lt;p&gt;Testcase with junit test TestCollection class.&lt;/p&gt;</comment>
                            <comment id="12614018" author="ppoddar@apache.org" created="Wed, 16 Jul 2008 17:51:24 +0100"  >&lt;p&gt;The test will pass if typed collection fields declare ElementClassCriteria as follows (+ marks added lines)&lt;/p&gt;

&lt;p&gt;    @OneToMany (mappedBy=&quot;dept&quot;, cascade= CascadeType.PERSIST)&lt;br/&gt;
+  @ElementClassCriteria&lt;br/&gt;
    private Collection&amp;lt;PartTimeEmployee&amp;gt; partTimeEmployees;&lt;/p&gt;

&lt;p&gt;    @OneToMany (mappedBy=&quot;dept&quot;, cascade= CascadeType.PERSIST)&lt;br/&gt;
+  @ElementClassCriteria&lt;br/&gt;
    private Collection&amp;lt;FullTimeEmployee&amp;gt; fullTimeEmployees;&lt;/p&gt;
</comment>
                            <comment id="12614027" author="vbhatia" created="Wed, 16 Jul 2008 18:28:14 +0100"  >&lt;p&gt;Thanks Pinaki for the suggestion, but it is causing &lt;/p&gt;

&lt;p&gt;2640  testInheritance  TRACE  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; openjpa.jdbc.SQL - &amp;lt;t 6889270, conn 20693770&amp;gt; executing prepstmnt 89154&lt;br/&gt;
06 SELECT t0.ssn, t0.type, t0.salary FROM EMP t0 WHERE t0.DEPT_NAME = ? AND t0.type = ? [params=(String) Mat&lt;br/&gt;
hs]&lt;br/&gt;
2656  testInheritance  TRACE  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; openjpa.jdbc.SQL - &amp;lt;t 6889270, conn 20693770&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;0 ms&amp;#93;&lt;/span&gt; spent&lt;br/&gt;
E&lt;br/&gt;
Time: 3.281&lt;br/&gt;
There was 1 error:&lt;br/&gt;
1) testInheritance(com.test.jpa.inheritance.TestCollection)&amp;lt;openjpa-1.2.0-SNAPSHOT-r422266:676787 nonfatal g&lt;br/&gt;
eneral error&amp;gt; org.apache.openjpa.persistence.PersistenceException: ORA-01008: not all variables bound&lt;br/&gt;
 &lt;/p&gt;
{prepstmnt 5084131 SELECT t0.ssn, t0.type, t0.salary FROM EMP t0 WHERE t0.DEPT_NAME = ? AND t0.type = ? [pa
rams=(String) Maths]} &lt;span class=&quot;error&quot;&gt;&amp;#91;code=1008, state=72000&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.DBDictionary.narrow(DBDictionary.java:4228)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.DBDictionary.newStoreException(DBDictionary.java:4193)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.SQLExceptions.getStore(SQLExceptions.java:102)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.SQLExceptions.getStore(SQLExceptions.java:88)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.SQLExceptions.getStore(SQLExceptions.java:64)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.load(JDBCStoreManager.java:613)&lt;br/&gt;
        at org.apache.openjpa.kernel.DelegatingStoreManager.load(DelegatingStoreManager.java:116)&lt;br/&gt;
        at org.apache.openjpa.kernel.ROPStoreManager.load(ROPStoreManager.java:78)&lt;br/&gt;
        at org.apache.openjpa.kernel.StateManagerImpl.loadFields(StateManagerImpl.java:2919)&lt;br/&gt;
        at org.apache.openjpa.kernel.StateManagerImpl.loadField(StateManagerImpl.java:2997)&lt;br/&gt;
        at org.apache.openjpa.kernel.StateManagerImpl.beforeAccessField(StateManagerImpl.java:1491)&lt;br/&gt;
        at org.apache.openjpa.kernel.StateManagerImpl.accessingField(StateManagerImpl.java:1476)&lt;br/&gt;
        at com.test.jpa.inheritance.Department.pcGetfullTimeEmployees(Department.java)&lt;br/&gt;
        at com.test.jpa.inheritance.Department.getFullTimeEmployees(Department.java:30)&lt;br/&gt;
        at com.test.jpa.inheritance.TestCollection.testInheritance(TestCollection.java:52)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
Caused by: org.apache.openjpa.lib.jdbc.ReportingSQLException: ORA-01008: not all variables bound&lt;br/&gt;
 {prepstmnt 5084131 SELECT t0.ssn, t0.type, t0.salary FROM EMP t0 WHERE t0.DEPT_NAME = ? AND t0.type = ? [pa
rams=(String) Maths]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=1008, state=72000&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator.wrap(LoggingConnectionDecorator.java:192)&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator.access$700(LoggingConnectionDecorator.java&lt;br/&gt;
:57)&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator$LoggingConnection$LoggingPreparedStatement&lt;br/&gt;
.executeQuery(LoggingConnectionDecorator.java:852)&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.DelegatingPreparedStatement.executeQuery(DelegatingPreparedStatement.&lt;br/&gt;
java:262)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.JDBCStoreManager$CancelPreparedStatement.executeQuery(JDBCStoreMan&lt;br/&gt;
ager.java:1494)&lt;br/&gt;
        at org.apache.openjpa.lib.jdbc.DelegatingPreparedStatement.executeQuery(DelegatingPreparedStatement.&lt;br/&gt;
java:252)&lt;/p&gt;

&lt;p&gt;It looks like it is svn r652913 (&lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-407&quot; title=&quot;Cache SQL (or closer precursors to SQL) more aggressively&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-407&quot;&gt;&lt;del&gt;OPENJPA-407&lt;/del&gt;&lt;/a&gt;) which has made changes in StoreCollectionFieldStrategy.load() method resulting in this issue.&lt;/p&gt;

&lt;p&gt;            ClassMapping mapping = field.getDefiningMapping();&lt;br/&gt;
            Object oid = sm.getObjectId();&lt;br/&gt;
            Column[] cols = mapping.getPrimaryKeyColumns();&lt;br/&gt;
            if (sel == null)&lt;br/&gt;
                sel = ((LogicalUnion.UnionSelect)union.getSelects()&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;).&lt;br/&gt;
                getDelegate();&lt;/p&gt;

&lt;p&gt;            sel.wherePrimaryKey(mapping, cols, cols, oid, store, &lt;br/&gt;
                	null, null, parmList);&lt;/p&gt;</comment>
                            <comment id="12614054" author="vbhatia" created="Wed, 16 Jul 2008 19:11:17 +0100"  >&lt;p&gt;Using &amp;lt;property name=&quot;openjpa.jdbc.QuerySQLCache&quot; value=&quot;false&quot;/&amp;gt; has resolved the issue. Please close it.&lt;/p&gt;</comment>
                            <comment id="12614758" author="faywang" created="Fri, 18 Jul 2008 16:27:59 +0100"  >&lt;p&gt;The attached patch fixes this problem. To load a toMany relationship, there is normally a foreign key corresponing to the primary key in the owner class in the where clause. The value of the primary key in the owner class is passed via the argument sm to the load method.  The parameter problem exposed by &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-660&quot; title=&quot;ClassCastException when using OneToMany Relation and collection is subclass using Discriminator with SINGLE_TABLE strategy.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-660&quot;&gt;&lt;del&gt;OPENJPA-660&lt;/del&gt;&lt;/a&gt; is the missing non-foreign key parameters. The fix is to detect any non-FK parameters and add them to the parameter list. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12386402" name="patch.txt" size="4339" author="faywang" created="Fri, 18 Jul 2008 16:27:59 +0100"/>
                            <attachment id="12386166" name="testInheritance.zip" size="22359" author="vbhatia" created="Wed, 16 Jul 2008 11:12:57 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 16 Jul 2008 16:51:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160974</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt247:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>203523</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>