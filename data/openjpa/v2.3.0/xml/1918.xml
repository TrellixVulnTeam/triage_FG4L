<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:39:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1918/OPENJPA-1918.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1918] MetaDataRepository.preload() ignores class loader returned by PersistenceUnitInfo.getClassLoader()</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1918</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;We are using openjpa inside an OSGi container together with&lt;/p&gt;

&lt;p&gt;   openjpa.MetaDataRepository&quot; value=&quot;Preload=true&quot;&lt;/p&gt;

&lt;p&gt;We pass the appliation class loeader as part of our PersistenceUnitInfo implementation by returning it from PersistenceUnitInfo.getClassLoader().&lt;/p&gt;

&lt;p&gt;However, the code in MetaDataRepository.preload() only uses the context class loader and not the class loader from PersistenceUnitInfo, which leades to ClassNotFoundExpcetions like mentioned at the end of this report.&lt;/p&gt;

&lt;p&gt;A fix might be quite easily establihed by appending the return value of PersistenceUnitInfo.getClassLoader() to the list of claas loaders participating in the MultiClassLoader set up in&lt;/p&gt;

&lt;p&gt;  MetaDataRepository.java:310ff&lt;/p&gt;

&lt;p&gt;In the meanwhile, we are additionally setting our classloader as context loader during the creation of the EntityManagerFactory by PersistenceProvider.createContainerEntityManagerFactory(), but a fix in MetaDatRepository.preload() is highly appreciated.&lt;/p&gt;

&lt;p&gt;  TIA for fixing this,&lt;/p&gt;

&lt;p&gt;   Wolfgang&lt;/p&gt;

&lt;p&gt;Stack trace:&lt;/p&gt;

&lt;p&gt;org.osgi.service.blueprint.container.ComponentDefinitionException: Error when instantiating bean entityManagerFactory of class null&lt;br/&gt;
	at org.apache.aries.blueprint.container.BeanRecipe.getInstance(BeanRecipe.java:233)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BeanRecipe.internalCreate(BeanRecipe.java:726)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.di.AbstractRecipe.create(AbstractRecipe.java:64)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintRepository.createInstances(BlueprintRepository.java:219)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintRepository.createAll(BlueprintRepository.java:147)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.instantiateEagerComponents(BlueprintContainerImpl.java:624)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.doRun(BlueprintContainerImpl.java:315)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.run(BlueprintContainerImpl.java:213)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:165)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:266)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:636)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
Caused by: &amp;lt;openjpa-2.0.1-r422266:989424 fatal user error&amp;gt; org.apache.openjpa.persistence.ArgumentException: Unexpected error during early loading of entity metadata during initialization. See nested stacktrace for details.	  &lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.preload(MetaDataRepository.java:331)&lt;br/&gt;
	at org.apache.openjpa.persistence.PersistenceProviderImpl.preloadMetaDataRepository(PersistenceProviderImpl.java:280)&lt;br/&gt;
	at org.apache.openjpa.persistence.PersistenceProviderImpl.createContainerEntityManagerFactory(PersistenceProviderImpl.java:211)&lt;br/&gt;
	at org.apache.openjpa.persistence.PersistenceProviderImpl.createContainerEntityManagerFactory(PersistenceProviderImpl.java:65)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:616)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.AbstractServiceReferenceRecipe$JdkProxyFactory$1.invoke(AbstractServiceReferenceRecipe.java:632)&lt;br/&gt;
	at $Proxy67.createContainerEntityManagerFactory(Unknown Source)&lt;br/&gt;
	at org.clazzes.util.jpa.provider.EntityManagerFactoryFactory.newEntityManagerFactory(EntityManagerFactoryFactory.java:108)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:616)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.utils.ReflectionUtils.invoke(ReflectionUtils.java:221)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BeanRecipe.invoke(BeanRecipe.java:844)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.aries.blueprint.container.BeanRecipe.getInstance(BeanRecipe.java:231)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.aries.blueprint:0.3.0.incubating-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	... 15 more&lt;br/&gt;
Caused by: java.security.PrivilegedActionException: java.lang.ClassNotFoundException: org.clazzes.fancymail.server.entities.EMail&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.preload(MetaDataRepository.java:326)&lt;br/&gt;
	... 32 more&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.clazzes.fancymail.server.entities.EMail&lt;br/&gt;
	at org.apache.openjpa.lib.util.MultiClassLoader.findClass(MultiClassLoader.java:216)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:321)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:266)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Class.forName0(Native Method)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Class.forName(Class.java:264)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.openjpa.lib.util.J2DoPrivHelper$4.run(J2DoPrivHelper.java:233)&lt;br/&gt;
	at org.apache.openjpa.lib.util.J2DoPrivHelper$4.run(J2DoPrivHelper.java:231)&lt;br/&gt;
	... 34 more&lt;/p&gt;
</description>
                <environment>apache-karaf-2.1.0, openjdk-1.6.0b20</environment>
        <key id="12494845">OPENJPA-1918</key>
            <summary>MetaDataRepository.preload() ignores class loader returned by PersistenceUnitInfo.getClassLoader()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curtisr7">Rick Curtis</assignee>
                                    <reporter username="wolfgang.glas@ev-i.at">Wolfgang Glas</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Jan 2011 14:11:24 +0000</created>
                <updated>Thu, 2 Feb 2012 17:03:42 +0000</updated>
                            <resolved>Thu, 6 Jan 2011 22:11:38 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.1.0</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12978381" author="curtisr7" created="Thu, 6 Jan 2011 15:57:42 +0000"  >&lt;p&gt;Would you be able to try out a patch for 2.1.x or trunk?&lt;/p&gt;</comment>
                            <comment id="12978389" author="curtisr7" created="Thu, 6 Jan 2011 16:16:43 +0000"  >&lt;p&gt;Please give this patch a try. It should work on 2.1.x and trunk.... it might even work for 2.0.x.&lt;/p&gt;</comment>
                            <comment id="12978399" author="wolfgang.glas@ev-i.at" created="Thu, 6 Jan 2011 16:31:38 +0000"  >&lt;p&gt;Rick,&lt;/p&gt;

&lt;p&gt;ThX for having alook at my issue, I sure will try out any patch. I&apos;ve now checked out the 2.1.x branch an I will hopefully be able to compile the stuff.&lt;/p&gt;

&lt;p&gt;Right now it looks like I have a good mileage &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I had to increase my ulimit for the  maximal number of open files in order to get teh enhance test up and running, ithis ok ? :-/&lt;/p&gt;

&lt;p&gt;And 2.1.0 as a target milestone looks quite OK for me.&lt;/p&gt;

&lt;p&gt;  Best regards, Wolfgang&lt;/p&gt;</comment>
                            <comment id="12978402" author="wolfgang.glas@ev-i.at" created="Thu, 6 Jan 2011 16:35:40 +0000"  >&lt;p&gt;Rick, could you please supply the patch as an output of &apos;svn diff&apos; or &apos;diff -u&apos;, so I can apply it to my working copy of the 2.1.x branch ?&lt;/p&gt;

&lt;p&gt;TIA, Wolfgang&lt;/p&gt;</comment>
                            <comment id="12978456" author="curtisr7" created="Thu, 6 Jan 2011 19:01:09 +0000"  >&lt;p&gt;Wolfgang -&lt;/p&gt;

&lt;p&gt;Take a peek inside the jar... the patch is there.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rick&lt;/p&gt;</comment>
                            <comment id="12978534" author="wolfgang.glas@ev-i.at" created="Thu, 6 Jan 2011 22:11:38 +0000"  >&lt;p&gt;Fixed by Rick&apos;s patch, works like acharm for me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12978536" author="wolfgang.glas@ev-i.at" created="Thu, 6 Jan 2011 22:12:56 +0000"  >&lt;p&gt;Rick, Thanks for your patch, forgot to mention, that I applis it to 2.1.x branch an now I don&apos;t need the context class laoder workaround anymore.&lt;/p&gt;</comment>
                            <comment id="12978541" author="curtisr7" created="Thu, 6 Jan 2011 22:33:26 +0000"  >&lt;p&gt;Wolfgang -&lt;/p&gt;

&lt;p&gt;Can I have you also try with this patch? I re-ordered the classloaders because I&apos;m quite paranoid that I&apos;m going to break others with this change. Please confirm that this also fixes your problem.&lt;/p&gt;

&lt;p&gt;Thanks so much!&lt;/p&gt;

&lt;p&gt;Rick&lt;/p&gt;</comment>
                            <comment id="12978549" author="wolfgang.glas@ev-i.at" created="Thu, 6 Jan 2011 22:49:36 +0000"  >&lt;p&gt;Second version works for me, too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;In apache-karaf the standard context class laoder is a boot delegation class loader from teh framework essentially exposing system and framework classes. The bundle class loader ait atop of this boot delgation class loader, so the order in your patch should not cause majot headaches insode apache-karaf.&lt;/p&gt;

&lt;p&gt;Sorry for setting the issue to resolved so fast :-/&lt;/p&gt;

&lt;p&gt;  Wolfgang&lt;/p&gt;</comment>
                            <comment id="13198959" author="allee8285" created="Thu, 2 Feb 2012 17:03:42 +0000"  >&lt;p&gt;Close issue in preparation for 2.2.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12467676" name="OPENJPA-1918.2.patch" size="4374" author="curtisr7" created="Thu, 6 Jan 2011 22:33:26 +0000"/>
                            <attachment id="12467643" name="openjpa-1918.1-trunk.jar" size="57993" author="curtisr7" created="Thu, 6 Jan 2011 16:16:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 Jan 2011 15:57:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>162142</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysxn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202798</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>