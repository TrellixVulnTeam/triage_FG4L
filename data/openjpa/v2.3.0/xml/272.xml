<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:29:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-272/OPENJPA-272.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-272] @GenerateValue (AUTO) doesn&apos;t work with Property level access</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-272</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;The @GenerateValue annotation doesn&apos;t work correctly when applied to via the Property level access (getter method) when using the wrapper classes for the primitive types.  Something like this:&lt;/p&gt;

&lt;p&gt;    private Long id;&lt;/p&gt;

&lt;p&gt;    @Id&lt;br/&gt;
    @GeneratedValue(strategy=GenerationType.AUTO)&lt;br/&gt;
	public Long getId() &lt;/p&gt;
{
		return id;
	}

&lt;p&gt;	public void setId(Long id) &lt;/p&gt;
{
		this.id = id;
	}

&lt;p&gt;With this type of Entity definition, we hit a problem when checking for the &quot;default value&quot;:&lt;/p&gt;

&lt;p&gt;    public boolean isDefaultValue() &lt;/p&gt;
{
        return dblval == 0 &amp;amp;&amp;amp; longval == 0
            &amp;amp;&amp;amp; (objval == null || &quot;&quot;.equals(objval));
    }

&lt;p&gt;For this scenario, objval is not null and it&apos;s not of type String, so we fail this test and return false.  Upon returning the value of false, the calling code skips the call that would have assigned the generated value to the field (in ApplicationIds):&lt;/p&gt;

&lt;p&gt;    private static boolean assign(OpenJPAStateManager sm, StoreManager store,&lt;br/&gt;
        FieldMetaData[] pks, boolean preFlush) &lt;/p&gt;
{
        for (int i = 0; i &amp;lt; pks.length; i++)
            if (pks[i].getValueStrategy() != ValueStrategies.NONE
                &amp;amp;&amp;amp; sm.isDefaultValue(pks[i].getIndex())
                &amp;amp;&amp;amp; !store.assignField(sm, pks[i].getIndex(), preFlush))
                return false;
        return true;
    }

&lt;p&gt;I haven&apos;t figured out the exact fix yet, but there are two workarounds available:&lt;/p&gt;

&lt;p&gt;1.  Use field level annotations instead of property, or...&lt;br/&gt;
2.  Don&apos;t use the primitive wrapper types (use long instead of Long).&lt;/p&gt;

&lt;p&gt;In either of these cases, objval is left as null and we are eventually allowed to call store.assignField() which gets the generated value assigned to the field in question (id in this case).&lt;/p&gt;

&lt;p&gt;I will keep digging, but if anyone knows the history of the isDefaultValue() method, it would help with getting a quick answer to this Issue.  Since we&apos;re dealing with generated values, I&apos;m not clear why we care if values are already assigned to this field or not.  It would seem that we would want to just override what&apos;s there.  But, like I said, I need to dive into this a bit.  I just wanted to get the Issue on the books with the information I discovered thus far.&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</description>
                <environment></environment>
        <key id="12372712">OPENJPA-272</key>
            <summary>@GenerateValue (AUTO) doesn&apos;t work with Property level access</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwsutter">Kevin Sutter</assignee>
                                    <reporter username="kwsutter">Kevin Sutter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Jun 2007 19:53:18 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:35 +0000</updated>
                            <resolved>Mon, 6 Aug 2007 01:00:08 +0100</resolved>
                                    <version>0.9.7</version>
                                    <fixVersion>1.0.0</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12509181" author="kwsutter" created="Fri, 29 Jun 2007 20:02:08 +0100"  >&lt;p&gt;The result of this type of scenario is that you get duplicate key exceptions because the id generation never takes place.  Thus, you end up with attempting to store multiple rows with the same key of 0:&lt;/p&gt;

&lt;p&gt;Caused by: &amp;lt;0.0.0 nonfatal store error&amp;gt; org.apache.openjpa.util.StoreException: The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or unique index identified by &apos;SQL070629094257460&apos; defined on &apos;GASPURCHASE&apos;. &lt;/p&gt;
{prepstmnt 429791646 INSERT INTO GASPURCHASE (id, DAYNUMBER, GRADENUMBER, PUMPNUMBER, QUANTITY) VALUES (?, ?, ?, ?, ?) [params=(long) 0, (int) 5, (int) 6, (int) 7, (int) 8]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=20000, state=23505&amp;#93;&lt;/span&gt;&lt;br/&gt;
FailedObject: com.ibm.ws.jpa.entities.GasPurchaseProperty@4e144e14&lt;/p&gt;
</comment>
                            <comment id="12509188" author="kwsutter" created="Fri, 29 Jun 2007 20:22:27 +0100"  >&lt;p&gt;New information...&lt;/p&gt;

&lt;p&gt;My original posting wasn&apos;t quite accurate.  You need to mix the use of primitive and wrapper types to get this to fail:&lt;/p&gt;

&lt;p&gt;    private long id;&lt;/p&gt;

&lt;p&gt;    @Id&lt;br/&gt;
    @GeneratedValue(strategy=GenerationType.AUTO)&lt;br/&gt;
    public Long getId() &lt;/p&gt;
{
        return id;
    }
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;    public void setId(Long id) &lt;/p&gt;
{
        this.id = id;
    }

&lt;p&gt;In this case, it seems that the autoboxing feature of Java 5 kicks in and when getId() gets called, the default value of &quot;long id&quot; (0) is returned as an autoboxed Long.  This returned Long object then throws off the conditional code mentioned above and we don&apos;t set the generated value appropriately.&lt;/p&gt;

&lt;p&gt;So, now I go back to my question of why the invocation of sm.isDefaultValue() necessary?  Do we care there&apos;s a default value when we&apos;re generating one anyway?&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12510432" author="pcl" created="Thu, 5 Jul 2007 19:04:57 +0100"  >&lt;p&gt;Man. Another place where property access rules are annoying.&lt;/p&gt;

&lt;p&gt;It seems like one possible solution would be to just expand what is considered a default value to include auto-boxed values, when running in a JDK1.5 or higher environment.&lt;/p&gt;</comment>
                            <comment id="12510456" author="kwsutter" created="Thu, 5 Jul 2007 20:18:48 +0100"  >&lt;p&gt;It&apos;s turning out that this is more than just autoboxing.  The setting of initial values for fields annotated with @GeneratedValue is causing several problems.&lt;/p&gt;

&lt;p&gt;For example, even if I have the same types through the Entity definition (where autoboxing does not come into play)...&lt;/p&gt;

&lt;p&gt;    private Long id = new Long(5);&lt;/p&gt;

&lt;p&gt;    @Id&lt;br/&gt;
    @GeneratedValue(strategy=GenerationType.AUTO)&lt;br/&gt;
    public Long getId() &lt;/p&gt;
{
        return id;
    }

&lt;p&gt;    public void setId(Long id) &lt;/p&gt;
{
        this.id = id;
    }


&lt;p&gt;.. I still get the duplicate key exceptions because our runtime logic doesn&apos;t know the difference between the initial value and somebody setting a value.  As I pointed out in a separate mail thread, the invocation of the setter method was also being allowed to override the @GeneratedValue annotation.  And, once you have set your own id, how do you tell OpenJPA &quot;okay, I&apos;m done now... go ahead and generate the rest of the ids now...&quot;?&lt;/p&gt;

&lt;p&gt;It just seems like we&apos;re opening a can of worms attempting to support both ways.  I think the @GeneratedValue annotation should take precedence.&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12517801" author="kwsutter" created="Mon, 6 Aug 2007 00:59:05 +0100"  >&lt;p&gt;I just committed the changes to resolve this issue.  Per the discussion on our dev mailing list (&lt;a href=&quot;http://www.nabble.com/Allow-overrides-of-%40GeneratedValue--tf4031013.html#a11450606&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Allow-overrides-of-%40GeneratedValue--tf4031013.html#a11450606&lt;/a&gt;), I decided to go with the more direct response as Patrick and others suggested.  That is, if somebody has @GeneratedValue on a field (id or otherwise) and then attempts to set a value either via an initializer or a setter method, then an InvalidStateException will be thrown.  This will immediately let the user know that something isn&apos;t quite right.  At first, I thought this was too drastic and was leaning towards a warning or error message.  But, due to data integrity concerns, I decided to go with an exception to signal the problem.  This will force the user to do something about the situation instead of blindly running with it until s/he notices the error message.&lt;/p&gt;

&lt;p&gt;The exception thrown has a localizer message that indicates the problem and suggested actions to resolve it.&lt;/p&gt;

&lt;p&gt;I also provided a new testcase to test for this new condition and the exception processing.&lt;/p&gt;

&lt;p&gt;I also had to update the TestSharedMappedSuperclassIdValue testcase since it was incorrectly relying on this &quot;incorrect&quot; behavior.&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12517802" author="kwsutter" created="Mon, 6 Aug 2007 01:00:08 +0100"  >&lt;p&gt;Resolved via revision 562987.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 5 Jul 2007 18:04:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18545</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt0c7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>203235</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>