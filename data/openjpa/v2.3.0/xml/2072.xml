<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:45:44 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2072/OPENJPA-2072.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2072] InvalidStateException deleting an instance with a timestamp in its primary key</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2072</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Attempting to remove an instance that has a timestamp field in its primary key results in this error:&lt;br/&gt;
org.apache.openjpa.persistence.InvalidStateException: Operation attempted on a deleted instance.&lt;/p&gt;

&lt;p&gt;Suppose I have this table:&lt;br/&gt;
CREATE TABLE test_tsp (&lt;br/&gt;
   t Timestamp,&lt;br/&gt;
   desc char(30)&lt;br/&gt;
)&lt;/p&gt;

&lt;p&gt;containing just the following row:&lt;br/&gt;
INSERT INTO test_tsp(T,DESC) VALUES ( CURRENT_TIMESTAMP, &apos;one&apos;)&lt;/p&gt;

&lt;p&gt;the table is mapped to this JPA Entity&lt;br/&gt;
@Entity&lt;br/&gt;
@Table(name=&quot;TEST_TSP&quot;)&lt;br/&gt;
public class TestTsp implements Serializable {&lt;br/&gt;
 private static final long serialVersionUID = -5756434331459759089L;&lt;br/&gt;
 @Column(name=&quot;T&quot;)&lt;br/&gt;
 @Id&lt;br/&gt;
 private Timestamp idTsp;&lt;/p&gt;

&lt;p&gt; @Column(name=&quot;DESC&quot;)&lt;br/&gt;
 private String desc;&lt;/p&gt;

&lt;p&gt; public TestTsp() &lt;/p&gt;
{
  super();
 }
&lt;p&gt;...getters and setters here...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;and the following code attempts a delete of the row I&apos;ve inserted&lt;/p&gt;

&lt;p&gt; Query query = em.createQuery(&quot;select t from TestTsp t where t.desc=&apos;one&apos;&quot;);&lt;br/&gt;
 List&amp;lt;TestTsp&amp;gt; list = query.getResultList();&lt;br/&gt;
 for (TestTsp t : list) &lt;/p&gt;
{
  em.remove(t);
 }

&lt;p&gt;Here is the error I get:&lt;br/&gt;
...&lt;br/&gt;
Caused by: &amp;lt;openjpa-1.2.2-r422266:898935 nonfatal user error&amp;gt; org.apache.openjpa.persistence.InvalidStateException: Operation attempted on a deleted instance.&lt;br/&gt;
FailedObject: org.apache.openjpa.enhance.provatsp$TestTsp$pcsubclass@3c0b655a&lt;br/&gt;
        at org.apache.openjpa.kernel.PCState.error(PCState.java:443)&lt;br/&gt;
        at org.apache.openjpa.kernel.PDeletedState.beforeOptimisticWrite(PDeletedState.java:76)&lt;br/&gt;
        at org.apache.openjpa.kernel.StateManagerImpl.dirty(StateManagerImpl.java:1575)&lt;br/&gt;
        at org.apache.openjpa.kernel.StateManagerImpl.dirty(StateManagerImpl.java:1515)&lt;br/&gt;
        at org.apache.openjpa.util.Proxies.dirty(Proxies.java:66)&lt;br/&gt;
        at org.apache.openjpa.util.java$sql$Timestamp$proxy.setNanos(Unknown Source)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.DBDictionary.setTimestamp(DBDictionary.java:1144)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.DBDictionary.setTyped(DBDictionary.java:1282)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.RowImpl.flush(RowImpl.java:890)&lt;br/&gt;
        at org.apache.openjpa.jdbc.sql.RowImpl.flush(RowImpl.java:850)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.flushAndUpdate(PreparedStatementManagerImpl.java:118)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.BatchingPreparedStatementManagerImpl.flushAndUpdate(BatchingPreparedStatementManagerImpl.java:82)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.flushInternal(PreparedStatementManagerImpl.java:89)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.PreparedStatementManagerImpl.flush(PreparedStatementManagerImpl.java:72)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.ConstraintUpdateManager.flush(ConstraintUpdateManager.java:543)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.ConstraintUpdateManager.flush(ConstraintUpdateManager.java:119)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.BatchingConstraintUpdateManager.flush(BatchingConstraintUpdateManager.java:59)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.AbstractUpdateManager.flush(AbstractUpdateManager.java:89)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.AbstractUpdateManager.flush(AbstractUpdateManager.java:72)&lt;br/&gt;
        at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.flush(JDBCStoreManager.java:721)&lt;br/&gt;
        at org.apache.openjpa.kernel.DelegatingStoreManager.flush(DelegatingStoreManager.java:130)&lt;br/&gt;
        ... 40 more&lt;/p&gt;

&lt;p&gt;N.B.: the error doesn&apos;t happen if the primary key annotation (@Id) is moved on the other field of the entity, which is not a timestamp but a char:&lt;br/&gt;
 @Column(name=&quot;T&quot;)&lt;br/&gt;
 private Timestamp idTsp;&lt;/p&gt;

&lt;p&gt; @Column(name=&quot;DESC&quot;)&lt;br/&gt;
 @Id&lt;br/&gt;
 private String desc;&lt;/p&gt;</description>
                <environment>Linux, JUnit + Spring and HSQLDB in a case; Windows, WebSphere and DB2 in another case</environment>
        <key id="12530831">OPENJPA-2072</key>
            <summary>InvalidStateException deleting an instance with a timestamp in its primary key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="helenxu">Helen Xu</assignee>
                                    <reporter username="ericci">Ernesto Ricci</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Nov 2011 08:12:15 +0000</created>
                <updated>Fri, 1 Jun 2012 18:37:21 +0100</updated>
                            <resolved>Fri, 1 Jun 2012 18:37:08 +0100</resolved>
                                    <version>1.2.1</version>
                    <version>1.2.2</version>
                    <version>1.2.3</version>
                                    <fixVersion>1.0.5</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13266653" author="helenxu" created="Wed, 2 May 2012 16:52:57 +0100"  >&lt;p&gt;Before it set the time stamp value to the delete prepared statement, it will set the nanosecond of the time stamp based on the precision.  This setting triggered the dirty update on PDeletedState and caused the invalid state error being generated.&lt;/p&gt;

&lt;p&gt;here is the code path&lt;/p&gt;

&lt;p&gt;	PDeletedState.beforeOptimisticWrite(StateManagerImpl, int, boolean) line: 76	&lt;br/&gt;
	StateManagerImpl.dirty(int, Boolean, boolean) line: 1546	&lt;br/&gt;
	StateManagerImpl.dirty(int) line: 1485	&lt;br/&gt;
	Proxies.dirty(Proxy, boolean) line: 66	&lt;br/&gt;
	java$sql$Timestamp$proxy.setNanos(int) line: not available	&lt;br/&gt;
	DB2Dictionary(DBDictionary).setTimestamp(PreparedStatement, int, Timestamp, Calendar, Column) line: 1103	&lt;br/&gt;
	DB2Dictionary(DBDictionary).setTyped(PreparedStatement, int, Object, Column, int, JDBCStore) line: 1241	&lt;br/&gt;
	PrimaryRow(RowImpl).flush(PreparedStatement, int, DBDictionary, JDBCStore) line: 888	&lt;br/&gt;
	PrimaryRow(RowImpl).flush(PreparedStatement, DBDictionary, JDBCStore) line: 848	&lt;br/&gt;
	PreparedStatementManagerImpl.flushInternal(RowImpl) line: 95	&lt;br/&gt;
	PreparedStatementManagerImpl.flush(RowImpl) line: 73	&lt;br/&gt;
	ConstraintUpdateManager.flush(Collection, PreparedStatementManager) line: 543	&lt;br/&gt;
	ConstraintUpdateManager.flush(RowManager, PreparedStatementManager, Collection) line: 119	&lt;br/&gt;
	ConstraintUpdateManager(AbstractUpdateManager).flush(Collection, JDBCStore, PreparedStatementManager) line: 89	&lt;br/&gt;
	ConstraintUpdateManager(AbstractUpdateManager).flush(Collection, JDBCStore) line: 72	&lt;br/&gt;
	JDBCStoreManager.flush(Collection) line: 514	&lt;br/&gt;
	ROPStoreManager(DelegatingStoreManager).flush(Collection) line: 130	&lt;br/&gt;
	FinalizingBrokerImpl(BrokerImpl).flush(int) line: 1956	&lt;br/&gt;
	FinalizingBrokerImpl(BrokerImpl).flushSafe(int) line: 1854	&lt;br/&gt;
	FinalizingBrokerImpl(BrokerImpl).beforeCompletion() line: 1772	&lt;br/&gt;
	LocalManagedRuntime.commit() line: 81	&lt;br/&gt;
	FinalizingBrokerImpl(BrokerImpl).commit() line: 1294	&lt;br/&gt;
	DelegatingBroker.commit() line: 861	&lt;br/&gt;
	EntityManagerImpl.commit() line: 408&lt;/p&gt;

&lt;p&gt;Fix and test case attached.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525308" name="OPENJPA-2072Patch" size="8001" author="helenxu" created="Wed, 2 May 2012 16:54:24 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 2 May 2012 15:52:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216569</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7pun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>289158</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>