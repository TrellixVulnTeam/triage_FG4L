<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:34:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-148/OPENJPA-148.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-148] Parsing exception while using an &quot;exploded&quot; archive</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-148</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;This happens when using OpenJPA as persistence provider for the EasyBeans ObjectWeb container.&lt;br/&gt;
The error is happening with &quot;exploded&quot; archive.&lt;br/&gt;
Exploded means that there is a directory, named &quot;entitybean.jar&quot; with a folder META-INF which contains a file named persistence.xml, and other directories/files for the classes.&lt;/p&gt;

&lt;p&gt;It seems that when using this mode, OpenJPA is trying to parse the directory inputstream (which is failing).&lt;br/&gt;
This exception is not occuring if a jar file is used instead of the &quot;exploded&quot; mode, but the exploded mode is the default mode for EasyBeans.&lt;br/&gt;
Note also that this exception don&apos;t occur by using Hibernate Entity Manager or Oracle TopLink Essentials as persistence provider.&lt;/p&gt;

&lt;p&gt;I will attach to this issue a stack trace (with the exploded directory) which fails and at the end with a jar file (which work)&lt;br/&gt;
And 4 steps used to reproduce this problem&lt;/p&gt;</description>
                <environment>Sun JDK 5.0 / EasyBeans / OpenJPA snapshot 0.9.7</environment>
        <key id="12362833">OPENJPA-148</key>
            <summary>Parsing exception while using an &quot;exploded&quot; archive</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="benoitf">Florent BENOIT</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Feb 2007 21:45:24 +0000</created>
                <updated>Tue, 9 Mar 2010 18:32:31 +0000</updated>
                            <resolved>Tue, 22 May 2007 17:28:45 +0100</resolved>
                                                    <fixVersion>1.0.0</fixVersion>
                                    <component>jpa</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12473211" author="benoitf" created="Wed, 14 Feb 2007 21:47:36 +0000"  >&lt;p&gt;On the top of the file, the error.&lt;/p&gt;

&lt;p&gt;At the end, the same data but packaged in a .jar file and in this case, it works.&lt;/p&gt;</comment>
                            <comment id="12473213" author="benoitf" created="Wed, 14 Feb 2007 21:48:37 +0000"  >&lt;p&gt;The steps to reproduce this error.&lt;/p&gt;</comment>
                            <comment id="12473942" author="benoitf" created="Sat, 17 Feb 2007 17:13:57 +0000"  >&lt;p&gt;Here is a follow up for explaining the process that OpenJPA is using on exploded jar files:&lt;/p&gt;

&lt;p&gt;The PersistenceUnitInfo object build by the EJB3 container(EasyBeans in my testcase) is sent to OpenJPA.&lt;br/&gt;
Then, in the method toOpenJPAProperties of org.apache.openjpa.persistence.PersistenceUnitInfoImpl class&lt;/p&gt;

&lt;p&gt;The getPersistenceUnitRootUrl() URL (which is the directory URL&lt;br/&gt;
 &lt;a href=&quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&lt;/a&gt;) is transformed&lt;br/&gt;
 into /home/florent/workspace/easybeans/ejb3s/entitybean.jar/ as it is a &quot;file:&quot; URL&lt;/p&gt;


&lt;p&gt;Then, the getJarFileUrls() is returning the same URL (&lt;a href=&quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&lt;/a&gt;)&lt;br/&gt;
This URL is an exploded JAR file URL which is valid for this method as said in the specification&lt;br/&gt;
 &quot;Returns a list of URLs for the jar files or exploded jar file directories that the persistence provider &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&quot;&lt;br/&gt;
 (It has been clarified between the proposed final specification and the final specification)&lt;/p&gt;

&lt;p&gt;The PersistenceUnitInfoImpl class is then transforming these two URLs into:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;Files&quot; property with the value /home/florent/workspace/easybeans/ejb3s/entitybean.jar/&lt;/li&gt;
	&lt;li&gt;&quot;URLs&quot; property with the value &lt;a href=&quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then, these values will be analyzed in  parsePersistentTypeNames(ClassLoader loader) method of&lt;br/&gt;
 the class org.apache.openjpa.meta.AbstractCFMetaDataFactory&lt;/p&gt;

&lt;p&gt;1/ First, the &quot;Files&quot; property is analyzed:&lt;br/&gt;
As /home/florent/workspace/easybeans/ejb3s/entitybean.jar/ is a directory, it goes in:&lt;/p&gt;

&lt;p&gt;                if (file.isDirectory()) &lt;/p&gt;
{
                    if (log.isTraceEnabled())
                        log.trace(_loc.get(&quot;scanning-directory&quot;, file));
                    scan(new FileMetaDataIterator(dir, newMetaDataFilter()),
                        cparser, names, true, file);
                }
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;which found...nothing. (I have done another test with a file for the PersistenceUnitRootUrl&lt;br/&gt;
 (and not a directory) and in this case the scan of the file finds the Entity class while it doesn&apos;t&lt;br/&gt;
 find the entity class in directory mode).&lt;br/&gt;
Also here, dir is null, if dir = file, it finds the entity class.&lt;/p&gt;

&lt;p&gt;The corresponding debug trace is:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;TRACE&amp;#93;&lt;/span&gt; MetaData - Scanning directory &quot;/home/florent/workspace/easybeans/ejb3s/entitybean.jar&quot; for persistent types.&lt;/p&gt;


&lt;p&gt;2/ Then, the &quot;URLs&quot; property is analyzed:&lt;br/&gt;
It&apos;s not a .jar file so the case &quot;else if (url.getPath().endsWith(&quot;.jar&quot;))&quot; is not used and it fallbacks&lt;br/&gt;
 in the default case:&lt;/p&gt;

&lt;p&gt;                } else &lt;/p&gt;
{
                    if (log.isTraceEnabled())
                        log.trace(_loc.get(&quot;scanning-url&quot;, url));
                    clss = cparser.parseTypeNames(new URLMetaDataIterator(url));
                    if (log.isTraceEnabled())
                        log.trace(_loc.get(&quot;scan-found-names&quot;, clss, url));
                    names.addAll(Arrays.asList(clss));
                    mapPersistentTypeNames(url, clss);
                }

&lt;p&gt;And mapPersistentTypeNames method do the following:&lt;br/&gt;
_unparsed.add((URL) rsrc);&lt;/p&gt;

&lt;p&gt;so, the URL which is referencing an exploded jar is considered as an unparsed URL from now.&lt;/p&gt;

&lt;p&gt;The corresponding traces are:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;TRACE&amp;#93;&lt;/span&gt; MetaData - Scanning URL &quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; for persistent types.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;TRACE&amp;#93;&lt;/span&gt; MetaData - Scan of &quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; found persistent types [Ljava.lang.String;@14c7cd.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;TRACE&amp;#93;&lt;/span&gt; MetaData - Mapping resource location &quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; to persistent types &quot;[]&quot;.&lt;/p&gt;

&lt;p&gt;(with [Ljava.lang.String;@14c7cd. being an empty array.)&lt;/p&gt;

&lt;p&gt;When a class needs to be loaded by the load(Class cls, int mode, ClassLoader envLoader) method of org.apache.openjpa.persistence.PersistenceMetaDataFactory class, there is a check on the _unparsed attribute.&lt;/p&gt;

&lt;p&gt;And in this case, it tries to parse the URL as an XML file:&lt;br/&gt;
  for (URL url : _unparsed)&lt;br/&gt;
    parseXML(url, cls, mode, envLoader);&lt;/p&gt;

&lt;p&gt;And we can imagine the result of parsing a directory as an XML file.&lt;/p&gt;

&lt;p&gt;The result is:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;WARN&amp;#93;&lt;/span&gt; Enhance - An exception was thrown while attempting to perform class file transformation on &quot;org/objectweb/easybeans/examples/entitybean/SessionFacadeRemote&quot;: &amp;lt;&amp;lt;0|false|0.9.7-incubating-SNAPSHOT&amp;gt; org.apache.openjpa.util.GeneralException: org.xml.sax.SAXException: &lt;a href=&quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Location: Line: 1, C: 1&amp;#93;&lt;/span&gt;: org.xml.sax.SAXParseException: Content is not allowed in prolog.&amp;gt;&amp;lt;0|false|0.9.7-incubating-SNAPSHOT&amp;gt; org.apache.openjpa.util.GeneralException: org.xml.sax.SAXException: &lt;a href=&quot;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:/home/florent/workspace/easybeans/ejb3s/entitybean.jar/&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Location: Line: 1, C: 1&amp;#93;&lt;/span&gt;: org.xml.sax.SAXParseException: Content is not allowed in prolog.&lt;br/&gt;
	at org.apache.openjpa.persistence.PersistenceMetaDataFactory.parseXML(PersistenceMetaDataFactory.java:233)&lt;/p&gt;


&lt;p&gt;So, I think that you have now a complete report and that you&apos;re understanding why OpenJPA is failing.&lt;/p&gt;

</comment>
                            <comment id="12473943" author="benoitf" created="Sat, 17 Feb 2007 17:14:55 +0000"  >&lt;p&gt;add traces with debug mode on (for the directory failing case)&lt;/p&gt;</comment>
                            <comment id="12473944" author="benoitf" created="Sat, 17 Feb 2007 17:15:47 +0000"  >&lt;p&gt;Add debug traces for the same classes packaged in a .jar file and that is working.&lt;/p&gt;</comment>
                            <comment id="12493227" author="djencks" created="Wed, 2 May 2007 23:05:52 +0100"  >&lt;p&gt;This patch fixes the issue for me in the geronimo integration.  There are 2 changes:&lt;/p&gt;

&lt;p&gt;1. there&apos;s an apparent bug in the treatment of a directory.  There&apos;s a var &quot;dir&quot; which is AFAICT never set that used to be scanned.  I changed it to scan the directory under consideration, which does find the persistent classes in the dir.  I don&apos;t know if dir should be set to one of the scanned directories.&lt;/p&gt;

&lt;p&gt;2. In the geronimo environment, the same locations show up in both the files and urls lists.  I haven&apos;t figured out exactly why.  However, this lets the second part of the fix work, which is to ignore urls that point to a file that has already been scanned.  I think this is probably OK since non-file urls generally can&apos;t be scanned like a directory.  &lt;/p&gt;

&lt;p&gt;I&apos;ll be happy to work on improvements given advice on problems with this patch, but this patch would IMO be a good start.&lt;/p&gt;</comment>
                            <comment id="12493639" author="mprudhom" created="Fri, 4 May 2007 10:38:30 +0100"  >&lt;p&gt;Applied (partial) patch.&lt;/p&gt;</comment>
                            <comment id="12493730" author="djencks" created="Fri, 4 May 2007 17:21:13 +0100"  >&lt;p&gt;Marc did not apply this part of the patch, which was actually the crucial part to get this to work for geronimo &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  As I noted before this may well not be the best way to solve the problem, its only virtue is that it works:&lt;/p&gt;

&lt;p&gt;+                if (&quot;file&quot;.equals(url.getProtocol())) {&lt;br/&gt;
+                    File file = new File(url.getFile()).getAbsoluteFile();&lt;br/&gt;
+                    if (files.contains(file)) &lt;/p&gt;
{
+                        continue;
+                    }
&lt;p&gt;+                }&lt;/p&gt;

&lt;p&gt;For reasons that are not entirely clear to me yet, the war WEB-INF/classes directory is showing up both in the files list (where it is processed correctly) and the urls list where it is causing an error since the code tries to treat it as an xml file.  The patch excerpt above is a bit of a hack but it checks each url to see if it matches a file in the files list and if so skips it.  In particular the directory WEB-INF/classes is matched so it is skipped, thus sidestepping the problem.&lt;/p&gt;

&lt;p&gt;IMO it would be better to avoid duplicating locations in the files and urls list but I haven&apos;t figured out how to make that happen yet.  I don&apos;t see much harm in this patch in any case since AFAICT there is never a reason to process a location twice.&lt;/p&gt;</comment>
                            <comment id="12493735" author="mprudhom" created="Fri, 4 May 2007 17:38:08 +0100"  >&lt;p&gt;I understand the reason for that part now. I&apos;ve applied and committed the rest of the patch. Please comment in this issue if you still experience the problem with this patch.&lt;/p&gt;</comment>
                            <comment id="12493736" author="clr" created="Fri, 4 May 2007 17:38:17 +0100"  >&lt;p&gt;Just thinking a bit outside the box here. Is it possibly a bug that the classes directory is being presented as a file? &lt;/p&gt;

&lt;p&gt;And perhaps defensively OpenJPA might check to see if the file is actually a directory and then just ignore it. i.e. if (file.isDirectory()) continue;&lt;/p&gt;

&lt;p&gt;But I&apos;d like to see a bit more investigation into whether the behavior of the container is correct. It does seem odd that the container is expecting the provider to remove duplicate items from the deployment artifact.&lt;/p&gt;</comment>
                            <comment id="12493739" author="benoitf" created="Fri, 4 May 2007 17:57:26 +0100"  >&lt;p&gt;I tested with the last revision 535321 (that includes the second commit of this patch) and the deployment works fine on EasyBeans when using exploded archive.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12493746" author="djencks" created="Fri, 4 May 2007 18:09:45 +0100"  >&lt;p&gt;Craig said...&lt;br/&gt;
&amp;lt;Just thinking a bit outside the box here. Is it possibly a bug that the classes directory is being presented as a file?&lt;/p&gt;

&lt;p&gt;I don&apos;t think presenting it as a file is a problem, that part works fine.  Presenting it as a URL is what causes problems.&lt;/p&gt;

&lt;p&gt;&amp;lt;And perhaps defensively OpenJPA might check to see if the file is actually a directory and then just ignore it. i.e. if (file.isDirectory()) continue;&lt;/p&gt;

&lt;p&gt;A couple lines above this patch file.isDirectory() is treated correctly, and ignoring it is not necessary &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;But I&apos;d like to see a bit more investigation into whether the behavior of the container is correct. It does seem odd that the container is expecting the provider to remove duplicate items from the &amp;lt;deployment artifact.&lt;/p&gt;

&lt;p&gt;I agree.  I think there&apos;s something wrong that the same things are showing up in the list of files and the list of urls.  However based on my very limited tracing through the code I think this is caused by some multiple format conversions openjpa is doing: list of urls &amp;gt;&amp;gt; &apos;;&apos; separated string &amp;gt;&amp;gt; list of files + list of urls.  I haven&apos;t figured out exactly what is going on here, and any comments on the codes&apos; purpose would be welcome &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

</comment>
                            <comment id="12496408" author="djencks" created="Wed, 16 May 2007 22:17:04 +0100"  >&lt;p&gt;Some more experience indicates my previous patch suffers from at least 2 problems:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;NPE if files is null&lt;/li&gt;
	&lt;li&gt;If one of the URLs is a directory, but not a file, we still get the same problem of trying to read a directory like an xml document.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12496410" author="djencks" created="Wed, 16 May 2007 22:17:50 +0100"  >&lt;p&gt;Attached patch fixes the 2 additional issues I&apos;ve found.&lt;/p&gt;</comment>
                            <comment id="12497575" author="mprudhom" created="Mon, 21 May 2007 21:44:42 +0100"  >&lt;p&gt;I&apos;ve gone ahead and applied &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-148&quot; title=&quot;Parsing exception while using an &amp;quot;exploded&amp;quot; archive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-148&quot;&gt;&lt;del&gt;OPENJPA-148&lt;/del&gt;&lt;/a&gt;-2.patch. If this works for you, please go ahead and mark this issue as resolved.&lt;/p&gt;</comment>
                            <comment id="12497922" author="djencks" created="Tue, 22 May 2007 17:28:45 +0100"  >&lt;p&gt;It works for geronimo now, many thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12357497" name="OPENJPA-148-2.patch" size="1798" author="djencks" created="Wed, 16 May 2007 22:17:50 +0100"/>
                            <attachment id="12356673" name="OPENJPA-148.patch" size="2205" author="djencks" created="Wed, 2 May 2007 23:05:51 +0100"/>
                            <attachment id="12351432" name="debug_traces_directorymode.txt" size="13971" author="benoitf" created="Sat, 17 Feb 2007 17:14:55 +0000"/>
                            <attachment id="12351433" name="debug_traces_filemode_working.txt" size="4369" author="benoitf" created="Sat, 17 Feb 2007 17:15:47 +0000"/>
                            <attachment id="12351179" name="stacktrace-error.txt" size="14455" author="benoitf" created="Wed, 14 Feb 2007 21:47:36 +0000"/>
                            <attachment id="12351180" name="steps.txt" size="14524" author="benoitf" created="Wed, 14 Feb 2007 21:48:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 2 May 2007 22:05:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160482</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7jqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>288167</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>