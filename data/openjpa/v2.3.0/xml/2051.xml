<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:31:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2051/OPENJPA-2051.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2051] Entities in a relationship are not properly cascaded after a EntityManager.flush is executed.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2051</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;I&apos;ve found a scenario where upon transaction commit, certain entities which should be persisted via a cascade operation are not present in the database.  To properly describe this issue, let me start by first introducing a few entities, and then list a snippet of a test which uses these entities to recreate an issue with cascading entities.  That said, take the following three entities:&lt;/p&gt;

&lt;p&gt;public class Vertex {&lt;/p&gt;

&lt;p&gt;    @Id&lt;br/&gt;
    @GeneratedValue(strategy = GenerationType.AUTO)&lt;br/&gt;
    private long oid;&lt;/p&gt;

&lt;p&gt;    @OneToMany(mappedBy = &quot;source&quot;, cascade = CascadeType.ALL)&lt;br/&gt;
    private List&amp;lt;Edge&amp;gt; outgoing;&lt;/p&gt;

&lt;p&gt;    @OneToMany(mappedBy = &quot;target&quot;, cascade = CascadeType.ALL)&lt;br/&gt;
    private List&amp;lt;Edge&amp;gt; incoming;&lt;/p&gt;

&lt;p&gt;    @ManyToOne(cascade = CascadeType.ALL)&lt;br/&gt;
    @JoinColumn(name = &quot;TYPE_OID&quot;)&lt;br/&gt;
    private VertexType type;&lt;/p&gt;

&lt;p&gt;    public Edge newEdge( Vertex target ) &lt;/p&gt;
{
        Edge t = new Edge( this );
        outgoing.add( t );
        t.setTarget( target );
        return t;
    }
&lt;p&gt;.........&lt;/p&gt;


&lt;p&gt;public class VertexType {&lt;/p&gt;

&lt;p&gt;    @Id&lt;br/&gt;
    @GeneratedValue(strategy = GenerationType.AUTO)    &lt;br/&gt;
    private long oid;&lt;/p&gt;

&lt;p&gt;    @OneToMany(mappedBy = &quot;type&quot;, cascade = CascadeType.ALL)&lt;br/&gt;
    List&amp;lt;Vertex&amp;gt; instances;&lt;/p&gt;

&lt;p&gt;    private String name;&lt;br/&gt;
.........&lt;/p&gt;


&lt;p&gt;public class Edge {&lt;/p&gt;

&lt;p&gt;    @Id&lt;br/&gt;
    @GeneratedValue(strategy = GenerationType.AUTO)&lt;br/&gt;
    private long oid;&lt;/p&gt;

&lt;p&gt;    @ManyToOne(cascade = CascadeType.ALL)&lt;br/&gt;
    @JoinColumn(name = &quot;SOURCE_OID&quot;)&lt;br/&gt;
    private Vertex source;&lt;/p&gt;

&lt;p&gt;    @ManyToOne(cascade = CascadeType.ALL)&lt;br/&gt;
    @JoinColumn(name = &quot;TARGET_OID&quot;)&lt;br/&gt;
    private Vertex target;&lt;br/&gt;
.........&lt;/p&gt;



&lt;p&gt;Before describing the test case, let me point out a couple important things about these entities.  First you will notice that each entity contains a generated id.  Second, notice that there are multiple relationships between these entities. &lt;/p&gt;

&lt;p&gt;Now let me introduce the test: &lt;/p&gt;

&lt;p&gt;EntityManager em = emf.createEntityManager();&lt;br/&gt;
EntityTransaction tx = em.getTransaction();&lt;/p&gt;

&lt;p&gt;tx.begin();&lt;br/&gt;
em.flush();&lt;/p&gt;

&lt;p&gt;VertexType defaultType = new VertexType( &quot;default&quot; );&lt;br/&gt;
VertexType specialType = new VertexType( &quot;special&quot; );&lt;/p&gt;

&lt;p&gt;em.persist(defaultType);&lt;br/&gt;
em.persist(specialType);&lt;/p&gt;

&lt;p&gt;Vertex src = new Vertex( defaultType );&lt;br/&gt;
Vertex target = new Vertex( specialType );&lt;/p&gt;

&lt;p&gt;Edge t = src.newEdge( target );&lt;br/&gt;
assertNotNull( t );&lt;/p&gt;

&lt;p&gt;em.persist(src);&lt;br/&gt;
tx.commit();&lt;/p&gt;


&lt;p&gt;Notice that one of the first things the test does is to perform a flush.  This may seem slightly odd, however this flush is important to cause the issue.  We could execute a query or some other operation which would cause a flush under the covers, however, calling a flush directly makes it clear that a flush has occurred when looking at the rest of the test.  &lt;/p&gt;

&lt;p&gt;With the entities and test case in place, let me now describe the issue.  After this test case executes, there should exist in the database two Vertex, two VertexType, and one Edge given the cascade type defined in the entities.  However, I find that one of the Vertex is missing.  &lt;/p&gt;

&lt;p&gt;In working with Rick Curtis on this issue, he found that the &apos;flush&apos; at the beginning of the test had an effect on the cascade persist at the end of the test.  That is, when &apos;flush&apos; is called, this causes the &apos;_flags&apos; variable in BrokerImpl to be set to flushed as follows:&lt;/p&gt;

&lt;p&gt;_flags |= FLAG_FLUSHED;&lt;/p&gt;

&lt;p&gt;This of course effects the return value of the method BrokerImpl.hasFlushed:&lt;/p&gt;

&lt;p&gt;    private boolean hasFlushed() &lt;/p&gt;
{
        return (_flags &amp;amp; FLAG_FLUSHED) != 0;
    }

&lt;p&gt;I will now describe how the return value of this method effects the outcome of the test.  However, in an effort of time I am going to skip over some details which I&apos;ll leave as an exercise for the reader to figure out (e.g. execute the test in a debugger).  Basically this has an effect on SingleFieldManager.persist when called by StateManagerImpl.cascadePersist.  That is, SingleFieldManager.persist makes a call to method &apos;isDetached&apos; on the broker here:&lt;/p&gt;

&lt;p&gt; case JavaTypes.PC_UNTYPED:&lt;br/&gt;
     if (!_broker.isDetachedNew() &amp;amp;&amp;amp; _broker.isDetached(objval))&lt;br/&gt;
         return; // allow but ignore&lt;br/&gt;
     _broker.persist(objval, true, call);&lt;br/&gt;
     break;&lt;/p&gt;

&lt;p&gt;Code within &apos;isDetached&apos; eventually makes a call to &apos;hasFlushed&apos;.  Given that &apos;hasFlushed&apos; returns true, it ultimately effects the result of &apos;isDetached&apos; and thus causing the persist method in the previously posted code block to be skipped.  Again, I&apos;m glossing over some details, but the code path described is also affected by the fact that the ids in these entities are auto generated.&lt;/p&gt;


&lt;p&gt;In order to resolve this problem, we feel the best solution is to change the &apos;_flags&apos; variable to indicate a flush has not occurred.  To that end, we propose adding the assignment &apos;_flags &amp;amp;= ~FLAG_FLUSHED&apos;&lt;br/&gt;
to this portion of code in BrokerImpl.setStateManager:&lt;/p&gt;

&lt;p&gt;     case STATUS_INIT:&lt;br/&gt;
     	   _flags &amp;amp;= ~FLAG_FLUSHED;&lt;br/&gt;
         _cache.add(sm);&lt;br/&gt;
         break;&lt;/p&gt;


&lt;p&gt;In addition, this new assignment will be gated by a compatibility property.&lt;/p&gt;

&lt;p&gt;I&apos;ve included a test patch, named &apos;CascadePersistIssue.test.patch&apos; which replicates the issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12523252">OPENJPA-2051</key>
            <summary>Entities in a relationship are not properly cascaded after a EntityManager.flush is executed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jpaheath">Heath Thomann</assignee>
                                    <reporter username="jpaheath">Heath Thomann</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Sep 2011 22:12:58 +0100</created>
                <updated>Wed, 6 Mar 2013 20:28:39 +0000</updated>
                            <resolved>Fri, 1 Jun 2012 18:47:35 +0100</resolved>
                                    <version>2.0.0</version>
                    <version>2.1.1</version>
                    <version>2.2.0</version>
                                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13105690" author="jpaheath" created="Thu, 15 Sep 2011 22:14:53 +0100"  >&lt;p&gt;Attaching a test case which replicates the issue described.&lt;/p&gt;</comment>
                            <comment id="13595067" author="jpaheath" created="Wed, 6 Mar 2013 20:28:39 +0000"  >&lt;p&gt;Note that prior to 2.2.1.x/2.2.x, the code of this fix is enabled with the following system property:&lt;/p&gt;

&lt;p&gt;&amp;lt;property name=&quot;openjpa.Compatibility&quot; value=&quot;resetFlushFlagForCascadePersist=true&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Heath&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12538078">OPENJPA-2107</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12494695" name="CascadePersistIssue.test.patch" size="11928" author="jpaheath" created="Thu, 15 Sep 2011 22:14:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2275</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7pj3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>289106</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>