<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:31:12 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-245/OPENJPA-245.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-245] Attach NEW and auto-increment identity</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-245</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;According to documentation (1.2 Attach Behavior), when an entity instance is NEW (never detached):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If neither of the above cases apply, OpenJPA will check to see if an instance with the same primary key values exists in the database. If so, the object is considered detached. Otherwise, it is considered new.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This doesn&apos;t work for me - a new record in database is created on commit instead of updating the existing one. The &quot;regular&quot; case - detach/modify/attach works fine - the existing record is updated.&lt;/p&gt;

&lt;p&gt;It is very easy to reproduce - just create a new instance of an entity, assign an already existing primary key, call em.merge() and commit. A new record will be created in database, with new, auto-generated primary key.&lt;/p&gt;

&lt;p&gt;I stumbled on this trying to implement a web service that uses OpenJPA-based backend. When servicing an &quot;update&quot; request, the web service instantiates a NEW object (by performing XML de-serialization) and calls em.merge to update the entity. A new record gets created instead of updating an existing one.&lt;/p&gt;

&lt;p&gt;------------ Entity class (START) ------------------------------&lt;/p&gt;

&lt;p&gt;package exaple;&lt;/p&gt;

&lt;p&gt;public class Consumer implements java.io.Serializable {&lt;/p&gt;

&lt;p&gt;  private long id;&lt;/p&gt;

&lt;p&gt;  public long getId() &lt;/p&gt;
{
    return this.id;
  }

&lt;p&gt;  public void setId(long id) &lt;/p&gt;
{
    this.id = id;
  }

&lt;p&gt;  private java.lang.String firstName;&lt;/p&gt;

&lt;p&gt;  public java.lang.String getFirstName() &lt;/p&gt;
{
    return this.firstName;
  }

&lt;p&gt;  public void setFirstName(java.lang.String firstName) &lt;/p&gt;
{
    this.firstName = firstName;
  }

&lt;p&gt;  private java.lang.String lastName;&lt;/p&gt;

&lt;p&gt;  public java.lang.String getLastName() &lt;/p&gt;
{
    return this.lastName;
  }

&lt;p&gt;  public void setLastName(java.lang.String lastName) &lt;/p&gt;
{
    this.lastName = lastName;
  }

&lt;p&gt;------------ Entity class (END) ------------------------------&lt;br/&gt;
------------ persistence.xml (START) ------------------------------&lt;br/&gt;
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;br/&gt;
&amp;lt;persistence xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; version=&quot;1.0&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;persistence-unit name=&quot;example&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;provider&amp;gt;org.apache.openjpa.persistence.PersistenceProviderImpl&amp;lt;/provider&amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;!-- We must enumerate each entity in the persistence unit --&amp;gt;&lt;br/&gt;
        &amp;lt;class&amp;gt;example.Consumer&amp;lt;/class&amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;properties&amp;gt;&lt;/p&gt;

&lt;p&gt;            &amp;lt;property name=&quot;openjpa.jdbc.DBDictionary&quot; value=&quot;postgres&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.ConnectionDriverName&quot; value=&quot;org.postgresql.Driver&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.ConnectionUserName&quot; value=&quot;app_user&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.ConnectionPassword&quot; value=&quot;app_user&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.ConnectionURL&quot; value=&quot;jdbc:postgresql://localhost/alikic&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.Log&quot; value=&quot;DefaultLevel=WARN,SQL=TRACE&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;/properties&amp;gt;&lt;br/&gt;
    &amp;lt;/persistence-unit&amp;gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;/persistence&amp;gt;&lt;br/&gt;
------------ persistence.xml (END) ------------------------------&lt;br/&gt;
------------ orm.xml (START) ------------------------------&lt;br/&gt;
&amp;lt;entity-mappings xmlns=&quot;http://java.sun.com/xml/ns/persistence/orm&quot; &lt;br/&gt;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &lt;br/&gt;
    xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/persistence/orm orm_1_0.xsd&quot;&lt;br/&gt;
    version=&quot;1.0&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;entity class=&quot;example.Consumer&quot;&amp;gt;&lt;br/&gt;
        &amp;lt;attributes&amp;gt;&lt;br/&gt;
            &amp;lt;id name=&quot;id&quot;&amp;gt;&lt;br/&gt;
                &amp;lt;generated-value strategy=&quot;IDENTITY&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;/id&amp;gt;&lt;br/&gt;
            &amp;lt;basic name=&quot;firstName&quot;&amp;gt;&lt;br/&gt;
                &amp;lt;column name=&quot;first_name&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;/basic&amp;gt;&lt;br/&gt;
            &amp;lt;basic name=&quot;lastName&quot;&amp;gt;&lt;br/&gt;
                &amp;lt;column name=&quot;last_name&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;/basic&amp;gt;&lt;br/&gt;
        &amp;lt;/attributes&amp;gt;&lt;br/&gt;
    &amp;lt;/entity&amp;gt;&lt;br/&gt;
&amp;lt;/entity-mappings&amp;gt;&lt;br/&gt;
------------ orm.xml (END) ------------------------------&lt;/p&gt;</description>
                <environment>jdk1.5.0_11, Win XP, Fedora Core 6, Postgres 8.1 (on Fedora)</environment>
        <key id="12370345">OPENJPA-245</key>
            <summary>Attach NEW and auto-increment identity</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikedd">Michael Dick</assignee>
                                    <reporter username="alikic">Aleksandar Likic</reporter>
                        <labels>
                    </labels>
                <created>Sun, 27 May 2007 15:03:51 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:35 +0000</updated>
                            <resolved>Tue, 29 Jan 2008 06:44:06 +0000</resolved>
                                    <version>0.9.6</version>
                    <version>0.9.7</version>
                                    <fixVersion>1.0.3</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>jpa</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12499851" author="ppoddar@apache.org" created="Tue, 29 May 2007 18:19:52 +0100"  >
&lt;p&gt;merge() to identify that the the merged entity instance is not &lt;b&gt;truely&lt;/b&gt; new but a version of a instance that is already persistent, the entity requires a version field.&lt;br/&gt;
If the merged instance was a clone created out of serialization and desrialization, then OpenJPA will maintain the required bits to identify the difference between a truly new instance and an instance that has been detached.&lt;/p&gt;
</comment>
                            <comment id="12499865" author="ppoddar@apache.org" created="Tue, 29 May 2007 19:00:43 +0100"  >&lt;p&gt;Attached a test case that demonstates merge() behaviour of entities with or without a version field and when the merged instance is a clone or a copy. A clone is created by serialization+deserialization of the original persistent instance. A copy is created by Java new() operator and then fields values are set equal to the original persistent instance (including the primary key field). &lt;/p&gt;

&lt;p&gt;Thus we have four scenarios:&lt;br/&gt;
1. Unversioned + Copy&lt;br/&gt;
2. Unversioned + Clone&lt;br/&gt;
3. Versioned + Copy&lt;br/&gt;
4. Versioned + Clone&lt;/p&gt;

&lt;p&gt;The  first case originated this issue (at least that&apos;s what I gathered from the description). The first case behaves &apos;rationally but non-intutively&apos;. It creates a new database record rather than updating the existing one. The merge() operation does not see a versioned field, treats the argument instance as a new instance, assigns a new identity (ignoring what the application has set).&lt;br/&gt;
If the entity were using application identity, one would have encountered a DuplicateKeyException of some sort, I presume but not tested here.&lt;/p&gt;

&lt;p&gt;The rest three cases update the existing record. In the third case, the user application has to copy the version field for merge() to treat the merged instance &apos;correctly&apos; i.e. as a update rather than an insert of a new record. This seems to be the solution to the original use cse &amp;#8211; add a version field and copy the version field to the merged instance.      &lt;/p&gt;
</comment>
                            <comment id="12499951" author="ppoddar@apache.org" created="Tue, 29 May 2007 23:43:14 +0100"  >&lt;p&gt;From openjpa documentation (ref: 1.2.  Attach Behavior)&lt;/p&gt;

&lt;p&gt;&quot;  * If the instance was detached and detached state is enabled, OpenJPA will use the detached state to determine the object&apos;s version and primary key values. In addition, this state will tell OpenJPA which fields were loaded at the time of detach, and in turn where to expect changes. Loaded detached fields with null values will set the attached instance&apos;s corresponding fields to null.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If the instance has a Version field, OpenJPA will consider the object detached if the version field has a non-default value, and new otherwise.&lt;/li&gt;
	&lt;li&gt;If neither of the above cases apply, OpenJPA will check to see if an instance with the same primary key values exists in the database. If so, the object is considered detached. Otherwise, it is considered new.&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The implementaion does not seem to adhere to the last statement above. This is observed by the original scenario described in this issue as well as the attached testcase testMergeUnversionedNewObjectCreatesNewRecord(). &lt;/p&gt;

&lt;p&gt;AttachStrategy implementaion is responsible for merge().  For a newly created entity instance even if it carries id of a persistent record &amp;#8211; the  attach strategy selected (by AttachManager.getStrategy() method) is VersionAttachStrategy. Now, VersionAttachStrategy determines whether the instance to be attached is new by the following logic:&lt;/p&gt;

&lt;p&gt;boolean isNew = !broker.isDetached(pc); // VersionAttachStrategy.java:70&lt;/p&gt;

&lt;p&gt;which turns out to be true in this case. &lt;/p&gt;

&lt;p&gt;With the current implementation, VersionAttachStrategy does not detect that a) the instance to be attached is carrying a primary key equal to a pre-existing data record and b) hence it should be an update and not an insert. However, it passes the instance as PNEW further downstream to be flushed (the instance is still carrying a primary key value same as the one set by the application and a record with the same key exists). However, as the identity field is annotated with GenerateValue.IDENTITY &amp;#8211; the PNEW instance gets stored without a duplicate key exception and its primary key in the database is auto incremented. That the primary key value assigned by the user application is ignored and a new value is assigned can also be verified (see the testcase).     &lt;/p&gt;

&lt;p&gt;This is the flow for a new instance being merged in a context which is not managing another instance with the same primary key. If the new instance carrying an existing key was merged to a EntityManager that already is managing another instance, because the attach strategy still considered the to be merged instance as PNEW &amp;#8211; a EntityExistsException is raised by the object management kernel even before attampting a flush to the database.&lt;/p&gt;</comment>
                            <comment id="12500235" author="ppoddar@apache.org" created="Wed, 30 May 2007 21:58:05 +0100"  >&lt;p&gt;An entity instance x which has been created by new() operator and carrying a existing id (say idx) set by the user application is treated as detached by merge() when the entity class is annotated with @DetachState(enabled=false). Then merge() updates the existing database record with current state of x. If it is not annotated with @DetachState(enabled=false), the instance x is trated as a new instance, and if the entity is using auto-generated identity, a new database record is created, ignoring the id set by the application. However, if the entitymanager doing the merge() is already managing an instance with the same identity idx then an EntityExists exception is raised. &lt;/p&gt;

&lt;p&gt;The generated enhanced code differs based on @DetachedState setting. &lt;br/&gt;
So if the application has changed this setting, the entity must be enhanced again.   &lt;/p&gt;

</comment>
                            <comment id="12561502" author="mikedd" created="Tue, 22 Jan 2008 22:45:13 +0000"  >&lt;p&gt;I&apos;m still seeing this problem on 1.0.x, and trunk. Attaching a patch for 1.0.1. I believe this resolves the problem. I&apos;ll commit to trunk and 1.0.x shortly. &lt;/p&gt;</comment>
                            <comment id="12562583" author="pcl" created="Fri, 25 Jan 2008 17:13:31 +0000"  >&lt;p&gt;I believe that the changes made for this issue will circumvent some of the more intelligent behavior in more-sophisticated attach strategies, which are used when the instance being attached is an enhanced type that was previously detached (vs. a newly-created instance).&lt;/p&gt;

&lt;p&gt;The attached patch moves the changes to VersionAttachManager, which is invoked when other strategies can&apos;t be found.&lt;/p&gt;

&lt;p&gt;We should probably come up with some more complex test scenarios involving graphs of newly-created instances and mixed graphs.&lt;/p&gt;</comment>
                            <comment id="12563402" author="pcl" created="Tue, 29 Jan 2008 06:44:06 +0000"  >&lt;p&gt;Resolved with r615317.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12374063" name="OPENJPA-245.patch" size="4247" author="pcl" created="Fri, 25 Jan 2008 17:13:30 +0000"/>
                            <attachment id="12373786" name="OPENJPA-245.patch.txt" size="6864" author="mikedd" created="Tue, 22 Jan 2008 22:45:13 +0000"/>
                            <attachment id="12358445" name="TestMerge.zip" size="4572" author="ppoddar@apache.org" created="Tue, 29 May 2007 19:00:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 29 May 2007 17:19:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18529</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysw6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202563</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>