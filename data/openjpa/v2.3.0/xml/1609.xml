<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:32:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1609/OPENJPA-1609.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1609] PessimisticLockException instead of LockTimeoutException thrown on DB2V9 for ZOS</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1609</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;I am observing the following problem while working with OpenJPA 2.x on DB2v91 for z/OS:&lt;/p&gt;

&lt;p&gt;When performing a EntityManager.find() with a lock timeout property set, I&apos;m expecting to receive a LockTimeoutException if my find operation fails to fetch the data from the database within the specified timeout period.  Instead of getting the LockTimeoutException, I am getting a PessimisticLockException &amp;#8211; an Exception that is considerably more severe then is expected.&lt;/p&gt;

&lt;p&gt;I looked at the stack trace, and found the following information:&lt;/p&gt;

&lt;p&gt;**Exception: Caught unexpected exception from find.&lt;br/&gt;
    org.apache.openjpa.persistence.PessimisticLockException:Unable to obtain an object lock on &quot;null &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.String&amp;#93;&lt;/span&gt;&quot;.&lt;br/&gt;
FailedObject: 1 &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.openjpa.util.IntId&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.String&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.DBDictionary.narrow(DBDictionary.java:4809)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.DBDictionary.newStoreException(DBDictionary.java:4787)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.DB2Dictionary.newStoreException(DB2Dictionary.java:563)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.SQLExceptions.getStore(SQLExceptions.java:136)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.SQLExceptions.getStore(SQLExceptions.java:86)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.initialize(JDBCStoreManager.java:339)&lt;br/&gt;
	at com.ibm.ws.persistence.jdbc.kernel.WsJpaJDBCStoreManager.initialize(WsJpaJDBCStoreManager.java:147)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingStoreManager.initialize(DelegatingStoreManager.java:111)&lt;br/&gt;
	at org.apache.openjpa.kernel.ROPStoreManager.initialize(ROPStoreManager.java:57)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.initialize(BrokerImpl.java:1005)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.find(BrokerImpl.java:963)&lt;br/&gt;
	at org.apache.openjpa.kernel.BrokerImpl.find(BrokerImpl.java:880)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBroker.find(DelegatingBroker.java:222)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerImpl.find(EntityManagerImpl.java:496)&lt;br/&gt;
	at suite.r80.base.jpaspec.entitymanager.testlogic.FindLockTestLogic.testScenarioL009(FindLockTestLogic.java:2150)&lt;br/&gt;
...&lt;br/&gt;
Caused by: org.apache.openjpa.lib.jdbc.ReportingSQLException: DB2 SQL Error: SQLCODE=-913, SQLSTATE=57033, SQLERRMC=00C9008E;00000304;DSN00292.JPA20EME.X&apos;00000002&apos;.X&apos;01&apos;, DRIVER=3.57.91 &lt;/p&gt;
{prepstmnt 2135785293 SELECT t0.version, t1.id, t1.version, t1.ENTITYALAZY_ID, t1.strData, t0.strData FROM JPA20EMEntityA t0 LEFT OUTER JOIN JPA20EMEntityC t1 ON t0.id = t1.ENTITYA_ID WHERE t0.id = ?  optimize for 1 row FOR READ ONLY WITH RR USE AND KEEP UPDATE LOCKS [params=(int) 1]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=-913, state=57033&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator.wrap(LoggingConnectionDecorator.java:257)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator.wrap(LoggingConnectionDecorator.java:241)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator.access$700(LoggingConnectionDecorator.java:70)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.LoggingConnectionDecorator$LoggingConnection$LoggingPreparedStatement.executeQuery(LoggingConnectionDecorator.java:1063)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.DelegatingPreparedStatement.executeQuery(DelegatingPreparedStatement.java:278)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCStoreManager$CancelPreparedStatement.executeQuery(JDBCStoreManager.java:1706)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.DelegatingPreparedStatement.executeQuery(DelegatingPreparedStatement.java:268)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.SelectImpl.executeQuery(SelectImpl.java:471)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.SelectImpl.execute(SelectImpl.java:396)&lt;br/&gt;
	at com.ibm.ws.persistence.jdbc.sql.SelectImpl.execute(SelectImpl.java:77)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.SelectImpl.execute(SelectImpl.java:354)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.getInitializeStateResult(JDBCStoreManager.java:577)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.initializeState(JDBCStoreManager.java:379)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCStoreManager.initialize(JDBCStoreManager.java:334)&lt;br/&gt;
	... 43 more&lt;/p&gt;

&lt;p&gt;The problem is that OpenJPA does not properly process the combination of SQLCODE=-913, SQLSTATE=57033, and SQLERRMC=00C9008E.&lt;br/&gt;
The RedBook &quot;DB2 for z/OS Stored Procedures: Through the CALL and Beyond&quot; page 188 states:&lt;/p&gt;

&lt;p&gt;-913&lt;br/&gt;
UNSUCCESSFUL EXECUTION CAUSED BY DEADLOCK OR TIMEOUT. REASON CODE reason-code, TYPE &lt;br/&gt;
OF RESOURCE resource-type, AND RESOURCE NAME resource-name&lt;/p&gt;

&lt;p&gt;Explanation: The application was the victim in a deadlock or experienced a time-out. The&lt;br/&gt;
reason code indicates whether a deadlock or time-out occurred.&lt;/p&gt;

&lt;p&gt;SQLERRD(3) also contains the reason-code which indicates whether a deadlock or time-out &lt;br/&gt;
occurred. The most common reason codes are:&lt;/p&gt;

&lt;p&gt;00C90088 - deadlock &lt;br/&gt;
00C9008E - time-out&lt;/p&gt;

&lt;p&gt;Response: The application should either commit or roll back to the previous COMMIT. Then,&lt;br/&gt;
generally, the application should terminate. See message DSNT376I in DB2 UDB for z/OS&lt;br/&gt;
Version 8 Messages and Codes, GC18-7422, for possible ways to avoid future deadlocks or&lt;br/&gt;
time-outs.&lt;/p&gt;

&lt;p&gt;The error being reported by DB2V9 on zOS is &quot;SQLCODE=-913, SQLSTATE=57033, SQLERRMC=00C9008E&quot;, which indicates that&lt;br/&gt;
the reason for the unsuccessful execution is a Timeout, not a Deadlock.  &lt;/p&gt;

&lt;p&gt;Presently, the DB2Dictionary.isFatalException() method does not support that combination.&lt;/p&gt;

&lt;p&gt;I&apos;ve made a change to the isFatalException() method that considers that error combination, and the expected LockTimeoutException now surfaces.  I will post the patch on to this JIRA in a few minutes.&lt;/p&gt;</description>
                <environment>DB2V91 on z/OS</environment>
        <key id="12460975">OPENJPA-1609</key>
            <summary>PessimisticLockException instead of LockTimeoutException thrown on DB2V9 for ZOS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fyrewyld">Jody Grassel</assignee>
                                    <reporter username="fyrewyld">Jody Grassel</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Apr 2010 23:21:46 +0100</created>
                <updated>Thu, 22 Apr 2010 21:30:14 +0100</updated>
                            <resolved>Wed, 7 Apr 2010 21:04:34 +0100</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                    <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12458864">OPENJPA-1565</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12441062" name="OpenJPA-1609.patch" size="1425" author="fyrewyld" created="Wed, 7 Apr 2010 18:49:40 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161869</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt2lb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>203600</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>