<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:46:24 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1367/OPENJPA-1367.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1367] H2 Database Engine does support cross join</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1367</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;The documentation says that the H2 database does not support cross joins:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://openjpa.apache.org/builds/1.2.1/apache-openjpa-1.2.1/docs/manual/dbsupport_h2.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://openjpa.apache.org/builds/1.2.1/apache-openjpa-1.2.1/docs/manual/dbsupport_h2.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://openjpa.apache.org/builds/2.0.0-M3/apache-openjpa-2.0.0-M3/docs/manual/main.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://openjpa.apache.org/builds/2.0.0-M3/apache-openjpa-2.0.0-M3/docs/manual/main.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;H2 does support cross join since a long time (I don&apos;t remember what version). See: &lt;a href=&quot;http://www.h2database.com/html/grammar.html#table_expression&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.h2database.com/html/grammar.html#table_expression&lt;/a&gt; (CROSS). A condition is not required for cross join.&lt;/p&gt;

&lt;p&gt;I think the documentation should be changed, and probably the H2Dictionary should be changed as well (crossJoinClause = &quot;CROSS JOIN&quot;; requiresConditionForCrossJoin = false&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12439523">OPENJPA-1367</key>
            <summary>H2 Database Engine does support cross join</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="milosz">Milosz Tylenda</assignee>
                                    <reporter username="tmueller">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Oct 2009 13:00:06 +0000</created>
                <updated>Tue, 9 Mar 2010 18:31:23 +0000</updated>
                            <resolved>Mon, 8 Feb 2010 19:30:17 +0000</resolved>
                                    <version>1.2.1</version>
                    <version>2.0.0-M1</version>
                    <version>2.0.0-M2</version>
                    <version>2.0.0-M3</version>
                    <version>2.0.0-beta</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0-beta2</fixVersion>
                                    <component>docs</component>
                    <component>jdbc</component>
                    <component>sql</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12803610" author="prashantbhat" created="Fri, 22 Jan 2010 05:22:43 +0000"  >&lt;p&gt;I&apos;ve run the test cases using H2 Database-1.2.127 with current trunk revision: r901901 Please refer to the attached test-results.txt file for more details. &lt;/p&gt;

&lt;p&gt;Descriptions for the changes in attached patch:&lt;br/&gt;
1. H2Dictionary changes:&lt;br/&gt;
    a)  as per this issue comment: crossJoinClause = &quot;CROSS JOIN&quot;; requiresConditionForCrossJoin = false;&lt;br/&gt;
    b) Return Types.BOOLEAN for Types.BIT in getPreferredType(type) because of warning message shown while running MappingTool. The message looked like this:&lt;br/&gt;
        4396  workflow-entities  WARN   &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; openjpa.jdbc.Schema - Existing column &quot;ACTIVE&quot; on table         &quot;OPENJPA.WORKFLOW_TASK_GROUP&quot; is incompatible with the same column in the given schema definition. Existing column:&lt;br/&gt;
         Full Name: WORKFLOW_TASK_GROUP.ACTIVE&lt;br/&gt;
        Type: unknown(16)&lt;br/&gt;
         Size: 1&lt;br/&gt;
         Default: null&lt;br/&gt;
         Not Null: false&lt;br/&gt;
         Given column:&lt;br/&gt;
         Full Name: workflow_task_group.active&lt;br/&gt;
         Type: bit&lt;br/&gt;
         Size: 0&lt;br/&gt;
         Default: null&lt;br/&gt;
         Not Null: false&lt;/p&gt;

&lt;p&gt;   c) H2 requires limit to be present for using offset. &lt;a href=&quot;http://www.h2database.com/html/grammar.html#select&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.h2database.com/html/grammar.html#select&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2. Changes to sql-error-state-codes.xml :   added missing error-codes (caused some test failures!)&lt;br/&gt;
3. TestMultipleSchemaNames.java :   Similar to Postgres, H2 requires schema to be created as as it does not create them automatically.&lt;/p&gt;

&lt;p&gt;4. And in the documentation: I&apos;ve changed the comment &apos;H2 does not support cross joins&apos; to &apos;None&apos; &lt;br/&gt;
    But as the following test cases fail,  may be it should be explained here. I&apos;ll leave it to someone with more knowledge about these failures.&lt;br/&gt;
   a) module openjpa-peristence-jdbc -&amp;gt; All the tests completed successfully, except for the error in following test:&lt;br/&gt;
          org.apache.openjpa.persistence.sequence.TestSequence   =&amp;gt; error in: testMultiThreadedNativeSequences&lt;br/&gt;
   b) module openjpa-peristence-locking  Tests run: 185, Failures: 43, Errors: 0, Skipped: 0&lt;/p&gt;

&lt;p&gt;Hope this patch can be integrated into OpenJpa-2.0!&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Prashant&lt;/p&gt;</comment>
                            <comment id="12804096" author="milosz" created="Sat, 23 Jan 2010 15:32:20 +0000"  >&lt;p&gt;Hi, Prashant,&lt;/p&gt;

&lt;p&gt;Thank you very much for your patch! I will look into it.&lt;/p&gt;

&lt;p&gt;Briefly looking, I have a question on the LIMIT clause. Do you know whether &quot;LIMIT 0&quot; means &quot;return all rows&quot; or &quot;return no rows&quot;? If &quot;return no rows&quot;, we would need to issue &quot;LIMIT big_constant&quot; instead.&lt;/p&gt;</comment>
                            <comment id="12804122" author="prashantbhat" created="Sat, 23 Jan 2010 18:32:07 +0000"  >&lt;p&gt;Actually I tried it with H2, it returns &apos;all rows&apos; for &apos;limit 0&apos;.  and Long.MAX_VALUE should also work. So, either of them should be fine.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Prashant&lt;/p&gt;</comment>
                            <comment id="12806810" author="milosz" created="Sun, 31 Jan 2010 11:47:27 +0000"  >&lt;p&gt;Prashant, I have applied your patch into 2.0.x branch, with slight modifications:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Removed a few variable assignments in H2Dictionary since DBDictionary already assigns the same values to them.&lt;/li&gt;
	&lt;li&gt;Modified a bit SQL error codes file. A caveat here is the difference between SQL state and SQL error code. It is handled by DBDictionary.matchErrorState method which uses SQL states to determine exception type unless the method is overriden. I found some H2 source file &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; helpful here.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As for org.apache.openjpa.persistence.sequence.TestSequence, it is failing because of a deadlock in INSERT statement. I believe this is because H2 uses table level locking and this test executes a lot of parallel inserts into two tables. I also ran the test with MVCC option turned on in H2 which is supposed to use row level locking but I ended up with OutOfMemoryError (although I only tried in-memory database). Anyway having only one test failing in openjpa-persistence-jdbc module is a very good result.&lt;/p&gt;

&lt;p&gt;Unfortunately I am currently not familiar with internals of openjpa-peristence-locking tests and do not have enough time to dig into them now. As you have noted in your attachment, the results are better with MVCC option turned on. I can only guess that the tests fail mainly due to different locking semantics in H2 than the tests assume.&lt;/p&gt;

&lt;p&gt;I am going to apply the patch also to the 1.3.x branch and then mark the issue resolved. If you would like to continue work on the mentioned failing tests, please open a new issue.&lt;/p&gt;


&lt;p&gt;Thomas, thank you for pointing the CROSS JOIN issue. The patch applied contains the fix.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://kickjava.com/src/org/h2/message/Message.java.htm&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://kickjava.com/src/org/h2/message/Message.java.htm&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12829442" author="prashantbhat" created="Thu, 4 Feb 2010 04:45:29 +0000"  >&lt;p&gt;Milosz Tylenda, thanks for reviewing and applying the patch.&lt;/p&gt;

&lt;p&gt;I&apos;ve noticed an exception &apos;Connection not closed&apos; being shown in database log (*.trace.db) for almost every test although the test passes! &lt;br/&gt;
trace.db file grows upto 9.5mb after running full persistence-jdbc tests. Is it because the entity manager is not closed at the end of each test? Or is some other configuration missing for h2?&lt;br/&gt;
for ex.: mvn -Ptest-h2 -Dtest=TestException test&lt;/p&gt;

&lt;p&gt;throws the following exception:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;code&amp;#93;&lt;/span&gt;&lt;br/&gt;
02-04 12:08:42 jdbc&lt;span class=&quot;error&quot;&gt;&amp;#91;13&amp;#93;&lt;/span&gt;: Connection not closed&lt;br/&gt;
java.lang.Exception: Stack Trace&lt;br/&gt;
	at org.h2.jdbc.JdbcConnection.&amp;lt;init&amp;gt;(JdbcConnection.java:121)&lt;br/&gt;
	at org.h2.jdbc.JdbcConnection.&amp;lt;init&amp;gt;(JdbcConnection.java:94)&lt;br/&gt;
	at org.h2.Driver.connect(Driver.java:58)&lt;br/&gt;
	at org.apache.commons.dbcp.DriverConnectionFactory.createConnection(DriverConnectionFactory.java:38)&lt;br/&gt;
	at org.apache.commons.dbcp.PoolableConnectionFactory.makeObject(PoolableConnectionFactory.java:294)&lt;br/&gt;
	at org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:1148)&lt;br/&gt;
	at org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:96)&lt;br/&gt;
	at org.apache.commons.dbcp.BasicDataSource.getConnection(BasicDataSource.java:880)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.DelegatingDataSource.getConnection(DelegatingDataSource.java:131)&lt;br/&gt;
	at org.apache.openjpa.lib.jdbc.DecoratingDataSource.getConnection(DecoratingDataSource.java:106)&lt;br/&gt;
	at org.apache.openjpa.jdbc.sql.DBDictionaryFactory.newDBDictionary(DBDictionaryFactory.java:91)&lt;br/&gt;
	at org.apache.openjpa.jdbc.conf.JDBCConfigurationImpl.getDBDictionaryInstance(JDBCConfigurationImpl.java:595)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingRepository.endConfiguration(MappingRepository.java:1489)&lt;br/&gt;
	at org.apache.openjpa.lib.conf.Configurations.configureInstance(Configurations.java:507)&lt;br/&gt;
	at org.apache.openjpa.lib.conf.Configurations.configureInstance(Configurations.java:432)&lt;br/&gt;
	at org.apache.openjpa.lib.conf.PluginValue.instantiate(PluginValue.java:104)&lt;br/&gt;
	at org.apache.openjpa.conf.MetaDataRepositoryValue.instantiate(MetaDataRepositoryValue.java:68)&lt;br/&gt;
	at org.apache.openjpa.lib.conf.ObjectValue.instantiate(ObjectValue.java:83)&lt;br/&gt;
	at org.apache.openjpa.conf.OpenJPAConfigurationImpl.newMetaDataRepositoryInstance(OpenJPAConfigurationImpl.java:920)&lt;br/&gt;
	at org.apache.openjpa.conf.OpenJPAConfigurationImpl.getMetaDataRepositoryInstance(OpenJPAConfigurationImpl.java:911)&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.makeReadOnly(AbstractBrokerFactory.java:619)&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:188)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBrokerFactory.newBroker(DelegatingBrokerFactory.java:152)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:200)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:151)&lt;br/&gt;
	at org.apache.openjpa.persistence.exception.TestException.testIllegalArgumennExceptionOnInvalidNamedQuery(TestException.java:188)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at junit.framework.TestCase.runTest(TestCase.java:154)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.runTest(AbstractPersistenceTestCase.java:514)&lt;br/&gt;
	at junit.framework.TestCase.runBare(TestCase.java:127)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.runBare(AbstractPersistenceTestCase.java:501)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.runBare(AbstractPersistenceTestCase.java:477)&lt;br/&gt;
	at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
	at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
	at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
	at junit.framework.TestCase.run(TestCase.java:118)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.run(AbstractPersistenceTestCase.java:177)&lt;br/&gt;
	at junit.framework.TestSuite.runTest(TestSuite.java:208)&lt;br/&gt;
	at junit.framework.TestSuite.run(TestSuite.java:203)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.maven.surefire.junit.JUnitTestSet.execute(JUnitTestSet.java:213)&lt;br/&gt;
	at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.executeTestSet(AbstractDirectoryTestSuite.java:140)&lt;br/&gt;
	at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.execute(AbstractDirectoryTestSuite.java:127)&lt;br/&gt;
	at org.apache.maven.surefire.Surefire.run(Surefire.java:177)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.maven.surefire.booter.SurefireBooter.runSuitesInProcess(SurefireBooter.java:345)&lt;br/&gt;
	at org.apache.maven.surefire.booter.SurefireBooter.main(SurefireBooter.java:1009)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;/code&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="12830202" author="milosz" created="Fri, 5 Feb 2010 18:05:21 +0000"  >&lt;p&gt;Prashant, most likely some (or even most of) connections are still open at the end of test but not because of not closing EntityManagers. The cause is rather a connection pool (Apache DPCP) being used by the test suite. I haven&apos;t seen the exceptions you mention, maybe because I did not enable trace log in H2.&lt;/p&gt;

&lt;p&gt;Looking at your stack trace, I would say you use H2 in kind of one-connection-only mode. Is this the case? I am not very familiar with H2.&lt;/p&gt;

&lt;p&gt;I don&apos;t have answer for your question on H2 configuration. I would try tweaking DBCP connection properties and H2 settings. If you have an IDE with OpenJPA source, you can also try running some test from there, without DBCP. Below I am including my settings for your reference:&lt;/p&gt;

&lt;p&gt;        &amp;lt;profile&amp;gt;&lt;br/&gt;
            &amp;lt;id&amp;gt;test-h2-milosz&amp;lt;/id&amp;gt;&lt;br/&gt;
            &amp;lt;properties&amp;gt;&lt;br/&gt;
                &amp;lt;test-custom&amp;gt;true&amp;lt;/test-custom&amp;gt;&lt;br/&gt;
                &amp;lt;openjpa.custom.driverjar&amp;gt;/alt/jdbc/h2-1.1.118.jar&amp;lt;/openjpa.custom.driverjar&amp;gt;&lt;br/&gt;
                &amp;lt;openjpa.custom.driverclass&amp;gt;org.h2.Driver&amp;lt;/openjpa.custom.driverclass&amp;gt;&lt;br/&gt;
                &amp;lt;openjpa.custom.url&amp;gt;jdbc:h2:mem:oj;DB_CLOSE_DELAY=-1&amp;lt;/openjpa.custom.url&amp;gt;&lt;br/&gt;
                &amp;lt;openjpa.custom.username&amp;gt;sa&amp;lt;/openjpa.custom.username&amp;gt;&lt;br/&gt;
                &amp;lt;openjpa.custom.password&amp;gt;&amp;lt;/openjpa.custom.password&amp;gt;&lt;br/&gt;
                &amp;lt;dbcp.args&amp;gt;&lt;br/&gt;
                     MaxActive=100,MaxIdle=10,MaxWait=10000,timeBetweenEvictionRunsMillis=2000,minEvictableIdleTimeMillis=1000&lt;br/&gt;
                &amp;lt;/dbcp.args&amp;gt;&lt;br/&gt;
            &amp;lt;/properties&amp;gt;&lt;br/&gt;
        &amp;lt;/profile&amp;gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12431097" name="OPENJPA-1367.patch" size="4044" author="prashantbhat" created="Fri, 22 Jan 2010 05:22:43 +0000"/>
                            <attachment id="12431098" name="openjpa-h2-test-results.txt" size="7766" author="prashantbhat" created="Fri, 22 Jan 2010 05:22:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 22 Jan 2010 05:22:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161636</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz0mr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>247693</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>