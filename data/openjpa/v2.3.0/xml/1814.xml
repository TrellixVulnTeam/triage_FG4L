<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:32:43 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1814/OPENJPA-1814.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1814] JPQL fails with Group By and Having aggregate_expression IN (subquery)</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1814</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;The following JPQL fail:&lt;/p&gt;

&lt;p&gt;    	String jpql = &quot;SELECT a.uuid from EntityA a WHERE a.name = &apos;test&apos; &quot; + &lt;br/&gt;
    	    &quot;GROUP BY a.date1, a.uuid &quot; +&lt;/p&gt;

&lt;p&gt;(1)    &quot;HAVING MAX(a.date1) IN (SELECT MAX(a1.date2) from EntityA a1 WHERE a1.name = &apos;test&apos;) &quot;;&lt;br/&gt;
(2)    &quot;HAVING MAX(a.date1) = (SELECT MAX(a1.date2) from EntityA a1 WHERE a1.name = &apos;test&apos;) &quot;;&lt;/p&gt;

&lt;p&gt;org.apache.openjpa.persistence.ArgumentException: Encountered &quot;MAX ( a .date1) IN&quot; at character 168, but expected: [&quot;(&quot;, &quot;)&quot;, &quot;*&quot;, &quot;+&quot;, &quot;-&quot;, &quot;.&quot;, &quot;/&quot;, &quot;:&quot;, &quot;&amp;lt;&quot;, &quot;&amp;lt;=&quot;, &quot;&amp;lt;&amp;gt;&quot;, &quot;=&quot;, &quot;&amp;gt;&quot;, &quot;&amp;gt;=&quot;, &quot;?&quot;, &quot;ABS&quot;, &quot;ALL&quot;, &quot;AND&quot;, &quot;ANY&quot;, &quot;AS&quot;, &quot;ASC&quot;, &quot;AVG&quot;, &quot;BETWEEN&quot;, &quot;BOTH&quot;, &quot;BY&quot;, &quot;CONCAT&quot;,&quot;COUNT&quot;, &quot;CURRENT_DATE&quot;, &quot;CURRENT_TIME&quot;, &quot;CURRENT_TIMESTAMP&quot;, &quot;DELETE&quot;, &quot;DESC&quot;, &quot;DISTINCT&quot;, &quot;EMPTY&quot;, &quot;ESCAPE&quot;, &quot;EXISTS&quot;, &quot;FETCH&quot;, &quot;FROM&quot;, &quot;GROUP&quot;, &quot;HAVING&quot;, &quot;IN&quot;, &quot;INNER&quot;, &quot;IS&quot;, &quot;JOIN&quot;, &quot;LEADING&quot;, &quot;LEFT&quot;,&quot;LENGTH&quot;, &quot;LIKE&quot;, &quot;LOCATE&quot;, &quot;LOWER&quot;, &quot;MAX&quot;, &quot;MEMBER&quot;, &quot;MIN&quot;, &quot;MOD&quot;,&quot;NEW&quot;, &quot;NOT&quot;, &quot;NULL&quot;, &quot;OBJECT&quot;, &quot;OF&quot;, &quot;OR&quot;, &quot;ORDER&quot;, &quot;OUTER&quot;, &quot;SELECT&quot;,&lt;br/&gt;
&quot;SET&quot;, &quot;SIZE&quot;, &quot;SOME&quot;, &quot;SQRT&quot;, &quot;SUBSTRING&quot;, &quot;SUM&quot;, &quot;TRAILING&quot;, &quot;TRIM&quot;,&quot;UPDATE&quot;, &quot;UPPER&quot;, &quot;WHERE&quot;, &amp;lt;BOOLEAN_LITERAL&amp;gt;, &amp;lt;DECIMAL_LITERAL&amp;gt;,&amp;lt;IDENTIFIER&amp;gt;, &amp;lt;INTEGER_LITERAL&amp;gt;, &amp;lt;STRING_LITERAL&amp;gt;].&lt;br/&gt;
 at org.apache.openjpa.kernel.jpql.JPQL.generateParseException(JPQL.java:9566)&lt;br/&gt;
 at org.apache.openjpa.kernel.jpql.JPQL.jj_consume_token(JPQL.java:9443)&lt;br/&gt;
 at org.apache.openjpa.kernel.jpql.JPQL.conditional_primary(JPQL.java:1947)&lt;br/&gt;
 at org.apache.openjpa.kernel.jpql.JPQL.conditional_factor(JPQL.java:1925)&lt;br/&gt;
 at org.apache.openjpa.kernel.jpql.JPQL.conditional_term(JPQL.java:1791)&lt;/p&gt;

&lt;p&gt;The fix involves two changes:&lt;br/&gt;
(1) jjt grammar change&lt;br/&gt;
(2) OpenJPA performs a preliminary validation to ensure the expression in the having clause is included in the group-by list. However, this validation checking should be done only on the LHS of the having clause (see expr1 below), not on the RHS (see expr2 below).  For example:&lt;/p&gt;

&lt;p&gt;     Having expr1 = expr2&lt;/p&gt;

&lt;p&gt;Only expr1 should be in the group-by list&lt;/p&gt;

&lt;p&gt;The current visitor pattern can not tell which node to visit without massive change. The alternative is to disable the checking by OpenJPA and let the backend to determine whether the generated SQL is valid or not.&lt;/p&gt;


</description>
                <environment>Fix committed to trunk at revision #1002419.</environment>
        <key id="12475061">OPENJPA-1814</key>
            <summary>JPQL fails with Group By and Having aggregate_expression IN (subquery)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fancy">Catalina Wei</assignee>
                                    <reporter username="faywang">Fay Wang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Sep 2010 19:15:08 +0100</created>
                <updated>Wed, 12 Jan 2011 23:11:36 +0000</updated>
                            <resolved>Wed, 12 Jan 2011 23:11:36 +0000</resolved>
                                    <version>1.2.2</version>
                    <version>2.1.0</version>
                                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12914595" author="faywang" created="Fri, 24 Sep 2010 20:07:28 +0100"  >&lt;p&gt;clean up the patch&lt;/p&gt;</comment>
                            <comment id="12915877" author="fancy" created="Tue, 28 Sep 2010 19:53:52 +0100"  >&lt;p&gt;In JPA Spec, aggregate expression is not allowed in the IN expression. The EBNF  In Section 2.4.9 of JPA spec:&lt;/p&gt;

&lt;p&gt; in_expression ::=&lt;/p&gt;
{state_field_path_expression | type_discriminator}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;NOT&amp;#93;&lt;/span&gt; IN &lt;br/&gt;
{ ( in_item &lt;/p&gt;
{, in_item}
&lt;p&gt;* ) | (subquery) | collection_valued_input_parameter }&lt;/p&gt;

&lt;p&gt;Therefore, the following JPQL results in syntax error:&lt;/p&gt;

&lt;p&gt;SELECT c5.uuid&lt;br/&gt;
FROM pcs.common.fleet.CarLocationMessage c5&lt;br/&gt;
WHERE c5.railCarNumber = UPPER(:carNumber) and c5.clmArchived = false &lt;br/&gt;
GROUP BY c5.sightDate, c5.uuid&lt;br/&gt;
HAVING MAX(c5.sightDate) IN (SELECT MAX(c6.sightDate) from pcs.common.fleet.CarLocationMessage c6 WHERE c6.railCarNumber = UPPER(:carNumber) and c6.clmArchived = false)&lt;/p&gt;

&lt;p&gt;The above JPQL can be rewritten to use EQUAL comparison as below:&lt;/p&gt;

&lt;p&gt;SELECT c5.uuid&lt;br/&gt;
FROM pcs.common.fleet.CarLocationMessage c5&lt;br/&gt;
WHERE c5.railCarNumber = UPPER(:carNumber) and c5.clmArchived = false &lt;br/&gt;
GROUP BY c5.sightDate, c5.uuid&lt;br/&gt;
HAVING MAX(c5.sightDate) = (SELECT MAX(c6.sightDate) from pcs.common.fleet.CarLocationMessage c6 WHERE c6.railCarNumber = UPPER(:carNumber) and c6.clmArchived = false)&lt;/p&gt;

&lt;p&gt;However, it still requires &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1814&quot; title=&quot;JPQL fails with Group By and Having aggregate_expression IN (subquery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1814&quot;&gt;&lt;del&gt;OPENJPA-1814&lt;/del&gt;&lt;/a&gt;-2.patch to overcome another problem in OpenJPA.&lt;br/&gt;
We have a rather restrictive rules for validating having/grouping clause, the patch is to avoid having/grouping validation if conditional expression involving a subquery.&lt;br/&gt;
In such cases, the having/grouping rules will be enforced by the backend DBMSs. Any violation would result in SQLException and would be considered as an user error.&lt;/p&gt;</comment>
                            <comment id="12915970" author="fancy" created="Wed, 29 Sep 2010 00:43:14 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1814&quot; title=&quot;JPQL fails with Group By and Having aggregate_expression IN (subquery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1814&quot;&gt;&lt;del&gt;OPENJPA-1814&lt;/del&gt;&lt;/a&gt;-2.patch committed to trunk at revision #1002419.&lt;/p&gt;</comment>
                            <comment id="12916537" author="jpaheath" created="Thu, 30 Sep 2010 17:19:40 +0100"  >&lt;p&gt;I&apos;m providing a patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1814&quot; title=&quot;JPQL fails with Group By and Having aggregate_expression IN (subquery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1814&quot;&gt;&lt;del&gt;OPENJPA-1814&lt;/del&gt;&lt;/a&gt;-1.2.x.patch) which is for 1.2.x and it a &quot;backport&quot; of &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1814&quot; title=&quot;JPQL fails with Group By and Having aggregate_expression IN (subquery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1814&quot;&gt;&lt;del&gt;OPENJPA-1814&lt;/del&gt;&lt;/a&gt;-2.patch.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Heath&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12403621">OPENJPA-712</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12456024" name="OPENJPA-1814-1.2.x.patch" size="3959" author="jpaheath" created="Thu, 30 Sep 2010 17:19:40 +0100"/>
                            <attachment id="12455511" name="OPENJPA-1814-1.patch" size="3904" author="faywang" created="Fri, 24 Sep 2010 20:07:28 +0100"/>
                            <attachment id="12455865" name="OPENJPA-1814-2.patch" size="3938" author="fancy" created="Tue, 28 Sep 2010 19:53:52 +0100"/>
                            <attachment id="12455509" name="OPENJPA-1814.patch" size="4665" author="faywang" created="Fri, 24 Sep 2010 19:32:50 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 28 Sep 2010 18:53:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>162054</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysyhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202935</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>