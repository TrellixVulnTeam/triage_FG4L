<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:42:13 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-952/OPENJPA-952.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-952] Utilize Sun JDK&apos;s Attach API to dynamically load the OpenJPA enhancer agent</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-952</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;When running in a JSE environment, OpenJPA could use the Attach API to dynamically load the enhancer agent at runtime. Dynamically loading the enhancer means that an OpenJPA developer doesn&apos;t need to configure a -javaagent. Doing this would dramatically improve the out of box performance, and also improve the ease of use. &lt;/p&gt;

&lt;p&gt;This improvement has the following caveats:&lt;br/&gt;
1.) This API is ONLY a part of the 1.6 JDK.&lt;br/&gt;
2.) This API is supported by only the Sun JDK.&lt;br/&gt;
3.) If the agent is loaded from the earliest OpenJPA code, the agent will be laoded when creating an EntityManager in the EntityManagerFactoryImpl. If an Entity class is loaded by the JVM before the enhancer agent is loaded, that class&apos; byte code will not be enhanced. &lt;/p&gt;

&lt;p&gt;Attach API - &lt;a href=&quot;http://java.sun.com/javase/6/docs/technotes/guides/attach/index.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/javase/6/docs/technotes/guides/attach/index.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment>Sun 1.6 JDK. &lt;br/&gt;
&lt;br/&gt;
Note: The Attach API is ONLY a part of the JDK, not the SDK.</environment>
        <key id="12416031">OPENJPA-952</key>
            <summary>Utilize Sun JDK&apos;s Attach API to dynamically load the OpenJPA enhancer agent</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikedd">Michael Dick</assignee>
                                    <reporter username="curtisr7">Rick Curtis</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Mar 2009 20:39:11 +0000</created>
                <updated>Thu, 2 May 2013 03:29:25 +0100</updated>
                            <resolved>Fri, 29 May 2009 21:09:52 +0100</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0-M3</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <timeoriginalestimate seconds="0">0h</timeoriginalestimate>
                            <timeestimate seconds="0">0h</timeestimate>
                                                    <aggregatetimeoriginalestimate seconds="0">0h</aggregatetimeoriginalestimate>
                                        <aggregatetimeremainingestimate seconds="0">0h</aggregatetimeremainingestimate>
                                                <comments>
                            <comment id="12678459" author="kwsutter" created="Tue, 3 Mar 2009 21:40:21 +0000"  >&lt;p&gt;This sounds very promising!  Thanks for diving into this.  A couple of questions...&lt;/p&gt;

&lt;p&gt;Can you comment on or further explain your third caveat above?  So, you are indicating that the &quot;earliest OpenJPA code&quot; is when an EM is created?  Why not any earlier?  For example, when creating the EMF?  We still may hit the window you are describing, but it might be a little narrower.&lt;/p&gt;

&lt;p&gt;And, in the case of an Entity class loaded by the JVM before the agent is hooked up...  You mention that the enhancement won&apos;t take place.  Okay.  But, what happens then?  Would we fall back into the subclassing support?&lt;/p&gt;

&lt;p&gt;Or, could we detect this condition and possibly do the class redefinition to replace the class that was already loaded?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Kevin&lt;/p&gt;</comment>
                            <comment id="12678483" author="curtisr7" created="Tue, 3 Mar 2009 22:16:07 +0000"  >&lt;p&gt;Yes I think it would be possible to move the loading of the agent into the factory ctor. It would close the window a little, but the window will still exit. I&apos;ll update the patch I&apos;m working on.&lt;/p&gt;

&lt;p&gt;If an Entity class is loaded by the JVM before the agent is loaded, that class will fallback to subclassing enhancement. In the small tests that I have run on my machine, bytecode enhacement plays nicely with subclassing enhancement. I&apos;ll look into whether or not it would be possible to redefine a class that has already been loaded. I&apos;ll tell you that it doesn&apos;t look promising... see below.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://java.sun.com/j2se/1.5.0/docs/api/java/lang/instrument/Instrumentation.html#redefineClasses(java.lang.instrument.ClassDefinition[&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/j2se/1.5.0/docs/api/java/lang/instrument/Instrumentation.html#redefineClasses(java.lang.instrument.ClassDefinition[&lt;/a&gt;])&lt;br/&gt;
...&lt;br/&gt;
The redefinition may change method bodies, the constant pool and attributes. The redefinition must not add, remove or rename fields or methods, change the signatures of methods, or change inheritance. These restrictions maybe be lifted in future versions. &lt;br/&gt;
...&lt;/p&gt;
</comment>
                            <comment id="12680613" author="curtisr7" created="Tue, 10 Mar 2009 21:01:09 +0000"  >&lt;p&gt;In this initial patch I purposely ignored wrapping blocks of code that require special security permission. I do so because I&apos;m not entirely sure that it is a valid use case. I assume this will be a point of some discussion.?&lt;/p&gt;</comment>
                            <comment id="12681733" author="kwsutter" created="Fri, 13 Mar 2009 14:41:40 +0000"  >&lt;p&gt;Rick,&lt;br/&gt;
Thanks for the patch.  I like the idea behind this patch and the JIRA itself, but I have a few questions and comments...&lt;/p&gt;

&lt;p&gt;o  Testing.  We need a means of testing this approach on a regular basis.  One of the problems with the old subclassing support is that it wasn&apos;t exercised.  We didn&apos;t know about some of the problems until users ran into them.  Somehow, we need the ability to run the junit bucket or a proper subset of the bucket using this dynamic agent support.  Could a new testing profile be created to make this easy to execute?  Maybe it&apos;s not run with every test build, but we easily have the capability to run the bucket?&lt;/p&gt;

&lt;p&gt;o  Documentation.  As you have found out, we&apos;re short on documentation in this enhancement area.  I don&apos;t see any doc updates in the patch you provided.  If we put this support in place, then we need some documentation to explain this new capability.  It&apos;s there automatically with Sun Java6, but is there any way to turn it off?  Should there be?  What about the other existing options like oopenjpa.RuntimeEnhancedClasses?  Any conflicts with these option settings?&lt;/p&gt;

&lt;p&gt;o  Javadoc.  I noticed a couple of places where javadoc probably needed to be updated, like with the PCEnhancerAgent.  The javadoc in this class talks about the -javaagent processing.  This would be a good area to update with the information on the dynamic agent plugin.  In general, don&apos;t forget about the javadoc.  It&apos;s very important.&lt;/p&gt;

&lt;p&gt;o  Java2 Security.  Due to the jar file manipulation and classloading that you are attempting to do, these type of changes need to be executed with Java2 Security turned on.  Albert has provided an easy way to run the bucket or an individual test with Java2 Security turned on.  It&apos;s something like this (but don&apos;t quote me):&lt;/p&gt;

&lt;p&gt;    mvn myTest -Penable-security&lt;/p&gt;

&lt;p&gt;o  The flags and methods in PCEnhancerAgent don&apos;t synch up for me.  For example, you introduced a boolean called enhancementComplete, but the accessor method is hasRun().  Since enhancementComplete seems to be set to true when preMain is first called, enhancement isn&apos;t really complete, is it?  Something along the lines of resident, invoked, initialized, or something like that seems more appropriate.  And, then having an accessor method that matches the boolean would be better.&lt;/p&gt;

&lt;p&gt;o  Warning mesasge id of entities-loaded-before-em.  I thought we could key off the emf creation instead of the em.  Would it be better to re-name and re-word this message to just indicate that entities were accessed before the dynamic agent was configured.  And, if the EMF creation is the proper step-off point, then it&apos;s okay to use that for an explanation and resolution.&lt;/p&gt;

&lt;p&gt;o  Trace messages.  It looks like you are trying to introduce some type of &quot;eye catcher&quot; for trace messages (ie. the &quot;:157&quot; in the trace message for ManagedClassSubclasser).  This is not consistent with the rest of the OpenJPA trace messages.  So, unless you are proposing to introduce a change to all of the Trace message processing, then I&apos;d stick with the current conventions.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;o  I see that you modified the existing logic of just warning a message when RuntimeUnenhancedClasses is set to WARN.  If it&apos;s something other than WARN, then you now throw an Exception.  What about a value of Supported?  And, is this the right place to throw this exception?  At minimum, we need more comments as to why we&apos;re changing the existing processing.  I&apos;m not clear on why an exception is proper processing at this point.&lt;/p&gt;

&lt;p&gt;o  The indentation and general formatting doesn&apos;t seem to be consistent.  In one spot, your indentation is the expected 4 spaces, while in other spaces it&apos;s all the way out to 8 spaces.  Are you using space substitution for tabs?  And, have you checked for the 80 column limit?&lt;/p&gt;

&lt;p&gt;o  Nit.  Check the spelling in your comments and javadoc updates.  Just read through them and I think you&apos;ll find a few.&lt;/p&gt;

&lt;p&gt;o  Some of the Trace statements in PersistenceProviderImpl need more &quot;beef&quot;.  They should be self-explanatory by reading a Trace log file without having to reference the code.  For example, &lt;/p&gt;

&lt;p&gt;    _log.trace(_name + &quot;:468&quot;,t);&lt;/p&gt;

&lt;p&gt;    ... wouldn&apos;t tell me enough in the log file as to why this was logged.  Some additional text explaining what this dumped exception means to me would help with deciphering a log without relying on the code.&lt;/p&gt;

&lt;p&gt;o  Can we be more helpful with the necessary runtime environment?  For example, if we detect they are running with the Sun JDK 6 JRE instead of the SDK (ie. no tools directory), could we output a message that would tell them about this nice feature if they would only run with the SDK...  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;o  I like the getAgentJar processing for when running within Eclipse.  Should make testing even easier.  Thanks.  But...  (always a but)...  Shouldn&apos;t there be a way to turn this feature off?  Just in case we&apos;re debugging a particular situation, I think we need a means of turning off this dynamic support.  Don&apos;t you think?&lt;/p&gt;

&lt;p&gt;o  All external messages (non Trace) needs to go into our message files.  Developers want the ability to read translated messages, much like end users.&lt;/p&gt;

&lt;p&gt;That&apos;s it.  Thanks again for driving this JIRA.  I think we really need this function and I appreciate your efforts.  When you have an updated patch, I&apos;d be happy to review it again.&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;</comment>
                            <comment id="12694670" author="curtisr7" created="Wed, 1 Apr 2009 19:26:05 +0100"  >&lt;p&gt;Kevin -&lt;/p&gt;

&lt;p&gt;Thanks for all the comments! The latest patch should have addressed all of your comments. The only comment I&apos;d like to address directly is,&lt;/p&gt;

&lt;p&gt;Question: I like the getAgentJar processing for when running within Eclipse.  Should make testing even easier.  Thanks.  But...  (always a but)...  Shouldn&apos;t there be a way to turn this feature off?  Just in case we&apos;re debugging a particular situation, I think we need a means of turning off this dynamic support.  Don&apos;t you think?&lt;/p&gt;

&lt;p&gt;Answer: That processing is out of necessity, not a feature. To dynamically load an agent, a jar file is needed that has an Agent-class defined. Under normal circumstances the PersistenceProviderImpl is loaded from the OpenJPA jar and we can load the agent with that jar. When running a test the OpenJPA jar doesn&apos;t exist and the only way to get around this would be to setup your test to run off a compiled OpenJPA jar.&lt;/p&gt;

&lt;p&gt;To run the news test suite associated with this patch the following steps need to be followed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Compile OpenJPA with the 1.5 JDK and make sure to skip the tests. (-DskipTests=true ... We need to skip the tests so that the build time enhancer doesn&apos;t run)&lt;/li&gt;
	&lt;li&gt;Switch to the Sun 1.6 JDK.&lt;/li&gt;
	&lt;li&gt;Run mvn test -P test-dynamic-enhancer,test-derby (or which ever DB you want to run with, I&apos;ve only tried derby)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Notes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;See openjpa-persistence-jdbc -&amp;gt; org.apache.openjpa.persistence.enhance.DynamicEnhancementSuite for a detailed list of the tests that are run.&lt;/li&gt;
	&lt;li&gt;By specifying mvn test -P test-dynamic-enhancer,test-derby -DdynamicTest=org.apache.openjpa.... allows you to run a single test with the dynamic enhancer.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-Rick&lt;/p&gt;</comment>
                            <comment id="12697769" author="milosz" created="Fri, 10 Apr 2009 09:24:02 +0100"  >&lt;p&gt;Don&apos;t we have some of this functionality already in the InstrumentationFactory class? If so, we could try to reuse it.&lt;/p&gt;</comment>
                            <comment id="12704644" author="mikedd" created="Thu, 30 Apr 2009 15:27:22 +0100"  >&lt;p&gt;Reviewing Rick&apos;s patch. &lt;/p&gt;</comment>
                            <comment id="12708958" author="mikedd" created="Wed, 13 May 2009 15:59:27 +0100"  >&lt;p&gt;I&apos;ve spoken with Rick a bit and he&apos;s looking into reusing some of the code from InstrumentationFactory (thanks for pointing it out Milosz).  &lt;/p&gt;</comment>
                            <comment id="12708962" author="curtisr7" created="Wed, 13 May 2009 16:02:02 +0100"  >&lt;p&gt;Milosz -&lt;/p&gt;

&lt;p&gt;You are correct that some of this functionality already exists in the InstrumentationFactory... not sure why I didn&apos;t use that in the first place. I&apos;m in the process of re-working my patch. I spoke with Mike and he is going to take a look at it once I post it.&lt;/p&gt;

&lt;p&gt;-Rick&lt;/p&gt;</comment>
                            <comment id="12711144" author="curtisr7" created="Wed, 20 May 2009 14:48:52 +0100"  >&lt;p&gt;Giving this one another shot. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Refactored much of the code (as Miloz commented, there was some commonality between what I was doing and the InstrumentationFactory).&lt;/li&gt;
	&lt;li&gt;Previously I mentioned that the code needed to be compiled with JDK1.5, that is no longer true.&lt;/li&gt;
	&lt;li&gt;The previous patch didn&apos;t have the test suite that I added.&lt;/li&gt;
	&lt;li&gt;To run the entire test suite:&lt;br/&gt;
	openjpa-parent&amp;gt;mvn test -P test-dynamic-enhancer,test-derby -DfailIfNoTests=false&lt;/li&gt;
	&lt;li&gt;The test suite is composed of:&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;All tests that failed when running with subclassing.&lt;/li&gt;
	&lt;li&gt;All tests in the following openjpa-persistence-jdbc packages&lt;/li&gt;
	&lt;li&gt;org.apache.openjpa.persistence.enhance&lt;/li&gt;
	&lt;li&gt;org.apache.openjpa.persistence.relations&lt;/li&gt;
	&lt;li&gt;org.apache.openjpa.persistence.simple&lt;/li&gt;
	&lt;li&gt;org.apache.openjpa.persistence.identity&lt;/li&gt;
	&lt;li&gt;org.apache.openjpa.persistence.annotations&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;To run a single test with the dynamic enhancer:&lt;br/&gt;
	openjpa-parent&amp;gt;mvn test -P test-dynamic-enhancer,test-derby -DfailIfNoTests=false -DdynamicTest=org.apache.openjpa...&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12714572" author="mikedd" created="Fri, 29 May 2009 21:09:51 +0100"  >&lt;p&gt;Thanks for the patch Rick. Fixed in 2.0.0 but could be merged to 1.3.x if there&apos;s sufficient demand. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12515578">OPENJPA-2036</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12469654">OPENJPA-1734</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12427229">OPENJPA-1125</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12408585" name="OPENJPA-952.patch" size="62296" author="curtisr7" created="Wed, 20 May 2009 14:48:51 +0100"/>
                            <attachment id="12404363" name="OPENJPA-952.patch" size="35125" author="curtisr7" created="Wed, 1 Apr 2009 19:26:03 +0100"/>
                            <attachment id="12401861" name="OPENJPA-952.patch" size="20122" author="curtisr7" created="Tue, 10 Mar 2009 21:01:09 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12432051">OPENJPA-1220</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 3 Mar 2009 21:40:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>66765</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysrbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>201774</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>