<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:37:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-758/OPENJPA-758.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-758] OpenJPA doesn&apos;t find ValueHandlers with an applicable class loader</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-758</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;We are working with ValueHandlers for enterprise applications that   &lt;br/&gt;
will be deployed on WebSphere, currently 6.1.0.19. We believe that the   &lt;br/&gt;
current OpenJPA implementation has made a less than stellar choice in   &lt;br/&gt;
how to load value handlers, and suggest a change&lt;/p&gt;


&lt;p&gt;ValueHandlers are naturally (or so we find) specific for certain value   &lt;br/&gt;
types, that are often dependent on the semantics of your business, and   &lt;br/&gt;
thus are part of the application, in some way bundled in the ear you   &lt;br/&gt;
are deploying. We do unit testing out of the container with OpenJPA   &lt;br/&gt;
1.0.3, and everything works like a charm. &lt;/p&gt;

&lt;p&gt;When we deploy on WebSphere however, nothing works. OpenJPA does not   &lt;br/&gt;
find our value handlers. &lt;br/&gt;
Luckily OpenJPA is open source &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, so we found with certainty that   &lt;br/&gt;
the reason is that OpenJPA tries to load the value handler with the   &lt;br/&gt;
class loader that loaded the meta information for the property. The   &lt;br/&gt;
class of that object is part of OpenJPA, and inside WebSphere, OpenJPA   &lt;br/&gt;
is loaded with a class loader that has no access to the application   &lt;br/&gt;
code, the code in the ear. So, ClassNotFoundException. Bummer. &lt;/p&gt;

&lt;p&gt;The long term solution, we believe, is not to use the classloader   &lt;br/&gt;
associated with the meta information for the property (i.e., the   &lt;br/&gt;
OpenJPA class loader), but instead the class loader of the entity for   &lt;br/&gt;
which we are working (which is also reachable via the parameters of   &lt;br/&gt;
the method that does the loading). Using the class loader of the   &lt;br/&gt;
actual value we want to handle is not an option, since the value can   &lt;br/&gt;
be null. The entity however is normally also part of the application,   &lt;br/&gt;
the ear, and cannot be null. &lt;/p&gt;</description>
                <environment>WebSphere 6.1, any other, 1.0.3 and probably all existing others</environment>
        <key id="12407602">OPENJPA-758</key>
            <summary>OpenJPA doesn&apos;t find ValueHandlers with an applicable class loader</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jpaheath">Heath Thomann</assignee>
                                    <reporter username="jandockx">Jan Dockx</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Oct 2008 15:07:59 +0000</created>
                <updated>Fri, 27 Jul 2012 19:51:26 +0100</updated>
                            <resolved>Wed, 15 Feb 2012 15:54:20 +0000</resolved>
                                    <version>1.0.3</version>
                    <version>1.2.2</version>
                    <version>2.0.0</version>
                    <version>2.1.1</version>
                    <version>2.2.0</version>
                                    <fixVersion>1.0.5</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                    <timeoriginalestimate seconds="259200">72h</timeoriginalestimate>
                            <timeestimate seconds="259200">72h</timeestimate>
                                        <comments>
                            <comment id="12650305" author="kwsutter" created="Mon, 24 Nov 2008 20:06:47 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
Just to ensure that I have discovered the same situation that you experienced, could you validate the following?&lt;/p&gt;

&lt;p&gt;During my recent experimentation with ValueHandlers and FieldStrategies &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, I came across the situation that you describe in this JIRA.  The classloading in question is in the namedHandler method on the MappingRepository class:&lt;/p&gt;

&lt;p&gt;        name = Configurations.getClassName(name);&lt;br/&gt;
        try {&lt;br/&gt;
            Class c = JavaTypes.classForName(name, val,&lt;br/&gt;
                (ClassLoader) AccessController.doPrivileged(&lt;br/&gt;
                    J2DoPrivHelper.getClassLoaderAction(ValueHandler.class)));&lt;/p&gt;

&lt;p&gt;I agree that a user-supplied class, such as a ValueHandler, should not depend on the classloader of the ValueHandler class.  But, I wanted to verify that we&apos;re talking about the same area of the code.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Kevin&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;  &lt;a href=&quot;http://n2.nabble.com/ValueHandlers-vs-FieldStrategies-td1573427.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://n2.nabble.com/ValueHandlers-vs-FieldStrategies-td1573427.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12661606" author="kwsutter" created="Wed, 7 Jan 2009 15:16:48 +0000"  >&lt;p&gt;Just to add another Nabble reference for this same problem.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://n2.nabble.com/Using-custom-ValueHandler-td210193.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://n2.nabble.com/Using-custom-ValueHandler-td210193.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Looks to be the same problem, but Catalina has proposed a change in slightly different area of the code.  Maybe these are in the same callstack when this problem occurs.  But, we should ensure that both cases are covered when this Issue gets resolved.&lt;/p&gt;
</comment>
                            <comment id="13066450" author="hwellmann" created="Sat, 16 Jul 2011 16:55:06 +0100"  >&lt;p&gt;I ran into the same issue working with OpenJPA 2.1.0 on OSGi, using Aries JPA 0.3 and Equinox 3.7.0. OpenJPA has to use the persistence bundle classloader instead of its own bundle classloader to load ValueHandlers. Looking at the attached patch and comparing it to the code in MetaDataRepository.loadPersistentTypesInternal for loading entity classes from user bundles, I believe this patch would also solve the problem for OSGi.&lt;/p&gt;</comment>
                            <comment id="13280082" author="thirion" created="Mon, 21 May 2012 12:13:00 +0100"  >&lt;p&gt;Hi, I wrote a custom Strategy and ran into this class loading issue.  &lt;/p&gt;

&lt;p&gt;I checked out version 2.2.0.&lt;/p&gt;

&lt;p&gt;I found that by adding &#8216;false&#8217; to the call to getClassLoaderAction inside method:&lt;br/&gt;
protected FieldStrategy namedStrategy(FieldMapping field, boolean installHandlers) &lt;br/&gt;
of class:&lt;br/&gt;
org.apache.openjpa.jdbc.meta.MappingRepository&lt;br/&gt;
my class was able to be loaded:&lt;/p&gt;

&lt;p&gt;Class&amp;lt;?&amp;gt; c = JavaTypes.classForName(name, field,&lt;br/&gt;
                AccessController.doPrivileged(&lt;br/&gt;
                    J2DoPrivHelper.getClassLoaderAction(FieldStrategy.class)), false);&lt;/p&gt;

&lt;p&gt;The boolean parameter for &#8216;mustExist&#8217; should be false in order for issue OpenJPA 758 to get taken into consideration and find the correct class loader in JavaTypes.classForName method .&lt;br/&gt;
I would have saved a lot of time if I found this post sooner though...&lt;/p&gt;</comment>
                            <comment id="13412254" author="garpinc" created="Wed, 11 Jul 2012 23:42:06 +0100"  >&lt;p&gt;I still have this issue in 2.2.0 using the following code path:&lt;/p&gt;

&lt;p&gt;JavaTypes.classForName(String, ClassMetaData, Class&amp;lt;?&amp;gt;, ValueMetaData, ClassLoader, boolean) line: 272	&lt;br/&gt;
JavaTypes.classForName(String, ClassMetaData, Class&amp;lt;?&amp;gt;, ValueMetaData, ClassLoader) line: 231	&lt;br/&gt;
JavaTypes.classForName(String, ValueMetaData, ClassLoader) line: 203	&lt;br/&gt;
MappingRepository.namedStrategy(FieldMapping, boolean) line: 580&lt;/p&gt;

&lt;p&gt;I think this mustExist should always be false&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12542708">OPENJPA-2133</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12486632" name="OPENJPA-758-1.2.x.patch" size="4465" author="jpaheath" created="Fri, 15 Jul 2011 16:44:17 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 24 Nov 2008 20:06:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>67912</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysnnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>201180</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>