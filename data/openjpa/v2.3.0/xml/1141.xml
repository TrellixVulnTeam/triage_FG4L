<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:31:45 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1141/OPENJPA-1141.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1141] NPE  at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1400)</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1141</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;We have the NPE shown below in a reproducible testcase (ZIP attached to JIRA ...).&lt;/p&gt;

&lt;p&gt;We&apos;ve reduced our complex intended target domain model (about 200+ Entities) to a simpler model with only 3 classes which illustrate the problem: You&apos;ll find attached a test project with a first entity which has a a OneToMany (with an ElementJoinColumns, but that shouldn&apos;t matter?) to a second entity has a ManyToOne to a third entity. The middle entity has a Composite ID Class including a ManyToOne as a key, which according to &lt;a href=&quot;http://openjpa.apache.org/builds/1.2.0/apache-openjpa-1.2.0/docs/manual/ref_guide_pc_oid.html#ref_guide_pc_oid_entitypk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://openjpa.apache.org/builds/1.2.0/apache-openjpa-1.2.0/docs/manual/ref_guide_pc_oid.html#ref_guide_pc_oid_entitypk&lt;/a&gt; is supported, so this seems a bug in OpenJPA&apos;s mapping algos, somehow?&lt;/p&gt;

&lt;p&gt;&amp;lt;openjpa-1.2.1-r752877:753278 nonfatal general error&amp;gt; org.apache.openjpa.persistence.PersistenceException: null&lt;br/&gt;
        at org.apache.openjpa.kernel.QueryImpl.compileForCompilation(QueryImpl.java:610)&lt;br/&gt;
        at org.apache.openjpa.kernel.QueryImpl.compileForExecutor(QueryImpl.java:667)&lt;br/&gt;
        at org.apache.openjpa.kernel.QueryImpl.getOperation(QueryImpl.java:1492)&lt;br/&gt;
        at org.apache.openjpa.kernel.DelegatingQuery.getOperation(DelegatingQuery.java:123)&lt;br/&gt;
        at org.apache.openjpa.persistence.QueryImpl.execute(QueryImpl.java:243)&lt;br/&gt;
        at org.apache.openjpa.persistence.QueryImpl.getResultList(QueryImpl.java:294)&lt;br/&gt;
        at testcase.TestMappingProblem.doTest(TestMappingProblem.java:42)&lt;br/&gt;
        at testcase.TestMappingProblem.testIt(TestMappingProblem.java:20)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at junit.framework.TestCase.runTest(TestCase.java:154)&lt;br/&gt;
        at junit.framework.TestCase.runBare(TestCase.java:127)&lt;br/&gt;
        at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
        at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
        at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
        at junit.framework.TestCase.run(TestCase.java:118)&lt;br/&gt;
        at junit.framework.TestSuite.runTest(TestSuite.java:208)&lt;br/&gt;
        at junit.framework.TestSuite.run(TestSuite.java:203)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.maven.surefire.junit.JUnitTestSet.execute(JUnitTestSet.java:213)&lt;br/&gt;
        at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.executeTestSet(AbstractDirectoryTestSuite.java:140)&lt;br/&gt;
        at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.execute(AbstractDirectoryTestSuite.java:127)&lt;br/&gt;
        at org.apache.maven.surefire.Surefire.run(Surefire.java:177)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.maven.surefire.booter.SurefireBooter.runSuitesInProcess(SurefireBooter.java:345)&lt;br/&gt;
        at org.apache.maven.surefire.booter.SurefireBooter.main(SurefireBooter.java:1009)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1400)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.MappingInfo.createJoins(MappingInfo.java:1206)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.MappingInfo.createForeignKey(MappingInfo.java:968)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.ValueMappingInfo.getTypeJoin(ValueMappingInfo.java:104)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.strats.RelationFieldStrategy.map(RelationFieldStrategy.java:157)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.FieldMapping.setStrategy(FieldMapping.java:121)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.RuntimeStrategyInstaller.installStrategy(RuntimeStrategyInstaller.java:80)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.FieldMapping.resolveMapping(FieldMapping.java:454)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.FieldMapping.resolve(FieldMapping.java:419)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.ClassMapping.resolveNonRelationMappings(ClassMapping.java:869)&lt;br/&gt;
        at org.apache.openjpa.jdbc.meta.MappingRepository.prepareMapping(MappingRepository.java:339)&lt;br/&gt;
        at org.apache.openjpa.meta.MetaDataRepository.preMapping(MetaDataRepository.java:662)&lt;br/&gt;
        at org.apache.openjpa.meta.MetaDataRepository.resolve(MetaDataRepository.java:549)&lt;br/&gt;
        at org.apache.openjpa.meta.MetaDataRepository.getMetaData(MetaDataRepository.java:308)&lt;br/&gt;
        at org.apache.openjpa.meta.MetaDataRepository.getMetaData(MetaDataRepository.java:363)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLExpressionBuilder.getClassMetaData(JPQLExpressionBuilder.java:159)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLExpressionBuilder.resolveClassMetaData(JPQLExpressionBuilder.java:139)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLExpressionBuilder.getCandidateMetaData(JPQLExpressionBuilder.java:225)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLExpressionBuilder.getCandidateMetaData(JPQLExpressionBuilder.java:195)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLExpressionBuilder.getCandidateType(JPQLExpressionBuilder.java:188)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLExpressionBuilder.access$600(JPQLExpressionBuilder.java:69)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLExpressionBuilder$ParsedJPQL.populate(JPQLExpressionBuilder.java:1756)&lt;br/&gt;
        at org.apache.openjpa.kernel.jpql.JPQLParser.populate(JPQLParser.java:56)&lt;br/&gt;
        at org.apache.openjpa.kernel.ExpressionStoreQuery.populateFromCompilation(ExpressionStoreQuery.java:153)&lt;br/&gt;
        at org.apache.openjpa.kernel.QueryImpl.newCompilation(QueryImpl.java:658)&lt;br/&gt;
        at org.apache.openjpa.kernel.QueryImpl.compilationFromCache(QueryImpl.java:639)&lt;br/&gt;
        at org.apache.openjpa.kernel.QueryImpl.compileForCompilation(QueryImpl.java:605)&lt;br/&gt;
        ... 33 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12428375">OPENJPA-1141</key>
            <summary>NPE  at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1400)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fyrewyld">Jody Grassel</assignee>
                                    <reporter username="yann">Yann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jun 2009 16:35:19 +0100</created>
                <updated>Mon, 17 Jan 2011 14:28:20 +0000</updated>
                            <resolved>Fri, 8 Jan 2010 00:07:29 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.2</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0-beta</fixVersion>
                                    <component>jdbc</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12728200" author="mikedd" created="Tue, 7 Jul 2009 18:15:32 +0100"  >&lt;p&gt;The entities contain comments indicating that they were generated. Did you use the OpenJPA ReverseMappingTool, or something else (ie Dali)? &lt;/p&gt;

&lt;p&gt;If you used the OpenJPAReverseMappingTool then would it be possible to see the table ddl that resulted in these entities? It looks like some annotations need to be added to complete the mappings. &lt;/p&gt;</comment>
                            <comment id="12729286" author="dirichs" created="Thu, 9 Jul 2009 15:52:15 +0100"  >&lt;p&gt;See &lt;a href=&quot;http://n2.nabble.com/NPE-at-org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java%3A1400)-tt3120428.html#a3231887&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://n2.nabble.com/NPE-at-org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java%3A1400)-tt3120428.html#a3231887&lt;/a&gt;&lt;br/&gt;
for an explanation of the root cause of this error.&lt;/p&gt;

&lt;p&gt;It also affects 2.0.0-M2.&lt;/p&gt;</comment>
                            <comment id="12733526" author="dirichs" created="Tue, 21 Jul 2009 08:55:36 +0100"  >&lt;p&gt;There seems to be no problem with the mapping of the supplied testcase as such. The reported exception is caused while OpenJPA resolves the primary key fields of NotepadEntity. Since one of the primary key fields of NotepadEntity is the id of another entity, namely TypeEntity, the primary key fields of NotepadEntity may only be completely resolved after TypeEntity has been resolved. However, the mapping data resolution algorithm of OpenJPA doesn&apos;t take into account this type of dependency between entities.&lt;/p&gt;

&lt;p&gt;See org.apache.openjpa.jdbc.meta.ClassMapping, methods resolveNonRelationMappings() and resolveMapping(). Inside the latter, there already seems to be a workaround for this deficiency of OpenJPAs resolution strategy. Here is says in line 838 (I&apos;m referencing to the 2.0.0-M2 source):&lt;br/&gt;
  // set resolve mode to force this field mapping to be &lt;br/&gt;
  // resolved again. The need to resolve again occurs when &lt;br/&gt;
  // a primary key is a relation field with the foreign key&lt;br/&gt;
  // annotation. In this situation, this primary key field&lt;br/&gt;
  // mapping is resolved during the call to &lt;br/&gt;
  // resolveNonRelationMapping. Since it is a relation&lt;br/&gt;
  // field, the foreign key will be constructed. However, &lt;br/&gt;
  // the primary key of the parent entity may not have been &lt;br/&gt;
  // resolved yet, resulting in missing information in the fk&lt;/p&gt;

&lt;p&gt;Unfortunately, there are situations such as in the reported test case that cause an exception before the code following the above comment runs. A more promising strategy would be to resolve the entities in the correct order taking into account the dependencies of their primary key fields. Then this workaround would not be needed at all and the reported exception would no longer happen.&lt;/p&gt;

&lt;p&gt;Of course, the code responsible for determining the correct order of entity resolution would have to deal with cycles, which may occur as the result of incorrect mappings. However, I can&apos;t think of any situation where cyclic references of primary key fields between entities would make any sense, so this case can probably reported as an error and remain unhandled.&lt;/p&gt;

&lt;p&gt;Oh, btw. I would be glad to help testing any fix for this.&lt;/p&gt;</comment>
                            <comment id="12734065" author="vorburger" created="Wed, 22 Jul 2009 11:28:52 +0100"  >&lt;p&gt;Michael Dick, in response to your questions (as also via IBM PMR 44438 500 624) : &lt;/p&gt;

&lt;p&gt;Attached a ddl.sql which represents the three physical tables that PortfolioEntity, NotepadEntity &amp;amp; TypeEntity need to map to. This is a simplified subset of a more complex existing (non changeable) real-world target DDL schema.  Note that the defect (NPE) occurs inside OpenJPA within jdbc.meta.MappingInfo BEFORE any SQL at all is actually executed - this DDL is FYI as requested, but the initially provided test case actually fails with NPE and demonstrates the problem WITHOUT any DB / DDL. See Martin Dirichs comments above.&lt;/p&gt;

&lt;p&gt;Regarding the comment in the .java that says &quot;This file has been automatically generated, DO NOT MODIFY!&quot;, please ignore that - strictly speaking all those *Entity classes (not just Notepad) were generated from some kind of in-house meta description, but NOT by the OpenJPAReverseMapping tool, but by a proprietary code gen. tool. That should be irrelevant for the purposes of this discussion though, please just assume for this discussion that it was hand-written, i.e. the generator could be adapted by us if there is a solution in adding any annotations as you suggest - but which?&lt;/p&gt;</comment>
                            <comment id="12734088" author="mikedd" created="Wed, 22 Jul 2009 13:14:56 +0100"  >&lt;p&gt;Hi Michael,&lt;/p&gt;

&lt;p&gt;I haven&apos;t taken a look at this issue since I made the earlier remarks, I&apos;ll take another look this morning and get back to you. Martin&apos;s comments above are intriguing though - at first glance I thought it was an incomplete mapping issue, but now I&apos;m not sure. &lt;/p&gt;

&lt;p&gt;Thanks for the explanation of how the entities get generated, too by the way. &lt;/p&gt;</comment>
                            <comment id="12734159" author="bjreed" created="Wed, 22 Jul 2009 16:42:09 +0100"  >&lt;p&gt;One thing I tried was playing around with the entities and persisting them before creating/running the query.&lt;/p&gt;

&lt;p&gt;Looks like persisting a TypeEntity (even one that&apos;s not used) seems to tweak the algorithm enough to get around the NullPointerException.&lt;/p&gt;

&lt;p&gt;I changed the doTest method to do the following:&lt;/p&gt;

&lt;p&gt;    public void testIt () throws Exception &lt;/p&gt;
{
        EntityManager em = emf.createEntityManager();

        em.getTransaction().begin();
        TypeEntity te = new TypeEntity();
        em.persist(te);

        Query query = em.createQuery(&quot;SELECT o from Portfolio o&quot;);
        query.getResultList();
        em.getTransaction().commit();
        em.close();

    }</comment>
                            <comment id="12734167" author="mikedd" created="Wed, 22 Jul 2009 16:53:18 +0100"  >&lt;p&gt;Spoke with B.J. offline and he agreed to look at the issue. &lt;/p&gt;</comment>
                            <comment id="12744046" author="bjreed" created="Mon, 17 Aug 2009 13:51:13 +0100"  >&lt;p&gt;Can someone else take a look at this?  I had only agreed originally to look at the work around and have not had much of a chance to try to actually fix the problem.  By having it assigned to me, I&apos;m afraid that someone more capable may be kept from looking into this.&lt;/p&gt;</comment>
                            <comment id="12768966" author="fyrewyld" created="Fri, 23 Oct 2009 00:23:39 +0100"  >&lt;p&gt;Update based on suggestions from code review.&lt;/p&gt;</comment>
                            <comment id="12770049" author="fyrewyld" created="Mon, 26 Oct 2009 15:05:04 +0000"  >&lt;p&gt;Updated version of the patch, dated 10 26 2009.&lt;/p&gt;</comment>
                            <comment id="12770146" author="fyrewyld" created="Mon, 26 Oct 2009 19:15:15 +0000"  >&lt;p&gt;OpenJPA-1141 patch for trunk&lt;/p&gt;</comment>
                            <comment id="12770968" author="fyrewyld" created="Wed, 28 Oct 2009 15:47:03 +0000"  >&lt;p&gt;Patch for OpenJPA 1.3.x&lt;/p&gt;</comment>
                            <comment id="12778555" author="dirichs" created="Mon, 16 Nov 2009 21:36:37 +0000"  >&lt;p&gt;I have tested patch OpenJPA-Trunk_OJ1141.patch with my application. Unfortunately, the patch doesn&apos;t seem to eliminate the problem. There seemed to be no difference at all.&lt;/p&gt;

&lt;p&gt;Digging further into this issue, I could spot in the code why the patch did not solve the problem. The patch adds a line to the bottom of MetaDataRepository.processBuffer() to reorder entities for further processing. Method processBuffer() is a bit strange at first view:&lt;/p&gt;

&lt;p&gt;private List&amp;lt;ClassMetaData&amp;gt; processBuffer(ClassMetaData meta, InheritanceOrderedMetaDataList buffer, int mode) {&lt;br/&gt;
    // if we&apos;re already processing a metadata, just buffer this one; when&lt;br/&gt;
    // the initial metadata finishes processing, we traverse the buffer&lt;br/&gt;
    // and process all the others that were introduced during reentrant calls&lt;br/&gt;
    if (!buffer.add(meta) || buffer.size() != 1)&lt;br/&gt;
        return null;&lt;/p&gt;

&lt;p&gt;    // continually pop a metadata and process it until we run out; note&lt;br/&gt;
    // that each processing call might place more metas in the buffer as&lt;br/&gt;
    // one class tries to access metadata for another; also note that the&lt;br/&gt;
    // buffer orders itself from least to most derived&lt;br/&gt;
    ClassMetaData buffered;&lt;br/&gt;
    List&amp;lt;ClassMetaData&amp;gt; processed = new ArrayList&amp;lt;ClassMetaData&amp;gt;(5);&lt;br/&gt;
    while (!buffer.isEmpty()) &lt;/p&gt;
{
        buffered = buffer.peek();
        buffered.resolve(mode);
        processed.add(buffered);
        buffer.remove(buffered);
    }

&lt;p&gt;    // this line is added by the patch&lt;br/&gt;
    processed = resolveFKInPKDependenciesOrdering(processed);&lt;/p&gt;

&lt;p&gt;    return processed;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Thus, the iteration within processBuffer() is only executed if the supplied list of entity meta data solely contains one item, which is also supplied as first parameter to the method. This puzzle is solved, of course, by taking into account that the line &quot;buffered.resolve(mode);&quot; may lead to recursive calls to processBuffer(), thereby growing the list of meta data while iterating over it in the outermost call.&lt;/p&gt;

&lt;p&gt;Note that the patch only adds a line behind the while loop. However, exceptions similar to the one reported in this JIRA issue occur within the while loop, during the recursion. The patch may happen to eliminate the meta data resolution problem for the supplied test setup, it does not work for the general case.&lt;/p&gt;

&lt;p&gt;The root problem lies in the usage of an InheritanceOrderedMetaDataList as buffer. This kind of list makes sure that new meta data entries put into the list are always inserted behind any meta data entries of super classes. This is fine, but it is not enough. If entities use other entities for their primary key fields, this is a dependency not taken into account by the InheritanceOrderedMetaDataList. Instead, entities not inheriting from each other are simply ordered alphabetically when inserted into the list.&lt;/p&gt;

&lt;p&gt;This is the real flaw of using the InheritanceOrderedMetaDataList in this context. Since resolving the meta data of an entity is only guaranteed to work if both super classes and entites referred to in the primary key fields are already resolved beforehand, the usage of InheritanceOrderedMetaDataList is error prone.&lt;/p&gt;

&lt;p&gt;There exists another approach to remove this kind of meta data resolution problems: Use a simple ArrayList instead of InheritanceOrderedMetaDataList. In the process of resolving the meta data for an entity, the current code already takes into account all possible dependencies between entities. In short, ClassMetaData.resolveMeta() works as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;resolve super class of current entity, if applicable&lt;/li&gt;
	&lt;li&gt;resolve primary key field entities of current entity, if applicable&lt;br/&gt;
Both of these actions lead to calls to MetaDataRepository.processBuffer() with the respective entity meta data before processBuffer() is finally called for the current entity. Thus, all entities the current entity is dependent on are put into the buffer before the current entity. A simple array list thus is sufficient to let all entities be processed in the correct order.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve attached a corresponding patch called OpenJPA-Trunk_OJ1141-2.patch which implements these considerations. Although this patch removes the special logic within MetaDataRepository introduced by the original patch, the test cases of the original patch continue to work flawlessly as does the test suite attached to this JIRA issue. What is more, this fix is also able to cope with the mapping of my application, which happens to have many instances of foreign key references in primary keys as well as sub/superclass dependencies.&lt;/p&gt;</comment>
                            <comment id="12982649" author="ragesteel" created="Mon, 17 Jan 2011 14:28:20 +0000"  >&lt;p&gt;I&apos;m encountered simular NullPointerException at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1415), when trying to use Entities as part of Primary Key in 1.2.2. There is no such problem in 2.0.0 and 2.0.1.&lt;br/&gt;
I&apos;ve prepare minimal set of Entities that reproduces this error.&lt;br/&gt;
If I remove @JoinColumns from LineItem.order or remove Item.items &#8212; problem goes away. If I rename Product to Customer (with corresponding changes in other classes) &#8212; problem goes away too.&lt;/p&gt;

&lt;p&gt;&amp;lt;openjpa-1.2.2-r422266:898935 nonfatal general error&amp;gt; org.apache.openjpa.persistence.PersistenceException: null&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:196)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBrokerFactory.newBroker(DelegatingBrokerFactory.java:142)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:192)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:145)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:56)&lt;br/&gt;
	at org.apache.openjpa.test.TestMapping.testMapping(TestMapping.java:11)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)&lt;br/&gt;
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)&lt;br/&gt;
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)&lt;br/&gt;
	at org.junit.runners.BlockJUnit4ClassRunner.runNotIgnored(BlockJUnit4ClassRunner.java:79)&lt;br/&gt;
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:71)&lt;br/&gt;
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:49)&lt;br/&gt;
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)&lt;br/&gt;
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)&lt;br/&gt;
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)&lt;br/&gt;
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)&lt;br/&gt;
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)&lt;br/&gt;
	at org.junit.runners.ParentRunner.run(ParentRunner.java:236)&lt;br/&gt;
	at org.apache.maven.surefire.junit4.JUnit4TestSet.execute(JUnit4TestSet.java:59)&lt;br/&gt;
	at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.executeTestSet(AbstractDirectoryTestSuite.java:115)&lt;br/&gt;
	at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.execute(AbstractDirectoryTestSuite.java:102)&lt;br/&gt;
	at org.apache.maven.surefire.Surefire.run(Surefire.java:180)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.maven.surefire.booter.SurefireBooter.runSuitesInProcess(SurefireBooter.java:350)&lt;br/&gt;
	at org.apache.maven.surefire.booter.SurefireBooter.main(SurefireBooter.java:1021)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1415)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingInfo.createJoins(MappingInfo.java:1206)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingInfo.createForeignKey(MappingInfo.java:968)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.ValueMappingInfo.getTypeJoin(ValueMappingInfo.java:104)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.RelationFieldStrategy.map(RelationFieldStrategy.java:157)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.FieldMapping.setStrategy(FieldMapping.java:121)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.RuntimeStrategyInstaller.installStrategy(RuntimeStrategyInstaller.java:80)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.FieldMapping.resolveMapping(FieldMapping.java:454)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.FieldMapping.resolve(FieldMapping.java:419)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.ClassMapping.resolveNonRelationMappings(ClassMapping.java:871)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingRepository.prepareMapping(MappingRepository.java:418)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.preMapping(MetaDataRepository.java:757)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.resolve(MetaDataRepository.java:644)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.getMetaDataInternal(MetaDataRepository.java:393)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.getMetaDataLocking(MetaDataRepository.java:366)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.getMetaData(MetaDataRepository.java:360)&lt;br/&gt;
	at org.apache.openjpa.enhance.PCEnhancer.&amp;lt;init&amp;gt;(PCEnhancer.java:253)&lt;br/&gt;
	at org.apache.openjpa.enhance.PCEnhancer.&amp;lt;init&amp;gt;(PCEnhancer.java:224)&lt;br/&gt;
	at org.apache.openjpa.enhance.PCEnhancer.&amp;lt;init&amp;gt;(PCEnhancer.java:192)&lt;br/&gt;
	at org.apache.openjpa.enhance.ManagedClassSubclasser.prepareUnenhancedClasses(ManagedClassSubclasser.java:121)&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.loadPersistentTypes(AbstractBrokerFactory.java:310)&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.initializeBroker(AbstractBrokerFactory.java:228)&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:190)&lt;br/&gt;
	... 32 more&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12469803">OPENJPA-1736</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12423204" name="OpenJPA-1.2.x-OJ1141_10226009.patch" size="32472" author="fyrewyld" created="Mon, 26 Oct 2009 15:05:04 +0000"/>
                            <attachment id="12423461" name="OpenJPA-1.3.x_OJ1141.patch" size="33307" author="fyrewyld" created="Wed, 28 Oct 2009 15:47:03 +0000"/>
                            <attachment id="12425147" name="OpenJPA-Trunk_OJ1141-2.patch" size="15573" author="dirichs" created="Mon, 16 Nov 2009 21:36:37 +0000"/>
                            <attachment id="12423231" name="OpenJPA-Trunk_OJ1141.patch" size="32617" author="fyrewyld" created="Mon, 26 Oct 2009 19:15:15 +0000"/>
                            <attachment id="12411233" name="TestMappingProblem.zip" size="6772" author="yann" created="Fri, 19 Jun 2009 16:35:56 +0100"/>
                            <attachment id="12414202" name="ddl.sql" size="278" author="vorburger" created="Wed, 22 Jul 2009 11:22:54 +0100"/>
                            <attachment id="12468557" name="openjpa-1141.zip" size="8195" author="ragesteel" created="Mon, 17 Jan 2011 14:28:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Jul 2009 17:15:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161425</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt6an:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204200</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>