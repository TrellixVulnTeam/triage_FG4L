<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:40:32 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2298/OPENJPA-2298.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2298] VerifyError/Stack underflow due to extra &apos;return&apos; statements generated by PCEnhancer.</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2298</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;I&apos;ve been assisting Kevin Sutter with a &apos;VerifyError&apos; and am opening this JIRA on his behalf.  He has discovered a situation where the following VerifyError occurs:&lt;/p&gt;

&lt;p&gt;Exception data: java.lang.VerifyError: JVMVRFY036 stack underflow; class=irwwbase/PersistentTimerStatsJPA, method=pcNewObjectIdInstance(Ljava/lang/Object;)Ljava/lang/Object;, pc=26&lt;br/&gt;
    at java.lang.J9VMInternals.verifyImpl(Native Method)&lt;br/&gt;
    at java.lang.J9VMInternals.verify(J9VMInternals.java:85)&lt;br/&gt;
    at java.lang.J9VMInternals.initialize(J9VMInternals.java:162)&lt;br/&gt;
    at java.lang.Class.forNameImpl(Native Method)&lt;br/&gt;
    at java.lang.Class.forName(Class.java:176)&lt;br/&gt;
    at org.apache.openjpa.meta.MetaDataRepository.classForName(MetaDataRepository.java:1552)&lt;br/&gt;
    at org.apache.openjpa.meta.MetaDataRepository.loadPersistentTypesInternal(MetaDataRepository.java:1528)&lt;br/&gt;
    at org.apache.openjpa.meta.MetaDataRepository.loadPersistentTypes(MetaDataRepository.java:1506)&lt;br/&gt;
    at org.apache.openjpa.kernel.AbstractBrokerFactory.loadPersistentTypes(AbstractBrokerFactory.java:282)&lt;br/&gt;
    at org.apache.openjpa.kernel.AbstractBrokerFactory.initializeBroker(AbstractBrokerFactory.java:238)&lt;br/&gt;
    at org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:212)&lt;br/&gt;
    at org.apache.openjpa.kernel.DelegatingBrokerFactory.newBroker(DelegatingBrokerFactory.java:156)&lt;br/&gt;
    at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:227)&lt;br/&gt;
    ...........&lt;/p&gt;


&lt;p&gt;This issue occurs on, and is unique to, Java 7 and our enhancement code (as well as the entity definition).  That is, in PCEnhancer we are generating extra &apos;returns&apos; in methods which throw an exception.  This has an effect on ASM post-processing needed on Java 7 which ultimately causes the VerifyError.  This description probably makes no sense without more details and code to go along with it.  So let me now show how this looks in code.  First, I&apos;m attaching an entity, named PersistentTimerStatsJPA.java, and a PK class named &apos;PersistentTimerStatsPK.java&apos;.  While I won&apos;t go into exact details on how to use these classes to recreate the issue, I am providing them for the reader&apos;s reference.&lt;br/&gt;
Next, lets look at enhanced code before ASM post-processing occurs.  Take this code:&lt;/p&gt;

&lt;p&gt;&#160; public java.lang.Object pcNewObjectIdInstance(java.lang.Object);&lt;br/&gt;
&#160;&#160;&#160; flags: ACC_PUBLIC&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; Code:&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160; stack=3, locals=2, args_size=2&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0: new&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; #207&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // class java/lang/IllegalArgumentException&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 3: dup&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4: ldc_w&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; #367&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // String The id type \&quot;class irwwbase.PersistentTimerStatsPK\&quot; specified by persistent type \&quot;class irwwbase.PersistentTimerStatsJPA\&quot; does not have a public class irwwbase.PersistentTimerStatsPK(String) or class irwwbase.PersistentTimerStatsPK(Class, String) constructor.&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 7: invokespecial #368&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Method java/lang/IllegalArgumentException.&quot;&amp;lt;init&amp;gt;&quot;:(Ljava/lang/String;)V&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; 10: athrow&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; 11: return&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/p&gt;

&lt;p&gt;As you can see, we have a &quot;10: athrow&quot; and &quot;11: return&quot;.  This extraneous &quot;11: return&quot; hasn&apos;t caused problems in the past, but as will be explained in more details below, with ASM post-processing necessary in Java 7, this &quot;11: return&quot; causes problems.  To see this, lets look at the code above after going through ASM post-processing:&lt;/p&gt;

&lt;p&gt;&#160; public java.lang.Object pcNewObjectIdInstance(java.lang.Object);&lt;br/&gt;
&#160;&#160;&#160; flags: ACC_PUBLIC&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; Code:&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160; stack=3, locals=2, args_size=2&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0: new&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; #205&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // class java/lang/IllegalArgumentException&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 3: dup&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4: ldc_w&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; #363&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // String The id type \&quot;class irwwbase.PersistentTimerStatsPK\&quot; specified by persistent type \&quot;class irwwbase.PersistentTimerStatsJPA\&quot; does not have a public class irwwbase.PersistentTimerStatsPK(String) or class irwwbase.PersistentTimerStatsPK(Class, String) constructor.&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 7: invokespecial #364&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Method java/lang/IllegalArgumentException.&quot;&amp;lt;init&amp;gt;&quot;:(Ljava/lang/String;)V&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; 10: athrow&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; 11: athrow&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;br/&gt;
&#160;&#160;&#160;&#160;&#160; StackMapTable: number_of_entries = 1&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; frame_type = 255 /* full_frame */&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; offset_delta = 11&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; locals = []&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; stack = [ class java/lang/Throwable ]&lt;/p&gt;

&lt;p&gt;Notice that the &quot;11: return&quot; was changed to a second &quot;11: athrow&quot;.  To tie this all together, let me blatantly copy/paste a detailed description sent to me by Kevin: &lt;/p&gt;

&lt;p&gt;&quot;When JPA was attempting to generate the bytecodes for throwing an exception, we were accidentally including a return bytecode as well.  Of course, in a normal Java environment, this would have been flagged since the return would have been unreachable code.  But, since we were generating the bytecodes during enhancement, nothing is going to flag this situation.  But, due to the Java 7 class validation that is now being performed, we had to introduce the ASM post-processing.  Normally, these simple enhanced methods would not have been touched by ASM.  But, since these methods now had multiple exit points (due to the throw and return bytecodes), these methods were being flagged as &quot;complicated&quot; and needed Stack Map table adjustments performed by ASM.  Unfortunately, this additional ASM code now introduced the situation where too many items would have been popped off the stack (if the code could have actually executed as coded).  This is the Stack Underflow exception that was happening during Class load time.&quot;&lt;/p&gt;

&lt;p&gt;Basically, Kevin&apos;s fix was to find all of the areas where we generate a &quot;throw&quot; followed by a &quot;return&quot;, and remove the &quot;return&quot;.  Since this method is only attempting to throw an exception, we really don&apos;t need the second &quot;return&quot; instruction.  I&apos;m providing Kevin&apos;s patch, which is named &apos;VerifyError.patch&apos;.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Heath&lt;/p&gt;</description>
                <environment></environment>
        <key id="12616445">OPENJPA-2298</key>
            <summary>VerifyError/Stack underflow due to extra &apos;return&apos; statements generated by PCEnhancer.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jpaheath">Heath Thomann</assignee>
                                    <reporter username="jpaheath">Heath Thomann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Nov 2012 17:18:32 +0000</created>
                <updated>Wed, 10 Apr 2013 15:49:35 +0100</updated>
                            <resolved>Wed, 10 Apr 2013 15:49:30 +0100</resolved>
                                    <version>2.2.0</version>
                    <version>2.3.0</version>
                                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>2.2.1.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Enhance</component>
                    <component>instrumentation</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13498940" author="jpaheath" created="Fri, 16 Nov 2012 17:20:41 +0000"  >&lt;p&gt;I&apos;m providing a patch which was created by Kevin Sutter, and am attaching two classes he used when recreating the issue.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Heath&lt;/p&gt;</comment>
                            <comment id="13499025" author="kwsutter" created="Fri, 16 Nov 2012 19:12:14 +0000"  >&lt;p&gt;Good write-up, Heath.  My patch had commented out the extra &quot;return&quot; bytecode generations.  When you apply the patch, please remove the &quot;return&quot; statements.  Don&apos;t comment them out.  Thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12633817">OPENJPA-2339</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12553799" name="PersistentTimerStatsJPA.java" size="2048" author="jpaheath" created="Fri, 16 Nov 2012 17:20:41 +0000"/>
                            <attachment id="12553800" name="PersistentTimerStatsPK.java" size="994" author="jpaheath" created="Fri, 16 Nov 2012 17:20:41 +0000"/>
                            <attachment id="12553798" name="VerifyError.patch" size="1270" author="jpaheath" created="Fri, 16 Nov 2012 17:20:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 16 Nov 2012 19:12:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>258287</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyelpz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>119215</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>