<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:36:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1726/OPENJPA-1726.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1726] Clean up OpenJPA test case failures for PostgreSQL</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1726</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description></description>
                <environment></environment>
        <key id="12469301">OPENJPA-1726</key>
            <summary>Clean up OpenJPA test case failures for PostgreSQL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="faywang">Fay Wang</assignee>
                                    <reporter username="faywang">Fay Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Jul 2010 23:46:28 +0100</created>
                <updated>Wed, 27 Apr 2011 18:33:38 +0100</updated>
                            <resolved>Tue, 27 Jul 2010 17:31:44 +0100</resolved>
                                    <version>2.1.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12888940" author="faywang" created="Thu, 15 Jul 2010 23:15:36 +0100"  >&lt;p&gt;TestIdClassCompanyModel.testBasicQueries fails with the following exception:&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.openjpa.lib.jdbc.ReportingSQLException: ERROR: function pg_catalog.substring(character varying, bigint) does not exist&lt;br/&gt;
Hint: No function matches the given name and argument types. You might need to add explicit type casts.&lt;br/&gt;
Position: 658 &lt;/p&gt;
{prepstmnt 795758045 SELECT t0.id, t0.DTYPE, t0.firstName, t2.id, t2.city, t2.phoneNumber, t2.postalCode, t2.state, t2.streetAddress, t0.lastName, t1.id, t3.id, t3.city, t3.phoneNumber, t3.postalCode, t3.state, t3.streetAddress, t1.name, t0.hireDate, t4.id, t4.DTYPE, t4.firstName, t4.HOMEADDRESS_ID, t4.lastName, t4.COMPANY_ID, t4.hireDate, t4.title, t4.salary, t0.title, t0.salary, t0.wage, t0.weeklyHours FROM IDC_Person t0 INNER JOIN IDC_Company t1 ON t0.COMPANY_ID = t1.id LEFT OUTER JOIN IDC_Address t2 ON t0.HOMEADDRESS_ID = t2.id LEFT OUTER JOIN IDC_Person t4 ON t0.MANAGER_ID = t4.id LEFT OUTER JOIN IDC_Address t3 ON t1.ADDRESS_ID = t3.id WHERE (((POSITION(t1.name IN SUBSTRING(?, ((? - ?) + 1))) - 1 + (? - ?)) + ?) &amp;gt; ?) AND t0.DTYPE IN (?, ?, ?) AND (t4.DTYPE IS NULL OR t4.DTYPE IN (?)) [params=?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=0, state=42883&amp;#93;&lt;/span&gt;&lt;br/&gt;
FailedObject: select x from IDC_Employee x where locate(x.company.name, &apos;x&apos;, 1) &amp;gt; 0 &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.String&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In the push-down sql:&lt;br/&gt;
(((POSITION(t0.firstName IN SUBSTRING(?, ((? - ?) + 1))) - 1 + (? - ?)) + ?) &amp;gt; ?)&lt;/p&gt;

&lt;p&gt;OpenJPA set the parameters as follows:&lt;/p&gt;

&lt;p&gt;        pstmt.setString(1, &quot;x&quot;);&lt;br/&gt;
        pstmt.setLong(2, 1);&lt;br/&gt;
        pstmt.setInt(3, 1);&lt;br/&gt;
        pstmt.setLong(4, 1);&lt;br/&gt;
        pstmt.setInt(5, 1);&lt;br/&gt;
        pstmt.setInt(6, 1);&lt;br/&gt;
        pstmt.setLong(7, 0);&lt;/p&gt;

&lt;p&gt;The second parameter is set to type Long, which causes the error that the function pg_catalog.substring(character varying, bigint) does not exist. It turns out the for Postgres, the start index in the locate function must be int:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.postgresql.org/docs/8.1/static/functions-string.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.postgresql.org/docs/8.1/static/functions-string.html&lt;/a&gt;&lt;br/&gt;
substring(string &lt;span class=&quot;error&quot;&gt;&amp;#91;from int&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;for int&amp;#93;&lt;/span&gt;)&lt;/p&gt;

&lt;p&gt;The fix is to modify JPQLExpressionBuilder to create a Lit of Integer value for the locateFromIndex.&lt;/p&gt;

&lt;p&gt;Although this fix affects all database, it is reasonable to assume that the start index in the locate function is in the integer range.&lt;/p&gt;</comment>
                            <comment id="12888968" author="faywang" created="Fri, 16 Jul 2010 01:16:07 +0100"  >&lt;p&gt;TestTypeSafeCondExpression.testTrimFunc1 and testTrimFunc2 fail in Postgres when the criteria API is used:&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.openjpa.lib.jdbc.ReportingSQLException: ERROR: function pg_catalog.btrim(character varying, integer) does not exist&lt;br/&gt;
Hint: No function matches the given name and argument types. You might need to add explicit type casts.&lt;br/&gt;
Position: 8 &lt;/p&gt;
{prepstmnt 598291031 SELECT TRIM(BOTH ? FROM t0.compName) FROM CompUser t0 WHERE (t0.name = ?) [params=?, ?]}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;code=0, state=42883&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In these test cases, OpenJPA criteria API sets the trim character as the Character type, resulting in the call of PreparedStatement.setInt for the trim character (via DBDictionary.setChar). Postgres therefore throws error that function pg_catalog.btrim(character varying, integer) does not exist. The patch &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1726&quot; title=&quot;Clean up OpenJPA test case failures for PostgreSQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1726&quot;&gt;&lt;del&gt;OPENJPA-1726&lt;/del&gt;&lt;/a&gt;-2.patch modifies the trim character  to String type to fix this problem.&lt;/p&gt;</comment>
                            <comment id="12890082" author="faywang" created="Mon, 19 Jul 2010 23:58:23 +0100"  >&lt;p&gt;The following four OpenJPA test cases fail with the same error:&lt;/p&gt;

&lt;p&gt;TestGeneratedValues.testDefaultValues&lt;br/&gt;
TestGeneratedValues.testCustomSequenceGeneratorWithIndirection&lt;br/&gt;
TestGeneratedValues.testUUIDGenerators&lt;br/&gt;
TestNonstandardMappingAnnotations.testInsertAndRetrieve&lt;/p&gt;

&lt;p&gt;Caused by: &amp;lt;openjpa-2.1.0-SNAPSHOT-rexported fatal general error&amp;gt; org.apache.openjpa.persistence.PersistenceException: ERROR: invalid byte sequence for encoding &quot;UTF8&quot;: 0x00. Hint: This error can also happen if the byte sequence does not match the encoding expected by the server, which is controlled by &quot;client_encoding&quot;.&lt;/p&gt;

&lt;p&gt;This error is caused by the two auto-generated uuid values (uuidstring and uuidT4string) In the entity, org.apache.openjpa.persistence.generationtype.GeneratedValues:  &lt;/p&gt;

&lt;p&gt;    @GeneratedValue(generator=&quot;uuid-string&quot;)&lt;br/&gt;
    private String uuidstring;&lt;/p&gt;

&lt;p&gt;    @GeneratedValue(generator=&quot;uuid-type4-string&quot;)&lt;br/&gt;
    private String uuidT4string;&lt;/p&gt;

&lt;p&gt;These two fields are populated in a way that org.apache.openjpa.lib.util.UUIDGenerator first randomly generates byte[] and then converts it to a String using charset &quot;ISO-8859-1&quot;. The resulting string may contain 0x00, causing invalid byte sequence for encoding &quot;UTF8&quot;: 0x00. The failures are not deterministic as the UUID values are randomly generated. One way to fix this problem is to exclude Postgres from running these four test cases. Any comments are welcome.&lt;/p&gt;</comment>
                            <comment id="12890272" author="techhusky" created="Tue, 20 Jul 2010 15:47:01 +0100"  >&lt;p&gt;I ran into some issues with uuid-string and uuid-type4-string a while back.  This problem isn&apos;t specific to PostgreSQL, but looks to be even more prevalent on that platform since it stores data in UTF-8.  UTF-8 is particularly picky about character values.  To be honest, I wouldn&apos;t ever recommend the use of uuid-string or uuid-type4-string since they generate integral byte values and plug them in as character data without taking into account the character encoding of either the client or database column.  Depending on the conversion, the id may get converted to some other value or fail to convert (like we are witnessing on PostgreSQL).  A better choice would have been to convert the values to ASCII base-10 numeric characters.  This is not something we can change now though, since there may be existing applications happily running with the current generation strategy.  The use of uuid-hex or uuid-type4-hex is a much better choice since the key value includes only invariant characters.&lt;/p&gt;

&lt;p&gt;Since this could fail intermittently on any platform a better choice might be to either discontinue testing uuid-string or uuid-type4-string (while continuing to test uuid-hex and uuid-type4-hex) or test the -string variants separately, excluding PostgreSQL.  I&apos;m OK with either, or simply excluding the test from running on PostgreSQL as you suggested.&lt;/p&gt;</comment>
                            <comment id="12893421" author="faywang" created="Thu, 29 Jul 2010 00:23:22 +0100"  >&lt;p&gt;	The failing test cases running on Postgres are now in TestMixedLockManagerFindPermutation. This test case spawns three threads and the pass/no pass of the test cases depends on the timing.  &lt;/p&gt;

&lt;p&gt;	One example is TestMixedLockManagerFindPermutation.testFindReadPessimisticRead when the second child thread is doing rollback: &lt;br/&gt;
        commonFindTest(&lt;br/&gt;
            &quot;testFind(Read,Commit/PessimisticRead,Rollback)&quot;,&lt;br/&gt;
            LockModeType.READ, Act.CommitTx, 1, null,&lt;br/&gt;
            LockModeType.PESSIMISTIC_READ, Act.RollbackTx, 1, null);&lt;/p&gt;

&lt;p&gt;	In the failing trace file, you can easily see that the find by the second child &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-8&amp;#93;&lt;/span&gt; is before the jdbc commit of the update statement by the first child &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-7&amp;#93;&lt;/span&gt;, even though the commit action is issued by Thread-7 before the find by Thread-8.&lt;/p&gt;</comment>
                            <comment id="12893423" author="faywang" created="Thu, 29 Jul 2010 00:26:49 +0100"  >&lt;p&gt;The zip file contains trace log for success run and failing run to illustrate the timing issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12468078">OPENJPA-1710</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12505188">OPENJPA-1985</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12449605" name="OPENJPA-1726-2.patch" size="3301" author="faywang" created="Fri, 16 Jul 2010 01:16:07 +0100"/>
                            <attachment id="12449598" name="OPENJPA-1726.patch" size="1642" author="faywang" created="Thu, 15 Jul 2010 23:15:35 +0100"/>
                            <attachment id="12450770" name="TestMixedLockManagerFindPermutation_trace.zip" size="3798" author="faywang" created="Thu, 29 Jul 2010 00:26:49 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 20 Jul 2010 14:47:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161973</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz7o8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>288896</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>