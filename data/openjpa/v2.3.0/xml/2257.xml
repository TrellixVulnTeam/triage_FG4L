<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:45:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-2257/OPENJPA-2257.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-2257] Concurreny in org.apache.openjpa.persistence.EntityManagerImpl.getProperties leads to NullPointer and ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-2257</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;A call of EntityManager.getProperties() can lead to NullPointer and ConcurrentModificationException. Issue occurs right after start up of the overlying JEE application if multiple EntityManager instance are created at same time.&lt;/p&gt;

&lt;p&gt;Please find the issued stack trace below:&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.NullPointerException&lt;br/&gt;
        at java.lang.String.compareTo(String.java:482)&lt;br/&gt;
        at java.lang.String.compareTo(String.java:31)&lt;br/&gt;
        at java.util.TreeMap.cmp(TreeMap.java:4514)&lt;br/&gt;
        at java.util.TreeMap.putImpl(TreeMap.java:4556)&lt;br/&gt;
        at java.util.TreeMap.put(TreeMap.java:4536)&lt;br/&gt;
        at java.util.TreeSet.add(TreeSet.java:122)&lt;br/&gt;
        at&lt;br/&gt;
org.apache.openjpa.lib.conf.ConfigurationImpl.getPropertyKeys(ConfigurationImpl.java:708)&lt;br/&gt;
        at&lt;br/&gt;
org.apache.openjpa.kernel.BrokerImpl.getSupportedProperties(BrokerImpl.java:729)&lt;br/&gt;
        at&lt;br/&gt;
org.apache.openjpa.kernel.DelegatingBroker.getSupportedProperties(DelegatingBroker.java:223)&lt;br/&gt;
        at&lt;br/&gt;
org.apache.openjpa.persistence.EntityManagerImpl.getProperties(EntityManagerImpl.java:1624)&lt;br/&gt;
        ... 33 more&lt;/p&gt;</description>
                <environment>AIX 6.1 (64-bit)&lt;br/&gt;
WebSphere Application Server V8.0 (32-bit) </environment>
        <key id="12605972">OPENJPA-2257</key>
            <summary>Concurreny in org.apache.openjpa.persistence.EntityManagerImpl.getProperties leads to NullPointer and ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="allee8285">Albert Lee</assignee>
                                    <reporter username="stephan82">Stephan Hagedorn</reporter>
                        <labels>
                            <label>concurrency</label>
                            <label>concurrentmodificationexception</label>
                            <label>nullpointerexception</label>
                    </labels>
                <created>Mon, 3 Sep 2012 11:28:41 +0100</created>
                <updated>Wed, 10 Apr 2013 16:04:28 +0100</updated>
                            <resolved>Wed, 5 Sep 2012 21:11:23 +0100</resolved>
                                    <version>2.1.2</version>
                                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>2.2.1.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>jpa</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13448979" author="allee8285" created="Wed, 5 Sep 2012 19:33:02 +0100"  >&lt;p&gt;The problem is caused by the assumption that the configurationImpl obtained from emf is threadsafe since all the configuration values are frozen once the emf is created. However the broker getProperty() implementation defers the building up of the property key collection (_supportedKeys) in the configurationImpl when it is needed, but the _supportedKeys is not synchronized( thread safe), hence the observed exceptions.&lt;/p&gt;</comment>
                            <comment id="13449076" author="allee8285" created="Wed, 5 Sep 2012 21:11:23 +0100"  >&lt;p&gt;Fixed only in trunk. To get fixes for 2.1.x, you&apos;ll need to request it from WebSphere service channel.&lt;/p&gt;</comment>
                            <comment id="13540513" author="jpaheath" created="Fri, 28 Dec 2012 16:56:27 +0000"  >&lt;p&gt;In addition to Albert&apos;s changes, I&apos;ve found that more changes were necessary.  That is, synchronizing on &apos;_supportedKeys&apos; in ConfigurationImpl.getPropertyKeys is necessary and fixes one ConcurrentModificationException/NPE, however, I found another spot which causes a ConcurrentModificationException when the returned &apos;_supportedKeys&apos; is added to by other areas of code.  The exception and stack I saw was the following:&lt;/p&gt;

&lt;p&gt;java.util.ConcurrentModification&lt;br/&gt;
	at java.util.TreeMap$AbstractMapIterator.makeNext(TreeMap.java:5794)&lt;br/&gt;
            at java.util.TreeMap$UnboundedKeyIterator.next(TreeMap.java:5896)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerImpl.getProperties(EntityManagerImpl.java:1624)&lt;br/&gt;
	at Test.run(Test.java:26)&lt;/p&gt;


&lt;p&gt;From the stack, EntityManagerImpl.getProperties is operating on the the set (i.e. &apos;_supportedKeys&apos;) returned by ConfigurationImpl.getPropertyKeys.  In a single threaded environment, operating on the set is just fine.  However, in my test, I had found that if one thread is operating on the set (as shown in the stack above), yet another thread is adding to the set, the ConcurrentModification exception can occur.  While the details of my tests are rather long and nearly impossible to hit in a real world situation, let me basically state that I found that if a thread was in the &apos;EntityManagerImpl.getProperties&apos; listed above, and another thread was in this portion of code in BrokerImpl:&lt;/p&gt;


&lt;p&gt;     public Set&amp;lt;String&amp;gt; getSupportedProperties() {&lt;br/&gt;
         Set&amp;lt;String&amp;gt; keys = _conf.getPropertyKeys();&lt;br/&gt;
        for (String s : _supportedPropertyNames)&lt;br/&gt;
            keys.add(&quot;openjpa.&quot; + s);&lt;/p&gt;

&lt;p&gt;A ConcurrentModification exception could occur given that the one thread operating in &apos;getSupportedProperties&apos; could add to &apos;keys&apos; (which is really the &apos;_supportedKeys&apos;), and another thread could be iterating over this same set.  This issue seemed to be further complicated, and dependent on, the JDK in use.  I created the above exception by using an IBM JDK which appears to add some inner classes (e.g. .TreeMap$UnboundedKeyIterator) to a TreeMap which performs some additional checks for concurrent access.  Bottom line is that the fix appears to be to return a copy of &apos;_supportedKeys&apos; which is returned by ConfigurationImpl.getPropertyKeys.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12544051" name="OPENJPA-2257.patch" size="4271" author="allee8285" created="Thu, 6 Sep 2012 15:52:07 +0100"/>
                            <attachment id="12543526" name="OpenJPABugTest.zip" size="8121105" author="stephan82" created="Mon, 3 Sep 2012 11:32:18 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 Sep 2012 18:33:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240109</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxurx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>