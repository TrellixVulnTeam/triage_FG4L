<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:34:34 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-146/OPENJPA-146.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-146] Entity enhancement fails while using EmbeddedId on a MappedSuperclass</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-146</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Both buildtime and runtime class enhancement fail with the following error:&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
1339  TRACE  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; openjpa.Enhance - Enhancing type &quot;class test.B&quot;.&lt;br/&gt;
Exception in thread &quot;main&quot; &amp;lt;0|false|0.9.6-incubating&amp;gt; org.apache.openjpa.util.GeneralException: null&lt;br/&gt;
        at org.apache.openjpa.enhance.PCEnhancer.run(PCEnhancer.java:350)&lt;br/&gt;
        at org.apache.openjpa.enhance.PCEnhancer.run(PCEnhancer.java:3711)&lt;br/&gt;
        at org.apache.openjpa.enhance.PCEnhancer.run(PCEnhancer.java:3661)&lt;br/&gt;
        at org.apache.openjpa.enhance.PCEnhancer.main(PCEnhancer.java:3633)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
        at org.apache.openjpa.enhance.PCEnhancer.enhanceObjectId(PCEnhancer.java:2745)&lt;br/&gt;
        at org.apache.openjpa.enhance.PCEnhancer.run(PCEnhancer.java:338)&lt;br/&gt;
        ... 3 more&lt;/p&gt;

&lt;p&gt;Test code as follows:&lt;/p&gt;

&lt;p&gt;test/A.java:&lt;br/&gt;
--------------&lt;br/&gt;
package test;&lt;/p&gt;

&lt;p&gt;import javax.persistence.*;&lt;br/&gt;
import java.io.Serializable;&lt;/p&gt;

&lt;p&gt;@MappedSuperclass&lt;br/&gt;
abstract public class A {&lt;/p&gt;

&lt;p&gt;    @Embeddable&lt;br/&gt;
    public static class A_PK implements Serializable {&lt;br/&gt;
        @Basic&lt;br/&gt;
        protected int id1;&lt;/p&gt;

&lt;p&gt;        @Basic&lt;br/&gt;
        protected String id2;&lt;/p&gt;

&lt;p&gt;        public boolean equals (Object other) &lt;/p&gt;
{
            return false;
        }

&lt;p&gt;        public int hashCode () &lt;/p&gt;
{
            return 0;
        }

&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;    @EmbeddedId&lt;br/&gt;
    protected A_PK pk;&lt;/p&gt;

&lt;p&gt;    @Basic&lt;br/&gt;
    protected String val;&lt;/p&gt;

&lt;p&gt;}&lt;br/&gt;
--------------&lt;/p&gt;

&lt;p&gt;test/B.java:&lt;br/&gt;
--------------&lt;br/&gt;
package test;&lt;/p&gt;

&lt;p&gt;import javax.persistence.Entity;&lt;/p&gt;

&lt;p&gt;@Entity&lt;br/&gt;
public class B extends A {&lt;/p&gt;

&lt;p&gt;}&lt;br/&gt;
--------------&lt;/p&gt;

&lt;p&gt;META-INF/persistence.xml:&lt;br/&gt;
--------------&lt;br/&gt;
&amp;lt;persistence xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot;&lt;br/&gt;
        xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;br/&gt;
        xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/persistence/orm &lt;a href=&quot;http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd&lt;/a&gt;&quot;&lt;br/&gt;
        version=&quot;1.0&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;persistence-unit name=&quot;TestService&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;&amp;gt;&lt;br/&gt;
        &amp;lt;class&amp;gt;test.A$A_PK&amp;lt;/class&amp;gt;&lt;br/&gt;
        &amp;lt;class&amp;gt;test.A&amp;lt;/class&amp;gt;&lt;br/&gt;
        &amp;lt;class&amp;gt;test.B&amp;lt;/class&amp;gt;&lt;br/&gt;
        &amp;lt;properties&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.Log&quot; value=&quot;DefaultLevel=TRACE&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;            &amp;lt;property name=&quot;openjpa.ConnectionUserName&quot; value=&quot;test&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.ConnectionPassword&quot; value=&quot;test&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.ConnectionURL&quot; value=&quot;jdbc:mysql://localhost:3306/oam?useServerPrepStmts=false&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;property name=&quot;openjpa.ConnectionDriverName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/properties&amp;gt;&lt;br/&gt;
    &amp;lt;/persistence-unit&amp;gt;&lt;br/&gt;
&amp;lt;/persistence&amp;gt;&lt;br/&gt;
--------------&lt;/p&gt;


</description>
                <environment>openjpa 0.9.6</environment>
        <key id="12362779">OPENJPA-146</key>
            <summary>Entity enhancement fails while using EmbeddedId on a MappedSuperclass</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="gergul">Gokhan Ergul</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Feb 2007 12:00:07 +0000</created>
                <updated>Tue, 9 Mar 2010 18:32:30 +0000</updated>
                            <resolved>Tue, 20 Feb 2007 16:35:16 +0000</resolved>
                                                    <fixVersion>0.9.7</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12473055" author="gergul" created="Wed, 14 Feb 2007 12:04:17 +0000"  >&lt;p&gt;Test case and trace output attached.&lt;/p&gt;</comment>
                            <comment id="12473122" author="awhite" created="Wed, 14 Feb 2007 15:25:19 +0000"  >&lt;p&gt;We don&apos;t enhance the oid class anymore, so this bug is probably fixed or at least will manifest itself in a different way in the latest code.&lt;/p&gt;</comment>
                            <comment id="12473901" author="gergul" created="Sat, 17 Feb 2007 09:13:10 +0000"  >&lt;p&gt;0.9.7-snapshot seems to have solved this indeed, thanks.&lt;/p&gt;</comment>
                            <comment id="12473911" author="gergul" created="Sat, 17 Feb 2007 10:08:44 +0000"  >&lt;p&gt;Alright, it did manifest itself in a different way as you guessed:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.EmbedValueHandler.map(EmbedValueHandler.java:50)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.ObjectIdValueHandler.map(ObjectIdValueHandler.java:46)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.HandlerStrategies.map(HandlerStrategies.java:56)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.strats.HandlerFieldStrategy.map(HandlerFieldStrategy.java:77)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.FieldMapping.setStrategy(FieldMapping.java:117)&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;Bit of debugging into the code:&lt;/p&gt;

&lt;p&gt;(EmbedValueHandler.java) &lt;br/&gt;
    protected void map(ValueMapping vm, String name, ColumnIO io,&lt;br/&gt;
        boolean adapt, List cols, List args) {&lt;br/&gt;
        // have to resolve embedded value to collect its columns&lt;br/&gt;
        vm.getEmbeddedMapping().resolve(vm.MODE_META | vm.MODE_MAPPING);&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;vm .getEmbeddedMapping() returns null, since:&lt;/p&gt;

&lt;p&gt;(ValueMetaDataImpl.java)&lt;br/&gt;
    public ClassMetaData getEmbeddedMetaData() &lt;/p&gt;
{
        if (_embeddedMeta == null &amp;amp;&amp;amp; isEmbeddedPC())
            addEmbeddedMetaData();
        return _embeddedMeta;
    }

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;    public boolean isEmbeddedPC() &lt;/p&gt;
{
        return _decCode == JavaTypes.PC &amp;amp;&amp;amp; isEmbedded();
    }&lt;br/&gt;
&lt;br/&gt;
_decCode is JavaTypes.OID. &lt;br/&gt;
&lt;br/&gt;
JavaTypes.PC was possibly overwritten by:&lt;br/&gt;
&lt;br/&gt;
    public boolean resolve(int mode) {&lt;br/&gt;
...&lt;br/&gt;
        // oid as primary key field?&lt;br/&gt;
        if (_decCode == JavaTypes.PC &amp;amp;&amp;amp; isEmbedded()&lt;br/&gt;
            &amp;amp;&amp;amp; _owner.isPrimaryKey() &amp;amp;&amp;amp; _owner.getValue() == this)&lt;br/&gt;
            _code = _decCode = JavaTypes.OID; &lt;br/&gt;
&lt;br/&gt;
So I&apos;ve changed&lt;br/&gt;
&lt;br/&gt;
    public boolean isEmbeddedPC() {
        return _decCode == JavaTypes.PC &amp;amp;&amp;amp; isEmbedded();
    }

&lt;p&gt;to &lt;/p&gt;

&lt;p&gt;    public boolean isEmbeddedPC() &lt;/p&gt;
{
        return (_decCode == JavaTypes.PC || _decCode == JavaTypes.OID) &amp;amp;&amp;amp; isEmbedded();
    }

&lt;p&gt;seems to have fixed the problem, tho I&apos;m not sure if it has any nasty sideeffects.&lt;/p&gt;

&lt;p&gt;Any comments?&lt;/p&gt;</comment>
                            <comment id="12474474" author="awhite" created="Tue, 20 Feb 2007 15:33:12 +0000"  >&lt;p&gt;Looks like a good fix to me.  Do you need someone to commit this for you?&lt;/p&gt;</comment>
                            <comment id="12474480" author="awhite" created="Tue, 20 Feb 2007 16:07:32 +0000"  >&lt;p&gt;Cancel my previous comment.  Embedded PCs are handled very differently than OIDs at runtime, and so changing the isEmbeddedPC method to encompass OIDs as well might cause problems.  I think the root of the problem has to do with metadata resolution of mapped superclass fields (after all, EmbeddedIds in Entities work fine, just not in MappedSuperclasses).  I&apos;ll investigate further.&lt;/p&gt;</comment>
                            <comment id="12474493" author="awhite" created="Tue, 20 Feb 2007 16:35:16 +0000"  >&lt;p&gt;Resolved with revision 509632.  When copying OID superclass fields for mapping in a subclass, revert the type of the field to PC.  It will re-resolve to OID when the copied field&apos;s metadata is resolved, and in the meantime it ensures that the copied field resolution will use the same code path as non-copied fields.&lt;/p&gt;</comment>
                            <comment id="12474525" author="gergul" created="Tue, 20 Feb 2007 18:39:52 +0000"  >&lt;p&gt;Fix confirmed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12351129" name="test-case.zip" size="2475" author="gergul" created="Wed, 14 Feb 2007 12:04:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 14 Feb 2007 15:25:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160480</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hysvyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>202526</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>