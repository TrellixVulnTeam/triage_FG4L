<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:37:20 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1736/OPENJPA-1736.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1736] Mappings with foreign keys as identity fields sometimes not resolved correctly</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1736</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;This is a follow-up issue of &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1141&quot; title=&quot;NPE  at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1400)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1141&quot;&gt;&lt;del&gt;OPENJPA-1141&lt;/del&gt;&lt;/a&gt;. The solution developed for that issue only handled some aspects of an underlying greater problem with OpenJPAs mapping algorithm. This algorithm may fail under certain circumstances involving foreign keys used as identity fields in other entities. A patch with a test case illustrating this problem is attached to this issue. The problem can probably show up with different exceptions. However, the stack trace for the supplied test case is as follows:&lt;/p&gt;

&lt;p&gt;testEntityAsIdentityField001(org.apache.openjpa.persistence.identity.entityasidentity2.TestEntityAsIdentityFields2)  Time elapsed: 1.656 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!&lt;br/&gt;
&amp;lt;openjpa-2.0.0-r422266:935683M fatal user error&amp;gt; org.apache.openjpa.persistence.ArgumentException: Errors encountered while resolving metadata.  See nested exceptions for details.&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.resolve(MetaDataRepository.java:642)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.getMetaDataInternal(MetaDataRepository.java:385)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.getMetaData(MetaDataRepository.java:358)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.resolveMeta(MetaDataRepository.java:688)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.resolve(MetaDataRepository.java:617)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.getMetaDataInternal(MetaDataRepository.java:385)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.getMetaData(MetaDataRepository.java:358)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingRepository.getMapping(MappingRepository.java:355)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingTool.getMapping(MappingTool.java:679)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingTool.buildSchema(MappingTool.java:751)&lt;br/&gt;
	at org.apache.openjpa.jdbc.meta.MappingTool.run(MappingTool.java:649)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCBrokerFactory.synchronizeMappings(JDBCBrokerFactory.java:149)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCBrokerFactory.synchronizeMappings(JDBCBrokerFactory.java:159)&lt;br/&gt;
	at org.apache.openjpa.jdbc.kernel.JDBCBrokerFactory.newBrokerImpl(JDBCBrokerFactory.java:117)&lt;br/&gt;
	at org.apache.openjpa.kernel.AbstractBrokerFactory.newBroker(AbstractBrokerFactory.java:199)&lt;br/&gt;
	at org.apache.openjpa.kernel.DelegatingBrokerFactory.newBroker(DelegatingBrokerFactory.java:156)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:213)&lt;br/&gt;
	at org.apache.openjpa.persistence.EntityManagerFactoryImpl.createEntityManager(EntityManagerFactoryImpl.java:151)&lt;br/&gt;
	at org.apache.openjpa.persistence.identity.entityasidentity2.TestEntityAsIdentityFields2.testEntityAsIdentityField001(TestEntityAsIdentityFields2.java:16)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at junit.framework.TestCase.runTest(TestCase.java:154)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.runTest(AbstractPersistenceTestCase.java:516)&lt;br/&gt;
	at junit.framework.TestCase.runBare(TestCase.java:127)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.runBare(AbstractPersistenceTestCase.java:503)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.runBare(AbstractPersistenceTestCase.java:479)&lt;br/&gt;
	at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
	at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
	at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
	at junit.framework.TestCase.run(TestCase.java:118)&lt;br/&gt;
	at org.apache.openjpa.persistence.test.AbstractPersistenceTestCase.run(AbstractPersistenceTestCase.java:179)&lt;br/&gt;
	at junit.framework.TestSuite.runTest(TestSuite.java:208)&lt;br/&gt;
	at junit.framework.TestSuite.run(TestSuite.java:203)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.maven.surefire.junit.JUnitTestSet.execute(JUnitTestSet.java:213)&lt;br/&gt;
	at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.executeTestSet(AbstractDirectoryTestSuite.java:140)&lt;br/&gt;
	at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.execute(AbstractDirectoryTestSuite.java:127)&lt;br/&gt;
	at org.apache.maven.surefire.Surefire.run(Surefire.java:177)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.maven.surefire.booter.SurefireBooter.runSuitesInProcess(SurefireBooter.java:345)&lt;br/&gt;
	at org.apache.maven.surefire.booter.SurefireBooter.main(SurefireBooter.java:1009)&lt;br/&gt;
Caused by: &amp;lt;openjpa-2.0.0-r422266:935683M fatal user error&amp;gt; org.apache.openjpa.persistence.ArgumentException: The id class specified by type &quot;class org.apache.openjpa.persistence.identity.entityasidentity2.Attendance&quot; does not match the primary key fields of the class.  Make sure your identity class has the same primary keys as your persistent type, including pk field types. Mismatched property: &quot;student&quot;&lt;br/&gt;
	at org.apache.openjpa.meta.ClassMetaData.validateAppIdClassPKs(ClassMetaData.java:2205)&lt;br/&gt;
	at org.apache.openjpa.meta.ClassMetaData.validateAppIdClass(ClassMetaData.java:2079)&lt;br/&gt;
	at org.apache.openjpa.meta.ClassMetaData.validateIdentity(ClassMetaData.java:2015)&lt;br/&gt;
	at org.apache.openjpa.meta.ClassMetaData.validateMeta(ClassMetaData.java:1927)&lt;br/&gt;
	at org.apache.openjpa.meta.ClassMetaData.resolve(ClassMetaData.java:1788)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.processBuffer(MetaDataRepository.java:790)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.resolveMeta(MetaDataRepository.java:693)&lt;br/&gt;
	at org.apache.openjpa.meta.MetaDataRepository.resolve(MetaDataRepository.java:617)&lt;br/&gt;
	... 48 more&lt;/p&gt;

&lt;p&gt;A proposed solution to this issue is given below.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12469803">OPENJPA-1736</key>
            <summary>Mappings with foreign keys as identity fields sometimes not resolved correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fancy">Catalina Wei</assignee>
                                    <reporter username="dirichs">Martin Dirichs</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Jul 2010 11:55:59 +0100</created>
                <updated>Mon, 20 Sep 2010 16:40:04 +0100</updated>
                            <resolved>Sat, 21 Aug 2010 16:52:22 +0100</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>jdbc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12890645" author="dirichs" created="Wed, 21 Jul 2010 12:00:39 +0100"  >&lt;p&gt;File OpenJPA-2.0.0_OJ1736.testcase.patch contains a test case which can be applied to the OpenJPA source and then run.&lt;/p&gt;</comment>
                            <comment id="12890702" author="dirichs" created="Wed, 21 Jul 2010 13:13:45 +0100"  >&lt;p&gt;File OpenJPA-2.0.0_OJ1736.patch contains a proposed fix for this issue.&lt;/p&gt;

&lt;p&gt;Basically, the patch removes the changes done for &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1141&quot; title=&quot;NPE  at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1400)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1141&quot;&gt;&lt;del&gt;OPENJPA-1141&lt;/del&gt;&lt;/a&gt; and replaces the InheritanceOrderedMetaDataList used in MetaDataRepository.processBuffer with a simple ArrayList&amp;lt;MetaData&amp;gt;. The assumptions accompanying this patch are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1141&quot; title=&quot;NPE  at org.apache.openjpa.jdbc.meta.MappingInfo.mergeJoinColumn(MappingInfo.java:1400)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1141&quot;&gt;&lt;del&gt;OPENJPA-1141&lt;/del&gt;&lt;/a&gt;, which consisted of an elaborate reordering of metadata classes at the end of method processBuffer, does not work in all cases, see attached test case. Reason: the reordering is done too late, things may go wrong earlier in the middle of method processBuffer.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There is no need to use complicated structures such as InheritanceOrderedMetaDataList, as the recursive resolution method implemented by processBuffer already ensures that entities that need to be resolved before another entity may be resolved, are put into the buffer after the entity that depends on them. Thus it suffices to just process the meta data instances accumulated in the buffer in a last-in-first-out fashion.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To be honest, I am not 100% sure that the second assumption is always right. There might be convoluted cases of complex entity dependencies where this assumption is no longer valid. However, the current approach based on InheritanceOrderedMetaDataList is much worse and leads to errors quite soon (the attached test case only needs 4 entities to trigger the error). A patched version of OpenJPA runs fine with our application of ~40 entities, quite a few of them depending on other entities (inheritance as well as identities based on foreign keys). With the original OpenJPA, this problem already faced at around 20 entities with no workaround possible.&lt;/p&gt;

&lt;p&gt;If it helps the adoption of this patch, I could assemble more complex mappings to see whether the patch continues to work or not. I am also willing to supply patches for the current trunk version as well as the 1.2-branch, if this is requested.&lt;/p&gt;</comment>
                            <comment id="12901041" author="fancy" created="Sat, 21 Aug 2010 16:52:22 +0100"  >&lt;p&gt;Thanks to Martin, your patch has been committed in r987772 (trunk), and r987773 (2.0.x).&lt;/p&gt;</comment>
                            <comment id="12901565" author="fancy" created="Mon, 23 Aug 2010 20:50:31 +0100"  >&lt;p&gt;Back out changes to 2.0.x branch.&lt;br/&gt;
Updates to maintenance stream 2.0.x must get approval from Michael Dick.&lt;/p&gt;</comment>
                            <comment id="12912537" author="mikedd" created="Mon, 20 Sep 2010 16:40:04 +0100"  >&lt;p&gt;Closing issues which have been resolved for some time. If the problem persists, please reopen. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12428375">OPENJPA-1141</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12450056" name="OpenJPA-2.0.0_OJ1736.patch" size="19487" author="dirichs" created="Wed, 21 Jul 2010 13:13:44 +0100"/>
                            <attachment id="12450050" name="OpenJPA-2.0.0_OJ1736.testcase.patch" size="5380" author="dirichs" created="Wed, 21 Jul 2010 12:00:38 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 21 Aug 2010 15:52:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161983</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt6hr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204232</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>