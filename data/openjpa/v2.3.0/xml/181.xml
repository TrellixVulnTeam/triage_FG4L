<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:39:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-181/OPENJPA-181.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-181] ClassCastException when executing bulk delete on an entity that owns a OneToOne with a Cascade.DELETE when DataCache is on</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-181</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;Given an entity class A which owns a OneToOne entity of class B, and given a cascade on that OneToOne that includes DELETE, an attempt to bulk-delete A when using the DataCache results in a stack trace like the following:&lt;/p&gt;

&lt;p&gt;java.lang.ClassCastException: org.apache.openjpa.datacache.QueryCacheStoreQuery cannot be cast to org.apache.openjpa.kernel.ExpressionStoreQuery&lt;br/&gt;
    at org.apache.openjpa.kernel.ExpressionStoreQuery$DataStoreExecutor.executeQuery(ExpressionStoreQuery.java:674)&lt;br/&gt;
    at org.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:979)&lt;br/&gt;
    at org.apache.openjpa.kernel.QueryImpl.deleteInMemory(QueryImpl.java:1005)&lt;br/&gt;
    ... 28 more&lt;/p&gt;

&lt;p&gt;The proximate cause for the bug is that when the JDBCStoreQuery does this:&lt;/p&gt;

&lt;p&gt;    private Table getTable(FieldMapping fm, Table table) {&lt;br/&gt;
        if (fm.getCascadeDelete() != ValueMetaData.CASCADE_NONE)&lt;br/&gt;
            return INVALID;&lt;/p&gt;

&lt;p&gt;it causes &quot;isSingleTableMapping&quot; to be considered false, which in turn permits executeBulkOperation to return null. Meanwhile, back in DataStoreExecutor:&lt;/p&gt;

&lt;p&gt;       public Number executeDelete(StoreQuery q, Object[] params) &lt;/p&gt;
{
            Number num = ((ExpressionStoreQuery) q).executeDelete(this, _meta,
                _metas, _subs, _facts, _exps, params);
            if (num == null)
                return q.getContext().deleteInMemory(this, params);   // &amp;lt;- now we have come here because executeDelete punted
            return num;
        }

&lt;p&gt;So deleteInMemory gets called in QueryImpl:&lt;/p&gt;

&lt;p&gt;   public Number deleteInMemory(StoreQuery.Executor executor,&lt;br/&gt;
        Object[] params) {&lt;br/&gt;
        try {&lt;br/&gt;
            Object o = execute(executor, params);&lt;/p&gt;

&lt;p&gt;, but a DataStoreExecutor doesn&apos;t know how to execute the QueryCacheStoreQuery that it gets.&lt;/p&gt;

&lt;p&gt;Somehwere, something is too unwrapped, or not wrapped enough. Good luck!&lt;/p&gt;

&lt;p&gt;Workaround:&lt;/p&gt;

&lt;p&gt;If A owns B, then instead of cascade=CascadeType.ALL, you can&lt;/p&gt;

&lt;p&gt;@Entity&lt;br/&gt;
class A {&lt;br/&gt;
    B myThing;&lt;/p&gt;

&lt;p&gt;    @OneToOne(cascade = &lt;/p&gt;
{ CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH }
&lt;p&gt;)&lt;br/&gt;
   B getMyThing() &lt;/p&gt;
{ return myThing; }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;@Entity&lt;br/&gt;
class B {&lt;br/&gt;
    A owner;&lt;/p&gt;

&lt;p&gt;    @ForeignKey(deleteAction=ForeignKeyAction.CASCADE)&lt;br/&gt;
    A getOwner() &lt;/p&gt;
{ return owner; }
&lt;p&gt;}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12365816">OPENJPA-181</key>
            <summary>ClassCastException when executing bulk delete on an entity that owns a OneToOne with a Cascade.DELETE when DataCache is on</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jdf@us.ibm.com">Jonathan Feinberg</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Mar 2007 16:26:49 +0100</created>
                <updated>Tue, 9 Mar 2010 18:32:32 +0000</updated>
                            <resolved>Tue, 27 Mar 2007 20:25:48 +0100</resolved>
                                    <version>0.9.7</version>
                                    <fixVersion>0.9.7</fixVersion>
                                    <component>kernel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12484557" author="awhite" created="Tue, 27 Mar 2007 20:25:48 +0100"  >&lt;p&gt;Fixed in SVN revision 523046.  See test case added to TestBulkJPQLAndDataCache.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 27 Mar 2007 19:25:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160513</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt5rz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204116</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>