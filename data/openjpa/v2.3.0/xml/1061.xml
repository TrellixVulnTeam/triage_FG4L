<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:42:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/OPENJPA-1061/OPENJPA-1061.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[OPENJPA-1061] Entities extending from a Mapped Superclass that defines the ID fields share the same ObjectID type parameter</title>
                <link>https://issues.apache.org/jira/browse/OPENJPA-1061</link>
                <project id="12310351" key="OPENJPA">OpenJPA</project>
                    <description>&lt;p&gt;When a mapped superclass (MSC) defines @Id fields, it appears that entities extending the MSC use the MSC&apos;s type in the generated ObjectID&apos;s type field.  This can result in unexpected primary key collissions between entities that are not intended to be related in an entity inheritance hierarchy.  Attached to the JIRA is a junit test case that demonstrates the problem. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12424625">OPENJPA-1061</key>
            <summary>Entities extending from a Mapped Superclass that defines the ID fields share the same ObjectID type parameter</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikedd">Michael Dick</assignee>
                                    <reporter username="fyrewyld">Jody Grassel</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 May 2009 19:26:31 +0100</created>
                <updated>Tue, 9 Mar 2010 18:31:14 +0000</updated>
                            <resolved>Tue, 30 Jun 2009 04:12:19 +0100</resolved>
                                    <version>1.2.0</version>
                    <version>1.2.1</version>
                                    <fixVersion>1.0.4</fixVersion>
                    <fixVersion>1.2.2</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0-M3</fixVersion>
                                    <component>jpa</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12706136" author="fyrewyld" created="Tue, 5 May 2009 19:27:14 +0100"  >&lt;p&gt;Unit test that demonstrates the problem.&lt;/p&gt;</comment>
                            <comment id="12706137" author="fyrewyld" created="Tue, 5 May 2009 19:28:26 +0100"  >&lt;p&gt;What seems to be happening is that during entity enhancement, the MSC type acquires an ObjectIDType.  When the enhancer reaches the entity types extending the MSC, the if-block:&lt;/p&gt;

&lt;p&gt;if (_meta.getIdentityType() == ClassMetaData.ID_APPLICATION&lt;br/&gt;
            &amp;amp;&amp;amp; (_meta.getPCSuperclass() == null || getCreateSubclass() ||&lt;br/&gt;
                _meta.getObjectIdType() !=&lt;br/&gt;
                    _meta.getPCSuperclassMetaData().getObjectIdType())) {&lt;/p&gt;

&lt;p&gt;compares the entity type&apos;s ObjectIDType with its MSC, finds they are equivalent, so the entity enhancement does not add the app-id methods; the leaf entity types defer to the MSC&apos;s app-id methods.  So when a new entity is being inserted into the persistence context, its initial ObjectID has the MSC in its type field, instead of the leaf entity type.  If another entity extending from the same MSC has the same PK-value, OpenJPAId&apos;s implentation of equals() will think it is equivalent, failing the checkForDuplicateId() check.&lt;/p&gt;

&lt;p&gt;I&apos;ve included a potential fix for the above issue.  It adds an additional check, looking for PKFields that are defined by a MSC.  If it finds such PKFields, it walks up the inheritance tree, stopping at either the MSC defining the PKField, or at an entity type (to avoid breaking entity inheritance mechanisms).  Stopping at the MSC defining the PKField qualifies the entity type for app-id method inclusion during enhancement.  This way, the leaf entities use their own pcNewObjectIdInstance() methods (with the appropriate type coded into the method) instead of relying on the mapped superclass&apos;s version of the method.&lt;/p&gt;

&lt;p&gt;However, there is a degree of uncertainty I have with the fix.  While it fixes the described problem, and it does not fail any of the existing JUnit tests, I rely on the ClassMetaData.isEmbeddedOnly() method to determine if a type is a MSC or a genuine entity.  From what I could tell, the ClassMetaData.setEmbeddedOnly() method is called only during annotation and ORL XML metadata processing (it is set explicitly false for MappedSuperClass types).  However, the methods ClassMetaData.isEmbeddedOnly() and ClassMetaData.resolveMeta() are capable of mutating the ClassMetaData._embedded field; so there needs to be verification that relying on the _embedded field is the correct method of identifying a MSC type for this processing.&lt;/p&gt;</comment>
                            <comment id="12706138" author="fyrewyld" created="Tue, 5 May 2009 19:29:19 +0100"  >&lt;p&gt;Proposed fix, pending verification that _embedded is a suitable check for MSC.&lt;/p&gt;</comment>
                            <comment id="12706264" author="ppoddar@apache.org" created="Wed, 6 May 2009 01:13:37 +0100"  >&lt;p&gt;I have added a new method ClassMetaData.isAbstract() which affirms (in JPA context) for MappedSuperclass. This method may help to identify whether a type is MSC. &lt;/p&gt;</comment>
                            <comment id="12706488" author="faywang" created="Wed, 6 May 2009 17:21:50 +0100"  >&lt;p&gt;hi Jody, the patch looks fine to me. ClassMetaData.resolveMeta can potentially modify _embedded field on the condition that the class meta data being resolved is actually &quot;embedded&quot; inside some other entity/embeddable. In other words, it has &quot;owner&quot;. In the MSC case, one can not at the same time inherit from MSC and also embed an MSC when this MSC declares an Id field. As to the method isEmbeddableOnly, the _embedded field will not be set again in this method if it is already set. As you pointed out, in the case of MSC, this field is already set during the annotation/xml parsing time.&lt;/p&gt;</comment>
                            <comment id="12706515" author="fyrewyld" created="Wed, 6 May 2009 18:01:18 +0100"  >&lt;p&gt;Thanks for the advise.   I migrated the ClassMetaData.isAbstract()/setAbstract() methods from trunk to the 1.2.x release, and modified my patch to use those methods instead of isEmbeddable(); I&apos;m much more content with that approach as it removes any chance that the added logic to addPCMethods() will trigger on anything else other then a MappedSuperclass.&lt;/p&gt;

&lt;p&gt;I also found it curious to hear that the unit tests pass with the trunk build &amp;#8211; perhaps there has been a change in processing given all the additional embeddable support provided by JPA 2.0.  It would still be good to bring the unit tests to trunk, extra testing never hurts. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a new patch which migrates and utilizes the ClassMetaData.&lt;span class=&quot;error&quot;&gt;&amp;#91;is|set&amp;#93;&lt;/span&gt;Abstract() methods to this JIRA.&lt;/p&gt;</comment>
                            <comment id="12712188" author="fyrewyld" created="Fri, 22 May 2009 19:03:23 +0100"  >&lt;p&gt;Updated patch.  The previous patch failed when the MappedSuperclass had the id fields set to private-access.&lt;/p&gt;</comment>
                            <comment id="12716715" author="fyrewyld" created="Fri, 5 Jun 2009 19:34:01 +0100"  >&lt;p&gt;Updated product code changes to resolve mapped superclass object id creation issue, and supporting JUnit test cases.&lt;/p&gt;</comment>
                            <comment id="12722817" author="fyrewyld" created="Mon, 22 Jun 2009 21:56:02 +0100"  >&lt;p&gt;Combined fix and junit together.&lt;/p&gt;</comment>
                            <comment id="12724241" author="fyrewyld" created="Thu, 25 Jun 2009 21:00:35 +0100"  >&lt;p&gt;Formatting cleanup.&lt;/p&gt;</comment>
                            <comment id="12725451" author="mikedd" created="Tue, 30 Jun 2009 04:12:19 +0100"  >&lt;p&gt;Thanks for the patch Jody&lt;/p&gt;</comment>
                            <comment id="12726661" author="fyrewyld" created="Thu, 2 Jul 2009 21:20:04 +0100"  >&lt;p&gt;Shortened the package names and tuned the entity class names used by the test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/OPENJPA-1061&quot; title=&quot;Entities extending from a Mapped Superclass that defines the ID fields share the same ObjectID type parameter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OPENJPA-1061&quot;&gt;&lt;del&gt;OPENJPA-1061&lt;/del&gt;&lt;/a&gt;.  This patch is intended for trunk.  A patch for 1.2.x is coming shortly.&lt;/p&gt;</comment>
                            <comment id="12726701" author="fyrewyld" created="Thu, 2 Jul 2009 22:55:34 +0100"  >&lt;p&gt;Refactored packaging for the tests for the 1.2.x branch.&lt;/p&gt;</comment>
                            <comment id="12728919" author="fyrewyld" created="Wed, 8 Jul 2009 22:49:18 +0100"  >&lt;p&gt;Another pass at refactoring the package and class names.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12429404">OPENJPA-1156</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12411854" name="OpenJPA-1061_1.2.x.patch" size="217339" author="fyrewyld" created="Thu, 25 Jun 2009 21:00:35 +0100"/>
                            <attachment id="12412425" name="OpenJPA-JIRA1061-packagerefactor-1.2.x.patch" size="294429" author="fyrewyld" created="Thu, 2 Jul 2009 22:55:34 +0100"/>
                            <attachment id="12412418" name="OpenJPA-JIRA1061-packagerefactor-trunk.patch" size="296117" author="fyrewyld" created="Thu, 2 Jul 2009 21:20:04 +0100"/>
                            <attachment id="12412919" name="OpenJPA-JIRA1061_1166-packagerefactor-1.2.x.patch" size="353291" author="fyrewyld" created="Wed, 8 Jul 2009 22:49:18 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 May 2009 00:13:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38570</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyt45j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>203853</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>