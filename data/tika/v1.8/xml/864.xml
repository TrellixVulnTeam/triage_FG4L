<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:32:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/TIKA-864/TIKA-864.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[TIKA-864] Metadata.formatDate causes blocking in concurrent use</title>
                <link>https://issues.apache.org/jira/browse/TIKA-864</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;Currently this is a synchronized method that uses a single instance of DateFormat. Instead it could use a pool of ThreadLocal DateFormat instances and avoid the sync blocking.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12542976">TIKA-864</key>
            <summary>Metadata.formatDate causes blocking in concurrent use</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jukkaz">Jukka Zitting</assignee>
                                    <reporter username="ab">Andrzej Bialecki </reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Feb 2012 01:12:30 +0000</created>
                <updated>Sat, 18 Feb 2012 00:31:10 +0000</updated>
                            <resolved>Fri, 17 Feb 2012 15:10:44 +0000</resolved>
                                                    <fixVersion>1.1</fixVersion>
                                    <component>metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13210207" author="gagravarr" created="Fri, 17 Feb 2012 12:14:22 +0000"  >&lt;p&gt;If we did store them on a ThreadLocal, then how would we allow them to be cleaned up?&lt;/p&gt;

&lt;p&gt;For an example, Tomcat will give you warnings if you leave behind Thread Locals, so we&apos;d need to give a way to clean them up that someone using Tika inside a webapp could use.&lt;/p&gt;</comment>
                            <comment id="13210238" author="ab" created="Fri, 17 Feb 2012 13:00:41 +0000"  >&lt;p&gt;Good point. Maybe Tika should use Joda-Time instead of the built-in DateFormat and Calendar classes - not only it&apos;s much faster but also provides thread-safe classes for date parsing and formatting (&lt;a href=&quot;http://joda-time.sourceforge.net/api-release/org/joda/time/format/DateTimeFormat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://joda-time.sourceforge.net/api-release/org/joda/time/format/DateTimeFormat.html&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13210240" author="jukkaz" created="Fri, 17 Feb 2012 13:03:04 +0000"  >&lt;p&gt;Like in &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-865&quot; title=&quot;MimeTypes.forName should avoid method-level synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-865&quot;&gt;&lt;del&gt;TIKA-865&lt;/del&gt;&lt;/a&gt;, is this a real measurable performance bottleneck? If not, I suggest we keep the code as is.&lt;/p&gt;</comment>
                            <comment id="13210247" author="ab" created="Fri, 17 Feb 2012 13:18:01 +0000"  >&lt;p&gt;I noticed this issue when profiling a larger application that uses a configurable pool of threads (hundreds) to process the Enron data-set (the version in plain text RFC822 format, available here &lt;a href=&quot;http://www.cs.cmu.edu/~enron/enron_mail_20110402.tgz&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.cs.cmu.edu/~enron/enron_mail_20110402.tgz&lt;/a&gt;). I didn&apos;t measure in numbers the impact of this particular method call on the whole process, but I saw that threads were very often blocked on a few sync blocks, among others on this one and the one in &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-865&quot; title=&quot;MimeTypes.forName should avoid method-level synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-865&quot;&gt;&lt;del&gt;TIKA-865&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13210301" author="jukkaz" created="Fri, 17 Feb 2012 14:51:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;threads were very often blocked on a few sync blocks, among others on this one and the one in &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-865&quot; title=&quot;MimeTypes.forName should avoid method-level synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-865&quot;&gt;&lt;del&gt;TIKA-865&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Reason enough for me, thanks for the background.&lt;/p&gt;

&lt;p&gt;I updated the issue summary to identify the problem to be solved instead of a proposed solution. Using ThreadLocals is troublesome as already mentioned by Nick.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Joda-Time&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not too excited about adding extra dependencies to tika-core. In &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-495&quot; title=&quot;Metadata constructor is slow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-495&quot;&gt;&lt;del&gt;TIKA-495&lt;/del&gt;&lt;/a&gt; (which led to the use of a synchronized static variable) the FastDateFormat class from Commons Lang was considered as an alternative, but also there the overhead of an extra dependency (or embedding just that class) was a problem.&lt;/p&gt;

&lt;p&gt;The formatDate() contract is pretty straightforward, so perhaps the best solution here is&lt;br/&gt;
just to add a bit of custom code that formats the requested string directly from the given&lt;br/&gt;
date object without needing extra formatter classes.&lt;/p&gt;</comment>
                            <comment id="13210313" author="jukkaz" created="Fri, 17 Feb 2012 15:10:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;perhaps the best solution here is just to add a bit of custom code that formats the requested string directly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done in revision 1245600.&lt;/p&gt;</comment>
                            <comment id="13210694" author="ab" created="Sat, 18 Feb 2012 00:31:10 +0000"  >&lt;p&gt;Thanks Jukka, this solved the issue nicely - however, I just noticed that the javadoc for that method is now incorrect, because it claims the method is synchronized and points to &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-495&quot; title=&quot;Metadata constructor is slow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-495&quot;&gt;&lt;del&gt;TIKA-495&lt;/del&gt;&lt;/a&gt;. This comment should be removed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 17 Feb 2012 12:14:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>228262</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxx15z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16508</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>