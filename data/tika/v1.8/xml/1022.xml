<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:38:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/TIKA-1022/TIKA-1022.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[TIKA-1022] DWG Custom properties not extracted</title>
                <link>https://issues.apache.org/jira/browse/TIKA-1022</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;Based on some code I provided some time ago (Alfresco forum), Derek Hulley opened ALF-2262, Nick Burch opened &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-413&quot; title=&quot;DWG Parser&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-413&quot;&gt;&lt;del&gt;TIKA-413&lt;/del&gt;&lt;/a&gt; issue and code has been committed to TIKA (0.8).&lt;/p&gt;

&lt;p&gt;With sample dwg provided TIKA (0.8 to 1.2) is correctly working but with attached file returns no custom metadata (my original &quot;C&quot; returns correct custom metadata, dwg is &quot;2010&quot; format).&lt;/p&gt;

&lt;p&gt;Tested tika-app.1.0.jar and tika-app.1.2.jar and tika 1.3 snapshot.&lt;br/&gt;
All versions could be impacted by this bug. &lt;/p&gt;

&lt;p&gt;I found failing code in skipToCustomProperties() of DWGParser.java, lines 320-321: &lt;br/&gt;
if(padding&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp;&lt;br/&gt;
  padding&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; == 0) {&lt;/p&gt;

&lt;p&gt;padding&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; byte is not always 0 (attached file has 0x2) and probably there is no need to check those bytes.&lt;/p&gt;

&lt;p&gt;Index: DWGParser.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; DWGParser.java	(revisione 1407024)&lt;br/&gt;
+++ DWGParser.java	(copia locale)&lt;br/&gt;
@@ -93,7 +93,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;How far to skip after the last standard property, before&lt;/li&gt;
	&lt;li&gt;we find any custom properties that might be there.&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final int CUSTOM_PROPERTIES_SKIP = 20;&lt;br/&gt;
+    private static final int CUSTOM_PROPERTIES_SKIP = 24; &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public void parse(&lt;br/&gt;
             InputStream stream, ContentHandler handler,&lt;br/&gt;
@@ -317,13 +317,7 @@&lt;/p&gt;

&lt;p&gt;     private int skipToCustomProperties(InputStream stream) &lt;br/&gt;
             throws IOException, TikaException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// There should be 4 zero bytes next&lt;/li&gt;
	&lt;li&gt;byte[] padding = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;;&lt;/li&gt;
	&lt;li&gt;IOUtils.readFully(stream, padding);&lt;/li&gt;
	&lt;li&gt;if(padding&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp;&lt;/li&gt;
	&lt;li&gt;padding&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; == 0) 
{
-          // Looks hopeful, skip on
-          padding = new byte[CUSTOM_PROPERTIES_SKIP];
+          byte[] padding = new byte[CUSTOM_PROPERTIES_SKIP];
           IOUtils.readFully(stream, padding);
           
           // We should now have the count
@@ -337,10 +331,6 @@
              // No properties / count is too high to trust
              return 0;
           }&lt;/li&gt;
	&lt;li&gt;} else 
{
-          // No padding. That probably means no custom props
-          return 0;
-       }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12615530">TIKA-1022</key>
            <summary>DWG Custom properties not extracted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="rgauss">Ray Gauss II</assignee>
                                    <reporter username="pnacci">Paolo Nacci</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Fri, 9 Nov 2012 18:06:12 +0000</created>
                <updated>Wed, 8 Apr 2015 22:32:00 +0100</updated>
                                            <version>1.0</version>
                    <version>1.1</version>
                    <version>1.2</version>
                    <version>1.3</version>
                                    <fixVersion>1.3</fixVersion>
                                    <component>metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13494174" author="pnacci" created="Fri, 9 Nov 2012 18:07:21 +0000"  >&lt;p&gt;No custom properties extracted from this file (version 2010)&lt;/p&gt;</comment>
                            <comment id="13494358" author="rgauss" created="Fri, 9 Nov 2012 22:14:06 +0000"  >&lt;p&gt;Thanks Paolo.&lt;/p&gt;

&lt;p&gt;I don&apos;t know a lot about these formats but I have a slightly different fix prepared which includes a unit test and your test file.&lt;/p&gt;

&lt;p&gt;As far as I can see from what Tika extracts, the file contains most of the phrases expected by DWGParserTest (with the exception of the addition of &quot;very lazy&quot;) but can you confirm that there&apos;s no additional sensitive information contained in that file that should prevent it from being part of Tika&apos;s source?&lt;/p&gt;</comment>
                            <comment id="13494371" author="pnacci" created="Fri, 9 Nov 2012 22:29:19 +0000"  >&lt;p&gt;I&apos;m sorry but that file cannot be distributed as is. I&apos;m going to clean up sensitive data then I&apos;ll attach here.&lt;/p&gt;</comment>
                            <comment id="13494384" author="pnacci" created="Fri, 9 Nov 2012 22:44:56 +0000"  >&lt;p&gt;Test file, can be freely distributed.&lt;/p&gt;</comment>
                            <comment id="13494391" author="rgauss" created="Fri, 9 Nov 2012 22:50:25 +0000"  >&lt;p&gt;Thanks for the new file, much smaller too!&lt;/p&gt;

&lt;p&gt;I&apos;ll commit shortly.&lt;/p&gt;</comment>
                            <comment id="13494403" author="rgauss" created="Fri, 9 Nov 2012 23:04:43 +0000"  >&lt;p&gt;Resolved in r1407683.&lt;/p&gt;</comment>
                            <comment id="14486030" author="pnacci" created="Wed, 8 Apr 2015 22:02:15 +0100"  >&lt;p&gt;DWG files saved from autocad 2015 have CUSTOM_PROPERTIES_ALT_PADDING_VALUES&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; = 0x5 (even if you save it as 2010 or 2013 version).&lt;br/&gt;
I think that it&apos;s safe to change DWGParser.java to check first &quot;padding&quot; to be &amp;lt;=5 and other padding bytes = 0 and skip CUSTOM_PROPERTIES_ALT_PADDING_VALUES check.&lt;br/&gt;
I added AC1027 (autocad 2013, 2014, 2015) too.&lt;/p&gt;

&lt;p&gt;Proposed patch for DWGParser.java:&lt;br/&gt;
96,103c96,98&lt;br/&gt;
&amp;lt;     private static final int CUSTOM_PROPERTIES_SKIP = 20;&lt;br/&gt;
&amp;lt;     &lt;br/&gt;
&amp;lt;     /** &lt;br/&gt;
&amp;lt;      * The value of padding bytes other than 0 in some DWG files.&lt;br/&gt;
&amp;lt;      */&lt;br/&gt;
&amp;lt;     private static final int[] CUSTOM_PROPERTIES_ALT_PADDING_VALUES = new int[] &lt;/p&gt;
{0x2, 0, 0, 0}
&lt;p&gt;;&lt;br/&gt;
&amp;lt; &lt;br/&gt;
&amp;lt;     public void parse(&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;     private static final int CUSTOM_PROPERTIES_SKIP = 20; &lt;br/&gt;
&amp;gt;       &lt;br/&gt;
&amp;gt; 	public void parse(&lt;br/&gt;
125c120&lt;br/&gt;
&amp;lt;         } else if (version.equals(&quot;AC1021&quot;) || version.equals(&quot;AC1024&quot;)) &lt;/p&gt;
{
---
&amp;gt;         }
&lt;p&gt; else if (version.equals(&quot;AC1021&quot;) || version.equals(&quot;AC1024&quot;)|| version.equals(&quot;AC1027&quot;)) {&lt;br/&gt;
325c320&lt;br/&gt;
&amp;lt;        // There should be 4 zero bytes or CUSTOM_PROPERTIES_ALT_PADDING_VALUES next&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;        // There should be 4 zero bytes next&lt;br/&gt;
328,335c323,326&lt;br/&gt;
&amp;lt;        if((padding&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp;&lt;br/&gt;
&amp;lt;              padding&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; == 0) ||&lt;br/&gt;
&amp;lt;              (padding&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; == CUSTOM_PROPERTIES_ALT_PADDING_VALUES&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &amp;amp;&amp;amp; &lt;br/&gt;
&amp;lt;                padding&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; == CUSTOM_PROPERTIES_ALT_PADDING_VALUES&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &amp;amp;&amp;amp;&lt;br/&gt;
&amp;lt;                padding&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; == CUSTOM_PROPERTIES_ALT_PADDING_VALUES&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &amp;amp;&amp;amp;&lt;br/&gt;
&amp;lt;                padding&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; == CUSTOM_PROPERTIES_ALT_PADDING_VALUES&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;)) {&lt;br/&gt;
&amp;lt;            &lt;br/&gt;
&amp;lt;           // Looks hopeful, skip on&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;        if(padding&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &amp;lt;= 5 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp;&lt;br/&gt;
&amp;gt;              padding&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; == 0 &amp;amp;&amp;amp; padding&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; == 0) {&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; 			   // Looks hopeful, skip on&lt;/p&gt;

&lt;p&gt;I attached testDWG2015_custom_props.dwg for test unit.&lt;/p&gt;</comment>
                            <comment id="14486103" author="gagravarr" created="Wed, 8 Apr 2015 22:32:00 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnacci&quot; class=&quot;user-hover&quot; rel=&quot;pnacci&quot;&gt;Paolo Nacci&lt;/a&gt; Any chance you could post (as text or screenshot) what Autocad shows as the metadata for the file you&apos;ve provided? We can then use that as the basis for a unit test for your fix, which will help ensure that no regressions get introduced in future&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12552911" name="quick2010-tika-no-custom.dwg" size="73791" author="pnacci" created="Fri, 9 Nov 2012 22:44:56 +0000"/>
                            <attachment id="12724018" name="testDWG2015_custom_props.dwg" size="36315" author="pnacci" created="Wed, 8 Apr 2015 22:03:07 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 9 Nov 2012 22:14:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256818</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hycnqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>107822</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>