<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:33:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/TIKA-1548/TIKA-1548.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[TIKA-1548] System property added while catching exception on parsing PDF encrypted doc</title>
                <link>https://issues.apache.org/jira/browse/TIKA-1548</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;I&apos;m using Tika 1.7. I&apos;m parsing an encrypted PDF document which raise an exception. So far, so good.&lt;/p&gt;

&lt;p&gt;My concern is that after that I have a new System property set &lt;tt&gt;sun.font.CFontManager&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;Code to reproduce the error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testSystem() {
    Properties props = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperties();
    assertThat(props.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;sun.font.fontmanager&quot;&lt;/span&gt;), nullValue());
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        tika().parseToString(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(&lt;span class=&quot;code-quote&quot;&gt;&quot;https:&lt;span class=&quot;code-comment&quot;&gt;//github.com/elasticsearch/elasticsearch-mapper-attachments/raw/master/src/test/resources/org/elasticsearch/index/mapper/xcontent/encrypted.pdf&quot;&lt;/span&gt;));
&lt;/span&gt;    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
    }
    assertThat(props.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;sun.font.fontmanager&quot;&lt;/span&gt;), nullValue());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;With Tika 1.7:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2015-02-11 16:43:36,166][INFO ][org.apache.pdfbox.pdfparser.PDFParser] Document is encrypted
[2015-02-11 16:43:36,837][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,837][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,838][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,838][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,839][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,840][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,840][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,841][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,841][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException
[2015-02-11 16:43:36,842][ERROR][org.apache.pdfbox.filter.FlateFilter] FlateFilter: stop reading corrupt stream due to a DataFormatException

java.lang.AssertionError: 
Expected: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
     but: was &lt;span class=&quot;code-quote&quot;&gt;&quot;sun.font.CFontManager&quot;&lt;/span&gt;
 &amp;lt;Click to see difference&amp;gt;
	at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)
	at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:8)
	at org.elasticsearch.plugin.mapper.attachments.test.TikaSystemTest.testSystem(TikaSystemTest.java:41)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:68)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:47)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:300)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:157)
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:74)
	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:211)
	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:67)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:134)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;With Tika 1.6:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2015-02-11 16:38:42,922][INFO ][org.apache.pdfbox.pdfparser.PDFParser] Document is encrypted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note also that it logs a lot of errors which was not the case in Tika 1.6.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Mac OS 10.10.2&lt;br/&gt;
java version &quot;1.7.0_60&quot;&lt;/p&gt;</environment>
        <key id="12774240">TIKA-1548</key>
            <summary>System property added while catching exception on parsing PDF encrypted doc</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dadoonet">David Pilato</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Feb 2015 15:47:01 +0000</created>
                <updated>Mon, 16 Feb 2015 08:36:53 +0000</updated>
                            <resolved>Fri, 13 Feb 2015 01:20:14 +0000</resolved>
                                    <version>1.7</version>
                                    <fixVersion>1.8</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="14316458" author="tallison@mitre.org" created="Wed, 11 Feb 2015 16:24:06 +0000"  >&lt;p&gt;Thank you for raising this. I&apos;ll look into it. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;Tilman Hausherr&lt;/a&gt;, any ideas?&lt;/p&gt;</comment>
                            <comment id="14316723" author="tilman" created="Wed, 11 Feb 2015 18:31:23 +0000"  >&lt;p&gt;Sorry, no. We&apos;re not setting that one. It isn&apos;t in our code.&lt;/p&gt;</comment>
                            <comment id="14316787" author="tpalsulich" created="Wed, 11 Feb 2015 19:10:02 +0000"  >&lt;p&gt;I&apos;m not seeing any mentions in Tika, either (&lt;tt&gt;grep -R &quot;CFontManager&quot; .&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="14318748" author="tallison@mitre.org" created="Thu, 12 Feb 2015 18:50:38 +0000"  >&lt;p&gt;I&apos;ll fix our PDFParser to stop any processing if decryption is unsuccessful.  This will prevent the logging errors among other things.&lt;/p&gt;

&lt;p&gt;I was able to replicate the issue with pure PDFBox 1.8.8 on rhel, but not with PDFBox-1.8-branch.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError:
Expected: null
     got: &quot;sun.awt.X11FontManager&quot;

        at org.junit.Assert.assertThat(Assert.java:778)
        at org.junit.Assert.assertThat(Assert.java:736)
        at org.apache.pdfbox.TestPropSet.testSystem(TestPropSet.java:29)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;with this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    @Test
    public void testSystem() throws Exception  {
        Properties props = System.getProperties();
        assertThat(props.get(&quot;sun.font.fontmanager&quot;), nullValue());
        String password = &quot;&quot;;
        try {
            File pdfFile = new File(&quot;encrypted.pdf&quot;);
            String txt = extractText(pdfFile, password);

        } catch (Throwable e) {
        }
        assertThat(props.get(&quot;sun.font.fontmanager&quot;), nullValue());
    }

    private String extractText(File pdfFile, String password) throws Exception {
        PDDocument document =
                PDDocument.load(pdfFile);
        PDFTextStripper stripper = null;
            stripper = new PDFTextStripper(&quot;UTF-8&quot;);
        StringWriter writer = new StringWriter();
        stripper.writeText(document, writer);
        return writer.toString();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14318769" author="tallison@mitre.org" created="Thu, 12 Feb 2015 19:02:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dadoonet&quot; class=&quot;user-hover&quot; rel=&quot;dadoonet&quot;&gt;David Pilato&lt;/a&gt;, is your file shareable under ASF 2.0?  Mind if we add it to our unit tests?&lt;/p&gt;</comment>
                            <comment id="14319372" author="tallison@mitre.org" created="Fri, 13 Feb 2015 01:20:14 +0000"  >&lt;p&gt;Fixed handling of bad passwords for encrypted pdfs.  The PDFParser now throws an &lt;tt&gt;EncryptedDocumentException&lt;/tt&gt; like Tika&apos;s other parsers do for both the classic and the non-sequential parser.&lt;/p&gt;

&lt;p&gt;r1659446.&lt;/p&gt;

&lt;p&gt;I used our current protected pdf for the new unit tests.&lt;/p&gt;

&lt;p&gt;However, I confirmed that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dadoonet&quot; class=&quot;user-hover&quot; rel=&quot;dadoonet&quot;&gt;David Pilato&lt;/a&gt;&apos;s &lt;tt&gt;testSystem()&lt;/tt&gt; unit test failed (in RHEL) in the previous version of our &lt;tt&gt;PDFParser&lt;/tt&gt; but now passes with the fixes.&lt;/p&gt;

&lt;p&gt;Thank you for reporting this and submitting a unit test with file!&lt;/p&gt;</comment>
                            <comment id="14319456" author="hudson" created="Fri, 13 Feb 2015 02:17:03 +0000"  >&lt;p&gt;SUCCESS: Integrated in tika-trunk-jdk1.7 #487 (See &lt;a href=&quot;https://builds.apache.org/job/tika-trunk-jdk1.7/487/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/tika-trunk-jdk1.7/487/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-1548&quot; title=&quot;System property added while catching exception on parsing PDF encrypted doc&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-1548&quot;&gt;&lt;del&gt;TIKA-1548&lt;/del&gt;&lt;/a&gt; improve handling of encrypted pdfs when wrong password is offered (tallison: &lt;a href=&quot;http://svn.apache.org/viewvc/tika/trunk/?view=rev&amp;amp;rev=1659446&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/tika/trunk/?view=rev&amp;amp;rev=1659446&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/tika/trunk/tika-parsers/src/main/java/org/apache/tika/parser/pdf/PDFParser.java&lt;/li&gt;
	&lt;li&gt;/tika/trunk/tika-parsers/src/test/java/org/apache/tika/parser/pdf/PDFParserTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14322524" author="dadoonet" created="Mon, 16 Feb 2015 08:36:53 +0000"  >&lt;p&gt;Thanks for fixing this. To answer to your question (but late), yes our code is also under Apache2 license so you can reuse it I guess.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 11 Feb 2015 16:24:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzzddr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>