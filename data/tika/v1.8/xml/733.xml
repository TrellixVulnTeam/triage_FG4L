<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:38:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/TIKA-733/TIKA-733.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[TIKA-733] [PATCH] RTF TextExtractor processGroupEnd() NoSuchElementException</title>
                <link>https://issues.apache.org/jira/browse/TIKA-733</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;Parsing some RTF documents attempt to perform a removeLast() on the groupStates() list when the list is empty.  Added a check to not perform the logic when the list is empty, thus causing the restore group state to not be performed. Text extraction now completes without further down-stream errors.&lt;/p&gt;

&lt;p&gt;Unable to include sample file due to sensitive nature of file contents.&lt;/p&gt;

&lt;p&gt;StackTrace (TIKA-0.9)&lt;/p&gt;

&lt;p&gt;Caused by: java.util.NoSuchElementException&lt;br/&gt;
	at java.util.LinkedList.remove(LinkedList.java:788)&lt;br/&gt;
	at java.util.LinkedList.removeLast(LinkedList.java:144)&lt;br/&gt;
	at org.apache.tika.parser.rtf.TextExtractor.processGroupEnd(TextExtractor.java:1010)&lt;br/&gt;
	at org.apache.tika.parser.rtf.TextExtractor.extract(TextExtractor.java:352)&lt;br/&gt;
	at org.apache.tika.parser.rtf.RTFParser.parse(RTFParser.java:53)&lt;br/&gt;
	at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:242)&lt;br/&gt;
	... 45 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12525004">TIKA-733</key>
            <summary>[PATCH] RTF TextExtractor processGroupEnd() NoSuchElementException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikemccand">Michael McCandless</assignee>
                                    <reporter username="rpialum">Jeremy Anderson</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Wed, 28 Sep 2011 03:11:10 +0100</created>
                <updated>Tue, 4 Oct 2011 11:47:10 +0100</updated>
                            <resolved>Mon, 3 Oct 2011 19:20:22 +0100</resolved>
                                    <version>1.0</version>
                                    <fixVersion>1.0</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13116071" author="rpialum" created="Wed, 28 Sep 2011 03:12:43 +0100"  >&lt;p&gt;Patch file&lt;/p&gt;</comment>
                            <comment id="13116331" author="mikemccand" created="Wed, 28 Sep 2011 11:39:47 +0100"  >&lt;p&gt;Hmm, it makes me a little nervous just blindly not popping the group&lt;br/&gt;
state once it&apos;s empty since this could be masking a more serious bug.&lt;/p&gt;

&lt;p&gt;Ie, it&apos;s possible we are not correctly tokenizing the open / close&lt;br/&gt;
group tokens.&lt;/p&gt;

&lt;p&gt;The other explanation is that the RTF doc is corrupt (has too many&lt;br/&gt;
closing } vs open {).&lt;/p&gt;

&lt;p&gt;Can you look at the doc and figure out if its corrupt?&lt;/p&gt;

&lt;p&gt;Does this RTF document work with older versions of Tika (before&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-683&quot; title=&quot;RTF Parser issues with non european characters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-683&quot;&gt;&lt;del&gt;TIKA-683&lt;/del&gt;&lt;/a&gt; was committed)?&lt;/p&gt;</comment>
                            <comment id="13119441" author="rpialum" created="Mon, 3 Oct 2011 19:00:08 +0100"  >&lt;p&gt;(Sorry, I can&apos;t seem to get the post to maintain my newline characters &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;

&lt;p&gt;The problem is also present in the older 0.9 release.&lt;/p&gt;


&lt;p&gt;Looking at the document as you suggested, the document is corrupt/malformed in the sense that it contains more closing brackets &apos;}&apos; than opening brackets &apos;&lt;/p&gt;
{&apos;.


However with that said, the text contained with in the document appears to still be extractable for this document using the patch I submitted that ignores the group state once empty.


My knowledge on RTF formats is rather limited, but is there perhaps a better compromise that will allow the parser to return the text it is able to get and maybe log a warning condition when a malformed RTF is encountered?



I have about 20 or so files that have encountered this failure in my load set.  I haven&apos;t had the time to investigate all of them yet to see if they all fail for the same mis-matched problem, and when corrupt, determine how much of the extractable text is impacted by the fix I submitted.



To be noted, both Word pad and MS word are able to open these files without issue... though thats to be expected.  I expect that they may also just ignore the final block in these cases.  Actually after opening the failed document and resaving it in WordPad, the final partial block does indeed just get truncated from the file.



Looking closer at the file in a text editor, the culprit final extra block appears to be a partial replication of the final valid ending block in the file.  Perhaps an appropriate fix for being able to auto-handle these partial corrupted RTF&apos;s is to:


* detect if they have more ending blocks than starting, and when it does


* check to see if the final one is a partial replication of the prior one


* and if so, just ignore the final one.



Last lines of the corrupted file:
\pard\li360____VALID RTF FILE TEXT _____\line\par
\pard\par
\pard\fi-1800\li1800\tx1800\cf1\f0\fs20\par
\pard\cf0\b\f3\par
\pard\fi-1800\li1800\tx1800\cf1\b0\f0\par
\pard\cf0\b\f3\par
\par
\pard\fi-1800\li1800\tx1800\cf1\b0\f0\par
\pard\cf0\b\f3\par
\pard\fi-1800\li1800\tx1800\cf1\b0\f0\par
\pard\cf0\b\f3\par
\par
\pard\fi-1800\li1800\tx1800\cf1\b0\f0\par
\pard\cf0\b\f3\par
\pard\fi-1800\li1800\tx1800\cf1\b0\f0\par
\pard\cf0\b\f3\par
\par
\pard\fi-1800\li1800\tx1800\cf1\b0\f0\par
}
&lt;p&gt; 0\li1800\tx1800\cf2\f2\fs20\par&lt;br/&gt;
\pard\cf0\b\f3\par&lt;br/&gt;
\pard\fi-1800\li1800\tx1800\cf2\b0\f2\par&lt;br/&gt;
\pard\cf0\b\f3\par&lt;br/&gt;
\par&lt;br/&gt;
\pard\fi-1800\li1800\tx1800\cf2\b0\f2\par&lt;br/&gt;
\pard\cf0\b\f3\par&lt;br/&gt;
\pard\fi-1800\li1800\tx1800\cf2\b0\f2\par&lt;br/&gt;
\pard\cf0\b\f3\par&lt;br/&gt;
\par&lt;br/&gt;
\pard\fi-1800\li1800\tx1800\cf2\b0\f2\par&lt;br/&gt;
\pard\cf0\b\f3\par&lt;br/&gt;
\pard\fi-1800\li1800\tx1800\cf2\b0\f2\par&lt;br/&gt;
\pard\cf0\b\f3\par&lt;br/&gt;
\par&lt;br/&gt;
}&lt;/p&gt;
</comment>
                            <comment id="13119462" author="mikemccand" created="Mon, 3 Oct 2011 19:17:57 +0100"  >&lt;p&gt;Actually, I think we should just commit your patch: it&apos;s harmless for non-corrupt RTF docs, and for corrupt ones (with this particular corruption) it will make a best effort to extract what text it can.&lt;/p&gt;

&lt;p&gt;I only wanted to confirm that you were hitting this because of document corruption and not a bug in how the new RTF parser tokenizes open/close groups.  Thanks!&lt;/p&gt;</comment>
                            <comment id="13119467" author="mikemccand" created="Mon, 3 Oct 2011 19:20:22 +0100"  >&lt;p&gt;Thanks Jeremy!&lt;/p&gt;</comment>
                            <comment id="13119815" author="rpialum" created="Tue, 4 Oct 2011 01:51:35 +0100"  >&lt;p&gt;Cool beans!! &lt;/p&gt;

&lt;p&gt;Thanks for your attention to it.  Yeah, I confirmed with 18 of the other files experiencing this error, all corruption issues similar to the first one.  Although the amount of info contained in the final block varies widely from a few chars to none.  &lt;/p&gt;


&lt;p&gt;But using the patch I already submitted does appear to actually work with getting the text out for each these corrupted documents.&lt;/p&gt;

&lt;p&gt;Thanks again for adding it to the trunk.&lt;/p&gt;</comment>
                            <comment id="13119999" author="mikemccand" created="Tue, 4 Oct 2011 11:47:10 +0100"  >&lt;p&gt;Thank you Jeremy!  Keep the patches coming &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12496831" name="TIKA-733-rtf_TextExtractor_processGroupEnd-NoSuchElementException.patch" size="2216" author="rpialum" created="Wed, 28 Sep 2011 03:12:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 28 Sep 2011 10:39:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34358</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxx1z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16639</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>