<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:33:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/TIKA-697/TIKA-697.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[TIKA-697] Tika reports the content type of AR archives as &quot;text/plain&quot;</title>
                <link>https://issues.apache.org/jira/browse/TIKA-697</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;The Tika.detect(InputStream) method returns &quot;text/plain&quot; for AR archives created with the Linux &quot;Create Archive&quot; option of Nautilus (available via right-clicking on a file).&lt;/p&gt;

&lt;p&gt;The Apache Commons Compress &quot;autodetection&quot; code of the ArchiveStreamFactory looks at the first 12 bytes of the stream and correctly identifies the type as AR.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux (CentOS 5.6)&lt;/p&gt;</environment>
        <key id="12519858">TIKA-697</key>
            <summary>Tika reports the content type of AR archives as &quot;text/plain&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="pns">PNS</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Aug 2011 19:16:04 +0100</created>
                <updated>Sun, 27 Nov 2011 22:59:21 +0000</updated>
                            <resolved>Sun, 27 Nov 2011 22:59:21 +0000</resolved>
                                                    <fixVersion>1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13090127" author="gagravarr" created="Wed, 24 Aug 2011 11:16:48 +0100"  >&lt;p&gt;I&apos;ve added a couple of test documents in r1161038.&lt;/p&gt;

&lt;p&gt;I think from these that we want to look for the pattern &quot;!&amp;lt;arch&amp;gt;\n&quot; i.e. 21 3c 61 72 63 68 3e 0a &lt;/p&gt;</comment>
                            <comment id="13145299" author="pns" created="Mon, 7 Nov 2011 09:34:35 +0000"  >&lt;p&gt;Detection of Unix AR archive types (see &lt;a href=&quot;http://en.wikipedia.org/wiki/Ar_(Unix&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/Ar_(Unix&lt;/a&gt;)) is very simple and can indeed be done either by checking for the 8 &quot;magic&quot; bytes (0x21, 0x3C, 0x61, 0x72, 0x63, 0x68, 0x3E, 0x0A).&lt;/p&gt;

&lt;p&gt;What needs to be changed in the Tika code is at least the TextDetector.detect() method, so that it returns an AR media type if the first 8 bytes of the archive are the AR signature.&lt;/p&gt;

&lt;p&gt;The AR MediaType needs to be added in class org.apache.tika.mime.MediaType and it will probably be a custom one, since apparently there is no IANA-registered MIME type for AR (see &lt;a href=&quot;http://en.wikipedia.org/wiki/List_of_archive_formats&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/List_of_archive_formats&lt;/a&gt; and &lt;a href=&quot;http://www.iana.org/assignments/media-types/index.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.iana.org/assignments/media-types/index.html&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Assuming the existence of a statement like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MediaType APPLICATION_AR = application(&lt;span class=&quot;code-quote&quot;&gt;&quot;x-ar&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in class &lt;b&gt;org.apache.tika.mime.MediaType&lt;/b&gt;, following is a quick implementation of the proposed changes in the &lt;b&gt;TextDetector.detect()&lt;/b&gt; method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-comment&quot;&gt;// Code immediately after the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initialization block of the IS_CONTROL_BYTE[] array
&lt;/span&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] AR_HEADER = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]
   	                     {0x21, 0x3C, 0x61, 0x72, 0x63, 0x68, 0x3E, 0x0A};
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; checkArHeader;

	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MediaType detect(InputStream input, Metadata metadata)
	&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (input == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MediaType.OCTET_STREAM;
		}

		input.mark(NUMBER_OF_BYTES_TO_TEST);
                checkArHeader = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; NUMBER_OF_BYTES_TO_TEST; i++) {
				&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ch = input.read();
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ch == -1) {
					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i &amp;gt; 0) {
						&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MediaType.TEXT_PLAIN;
					} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
						&lt;span class=&quot;code-comment&quot;&gt;// See https://issues.apache.org/jira/browse/TIKA-483
&lt;/span&gt;						&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MediaType.OCTET_STREAM;
					}
				} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ch &amp;lt; IS_CONTROL_BYTE.length &amp;amp;&amp;amp; IS_CONTROL_BYTE[ch]) {
					&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MediaType.OCTET_STREAM;
				} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (checkArHeader) {
                                        &lt;span class=&quot;code-comment&quot;&gt;// See https://issues.apache.org/jira/browse/TIKA-697
&lt;/span&gt;					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((i&amp;gt;7) || (AR_HEADER[i] != ch)) {
						checkArHeader = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
					} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((i==7) &amp;amp;&amp;amp; (AR_HEADER[i] == ch)) {
						&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MediaType.APPLICATION_AR;
					}
				}
			}
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MediaType.TEXT_PLAIN;
		} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
			input.reset();
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Essentially, the additions are just the new MediaType.APPLICATION_AR constant, the 2 new variables (AR_HEADER, checkArHeader) and the &quot;else if (checkArHeader)&quot; control block.&lt;/p&gt;

&lt;p&gt;I have tested the above with numerous combinations of files and it works as expected.&lt;/p&gt;</comment>
                            <comment id="13145308" author="alexott" created="Mon, 7 Nov 2011 09:52:02 +0000"  >&lt;p&gt;I think, that following magic in tika-mimetypes.xml will be enough (instead of modifying code of Tika):&lt;/p&gt;

&lt;p&gt;  &amp;lt;mime-type type=&quot;application/x-unix-archive&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;magic priority=&quot;50&quot;&amp;gt;&lt;br/&gt;
      &amp;lt;match value=&quot;0x213C617263683E0A&quot; type=&quot;string&quot; offset=&quot;0&quot; /&amp;gt;&lt;br/&gt;
    &amp;lt;/magic&amp;gt;&lt;br/&gt;
    &amp;lt;glob pattern=&quot;*.a&quot;/&amp;gt;&lt;br/&gt;
  &amp;lt;/mime-type&amp;gt;&lt;/p&gt;</comment>
                            <comment id="13145319" author="alexott" created="Mon, 7 Nov 2011 10:19:08 +0000"  >&lt;p&gt;This patch adds signature for Unix Archive files (.a)&lt;/p&gt;

&lt;p&gt;I think, that signature for .deb files should be also updated accordingly&lt;/p&gt;</comment>
                            <comment id="13145494" author="pns" created="Mon, 7 Nov 2011 13:05:45 +0000"  >&lt;p&gt;Even better, but maybe we need to add &quot;*.ar&quot; as a glob pattern, too?&lt;/p&gt;</comment>
                            <comment id="13145496" author="alexott" created="Mon, 7 Nov 2011 13:12:39 +0000"  >&lt;p&gt;No problem, just add:&lt;/p&gt;

&lt;p&gt;&amp;lt;glob pattern=&quot;*.ar&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;after&lt;/p&gt;

&lt;p&gt;&amp;lt;glob pattern=&quot;*.a&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;... But I really never saw such file extension&lt;/p&gt;</comment>
                            <comment id="13158070" author="gagravarr" created="Sun, 27 Nov 2011 22:59:10 +0000"  >&lt;p&gt;Thanks for this&lt;/p&gt;

&lt;p&gt;I&apos;ve tweaked the existing mime magic in r1206896, which should now correctly detect the file format (the previous one had an eronious = at the start, and lacked the \n). I&apos;ve also added the alternate extension and alternate mimetype&lt;/p&gt;

&lt;p&gt;In r1206898 I&apos;ve also added mime magic for .deb, based on the working one for archive. Ideally we should also add a very small .deb file to the test suite&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12502742" name="tika-697.diff" size="735" author="alexott" created="Mon, 7 Nov 2011 10:19:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 24 Aug 2011 10:16:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3845</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxx273:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16675</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>