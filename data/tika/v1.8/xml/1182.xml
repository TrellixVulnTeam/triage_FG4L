<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:38:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/TIKA-1182/TIKA-1182.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[TIKA-1182] Out of memory exception when parsing TTF file</title>
                <link>https://issues.apache.org/jira/browse/TIKA-1182</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;   When parsing attached file using tika-app-1.4.jar, CPU usage is high and it never seems to finish.&lt;/p&gt;

&lt;p&gt;When parsing using attached java code, I get an out of memory exception.&lt;/p&gt;

&lt;p&gt;Let me know what other information I can provide.&lt;/p&gt;

&lt;p&gt;Thank you!&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu&lt;/p&gt;

&lt;p&gt;java version &quot;1.7.0_40&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_40-b43)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 24.0-b56, mixed mode)&lt;/p&gt;</environment>
        <key id="12673521">TIKA-1182</key>
            <summary>Out of memory exception when parsing TTF file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="egh">Erik Hetzner</reporter>
                        <labels>
                    </labels>
                <created>Sat, 12 Oct 2013 01:24:17 +0100</created>
                <updated>Fri, 6 Jun 2014 12:44:43 +0100</updated>
                            <resolved>Fri, 6 Jun 2014 11:49:03 +0100</resolved>
                                    <version>1.4</version>
                                    <fixVersion>1.6</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13793167" author="egh" created="Sat, 12 Oct 2013 01:26:41 +0100"  >&lt;p&gt;To build and run attached source:&lt;/p&gt;

&lt;p&gt;javac -cp tika-app-1.4.jar TIKA_1182.java&lt;br/&gt;
java -cp .:tika-app-1.4.jar TIKA_1182&lt;/p&gt;</comment>
                            <comment id="13793443" author="egh" created="Sat, 12 Oct 2013 20:01:52 +0100"  >&lt;p&gt;For what it&apos;s worth, increasing max heap to 16gb does not help.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java -Xmx16000m -cp .:tika-app-1.4.jar TIKA_1182 
error: array index out of bounds
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Java heap space
	at org.apache.fontbox.ttf.GlyfCompositeDescript.&amp;lt;init&amp;gt;(GlyfCompositeDescript.java:59)
	at org.apache.fontbox.ttf.GlyphData.initData(GlyphData.java:63)
	at org.apache.fontbox.ttf.GlyphTable.initData(GlyphTable.java:71)
	at org.apache.fontbox.ttf.AbstractTTFParser.parseTables(AbstractTTFParser.java:163)
	at org.apache.fontbox.ttf.TTFParser.parseTables(TTFParser.java:61)
	at org.apache.fontbox.ttf.AbstractTTFParser.parseTTF(AbstractTTFParser.java:90)
	at org.apache.fontbox.ttf.TTFParser.parseTTF(TTFParser.java:26)
	at org.apache.fontbox.ttf.AbstractTTFParser.parseTTF(AbstractTTFParser.java:66)
	at org.apache.fontbox.ttf.TTFParser.parseTTF(TTFParser.java:26)
	at org.apache.tika.parser.font.TrueTypeParser.parse(TrueTypeParser.java:65)
	at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:242)
	at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:242)
	at org.apache.tika.parser.AutoDetectParser.parse(AutoDetectParser.java:120)
	at TIKA_1182.main(TIKA_1182.java:19)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13793460" author="gagravarr" created="Sat, 12 Oct 2013 21:31:28 +0100"  >&lt;p&gt;It looks from the stacktrace like the bug is actually in FontBox, part of the Apache PDFBox project. Most likely you&apos;ll need to report this upstream to PDFBox&lt;/p&gt;</comment>
                            <comment id="13793536" author="egh" created="Sun, 13 Oct 2013 01:24:37 +0100"  >&lt;p&gt;Hi Nick,&lt;/p&gt;

&lt;p&gt;Of course, thanks. I will report upstream and link. &lt;/p&gt;</comment>
                            <comment id="13794665" author="egh" created="Tue, 15 Oct 2013 00:58:43 +0100"  >&lt;p&gt;See: &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PDFBOX-1749&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13795539" author="egh" created="Tue, 15 Oct 2013 20:31:10 +0100"  >&lt;p&gt;The pdfbox project is suggesting that, because this is a bad font, we should try to precheck the font with java.awt.Font.createFont. I have modified TrueTypeParser.java to do this. It passes all tests and does not go into an infinite loop or blow out the memory, but I don&apos;t know if this will work with Tika. Patch attached.&lt;/p&gt;</comment>
                            <comment id="13802325" author="gagravarr" created="Tue, 22 Oct 2013 22:57:26 +0100"  >&lt;p&gt;Your patch would&apos;ve thrown a NPE if the InputStream wasn&apos;t a TikaInputStream. In r1534816 I&apos;ve added a version that only does the AWT check if we have a TikaInputStream, as that&apos;s the only way we can be sure we can rewind to then use FontBox. That should work for most people for now, but the proper fix is to get the EOF check into PDFBox, then upgrade our dependency and remove the extra check from Tika&lt;/p&gt;</comment>
                            <comment id="13802358" author="egh" created="Tue, 22 Oct 2013 23:21:03 +0100"  >&lt;p&gt;Thanks, Nick. I didn&apos;t know TikaInputStream.cast could return null. Thanks also for commenting on the upstream bug; it&apos;s good to have somebody from tika asking for a better fix from fontbox.&lt;/p&gt;</comment>
                            <comment id="13802370" author="gagravarr" created="Tue, 22 Oct 2013 23:34:53 +0100"  >&lt;p&gt;TikaInputStream.get will wrap the stream if it isn&apos;t already a TikaInputStream&lt;/p&gt;

&lt;p&gt;TikaInputStream.cast will cast to a TikaInputStream if possible, else return null. A typical use for this is the code in the ttf parser, where we can shortcut something with TIS+File but have a backup if not&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://tika.apache.org/1.4/api/org/apache/tika/io/TikaInputStream.html#cast%28java.io.InputStream%29&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://tika.apache.org/1.4/api/org/apache/tika/io/TikaInputStream.html#cast%28java.io.InputStream%29&lt;/a&gt; for more details&lt;/p&gt;</comment>
                            <comment id="13930116" author="magloven" created="Tue, 11 Mar 2014 09:31:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PDFBOX-1749&lt;/a&gt;&lt;br/&gt;
-&amp;gt; Seems the EOF check was actually fixed in PDFBox 1.8.3&lt;/p&gt;

&lt;p&gt;Tika 1.5 uses PDFBox 1.8.4 (updated in &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-1230&quot; title=&quot;Update PDFBox to v1.8.4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-1230&quot;&gt;&lt;del&gt;TIKA-1230&lt;/del&gt;&lt;/a&gt;)&lt;br/&gt;
=&amp;gt; This issue can now be addressed properly as suggested by Nick Burch 22/Oct/2013...&lt;/p&gt;</comment>
                            <comment id="14019351" author="mkrio" created="Thu, 5 Jun 2014 23:13:53 +0100"  >&lt;p&gt;I retested with the current Tika trunk and can confirm that this file is now handled in FontBox properly (throwing a java.io.EOFException). We should revert &lt;a href=&quot;https://github.com/apache/tika/commit/bbd065b7070651d939a84e043b4f6f22f80269d9&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/tika/commit/bbd065b7070651d939a84e043b4f6f22f80269d9&lt;/a&gt; to remove the temporary workaround and can resolve this ticket.&lt;/p&gt;

&lt;p&gt;This is trivial and would be good to have as the workaround has its own issues:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Font.createFont(Font.TRUETYPE_FONT, tis.getFile());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Not 100% sure but I think the JDK&apos;s FontManager will permanently keep a file handle open for any font created that way.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
tis.mark(0);
Font.createFont(Font.TRUETYPE_FONT, stream);
tis.reset();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This never really worked as a mark(0) with subsequent reads from the stream will cause reset to throw an IOException.&lt;/p&gt;</comment>
                            <comment id="14019747" author="gagravarr" created="Fri, 6 Jun 2014 11:49:03 +0100"  >&lt;p&gt;Temporary fix reverted in r1600844.&lt;/p&gt;</comment>
                            <comment id="14019754" author="hudson" created="Fri, 6 Jun 2014 12:03:21 +0100"  >&lt;p&gt;SUCCESS: Integrated in tika-trunk-jdk1.6 #25 (See &lt;a href=&quot;https://builds.apache.org/job/tika-trunk-jdk1.6/25/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/tika-trunk-jdk1.6/25/&lt;/a&gt;)&lt;br/&gt;
Remove the temporary PDFBox workaround for &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-1182&quot; title=&quot;Out of memory exception when parsing TTF file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-1182&quot;&gt;&lt;del&gt;TIKA-1182&lt;/del&gt;&lt;/a&gt;, now that we have upgraded to a version with the fix (nick: &lt;a href=&quot;http://svn.apache.org/viewvc/tika/trunk/?view=rev&amp;amp;rev=1600844&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/tika/trunk/?view=rev&amp;amp;rev=1600844&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/tika/trunk/tika-parsers/src/main/java/org/apache/tika/parser/font/TrueTypeParser.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14019778" author="hudson" created="Fri, 6 Jun 2014 12:44:43 +0100"  >&lt;p&gt;SUCCESS: Integrated in tika-trunk-jdk1.7 #25 (See &lt;a href=&quot;https://builds.apache.org/job/tika-trunk-jdk1.7/25/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/tika-trunk-jdk1.7/25/&lt;/a&gt;)&lt;br/&gt;
Remove the temporary PDFBox workaround for &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-1182&quot; title=&quot;Out of memory exception when parsing TTF file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-1182&quot;&gt;&lt;del&gt;TIKA-1182&lt;/del&gt;&lt;/a&gt;, now that we have upgraded to a version with the fix (nick: &lt;a href=&quot;http://svn.apache.org/viewvc/tika/trunk/?view=rev&amp;amp;rev=1600844&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/tika/trunk/?view=rev&amp;amp;rev=1600844&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/tika/trunk/tika-parsers/src/main/java/org/apache/tika/parser/font/TrueTypeParser.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12608113" name="16A4FF_8.ttf" size="19872" author="egh" created="Sat, 12 Oct 2013 01:25:56 +0100"/>
                            <attachment id="12608557" name="TIKA-1182-fix1.patch" size="1686" author="egh" created="Tue, 15 Oct 2013 20:31:43 +0100"/>
                            <attachment id="12608114" name="TIKA_1182.java" size="952" author="egh" created="Sat, 12 Oct 2013 01:25:56 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 12 Oct 2013 20:31:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353144</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hziq9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353431</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>