[patch] avoid map look ups in a loop by using entrySet