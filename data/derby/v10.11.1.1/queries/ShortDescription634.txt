Subquery materialization can cause stack overflow