<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5539/DERBY-5539.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5539] Harden password hashing in the builtin authentication service</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5539</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The Open Web Application Security Project has some suggestions on how to make it harder for an attacker to crack hashed passwords: &lt;a href=&quot;https://www.owasp.org/index.php/Hashing_Java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://www.owasp.org/index.php/Hashing_Java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The builtin authentication service doesn&apos;t follow all the suggestions. In particular, it doesn&apos;t add a random salt, and it only performs the hash operation once.&lt;/p&gt;

&lt;p&gt;I propose that we add two new properties that makes it possible to configure builtin to use a random salt and run multiple iterations of the hash operation:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;derby.authentication.builtin.saltLength - the length of the random salt to add (in bytes)&lt;/li&gt;
	&lt;li&gt;derby.authentication.builtin.iterations - the number of times to perform the hash operation&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;d also suggest that we set the defaults so that random salt and multiple iterations are used by default. The OWASP page mentions 64 bits of salt (8 bytes) and a minimum of 1000 iterations. I consulted a security expert who thought that these recommendations sounded OK, but he believed the recommended salt length was likely to be revised and suggested 16 bytes instead. The only price we pay by going from 8 to 16 bytes, is that we&apos;ll need to store 8 bytes extra per user in the database, so I don&apos;t see any reason not to set the default for derby.authentication.builtin.saltLength as high as 16. Setting the default for derby.authentication.builtin.iterations to 1000 will make authentication of a user somewhat slower (which is the point, really), but experiments on my machine suggest that running our default hash function (SHA-256) 1000 times takes around 1 ms. Since authentication only happens when establishing a new connection to the database, that would be a negligible cost, I think.&lt;/p&gt;

&lt;p&gt;If saltLength is set to 0 and iterations is set to 1, the hashing will be done in the exact same way as in previous versions.&lt;/p&gt;

&lt;p&gt;Both of the properties should only be respected when the data dictionary version is 10.9 or higher, so that users in soft-upgraded databases can still log in after a downgrade.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535288">DERBY-5539</key>
            <summary>Harden password hashing in the builtin authentication service</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Dec 2011 10:58:33 +0000</created>
                <updated>Tue, 24 Jul 2012 18:28:04 +0100</updated>
                            <resolved>Thu, 23 Feb 2012 08:36:49 +0000</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13173198" author="knutanders" created="Tue, 20 Dec 2011 13:49:45 +0000"  >&lt;p&gt;Attaching patch d5539-1a.diff, which adds the two proposed properties (with the defaults suggested in the issue description) and makes the configurable hash scheme in AuthenticationServiceBase use them.&lt;/p&gt;

&lt;p&gt;When using the existing algorithm, we store the credentials as a token with the following components:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a format identifier&lt;/li&gt;
	&lt;li&gt;the hashed password&lt;/li&gt;
	&lt;li&gt;the name of the hash function&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With the new algorithm, the format identifier is bumped, and the random salt and the number of iterations are added to the token.&lt;/p&gt;

&lt;p&gt;If the data dictionary version is less than 10.9, the two properties are ignored. This is done to ensure that it is safe to set passwords in soft upgrade mode. The patch also adds upgrade tests to verify this (more precisely, it moved the upgrade tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4483&quot; title=&quot;Provide a way to change the hash algorithm used by BUILTIN authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4483&quot;&gt;&lt;del&gt;DERBY-4483&lt;/del&gt;&lt;/a&gt; from Changes10_6 to Changes10_9, so that they&apos;ll also test upgrade from 10.6, 10.7 and 10.8, and updated them to check the stored tokens against the new format). AuthenticationTest was also updated to test the new format.&lt;/p&gt;

&lt;p&gt;The regression tests ran cleanly. Patch is ready for review.&lt;/p&gt;</comment>
                            <comment id="13173570" author="dagw" created="Tue, 20 Dec 2011 22:30:44 +0000"  >&lt;p&gt;Thanks, Knut. I read through the patch, and it looks good to me. +1&lt;/p&gt;

&lt;p&gt;Nits: Do you need the upper bound in AuthenticationServiceBase#getIntProperty? &lt;br/&gt;
The Javadoc for Changes10_9#testBuiltinAuthenticationWithConfigurableHash is a little ambiguous in its use of &quot;only&quot;.&lt;br/&gt;
Could you test with the salt in the upgrade test by reading the property first?&lt;/p&gt;</comment>
                            <comment id="13173994" author="knutanders" created="Wed, 21 Dec 2011 10:37:10 +0000"  >&lt;p&gt;Thanks, Dag! I&apos;m uploading an updated patch (d5539-1b.diff) which clarifies the javadoc comment. Committed with revision 1221666. Further comments can be addressed in followup patches.&lt;/p&gt;

&lt;p&gt;&amp;gt; Nits: Do you need the upper bound in AuthenticationServiceBase#getIntProperty?&lt;/p&gt;

&lt;p&gt;You&apos;re right, we don&apos;t, since both of the current callers pass in Integer.MAX_VALUE. I guess it just felt more natural to specify the accepted range rather than just the lower bound, especially since the method is a general one. It shouldn&apos;t cause too much bloat, but I can remove that parameter if you think that would be better.&lt;/p&gt;

&lt;p&gt;(On a related note, I started wondering about what would happen if the salt length was set so high that the token wouldn&apos;t fit in a varchar, and if we&apos;d need an upper bound. That turned out not to be an issue, as the db properties conglomerate doesn&apos;t store the values in varchars. It stores them in UserType columns. I tested with salt length 40000, which results in a token with more than 80000 characters, and that worked fine.)&lt;/p&gt;

&lt;p&gt;&amp;gt; Could you test with the salt in the upgrade test by reading the property first?&lt;/p&gt;

&lt;p&gt;Yes and no. With non-zero length salts, the stored token will vary between test runs, so in that case we&apos;d need to duplicate the hashing algorithm in the test in order to verify that we get the correct token. But the main purpose of the test case is to verify that the token is stored in the expected format (for which we just need to check the format identifier in the first four characters) and that we&apos;re still able to connect after upgrade/downgrade, so we might also run the test case with default salt length and disable the full checks of the stored tokens. Those two alternatives should be more or less equivalent with respect to what we want to test in this test.&lt;/p&gt;</comment>
                            <comment id="13213584" author="knutanders" created="Wed, 22 Feb 2012 12:53:40 +0000"  >&lt;p&gt;There&apos;s one more thing I&apos;d like to change before I mark this issue as resolved. The OWASP page doesn&apos;t mention it explicitly, but the code example has a comment saying:&lt;/p&gt;

&lt;p&gt;// TIME RESISTANT ATTACK (Even if the user does not exist the&lt;br/&gt;
// Computation time is equal to the time needed for a legitimate user&lt;/p&gt;

&lt;p&gt;I think the point here is that we should always generate a hashed token, also if the user does not exist, so that attackers cannot use the difference in computation time to determine whether or not a user exists.&lt;/p&gt;

&lt;p&gt;The attached patch (d5539-2a.diff) makes BasicAuthenticationServiceImpl.authenticateUser() generate a hashed token based on the supplied credentials if it couldn&apos;t find a user with the specified name at the database level. The token is thrown away once it&apos;s generated, since its only purpose is to make the authentication failure as slow for non-existing users as it is for existing users.&lt;/p&gt;

&lt;p&gt;Without the patch, 10000 unsuccessful attempts to connect to a database using a non-existing user name took 40 seconds in my environment, whereas 10000 unsuccessful connection attempts with an existing user name took 9 seconds. With the patch, 10000 unsuccessful connection attempts took 40 seconds in both scenarios.&lt;/p&gt;

&lt;p&gt;All the regression tests ran cleanly with the patch.&lt;/p&gt;</comment>
                            <comment id="13214031" author="knutanders" created="Wed, 22 Feb 2012 21:57:22 +0000"  >&lt;p&gt;&amp;gt; Without the patch, 10000 unsuccessful attempts to connect to a&lt;br/&gt;
&amp;gt; database using a non-existing user name took 40 seconds in my&lt;br/&gt;
&amp;gt; environment, whereas 10000 unsuccessful connection attempts with an&lt;br/&gt;
&amp;gt; existing user name took 9 seconds.&lt;/p&gt;

&lt;p&gt;Oops. I was too quick when I wrote the above comment. It was the other&lt;br/&gt;
way around. It was faster with non-existing users than with existing&lt;br/&gt;
users.&lt;/p&gt;

&lt;p&gt;But the main point is still that the time it took to refuse a&lt;br/&gt;
connection was different for existing and non-existing users before&lt;br/&gt;
the patch, and it takes (approximately) the same time for existing and&lt;br/&gt;
non-existing users when the patch is applied.&lt;/p&gt;</comment>
                            <comment id="13214459" author="knutanders" created="Thu, 23 Feb 2012 08:36:49 +0000"  >&lt;p&gt;Committed revision 1292704.&lt;br/&gt;
Marking the issue as resolved since there&apos;s no more planned work.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12535988">DERBY-5550</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12508074" name="d5539-1a.diff" size="34365" author="knutanders" created="Tue, 20 Dec 2011 13:49:45 +0000"/>
                            <attachment id="12508223" name="d5539-1b.diff" size="34407" author="knutanders" created="Wed, 21 Dec 2011 10:37:09 +0000"/>
                            <attachment id="12515584" name="d5539-2a.diff" size="4518" author="knutanders" created="Wed, 22 Feb 2012 12:53:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 20 Dec 2011 22:30:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220972</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0as7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35565</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>