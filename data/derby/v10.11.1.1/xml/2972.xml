<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:35:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2972/DERBY-2972.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2972] Update or select with function in the where clause causes with TERRITORY_BASED collation fails with ERROR 42818: Comparisons between &apos;VARCHAR&apos; and &apos;VARCHAR&apos; are not supported.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2972</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following update fails with ERROR 42818&lt;br/&gt;
ij&amp;gt; update testing set a = PADSTRING(&apos;aa&apos;,2024) where a = PADSTRING(&apos;a&apos;,2024);&lt;br/&gt;
ERROR 42818: Comparisons between &apos;VARCHAR&apos; and &apos;VARCHAR&apos; are not supported.&lt;/p&gt;

&lt;p&gt;See full script below &lt;br/&gt;
onnect &apos;jdbc:derby:nordb;territory=no_NO;collation=TERRITORY_BASED&apos;;&lt;/p&gt;

&lt;p&gt;CREATE FUNCTION  PADSTRING (DATA VARCHAR(32000), LENGTH INTEGER) RETURNS VARCHAR(32000) EXTERNAL NAME &apos;org.apache.derbyTesting.functionTests.util.Formatters.padString&apos; LANGUAGE JAVA PARAMETER STYLE JAVA;&lt;/p&gt;

&lt;p&gt;create table testing &lt;br/&gt;
	(a varchar(2024), b varchar(1024), c varchar(1024), d varchar(2048), e varchar(300)) ;&lt;/p&gt;

&lt;p&gt;&amp;#8211; insert 9 rows into the table&lt;br/&gt;
insert into testing values (PADSTRING(&apos;1&apos;,2024),  PADSTRING(&apos;2&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;3&apos;,1024), PADSTRING(&apos;4&apos;,2048),  PADSTRING(&apos;5&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;10&apos;,2024),  &lt;br/&gt;
       PADSTRING(&apos;20&apos;,1024), PADSTRING(&apos;30&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;40&apos;,2048), PADSTRING(&apos;50&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;100&apos;,2024),  &lt;br/&gt;
       PADSTRING(&apos;200&apos;,1024), PADSTRING(&apos;300&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;400&apos;,2048), PADSTRING(&apos;500&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;1000&apos;,2024),  &lt;br/&gt;
       PADSTRING(&apos;2000&apos;,1024), PADSTRING(&apos;3000&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;4000&apos;,2048), PADSTRING(&apos;5000&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;10000&apos;,2024),  &lt;br/&gt;
       PADSTRING(&apos;20000&apos;,1024),	PADSTRING(&apos;30000&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;40000&apos;,2048), PADSTRING(&apos;50000&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;100000&apos;,2024), &lt;br/&gt;
       PADSTRING(&apos;200000&apos;,1024), PADSTRING(&apos;300000&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;400000&apos;,2048), PADSTRING(&apos;500000&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;1000000&apos;,2024), &lt;br/&gt;
       PADSTRING(&apos;2000000&apos;,1024), PADSTRING(&apos;3000000&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;4000000&apos;,2048), PADSTRING(&apos;5000000&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;10000000&apos;,2024), &lt;br/&gt;
       PADSTRING(&apos;20000000&apos;,1024), PADSTRING(&apos;30000000&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;40000000&apos;,2048), PADSTRING(&apos;50000000&apos;,300));&lt;/p&gt;

&lt;p&gt;insert into testing values (PADSTRING(&apos;100000000&apos;,2024), &lt;br/&gt;
       PADSTRING(&apos;200000000&apos;,1024), PADSTRING(&apos;300000000&apos;,1024), &lt;br/&gt;
       PADSTRING(&apos;400000000&apos;,2048), PADSTRING(&apos;500000000&apos;,300));&lt;/p&gt;

&lt;p&gt;update testing set a = PADSTRING(&apos;aa&apos;,2024) where a = PADSTRING(&apos;a&apos;,2024);&lt;/p&gt;</description>
                <environment></environment>
        <key id="12374471">DERBY-2972</key>
            <summary>Update or select with function in the where clause causes with TERRITORY_BASED collation fails with ERROR 42818: Comparisons between &apos;VARCHAR&apos; and &apos;VARCHAR&apos; are not supported.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Jul 2007 17:07:11 +0100</created>
                <updated>Fri, 14 Sep 2007 18:36:09 +0100</updated>
                            <resolved>Fri, 14 Sep 2007 18:36:09 +0100</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12515015" author="kmarsden" created="Tue, 24 Jul 2007 17:08:28 +0100"  >&lt;p&gt;This issue was found during collation testing &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2656&quot; title=&quot;Run suites.All against a collated database&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2656&quot;&gt;&lt;del&gt;DERBY-2656&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12515025" author="kmarsden" created="Tue, 24 Jul 2007 17:45:33 +0100"  >&lt;p&gt;This is also an issue with selects &lt;br/&gt;
ij&amp;gt; select b, e from testing where e = PADSTRING(&apos;e&apos;,300);&lt;br/&gt;
ERROR 42818: Comparisons between &apos;VARCHAR&apos; and &apos;VARCHAR&apos; are not supported.&lt;/p&gt;</comment>
                            <comment id="12520398" author="kmarsden" created="Thu, 16 Aug 2007 23:45:49 +0100"  >&lt;p&gt;According to &lt;a href=&quot;http://wiki.apache.org/db-derby/BuiltInLanguageBasedOrderingDERBY-1478:&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/BuiltInLanguageBasedOrderingDERBY-1478:&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;7)For user defined functions&apos; that return character string type, the return type&apos;s collation will have the same collation as of the character set of the schema that the function is defined in. The collation derivation will be implicit.&lt;/p&gt;

&lt;p&gt;so there must be something awry in setting that collation.  Builtin functions such as TRIM work fine.&lt;/p&gt;
</comment>
                            <comment id="12520577" author="mamtas" created="Fri, 17 Aug 2007 15:58:03 +0100"  >&lt;p&gt;Built-in function TRIM is implemented in it&apos;s own compile time node(TernaryOperatorNode) and hence it was very easy to set correct collation setting on it.&lt;/p&gt;

&lt;p&gt;The processing for user-defined function involve lots of compile time nodes in Derby and they all need to be taken into consideration  when someone works on this Jira entry. I haven&apos;t looked at this jira entry enough to provide more info.&lt;/p&gt;</comment>
                            <comment id="12524215" author="kmarsden" created="Sat, 1 Sep 2007 00:05:12 +0100"  >&lt;p&gt;Attached is an initial patch for this issue.  It sets collation in JavaToSQLValueNode.java for string types to that of the current schema.  It fixes the cases outlined in this issue, but according to Mamta there may be more places that need to be changed.  &lt;/p&gt;

&lt;p&gt;The patch also adds tests for function comparisons and order by expression to CollationTest.&lt;/p&gt;

&lt;p&gt;Mamta, could you review this patch? Also if you know of other cases that might fail with functions please let me know. I am trying to think of some, but haven&apos;t come up with any yet.&lt;/p&gt;
</comment>
                            <comment id="12524221" author="djd" created="Sat, 1 Sep 2007 00:30:22 +0100"  >&lt;p&gt;Kathey&amp;gt; &quot;It sets collation in JavaToSQLValueNode.java for string types to that of the current schema. &quot;&lt;/p&gt;

&lt;p&gt;That doesn&apos;t seem to match the rule 7 from the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1478&quot; title=&quot;Add built in language based ordering and like processing to Derby&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1478&quot;&gt;&lt;del&gt;DERBY-1478&lt;/del&gt;&lt;/a&gt; wiki page that you quoted in an earlier comment??&lt;/p&gt;</comment>
                            <comment id="12524223" author="kmarsden" created="Sat, 1 Sep 2007 00:38:00 +0100"  >&lt;p&gt;Oops, let me have another go at it.  Ignore the previous patch.&lt;/p&gt;
</comment>
                            <comment id="12524764" author="kmarsden" created="Tue, 4 Sep 2007 16:45:14 +0100"  >&lt;p&gt;I am having trouble finding this rule (From the wiki page) in the SQL Spec.  Can someone point me to the section where this is defined?&lt;/p&gt;

&lt;p&gt;7)For user defined functions&apos; that return character string type, the return type&apos;s collation will have the same collation as of the character set of the schema that the function is defined in. The collation derivation will be implicit.&lt;/p&gt;

&lt;p&gt;Thanks &lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12524811" author="mamtas" created="Tue, 4 Sep 2007 19:19:36 +0100"  >&lt;p&gt;Kathey, the SQL spec does not have specific blurb about user defined functions and collations. But applying Section 6.1, syntax rules 3b) and 16) for character string types (which is where user defined functions with return type of character string type fall into), the collation type of return of user defined functions is implementation defined. &lt;/p&gt;

&lt;p&gt;In the thread titled &quot;some comments on collation wiki page&quot;, if you got Dan&apos;s comment &lt;a href=&quot;http://www.nabble.com/Re%3A-some-comments-on-collation-wiki-page-p9813465.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Re%3A-some-comments-on-collation-wiki-page-p9813465.html&lt;/a&gt; and then my comment &lt;a href=&quot;http://www.nabble.com/Re%3A-some-comments-on-collation-wiki-page-p9815841.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Re%3A-some-comments-on-collation-wiki-page-p9815841.html&lt;/a&gt;, that is where we decided Derby&apos;s implementation behavior for user defined functions to be to pick up the collation of the schema in which the function is defined. Hope this helps provide a background info for you.&lt;/p&gt;</comment>
                            <comment id="12524815" author="mamtas" created="Tue, 4 Sep 2007 19:25:32 +0100"  >&lt;p&gt;Kathey, you probably know this already, but RoutineAliasInfo  for user defined functions has collation info about function&apos;s return type and parameters. The work for RoutineAliasInfo changes went in as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2723&quot; title=&quot; Set correct collation type and derivation for result from user defined functions&amp;#39; that return character string type.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2723&quot;&gt;&lt;del&gt;DERBY-2723&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2723&quot; title=&quot; Set correct collation type and derivation for result from user defined functions&amp;#39; that return character string type.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2723&quot;&gt;&lt;del&gt;DERBY-2723&lt;/del&gt;&lt;/a&gt; was created to make sure that we save correct collation info into the system table for user defined functions. &lt;/p&gt;

&lt;p&gt;I could be wrong because I have not done much research myself, but because there are quite a few compile time nodes involved for user defined functions, I thought we would need changes in handful of compile time nodes to make sure that the collation info from RoutineAliasInfo gets propogated all the way to bind and generate time.&lt;/p&gt;</comment>
                            <comment id="12524817" author="djd" created="Tue, 4 Sep 2007 19:31:39 +0100"  >&lt;p&gt;Right, &quot;rule&quot; 7) in the wiki page is an instance of rule 3) on the same page.&lt;/p&gt;</comment>
                            <comment id="12524849" author="kmarsden" created="Tue, 4 Sep 2007 21:07:11 +0100"  >&lt;p&gt;Dan said:&lt;br/&gt;
&amp;gt;, &quot;rule&quot; 7) in the wiki page is an instance of rule 3) on the same page.&lt;br/&gt;
Rule 3 says:&lt;/p&gt;

&lt;p&gt;&amp;gt;We define Derby&apos;s implementation-defined character set for such &amp;lt;character string type&amp;gt; to be current &amp;gt;compilation schema&apos;s character set. The collation derivation will be implicit.&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t it then follow that that functions shouldn&apos;t it follow that functions should use the current compilation schema as well?&lt;/p&gt;
</comment>
                            <comment id="12524859" author="djd" created="Tue, 4 Sep 2007 21:24:04 +0100"  >&lt;p&gt;Sorry, mis-read rule 3 on the wiki page. I think rule 3 on the wiki page would be clearer if it explicit stated Derby&apos;s implementation defined rules for when a character string type is not contained in a column definition. As you point out Kathey, the text in 3 does not obviously match a function&apos;s definition, though it does if the current compilation schema is taken as the schema the routine is defined in (which I think would be the case when SQL routines are supported).&lt;/p&gt;

&lt;p&gt;Derby&apos;s implementation rules might be:&lt;/p&gt;

&lt;p&gt; For a character string type in a routine definition, the collation type will be that of the schema the routine is defined in and derivation will be implicit.&lt;/p&gt;

&lt;p&gt; For a character string type in a CAST expression, the the collation type will be that of the current compilation schema and derivation will be implicit.&lt;/p&gt;

&lt;p&gt; Any other uses of character type definitions??&lt;/p&gt;




</comment>
                            <comment id="12524878" author="mamtas" created="Tue, 4 Sep 2007 22:26:32 +0100"  >&lt;p&gt;Following are all the bullet items from wiki page &lt;a href=&quot;http://wiki.apache.org/db-derby/BuiltInLanguageBasedOrderingDERBY-1478&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/BuiltInLanguageBasedOrderingDERBY-1478&lt;/a&gt; that specifies Derby specific implementation rules (ie where the SQL spec allows the implementation to choose it&apos;s own behavior)&lt;br/&gt;
1)String literal (specific instance of rule 3)&lt;br/&gt;
3)Generic rule for character string type (pickup collation from current compilation schema)&lt;br/&gt;
4)CAST (specific instance of rule 3)&lt;br/&gt;
6)XMLSERIALIZE, CHAR and VARCHAR functions (specific instance of rule 3)&lt;br/&gt;
7)user defined functions (pickup collation from schema where the function is defined)&lt;br/&gt;
8)JDBC parameters (pickup collation from context)&lt;br/&gt;
10)CURRENT ISOLATION, CURRENT SCHEMA and CURRENT SQLID (pickup collation of character set SQL_IDENTIFIER)&lt;/p&gt;</comment>
                            <comment id="12524881" author="kmarsden" created="Tue, 4 Sep 2007 22:36:17 +0100"  >&lt;p&gt;Why did we choose to not have the functions follow rule three and use the current compilation schema?&lt;br/&gt;
It seems like that would be a lot clearer to users because they would not have to use casts for literal comparisons to functions because the collation for both would match the current compilation schema,&lt;/p&gt;

</comment>
                            <comment id="12524882" author="djd" created="Tue, 4 Sep 2007 22:37:41 +0100"  >&lt;p&gt;Rule 3 on the wiki page is only about situations where a data type definition is explicitly used, like CHAR(10), VARCHAR(10) etc.&lt;br/&gt;
So String literal is not a specific instance of rule 3.&lt;/p&gt;

&lt;p&gt;From the list in the last comment, the only additional one is XMLSERIALIZE, leading to&lt;/p&gt;

&lt;p&gt;Routine definition&lt;br/&gt;
XMLSERIALIZE&lt;br/&gt;
CAST&lt;/p&gt;

&lt;p&gt;being the only implementation defined instances of rule 3.&lt;/p&gt;</comment>
                            <comment id="12524983" author="mamtas" created="Wed, 5 Sep 2007 06:24:49 +0100"  >&lt;p&gt;Kathey asked &quot;Why did we choose to not have the functions follow rule three and use the current compilation schema? &quot; &lt;/p&gt;

&lt;p&gt;I have copied following from the thread at &lt;a href=&quot;http://www.nabble.com/Re%3A-some-comments-on-collation-wiki-page-p9815841.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Re%3A-some-comments-on-collation-wiki-page-p9815841.html&lt;/a&gt; where the decision for function&apos;s collation was made. I guess the question at that time was that if we chose current compilation schema, what compilation schema should be picked up ie the current compilation schema when the function is getting defined or the current compilation when the function is getting executed. Based on that, to avoid confusion, decision was made to use the collation of the schema in which the function is defined. &lt;/p&gt;

&lt;p&gt;*******************************************************************************************************************&lt;br/&gt;
The character set of the schema the function is defined in. That keeps it least confusing and easier for the users to understand. &lt;br/&gt;
Mamta&lt;/p&gt;

&lt;p&gt; On 4/3/07, Daniel John Debrunner &amp;lt;djd@...&amp;gt; wrote: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/db-derby/BuiltInLanguageBasedOrderingDERBY-1478&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/BuiltInLanguageBasedOrderingDERBY-1478&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;&amp;gt; 7)For user defined functions&apos; that return character string type, the return type&apos;s collation&lt;br/&gt;
&amp;gt; will have the same collation as current schema&apos;s character set.&lt;/p&gt;

&lt;p&gt;The &quot;current schema&apos;s&quot; character set, or the character set of the schema &lt;br/&gt;
the function is defined in? And if it&apos;s the current schema, is it&lt;br/&gt;
current at function definition time, or current when used?&lt;/p&gt;

&lt;p&gt;Dan.&lt;/p&gt;

&lt;p&gt;*******************************************************************************************************************&lt;/p&gt;</comment>
                            <comment id="12525169" author="kmarsden" created="Wed, 5 Sep 2007 19:04:11 +0100"  >&lt;p&gt;I think that matching the collation of the compilation schema of the executing statement would be easiest for users to understand, because it would match the behavour of string literals and system functions would ve much more likely to work. For example the statement below would execute fine regardless of current schema if we use the compilation schema of the executing statement (as in the attached patch).  If we use the compilation schema of the system schema the user would have to almost always cast the result of system functions.&lt;/p&gt;

&lt;p&gt;VALUES case WHEN SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(&apos;derby.stream.error.logSeverityLevel&apos;) = &apos;50000&apos;  THEN &apos;LOG SHUT&lt;br/&gt;
DOWN  ERRORS&apos;&lt;br/&gt;
WHEN SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(&apos;derby.stream.error.logSeverityLevel&apos;) = &apos;40000&apos; THEN &apos;SHOW CONN CLOSE ERROR&lt;br/&gt;
S&apos;&lt;br/&gt;
WHEN SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(&apos;derby.stream.error.logSeverityLevel&apos;) = &apos;30000&apos; THEN &apos;SHOW XACT ROLLBACK ER&lt;br/&gt;
RORS&apos;&lt;br/&gt;
WHEN SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(&apos;derby.stream.error.logSeverityLevel&apos;) = &apos;20000&apos; THEN &apos;SHOW STMT  ROLLBACK E&lt;br/&gt;
RRORS&apos;&lt;br/&gt;
WHEN SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(&apos;derby.stream.error.logSeverityLevel&apos;) = &apos;0&apos; THEN &apos;SHOW ALL  ERRORS&apos; ELSE &apos;D&lt;br/&gt;
ONT KNOW&apos; END;&lt;br/&gt;
1&lt;/p&gt;</comment>
                            <comment id="12525196" author="mamtas" created="Wed, 5 Sep 2007 20:49:07 +0100"  >&lt;p&gt;Kathey, I can see where you suggestion is coming from when I look at the examples that you provided. But I also feel that when something comes from a specific schema, which in these examples is SYSCS_UTIL, it seems like it should get collation of that schema. This is similar to character columns coming from system schema vs user schema. String literals do not belong to any schema and hence it&apos;s seems reasonable to have them take the collation for the current compilation schema. But for stored objects, like user-defined functions, columns belonging to tables, it seems like they should take the collation of their schema.&lt;/p&gt;

&lt;p&gt;I am on the border line on this issue and would be willing to go either way. I wonder if anyone else in the community thinks strongly one way or the other.&lt;/p&gt;</comment>
                            <comment id="12525465" author="mamtas" created="Thu, 6 Sep 2007 18:07:55 +0100"  >&lt;p&gt;Kathey, I thought more about this issue since yesterday and I believe now that functions should get their collation from their schema because they are stored objects similar to a column. &lt;/p&gt;</comment>
                            <comment id="12525922" author="mamtas" created="Sat, 8 Sep 2007 16:33:22 +0100"  >&lt;p&gt;Kathey, I have a really old(3mths old), NOT ready for commit or for that matter review, but I thought I would attach it here in case if it is of any value to you. I can&apos;t remember all the changes that I mad but I do not think it implemented the complete functionality.&lt;/p&gt;</comment>
                            <comment id="12525934" author="kmarsden" created="Sat, 8 Sep 2007 19:05:37 +0100"  >&lt;p&gt;Attached is a patch for this issue.  I am not sure how to cover or even if I can cover the changes in NewInvocationNode.java, but made those changes just based on the fact that it looked like the codepath was impacted.  &lt;/p&gt;

&lt;p&gt;Please review&lt;/p&gt;
</comment>
                            <comment id="12526345" author="mamtas" created="Tue, 11 Sep 2007 05:42:04 +0100"  >&lt;p&gt;Kathey, thanks for your work on this non-trivial bug. The patch looks good. I had 2 minor comments&lt;br/&gt;
1)Following is part of the changes for StaticMethodCallNode &lt;br/&gt;
+	returnValueToJava.setCollationType(returnType.getCollationType());&lt;br/&gt;
+                         returnValueDtd.setCollationDerivation(StringDataValue.COLLATION_DERIVATION_IMPLICIT);&lt;br/&gt;
Should the 2nd line say returnValueToJava.setCollationDerivation(StringDataValue.COLLATION_DERIVATION_IMPLICIT);?&lt;/p&gt;

&lt;p&gt;2)Also, can you please add some negative tests for user functions too? One negative test I can think of is failure when using user function in a collation operation against a system character column and then a test to show that CAST will fix that problem. &lt;/p&gt;
</comment>
                            <comment id="12526522" author="kmarsden" created="Tue, 11 Sep 2007 17:51:46 +0100"  >&lt;p&gt;Thanks Mamta for the review. On item 1 the second line is not needed as the derivation is set in JavaToSQLValueNode.  For the tests I had a negative test for a system function, but I added positive/negative test for the table function SYSCS_DIAG.LOCK_TABLE as well. I checked into trunk. I will port to 10.3 as soon as tests complete.&lt;/p&gt;
</comment>
                            <comment id="12526582" author="djd" created="Tue, 11 Sep 2007 21:01:56 +0100"  >&lt;p&gt;The commit  comment (Revision: 574674) doesn&apos;t describe how the issue was fixed, neither do any of the comments here. Can you clarify what direction you took in the patch?&lt;/p&gt;</comment>
                            <comment id="12526589" author="kmarsden" created="Tue, 11 Sep 2007 21:18:06 +0100"  >&lt;p&gt;Per the wiki page and Mamta&apos;s suggestion the patch the collation will match the collation of the schema where the function is defined.  This means that for TERRITORY_BASED collation database, users executing a query like:&lt;br/&gt;
&quot;select * from SYSCS_DIAG.LOCK_TABLE where tablename = &apos;LOCKFUNCTESTTABLE&apos;&quot;&lt;/p&gt;

&lt;p&gt;will need to either switch to the SYS schema or cast e.g:&lt;br/&gt;
select * from SYSCS_DIAG.LOCK_TABLE where CAST(tablename as VARCHAR(128))= &apos;LOCKFUNCTESTTABLE&lt;/p&gt;

&lt;p&gt;The collation type is stored in the RoutineAliasInfo from an earlier patch, so it gets the collation type from there.&lt;br/&gt;
To propogate the collation type from the nodes where it is available to SQLToJavaValueNode, I added setCollationType()/getCollationType methods to JavaValueNode.&lt;/p&gt;

&lt;p&gt;SQLToJavaValueNode always sets the derivation to StringDataValue.COLLATION_DERIVATION_IMPLICIT&lt;/p&gt;</comment>
                            <comment id="12526605" author="djd" created="Tue, 11 Sep 2007 22:10:06 +0100"  >&lt;p&gt;&amp;gt; or cast e.g:&lt;br/&gt;
&amp;gt; select * from SYSCS_DIAG.LOCK_TABLE where CAST(tablename as VARCHAR(128))= &apos;LOCKFUNCTESTTABLE &lt;/p&gt;

&lt;p&gt;That query will be using the incorrect collation and thus should not be used or recommended.&lt;br/&gt;
System information is collated using UCS_BASIC collation, any queries that deviate from that for reporting system information should not be recommended.&lt;/p&gt;</comment>
                            <comment id="12526607" author="kmarsden" created="Tue, 11 Sep 2007 22:23:45 +0100"  >&lt;p&gt;So is true then to say that for system table queries, or using system functions or system table functions, we recommend switching to the SYS schema?  I ask, because in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2962&quot; title=&quot;Change functional tests to use casts for System table queries to avoid conversion errors when run with TERRITORY_BASED collation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2962&quot;&gt;&lt;del&gt;DERBY-2962&lt;/del&gt;&lt;/a&gt; I went through and changed all the system queries to use casts to avoid conversion errors.  Was that the wrong thing to do?&lt;/p&gt;
</comment>
                            <comment id="12526619" author="djd" created="Tue, 11 Sep 2007 23:06:35 +0100"  >&lt;p&gt;Well these two statements are &lt;b&gt;not&lt;/b&gt; equivalent:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;in any system schema&amp;#93;&lt;/span&gt;&lt;br/&gt;
select * from SYSCS_DIAG.LOCK_TABLE where tablename = &apos;LOCKFUNCTESTTABLE&apos;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;in a user schema in a territory based collation database&amp;#93;&lt;/span&gt;&lt;br/&gt;
select * from SYSCS_DIAG.LOCK_TABLE where CAST(tablename as VARCHAR(128))= &apos;LOCKFUNCTESTTABLE&apos;&lt;/p&gt;

&lt;p&gt;The equality predicate for the first statement matches the comparison rules Derby uses for SQL identifiers.&lt;/p&gt;

&lt;p&gt;The equality predicate for the second statement doesn&apos;t match  the comparison rules Derby uses for SQL identifiers.&lt;/p&gt;

&lt;p&gt;For any query in a test maybe the difference doesn&apos;t matter, but for recommending the correct approach for users it does.&lt;/p&gt;

&lt;p&gt;Note that using parameter markers makes this problem go away, since the equality will match how Derby looks up SQL identifiers.:&lt;/p&gt;

&lt;p&gt;select * from SYSCS_DIAG.LOCK_TABLE where tablename = ?&lt;/p&gt;


</comment>
                            <comment id="12527577" author="kmarsden" created="Fri, 14 Sep 2007 18:36:08 +0100"  >&lt;p&gt;Fixed and ported to 10.3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12369433">DERBY-2656</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12364932" name="derby-2972_diff.txt" size="5734" author="kmarsden" created="Sat, 1 Sep 2007 00:05:12 +0100"/>
                            <attachment id="12364933" name="derby-2972_stat.txt" size="167" author="kmarsden" created="Sat, 1 Sep 2007 00:05:12 +0100"/>
                            <attachment id="12365404" name="derby_2972_diff.txt" size="11508" author="kmarsden" created="Sat, 8 Sep 2007 19:05:36 +0100"/>
                            <attachment id="12365405" name="derby_2972_stat.txt" size="471" author="kmarsden" created="Sat, 8 Sep 2007 19:05:37 +0100"/>
                            <attachment id="12365401" name="tempFunction_diff.txt" size="66575" author="mamtas" created="Sat, 8 Sep 2007 16:33:22 +0100"/>
                            <attachment id="12365402" name="tempFunction_stat.txt" size="941" author="mamtas" created="Sat, 8 Sep 2007 16:33:22 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 17 Aug 2007 14:58:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23353</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy1133:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39826</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>