<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:18 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3009/DERBY-3009.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3009] Out of memory error when creating a very large table</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3009</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When creating an extremely large table (c.50 indexes, c.50 FK constraints), IJ crashes with an out of memory error. The table can be created successfully if it is done in stages, each one in a different IJ session.&lt;/p&gt;

&lt;p&gt;From Kristian Waagan:&lt;/p&gt;

&lt;p&gt;&quot;With default settings on my machine, I also get the OOME.&lt;br/&gt;
A brief investigation revealed a few things:&lt;/p&gt;

&lt;p&gt;  1) The OOME occurs during constraint additions (with ALTER TABLE ... &lt;br/&gt;
ADD CONSTRAINT). I could observe this by monitoring the heap usage.&lt;/p&gt;

&lt;p&gt;  2) The complete script can be run by increasing the heap size. I tried with 256 MB, but the monitoring showed usage peaked at around 150 MB.&lt;/p&gt;

&lt;p&gt;  3) The stack traces produced when the OOME occurs varies (as could be expected).&lt;/p&gt;

&lt;p&gt;  4) It is the Derby engine that &quot;produce&quot; the OOME, not ij (i.e. when I ran with the network server, the server failed).&lt;/p&gt;

&lt;p&gt;I have not had time to examine the heap content, but I do believe there is a bug in Derby. It seems some resource is not freed after use.&quot;&lt;/p&gt;</description>
                <environment>Win XP Pro</environment>
        <key id="12376030">DERBY-3009</key>
            <summary>Out of memory error when creating a very large table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="tarby777">Nick Williamson</reporter>
                        <labels>
                            <label>derby_triage10_5_2</label>
                    </labels>
                <created>Wed, 15 Aug 2007 09:58:27 +0100</created>
                <updated>Mon, 17 Jun 2013 10:19:11 +0100</updated>
                            <resolved>Fri, 16 Mar 2012 16:21:18 +0000</resolved>
                                    <version>10.5.3.0</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="12519901" author="tarby777" created="Wed, 15 Aug 2007 10:00:58 +0100"  >&lt;p&gt;If you create a new database and run derby-3009.sql in an IJ session running on default values, you will experience the out-of-memory error.&lt;/p&gt;</comment>
                            <comment id="12520030" author="djd" created="Wed, 15 Aug 2007 17:37:42 +0100"  >&lt;p&gt;May not be related but in addressing &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3008&quot; title=&quot;The forCreateTable state of a CreateConstantAction or CreateIndexConstantAction should be a state of the actions, not of the activation.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3008&quot;&gt;DERBY-3008&lt;/a&gt; it seemed that even when a table is being created CreateIndexConstantAction scans the table and sets up a sorter to populate the index. Of course when creating a table there will be no rows so it&apos;s wasted work. In this case with up to 100 indexes maybe that&apos;s a factor.&lt;br/&gt;
I didn&apos;t fully check that CreatetableConstantAction does scan the table &amp;amp; sort when creating the table, it was just a quick glance at the code.&lt;/p&gt;</comment>
                            <comment id="12542608" author="abrown23" created="Wed, 14 Nov 2007 22:10:09 +0000"  >&lt;p&gt;I have run accross this issue also and I narrowed it down to index building.  I have a few tables with 10-30 million records and when building indexes on them I can watch the memory used grow until it crashes.  The only way around this for me has been to restart Derby after each index is built (not really a good thing is a production environment).  This happens both in IJ and through a java application.  We changed the  java code to commit and close the connection after each index build and that seemed to help, but the problem would still manifest itself.&lt;/p&gt;

&lt;p&gt;I played around with some of the memory settings and by setting derby.storage.pageSize to a bigger size than the default size, this just caused the crash to happen faster.  I am not a Java developer but it seems that once an index is built, the buffer still has a lock on the memory and it isn&apos;t being freed.&lt;/p&gt;</comment>
                            <comment id="12545913" author="tarby777" created="Tue, 27 Nov 2007 16:55:52 +0000"  >&lt;p&gt;Thanks for that, Andrew. It must be a different thing in my case, as my&lt;br/&gt;
tables are empty; it&apos;s a big (500+ tables) schema with one particularly&lt;br/&gt;
large and complex table, and it seems to be too much for Derby to handle&lt;br/&gt;
in one go. I guess there&apos;s some generic weakness in Derby that holds&lt;br/&gt;
onto resources when processing DDL, and any number of things can trigger&lt;br/&gt;
it...&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Nick&lt;/p&gt;


</comment>
                            <comment id="12586691" author="gekhin" created="Tue, 8 Apr 2008 08:23:08 +0100"  >&lt;p&gt;I just came across the same effect as Andrew Brown mentioned in his comment: A couple of ALTER TABLE ADD CONSTRAINT FOREIGN KEY statements on a couple of non-empty tables (the biggest of about 150k rows) caused an OOME. And the OOME doesn&apos;t happen when restarting the database process before each ALTER TABLE statement.&lt;/p&gt;

&lt;p&gt;But it seems to me that this effect doesn&apos;t match the description of this JIRA entry. So my question is: Is this effect already known and honoured in a separate JIRA entry?&lt;/p&gt;</comment>
                            <comment id="12708918" author="nathanboy" created="Wed, 13 May 2009 14:40:00 +0100"  >&lt;p&gt;I have this problem as well, using both Derby 10.5.1.1 and 10.4.2.0 in an embedded client.  I have a schema of about 16 tables, a few of which generally have 200-300k rows.  All of the data is loaded in, and then foreign key constraints are added one by one.  I tried committing between each ADD CONSTRAINT statement, but this did not seem to have any effect.  I still run out of memory even when heap size is set to 2-3 gb.  I have not tried shutting down and starting up the database between each add constraint statement.  I will try this next.&lt;/p&gt;</comment>
                            <comment id="12709054" author="hallorant" created="Wed, 13 May 2009 19:28:26 +0100"  >&lt;p&gt;Also seeing what appears to be this problem on Derby 10.5.1.1 (on Windows I can&apos;t get the heap up above 1.5 GB-ish)&lt;/p&gt;</comment>
                            <comment id="12727663" author="rhillegas" created="Mon, 6 Jul 2009 19:14:41 +0100"  >&lt;p&gt;Triaged for 10.5.2: noted that repro is available.&lt;/p&gt;</comment>
                            <comment id="12728784" author="kmarsden" created="Wed, 8 Jul 2009 17:43:19 +0100"  >&lt;p&gt;Marking urgency normal. This is not a regression won&apos;t make it for 10.5.2.&lt;/p&gt;</comment>
                            <comment id="12976743" author="hg8496" created="Mon, 3 Jan 2011 14:00:17 +0000"  >&lt;p&gt;Also seeing what appears to be this problem on Derby 10.7.1.1&lt;br/&gt;
Any progress on this topic?&lt;/p&gt;</comment>
                            <comment id="12996229" author="brettw" created="Fri, 18 Feb 2011 03:16:49 +0000"  >&lt;p&gt;I am seeing the same issue as Nathan Boy commented on in May 2009.  Performing an ALTER TABLE with ADD CONSTRAINT on a large table causes an OOM error.  Unless this issue is fixed, it will be impossible for us to upgrade customers&apos; databases in the field.&lt;/p&gt;</comment>
                            <comment id="13010160" author="knutanders" created="Wed, 23 Mar 2011 14:58:51 +0000"  >&lt;p&gt;Marking the issue as a crash since the memory leak may take down the database.&lt;/p&gt;</comment>
                            <comment id="13011699" author="knutanders" created="Sat, 26 Mar 2011 23:18:20 +0000"  >&lt;p&gt;The problem appears to be that references to table descriptors are leaked by AlterTableConstantAction (via the fields td and activation). The AlterTableConstantAction object isn&apos;t eligible for garbage collection until the corresponding statement has been evicted from the statement cache. The table descriptors may be of considerable because of all the constraints.&lt;/p&gt;

&lt;p&gt;The attached patch (derby-3009-1a.diff) clears these fields once the constant action has been executed. With the patch, I could run the repro with 16 MB heap space without seeing out of memory errors.&lt;/p&gt;</comment>
                            <comment id="13012018" author="knutanders" created="Mon, 28 Mar 2011 13:05:16 +0100"  >&lt;p&gt;Uploading an updated patch (1b) which adds a test case for this bug. The test case was added to the lowmem test suite, which limits the heap size to 16 MB. To test it, run &quot;ant junit-lowmem&quot;. It fails without the fix and passes when the fix is applied.&lt;/p&gt;

&lt;p&gt;All the regression tests ran cleanly with the fix.&lt;/p&gt;</comment>
                            <comment id="13012405" author="knutanders" created="Tue, 29 Mar 2011 10:24:42 +0100"  >&lt;p&gt;Committed revision 1086527.&lt;/p&gt;</comment>
                            <comment id="13012720" author="dagw" created="Tue, 29 Mar 2011 22:36:43 +0100"  >&lt;p&gt;Fix looks safe to me. I verified that without the code changes, the new lowmem test case fails. &lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="13012770" author="lilywei" created="Wed, 30 Mar 2011 00:25:36 +0100"  >&lt;p&gt;+1 for the fix. When I verified without code changes on windows 7, the new lowmem test case did not fail for me. I have to add to tables=200 and column=200 and run it with -Dderby.storage.pageCacheSize=4M. The test failed in the case above for me. However, I couldn&apos;t run ant lowmem. Either case, the test verified the fix is fixing memory leak issue. Thanks Knut.&lt;/p&gt;</comment>
                            <comment id="13012855" author="knutanders" created="Wed, 30 Mar 2011 07:40:53 +0100"  >&lt;p&gt;Thanks for testing the patch, Dag and Lily.&lt;/p&gt;

&lt;p&gt;Lily, if you run the new test case outside of the lowmem suite, you need to invoke JUnit with -Xmx16M in order to see the OOME. The ant target junit-lowmem adds that JVM argument automatically.&lt;/p&gt;</comment>
                            <comment id="13229384" author="kmarsden" created="Wed, 14 Mar 2012 17:19:48 +0000"  >&lt;p&gt;Reopen for 10.5 backport consideration. If working on the backport for this issue. Temporarily assign yourself and add a comment that you are working on it. When finished, reresolve with the new fix versions or label backport_reject_10_x as appropriate.&lt;/p&gt;</comment>
                            <comment id="13229692" author="kmarsden" created="Wed, 14 Mar 2012 22:19:01 +0000"  >&lt;p&gt;Assigning to myself for backport to 10.5&lt;/p&gt;</comment>
                            <comment id="13230370" author="kmarsden" created="Thu, 15 Mar 2012 17:58:37 +0000"  >&lt;p&gt;10.5 had to be merged manually. Attaching patch derby-3009_10_5_diff.txt&lt;/p&gt;</comment>
                            <comment id="13231337" author="kmarsden" created="Fri, 16 Mar 2012 16:21:18 +0000"  >&lt;p&gt;Completed merge back to 10.5. Assigning back to Knut and resolving.&lt;/p&gt;</comment>
                            <comment id="13685152" author="knutanders" created="Mon, 17 Jun 2013 10:19:11 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12546430">DERBY-5654</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12363832" name="DERBY-3009.zip" size="65252" author="tarby777" created="Wed, 15 Aug 2007 10:00:56 +0100"/>
                            <attachment id="12474714" name="derby-3009-1a.diff" size="2029" author="knutanders" created="Sat, 26 Mar 2011 23:18:20 +0000"/>
                            <attachment id="12474768" name="derby-3009-1b.diff" size="6008" author="knutanders" created="Mon, 28 Mar 2011 13:05:16 +0100"/>
                            <attachment id="12518490" name="derby-3009_10_5_diff.txt" size="2509" author="kmarsden" created="Thu, 15 Mar 2012 17:58:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 15 Aug 2007 16:37:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23374</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0cnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35870</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>