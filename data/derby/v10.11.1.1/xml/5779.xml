<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:44:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5779/DERBY-5779.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5779] Table functions should only accept arguments which are constant in their query block.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5779</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Derby lets you invoke a table function in the FROM list of a query, passing in arguments built out of columns in other tables in the FROM list. This syntax is illegal and the resulting queries have no meaning under the SQL Standard. See the discussion on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5554&quot; title=&quot;NullPointerException in generated VTI code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5554&quot;&gt;&lt;del&gt;DERBY-5554&lt;/del&gt;&lt;/a&gt;. We should forbid this syntax. Similar syntax involving correlated subqueries in the FROM list is already forbidden. Fixing this will create a backward incompatibility which requires a release note.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12557004">DERBY-5779</key>
            <summary>Table functions should only accept arguments which are constant in their query block.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_backport_reject_10_9</label>
                    </labels>
                <created>Wed, 23 May 2012 14:55:59 +0100</created>
                <updated>Mon, 2 Jun 2014 13:37:25 +0100</updated>
                            <resolved>Fri, 28 Jun 2013 00:02:15 +0100</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13290120" author="rhillegas" created="Wed, 6 Jun 2012 13:54:19 +0100"  >&lt;p&gt;Derby relies on the illegal syntax for some of its internal metadata queries. For instance, the getFunctionColumns() query (in metadata.properties) involves a join, in the FROM list, between a VTI&apos;s arguments and columns from other tables in the FROM list. This raises the following red flags:&lt;/p&gt;

&lt;p&gt;1) Fixing the syntax may involve re-writing existing Derby metadata queries.&lt;/p&gt;

&lt;p&gt;2) The backward compatibility problem may be too big to contemplate.&lt;/p&gt;

&lt;p&gt;We may want to narrow the scope of this issue and just fix the problem for table functions, leaving Derby VTIs alone. We could probably back ourselves into the position that VTIs fall outside the SQL Standard. As a Derby extension, we can make up our own rules for them.&lt;/p&gt;

&lt;p&gt;The following phased approach might make sense:&lt;/p&gt;

&lt;p&gt;A) Add new overloads so that Derby table functions (like SYSCS_DIAG.SPACE_TABLE) can be invoked in a legal way.&lt;/p&gt;

&lt;p&gt;B) Change the documentation accordingly so that we no longer showcase illegal syntax.&lt;/p&gt;

&lt;p&gt;C) Make the bad syntax illegal for table functions, but leave VTIs alone.&lt;/p&gt;

&lt;p&gt;Later on, we may want to give some thought to what the illegal VTI syntax means. It may have a well-defined meaning provided that we can guarantee the join order which Derby chooses.&lt;/p&gt;</comment>
                            <comment id="13290246" author="dagw" created="Wed, 6 Jun 2012 17:34:09 +0100"  >&lt;p&gt;Sounds like a good plan to me. As long as we can&apos;t express the intent of the query in another way (maybe recursive SQL would enable it?), &lt;b&gt;and&lt;/b&gt; we can define the semantics precisely, I guess we could retain the syntax for VTIs.&lt;/p&gt;</comment>
                            <comment id="13398498" author="rhillegas" created="Thu, 21 Jun 2012 16:36:13 +0100"  >&lt;p&gt;Attaching derby-5779-01-ab-forbidReferencesInQueryBlock.diff. This patch prevents table function parameters from referring to other tables in the same query block. I am running regression tests now.&lt;/p&gt;

&lt;p&gt;There already was a place in the bind() logic for table functions where we dug up column references inside parameter expressions. I simply inserted another check there.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;---------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/loc/messages.xml&lt;br/&gt;
M       java/shared/org/apache/derby/shared/common/reference/SQLState.java&lt;/p&gt;

&lt;p&gt;Added a new error message for this condition. I considered re-using 42X04, which we use for the parallel error with correlated subqueries in the FROM list. However, I think that message is already too long, complicated, and confusing.&lt;/p&gt;

&lt;p&gt;---------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/FromVTI.java&lt;/p&gt;

&lt;p&gt;The actual fix.&lt;/p&gt;

&lt;p&gt;---------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/TableFunctionTest.java&lt;/p&gt;

&lt;p&gt;New tests.&lt;/p&gt;</comment>
                            <comment id="13398617" author="rhillegas" created="Thu, 21 Jun 2012 18:32:05 +0100"  >&lt;p&gt;Tests passed cleanly for me on derby-5779-01-ab-forbidReferencesInQueryBlock.diff. Committed at subversion revision 1352631.&lt;/p&gt;</comment>
                            <comment id="13398797" author="rhillegas" created="Thu, 21 Jun 2012 20:48:39 +0100"  >&lt;p&gt;Attaching the first rev of a release note for this issue.&lt;/p&gt;</comment>
                            <comment id="13398802" author="rhillegas" created="Thu, 21 Jun 2012 20:53:10 +0100"  >&lt;p&gt;Resolving this issue. Because of the scope of the backward incompatibility, I think that we should not port this fix to older release branches.&lt;/p&gt;</comment>
                            <comment id="13411575" author="rhillegas" created="Wed, 11 Jul 2012 15:36:42 +0100"  >&lt;p&gt;Re-opening this issue. Another variant of this problem occurs when table functions and diagnostic VTIs are factors in a &amp;lt;joined table&amp;gt; expression and they take arguments built out of columns from other tables in the &amp;lt;joined table&amp;gt; expression. This is another example of violating part 2 of the SQL Standard, section 7.6 (&amp;lt;table reference&amp;gt;), Syntax Rule 6.a. Right now these queries do not even run. They raise NPEs and compiler assertions. We should raise a proper exception when trying to compile this illegal syntax. The following script shows how the bad syntax currently results in NPEs and compiler assertions:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create function lowerCaseRow( contents varchar( 32672 ) )&lt;br/&gt;
returns table&lt;br/&gt;
(&lt;br/&gt;
    contents varchar( 32672 )&lt;br/&gt;
)&lt;br/&gt;
language java parameter style DERBY_JDBC_RESULT_SET no sql&lt;br/&gt;
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.TableFunctionTest.lowerCaseRow&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; NPEs&lt;br/&gt;
select tt.* from table(syscs_diag.space_table(st.tablename)) tt join sys.systables st using(tableid);&lt;br/&gt;
select tt.* from table( lowerCaseRow(st.tablename)) tt join sys.systables st on tt.contents = st.tablename;&lt;/p&gt;

&lt;p&gt;&amp;#8211; Compiler assertions&lt;br/&gt;
select tt.* from table(syscs_diag.space_table(st.tablename)) tt right join sys.systables st using(tableid);&lt;br/&gt;
select tt.* from table( lowerCaseRow(st.tablename)) tt right join sys.systables st on tt.contents = st.tablename;&lt;/p&gt;</comment>
                            <comment id="13411915" author="rhillegas" created="Wed, 11 Jul 2012 21:03:25 +0100"  >&lt;p&gt;Attaching derby-5779-02-aa-forbidReferencesToJoinedTables.diff. This patch makes it illegal to join VTI arguments to other tables in &amp;lt;joined table&amp;gt; clauses. I will run regression tests.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;---------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/FromVTI.java&lt;/p&gt;

&lt;p&gt;Continue to refine the logic in FromVTI.bindExpressions() in order to forbid these additional cases.&lt;/p&gt;

&lt;p&gt;---------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/TableFunctionTest.java&lt;/p&gt;

&lt;p&gt;Add more test cases.&lt;/p&gt;</comment>
                            <comment id="13412058" author="rhillegas" created="Wed, 11 Jul 2012 23:08:26 +0100"  >&lt;p&gt;Tests passed cleanly for me on derby-5779-02-aa-forbidReferencesToJoinedTables.diff.&lt;/p&gt;</comment>
                            <comment id="13412891" author="rhillegas" created="Thu, 12 Jul 2012 16:54:20 +0100"  >&lt;p&gt;Committed derby-5779-02-aa-forbidReferencesToJoinedTables.diff at subversion revision 1360736.&lt;/p&gt;</comment>
                            <comment id="13413048" author="rhillegas" created="Thu, 12 Jul 2012 19:29:26 +0100"  >&lt;p&gt;Attaching derby-5779-03-aa-moreTests.diff. This adds tests for more &amp;lt;joined table&amp;gt; cases. Committed at subversion revision 1360846.&lt;/p&gt;

&lt;p&gt;Touches the following file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/TableFunctionTest.java&lt;/p&gt;</comment>
                            <comment id="13413056" author="rhillegas" created="Thu, 12 Jul 2012 19:37:40 +0100"  >&lt;p&gt;Another case which needs to be forbidden:&lt;/p&gt;

&lt;p&gt;Derby trips over a compiler assertion if an argument to a VTI/tableFunction in a subquery in the FROM list references another table in the FROM list. The following script shows this:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create function lowerCaseRow( contents varchar( 32672 ) )&lt;br/&gt;
returns table&lt;br/&gt;
(&lt;br/&gt;
    contents varchar( 32672 )&lt;br/&gt;
)&lt;br/&gt;
language java parameter style DERBY_JDBC_RESULT_SET no sql&lt;br/&gt;
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.TableFunctionTest.lowerCaseRow&apos;;&lt;/p&gt;

&lt;p&gt;create table t1 (a int);&lt;/p&gt;

&lt;p&gt;&amp;#8211; ok&lt;br/&gt;
select tt.*&lt;br/&gt;
    from&lt;br/&gt;
        sys.systables systabs,&lt;br/&gt;
        ( select * from table (syscs_diag.space_table( &apos;T1&apos; )) as t2 ) tt&lt;br/&gt;
    where systabs.tabletype = &apos;T&apos; and systabs.tableid = tt.tableid;&lt;br/&gt;
select tt.*&lt;br/&gt;
    from&lt;br/&gt;
        sys.systables systabs,&lt;br/&gt;
        ( select * from table (lowerCaseRow( &apos;T1&apos; )) as t2 ) tt&lt;br/&gt;
    where systabs.tabletype = &apos;T&apos; and systabs.tablename = tt.contents;&lt;/p&gt;

&lt;p&gt;&amp;#8211; raises compiler assertions&lt;br/&gt;
select tt.*&lt;br/&gt;
    from&lt;br/&gt;
        sys.systables systabs,&lt;br/&gt;
        ( select * from table (syscs_diag.space_table( systabs.tablename )) as t2 ) tt&lt;br/&gt;
    where systabs.tabletype = &apos;T&apos; and systabs.tableid = tt.tableid;&lt;br/&gt;
select tt.*&lt;br/&gt;
    from&lt;br/&gt;
        sys.systables systabs,&lt;br/&gt;
        ( select * from table (lowerCaseRow( systabs.tablename )) as t2 ) tt&lt;br/&gt;
    where systabs.tabletype = &apos;T&apos; and systabs.tablename = tt.contents;&lt;/p&gt;</comment>
                            <comment id="13413999" author="rhillegas" created="Fri, 13 Jul 2012 20:56:43 +0100"  >&lt;p&gt;Attaching derby-5779-04-aa-subqueriesInFromList.diff. This is the first rev of a patch to forbid the problem identified above with subqueries in the FROM list. This patch is not ready for commit. I need to add more test cases and run regression tests.&lt;/p&gt;</comment>
                            <comment id="13415185" author="rhillegas" created="Mon, 16 Jul 2012 15:40:43 +0100"  >&lt;p&gt;Attaching derby-5779-04-ab-subqueriesInFromList.diff. Second rev of patch to fix correlated references to outer tables by arguments to VTIs/tableFunctions invoked inside subqueries. I am running regression tests now.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;----------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/FromSubquery.java&lt;/p&gt;

&lt;p&gt;At bind time, a subquery in the FROM list now pokes the FROM list into any VTIs invoked inside it.&lt;/p&gt;

&lt;p&gt;----------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/FromVTI.java&lt;/p&gt;

&lt;p&gt;When binding VTI arguments, we check to see if they contain correlated references to outer query blocks. If so, we make sure that those references are not to tables on the FROM lists which were poked into the VTI by outer subqueries.&lt;/p&gt;

&lt;p&gt;----------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/FromBaseTable.java&lt;/p&gt;

&lt;p&gt;We hit an NPE if we permute the join order, putting the subquery in the FROM list ahead of the tables referenced by args in its nested VTIs. We replace that NPE with an error message saying that we have detected an illegal reference in a VTI argument.&lt;/p&gt;


&lt;p&gt;----------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/loc/messages.xml&lt;/p&gt;

&lt;p&gt;We reword the 42ZB7 message to reflect the fact that it is being raised in more situations now.&lt;/p&gt;

&lt;p&gt;----------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/TableFunctionTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SysDiagVTIMappingTest.java&lt;/p&gt;

&lt;p&gt;Additional test cases.&lt;/p&gt;</comment>
                            <comment id="13415429" author="rhillegas" created="Mon, 16 Jul 2012 18:37:12 +0100"  >&lt;p&gt;Tests passed cleanly on derby-5779-04-ab-subqueriesInFromList.diff. Committed at subversion revision 1362159.&lt;/p&gt;</comment>
                            <comment id="13417399" author="rhillegas" created="Wed, 18 Jul 2012 20:37:05 +0100"  >&lt;p&gt;Resolving this issue again. We can re-open the issue if we discover other instances of this bad syntax.&lt;/p&gt;</comment>
                            <comment id="13695146" author="mikem" created="Fri, 28 Jun 2013 00:02:09 +0100"  >&lt;p&gt;fix adds a backword incompatibility so should not be backported.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12536241">DERBY-5554</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12717893">DERBY-6593</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12532886" name="derby-5779-01-ab-forbidReferencesInQueryBlock.diff" size="8186" author="rhillegas" created="Thu, 21 Jun 2012 16:36:13 +0100"/>
                            <attachment id="12536101" name="derby-5779-02-aa-forbidReferencesToJoinedTables.diff" size="5242" author="rhillegas" created="Wed, 11 Jul 2012 21:03:25 +0100"/>
                            <attachment id="12536254" name="derby-5779-03-aa-moreTests.diff" size="4965" author="rhillegas" created="Thu, 12 Jul 2012 19:29:26 +0100"/>
                            <attachment id="12536443" name="derby-5779-04-aa-subqueriesInFromList.diff" size="9535" author="rhillegas" created="Fri, 13 Jul 2012 20:56:43 +0100"/>
                            <attachment id="12536638" name="derby-5779-04-ab-subqueriesInFromList.diff" size="18168" author="rhillegas" created="Mon, 16 Jul 2012 15:40:43 +0100"/>
                            <attachment id="12532931" name="releaseNote.html" size="3235" author="rhillegas" created="Thu, 21 Jun 2012 20:48:39 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 Jun 2012 16:34:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245872</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0b3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35615</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>