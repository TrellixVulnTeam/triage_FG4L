<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:44:20 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5578/DERBY-5578.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5578] Provide a way to invalidate stored prepared statements</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5578</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;In various support situations I have seen problems with JDBC metadata stored prepared statements or trigger stored prepared statements that need to be invalidated.  It would be nice to have a way to do this in the field.  For 10.9 a stored procedure would make most sense, but it would be good to have something available in the release branches too.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12539173">DERBY-5578</key>
            <summary>Provide a way to invalidate stored prepared statements</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jan 2012 17:09:46 +0000</created>
                <updated>Wed, 3 Sep 2014 09:31:23 +0100</updated>
                            <resolved>Sat, 9 Jun 2012 00:23:10 +0100</resolved>
                                                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                            <comments>
                            <comment id="13271745" author="mamtas" created="Wed, 9 May 2012 21:04:14 +0100"  >&lt;p&gt;Was wondering, would only a dba have permissions to invalidate the prepared statements?&lt;/p&gt;</comment>
                            <comment id="13272754" author="dagw" created="Thu, 10 May 2012 21:56:31 +0100"  >&lt;p&gt;For field work-arounds I would imagine DBO access would suffice.&lt;/p&gt;</comment>
                            <comment id="13285817" author="mamtas" created="Wed, 30 May 2012 17:54:35 +0100"  >&lt;p&gt;Attaching a patch which adds the new stored procedure which will invalidate all the stored statements. Next execution of the statement will cause it to recompile. I will work next on adding regression tests and upgrade tests.&lt;/p&gt;</comment>
                            <comment id="13285919" author="knutanders" created="Wed, 30 May 2012 20:00:32 +0100"  >&lt;p&gt;Maybe we should call it something like SYSCS_INVALIDATE_STORED_STATEMENTS, just so that it&apos;s clear from the name that it doesn&apos;t invalidate ordinary statements?&lt;/p&gt;</comment>
                            <comment id="13285967" author="mamtas" created="Wed, 30 May 2012 21:00:40 +0100"  >&lt;p&gt;Knut, I think that&apos;s a good idea to include STORED in the procedure name to indicate that we are only going to invalidate stored prepared statements. I will make the procedure name change.&lt;/p&gt;</comment>
                            <comment id="13286234" author="mamtas" created="Thu, 31 May 2012 01:43:57 +0100"  >&lt;p&gt;While writing one of the tests for this procedure, I saw that, as a dba, I was able to grant the execute permission on this procedure to another user.&lt;br/&gt;
grant execute on procedure syscs_util.SYSCS_INVALIDATE_STORED_STATEMENTS to sam;&lt;/p&gt;

&lt;p&gt;But a similar grant on sysibm.sqlprocedures by dbo to another user fails&lt;br/&gt;
grant execute on procedure sysibm.sqlprocedures to sam;&lt;br/&gt;
ERROR 42509: Specified grant or revoke operation is not allowed on object &apos;SYSIBM.SQLPROCEDURES&apos;.&lt;/p&gt;

&lt;p&gt;Looking at the code, I found that SchemaDescriptor.isSchemaWithGrantableRoutines() identifies SQLJ and SYSCS_UTIL as schemas which allows grant on it&apos;s routines. And that is why we were able to grant execute on syscs_util.SYSCS_INVALIDATE_STORED_STATEMENTS but not on sysibm.sqlprocedures.&lt;/p&gt;

&lt;p&gt;So, the question is should the new procedure for invalidating stored statements have grantable execute permission? If not, then should we move it to some other schema like sysibm which does not allow grant execute permission on it&apos;s procedures?&lt;/p&gt;</comment>
                            <comment id="13286292" author="mamtas" created="Thu, 31 May 2012 04:49:53 +0100"  >&lt;p&gt;As per my understanding, SYSSTATEMENTS will only has two kinds stored prepared statements - for metadata queries and for trigger action plan. Please let me know if there are other possibilities. I am working on writing tests and want to make sure that I provide test cases covering different kinds of stored statements. Thanks&lt;/p&gt;</comment>
                            <comment id="13286383" author="knutanders" created="Thu, 31 May 2012 08:19:49 +0100"  >&lt;p&gt;I don&apos;t see any reason why we&apos;d want to deny the DBO&apos;s granting the execute permission on this procedure, so +1 to keeping it in SYSCS_UTIL.&lt;/p&gt;

&lt;p&gt;I think you&apos;re right that only meta-data queries and triggers are stored in SYSSTATEMENTS. It looks like there used to be syntax for CREATE STATEMENT, which allowed user-defined queries to be stored there too, but that syntax is disabled now.&lt;/p&gt;</comment>
                            <comment id="13287638" author="mamtas" created="Fri, 1 Jun 2012 21:12:55 +0100"  >&lt;p&gt;Attaching patch DERBY5578_patch2_diff.txt which is ready for commit. This patch has required code changes to add a new procedure which will allow users to invalidate all the stored statements inside SYS.SYSSTATEMENTS. At this point, there are two types of stored statements in that system table - statements for metadata calls and statements for trigger action plans. I have also added test cases including the regression tests and upgrade tests. Upgrade tests show that this procedure is available only after hard upgrade. Regression test show how the procedure can be executed only by dba unless dba grants execute permission to other users. Additionally, it has test cases showing statements getting invalidated by the procedure call and subsequent execution of metadata call or trigger causing their corresponding statements to become valid.&lt;/p&gt;

&lt;p&gt;Please let me know if there is any feedback on the code changes or any other test cases I should add. &lt;/p&gt;

&lt;p&gt;The changes for this jira can only go in as part of a major release since it fiddles around wit system tables. This jira can&apos;t be backported to released branches.&lt;/p&gt;

&lt;p&gt;If Rick sees a need to cut another 10.9 release jars, we can backport it to 10.9 but otherwise it will need to go into next major release. &lt;/p&gt;</comment>
                            <comment id="13287691" author="dagw" created="Fri, 1 Jun 2012 22:35:27 +0100"  >&lt;p&gt;&amp;gt; I don&apos;t see any reason why we&apos;d want to deny the DBO&apos;s granting the execute permission on this procedure, so +1 to keeping it in SYSCS_UTIL. &lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13288466" author="knutanders" created="Mon, 4 Jun 2012 11:11:41 +0100"  >&lt;p&gt;The upgrade test should probably go into Changes10_10, since that&apos;s the current version of trunk. And maybe the new helper methods in TriggerTest should close the ResultSets. Otherwise, the patch looks good to me.&lt;/p&gt;

&lt;p&gt;Nits: Some small typos in the comments in TriggerTest that you might want to fix:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;Creat the required tables&quot; - creat -&amp;gt; create&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;It&apos;s trigger action&quot; - It&apos;s -&amp;gt; Its&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;trigger action with have&quot; - with -&amp;gt; will&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="13292088" author="mamtas" created="Sat, 9 Jun 2012 00:22:26 +0100"  >&lt;p&gt;Knut, thanks for reviwing the patch. I have made the changes suggested by you and committed the changes to trunk(10.10)&lt;/p&gt;</comment>
                            <comment id="13484969" author="rhillegas" created="Fri, 26 Oct 2012 15:46:40 +0100"  >&lt;p&gt;Attaching derby-5578-create.sql and derby-5578-upgrade.sql. These are scripts which I used to buddy-test this feature. The first script relies on the wrapper DatabaseMetaData functions attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3973&quot; title=&quot;Create function wrappers for DatabaseMetaData so that you can join metadata results in queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3973&quot;&gt;&lt;del&gt;DERBY-3973&lt;/del&gt;&lt;/a&gt;. Here&apos;s how you run these scripts:&lt;/p&gt;

&lt;p&gt;o First run derby-5578-create.sql using an earlier release like 10.8.2.2. This script creates a trigger and registers functions to wrap the DatabaseMetaData methods.&lt;/p&gt;

&lt;p&gt;o Then run derby-5578-upgrade.sql using the 10.10 trunk. This script hard-upgrades the database, adding the new SYSCS_UTIL.SYSCS_INVALIDATE_STORED_STATEMENTS procedure.&lt;/p&gt;

&lt;p&gt;The scripts verify that SYSCS_INVALIDATE_STORED_STATEMENTS marks all stored prepared statements as invalid in SYS.SYSSTATEMENTS. The scripts verify that invoking the trigger after the invalidation causes it to be marked as valid and updates its lastcompiled timestamp. Those columns in SYS.SYSSTATEMENTS are similarly updated for a DatabaseMetaData method when you invoke it after the bulk invalidation.&lt;/p&gt;

&lt;p&gt;This indicates to me that SYSCS_INVALIDATE_STORED_STATEMENTS behaves as described in the Reference Manual.&lt;/p&gt;</comment>
                            <comment id="13485004" author="rhillegas" created="Fri, 26 Oct 2012 16:35:15 +0100"  >&lt;p&gt;The following script demonstrates what the Reference Manual says:&lt;/p&gt;

&lt;p&gt;o By default, only the DBO can run SYSCS_UTIL.SYSCS_INVALIDATE_STORED_STATEMENTS.&lt;/p&gt;

&lt;p&gt;o However, the DBO can grant other users the privilege to run this procedure.&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;create=true;user=test_dbo&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; turn on NATIVE authentication. won&apos;t take effect until you bounce the database.&lt;br/&gt;
call syscs_util.syscs_create_user( &apos;test_dbo&apos;, &apos;test_dbopassword&apos; );&lt;br/&gt;
call syscs_util.syscs_create_user( &apos;fred&apos;, &apos;fredpassword&apos; );&lt;/p&gt;

&lt;p&gt;&amp;#8211; bounce the database in order to turn on NATIVE authentication&lt;br/&gt;
connect &apos;jdbc:derby:memory:db;shutdown=true&apos;;&lt;br/&gt;
connect &apos;jdbc:derby:memory:db;user=test_dbo;password=test_dbopassword&apos; as dbo;&lt;/p&gt;

&lt;p&gt;&amp;#8211; the DBO can run this procedure&lt;br/&gt;
call syscs_util.syscs_invalidate_stored_statements();&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;user=fred;password=fredpassword&apos; as fred;&lt;/p&gt;

&lt;p&gt;&amp;#8211; should fail because privilege has not been granted&lt;br/&gt;
call syscs_util.syscs_invalidate_stored_statements();&lt;/p&gt;

&lt;p&gt;set connection dbo;&lt;/p&gt;

&lt;p&gt;--grant privilege to fred;&lt;br/&gt;
grant execute on procedure syscs_util.syscs_invalidate_stored_statements to fred;&lt;/p&gt;

&lt;p&gt;set connection fred;&lt;/p&gt;

&lt;p&gt;&amp;#8211; should work now that fred has been granted privilege&lt;br/&gt;
call syscs_util.syscs_invalidate_stored_statements();&lt;/p&gt;</comment>
                            <comment id="13603408" author="rhillegas" created="Fri, 15 Mar 2013 14:24:04 +0000"  >&lt;p&gt;Adding a release note based on the Reference Manual&apos;s description of the procedure.&lt;/p&gt;</comment>
                            <comment id="14119546" author="knutanders" created="Wed, 3 Sep 2014 09:31:23 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12530233" name="DERBY5578_patch1_diff.txt" size="3845" author="mamtas" created="Wed, 30 May 2012 17:54:35 +0100"/>
                            <attachment id="12530592" name="DERBY5578_patch2_diff.txt" size="15513" author="mamtas" created="Fri, 1 Jun 2012 21:12:55 +0100"/>
                            <attachment id="12550970" name="derby-5578-create.sql" size="856" author="rhillegas" created="Fri, 26 Oct 2012 15:46:40 +0100"/>
                            <attachment id="12550971" name="derby-5578-upgrade.sql" size="1147" author="rhillegas" created="Fri, 26 Oct 2012 15:46:40 +0100"/>
                            <attachment id="12573878" name="releaseNote.html" size="3486" author="rhillegas" created="Fri, 15 Mar 2013 14:24:04 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12558641">DERBY-5793</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 9 May 2012 20:04:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224675</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10423"><![CDATA[Newcomer]]></customfieldvalue>
    <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0bf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35668</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>