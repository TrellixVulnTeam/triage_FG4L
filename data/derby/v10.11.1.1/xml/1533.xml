<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:40:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1533/DERBY-1533.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1533] ArrayIndexOutOfBoundsException in DDMReader, on a specific data size</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1533</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;As far as I know, this bug is not related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-428&quot; title=&quot;NetworkClient PreparedStatement.executeBatch() hangs if batch is too large (ArrayIndexOutOfBoundsException in Network Server)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-428&quot;&gt;&lt;del&gt;DERBY-428&lt;/del&gt;&lt;/a&gt; bug.&lt;br/&gt;
I got this bug both on 10.1.3.1 and 10.1.2.1 - an ArrayIndexOutOfBoundsException in DDMReader (in Network Server).&lt;/p&gt;

&lt;p&gt;To reproduce the bug:&lt;br/&gt;
1. Compile the attached DerbyTest.java&lt;br/&gt;
2. Start the Network Server (startNetworkServer.bat under Windows)&lt;br/&gt;
3. Run: java DerbyTest&lt;/p&gt;

&lt;p&gt;On client side you get:&lt;br/&gt;
org.apache.derby.client.am.DisconnectException: The DDM object is not supported.  Unsupported DDM object code point: 0x0&lt;br/&gt;
        at org.apache.derby.client.net.NetConnectionReply.doObjnsprmSemantics(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetConnectionReply.parseCommonError(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.parseExecuteError(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.readExecute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.StatementReply.readExecute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetPreparedStatement.readExecute_(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.readExecute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.flowExecute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeX(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.execute(Unknown Source)&lt;br/&gt;
        at DerbyTest.main(DerbyTest.java:479)&lt;/p&gt;

&lt;p&gt;On server side you get:&lt;br/&gt;
java.lang.ArrayIndexOutOfBoundsException&lt;br/&gt;
        at java.lang.System.arraycopy(Native Method)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.compressBLayerData(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.ensureBLayerDataInBuffer(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.readNetworkShort(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.readLDStringData(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.readAndSetParams(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA_work(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;br/&gt;
agentThread&lt;span class=&quot;error&quot;&gt;&amp;#91;DRDAConnThread_11,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
null&lt;br/&gt;
java.lang.ArrayIndexOutOfBoundsException&lt;br/&gt;
        at java.lang.System.arraycopy(Native Method)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.compressBLayerData(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.ensureBLayerDataInBuffer(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.readNetworkShort(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.readLDStringData(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.readAndSetParams(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA_work(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;/p&gt;</description>
                <environment>--------- Derby Network Server Information --------&lt;br/&gt;
Version: CSS10011/10.1.3.1  Build: 417277  DRDA Product Id: CSS10011&lt;br/&gt;
-- listing properties --&lt;br/&gt;
derby.drda.maxThreads=0&lt;br/&gt;
derby.drda.keepAlive=true&lt;br/&gt;
derby.drda.minThreads=0&lt;br/&gt;
derby.drda.portNumber=1527&lt;br/&gt;
derby.drda.logConnections=false&lt;br/&gt;
derby.drda.timeSlice=0&lt;br/&gt;
derby.drda.startNetworkServer=false&lt;br/&gt;
derby.drda.host=localhost&lt;br/&gt;
derby.drda.traceAll=false&lt;br/&gt;
------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.4.2_08&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
OS name:         Windows XP&lt;br/&gt;
OS architecture: x86&lt;br/&gt;
OS version:      5.1&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.4&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: J2SE 1.4.2 - JDBC 3.0&lt;br/&gt;
[C:\dev\derby\lib\derby.jar] 10.1.3.1 - (417277)&lt;br/&gt;
[C:\dev\derby\lib\derbytools.jar] 10.1.3.1 - (417277)&lt;br/&gt;
[C:\dev\derby\lib\derbynet.jar] 10.1.3.1 - (417277)&lt;br/&gt;
------------------------------------------------------</environment>
        <key id="12346227">DERBY-1533</key>
            <summary>ArrayIndexOutOfBoundsException in DDMReader, on a specific data size</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="ender">Wiktor Lisowicz</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Jul 2006 10:00:17 +0100</created>
                <updated>Thu, 3 May 2007 21:10:12 +0100</updated>
                            <resolved>Thu, 3 May 2007 21:09:35 +0100</resolved>
                                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                                    <fixVersion>10.1.3.2</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12422062" author="ender" created="Wed, 19 Jul 2006 10:01:48 +0100"  >&lt;p&gt;A test to get the reported error&lt;/p&gt;</comment>
                            <comment id="12422063" author="ender" created="Wed, 19 Jul 2006 10:07:52 +0100"  >&lt;p&gt;I guess the problem lies around the &quot;private byte[] buffer&quot;&lt;br/&gt;
in the class &quot;org.apache.derby.impl.drda.DDMReader&quot; and has probably something to do with the &quot;DEFAULT_BUFFER_SIZE = 32767&quot;.&lt;/p&gt;

&lt;p&gt;The entered data (with DerbyTest.java) is about 32K.&lt;/p&gt;</comment>
                            <comment id="12422188" author="bryanpendleton" created="Wed, 19 Jul 2006 17:47:15 +0100"  >&lt;p&gt;Thanks for the bug report! I am able to reproduce this using your test program. I&apos;m going to be out of town for a couple weeks, but if nobody&apos;s figured this out by then, I&apos;ll take a look at it when I return.&lt;/p&gt;</comment>
                            <comment id="12422272" author="bryanpendleton" created="Wed, 19 Jul 2006 23:06:12 +0100"  >&lt;p&gt;Attached is &quot;DerbyTest2.java&quot;, a slight variant of DerbyTest.java, which demonstrates a completely different symptom, but I suspect that the two test programs are both exploiting the same underlying cause. &lt;/p&gt;

&lt;p&gt;DerbyTest.java causes a message from the client to the server to be segmented into two segments with one continuation header; DerbyTest2.java causes a message from the client to the server to be segmented into &lt;b&gt;five&lt;/b&gt; segments with four continuation headers.&lt;/p&gt;

&lt;p&gt;The symptoms that the two programs trigger are quite different, but I think that the underlying problem is that the server isn&apos;t processing the message segmentation continuation headers correctly.&lt;/p&gt;</comment>
                            <comment id="12422293" author="bryanpendleton" created="Thu, 20 Jul 2006 00:34:11 +0100"  >&lt;p&gt;I know I said I wasn&apos;t going to work on this bug until after I returned from vacation, but those darned DRDA protocol bugs are just too much fun! (Besides, I got my packing done early).&lt;/p&gt;

&lt;p&gt;I need to work up a complete proposal, with detailed notes, javadoc changes, regression tests, and so forth,  and of course run the full regression suite, but attached is &apos;ddmreader1.diff&apos; which is the core of a possible fix.&lt;/p&gt;

&lt;p&gt;I think there are two basic issues here:&lt;/p&gt;

&lt;p&gt;1) DDMReader.compressBLayerData seems to have a few small bugs involving the mechanics of de-segmenting a multi-segment message. I believe that the almost identical routine in the network client (Reply.compressBLayerData()) is correct, so I just made the two routines match.&lt;/p&gt;

&lt;p&gt;2) The network client appears to decide whether to flow a large byte array as inline data or as externalized data based on its length; if the data is less than 32767 bytes long it is flowed inline (see line 1164 or so in NetStatementRequest.java). However, the network server was not mirroring that logic, and sometimes decided to parse an incoming byte array as externalized data even though the network client had sent it inline.&lt;/p&gt;

&lt;p&gt;In early August, I will follow-up this patch with a complete patch, but if anybody has the time to review this code before then, that would be great!&lt;/p&gt;</comment>
                            <comment id="12425759" author="bryanpendleton" created="Fri, 4 Aug 2006 15:28:15 +0100"  >&lt;p&gt;Attached is an updated patch (&quot;withTests.diff&quot;), with 2 new regression tests added to derbynet/prepStmt.java, and master files updated accordingly. The code portion of the patch is identical to ddmReader.diff. Also attached is notes.html, with a few extra background notes for reviewers and code historians.&lt;/p&gt;

&lt;p&gt;derbyall run has two failures:&lt;br/&gt;
 -Dframework=DerbyNetClient jdbcapi/XATest.java&lt;br/&gt;
 -Dframework=DerbyNet lang/wisconsin.java&lt;/p&gt;

&lt;p&gt;The Wisconsin diff disappeared on re-run but the XATest diff persists.&lt;/p&gt;

&lt;p&gt;I will look at this XATest some more to see if it could have been caused by this change.&lt;/p&gt;</comment>
                            <comment id="12425760" author="bryanpendleton" created="Fri, 4 Aug 2006 15:32:21 +0100"  >&lt;p&gt;-Dframework=DerbyNetClient jdbcapi/XATest.java fails even after I reverted my change. The diff is:&lt;/p&gt;

&lt;p&gt;52a53&lt;br/&gt;
&amp;gt; (1 |PREPARED |false |APP |UserTransaction&lt;br/&gt;
54d54&lt;br/&gt;
&amp;lt; (1 |PREPARED |false |APP |UserTransaction&lt;br/&gt;
Test Failed.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;End:   XATest jdk1.4.2_11 DerbyNetClient 2006-08-04 07:55:58 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Looks like the output is in a slightly different order now.&lt;/p&gt;

&lt;p&gt;Anybody have an idea why I am seeing this diff in my environment? (Sun 1.4.2, Linux)&lt;/p&gt;</comment>
                            <comment id="12425772" author="bryanpendleton" created="Fri, 4 Aug 2006 16:25:33 +0100"  >&lt;p&gt;Deepa pointed me at &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1640&quot; title=&quot;Instability in XATest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1640&quot;&gt;&lt;del&gt;DERBY-1640&lt;/del&gt;&lt;/a&gt;, which explains the XATest.java diff. (Thanks Deepa!) I&apos;ll set Patch Available to indicate that this patch (withTests.diff) is now ready for review.&lt;/p&gt;</comment>
                            <comment id="12426091" author="bryanpendleton" created="Sun, 6 Aug 2006 23:21:35 +0100"  >&lt;p&gt;I intend to commit this patch in a few days; any review comments would be appreciated. Thanks!&lt;/p&gt;</comment>
                            <comment id="12426945" author="bryanpendleton" created="Wed, 9 Aug 2006 16:44:41 +0100"  >&lt;p&gt;Committed the withTests patch to subversion as revision 430077. Cleared the&lt;br/&gt;
patch available flag, and marked as resolved in 10.2.&lt;/p&gt;

&lt;p&gt;Wiktor, if you could please verify that this problem has been fixed in your&lt;br/&gt;
environment, and then close the bug if true, that would be great.&lt;/p&gt;</comment>
                            <comment id="12430970" author="ender" created="Mon, 28 Aug 2006 13:55:17 +0100"  >&lt;p&gt;OK, works for me.&lt;/p&gt;</comment>
                            <comment id="12492933" author="kmarsden" created="Tue, 1 May 2007 20:13:21 +0100"  >&lt;p&gt;Re-open to port to 10.1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12337147" name="DerbyTest.java" size="40815" author="ender" created="Wed, 19 Jul 2006 10:01:48 +0100"/>
                            <attachment id="12337200" name="DerbyTest2.java" size="2729" author="bryanpendleton" created="Wed, 19 Jul 2006 23:06:12 +0100"/>
                            <attachment id="12337203" name="ddmreader1.diff" size="1220" author="bryanpendleton" created="Thu, 20 Jul 2006 00:34:11 +0100"/>
                            <attachment id="12338153" name="notes.html" size="6367" author="bryanpendleton" created="Fri, 4 Aug 2006 15:28:15 +0100"/>
                            <attachment id="12338154" name="withTests.diff" size="9503" author="bryanpendleton" created="Fri, 4 Aug 2006 15:28:15 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Jul 2006 16:47:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22556</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy12i7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40056</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>