<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:51:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2162/DERBY-2162.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2162] Shutting down a database loaded from a jar file via the classpath and URLClassLoader  leaves an open file reference to the jar file containing the database.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2162</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A bug in java.net.URLClassLoader causes the underlying jar file to be held open once a resource has been fetched and opened.&lt;br/&gt;
Loading a class or just accessing the URL for the resource does not keep the jar open. Reported the bug to Sun, it is similar to the existing bug Java bug 4950148 but in this case no amount of garbage collection will close the jar.&lt;/p&gt;

&lt;p&gt;Derby exposes this as all containers/files are opened using as resources when loading the database from the classpath.&lt;/p&gt;

&lt;p&gt;On windows this is seen as the inability to delete the jar file, seen by the fixture testDatabaseInClasspath in DatabaseClassLoadingTest.&lt;/p&gt;

&lt;p&gt;Similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2083&quot; title=&quot;Shutting down a database loaded from a jar leaves an open file reference to the jar file containing the database.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2083&quot;&gt;&lt;del&gt;DERBY-2083&lt;/del&gt;&lt;/a&gt; but due to a different cause.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12358047">DERBY-2162</key>
            <summary>Shutting down a database loaded from a jar file via the classpath and URLClassLoader  leaves an open file reference to the jar file containing the database.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                            <label>derby_triage10_5_2</label>
                    </labels>
                <created>Thu, 7 Dec 2006 18:30:39 +0000</created>
                <updated>Wed, 21 Jan 2015 00:23:00 +0000</updated>
                            <resolved>Thu, 27 Mar 2014 08:40:43 +0000</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12728127" author="knutanders" created="Tue, 7 Jul 2009 15:39:23 +0100"  >&lt;p&gt;Triaged for 10.5.2.&lt;/p&gt;</comment>
                            <comment id="13945280" author="knutanders" created="Mon, 24 Mar 2014 16:10:36 +0000"  >&lt;p&gt;Java 7 added a close() method to URLClassLoader for releasing the jar files. See &lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-4167874&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-4167874&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If I enable testDatabaseInClasspath() and add a call to URLClassLoader.close() when it resets the context class loader, the test passes for me with JDK 7u51 on Windows. It fails to delete dclt.jar if I don&apos;t add the call to close().&lt;/p&gt;

&lt;p&gt;I&apos;ll try to get the test enabled permanently on Java 7 and higher using the new method.&lt;/p&gt;</comment>
                            <comment id="13946323" author="knutanders" created="Tue, 25 Mar 2014 09:18:50 +0000"  >&lt;p&gt;Another way to get the test case to pass, also on Java versions earlier than 7, is to call the URLConnection.setDefaultUseCaches() method first to disable caching of the jar files opened by URLClassLoader. That seems to make gc capable of freeing the file handle after the context class loader has been set to null at the end of the test case. An explicit call to System.gc() is needed before trying to delete the jar file, though, in order to make sure gc has run and released the file handle.&lt;/p&gt;

&lt;p&gt;This latter approach is probably too brittle to use in the regression tests, since System.gc() doesn&apos;t guarantee that all garbage is cleaned up. But I think these results support Dan&apos;s initial analysis that the file handle is kept open by the Java platform itself and not by Derby. I also think it means the solution for this problem must be implemented in the application layer (applications could either close the URLClassLoader when they are done with it, or disable caching of jar files). Having Derby close the URLClassLoader on shutdown is not an option, I think, as it is not possible for Derby to determine whether or not the application will still need the class loader after the Derby engine has been shut down.&lt;/p&gt;</comment>
                            <comment id="13947712" author="knutanders" created="Wed, 26 Mar 2014 09:23:15 +0000"  >&lt;p&gt;The attached patch (d2162-1a.diff) makes ClasspathSetup.tearDown() call close() on the URLClassLoader to free the resources held by it. It rewrites DatabaseClassLoadingTest.testDatabaseInClasspath() so that it uses ClasspathSetup, and enables it on Java 7 and higher (not on Java 6 because it&apos;s missing URLClassLoader.close()).&lt;/p&gt;

&lt;p&gt;The patch also enables some previously disabled test cases in NativeAuthenticationServiceTest on Windows (except on Java 6).&lt;/p&gt;

&lt;p&gt;These test cases now run cleanly for me on Windows. Without the fix in ClasspathSetup.tearDown(), they fail because they cannot delete the jar files at the end of the test.&lt;/p&gt;

&lt;p&gt;URLClassLoader.close() is protected by a RuntimePermission. The patch grants that permission to derbyTesting.jar.&lt;/p&gt;</comment>
                            <comment id="13949035" author="jira-bot" created="Thu, 27 Mar 2014 08:40:10 +0000"  >&lt;p&gt;Commit 1582220 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1582220&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1582220&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2162&quot; title=&quot;Shutting down a database loaded from a jar file via the classpath and URLClassLoader  leaves an open file reference to the jar file containing the database.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2162&quot;&gt;&lt;del&gt;DERBY-2162&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5618&quot; title=&quot;On Windows, orderly engine shutdown does not release the file handle on a jar file containing a database which was booted using the classpath subprotocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5618&quot;&gt;&lt;del&gt;DERBY-5618&lt;/del&gt;&lt;/a&gt;: Close the URLClassLoader when tests are done&lt;br/&gt;
with it so that file handles are freed and the jar files can be&lt;br/&gt;
deleted.&lt;/p&gt;</comment>
                            <comment id="13949040" author="knutanders" created="Thu, 27 Mar 2014 08:42:10 +0000"  >&lt;p&gt;Changing component from Services to Test, since the fix was to make the test close the URLClassLoader when it was done.&lt;/p&gt;</comment>
                            <comment id="14284728" author="myrna" created="Wed, 21 Jan 2015 00:23:00 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12542684">DERBY-5618</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12636890" name="d2162-1a.diff" size="17624" author="knutanders" created="Wed, 26 Mar 2014 09:23:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Jul 2009 14:39:23 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22918</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ikn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36827</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>