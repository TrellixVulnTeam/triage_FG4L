<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5173/DERBY-5173.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5173] RAFContainer.privGetRandomAccessFile() unwraps wrong exception type</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5173</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;RAFContainer.privGetRandomAccessFile() catches and unwraps PrivilegedActionExceptions raised in the privileged code:&lt;/p&gt;

&lt;p&gt;        catch( PrivilegedActionException pae)&lt;/p&gt;
{ 
            throw (StandardException) pae.getException();
        }

&lt;p&gt;The problem is that the privileged code is this:&lt;/p&gt;

&lt;p&gt;         case GET_RANDOM_ACCESS_FILE_ACTION: &lt;/p&gt;
{
             return actionFile.getRandomAccessFile(&quot;rw&quot;);
		 }
&lt;p&gt; // end of case BACKUP_CONTAINER_ACTION&lt;/p&gt;

&lt;p&gt;getRandomAccessFile() only has one checked exception, and that is FileNotFoundException. If it ever happens to raise FNFE, privGetRandomAccessFile() will fail with a ClassCastException and hide the underlying error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12503128">DERBY-5173</key>
            <summary>RAFContainer.privGetRandomAccessFile() unwraps wrong exception type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Apr 2011 13:40:42 +0100</created>
                <updated>Tue, 19 Apr 2011 13:39:24 +0100</updated>
                            <resolved>Mon, 4 Apr 2011 08:49:19 +0100</resolved>
                                    <version>10.7.1.1</version>
                                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13014546" author="knutanders" created="Fri, 1 Apr 2011 14:13:07 +0100"  >&lt;p&gt;To reproduce, follow these steps:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;create a new, unencrypted database&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;remove the write permission from the db/seg0 directory (chmod 555 db/seg0)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;reboot the database with encryption enabled, and see it fail with a ClassCastException:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:db;dataEncryption=true;bootPassword=abc1234xyz&apos;;&lt;br/&gt;
ERROR XJ040: Failed to start database &apos;db&apos; with class loader sun.misc.Launcher$AppClassLoader@1a336d5, see the next exception for details.&lt;br/&gt;
ERROR XJ001: Java exception: &apos;java.io.FileNotFoundException cannot be cast to org.apache.derby.iapi.error.StandardException: java.lang.ClassCastException&apos;.&lt;/p&gt;</comment>
                            <comment id="13014553" author="knutanders" created="Fri, 1 Apr 2011 14:26:57 +0100"  >&lt;p&gt;I&apos;m not sure if there&apos;s an easy way to add a regression test for this bug, or if it&apos;s worthwhile given that the issue is mostly cosmetic and the bug is somewhat of an edge case.&lt;/p&gt;

&lt;p&gt;In any case, here&apos;s a fix for the problem. Following the steps to reproduce described in the previous comment, I now get this error message:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:db;dataEncryption=true;bootPassword=abc1234xyz&apos;;&lt;br/&gt;
ERROR XJ040: Failed to start database &apos;db&apos; with class loader sun.misc.Launcher$AppClassLoader@18a80d4, see the next exception for details.&lt;br/&gt;
ERROR XBCXU: Encryption of an un-encrypted database failed: Exception during creation of file /tmp/db/seg0/n461.dat for container&lt;/p&gt;

&lt;p&gt;The ClassCastException is gone. And if ij had called printStackTrace() or otherwise followed the getCause() exception chain (it currently only follows the SQLException.getNextException() chain), it would have shown the underlying exception too:&lt;/p&gt;

&lt;p&gt;Caused by: java.io.FileNotFoundException: /tmp/db/seg0/n461.dat (Permission denied)&lt;br/&gt;
	at java.io.RandomAccessFile.open(Native Method)&lt;br/&gt;
	at java.io.RandomAccessFile.&amp;lt;init&amp;gt;(RandomAccessFile.java:233)&lt;br/&gt;
	at org.apache.derby.impl.io.DirRandomAccessFile.&amp;lt;init&amp;gt;(DirRandomAccessFile.java:57)&lt;br/&gt;
	at org.apache.derby.impl.io.DirFile4.getRandomAccessFile(DirFile4.java:275)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.RAFContainer.run(RAFContainer.java:1692)&lt;br/&gt;
	... 45 more&lt;/p&gt;</comment>
                            <comment id="13015302" author="knutanders" created="Mon, 4 Apr 2011 08:49:19 +0100"  >&lt;p&gt;Committed revision 1088491.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12475217" name="derby-5173-1a.diff" size="1359" author="knutanders" created="Fri, 1 Apr 2011 14:26:57 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24693</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0giv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36495</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>