<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:49:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3401/DERBY-3401.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3401] Removing a ConnectionEventListener from a PooledConnection during its connectionClosed() callback causes other ConnectionEventListener callbacks to be missed</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3401</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A ConnectionEventListener should be able to remove itself as a listener during a callback without affecting any other callbacks.&lt;/p&gt;

&lt;p&gt;DataSourceTest.subtestPooledRemoveListenerOnClose() tests the scenario but calls to it will be commented out in the fixture testPooledReuseOnClose() (using this bug number).&lt;/p&gt;

&lt;p&gt;Issue is that such a remove will modify the eventListener Vector in EmbedPooledConnection while it is being enumerated over.&lt;br/&gt;
An idea for a fix would be to first change the Vector over to a new-style collection, such as an implementation of List, then work off a copy of the collection when calling the callbacks. I don&apos;t think eventListener needs to be a synchronized collection, its access should be already synchronized on EmbedPooledConnection.&lt;/p&gt;

&lt;p&gt;I imagine that a similar issue exists for adding a new callback during callback processing, fixing this bug would fix that issue as well though no tests have been written for the add case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12388230">DERBY-3401</key>
            <summary>Removing a ConnectionEventListener from a PooledConnection during its connectionClosed() callback causes other ConnectionEventListener callbacks to be missed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Feb 2008 20:27:03 +0000</created>
                <updated>Fri, 21 Jan 2011 17:51:26 +0000</updated>
                            <resolved>Mon, 9 Jun 2008 09:37:19 +0100</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.2.0</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12598325" author="knutanders" created="Tue, 20 May 2008 16:16:39 +0100"  >&lt;p&gt;I think this is also a problem for the statement event listeners (JDBC 4.0 feature).&lt;/p&gt;</comment>
                            <comment id="12600126" author="knutanders" created="Tue, 27 May 2008 14:47:14 +0100"  >&lt;p&gt;I agree that copying the collection sounds like a reasonable approach. Strictly speaking, we only need a copy if there are at least two listeners in the list, but it is perhaps not worth the extra complexity to avoid copying 1-element lists. I&apos;ll try it and see how complex it gets.&lt;/p&gt;

&lt;p&gt;Alternatively, we could have a copy-on-write scheme so that we only pay the extra price if we actually modify the list of listeners (this assumes that the listeners are triggered more frequently than they are modified). For the statement event listeners, we could get this more or less for free with java.util.concurrent.CopyOnWriteArrayList (new in Java 1.5) since that code is compiled with the 1.6 compiler.&lt;/p&gt;</comment>
                            <comment id="12600422" author="knutanders" created="Wed, 28 May 2008 10:56:10 +0100"  >&lt;p&gt;Here&apos;s a test and a fix for the statement event listeners. In the current trunk, adding or removing listeners from a listener causes ConcurrentModificationException (both client and embedded). Since this was JDBC 4.0 code, I went for the simple solution and just replaced Vector/ArrayList with CopyOnWriteArrayList and removed the synchronization.&lt;/p&gt;

&lt;p&gt;All the regression tests passed.&lt;/p&gt;</comment>
                            <comment id="12600458" author="kristwaa" created="Wed, 28 May 2008 13:50:02 +0100"  >&lt;p&gt;I had a look at &apos; d3401-statement_events.diff&apos;. I think it looks good, but I have one question.&lt;/p&gt;

&lt;p&gt;Any reason why you allow null objects into the list of listeners in ClientPooledConnection40 and ClientXAConnection40?&lt;br/&gt;
Can&apos;t you get an NPE when you iterate through the list of listeners and invoke the callback method?&lt;/p&gt;

&lt;p&gt;I ran the new test(s) successfully, but modifying it to add a null listener causes failures.&lt;/p&gt;

&lt;p&gt;+1 to commit if you plan to address the NPE elsewhere or in a followup patch.&lt;/p&gt;
</comment>
                            <comment id="12600480" author="knutanders" created="Wed, 28 May 2008 15:08:20 +0100"  >&lt;p&gt;Thanks for looking at the patch Kristian. Since the different handling of null in client versus embedded is an existing issue, I filed a new bug (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3695&quot; title=&quot;NullPointerException when invoking statement event listeners if one of the listeners is null&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3695&quot;&gt;&lt;del&gt;DERBY-3695&lt;/del&gt;&lt;/a&gt;) that I plan to address separately. You&apos;re quite right that it causes a NullPointerException on the client.&lt;/p&gt;</comment>
                            <comment id="12600486" author="knutanders" created="Wed, 28 May 2008 15:23:46 +0100"  >&lt;p&gt;Committed d3401-statement_events.diff with revision 660959.&lt;/p&gt;</comment>
                            <comment id="12602590" author="knutanders" created="Thu, 5 Jun 2008 10:17:39 +0100"  >&lt;p&gt;Attaching a patch which fixes the problem with the ConnectionEventListeners, enables the test case for removing a listener and adds a test case for adding a listener.&lt;/p&gt;

&lt;p&gt;The fix makes the PC update a variable each time it starts iterating over the list of listeners and each time it has finished iterating. That way, (add/remove)ConnectionEventListener knows if the list is currently being iterated over. If it is being iterated over, the list is cloned and the add/remove operation is performed on the clone. That way, the iterator is not affected and continues to work just as if no listener has been added or removed.&lt;/p&gt;

&lt;p&gt;The logic is somewhat more complex than the code for the statement event listeners, as we don&apos;t have CopyOnWriteArrayList available in Java 1.4. However, it is less costly, as it only copies the list in the cases where modifying the list directly would have caused problems (CopyOnWriteArrayList always copies the list when it&apos;s modified).&lt;/p&gt;

&lt;p&gt;All the regression tests passed with this patch.&lt;/p&gt;</comment>
                            <comment id="12602682" author="kristwaa" created="Thu, 5 Jun 2008 16:27:14 +0100"  >&lt;p&gt;I looked at the patch &apos;d3401-connection_events.diff&apos; and it looks good to me.&lt;br/&gt;
suites.All (Sun JDK  1.5) and derbyall (Sun JDK 1.6) passed without failures.&lt;/p&gt;

&lt;p&gt;+1 to commit&lt;/p&gt;</comment>
                            <comment id="12602686" author="knutanders" created="Thu, 5 Jun 2008 16:35:22 +0100"  >&lt;p&gt;Thanks for reviewing the patch, Kristian.&lt;br/&gt;
Committed revision 663641.&lt;/p&gt;

&lt;p&gt;I&apos;ll probably merge it to 10.4 in a couple of days, so I&apos;m leaving the issue open for now.&lt;/p&gt;</comment>
                            <comment id="12603520" author="knutanders" created="Mon, 9 Jun 2008 09:37:19 +0100"  >&lt;p&gt;Merged to 10.4 and committed revision 664655.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12396070">DERBY-3675</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12396070">DERBY-3675</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12383441" name="d3401-connection_events.diff" size="14639" author="knutanders" created="Thu, 5 Jun 2008 10:17:39 +0100"/>
                            <attachment id="12383442" name="d3401-connection_events.stat" size="235" author="knutanders" created="Thu, 5 Jun 2008 10:17:39 +0100"/>
                            <attachment id="12382916" name="d3401-statement_events.diff" size="23477" author="knutanders" created="Wed, 28 May 2008 10:56:09 +0100"/>
                            <attachment id="12382917" name="d3401-statement_events.stat" size="373" author="knutanders" created="Wed, 28 May 2008 10:56:10 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 20 May 2008 15:16:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23622</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0lpz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37337</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>