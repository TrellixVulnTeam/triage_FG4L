<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:14:07 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4420/DERBY-4420.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4420] NullPointerException with INSERT INTO ... from EXCEPT/INTERSECT</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4420</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The sequence of statements below give a NullPointerException. The statements are very similar to the ones in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4419&quot; title=&quot;NullPointerException with INSERT INTO ... from UNION and identity columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4419&quot;&gt;&lt;del&gt;DERBY-4419&lt;/del&gt;&lt;/a&gt;, but this is a separate bug since the stack traces are different, and this bug can be seen all the way back to 10.1.1.0, whereas &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4419&quot; title=&quot;NullPointerException with INSERT INTO ... from UNION and identity columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4419&quot;&gt;&lt;del&gt;DERBY-4419&lt;/del&gt;&lt;/a&gt; was a regression in 10.3. (On 10.0.2.1, a syntax error is raised instead of the NPE.)&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t1(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t1 values 1,2;&lt;br/&gt;
2 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table t2(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t2 values 2,3;&lt;br/&gt;
2 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table t3(x int, y int generated always as identity);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t3&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; select * from t1 except select * from t2;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;/p&gt;

&lt;p&gt;Same error if INTERSECT is used instead of EXCEPT.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12438891">DERBY-4420</key>
            <summary>NullPointerException with INSERT INTO ... from EXCEPT/INTERSECT</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Oct 2009 07:56:18 +0100</created>
                <updated>Fri, 21 May 2010 11:53:36 +0100</updated>
                            <resolved>Tue, 3 Nov 2009 11:51:34 +0000</resolved>
                                    <version>10.1.1.0</version>
                    <version>10.2.1.6</version>
                    <version>10.3.1.4</version>
                    <version>10.4.1.3</version>
                    <version>10.5.1.1</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12769111" author="knutanders" created="Fri, 23 Oct 2009 07:57:15 +0100"  >&lt;p&gt;Stack trace:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ResultSetNode.setTableConstructorTypes(ResultSetNode.java:329)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.InsertNode.bindStatement(InsertNode.java:329)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:324)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:90)&lt;br/&gt;
	at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:828)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:606)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:555)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:329)&lt;/p&gt;</comment>
                            <comment id="12769112" author="knutanders" created="Fri, 23 Oct 2009 07:58:04 +0100"  >&lt;p&gt;Attached is a script that reproduces the NPE.&lt;/p&gt;</comment>
                            <comment id="12769967" author="knutanders" created="Mon, 26 Oct 2009 10:01:15 +0000"  >&lt;p&gt;Note that a NullPointerException with the exact same stack trace is also seen if T3 is defined as&lt;br/&gt;
    create table t3(x int, y int default 4);&lt;br/&gt;
or&lt;br/&gt;
    create table t3(x int, y generated always as (2*x));&lt;/p&gt;</comment>
                            <comment id="12770518" author="knutanders" created="Tue, 27 Oct 2009 14:17:39 +0000"  >&lt;p&gt;Actually, this has nothing to do with generated columns, default values or identity columns:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t1(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table t2(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table t3(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t3 select * from t1 except select * from t2;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;/p&gt;</comment>
                            <comment id="12770519" author="knutanders" created="Tue, 27 Oct 2009 14:20:02 +0000"  >&lt;p&gt;Removed &quot;generated columns&quot; from the bug summary, since the NPE can be reproduced without such columns.&lt;/p&gt;</comment>
                            <comment id="12770534" author="knutanders" created="Tue, 27 Oct 2009 15:04:57 +0000"  >&lt;p&gt;The NPE is raised by this code in ResultSetNode.setTableConstructorTypes() because re is null:&lt;/p&gt;

&lt;p&gt;			ResultColumn	rc = (ResultColumn) resultColumns.elementAt(index);&lt;/p&gt;

&lt;p&gt;			ValueNode re = rc.getExpression();&lt;/p&gt;

&lt;p&gt;			if (re.requiresTypeFromContext())&lt;/p&gt;

&lt;p&gt;I looked at it in the debugger, and it turned out that rc was an instance of AllResultColumn, which represents the &quot;&lt;b&gt;&quot; in the select list. So the problem seems to be related to the &quot;&lt;/b&gt;&quot; not having been expanded to the actual RC at that time.&lt;/p&gt;

&lt;p&gt;The insert statement works if the &quot;*&quot; in the first operand of the except operator is replaced with the actual column name:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; insert into t3 select x from t1 except select * from t2;&lt;br/&gt;
1 row inserted/updated/deleted&lt;/p&gt;</comment>
                            <comment id="12770562" author="knutanders" created="Tue, 27 Oct 2009 16:47:40 +0000"  >&lt;p&gt;It looks like setTableConstructorTypes() is only meant for table constructors (values clauses). UnionNode overrides it and makes it a no-op unless the union really is a values clause that has been rewritten to a union. IntersectOrExceptNode does not override it. I tried implementing an empty override in IntersectOrExceptNode, and that made the NPE go away. Probably, the code in ResultSetNode.setTableConstructorTypes() should only be executed if the node is a RowResultSetNode, so an alternative solution would be to move the method to RowResultSetNode and make the method in ResultSetNode a no-op.&lt;/p&gt;

&lt;p&gt;The change fixes the NPE, and the query with no generated columns, identity columns or default values works correctly. The queries that insert into a table with a column that&apos;s auto-generated somehow, this error is raised instead:&lt;/p&gt;

&lt;p&gt;ERROR 42X77: Column position &apos;2&apos; is out of range for the query expression.&lt;/p&gt;

&lt;p&gt;So either it&apos;s the wrong fix, or there&apos;s more than one bug.&lt;/p&gt;</comment>
                            <comment id="12771446" author="knutanders" created="Thu, 29 Oct 2009 15:23:29 +0000"  >&lt;p&gt;The attached patch copies ResultSetNode.setTableConstructorTypes() to RowResultSetNode and makes the method in RSN a no-op. According to the comments in RSN, the code is only supposed to be executed if the node is a RowResultSetNode, so it sounds like a better place for the code. A test case is also added in InsertTest.&lt;/p&gt;

&lt;p&gt;Now the insert statements that take all the column values from the select statement work as expected. The ones that only insert into a subset of the columns and take the rest of the values from the column defaults, fail with the &quot;column position out of range&quot; message mentioned in the previous comment. I&apos;m assuming this is a different bug, and I intend to file a separate issue if the proposed fix is committed.&lt;/p&gt;

&lt;p&gt;All the regression tests ran cleanly.&lt;/p&gt;</comment>
                            <comment id="12773009" author="knutanders" created="Tue, 3 Nov 2009 10:32:47 +0000"  >&lt;p&gt;Committed revision 832379.&lt;/p&gt;

&lt;p&gt;I&apos;ll file a new issue for the column position out of range error.&lt;/p&gt;</comment>
                            <comment id="12773027" author="knutanders" created="Tue, 3 Nov 2009 11:51:34 +0000"  >&lt;p&gt;Logged the remaining problems as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4433&quot; title=&quot;Cannot insert from EXCEPT/INTERSECT when target table has more columns than the source&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4433&quot;&gt;&lt;del&gt;DERBY-4433&lt;/del&gt;&lt;/a&gt;. Marking this issue as resolved.&lt;/p&gt;</comment>
                            <comment id="12782923" author="knutanders" created="Thu, 26 Nov 2009 16:06:29 +0000"  >&lt;p&gt;Merged fix to 10.5 with revision 884616.&lt;/p&gt;</comment>
                            <comment id="12828569" author="knutanders" created="Tue, 2 Feb 2010 09:55:52 +0000"  >&lt;p&gt;Verified on trunk. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12439750">DERBY-4433</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12465069">DERBY-4671</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12423585" name="d4420-1a.diff" size="17639" author="knutanders" created="Thu, 29 Oct 2009 15:23:29 +0000"/>
                            <attachment id="12423586" name="d4420-1a.stat" size="235" author="knutanders" created="Thu, 29 Oct 2009 15:23:29 +0000"/>
                            <attachment id="12422996" name="npe.sql" size="266" author="knutanders" created="Fri, 23 Oct 2009 07:58:04 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24245</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0qav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38079</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>