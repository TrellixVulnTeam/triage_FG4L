<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:35 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-630/DERBY-630.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-630] create trigger fails with null pointer exception</title>
                <link>https://issues.apache.org/jira/browse/DERBY-630</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When i create a brand new database, and execute the following statements all in one transaction or each of them in their own transaction, then it fails at trigger creation with null pointer exception. if i exclude the schema names from statement, then it runs fine. (If S1 is ommited from every statement then it runs fine). Once the version without the schema names run fine, i can run the version that has schema names, fine also. &lt;/p&gt;

&lt;p&gt;create schema S1;&lt;/p&gt;

&lt;p&gt;create table&lt;br/&gt;
  S1.PRODUCT(&lt;br/&gt;
    PRODUCT_ID VARCHAR(255) unique not null,&lt;br/&gt;
    VERSION BIGINT&lt;br/&gt;
  );&lt;/p&gt;

&lt;p&gt;create table&lt;br/&gt;
  S1.CATEGORY(&lt;br/&gt;
    CAT_ID VARCHAR(255),&lt;br/&gt;
    NAME varchar(255) not null,&lt;br/&gt;
    VERSION BIGINT&lt;br/&gt;
  );&lt;/p&gt;

&lt;p&gt;create table&lt;br/&gt;
  S1.PROD_IN_CAT(&lt;br/&gt;
    CAT_ID VARCHAR(255) not null,&lt;br/&gt;
    PRODUCT_ID VARCHAR(255) not null,&lt;br/&gt;
    VERSION BIGINT&lt;br/&gt;
  );&lt;/p&gt;

&lt;p&gt;create trigger S1.product_v &lt;br/&gt;
after update of version on S1.product&lt;br/&gt;
referencing new as n&lt;br/&gt;
for each row&lt;br/&gt;
mode db2sql&lt;br/&gt;
	update S1.prod_in_cat set version = n.version where S1.prod_in_cat.product_id=n.product_id;&lt;/p&gt;



&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.SYSSTATEMENTSRowFactory.makeSYSSTATEMENTSrow(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addSPSDescriptor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.CreateTriggerConstantAction.createSPS(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.CreateTriggerConstantAction.executeConstantAction(Unknown Source)Stopping progress indicator for: Executing SQL&lt;/p&gt;

&lt;p&gt;	at org.apache.derby.impl.sql.execute.MiscResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;/p&gt;
</description>
                <environment>windows 2000, sun jdk 1.5.0</environment>
        <key id="12318000">DERBY-630</key>
            <summary>create trigger fails with null pointer exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yipng">Yip Ng</assignee>
                                    <reporter username="mardacay">mardacay</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Oct 2005 07:20:43 +0100</created>
                <updated>Thu, 13 Dec 2007 09:04:44 +0000</updated>
                            <resolved>Sun, 15 Oct 2006 16:42:31 +0100</resolved>
                                    <version>10.1.1.0</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12332185" author="mamtas" created="Mon, 17 Oct 2005 15:35:56 +0100"  >&lt;p&gt;This looks like duplicate of bug (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-85&quot; title=&quot;NPE when creating a trigger on a table and default schema doesn&amp;#39;t exist.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-85&quot;&gt;&lt;del&gt;DERBY-85&lt;/del&gt;&lt;/a&gt;) NPE when creating a trigger on a table and default schema doesn&apos;t exist. If that is correct, we should mark this bug as duplicate.&lt;/p&gt;</comment>
                            <comment id="12360470" author="kmarsden" created="Thu, 15 Dec 2005 10:04:26 +0000"  >&lt;p&gt;Looks like a Duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-85&quot; title=&quot;NPE when creating a trigger on a table and default schema doesn&amp;#39;t exist.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-85&quot;&gt;&lt;del&gt;DERBY-85&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12360471" author="kmarsden" created="Thu, 15 Dec 2005 10:05:11 +0000"  >&lt;p&gt;dup of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-85&quot; title=&quot;NPE when creating a trigger on a table and default schema doesn&amp;#39;t exist.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-85&quot;&gt;&lt;del&gt;DERBY-85&lt;/del&gt;&lt;/a&gt; which is In Progress&lt;/p&gt;</comment>
                            <comment id="12420714" author="slc" created="Thu, 13 Jul 2006 03:31:10 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-630&quot; title=&quot;create trigger fails with null pointer exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-630&quot;&gt;&lt;del&gt;DERBY-630&lt;/del&gt;&lt;/a&gt; is listed as a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-85&quot; title=&quot;NPE when creating a trigger on a table and default schema doesn&amp;#39;t exist.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-85&quot;&gt;&lt;del&gt;DERBY-85&lt;/del&gt;&lt;/a&gt; and was marked fixed in release 10.1.3, however, I believe it is not a duplicate, and although &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-85&quot; title=&quot;NPE when creating a trigger on a table and default schema doesn&amp;#39;t exist.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-85&quot;&gt;&lt;del&gt;DERBY-85&lt;/del&gt;&lt;/a&gt; is fixed in 10.1.3, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-630&quot; title=&quot;create trigger fails with null pointer exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-630&quot;&gt;&lt;del&gt;DERBY-630&lt;/del&gt;&lt;/a&gt; is not.&lt;/p&gt;

&lt;p&gt;the test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-85&quot; title=&quot;NPE when creating a trigger on a table and default schema doesn&amp;#39;t exist.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-85&quot;&gt;&lt;del&gt;DERBY-85&lt;/del&gt;&lt;/a&gt; consists of this:&lt;/p&gt;

&lt;p&gt;creates a table in the non-default schema &lt;br/&gt;
creates a trigger in the default schema on a table in the non-default schema.&lt;/p&gt;

&lt;p&gt;the test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-630&quot; title=&quot;create trigger fails with null pointer exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-630&quot;&gt;&lt;del&gt;DERBY-630&lt;/del&gt;&lt;/a&gt; consists of this:&lt;/p&gt;

&lt;p&gt;creates a table in the non-default schema &lt;br/&gt;
creates a trigger in the non-default schema on a table in the non-default schema&lt;/p&gt;

&lt;p&gt;Below is the output from the two test cases run against the 10.1.3 release,&lt;br/&gt;
plus an additional one that shows creating a table in the default schema, then a trigger in the default schema on the table in the default schema does succeed.&lt;/p&gt;


&lt;p&gt;DERBY- 85:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:firstDB;create=true;user=someUser;password=somePwd&apos;; &lt;br/&gt;
ij&amp;gt; create table itko.t1 (i int); &lt;br/&gt;
0 rows inserted/updated/deleted &lt;br/&gt;
ij&amp;gt; create trigger trig1 after update on itko.t1 for each row mode db2sql select &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;from sys.systables;&lt;br/&gt;
0 rows inserted/updated/deleted &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-630&quot; title=&quot;create trigger fails with null pointer exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-630&quot;&gt;&lt;del&gt;DERBY-630&lt;/del&gt;&lt;/a&gt; (simplified test case):&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:myDB;create=true;user=someUser;password=somePwd&apos;; &lt;br/&gt;
ij&amp;gt; create table itko.t1 (i int); &lt;br/&gt;
0 rows inserted/updated/deleted &lt;br/&gt;
ij&amp;gt; create trigger itko.trig1 after update on itko.t1 for each row mode db2sql s &lt;br/&gt;
elect * from sys.systables; &lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;. &lt;/p&gt;

&lt;p&gt;Test case showing creating everything in the default schema is OK:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:newDB;create=true;user=someUser;password=somePwd&apos;; &lt;br/&gt;
ij&amp;gt; create table t1 (i int); &lt;br/&gt;
0 rows inserted/updated/deleted &lt;br/&gt;
ij&amp;gt; create trigger trig1 after update on t1 for each row mode db2sql select * fr &lt;br/&gt;
om sys.systables; &lt;br/&gt;
0 rows inserted/updated/deleted &lt;/p&gt;

&lt;p&gt;Sysinfo:&lt;/p&gt;

&lt;p&gt;java org.apache.derby.tools.sysinfo&lt;br/&gt;
------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.5.0_06&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
Java home:       C:\JDK\jdk1.5.0_06\jre&lt;br/&gt;
Java classpath:  derby.jar;.;derbytools.jar;&lt;br/&gt;
OS name:         Windows XP&lt;br/&gt;
OS architecture: x86&lt;br/&gt;
OS version:      5.1&lt;br/&gt;
Java user name:  slc&lt;br/&gt;
Java user home:  C:\Documents and Settings\Administrator&lt;br/&gt;
Java user dir:   C:\projects\gilles_tool\releases\Nov_refresh\installs\db-derby-&lt;br/&gt;
10.1.3.1-lib\lib&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.5&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: J2SE 5.0 - JDBC 3.0&lt;br/&gt;
[C:\projects\gilles_tool\releases\Nov_refresh\installs\db-derby-10.1.3.1-lib\lib&lt;br/&gt;
\derby.jar] 10.1.3.1 - (417277)&lt;br/&gt;
[C:\projects\gilles_tool\releases\Nov_refresh\installs\db-derby-10.1.3.1-lib\lib&lt;br/&gt;
\derbytools.jar] 10.1.3.1 - (417277)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Locale Information -----------------&lt;br/&gt;
------------------------------------------------------&lt;/p&gt;</comment>
                            <comment id="12424128" author="cybereal" created="Fri, 28 Jul 2006 17:29:43 +0100"  >&lt;p&gt;I can confirm this happening to me in version 10.1.3.1.&lt;/p&gt;

&lt;p&gt;The test case above causes the issue.  It doesn&apos;t occur when creating the triggers on the APP schema.&lt;/p&gt;</comment>
                            <comment id="12438834" author="yipng" created="Sat, 30 Sep 2006 03:43:53 +0100"  >&lt;p&gt;At execution time, it looks like CREATE TRIGGER expects a compilation schema UUID to be available.  Since the above example did not use the schema APP (which already exists after db creation time), the schema &quot;someUser&quot; is not created physically yet, so there won&apos;t be any UUID available.  When trying to retrieve its&lt;br/&gt;
schema descriptor from the data dictionary, getSchemaDescriptor will return null, so trying to access the&lt;br/&gt;
UUID will ultimately result in NPE.&lt;/p&gt;

&lt;p&gt;CREATE VIEW also suffers from this problem wth regards to compilation schema.  From looking at the code, it seems it is possible for the non-nullable column COMPILATIONSCHEMAID in SYS.SYSVIEWS to have SQL NULL value.  So to confirm this, I tried the following script on ij:&lt;/p&gt;

&lt;p&gt;&amp;gt; connect &apos;jdbc:derby:wombat;create=true;user=user2;password=pwd&apos; as user2;&lt;br/&gt;
&amp;gt; WARNING 01J01: Database &apos;wombat&apos; not created, connection made to existing database instead.&lt;br/&gt;
&amp;gt; ij(USER2)&amp;gt; create table ippo.t1 (i int);&lt;br/&gt;
&amp;gt; 0 rows inserted/updated/deleted&lt;br/&gt;
&amp;gt; ij(USER2)&amp;gt; create table ippo.t2 (i int);&lt;br/&gt;
&amp;gt; 0 rows inserted/updated/deleted&lt;br/&gt;
&amp;gt; ij(USER2)&amp;gt; create view ippo.v1&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; as values 1;&lt;br/&gt;
&amp;gt; 0 rows inserted/updated/deleted&lt;br/&gt;
&amp;gt; ij(USER2)&amp;gt; &amp;#8211; should return 0 row, as SYS.SYSVIEWS.COMPILATIONSCHEMAID column is not nullable&lt;br/&gt;
&amp;gt; select t.tablename, v.compilationschemaid&lt;br/&gt;
&amp;gt;    from sys.systables t, sys.sysviews v&lt;br/&gt;
&amp;gt;    where t.tableid = v.tableid and t.tablename=&apos;V1&apos; and v.compilationschemaid is null;&lt;br/&gt;
&amp;gt; TABLENAME    |COMPILATIONSCHEMAID&lt;br/&gt;
&amp;gt; ------------------------------------------------------------------------------&lt;br/&gt;
&amp;gt; V1                       |NULL&lt;/p&gt;

&lt;p&gt;ij&amp;gt; describe sys.sysviews;&lt;br/&gt;
COLUMN_NAME                 |TYPE_NAME|DEC&amp;amp;|NUM&amp;amp;|COLUM&amp;amp;|COLUMN_DEF|CHAR_OCTE&amp;amp;|IS_NULL&amp;amp;&lt;br/&gt;
------------------------------------------------------------------------------&lt;br/&gt;
TABLEID                                |CHAR           |NULL|NULL  |36             |NULL                 |72                      |NO&lt;br/&gt;
VIEWDEFINITION                |LONG VAR&amp;amp;|NULL|NULL  |32700      |NULL                 |NULL                |NO&lt;br/&gt;
CHECKOPTION                   |CHAR           |NULL|NULL  |1               |NULL                 |2                         |NO&lt;br/&gt;
COMPILATIONSCHEMAID |CHAR           |NULL|NULL  |36             |NULL                 |72                      |NO&lt;br/&gt;
4 rows selected&lt;/p&gt;

&lt;p&gt;So the above script shows that CREATE VIEW also have a problem.&lt;/p&gt;

</comment>
                            <comment id="12439330" author="yipng" created="Mon, 2 Oct 2006 23:18:03 +0100"  >&lt;p&gt;I think to properly address this issue, the current implementation for CREATE TRIGGER needs &lt;br/&gt;
to handle null compilation schema.  A compilation schema with null value indicates that the &lt;br/&gt;
trigger action statement text does not depend on the current schema.  This means:&lt;/p&gt;

&lt;p&gt;1.  It is safe to compile this statement in any schema since there is no dependency with &lt;br/&gt;
    the CURRENT SCHEMA.  i.e.:  All relevent fields are qualified with a specific schema.&lt;/p&gt;

&lt;p&gt;2.  The statement cache mechanism can utilize this piece of information to enable &lt;br/&gt;
    better statement plan sharing across different schemas; thus, avoiding unnecessary &lt;br/&gt;
    statement compilation.  &lt;/p&gt;


&lt;p&gt;So the proposal is:&lt;/p&gt;

&lt;p&gt;a) Allow null compilation schema.  The system catalog first needs to change the &lt;br/&gt;
   compiliation schema id column of SYS.SYSSTATEMENTS and SYS.SYSVIEWS system &lt;br/&gt;
   table&apos;s nullability to true.  This would also require a soft upgrade for the &lt;br/&gt;
   previous versions of Derby.  This step will resolve the NPE problem of this jira.&lt;/p&gt;

&lt;p&gt;b) Handle null compilation schema in statement preparation logic.  This can be filed&lt;br/&gt;
   as a separate jira as improvement.  It may require some work on the SQL parser to &lt;br/&gt;
   determine whether the compiled statement depends on the CURRENT SCHEMA or not, so &lt;br/&gt;
   that the compilation schema can be properly set.&lt;/p&gt;</comment>
                            <comment id="12439397" author="yipng" created="Tue, 3 Oct 2006 07:57:50 +0100"  >&lt;p&gt;Attaching proposal patch derby630-trunk-diff01.txt for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-630&quot; title=&quot;create trigger fails with null pointer exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-630&quot;&gt;&lt;del&gt;DERBY-630&lt;/del&gt;&lt;/a&gt;.  This patch fixes the NPE problem + allowing compilation schema uuid column to be nullable in both SYS.SYSSTATEMENTS and SYS.SYSVIEWS.  If this patch is reasonable, then a subsequent jira should be file to handle null compilation schema in the statement preparation logic as described in my previous comment.  derbyall passes with this patch.  &lt;/p&gt;</comment>
                            <comment id="12439540" author="bryanpendleton" created="Tue, 3 Oct 2006 16:32:36 +0100"  >&lt;p&gt;Is a null schema the same as an implicit schema? Or is there a different concept being discussed here?&lt;/p&gt;</comment>
                            <comment id="12439569" author="yipng" created="Tue, 3 Oct 2006 18:32:58 +0100"  >&lt;p&gt;Hi Bryan.  An implicit schema is not the same as a null compilation schema that I described.  An implicit schema or current schema, as we see in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-85&quot; title=&quot;NPE when creating a trigger on a table and default schema doesn&amp;#39;t exist.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-85&quot;&gt;&lt;del&gt;DERBY-85&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&amp;lt;snip&amp;gt;&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:firstDB;create=true;user=someUser;password=somePwd&apos;;&lt;br/&gt;
ij&amp;gt; create table itko.t1 (i int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create trigger trig1 after update on itko.t1 for each row mode db2sql select * from sys.systables; &lt;br/&gt;
&amp;lt;/snip&amp;gt;&lt;/p&gt;

&lt;p&gt;will have a compilation schema &apos;someUser&apos; (the trigger name is not qualified with a schema name, so it will use the current schema, &apos;someUser&apos; which will be implicitly created at execution time).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-630&quot; title=&quot;create trigger fails with null pointer exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-630&quot;&gt;&lt;del&gt;DERBY-630&lt;/del&gt;&lt;/a&gt; poses a different problem where the current schema is not explicitly or implicitly created.  &lt;/p&gt;

&lt;p&gt;&amp;lt;snip&amp;gt;&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:myDB;create=true;user=someUser;password=somePwd&apos;;&lt;br/&gt;
ij&amp;gt; create table itko.t1 (i int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create trigger itko.trig1 after update on itko.t1 for each row mode db2sql select * from sys.systables; &lt;br/&gt;
&amp;lt;/snip&amp;gt;&lt;/p&gt;

&lt;p&gt;So this is one edge case where the compilation schema can be null since the current schema is not physically created yet, so the spsCompSchemaId is null.  At the CREATE TRIGGER execution time, it&lt;br/&gt;
attempts to locate the CURRENT SCHEMA via the data dictionary but this will ultimately return null.  &lt;br/&gt;
Hence, when attempting to retrieve its UUID, NPE occurs. &lt;/p&gt;

&lt;p&gt;A compilation schema can also be set to null if the statement text does not have dependencies on the CURRENT SCHEMA but this logic does not seem to be implemented yet in Derby.  There are some&lt;br/&gt;
comments in the code but the actual implementation logic is incomplete.  The latter case can benefit statement cache plan sharing across connections in different schema.  The compilation schema is&lt;br/&gt;
used as an identity part for the statement.&lt;/p&gt;
</comment>
                            <comment id="12441257" author="yipng" created="Tue, 10 Oct 2006 20:00:13 +0100"  >&lt;p&gt;Anyone else have a chance to try out and review the patch for this issue?&lt;/p&gt;</comment>
                            <comment id="12441596" author="bryanpendleton" created="Thu, 12 Oct 2006 02:51:16 +0100"  >&lt;p&gt;Hi Yip, sorry I kind of lost track of this issue. Your explanation of the schema&lt;br/&gt;
handling seems reasonable to me. I intend to commit this patch.&lt;/p&gt;

&lt;p&gt;If anybody else is reviewing this change, please let us know.&lt;/p&gt;</comment>
                            <comment id="12441797" author="bryanpendleton" created="Thu, 12 Oct 2006 17:51:20 +0100"  >&lt;p&gt;The patch applies cleanly for me and builds without problem. The new tests fail as expected&lt;br/&gt;
without the code changes, and pass as expected with the code changes. derbyall passes&lt;br/&gt;
cleanly for me.&lt;/p&gt;

&lt;p&gt;One question, though: I see that there is code in the patch which runs during the upgrade&lt;br/&gt;
path. Has this code been tested? Are there automated tests of the ugprade processing,&lt;br/&gt;
or is the testing manual?&lt;/p&gt;

&lt;p&gt;I am not very familiar with upgrade and so am not certain what sort of review is useful for&lt;br/&gt;
the upgrade changes. I read through the code and it makes sense, and your comments&lt;br/&gt;
in the code are very useful. I&apos;m just wondering about the testing, both manual and automated.&lt;/p&gt;</comment>
                            <comment id="12441875" author="yipng" created="Thu, 12 Oct 2006 22:22:50 +0100"  >&lt;p&gt;Hi Bryan.  I am glad that you brought this up.  In the current state of the trunk, the soft upgrade code that I put into the current patch will not get triggered since the release.properties file&apos;s beta property is set to true and the maint property has a value of 0 which indicates alpha.  Thus, the system will not allow an upgrade to occur.  i.e.:&lt;/p&gt;

&lt;p&gt;&amp;lt;snip&amp;gt;&lt;br/&gt;
ij version 10.3&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:db102&apos; user &apos;user1&apos;;&lt;br/&gt;
ERROR XJ040: Failed to start database &apos;db102&apos;, see the next exception for details.&lt;br/&gt;
ERROR XCW00: Unsupported upgrade from &apos;10.2&apos; to &apos;10.3 beta&apos;.&lt;br/&gt;
&amp;lt;/snip&amp;gt;&lt;/p&gt;

&lt;p&gt;I am not sure what the next release will be, so I didn&apos;t modify the release.properties file.  However, I did run the soft upgrade test manually to verify my code changes are executed correctly.  What I did was:&lt;/p&gt;

&lt;p&gt;1) Set the beta property to false and maint property to non-zero value (1000001, for example)&lt;/p&gt;

&lt;p&gt;2) In order for the soft upgrade to get triggered, the data dictionary(dd) version (currently 140 for 10.2.1.6) &lt;br/&gt;
needs to  be incremented to a higher version number than the on-disk version.  &lt;/p&gt;

&lt;p&gt;3) Create the database in 10.2.1.6, this will have dd version of 140.&lt;/p&gt;

&lt;p&gt;&amp;lt;snip&amp;gt;&lt;br/&gt;
ij version 10.2&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:db102;create=true&apos; user &apos;user1&apos;;&lt;br/&gt;
WARNING 01J14: SQL authorization is being used without first enabling authentication.&lt;br/&gt;
ij&amp;gt; describe &apos;sys.sysstatements&apos;;&lt;br/&gt;
COLUMN_NAME         |TYPE_NAME|DEC&amp;amp;|NUM&amp;amp;|COLUM&amp;amp;|COLUMN_DEF|CHAR_OCTE&amp;amp;|IS_NULL&amp;amp;&lt;br/&gt;
------------------------------------------------------------------------------&lt;br/&gt;
STMTID              |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;br/&gt;
STMTNAME            |VARCHAR  |NULL|NULL|128   |NULL      |256       |NO&lt;br/&gt;
SCHEMAID            |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;br/&gt;
TYPE                |CHAR     |NULL|NULL|1     |NULL      |2         |NO&lt;br/&gt;
VALID               |BOOLEAN  |NULL|NULL|1     |NULL      |NULL      |NO&lt;br/&gt;
TEXT                |LONG VAR&amp;amp;|NULL|NULL|32700 |NULL      |NULL      |NO&lt;br/&gt;
LASTCOMPILED        |TIMESTAMP|0   |10  |26    |NULL      |NULL      |YES&lt;br/&gt;
COMPILATIONSCHEMAID |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;br/&gt;
USINGTEXT           |LONG VAR&amp;amp;|NULL|NULL|32700 |NULL      |NULL      |YES&lt;/p&gt;

&lt;p&gt;9 rows selected&lt;/p&gt;

&lt;p&gt;ij&amp;gt; describe &apos;sys.sysviews&apos;;&lt;br/&gt;
COLUMN_NAME         |TYPE_NAME|DEC&amp;amp;|NUM&amp;amp;|COLUM&amp;amp;|COLUMN_DEF|CHAR_OCTE&amp;amp;|IS_NULL&amp;amp;&lt;br/&gt;
------------------------------------------------------------------------------&lt;br/&gt;
TABLEID             |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;br/&gt;
VIEWDEFINITION      |LONG VAR&amp;amp;|NULL|NULL|32700 |NULL      |NULL      |NO&lt;br/&gt;
CHECKOPTION         |CHAR     |NULL|NULL|1     |NULL      |2         |NO&lt;br/&gt;
COMPILATIONSCHEMAID |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;/p&gt;

&lt;p&gt;4 rows selected&lt;br/&gt;
&amp;lt;/snip&amp;gt;&lt;/p&gt;


&lt;p&gt;4) Boot this 10.2 database using the trunk code with my patch(dd version for runtime is 141).&lt;br/&gt;
&amp;lt;snip&amp;gt;&lt;br/&gt;
ij version 10.3&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:db102&apos; user &apos;user1&apos;;&lt;br/&gt;
WARNING 01J14: SQL authorization is being used without first enabling authentication.&lt;br/&gt;
ij&amp;gt; describe &apos;sys.sysstatements&apos;;&lt;br/&gt;
COLUMN_NAME         |TYPE_NAME|DEC&amp;amp;|NUM&amp;amp;|COLUM&amp;amp;|COLUMN_DEF|CHAR_OCTE&amp;amp;|IS_NULL&amp;amp;&lt;br/&gt;
------------------------------------------------------------------------------&lt;br/&gt;
STMTID              |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;br/&gt;
STMTNAME            |VARCHAR  |NULL|NULL|128   |NULL      |256       |NO&lt;br/&gt;
SCHEMAID            |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;br/&gt;
TYPE                |CHAR     |NULL|NULL|1     |NULL      |2         |NO&lt;br/&gt;
VALID               |BOOLEAN  |NULL|NULL|1     |NULL      |NULL      |NO&lt;br/&gt;
TEXT                |LONG VAR&amp;amp;|NULL|NULL|32700 |NULL      |NULL      |NO&lt;br/&gt;
LASTCOMPILED        |TIMESTAMP|0   |10  |26    |NULL      |NULL      |YES&lt;br/&gt;
COMPILATIONSCHEMAID |CHAR     |NULL|NULL|36    |NULL      |72        |YES&lt;br/&gt;
USINGTEXT           |LONG VAR&amp;amp;|NULL|NULL|32700 |NULL      |NULL      |YES&lt;/p&gt;

&lt;p&gt;9 rows selected&lt;br/&gt;
ij&amp;gt; describe &apos;sys.sysviews&apos;;&lt;br/&gt;
COLUMN_NAME         |TYPE_NAME|DEC&amp;amp;|NUM&amp;amp;|COLUM&amp;amp;|COLUMN_DEF|CHAR_OCTE&amp;amp;|IS_NULL&amp;amp;&lt;br/&gt;
------------------------------------------------------------------------------&lt;br/&gt;
TABLEID             |CHAR     |NULL|NULL|36    |NULL      |72        |NO&lt;br/&gt;
VIEWDEFINITION      |LONG VAR&amp;amp;|NULL|NULL|32700 |NULL      |NULL      |NO&lt;br/&gt;
CHECKOPTION         |CHAR     |NULL|NULL|1     |NULL      |2         |NO&lt;br/&gt;
COMPILATIONSCHEMAID |CHAR     |NULL|NULL|36    |NULL      |72        |YES&lt;/p&gt;

&lt;p&gt;4 rows selected&lt;br/&gt;
&amp;lt;/snip&amp;gt;&lt;/p&gt;

&lt;p&gt;Notice the COMPILATIONSCHEMAID&apos;s IS_NULLABLE column for both system tables are now set to true &lt;br/&gt;
after the soft upgrade.  So it works as expected. &lt;/p&gt;

&lt;p&gt;For step 2 described above, the DD runtime version should have been incremented along with this fix &lt;br/&gt;
and I noticed there is an 10.1 to 10.2 upgrade test available in the regression.  Perhaps I can &lt;br/&gt;
investigate this abit more and make this verification step automated with this test.  &lt;br/&gt;
I&apos;ll resubmit a follow-up patch.  &lt;/p&gt;</comment>
                            <comment id="12441883" author="yipng" created="Fri, 13 Oct 2006 00:14:18 +0100"  >&lt;p&gt;Hmm...  I cannot seem to attach file to this jira as well:&lt;/p&gt;

&lt;p&gt;Exception trying to establish attachment directory. Check that the application server and JIRA have permissions to write to it: com.atlassian.jira.web.util.AttachmentException: Cannot write to attachment directory. Check that the application server and JIRA have permissions to write to: /usr/local/tomcat/tomcat-jira/attachments/DERBY/&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-630&quot; title=&quot;create trigger fails with null pointer exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-630&quot;&gt;&lt;del&gt;DERBY-630&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12442078" author="yipng" created="Fri, 13 Oct 2006 19:38:21 +0100"  >&lt;p&gt;Attaching derby630-trunk-diff02.txt.  This patch contains the automated upgrade test from 10.1 to 10.3.  Running derbyall now, will post result when it completes.&lt;/p&gt;</comment>
                            <comment id="12442102" author="yipng" created="Fri, 13 Oct 2006 22:46:16 +0100"  >&lt;p&gt;derbyall passes with patch derby630-trunk-diff02.txt.&lt;/p&gt;</comment>
                            <comment id="12442103" author="bryanpendleton" created="Fri, 13 Oct 2006 23:04:50 +0100"  >&lt;p&gt;Thanks for investigating the automated upgrade test! I will have a look at the new patch.&lt;/p&gt;</comment>
                            <comment id="12442304" author="bryanpendleton" created="Sat, 14 Oct 2006 16:24:36 +0100"  >&lt;p&gt;Hi Yip, thanks very much for adding the upgrade test. It looks great, and it passes fine in my environment.&lt;/p&gt;

&lt;p&gt;However, I am wondering: should we fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1689&quot; title=&quot;Remove Upgrade_10_1_10_2 test from 10.3 and add new upgrade tests for 10.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1689&quot;&gt;&lt;del&gt;DERBY-1689&lt;/del&gt;&lt;/a&gt; first? More precisely, do you think that committing&lt;br/&gt;
this change will make it harder to address &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1689&quot; title=&quot;Remove Upgrade_10_1_10_2 test from 10.3 and add new upgrade tests for 10.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1689&quot;&gt;&lt;del&gt;DERBY-1689&lt;/del&gt;&lt;/a&gt;? If not, I think I&apos;m ready to commit this patch.&lt;/p&gt;</comment>
                            <comment id="12442368" author="yipng" created="Sun, 15 Oct 2006 06:55:41 +0100"  >&lt;p&gt;Hi Bryan.  Thanks for your continous review of the patches.  &lt;/p&gt;

&lt;p&gt;If &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1689&quot; title=&quot;Remove Upgrade_10_1_10_2 test from 10.3 and add new upgrade tests for 10.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1689&quot;&gt;&lt;del&gt;DERBY-1689&lt;/del&gt;&lt;/a&gt; is still using the same upgrade test infrastructure, then this patch shouldn&apos;t make it harder to address the upgrade issue for 10.3.  &lt;/p&gt;

&lt;p&gt;This patch has already activated the upgrade test for 10.1 to 10.3.  To enable 10.2 to 10.3 upgrade test as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1689&quot; title=&quot;Remove Upgrade_10_1_10_2 test from 10.3 and add new upgrade tests for 10.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1689&quot;&gt;&lt;del&gt;DERBY-1689&lt;/del&gt;&lt;/a&gt;, the 10.2 release jars needs to be check-in to the trunk code line first.&lt;/p&gt;</comment>
                            <comment id="12442401" author="bryanpendleton" created="Sun, 15 Oct 2006 16:42:31 +0100"  >&lt;p&gt;Thanks Yip and Deepa for the info on the upgrade testing infrastructure. I think&lt;br/&gt;
everything is good to go here, so I committed patch diff02 to subversion as&lt;br/&gt;
revision 464215.&lt;/p&gt;

&lt;p&gt;Thanks Yip for all the patches and explanations. Can you verify that the fix looks&lt;br/&gt;
good and close this issue? &lt;/p&gt;

&lt;p&gt;Also, you made a comment about needing to file a follow-on issue to track the&lt;br/&gt;
improvement of the statement cache mechanism to avoid unnecessary&lt;br/&gt;
statement compilation. Did that follow-on issue get filed? If so, it would be&lt;br/&gt;
nice to link that issue to this one.&lt;/p&gt;</comment>
                            <comment id="12442412" author="yipng" created="Sun, 15 Oct 2006 19:34:45 +0100"  >&lt;p&gt;Hi Bryan, I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1960&quot; title=&quot;Handle null compilation schema to improve statement cache mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1960&quot;&gt;DERBY-1960&lt;/a&gt; for the second part of the proposal.  Thanks for committing the patch.&lt;br/&gt;
One question though, will this patch be back ported to 10.2 line?  I think the current patch cannot be apply &lt;br/&gt;
to the 10.2 line since it involves data dictionary upgrade.&lt;/p&gt;</comment>
                            <comment id="12442416" author="bryanpendleton" created="Sun, 15 Oct 2006 19:53:34 +0100"  >&lt;p&gt;I am not intending to port this patch to 10.2. I agree with you that the upgrade requirements&lt;br/&gt;
would necessitate special handling. &lt;/p&gt;</comment>
                            <comment id="12551294" author="fuzzylogic" created="Thu, 13 Dec 2007 09:04:44 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12353221">DERBY-1960</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12342148" name="derby630-trunk-diff01.txt" size="70819" author="yipng" created="Tue, 3 Oct 2006 07:57:50 +0100"/>
                            <attachment id="12342911" name="derby630-trunk-diff02.txt" size="290580" author="yipng" created="Fri, 13 Oct 2006 19:38:21 +0100"/>
                            <attachment id="12342147" name="derby630-trunk-stat01.txt" size="941" author="yipng" created="Tue, 3 Oct 2006 07:57:50 +0100"/>
                            <attachment id="12342910" name="derby630-trunk-stat02.txt" size="1839" author="yipng" created="Fri, 13 Oct 2006 19:38:21 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 17 Oct 2005 14:35:56 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22059</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy10g7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39723</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>