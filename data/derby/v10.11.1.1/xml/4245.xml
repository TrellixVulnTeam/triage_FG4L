<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4245/DERBY-4245.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4245] Sorting a table containing a CLOB fails after upgrade to 10.5</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4245</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When sorting a table containing a CLOB column in a database that has been soft-upgraded from 10.4.2.0 to 10.5.1.1, the query fails with a NullPointerException.&lt;/p&gt;

&lt;p&gt;Reported on derby-user: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/200905.mbox/%3ckk5ivy.tcwvy@email.bg%3e&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/200905.mbox/%3ckk5ivy.tcwvy@email.bg%3e&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12426254">DERBY-4245</key>
            <summary>Sorting a table containing a CLOB fails after upgrade to 10.5</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Sun, 24 May 2009 17:52:03 +0100</created>
                <updated>Wed, 2 Dec 2009 12:03:49 +0000</updated>
                            <resolved>Mon, 13 Jul 2009 13:14:55 +0100</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.5.2.0</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12712574" author="knutanders" created="Sun, 24 May 2009 17:54:52 +0100"  >&lt;p&gt;To reproduce:&lt;/p&gt;

&lt;p&gt;1) Run the attached class with Derby 10.4.2.0 to create the database&lt;/p&gt;

&lt;p&gt;2) Open the database in ij with Derby 10.5.1.1 and issue a select with an ORDER BY:&lt;/p&gt;

&lt;p&gt;ij version 10.5&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:db&apos;;&lt;br/&gt;
ij&amp;gt; select c from t order by length(c);&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
ij&amp;gt; &lt;/p&gt;</comment>
                            <comment id="12712682" author="kristwaa" created="Mon, 25 May 2009 11:27:38 +0100"  >&lt;p&gt;Patch 0a is a preview patch.&lt;br/&gt;
I found two problems when investigating the bug;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SQLClob incorrectly assumes that the instance variable SQLChar.stream always reference the passed in stream to readExternal.&lt;br/&gt;
    This is just wrong, and is what causes the NPE.&lt;/li&gt;
	&lt;li&gt;LimitInputStream does not support mark/reset.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the case of LimitInputStream, the underlying BufferedInputStream supports mark/reset. In this cause we read 5 bytes, resets and skips two bytes. This causes the limit stream to believe it can only deliver 59998 bytes, whereas the correct number is 60003 (full length minus header length). The five bytes involved in the mark/reset are &quot;lost&quot;.&lt;/p&gt;

&lt;p&gt;I&apos;m not yet sure how to handle mark/reset with the limit reader.&lt;br/&gt;
I plan to address the problems in SQLClob under this issue, and create a sub-issue for the limit stream.&lt;/p&gt;

&lt;p&gt;The repro passes with the preview patch, and because mark/reset isn&apos;t used much it may also pass the regression tests (the fix for LimitInputStream is broken).&lt;br/&gt;
I&apos;m starting the regression tests now, will report back with the results.&lt;/p&gt;</comment>
                            <comment id="12713297" author="kristwaa" created="Tue, 26 May 2009 23:33:10 +0100"  >&lt;p&gt;The regression tests passed, but that does &lt;b&gt;not&lt;/b&gt; mean the patch is ready for commit &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12714806" author="knutanders" created="Sun, 31 May 2009 03:06:39 +0100"  >&lt;p&gt;It doesn&apos;t look like the upgrade step is necessary in order to reproduce this issue. I also see the NPE when I create the database with trunk. The preview patch appears to fix it.&lt;/p&gt;</comment>
                            <comment id="12717686" author="kristwaa" created="Tue, 9 Jun 2009 15:20:43 +0100"  >&lt;p&gt;Patch 1a contains a test for this issue.&lt;br/&gt;
The test has not been enabled. On my system it takes around 130 seconds, where around half of the time is spent inserting test data. I&apos;ll see if I can reduce the number of rows inserted further.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12718103" author="knutanders" created="Wed, 10 Jun 2009 15:58:49 +0100"  >&lt;p&gt;Would it make sense to include the seed in the test name by overriding getName() and make it return super.getName() + SEED? Then we don&apos;t need to intercept all exceptions manually in order to report the seed.&lt;/p&gt;</comment>
                            <comment id="12718121" author="kristwaa" created="Wed, 10 Jun 2009 17:01:00 +0100"  >&lt;p&gt;It makes sense, as it makes the code cleaner. Is patch 1b along the lines you were thinking of?&lt;/p&gt;

&lt;p&gt;I also attached patch 2a, which fixes the problems in SQLClob. When applying it, the bug should no longer reproduce with a clean database. The bug will still occur with upgraded databases.&lt;br/&gt;
Patch 2a passes the regression tests.&lt;/p&gt;

&lt;p&gt;Patches ready for review.&lt;/p&gt;</comment>
                            <comment id="12718415" author="knutanders" created="Thu, 11 Jun 2009 12:47:34 +0100"  >&lt;p&gt;Thanks. 1b looks good and I&apos;ve verified that it fails without the 2a patch and passes with it. You may also want to change the calls to fail() in fetchIterateGetLengthBlob/fetchIterateGetLengthBlob to assertEquals() now that the seed is part of the name.&lt;/p&gt;

&lt;p&gt;The changes in 2a also look fine to me. +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12719487" author="kristwaa" created="Mon, 15 Jun 2009 10:36:40 +0100"  >&lt;p&gt;Committed patch 2a to trunk with revision 784701.&lt;/p&gt;</comment>
                            <comment id="12719569" author="kristwaa" created="Mon, 15 Jun 2009 15:09:21 +0100"  >&lt;p&gt;Patch 3a is the first revision of a fix for the issue seen for upgraded databases.&lt;br/&gt;
The regression tests passed.&lt;/p&gt;

&lt;p&gt;Before I commit this I need to see if I understand exactly why the failure occurred. Specifically, I have to verify my own claim about the BufferedInputStream. It may be that there shouldn&apos;t be a buffered stream here. This won&apos;t affect the problem with LimitInputStream and mark/reset, but it may be an issue worth fixing anyway. I don&apos;t think there is a reason to buffer streams serving bytes from the pages in the page cache.&lt;/p&gt;

&lt;p&gt;Patch ready for initial review.&lt;/p&gt;</comment>
                            <comment id="12719967" author="kristwaa" created="Tue, 16 Jun 2009 08:53:47 +0100"  >&lt;p&gt;Thank you for the feedback, Knut Anders.&lt;/p&gt;

&lt;p&gt;Attached and committed patch 1c to trunk with revision 785104. The test is not yet enabled.&lt;/p&gt;</comment>
                            <comment id="12719970" author="kristwaa" created="Tue, 16 Jun 2009 08:59:09 +0100"  >&lt;p&gt;Fixed two spelling errors in the test with revision 785105.&lt;/p&gt;</comment>
                            <comment id="12720087" author="kristwaa" created="Tue, 16 Jun 2009 13:01:54 +0100"  >&lt;p&gt;Code inspection shows that getting a BufferedInputStream in this case is correct. It comes from StreamFileContainer.open, and the source is a file. The merge sort (MergeSort.openSortScan) uses stream containers.&lt;br/&gt;
The default buffer size is 16 KB (RawStoreFactory.STREAM_FILE_BUFFER_SIZE_DEFAULT).&lt;/p&gt;</comment>
                            <comment id="12721147" author="knutanders" created="Thu, 18 Jun 2009 10:50:41 +0100"  >&lt;p&gt;&amp;gt; On my system it takes around 130 seconds, where around half of the time is spent inserting test data. I&apos;ll see if I can reduce the number of rows inserted further.&lt;/p&gt;

&lt;p&gt;I think if you lower derby.storage.sortBufferMax, you&apos;ll see the bug with less rows in the table.&lt;/p&gt;</comment>
                            <comment id="12726063" author="kristwaa" created="Wed, 1 Jul 2009 14:49:04 +0100"  >&lt;p&gt;Thanks for the tip, Knut.&lt;/p&gt;

&lt;p&gt;Patch 4a lowers the sort buffer. Although the lowered sort buffer size makes it possible to run with even fewer rows, I chose to keep it as high as it is (100 rows) due to the randomness in the test and because lowering it further didn&apos;t make the test runs that much faster.&lt;/p&gt;

&lt;p&gt;Committed patch 4a to trunk with revision 790162.&lt;/p&gt;</comment>
                            <comment id="12727067" author="dagw" created="Fri, 3 Jul 2009 18:49:10 +0100"  >&lt;p&gt;Triaged for 10.5.2, &quot;repro attached&quot; and setting &quot;urgent&quot; urgency.&lt;/p&gt;</comment>
                            <comment id="12727411" author="kristwaa" created="Mon, 6 Jul 2009 08:34:23 +0100"  >&lt;p&gt;Committed patch 3a to trunk with revision 791398.&lt;/p&gt;

&lt;p&gt;Is it worth making LimitInputStream.mark(int) do nothing and have reset() throw an exception to be on the safe side?&lt;/p&gt;

&lt;p&gt;With the possible exception of mark/reset above, I don&apos;t expect to do any more work on this issue before I port the fixes to the 10.5 branch.&lt;/p&gt;</comment>
                            <comment id="12728766" author="kmarsden" created="Wed, 8 Jul 2009 17:27:40 +0100"  >&lt;p&gt;Changing to Blocker urgency. It looks like port to 10.5 is all that is needed.&lt;/p&gt;</comment>
                            <comment id="12730017" author="kmarsden" created="Sat, 11 Jul 2009 22:22:11 +0100"  >&lt;p&gt;Is this ready to port to 10.5?  It is currently marked as a Blocker for the release.  &lt;/p&gt;</comment>
                            <comment id="12730314" author="kristwaa" created="Mon, 13 Jul 2009 13:14:55 +0100"  >&lt;p&gt;The regression tests passed on my machine for 10.5. Merged to the 10.5 branch with revision 793565.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12432075">DERBY-4333</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12408910" name="MixedVersionClob.java" size="681" author="knutanders" created="Sun, 24 May 2009 17:54:52 +0100"/>
                            <attachment id="12408935" name="derby-4245-0a-preview.diff" size="4478" author="kristwaa" created="Mon, 25 May 2009 11:27:38 +0100"/>
                            <attachment id="12410224" name="derby-4245-1a-test.diff" size="12076" author="kristwaa" created="Tue, 9 Jun 2009 15:20:43 +0100"/>
                            <attachment id="12410320" name="derby-4245-1b-test.diff" size="11535" author="kristwaa" created="Wed, 10 Jun 2009 17:01:00 +0100"/>
                            <attachment id="12410763" name="derby-4245-1c-test.diff" size="10948" author="kristwaa" created="Tue, 16 Jun 2009 08:53:47 +0100"/>
                            <attachment id="12410321" name="derby-4245-2a-sqlclob_fix.diff" size="3551" author="kristwaa" created="Wed, 10 Jun 2009 17:01:00 +0100"/>
                            <attachment id="12410674" name="derby-4245-3a-unread_bytes_fix.diff" size="4636" author="kristwaa" created="Mon, 15 Jun 2009 15:09:20 +0100"/>
                            <attachment id="12412274" name="derby-4245-4a-adjust_sort_buffer_test.diff" size="1996" author="kristwaa" created="Wed, 1 Jul 2009 14:49:04 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 25 May 2009 10:27:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24129</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0rhb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10050"><![CDATA[Blocker]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>