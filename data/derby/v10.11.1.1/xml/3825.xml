<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:12:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3825/DERBY-3825.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3825] StoreStreamClob.getReader(charPos) performs poorly</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3825</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;StoreStreamClob.getReader(charPos) performs poorly because it resets the underlying stream and skips data until it reached the requested character position. Not only does the data has to be skipped, it also has to be decoded (UTF-8).&lt;br/&gt;
The problem is exposed through EmbedClob.getSubString, which causes extremely bad performance for the client driver because the locator based Clob implementation uses this method.&lt;/p&gt;

&lt;p&gt;For the record, there is another read buffer size issue that exaggerates the problem (it will probably be handled under &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3769&quot; title=&quot;Make LOBStoredProcedure on the server side smarter about the read buffer size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3769&quot;&gt;&lt;del&gt;DERBY-3769&lt;/del&gt;&lt;/a&gt;, and also &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3818&quot; title=&quot;client Insert/retrieval of 18MB  Clob is extremely slow  in MultiByteClobTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3818&quot;&gt;&lt;del&gt;DERBY-3818&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12401788">DERBY-3825</key>
            <summary>StoreStreamClob.getReader(charPos) performs poorly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Aug 2008 15:19:07 +0100</created>
                <updated>Mon, 4 May 2009 19:22:46 +0100</updated>
                            <resolved>Mon, 3 Nov 2008 14:44:46 +0000</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>JDBC</component>
                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12620272" author="kristwaa" created="Wed, 6 Aug 2008 15:41:50 +0100"  >&lt;p&gt;&apos;derby-3825-0a-preview.diff&apos; is a preview patch. It is incomplete and not for commit.&lt;/p&gt;

&lt;p&gt;It introduces a new method for InternalClob: getInternalReader(charPos).&lt;br/&gt;
The idea is to keep only one such reader per clob that can be used internally - that is not published to the user. The most prominent example is Clob.getSubString().&lt;br/&gt;
There are two performance gains:&lt;br/&gt;
 1) Repositioning capabilities (see below).&lt;br/&gt;
 2) Less object creation (GC).&lt;/p&gt;

&lt;p&gt;The repositioning functionality is added to UTF8Reader, and can be split into three types - ordered after increasing cost:&lt;br/&gt;
 a) Reposition within current character buffer (small hops forwards and potentially backwards - in range 1 char to 8K chars)&lt;br/&gt;
 b) Forward stream from current position (hops forwards)&lt;br/&gt;
 c) Reset stream and skip data (hops backwards)&lt;/p&gt;

&lt;p&gt;The more I work with this, the more I feel the functionality should be pushed closer to store.&lt;/p&gt;

&lt;p&gt;Preview patch ready for comments.&lt;/p&gt;</comment>
                            <comment id="12626546" author="kristwaa" created="Thu, 28 Aug 2008 13:37:45 +0100"  >&lt;p&gt;&apos;derby-3825-1a-reset_readpositioninbuffer.diff&apos; is a small cleanup patch moving the resetting of the readPositionInBuffer variable into fillBuffer.&lt;/p&gt;

&lt;p&gt;Committed to trunk with revision 689803.&lt;/p&gt;</comment>
                            <comment id="12637518" author="kristwaa" created="Tue, 7 Oct 2008 16:22:10 +0100"  >&lt;p&gt;Patch 2a introduces an internal reader and adds repositioning logic to UTF8Reader.&lt;/p&gt;

&lt;p&gt;Note that I have made getInternalReader merely forward to getReader in TemporaryClob.&lt;br/&gt;
I will commit the simple Clob regression tests and run it with and without this patch to document the effect.&lt;/p&gt;

&lt;p&gt;Regression tests passed (JDK 1.6.0, Solaris 10).&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12637523" author="kristwaa" created="Tue, 7 Oct 2008 16:44:09 +0100"  >&lt;p&gt;Just noticed I forgot the license header in the new test. I&apos;ll add it in the next rev.&lt;/p&gt;</comment>
                            <comment id="12639064" author="knutanders" created="Mon, 13 Oct 2008 15:26:57 +0100"  >&lt;p&gt;I read through the patch, and it looks correct to me. The repositioning logic was rather complex, mainly because of the buffering and the mix of 1-based indexes on the JDBC level and 0-based indexes on the buffer level, but it looks to me as if all cases are handled correctly.&lt;/p&gt;

&lt;p&gt;I have also tested the patch by fetching a 32 MB CLOB with getSubString(). Without the patch, it took so long time that I hit Ctrl-C in the end (waited for minutes). With the patch, it took 3-4 seconds to fetch the CLOB. So the patch seems to work very well! This was with a CLOB stored in a table. When I tested the same with a CLOB created by Connection.createClob(), I still observed that getSubString() took a very long time. I suppose this is what&apos;s meant by the TODO comment in TemporaryClob?&lt;/p&gt;

&lt;p&gt;I noticed a TODO that suggested that localization was going to be added in UTF8Reader.skipPersistent(). Is this planned in a follow-up patch? Other places in the code, we just throw an EOFException with no message in similar situations. Perhaps the detailed error message could be put in a THROWASSERT() so that it is only used in debug builds?&lt;/p&gt;

&lt;p&gt;The class javadoc for UTF8ReaderTest says that it tests &quot;package-private methods in &lt;/p&gt;
{@code UTF8Reader}
&lt;p&gt;.&quot; As far as I can see, it only tests the public methods of UTF8Reader.&lt;/p&gt;</comment>
                            <comment id="12639360" author="kristwaa" created="Tue, 14 Oct 2008 10:30:09 +0100"  >&lt;p&gt;Patch 2b addresses the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added license to UTF8ReaderTest&lt;/li&gt;
	&lt;li&gt;changed class comment in UTF8ReaderTest&lt;/li&gt;
	&lt;li&gt;added DEBUG block with detailed EOFException&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding Knut Anders&apos; comments (from top to bottom):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Thanks for looking at the repositioning logic. It is a bit complex, but it should be pretty well tested functionally. Can it be optimized?&lt;/li&gt;
	&lt;li&gt;Regarding the poor performance you observed, I need to look into it. I will create a new Jira for it. Implementing getInternalReader is one issue, but I think there are more severe problems in this code path (it is using some special reader objects). Hopefully the ClobAccessTest should demonstrate the problem.&lt;/li&gt;
	&lt;li&gt;I resolved the localization issue by throwing a detailed EOFException from inside a debug block. I chose this over an assert, as an assert makes a test fail (expects EOFException).&lt;/li&gt;
	&lt;li&gt;I changed the comment, it was not very precise. I need a package-private test because of StoreStreamClob, which is the only user of UTF8Reader.reposition at the moment and I wanted a little bit more control than what I get going through the JDBC API.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks for looking at the patch!&lt;br/&gt;
Unless there are more comments on patch 2b, I expect to commit it shortly.&lt;/p&gt;</comment>
                            <comment id="12639423" author="knutanders" created="Tue, 14 Oct 2008 14:48:09 +0100"  >&lt;p&gt;Thanks for the updated patch, Kristian. I think it looks ready for&lt;br/&gt;
commit.&lt;/p&gt;

&lt;p&gt;&amp;gt; Thanks for looking at the repositioning logic. It is a bit complex,&lt;br/&gt;
&amp;gt; but it should be pretty well tested functionally. Can it be&lt;br/&gt;
&amp;gt; optimized?&lt;/p&gt;

&lt;p&gt;I don&apos;t see how it can be optimized without changing the format, since&lt;br/&gt;
random access to a lob is currently not supported by the store.&lt;/p&gt;

&lt;p&gt;It may perhaps be easier to read it if the call to resetUTF8Reader()&lt;br/&gt;
is moved to the beginning of the method. Then there will be just two&lt;br/&gt;
cases to consider for the repositioning: the requested position is&lt;br/&gt;
either after the current position or in the buffer. This means that we&lt;br/&gt;
don&apos;t need the nested if statements. Something along these lines:&lt;/p&gt;

&lt;p&gt;if (requestedCharPos &amp;lt;= readerCharCount - charactersInBuffer) &lt;/p&gt;
{
    resetUTF8Reader();
}

&lt;p&gt;long currentCharPos =&lt;br/&gt;
    readerCharCount - charactersInBuffer + readPositionInBuffer;&lt;/p&gt;

&lt;p&gt;long difference = (requestedCharPos - 1) - currentCharPos;&lt;/p&gt;

&lt;p&gt;if (difference &amp;lt;= 0) &lt;/p&gt;
{
    // move back in the buffer
    readPositionInBuffer += difference;
}
&lt;p&gt; else &lt;/p&gt;
{
    // skip forward
    persistentSkip(difference);
}</comment>
                            <comment id="12639432" author="kristwaa" created="Tue, 14 Oct 2008 15:21:30 +0100"  >&lt;p&gt;Thanks again, Knut Anders.&lt;/p&gt;

&lt;p&gt;I committed patch 2b to trunk with revision 704547, and will look at the suggested simplification(s) in a separate patch.&lt;/p&gt;</comment>
                            <comment id="12644304" author="kristwaa" created="Fri, 31 Oct 2008 14:18:56 +0000"  >&lt;p&gt;&apos;derby-3825-3a-simplification.diff&apos; makes the repositioning logic easier to read.&lt;br/&gt;
Thanks for the suggestion Knut Anders.&lt;/p&gt;

&lt;p&gt;Running tests, will commit and backport to 10.4 when the tests have finished.&lt;/p&gt;</comment>
                            <comment id="12644677" author="kristwaa" created="Mon, 3 Nov 2008 10:27:43 +0000"  >&lt;p&gt;Committed patch 3a to trunk with revision 710033.&lt;/p&gt;</comment>
                            <comment id="12644731" author="kristwaa" created="Mon, 3 Nov 2008 14:44:46 +0000"  >&lt;p&gt;Backported patches 1a, 2b and 3a to 10.4 with revision 710070.&lt;br/&gt;
Will close when tinderbox test run has completed.&lt;/p&gt;</comment>
                            <comment id="12644928" author="olesolberg" created="Tue, 4 Nov 2008 08:56:52 +0000"  >&lt;p&gt;10.4 Tinderbox build &lt;br/&gt;
&lt;a href=&quot;http://dbtg.thresher.com/derby/test/tinderbox_10.4_16/UpdateInfo/710076-buildDetails.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/tinderbox_10.4_16/UpdateInfo/710076-buildDetails.txt&lt;/a&gt;&lt;br/&gt;
reports:&lt;/p&gt;


&lt;p&gt;pptesting:&lt;/p&gt;

&lt;p&gt;compile:&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;mkdir&amp;#93;&lt;/span&gt; Created dir: Apache/TinderBox-10.4/10.4/classes.pptesting&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; Compiling 11 source files to Apache/TinderBox-10.4/10.4/classes.pptesting&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; Apache/TinderBox-10.4/10.4/java/testing/org/apache/derby/impl/jdbc/UTF8ReaderTest.java:57: cannot find symbol&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; symbol  : method setAutoCommit(boolean)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; location: class org.apache.derby.impl.jdbc.UTF8ReaderTest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;         setAutoCommit(false);&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;         ^&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; Apache/TinderBox-10.4/10.4/java/testing/org/apache/derby/impl/jdbc/UTF8ReaderTest.java:88: cannot find symbol&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; symbol  : method setAutoCommit(boolean)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; location: class org.apache.derby.impl.jdbc.UTF8ReaderTest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;         setAutoCommit(false);&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;         ^&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; Apache/TinderBox-10.4/10.4/java/testing/org/apache/derby/impl/jdbc/UTF8ReaderTest.java:126: cannot find symbol&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; symbol  : method setAutoCommit(boolean)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; location: class org.apache.derby.impl.jdbc.UTF8ReaderTest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;         setAutoCommit(false);&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;         ^&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; Note: Apache/TinderBox-10.4/10.4/java/testing/org/apache/derby/impl/drda/TestProto.java uses unchecked or unsafe operations.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; Note: Recompile with -Xlint:unchecked for details.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; 3 errors&lt;/p&gt;

&lt;p&gt;BUILD FAILED&lt;br/&gt;
Apache/TinderBox-10.4/10.4/build.xml:457: The following error occurred while executing this line:&lt;br/&gt;
Apache/TinderBox-10.4/10.4/java/testing/org/apache/derby/build.xml:44: Compile failed; see the compiler error output for details.&lt;/p&gt;


&lt;p&gt;Dittot on 10.4 branch build last night: &lt;/p&gt;</comment>
                            <comment id="12644941" author="kristwaa" created="Tue, 4 Nov 2008 10:48:12 +0000"  >&lt;p&gt;Thanks for letting me know, Ole.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure how this slipped though, guess I have to look at my test-deployment scripts...&lt;br/&gt;
Committed fix to 10.4 with revision 711221.&lt;/p&gt;

&lt;p&gt;I&apos;m sorry for the noise.&lt;/p&gt;</comment>
                            <comment id="12652725" author="kristwaa" created="Wed, 3 Dec 2008 09:19:29 +0000"  >&lt;p&gt;Closing the issue.&lt;/p&gt;

&lt;p&gt;Note that getReader is still rather low-performant, compared to what it could have been. Again the cause is positioning. The trick I used for getInternalReader cannot be used, because the reader from getReader is passed out to the user and cannot be shared.&lt;br/&gt;
Given the current requirements and limitations, a possible optimization is to remember one or more byte/char position and then be able to skip bytes instead of chars. The latter requires decoding, the former doesn&apos;t.&lt;/p&gt;

&lt;p&gt;On the other side, if a user just obtains one reader and keeps reading from it, the initial positioning cost doesn&apos;t matter that much.&lt;br/&gt;
The problem with getSubString has been resolved by the patches committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12387647" name="derby-3825-0a-preview.diff" size="10289" author="kristwaa" created="Wed, 6 Aug 2008 15:41:50 +0100"/>
                            <attachment id="12389088" name="derby-3825-1a-reset_readpositioninbuffer.diff" size="1641" author="kristwaa" created="Thu, 28 Aug 2008 13:37:45 +0100"/>
                            <attachment id="12391639" name="derby-3825-2a-internalReader_repositioning.diff" size="23036" author="kristwaa" created="Tue, 7 Oct 2008 16:22:10 +0100"/>
                            <attachment id="12391640" name="derby-3825-2a-internalReader_repositioning.stat" size="445" author="kristwaa" created="Tue, 7 Oct 2008 16:22:10 +0100"/>
                            <attachment id="12392079" name="derby-3825-2b-internalReader_repositioning.diff" size="24082" author="kristwaa" created="Tue, 14 Oct 2008 10:30:09 +0100"/>
                            <attachment id="12393155" name="derby-3825-3a-simplification.diff" size="2079" author="kristwaa" created="Fri, 31 Oct 2008 14:18:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 13 Oct 2008 14:26:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23866</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xdj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39225</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>