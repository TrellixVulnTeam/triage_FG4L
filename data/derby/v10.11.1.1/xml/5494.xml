<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:21:36 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5494/DERBY-5494.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5494] Same value returned by successive calls to a sequence generator flanking an unorderly shutdown.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5494</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following sequence of steps causes a sequence generator to return the same value on successive NEXT VALUE FOR calls.&lt;/p&gt;

&lt;p&gt;1) Bring up ij and issue the following commands:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create sequence s;&lt;br/&gt;
values next value for s; &lt;/p&gt;

&lt;p&gt;2) Control-c out of ij so that the engine comes down hard without an orderly shutdown.&lt;/p&gt;

&lt;p&gt;3) Now bring up ij again and issue the following commands:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:db&apos;;&lt;/p&gt;

&lt;p&gt;values next value for s; &lt;/p&gt;

&lt;p&gt;Thanks to Knut for finding this one.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12530576">DERBY-5494</key>
            <summary>Same value returned by successive calls to a sequence generator flanking an unorderly shutdown.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikem">Mike Matrigali</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_backport_reject_10_8</label>
                            <label>derby_triage10_9</label>
                    </labels>
                <created>Mon, 7 Nov 2011 14:07:03 +0000</created>
                <updated>Fri, 14 Jun 2013 18:19:29 +0100</updated>
                            <resolved>Thu, 31 May 2012 19:47:31 +0100</resolved>
                                    <version>10.6.1.0</version>
                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                    <version>10.8.2.2</version>
                    <version>10.9.1.0</version>
                                    <fixVersion>10.9.1.0</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13152128" author="kmarsden" created="Thu, 17 Nov 2011 16:40:24 +0000"  >&lt;p&gt;Does this issue affect identity columns in 10.8 or trunk?&lt;/p&gt;</comment>
                            <comment id="13152138" author="rhillegas" created="Thu, 17 Nov 2011 16:58:26 +0000"  >&lt;p&gt;Hi Kathey,&lt;/p&gt;

&lt;p&gt;There may be a variant of this issue which affects identity columns in 10.9. There may also be a variant of this issue which affects identity columns in 10.8, 10.7, and all the way back. I say that because the transaction trickiness in the sequence generators was modelled on similar trickiness in the pre-exisiting identity implementation. But I haven&apos;t investigated the implications for identity columns yet. Hopefully the solution to this problem will address identity columns, at least in 10.9.&lt;/p&gt;</comment>
                            <comment id="13238516" author="rhillegas" created="Mon, 26 Mar 2012 17:09:54 +0100"  >&lt;p&gt;To answer Kathey&apos;s question more exactly: Yes, a version of this problem also affects identity columns. This is true regardless of whether you use the new identity generators (currently implemented in 10.9) or the old-style identity generators (in 10.8).&lt;/p&gt;

&lt;p&gt;According to the SQL Standard, part 2, section 4.14.7, identity columns are supposed to behave as though they are backed by internal sequence generators. That means that commits and rollbacks are not supposed to affect identity values.&lt;/p&gt;

&lt;p&gt;The following scripts show that you can make an identity column produce the same value in two successive invocations.&lt;/p&gt;

&lt;p&gt;First run this script to generate a value and then rollback:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create procedure systemExit( in exitCode  int )&lt;br/&gt;
language java parameter style java no sql&lt;br/&gt;
external name &apos;java.lang.System.exit&apos;;&lt;/p&gt;

&lt;p&gt;create table t( a int generated always as identity, b int );&lt;/p&gt;

&lt;p&gt;autocommit off;&lt;/p&gt;

&lt;p&gt;select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.syscolumns with rs; &lt;/p&gt;

&lt;p&gt;insert into t( b ) values ( 0 );&lt;/p&gt;

&lt;p&gt;&amp;#8211; here you see that the identity column has value 1&lt;br/&gt;
select * from t;&lt;/p&gt;

&lt;p&gt;rollback;&lt;/p&gt;

&lt;p&gt;select * from t;&lt;/p&gt;

&lt;p&gt;call systemExit( 0 );&lt;/p&gt;

&lt;p&gt;Now run this script to generate a new value (which turns out to be the original value):&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:db&apos;;&lt;/p&gt;

&lt;p&gt;insert into t( b ) values ( 1 );&lt;/p&gt;

&lt;p&gt;&amp;#8211; here you see that the identity column again has value 1&lt;br/&gt;
select * from t;&lt;/p&gt;</comment>
                            <comment id="13251504" author="rhillegas" created="Wed, 11 Apr 2012 13:38:17 +0100"  >&lt;p&gt;Here is another view on the bug. In this view we add another connection which confirms that the original &quot;next value for&quot; statement durably commits a change to SYSSEQUENCES. But after the system crash, that supposedly durable change has rolled back.&lt;/p&gt;

&lt;p&gt;1) Run this script. The select from the second thread shows that SYSSEQUENCES has changed:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:db;create=true&apos; as dbo;&lt;br/&gt;
create procedure systemExit( in exitCode int ) language java parameter style java no sql external name &apos;java.lang.System.exit&apos;;&lt;br/&gt;
create sequence s;&lt;/p&gt;

&lt;p&gt;values next value for s;&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:db&apos;;&lt;br/&gt;
select currentvalue from sys.syssequences where sequencename=&apos;S&apos;;&lt;/p&gt;

&lt;p&gt;set connection dbo;&lt;br/&gt;
call systemExit( 1 );&lt;/p&gt;

&lt;p&gt;2) Now run this script. You will see that the change to SYSSEQUENCES has been rolled back:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:db&apos;;&lt;br/&gt;
select currentvalue from sys.syssequences where sequencename=&apos;S&apos;;&lt;/p&gt;</comment>
                            <comment id="13251895" author="mikem" created="Wed, 11 Apr 2012 21:26:10 +0100"  >&lt;p&gt;i am looking at the latest test case posted in comments.  Looking at log traces is seems like update of catalog row does get done in a nested transaction, and commit record is written to stream, but does not look like a force of the log is happening at that point.  Not sure why not, yet.  For some internal/nested transactions this behavior is ok as rather get the performance of a nosync commit and we don&apos;t really care as long as either all or none of the transaction gets done.  The is the case with btree splits.  I think it also makes sense for identity columns as the nested transaction only is important once some other transaction that uses one of the value commits, which in turn will force this transaction.  &lt;/p&gt;

&lt;p&gt;I don&apos;t think sequences should be using this optimization and thought that only would happen if they called commitNoSync() which I did not see in the code.&lt;/p&gt;</comment>
                            <comment id="13252024" author="mikem" created="Thu, 12 Apr 2012 00:00:05 +0100"  >&lt;p&gt;I am not sure yet how to fix, but think I understand the issue now.  At least as far back as 10.1, the system always does a no sync commit for any transaction that is not a user transaction.  I don&apos;t think this is a problem for anything other than sequences, but welcome opinions.  &lt;/p&gt;

&lt;p&gt;The comments in the code are correct but incomplete, I think the code was written before there were any nested user transactions.  the &lt;br/&gt;
internal and nested top transactions are store internal things that do not require flushing.  I am guessing since this code was added&lt;br/&gt;
we added the 2 new nested transactions, for the sql layer.&lt;/p&gt;

&lt;p&gt;I hacked the code below to always return true and the test case worked, but this is not correct fix.&lt;/p&gt;

&lt;p&gt;An easy fix that might work is to return true for user transactions and NestedRawUpdateUserTransaction.  The problem with this change is it will&lt;br/&gt;
slow down  operations that use NestedRawUpdateUserTransaction but not require forcing the log on commit.&lt;/p&gt;

&lt;p&gt;The system already has commit and&lt;br/&gt;
commitNoSync interfaces, so I think the right longterm fix would be to get rid of this code completely and change all the callers to correctly call&lt;br/&gt;
commit or commitNoSync.  &lt;/p&gt;

&lt;p&gt;The problem code is in xactfactory.java and then is called by Xact.java:&lt;br/&gt;
    /**&lt;br/&gt;
        Decide if a transaction of this contextId needs to flush the log when&lt;br/&gt;
        it commits&lt;br/&gt;
    */&lt;br/&gt;
    public boolean flushLogOnCommit(String contextName)&lt;/p&gt;
    {
        //
        // if this is a user transaction, flush the log
        // if this is an internal or nested top transaction, do not
        // flush, let it age out.
        //
        /*
        return (contextName == USER_CONTEXT_ID ||
                contextName.equals(USER_CONTEXT_ID));
        */
        return(true);
    }</comment>
                            <comment id="13252117" author="mikem" created="Thu, 12 Apr 2012 02:13:38 +0100"  >&lt;p&gt;patch not ready for commit. First step of proposed fix, this change causes all user level nested write transactions to flush commit log record.  Next step is to isolate the flushing to just sequences as I don&apos;t understand the performance ramifications of other usages in SQL layer of the nested write transaction.  Seems to fix ij repro in this JIRA, going to run tests over night to see if it has any obvious problems.  needs some comments also.&lt;/p&gt;</comment>
                            <comment id="13252528" author="mikem" created="Thu, 12 Apr 2012 17:12:07 +0100"  >&lt;p&gt;derby-5494_diff_1a.txt passed all tests, still more work needed for checkin. Note that this fix will decrease the performance of using sequences. The amount of the affect depends on how many &quot;block&quot; updates done per measured benchmark, and if the benchmark must wait on those updates. I think the worst case would be a single user insert benchmark that rarely commits, using one or more next sequence calls per inserted row. Large numbers of inserts per transaction is the usual case we recommend for users that want to insert as fast as possbile. I have not done the measurement recently but it use to be not unusual that you had to do &amp;gt; 10000 inserts per transaction to max out cpu on a single processor or you would just get I/O bottlenecked on the commit record. Make sure to measure on a machine that has proper disk syncing. After this fix each block update will have to wait for an I/O to hit disk at commit time. &lt;/p&gt;</comment>
                            <comment id="13254142" author="mikem" created="Sat, 14 Apr 2012 17:08:34 +0100"  >&lt;p&gt;This is the proposed code patch for this issue, it passes all tests on my machine (windows, xp).  Before committing I am planning on including the crash test that rick has as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5493&quot; title=&quot;Same value returned by successive calls to a sequence generator.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5493&quot;&gt;&lt;del&gt;DERBY-5493&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;</comment>
                            <comment id="13256413" author="kristwaa" created="Wed, 18 Apr 2012 11:11:47 +0100"  >&lt;p&gt;I noticed this code in the commit mail:&lt;/p&gt;

&lt;p&gt;+++ db/derby/code/trunk/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java Tue Apr 17 18:40:15 2012&lt;br/&gt;
@@ -943,12 +943,18 @@ public class XactFactory implements Tran&lt;br/&gt;
 	public boolean flushLogOnCommit(String contextName)&lt;/p&gt;
 	{
 		//
-		// if this is a user transaction, flush the log
+		// if this is a user transaction, flush the log by default.
+        // if this is a nested user update transaction, flush log by default.
 		// if this is an internal or nested top transaction, do not
 		// flush, let it age out.
+        //
+        // In all cases log will not be flushsed by Xact.prepareCommit() 
+        // if commitNoSync() has been called rather than commit.
 		//
-		return (contextName == USER_CONTEXT_ID || 
-				contextName.equals(USER_CONTEXT_ID));
+		return (contextName == USER_CONTEXT_ID               || 
+				contextName.equals(USER_CONTEXT_ID)          ||
+                contextName == NESTED_UPDATE_USER_CONTEXT_ID ||
+                contextName.equals(NESTED_UPDATE_USER_CONTEXT_ID));
 	}

&lt;p&gt;It appears that reference equality is used as an optimization, i.e. to avoid calling equals in many/some cases. With that in mind, would it make sense to group the == together first, and then the equals next?&lt;br/&gt;
Also, a comment on the use of == for string comparison wouldn&apos;t hurt.&lt;/p&gt;</comment>
                            <comment id="13256466" author="knutanders" created="Wed, 18 Apr 2012 13:07:32 +0100"  >&lt;p&gt;Alternatively, since at least OpenJDK (and I expect most other implementations) already shortcuts String.equals() on reference equality, just skip the reference check?&lt;/p&gt;</comment>
                            <comment id="13258384" author="rhillegas" created="Fri, 20 Apr 2012 18:17:18 +0100"  >&lt;p&gt;Hi Mike,&lt;/p&gt;

&lt;p&gt;Do you think work on this issue has wrapped up and it can be resolved? Thanks.&lt;/p&gt;</comment>
                            <comment id="13258429" author="mikem" created="Fri, 20 Apr 2012 19:03:44 +0100"  >&lt;p&gt;I would like opinions on whether this should be backported to 10.8 or not.  The downside is that performance will go down.  I am leaning toward not backporting this or any of the sequence changes.  &lt;/p&gt;

&lt;p&gt;There were a couple of comments after checkin, which I would rather address in a separate issue, but don&apos;t have time right now.  Long term I think the routine in question should be removed with no &quot;default&quot; syncing behavior.  All code should just make the expected commit calls that it wants.  &lt;/p&gt;</comment>
                            <comment id="13258453" author="rhillegas" created="Fri, 20 Apr 2012 19:29:47 +0100"  >&lt;p&gt;I don&apos;t think this fix should be backported in isolation. We would want to boost the pre-allocation range as well to retrieve the lost concurrency. Then we would want to warn users to always shutdown their databases gracefully in order to avoid leaking the longer preallocation range. Won&apos;t this fix degrade the concurrency of identity columns also? That might be a surprising consequence of upgrading to a supposedly stable bug-fix release.&lt;/p&gt;</comment>
                            <comment id="13271362" author="rhillegas" created="Wed, 9 May 2012 13:35:36 +0100"  >&lt;p&gt;Hi Mike,&lt;/p&gt;

&lt;p&gt;Have you reached a conclusion about whether this patch should be backported to 10.8? Thanks.&lt;/p&gt;</comment>
                            <comment id="13281933" author="mikem" created="Wed, 23 May 2012 22:34:33 +0100"  >&lt;p&gt;i do not think we should backport this change until &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5780&quot; title=&quot;identity column performance has degredated&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5780&quot;&gt;&lt;del&gt;DERBY-5780&lt;/del&gt;&lt;/a&gt; is understood.  Even then I am still leaning toward not backporting any sequence/identity changes in this area.&lt;/p&gt;</comment>
                            <comment id="13283582" author="mikem" created="Fri, 25 May 2012 17:33:48 +0100"  >&lt;p&gt;Here is proposed fix for performance degredation of identity columns caused by previous patch.  All tests passed for me running sane, classes, write sync disabled, and no special handling for upgrade tests.  I am concerned that tests took a lot longer (9+ hours) vs around 6 hours for runs in the past on this new machine doing sane, classes, write sync enabled, but I changed both the write sync option and the patch so don&apos;t have a good baseline.  Am running more tests before commit.&lt;/p&gt;

&lt;p&gt;The patch changes some interfaces to allow creaters of nested user transactions to set the default sync on transaction end when they&lt;br/&gt;
create the transaction, rather than just relying on type of transaction.  The previous patch set the intended behavior for commit but &lt;br/&gt;
abort did not pick up the intended behaviour and it turned out each insert of a identity column row did commit and then destroy which called abort.  Gets rid of the previous routine which would check type of xact for every commit so should eliminate some small codepath also.  &lt;/p&gt;</comment>
                            <comment id="13284868" author="mikem" created="Tue, 29 May 2012 16:05:30 +0100"  >&lt;p&gt;Tests all pass and I have verified that the nightly test performance is same before and after the change.  plan on committing today unless there are any reviewers who don&apos;t think it should go in.&lt;/p&gt;</comment>
                            <comment id="13285023" author="rhillegas" created="Tue, 29 May 2012 20:13:01 +0100"  >&lt;p&gt;I applied the derby-5494_3.diff patch and built insane jars. Then I re-ran the experiments described in the 5471-performance.html report attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5471&quot; title=&quot;Stress test for identity columns and sequence seem to be taking longer on trunk compared to 10.8.2.2 RC3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5471&quot;&gt;&lt;del&gt;DERBY-5471&lt;/del&gt;&lt;/a&gt;. I observed the following:&lt;/p&gt;

&lt;p&gt;o The IDENTITY 10 and IDENTITY 1 tests now run at the same transaction rate on 10.8.2.2 and the patched trunk.&lt;/p&gt;

&lt;p&gt;o The SEQUENCE 10 and SEQUENCE 1 tests run at the same transaction rate on the trunk and the patched trunk.&lt;/p&gt;

&lt;p&gt;This evidence supports the following conclusions:&lt;/p&gt;

&lt;p&gt;1) The patch restores the concurrency of identity columns seen in 10.8.2.2.&lt;/p&gt;

&lt;p&gt;2) The patch does not affect the concurrency of sequence generators.&lt;/p&gt;

&lt;p&gt;So I say +1 to the patch. Thanks.&lt;/p&gt;</comment>
                            <comment id="13285628" author="rhillegas" created="Wed, 30 May 2012 13:50:28 +0100"  >&lt;p&gt;Hi Mike,&lt;/p&gt;

&lt;p&gt;I see that you checked derby-5494_3.diff into the trunk at subversion revision 1344065. It does not appear to me that the fix has been ported to the 10.9 branch yet. Does some additional work need to be done before we port this to 10.9? Thanks.&lt;/p&gt;</comment>
                            <comment id="13285829" author="mikem" created="Wed, 30 May 2012 18:22:03 +0100"  >&lt;p&gt;i am hoping no additional work is necessary.  I am waiting to see clean trunk results from the nightly tests across platforms that include change 1327471, and once they pass am happy to backport to &lt;br/&gt;
10.9.&lt;/p&gt;

&lt;p&gt;Just realized that no public ibm tests have posted since 5/22.  I saw it saying tuesday result and assumed it was yesterday.&lt;br/&gt;
So at this point just have tinderbox nightly result which passed, and no other nightly results..&lt;/p&gt;

&lt;p&gt;looks like i missed the window for the sun runs.  &lt;/p&gt;</comment>
                            <comment id="13286685" author="rhillegas" created="Thu, 31 May 2012 17:05:01 +0100"  >&lt;p&gt;The Oracle nightly tests on the trunk passed cleanly except for a heisenbug in the replication tests on JDK 1.6: &lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.6/testing/Limited/testSummary-1344319.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.6/testing/Limited/testSummary-1344319.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13286796" author="rhillegas" created="Thu, 31 May 2012 19:19:19 +0100"  >&lt;p&gt;The IBM tests raised no errors either. Here are the Windows results: &lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/main/windows/testSummary-1344525.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/main/windows/testSummary-1344525.html&lt;/a&gt; Here are the Linux results: &lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/main/linux/testSummary-1344524.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/main/linux/testSummary-1344524.html&lt;/a&gt; Are we waiting for some other confirmation before backporting derby-5494_3.diff to 10.9? Thanks.&lt;/p&gt;</comment>
                            <comment id="13286819" author="mikem" created="Thu, 31 May 2012 19:47:31 +0100"  >&lt;p&gt;Fixed in 10.10 and backported to unreleased 10.9 branch prior to 10.9 being released.  Because of &lt;br/&gt;
change in behavior in syncing and extent of changes I don&apos;t think we should backport the changes for&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5780&quot; title=&quot;identity column performance has degredated&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5780&quot;&gt;&lt;del&gt;DERBY-5780&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5494&quot; title=&quot;Same value returned by successive calls to a sequence generator flanking an unorderly shutdown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5494&quot;&gt;&lt;del&gt;DERBY-5494&lt;/del&gt;&lt;/a&gt; to 10.8 or previous.&lt;/p&gt;</comment>
                            <comment id="13286837" author="rhillegas" created="Thu, 31 May 2012 20:04:25 +0100"  >&lt;p&gt;Changed the fix-in version to 10.9.1.0 so that this issue will appear in the 10.9.1.0 release notes.&lt;/p&gt;</comment>
                            <comment id="13291063" author="mamtas" created="Thu, 7 Jun 2012 16:09:28 +0100"  >&lt;p&gt;For both identity column and sequences, I ran two kinds of tests as explained below. I have run these tests 3 times each for 10.9 release(10.9.1.0) candidate and 10.8.1.2 release and have included the results below. The tests were run with write caching disabled.&lt;/p&gt;

&lt;p&gt;The 2 kinds of tests for sequences and identity columns were as follows&lt;br/&gt;
1)default behavior : For the test, when we let it pick the default behavior, number of threads default to 1, preallocate defaults to 100 on 10.9 and 5 on 10.8, numberOfGenerator defaults to 1, tablesPerGenerator defaults to 1 and insertsPerTransaction default to 1&lt;br/&gt;
2)In this kind of run, I passed following paramters to the test.- number of threads 1, preallocation of 1,  numberOfGenerator to 1, tablesPerGenerator to 1 and insertsPerTransaction to 100&lt;/p&gt;


&lt;p&gt;Identity test(default behavior)&lt;br/&gt;
java -Dderby.system.home=./systest/db1 org.apache.derbyTesting.perf.clients.Runner -driver org.apache.derby.jdbc.EmbeddedDriver -init -load seq_gen -load_opts debugging=0,identityTest=1 -gen b2b&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
                                              10.9.1.0|                   10.8.1.2                   &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;of transactions | Average Thruput       | - of transactions | Average Thruput&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
       5015        |   83.58333333333333  |         3889           |    64.81666666666666  &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
       4697        |   78.28333333333333  |         4578           |    76.3  &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
       5150        |   85.83333333333333  |         5016           |    83.6  &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Sequence test(default behavior)&lt;br/&gt;
java -Dderby.system.home=./systest/db4 org.apache.derbyTesting.perf.clients.Runner -driver org.apache.derby.jdbc.EmbeddedDriver -init -load seq_gen -load_opts debugging=0,identityTest=0 -gen b2b &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
                                              10.9.1.0|                   10.8.1.2                   &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;of transactions | Average Thruput       | - of transactions | Average Thruput&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
      5228        |    87.13333333333334  |         4330           |    72.16666666666667  &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
      5206        |    86.76666666666667  |         5026           |    83.76527057882369&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
      5010        |    83.5                               |         4489           |    74.81541974300428  &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Identity test(number of threads 1, preallocation of 1,  numberOfGenerator to 1, tablesPerGenerator to 1 and insertsPerTransaction to 100)&lt;br/&gt;
java -Dderby.system.home=./systest/db7 -Dderby.language.sequence.preallocator=1 org.apache.derbyTesting.perf.clients.Runner -driver org.apache.derby.jdbc.EmbeddedDriver -init -load seq_gen -load_opts debugging=0,numberOfGenerators=1,tablesPerGenerator=1,insertsPerTransaction=100,identityTest=1 -gen b2b -threads 1&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
                                              10.9.1.0|                   10.8.1.2                   &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;of transactions | Average Thruput       | - of transactions | Average Thruput&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
       1537        |   25.616666666666667 |         1086           |    18.099698338361026&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
       1628        |   27.133333333333333 |         1518           |    25.3&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
       1514        |   25.230810252308103 |         1472           |    24.533333333333335&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;Sequence test(number of threads 1, preallocation of 1,  numberOfGenerator to 1, tablesPerGenerator to 1 and insertsPerTransaction to 100)&lt;br/&gt;
java -Dderby.system.home=./systest/db11 -Dderby.language.sequence.preallocator=1 org.apache.derbyTesting.perf.clients.Runner -driver org.apache.derby.jdbc.EmbeddedDriver -init -load seq_gen -load_opts debugging=0,numberOfGenerators=1,tablesPerGenerator=1,insertsPerTransaction=100,identityTest=0 -gen b2b -threads 1 &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
                                              10.9.1.0|                   10.8.1.2                   &lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;of transactions | Average Thruput       | - of transactions | Average Thruput&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
        50         |   0.8333333333333334 |         3054           |   50.9&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
        47         |   0.7833333333333333 |         3033           |   50.55&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;br/&gt;
        49         |   0.8166666666666667 |         3000           |   50.0&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;Average time for each of the tests above&lt;br/&gt;
----------------------------------------------------------------------------------------------------------- &lt;br/&gt;
                                              10.9.1.0| 10.8.1.2 &lt;br/&gt;
----------------------------------------------------------------------------------------------------------- &lt;br/&gt;
                 Test type | # of transactions | Average Thruput | # of transactions | Average Thruput &lt;br/&gt;
----------------------------------------------------------------------------------------------------------- &lt;br/&gt;
          Identity default |       5015 | 83.58333333333333  | 4578 | 76.3 &lt;br/&gt;
----------------------------------------------------------------------------------------------------------- &lt;br/&gt;
          Sequence default |       5206 | 86.76666666666667  | 4489 | 74.81541974300428  &lt;br/&gt;
----------------------------------------------------------------------------------------------------------- &lt;br/&gt;
Identity prellocation of 1 |       1537 | 25.616666666666667 | 1472 | 24.533333333333335&lt;br/&gt;
----------------------------------------------------------------------------------------------------------- &lt;br/&gt;
Sequence prellocation of 1 |         49 | 0.8166666666666667 | 3033 | 50.55&lt;br/&gt;
----------------------------------------------------------------------------------------------------------- &lt;/p&gt;</comment>
                            <comment id="13291202" author="rhillegas" created="Thu, 7 Jun 2012 19:45:53 +0100"  >&lt;p&gt;Thanks for running the latest batch of experiments, Mamta.  It is good to see that, on your platform, the 10.9.1 defaults result in slightly better throughput for sequences and identities than the previous 10.8.2 release. Thanks.&lt;/p&gt;</comment>
                            <comment id="13291242" author="mamtas" created="Thu, 7 Jun 2012 20:32:56 +0100"  >&lt;p&gt; It looks like all the results between the 2 releases are very comparable except for sequences when the preallocation is set to 1. On 10.9.1.0, we got a thru put of 0.8166666666666667  where as on 10.8..1.2, we got thru put of 50.55 tx/sec&lt;/p&gt;</comment>
                            <comment id="13291250" author="rhillegas" created="Thu, 7 Jun 2012 20:45:09 +0100"  >&lt;p&gt;Hi Mamta,&lt;/p&gt;

&lt;p&gt;Yes, that lower throughput for sequences when preallocation is set to 1 appears to be the cost of the correctness work done in 10.9. Thanks.&lt;/p&gt;</comment>
                            <comment id="13291327" author="mikem" created="Thu, 7 Jun 2012 22:38:30 +0100"  >&lt;p&gt;The perfomance results posted are along what I expect given the work gone into 10.9.  Default behavior seems better or same for both&lt;br/&gt;
identity and sequences.&lt;/p&gt;

&lt;p&gt;The preallocation of 1, single user sequence is the worst case I can think of.  In order to insure that a sequence number is not given out&lt;br/&gt;
twice a synchonous commit is done for each allocation, where it was asynchronous in 10.8.  Not sure if we should document the &lt;br/&gt;
50 fold slowdown in the worst case.  If user does not touch tuning knobs we expect no slow down, and on this platform see a slight&lt;br/&gt;
performance gain.&lt;/p&gt;</comment>
                            <comment id="13291761" author="rhillegas" created="Fri, 8 Jun 2012 14:07:32 +0100"  >&lt;p&gt;I would be happy to build a new release candidate if we wanted to add a release note explaining how to get better concurrency for sequences by adjusting the value of derby.language.sequence.preallocator.&lt;/p&gt;

&lt;p&gt;Note, however, that the derby.language.sequence.preallocator knob is added by 10.9. It does not appear in 10.8. The knob was added by derby-4437-05-aa-pluggablePreallocation.diff (revision 1138434), ported to 10.8 by revision 1141645, but backed out of 10.8 by derby-5448-01-aa-backoutConcurrencyChanges.diff (revision 1179717).&lt;/p&gt;

&lt;p&gt;So I would not expect that this knob would be set by users upgrading from 10.8. Users  upgrading from 10.8 will get the new default preallocation size of 100.&lt;/p&gt;

&lt;p&gt;Mamta and I have run experiments with different settings of derby.language.sequence.preallocator. So far our only evidence is that the concurrency of sequences is better in 10.9 than in 10.8.&lt;/p&gt;

&lt;p&gt;At this point, I don&apos;t know what a release note would say other than &quot;We expect that the concurrency of your sequence generators has gone up by upgrading to 10.9. If you want even better concurrency, consider adjusting derby.language.sequence.preallocator.&quot;&lt;/p&gt;

&lt;p&gt;Does that advice merit a release note? Is there some other advice we should give in a release note? Does this advice merit a new release candidate?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;
</comment>
                            <comment id="13291780" author="knutanders" created="Fri, 8 Jun 2012 14:46:55 +0100"  >&lt;p&gt;I don&apos;t think it merits a new release candidate. We already mention this in the reference manual, and I don&apos;t think it&apos;s worthwhile spinning a new RC just to copy that information into the release notes.&lt;/p&gt;</comment>
                            <comment id="13291793" author="mikem" created="Fri, 8 Jun 2012 15:15:17 +0100"  >&lt;p&gt;I didn&apos;t realize that knob is new to 10.9 (at least for customer use).   So I think it is less important to note this is a release note vs whatever we have in documentation.  &lt;/p&gt;

&lt;p&gt;Just to verify the amount of preallocation is not stored in a catalog per table, correct?  A user either hard or soft upgrading a sequence from&lt;br/&gt;
10.8 is still going to see the new default 100 preallocation, correct?&lt;/p&gt;</comment>
                            <comment id="13291813" author="rhillegas" created="Fri, 8 Jun 2012 16:03:04 +0100"  >&lt;p&gt;The preallocation size is not persisted. In 10.9 the value defaults to 100 regardless of whether you hard or soft upgrade.&lt;/p&gt;</comment>
                            <comment id="13291849" author="kmarsden" created="Fri, 8 Jun 2012 17:30:28 +0100"  >&lt;p&gt;I think  &lt;b&gt;if&lt;/b&gt; we made a new release candidate, the performance improvement and relation to derby.language.sequence.preallocator would be worth mentioning in the release note.  Also might want to mention that users seeking increased performance for identity columns might want to try implementing as sequences. That way we might encourage users to exercise sequences more in preparation for ultimately transitioning identity columns to use this code.  If there is not a new release candidate, a blurb in the announcement might do just as well or even garner more attention.&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12530579">DERBY-5495</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12551640">DERBY-5697</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12525593">DERBY-5443</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12557075">DERBY-5780</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12529742" name="derby-5494_3.diff" size="26801" author="mikem" created="Fri, 25 May 2012 17:33:47 +0100"/>
                            <attachment id="12522361" name="derby-5494_diff_1a.txt" size="783" author="mikem" created="Thu, 12 Apr 2012 02:13:38 +0100"/>
                            <attachment id="12522680" name="derby-5494_diff_2.txt" size="7613" author="mikem" created="Sat, 14 Apr 2012 17:08:34 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 17 Nov 2011 16:40:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216314</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10426"><![CDATA[Known fix]]></customfieldvalue>
    <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0bfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35669</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>