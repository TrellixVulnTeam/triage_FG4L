<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:23:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5933/DERBY-5933.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5933] SQL sorting error</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5933</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Hello &lt;br/&gt;
I have a simple database with 100 records.&lt;br/&gt;
I am running a SQL query from Netbeans GUI though JDBC&lt;/p&gt;

&lt;p&gt;This query was generated by Hibernate ORM.&lt;/p&gt;

&lt;p&gt;In certain circumstances the result rowset is not sorting.&lt;/p&gt;

&lt;p&gt;When I use  condition morefld2_.mf_id in (5) the result is unsortable.&lt;br/&gt;
When I use  condition morefld2_.mf_id in (5,0) the result is sorting properly.&lt;/p&gt;

</description>
                <environment>Windows 7 Netbeans JDBC GUI</environment>
        <key id="12608438">DERBY-5933</key>
            <summary>SQL sorting error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="vigor">Vlasov Igor</reporter>
                        <labels>
                            <label>derby_triage10_10</label>
                    </labels>
                <created>Thu, 20 Sep 2012 13:29:55 +0100</created>
                <updated>Wed, 3 Sep 2014 09:31:32 +0100</updated>
                            <resolved>Mon, 4 Feb 2013 10:39:16 +0000</resolved>
                                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.2.1.6</version>
                    <version>10.3.1.4</version>
                    <version>10.4.1.3</version>
                    <version>10.5.1.1</version>
                    <version>10.6.1.0</version>
                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.3.3</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13459559" author="vigor" created="Thu, 20 Sep 2012 13:32:34 +0100"  >&lt;p&gt;The query is &lt;/p&gt;

&lt;p&gt;    select&lt;br/&gt;
        projecttas0_.t_id as t1_4_0_,&lt;br/&gt;
        project1_.p_id as p1_3_1_,&lt;br/&gt;
        morefld2_.mf_id as mf1_2_2_,&lt;br/&gt;
        user3_.usr_id as usr1_9_3_,&lt;br/&gt;
        morefld4_.mf_id as mf1_2_4_,&lt;br/&gt;
        projecttas0_.t_content as t2_4_0_,&lt;br/&gt;
        projecttas0_.t_deadline as t3_4_0_,&lt;br/&gt;
        projecttas0_.t_hours as t4_4_0_,&lt;br/&gt;
        projecttas0_.mf_level as mf9_4_0_,&lt;br/&gt;
        projecttas0_.sys_usr as sys10_4_0_,&lt;br/&gt;
        projecttas0_.sys_cre as sys5_4_0_,&lt;br/&gt;
        projecttas0_.sys_end as sys6_4_0_,&lt;br/&gt;
        projecttas0_.sys_upd as sys7_4_0_,&lt;br/&gt;
        projecttas0_.owner_id as owner11_4_0_,&lt;br/&gt;
        projecttas0_.p_id as p12_4_0_,&lt;br/&gt;
        projecttas0_.t_start as t8_4_0_,&lt;br/&gt;
        projecttas0_.mf_status as mf13_4_0_,&lt;br/&gt;
        projecttas0_.worker_id as worker14_4_0_,&lt;br/&gt;
        project1_.mf_level as mf7_3_1_,&lt;br/&gt;
        project1_.p_name as p2_3_1_,&lt;br/&gt;
        project1_.sys_usr as sys8_3_1_,&lt;br/&gt;
        project1_.sys_cre as sys3_3_1_,&lt;br/&gt;
        project1_.sys_end as sys4_3_1_,&lt;br/&gt;
        project1_.sys_upd as sys5_3_1_,&lt;br/&gt;
        project1_.p_start as p6_3_1_,&lt;br/&gt;
        morefld2_.dm_id as dm8_2_2_,&lt;br/&gt;
        morefld2_.mf_key as mf2_2_2_,&lt;br/&gt;
        morefld2_.mf_name as mf3_2_2_,&lt;br/&gt;
        morefld2_.sys_usr as sys9_2_2_,&lt;br/&gt;
        morefld2_.sys_cre as sys4_2_2_,&lt;br/&gt;
        morefld2_.sys_end as sys5_2_2_,&lt;br/&gt;
        morefld2_.sys_upd as sys6_2_2_,&lt;br/&gt;
        morefld2_.mf_order as mf7_2_2_,&lt;br/&gt;
        user3_.usr_blocked as usr2_9_3_,&lt;br/&gt;
        user3_.usr_email as usr3_9_3_,&lt;br/&gt;
        user3_.usr_fio as usr4_9_3_,&lt;br/&gt;
        user3_.if_user as if5_9_3_,&lt;br/&gt;
        user3_.last_login as last6_9_3_,&lt;br/&gt;
        user3_.usr_login as usr7_9_3_,&lt;br/&gt;
        user3_.sys_usr as sys14_9_3_,&lt;br/&gt;
        user3_.sys_cre as sys8_9_3_,&lt;br/&gt;
        user3_.sys_end as sys9_9_3_,&lt;br/&gt;
        user3_.sys_upd as sys10_9_3_,&lt;br/&gt;
        user3_.usr_password as usr11_9_3_,&lt;br/&gt;
        user3_.usr_rme_code as usr12_9_3_,&lt;br/&gt;
        user3_.usr_emailsend as usr13_9_3_,&lt;br/&gt;
        user3_.usr_type as usr15_9_3_,&lt;br/&gt;
        morefld4_.dm_id as dm8_2_4_,&lt;br/&gt;
        morefld4_.mf_key as mf2_2_4_,&lt;br/&gt;
        morefld4_.mf_name as mf3_2_4_,&lt;br/&gt;
        morefld4_.sys_usr as sys9_2_4_,&lt;br/&gt;
        morefld4_.sys_cre as sys4_2_4_,&lt;br/&gt;
        morefld4_.sys_end as sys5_2_4_,&lt;br/&gt;
        morefld4_.sys_upd as sys6_2_4_,&lt;br/&gt;
        morefld4_.mf_order as mf7_2_4_ &lt;br/&gt;
    from&lt;br/&gt;
        project_task projecttas0_ &lt;br/&gt;
    inner join&lt;br/&gt;
        project project1_ &lt;br/&gt;
            on projecttas0_.p_id=project1_.p_id &lt;br/&gt;
    inner join&lt;br/&gt;
        morefld morefld2_ &lt;br/&gt;
            on projecttas0_.mf_status=morefld2_.mf_id &lt;br/&gt;
    left outer join&lt;br/&gt;
        user_ user3_ &lt;br/&gt;
            on projecttas0_.worker_id=user3_.usr_id &lt;br/&gt;
    inner join&lt;br/&gt;
        morefld morefld4_ &lt;br/&gt;
            on projecttas0_.mf_level=morefld4_.mf_id &lt;br/&gt;
    where&lt;br/&gt;
        1=1 &lt;br/&gt;
        and (&lt;br/&gt;
            projecttas0_.sys_end is null&lt;br/&gt;
        ) &lt;br/&gt;
        and (&lt;br/&gt;
            morefld2_.mf_id in (&lt;br/&gt;
                5&lt;br/&gt;
            )&lt;br/&gt;
        ) &lt;br/&gt;
    order by&lt;br/&gt;
        projecttas0_.t_id desc fetch first 30 rows only&lt;/p&gt;</comment>
                            <comment id="13459624" author="knutanders" created="Thu, 20 Sep 2012 15:31:20 +0100"  >&lt;p&gt;If you could post the schema for the tables involved in the query, including indexes and constraints defined on those tables, it might help others reproduce the problem. For example you could post the output from running the dblook tool on the database. Thanks.&lt;/p&gt;</comment>
                            <comment id="13459716" author="kmarsden" created="Thu, 20 Sep 2012 17:31:05 +0100"  >&lt;p&gt;It would also be good to do a consistency check on the database  to make sure there is not a problem with an index.  &lt;a href=&quot;http://wiki.apache.org/db-derby/DatabaseConsistencyCheck&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DatabaseConsistencyCheck&lt;/a&gt; and even attach the zipped database if he data is not confidential and  the database is small.&lt;/p&gt;</comment>
                            <comment id="13460288" author="vigor" created="Fri, 21 Sep 2012 07:53:38 +0100"  >&lt;p&gt;sample database&lt;/p&gt;</comment>
                            <comment id="13460535" author="knutanders" created="Fri, 21 Sep 2012 15:51:38 +0100"  >&lt;p&gt;Thanks, Igor. I can reproduce the incorrect ordering on trunk. (I had to disable Derby&apos;s authentication checks to try the database, since it is password protected.)&lt;/p&gt;

&lt;p&gt;The consistency checker didn&apos;t find any problems with the database.&lt;/p&gt;

&lt;p&gt;The incorrect ordering is also seen in this simpler query:&lt;/p&gt;

&lt;p&gt;select&lt;br/&gt;
        projecttas0_.t_id&lt;br/&gt;
    from&lt;br/&gt;
        project_task projecttas0_&lt;br/&gt;
    inner join&lt;br/&gt;
        morefld morefld2_&lt;br/&gt;
            on projecttas0_.mf_status=morefld2_.mf_id&lt;br/&gt;
    left outer join&lt;br/&gt;
        user_ user3_&lt;br/&gt;
            on projecttas0_.worker_id=user3_.usr_id&lt;br/&gt;
    inner join&lt;br/&gt;
        morefld morefld4_&lt;br/&gt;
            on projecttas0_.mf_level=morefld4_.mf_id&lt;br/&gt;
    where&lt;br/&gt;
            morefld2_.mf_id = 5&lt;br/&gt;
    order by&lt;br/&gt;
        projecttas0_.t_id desc;&lt;/p&gt;</comment>
                            <comment id="13461170" author="knutanders" created="Sat, 22 Sep 2012 15:35:56 +0100"  >&lt;p&gt;Attaching repro.sql, which is a standalone, stripped-down repro for the bug. Here is what I see when I run the script on trunk:&lt;/p&gt;

&lt;p&gt;ij version 10.10&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:memory:d5933;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create table a (a1 int, a2 int, a3 int, a4 int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table b (b1 int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table c (c1 int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table d (d1 int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into a values (1,2,1,2), (2,3,1,3), (1,4,1,4);&lt;br/&gt;
3 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into b values 1;&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into d values 2,3,4;&lt;br/&gt;
3 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select a1&lt;br/&gt;
from&lt;br/&gt;
    a inner join b on a3 = b1&lt;br/&gt;
      left outer join c on a4 = c1&lt;br/&gt;
      inner join d on a2 = d1&lt;br/&gt;
where b1 = 1&lt;br/&gt;
order by a1;&lt;br/&gt;
A1         &lt;br/&gt;
-----------&lt;br/&gt;
1          &lt;br/&gt;
2          &lt;br/&gt;
1          &lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;

&lt;p&gt;The results come out unordered, even though there is an ORDER BY clause. The bug seems to go all the way back to 10.0.&lt;/p&gt;</comment>
                            <comment id="13461188" author="bryanpendleton" created="Sat, 22 Sep 2012 16:18:44 +0100"  >&lt;p&gt;I think it must be related to the outer join. If you remove the outer join, &lt;br/&gt;
the optimizer tosses a SortResultSet as the top-most result set in the&lt;br/&gt;
query plan, giving the right results:&lt;/p&gt;

&lt;p&gt;select a1&lt;br/&gt;
from&lt;br/&gt;
    a inner join b on a3 = b1&lt;br/&gt;
      inner join d on a2 = d1&lt;br/&gt;
where b1 = 1&lt;br/&gt;
order by a1;&lt;/p&gt;

&lt;p&gt;A1         &lt;br/&gt;
-----------&lt;br/&gt;
1          &lt;br/&gt;
1          &lt;br/&gt;
2          &lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;

&lt;p&gt;And if you populate table C with some matching values, and&lt;br/&gt;
then just change &quot;left outer&quot; to &quot;inner&quot; in the query, it again&lt;br/&gt;
gives the correct results:&lt;/p&gt;

&lt;p&gt;insert into c values (3), (4), (2);&lt;br/&gt;
select a1&lt;br/&gt;
from&lt;br/&gt;
    a inner join b on a3 = b1&lt;br/&gt;
      inner join c on a4 = c1&lt;br/&gt;
      inner join d on a2 = d1&lt;br/&gt;
where b1 = 1&lt;br/&gt;
order by a1;&lt;/p&gt;

&lt;p&gt;A1         &lt;br/&gt;
-----------&lt;br/&gt;
1          &lt;br/&gt;
1          &lt;br/&gt;
2          &lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;

&lt;p&gt;But even with the data present in C, the OUTER JOIN query doesn&apos;t perform the sort.&lt;/p&gt;

&lt;p&gt;Actually, if you run repro.sql with -Dderby.language.logQueryPlan=true, you can see&lt;br/&gt;
that if the OUTER JOIN is missing, the optimizer chooses a tree full of table scans,&lt;br/&gt;
nested loop joins, and an outer-most SortResultSet at the end, while with the OUTER&lt;br/&gt;
JOIN in place, the query plan is entirely comprised of HashJoin nodes.&lt;/p&gt;

&lt;p&gt;That is, the two query plans are wildly different, just by changing &quot;left outer&quot; to &quot;inner&quot;&lt;br/&gt;
in the query.&lt;/p&gt;

&lt;p&gt;Not sure if any of this helps, just wanted to share it.&lt;/p&gt;
</comment>
                            <comment id="13461790" author="knutanders" created="Mon, 24 Sep 2012 14:44:01 +0100"  >&lt;p&gt;Another observation: The optimizer knows that the predicate B1=1 means that the results are always ordered on B1 (see FromTable.tellRowOrderingAboutConstantColumns()). Although this fact should have no significance for this query, whose results should be ordered on A1 and not on B1, disabling the optimization makes the rows come out in the correct order. This is consistent with Igor&apos;s observation that changing the predicate from IN (5) to IN (5,0) made the results ordered. So maybe the sort avoidance code is confusing the two columns for some reason.&lt;/p&gt;</comment>
                            <comment id="13461806" author="dagw" created="Mon, 24 Sep 2012 15:02:30 +0100"  >&lt;p&gt;&amp;gt; So maybe the sort avoidance code is confusing the two columns for some reason. &lt;/p&gt;

&lt;p&gt;If so that wouldn&apos;t be the first bug in this area, sounds like a good candidate culprit.&lt;/p&gt;</comment>
                            <comment id="13461937" author="dagw" created="Mon, 24 Sep 2012 18:44:31 +0100"  >&lt;p&gt;Enclosing dump of the compiler tree after parsing, binding and optimization, &quot;5933.log&quot;. It shows that &lt;b&gt;both&lt;/b&gt; B1 and A1 columns are labelled &lt;br/&gt;
(4,1), i.e. tableNumber 4, columnNumber 1. In the debugger I see that the sort avoidance code checks and finds that (4,1) is indeed part of comparison with a constant. So, for some reason, the column reference for A1 here gets messed up.&lt;/p&gt;</comment>
                            <comment id="13462068" author="dagw" created="Mon, 24 Sep 2012 21:09:44 +0100"  >&lt;p&gt;Another data point: if I disable join flattening, the result is correct. I suspect the column reference remapping logic, e.g. used during &lt;/p&gt;

&lt;p&gt;PredicateList#remapColumnReferencesToExpressions&lt;br/&gt;
JoinNode#flatten&lt;br/&gt;
FromList#flattenTables&lt;br/&gt;
SelectNode#preprocess&lt;/p&gt;

&lt;p&gt;is flawed.&lt;/p&gt;</comment>
                            <comment id="13462085" author="dagw" created="Mon, 24 Sep 2012 21:24:56 +0100"  >&lt;p&gt;I checked the resulting tree after the preprocess phase of optimization, and the column reference to A1 is indeed already labeled  (4,1). The enclosed log file shows this to be the case after end of the optimization phase. The problematic labelling happens during preprocess time, at which time the flattening occurs.&lt;/p&gt;</comment>
                            <comment id="13462151" author="dagw" created="Mon, 24 Sep 2012 22:19:34 +0100"  >&lt;p&gt;Looking again, I believe that A1 is correctly labelled (4,1). The column reference to &quot;B1&quot;, however, should be (4,5), not (4,1), since B1 is the fifth column in the result set of the left outer join. So now we just need to find out why &quot;B1&quot; ends up with the wrong label after flattening.&lt;/p&gt;</comment>
                            <comment id="13462203" author="dagw" created="Mon, 24 Sep 2012 23:28:32 +0100"  >&lt;p&gt;Uploading an experimental patch which makes the query work.&lt;/p&gt;

&lt;p&gt;I found that the wrong label to the column reference &quot;B1&quot; happened when that expression was pushed into the left outer join node at this stack position:&lt;/p&gt;

&lt;p&gt;.sql.compile.ResultColumn.getColumnPosition(ResultColumn.java:447)&lt;br/&gt;
.sql.compile.ColumnReference.remapColumnReferences(ColumnReference.java:721)&lt;br/&gt;
.sql.compile.RemapCRsVisitor.visit(RemapCRsVisitor.java:75)&lt;br/&gt;
.sql.compile.QueryTreeNode.accept(QueryTreeNode.java:718)&lt;br/&gt;
.sql.compile.BinaryOperatorNode.acceptChildren(BinaryOperatorNode.java:812)&lt;br/&gt;
.sql.compile.QueryTreeNode.accept(QueryTreeNode.java:721)&lt;br/&gt;
.sql.compile.BinaryOperatorNode.acceptChildren(BinaryOperatorNode.java:812)&lt;br/&gt;
.sql.compile.QueryTreeNode.accept(QueryTreeNode.java:721)&lt;br/&gt;
.sql.compile.PredicateList.getPushablePredicates(PredicateList.java:1780)&lt;br/&gt;
.sql.compile.ProjectRestrictNode.pushExpressions(ProjectRestrictNode.java:1095)&lt;br/&gt;
.sql.compile.FromList.pushPredicates(FromList.java:846)&lt;br/&gt;
.sql.compile.SelectNode.preprocess(SelectNode.java:1238)&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;The code in ResultColumn#getColumnPosition looks like this:&lt;/p&gt;

&lt;p&gt;	public int getColumnPosition()&lt;/p&gt;
	{
		if (columnDescriptor!=null)
			return columnDescriptor.getPosition();
		else
			return virtualColumnId;

	}

&lt;p&gt;In this case, there is a columnDescriptor present in the RC (maybe because it is also used in the join condition?), but that refers the the base table &quot;B&quot;, in which &quot;B1&quot; has column position 1. However, here we are trying to push into the LOJ, in which the real position is 5, the value of virtualColumnId. So, the patch just uses virtualColumnId iff we are sitting on top of a join.&lt;/p&gt;

&lt;p&gt;I tried the patch briefly and it worked for the join and predicate pushdown tests, but I am still very wary of this hack, but I post it now anyway &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Running regressions to see what happens.&lt;/p&gt;

</comment>
                            <comment id="13462706" author="knutanders" created="Tue, 25 Sep 2012 13:44:14 +0100"  >&lt;p&gt;Good detective work, Dag!&lt;/p&gt;

&lt;p&gt;I noticed that ColumnReference.remapColumnReferencesToExpressions() had a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3023&quot; title=&quot;Different result rows depending on the sequence of INNER JOIN and OUTER JOIN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3023&quot;&gt;&lt;del&gt;DERBY-3023&lt;/del&gt;&lt;/a&gt; which made it use getVirtualColumnId() instead of getColumnPosition() if the source of the result column was a VirtualColumnNode. remapColumnReferences() does not have this fix.&lt;/p&gt;

&lt;p&gt;Adding a similar fix to remapColumnReferences() (see the attached d5933-remap.diff) also makes the results come out in the right order. It does essentially the same thing as the poc patch, only that it narrows down the change to only affect remapping.&lt;/p&gt;

&lt;p&gt;All the regression tests ran cleanly with the remap patch, FWIW.&lt;/p&gt;</comment>
                            <comment id="13462741" author="bryanpendleton" created="Tue, 25 Sep 2012 14:52:35 +0100"  >&lt;p&gt;Thanks for the pointer to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3023&quot; title=&quot;Different result rows depending on the sequence of INNER JOIN and OUTER JOIN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3023&quot;&gt;&lt;del&gt;DERBY-3023&lt;/del&gt;&lt;/a&gt;. It was very helpful to re-read Army&apos;s &lt;br/&gt;
comments in that issue, and in the older &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2526&quot; title=&quot;Wrong results with queries that use the JOIN ... ON syntax to join with views or other non-base table expressions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2526&quot;&gt;&lt;del&gt;DERBY-2526&lt;/del&gt;&lt;/a&gt;. Thank goodness for&lt;br/&gt;
6 years of accumulated JIRA discussions to refer back to!&lt;/p&gt;

&lt;p&gt;I do wonder if, in some future patch, the logic contained in d5933-remap.diff could be&lt;br/&gt;
somehow moved down into the ResultColumn class itself, rather than being&lt;br/&gt;
in its caller.&lt;/p&gt;

&lt;p&gt;But this is incredibly delicate code and I&apos;m not advocating to expand the&lt;br/&gt;
scope of this issue. +1 to the approach outlined in d5933-remap.diff.&lt;/p&gt;</comment>
                            <comment id="13462889" author="dagw" created="Tue, 25 Sep 2012 16:44:21 +0100"  >&lt;p&gt;I agree it would be nice to move this logic down, but narrowing the impact as Knut&apos;s version does is probably safer.&lt;br/&gt;
Attaching a new version which includes a test case: JoinTest#5933.&lt;/p&gt;

&lt;p&gt;Note the related issues concerning the brittleness of the column renumbering: &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4679&quot; title=&quot;Several left outer joins causes unstable query with incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4679&quot;&gt;&lt;del&gt;DERBY-4679&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4695&quot; title=&quot;Internal assignment of tablenumer, columnnumber looks wrong in query tree, although no ill effects are seen.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4695&quot;&gt;&lt;del&gt;DERBY-4695&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13463139" author="knutanders" created="Tue, 25 Sep 2012 20:30:18 +0100"  >&lt;p&gt;The remap+test patch looks good to me. Thanks for explaining the cause of the bug so clearly in the test comment. +1 to commit.&lt;/p&gt;

&lt;p&gt;As to pushing the logic down, I agree that that would be cleaner. However, it looks like there are parts of the code that expect the current behaviour of ResultColumn.getColumnPosition(). At least, I ran into trouble with some other statements when I attempted to push down the logic without the extra check for JoinNode that Dag put in the poc patch (I suspect that the JoinNode check was what made Dag call that patch a hack in the first place). So in that case I think we should create a new method rather than changing the existing one. And try to explain clearly when to use which method to retrieve the column number/position.&lt;/p&gt;

&lt;p&gt;My main problem with this code is that I don&apos;t fully understand the invariants. My first thought was that (columnDescriptor == null) == (expression instanceof VirtualColumnNode) was one, but apparently not. And that makes it more difficult to understand when to use virtualColumnId and when to use columnDescriptor.&lt;/p&gt;</comment>
                            <comment id="13463312" author="dagw" created="Tue, 25 Sep 2012 23:57:07 +0100"  >&lt;p&gt;Thanks for looking at the test and the further comments, Knut. You are right, the extra test for JoinNode made the fix so ugly I called it a hack &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I have the same problem with the code as you do as far as understanding the conditions under which the VCN has a columnDescriptor.&lt;br/&gt;
I&apos;ll see if i can run some tracing over the set of regressions tests to see if I can understand it a little better.&lt;/p&gt;

&lt;p&gt;Committed the patch d5933-remap+test as svn 1390205.&lt;/p&gt;</comment>
                            <comment id="13463356" author="bryanpendleton" created="Wed, 26 Sep 2012 00:42:23 +0100"  >&lt;p&gt;Yes, the comment in the test code is very readable and helpful, and the&lt;br/&gt;
references to the associated JIRAs are quite useful. Thanks for taking&lt;br/&gt;
the time to include that information, Dag!&lt;/p&gt;</comment>
                            <comment id="13468811" author="kmarsden" created="Wed, 3 Oct 2012 21:38:34 +0100"  >&lt;p&gt;Is there more work to do on this issue or is fixed?  It would be great to get the fix into 10.8.3.&lt;/p&gt;</comment>
                            <comment id="13570103" author="dagw" created="Mon, 4 Feb 2013 10:38:45 +0000"  >&lt;p&gt;I ran some trace on the lang suite, and it&apos;s pretty common that VCN nodes have a non-null columnDescriptor, so I don&apos;t understand the invariant either, Knut. I&apos;ll resolve this issue for now, though, since the fix went in some months ago and we haven&apos;t seen issues with it AFAIK.&lt;/p&gt;</comment>
                            <comment id="13570106" author="dagw" created="Mon, 4 Feb 2013 10:54:52 +0000"  >&lt;p&gt;Igor, feel free to close the issue if you believe it&apos;s been sufficiently addressed. If you can build a Derby version from subversion trunk and test your case with it, that would be optimal. Thanks for uncovering this bug!&lt;/p&gt;</comment>
                            <comment id="13729035" author="kmarsden" created="Mon, 5 Aug 2013 01:26:41 +0100"  >&lt;p&gt;Assign to myself for backport&lt;/p&gt;</comment>
                            <comment id="13729449" author="jira-bot" created="Mon, 5 Aug 2013 13:16:23 +0100"  >&lt;p&gt;Commit 1510445 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kmarsden&quot; class=&quot;user-hover&quot; rel=&quot;kmarsden&quot;&gt;Kathey Marsden&lt;/a&gt; in branch &apos;code/branches/10.9&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1510445&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1510445&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5933&quot; title=&quot;SQL sorting error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5933&quot;&gt;&lt;del&gt;DERBY-5933&lt;/del&gt;&lt;/a&gt; SQL sorting error&lt;br/&gt;
merge from trunk revision 1510360&lt;br/&gt;
Contributed by Dag H.Wanvik&lt;/p&gt;</comment>
                            <comment id="13729473" author="jira-bot" created="Mon, 5 Aug 2013 13:43:34 +0100"  >&lt;p&gt;Commit 1510456 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kmarsden&quot; class=&quot;user-hover&quot; rel=&quot;kmarsden&quot;&gt;Kathey Marsden&lt;/a&gt; in branch &apos;code/branches/10.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1510456&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1510456&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5933&quot; title=&quot;SQL sorting error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5933&quot;&gt;&lt;del&gt;DERBY-5933&lt;/del&gt;&lt;/a&gt; SQL sorting error&lt;br/&gt;
merge from trunk revision 1510360&lt;br/&gt;
Contributed by Dag H.Wanvik&lt;/p&gt;</comment>
                            <comment id="14119587" author="knutanders" created="Wed, 3 Sep 2014 09:31:32 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12366604">DERBY-2526</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12376689">DERBY-3023</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12465506">DERBY-4679</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12656863">DERBY-6289</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12466382">DERBY-4695</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12546346" name="5933.log" size="197239" author="dagw" created="Mon, 24 Sep 2012 18:46:12 +0100"/>
                            <attachment id="12546006" name="Helpdesk.zip" size="172204" author="vigor" created="Fri, 21 Sep 2012 07:53:38 +0100"/>
                            <attachment id="12546395" name="d5933-pof.diff" size="869" author="dagw" created="Mon, 24 Sep 2012 23:28:32 +0100"/>
                            <attachment id="12546532" name="d5933-remap+test.diff" size="3204" author="dagw" created="Tue, 25 Sep 2012 16:44:21 +0100"/>
                            <attachment id="12546506" name="d5933-remap.diff" size="885" author="knutanders" created="Tue, 25 Sep 2012 13:44:14 +0100"/>
                            <attachment id="12546164" name="repro.sql" size="416" author="knutanders" created="Sat, 22 Sep 2012 15:35:56 +0100"/>
                            <attachment id="12545899" name="right_sorting.png" size="56950" author="vigor" created="Thu, 20 Sep 2012 13:39:30 +0100"/>
                            <attachment id="12545898" name="wrong_sorting.png" size="57054" author="vigor" created="Thu, 20 Sep 2012 13:39:30 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 20 Sep 2012 14:31:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240662</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxuywf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4477</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>