<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:41:51 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4451/DERBY-4451.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4451] ArrayIndexOutOfBoundsException or ASSERT FAILED when inserting generated columns out of order</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4451</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I see this error when I specify the columns in a different order than in the table definition. It only fails if a multi-row table constructor is used.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t(a int, b generated always as (-a));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t(b,a) values (default,1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t(b,a) values (default,1), (default, 2);&lt;br/&gt;
ERROR XJ001: Java exception: &apos;1 &amp;gt;= 1: java.lang.ArrayIndexOutOfBoundsException&apos;.&lt;/p&gt;

&lt;p&gt;And in a sane build:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; insert into t(b,a) values (default,1),(default,2);&lt;br/&gt;
ERROR XJ001: Java exception: &apos;ASSERT FAILED More columns in result column list than in base table: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;/p&gt;

&lt;p&gt;This bug may be similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4448&quot; title=&quot;ArrayIndexOutOfBoundsException when trying to override generated column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4448&quot;&gt;&lt;del&gt;DERBY-4448&lt;/del&gt;&lt;/a&gt;, but the stack trace is different, and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4448&quot; title=&quot;ArrayIndexOutOfBoundsException when trying to override generated column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4448&quot;&gt;&lt;del&gt;DERBY-4448&lt;/del&gt;&lt;/a&gt; does not raise an ASSERT FAILED in sane builds.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12441154">DERBY-4451</key>
            <summary>ArrayIndexOutOfBoundsException or ASSERT FAILED when inserting generated columns out of order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Nov 2009 08:34:51 +0000</created>
                <updated>Mon, 5 Jul 2010 13:50:45 +0100</updated>
                            <resolved>Wed, 25 Nov 2009 16:01:04 +0000</resolved>
                                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12781084" author="dagw" created="Sun, 22 Nov 2009 02:10:18 +0000"  >&lt;p&gt;Uploading a fix for this, which also solves &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4448&quot; title=&quot;ArrayIndexOutOfBoundsException when trying to override generated column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4448&quot;&gt;&lt;del&gt;DERBY-4448&lt;/del&gt;&lt;/a&gt; which has the same underlying cause;&lt;br/&gt;
the checking and pruning of explictly given generated columns (only default is allowed), fails to visit all rows in a multi-row VALUES clause. The fix moves the source result set part of INSERT logic in DMLModStatementNode#forbidGenerationOverrides down to the relevant result sets, and adds tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4448&quot; title=&quot;ArrayIndexOutOfBoundsException when trying to override generated column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4448&quot;&gt;&lt;del&gt;DERBY-4448&lt;/del&gt;&lt;/a&gt; as well as this issue to GeneratedColumnsTest. Running regressions.&lt;/p&gt;
</comment>
                            <comment id="12781257" author="dagw" created="Sun, 22 Nov 2009 23:43:15 +0000"  >&lt;p&gt;Regressions passed, please review.&lt;/p&gt;</comment>
                            <comment id="12781261" author="dagw" created="Sun, 22 Nov 2009 23:57:44 +0000"  >&lt;p&gt;Uploading a slightly improved version, derby-4451b.&lt;/p&gt;</comment>
                            <comment id="12781405" author="kristwaa" created="Mon, 23 Nov 2009 13:54:24 +0000"  >&lt;p&gt;I ran the regression tests (no failures) and tried Knut&apos;s repro. It failed without the patch, and passed with the patch.&lt;br/&gt;
This area of the code is new to me, so I would need more time to fully understand the code changes.&lt;/p&gt;</comment>
                            <comment id="12781406" author="knutanders" created="Mon, 23 Nov 2009 13:58:20 +0000"  >&lt;p&gt;Thanks for the patch. I still see this ArrayIndexOutOfBoundsException, though, which appears to be another instance of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4448&quot; title=&quot;ArrayIndexOutOfBoundsException when trying to override generated column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4448&quot;&gt;&lt;del&gt;DERBY-4448&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t(x int, y generated always as (-x));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t(x,y) select * from t union select * from t;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;1 &amp;gt;= 1: java.lang.ArrayIndexOutOfBoundsException&apos;.&lt;/p&gt;</comment>
                            <comment id="12781409" author="kristwaa" created="Mon, 23 Nov 2009 14:10:10 +0000"  >&lt;p&gt;FYI, I tried the repro without the union. I can confirm that the one with the union fails for me too, as Knut reported.&lt;/p&gt;</comment>
                            <comment id="12781428" author="knutanders" created="Mon, 23 Nov 2009 15:22:24 +0000"  >&lt;p&gt;The approach in the patch looks good. Some small comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;to get consistent naming of the forbid* methods, you may want to rename the new method to forbidGenerationOverrides (note: lower-case b in forbid)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;typo in DMLModStatementNode: multi-row VALUE clause -&amp;gt; multi-row VALUES clause&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the code touched in DMLModStatementNode uses spaces for indentation, whereas the added code uses tabs&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;javadoc for ResultSetNode.forBidGenerationOverrides() says &quot;For a UnionNode representing a table constructor, this happens recursively till we have checked all rows&quot;, but in the implementation, UnionNodes that are not representing a table constructor are handled the same way.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12781493" author="dagw" created="Mon, 23 Nov 2009 17:26:18 +0000"  >&lt;p&gt;Thanks for looking at the patch, guys. Interestingly, &lt;/p&gt;

&lt;p&gt;insert into t(x,y) select * from t union select * from t; &lt;/p&gt;

&lt;p&gt;gives the ArrayIndexOutOfBoundsException, but this version:&lt;/p&gt;

&lt;p&gt;ij(CONNECTION1)&amp;gt; insert into t(y,x) select * from t union select * from t; &lt;br/&gt;
ERROR 42XA3: You may not override the value of generated column &apos;Y&apos;.&lt;/p&gt;

&lt;p&gt;works as expected. I also see that the patch doesn&apos;t handle INTERSECT/EXCEPT properly, but that&apos;s easily fixed by moving the mothod from UnionNode up to SetOperatorNode. I&apos;ll spin a new verision when I have figured out the ArrayIndexOutOfBoundsException case. Another thing is that the new version would silently remove the defaults in this case (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4426&quot; title=&quot;With generated columns,  INSERT with DEFAULT inside a VALUES clause inside a UNION fails.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4426&quot;&gt;&lt;del&gt;DERBY-4426&lt;/del&gt;&lt;/a&gt; variant):&lt;/p&gt;

&lt;p&gt;create table mytab (i int generated always as (j*2), j int);&lt;br/&gt;
insert into mytab(i,j) values (default,1) union values (default,2); &lt;/p&gt;

&lt;p&gt;wheres they should be flagged according to the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4426&quot; title=&quot;With generated columns,  INSERT with DEFAULT inside a VALUES clause inside a UNION fails.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4426&quot;&gt;&lt;del&gt;DERBY-4426&lt;/del&gt;&lt;/a&gt;..&lt;/p&gt;</comment>
                            <comment id="12781740" author="dagw" created="Tue, 24 Nov 2009 01:50:38 +0000"  >&lt;p&gt;Uploading derby-4451c, which fixes the case seen by Knut. It also now handles INTERSECT/EXCEPT and any nested use of DEFAULT, i.e. use of DEFAULT is only allowed in a top level table constructor. Note that this does not solve &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4426&quot; title=&quot;With generated columns,  INSERT with DEFAULT inside a VALUES clause inside a UNION fails.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4426&quot;&gt;&lt;del&gt;DERBY-4426&lt;/del&gt;&lt;/a&gt;, which does not have an explicit target column list, and so is not checked by forbidGenerationOverrides#forbidGenerationOverrides. We do need to add this logic here, though, for otherwise we would lose the information that the user provided a default in a nested table constructor (it would be pruned away). The alternative would be to just throw LANG_CANT_OVERRIDE_GENERATION_CLAUSE, but that could be confusing for the following query:&lt;/p&gt;

&lt;p&gt;        insert into t(a,b) values (3,default) union all values (3,default)&lt;/p&gt;

&lt;p&gt;Added more test cases, rerunning regressions.&lt;/p&gt;
</comment>
                            <comment id="12781968" author="knutanders" created="Tue, 24 Nov 2009 14:59:09 +0000"  >&lt;p&gt;If I understand correctly, the patch will disallow DEFAULT in EXCEPT/INTERSECT/UNION, but only for the queries that end up calling ResultSetNode.forbidGenerationOverrides(). This means that it will be disallowed if the DEFAULT is specified for a generated column (not for identity columns or regular columns), and an explicit column list is specified. So given a table&lt;/p&gt;

&lt;p&gt;  CREATE TABLE T(A INT, B GENERATED ALWAYS AS (-A));&lt;/p&gt;

&lt;p&gt;the following is disallowed:&lt;/p&gt;

&lt;p&gt;  INSERT INTO T(B) VALUES (DEFAULT) UNION VALUES (DEFAULT);&lt;br/&gt;
  INSERT INTO T(A, B) VALUES (DEFAULT, DEFAULT) UNION VALUES (DEFAULT, DEFAULT);&lt;/p&gt;

&lt;p&gt;whereas this is still allowed:&lt;/p&gt;

&lt;p&gt;  INSERT INTO T(A) VALUES (DEFAULT) UNION VALUES (DEFAULT);&lt;br/&gt;
  INSERT INTO T VALUES (DEFAULT, DEFAULT) UNION VALUES (DEFAULT, DEFAULT);&lt;/p&gt;

&lt;p&gt;Is that about right? If so, using this mechanism to disallow DEFAULT seems to miss most cases, so perhaps it&apos;s the wrong place to add this check? Since the checking makes the patch somewhat more complex, and it is not actually needed for this issue (is it?), perhaps it&apos;s better to leave it out and try do devise a complete fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4426&quot; title=&quot;With generated columns,  INSERT with DEFAULT inside a VALUES clause inside a UNION fails.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4426&quot;&gt;&lt;del&gt;DERBY-4426&lt;/del&gt;&lt;/a&gt; instead?&lt;/p&gt;</comment>
                            <comment id="12782000" author="dagw" created="Tue, 24 Nov 2009 16:06:45 +0000"  >&lt;p&gt;Discussed this offline with Knut, it turns out that the removal of generated columns for the case where we have an explicit target column list is not really required. This frees us from having to duplicate the checking if nested DEFAULTs at this stage also, so we can devise a solution which works for all column types; postponed this to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4426&quot; title=&quot;With generated columns,  INSERT with DEFAULT inside a VALUES clause inside a UNION fails.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4426&quot;&gt;&lt;del&gt;DERBY-4426&lt;/del&gt;&lt;/a&gt;. &lt;br/&gt;
The resulting patch is way simpler now:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;drop the call to forbidGenerationOverrides from InsertNode.&lt;/li&gt;
	&lt;li&gt;move forbidGenerationOverrides to UpdateNode since it&apos;s now only used by that class.&lt;/li&gt;
	&lt;li&gt;simplified forbidGenerationOverrides to only handle the update case&lt;/li&gt;
	&lt;li&gt;removed the test cases for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4426&quot; title=&quot;With generated columns,  INSERT with DEFAULT inside a VALUES clause inside a UNION fails.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4426&quot;&gt;&lt;del&gt;DERBY-4426&lt;/del&gt;&lt;/a&gt; from GeneratedColumnsTest seen in earlier patch versions.&lt;/li&gt;
	&lt;li&gt;removed forbidGenerationOverrides from the result sets seen in earlier patch versions.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Rerunning regressions.&lt;/p&gt;</comment>
                            <comment id="12782448" author="knutanders" created="Wed, 25 Nov 2009 14:24:38 +0000"  >&lt;p&gt;The patch looks good to me. I tried something similar in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4448&quot; title=&quot;ArrayIndexOutOfBoundsException when trying to override generated column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4448&quot;&gt;&lt;del&gt;DERBY-4448&lt;/del&gt;&lt;/a&gt; (see comment dated 19/Nov/09 08:12 AM) but for some reason that I don&apos;t remember now, I also made some changes to when InsertNode.enhanceAndCheckForAutoincrement() was called. This caused a failure in GeneratedColumnsTest. I&apos;m trying to remember why I thought that change was needed in addition to removing the call to forbidGenerationOverrides(), but nothing comes to mind, so I&apos;m guessing I just wasn&apos;t thinking clearly at that moment. +1 to commit if the regression tests ran cleanly.&lt;/p&gt;</comment>
                            <comment id="12782473" author="dagw" created="Wed, 25 Nov 2009 16:01:04 +0000"  >&lt;p&gt;Commited derby-4451d on trunk as svn 884163, resolving. I leave it open for backporting to 10.5&lt;/p&gt;</comment>
                            <comment id="12782486" author="dagw" created="Wed, 25 Nov 2009 16:22:18 +0000"  >&lt;p&gt;Investigated backporting this to 10.5, but GeneratedColumnsTest broke due to a dependency of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4420&quot; title=&quot;NullPointerException with INSERT INTO ... from EXCEPT/INTERSECT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4420&quot;&gt;&lt;del&gt;DERBY-4420&lt;/del&gt;&lt;/a&gt; which has not yet been backported.&lt;/p&gt;</comment>
                            <comment id="12782889" author="knutanders" created="Thu, 26 Nov 2009 13:18:58 +0000"  >&lt;p&gt;I&apos;ll look into backporting &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4420&quot; title=&quot;NullPointerException with INSERT INTO ... from EXCEPT/INTERSECT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4420&quot;&gt;&lt;del&gt;DERBY-4420&lt;/del&gt;&lt;/a&gt; to 10.5.&lt;/p&gt;</comment>
                            <comment id="12783011" author="dagw" created="Fri, 27 Nov 2009 02:30:21 +0000"  >&lt;p&gt;Backported to 10.5 as svn 884738 (thanks to Knut for backporting &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4420&quot; title=&quot;NullPointerException with INSERT INTO ... from EXCEPT/INTERSECT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4420&quot;&gt;&lt;del&gt;DERBY-4420&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="12828552" author="knutanders" created="Tue, 2 Feb 2010 09:35:08 +0000"  >&lt;p&gt;Verified fix on trunk. Closing.&lt;/p&gt;</comment>
                            <comment id="12885212" author="knutanders" created="Mon, 5 Jul 2010 13:50:45 +0100"  >&lt;p&gt;Changed 10.5 fix version to match the version on the branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12425745" name="derby-4451.diff" size="11683" author="dagw" created="Sun, 22 Nov 2009 02:10:18 +0000"/>
                            <attachment id="12425746" name="derby-4451.stat" size="457" author="dagw" created="Sun, 22 Nov 2009 02:10:18 +0000"/>
                            <attachment id="12425788" name="derby-4451b.diff" size="11557" author="dagw" created="Sun, 22 Nov 2009 23:59:47 +0000"/>
                            <attachment id="12425787" name="derby-4451b.stat" size="457" author="dagw" created="Sun, 22 Nov 2009 23:57:44 +0000"/>
                            <attachment id="12425923" name="derby-4451c.diff" size="17432" author="dagw" created="Tue, 24 Nov 2009 01:50:38 +0000"/>
                            <attachment id="12425924" name="derby-4451c.stat" size="560" author="dagw" created="Tue, 24 Nov 2009 01:50:38 +0000"/>
                            <attachment id="12425989" name="derby-4451d.diff" size="12691" author="dagw" created="Tue, 24 Nov 2009 18:12:49 +0000"/>
                            <attachment id="12425990" name="derby-4451d.stat" size="311" author="dagw" created="Tue, 24 Nov 2009 18:12:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 22 Nov 2009 02:10:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24264</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0q0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38032</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>