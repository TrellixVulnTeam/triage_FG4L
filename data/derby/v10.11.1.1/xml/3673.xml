<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:30:43 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3673/DERBY-3673.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3673] Add checks that a new role isn&apos;t already a user authorization id</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3673</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Derby current does not have dictionary information about legal users.&lt;br/&gt;
Authentication is configurable as being derby internal, LDAP based, or&lt;br/&gt;
user supplied.&lt;/p&gt;

&lt;p&gt;SQL specifies that user ids and role names go in the same namespace&lt;br/&gt;
(authorization ids).  Therefore, at role creation time, a new role&lt;br/&gt;
name should be checked against legal users for this database, and be&lt;br/&gt;
defined if there is already a user id by that name.&lt;/p&gt;

&lt;p&gt;Unfortunately, since there is currently no reliable dictionary&lt;br/&gt;
information about legal users, the best we can do presently is perform&lt;br/&gt;
heuristic checks that a proposed role id is not already a user id.&lt;/p&gt;

&lt;p&gt;Since the check can not not reliable, we should also add a check to&lt;br/&gt;
prohibit conncting with a user id that is a known role id.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12395926">DERBY-3673</key>
            <summary>Add checks that a new role isn&apos;t already a user authorization id</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12380756">DERBY-3137</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 May 2008 15:42:48 +0100</created>
                <updated>Mon, 4 May 2009 19:22:55 +0100</updated>
                            <resolved>Tue, 20 May 2008 19:41:32 +0100</resolved>
                                                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12596412" author="dagw" created="Tue, 13 May 2008 16:17:17 +0100"  >&lt;p&gt;This patch is a first attempt to check that a proposed new role name&lt;br/&gt;
is not already a user name. &lt;/p&gt;

&lt;p&gt;Checks performed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the proposed name does not already figure as a grantee in a&lt;br/&gt;
         permission descriptor.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the proposed name is not the user id of the current session&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if we are using Derby built-in users, check that the proposed&lt;br/&gt;
         role name is not a built-in user. If authentication is&lt;br/&gt;
         external, we have no way of knowing, alas.       &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Still missing is a check that a connection is not made with a user id&lt;br/&gt;
that is a role name.&lt;/p&gt;

&lt;p&gt;Patch details:&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/execute/CreateRoleConstantAction.java&lt;/p&gt;

&lt;p&gt;Added the above checks. I found no way of systematically going through&lt;br/&gt;
all properties which start with the string &quot;derby.user&quot;, so present&lt;br/&gt;
method tries to guess the property name on the basis of the internal&lt;br/&gt;
role name, and then look up that property, which if it exists,&lt;br/&gt;
represents a user id. This would fail if the user property is&lt;br/&gt;
specified in a non-canonical way, cf logic in&lt;br/&gt;
IdUtil.SQLIdentifier2CanonicalPropertyUsername. Any ideas here are&lt;br/&gt;
welcome.&lt;/p&gt;

&lt;p&gt;I am not really happy with this solution, so I will see if I can find&lt;br/&gt;
a way to run through all &quot;derby.user&quot; properties instead. &lt;/p&gt;

&lt;p&gt;Also, instead of just checking the authorization id of the current&lt;br/&gt;
session, it would be better to check all current sessions of course. I&lt;br/&gt;
will see if I can find a way to do that. Again, suggestions are&lt;br/&gt;
welcome.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/iapi/sql/dictionary/DataDictionary.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java&lt;/p&gt;

&lt;p&gt;Added code to look for permission grants to a specific grantee. Did&lt;br/&gt;
some refactoring here too to avoid code duplication.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/iapi/util/IdUtil.java&lt;/p&gt;

&lt;p&gt;Added SQLIdentifier2CanonicalPropertyUsername. See also comments above.&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/RolesTest.java&lt;/p&gt;

&lt;p&gt;Added some test cases, including a case which currently fails&lt;br/&gt;
(commented out for now).&lt;/p&gt;

&lt;p&gt;M      java/storeless/org/apache/derby/impl/storeless/EmptyDictionary.java&lt;/p&gt;

&lt;p&gt;stub added&lt;/p&gt;
</comment>
                            <comment id="12596456" author="dagw" created="Tue, 13 May 2008 18:14:29 +0100"  >&lt;p&gt;Refreshed the diff after a conflict arose from updating to svn 655948.&lt;/p&gt;</comment>
                            <comment id="12596750" author="dagw" created="Wed, 14 May 2008 13:56:20 +0100"  >&lt;p&gt;The test for exisiting user should probably ignore builtin users defined&lt;br/&gt;
at the system level when derby.database.propertiesOnly is true. &lt;br/&gt;
Will make that change.&lt;/p&gt;</comment>
                            <comment id="12596842" author="rhillegas" created="Wed, 14 May 2008 18:36:27 +0100"  >&lt;p&gt;Thanks for this patch, Dag. It also looks good. I have a couple comments:&lt;/p&gt;

&lt;p&gt;CreateRoleConstantAction&lt;/p&gt;

&lt;p&gt;When creating a LANG_OBJECT_ALREADY_EXISTS exception, I recommend&lt;br/&gt;
calling rd.getDescriptorType() rather than hard-coding &quot;User&quot;. This is&lt;br/&gt;
a small point but it may help us better localize this message in the&lt;br/&gt;
future.&lt;/p&gt;

&lt;p&gt;I&apos;m also curious about the check being performed in knownUser(). Are&lt;br/&gt;
we already checking that the new role name is not the same as an&lt;br/&gt;
existing authorization id in SYS.SYSSCHEMAS? Off the top of my head it&lt;br/&gt;
seems that we want to forbid those collisions and it seems likely to&lt;br/&gt;
me that such a check would catch a very broad class of collisions,&lt;br/&gt;
including most of the cases caught by the current knownUser() code.&lt;/p&gt;


&lt;p&gt;DataDictionaryImpl.inspectRoleGrants()&lt;/p&gt;

&lt;p&gt;I am a little troubled that a method with this innocent name may have&lt;br/&gt;
the side-effect of dropping a role descriptor. At the very least, I&lt;br/&gt;
think that the header comment for this method should document the&lt;br/&gt;
side-effect.&lt;/p&gt;
</comment>
                            <comment id="12597092" author="dagw" created="Thu, 15 May 2008 12:36:48 +0100"  >&lt;p&gt;Thanks for looking at this, Rick!&lt;br/&gt;
I think all your comments are valid, thanks! The schema owner authid&lt;br/&gt;
fell off my radar at some point, thanks for catching that.&lt;/p&gt;</comment>
                            <comment id="12597991" author="dagw" created="Mon, 19 May 2008 17:21:08 +0100"  >&lt;p&gt;This patch, derby-3673-2, addresses one of Ricks comments (more&lt;br/&gt;
below), and also improves somewhat on the previous implementation, in&lt;br/&gt;
that this present patch, if possible, maps from the properties user&lt;br/&gt;
(&quot;derby.user.&amp;lt;user&amp;gt;&quot; to canonical internal form before checking for a&lt;br/&gt;
match against the role, instead of trying to compute the external form&lt;br/&gt;
from the internal form and then look up that property.&lt;/p&gt;

&lt;p&gt;This will work for users defined by database properties, and system properties if&lt;br/&gt;
specified in derby.properties. However, the new approach will not work&lt;br/&gt;
for JVM properties if the security manager is enabled and the&lt;br/&gt;
permission to execute System.getProperties is not given&lt;br/&gt;
(PropertyPermission(&quot;*&quot;, &quot;read,write&quot;),&lt;br/&gt;
cf. &lt;a href=&quot;http://java.sun.com/j2se/1.5.0/docs/api/java/lang/SecurityManager.html#checkPropertiesAccess(&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/j2se/1.5.0/docs/api/java/lang/SecurityManager.html#checkPropertiesAccess(&lt;/a&gt;)).&lt;/p&gt;

&lt;p&gt;In such a case we fall back on mapping in the other direction, as in&lt;br/&gt;
the first patch, since this only needs permission to read access&lt;br/&gt;
(PropertyPermission(&quot;derby.user.*&quot;, &quot;read&quot;).&lt;/p&gt;

&lt;p&gt;Rick, the first comment where you warn against hard-coding &quot;User&quot; in&lt;br/&gt;
the error message: I don&apos;t really have a user descriptor, so I can&apos;t&lt;br/&gt;
call getDescriptorType. I did modify the hard-coded &quot;Role&quot; in the&lt;br/&gt;
error message a few lines up to use rd.getDescriptorType(), though.&lt;/p&gt;

&lt;p&gt;For the existing user case, &quot;USER&quot; is a SQL keyword so I am not sure&lt;br/&gt;
it needs be localized. But we could create a new error message to&lt;br/&gt;
cover this situation, which would be localized. What do you think?&lt;/p&gt;

&lt;p&gt;Running regression tests now.&lt;/p&gt;


&lt;p&gt;Patch details:&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/execute/CreateRoleConstantAction.java&lt;/p&gt;

&lt;p&gt;Added check against schema owners. Moved more logic over to&lt;br/&gt;
PropertyUtil#existsBuiltinUser to simplify code in&lt;br/&gt;
CreateRoleConstantAction.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java&lt;/p&gt;

&lt;p&gt;Renamed inspect* methods to visit* and added more prominent Javadocs&lt;br/&gt;
to indicate the drop behavior better.  Added existsSchemaOwnedBy.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/iapi/services/property/PropertyUtil.java&lt;/p&gt;

&lt;p&gt;Added existsBuiltinUser and minions.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/iapi/util/StringUtil.java&lt;/p&gt;

&lt;p&gt;Added normalizeSQLIdentifier and&lt;br/&gt;
compressQuotes. normalizeSQLIdentifier is used by minion of&lt;br/&gt;
PropertyUtil#existsBuiltinUser.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/iapi/util/IdUtil.java&lt;/p&gt;

&lt;p&gt;Same as previous patch.&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/RolesTest.java&lt;/p&gt;

&lt;p&gt;New test for an additional user which would we would fail to find in&lt;br/&gt;
the first patch due to mapping direction. New test for existing user&lt;br/&gt;
found via schema owner.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/compile/sqlgrammar.jj&lt;/p&gt;

&lt;p&gt;Moved a utility method, compressQuotes, to StringUtil, since I needed&lt;br/&gt;
it in StringUtil#normalizeSQLIdentifier.&lt;/p&gt;

&lt;p&gt;M      java/storeless/org/apache/derby/impl/storeless/EmptyDictionary.java&lt;br/&gt;
M      java/engine/org/apache/derby/iapi/sql/dictionary/DataDictionary.java&lt;/p&gt;

</comment>
                            <comment id="12598009" author="rhillegas" created="Mon, 19 May 2008 18:28:44 +0100"  >&lt;p&gt;Thanks, Dag. Looks good. Thanks for the explanation of the localization issues for &quot;User&quot;. I don&apos;t think this needs to be sanded down further.&lt;/p&gt;</comment>
                            <comment id="12598386" author="dagw" created="Tue, 20 May 2008 19:40:02 +0100"  >&lt;p&gt;Committed derby-3673-2 as svn version 658385.&lt;/p&gt;</comment>
                            <comment id="12598610" author="kristwaa" created="Wed, 21 May 2008 10:56:21 +0100"  >&lt;p&gt;&apos;derby-3673-3a-javadoc_fixes.diff&apos; fixes some JavaDoc warnings.&lt;br/&gt;
Committed to trunk with revision 658612.&lt;/p&gt;</comment>
                            <comment id="12598653" author="dagw" created="Wed, 21 May 2008 15:23:02 +0100"  >&lt;p&gt;Changes look good, thanks Kristian!&lt;/p&gt;</comment>
                            <comment id="12598867" author="dagw" created="Thu, 22 May 2008 01:00:54 +0100"  >&lt;p&gt;A small corner case fix which escapes &quot; inside a quoted identifer in &lt;br/&gt;
IdUtil#SQLIdentifier2CanonicalPropertyUsername.&lt;br/&gt;
Tested manually since this code path is hard to reach in the regression tests&lt;br/&gt;
(to reach it requires a user defined as a JVM property + default security manager).&lt;/p&gt;

&lt;p&gt;E.g.:&lt;br/&gt;
   java &apos;-Dderby.user.&quot;f&quot;&quot;OO&quot;=foo&apos; org.apache.derby.drda.NetworkServerControl start&lt;/p&gt;

&lt;p&gt;and then trying to do:&lt;/p&gt;

&lt;p&gt;   create role &quot;f&quot;&quot;OO&quot;;&lt;/p&gt;

&lt;p&gt;giving:&lt;/p&gt;

&lt;p&gt;  ERROR X0Y68: User &apos;f&quot;OO&apos; already exists.&lt;/p&gt;</comment>
                            <comment id="12598869" author="dagw" created="Thu, 22 May 2008 01:08:15 +0100"  >&lt;p&gt;derby-3673-3 committed as svn 658943.&lt;/p&gt;</comment>
                            <comment id="12599110" author="dagw" created="Thu, 22 May 2008 19:34:31 +0100"  >&lt;p&gt;This fix (derby-3673-4) removes redundant code in IdUtil#SQLIdentifier2CanonicalPropertyUsername by calling the existing method #normalToDelimited instead. Tested manually. Committed as svn 659195.&lt;/p&gt;</comment>
                            <comment id="12628417" author="dagw" created="Thu, 4 Sep 2008 19:10:26 +0100"  >&lt;p&gt;Uploading a javadoc patch, committed as svn 692179.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12381971" name="derby-3673-1.diff" size="27580" author="dagw" created="Tue, 13 May 2008 18:14:29 +0100"/>
                            <attachment id="12381963" name="derby-3673-1.diff" size="27510" author="dagw" created="Tue, 13 May 2008 16:17:16 +0100"/>
                            <attachment id="12381964" name="derby-3673-1.stat" size="453" author="dagw" created="Tue, 13 May 2008 16:17:16 +0100"/>
                            <attachment id="12382310" name="derby-3673-2.diff" size="43877" author="dagw" created="Mon, 19 May 2008 17:21:08 +0100"/>
                            <attachment id="12382311" name="derby-3673-2.stat" size="659" author="dagw" created="Mon, 19 May 2008 17:21:08 +0100"/>
                            <attachment id="12382527" name="derby-3673-3.diff" size="622" author="dagw" created="Thu, 22 May 2008 01:04:57 +0100"/>
                            <attachment id="12382448" name="derby-3673-3a-javadoc_fixes.diff" size="3965" author="kristwaa" created="Wed, 21 May 2008 10:56:21 +0100"/>
                            <attachment id="12382588" name="derby-3673-4.diff" size="723" author="dagw" created="Thu, 22 May 2008 19:34:31 +0100"/>
                            <attachment id="12389528" name="derby-3673-5.diff" size="5458" author="dagw" created="Thu, 4 Sep 2008 19:10:25 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 14 May 2008 17:36:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30950</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0x93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39205</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>