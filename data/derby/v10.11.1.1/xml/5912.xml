<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:30:32 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5912/DERBY-5912.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5912] testIsValidImplemented fails for NetworkServer in some slow running machines/configurations</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5912</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following test has been seen to fail as below  in some runs where the machine is under heavy load  and slow running options are specified and the isValid() call takes more than a second to return.&lt;/p&gt;

&lt;p&gt;1) testIsValidImplemented(org.apache.derbyTesting.functionTests.tests.jdbc4.ConnectionTest)junit.framework.AssertionFailedError&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.jdbc4.ConnectionTest.testIsValidImplemented(ConnectionTest.java:168)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:60)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:113)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;/p&gt;


&lt;p&gt;The test does:&lt;br/&gt;
   // Test with a 1 second timeout&lt;br/&gt;
        assertTrue(getConnection().isValid(1));&lt;/p&gt;

&lt;p&gt;assuming it will return in one second.  For embedded the int parameter is not implemented so indeed this always passes. For the Network implementation in NetConnection40.java we actually do timeout and perform a query as part of the implementation so might indeed return false. &lt;/p&gt;

</description>
                <environment></environment>
        <key id="12605318">DERBY-5912</key>
            <summary>testIsValidImplemented fails for NetworkServer in some slow running machines/configurations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="myrna">Myrna van Lunteren</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Aug 2012 01:43:59 +0100</created>
                <updated>Wed, 3 Sep 2014 09:31:22 +0100</updated>
                            <resolved>Fri, 31 Aug 2012 00:45:43 +0100</resolved>
                                    <version>10.8.3.0</version>
                                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13444439" author="myrna" created="Wed, 29 Aug 2012 22:39:37 +0100"  >&lt;p&gt;Linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1090&quot; title=&quot;Implement Connection.isValid as defined by JDBC4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1090&quot;&gt;&lt;del&gt;DERBY-1090&lt;/del&gt;&lt;/a&gt;, which has a discussion about the implementation of this method.&lt;/p&gt;</comment>
                            <comment id="13444448" author="myrna" created="Wed, 29 Aug 2012 22:48:28 +0100"  >&lt;p&gt;Attaching a patch which basically just sets a -arbitrarily chosen - really long timeout. For most machines this shouldn&apos;t matter as it normally doesn&apos;t time out.&lt;/p&gt;

&lt;p&gt;Looks from the comments in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1090&quot; title=&quot;Implement Connection.isValid as defined by JDBC4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1090&quot;&gt;&lt;del&gt;DERBY-1090&lt;/del&gt;&lt;/a&gt; that Olav tested the time-out by adding a &apos;sleep&apos; somewhere in the network server code. Does anyone have any suggestions on how to cause a time-out for this case so it can be tested for? &lt;/p&gt;</comment>
                            <comment id="13445317" author="myrna" created="Thu, 30 Aug 2012 22:35:18 +0100"  >&lt;p&gt;I committed the change with revision &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1379163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1379163&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13445452" author="myrna" created="Fri, 31 Aug 2012 00:45:43 +0100"  >&lt;p&gt;backported the fix to 10.9 with revision &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1379219&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1379219&lt;/a&gt; and backported that to 10.8 with revision &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1379230&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;amp;revision=1379230&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Resolving - if we think of an automated way to test the timeout we can open a new issue for that specifically.&lt;/p&gt;</comment>
                            <comment id="13447807" author="kmarsden" created="Tue, 4 Sep 2012 17:43:06 +0100"  >&lt;p&gt;I could not think of an automated way to to test the timeout, but it occurred to me that it would be worth testing manually because I think maybe the current client code would actually cause the connection to become invalid if it timed out because  socket_.setSoTimeout would cause permanent loss of the connection if it timed out.  There may be some recovery mechanism that I am missing though.  I think you can force a timeout by putting a sleep in DRDAConnThread.processCommands() right after this code:&lt;br/&gt;
                case CodePoint.EXCSQLIMM:&lt;br/&gt;
                    try {&lt;/p&gt;




</comment>
                            <comment id="13449979" author="myrna" created="Thu, 6 Sep 2012 20:39:58 +0100"  >&lt;p&gt;Kathey was right, when I tested this manually the connection  following the timeout indeed had become unavailable. I logged &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5919&quot; title=&quot;Network Server connection gets destroyed after isValid(#) times out.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5919&quot;&gt;DERBY-5919&lt;/a&gt; for this.&lt;/p&gt;

&lt;p&gt;The location of the sleep in EXCSQLIMM was not right, because the isValid call is actually a prepared statement call, see NetConnection40:&lt;br/&gt;
         &quot;...&lt;br/&gt;
                // Set the query timeout&lt;br/&gt;
                isValidStmt.setQueryTimeout(timeout);&lt;/p&gt;

&lt;p&gt;                // Run the query against the database&lt;br/&gt;
                ResultSet rs = isValidStmt.executeQuery();&lt;br/&gt;
                rs.close();&lt;br/&gt;
         ...  &quot;&lt;/p&gt;

&lt;p&gt;After some discussion with Kathey, I first tried the sleep in CodePoint.PRPSQLSTT, but that wasn&apos;t correct either, because before the above code snippet, NetConnection40 has this:&lt;/p&gt;

&lt;p&gt;         &quot;....&lt;br/&gt;
                if (isValidStmt == null) &lt;/p&gt;
{
                    isValidStmt = prepareStatement(&quot;VALUES (1)&quot;);
                }
&lt;p&gt; &lt;br/&gt;
          ...&quot;&lt;/p&gt;

&lt;p&gt;Kathey said: So the prepareStatment() won&apos;t happen  the second time and so we won&apos;t go through PRPSQLSTT on the server.&lt;br/&gt;
The right location for the sleep is in CodePoint.OPNQRY.&lt;/p&gt;

&lt;p&gt;I modified the current test with a test case that will not run unless one removes a &apos;x&apos; in front of the fixture name, and added the sleep, but commented out, into DRDAConnThread.&lt;/p&gt;

&lt;p&gt;I also noticed the comment saying that isValid was also tested in TestConnectionMethods.java.&lt;br/&gt;
That test has been converted to junit and renamed ConnectionMethodsTest, so I updated the comment.&lt;br/&gt;
I also modified ConnectionMethodsTest to have a longer timeout.&lt;/p&gt;

&lt;p&gt;I will attach these changes as patch, then commit these changes shortly.&lt;/p&gt;</comment>
                            <comment id="13449981" author="myrna" created="Thu, 6 Sep 2012 20:43:05 +0100"  >&lt;p&gt;Attaching a patch that:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;changes the timeout in ConnectionMethodsTest from isValid(1) to isValid(200) and adds a comment&lt;/li&gt;
	&lt;li&gt;updates the comment in ConnectionTest so it refers to ConnectionMethodsTest&lt;/li&gt;
	&lt;li&gt;has commented out sleep code in DRDAConnThread that can be uncommented to test this&lt;/li&gt;
	&lt;li&gt;adds a fixture, testIsValidWithTimeout, that is disabled by having an &apos;x&apos; in front of it, to ConnectionTest.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13449989" author="myrna" created="Thu, 6 Sep 2012 20:49:27 +0100"  >&lt;p&gt;committed with revision: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1381731&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1381731&lt;/a&gt;&lt;br/&gt;
The change to ConnectionMethodsTest can be backported to 10.9 and 10.8 if needed (and the name correction in the comment in ConnectionTest) .&lt;/p&gt;</comment>
                            <comment id="13455068" author="myrna" created="Thu, 13 Sep 2012 18:53:44 +0100"  >&lt;p&gt;Backported the comment change, and the change to ConnectionMethodsTest to 10.9 with revision 1384397 (&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1384397&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1384397&lt;/a&gt;), and to 10.8 with revision 1384432 (&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1384432&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1384432&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="14119542" author="knutanders" created="Wed, 3 Sep 2014 09:31:22 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12606465">DERBY-5919</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12329999">DERBY-1090</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12542995" name="DERBY-5912.diff" size="813" author="myrna" created="Wed, 29 Aug 2012 22:48:28 +0100"/>
                            <attachment id="12544099" name="DERBY-5912_2.diff" size="4372" author="myrna" created="Thu, 6 Sep 2012 20:43:05 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Aug 2012 21:39:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245818</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy09z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35434</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>