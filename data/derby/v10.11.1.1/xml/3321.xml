<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:15:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3321/DERBY-3321.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3321] NullPointerException for &apos;NOT EXISTS&apos; with nested subquery</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3321</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Queries with &apos;not exists&apos; followed by a nested subquery results in NPE:&lt;/p&gt;

&lt;p&gt;----------&lt;del&gt;8&amp;lt;&lt;/del&gt;-------------&lt;br/&gt;
connect &apos;jdbc:derby:testdb;create=true&apos;;&lt;br/&gt;
create table a (aa int, bb int);&lt;br/&gt;
&amp;#8211; 0 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;create table b (bb int);&lt;br/&gt;
&amp;#8211; 0 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;insert into a values (1, 1), (1, 2), (2, 2);&lt;br/&gt;
&amp;#8211; 3 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;insert into b values (1);&lt;br/&gt;
&amp;#8211; 1 row inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;select * from a &lt;br/&gt;
   where not exists &lt;br/&gt;
   (select bb from b where a.bb=b.bb);&lt;/p&gt;

&lt;p&gt;&amp;#8211; AA         |BB&lt;br/&gt;
&amp;#8211; ----------------------&lt;br/&gt;
&amp;#8211; 1          |2&lt;br/&gt;
&amp;#8211; 2          |2&lt;/p&gt;

&lt;p&gt;select bb from (select bb from b) p;&lt;br/&gt;
&amp;#8211; BB&lt;br/&gt;
&amp;#8211; -----------&lt;br/&gt;
&amp;#8211; 1&lt;/p&gt;

&lt;p&gt;select * from a &lt;br/&gt;
   where not exists &lt;br/&gt;
   (select bb from (select bb from b) p where a.bb=p.bb);&lt;br/&gt;
&amp;#8211; ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
-----------&lt;del&gt;&amp;gt;8&lt;/del&gt;---------------&lt;/p&gt;</description>
                <environment>Committed revision 651700 to 10.3</environment>
        <key id="12386370">DERBY-3321</key>
            <summary>NullPointerException for &apos;NOT EXISTS&apos; with nested subquery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomanie">Thomas Nielsen</assignee>
                                    <reporter username="jorgenlo">J&#248;rgen L&#248;land</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Jan 2008 10:42:55 +0000</created>
                <updated>Fri, 25 Apr 2008 22:07:36 +0100</updated>
                            <resolved>Thu, 6 Mar 2008 16:51:47 +0000</resolved>
                                    <version>10.0.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.2.1</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12559437" author="jorgenlo" created="Wed, 16 Jan 2008 10:47:52 +0000"  >&lt;p&gt;Attached derby.log.&lt;/p&gt;

&lt;p&gt;This issue also applies to &apos;exists&apos;, i.e. the same query without &apos;not&apos;&lt;/p&gt;</comment>
                            <comment id="12560749" author="dyret" created="Sat, 19 Jan 2008 23:58:48 +0000"  >&lt;p&gt;HI J&#248;rgen, &lt;/p&gt;

&lt;p&gt;I don&apos;t think this is the exact same problem as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3310&quot; title=&quot;ASSERT in MergeSort.checkColumnTypes() disallow legal type conversions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3310&quot;&gt;&lt;del&gt;DERBY-3310&lt;/del&gt;&lt;/a&gt; since that happens during execution, and your problem appears to happen during compilation (according to the call stack).&lt;br/&gt;
But it seems like both problems could be related to eager optimization of (NOT) EXISTS. In your case I think the problem is that in &lt;br/&gt;
SelectNode.bindTargetExpressions:584 bindTargetListOnly is temporarily set to true. This will inhibit calling fromList.bindExpressions( fromListParam ); in SelectNode.bindExpression(). This is a problem since &lt;br/&gt;
it is this call that will initialize FromSubquery.resultColumns (it is initially, null). Since the initialization is skipped you&apos;re all set for the NPE further down when  you reference resultColumns in FromSubquery.getMatchingColumn().&lt;/p&gt;

&lt;p&gt;If I keep bindTargetListOnly false I get&lt;/p&gt;

&lt;p&gt;select * from a&lt;br/&gt;
   where not exists&lt;br/&gt;
   (select bb from (select bb from b) p where a.bb=p.bb);&lt;br/&gt;
AA         |BB         &lt;br/&gt;
-----------------------&lt;br/&gt;
1          |2          &lt;br/&gt;
2          |2          &lt;/p&gt;

&lt;p&gt;2 rows selected&lt;/p&gt;

&lt;p&gt;bindTargetListOnly is used elsewhere as well, so this is probably not a viable fix. &lt;/p&gt;</comment>
                            <comment id="12568733" author="kmarsden" created="Wed, 13 Feb 2008 22:27:59 +0000"  >&lt;p&gt;Verified this back to 10.0.2.1 so it&apos;s not a regression. Below is the full stack trace.&lt;br/&gt;
   (select bb from (select bb from b) p where a.bb=p.bb);&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
java.sql.SQLException: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:88)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:245)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:1946)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:613)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:556)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:330)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:508)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:353)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:248)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:215)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:181)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.main(Main.java:73)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:59)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.FromSubquery.getMatchingColumn(FromSubquery.java:289)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.FromList.bindColumnReference(FromList.java:602)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ColumnReference.bindExpression(ColumnReference.java:349)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ResultColumn.bindExpression(ResultColumn.java:552)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ResultColumnList.bindExpressions(ResultColumnList.java:680)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SelectNode.bindExpressions(SelectNode.java:445)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SelectNode.bindTargetExpressions(SelectNode.java:597)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SubqueryNode.bindExpression(SubqueryNode.java:483)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.UnaryOperatorNode.bindOperand(UnaryOperatorNode.java:333)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.UnaryLogicalOperatorNode.bindExpression(UnaryLogicalOperatorNode.java:74)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SelectNode.bindExpressions(SelectNode.java:468)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.DMLStatementNode.bindExpressions(DMLStatementNode.java:227)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.DMLStatementNode.bind(DMLStatementNode.java:140)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.CursorNode.bindStatement(CursorNode.java:236)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:314)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:88)&lt;br/&gt;
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConne&lt;br/&gt;
ctionContext.java:768)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:607)&lt;br/&gt;
        ... 9 more&lt;/p&gt;</comment>
                            <comment id="12575330" author="thomanie" created="Wed, 5 Mar 2008 12:52:59 +0000"  >&lt;p&gt;Attaching patch proposal and test extention for this issue.&lt;/p&gt;

&lt;p&gt;Like Dyres initial analysis shows, we fail to bind the columns of the innermost subquery and end up with an NPE.&lt;br/&gt;
The patch solves this by checking the fromList for a FromSubquery using a CollectNodesVistior and basing the value of bindTargetListOnly on the contents of the visior.&lt;/p&gt;

&lt;p&gt;suites.All and derbyAll are running&lt;/p&gt;

</comment>
                            <comment id="12575405" author="thomanie" created="Wed, 5 Mar 2008 16:23:59 +0000"  >&lt;p&gt;Got some unrelated OutOfMemoryExceptions off the head of trunk when running suites.All&lt;br/&gt;
Reran only the lang._Suite, and it ran without problems.&lt;/p&gt;</comment>
                            <comment id="12575460" author="thomanie" created="Wed, 5 Mar 2008 18:59:01 +0000"  >&lt;p&gt;derbyAll ran cleanly, except for the non-empty transaction table others also have reported seeing every now and then.&lt;/p&gt;</comment>
                            <comment id="12575639" author="dyret" created="Thu, 6 Mar 2008 10:03:46 +0000"  >&lt;p&gt;Patch looks good to me. I would like to commit it shortly, unless there are further comments.&lt;/p&gt;</comment>
                            <comment id="12575749" author="dyret" created="Thu, 6 Mar 2008 15:52:28 +0000"  >&lt;p&gt;Committed revision 634316.&lt;/p&gt;</comment>
                            <comment id="12575772" author="thomanie" created="Thu, 6 Mar 2008 16:51:47 +0000"  >&lt;p&gt;Thanks Dyre!&lt;/p&gt;

&lt;p&gt;Marking as resolved.&lt;/p&gt;</comment>
                            <comment id="12578176" author="jorgenlo" created="Thu, 13 Mar 2008 07:59:15 +0000"  >&lt;p&gt;Thank you for the patch, Thomas&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12385521">DERBY-3301</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12377164" name="d3321.diff" size="2687" author="thomanie" created="Wed, 5 Mar 2008 12:52:59 +0000"/>
                            <attachment id="12377165" name="d3321.stat" size="167" author="thomanie" created="Wed, 5 Mar 2008 12:52:59 +0000"/>
                            <attachment id="12373258" name="derby.log" size="3272" author="jorgenlo" created="Wed, 16 Jan 2008 10:47:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 19 Jan 2008 23:58:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23572</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0yx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39475</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>