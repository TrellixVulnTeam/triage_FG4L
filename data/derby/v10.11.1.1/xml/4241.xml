<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:54:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4241/DERBY-4241.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4241] Improve transition from read-only to writable Clob representation</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4241</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When a store stream Clob is going to be modified, it will be written out to the temporary area of Derby and represented as a TemporaryClob.&lt;br/&gt;
The transfer of the data is done in a sub-optimal manner for two reasons;&lt;br/&gt;
 o for transfer of the complete Clob, the copy method operates on the byte level and we&apos;re not able to save the character length.&lt;br/&gt;
 o for transfer of parts of the Clob (i.e. truncation), we have to first decode the UTF-8 encoding to find the byte count and then transfer the same bytes.&lt;/p&gt;

&lt;p&gt;I intend to do the following two changes;&lt;br/&gt;
 1) Add a getCharLengthIfKnow-method to InternalClob.&lt;br/&gt;
 2) Add a UTF-8 aware copy method to LOBStreamControl.&lt;/p&gt;

&lt;p&gt;When a complete Clob is to be copied, code like this will be executed;&lt;br/&gt;
  cachedCharLength = internalClob.getLengthIfKnown();&lt;br/&gt;
  if (cachedCharLength &amp;gt; 0)&lt;br/&gt;
      // use existing byte-oriented copy method for best performance (copy until EOF)&lt;br/&gt;
  else&lt;br/&gt;
      cachedCharLength = control.copyUTF8Data()&lt;/p&gt;

&lt;p&gt;When parts of a Clob is to be copied, we always use the UTF-8 aware copy method, but we also do a cheap range check.&lt;br/&gt;
  cachedCharLength = internalClob.getLengthIfKnown();&lt;br/&gt;
  if (cachedCharLength &amp;gt; 0 &amp;amp;&amp;amp; requestedLength &amp;gt; cachedCharLength)&lt;br/&gt;
      throw EOFException();&lt;br/&gt;
  if (cachedCharLength == requestedLength)&lt;br/&gt;
     // use existing byte-oriented copy method for best performance (copy until EOF)&lt;br/&gt;
  else&lt;br/&gt;
      cachedCharLength = control.copyUTF8Data(requestedLength);&lt;/p&gt;

&lt;p&gt;Adding the UTF-8 aware copy method was started under &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4023&quot; title=&quot;Improve length caching in TemporaryClob&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4023&quot;&gt;&lt;del&gt;DERBY-4023&lt;/del&gt;&lt;/a&gt;, including comments on the first revision of a patch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12426088">DERBY-4241</key>
            <summary>Improve transition from read-only to writable Clob representation</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 May 2009 08:33:32 +0100</created>
                <updated>Mon, 29 Nov 2010 14:20:38 +0000</updated>
                            <resolved>Mon, 28 Jun 2010 10:54:47 +0100</resolved>
                                    <version>10.5.1.1</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12711989" author="kristwaa" created="Fri, 22 May 2009 09:17:33 +0100"  >&lt;p&gt;Patch 1a adds the method getLengthIfKnown to the InternalClob interface, and implements it in TemporaryClob and StoreStreamClob.&lt;/p&gt;

&lt;p&gt;I expect to commit this shortly.&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12712140" author="kristwaa" created="Fri, 22 May 2009 16:37:56 +0100"  >&lt;p&gt;Patch 4241-2a is a second revision of patch 4023-2a. The patch is dependent on path 4241-1a.&lt;br/&gt;
I have (hopefully) addressed Knut&apos;s comments from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4023&quot; title=&quot;Improve length caching in TemporaryClob&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4023&quot;&gt;&lt;del&gt;DERBY-4023&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;All feedback welcome, and especially on the working of the message I added.&lt;/p&gt;

&lt;p&gt;Regressions tests passed. &lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12717241" author="kristwaa" created="Mon, 8 Jun 2009 13:17:13 +0100"  >&lt;p&gt;Committed patch 1a to trunk with revision 782600.&lt;br/&gt;
I&apos;ll wait a few more days with patch 2a, hoping that someone will have a look at it.&lt;/p&gt;</comment>
                            <comment id="12718048" author="knutanders" created="Wed, 10 Jun 2009 13:34:25 +0100"  >&lt;p&gt;Sorry, I thought I had commented on 2a already, but seems I had only looked at it. It looks fine to me. Or perhaps &quot;correct&quot; is more accurate than &quot;fine&quot;, since the LOB code is getting more and more complex every day, it seems... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Did you run any tests to verify that the performance was improved by the changes?&lt;/p&gt;</comment>
                            <comment id="12881202" author="kristwaa" created="Tue, 22 Jun 2010 14:57:14 +0100"  >&lt;p&gt;Hi Knut,&lt;/p&gt;

&lt;p&gt;I ran a series of tests, but it&apos;s a long time ago... I was also working on some statistical analysis at that time, which hasn&apos;t made it into the Derby repos (I&apos;m not sure they can).&lt;/p&gt;

&lt;p&gt;You can see the results from one of the runs in &apos;derby-4241-32core-cmt.txt&apos;, and the file &apos;better.txt&apos; is just a grep on a series of such results.&lt;/p&gt;

&lt;p&gt;I saw up to ~65% improvement with the patch on the machines with the slowest CPUs. I believe that the benefit will be greater the larger the CLOB is (the tests used 15 MB CLOBs, I think).&lt;br/&gt;
The conclusions are based on time measurements and confidence intervals (obtained using a technique called bootstrapping) for both the mean and the standard deviation. Therefore, in some cases the conclusion was &quot;indecisive&quot;, even though looking at only the means (from a series of runs) indicated an improvement.&lt;br/&gt;
Now, since this is so long ago, please don&apos;t ask too many detailed questions &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Also, since I&apos;m no statistician, I cannot guarantee anything about the results I present...&lt;/p&gt;

&lt;p&gt;A small glossary:&lt;br/&gt;
meanP = mean point&lt;br/&gt;
meanP 2sd = the difference between the mean points are at least two times the standard deviation&lt;br/&gt;
meanP 3sd = the difference between the mean points are at least three times the standard deviation&lt;br/&gt;
meanHL 3sd = the high estimate of PATCHED lies at least three times the standard deviation away from the low estimate of BASE&lt;/p&gt;

&lt;p&gt;I cannot remember which value I used for the standard deviation, but I guess it was the point value.&lt;/p&gt;</comment>
                            <comment id="12882846" author="knutanders" created="Sat, 26 Jun 2010 16:52:56 +0100"  >&lt;p&gt;Thanks, Kristian. It sounds like this is a good improvement. +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12883086" author="kristwaa" created="Mon, 28 Jun 2010 10:53:02 +0100"  >&lt;p&gt;Thanks, Knut.&lt;/p&gt;

&lt;p&gt;Attaching revision 2b of the patch. I had to adjust the patch slightly due to other changes made since 2a was created (i.e. change the error message from I028 to I029).&lt;br/&gt;
Regression tests passed.&lt;/p&gt;</comment>
                            <comment id="12883087" author="kristwaa" created="Mon, 28 Jun 2010 10:54:47 +0100"  >&lt;p&gt;Committed patch 2b to trunk with revision 958522.&lt;/p&gt;</comment>
                            <comment id="12887705" author="kristwaa" created="Tue, 13 Jul 2010 10:59:54 +0100"  >&lt;p&gt;Backported to 10.6 with revision 963652.&lt;br/&gt;
Closing issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12412580">DERBY-4023</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12447698" name="better.txt" size="4285" author="kristwaa" created="Tue, 22 Jun 2010 14:57:13 +0100"/>
                            <attachment id="12408780" name="derby-4241-1a-InternalClob.getLengthIfKnown.diff" size="2893" author="kristwaa" created="Fri, 22 May 2009 09:17:33 +0100"/>
                            <attachment id="12408817" name="derby-4241-2a-utf8AwareCopy.diff" size="11690" author="kristwaa" created="Fri, 22 May 2009 16:37:56 +0100"/>
                            <attachment id="12448196" name="derby-4241-2b-utf8AwareCopy.diff" size="11795" author="kristwaa" created="Mon, 28 Jun 2010 10:53:02 +0100"/>
                            <attachment id="12447699" name="derby-4241-32core-cmt.txt" size="5485" author="kristwaa" created="Tue, 22 Jun 2010 14:57:14 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 10 Jun 2009 12:34:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31171</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ozr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37867</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>