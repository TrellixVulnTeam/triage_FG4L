<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:40:07 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1095/DERBY-1095.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1095] Closing an embedded connection does not seem to close associated EmbedStatements</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1095</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Closing an embedded connection (calling EmbedConnection.close()) does not seem to close associated EmbedStatements. &lt;br/&gt;
The severity of the bug is not determined. The least severe case is that the internal EmbedStatement variable &apos;active&apos; is not updated accordingly, the most severe case is that the the resources bound to EmbedStatement will not be viable for garbage collection until the EmbedStatement itself is (if user keeps references to it).&lt;br/&gt;
If methods on the statement are called, Derby will correctly throw an NoCurrentConnection exception, but the close() method is still never called automatically.&lt;br/&gt;
The problem also seem to extend down to ResultSet.isClosed(), but this is probably due to the bug in EmbedStatement.&lt;/p&gt;

&lt;p&gt;Problem detected while fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-953&quot; title=&quot;Add miscellaneous Statement methods introduced by JDBC 4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-953&quot;&gt;&lt;del&gt;DERBY-953&lt;/del&gt;&lt;/a&gt;; implement Statement.isClosed().&lt;/p&gt;</description>
                <environment></environment>
        <key id="12330137">DERBY-1095</key>
            <summary>Closing an embedded connection does not seem to close associated EmbedStatements</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djd">Daniel John Debrunner</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Mar 2006 00:26:45 +0000</created>
                <updated>Mon, 10 Apr 2006 23:51:26 +0100</updated>
                            <resolved>Mon, 10 Apr 2006 23:51:26 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12369879" author="kristwaa" created="Sat, 11 Mar 2006 00:34:29 +0000"  >&lt;p&gt;Simple repro for demonstrating the issue. Compile and run with JDK 1.6. Derby must also be built with JDK 1.6.&lt;br/&gt;
The repro will fail with a &quot;java.sql.SQLTransientConnectionException: No current connection&quot; as long as the issue exist.&lt;br/&gt;
When the issue is fixed, it should simply print two lines saying both the connection and the resultset is closed.&lt;/p&gt;</comment>
                            <comment id="12369885" author="kristwaa" created="Sat, 11 Mar 2006 00:49:09 +0000"  >&lt;p&gt;Statement.isClosed() will not return correct values on the embedded side when parent connection is closed until the blocking issue &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1095&quot; title=&quot;Closing an embedded connection does not seem to close associated EmbedStatements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1095&quot;&gt;&lt;del&gt;DERBY-1095&lt;/del&gt;&lt;/a&gt; is resolved.&lt;/p&gt;</comment>
                            <comment id="12369887" author="djd" created="Sat, 11 Mar 2006 01:07:22 +0000"  >&lt;p&gt;I wouldn&apos;t actually describe this as a bug, it&apos;s more an internal issue. As far as the application is concerned the Statement and ResultSet&apos;s are closed.&lt;br/&gt;
I see it as really  an internal optimization. &lt;/p&gt;

&lt;p&gt;I do think it needs to be fixed, I don&apos;t think the Connection having a list of open statements and calling close on them is the way to go.&lt;br/&gt;
I&apos;ve been thinking about ways to fix this related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-538&quot; title=&quot;Investigate using the standard java.net.URLClassLoader for database class loading.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-538&quot;&gt;&lt;del&gt;DERBY-538&lt;/del&gt;&lt;/a&gt;  where an application holding onto an open statement or result set&lt;br/&gt;
might hold onto the class loader indirectly and thus keep an open file. I was thinking about addressing this in the language connection&lt;br/&gt;
context, where the real list of active resources is held.&lt;/p&gt;

&lt;p&gt;Not sure why it blocks &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-953&quot; title=&quot;Add miscellaneous Statement methods introduced by JDBC 4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-953&quot;&gt;&lt;del&gt;DERBY-953&lt;/del&gt;&lt;/a&gt;, if all the other statements can detect if the Statement has been automatically closed,&lt;br/&gt;
why can&apos;t isClosed? Seems like the proposed implementation of that method is insufficient.&lt;/p&gt;</comment>
                            <comment id="12370077" author="kristwaa" created="Mon, 13 Mar 2006 00:09:28 +0000"  >&lt;p&gt;I see your point, but I still think Derby is buggy. The repro script executes a statement, closes the connection then asks the resultset if it is closed. The resultset says it is not, and based on this the repro then executes an operation that causes an exception to be thrown. A correct answer from ResultSet.isClosed() would not have caused an exception in the repro.&lt;/p&gt;

&lt;p&gt;According to the JDBC4 spec: &quot;A ResultSet is closed if the method close has been called on it, or if it is automatically closed.&quot;&lt;br/&gt;
I thought closing the underlying connection should close all associated resources, including the resultset(s). Am I mistaken?&lt;/p&gt;

&lt;p&gt;I notice that ResultSet.isClosed() simply returns a variable (&apos;isClosed&apos;), and to me it seems that the state of this variable is not maintained correctly (have not looked at the code), thus the ResultSet.isClosed() method suffers the same problem as Statement.isClosed(). We must either ensure the internal state is kept correct, or we must add extra checks to the isClosed methods.&lt;br/&gt;
Although the latter solution is very simple (at least for Statement), I personally think it would be better if the close methods were executed also when the resources are automatically &quot;closed&quot;.&lt;/p&gt;

&lt;p&gt;Dan, since you have assigned yourself to this issue, can you tell me how your (planned) solution would affect the internal state variables in ResultSet and Statment, so that I can fix Statement.isClosed accordingly?&lt;/p&gt;</comment>
                            <comment id="12370115" author="djd" created="Mon, 13 Mar 2006 11:42:11 +0000"  >&lt;p&gt;Are there bugs open for the incorrect results from Statement.isClosed() and ResultSet.isClosed? If so I can pick them up after my latest change under this bug, which is currently undergoing tests. Or I could fix them under this bug.&lt;/p&gt;</comment>
                            <comment id="12370138" author="kristwaa" created="Mon, 13 Mar 2006 17:52:33 +0000"  >&lt;p&gt;No Jiras have been opened. First patch for Statement.isClosed() is not even committed yet (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-953&quot; title=&quot;Add miscellaneous Statement methods introduced by JDBC 4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-953&quot;&gt;&lt;del&gt;DERBY-953&lt;/del&gt;&lt;/a&gt;). Code for ResultSet.isClosed() is committed under &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-948&quot; title=&quot;Miscellaneous ResultSet methods added by JDBC 4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-948&quot;&gt;&lt;del&gt;DERBY-948&lt;/del&gt;&lt;/a&gt;. &lt;br/&gt;
I was planning to  change the patch for Statement.isClosed() based on information about your planned fix, but if you want to do it just unassign me from the issue and assign yourself.&lt;/p&gt;</comment>
                            <comment id="12370210" author="knutanders" created="Tue, 14 Mar 2006 01:15:12 +0000"  >&lt;p&gt;Dan Debrunner wrote:&lt;/p&gt;

&lt;p&gt;&amp;gt; I do think it needs to be fixed, I don&apos;t think the Connection having&lt;br/&gt;
&amp;gt; a list of open statements and calling close on them is the way to&lt;br/&gt;
&amp;gt; go.&lt;/p&gt;

&lt;p&gt;In the client driver, NetConnection maintains a WeakHashMap with all&lt;br/&gt;
open statements. When the connection is marked as closed, it will call&lt;br/&gt;
markClosed() on the open statements. I&apos;m afraid I don&apos;t see why it&apos;s a&lt;br/&gt;
bad idea to do the same in EmbedConnection. Could you please explain?&lt;/p&gt;</comment>
                            <comment id="12370305" author="djd" created="Tue, 14 Mar 2006 13:13:32 +0000"  >&lt;p&gt;Knut wrote:&lt;/p&gt;

&lt;p&gt;&amp;gt; In the client driver, NetConnection maintains a WeakHashMap with all&lt;br/&gt;
&amp;gt; open statements. When the connection is marked as closed, it will call&lt;br/&gt;
&amp;gt; markClosed() on the open statements. I&apos;m afraid I don&apos;t see why it&apos;s a&lt;br/&gt;
&amp;gt; bad idea to do the same in EmbedConnection. Could you please explain?&lt;/p&gt;

&lt;p&gt;Two reasons:&lt;/p&gt;

&lt;p&gt;    1) Statement resources are already closed correctly on a connection.close() so I don&apos;t know what purpose this additional code is meant to solve.&lt;/p&gt;

&lt;p&gt;    2) Performance overhead due to storage and additional object creation and garbage collection is a concern. Maybe if it&apos;s only at the&lt;br/&gt;
     Statement level it&apos;s not too bad a concern, but there would have to be some additional logic to handle server-side JDBC. In the server-side case&lt;br/&gt;
      I don&apos;t think you want to set up the WeakHashMap, if you did the performance overhead would be a concern, because with server-side&lt;br/&gt;
       logic there is no way for the application to hang onto statements for multiple applications like a JDBC client program can. Also J2EE&lt;br/&gt;
       applications tend to be stateless and therefore incur Statement creation on each execution.&lt;/p&gt;

&lt;p&gt;For ResultSet.isClosed() a simple way of implementing it would be:&lt;/p&gt;

&lt;p&gt;  if (isClosed)&lt;br/&gt;
     return true;&lt;/p&gt;

&lt;p&gt;   try &lt;/p&gt;
{
         checkExecStatus();
          return false;
}
&lt;p&gt; catch (SQLException sqle)&lt;/p&gt;
{
     return isClosed;
}

&lt;p&gt;A similar approach would work for Statement.isClosed.&lt;/p&gt;</comment>
                            <comment id="12370338" author="kristwaa" created="Tue, 14 Mar 2006 20:16:50 +0000"  >&lt;p&gt;I do not disagree that it is easy to implement isClosed to return the intended results (I commented this when uploading the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-953&quot; title=&quot;Add miscellaneous Statement methods introduced by JDBC 4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-953&quot;&gt;&lt;del&gt;DERBY-953&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;However, by looking briefly at EmbedConnection, I cannot immediatly see how assoicated resources are closed when EmbedConnection.close() is called. Can someone familiar with the code take a few minutes to briefly explain how it is done? (I&apos;m referring to reason 1 in the previous comment by Dan)&lt;br/&gt;
With regard to statements and resultsets, are these being closed explicitly or are we only nulling out the references to them?&lt;/p&gt;</comment>
                            <comment id="12370344" author="knutanders" created="Tue, 14 Mar 2006 21:31:02 +0000"  >&lt;p&gt;Attaching patch derby-1095-ResultSet.isClosed-v1.diff.&lt;br/&gt;
EmbedResultSet40.isClosed() is fixed (and moved to&lt;br/&gt;
EmbedResultSet). Also added regression test.&lt;/p&gt;

&lt;p&gt;derbyall and jdbc4 passed.&lt;/p&gt;

&lt;p&gt;Does the patch look OK?&lt;/p&gt;</comment>
                            <comment id="12370471" author="djd" created="Wed, 15 Mar 2006 13:35:41 +0000"  >&lt;p&gt;I don&apos;t have time now to write up how the cleanup of connection close happens but it is covered somewhat in:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://db.apache.org/derby/binaries/ApacheDerbyInternals_1_1.pdf&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/binaries/ApacheDerbyInternals_1_1.pdf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slides 29-32&lt;/p&gt;

&lt;p&gt;I&apos;ll try and produce a writeup early next week.&lt;/p&gt;</comment>
                            <comment id="12370518" author="kristwaa" created="Wed, 15 Mar 2006 21:41:28 +0000"  >&lt;p&gt;Thanks Dan.&lt;/p&gt;

&lt;p&gt;The slides are nice &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Assuming they are still up-to-date, I would recommend people who haven&apos;t looked at them do so!&lt;/p&gt;</comment>
                            <comment id="12371431" author="knutanders" created="Thu, 23 Mar 2006 00:21:32 +0000"  >&lt;p&gt;The patch for ResultSet.isClosed() has to be updated because of a&lt;br/&gt;
conflict with the rearranging of the jdbc4 test suite. I will resolve&lt;br/&gt;
the conflict and commit the patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="12371521" author="knutanders" created="Thu, 23 Mar 2006 16:01:08 +0000"  >&lt;p&gt;EmbedResultSet.isClosed() is fixed in revision 388093.&lt;/p&gt;</comment>
                            <comment id="12372030" author="djd" created="Tue, 28 Mar 2006 07:43:48 +0100"  >&lt;p&gt;I think all the cleanup for this task has been performed. A connection close always did incorrectly close&lt;br/&gt;
any JDBC objects, now the context manager is cleaned up correctly as well.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12328844">DERBY-953</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12324024" name="Derby1095Repro.java" size="761" author="kristwaa" created="Sat, 11 Mar 2006 00:34:29 +0000"/>
                            <attachment id="12324159" name="derby-1095-ResultSet.isClosed-v1.diff" size="6326" author="knutanders" created="Tue, 14 Mar 2006 21:31:01 +0000"/>
                            <attachment id="12324160" name="derby-1095-ResultSet.isClosed-v1.stat" size="230" author="knutanders" created="Tue, 14 Mar 2006 21:31:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 11 Mar 2006 01:07:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22302</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy16vj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40764</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>