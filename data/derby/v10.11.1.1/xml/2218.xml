<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:16:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2218/DERBY-2218.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2218] Null Pointer Exception when an untyped NULL subquery (&quot;values null&quot;) appears outside of the FROM list in a SELECT query.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2218</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If a SELECT query contains a subquery which includes an untyped NULL value at any place other than in the FROM list, Derby will throw an NPE at bind time.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t1 (i int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;&amp;#8211; If the untyped NULL is in the FROM list, a reasonable error is thrown.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from (values null) x;&lt;br/&gt;
ERROR 42X07: Null is only allowed in a VALUES clause within an INSERT statement.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from (select * from t1, (values null) x )y;&lt;br/&gt;
ERROR 42X07: Null is only allowed in a VALUES clause within an INSERT statement.&lt;/p&gt;

&lt;p&gt;&amp;#8211; But if it appears anywhere else, the result is an NPE:&lt;/p&gt;

&lt;p&gt;&amp;#8211; IN-list&lt;br/&gt;
ij&amp;gt; select * from t1 where i in (1, 2, (values null));&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;/p&gt;

&lt;p&gt;&amp;#8211; where clause&lt;br/&gt;
select * from t1 where (values null);&lt;/p&gt;

&lt;p&gt;&amp;#8211; order by clause&lt;br/&gt;
select * from t1 order by (values null);&lt;/p&gt;

&lt;p&gt;&amp;#8211; result column&lt;br/&gt;
select (values null) from t1;&lt;/p&gt;

&lt;p&gt;&amp;#8211; group by clause (only works in 10.2 and later)&lt;br/&gt;
select * from t1 group by (values null);&lt;/p&gt;

&lt;p&gt;&amp;#8211; having clause&lt;br/&gt;
select * from t1 group by i having (values null);&lt;/p&gt;

&lt;p&gt;Stack trace (from 10.2.2) is:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.SubqueryNode.setDataTypeServices(SubqueryNode.java:2289)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.SubqueryNode.bindExpression(SubqueryNode.java:529)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ValueNodeList.bindExpression(ValueNodeList.java:130)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.BinaryListOperatorNode.bindExpression(BinaryListOperatorNode.java:161)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.SelectNode.bindExpressions(SelectNode.java:540)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.DMLStatementNode.bindExpressions(DMLStatementNode.java:249)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.DMLStatementNode.bind(DMLStatementNode.java:162)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.CursorNode.bind(CursorNode.java:253)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:345)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:119)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12359911">DERBY-2218</key>
            <summary>Null Pointer Exception when an untyped NULL subquery (&quot;values null&quot;) appears outside of the FROM list in a SELECT query.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yipng">Yip Ng</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Jan 2007 22:50:59 +0000</created>
                <updated>Mon, 5 Jul 2010 18:12:37 +0100</updated>
                            <resolved>Wed, 21 Feb 2007 18:59:18 +0000</resolved>
                                    <version>10.1.3.2</version>
                    <version>10.2.2.1</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12462632" author="yipng" created="Fri, 5 Jan 2007 22:57:08 +0000"  >&lt;p&gt;Happens in 10.1.3 too&lt;/p&gt;

&lt;p&gt;2007-01-05 22:55:13.328 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 115), (SESSIONID = 0), (DATABASE = wombat), (DRDAID = null), Cleanup action starting&lt;br/&gt;
2007-01-05 22:55:13.328 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 115), (SESSIONID = 0), (DATABASE = wombat), (DRDAID = null), Failed Statement is: select * from t1 where i in (1,2,(values null))&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.SubqueryNode.setDataTypeServices(SubqueryNode.java:2303)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.SubqueryNode.bindExpression(SubqueryNode.java:536)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ValueNodeList.bindExpression(ValueNodeList.java:137)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.BinaryListOperatorNode.bindExpression(BinaryListOperatorNode.java:164)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.SelectNode.bindExpressions(SelectNode.java:554)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.DMLStatementNode.bindExpressions(DMLStatementNode.java:247)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.DMLStatementNode.bind(DMLStatementNode.java:161)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ReadCursorNode.bind(ReadCursorNode.java:74)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.CursorNode.bind(CursorNode.java:250)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:332)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:107)&lt;br/&gt;
	at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:704)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:513)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:487)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:312)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.go(Main.java:203)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:169)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)&lt;br/&gt;
	at org.apache.derby.tools.ij.main(ij.java:60)&lt;br/&gt;
Cleanup action completed&lt;/p&gt;
</comment>
                            <comment id="12462683" author="yipng" created="Sat, 6 Jan 2007 05:15:26 +0000"  >&lt;p&gt;Attaching patch derby2218-trunk-diff01.txt.  This is a simple fix where it catches untyped null in SubqueryNode at bind phase.&lt;/p&gt;</comment>
                            <comment id="12462684" author="yipng" created="Sat, 6 Jan 2007 05:35:03 +0000"  >&lt;p&gt;Unchecking patch available.  The following should have returned an error instead of executed successfully:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t1 (i int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t1 values 1,2,3;&lt;br/&gt;
3 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from t1 where exists (values null);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;br/&gt;
1&lt;br/&gt;
2&lt;br/&gt;
3&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;</comment>
                            <comment id="12463693" author="yipng" created="Wed, 10 Jan 2007 20:14:01 +0000"  >&lt;p&gt;Attaching patch derby2218-trunk-diff02.txt to resolve the EXISTS subquery issue also.  It turns out that the EXISTS subquery will get transform from:  &lt;/p&gt;

&lt;p&gt;... EXISTS (SELECT * FROM t1 ...)&lt;/p&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;p&gt;... EXISTS (SELECT TRUE FROM t1...)&lt;/p&gt;

&lt;p&gt;So prior this transformation, the bind phase in Subquery node need to check for untyped NULL and throw the appropriate exception.&lt;/p&gt;

&lt;p&gt;derbyall + junit suite passes.&lt;/p&gt;
</comment>
                            <comment id="12466173" author="army" created="Fri, 19 Jan 2007 22:56:33 +0000"  >&lt;p&gt;I looked at the patch and it seems straightforward--thank you for tracking this down, Yip!&lt;/p&gt;

&lt;p&gt;The test cases all look good-&lt;del&gt;but I did notice that they are limited to IN and EXISTS predicates.  Since the only file you changed was SuqbueryNode.java that made me wonder if the problem didn&apos;t apply elsewhere, as well.  And sure enough, it looks like &quot;values null&quot; will cause a NPE if it appears in any part of the query except the FROM list&lt;/del&gt;-without your patch.&lt;/p&gt;

&lt;p&gt;For example, all of the following queries fail with NPEs without your patch but throw the correct error with it:&lt;/p&gt;

&lt;p&gt;&amp;#8211; where clause&lt;br/&gt;
select * from t1 where (values null);&lt;/p&gt;

&lt;p&gt;&amp;#8211; order by clause&lt;br/&gt;
select * from t1 order by (values null);&lt;/p&gt;

&lt;p&gt;&amp;#8211; result column&lt;br/&gt;
select (values null) from t1;&lt;/p&gt;

&lt;p&gt;&amp;#8211; group by clause&lt;br/&gt;
select * from t1 group by (values null);&lt;/p&gt;

&lt;p&gt;&amp;#8211; having clause&lt;br/&gt;
select * from t1 group by i having (values null);&lt;/p&gt;

&lt;p&gt;So your patch actually fixes more than just IN-list; I wonder if the description for this issue should be changed to reflect that?  In any event, do you think it would be useful to add these queries to the test, as well?  If so, that can of course come as a follow-up patch (by you or someone else with that fish to fry).&lt;/p&gt;

&lt;p&gt;My only other comment is that with your change we will end up calling:&lt;/p&gt;

&lt;p&gt;    resultSet.bindResultColumns(fromList);&lt;/p&gt;

&lt;p&gt;&lt;b&gt;twice&lt;/b&gt; for an EXISTS query.  Given that derbyall and suites.All all passed I guess this isn&apos;t really a problem--but it does kind of look weird in the code and it sort of makes me worry (a little).  How certain are we that double-binding is safe thing to do here (I admit, I didn&apos;t actually look into the relevant code)?  Would it be worth it to add some minimal logic to avoid the double bind?  Also, with the patch we call &quot;bindExpressions()&quot; for EXISTS queries when we didn&apos;t use to.  Again, this is apparently pretty harmless, but I thought I&apos;d mention it...&lt;/p&gt;

&lt;p&gt;If you think the double-binding is safe and that it&apos;s not worth adding logic to avoid it, then just let me know and I&apos;ll go ahead with the commit.  I don&apos;t consider anything I&apos;ve mentioned here to be a blocker for the patch.&lt;/p&gt;

&lt;p&gt;Thank you for picking this issue up and resolving it so quickly!&lt;/p&gt;</comment>
                            <comment id="12466178" author="army" created="Fri, 19 Jan 2007 23:10:50 +0000"  >&lt;p&gt;Changed Summary and Description to match the behavior described in my preceding comment.&lt;/p&gt;</comment>
                            <comment id="12466184" author="army" created="Fri, 19 Jan 2007 23:29:07 +0000"  >&lt;p&gt;Actually, I changed my mind &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  The patch as posted by Yip fixes the problem and doesn&apos;t break anything else (Yip reported that derbyall ran without error) so I committed it with svn #498004.  Follow-up work to address my review comments can be committed separately.&lt;/p&gt;</comment>
                            <comment id="12466185" author="yipng" created="Sat, 20 Jan 2007 00:08:06 +0000"  >&lt;p&gt;Thanks Army for taking the time to review the patch.  I can certainly post a follow up patch for the additional tests&lt;br/&gt;
you added in this jira.&lt;/p&gt;

&lt;p&gt;Yes, the resultSet.bindResultColumns(fromList) is called to make sure that the result column have its type assigned&lt;br/&gt;
by the expression.  This is what I interpreted from the method name of resultSet.bindUntypedNullsToResultColumns(null), &lt;br/&gt;
which looks to me that the RCL should be resolved before calling this method.  &lt;/p&gt;

&lt;p&gt;However, it looks like if the RC&apos;s type cannot be retrieved from the binding RC, then it will get it from its expression.  So we &lt;br/&gt;
may be able to safely remove the extra call to bindResultColumns().  But I&apos;ll rerun derbyall and junit suite to make sure &lt;br/&gt;
of that.  Will post result here when the regression completes.  &lt;/p&gt;</comment>
                            <comment id="12466210" author="yipng" created="Sat, 20 Jan 2007 04:41:01 +0000"  >&lt;p&gt;Attaching derby2218-trunk-diff03.txt for additional tests + the bindResultColumns call removal.  &lt;br/&gt;
derbyall and junit suite passes.&lt;/p&gt;</comment>
                            <comment id="12466503" author="army" created="Mon, 22 Jan 2007 16:51:50 +0000"  >&lt;p&gt;Thank you for the follow-up patch, Yip.  I ran lang/valuesclause and lang/subquery as a sanity check and then committed *diff03.txt to trunk with svn # 498689:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=498689&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=498689&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12474793" author="army" created="Wed, 21 Feb 2007 18:58:42 +0000"  >&lt;p&gt;Reopening to set Fixin version.&lt;/p&gt;</comment>
                            <comment id="12474794" author="army" created="Wed, 21 Feb 2007 18:59:18 +0000"  >&lt;p&gt;Resolving as fixed in 10.3.  Yip, do you have any interest/desire to port this back to 10.2 and/or 10.1?&lt;/p&gt;</comment>
                            <comment id="12474837" author="yipng" created="Wed, 21 Feb 2007 21:34:15 +0000"  >&lt;p&gt;Sure, Army, I will port it to 10.2 and 10.1.&lt;/p&gt;</comment>
                            <comment id="12474869" author="yipng" created="Wed, 21 Feb 2007 23:25:11 +0000"  >&lt;p&gt;Attaching derby2218-10.2-diff01.txt patch for 10.2.&lt;/p&gt;</comment>
                            <comment id="12474870" author="yipng" created="Wed, 21 Feb 2007 23:25:44 +0000"  >&lt;p&gt;Patch available for 10.2&lt;/p&gt;</comment>
                            <comment id="12474879" author="yipng" created="Thu, 22 Feb 2007 00:00:01 +0000"  >&lt;p&gt;Running regression for 10.2, will post result when it is completed.&lt;/p&gt;</comment>
                            <comment id="12474942" author="yipng" created="Thu, 22 Feb 2007 08:34:36 +0000"  >&lt;p&gt;derbyall passes for 10.2&lt;/p&gt;

&lt;p&gt;I might not be able to work on the backport and rerun the regression for 10.1 this week since I am busy with something else.  Maybe sometime next week.  &lt;/p&gt;</comment>
                            <comment id="12475059" author="army" created="Thu, 22 Feb 2007 16:01:54 +0000"  >&lt;p&gt;Thanks, Yip.  I committed derby2218-10.2-diff01.txt with svn revision 510562 and am updating the fixin version accordingly:&lt;/p&gt;


&lt;p&gt;&amp;gt; I might not be able to work on the backport and rerun the regression for 10.1 this week .&lt;/p&gt;

&lt;p&gt;That&apos;s fine.  I&apos;ll just leave the issue in RESOLVED state for now.&lt;/p&gt;</comment>
                            <comment id="12475060" author="army" created="Thu, 22 Feb 2007 16:02:09 +0000"  >&lt;p&gt;Thanks, Yip.  I committed derby2218-10.2-diff01.txt with svn revision 510562 and am updating the fixin version accordingly:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=510562&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=510562&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; I might not be able to work on the backport and rerun the regression for 10.1 this week .&lt;/p&gt;

&lt;p&gt;That&apos;s fine.  I&apos;ll just leave the issue in RESOLVED state for now.  Thank you for the port to 10.2!&lt;/p&gt;</comment>
                            <comment id="12562130" author="army" created="Thu, 24 Jan 2008 17:00:32 +0000"  >&lt;p&gt;Issue has not been ported 10.1, but there has been no request to do so.  If any such request comes in then the issue can be re-opened.  But I&apos;m marking it close for now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12351744" name="derby2218-10.2-diff01.txt" size="6383" author="yipng" created="Wed, 21 Feb 2007 23:25:11 +0000"/>
                            <attachment id="12351743" name="derby2218-10.2-stat01.txt" size="500" author="yipng" created="Wed, 21 Feb 2007 23:25:11 +0000"/>
                            <attachment id="12348427" name="derby2218-trunk-diff01.txt" size="2389" author="yipng" created="Sat, 6 Jan 2007 05:12:50 +0000"/>
                            <attachment id="12348684" name="derby2218-trunk-diff02.txt" size="4213" author="yipng" created="Wed, 10 Jan 2007 20:09:13 +0000"/>
                            <attachment id="12349304" name="derby2218-trunk-diff03.txt" size="2840" author="yipng" created="Sat, 20 Jan 2007 04:39:23 +0000"/>
                            <attachment id="12348426" name="derby2218-trunk-stat01.txt" size="330" author="yipng" created="Sat, 6 Jan 2007 05:12:50 +0000"/>
                            <attachment id="12348683" name="derby2218-trunk-stat02.txt" size="330" author="yipng" created="Wed, 10 Jan 2007 20:09:13 +0000"/>
                            <attachment id="12349303" name="derby2218-trunk-stat03.txt" size="338" author="yipng" created="Sat, 20 Jan 2007 04:39:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 5 Jan 2007 22:57:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22947</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ptz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38003</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>