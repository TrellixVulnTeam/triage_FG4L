<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:40:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-670/DERBY-670.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-670] improve space reclamation from deleted blob/clob columns which are bigger than a page</title>
                <link>https://issues.apache.org/jira/browse/DERBY-670</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Currently Derby space reclamation is initiated after all the rows on a &lt;br/&gt;
MAIN page are delted.  When blob/clob&apos;s larger than a page are involved&lt;br/&gt;
the row on the main page only keeps a pointer to a page chain, so the&lt;br/&gt;
main page rows can be very small and thus may take a lot of rows to be&lt;br/&gt;
deleted before we clean up and reuse space associated with blob/clob.&lt;br/&gt;
So in an extreme case of a table with only a int key and a 1 blob column&lt;br/&gt;
with N bytes , and a 32k &lt;br/&gt;
page derby probably stores more than 1000 rows.  If the app simply does&lt;br/&gt;
insert/delete of a single row it will grow to 1000 * N bytes&lt;br/&gt;
for an app that to the user should only be on the order of N big.&lt;/p&gt;

&lt;p&gt;It would seem reasonable to queue a post commit for any delete which&lt;br/&gt;
includes a blob/clob that has been chained.  This is in keeping with&lt;br/&gt;
the current policy to queue the work when it is possible we can reclaim&lt;br/&gt;
an entire page.  &lt;/p&gt;

&lt;p&gt;The problem is that there would be an extra cost at delete time to &lt;br/&gt;
determine if the row being deleted has a blob/clob page chain.  The&lt;br/&gt;
actual information is stored in the field header of that particular&lt;br/&gt;
column so currently the only way to check would be to check every&lt;br/&gt;
field header of every column in the deleted row.  From the store&apos;s&lt;br/&gt;
point of view every column can be &quot;long&quot; with a page chain &amp;#8211; currently&lt;br/&gt;
it doesn&apos;t know that only blob/clob datatypes can cause this behavior.&lt;/p&gt;

&lt;p&gt;Some options include:&lt;/p&gt;

&lt;p&gt;1 at table create time ask for input from language to say if one of&lt;br/&gt;
  these is at all possible, so that check is never done if not &lt;br/&gt;
  necessary.&lt;br/&gt;
2 Maintain a bit in the container header with some sort of indication if any long&lt;br/&gt;
    row exists, may simply 1/0 or a reference count.   Note information is easily&lt;br/&gt;
     available at insert time.&lt;br/&gt;
3 maintain a bit in the page indicating if any long rows exist&lt;br/&gt;
4 maintain a bit in the record header if any long columns exist,  note the existing bit&lt;br/&gt;
    is only if the whole record is overflowed, not if a single column is overflowed.&lt;/p&gt;

&lt;p&gt;options 1-3 would then be used to only perform the slow check at delete time if  necessary.&lt;/p&gt;

&lt;p&gt;I don&apos;t really like option 1 unless we change the storage interface to actually check/guarantee the behavior.&lt;/p&gt;

&lt;p&gt;I lean toward option 4, but it is sort of a row format change.  Given that the system has room saved for this&lt;br/&gt;
bit I believe we can use it without any sort of upgrade-time work necessary - though I believe it can only be set on a&lt;br/&gt;
hard upgrade as there may be old code which does not expect it to be set.  Soft upgrades won&apos;t get the&lt;br/&gt;
benefit and existing data won&apos;t get the benefit.&lt;/p&gt;

&lt;p&gt;Any other ideas out there?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12325225">DERBY-670</key>
            <summary>improve space reclamation from deleted blob/clob columns which are bigger than a page</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikem">Mike Matrigali</assignee>
                                    <reporter username="mikem">Mike Matrigali</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Nov 2005 10:29:04 +0000</created>
                <updated>Wed, 27 Jul 2011 20:57:37 +0100</updated>
                            <resolved>Mon, 14 May 2007 18:39:59 +0100</resolved>
                                    <version>10.1.1.0</version>
                                    <fixVersion>10.2.2.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12369120" author="mikem" created="Tue, 7 Mar 2006 09:12:25 +0000"  >&lt;p&gt;this patch just uses the exising row and column header information to schedule deleted rows to be &lt;br/&gt;
post commit reclaimed immediately  if the row is long or has a long column.  The overhead was not&lt;br/&gt;
much to just check the in memory part of the row on the current cached page.  &lt;/p&gt;

&lt;p&gt;committed :&lt;br/&gt;
m2_142:5&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\iapi\store\raw\Page.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\conglomerate\Gener&lt;br/&gt;
icConglomerateController.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\StoredRecordHead&lt;br/&gt;
er.java&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\master\st_recl&lt;br/&gt;
aim_longcol.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\suites\storete&lt;br/&gt;
sts.runall&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\store\Ba&lt;br/&gt;
seTest.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\store\On&lt;br/&gt;
lineCompressTest.java&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\storetes&lt;br/&gt;
ts\st_reclaim_longcol.java&lt;br/&gt;
Transmitting file data .........&lt;br/&gt;
Committed revision 383663.&lt;/p&gt;</comment>
                            <comment id="12495691" author="mikem" created="Mon, 14 May 2007 18:39:27 +0100"  >&lt;p&gt;reopening to set fix in.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12515565">DERBY-5356</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>29650</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>