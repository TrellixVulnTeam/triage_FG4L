<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:16:40 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2183/DERBY-2183.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2183] Trigger recompilation problem when trigger action has its table not qualified with a schema</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2183</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Trigger recompilation problem when trigger action has its table not qualified with a schema.&lt;/p&gt;

&lt;p&gt;SPSs in SYS.SYSSTATEMENTS get invalidated for recompilation when sqlj.install_jar, sqlj.remove_jar, sqlj.replace_jar are called, or when a database upgrade is performed.  The problem arises when the trigger action statement does not qualify the table with an explicit schema name.  During recompilation it uses the default schema instead of using the original schema that was persisted in SYS.SYSSTATEMENTS causing an exception to occur.  e.g.:&lt;/p&gt;

&lt;p&gt;C:\derby\trunk&amp;gt;java -classpath classes;. org.apache.derby.tools.ij&lt;br/&gt;
ij version 10.3&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:wombat;create=true&apos;;&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table app.t1 (i int, j int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;ij&amp;gt; insert into app.t1 values (1,10);&lt;br/&gt;
1 row inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;&amp;#8211; notice trigger action&apos;s update statement did not qualify table t1 with a schema name&lt;br/&gt;
ij&amp;gt; create trigger app.tr1 after update of i on app.t1 update t1 set j = 1;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;ij&amp;gt; update app.t1 set i=i+1;&lt;br/&gt;
1 row inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from app.t1;&lt;br/&gt;
I          |J&lt;br/&gt;
-----------------------&lt;br/&gt;
2          |1&lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;

&lt;p&gt;&amp;#8211; this action invalidates the SPS and mark for recompilation&lt;br/&gt;
ij&amp;gt; call sqlj.install_jar(&apos;c:/derby/procs/Procs.jar&apos;, &apos;APP.Procs&apos;, 0);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; disconnect;&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:wombat&apos; user &apos;user1&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; recompilation occurs but uses &apos;USER1&apos; as the schema to compile instead of &apos;APP&apos;, resulting in error&lt;br/&gt;
ij&amp;gt; update app.t1 set i=i+1;&lt;br/&gt;
ERROR 42Y07: Schema &apos;USER1&apos; does not exist&lt;br/&gt;
ij&amp;gt;&lt;/p&gt;</description>
                <environment>Any</environment>
        <key id="12358800">DERBY-2183</key>
            <summary>Trigger recompilation problem when trigger action has its table not qualified with a schema</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yipng">Yip Ng</assignee>
                                    <reporter username="yipng">Yip Ng</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Dec 2006 19:01:24 +0000</created>
                <updated>Mon, 5 Jul 2010 18:32:49 +0100</updated>
                            <resolved>Thu, 4 Jan 2007 20:56:59 +0000</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.1.3.3</fixVersion>
                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12459102" author="yipng" created="Sun, 17 Dec 2006 02:23:40 +0000"  >&lt;p&gt;Attaching initial patch derby2813-trunk-diff01.txt for review.  derbyall and junit test suite passes successfully.  &lt;/p&gt;

&lt;p&gt;The problem was that the compilation schema for the SPS was never set during its recompilation, it was using the current schema to perform the recompilation which is not correct.  It should have use the SPS&apos;s compilation schema to do the recompilation when we push the compiler context.  &lt;/p&gt;

&lt;p&gt;On a side note, I think I might have found/encountered another problem with trigger while I was fixing this bug.  Specifically in the area of trigger execution context(TEC) in the LCC.  For instance, when a trigger reaches its maximum recursion allowed, it appears that the TEC count is not being reset properly, causing the maximum recursion to be thrown again for a statement that merely triggers no more than two TECs. I&apos;ll file a separate jira for this issue.&lt;/p&gt;</comment>
                            <comment id="12461631" author="bryanpendleton" created="Mon, 1 Jan 2007 18:27:36 +0000"  >&lt;p&gt;Hi Yip, thanks for the patch and for the notes. It&apos;s a little startling that the&lt;br/&gt;
change turned out to be in such a fundamental and oft-called part of&lt;br/&gt;
the code, isn&apos;t it?&lt;/p&gt;

&lt;p&gt;I think your change is very good, I just had a few comments:&lt;/p&gt;

&lt;p&gt;1) Your description of the change makes it sound as though we&lt;br/&gt;
were using the default schema when we shouldn&apos;t be, but the actual&lt;br/&gt;
code change appears to be to instruct the system to use &quot;sd&quot;, which&lt;br/&gt;
is described in the javadoc for this method as &quot;the default schema&quot;.&lt;br/&gt;
I&apos;m just reading the comments in the code, not doing any deep analysis.&lt;br/&gt;
I guess what I&apos;m suggesting here is it seems like the javadoc for&lt;br/&gt;
pushCompilerContext(SchemaDescriptor sd) needs to be changed,&lt;br/&gt;
because it seems like this method (as opposed to the no-arg version&lt;br/&gt;
of pushCompilerContext()) is supposed to be used precisely when&lt;br/&gt;
the passed &quot;sd&quot; is &lt;b&gt;not&lt;/b&gt; the default schema, but is in fact some special&lt;br/&gt;
non-default schema, such as the saved SPS schema in your case.&lt;/p&gt;

&lt;p&gt;2) Related to the above, I think it would be nice to see some javadoc&lt;br/&gt;
for the pushCompilerContext(SchemaDescriptor sd) overload&lt;br/&gt;
explaining what the meaning of a NULL &quot;sd&quot; argument is. In particular,&lt;br/&gt;
it&apos;s not clear to me from reading the code why we need to test sd != null&lt;br/&gt;
and only call setCompilationSchema in that case. Why would it not&lt;br/&gt;
be correct to &lt;b&gt;always&lt;/b&gt; call cc.setCompilationSchema(sd)?&lt;/p&gt;

&lt;p&gt;3) Lastly, in your code comments in the patch you mention that this&lt;br/&gt;
change is significant not just for trigger SPS recompilation but also&lt;br/&gt;
for view recompilation, but I do not see any tests in the test section of&lt;br/&gt;
your patch which demonstrate how you change affects view recompilation.&lt;br/&gt;
Would it be possible to add a test which demonstrates this new behavior? &lt;/p&gt;

&lt;p&gt;Thanks very much!&lt;/p&gt;</comment>
                            <comment id="12461876" author="yipng" created="Wed, 3 Jan 2007 00:29:57 +0000"  >&lt;p&gt;Thanks Bryan for reviewing the patch!  Let me attempt to answer your questions/comments.  =)&lt;/p&gt;

&lt;p&gt;1)  Yes, I agree that the Javadoc needs to be updated with regard to the current changes.  &lt;br/&gt;
    I&apos;ll resubmit a follow up patch to address the code comments.  In the original code, &lt;br/&gt;
    it appears that the SchemaDescriptor input parameter is never set even though the &lt;br/&gt;
    javadoc states so.  &lt;/p&gt;

&lt;p&gt;2) There are 3 possible values(of interest) that can get passed into pushCompilerContext(SchemaDescriptor ):&lt;/p&gt;

&lt;p&gt; a) A null SchemaDescriptor which indicates to the system to use the CURRENT SCHEMA as the compilation  &lt;br/&gt;
     schema.  (This is the same behavior as the original code.)&lt;/p&gt;

&lt;p&gt; b) A SchemaDescriptor with its UUID == null, this means that either the schema has not been physically &lt;br/&gt;
     created yet or that the LCC&apos;s getDefaultSchema() is not yet up-to-date with its actual UUID.  Use the &lt;br/&gt;
    CURRENT SCHEMA as the compilation schema.  (This is the same behavior as the original code.)      &lt;/p&gt;

&lt;p&gt; c) A schemaDescriptor with its UUID != null, this means that the schema has been physiclally created.  &lt;br/&gt;
     Use this schema as the compilation schema (e.g.:  for trigger or view recompilation cases).&lt;/p&gt;

&lt;p&gt;On a side note, if the check for UUID != null is removed, it will reveal another bug in the view binding or execution code logic if the compilation schema is set with case b) above.  e.g.:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:wombat;create=true&apos; user &apos;user1&apos;;&lt;br/&gt;
create table ta (i int);&lt;br/&gt;
create view sva as select * from ta;&lt;br/&gt;
connect &apos;jdbc:derby:wombat&apos; user &apos;user2&apos;;&lt;br/&gt;
create schema user2;&lt;br/&gt;
create view svc &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; as select * from user1.sva;&lt;br/&gt;
ERROR 42X05: Table/View &apos;TA&apos; does not exist.&lt;/p&gt;

&lt;p&gt;The cause for the above error is due to the view SVA&apos;s compilation schema UUID being null       &lt;br/&gt;
which is not correct, so setting compilation schema with case b) early has some side effect &lt;br/&gt;
on the schema binding logic in later stage.  It is probably due to a stale default schema in LCC.  &lt;br/&gt;
I think I&apos;ll file a separate jira for this issue.  With the current fix, this problem will&lt;br/&gt;
not manifest itself.  &lt;/p&gt;

&lt;p&gt;I&apos;ll add the above comments to the pushCompilerContext() javadoc also.&lt;/p&gt;

&lt;p&gt;3)  Actually, the view recompilation does not use pushCompilerContext(SchemaDescriptor) directly but   &lt;br/&gt;
     instead sets the actual compilation schema to the compiler context directly with a call &lt;br/&gt;
    cc.setCompilerSchema(sd).  This may explain why the problem does not occur in view recompilation &lt;br/&gt;
    cases.  The comment is there to remind developers in the future to pay attention when using LCC&apos;s &lt;br/&gt;
    pushCompilerContext(SchemaDescriptor).&lt;/p&gt;</comment>
                            <comment id="12461880" author="yipng" created="Wed, 3 Jan 2007 00:51:51 +0000"  >&lt;p&gt;Attaching follow-up derby2183-trunk-diff02.txt patch to address code comments.  Please review.&lt;/p&gt;</comment>
                            <comment id="12462020" author="bryanpendleton" created="Wed, 3 Jan 2007 18:37:20 +0000"  >&lt;p&gt;The updated javadoc looks great; I think it is much clearer now and it&lt;br/&gt;
will be quite helpful to future readers of the code.&lt;/p&gt;

&lt;p&gt;I intend to commit the &quot;02&quot; version of this patch; if anyone else is reviewing&lt;br/&gt;
this change and needs more time, please let us know.&lt;/p&gt;</comment>
                            <comment id="12462090" author="bryanpendleton" created="Wed, 3 Jan 2007 23:49:02 +0000"  >&lt;p&gt;Committed derby2183-trunk-diff02.txt to subversion as revision 492353.&lt;/p&gt;

&lt;p&gt;Should this fix be merged to 10.2?&lt;/p&gt;</comment>
                            <comment id="12462136" author="yipng" created="Thu, 4 Jan 2007 05:33:21 +0000"  >&lt;p&gt;Thanks Bryan.  Submitting derby2183-10.2-diff01.txt for 10.2.  Running derbyall now, will post result here when it completes.&lt;/p&gt;</comment>
                            <comment id="12462174" author="yipng" created="Thu, 4 Jan 2007 09:35:10 +0000"  >&lt;p&gt;derbyall passes successfully for 10.2 with this patch.&lt;/p&gt;</comment>
                            <comment id="12462318" author="bryanpendleton" created="Thu, 4 Jan 2007 20:56:59 +0000"  >&lt;p&gt;Applied derby2183-10.2-diff01.txt to the 10.2 branch and&lt;br/&gt;
committed it to subversion as revision 492734.&lt;/p&gt;</comment>
                            <comment id="12462366" author="mikem" created="Fri, 5 Jan 2007 00:21:38 +0000"  >&lt;p&gt;yip, I need this to get fixed in 10.1 - will a simple merge do it.  Or do you think there is more work to get it to 10.1?  I can&lt;br/&gt;
do the commit/test running - just let me know.&lt;/p&gt;</comment>
                            <comment id="12462379" author="yipng" created="Fri, 5 Jan 2007 01:16:52 +0000"  >&lt;p&gt;Hi Mike, attaching derby2183-10.1-diff01.txt for 10.1.  &lt;/p&gt;</comment>
                            <comment id="12462659" author="mikem" created="Sat, 6 Jan 2007 00:28:19 +0000"  >&lt;p&gt;committed fix patch to 10.1 branch:&lt;/p&gt;

&lt;p&gt;m101_ibm142:118&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\sql\conn\GenericLanguageConnect&lt;br/&gt;
ionContext.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\trigger&lt;br/&gt;
General.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\tri&lt;br/&gt;
ggerGeneral.sql&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\tri&lt;br/&gt;
ggerGeneral_app.properties&lt;br/&gt;
Transmitting file data ....&lt;br/&gt;
Committed revision 493253.&lt;/p&gt;</comment>
                            <comment id="12562059" author="dyret" created="Thu, 24 Jan 2008 13:10:08 +0000"  >&lt;p&gt;This issue is resolved and has not been updated in the last 12 months (since 24/Jan/07). &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12348317" name="derby2183-10.1-diff01.txt" size="10287" author="yipng" created="Fri, 5 Jan 2007 01:15:01 +0000"/>
                            <attachment id="12348316" name="derby2183-10.1-stat01.txt" size="363" author="yipng" created="Fri, 5 Jan 2007 01:15:01 +0000"/>
                            <attachment id="12348245" name="derby2183-10.2-diff01.txt" size="9966" author="yipng" created="Thu, 4 Jan 2007 05:32:33 +0000"/>
                            <attachment id="12348244" name="derby2183-10.2-stat01.txt" size="459" author="yipng" created="Thu, 4 Jan 2007 05:32:33 +0000"/>
                            <attachment id="12348182" name="derby2183-trunk-diff02.txt" size="9981" author="yipng" created="Wed, 3 Jan 2007 00:50:56 +0000"/>
                            <attachment id="12348181" name="derby2183-trunk-stat02.txt" size="459" author="yipng" created="Wed, 3 Jan 2007 00:50:56 +0000"/>
                            <attachment id="12347356" name="derby2813-trunk-diff01.txt" size="8704" author="yipng" created="Sun, 17 Dec 2006 02:23:40 +0000"/>
                            <attachment id="12347355" name="derby2813-trunk-stat01.txt" size="459" author="yipng" created="Sun, 17 Dec 2006 02:23:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 1 Jan 2007 18:27:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22932</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0pon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37979</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>