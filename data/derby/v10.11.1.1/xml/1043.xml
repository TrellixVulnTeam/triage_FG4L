<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:36:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1043/DERBY-1043.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1043] Invalid column references are not caught in a trigger action statement when the referencing table of the column is the triggered table</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1043</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Recently there was a question on the derby-user list about a trigger not firing correctly.&lt;br/&gt;
&lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.user/3246&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.user/3246&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The correct approach was suggested since the trigger statement referenced the actual table name in the &apos;Triggered-SQL-Statement. But I was surprised that no exception was thrown in the first place during trigger creation.  I tried a couple of scenarios and it turns out that if the col names of the triggered column and the column being updated in the triggered SQL are the same, Derby does not throw any exception and the trigger gets created just fine, but will not fire.&lt;/p&gt;

&lt;p&gt;The solution may be to throw ERROR 42X04 exception in all the cases when actual table names are referred in the triggered SQL, but the current way is misleading hence marking this  issue a Medium.  To reproduce the issue, simply run  the attached sql script.&lt;/p&gt;

&lt;p&gt;ij version 10.2&lt;br/&gt;
ij&amp;gt; run &apos;trigger_error.sql&apos;;&lt;br/&gt;
ij&amp;gt; CONNECT &apos;jdbc:derby:bdb;create=true&apos;;&lt;br/&gt;
ij&amp;gt; DROP TABLE A_TABLE;&lt;br/&gt;
ERROR 42Y55: &apos;DROP TABLE&apos; cannot be performed on &apos;A_TABLE&apos; because it does not exist.&lt;br/&gt;
ij&amp;gt; DROP TABLE B_TABLE;&lt;br/&gt;
ERROR 42Y55: &apos;DROP TABLE&apos; cannot be performed on &apos;B_TABLE&apos; because it does not exist.&lt;br/&gt;
ij&amp;gt; CREATE TABLE A_TABLE (ID SMALLINT GENERATED ALWAYS AS IDENTITY, A_COL VARCHAR(15) NOT NULL PRIMARY KEY);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TABLE B_TABLE (TYPE VARCHAR(15) NOT NULL, B_COL VARCHAR(15) NOT NULL, AMOUNT SMALLINT NOT NULL DEFAULT 0);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--CORRECT BEHAVIOUR:&lt;br/&gt;
--==================&lt;br/&gt;
--This trigger statement throws an exception, since actual&lt;br/&gt;
--table reference cannot be made in the &apos;Triggered-SQL-Statement&apos;&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--Note:The Col name used in the &apos;Triggered-SQL-Statement&apos; for B_TABLE is B_COL.&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;CREATE TRIGGER UPDATE_A_TABLE AFTER UPDATE OF A_COL ON A_TABLE   REFERENCING OLD&lt;br/&gt;
 AS PREVIOUSROW    FOR EACH ROW MODE DB2SQL    UPDATE B_TABLE SET B_TABLE.B_COL&lt;br/&gt;
= A_TABLE.A_COL    WHERE B_TABLE.B_COL = PREVIOUSROW.A_COL;&lt;/p&gt;

&lt;p&gt;ERROR 42X04: Column &apos;A_COL&apos; is either not in any table in the FROM list or appea&lt;br/&gt;
rs within a join specification and is outside the scope of the join specificatio&lt;br/&gt;
n or appears in a HAVING clause and is not in the GROUP BY list. If this is a CR&lt;br/&gt;
EATE or ALTER TABLE  statement then &apos;A_COL&apos; is not a column in the target table.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
--Drop and Re-create the B_TABLE, but with A_COL as the column name&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
DROP TABLE B_TABLE;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TABLE B_TABLE (TYPE VARCHAR(15) NOT NULL, A_COL VARCHAR(15) NOT NULL, AMOUNT SMALLINT NOT NULL DEFAULT 0);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--INCORRECT BEHAVIOUR:&lt;br/&gt;
--====================&lt;br/&gt;
--This trigger statement executes successfully, does NOT throw an exception, even&lt;br/&gt;
--when actual table reference is made in the &apos;Triggered-SQL-Statement&apos;&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--Note: The Col name used in the &apos;Triggered-SQL-Statement&apos; for B_TABLE is A_COL&lt;br/&gt;
--(same name as the column in A_TABLE)&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;CREATE TRIGGER UPDATE_A_TABLE AFTER UPDATE OF A_COL ON A_TABLE   REFERENCING OLD&lt;br/&gt;
 AS PREVIOUSROW    FOR EACH ROW MODE DB2SQL    UPDATE B_TABLE SET B_TABLE.A_COL&lt;br/&gt;
= A_TABLE.A_COL    WHERE B_TABLE.A_COL = PREVIOUSROW.A_COL;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
-- insert data&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;insert into a_table(a_col) values (&apos;apples&apos;);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into a_table(a_col) values (&apos;watermelons&apos;);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into a_table(a_col) values (&apos;oranges&apos;);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into b_table values(&apos;tree fruit&apos;,&apos;apples&apos;,1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into b_table values(&apos;citrus fruit&apos;,&apos;oranges&apos;,1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into b_table values(&apos;melon fruit&apos;,&apos;watermelons&apos;,1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--get contents of tables;&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
SELECT * FROM A_TABLE;&lt;br/&gt;
ID    |A_COL&lt;br/&gt;
----------------------&lt;br/&gt;
1     |apples&lt;br/&gt;
2     |watermelons&lt;br/&gt;
3     |oranges&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;br/&gt;
ij&amp;gt; SELECT * FROM B_TABLE;&lt;br/&gt;
TYPE           |A_COL          |AMOUNT&lt;br/&gt;
--------------------------------------&lt;br/&gt;
tree fruit     |apples         |1&lt;br/&gt;
citrus fruit   |oranges        |1&lt;br/&gt;
melon fruit    |watermelons    |1&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--update a col in a_table, trigger will not fire&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
update a_table set a_col=&apos;cherries&apos; where a_col=&apos;apples&apos;;&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--select from a_table&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
SELECT * FROM A_TABLE;&lt;br/&gt;
ID    |A_COL&lt;br/&gt;
----------------------&lt;br/&gt;
1     |cherries&lt;br/&gt;
2     |watermelons&lt;br/&gt;
3     |oranges&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--trigger did not fire and will see the same data. &apos;apples&apos; still shown in b_table;&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
SELECT * FROM B_TABLE;&lt;br/&gt;
TYPE           |A_COL          |AMOUNT&lt;br/&gt;
--------------------------------------&lt;br/&gt;
tree fruit     |apples         |1&lt;br/&gt;
citrus fruit   |oranges        |1&lt;br/&gt;
melon fruit    |watermelons    |1&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;

&lt;p&gt;In any case, the correct way to create the trigger is to use &apos;NEW&apos; to refer the new row value rather than using&lt;br/&gt;
the actual table name.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
-- Attempt to create using the correct trigger statement - the RIGHT WAY&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
DROP TRIGGER UPDATE_A_TABLE;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TRIGGER UPDATE_A_TABLE AFTER UPDATE OF A_COL ON A_TABLE   REFERENCING&lt;br/&gt;
 OLD AS PREVIOUSROW NEW AS NEWROW  FOR EACH ROW MODE DB2SQL    UPDATE B_TABLE SE&lt;br/&gt;
T B_TABLE.A_COL = NEWROW.A_COL    WHERE B_TABLE.A_COL = PREVIOUSROW.A_COL;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
 &amp;#8211;&lt;br/&gt;
-- update&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
UPDATE A_TABLE SET A_COL=&apos;limes&apos; WHERE A_COL=&apos;oranges&apos;;&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--select from a_table&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
SELECT * FROM A_TABLE;&lt;br/&gt;
ID    |A_COL&lt;br/&gt;
----------------------&lt;br/&gt;
1     |cherries&lt;br/&gt;
2     |watermelons&lt;br/&gt;
3     |limes&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
--trigger fired and reflects in the b_table data &apos;oranges&apos; became &apos;limes&apos;&lt;br/&gt;
&amp;#8211;&lt;br/&gt;
SELECT * FROM B_TABLE;&lt;br/&gt;
TYPE           |A_COL          |AMOUNT&lt;br/&gt;
--------------------------------------&lt;br/&gt;
tree fruit     |apples         |1&lt;br/&gt;
citrus fruit   |limes          |1&lt;br/&gt;
melon fruit    |watermelons    |1&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;</description>
                <environment></environment>
        <key id="12329405">DERBY-1043</key>
            <summary>Invalid column references are not caught in a trigger action statement when the referencing table of the column is the triggered table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fernanda">Fernanda Pizzorno</assignee>
                                    <reporter username="kartha">Rajesh Kartha</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Feb 2006 09:14:04 +0000</created>
                <updated>Thu, 13 Dec 2007 09:04:48 +0000</updated>
                            <resolved>Tue, 4 Jul 2006 16:05:54 +0100</resolved>
                                    <version>10.0.2.0</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12367607" author="kartha" created="Fri, 24 Feb 2006 09:14:59 +0000"  >&lt;p&gt;To reproduce, run the attached file thru &apos;ij&apos;&lt;/p&gt;</comment>
                            <comment id="12367608" author="kartha" created="Fri, 24 Feb 2006 09:42:24 +0000"  >&lt;p&gt;Set the right priority based on the description.&lt;/p&gt;</comment>
                            <comment id="12367611" author="djd" created="Fri, 24 Feb 2006 09:44:32 +0000"  >&lt;p&gt;Possible more precise summary/title for this bug is:&lt;/p&gt;

&lt;p&gt;Invalid column references are not caught in a trigger action statement when the referencing table of the column is the trigger&apos;s table.&lt;/p&gt;

&lt;p&gt;The description is correct, but I feel the title isn&apos;t capturing the problem correctly.&lt;/p&gt;
</comment>
                            <comment id="12368070" author="kartha" created="Tue, 28 Feb 2006 13:15:11 +0000"  >&lt;p&gt;A more clearer summary&lt;/p&gt;</comment>
                            <comment id="12418235" author="fernanda" created="Wed, 28 Jun 2006 20:36:30 +0100"  >&lt;p&gt;I tried a similar update statement as the one in the trigger to see if the problem was related to the fact that it was a trigger or not, and it turns out that no exception was thrown during the execution of the update statement.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; &amp;#8211; this update should throw an exception&lt;br/&gt;
UPDATE B_TABLE SET B_TABLE.A_COL = A_TABLE.A_COL WHERE A_COL = &apos;apples&apos;;&lt;br/&gt;
1 row inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;In the UpdateNode.bind() method there is a call to the scrubResultColumns() method that removes the table name for the result columns. Once A_TABLE is removed, A_TABLE.A_COL becomes A_COL which is a column of B_TABLE and no exception is thrown.&lt;/p&gt;

&lt;p&gt;The attached patch (derby-1043.diff) fixes this problem by replacing the scrubResultColumns() method by a new methods called checkTableNameAndScrubResultColumns(), which will check that the table name is valid before removing it.&lt;/p&gt;

&lt;p&gt;I have successfully run derbyall with this patch. Can someone please review it?&lt;/p&gt;</comment>
                            <comment id="12418628" author="andreask" created="Fri, 30 Jun 2006 19:41:29 +0100"  >&lt;p&gt;The patch looks good to me. I intent to commit it after running derbyall.&lt;/p&gt;</comment>
                            <comment id="12419058" author="andreask" created="Tue, 4 Jul 2006 16:05:54 +0100"  >&lt;p&gt;Committed revision 418933.&lt;/p&gt;</comment>
                            <comment id="12551313" author="fuzzylogic" created="Thu, 13 Dec 2007 09:04:48 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12336066" name="derby-1043.diff" size="6087" author="fernanda" created="Wed, 28 Jun 2006 20:36:30 +0100"/>
                            <attachment id="12336067" name="derby-1043.stat" size="291" author="fernanda" created="Wed, 28 Jun 2006 20:36:30 +0100"/>
                            <attachment id="12323350" name="trigger_error.sql" size="2920" author="kartha" created="Fri, 24 Feb 2006 09:14:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 24 Feb 2006 09:44:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22278</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy10dj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39711</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>