<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:10:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1373/DERBY-1373.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1373] Encrypted databases cannot be booted using the jar subprotocol (and possibly also using http/https/classpath)</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1373</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;An encrypted database cannot be booted when using the jar subprotocol.&lt;/p&gt;

&lt;p&gt;The problem lies in the method run from JCECipherFactory. The call to getRandomAccessFile returns null when the verifyKeyFile is an instance of InputStreamFile and the key verification therefore fails.&lt;/p&gt;

&lt;p&gt;The implementation of getRandomAccessFile for InputStreamFile states that its code cannot be reached which is untrue.&lt;/p&gt;

&lt;p&gt;The provided patch does two things, it provides a new class InputStreamRandomAccessFile in package org.apache.derby.impl.io. This class provides simple implementations of readInt and readFully so the key verification process succeeds. A quick scan of the derby source tree showed no problem or possible impact of this simple implementation.&lt;/p&gt;

&lt;p&gt;The second thing the patch does is to modify org/apache/derby/impl/io/InputStreamFile.java so the getRandomAccessFile creates an instance of InputStreamRandomAccessFile instead of returning null.&lt;/p&gt;

&lt;p&gt;This patch has been tested against trunk 410361. It solves the problem at least under the jar subprotocol.&lt;/p&gt;

&lt;p&gt;The patch has not been tested against http/https/classpath.&lt;/p&gt;</description>
                <environment>Environment does not matter.</environment>
        <key id="12343880">DERBY-1373</key>
            <summary>Encrypted databases cannot be booted using the jar subprotocol (and possibly also using http/https/classpath)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="herberts">Mathias Herberts</assignee>
                                    <reporter username="herberts">Mathias Herberts</reporter>
                        <labels>
                    </labels>
                <created>Sat, 3 Jun 2006 06:21:18 +0100</created>
                <updated>Mon, 5 Jul 2010 18:32:34 +0100</updated>
                            <resolved>Thu, 27 Jul 2006 22:49:38 +0100</resolved>
                                    <version>10.1.3.1</version>
                                    <fixVersion>10.1.3.2</fixVersion>
                    <fixVersion>10.1.3.3</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12414531" author="herberts" created="Sat, 3 Jun 2006 06:23:46 +0100"  >&lt;p&gt;Patch mentioned in the problem description.&lt;/p&gt;</comment>
                            <comment id="12417195" author="skambha" created="Thu, 22 Jun 2006 05:40:04 +0100"  >&lt;p&gt;Thanks Mathias for finding this issue and posting a patch. It would be nice if you could add some tests so we dont regress this issue in the future.  Also I was wondering, if you considered Suresh&apos;s comment  on an alternate way of how this could be fixed. &lt;/p&gt;

&lt;p&gt;Suresh&apos;s comment is in the mail with subject &apos;Problem using encrypted databases with jar subprotocol&apos;&lt;br/&gt;
&quot;I think the verifyKey file can be read by wrapping the file InputStream with a DataInputStream instead of reading it as RandomAccessFile in the JCECipherFactory itself. If that works then there is no need to add  InputStreamRandomAccessFile.java class. &quot; &lt;/p&gt;

&lt;p&gt;The copyright notice is missing from the InputStreamRandomAccessFile.  Can you please svn add this file and generate a new patch.  We have a useful checklist on the wiki.&lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyContributorChecklist&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DerbyContributorChecklist&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12417652" author="fuzzylogic" created="Sun, 25 Jun 2006 07:51:59 +0100"  >&lt;p&gt;Mathias, if you can address the issues with the patch mentioned by Sunitha by midday Monday, we can get this into 10.1.3.&lt;/p&gt;</comment>
                            <comment id="12417674" author="herberts" created="Sun, 25 Jun 2006 20:32:52 +0100"  >&lt;p&gt;I had a look to the suggestion Suresh made. Implementing his idea would require changes to JCECipherFactory to return a RandomAccessFile when the verifyKey file has to be written (created) and a DataInput when it has to be read. This is a change I do not have time to implement as it would mean revalidate all other cases which are currently working.&lt;/p&gt;

&lt;p&gt;Therefore I&apos;ll stick with my initial fix consisting in adding an InputStreamRandomAccessFile class.&lt;/p&gt;

&lt;p&gt;As for a test I do not see an easy way of implementing it as it requires to create a DB with encryption, package it into a jar and boot it from the jar. I do not know how to do that simply using JUnit. What I could think of would imply running Ant from the test to create a jar file and then access it. I do not know if this is the cleanest way to do it.&lt;/p&gt;
</comment>
                            <comment id="12417675" author="herberts" created="Sun, 25 Jun 2006 20:34:39 +0100"  >&lt;p&gt;Patch meant to be applied to the 10.1 branch.&lt;/p&gt;</comment>
                            <comment id="12417867" author="skambha" created="Tue, 27 Jun 2006 02:20:03 +0100"  >&lt;p&gt;In my opinion, it seems like it would be good to pursue suresh&apos;s suggestion since then we wont need to add a extra class.  Regarding your concern about tests - there are some existing tests that would test the current codepaths for encryptionKey which is in store/encryptionKey.sql.   &lt;/p&gt;

&lt;p&gt;I think it would be great to have this issue resolved and I&apos;d be willing to work with you to add tests in case you want to pursue this.  You can add jar files to the tests.  For an example of a test where this is used - see  java/testing/org/apache/derbyTesting/functionTests/tests/tools/dblook_test.java and the corresponding files associated with it - dblook_test_app.properties that makes use of the supportfiles attribute. &lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12417875" author="fuzzylogic" created="Tue, 27 Jun 2006 02:41:30 +0100"  >&lt;p&gt;I&apos;m going to pass on this for 10.1.3 as I&apos;ve run out of time to verify the fix before finalizing the 10.1.3 release candidate, and no tests for the fix were contributed. Also, the user affected by the problem has indicated they are comfortable continuing to patch their local copy to workaround the problem.&lt;/p&gt;

&lt;p&gt;We should work on a complete fix for this for the 10.2 release, as it looks like that may be the next release after 10.1.3.&lt;/p&gt;</comment>
                            <comment id="12421191" author="skambha" created="Fri, 14 Jul 2006 19:51:02 +0100"  >&lt;p&gt;Mathias wrote:&lt;br/&gt;
&quot;I had a look to the suggestion Suresh made.This is a change I do not have time to implement as it would mean revalidate all other cases which are currently working. &quot;&lt;/p&gt;

&lt;p&gt;So I followed up on Suresh&apos;s suggestion and am attaching a patch &apos;derby1373.diff.txt&apos; and &apos;derby1373.stat.txt&apos; for review.&lt;/p&gt;

&lt;p&gt;This patch makes the following changes:&lt;br/&gt;
1) Instead of using RandomAccessFile, the verifyKey.dat is read as a InputStream. &lt;/p&gt;

&lt;p&gt;2)   Add a new test (encryptionKey_jar.sql) for booting encrypted database using encryptionKey via classpath, and jar subprotocol. &lt;br/&gt;
Please note, as already mentioned in an earlier comment - There are existing test (encryptionKey.sql) that test cases for encryptionKey.&lt;/p&gt;

&lt;p&gt;The test will fail without the code change, and will pass with  the code changes.&lt;/p&gt;

&lt;p&gt;svn stat&lt;br/&gt;
M      java\engine\org\apache\derby\impl\services\jce\JCECipherFactory.java&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\tests\store\copyfiles.ant&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar.sql&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar_app.properties&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\master\encryptionKey_jar.out&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\suites\encryptionAll.runall&lt;/p&gt;

&lt;p&gt;I ran derbyall on ibm142 on linux ok. I made one small change to a comment in the test after that. I have run the test again and it passed ok.&lt;/p&gt;

&lt;p&gt;Can someone please review this patch.  &lt;/p&gt;

&lt;p&gt;Thanks to Mathias for finding the problem, reporting it, providing a fix and for the good discussion that followed on this issue.  If you have the time, it would be nice if you can verify if this works for you.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Sunitha.&lt;/p&gt;</comment>
                            <comment id="12422009" author="tsuresh" created="Wed, 19 Jul 2006 01:46:11 +0100"  >&lt;p&gt;I am planning to  review/commit  derby1373.diff.txt patch,  if  any one else is reviewing  this patch, please let me  know. &lt;/p&gt;</comment>
                            <comment id="12422263" author="tsuresh" created="Wed, 19 Jul 2006 22:53:00 +0100"  >&lt;p&gt;I reviewed the patch , it looks good.  Thanks for adding  the test to test  the encryption with jar and classpath protocols.   While reviewing the test I  noticed  it  is not running under  security manager. &lt;/p&gt;

&lt;p&gt;+# Test fails with security manager because it uses some functions in &lt;br/&gt;
+# org/apache/derbyTesting/functionTests/tests/lang/dbjarUtil.java for&lt;br/&gt;
+# creating archive and these methods do not use a privileged block&lt;br/&gt;
+# to read the properties etc.  &lt;br/&gt;
+noSecurityManager=true&lt;/p&gt;

&lt;p&gt;It would be good if  this test can run under the security manager.   I also thing some methods in the dbjarUtil.java would require privilegded blocks because the methods in them are called indirectly through the java procedures using the derby  engine.    I think recently  some one  addded  framework  that allows to specify test specific permissions., incase if this test  needs any special permissions.  if  you don&apos;t have time to address  this issue now, could you please file a JIRA entry.&lt;/p&gt;

&lt;p&gt;I am running  derbyall ,  so far i have not seen any failures .  I  will commit the patch,  if  all the tests pass. &lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
-suresh&lt;/p&gt;

</comment>
                            <comment id="12422304" author="tsuresh" created="Thu, 20 Jul 2006 01:38:01 +0100"  >&lt;p&gt;Committed derby1373.diff.txt  patch  to trunk with revision 423682.&lt;/p&gt;</comment>
                            <comment id="12422451" author="skambha" created="Thu, 20 Jul 2006 18:04:29 +0100"  >&lt;p&gt;Thanks Suresh for reviewing and committing this patch.  I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1552&quot; title=&quot;Add privileged blocks to test/lang/dbjarUtil.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1552&quot;&gt;DERBY-1552&lt;/a&gt; to add priv blocks to dbjarUtil.java.  &lt;/p&gt;

&lt;p&gt;I would like this fix to go into 10.1.  I&apos;ll post the merge command for this after running tests. &lt;/p&gt;</comment>
                            <comment id="12422710" author="skambha" created="Fri, 21 Jul 2006 17:52:49 +0100"  >&lt;p&gt;I  would like this fix to go into 10.1 branch. &lt;/p&gt;

&lt;p&gt;The below merge command to put this fix to 10.1 does not apply cleanly because of conflict in encryptionAll.runall&lt;br/&gt;
svn merge -r 423681:423682 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So, I am attaching a patch 10.1_derby1373.diff.txt for 10.1 codeline. Please note, it is the same changes as derby1373.diff.txt.&lt;/p&gt;

&lt;p&gt;svn stat:&lt;br/&gt;
M      java\engine\org\apache\derby\impl\services\jce\JCECipherFactory.java&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\tests\store\copyfiles.ant&lt;br/&gt;
A  +   java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar.sql&lt;br/&gt;
A  +   java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar_app.properties&lt;br/&gt;
A  +   java\testing\org\apache\derbyTesting\functionTests\master\encryptionKey_jar.out&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\suites\encryptionAll.runall&lt;/p&gt;


&lt;p&gt;Ran derbyall on ibm142/linux ok.&lt;/p&gt;

&lt;p&gt;Can someone please commit this change.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12422728" author="skambha" created="Fri, 21 Jul 2006 18:49:47 +0100"  >&lt;p&gt;In the earlier patch 10.1_derby1373.diff.txt&apos; the new files didnt get added to the patch because,merge adds the files to the codeline but does not do a svn add.  In this case, svn stat shows A+ which is just the property file changes.  It does not add the file.  &lt;/p&gt;

&lt;p&gt;I am attaching a new patch &apos;10.1_explicitsvnadd_derby1373.diff.txt&apos;  that has all the newly added files in it.  &lt;/p&gt;

&lt;p&gt;svn stat &lt;br/&gt;
M      java\engine\org\apache\derby\impl\services\jce\JCECipherFactory.java&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\tests\store\copyfiles.ant&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar.sql&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar_app.properties&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\master\encryptionKey_jar.out&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\suites\encryptionAll.runall&lt;/p&gt;

&lt;p&gt;Can someone look at this patch. &lt;/p&gt;

&lt;p&gt;Thanks to Deepa for pointing the issue with &apos;A+&apos; in the svn stat. .&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Sunitha.&lt;/p&gt;</comment>
                            <comment id="12423140" author="mikem" created="Mon, 24 Jul 2006 21:05:01 +0100"  >&lt;p&gt;Committed  the 10.1_explicitsvnadd_derby1373.diff.txt patch to the 10.1 branch:&lt;br/&gt;
m101_142:149&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\services\jce\JCECipherFactory.java&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\master\encryptionKey_jar.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\suites\encryptionAll.runall&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\store\copyfiles.ant&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar.sql&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\store\encryptionKey_jar_app.properties&lt;br/&gt;
Transmitting file data ......&lt;br/&gt;
Committed revision 425172.&lt;/p&gt;</comment>
                            <comment id="12423147" author="skambha" created="Mon, 24 Jul 2006 21:13:19 +0100"  >&lt;p&gt;Adding fix version 10.1.3.2&lt;/p&gt;</comment>
                            <comment id="12423940" author="skambha" created="Thu, 27 Jul 2006 22:49:38 +0100"  >&lt;p&gt;This issue has been fixed on trunk as well as 10.1. &lt;/p&gt;</comment>
                            <comment id="12551346" author="fuzzylogic" created="Thu, 13 Dec 2007 09:04:56 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12337314" name="10.1_derby1373.diff.txt" size="5106" author="skambha" created="Fri, 21 Jul 2006 17:52:49 +0100"/>
                            <attachment id="12337315" name="10.1_explicitsvnadd_derby1373.diff.txt" size="13912" author="skambha" created="Fri, 21 Jul 2006 18:49:47 +0100"/>
                            <attachment id="12334969" name="InputStreamFile.java-patch" size="706" author="herberts" created="Sat, 3 Jun 2006 06:23:46 +0100"/>
                            <attachment id="12334968" name="InputStreamRandomAccessFile.java" size="4437" author="herberts" created="Sat, 3 Jun 2006 06:23:46 +0100"/>
                            <attachment id="12336902" name="derby1373.diff.txt" size="14109" author="skambha" created="Fri, 14 Jul 2006 19:51:02 +0100"/>
                            <attachment id="12336903" name="derby1373.stat.txt" size="534" author="skambha" created="Fri, 14 Jul 2006 19:51:02 +0100"/>
                            <attachment id="12335877" name="encryptedJar.patch" size="6302" author="herberts" created="Sun, 25 Jun 2006 20:34:39 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 22 Jun 2006 04:40:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22466</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0pqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37987</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>