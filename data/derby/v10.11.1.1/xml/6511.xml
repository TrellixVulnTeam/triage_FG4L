<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:15:57 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6511/DERBY-6511.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6511] java.lang.NoSuchMethodError chaining a function and procedure</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6511</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;java.lang.NoSuchMethodError is raised when calling a procedure which takes an Integer argument and passing it the result of a function which returns an int. The error is raised in generated code.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12701534">DERBY-6511</key>
            <summary>java.lang.NoSuchMethodError chaining a function and procedure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Fri, 14 Mar 2014 17:53:45 +0000</created>
                <updated>Fri, 10 Oct 2014 19:34:04 +0100</updated>
                            <resolved>Fri, 30 May 2014 15:34:26 +0100</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13935334" author="rhillegas" created="Fri, 14 Mar 2014 17:56:27 +0000"  >&lt;p&gt;Attaching derby-6511.sql, a script which shows this problem.&lt;/p&gt;</comment>
                            <comment id="13935348" author="rhillegas" created="Fri, 14 Mar 2014 18:04:04 +0000"  >&lt;p&gt;The trigger is a red herring. You can reproduce this problem with just a function and a procedure.&lt;/p&gt;</comment>
                            <comment id="13935353" author="rhillegas" created="Fri, 14 Mar 2014 18:05:24 +0000"  >&lt;p&gt;Attaching a simplified derby-6511.sql which shows this problem raised by chaining a function and procedure together.&lt;/p&gt;</comment>
                            <comment id="13937597" author="knutanders" created="Mon, 17 Mar 2014 09:37:05 +0000"  >&lt;p&gt;I can also reproduce this by chaining a function and a function.&lt;/p&gt;

&lt;p&gt;Given this Java method&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; f(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; x) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; x;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the following SQL code fails&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; create function f(x int) returns int language java parameter style java no sql deterministic external name &apos;Kladd.f&apos;;
0 rows inserted/updated/deleted
ij&amp;gt; values f(f(1));
1          
-----------
ERROR 38000: The exception &apos;java.lang.NoSuchMethodError: Kladd.f(I)I&apos; was thrown while evaluating an expression.
ERROR XJ001: Java exception: &apos;Kladd.f(I)I: java.lang.NoSuchMethodError&apos;.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I add &quot;returns null on null input&quot; to the CREATE FUNCTION statement, it doesn&apos;t fail.&lt;/p&gt;</comment>
                            <comment id="13937717" author="rhillegas" created="Mon, 17 Mar 2014 12:06:46 +0000"  >&lt;p&gt;Thanks, Knut. Yes, given these functions...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public class zz
{
    public  static  Integer intToInteger( int val )
    {
        return new Integer( val );
    }

    public  static  int     integerToInt( Integer val )
        throws Exception
    {
        if ( val == null )  { throw new Exception( &quot;This method does not allow nulls!&quot; ); }
        else { return val.intValue(); }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...I see this behavior:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;

create function intToInteger( val int ) returns int
language java parameter style java deterministic no sql
external name &apos;zz.intToInteger&apos;;

create function integerToInt( val int ) returns int
language java parameter style java deterministic no sql
external name &apos;zz.integerToInt&apos;;

-- succeeds
values intToInteger( integerToInt( 1 ) );

-- succeeds
values intToInteger( intToInteger( 1 ) );

-- fails
values integerToInt( integerToInt( 1 ) );

-- succeeds
values integerToInt( intToInteger( 1 ) );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13937759" author="knutanders" created="Mon, 17 Mar 2014 12:56:01 +0000"  >&lt;p&gt;Maybe we need to make MethodCallNode.generateAndCastOneParameter() generate a call such as java.lang.Integer.valueOf(int) in the case where argumentType is the corresponding primitive type to parameterType. That seems to be where the result from the inner function call is pushed to the stack as an int instead of an Integer.&lt;/p&gt;</comment>
                            <comment id="13937768" author="rhillegas" created="Mon, 17 Mar 2014 13:05:05 +0000"  >&lt;p&gt;Hi Knut, yes, that&apos;s where my mind has trended too. Thanks.&lt;/p&gt;</comment>
                            <comment id="13937932" author="rhillegas" created="Mon, 17 Mar 2014 15:39:44 +0000"  >&lt;p&gt;Attaching derby-6511-01-aa-fixPrimitiveToWrapper.diff. This patch adds a little conversion logic when passing a primitive to a method which takes a wrapper type. I am running tests now.&lt;/p&gt;

&lt;p&gt;As Knut noted, the fix is to generate a call to $WrapperObject.valueOf( $primitiveType ) when generating the code to evaluate routine parameters. An extra cast is needed if the primitive type is &quot;short&quot;. That is because JDBC specifies that the wrapper type for SMALLINT is java.lang.Integer even though the primitive type for SMALLINT is short.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/types/JSQLType.java&lt;/p&gt;

&lt;p&gt;Make some methods public, for use by MethodCallNode.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/MethodCallNode.java&lt;/p&gt;

&lt;p&gt;Add a little conversion logic to generateAndCastOneParameter(). The conversion is performed if the argument type is a primitive and the parameter type is its corresponding wrapper form.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GeneratedColumnsHelper.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutineTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/junit/BaseJDBCTestCase.java&lt;/p&gt;

&lt;p&gt;Add tests for conversions of all primitive types (except for the unsupported byte type) to their corresponding wrapper types.&lt;/p&gt;</comment>
                            <comment id="13938087" author="jira-bot" created="Mon, 17 Mar 2014 17:37:59 +0000"  >&lt;p&gt;Commit 1578479 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1578479&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1578479&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6511&quot; title=&quot;java.lang.NoSuchMethodError chaining a function and procedure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6511&quot;&gt;&lt;del&gt;DERBY-6511&lt;/del&gt;&lt;/a&gt;: Convert primitives to wrapper types as appropriate when chaining functions; tests passed cleanly on derby-6511-01-aa-fixPrimitiveToWrapper.diff.&lt;/p&gt;</comment>
                            <comment id="13939148" author="knutanders" created="Tue, 18 Mar 2014 12:52:31 +0000"  >&lt;p&gt;Thanks for fixing this, Rick.&lt;/p&gt;

&lt;p&gt;Just a heads up in case someone wants to backport the fix: Most of the valueOf() methods used in the fix were not added until Java 5, so the code generator needs to generate different code on Derby versions that are supposed to work on older Java versions. For example, it could use the wrapper classes&apos; constructors instead of the valueOf() methods. (We should still use valueOf() on trunk, though, since it&apos;s more efficient than the constructors.)&lt;/p&gt;</comment>
                            <comment id="14013693" author="rhillegas" created="Fri, 30 May 2014 15:34:26 +0100"  >&lt;p&gt;I believe that work on this issue is done. Resolving.&lt;/p&gt;</comment>
                            <comment id="14167250" author="mikem" created="Fri, 10 Oct 2014 19:21:43 +0100"  >&lt;p&gt;as comments point out this is not a simple backport of a fix into 10.10, so marking as not appropriate for the 10.10 mass backport effort.  If anyone needs this change in 10.10 note the kinds of by hand changes that will be necessary to make it work in pre jdk5 environments, do not count on simple merge.  Comments about this are included in the issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12635101" name="derby-6511-01-aa-fixPrimitiveToWrapper.diff" size="13550" author="rhillegas" created="Mon, 17 Mar 2014 15:39:44 +0000"/>
                            <attachment id="12634768" name="derby-6511.sql" size="585" author="rhillegas" created="Fri, 14 Mar 2014 18:05:24 +0000"/>
                            <attachment id="12634764" name="derby-6511.sql" size="900" author="rhillegas" created="Fri, 14 Mar 2014 17:56:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 17 Mar 2014 09:37:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379880</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hznb2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380165</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>