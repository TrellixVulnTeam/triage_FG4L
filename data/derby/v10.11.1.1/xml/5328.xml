<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:50:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5328/DERBY-5328.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5328] The private fields of the NetServlet can be changed by multiple threads, giving rise to race conditions and corruptions.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5328</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;At the beginning of the NetServlet class, there are a number of private fields. These fields can be inspected and changed by any thread running inside NetServlet.doGet(). Due to the way that app servers dispatch servlet requests, this means that multiple threads can be operating inside doGet() at the same time, clobbering one another&apos;s work. The weirdest instance of this is the shared PrintWriter (called &quot;out&quot;) which is used to produce the response web page sent back by the servlet. Multiple threads all writing to the same PrintWriter will create a very bizarre response page. The following improvements should be made:&lt;/p&gt;

&lt;p&gt;1) The &quot;server&quot; field should be set by a synchronized method.&lt;/p&gt;

&lt;p&gt;2) Every run through doGet() should create its own PrintWriter which is passed to other methods. The instance-wide &quot;out&quot; field should be removed.&lt;/p&gt;

&lt;p&gt;3) Various other fields should be re-coded using the Atomic classes introduced by Java 5. These fields include &quot;logStatus&quot; and &quot;traceStatus&quot;. This solution can be implemented if the community votes to approve the sunsetting of JVM 1.4 (currently at the polls).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12513945">DERBY-5328</key>
            <summary>The private fields of the NetServlet can be changed by multiple threads, giving rise to race conditions and corruptions.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_triage10_9</label>
                    </labels>
                <created>Wed, 13 Jul 2011 17:14:03 +0100</created>
                <updated>Fri, 14 Jun 2013 18:23:47 +0100</updated>
                            <resolved>Wed, 4 Apr 2012 13:18:10 +0100</resolved>
                                    <version>10.9.1.0</version>
                                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="13064677" author="kmarsden" created="Wed, 13 Jul 2011 17:29:40 +0100"  >&lt;p&gt;What  corruptions that might be caused by this issue?  Could an actual database corruption occur or is it just that the output screens might be garbled when presented to the user?&lt;/p&gt;</comment>
                            <comment id="13064691" author="rhillegas" created="Wed, 13 Jul 2011 17:47:55 +0100"  >&lt;p&gt;I don&apos;t see how the database could be corrupted. Output screens could be garbled.&lt;/p&gt;</comment>
                            <comment id="13064889" author="knutanders" created="Wed, 13 Jul 2011 22:45:58 +0100"  >&lt;p&gt;&amp;gt; 1) The &quot;server&quot; field should be set by a synchronized method.&lt;/p&gt;

&lt;p&gt;I don&apos;t think NetworkServerControl is thread-safe, so it&apos;s probably safer to create an instance in doGet() and pass it to the other methods as an argument.&lt;/p&gt;

&lt;p&gt;&amp;gt; 3) Various other fields should be re-coded using the Atomic classes introduced by Java 5.&lt;/p&gt;

&lt;p&gt;If all we need is atomic get and set of these fields, and not compare-and-swap, just declaring the fields volatile would suffice, I think.&lt;/p&gt;</comment>
                            <comment id="13065106" author="kristwaa" created="Thu, 14 Jul 2011 08:55:32 +0100"  >&lt;p&gt;A typical way to store data belonging to a specific session, and to retrieve it later, is to use the session context. We can also pass some of the variables as arguments, this would require changing the method signatures (while at it, some other arguments could be removed).&lt;/p&gt;

&lt;p&gt;What isn&apos;t clear to me, is what kind of underlying state the servlet is dependent on. Are all executions of the servlet supposed to operate on and query the same NetworkServerControl, or should there be one instance per session?&lt;br/&gt;
Can the servlet control several network servers, or only one? (I assume one, since the server is started in the appserver process?)&lt;/p&gt;

&lt;p&gt;Finally, can anyone answer whether NetServlet can assume that there will always be only one instance of it in the web container, or do we have to make sure it runs properly if the container creates a pool of instances too?&lt;br/&gt;
I can&apos;t see any reasons why we should make this code able to run in 100&apos;s of concurrent sessions - that doesn&apos;t make any sense for the functionality it provides. However, we should make sure the servlet is properly implemented and won&apos;t fall over or cause side effects if it happens that it is run by concurrent sessions.&lt;/p&gt;</comment>
                            <comment id="13081137" author="rhillegas" created="Mon, 8 Aug 2011 20:17:47 +0100"  >&lt;p&gt;Attaching derby-5328-01-aa-simpleFields.diff. This patch makes a number of changes to improve the re-entrancy of the NetServlet:&lt;/p&gt;

&lt;p&gt;1) Makes the following fields volatile: tracingDirectory, logStatus, traceStatus.&lt;/p&gt;

&lt;p&gt;2) Makes knownLang a constant.&lt;/p&gt;

&lt;p&gt;3) Moves the following fields inside the doGet() method: locale, out.&lt;/p&gt;

&lt;p&gt;This patch does not tackle the issue of what to do with the server field.&lt;/p&gt;

&lt;p&gt;I have run the resulting NetServlet inside tomcat and accessed it from multiple browser tabs. The browser pages continue to operate as expected: changes to a field in one tab become visible in the other tab after you refresh the second tab. However, I have not stressed NetServlet by forcing close races between the two tabs.&lt;/p&gt;

&lt;p&gt;Touches one file:&lt;/p&gt;

&lt;p&gt;M      java/drda/org/apache/derby/drda/NetServlet.java&lt;/p&gt;</comment>
                            <comment id="13081636" author="rhillegas" created="Tue, 9 Aug 2011 14:57:44 +0100"  >&lt;p&gt;Committed derby-5328-01-aa-simpleFields.diff at subversion revision 1155367.&lt;/p&gt;</comment>
                            <comment id="13210468" author="kmarsden" created="Fri, 17 Feb 2012 19:33:40 +0000"  >&lt;p&gt;Rick committed a change for this issue:&lt;br/&gt;
	#1155367 	Tue Aug 09 13:56:04 UTC 2011 	rhillegas 	&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5328&quot; title=&quot;The private fields of the NetServlet can be changed by multiple threads, giving rise to race conditions and corruptions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5328&quot;&gt;&lt;del&gt;DERBY-5328&lt;/del&gt;&lt;/a&gt;: Improve the re-entrancy of the NetServlet.&lt;br/&gt;
Files Changed&lt;br/&gt;
MODIFY /db/derby/code/trunk/java/drda/org/apache/derby/drda/NetServlet.java&lt;br/&gt;
Comment &lt;/p&gt;

&lt;p&gt;Is it fixed or is there more work to do?&lt;/p&gt;
</comment>
                            <comment id="13210487" author="rhillegas" created="Fri, 17 Feb 2012 19:57:33 +0000"  >&lt;p&gt;Hi Kathey,&lt;/p&gt;

&lt;p&gt;I believe there is more work to be done on this issue. Thanks.&lt;/p&gt;</comment>
                            <comment id="13212114" author="kmarsden" created="Mon, 20 Feb 2012 21:51:33 +0000"  >&lt;p&gt;Triage for 10.9&lt;/p&gt;</comment>
                            <comment id="13220793" author="kristwaa" created="Fri, 2 Mar 2012 09:20:14 +0000"  >&lt;p&gt;I&apos;m wondering if it makes sense to simply make the doGet-method synchronized?&lt;br/&gt;
This would make the servlet &quot;serial&quot;, i.e. only one request can be processed at a time, but that seems suitable for this servlet.&lt;/p&gt;</comment>
                            <comment id="13220907" author="rhillegas" created="Fri, 2 Mar 2012 13:20:32 +0000"  >&lt;p&gt;Hi Kristian,&lt;/p&gt;

&lt;p&gt;That sounds reasonable to me. I agree that this servlet doesn&apos;t serve up high volumes of content. I can&apos;t imagine why multiple users would want to bounce the server and toggle tracing off and on as fast as they could. This is an administrative tool so making doGet() synchronized would be fine. Thanks.&lt;/p&gt;</comment>
                            <comment id="13222272" author="kristwaa" created="Mon, 5 Mar 2012 11:09:20 +0000"  >&lt;p&gt;Thanks, Rick.&lt;/p&gt;

&lt;p&gt;I&apos;ve logged &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5639&quot; title=&quot;Minor code cleanup for NetServlet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5639&quot;&gt;&lt;del&gt;DERBY-5639&lt;/del&gt;&lt;/a&gt; to track some minor code cleanups, and we can return to making doGet synchronized a little later.&lt;/p&gt;</comment>
                            <comment id="13244121" author="kristwaa" created="Mon, 2 Apr 2012 12:07:57 +0100"  >&lt;p&gt;Attaching patch 02-aa, which makes the doGet-method synchronized.&lt;br/&gt;
As mentioned earlier this is normally not something one would do for a servlet, but in this case it seems appropriate. We only want to allow for one &quot;admin request&quot; to the network server instance at a time.&lt;/p&gt;

&lt;p&gt;I plan to commit this patch shortly.&lt;/p&gt;</comment>
                            <comment id="13246076" author="kristwaa" created="Wed, 4 Apr 2012 07:57:26 +0100"  >&lt;p&gt;Committed patch 02-aa to trunk with revision 1309264.&lt;br/&gt;
I don&apos;t plan any more work on this issue, and I expect that we can resolve this issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12489727" name="derby-5328-01-aa-simpleFields.diff" size="22118" author="rhillegas" created="Mon, 8 Aug 2011 20:17:47 +0100"/>
                            <attachment id="12520966" name="derby-5328-02-aa-synchronized_doget.diff" size="664" author="kristwaa" created="Mon, 2 Apr 2012 12:07:56 +0100"/>
                    </attachments>
                <subtasks>
                            <subtask id="12545154">DERBY-5639</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 13 Jul 2011 16:29:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24773</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10423"><![CDATA[Newcomer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0cgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35837</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>