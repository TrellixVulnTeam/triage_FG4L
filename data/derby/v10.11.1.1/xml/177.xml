<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:10:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-177/DERBY-177.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-177] Unnecessary waiting within EmbedDatabaseMetaData.getIndexInfo()</title>
                <link>https://issues.apache.org/jira/browse/DERBY-177</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When setting up a new schema (creating tables, constraints and indexes), using a JDO implementation&apos;s autocreate feature (JPOX JDO), the application hangs for 20 seconds in a call to EmbedDatabaseMetaData.getIndexInfo(). The stacktrace is:&lt;/p&gt;

&lt;p&gt;Thread &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; (Suspended)&lt;br/&gt;
	Object.wait(long) line: not available &lt;span class=&quot;error&quot;&gt;&amp;#91;native method&amp;#93;&lt;/span&gt;&lt;br/&gt;
	ActiveLock.waitForGrant(int) line: not available&lt;br/&gt;
	LockSet.lockObject(Object, Lockable, Object, int, Latch) line: not available&lt;br/&gt;
	SinglePool.zeroDurationlockObject(Object, Lockable, Object, int) line: not available&lt;br/&gt;
	RowLockingRR(RowLocking3).zeroDurationLockRecordForWrite(Transaction, RecordHandle, boolean, boolean) line: not available&lt;br/&gt;
	HeapController.lockRow(RecordHandle, int, boolean, int) line: not available&lt;br/&gt;
	HeapController.lockRow(RowLocation, int, boolean, int) line: not available&lt;br/&gt;
	B2IRowLocking3.lockRowOnPage(BTree, LeafControlRow, LeafControlRow, int, boolean, FetchDescriptor, DataValueDescriptor[], RowLocation, int, int) line: not available&lt;br/&gt;
	B2IRowLocking3.lockNonScanPreviousRow(BTree, LeafControlRow, int, FetchDescriptor, DataValueDescriptor[], RowLocation, OpenBTree, int, int) line: not available&lt;br/&gt;
	B2IController(BTreeController).doIns(DataValueDescriptor[]) line: not available&lt;br/&gt;
	B2IController(BTreeController).insert(DataValueDescriptor[]) line: not available&lt;br/&gt;
	B2IController.insert(DataValueDescriptor[]) line: not available&lt;br/&gt;
	TabInfoImpl.insertRowListImpl(RowList, TransactionController, RowLocation[], boolean) line: not available&lt;br/&gt;
	TabInfoImpl.insertRow(ExecRow, TransactionController, boolean) line: not available&lt;br/&gt;
	DataDictionaryImpl.addDescriptorNow(TupleDescriptor, TupleDescriptor, int, boolean, TransactionController, boolean) line: not available&lt;br/&gt;
	DataDictionaryImpl.addSPSParams(SPSDescriptor, TransactionController, boolean) line: not available&lt;br/&gt;
	DataDictionaryImpl.updateSPS(SPSDescriptor, TransactionController, boolean, boolean, boolean, boolean) line: not available&lt;br/&gt;
	SPSDescriptor.updateSYSSTATEMENTS(LanguageConnectionContext, int, TransactionController) line: not available&lt;br/&gt;
	SPSDescriptor.getPreparedStatement(boolean) line: not available&lt;br/&gt;
	SPSDescriptor.getPreparedStatement() line: not available&lt;br/&gt;
	ExecSPSNode.generate(ByteArray) line: not available&lt;br/&gt;
	GenericStatement.prepMinion(LanguageConnectionContext, boolean, Object[], SchemaDescriptor, boolean) line: not available&lt;br/&gt;
	GenericStatement.prepare(LanguageConnectionContext) line: not available&lt;br/&gt;
	GenericLanguageConnectionContext.prepareInternalStatement(String) line: not available&lt;br/&gt;
	EmbedPreparedStatement30(EmbedPreparedStatement).&amp;lt;init&amp;gt;(EmbedConnection, String, boolean, int, int, int, int, int[], String[]) line: not available&lt;br/&gt;
	EmbedPreparedStatement30(EmbedPreparedStatement20).&amp;lt;init&amp;gt;(EmbedConnection, String, boolean, int, int, int, int, int[], String[]) line: not available&lt;br/&gt;
	EmbedPreparedStatement30.&amp;lt;init&amp;gt;(EmbedConnection, String, boolean, int, int, int, int, int[], String[]) line: not available&lt;br/&gt;
	Driver30.newEmbedPreparedStatement(EmbedConnection, String, boolean, int, int, int, int, int[], String[]) line: not available&lt;br/&gt;
	EmbedConnection30(EmbedConnection).prepareMetaDataStatement(String) line: not available&lt;br/&gt;
	EmbedDatabaseMetaData.prepareSPS(String, String) line: not available&lt;br/&gt;
	EmbedDatabaseMetaData.getPreparedQuery(String) line: not available&lt;br/&gt;
	EmbedDatabaseMetaData.getIndexInfo(String, String, String, boolean, boolean) line: not available&lt;br/&gt;
&lt;a href=&quot;###### entry into Derby code ##########&quot;&gt;##### entry into Derby code ##########&lt;/a&gt;&lt;br/&gt;
	CloudscapeAdapter(DatabaseAdapter).getExistingIndexes(Connection, DatabaseMetaData, String, String, String) line: 1257&lt;br/&gt;
	ClassTable(TableImpl).getExistingCandidateKeys(Connection) line: 839&lt;br/&gt;
	ClassTable(TableImpl).validateCandidateKeys(Connection, boolean) line: 463&lt;br/&gt;
	ClassTable(TableImpl).validateConstraints(Connection, boolean) line: 293&lt;br/&gt;
	RDBMSManager$ClassAdder.addClassTablesAndValidate(String[], ClassLoaderResolver) line: 2546&lt;br/&gt;
	RDBMSManager$ClassAdder.execute(Connection, ClassLoaderResolver) line: 2108&lt;br/&gt;
	RDBMSManager$ClassAdder(RDBMSManager$MgmtTransaction).execute(ClassLoaderResolver) line: 1977&lt;br/&gt;
	RDBMSManager.addClasses(String[]) line: 469&lt;br/&gt;
	RDBMSManager.addClass(String) line: 481&lt;br/&gt;
	RDBMSManager(StoreManager).initialiseAutoStart() line: 333&lt;br/&gt;
	RDBMSManager.initialiseSchema(String, String, String, Connection) line: 379&lt;br/&gt;
	RDBMSManager.&amp;lt;init&amp;gt;(ClassLoaderResolver, AbstractPersistenceManagerFactory, String, String) line: 243&lt;br/&gt;
	RDBMSManagerFactory.getStoreManager(ClassLoaderResolver, AbstractPersistenceManagerFactory, String, String) line: 59&lt;br/&gt;
	PersistenceManagerImpl(AbstractPersistenceManager).&amp;lt;init&amp;gt;(AbstractPersistenceManagerFactory, String, String) line: 179&lt;br/&gt;
	PersistenceManagerImpl.&amp;lt;init&amp;gt;(AbstractPersistenceManagerFactory, String, String) line: 34&lt;br/&gt;
	PersistenceManagerFactoryImpl.getPersistenceManager(String, String) line: 606&lt;br/&gt;
	PersistenceManagerFactoryImpl.getPersistenceManager() line: 582&lt;br/&gt;
	ManagedObjectManager.getJdoPm() line: 536&lt;br/&gt;
	DefaultLeihnehmerTypManager(ManagedObjectManager).queryAll() line: 425&lt;br/&gt;
	DefaultLeihnehmerTypManager(ManagedObjectManager).getAll() line: 402&lt;br/&gt;
	PictitImporter.importContents(EList) line: 91&lt;br/&gt;
	PictitImporter.run(Object) line: 651&lt;br/&gt;
	PlatformActivator$1.run(Object) line: 228&lt;br/&gt;
	EclipseStarter.run(Object) line: 333&lt;br/&gt;
	EclipseStarter.run(String[], Runnable) line: 150&lt;br/&gt;
	NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) line: not available &lt;span class=&quot;error&quot;&gt;&amp;#91;native method&amp;#93;&lt;/span&gt;&lt;br/&gt;
	NativeMethodAccessorImpl.invoke(Object, Object[]) line: 39&lt;br/&gt;
	DelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 25&lt;br/&gt;
	Method.invoke(Object, Object[]) line: 324&lt;br/&gt;
	Main.invokeFramework(String[], URL[]) line: 268&lt;br/&gt;
	Main.basicRun(String[]) line: 260&lt;br/&gt;
	Main.run(String[]) line: 887&lt;br/&gt;
	Main.main(String[]) line: 871&lt;/p&gt;</description>
                <environment>Windows XP, JDK 1.4.2_07, derby embedded server</environment>
        <key id="31112">DERBY-177</key>
            <summary>Unnecessary waiting within EmbedDatabaseMetaData.getIndexInfo()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jfrantzius">J&#246;rg von Frantzius</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Mar 2005 20:47:25 +0000</created>
                <updated>Fri, 21 Jan 2011 17:48:12 +0000</updated>
                            <resolved>Mon, 25 Aug 2008 17:05:32 +0100</resolved>
                                    <version>10.0.2.2</version>
                                                    <component>Store</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12494414" author="knutanders" created="Tue, 8 May 2007 23:48:32 +0100"  >&lt;p&gt;This probably happens because there is a shared lock on one of the system tables when the meta-data query is compiled for the first time. The repro attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2584&quot; title=&quot;Creating a database with JPOX SchemaTool sometimes gives ArrayIndexOutOfBoundsException when getIndexInfo() is called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2584&quot;&gt;&lt;del&gt;DERBY-2584&lt;/del&gt;&lt;/a&gt; also experiences this hang. Compilation of meta-data queries normally happens in a sub-transaction to allow earlier release of locks, but if the parent transaction already has some of the locks the sub-transaction needs, the sub-transaction will fail with a lock timeout and the compilation is re-done in the parent transaction.&lt;/p&gt;

&lt;p&gt;There is code to make sure that the attempt to compile in a sub-transaction fails immediately if it can&apos;t obtain the locks it needs (that is, the conglomerates are opened with the TransactionController.OPENMODE_LOCK_NOWAIT flag). This flag does however not seem to be recognized by the B-tree conglomerates, so the calls to the lock manager end up using timed waits.&lt;/p&gt;

&lt;p&gt;Perhaps we should add a useTimedWait field to the B2IRowLocking classes?&lt;/p&gt;</comment>
                            <comment id="12494561" author="knutanders" created="Wed, 9 May 2007 20:37:01 +0100"  >&lt;p&gt;After some more digging, I found out that the TransactionController.OPENMODE_LOCK_NOWAIT is only supposed to make lock requests time out immediately if a table-level lock is requested. So since the compilation normally uses row locking, it will have to wait for a timeout before it gives up compiling in the nested transaction and restarts in the main transaction.&lt;/p&gt;

&lt;p&gt;Attached is a hack which changes the lock mode to table locking when compiling in the nested transaction. I have ran absolutely no tests on it other than the repro for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2584&quot; title=&quot;Creating a database with JPOX SchemaTool sometimes gives ArrayIndexOutOfBoundsException when getIndexInfo() is called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2584&quot;&gt;&lt;del&gt;DERBY-2584&lt;/del&gt;&lt;/a&gt;, which now doesn&apos;t hang on the compilation.&lt;/p&gt;</comment>
                            <comment id="12501233" author="knutanders" created="Mon, 4 Jun 2007 15:49:34 +0100"  >&lt;p&gt;This bug is probably also the cause of the hangs seen in UpdatableResultSetTest. The test case testDeleteRowWithDeleteTrigger hangs for about one minute waiting for a lock in an internal transaction (compiling a trigger statement) before it completes successfully. The attached patch (testhang.diff) wraps the test in a DatabasePropertyTestSetup which reduces the wait timeout. This change should be reverted once the bug has been fixed. Committed revision 544155.&lt;/p&gt;</comment>
                            <comment id="12534661" author="knutanders" created="Sun, 14 Oct 2007 20:47:25 +0100"  >&lt;p&gt;Related issue (and repro) mentioned on derby-user:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/200710.mbox/%3c042D2B87F53441B4A0FFE34A14B0C448@Laptop%3e&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/200710.mbox/%3c042D2B87F53441B4A0FFE34A14B0C448@Laptop%3e&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12625412" author="knutanders" created="Mon, 25 Aug 2008 17:05:32 +0100"  >&lt;p&gt;I believe this issue has been fixed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3693&quot; title=&quot;Deadlocks accessing DB metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3693&quot;&gt;&lt;del&gt;DERBY-3693&lt;/del&gt;&lt;/a&gt;, so I&apos;m marking this one as resolved. The fix should be available in the upcoming 10.4.2 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12396923">DERBY-3693</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12367904">DERBY-2584</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12396923">DERBY-3693</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12402999">DERBY-3850</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12356992" name="tablelock.diff" size="2709" author="knutanders" created="Wed, 9 May 2007 20:37:01 +0100"/>
                            <attachment id="12358869" name="testhang.diff" size="1538" author="knutanders" created="Mon, 4 Jun 2007 15:49:34 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 May 2007 22:48:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21820</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ndr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37606</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>