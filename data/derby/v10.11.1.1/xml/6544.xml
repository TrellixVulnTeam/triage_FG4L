<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:55:01 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6544/DERBY-6544.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6544] Non-english locale flunks LuceneSupportTest</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6544</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following error surfaced in the nightly tests on a windows machine with a Swedish locale. See &lt;a href=&quot;http://download.java.net/javadesktop/derby/request_5589934/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://download.java.net/javadesktop/derby/request_5589934/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    junit.framework.AssertionFailedError: Column value mismatch @ column &apos;1&apos;, row 1:
    Expected: &amp;gt;en&amp;lt;
    Found:    &amp;gt;sv&amp;lt;
	at org.apache.derbyTesting.junit.JDBC.assertRowInResultSet(JDBC.java:1303)
	at org.apache.derbyTesting.junit.JDBC.assertRowInResultSet(JDBC.java:1215)
	at org.apache.derbyTesting.junit.JDBC.assertFullResultSetMinion(JDBC.java:1102)
	at org.apache.derbyTesting.junit.JDBC.assertFullResultSet(JDBC.java:1025)
	at org.apache.derbyTesting.junit.JDBC.assertFullResultSet(JDBC.java:982)
	at org.apache.derbyTesting.junit.JDBC.assertFullResultSet(JDBC.java:940)
	at org.apache.derbyTesting.functionTests.tests.lang.LuceneSupportTest.testCreateAndQueryIndex(LuceneSupportTest.java:75)
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:118)
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBareOverridable(BaseJDBCTestCase.java:440)
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBare(BaseJDBCTestCase.java:457)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12708743">DERBY-6544</key>
            <summary>Non-english locale flunks LuceneSupportTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Apr 2014 13:10:50 +0100</created>
                <updated>Wed, 21 Jan 2015 00:23:01 +0000</updated>
                            <resolved>Mon, 5 May 2014 14:15:36 +0100</resolved>
                                    <version>10.11.1.1</version>
                                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13971822" author="rhillegas" created="Wed, 16 Apr 2014 20:15:40 +0100"  >&lt;p&gt;Looking for theories about why this test fails on the machine in question during the nightly runs but does not fail for me on that machine. The machine is sthvmwin011. I have verified that the default locale on that machine is sv_SE. LuceneSupportTest adds a decorator which forces the database locale to be en_US. And there is an assertion in the test that the language is, in fact, en. That assertion fails during the nightly tests because the database language comes back as sv. But when I run the test, the assertion passes.&lt;/p&gt;

&lt;p&gt;All theories welcome. Thanks.&lt;/p&gt;</comment>
                            <comment id="13971865" author="knutanders" created="Wed, 16 Apr 2014 20:59:07 +0100"  >&lt;p&gt;Since the database locale (territory) is set at database creation time, maybe a fresh database needs to be created in order for it to take effect. If you run the test standalone, and the system/wombat database doesn&apos;t already exist, it may appear to work because the database is created by the test, but when it&apos;s run as part of a suite, it ends up with the locale that happened to be the current locale when some earlier test case ran and created the database.&lt;/p&gt;

&lt;p&gt;Most tests that use LocaleTestSetup wrap it around a single-use database decorator. Maybe that&apos;ll do the trick for the Lucene tests as well.&lt;/p&gt;</comment>
                            <comment id="13974380" author="rhillegas" created="Fri, 18 Apr 2014 20:23:35 +0100"  >&lt;p&gt;Thanks, Knut, for that advice. That has moved the problem forward. I was able to reproduce the problem by running a small suite with a couple other tests in it, which run before the Lucene tests. I can also reproduce the problem on my Mac by running the small suite with a Swedish locale. The additional tests are...&lt;/p&gt;

&lt;p&gt;GrantRevokeTest&lt;br/&gt;
DB2IsolationLevelsTest&lt;/p&gt;

&lt;p&gt;...and a Swedish locale can be forced by setting these properties on the command line...&lt;/p&gt;

&lt;p&gt;-Duser.country=SE -Duser.language=sv&lt;/p&gt;

&lt;p&gt;I was able to fix the problems in LuceneSupportTest and LuceneCoarseAuthorizationTest by wrapping those tests in TestConfiguration.singleUseDatabaseDecorator()s. That trick, however, didn&apos;t work for LuceneSupportPermsTest because its other decorators don&apos;t compose correctly with the singleUse decorator. LuceneSupportPermsTest was using a sqlAuthorization decorator, which hardcodes the database name, forcing a collision with the database already created by GrantRevokeTest. I got around that problem by introducing a new TestConfiguration.sqlAuthorizationDecoratorSingleUse() decorator, which lets you override the database name.&lt;/p&gt;

&lt;p&gt;With all of those changes, I was able to get the mini suite to run correctly with a Swedish locale on my Mac. And those changes cleared up the locale problems on the Windows machine too. However, another problem then surfaced on the Windows machine: The DropDatabaseSetup.removeDatabase() method now fails to delete the database created by TestConfiguration.sqlAuthorizationDecoratorSingleUse(). More specifically, there are 19 files, mostly in lucenesupportpermsdb/seg0, which it can&apos;t delete. That means that it managed to delete a lot of other files, but for some reason those 19 files couldn&apos;t be deleted. This suggest to me that the problem is not a Java SecurityManager problem and not even a Windows file permission problem (the error report says that all of those 19 files are readable and writable). My first thought was that those 19 files must be open. So I added the following tearDown() method to LuceneSupportPermsTest:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    protected void tearDown()
        throws Exception
    {
        TestConfiguration.getCurrent().shutdownEngine();
        super.tearDown();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That did not fix the problem. I am attaching a screenshot of the error (error.png). I would welcome theories about what this new problem is.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13974527" author="knutanders" created="Fri, 18 Apr 2014 22:48:56 +0100"  >&lt;p&gt;Hi Rick,&lt;/p&gt;

&lt;p&gt;If you could post the code changes that you&apos;ve made so far, it might be easier for someone to come up with a qualified guess.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13975161" author="rhillegas" created="Sun, 20 Apr 2014 16:29:06 +0100"  >&lt;p&gt;Thanks, Knut. Attaching z.diff, which are the changes to the following files. Z is the script which shows the problem:&lt;/p&gt;

&lt;p&gt;A       java/testing/org/apache/derbyTesting/functionTests/tests/lang/Z.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/LuceneCoarseAuthorizationTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/luceneSupport.policy&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/LuceneSupportPermsTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/LuceneSupportTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/junit/TestConfiguration.java&lt;/p&gt;</comment>
                            <comment id="13975545" author="rhillegas" created="Mon, 21 Apr 2014 13:22:44 +0100"  >&lt;p&gt;Perhaps the files remain open because shutting down the engine (and the database) does not close open file handles. The file handles are orphaned and would not be released until the JVM exits. But our harness runs all the tests in a single instance of the JVM.&lt;/p&gt;</comment>
                            <comment id="13975553" author="rhillegas" created="Mon, 21 Apr 2014 13:57:28 +0100"  >&lt;p&gt;Attaching Z1.java. This is a small test program which is decorated like LuceneSupportPermsTest. Z1 creates a table, inserts some rows, then selects them. When run under the JUnit harness, this test fails the same way. 19 files can&apos;t be deleted and the database directory can&apos;t be deleted.&lt;/p&gt;</comment>
                            <comment id="13975589" author="rhillegas" created="Mon, 21 Apr 2014 15:16:35 +0100"  >&lt;p&gt;If LuceneSupportPermsTest is decorated so that the database is not removed at the end, then the test run succeeds. I am inclined to pursue this solution and log a separate bug against the test harness to make the decorators play together better. The Z1 test demonstrates that this is a test-framework problem and not a defect in the Lucene plugin.&lt;/p&gt;</comment>
                            <comment id="13975597" author="rhillegas" created="Mon, 21 Apr 2014 15:31:34 +0100"  >&lt;p&gt;Attaching derby-6544-01-aa-singleUseDatabases.diff. This patch makes the locale-sensitive Lucene tests run in single-use databases. I am running tests now.&lt;/p&gt;

&lt;p&gt;I will log a follow-on bug for sorting out the decorator problems.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/LuceneCoarseAuthorizationTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/luceneSupport.policy&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/LuceneSupportPermsTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/LuceneSupportTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/junit/TestConfiguration.java&lt;/p&gt;</comment>
                            <comment id="13975739" author="rhillegas" created="Mon, 21 Apr 2014 18:21:40 +0100"  >&lt;p&gt;Full tests passed cleanly for me on derby-6544-01-aa-singleUseDatabases.diff on my Mac. Tests also passed on Mac when I ran the lang suite with a Swedish locale. When I ran the lang suite on the windows machine, it had a lot of errors in the NativeAuthenticationServiceTest. Even without this patch, the lang suite raises the same errors in NativeAuthenticationServiceTest, but without the patch there were also errors in the Lucene tests. I&apos;m going to take this as a green light to checkin.&lt;/p&gt;</comment>
                            <comment id="13975742" author="jira-bot" created="Mon, 21 Apr 2014 18:23:34 +0100"  >&lt;p&gt;Commit 1588933 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1588933&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1588933&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6544&quot; title=&quot;Non-english locale flunks LuceneSupportTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6544&quot;&gt;&lt;del&gt;DERBY-6544&lt;/del&gt;&lt;/a&gt;: Run locale-sensitive Lucene tests in single-use databases; commit derby-6544-01-aa-singleUseDatabases.diff.&lt;/p&gt;</comment>
                            <comment id="13989494" author="rhillegas" created="Mon, 5 May 2014 14:15:36 +0100"  >&lt;p&gt;I have not seen this bug in a long time. It appears to be fixed.&lt;/p&gt;</comment>
                            <comment id="14284731" author="myrna" created="Wed, 21 Jan 2015 00:23:01 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12317415">DERBY-590</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12709557">DERBY-6546</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12641060" name="Z1.java" size="5503" author="rhillegas" created="Mon, 21 Apr 2014 13:57:28 +0100"/>
                            <attachment id="12641067" name="derby-6544-01-aa-singleUseDatabases.diff" size="10226" author="rhillegas" created="Mon, 21 Apr 2014 15:31:34 +0100"/>
                            <attachment id="12640869" name="error.png" size="281965" author="rhillegas" created="Fri, 18 Apr 2014 20:23:35 +0100"/>
                            <attachment id="12640991" name="z.diff" size="22374" author="rhillegas" created="Sun, 20 Apr 2014 16:29:06 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 16 Apr 2014 19:59:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>387066</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzoj7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>387329</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>