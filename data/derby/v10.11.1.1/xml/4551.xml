<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:30:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4551/DERBY-4551.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4551] Allow database user to execute stored procedures with same permissions as database owner and/or routine definer</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4551</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Curretnly there is no way to hide data and database structure in embedded derby from the end user. &lt;/p&gt;

&lt;p&gt;One way to accomplish the above requirement is as follows:&lt;br/&gt;
1. Create encrypted database so data is protected&lt;br/&gt;
2. Enable authentication and sql authorization in database&lt;br/&gt;
3. Create two users, dbUser and dbOwner&lt;br/&gt;
4. Store application logic as stored procedure in the databse so dbUser does not know what tables are accecced by the application logic, thus hiding table structure&lt;br/&gt;
5. Revoke select permission from dbUser so he cannot describe tables thus protecting table structures&lt;br/&gt;
6. Give only Execute permissions on stored procedures to dbUser&lt;/p&gt;

&lt;p&gt;The above steps will ensure that data and data structure is hidden when application is delivered to end user.&lt;/p&gt;

&lt;p&gt;The problem is, if user does not have select permission, the stored procedures will not execute. So I am requesting the following enhancement to Derby:&lt;/p&gt;

&lt;p&gt;If dbOwner has given Execure permission to stored procecure to a dbUser, then allow stored procedure to execute even if the dbUser has no select permission. &lt;/p&gt;

&lt;p&gt;In otherwords, When dbUser calls stored procedure, database will use dbOwners authorization to execute stored procedure rather than dbUsers.  &lt;/p&gt;

&lt;p&gt;This may be implemented by creating new permission called RunAsDbOwner.&lt;/p&gt;

&lt;p&gt;DbOwner can then grant permission to dbUser  to execute a stored procedure with RunAsDbOwner.&lt;/p&gt;

&lt;p&gt;If this is implemented, applications can be created which will truely hide the database structure and data from end users. Database will behave as a blackbox with only in/out data exposed in stored procedures.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12456504">DERBY-4551</key>
            <summary>Allow database user to execute stored procedures with same permissions as database owner and/or routine definer</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="tskale">Tushar Kale</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Feb 2010 03:13:20 +0000</created>
                <updated>Mon, 17 Jun 2013 10:19:14 +0100</updated>
                            <resolved>Fri, 24 Sep 2010 20:36:39 +0100</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.3.3.0</version>
                    <version>10.4.1.3</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                    <version>10.5.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12835823" author="rhillegas" created="Fri, 19 Feb 2010 17:07:43 +0000"  >&lt;p&gt;One workaround would be for the database procedure to create a connection using the database owner&apos;s credentials and do its work in that connection. The database procedure could be stored in a jar file in the database. The hard-coded credentials would be protected by the database-wide encryption. Hope this helps.&lt;/p&gt;</comment>
                            <comment id="12864952" author="thomashill" created="Thu, 6 May 2010 23:30:35 +0100"  >&lt;p&gt;Although my requirement is not to hide data structure from the end user, being able to specify the security context in which SQL routines (stored procedures and functions) are executed would improve SQL standard compliance and allow a security layer to be implemented by which access to data (primarily inserts, updates, deletes / but also selects if needed) would only be possible via SQL routines. When designing database applications, one rarely wants users to have full permissions to access the tables in the database. Many applications are designed to perform all database access through stored procedures (which have all been created by / are owned by the database owner), and it is through the stored procedures application users can access and update data. The procedures perform validations of business rules to protect the integrity of the database. This concept would also work when accessing data with SQL Query tools like IJ.&lt;/p&gt;

&lt;p&gt;Raising questions about routine permission granting on the Derby mailing list, I was advised by Dag Wanvik that &quot;Derby routines execute with the invoker&apos;s current privileges. SQL has a provision for defining routines to run with the definer&apos;s privileges as well, but this is not yet implemented in Derby. Feel free to file an improvement request!&quot;. As I found this existing request which I consider asking largerly for the same, I decided to add my comments here.&lt;/p&gt;

&lt;p&gt;Having looked at other data bases, to execute routines with the invoker&apos;s privileges seems to be the default commonly found (at least in MS SQL 2005 and PostgreSQL). &lt;br/&gt;
Note: For SQL Server I found the SQL text from Erland Sommarskog published at &lt;a href=&quot;http://www.sommarskog.se/grantperm.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.sommarskog.se/grantperm.html&lt;/a&gt; very helpful. After having read this, it was sufficient to look at the create function statement syntax for PostgreSQL to understand how ownership chaining is implemented there. I would have liked to read the SQL standard on this, but am not sure where this can be found.&lt;br/&gt;
However these databases (MS SQL, PostgreSQL) in contrast to Derby also allow executing routines with the definer&apos;s privilege. &lt;/p&gt;

&lt;p&gt;Two additional topics come to mind which I think need to be mentioned:&lt;br/&gt;
1) As logging the user who manipulated the data is also a frequent requirement, there would also need to be a function made available which would unlike CURRENT_USER not return the name of the user under whos privileges the SQL is executed (i.e. the database owner), but the session user who is connected to the database / has called the routine (e.g. FredMeyer).&lt;br/&gt;
2) Not sure if there is a dependency on schema privileges. I noted when testing on PostgreSQL that usage privileges need to be granted on the schema(s) - the grant statement in Derby has not option allowing to grant permissions on schemas.&lt;/p&gt;

&lt;p&gt;I will look into the workaround suggested by Rick above and might use it hoping for this request to receive attention and support from the community to get implemented soon. (Unfortunately I am not a programmer myself, so am afraid can&apos;t contribute more than raising the request and potentially writing documentation on it.&lt;/p&gt;

&lt;p&gt;Regards&lt;br/&gt;
Thomas&lt;/p&gt;</comment>
                            <comment id="12864971" author="dagw" created="Fri, 7 May 2010 01:14:19 +0100"  >&lt;p&gt;Thanks, Thomas. You can find the SQL standard drafts (very close to the real thing!) here:&lt;br/&gt;
&lt;a href=&quot;http://www.wiscorp.com/SQLStandards.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.wiscorp.com/SQLStandards.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12867282" author="dagw" created="Thu, 13 May 2010 23:19:56 +0100"  >&lt;p&gt;Updated title, set component to SQL, reset Urgency field since that is reserved by dev team at triage time.&lt;/p&gt;</comment>
                            <comment id="12867284" author="dagw" created="Thu, 13 May 2010 23:21:05 +0100"  >&lt;p&gt;Uploading a draft functional specification for this feature.&lt;/p&gt;</comment>
                            <comment id="12867524" author="dagw" created="Fri, 14 May 2010 16:19:31 +0100"  >&lt;p&gt;Updated the spec with a new example which also shows the feature used with a table function.&lt;/p&gt;</comment>
                            <comment id="12867546" author="dagw" created="Fri, 14 May 2010 17:14:12 +0100"  >&lt;p&gt;Updated spec with note on semantics of SESSION_USER as opposed to CURRENT_USER inside a routine running with definer&apos;s rights.&lt;/p&gt;</comment>
                            <comment id="12868718" author="dagw" created="Tue, 18 May 2010 17:40:07 +0100"  >&lt;p&gt;Uploading new version of the spec draft, added a section on security and impl suggestion for RoutineAliasInfo.&lt;/p&gt;</comment>
                            <comment id="12869646" author="rhillegas" created="Thu, 20 May 2010 16:53:36 +0100"  >&lt;p&gt;Thanks for the functional spec, Dag. Some small comments follow:&lt;/p&gt;

&lt;p&gt;Behavior&lt;/p&gt;

&lt;p&gt;o Some typos:&lt;/p&gt;

&lt;p&gt;  &quot;to Derby will retain&quot; -&amp;gt; &quot;so Derby will retain&quot;&lt;/p&gt;

&lt;p&gt;  &quot;notwithstanding and lack&quot; -&amp;gt; &quot;notwithstanding a lack&quot;&lt;/p&gt;

&lt;p&gt;o I did not understand the red paragraph. It talked about 2 different routines and it was hard for me to tell which routine was intended at various points in the paragraph.&lt;/p&gt;

&lt;p&gt;o By &quot;real caller&quot; you mean the user associated with the original stack frame, that is, the user whose credentials logged in the session?&lt;/p&gt;


&lt;p&gt;Security Considerations&lt;/p&gt;

&lt;p&gt;o Probably this feature widens the scope of SQL injection attacks since the procedure could construct statements based on its arguments.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="12869997" author="dagw" created="Fri, 21 May 2010 15:34:34 +0100"  >&lt;p&gt;Uploading version 1.0 of spec. Please review.&lt;/p&gt;</comment>
                            <comment id="12870163" author="dagw" created="Fri, 21 May 2010 22:07:17 +0100"  >&lt;p&gt;Thanks for your comments, Rick. Uploading a new version which addresses those + one more item, see rev. notes at top.&lt;/p&gt;</comment>
                            <comment id="12870193" author="dagw" created="Fri, 21 May 2010 23:17:16 +0100"  >&lt;p&gt;Uploading a first patch for this feature, which is intended to implement the specification as it currently stands.&lt;br/&gt;
Please see detailed patch notes in derby-4551-1.txt. Regressions ran ok. &lt;/p&gt;

&lt;p&gt;Tests for the new feature are still only rudimentary.&lt;/p&gt;</comment>
                            <comment id="12870421" author="dagw" created="Sun, 23 May 2010 17:27:59 +0100"  >&lt;p&gt;Rick &amp;gt; By &quot;real caller&quot; you mean the user associated with the original stack frame, that is, the user whose credentials logged in the session?&lt;/p&gt;

&lt;p&gt;Yes, I have changed the wording now.&lt;/p&gt;
</comment>
                            <comment id="12871145" author="rhillegas" created="Tue, 25 May 2010 14:39:46 +0100"  >&lt;p&gt;Thanks for the patch and description, Dag. I glanced at the changes and they look like they are covering a lot of cases. I was wondering about what happens in the following situation:&lt;/p&gt;

&lt;p&gt;o Alice invokes procedure Brad.P which executes with definer&apos;s rights.&lt;/p&gt;

&lt;p&gt;o Procedure Brad.P sets role to HR, does some work, then returns.&lt;/p&gt;

&lt;p&gt;o What is the role of Alice&apos;s session after the return?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="12871150" author="dagw" created="Tue, 25 May 2010 14:56:28 +0100"  >&lt;p&gt;Thanks for looking at the patch, Rick!&lt;/p&gt;

&lt;p&gt;When a routine exits, any role set inside the routine will be popped back to whatever role (or none) was set when the call was invoked. This is true whether definer&apos;s or invoker&apos;s rights are used, as per the standard. &lt;/p&gt;

&lt;p&gt;In the implementation this is realized by popping the SQLSessionContext which was pushed at call time. The &quot;old&quot; SQLSessionContext (the one which was active when the call was invoked) is untouched during the invocation, and will still hold the &quot;old&quot; values of current user, current role and current default schema at return time. &lt;/p&gt;

&lt;p&gt;The new thing with the patch is that the current user is also held by the stack of SQLSessionContexts, making it possible to pop back from the defining user to the invoking user in a similar way at return time.&lt;/p&gt;</comment>
                            <comment id="12871967" author="dagw" created="Wed, 26 May 2010 22:53:07 +0100"  >&lt;p&gt;Uploading version 2 of this patch. The only difference relative version 1 is that more tests have been added, including:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;test of 2 levels of routines:&lt;/li&gt;
	&lt;li&gt;invoker session, which calls&lt;/li&gt;
	&lt;li&gt;definer A&apos;s rights routine, employing a role to next call&lt;/li&gt;
	&lt;li&gt;definer B&apos;s rights routine&lt;/li&gt;
	&lt;li&gt;sanity checks that current user, role are reset correctly at return time&lt;/li&gt;
	&lt;li&gt;test of explicit invoker&apos;s rights syntax and behavior.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you have ideas of more tests for this feature, feel free to suggest them!&lt;br/&gt;
Rerunning regressions.&lt;/p&gt;</comment>
                            <comment id="12872247" author="dagw" created="Thu, 27 May 2010 16:07:56 +0100"  >&lt;p&gt;Uploading rev 3 of the patch, which adds dblook support &amp;amp; tests, otherwise identical to rev 2.&lt;/p&gt;</comment>
                            <comment id="12872331" author="dagw" created="Thu, 27 May 2010 20:23:24 +0100"  >&lt;p&gt;Revision 3 had some missing updates to the masters for dblook_test (DerbyNet, DerbyNetClient), so I upload a version that passed regressions:  derby-4551-3b.&lt;/p&gt;</comment>
                            <comment id="12875178" author="dagw" created="Thu, 3 Jun 2010 17:12:04 +0100"  >&lt;p&gt;I have not had any comment on the new patch for about a week, so I will commit this patch shortly.&lt;/p&gt;</comment>
                            <comment id="12875529" author="kristwaa" created="Fri, 4 Jun 2010 09:48:44 +0100"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;I read through the specification. It was very clear, nicely written &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
A few observations and comments (correct me if I got this wrong):&lt;br/&gt;
 o Derby will deviate from the standard for the default value of EXTERNAL SECURITY, this is done to avoid breaking existing applications.&lt;br/&gt;
 o There is an issue with REVOKE EXECUTE ... RESTRICT, which is proposed handled &lt;span class=&quot;error&quot;&gt;&amp;#91;for now&amp;#93;&lt;/span&gt; by relaxing the semantics of RESTRICT.&lt;br/&gt;
 o As far as I understand, no changes to the descriptors for existing routines will be performed on hard upgrade. They happen to already have the value meaning INVOKER.&lt;br/&gt;
 o Should there be a release note describing the changes made to SESSION_USER?&lt;br/&gt;
    The reference manual says: &quot;USER, CURRENT_USER, and SESSION_USER are synonyms.&quot;&lt;/p&gt;

&lt;p&gt;I also attached &apos;definers_rights_typos-1.diff&apos;, which you may want to incorporate if you update the specification.&lt;/p&gt;</comment>
                            <comment id="12875572" author="knutanders" created="Fri, 4 Jun 2010 12:47:05 +0100"  >&lt;p&gt;The changes in the patch look reasonable to me. One tiny nit: the added Boolean variable definersRights in sqlgrammar.jj appears to be unused.&lt;/p&gt;</comment>
                            <comment id="12875667" author="dagw" created="Fri, 4 Jun 2010 18:19:03 +0100"  >&lt;p&gt;Thanks a lot, guys!&lt;/p&gt;

&lt;p&gt;@Kristian: 3 first items are all correctly observed. Item 4: I think we need to update the documentation on SESSION_USER,&lt;br/&gt;
but  I am not sure we need a release note, since the change in semantics is only observable with the new feature. Old usage (with invoker&apos;s rights only) will still not change behavior for SESSION_USER. I&apos;ll incorporate your typos, thx!&lt;/p&gt;

&lt;p&gt;@Knut: I&apos;ll fix the nit before I commit&lt;/p&gt;</comment>
                            <comment id="12876061" author="dagw" created="Sun, 6 Jun 2010 18:14:41 +0100"  >&lt;p&gt;Uploading version 1.2 of the specification for this feature:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixed typos found by Krisitian, thanks!&lt;/li&gt;
	&lt;li&gt;added an item for doc additon to REVOKE statement.&lt;/li&gt;
	&lt;li&gt;added an item for doc addition to the user built-in functions.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12876080" author="dagw" created="Sun, 6 Jun 2010 21:11:39 +0100"  >&lt;p&gt;Uploading derby-4551-4, which &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixes Knut&apos;s nit&lt;/li&gt;
	&lt;li&gt;adds a test to check that multiple security clauses are caught, and updated sqlgrammar to include&lt;br/&gt;
  a string for the new error message parameter, which was missing.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regressions ran ok.&lt;/p&gt;</comment>
                            <comment id="12876241" author="dagw" created="Mon, 7 Jun 2010 14:52:10 +0100"  >&lt;p&gt;Committed derby-4551-4 as svn 952227.&lt;/p&gt;</comment>
                            <comment id="12876243" author="dagw" created="Mon, 7 Jun 2010 14:56:08 +0100"  >&lt;p&gt;Tushar &amp;amp; Thomas, if you want to test the new functionality you can download Derby trunk with subversion and compile it yourself. Note that you should not use those bits in production, since it&apos;s a snapshot of the development branch which has not been through QA.&lt;/p&gt;</comment>
                            <comment id="12876289" author="dagw" created="Mon, 7 Jun 2010 16:55:24 +0100"  >&lt;p&gt;Committed a follow-up patch to address some Javadoc issues, svn 952284.&lt;/p&gt;</comment>
                            <comment id="12876807" author="thomashill" created="Tue, 8 Jun 2010 22:10:46 +0100"  >&lt;p&gt;Dag, many thanks for your work on this! I am amazed how quickly this has been picked up and a solution put in place. I would like to test, but am not sure I will be able to download and compile a Derby version myself (have never done/tried something like that before). &lt;/p&gt;</comment>
                            <comment id="12876819" author="dagw" created="Tue, 8 Jun 2010 22:44:51 +0100"  >&lt;p&gt;Thanks, Thomas. Instead of compiling yourself, you could pick up and test with the latest daily jars we make for our regression testing here:&lt;br/&gt;
&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/bits/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/bits/trunk&lt;/a&gt;. Again, these are not for production usage and may be unstable. This feature will be part of the 10.7 release, whenever that comes.&lt;/p&gt;</comment>
                            <comment id="12885345" author="thomashill" created="Mon, 5 Jul 2010 22:10:41 +0100"  >&lt;p&gt;I have tested using the daily build from 26th June. Regression testing, i.e. recreating all my database objects under 10.7.0.0 and embedding my current Java procedures in which I use a workaround of running a connect with hardcoded credentials of the data base owner at the beginning of each procedure (=&amp;gt; Connection conn =  DriverManager.getConnection(&quot;jdbc:derby:DB1;bootPassword=xxxx;user=dbo;password=zzzz;&quot;)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; worked as expected, so everything continued to run fine. Then I have:&lt;br/&gt;
1) recreated the procedures with External Security Definer, &lt;br/&gt;
2) changed the Java code to re-use an existing connection (=&amp;gt; Connection conn = DriverManager.getConnection(&quot;jdbc:default:connection&quot;)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  &lt;br/&gt;
3) created a &apos;normal&apos; login/user without permissions on the (base) table, &lt;br/&gt;
4) created a role &apos;data_updater&apos;, &lt;br/&gt;
5) wrote a Java stored procedure to update the base table and created a corresponding stored procedure  when being logged in as database owner, &lt;br/&gt;
6) granted permission to execute the procedure to role &apos;data_updater&apos;, &lt;br/&gt;
7) granted role &apos;data_updater&apos; to my &apos;normal&apos; application user &lt;br/&gt;
8) logged in as the &apos;normal&apos; application user&lt;br/&gt;
9) set role to &apos;data_updater&apos; and finally&lt;br/&gt;
10) tried to run the procedure&lt;br/&gt;
==&amp;gt; I am getting a SQLException that the user does not have update permissions on the (first column in the) table. &lt;/p&gt;

&lt;p&gt;Can you please advise if you are spotting anything I have forgotten or done incorrectly as I was expecting step 10 to succeed with the new feature being available in this build?&lt;/p&gt;</comment>
                            <comment id="12885552" author="dagw" created="Tue, 6 Jul 2010 15:36:16 +0100"  >&lt;p&gt;Thanks for test driving this, Thomas!&lt;/p&gt;

&lt;p&gt;It looks right to me. Did you remember to specify EXTERNAL SECURITY DEFINER  in step 5?&lt;br/&gt;
You may have a look at the tests I wrote for this feature, one of which which does essentially the same thing:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/db/derby/code/trunk/java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutinesDefinersRightsTest.java?view=log&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/db/derby/code/trunk/java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutinesDefinersRightsTest.java?view=log&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you still can&apos;t make it work, please try to make a repro, so we can have a look at it.&lt;/p&gt;</comment>
                            <comment id="12885693" author="thomashill" created="Tue, 6 Jul 2010 22:24:42 +0100"  >&lt;p&gt;YES, I did specify EXTERNAL SECURITY DEFINER on the DDL to create the procedures.&lt;/p&gt;

&lt;p&gt;I will extract the relevant parts from my scripts used to create the data base and it&apos;s objects and double check / try again. &lt;br/&gt;
If don&apos;t come accross anything I overlooked and still can&apos;t get it to work, I would make a repro and appreciate if you could have a look as offered then.&lt;/p&gt;

&lt;p&gt;Might take me a couple of days before coming back on this.&lt;/p&gt;</comment>
                            <comment id="12887745" author="kristwaa" created="Tue, 13 Jul 2010 14:04:49 +0100"  >&lt;p&gt;Besides from the pending feedback from Thomas H. and any potential follow-up work, is the work for this issue complete?&lt;/p&gt;</comment>
                            <comment id="12887776" author="dagw" created="Tue, 13 Jul 2010 15:41:05 +0100"  >&lt;p&gt;Yes, as far as I know. I&apos;ll wait with resolving it till we get Thomas&apos; issue cleared up.&lt;/p&gt;</comment>
                            <comment id="12891959" author="thomashill" created="Sat, 24 Jul 2010 10:06:25 +0100"  >&lt;p&gt;I have now produced a repro (see file reproTH-derby-4551). Unfortunately all I can say (after quite some hours of testing) is, that my repro sometimes works (= user Thomas@000 can insert a new row into table rte.&quot;TBL_Clients&quot; (on which he holds no permissions) via stored procedure rte.&quot;SP_addClient&quot; created as DBO with external security definer and sometimes not (then receiving an error that user has no permission to update app.&quot;TBL_ApplIDs&quot; from which I am fetching the next available client ID). Note: I have included a call to the stored procedure incrementing the ClientID into the addClient procedure as this is a concept I use for assigning next available values to IDs, knowing that in the repro nothing is done with the result returned. The zipped file also includes the database DB - selecting from rte.&quot;TBL_Clients&quot; shows that the row was inserted by Thomas@000. I hope the scripts included in the repro to reproduce the situation are self-explanatory. Thanks again for your help and willingness to look into this.&lt;/p&gt;</comment>
                            <comment id="12891960" author="thomashill" created="Sat, 24 Jul 2010 10:07:55 +0100"  >&lt;p&gt;repro from Thomas - see related comment&lt;/p&gt;</comment>
                            <comment id="12892702" author="kristwaa" created="Tue, 27 Jul 2010 10:23:20 +0100"  >&lt;p&gt;Thanks for the repro, Thomas.&lt;/p&gt;

&lt;p&gt;I think Dag is on vacation (as many others in the community), so unless someone else feels the itch it may take a while before this issue is cleared up (sounds like more investigation is needed).&lt;/p&gt;</comment>
                            <comment id="12893078" author="thomashill" created="Wed, 28 Jul 2010 07:34:32 +0100"  >&lt;p&gt;Thanks Kristian for letting me know.&lt;/p&gt;</comment>
                            <comment id="12911029" author="dagw" created="Sat, 18 Sep 2010 15:54:35 +0100"  >&lt;p&gt;Thomas, just to confirm, I can reproduce using your uploaded repro, thanks!&lt;/p&gt;</comment>
                            <comment id="12911050" author="dagw" created="Sat, 18 Sep 2010 18:04:15 +0100"  >&lt;p&gt;Thomas, there is definitely a bug here, thanks a lot for uncovering it and providing a good repro &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12912261" author="dagw" created="Sun, 19 Sep 2010 18:28:09 +0100"  >&lt;p&gt;Attaching a patch (followup-1a) which fixes the issue seen. It problem doesn&apos;t have&lt;br/&gt;
to do with the implementation of definer&apos;s rights &lt;b&gt;per se&lt;/b&gt;, but showed&lt;br/&gt;
up in this case due to the feature&apos;s heavy dependence of the&lt;br/&gt;
correctness of the SQL session context introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3327&quot; title=&quot;SQL roles: Implement authorization stack (and SQL session context to hold it)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3327&quot;&gt;&lt;del&gt;DERBY-3327&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The problem here is that the substatement executed as part of&lt;br/&gt;
ResultSet.&lt;/p&gt;
{insertRow, updateRow,deleteRow}
&lt;p&gt; pushes a new statement&lt;br/&gt;
context. This statement context is consulted when constructing the&lt;br/&gt;
activation for the substatement, to see if the activation shall have a&lt;br/&gt;
parent activation (which is used to get the correct SQL session&lt;br/&gt;
context),&lt;br/&gt;
cf. GenericLanguageConnectionContext#getCurrentSQLSessionContext.&lt;/p&gt;

&lt;p&gt;However, the newly pushed statement context was missing its parent&apos;s&lt;br/&gt;
activation, so the substatement instead get the top level session&lt;br/&gt;
context, whose current user is not the DEFINER (in this case instead&lt;br/&gt;
of &quot;DBO&quot; it was &quot;Thomas&quot;), cf&lt;br/&gt;
BaseActivation#setupSQLSessionContextForChildren, hence the&lt;br/&gt;
authorization error.&lt;/p&gt;

&lt;p&gt;The patch makes sure the nested statement context initially gets the&lt;br/&gt;
(new) parent context set.&lt;/p&gt;

&lt;p&gt;The repro now works with this patch. Running regression tests.&lt;/p&gt;

&lt;p&gt;The patch is not for commit, I need to add new regression tests for&lt;br/&gt;
this case.&lt;/p&gt;</comment>
                            <comment id="12912301" author="dagw" created="Mon, 20 Sep 2010 00:44:01 +0100"  >&lt;p&gt;Regressions ran OK. &lt;/p&gt;

&lt;p&gt;Uploading version followup-1b, which adds tests for the problem seen,&lt;br/&gt;
cf. the new stored procedure with definer&apos;s rights:&lt;br/&gt;
RoutinesDefinersRightsTest#updateWage.  This procedure exercises&lt;br/&gt;
ResultSet.insertRow, ResultSet.updateRow and ResultSet.deleteRow to&lt;br/&gt;
check that their nested SQL statement run with the proper SQL session&lt;br/&gt;
context.  Rerunning regressions: &lt;span class=&quot;error&quot;&gt;&amp;#91;Update: ran OK&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Ready for review.&lt;/p&gt;</comment>
                            <comment id="12912560" author="dagw" created="Mon, 20 Sep 2010 17:15:12 +0100"  >&lt;p&gt;Attaching a debugging patch I used to trace the sequence of active SQL session contexts  and current users during execution, in case somebody (most likely myself &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; needs to revisit this area in case of future bugs (derby4551-trial.diff).&lt;/p&gt;</comment>
                            <comment id="12913204" author="dagw" created="Tue, 21 Sep 2010 20:41:57 +0100"  >&lt;p&gt;Committed patch derby-4551-followup-1b (plus some small hygiene adjustments) as svn 999570.&lt;/p&gt;</comment>
                            <comment id="12914263" author="dagw" created="Thu, 23 Sep 2010 23:30:43 +0100"  >&lt;p&gt;Thomas, if you want to, you may pick up a testing binary which contains the fix by now. I would appreciate any feedback. Hopefully it should work now. Again, the latest daily jars we make for our regression testing here:&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/bits/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/bits/trunk&lt;/a&gt;. Again, these are not for production usage and may be unstable. Pick one with s subversion number &amp;gt;999570.&lt;/p&gt;</comment>
                            <comment id="12914613" author="dagw" created="Fri, 24 Sep 2010 20:36:39 +0100"  >&lt;p&gt;Resolving this issue since I don&apos;t plan more work on it. Docs still remain, though.&lt;/p&gt;</comment>
                            <comment id="12915214" author="thomashill" created="Mon, 27 Sep 2010 07:37:42 +0100"  >&lt;p&gt;At this stage I can confirm the repro now works fine. I plan to do some further &apos;testing&apos;, i.e. to recreate all my stored procs with external security definer and run my application to see if, in this context, this works as expected as well.&lt;/p&gt;</comment>
                            <comment id="12915924" author="dagw" created="Tue, 28 Sep 2010 22:09:35 +0100"  >&lt;p&gt;Thanks a lot for the help, Thomas! The more bugs we can get rid of before the release, the better! &lt;/p&gt;</comment>
                            <comment id="12916635" author="thomashill" created="Thu, 30 Sep 2010 21:23:15 +0100"  >&lt;p&gt;I have now recreated my stored procedures (~ 12 procs) with external security definer and used them to access and change data in base tables to which the user (/ role) I was logged in as has no access. Everything worked as expected. (Note that this test more likely tested the same conditions multiple times opposed to a structured testing which would aim at testing all possible conditions (at least) one time.)&lt;/p&gt;</comment>
                            <comment id="12917653" author="dagw" created="Mon, 4 Oct 2010 17:30:56 +0100"  >&lt;p&gt;Good to know.Thanks for your continued help with testing this new feature!&lt;/p&gt;</comment>
                            <comment id="12917756" author="thomashill" created="Mon, 4 Oct 2010 21:48:29 +0100"  >&lt;p&gt;Thanks to you for the implementation! Looking forward to this new feature becoming available - and really hope it will make it into 10.7. and this release not being in a too distant future.&lt;/p&gt;</comment>
                            <comment id="12917886" author="kristwaa" created="Tue, 5 Oct 2010 07:41:44 +0100"  >&lt;p&gt;The current plan for the 10.7 release can be found here: &lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyTenSevenOneRelease&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DerbyTenSevenOneRelease&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12920303" author="thomashill" created="Tue, 12 Oct 2010 19:57:24 +0100"  >&lt;p&gt;Would need advice on a related question:&lt;br/&gt;
At this stage I have hard coded a connection string opening a new connection as &apos;dbo&apos; into my stored procedures (i.e. implemented the work around as per Rick&apos;s advice) which I intend to remove once this feature becomes available. Recently I have moved my network server to an environment hosted by a java hoster on the internet. This network server uses SSL and authentication. SSL encryption is based on certificates which were self generated using the keytool utility. The network server is started with default/simple security policy and with references to the keystore file on the command line. I am able to connect to the server and issue SQL commands (e.g.selects, inserts) via IJ just fine when starting IJ via a reference to the clientkeystore file and connecting with ssl=basic. However when trying to call my stored procedures I am getting security errors.&lt;br/&gt;
Questions: &lt;br/&gt;
1) on my hard coded connection strings at the start of each procedure do I need to specify ssl=basic or is ssl not relevant in this context as the code is executed within the server? When trying the connect with ssl=basic I am getting &apos;access denied (java.util.PropertyPermission javax.net.ssl.keyStore write): java.security.AccessControlException&apos; - my hoster tells me properties are set to allow read,write access, i.e. permission java.util.PropertyPermission &quot;*&quot;,&quot;read,write&quot; is in place;&lt;br/&gt;
   a) do I also need the java code System.setProperty(&quot;javax.net.ssl.keyStore&quot;, vcKeyStoreFileName) and System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, vcKeyStorePassword) prior to the connect?; - tried this as well, but no success.&lt;/p&gt;

&lt;p&gt;2) if I ommit the ssl parameter completely, I am getting a different err: &apos;access denied (java.net.SocketPermission 127.0.0.1:31540 connect,resolve): java.security.AccessControlException&apos;, again the property file setting is permission java.net.SocketPermission &quot;*&quot;,&quot;accept, connect, listen, resolve&quot;&lt;/p&gt;

&lt;p&gt;Not sure what the right approach would be. Hope my explanation was clear enough and someone can offer some advice.&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                            <comment id="12920390" author="dagw" created="Tue, 12 Oct 2010 23:40:27 +0100"  >&lt;p&gt;You are correct that ssl is not necessary when one opens a connection from within the stored procedure (it is already inside the server).&lt;br/&gt;
Since in 2) you are seeing Sockepermission errors, it seems you are using client/server URL connect syntax. You could try to use embedded URL connection syntax, i.e. &quot;jdbc:derby:&amp;lt;dbname-possibly-incl-path&amp;gt;;user=&amp;lt;username&amp;gt;;password=&amp;lt;userpassword&amp;gt;&quot;, since there is no need to go out via a socket when you are already executing in the server. Does that help?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://db.apache.org/derby/docs/10.6/devguide/tdevdvlp12233.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/docs/10.6/devguide/tdevdvlp12233.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12920709" author="thomashill" created="Wed, 13 Oct 2010 19:37:54 +0100"  >&lt;p&gt;Dag, thanks for your prompt reply. Using an embedded URL connection syntax (and no ssl option) solved the problem. So yes, you helped me once again.&lt;/p&gt;</comment>
                            <comment id="13069693" author="thomashill" created="Fri, 22 Jul 2011 20:41:32 +0100"  >&lt;p&gt;I hope it is okay to add comments to a resolved issue... &lt;br/&gt;
One use case I just came accross is that I would need to know in the SQL code inside the procedure defined with External Security Definer the role that had been set for the session user prior to calling the procedure - so a &quot;SESSION_ROLE&quot; which implements for CURRENT_ROLE what SESSION_USER does for CURRENT_USER. Would this make sense to implement? or is there another way to achieve this? (besides passing the role to the procedure as a string parameter)&lt;/p&gt;</comment>
                            <comment id="13070479" author="dagw" created="Mon, 25 Jul 2011 13:57:15 +0100"  >&lt;p&gt;You are right that there is no SESSION_ROLE to mirror SESSION_USER currently. Nor does the SQL standard have such a built-in. The only way would be to pass it in as a string parameter as you say. I think we would hesitate to add this since it&apos;s not defined by the standard, unless we had a really compelling reason to do so. It seems to me you would only need this is you wanted to implement some hand-crafted access control within the definer&apos;s rights method?&lt;/p&gt;</comment>
                            <comment id="13070977" author="thomashill" created="Tue, 26 Jul 2011 07:52:55 +0100"  >&lt;p&gt;Thanks for your reply and for sharing background on this not being part of the SQL standard. I fully understand the hesitation to implement and will use the work-around to pass the role name as a parameter then. Your assumption is right: I moved application level security and access control checking into the data base: for select operations by defining views that only return rows the user is allowed to see; for insert/update/delete operations (which in my set-up can only be performed by executing stored procedures the user is granted permission on) I would need to know inside the procedure which user called it and which role was set for the user before invoking the procedure.&lt;/p&gt;</comment>
                            <comment id="13685171" author="knutanders" created="Mon, 17 Jun 2013 10:19:14 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12386518">DERBY-3327</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12465573">DERBY-4680</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12446444" name="definers_rights.html" size="27128" author="dagw" created="Sun, 6 Jun 2010 18:22:04 +0100"/>
                            <attachment id="12445201" name="definers_rights.html" size="26290" author="dagw" created="Fri, 21 May 2010 22:07:17 +0100"/>
                            <attachment id="12445171" name="definers_rights.html" size="25283" author="dagw" created="Fri, 21 May 2010 15:34:34 +0100"/>
                            <attachment id="12444809" name="definers_rights.html" size="24024" author="dagw" created="Tue, 18 May 2010 17:40:07 +0100"/>
                            <attachment id="12444505" name="definers_rights.html" size="22818" author="dagw" created="Fri, 14 May 2010 17:13:15 +0100"/>
                            <attachment id="12444495" name="definers_rights.html" size="22154" author="dagw" created="Fri, 14 May 2010 16:19:31 +0100"/>
                            <attachment id="12444433" name="definers_rights.html" size="18673" author="dagw" created="Thu, 13 May 2010 23:31:44 +0100"/>
                            <attachment id="12446336" name="definers_rights_typos-1.diff" size="3121" author="kristwaa" created="Fri, 4 Jun 2010 09:48:44 +0100"/>
                            <attachment id="12445210" name="derby-4551-1.diff" size="77767" author="dagw" created="Fri, 21 May 2010 23:17:15 +0100"/>
                            <attachment id="12445211" name="derby-4551-1.stat" size="3084" author="dagw" created="Fri, 21 May 2010 23:17:16 +0100"/>
                            <attachment id="12445242" name="derby-4551-1.txt" size="4364" author="dagw" created="Sun, 23 May 2010 00:55:00 +0100"/>
                            <attachment id="12445583" name="derby-4551-2.diff" size="84937" author="dagw" created="Wed, 26 May 2010 22:53:07 +0100"/>
                            <attachment id="12445584" name="derby-4551-2.stat" size="3181" author="dagw" created="Wed, 26 May 2010 22:53:07 +0100"/>
                            <attachment id="12445659" name="derby-4551-3.diff" size="89343" author="dagw" created="Thu, 27 May 2010 16:07:56 +0100"/>
                            <attachment id="12445660" name="derby-4551-3.stat" size="3444" author="dagw" created="Thu, 27 May 2010 16:07:56 +0100"/>
                            <attachment id="12445692" name="derby-4551-3b.diff" size="93071" author="dagw" created="Thu, 27 May 2010 20:23:24 +0100"/>
                            <attachment id="12445693" name="derby-4551-3b.stat" size="3856" author="dagw" created="Thu, 27 May 2010 20:23:24 +0100"/>
                            <attachment id="12446447" name="derby-4551-4.diff" size="94710" author="dagw" created="Sun, 6 Jun 2010 21:11:39 +0100"/>
                            <attachment id="12446448" name="derby-4551-4.stat" size="3856" author="dagw" created="Sun, 6 Jun 2010 21:11:39 +0100"/>
                            <attachment id="12454981" name="derby-4551-followup-1a.diff" size="4859" author="dagw" created="Sun, 19 Sep 2010 18:28:09 +0100"/>
                            <attachment id="12454982" name="derby-4551-followup-1a.stat" size="141" author="dagw" created="Sun, 19 Sep 2010 18:28:09 +0100"/>
                            <attachment id="12455001" name="derby-4551-followup-1b.diff" size="8782" author="dagw" created="Mon, 20 Sep 2010 00:44:01 +0100"/>
                            <attachment id="12455002" name="derby-4551-followup-1b.stat" size="243" author="dagw" created="Mon, 20 Sep 2010 00:44:01 +0100"/>
                            <attachment id="12455050" name="derby4551-trial.diff" size="4442" author="dagw" created="Mon, 20 Sep 2010 17:15:12 +0100"/>
                            <attachment id="12450392" name="reproTH-derby-4551.7z" size="620900" author="thomashill" created="Sat, 24 Jul 2010 10:07:55 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 19 Feb 2010 17:07:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31272</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0flr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36346</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>