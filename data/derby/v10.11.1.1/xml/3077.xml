<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:28:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3077/DERBY-3077.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3077] Trying to reconnect with derby client after bringing server down throws SQL Exception 58009 rather than 08XXX exception</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3077</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This issue was discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-401&quot; title=&quot;Add SQLException subclasses and throw them correctly to match JDBC 4 spec&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-401&quot;&gt;&lt;del&gt;DERBY-401&lt;/del&gt;&lt;/a&gt;, because the case where the server is brought down and an application tries to reconnect does not throw a SQLNonTransientException.  Discussion is still underway about whether 58XXX exceptions should be SQLNonTransientExceptions, but at least for this case changing the exception to 08006 per Knut&apos;s suggestion should correct the problem for this case. See &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-401#action_12527400&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-401#action_12527400&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Below is current stack and test case.&lt;/p&gt;

&lt;p&gt;Apache Derby&lt;br/&gt;
got connection now sleep&lt;br/&gt;
now try to use the connection after you killed the nS&lt;br/&gt;
Exception in thread &quot;main&quot; java.sql.SQLException: A communications error has been detected: Software caused connection abort: recv failed.&lt;br/&gt;
at org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.Connection.prepareStatement(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.LogicalConnection.prepareStatement(Unknown Source)&lt;br/&gt;
at DerbyClientNonXA.main(DerbyClientNonXA.java:48)&lt;br/&gt;
Caused by: org.apache.derby.client.am.DisconnectException: A communications error has been detected: Software caused connection abort: recv failed.&lt;br/&gt;
at org.apache.derby.client.net.NetAgent.throwCommunicationsFailure(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.net.Reply.fill(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.net.Reply.ensureALayerDataInBuffer(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.net.Reply.readDssHeader(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.net.Reply.startSameIdChainParse(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.net.NetStatementReply.readPrepareDescribeOutput(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.net.StatementReply.readPrepareDescribeOutput(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.net.NetStatement.readPrepareDescribeOutput_(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.Statement.readPrepareDescribeOutput(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.PreparedStatement.readPrepareDescribeInputOutput(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.PreparedStatement.flowPrepareDescribeInputOutput(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.PreparedStatement.prepare(Unknown Source)&lt;br/&gt;
at org.apache.derby.client.am.Connection.prepareStatementX(Unknown Source)&lt;br/&gt;
... 3 more&lt;br/&gt;
Caused by: java.net.SocketException: Software caused connection abort: recv failed&lt;br/&gt;
at java.net.SocketInputStream.read(SocketInputStream.java:129)&lt;br/&gt;
... 15 more&lt;/p&gt;


&lt;p&gt;import java.sql.Connection;&lt;br/&gt;
import java.sql.DatabaseMetaData;&lt;br/&gt;
import java.sql.PreparedStatement;&lt;br/&gt;
import java.sql.SQLException;&lt;br/&gt;
import java.sql.Statement;&lt;br/&gt;
import javax.sql.PooledConnection;&lt;/p&gt;

&lt;p&gt;public class DerbyClientNonXA&lt;/p&gt;
{

public static void main(String args[]) throws Exception
{

org.apache.derby.jdbc.ClientConnectionPoolDataSource40 ds = new org.apache.derby.jdbc.ClientConnectionPoolDataSource40();

Connection conn = null;
ds.setDatabaseName(&quot;e:\\temp\\sampl127;create=true&quot;);

PooledConnection pooledCon = ds.getPooledConnection();

conn = pooledCon.getConnection();

DatabaseMetaData md = conn.getMetaData();
System.out.println(md.getDatabaseProductVersion());
System.out.println(md.getDatabaseProductName());
System.out.println(&quot;got connection now sleep. Bring down network server.&quot;);



Statement st = null;
PreparedStatement ps1 = null;
st = conn.createStatement();
try
{


st.executeUpdate(&quot;drop table TAB1&quot;);
}
catch (SQLException x)
{
System.out.println(&quot;no table exists&quot;);
}

Thread.sleep(15000);
System.out.println(&quot;now try to use the connection after you killed the nS&quot;);

ps1 = conn.prepareStatement(&quot;CREATE TABLE TAB1(COL1 INT NOT NULL)&quot;);
ps1.executeUpdate();

conn.commit();

System.out.println(&quot;done&quot;);

}
&lt;p&gt;}&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12378303">DERBY-3077</key>
            <summary>Trying to reconnect with derby client after bringing server down throws SQL Exception 58009 rather than 08XXX exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Sep 2007 17:45:03 +0100</created>
                <updated>Thu, 20 Sep 2007 21:02:10 +0100</updated>
                            <resolved>Thu, 20 Sep 2007 21:02:10 +0100</resolved>
                                    <version>10.2.2.0</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12528122" author="kmarsden" created="Mon, 17 Sep 2007 20:21:42 +0100"  >&lt;p&gt;Looking at the 58009 exceptions. I think the first 6  should be 08006&quot;:&lt;br/&gt;
String DRDA_CONNECTION_TERMINATED                               = &quot;58009.C&quot;;&lt;br/&gt;
    // Use this version of SOCKET_EXCEPTION any time &lt;b&gt;except&lt;/b&gt; when trying to&lt;br/&gt;
    // establish a connection, as the SQLState is different.  When trying&lt;br/&gt;
    // to establish a connection, use CONNECT_SOCKET_EXCEPTION.&lt;br/&gt;
    String SOCKET_EXCEPTION                                         = &quot;58009.C.2&quot;;&lt;br/&gt;
    String COMMUNICATION_ERROR                                      = &quot;58009.C.3&quot;;&lt;br/&gt;
    String CONNECTION_FAILED_ON_DEFERRED_RESET                      = &quot;58009.C.4&quot;;&lt;br/&gt;
    String NET_INSUFFICIENT_DATA                                    = &quot;58009.C.5&quot;;&lt;br/&gt;
    String NET_LOB_DATA_TOO_LARGE_FOR_JVM                           = &quot;58009.C.6&quot;;&lt;/p&gt;


&lt;p&gt;The following would remain 58009 as they are DRDA protocol exceptions:&lt;/p&gt;


&lt;p&gt;    String NET_SQLCDTA_INVALID_FOR_RDBCOLID                         = &quot;58009.C.7&quot;;&lt;br/&gt;
    String NET_SQLCDTA_INVALID_FOR_PKGID                            = &quot;58009.C.8&quot;;&lt;br/&gt;
    String NET_PGNAMCSN_INVALID_AT_SQLAM                            = &quot;58009.C.9&quot;;&lt;br/&gt;
    String NET_VCM_VCS_LENGTHS_INVALID                              = &quot;58009.C.10&quot;;&lt;br/&gt;
    String NET_ENCODING_NOT_SUPPORTED                               = &quot;58009.C.11&quot;;&lt;br/&gt;
    String NET_NOT_EXPECTED_CODEPOINT                               = &quot;58009.C.12&quot;;&lt;br/&gt;
    String NET_DDM_COLLECTION_TOO_SMALL                             = &quot;58009.C.13&quot;;&lt;br/&gt;
    String NET_COLLECTION_STACK_NOT_EMPTY                           = &quot;58009.C.14&quot;;&lt;br/&gt;
    String NET_DSS_NOT_ZERO                                         = &quot;58009.C.15&quot;;&lt;br/&gt;
    String NET_DSS_CHAINED_WITH_SAME_ID                             = &quot;58009.C.16&quot;;&lt;br/&gt;
    String NET_PREMATURE_EOS_DISCONNECT                             = &quot;58009.C.17&quot;;&lt;br/&gt;
    String NET_INVALID_FDOCA_ID                                     = &quot;58009.C.18&quot;;&lt;br/&gt;
    String NET_SECTKN_NOT_RETURNED                                  = &quot;58009.C.19&quot;;&lt;br/&gt;
    String NET_NVCM_NVCS_BOTH_NON_NULL                              = &quot;58009.C.20&quot;;&lt;br/&gt;
    String NET_SQLCDTA_INVALID_FOR_RDBNAM                           = &quot;58009.C.21&quot;;&lt;/p&gt;


&lt;p&gt;Does that sound correct?&lt;/p&gt;</comment>
                            <comment id="12528193" author="kmarsden" created="Tue, 18 Sep 2007 01:03:08 +0100"  >&lt;p&gt;Attached is a patch for this issue.   Per Knut&apos;s suggestion,  it changes expected client side errors such as SocketExceptions and IOExceptions to throw 08006 exceptions instead of 58 class exceptions.&lt;br/&gt;
DRDA_CONNECTION_TERMINATED &lt;br/&gt;
SOCKET_EXCEPTION&lt;br/&gt;
COMMUNICATION_ERROR&lt;br/&gt;
CONNECTION_FAILED_ON_DEFERRED_RESET&lt;br/&gt;
NET_INSUFFICIENT_DATA&lt;br/&gt;
NET_LOB_DATA_TOO_LARGE_FOR_JVM &lt;/p&gt;

&lt;p&gt;This leaves only protocol exceptions in the 58 class.  &lt;/p&gt;

&lt;p&gt;Please review.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12528570" author="knutanders" created="Tue, 18 Sep 2007 22:26:17 +0100"  >&lt;p&gt;Looks good! There was one white-space change in messages.xml, though:&lt;/p&gt;

&lt;p&gt;@@ -2614,7 +2645,7 @@&lt;/p&gt;

&lt;p&gt;             &amp;lt;msg&amp;gt;&lt;br/&gt;
                 &amp;lt;name&amp;gt;58009.C.2&amp;lt;/name&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;text&amp;gt;SocketException: &apos;
{0}&apos;&amp;lt;/text&amp;gt;&lt;br/&gt;
+                &amp;lt;text&amp;gt; SocketException: &apos;{0}
&lt;p&gt;&apos;&amp;lt;/text&amp;gt;&lt;br/&gt;
                 &amp;lt;arg&amp;gt;error&amp;lt;/arg&amp;gt;&lt;br/&gt;
             &amp;lt;/msg&amp;gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Is there any reason why we cannot remove the XX_MOVED_TO_8006 constants? (and their corresponding messages in messages.xml)&lt;/p&gt;

&lt;p&gt;Could the localized messages also be updated? (that would just involve replacing the message ids, no language skills are needed I think)&lt;/p&gt;</comment>
                            <comment id="12528598" author="kmarsden" created="Tue, 18 Sep 2007 23:45:04 +0100"  >&lt;p&gt;Knut said&lt;br/&gt;
&amp;gt;Is there any reason why we cannot remove the XX_MOVED_TO_8006 constants? (and their corresponding messages in messages.xml)&lt;/p&gt;

&lt;p&gt;&amp;gt;Could the localized messages also be updated? (that would just involve replacing the message ids, no language skills are needed I think)&lt;/p&gt;

&lt;p&gt;I left the old messages so there would not be a disconnect with the localized messages (messages would not get reused inappropriately).   If I try to update the localized messages as well, then they can be removed.  I&apos;ll take a look.  I do get a bit nervous though dealing with languages that I don&apos;t understand.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12528599" author="kmarsden" created="Tue, 18 Sep 2007 23:45:43 +0100"  >&lt;p&gt;Reopen to address review comments&lt;/p&gt;</comment>
                            <comment id="12528848" author="kmarsden" created="Wed, 19 Sep 2007 19:21:46 +0100"  >&lt;p&gt;Here is the cleanup patch for this issue.  It removes the old messages and changes the SQLStates in all the translation files.  I ran suites.All, derbyall and manually tested a connection error in each language to make sure it was something I didn&apos;t understand #&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Please review.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12529119" author="knutanders" created="Thu, 20 Sep 2007 15:37:44 +0100"  >&lt;p&gt;Thanks Kathey! The changes look safe to me. +1 to commit.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12366222" name="derby-3077_cleanup_diff.txt" size="61582" author="kmarsden" created="Wed, 19 Sep 2007 19:21:45 +0100"/>
                            <attachment id="12366223" name="derby-3077_cleanup_stat.txt" size="1114" author="kmarsden" created="Wed, 19 Sep 2007 19:21:46 +0100"/>
                            <attachment id="12366053" name="derby-3077_diff.txt" size="42383" author="kmarsden" created="Tue, 18 Sep 2007 01:03:07 +0100"/>
                            <attachment id="12366054" name="derby-3077_stat.txt" size="305" author="kmarsden" created="Tue, 18 Sep 2007 01:03:08 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 18 Sep 2007 21:26:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23414</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy112v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39825</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>