<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:32:04 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3061/DERBY-3061.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3061] Wrong results from query with two conjuncts</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3061</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Tim Dudgeon, on the user list, reports that the following query returns no results in 10.3.1.4 but works correctly in 10.2. I have verified that the query returns no results in the mainline as well. If you eliminate either of the the conjuncts, then the query returns the correct results:&lt;/p&gt;

&lt;p&gt;SELECT MYTABLE.MY_ID&lt;br/&gt;
 FROM MYTABLE&lt;br/&gt;
 WHERE MYTABLE.MY_ID &amp;lt; 100 AND MYTABLE.MY_ID IN (&lt;br/&gt;
2,15,19,20,21,48,49&lt;br/&gt;
)&lt;/p&gt;

&lt;p&gt;Here is a more complete script which demonstrates the problem:&lt;/p&gt;

&lt;p&gt;drop table mytable;&lt;/p&gt;

&lt;p&gt;create table mytable ( id int primary key );&lt;/p&gt;

&lt;p&gt;insert into mytable ( id )&lt;br/&gt;
values&lt;br/&gt;
( 0 ), ( 1 ), ( 2 ), ( 3 ), ( 4 ), ( 5 ), ( 6 ), ( 7 ), ( 8 ), ( 9 );&lt;/p&gt;

&lt;p&gt;insert into mytable select id + 10 from mytable;&lt;br/&gt;
insert into mytable select id + 20 from mytable;&lt;br/&gt;
insert into mytable select id + 40 from mytable;&lt;br/&gt;
insert into mytable select id + 100 from mytable;&lt;/p&gt;

&lt;p&gt;select mytable.id&lt;br/&gt;
from mytable&lt;br/&gt;
where mytable.id &amp;lt; 100;&lt;/p&gt;


&lt;p&gt;select mytable.id&lt;br/&gt;
from mytable&lt;br/&gt;
where mytable.id in ( 2, 15, 19, 20, 21, 48, 49 );&lt;/p&gt;

&lt;p&gt;select mytable.id&lt;br/&gt;
from mytable&lt;br/&gt;
where mytable.id &amp;lt; 100&lt;br/&gt;
and mytable.id in ( 2, 15, 19, 20, 21, 48, 49 );&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12377755">DERBY-3061</key>
            <summary>Wrong results from query with two conjuncts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Sep 2007 14:28:53 +0100</created>
                <updated>Tue, 13 Jul 2010 20:21:50 +0100</updated>
                            <resolved>Wed, 12 Sep 2007 00:43:33 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12525751" author="kmarsden" created="Fri, 7 Sep 2007 16:43:29 +0100"  >&lt;p&gt;Verified that this is a regresssion.  Running against  10.2.2.1.545663  I see:&lt;/p&gt;


&lt;p&gt;ij&amp;gt; select mytable.id&lt;br/&gt;
from mytable&lt;br/&gt;
where mytable.id &amp;lt; 100&lt;br/&gt;
and mytable.id in ( 2, 15, 19, 20, 21, 48, 49 );&lt;br/&gt;
ID&lt;br/&gt;
-----------&lt;br/&gt;
2&lt;br/&gt;
15&lt;br/&gt;
19&lt;br/&gt;
20&lt;br/&gt;
21&lt;br/&gt;
48&lt;br/&gt;
49&lt;/p&gt;

&lt;p&gt;7 rows selected&lt;/p&gt;
</comment>
                            <comment id="12525753" author="kmarsden" created="Fri, 7 Sep 2007 16:45:33 +0100"  >&lt;p&gt;linking to 2034 since it is wrong results&lt;/p&gt;</comment>
                            <comment id="12525754" author="kmarsden" created="Fri, 7 Sep 2007 16:46:37 +0100"  >&lt;p&gt;Marking critical since this is wrong results and a regression&lt;/p&gt;</comment>
                            <comment id="12525757" author="army" created="Fri, 7 Sep 2007 16:57:10 +0100"  >&lt;p&gt;I ran the repro with svn # 541822 ant it fails with an ASSERT failure:&lt;/p&gt;

&lt;p&gt;shared.common.sanity.AssertFailure: ASSERT FAILED All multi-probing result sets are expected to have a single key that is both the start key AND the stop key, but that is not the case.&lt;/p&gt;

&lt;p&gt;    at shared.common.sanity.SanityManager.ASSERT(SanityManager.java(Compiled Code))&lt;br/&gt;
    at impl.sql.execute.MultiProbeTableScanResultSet.&amp;lt;init&amp;gt;(MultiProbeTableScanResultSet.java:158)&lt;br/&gt;
    ...&lt;/p&gt;

&lt;p&gt;But that ASSERT was removed as part of changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2740&quot; title=&quot;LIKE parameter marker combined with index multi-probing leads to ASSERT failure with sane jars, wrong results with insane jars.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2740&quot;&gt;&lt;del&gt;DERBY-2740&lt;/del&gt;&lt;/a&gt;, hence no failure in 10.3.1.4 nor latest runk.  It looks like that fix was intended to allow different start/stop keys to work (hence the assertion was removed), but apparently it does not do the correct thing after all.&lt;/p&gt;</comment>
                            <comment id="12525782" author="kmarsden" created="Fri, 7 Sep 2007 18:12:37 +0100"  >&lt;p&gt;This issue is also related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt; revision 518322 this was the revision at which we moved from correct results to the assertion.&lt;/p&gt;</comment>
                            <comment id="12525805" author="army" created="Fri, 7 Sep 2007 20:12:46 +0100"  >&lt;p&gt;The incorrect results come from the fact that the the &quot;probe predicate&quot;, which is treated as an equality predicate (&quot;MYTABLE.MY_ID = ?&quot;) during compilation, is being chosen as the start key but is &lt;b&gt;not&lt;/b&gt; being chosen as the stop key.  This happens because prior to generating the query plan, we &quot;sort&quot; the useful predicates based on index position.  In the query for this issue both the &quot;probe predicate&quot; and the predicate &quot;MYTABLE.MY_ID &amp;lt; 100&quot; have the same index position--i.e. they are both on the same column.  For the query in question, this causes the less than predicate to come first in the sorted order, which ultimately means &quot;MYTABLE.MY_ID &amp;lt; 100&quot; becomes the stop key instead of the probe predicate.&lt;/p&gt;

&lt;p&gt;But if we look at the &quot;compareTo()&quot; method on Predicate.java, which is used for the sort, we see the following comment:&lt;/p&gt;

&lt;p&gt;       /* Not all operators are &quot;equal&quot;. If the predicates are on the&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;same key column, then a &quot;=&quot; opertor takes precedence over all&lt;/li&gt;
	&lt;li&gt;other operators.  This ensures that the &quot;=&quot; will be both the start&lt;/li&gt;
	&lt;li&gt;and stop predicates.  Otherwise, we could end up with it being one&lt;/li&gt;
	&lt;li&gt;but not the other and get incorrect results.&lt;br/&gt;
        */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case the probe predicate is an &quot;equal&quot; (MYTABLE.MY_ID = ?) and thus should have precedence over the less-than predicate.  That in turn would guarantee that the probe predicate is the start key &lt;b&gt;AND&lt;/b&gt; the stop key, which would satisfy the execution-time requirements and fix the query results.&lt;/p&gt;

&lt;p&gt;So the problem looks to be related to (directly or indirectly) the &quot;compareTo()&quot; method of Predicate.java.  That method should be giving the probe predicate the same precedence as a normal equality predicate, and it should therefore always put the probe predicate first in the sorted list.  If that happens, the probe predicate will correctly become the start key &lt;em&gt;and&lt;/em&gt; stop key, as needed.&lt;/p&gt;

&lt;p&gt;More investigation is required to see what might be going wrong with the predicate comparison...&lt;/p&gt;</comment>
                            <comment id="12525943" author="army" created="Sat, 8 Sep 2007 20:26:03 +0100"  >&lt;p&gt;Attaching a patch for this issue.  The change here is pretty small: just add logic to the &quot;if&quot; statement to assign the correct &quot;precedence&quot; to an IN-list probe predicate when sorting predicates for code generation.  This ensures that the probe predicate will be chosen as the start key &lt;em&gt;and&lt;/em&gt; as the stop key, which gives us correct results.  I also added the repro script attached to this issue to the existing InListMultiProbeTest (thanks for creating the script, Rick).&lt;/p&gt;

&lt;p&gt;I ran derbyall and suites.All with ibm142 on Red Hat Linux.  There were two failures in derbyall with server tests, but they look unrelated to these changes.   suites.All ran cleanly.&lt;/p&gt;

&lt;p&gt;Review comments are always appreciated; if I hear no feedback to the contrary, I&apos;ll commit this early next week (probably Tuesday).&lt;/p&gt;</comment>
                            <comment id="12525970" author="bryanpendleton" created="Sun, 9 Sep 2007 03:15:49 +0100"  >&lt;p&gt;Hi Army, the patch looks good to me. Your explanation makes sense, and is persuasive. The code change seems fine to me. Thanks for adding the comment to the code, as this is a tricky subject, and the comment helps considerably here. I applied the patch and tested, and the new test fails as expected without your code change, and passes as expected with your code change. Thanks for picking up this issue! +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12526511" author="army" created="Tue, 11 Sep 2007 17:17:05 +0100"  >&lt;p&gt;Just before committing the d3061_v1.patch I realized that we need to add the appropriate &quot;isInListProbePredicate()&quot; check to the &lt;b&gt;other&lt;/b&gt; &quot;if&quot; branch in Predicate.compareTo(), as well.  Otherwise the probe predicate might still be incorrectly sorted.&lt;/p&gt;

&lt;p&gt;So I&apos;m attaching d3061_v2.patch which adds the appropriate check, and also adds a few more test cases to InListMultiProbeTest (one of which shows the need for the second isInListProbePredicate() check mentioned above).&lt;/p&gt;

&lt;p&gt;I then committed the _v2 patch with svn # 574635:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=574635&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=574635&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll look into porting this back to 10.3 once I can do the merge and run the regression tests on that branch.&lt;/p&gt;

&lt;p&gt;Many thanks to Bryan for feedback and review.  I&apos;m always grateful for an extra pair of eyes!&lt;/p&gt;</comment>
                            <comment id="12526641" author="army" created="Wed, 12 Sep 2007 00:43:33 +0100"  >&lt;p&gt;The merge to 10.3 was clean and the regression tests ran without error (derbyall and suites.All) on Red Hat Linux:&lt;/p&gt;

&lt;p&gt;  svn merge -r 574634:574635 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So I committed d3061_v2.patch to the 10.3 branch with svn # 574730:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=574730&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=574730&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m marking the issue as RESOLVED but will leave it up to Tim Dudgeon and/or Rick Hillegas to verify and either close or re-open as appropriate.&lt;/p&gt;</comment>
                            <comment id="12527172" author="tdudgeon" created="Thu, 13 Sep 2007 17:55:24 +0100"  >&lt;p&gt;Any ideas when this fix will be available in a Derby 10.3.x release?&lt;br/&gt;
I need to rollback to the 10.2 releases unless a new 10.3.x release is coming soon.&lt;/p&gt;</comment>
                            <comment id="12539800" author="rhillegas" created="Sat, 3 Nov 2007 05:42:06 +0000"  >&lt;p&gt;Hi Tim,&lt;/p&gt;

&lt;p&gt;I would recommend posting your question to derby-dev. Real user interest &lt;br/&gt;
in a bug-fix release may prompt someone to volunteer to produce it. In &lt;br/&gt;
the past, bug-fix releases have turned up fairly soon after the IBM team &lt;br/&gt;
localizes new error messages introduced by the feature release. It takes &lt;br/&gt;
IBM about 2 months to do that work.&lt;/p&gt;

&lt;p&gt;Hope this helps,&lt;br/&gt;
-Rick&lt;/p&gt;

</comment>
                            <comment id="12539801" author="rhillegas" created="Sat, 3 Nov 2007 05:42:06 +0000"  >&lt;p&gt;Hi Tim,&lt;/p&gt;

&lt;p&gt;I see that you posted your question to derby-dev already. Please ignore &lt;br/&gt;
my previous post.&lt;/p&gt;

&lt;p&gt;Regars,&lt;br/&gt;
-Rick&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12442047">DERBY-4456</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12442702">DERBY-4464</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12354628">DERBY-2034</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12370654">DERBY-2740</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="27899">DERBY-47</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12365408" name="d3061_v1.patch" size="4016" author="army" created="Sat, 8 Sep 2007 20:26:02 +0100"/>
                            <attachment id="12365409" name="d3061_v1.stat" size="165" author="army" created="Sat, 8 Sep 2007 20:26:03 +0100"/>
                            <attachment id="12365574" name="d3061_v2.patch" size="5924" author="army" created="Tue, 11 Sep 2007 17:17:05 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 7 Sep 2007 15:43:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23406</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0pg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37941</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>