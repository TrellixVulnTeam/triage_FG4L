<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:42:44 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4584/DERBY-4584.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4584] Unable to connect to network server if client thread name has Japanese characters</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4584</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I am opening this bug, which is probably a duplicate of bug#728 so that other&apos;s may find it and save the hours I spent chasing it down.  Feel free to mark this as a duplicate.  However, while related, it may not be a true duplicate of 728.&lt;/p&gt;

&lt;p&gt;The exception is similar to 728:&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; org.apache.derby.client.am.SqlException: Unicode string can&apos;t convert to Ebcdic string&lt;/p&gt;

&lt;p&gt;(Here is the version of the exception I received &amp;#8211; excuse the Japanese characters):&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.derby.client.am.SqlException: Unicode &#12473;&#12488;&#12522;&#12531;&#12464;&#12434; EBCDIC &#12473;&#12488;&#12522;&#12531;&#12464;&#12395;&#22793;&#25563;&#12377;&#12427;&#12371;&#12392;&#12399;&#12391;&#12365;&#12414;&#12379;&#12435;&#12290;&lt;br/&gt;
	at org.apache.derby.client.net.EbcdicCcsidManager.convertFromUCS2(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.Request.writeScalarString(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.Request.writeScalarString(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnectionRequest.buildEXTNAM(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnectionRequest.buildEXCSAT(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnectionRequest.writeExchangeServerAttributes(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnection.writeServerAttributesAndKeyExchange(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnection.flowServerAttributesAndKeyExchange(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnection.flowUSRIDPWDconnect(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnection.flowConnect(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnection.initialize(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnection.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetConnection40.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.ClientJDBCObjectFactoryImpl40.newNetConnection(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetXAConnection.createNetConnection(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetXAConnection.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.ClientPooledConnection.getNetXAConnection(Unknown Source)&lt;br/&gt;
	... 45 more&lt;/p&gt;

&lt;p&gt;However, the difference is that the database name (and connection URL) does NOT contain unicode characters.  In this case, the &lt;b&gt;thread name&lt;/b&gt; contains Japanese characters.  If the thread performing java.sql.DriverManager.getConnection() has characters that cannot be translated into EBCDIC the above exception is the result.  If the thread name is changed to contain only standard ASCII characters, the connection to the DB is successful.  Note again, in my case, the connection URL is a standard connection URL with no i18n characters, something similar to:&lt;/p&gt;

&lt;p&gt;jdbc:derby://localhost/database&lt;/p&gt;

&lt;p&gt;It is only the thread-name that contains i18n characters.  I don&apos;t know why the client feels it necessary to marshall the client-thread name, but that seems to be the problem.  The fix for this issue is likely easier than 728 if the requirement that the client marshall the thread name can be removed (it seems senseless).&lt;/p&gt;

&lt;p&gt;Finally, just for the record, a typical thread name that tickles this bug is:&lt;/p&gt;

&lt;p&gt;&quot;Running-2 (MOTD&#12496;&#12490;&#12540;&#12398;&#35373;&#23450; for 10.0.0.90@Default)&quot;&lt;/p&gt;

&lt;p&gt;If the Japanese is removed from the thread names, there is no problem.&lt;/p&gt;

&lt;p&gt;The workaround in our case was to change the thread names in our code to not contain Japanese characters.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12459231">DERBY-4584</key>
            <summary>Unable to connect to network server if client thread name has Japanese characters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="espinha">Tiago R. Espinha</assignee>
                                    <reporter username="brettw">Brett Wooldridge</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Mar 2010 06:42:19 +0000</created>
                <updated>Tue, 5 Oct 2010 10:47:59 +0100</updated>
                            <resolved>Wed, 21 Jul 2010 18:59:06 +0100</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.3.3.0</version>
                    <version>10.4.1.3</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                    <version>10.5.2.0</version>
                    <version>10.5.3.0</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12846032" author="kmarsden" created="Tue, 16 Mar 2010 17:52:39 +0000"  >&lt;p&gt;Thanks for filing this issue.&lt;br/&gt;
Maybe we use the thread name in something we send in the protocol, but I am not sure why we would. I am also not sure if it would be fixed with the proposed changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-728&quot; title=&quot;Unable to create databases whose name containg Chinese characters through the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-728&quot;&gt;&lt;del&gt;DERBY-728&lt;/del&gt;&lt;/a&gt; or if this will need a separate fix.   Linking to that issue so we make sure it is considered with that change.&lt;/p&gt;</comment>
                            <comment id="12846740" author="dagw" created="Thu, 18 Mar 2010 04:52:49 +0000"  >&lt;p&gt;This code in org.apache.derby.client.net.NetConnection&lt;br/&gt;
is the source of this, presumably:&lt;/p&gt;

&lt;p&gt;    private void constructExtnam() throws SqlException &lt;/p&gt;
{
        extnam_ = &quot;derbydnc&quot; + java.lang.Thread.currentThread().getName();
    }

&lt;p&gt;This is a quantity of the DRDA protocol: (quote)&lt;br/&gt;
DRDA, Version 3, Volume 1, section 4.4.1 Accessing a Remote Relational Database Manager&lt;/p&gt;

&lt;p&gt;&quot;The extnam is the name of a job, task, or process that the application requester services.&lt;br/&gt;
It is used for diagnostic/logging purposes. In this example, it is the name of the job that&lt;br/&gt;
contains the execution of the application that is invoking application requester&lt;br/&gt;
functions on the OS/400 system.&lt;br/&gt;
Note: This parameter is required and must contain the name of the application requester&apos;s&lt;br/&gt;
execution thread in its operating environment. It must be a name that an observer of&lt;br/&gt;
the operating environment can easily associate with its execution.&quot;&lt;/p&gt;

&lt;p&gt;I think there is a new version of DRDA coming that would allow Unicode in such strings; and if/when we move to that, it might solve this issue. A more immediate way to this is to algoritmically modify a non-EBCDIC thread name into something EBCDIC...&lt;/p&gt;</comment>
                            <comment id="12849336" author="kmarsden" created="Wed, 24 Mar 2010 18:27:58 +0000"  >&lt;p&gt;As I recall EXTNAM is part of the EXTSAT command which will still be in EBCDIC, even with the new ACR &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12405588/ACR7007.pdf&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12405588/ACR7007.pdf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So, I think maybe mapping multibyte characters to question  marks or some such will be how we will need to handle this.&lt;/p&gt;
</comment>
                            <comment id="12850733" author="espinha" created="Sun, 28 Mar 2010 22:09:05 +0100"  >&lt;p&gt;This patch uses Kathey&apos;s suggestion for the thread name.&lt;/p&gt;

&lt;p&gt;The problem now remains as to how will we test this patch. Is there any way to get our thread names to show in Japanese?&lt;/p&gt;</comment>
                            <comment id="12850812" author="knutanders" created="Mon, 29 Mar 2010 08:41:09 +0100"  >&lt;p&gt;Hi Tiago,&lt;/p&gt;

&lt;p&gt;Thanks for the patch. I think there are some problems with this approach:&lt;/p&gt;

&lt;p&gt;1) The javadoc for java.lang.String#getBytes(java.lang.String) says that the behaviour is unspecified if the string cannot be encoded in the given charset. So we cannot rely on that method to replace non-ascii characters with question marks.&lt;/p&gt;

&lt;p&gt;2) The String constructor should also take the charset name as an argument so that the code works regardless of what the system default encoding is.&lt;/p&gt;

&lt;p&gt;3) We should avoid printing exceptions on the console. I think it would be better instead to do a &quot;throw SqlException.javaException(agent_.logWriter, e)&quot;.&lt;/p&gt;

&lt;p&gt;4) EBCDIC supports more characters than US-ASCII does, so this approach will also replace some valid EBCDIC characters with question marks.&lt;/p&gt;

&lt;p&gt;I noticed that EbcdicCcsidManager.convertFromUCS2() has commented out code to generate a question mark instead of raising an exception for multi-byte characters. Would it be possible to add a flag to re-enable that code and call the method with that flag when converting extnam_ to EBCDIC in NetConnection.constructPrddta()?&lt;/p&gt;</comment>
                            <comment id="12850833" author="knutanders" created="Mon, 29 Mar 2010 09:37:04 +0100"  >&lt;p&gt;As for testing, could we set the name of the JUnit execution thread with Thread.currentThread().setName(&quot;&amp;lt;string with Japanese characters&amp;gt;&quot;) in setUp() and reset it in tearDown()?&lt;/p&gt;</comment>
                            <comment id="12850860" author="espinha" created="Mon, 29 Mar 2010 10:44:05 +0100"  >&lt;p&gt;Hello Knut,&lt;/p&gt;

&lt;p&gt;Thank you for your comments; I overlooked the fact that the behavior is unspecified but indeed, then we cannot use it. All things considered we might just use the method you suggested instead.&lt;/p&gt;

&lt;p&gt;Maybe I can create an overload of convertFromUCS2() with an encodeExtraCharacters flag where I implement your suggestion, and then the existing method invokes that one with this flag set to false. This way we maintain the existing behavior for compatibility and we have a way to encode UCS2 strings in EBCDIC whenever the content of the extra characters isn&apos;t important.&lt;/p&gt;

&lt;p&gt;You suggested though that we do this on the constructPrddta method, but is it wise to simply convert the EXTNAM on the fly rather than converting it in a definite manner when it is constructed? (constructExtnam())&lt;/p&gt;

&lt;p&gt;If we simply convert it on the fly, then we must always be careful whenever we use the extnam_ as it will still contain UCS2 characters.&lt;/p&gt;

&lt;p&gt;I&apos;ll also look into setting the name of threads like you mentioned; if this is possible, I&apos;ll also add a fixture to test this behavior.&lt;/p&gt;</comment>
                            <comment id="12850882" author="knutanders" created="Mon, 29 Mar 2010 11:50:52 +0100"  >&lt;p&gt;Looks like you&apos;re right, extnam_ is used and converted to EBCDIC more places than constructPrddta(), so it&apos;s probably best to do this in constructExtnam(). As far as I understand, we are able to convert all characters whose Unicode codepoint is less than 256 to EBCDIC, so perhaps something like this would do?&lt;/p&gt;

&lt;p&gt;char[] chars = threadName.toCharArray();&lt;br/&gt;
for (int i = 0; i &amp;lt; chars.length; i++) &lt;/p&gt;
{
  if (chars[i] &amp;gt; 0xff) chars[i] = &apos;?&apos;;
}
&lt;p&gt;threadName = new String(chars);&lt;/p&gt;</comment>
                            <comment id="12850913" author="espinha" created="Mon, 29 Mar 2010 15:02:54 +0100"  >&lt;p&gt;That does the trick Knut.&lt;/p&gt;

&lt;p&gt;I&apos;m submitting two files now:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4584&quot; title=&quot;Unable to connect to network server if client thread name has Japanese characters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4584&quot;&gt;&lt;del&gt;DERBY-4584&lt;/del&gt;&lt;/a&gt;-test.diff&lt;br/&gt;
This adds a fixture to DRDAProtocolTest that makes the exception pop. For this test I&apos;m using the Chinese character in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-728&quot; title=&quot;Unable to create databases whose name containg Chinese characters through the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-728&quot;&gt;&lt;del&gt;DERBY-728&lt;/del&gt;&lt;/a&gt; but it is equally good as a Japanese test for this purpose.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4584&quot; title=&quot;Unable to connect to network server if client thread name has Japanese characters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4584&quot;&gt;&lt;del&gt;DERBY-4584&lt;/del&gt;&lt;/a&gt;-fix.diff&lt;br/&gt;
This implements the fix as suggested and the fixture mentioned above no longer fails.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12851006" author="knutanders" created="Mon, 29 Mar 2010 18:09:09 +0100"  >&lt;p&gt;Thanks, the fix looks fine to me, but I think we need to add comments to the code both in NetConnection and in the test, as the purpose of this code is not obvious just by looking at it. Also, I think the connection returned by BaseJDBCTestCase.openConnection(String) is not closed automatically by the test harness, so it needs to be closed manually in the test case. DRDAProtocolTest.tearDown() also needs to call super.tearDown().&lt;/p&gt;</comment>
                            <comment id="12851133" author="espinha" created="Mon, 29 Mar 2010 23:21:21 +0100"  >&lt;p&gt;Thank you for your comments Knut. I&apos;m uploading two new patches and I&apos;ll be running suites.All now.&lt;/p&gt;</comment>
                            <comment id="12851341" author="espinha" created="Tue, 30 Mar 2010 11:10:49 +0100"  >&lt;p&gt;suites.All ran without problems (just the &quot;normal&quot; replication test failure since I&apos;m using a Windows box)&lt;/p&gt;

&lt;p&gt;Next, I&apos;ll be running derbyall.&lt;/p&gt;</comment>
                            <comment id="12851361" author="knutanders" created="Tue, 30 Mar 2010 12:24:01 +0100"  >&lt;p&gt;Thanks, Tiago, for the new patch. It looks fine, and all the regression tests ran cleanly. Committed revision 929085.&lt;/p&gt;</comment>
                            <comment id="12852109" author="espinha" created="Wed, 31 Mar 2010 22:15:23 +0100"  >&lt;p&gt;Knut,&lt;/p&gt;

&lt;p&gt;I was looking at today&apos;s regression testing and this came up:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.4/testing/testlog/lin/929180-suitesAll_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.4/testing/testlog/lin/929180-suitesAll_diff.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It only seems to happen in JVM 1.4 though... do you think this is related to my change?&lt;/p&gt;</comment>
                            <comment id="12852123" author="knutanders" created="Wed, 31 Mar 2010 22:39:55 +0100"  >&lt;p&gt;Looks like it only happened on one of the machines, so let&apos;s wait and see if it happens again or if it&apos;s just a glitch. It sounds unlikely that the changes made here should be preventing the network server from starting up.&lt;/p&gt;</comment>
                            <comment id="12852137" author="espinha" created="Wed, 31 Mar 2010 23:13:26 +0100"  >&lt;p&gt;I was more concerned about this:&lt;/p&gt;

&lt;p&gt;java.lang.Exception: DRDA_InvalidReplyHeader2.S:Invalid reply header from network server: Invalid string ?. Plaintext connection attempt to an SSL enabled server?&lt;/p&gt;

&lt;p&gt;It&apos;s complaining about an invalid string composed of a question mark... but we&apos;ll wait to see tomorrow&apos;s regressions.&lt;/p&gt;</comment>
                            <comment id="12854917" author="espinha" created="Thu, 8 Apr 2010 13:35:49 +0100"  >&lt;p&gt;Regressions look fine, so I&apos;m closing the issue.&lt;/p&gt;</comment>
                            <comment id="12887450" author="mikem" created="Mon, 12 Jul 2010 19:17:33 +0100"  >&lt;p&gt;i am looking at backporting this issue to 10.5.&lt;/p&gt;</comment>
                            <comment id="12890796" author="mikem" created="Wed, 21 Jul 2010 18:59:06 +0100"  >&lt;p&gt;backported fix to 10.5, resolving as fixed and resetting original owner.&lt;/p&gt;</comment>
                            <comment id="12917923" author="espinha" created="Tue, 5 Oct 2010 10:47:58 +0100"  >&lt;p&gt;Closing this issue. Since this issue is related to Japanese characters on the EXCSAT command (which must be negotiated in EBCDIC), there&apos;s nothing &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-728&quot; title=&quot;Unable to create databases whose name containg Chinese characters through the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-728&quot;&gt;&lt;del&gt;DERBY-728&lt;/del&gt;&lt;/a&gt; can do here other than convert the characters into question marks like it has been done.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12326016">DERBY-728</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12468384">DERBY-4728</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12440125" name="DERBY-4584-fix.diff" size="906" author="espinha" created="Mon, 29 Mar 2010 23:21:21 +0100"/>
                            <attachment id="12440064" name="DERBY-4584-fix.diff" size="773" author="espinha" created="Mon, 29 Mar 2010 15:02:54 +0100"/>
                            <attachment id="12440126" name="DERBY-4584-test.diff" size="1455" author="espinha" created="Mon, 29 Mar 2010 23:21:21 +0100"/>
                            <attachment id="12440063" name="DERBY-4584-test.diff" size="1018" author="espinha" created="Mon, 29 Mar 2010 15:02:54 +0100"/>
                            <attachment id="12440019" name="DERBY-4584.diff" size="1047" author="espinha" created="Sun, 28 Mar 2010 22:09:05 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 16 Mar 2010 17:52:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24352</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0p8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37908</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>