<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1585/DERBY-1585.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1585] derbylang/procedureInTrigger: not able to create trigger due to an open ResultSet</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1585</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;
			&lt;ul&gt;
				&lt;li&gt;
				&lt;ul&gt;
					&lt;li&gt;
					&lt;ul&gt;
						&lt;li&gt;
						&lt;ul&gt;
							&lt;li&gt;
							&lt;ul&gt;
								&lt;li&gt;
								&lt;ul&gt;
									&lt;li&gt;Diff file derbyall/derbylang/procedureInTrigger.diff&lt;/li&gt;
								&lt;/ul&gt;
								&lt;/li&gt;
							&lt;/ul&gt;
							&lt;/li&gt;
						&lt;/ul&gt;
						&lt;/li&gt;
					&lt;/ul&gt;
					&lt;/li&gt;
				&lt;/ul&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;Start: procedureInTrigger jdk1.6.0-rc derbyall:derbylang 2006-07-19 13:52:20 ***&lt;br/&gt;
714a715,730&lt;br/&gt;
&amp;gt; ERROR X0X95: Operation &apos;CREATE TRIGGER&apos; cannot be performed on object &apos;T1&apos; because there is an open ResultSet dependent on that object.&lt;br/&gt;
&amp;gt; ij&amp;gt; &amp;#8212; delete a row. check that trigger is fired - procedure should be called once&lt;br/&gt;
&amp;gt; delete from t1 where i=10;&lt;br/&gt;
&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
&amp;gt; ij&amp;gt; &amp;#8212; check delete is successful&lt;br/&gt;
&amp;gt; select * from t1;&lt;br/&gt;
&amp;gt; I          |B              &lt;br/&gt;
&amp;gt; ---------------------------&lt;br/&gt;
&amp;gt; 5          |two            &lt;br/&gt;
&amp;gt; 6          |four           &lt;br/&gt;
&amp;gt; 8          |eight          &lt;br/&gt;
&amp;gt; ij&amp;gt; drop trigger select_from_trig_table;&lt;br/&gt;
&amp;gt; ERROR 42X94: TRIGGER &apos;SELECT_FROM_TRIG_TABLE&apos; does not exist.&lt;br/&gt;
&amp;gt; ij&amp;gt; &amp;#8212; use procedures which alter/drop trigger table and some other table&lt;br/&gt;
&amp;gt; create trigger alter_table_trig AFTER delete on t1 &lt;br/&gt;
&amp;gt; 	for each STATEMENT mode db2sql call alter_table_proc();&lt;br/&gt;
716,732d731&lt;br/&gt;
&amp;lt; ij&amp;gt; &amp;#8212; delete a row. check that trigger is fired - procedure should be called once&lt;br/&gt;
&amp;lt; delete from t1 where i=10;&lt;br/&gt;
&amp;lt; selectRows - 1 arg - 1 rs&lt;br/&gt;
&amp;lt; 1 row inserted/updated/deleted&lt;br/&gt;
&amp;lt; ij&amp;gt; &amp;#8212; check delete is successful&lt;br/&gt;
&amp;lt; select * from t1;&lt;br/&gt;
&amp;lt; I          |B              &lt;br/&gt;
&amp;lt; ---------------------------&lt;br/&gt;
&amp;lt; 5          |two            &lt;br/&gt;
&amp;lt; 6          |four           &lt;br/&gt;
&amp;lt; 8          |eight          &lt;br/&gt;
&amp;lt; ij&amp;gt; drop trigger select_from_trig_table;&lt;br/&gt;
&amp;lt; 0 rows inserted/updated/deleted&lt;br/&gt;
&amp;lt; ij&amp;gt; &amp;#8212; use procedures which alter/drop trigger table and some other table&lt;br/&gt;
&amp;lt; create trigger alter_table_trig AFTER delete on t1 &lt;br/&gt;
&amp;lt; 	for each STATEMENT mode db2sql call alter_table_proc();&lt;br/&gt;
&amp;lt; 0 rows inserted/updated/deleted&lt;br/&gt;
Test Failed.&lt;/li&gt;
			&lt;li&gt;End:   procedureInTrigger jdk1.6.0-rc derbyall:derbylang 2006-07-19 13:52:34 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.6.0-rc&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
Java home:       /usr/local/java/jdk1.6.0_b91/jre&lt;br/&gt;
Java classpath:  &lt;br/&gt;
test/junit.jar:test/dbprocedures.jar:test/jmxremote.jar:test/javadbtests.jar: test/Dots.jar:test/mail.jar:test/activation.jar:test/Perfmon.jar: test/jakarta-oro-2.0.8.jar:test/commons-logging.jar:test/jagops.jar: test/jdmkrt.jar:test/db2jcc_license_c.jar:test/jet.jar:test/jetbatch.jar: test/db2jcc.jar:test/jag.jar:test/jagclient.jar:test/jagutils.jar:test/GenCfg.jar: test/jmxremote_optional.jar:test/jmx.jar:test/hadbjdbc4.jar:derbyTesting.jar: derby.jar:derbyLocale_zh_TW.jar:derbytools.jar:derbyLocale_ko_KR.jar: derbyLocale_zh_CN.jar:derbyLocale_es.jar:derbyLocale_de_DE.jar:derbyLocale_ja_JP.jar: derbynet.jar:derbyLocale_pt_BR.jar:derbyclient.jar:derbyLocale_fr.jar:derbyrun.jar: derbyLocale_it.jar:&lt;br/&gt;
&lt;br/&gt;
OS name:         Linux&lt;br/&gt;
OS architecture: i386&lt;br/&gt;
OS version:      2.6.9-34.ELsmp&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.6&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: Java SE 6 - JDBC 4.0&lt;br/&gt;
[/export/home/tmp/jagtmp/autoderbyN_regression/install/lib/derby.jar] 10.2.0.4 alpha - (423199)&lt;br/&gt;
[/export/home/tmp/jagtmp/autoderbyN_regression/install/lib/derbytools.jar] 10.2.0.4 alpha - (423199)&lt;br/&gt;
[/export/home/tmp/jagtmp/autoderbyN_regression/install/lib/derbynet.jar] 10.2.0.4 alpha - (423199)&lt;br/&gt;
[/export/home/tmp/jagtmp/autoderbyN_regression/install/lib/derbyclient.jar] 10.2.0.4 alpha - (423199)&lt;br/&gt;
[/export/home/tmp/jagtmp/autoderbyN_regression/install/lib/test/db2jcc_license_c.jar] 2.4 - (17)&lt;br/&gt;
[/export/home/tmp/jagtmp/autoderbyN_regression/install/lib/test/db2jcc.jar] 2.4 - (17)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Locale Information -----------------&lt;br/&gt;
Current Locale :  [English/United States [en_US]]&lt;br/&gt;
Found support for locale: [de_DE]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [es]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [fr]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [it]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [ja_JP]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [ko_KR]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [pt_BR]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [zh_CN]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
Found support for locale: [zh_TW]&lt;br/&gt;
	 version: 10.2.0.4 alpha - (423199)&lt;br/&gt;
------------------------------------------------------</environment>
        <key id="12346613">DERBY-1585</key>
            <summary>derbylang/procedureInTrigger: not able to create trigger due to an open ResultSet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djd">Daniel John Debrunner</assignee>
                                    <reporter username="scheur">Henri van de Scheur</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jul 2006 09:54:51 +0100</created>
                <updated>Fri, 25 Jan 2008 14:39:02 +0000</updated>
                            <resolved>Fri, 11 Jan 2008 20:01:53 +0000</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12423768" author="kmarsden" created="Thu, 27 Jul 2006 05:49:48 +0100"  >&lt;p&gt;I will put this in component test for now.  I am not sure ultimately if it should be test or sql&lt;/p&gt;</comment>
                            <comment id="12424148" author="myrna" created="Fri, 28 Jul 2006 19:48:30 +0100"  >&lt;p&gt;I see a similar diff with wctme5.7/j9 2.2:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Start: procedureInTrigger jdk1.3.1 subset - 2.2 2006-07-28 11:45:34 ***&lt;br/&gt;
700a701,716&lt;br/&gt;
&amp;gt; ERROR X0X95: Operation &apos;CREATE TRIGGER&apos; cannot be performed on object &apos;T1&apos; because there is an open ResultSet dependent on that object.&lt;br/&gt;
&amp;gt; ij&amp;gt; &amp;#8212; delete a row. check that trigger is fired - procedure should be called once&lt;br/&gt;
&amp;gt; delete from t1 where i=10;&lt;br/&gt;
&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
&amp;gt; ij&amp;gt; &amp;#8212; check delete is successful&lt;br/&gt;
&amp;gt; select * from t1;&lt;br/&gt;
&amp;gt; I          |B              &lt;br/&gt;
&amp;gt; ---------------------------&lt;br/&gt;
&amp;gt; 5          |two            &lt;br/&gt;
&amp;gt; 6          |four           &lt;br/&gt;
&amp;gt; 8          |eight          &lt;br/&gt;
&amp;gt; ij&amp;gt; drop trigger select_from_trig_table;&lt;br/&gt;
&amp;gt; ERROR 42X94: TRIGGER &apos;SELECT_FROM_TRIG_TABLE&apos; does not exist.&lt;br/&gt;
&amp;gt; ij&amp;gt; &amp;#8212; use procedures which alter/drop trigger table and some other table&lt;br/&gt;
&amp;gt; create trigger alter_table_trig AFTER delete on t1 &lt;br/&gt;
&amp;gt; 	for each STATEMENT mode db2sql call alter_table_proc();&lt;br/&gt;
702,718d717&lt;br/&gt;
&amp;lt; ij&amp;gt; &amp;#8212; delete a row. check that trigger is fired - procedure should be called once&lt;br/&gt;
&amp;lt; delete from t1 where i=10;&lt;br/&gt;
&amp;lt; selectRows - 1 arg - 1 rs&lt;br/&gt;
&amp;lt; 1 row inserted/updated/deleted&lt;br/&gt;
&amp;lt; ij&amp;gt; &amp;#8212; check delete is successful&lt;br/&gt;
&amp;lt; select * from t1;&lt;br/&gt;
&amp;lt; I          |B              &lt;br/&gt;
&amp;lt; ---------------------------&lt;br/&gt;
&amp;lt; 5          |two            &lt;br/&gt;
&amp;lt; 6          |four           &lt;br/&gt;
&amp;lt; 8          |eight          &lt;br/&gt;
&amp;lt; ij&amp;gt; drop trigger select_from_trig_table;&lt;br/&gt;
&amp;lt; 0 rows inserted/updated/deleted&lt;br/&gt;
&amp;lt; ij&amp;gt; &amp;#8212; use procedures which alter/drop trigger table and some other table&lt;br/&gt;
&amp;lt; create trigger alter_table_trig AFTER delete on t1 &lt;br/&gt;
&amp;lt; 	for each STATEMENT mode db2sql call alter_table_proc();&lt;br/&gt;
&amp;lt; 0 rows inserted/updated/deleted&lt;br/&gt;
Test Failed.&lt;/li&gt;
			&lt;li&gt;End:   procedureInTrigger jdk1.3.1 subset - 2.2 2006-07-28 11:46:08 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In other words, wctme5.7 barks earlier than jdk16.&lt;/p&gt;</comment>
                            <comment id="12433522" author="deepa" created="Fri, 8 Sep 2006 23:52:56 +0100"  >&lt;p&gt;Attaching a patch &apos;derby1585_v1.diff&apos; to resolve the intermittent failure seen in the test lang/procedureInTrigger.sql.&lt;/p&gt;

&lt;p&gt;The intermittent failure was happening when a result set returned by a procedure called from a trigger remains open. Then when we create another trigger on the same table, we get following exception:&lt;br/&gt;
ERROR X0X95: Operation &apos;CREATE TRIGGER&apos; cannot be performed on object &apos;T1&apos; because there is an open ResultSet dependent on that object.&lt;/p&gt;

&lt;p&gt;The purpose of the test is only to test after/before triggers that call a procedure which executes a select statement. As we are calling the procedure from a trigger, there is no need to use a procedure that returns a result set. The result set cannot be accessed from the trigger. So I changed this test to call a new procedure which executes a select, uses the result set and closes it. I believe this will solve the intermittent failure.  &lt;/p&gt;

&lt;p&gt;This patch modifies only tests. I ran the changed test multiple times on jdk142, jdk15, and j9_22 vm successfully. I modified the master file for jdk16 but have some trouble with jdk16 environment on my machine. So I haven&apos;t run the test on jdk16.&lt;/p&gt;

&lt;p&gt;Please take a look at this patch and commit if okay.&lt;/p&gt;</comment>
                            <comment id="12433524" author="djd" created="Sat, 9 Sep 2006 00:05:43 +0100"  >&lt;p&gt;Does this mean that there is a bug?&lt;br/&gt;
Either:&lt;/p&gt;

&lt;p&gt;When a procedure is called from a trigger any ResultSet&apos;s returned are not explictly closed by the trigger calling mechanism?&lt;/p&gt;

&lt;p&gt;or&lt;/p&gt;

&lt;p&gt;procedures that return result sers should not be allowed in triggers.&lt;/p&gt;

&lt;p&gt;Might need to look at the standard to see what is expected here. For the first case the question would be should the&lt;br/&gt;
returned dynamic result sets simply be closed, or should each row be fetched and then closed. The fetching of rows&lt;br/&gt;
could have functions that produce side effects the application is expecting to occur.&lt;/p&gt;</comment>
                            <comment id="12434571" author="deepa" created="Thu, 14 Sep 2006 01:04:09 +0100"  >&lt;p&gt;Pasting the link to my previous comment to derby-dev for reference.&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/Re%3A--jira--Commented%3A-%28DERBY-1585%29-derbylang-procedureInTrigger%3A-not-able-to-create-trigger-due-to-an-open-ResultSet-p6235128.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Re%3A--jira--Commented%3A-%28DERBY-1585%29-derbylang-procedureInTrigger%3A-not-able-to-create-trigger-due-to-an-open-ResultSet-p6235128.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In the code, the result set returned from executing the trigger action statement is closed. GenericTriggerExecutor.executeSPS fetches all rows and closes the result set. So the problem seems to be elsewhere.&lt;/p&gt;</comment>
                            <comment id="12435816" author="rhillegas" created="Tue, 19 Sep 2006 15:42:10 +0100"  >&lt;p&gt;Moving to 10.2.2.0.&lt;/p&gt;</comment>
                            <comment id="12437653" author="deepa" created="Mon, 25 Sep 2006 20:33:25 +0100"  >&lt;p&gt;I had earlier said:&lt;br/&gt;
&quot;In the code, the result set returned from executing the trigger action statement is closed. GenericTriggerExecutor.executeSPS fetches all rows and closes the result set. So the problem seems to be elsewhere.&quot;&lt;/p&gt;

&lt;p&gt;What I had previously stated is not fully correct. Result set returned by executing the trigger action statement (in this case the call statement) is closed. But the result set which is closed is the internal CallStatementResultSet. &lt;br/&gt;
The result set returned by the procedure is not closed. It may get closed if it is garbage collected. However, if the result set remains open, a subsequent trigger creation will fail with following error:&lt;br/&gt;
ERROR X0X95: Operation &apos;CREATE TRIGGER&apos; cannot be performed on object &apos;T1&apos; because there is an open ResultSet dependent on that object. &lt;/p&gt;

</comment>
                            <comment id="12454852" author="oysteing" created="Fri, 1 Dec 2006 09:33:50 +0000"  >&lt;p&gt;What is the status on this bug fix?  It would be nice to get this&lt;br/&gt;
fixed since I think it is one of the more common intermittent in the&lt;br/&gt;
nightly tests.  This week it has also happened twice in the tinderbox&lt;br/&gt;
test.&lt;/p&gt;</comment>
                            <comment id="12454861" author="scheur" created="Fri, 1 Dec 2006 10:12:21 +0000"  >&lt;p&gt;I agree it would be nice to get this one fixed, but I do not have the &lt;br/&gt;
resources to follow up bug fixes....&lt;br/&gt;
After Deepa assigned this bug, I don&apos;t think there has been so much &lt;br/&gt;
activity......&lt;br/&gt;
I can send a copy of this mail to Rick, maybe it starts itching...... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Henri&lt;/p&gt;


&lt;p&gt;&amp;#8211; &lt;/p&gt;

&lt;p&gt;With regards,&lt;/p&gt;



&lt;p&gt;Henri van de Scheur, Database Technology Group,&lt;br/&gt;
Sun Microsystems, Trondheim, Norway&lt;/p&gt;
</comment>
                            <comment id="12454936" author="deepa" created="Fri, 1 Dec 2006 15:47:14 +0000"  >&lt;p&gt;After the initial analysis, I hadn&apos;t spent much time on this bug. Thanks for bringing this up. I&apos;m unassigning now if anyone else wants to pick this up. &lt;/p&gt;</comment>
                            <comment id="12456046" author="rhillegas" created="Wed, 6 Dec 2006 14:37:50 +0000"  >&lt;p&gt;Move to 10.2.3.0.&lt;/p&gt;</comment>
                            <comment id="12467569" author="fuzzylogic" created="Thu, 25 Jan 2007 20:36:45 +0000"  >&lt;p&gt;Unsetting Fix Version for unassigned issues.&lt;/p&gt;</comment>
                            <comment id="12490195" author="knutanders" created="Thu, 19 Apr 2007 23:54:20 +0100"  >&lt;p&gt;I have a machine where this test (actually, it&apos;s the new ProcedureInTriggerTest) fails more or less consistently (running on OpenSolaris and Sun JDK 6). The attached patch makes the test pass, but it&apos;s more of a hack than a fix.&lt;/p&gt;

&lt;p&gt;The patch makes GenericTriggerExecutor call close() on any dynamic result sets returned by the trigger action, and on their statements. However, the calls to close() are no-ops because setting up the context stack fails and the error is silently ignored. Therefore, I also had to make EmbedPreparedStatement.close() call markUnused() on its activation if setupContextStack() failed. The same thing should probably have been done with singleUseActivation in EmbedResultSet.close() in case the ResultSet didn&apos;t come from a PreparedStatement, but that wasn&apos;t necessary for this particular issue.&lt;/p&gt;

&lt;p&gt;Ugly, I know, but at least it&apos;s a starting point... No other tests were run.&lt;/p&gt;</comment>
                            <comment id="12490211" author="djd" created="Fri, 20 Apr 2007 02:26:14 +0100"  >&lt;p&gt;I see the intent in closing the result sets but this (in edge cases) can lead to exceptions being thrown in a trigger but calling the procedure directly would not throw those exceptions.&lt;br/&gt;
That would be when the close() fails on a ResultSet that would be ignored by EmbedStatement.processDynamicResults.&lt;br/&gt;
Also if multiple result sets are returned and an exception is thrown on close, then the remaining result sets would not be closed, thus leaving the potential for&lt;br/&gt;
the bug to resurface.&lt;/p&gt;

&lt;p&gt;It&apos;s also strange that the close calls are failing, is it because the result sets are in a limbo between the old closed nested connection and the user connection?&lt;br/&gt;
I.e. if this was a plain CALL statement then the ResultSets would be linked into the valid open user connection, which obviously does not  (and should not) happen here.&lt;/p&gt;

&lt;p&gt;Not sure I have good ideas here on the best approach, but I don&apos;t understand why the close() is failing or how the change in EmbedPreparedStatement.close() achieves.&lt;br/&gt;
Also the comment about singleUseActivation in EmbedResultSet.close() is not clear to me.&lt;/p&gt;
</comment>
                            <comment id="12490264" author="kristwaa" created="Fri, 20 Apr 2007 09:29:38 +0100"  >&lt;p&gt;There were problems with the line-breaking in the environment field. I removed the prefix &apos;/export/home/tmp/jagtmp/autoderbyN_regression/install/lib&apos; from the Java classpath and broke the lines manually.&lt;/p&gt;</comment>
                            <comment id="12490274" author="knutanders" created="Fri, 20 Apr 2007 09:48:43 +0100"  >&lt;p&gt;close() doesn&apos;t actually fail, but EmbedResultSet.close() and EmbedPreparedStatement.closeActions() have this piece of code:&lt;/p&gt;

&lt;p&gt;			try &lt;/p&gt;
{
				setupContextStack(); // make sure there&apos;s context
			}
&lt;p&gt; catch (SQLException se) &lt;/p&gt;
{
				// we may get an exception here if this is part of an XA transaction
				// and the transaction has been committed
				// just give up and return
				return;
			}

&lt;p&gt;The exception that is swallowed is a no-current-connection error, so your limbo theory could very well be correct.&lt;/p&gt;

&lt;p&gt;With my comment about singleUseActivation I meant to say that the attached patch only fixes the problem if the stored procedure used a PreparedStatement (since ResultSet.close() was a no-op here and I only fixed/hacked EmbedPreparedStatement.closeActions()). If the stored procedure had used a Statement, we would have to find another way to mark the activation as unused.&lt;/p&gt;

&lt;p&gt;I guess the main problem is that we only have access to the dynamic results through their JDBC interface, and since we&apos;re in the SQL execution layer, we cannot simply call some package private methods to do the required magic.&lt;/p&gt;

&lt;p&gt;Anyway, the patch is not meant for commit. Only food for thought.&lt;/p&gt;</comment>
                            <comment id="12491371" author="mikem" created="Tue, 24 Apr 2007 18:35:01 +0100"  >&lt;p&gt;I believe the following junit test failure is the same bug, if not let me know and I will file it as a separate case.  it also seems intermittent.  It followed on this date in the nightly poster runs in only one enviroment and passed in the others.  It failed in&lt;br/&gt;
&lt;a href=&quot;http://dbtg.thresher.com/derby/test/Daily/jvm1.6/testing/testlog/sles/531517-suitesAll_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/Daily/jvm1.6/testing/testlog/sles/531517-suitesAll_diff.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There was 1 error:&lt;br/&gt;
1) testTriggerNegative(org.apache.derbyTesting.functionTests.tests.lang.ProcedureInTriggerTest)java.sql.SQLException: Operation &apos;CREATE TRIGGER&apos; cannot be performed on object &apos;T1&apos; because there is an open ResultSet dependent on that object.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.ProcedureInTriggerTest.testTriggerNegative(ProcedureInTriggerTest.java:396)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:88)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
Caused by: java.sql.SQLException: Operation &apos;CREATE TRIGGER&apos; cannot be performed on object &apos;T1&apos; because there is an open ResultSet dependent on that object.&lt;br/&gt;
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.verifyNoOpenResultSets(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.prepareToInvalidate(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.depend.BasicDependencyManager.coreInvalidateFor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.depend.BasicDependencyManager.invalidateFor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.CreateTriggerConstantAction.executeConstantAction(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.MiscResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	... 32 more&lt;/p&gt;</comment>
                            <comment id="12491491" author="dagw" created="Wed, 25 Apr 2007 01:12:41 +0100"  >&lt;p&gt;See also my experience/run-in with this test in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1947&quot; title=&quot;OutOfMemoryError after repeated calls to boot and shutdown a database&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1947&quot;&gt;&lt;del&gt;DERBY-1947&lt;/del&gt;&lt;/a&gt;. Relying&lt;br/&gt;
on explicitly running System.gc and System.runFinalization&lt;br/&gt;
is not a sure way to make this work (cf &lt;br/&gt;
GenericLanguageConnectionContext#verifyNoOpenResultSets),&lt;br/&gt;
so intermittent occurences would be expected.&lt;/p&gt;</comment>
                            <comment id="12548330" author="djd" created="Tue, 4 Dec 2007 18:06:52 +0000"  >&lt;p&gt;Section 4.27.5 of the TECHNICAL CORRIGENDUM 1 to the SQL 2003 Standard details what happens to dynamic result sets in detail, the SQL 2003 foundation document is missing these details. &lt;/p&gt;

&lt;p&gt;If the dynamic result sets are unreachable, which they will be for a CALL statement as a trigger&apos;s single action statement, then they must be destroyed, which is ResultSet.close() in JDBC terms.&lt;/p&gt;

&lt;p&gt;Thus I think the general idea of the close.diff is correct, but I think a cleaner implementation would be to encapsulate the logic in the close of the activation for the CALL statement. (also need to ensure that all result sets are closed, regardless of any exceptions).&lt;/p&gt;</comment>
                            <comment id="12548850" author="djd" created="Wed, 5 Dec 2007 22:38:43 +0000"  >&lt;p&gt;Patch that closes dynamic result sets in the CallStatementResultSet.close(), thus encapsulating the logic rather than putting CALL specific code in the general trigger path. Code will also work for any other situations where a CALL statement will be executed and the dynamic results inaccessible (ie. potential future changes).&lt;/p&gt;

&lt;p&gt;CallStatementResultSet.close() ensures all dynamic ResultSets for the current connection are closed and thus mimics the logic when dynamic results sets are processed in EmbedStatement (through code sharing).&lt;/p&gt;

&lt;p&gt;Patch does close result sets in ProcedureInTrigger test that were not closed before, so I assume it will fix the bug, but I haven&apos;t be able to make the test fail without the change.&lt;/p&gt;

&lt;p&gt;Will run tests on the patch before any commit&lt;/p&gt;</comment>
                            <comment id="12548867" author="knutanders" created="Wed, 5 Dec 2007 23:13:49 +0000"  >&lt;p&gt;I have a machine on which I&apos;m able to reproduce this failure when I use an insane build. I&apos;m afraid it still fails after applying the patch.&lt;/p&gt;</comment>
                            <comment id="12548904" author="djd" created="Thu, 6 Dec 2007 02:11:50 +0000"  >&lt;p&gt;Thanks Knut Anders, I neglected the information you found earlier that the close of the result set did nothing. I&apos;ll submit a new patch, again I can&apos;t seem to make this test fail.&lt;/p&gt;</comment>
                            <comment id="12549113" author="djd" created="Thu, 6 Dec 2007 18:08:39 +0000"  >&lt;p&gt;Patch that ensures the close on the dynamic results does in fact close the language ResultSet and activation.&lt;/p&gt;</comment>
                            <comment id="12550129" author="knutanders" created="Mon, 10 Dec 2007 17:31:02 +0000"  >&lt;p&gt;Hi Dan,&lt;/p&gt;

&lt;p&gt;I&apos;m not able to reproduce the failure with the v2 patch, so +1 to commit from me. I found the javadoc comment for EmbedConnectionContext.processInaccessibleDynamicResult() a bit unclear, so you may consider rewriting it. (It talks about converting a ResultSet, but I can&apos;t see that any conversion is performed. The interface&apos;s javadoc comment says &quot;Process the resultSet as a dynamic result for closure&quot; which sounds clearer to me.)&lt;/p&gt;</comment>
                            <comment id="12550150" author="djd" created="Mon, 10 Dec 2007 18:47:29 +0000"  >&lt;p&gt;Revisions 602991 (trunk) closes inaccessible dynamic result sets from a CALL statement, which was causing the procedureInTriggerTest to fail.&lt;/p&gt;

&lt;p&gt;Thanks to Knut Anders for confirming the test no longer failed with the patch.&lt;/p&gt;</comment>
                            <comment id="12550161" author="knutanders" created="Mon, 10 Dec 2007 19:44:47 +0000"  >&lt;p&gt;Thanks for fixing this, Dan.&lt;/p&gt;

&lt;p&gt;By the way, I noticed this incomplete comment in EmbedStatement:&lt;/p&gt;

&lt;p&gt;+     * &amp;lt;P&amp;gt;&lt;br/&gt;
+     * if b&lt;/p&gt;

&lt;p&gt;Perhaps you could elaborate a bit more on what happens if b... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12554669" author="olesolberg" created="Fri, 28 Dec 2007 10:27:03 +0000"  >&lt;p&gt;We still see this on 10.3: &lt;a href=&quot;http://dbtg.thresher.com/derby/test/stats.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/stats.html&lt;/a&gt; .&lt;br/&gt;
Could the 602991(trunk) fix be merged to 10.3?&lt;/p&gt;</comment>
                            <comment id="12556923" author="dagw" created="Tue, 8 Jan 2008 15:59:17 +0000"  >&lt;p&gt;I attach a a repro (Main.java) that shows changed behavior after svn 602991&lt;br/&gt;
(the patch committed for this issue). It seems a regression:&lt;/p&gt;

&lt;p&gt;An explicit commit inside a stored procedure makes a dynamic result sets passed out unavailable, even if the commit is executed &lt;b&gt;prior&lt;/b&gt; to the result set; as in the repro.&lt;br/&gt;
Is this the expected behavior or not? Reopening.&lt;/p&gt;
</comment>
                            <comment id="12556932" author="djd" created="Tue, 8 Jan 2008 16:24:14 +0000"  >&lt;p&gt;issue shown by Main.java attachment is a new issue, since it does not involve triggers in any way. Clearer to have a separate issue.&lt;/p&gt;</comment>
                            <comment id="12558092" author="djd" created="Fri, 11 Jan 2008 19:58:32 +0000"  >&lt;p&gt;To record back-port to 10.3 branch&lt;/p&gt;</comment>
                            <comment id="12558094" author="djd" created="Fri, 11 Jan 2008 20:01:52 +0000"  >&lt;p&gt;Revision: 611274 merges trunk revisions 602991 and 603030 to the 10.3 branch.&lt;/p&gt;</comment>
                            <comment id="12562522" author="scheur" created="Fri, 25 Jan 2008 14:39:02 +0000"  >&lt;p&gt;Not seen anymore after week 2 when this was fixed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12352818">DERBY-1947</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12372720" name="Main.java" size="2880" author="dagw" created="Tue, 8 Jan 2008 15:59:16 +0000"/>
                            <attachment id="12355869" name="close.diff" size="1970" author="knutanders" created="Thu, 19 Apr 2007 23:54:20 +0100"/>
                            <attachment id="12371076" name="derby1585_diff.txt" size="9721" author="djd" created="Wed, 5 Dec 2007 22:38:43 +0000"/>
                            <attachment id="12371154" name="derby1585_diff_v2.txt" size="14227" author="djd" created="Thu, 6 Dec 2007 18:08:33 +0000"/>
                            <attachment id="12340485" name="derby1585_v1.diff" size="41911" author="deepa" created="Fri, 8 Sep 2006 23:52:55 +0100"/>
                            <attachment id="12340486" name="derby1585_v1.status" size="455" author="deepa" created="Fri, 8 Sep 2006 23:52:56 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 27 Jul 2006 04:49:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22580</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0zkf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39580</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>