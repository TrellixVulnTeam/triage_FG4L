<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:10:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5667/DERBY-5667.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5667] testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5667</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;one failure and 2 errors which I would guess are because of the failure.  Failed against 10.8 branch, ibm15, windows, build 1302046&lt;br/&gt;
There were 2 errors:&lt;br/&gt;
1) testSerializable(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)java.sql.SQLException: Table/View &apos;A&apos; already exists in Schema &apos;APP&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:185)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testSerializable(UpdateLocksTest.java:154)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:79)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:113)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
Caused by: ERROR X0Y32: Table/View &apos;A&apos; already exists in Schema &apos;APP&apos;.&lt;br/&gt;
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.duplicateDescriptorException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addDescriptor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.CreateTableConstantAction.executeConstantAction(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.MiscResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	... 36 more&lt;br/&gt;
2) testReadUncommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)java.sql.SQLException: Table/View &apos;A&apos; already exists in Schema &apos;APP&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:185)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testReadUncommitted(UpdateLocksTest.java:158)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:79)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:113)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
Caused by: ERROR X0Y32: Table/View &apos;A&apos; already exists in Schema &apos;APP&apos;.&lt;br/&gt;
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.duplicateDescriptorException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addDescriptor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.CreateTableConstantAction.executeConstantAction(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.MiscResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	... 36 more&lt;br/&gt;
There were 2 failures:&lt;br/&gt;
1) testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java:1349)&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java:1285)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.updateBtreeSetLocks(UpdateLocksTest.java:6764)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:387)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testReadCommitted(UpdateLocksTest.java:150)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:79)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:113)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm15/1302046-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm15/1302046-suites.All_diff.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12547298">DERBY-5667</key>
            <summary>testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="myrna">Myrna van Lunteren</assignee>
                                    <reporter username="mikem">Mike Matrigali</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Mar 2012 22:23:21 +0000</created>
                <updated>Thu, 13 Feb 2014 17:56:21 +0000</updated>
                            <resolved>Thu, 13 Feb 2014 17:56:21 +0000</resolved>
                                    <version>10.8.3.0</version>
                                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13251782" author="myrna" created="Wed, 11 Apr 2012 18:48:36 +0100"  >&lt;p&gt;I see this failure pop up frequently in the nightly tests. &lt;/p&gt;

&lt;p&gt;I did a cursory check, a variation of this has been happening before Mike logged it, see e.g. the run on Fri Mar 9, 2012 on this same platform (10.8 on windows 2008 / ibm 1.7):  &lt;br/&gt;
testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Unexpected row count expected:&amp;lt;2&amp;gt; but was:&amp;lt;3&amp;gt;&lt;br/&gt;
(&lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm17/1299147-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm17/1299147-suites.All_diff.txt&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;The current failure is happening a couple of times per week.&lt;br/&gt;
For example&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fri April 5, 2012, ibm 1.7 on windows 2008: &lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm17/1310152-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm17/1310152-suites.All_diff.txt&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Mon April 9, 2012, ibm 1.7 on windows 2008: &lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm17/1311551-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm17/1311551-suites.All_diff.txt&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Tue April 10, 2012, ibm 1.4.2 on windows 2008: &lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm142/1312069-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm142/1312069-suites.All_diff.txt&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Just like the intermittent AccessTest failure of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5377&quot; title=&quot;AssertionFailedError in testCaseCS4595B_NonUniqueIndex in AccessTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5377&quot;&gt;&lt;del&gt;DERBY-5377&lt;/del&gt;&lt;/a&gt; this problem seems to show up only on this machine, but not reproducible at will or with a smaller subset of tests than suites.All even on this machine.&lt;br/&gt;
I do not have another Windows 2008 machine available to check if it&apos;s something related to this OS.&lt;br/&gt;
I also do not have any other 4 CPU boxes available to me to do further experimenting with that.&lt;/p&gt;</comment>
                            <comment id="13261059" author="myrna" created="Tue, 24 Apr 2012 22:48:46 +0100"  >&lt;p&gt;Attaching a patch that creates a WAIT_FOR_POST_COMMIT procedure in the decorateSQL and then calls it before doing the assertUnorderedResultSet after a delete.&lt;/p&gt;

&lt;p&gt;I intend to commit this shortly; then backport it to 10.8.&lt;/p&gt;

&lt;p&gt;As I&apos;ve not been able to reproduce the issue at will this is a bit of a guess, we might have to revisit the issue again later.&lt;/p&gt;</comment>
                            <comment id="13261156" author="mikem" created="Wed, 25 Apr 2012 00:57:40 +0100"  >&lt;p&gt;comments from the review.   The call to wait_for_post_commit should be placed after the commit that follows a delete.  putting after the delete but before the commit does not help.  The problem is caused by async work done that starts when commit is called.&lt;/p&gt;

&lt;p&gt;The calls on lines 6774 and 7140 and 7340 are all too soon, they should come after the first commit following the delete.&lt;/p&gt;

&lt;p&gt;Also the change does not handle the deletes that are made because of deleteRow() being called.  &lt;/p&gt;</comment>
                            <comment id="13261204" author="myrna" created="Wed, 25 Apr 2012 02:33:05 +0100"  >&lt;p&gt;You&apos;re right of course.&lt;br/&gt;
This was because I looked at the stack trace of the original error, which shows this:&lt;br/&gt;
------------&lt;br/&gt;
testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java:1349)&lt;br/&gt;
at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java:1285)&lt;br/&gt;
at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.updateBtreeSetLocks(UpdateLocksTest.java:6764) &lt;br/&gt;
-------------&lt;br/&gt;
So I assumed I had to put the call for wait_for_post_commit &lt;b&gt;before&lt;/b&gt; the assertUnorderedResultSet call on line 6764.&lt;/p&gt;

&lt;p&gt;The delete-commit it would affect is then not the delete call right before ((original file line 6760/6761):  s.executeUpdate(&quot;delete from a where a = 2 or a = 4 or a = 6&quot;)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Because, as you say, there&apos;s no commit for that one yet.&lt;br/&gt;
Instead it would be for the earlier delete (original file line 6689/6690):   &lt;br/&gt;
         s.executeUpdate(&lt;br/&gt;
            &quot;delete from a where a = 4&quot;); &lt;br/&gt;
which got committed on line (again, original file numbers&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; 6732.&lt;/p&gt;

&lt;p&gt;Still, there&apos;s no good explanation for the placing of the other wait_for_commit calls. I will make a new patch that does the call after the commit belonging to each delete - and after the commit following each deleteRow() call.&lt;/p&gt;
</comment>
                            <comment id="13261242" author="myrna" created="Wed, 25 Apr 2012 03:10:13 +0100"  >&lt;p&gt;Attaching patch _2.diff which puts the calls for wait_for_post_commit after each commit following a delete.&lt;/p&gt;</comment>
                            <comment id="13261827" author="mikem" created="Wed, 25 Apr 2012 18:28:45 +0100"  >&lt;p&gt;the second patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="13261962" author="myrna" created="Wed, 25 Apr 2012 20:11:25 +0100"  >&lt;p&gt;I applied the changes as per patch _2.diff to trunk with revision 1330482 and merged 1330066 and 1330482 to 10.8 with revision 1330489. &lt;br/&gt;
I&apos;m resolving this issue. It&apos;s possible the test will fail again because of activity resulting from updates, if it does, we can repeat the solution for that.&lt;/p&gt;</comment>
                            <comment id="13289523" author="myrna" created="Tue, 5 Jun 2012 17:42:56 +0100"  >&lt;p&gt;The problem occurred again last night, with ibm 1.4.2, with the 10.8 branch updated to revision 1346212.&lt;/p&gt;

&lt;p&gt;This is the stack trace:&lt;/p&gt;

&lt;p&gt;1) testReadUncommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.updateBtreeSetLocks(UpdateLocksTest.java:7373)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:264)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testReadUncommitted(UpdateLocksTest.java:168)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java(Compiled Code))&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;</comment>
                            <comment id="13289626" author="myrna" created="Tue, 5 Jun 2012 19:28:51 +0100"  >&lt;p&gt;See: &lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm142/1346212-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm142/1346212-suites.All_diff.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13423900" author="myrna" created="Fri, 27 Jul 2012 15:27:18 +0100"  >&lt;p&gt;Looking again at the previous mention, it seems something else than post-commit activity after a delete-commit is going on, because the code that failed already had the post-commit call in place...&lt;br/&gt;
I think more detailed output on error would help.&lt;/p&gt;

&lt;p&gt;This test failed again, on July 24, on nightly builds off the 10.8 branch synced to revision 1365402 on windows with ibm 1.4.2.: &lt;br/&gt;
&lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm142/1365402-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/windows/testlog/ibm142/1365402-suites.All_diff.txt&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The stack trace indicates the trouble this time was after an update, not a delete:&lt;br/&gt;
1) testSerializable(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Unexpected row count expected:&amp;lt;4&amp;gt; but was:&amp;lt;6&amp;gt;&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.updateBtreeSetLocks(UpdateLocksTest.java:7085)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:252)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testSerializable(UpdateLocksTest.java:164)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java(Compiled Code))&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
(There was also an error in the subsequent fixture testReadUncommitted (java.sql.SQLException: Table/View &apos;A&apos; already exists in Schema &apos;APP&apos;) - but I&apos;m chalking that up to a result of the failure)&lt;/p&gt;

&lt;p&gt;Also, I it seems these failures in UpdateLocksTest seem to be happening only on the machine running 10.8 windows tests, and most often with ibm 1.4.2. Could be there&apos;s just more concurrency trouble on this machine - it&apos;s a 4 CPU but it&apos;s running suites.All for 6 jvm versions at the same time...&lt;/p&gt;

&lt;p&gt;I will work towards a new patch which does:&lt;br/&gt;
1. print out more detailed info on error&lt;br/&gt;
2. adds the wait_for_post_commit calls to all commits following an update.&lt;/p&gt;</comment>
                            <comment id="13427754" author="myrna" created="Fri, 3 Aug 2012 01:09:06 +0100"  >&lt;p&gt;Attaching a patch which:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in store.UpdateLocksTest, adds a call to wait_for_post_commit after each commit following an update&lt;/li&gt;
	&lt;li&gt;in junit.JDBC, modifies the &apos;missing Rows&apos; output to always print out the actual and expected rows:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Index: java/testing/org/apache/derbyTesting/junit/JDBC.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; java/testing/org/apache/derbyTesting/junit/JDBC.java        (revision 1368744)&lt;br/&gt;
+++ java/testing/org/apache/derbyTesting/junit/JDBC.java        (working copy)&lt;br/&gt;
@@ -1392,7 +1392,9 @@&lt;br/&gt;
             expected.removeAll( actual );&lt;br/&gt;
             BaseTestCase.println&lt;br/&gt;
                 ( &quot;These expected rows don&apos;t appear in the actual result: &quot; + expected );&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Assert.fail( &quot;Missing rows in ResultSet&quot; );&lt;br/&gt;
+            String message = &quot;Missing rows in ResultSet; expected rows: \n\t&quot;&lt;br/&gt;
+                + expected + &quot;, actual result: \n\t&quot; + actual;&lt;br/&gt;
+            Assert.fail( message );&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I hesitated before changing this, because there is a BaseTestCase.println line that does mostly the same - but of course we need to have verbose on. I could change the nightly run mechanisms to always run with verbose. But I think that will give us too much info in full runs, and this test does not fail often.&lt;/p&gt;

&lt;p&gt;Also, this change is on trunk, and I tend to backport to 10.8, as it is the community&apos;s common practice to backport from trunk. However. Alternatively, I could make this change only on 10.8, as that is where we appear to be seeing this (mostly?). Anyone having a preference to this 10.8 alternative?&lt;/p&gt;
</comment>
                            <comment id="13427758" author="myrna" created="Fri, 3 Aug 2012 01:12:26 +0100"  >&lt;p&gt;reattaching the file, after renaming it to _3.diff, so I can flag the grant to ASF button.&lt;/p&gt;</comment>
                            <comment id="13427760" author="myrna" created="Fri, 3 Aug 2012 01:12:53 +0100"  >&lt;p&gt;patch available for review&lt;/p&gt;</comment>
                            <comment id="13429314" author="kmarsden" created="Mon, 6 Aug 2012 19:14:56 +0100"  >&lt;p&gt;Thank you Myna for the patch.&lt;br/&gt;
I think printing the missing  expected results and the actual results as part of the failure is a good idea but since actual and expected are Array&apos;s, I think the following won&apos;t print the contents of the array, just the Array object reference.  &lt;/p&gt;


&lt;p&gt;+            String message = &quot;Missing rows in ResultSet; expected rows: \n\t&quot; &lt;br/&gt;
+                + expected + &quot;, actual result: \n\t&quot; + actual;&lt;/p&gt;

&lt;p&gt;Otherwise the patch looks fine to me. My vote is to put  it into trunk and backport to 10.8. I generally don&apos;t like to dead end anything in a branch unless it is an alternate fix to a trunk fix.&lt;/p&gt;

</comment>
                            <comment id="13429558" author="myrna" created="Tue, 7 Aug 2012 00:07:09 +0100"  >&lt;p&gt;Thanks for the review and input, Kathey.&lt;br/&gt;
But &apos;actual&apos; and &apos;expected&apos; are not Arrays, but ArrayLists. To my delight, ArrayList has a toString() method that seems sufficient to print out further info.&lt;br/&gt;
(ArrayList.toString():&lt;br/&gt;
Returns a string representation of this collection. The string representation consists of a list of the collection&apos;s elements in the order they are returned by its iterator, enclosed in square brackets (&quot;[]&quot;). Adjacent elements are separated by the characters &quot;, &quot; (comma and space). Elements are converted to strings as by String.valueOf(Object). )&lt;/p&gt;

&lt;p&gt;I modified the placings of \n and \t a little since I created my patch.&lt;br/&gt;
To see what we&apos;d get if the test failed, for debugging, I moved the creation of the &apos;message&apos; String out of the if block, added a println, and ran UpdateLocksTest. I got output like this:&lt;br/&gt;
	 expected rows: &lt;br/&gt;
		[&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 1, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;], &lt;br/&gt;
	 actual result: &lt;br/&gt;
		[&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 1, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;]&lt;/p&gt;
</comment>
                            <comment id="13429563" author="myrna" created="Tue, 7 Aug 2012 00:12:55 +0100"  >&lt;p&gt;Attaching a patch that is just like the previous &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5667&quot; title=&quot;testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5667&quot;&gt;&lt;del&gt;DERBY-5667&lt;/del&gt;&lt;/a&gt;_3.diff, except that there&apos;s some minor changes in the location of the returns and tabs, to facilitate visual comparison in the output.&lt;/p&gt;

&lt;p&gt;I will commit this shortly to trunk, then port it back to 10.9 and 10.8 later.&lt;/p&gt;</comment>
                            <comment id="13429567" author="myrna" created="Tue, 7 Aug 2012 00:22:08 +0100"  >&lt;p&gt;committed patch _3b.diff to trunk with revision: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1370058&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1370058&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13430821" author="myrna" created="Wed, 8 Aug 2012 03:47:57 +0100"  >&lt;p&gt;Attaching a patch which is the result of svn  merge -c for UpdateLocksTest, but JDBC.java needed manual adjustment. &lt;/p&gt;

&lt;p&gt;I will to commit this shortly.&lt;/p&gt;</comment>
                            <comment id="13430823" author="myrna" created="Wed, 8 Aug 2012 03:51:35 +0100"  >&lt;p&gt;committed patch _3_109.diff to 10.9 with revision: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1370647&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1370647&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13432119" author="myrna" created="Thu, 9 Aug 2012 21:26:53 +0100"  >&lt;p&gt;committed backport of revison 1370647 from 10.9 branch to 10.8 (clean merge using svn merge -c 1370647  &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/branches/10.9&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/branches/10.9&lt;/a&gt;), see: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1371433&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1371433&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13565836" author="myrna" created="Tue, 29 Jan 2013 21:34:26 +0000"  >&lt;p&gt;I think this issue has been resolved.&lt;/p&gt;</comment>
                            <comment id="13897341" author="myrna" created="Tue, 11 Feb 2014 00:36:28 +0000"  >&lt;p&gt;This failed again on the 10.8 branch, with ibm 1.4.2, linux, see:&lt;br/&gt;
&lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_8/linux/testlog/ibm142/1566493-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_8/linux/testlog/ibm142/1566493-suites.All_diff.txt&lt;/a&gt;&lt;br/&gt;
testReadUncommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Unexpected row count expected:&amp;lt;3&amp;gt; but was:&amp;lt;2&amp;gt;&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.updateBtreeCursorLocks2(UpdateLocksTest.java:5874)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:337)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testReadUncommitted(UpdateLocksTest.java:168)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java(Compiled Code))&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;

&lt;p&gt;Interestingly, I can now duplicate this behavior very easily on my machine with 10.8 classes and running the store suite.&lt;br/&gt;
I narrowed it down to (apparently) a cleanup issue in the test Derby4676Test.java.&lt;br/&gt;
I will work on an improved cleanup.&lt;/p&gt;</comment>
                            <comment id="13897427" author="myrna" created="Tue, 11 Feb 2014 01:43:50 +0000"  >&lt;p&gt;On closer look, it&apos;s not that simple.&lt;/p&gt;

&lt;p&gt;I think there is an issue with ibm 1.4.2 and Thread maintenance, I believe we have seen other instances of trouble. &lt;br/&gt;
If ,with 10.8 classes and ibm 1.4.2, I have only the Derby4676Test run before UpdateLocksTest, then on my system, there are always one or more failures in the UpdateLocksTest.&lt;br/&gt;
With ibm 1.5 or higher, all is fine.&lt;br/&gt;
If I do not have Derby4676Test, all is fine.&lt;br/&gt;
If I only have embeddedSuite for Derby4676Test, all is fine in UpdateLocksTest also.&lt;br/&gt;
If I only have clientServerSuite for Derby4676Test, all is fine in UpdateLocksTest also.&lt;br/&gt;
But if I have defaultSuite, the UpdateLocksTest fails with ibm 1.4.2&lt;/p&gt;

&lt;p&gt;I have tried to put waitforPostCommit calls in various places in the teardown, but it does not appear to matter.&lt;/p&gt;

&lt;p&gt;At this point, I propose to make the Derby4676Test to only run in embedded with ibm 1.4.2  on 10.8. I do not intend to make this change on any other branch, even on 10.8 I do not really expect anyone to run with 1.4.2 anymore.&lt;/p&gt;</comment>
                            <comment id="13897565" author="myrna" created="Tue, 11 Feb 2014 06:19:30 +0000"  >&lt;p&gt;Unfortunately, when I ran the normal length store._Suite, UpdateLocksTest failed again.&lt;br/&gt;
When I eliminate the Derby4676Test altogether, then the UpdateLocksTest passes...&lt;/p&gt;
</comment>
                            <comment id="13898254" author="myrna" created="Tue, 11 Feb 2014 20:11:54 +0000"  >&lt;p&gt;I made a little modification in JDBC.assertUnorderedResultSet, and added a commit to UpdateLocksTest.teardown, and this resulted in the following test output (ibm 1.4.2, 10.8, on my windows 7 laptop):&lt;/p&gt;

&lt;p&gt;(emb)store.Derby4676Test.testConcurrentFetchAndDelete used 4817 ms .&lt;br/&gt;
(net)store.Derby4676Test.testConcurrentFetchAndDelete used 4103 ms .&lt;br/&gt;
(emb)store.UpdateLocksTest.testRepeatableRead used 3814 ms .&lt;br/&gt;
(emb)store.UpdateLocksTest.testReadCommitted used 3401 ms .&lt;br/&gt;
(emb)store.UpdateLocksTest.testSerializable used 3568 ms F.&lt;br/&gt;
(emb)store.UpdateLocksTest.testReadUncommitted used 1773 ms F&lt;br/&gt;
Time: 28.754&lt;br/&gt;
There were 2 failures:&lt;br/&gt;
1) testSerializable(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Unexpected row count, expected: 2, actual: 3&lt;br/&gt;
         expected rows:&lt;br/&gt;
                [&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 2, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 3, X, A, (1,9), GRANT, ACTIVE&amp;#93;&lt;/span&gt;]&lt;br/&gt;
         actual result:&lt;br/&gt;
                [&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 2, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 1, U, A, (1,9), GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 2, X, A, (1,9), GRANT, ACTIVE&amp;#93;&lt;/span&gt;] expected:&amp;lt;2&amp;gt; but was:&amp;lt;3&amp;gt;&lt;br/&gt;
        at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
        at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java:1304)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.updateBtreeSetLocks(UpdateLocksTest.java:7028)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:254)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testSerializable(UpdateLocksTest.java:166)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:88)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:61)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:113)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
2) testReadUncommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Unexpected row count, expected: 3, actual: 2&lt;br/&gt;
         expected rows:&lt;br/&gt;
                [&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 2, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 1, X, A, (1,10), GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 3, X, A, (1,9), GRANT, ACTIVE&amp;#93;&lt;/span&gt;]&lt;br/&gt;
         actual result:&lt;br/&gt;
                [&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 2, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 2, X, A, (1,9), GRANT, ACTIVE&amp;#93;&lt;/span&gt;] expected:&amp;lt;3&amp;gt; but was:&amp;lt;2&amp;gt;&lt;br/&gt;
        at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java(Compiled Code))&lt;br/&gt;
        at org.apache.derbyTesting.junit.JDBC.assertUnorderedResultSet(JDBC.java:1304)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.updateBtreeSetLocks(UpdateLocksTest.java:7472)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.doRunTests(UpdateLocksTest.java:266)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest.testReadUncommitted(UpdateLocksTest.java:170)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:88)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:61)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java(Compiled Code))&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:113)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;

&lt;p&gt;It is surprising that I can make UpdateLocksTest fail when run after Derby4676Test. But if we&apos;re assuming that there issue is background threads from the deletes in the earlier test, then why doesn&apos;t that show up in the first test cases?&lt;/p&gt;

&lt;p&gt;I can modify the 10.8 store._Suite so it runs the two tests in reverse order with ibm 1.4.2.&lt;br/&gt;
But I would like to understand a bit more, in case failures pop up again in UpdateLocksTest on later branches with newer jvms.&lt;/p&gt;</comment>
                            <comment id="13898566" author="mikem" created="Wed, 12 Feb 2014 00:42:03 +0000"  >&lt;p&gt;I looked closely at the first failure in your recent posting, a failure in testSerializable, with updateBtreeSetLocks.  This test is expecting a query plan to use the index.  The difference is rather than 3 X row locks, we end up with 2 X row locks and a U lock.&lt;/p&gt;

&lt;p&gt;The query is:&lt;br/&gt;
       /* ------------------------------------------------------------&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Test updates an exact match on a with base row qualification&lt;/li&gt;
	&lt;li&gt;necessary.&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;At this point the table should look like:&lt;/li&gt;
	&lt;li&gt;1, 10, &apos;one&apos;&lt;/li&gt;
	&lt;li&gt;3, 300, &apos;three&apos;&lt;/li&gt;
	&lt;li&gt;5, 50, &apos;five&apos;&lt;/li&gt;
	&lt;li&gt;7, 70, &apos;seven&apos;&lt;/li&gt;
	&lt;li&gt;------------------------------------------------------------&lt;br/&gt;
         */&lt;br/&gt;
        s.executeUpdate(&lt;br/&gt;
            &quot;update a  set b = 30 where a = 3 and b = 300&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There is a index on a, and query needs to go to base table to read and write b.&lt;/p&gt;

&lt;p&gt;I think the expected locks are:&lt;br/&gt;
look up a=3 in index (IX table on a, X lock on row a=3)&lt;br/&gt;
find base row and get value b (X lock on row a=3, b=300 in base table)&lt;br/&gt;
separate step to update the value in base table (IX table on a, X lock on row a=3, b=300)&lt;/p&gt;

&lt;p&gt;I believe we actually in-line ask for a U row lock first at some point and then escalate&lt;br/&gt;
it to X when we have gotten it and know we are going to do the update.  I don&apos;t know&lt;br/&gt;
why a U lock would be left around in any case.  It would not cause any problem because the xact already has X lock until end transaction so the U lock becomes&lt;br/&gt;
meaningless.  &lt;/p&gt;

&lt;p&gt;The lock count is an internal implementation detail and probably should not have&lt;br/&gt;
been exposed, but doing that would have been more work than just dumping the&lt;br/&gt;
lock table state.  And originally the tool really was more for debugging the lock&lt;br/&gt;
manager than providing something for users.&lt;/p&gt;



&lt;p&gt;I looked closely and it looks like the code handles committed deletes with proper wait for post commit.  &lt;/p&gt;

&lt;p&gt;So, given you are seeing intermittent issues, I started wondering if it could be related to the other background timing issue with tests - the automatic statistics gatherer.  This test has very few rows and in this test case  I think all the rows fit on one page of index and one page of a data page.   I could see the optmizer picking&lt;br/&gt;
a different plan with a change of statistics.  I sugest turning off the statistics gatherer for all locking tests like these&lt;br/&gt;
that expect to own exactly how the query will be executed.  &lt;/p&gt;
</comment>
                            <comment id="13898567" author="mikem" created="Wed, 12 Feb 2014 00:44:57 +0000"  >&lt;p&gt;the second failure:&lt;br/&gt;
2) testReadUncommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Unexpected row count, expected: 3, actual: 2&lt;br/&gt;
expected rows:&lt;br/&gt;
[&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 2, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 1, X, A, (1,10), GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 3, X, A, (1,9), GRANT, ACTIVE&amp;#93;&lt;/span&gt;]&lt;br/&gt;
actual result:&lt;br/&gt;
[&lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, TABLE, 2, IX, A, Tablelock, GRANT, ACTIVE&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;APP, UserTran, ROW, 2, X, A, (1,9), GRANT, ACTIVE&amp;#93;&lt;/span&gt;] expected:&amp;lt;3&amp;gt; but was:&amp;lt;2&amp;gt;&lt;/p&gt;

&lt;p&gt;In this case we expected X row locks on both rows in the table since the scan is a range&lt;br/&gt;
that includes both rows.  But we only got locks on one row, can&apos;t tell from the output but&lt;br/&gt;
have to assume it is on the one qualifying row.  This does have the feel of a different&lt;br/&gt;
execution plan for some reason.&lt;/p&gt;

&lt;p&gt; /* ------------------------------------------------------------&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Test qualified full cursor scan which updates a row.&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;At this point the table should look like:&lt;/li&gt;
	&lt;li&gt;3, -30, &apos;-three&apos;&lt;/li&gt;
	&lt;li&gt;5, -50, &apos;five&apos;&lt;/li&gt;
	&lt;li&gt;------------------------------------------------------------&lt;br/&gt;
         */&lt;br/&gt;
        s.executeUpdate(&lt;br/&gt;
            &quot;update a  set b = 30 where a &amp;gt; 2 and a &amp;lt; 5&quot;);&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13899715" author="myrna" created="Wed, 12 Feb 2014 22:53:30 +0000"  >&lt;p&gt;The failures (still only with ibm 1.4.2 and only if I run Derby4676Test first) are always in the method UpdateLocksTest.updateBtreeSetLocks, and always in the checks after a delete or update, but before commit. I&apos;ve seen all of them fail at one point or another. I&apos;ve seen test failures in all the isolations in differing combinations. The test mostly repeats the same checks after a commit and those are always fine.&lt;/p&gt;

&lt;p&gt;I&apos;ve thought of updating runtimestatistics before the check, but that seems to only cause additional IS locks. I could do a commit after the runtimestatistics call, but that would make the checks unnecessary because we already have the one after commit.&lt;/p&gt;

&lt;p&gt;I have tried to make the UpdateLocksTest bounce the database, from the comments this should happen when you pass &apos;true&apos; as the third argument to the SystemPropertyTestSetup, but that did not change the behavior.&lt;/p&gt;

&lt;p&gt;Although it&apos;s still mysterious that this pops when I run the Derby4676Test first, I think at this point I am satisfied that for some reason it makes the optimizer like a different plan. The instability remains possible and only if we modify the entire test and make a search for only those locks we are really after will this be completely eliminated. I do not intend to make that effort at this time.&lt;/p&gt;

&lt;p&gt;I will do the following:&lt;br/&gt;
for all branches&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add a commit() to the teardown in UpdateLocksTest so it doesn&apos;t choke in attempting to create &apos;A&apos; table for subsequent test fixtures if one fails&lt;/li&gt;
	&lt;li&gt;expand the error reporting in JDBC.assertUnorderedResultSet to show any missing rows&lt;br/&gt;
only for 10.8:&lt;/li&gt;
	&lt;li&gt;add a private method (assertUnorderedResultSet) in UpdateLocksTest which just returns if the jvm is ibm142, and calls the public JDBC.assertUnorderedResultSet otherwise, and use this method in the problematic calls in UpdateLocksTest.updateBtreeSetLocks.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13899728" author="jira-bot" created="Wed, 12 Feb 2014 23:01:36 +0000"  >&lt;p&gt;Commit 1567787 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1567787&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1567787&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5667&quot; title=&quot;testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5667&quot;&gt;&lt;del&gt;DERBY-5667&lt;/del&gt;&lt;/a&gt;; testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
   further improving error message in assert, and avoiding error message re table exists if a test case fails&lt;/p&gt;</comment>
                            <comment id="13899888" author="jira-bot" created="Thu, 13 Feb 2014 01:21:18 +0000"  >&lt;p&gt;Commit 1567823 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1567823&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1567823&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5667&quot; title=&quot;testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5667&quot;&gt;&lt;del&gt;DERBY-5667&lt;/del&gt;&lt;/a&gt;;  testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
   backport of revision 1567787 from trunk - improve error message&lt;/p&gt;</comment>
                            <comment id="13899918" author="jira-bot" created="Thu, 13 Feb 2014 01:53:11 +0000"  >&lt;p&gt;Commit 1567826 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.9&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1567826&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1567826&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5667&quot; title=&quot;testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5667&quot;&gt;&lt;del&gt;DERBY-5667&lt;/del&gt;&lt;/a&gt;; testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
   backport of revision 1567823 from trunk, not a clean merge of JDBC.java&lt;/p&gt;</comment>
                            <comment id="13899928" author="jira-bot" created="Thu, 13 Feb 2014 02:03:56 +0000"  >&lt;p&gt;Commit 1567828 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1567828&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1567828&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5667&quot; title=&quot;testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5667&quot;&gt;&lt;del&gt;DERBY-5667&lt;/del&gt;&lt;/a&gt;; testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
  merge of revision 1567826 from 10.9 branch&lt;/p&gt;</comment>
                            <comment id="13899932" author="jira-bot" created="Thu, 13 Feb 2014 02:09:20 +0000"  >&lt;p&gt;Commit 1567831 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1567831&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1567831&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5667&quot; title=&quot;testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5667&quot;&gt;&lt;del&gt;DERBY-5667&lt;/del&gt;&lt;/a&gt;; testReadCommitted(org.apache.derbyTesting.functionTests.tests.store.UpdateLocksTest)junit.framework.AssertionFailedError: Missing rows in ResultSet&lt;br/&gt;
   making part of the tests&apos; checks skip with ibm 1.4.2.&lt;/p&gt;</comment>
                            <comment id="13900548" author="myrna" created="Thu, 13 Feb 2014 17:56:21 +0000"  >&lt;p&gt;Although several improvements have gone in (some improved error messaging, and especially, adding of calls to wait for background commit tasks), and I&apos;ve  added skipping of one set of checks that failed on one particular machine with one particular JVM in the 10.8 branch, it is still possible that this test might show instability. To eliminate that, we&apos;d have to go through this test and figure out in each case, which lock we&apos;re really interested in, and look for that one only.&lt;/p&gt;

&lt;p&gt;I do not intend to do that at this time, so I am closing this issue as &apos;Won&apos;t Fix&apos;. If this failure becomes prevalent, we can re-evaluate.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12524065" name="DERBY-5667.diff" size="2239" author="myrna" created="Tue, 24 Apr 2012 22:48:46 +0100"/>
                            <attachment id="12524102" name="DERBY-5667_2.diff" size="7352" author="myrna" created="Wed, 25 Apr 2012 03:10:13 +0100"/>
                            <attachment id="12538984" name="DERBY-5667_3.diff" size="4469" author="myrna" created="Fri, 3 Aug 2012 01:12:26 +0100"/>
                            <attachment id="12539761" name="DERBY-5667_3_109.diff" size="4505" author="myrna" created="Wed, 8 Aug 2012 03:47:57 +0100"/>
                            <attachment id="12539371" name="DERBY-5667_3b.diff" size="4483" author="myrna" created="Tue, 7 Aug 2012 00:12:54 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 11 Apr 2012 17:48:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>232456</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ahj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35517</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>