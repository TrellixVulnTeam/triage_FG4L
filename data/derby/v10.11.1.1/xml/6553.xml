<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:51:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6553/DERBY-6553.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6553] Sequence generator makes CREATE TRIGGER fail with internal error</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6553</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I&apos;m seeing this on trunk:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij version 10.11
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=true&apos;;
ij&amp;gt; create table t1(x int, y int, z int);
0 rows inserted/updated/deleted
ij&amp;gt; create table t2(x int, y int, z int);
0 rows inserted/updated/deleted
ij&amp;gt; create sequence seq;
0 rows inserted/updated/deleted
ij&amp;gt; values next value for seq;
1          
-----------
-2147483648

1 row selected
ij&amp;gt; create trigger tr1 after insert on t1 insert into t2(x) values (next value for seq);
ERROR 40XT8: An internal error was identified by RawStore module. Internal state detail from the transaction is as follows: savedEndStatus = 0
needSync = false
justCreated = false
myGlobalId = null
myId = null
state = 0
inComplete = null
seenUpdates = false
inPostCommitProcessing = false
logStart = null
logLast = null
recoveryTransaction = false
postCompleteMode = false
sanityCheck_xaclosed = false
transName = UserTransaction
readOnly = false
flush_log_on_xact_end = true
backupBlocked = false
dontWaitForLocks = false
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12710522">DERBY-6553</key>
            <summary>Sequence generator makes CREATE TRIGGER fail with internal error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Fri, 25 Apr 2014 11:15:55 +0100</created>
                <updated>Thu, 25 Sep 2014 21:53:43 +0100</updated>
                            <resolved>Mon, 19 May 2014 18:53:19 +0100</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13980865" author="knutanders" created="Fri, 25 Apr 2014 11:19:11 +0100"  >&lt;p&gt;The same CREATE TRIGGER statement does not fail on head of 10.10, so it looks as if this is a regression in trunk.&lt;/p&gt;

&lt;p&gt;The CREATE TRIGGER statement does not fail on trunk if no value has been fetched from the sequence generator first. That is, if the &quot;values next value for seq&quot; statement is commented out in the repro, CREATE TRIGGER does not raise this error.&lt;/p&gt;</comment>
                            <comment id="13980912" author="knutanders" created="Fri, 25 Apr 2014 12:48:47 +0100"  >&lt;p&gt;I&apos;m able to reproduce this error outside of a trigger as well:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij version 10.11
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=true&apos; as c1;
ij&amp;gt; autocommit off;
ij&amp;gt; create sequence seq;
0 rows inserted/updated/deleted
ij&amp;gt; commit;
ij&amp;gt; values next value for seq;
1          
-----------
-2147483648

1 row selected
ij&amp;gt; create sequence seq;
ERROR X0Y68: Sequence &apos;SEQ&apos; already exists.
ij&amp;gt; rollback;
ERROR 40XT8: An internal error was identified by RawStore module. Internal state detail from the transaction is as follows: savedEndStatus = 0
needSync = false
justCreated = false
myGlobalId = null
myId = null
state = 0
inComplete = null
seenUpdates = false
inPostCommitProcessing = false
logStart = null
logLast = null
recoveryTransaction = false
postCompleteMode = false
sanityCheck_xaclosed = false
transName = UserTransaction
readOnly = false
flush_log_on_xact_end = true
backupBlocked = false
dontWaitForLocks = false
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This variant is reproducible on head of 10.10 too. &lt;/p&gt;</comment>
                            <comment id="13980952" author="rhillegas" created="Fri, 25 Apr 2014 13:35:55 +0100"  >&lt;p&gt;The second script runs fine for me with 10.10.1.1 (and Oracle&apos;s 10.10.1.2).&lt;/p&gt;</comment>
                            <comment id="13981027" author="knutanders" created="Fri, 25 Apr 2014 14:46:35 +0100"  >&lt;p&gt;I only see this error with a debug build of 10.10. It doesn&apos;t seem to fail in production builds.&lt;/p&gt;

&lt;p&gt;Attaching derby.log from a run of the second script against db-derby-10.10.2.0-lib-debug. If I read it correctly, the rollback command first get a &quot;too much contention&quot; error, then an assert failure during cleanup (ASSERT FAILED Number of DDL Users is &amp;lt;= 0 when finishing a transaction), and finally the internal error reported by ij.&lt;/p&gt;

&lt;p&gt;Although the reported error is not an assert failure, it is only raised in debug builds:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;impl.store.raw.xact.Xact.abort()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (SanityManager.DEBUG)
            {
                &lt;span class=&quot;code-comment&quot;&gt;// Only global transaction is allowed to abort a closed
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// transaction.
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!sanityCheck_xaclosed)
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; StandardException.newException(
                                    SQLState.XACT_PROTOCOL_VIOLATION_DETAILED, 
                                    toInternalDetailString());
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13981036" author="knutanders" created="Fri, 25 Apr 2014 14:56:09 +0100"  >&lt;p&gt;Seems like something similar is happening in the CREATE TRIGGER case. After the statement has executed, auto-commit experiences a too much contention error, followed by the same assert failure as seen above during cleanup, and finally an internal error in Xact.prepareCommit().&lt;/p&gt;</comment>
                            <comment id="13981041" author="knutanders" created="Fri, 25 Apr 2014 15:03:52 +0100"  >&lt;p&gt;In the CREATE TRIGGER case (the first script), I do not see it on trunk when compiled in insane mode. If I run it with derby.stream.error.logSeverityLevel=0, I do see that derby.log contains a too much contention error that has been raised during auto-commit. That error seems to be swallowed, though. Possibly by the catch block in SequenceUpdater.clearIdentity().&lt;/p&gt;</comment>
                            <comment id="14002062" author="rhillegas" created="Mon, 19 May 2014 18:51:05 +0100"  >&lt;p&gt;It appears that this bug has been fixed by the work on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6554&quot; title=&quot;Too much contention followed by assert failure when accessing sequence in transaction that created it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6554&quot;&gt;&lt;del&gt;DERBY-6554&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Attaching derby-6553-01-aa-verifyFix.diff. This adds test cases for the repros for this bug.&lt;/p&gt;

&lt;p&gt;Touches the following file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceGeneratorTest.java&lt;/p&gt;</comment>
                            <comment id="14002064" author="jira-bot" created="Mon, 19 May 2014 18:52:31 +0100"  >&lt;p&gt;Commit 1595977 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1595977&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1595977&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6553&quot; title=&quot;Sequence generator makes CREATE TRIGGER fail with internal error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6553&quot;&gt;&lt;del&gt;DERBY-6553&lt;/del&gt;&lt;/a&gt;: Adding test cases to verify that we can create trigger-invoking sequences: commit derby-6553-01-aa-verifyFix.diff.&lt;/p&gt;</comment>
                            <comment id="14002065" author="rhillegas" created="Mon, 19 May 2014 18:53:19 +0100"  >&lt;p&gt;I believe this issue can be resolved now.&lt;/p&gt;</comment>
                            <comment id="14147025" author="mikem" created="Wed, 24 Sep 2014 23:52:48 +0100"  >&lt;p&gt;requires &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6554&quot; title=&quot;Too much contention followed by assert failure when accessing sequence in transaction that created it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6554&quot;&gt;&lt;del&gt;DERBY-6554&lt;/del&gt;&lt;/a&gt; fixes which are not appropriate for backport to 10.10, so marking this issue also as not to be backported before 10.11&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12645595" name="derby-6553-01-aa-verifyFix.diff" size="2185" author="rhillegas" created="Mon, 19 May 2014 18:51:05 +0100"/>
                            <attachment id="12641922" name="derby.log" size="17775" author="knutanders" created="Fri, 25 Apr 2014 14:46:35 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 25 Apr 2014 12:35:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>388843</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzou1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>389089</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>