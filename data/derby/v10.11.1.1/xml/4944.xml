<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:34:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4944/DERBY-4944.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4944] Embedded Derby does not start when derby.jar is dynamically uploaded / added to the classpath</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4944</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Hi, &lt;/p&gt;

&lt;p&gt;For our workflow-system, we can use a variety of DBMS as the store engine. Derby is one of them especially popular&lt;br/&gt;
for test and development purposes. During setup of our system, we allow to upload a jar file with the JDBC-Driver for the DBMS.&lt;br/&gt;
In case of derby, we use the embedded mode and upload derby.jar. After that we add the jar to the repositories of our class loader&lt;br/&gt;
and call &lt;/p&gt;

&lt;p&gt;Class drc = Class.forName(&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;, true, ourclassloader);&lt;br/&gt;
Driver drv = (Driver)drc.newInstance();&lt;/p&gt;

&lt;p&gt;this worked perfectly for many years up to version 10.6.1.0, but ceased to work in 10.6.2.1; &lt;br/&gt;
i assume the unreleased future versions are affected, too&lt;/p&gt;

&lt;p&gt;when derby.jar is placed in the classpath manually before starting our setup, everything works fine regardless of the derby version.&lt;/p&gt;

&lt;p&gt;investigations lead to the following conclusion:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;since rev. 982370 this is broken, in the immediate predecessor rev. 980035  it worked.&lt;/li&gt;
	&lt;li&gt;rev. 982370 in  the org.apache.derby.impl.store.raw.data.BaseDataFileFactory class introduced a new method&lt;br/&gt;
    private static String jarClassPath(final Class cls) which tries to find the jarfile from which derby was loaded.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  it contains the following lines: &lt;/p&gt;

&lt;p&gt;if ( cs == null )&lt;br/&gt;
  return null;&lt;br/&gt;
URL result = cs.getLocation();&lt;br/&gt;
return result.toString();        &lt;/p&gt;

&lt;p&gt;  but in the case, when we dynamically load derby, &lt;br/&gt;
  cs is not null but cs.getLocation() is null. so i propose to change the line with the if to:&lt;br/&gt;
...&lt;br/&gt;
if ( cs == null || cs.getLocation()==null)&lt;br/&gt;
  return null;&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;or maybe it would be better to surround the whole body of the method with a try catch, since it is not essential, and a null &lt;br/&gt;
return value is also ok?&lt;/p&gt;

&lt;p&gt;thank you for your efforts concerning derby at large, &lt;/p&gt;

&lt;p&gt;Michael&lt;/p&gt;



</description>
                <environment>various windows versions, jdk1.6.0 and 1.5.0</environment>
        <key id="12493191">DERBY-4944</key>
            <summary>Embedded Derby does not start when derby.jar is dynamically uploaded / added to the classpath</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="michid">Michael Dobrovnik</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Dec 2010 15:58:49 +0000</created>
                <updated>Wed, 11 Mar 2015 17:33:02 +0000</updated>
                            <resolved>Wed, 11 Mar 2015 17:33:02 +0000</resolved>
                                    <version>10.6.2.1</version>
                                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="12971312" author="dagw" created="Tue, 14 Dec 2010 17:02:54 +0000"  >&lt;p&gt;Thanks for tracking this down and the fix, Michael! It looks good to me. &lt;/p&gt;

&lt;p&gt;I&apos;ll commit it after running our regression suite and back-port it to the 10.7 branch, so it would be included in an update release of 10.7 if there will be one (likely). The initial release of 10.7 is going out the door as we speak, so it will not make it there, unfortunately.&lt;/p&gt;</comment>
                            <comment id="12971432" author="dagw" created="Tue, 14 Dec 2010 22:13:13 +0000"  >&lt;p&gt;Trying to make a repro, this snippet did work for me, though. Could you help me determine how&lt;br/&gt;
your setup differs?&lt;/p&gt;

&lt;p&gt;public class Foo {&lt;br/&gt;
    public static void main(String[] args) throws Exception {&lt;/p&gt;

&lt;p&gt;        URL[] urls = &lt;/p&gt;
{new URL(&quot;http://myhost/mydir/derby.jar&quot;)}
&lt;p&gt;;&lt;br/&gt;
        ClassLoader mycl = URLClassLoader.newInstance(urls);&lt;/p&gt;

&lt;p&gt;        Class drc = Class.forName(&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;,&lt;br/&gt;
                                  true,&lt;br/&gt;
                                  mycl);&lt;br/&gt;
        Driver drv = (Driver)drc.newInstance();&lt;br/&gt;
        Properties cp = new Properties();&lt;br/&gt;
        cp.setProperty(&quot;create&quot;, &quot;true&quot;);&lt;br/&gt;
        Connection c = drv.connect(&quot;jdbc:derby:wombat&quot;, cp);&lt;br/&gt;
        c.close();&lt;br/&gt;
    }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;In derby.log I saw:&lt;/p&gt;

&lt;p&gt;Loaded from &lt;a href=&quot;http://myhost/mydir/derby.jar&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://myhost/mydir/derby.jar&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12971462" author="dagw" created="Tue, 14 Dec 2010 23:07:43 +0000"  >&lt;p&gt;The patch passed regression tests.&lt;/p&gt;</comment>
                            <comment id="12971589" author="michid" created="Wed, 15 Dec 2010 09:25:39 +0000"  >&lt;p&gt;In the meantime, a co-worker of mine also did some &quot;independent investigations&quot; and came to additional insight:&lt;/p&gt;

&lt;p&gt;we added the derby.jar to our classloader  with &lt;/p&gt;

&lt;p&gt;  classLoader.addRepository(jarfile,null);&lt;/p&gt;

&lt;p&gt;Changing this to &lt;/p&gt;

&lt;p&gt;  classLoader.addRepository(jarfile,new ProtectionDomain(new CodeSource(jarfile.toURL(), new Certificate&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;), null));&lt;/p&gt;

&lt;p&gt;also remedied the problem. so its not important that the patch barely did not make it into 10.7&lt;/p&gt;

&lt;p&gt;but since the apidoc of CodeSource implies that getLocation() can return null, i think it is still a relevant patch.&lt;/p&gt;

&lt;p&gt;thanks for your quick reaction.&lt;/p&gt;</comment>
                            <comment id="12971683" author="kmarsden" created="Wed, 15 Dec 2010 13:44:56 +0000"  >&lt;p&gt;Regression related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4715&quot; title=&quot;Write jvm information and path of derby.jar to derby.log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4715&quot;&gt;&lt;del&gt;DERBY-4715&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12971797" author="kmarsden" created="Wed, 15 Dec 2010 19:27:24 +0000"  >&lt;p&gt;Thank you Michael.&lt;/p&gt;

&lt;p&gt;I don&apos;t see addRepository method  in the ClassLoader or URLClassLoader API, so assume it is a custom class loader subclass.  Can you describe it in a bit more detail to help us modify Dag&apos;s attempt at a reproduction, so we can get a test case?  &lt;/p&gt;

&lt;p&gt;I wonder too is it ever possible for cls.getProtectionDomain() to return Null which might cause an NPE further up at:&lt;br/&gt;
cs = cls.getProtectionDomain().getCodeSource();&lt;/p&gt;

</comment>
                            <comment id="12971863" author="dagw" created="Wed, 15 Dec 2010 22:08:04 +0000"  >&lt;p&gt;Hi Michael,&lt;/p&gt;

&lt;p&gt;what Javadoc are you looking at to arrive at that conclusion? (&quot;the apidoc of CodeSource implies that getLocation() can return null&quot;)&lt;br/&gt;
Looking at the Javadoc for Java 1.6&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, I see this:&lt;/p&gt;

&lt;p&gt;&amp;gt; CodeSource#getLocation:&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; public final URL getLocation()&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;   Returns the location associated with this CodeSource.&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;    Returns:&lt;br/&gt;
&amp;gt;        the location (URL).&lt;/p&gt;

&lt;p&gt;It seems there is no indication that the returned value could be null?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://download.oracle.com/javase/6/docs/api/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://download.oracle.com/javase/6/docs/api/&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="12972017" author="knutanders" created="Thu, 16 Dec 2010 09:36:00 +0000"  >&lt;p&gt;The javadoc for CodeSource#implies says:&lt;/p&gt;

&lt;p&gt;  &quot;3. If this object&apos;s location (getLocation()) is not null, (...)&quot;&lt;/p&gt;

&lt;p&gt;  &quot;Note that if this CodeSource has a null location and a null certificate chain, then it implies every other CodeSource.&quot;&lt;/p&gt;

&lt;p&gt;That seems to indicate that null is a valid return value.&lt;/p&gt;</comment>
                            <comment id="12972027" author="michid" created="Thu, 16 Dec 2010 09:50:01 +0000"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;sorry for not being clear enough, (obviously, the pun on &quot;implies&quot; did not work).&lt;/p&gt;

&lt;p&gt;I am looking at the official javadoc you cited, but as i said: &quot;it implies, that...&quot;, not &quot;it states that, ..&quot;&lt;/p&gt;

&lt;p&gt;the apidoc for&lt;/p&gt;

&lt;p&gt;boolean CodeSource.implies(CodeSource)&lt;/p&gt;

&lt;p&gt;says: &quot;Note that if this CodeSource has a null location...&quot;&lt;/p&gt;

&lt;p&gt;Furthermore, looking into the source of java.security.CodeSource or java.lang.ClassLoader&lt;br/&gt;
reveals a couple of locations where location is checked if it is null.&lt;/p&gt;</comment>
                            <comment id="12972102" author="dagw" created="Thu, 16 Dec 2010 15:17:31 +0000"  >&lt;p&gt;Patch committed to trunk as svn 1050000, resolving.&lt;/p&gt;</comment>
                            <comment id="13685388" author="knutanders" created="Mon, 17 Jun 2013 10:19:53 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                            <comment id="14355141" author="frowe" created="Tue, 10 Mar 2015 16:20:47 +0000"  >&lt;p&gt;Please reopen issue and backport to 10.7.&lt;/p&gt;</comment>
                            <comment id="14355197" author="myrna" created="Tue, 10 Mar 2015 16:58:29 +0000"  >&lt;p&gt;reopening for backport to 10.7 as requested.&lt;/p&gt;</comment>
                            <comment id="14355654" author="jira-bot" created="Tue, 10 Mar 2015 20:36:44 +0000"  >&lt;p&gt;Commit 1665680 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.7&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1665680&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1665680&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4944&quot; title=&quot;Embedded Derby does not start when derby.jar is dynamically uploaded / added to the classpath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4944&quot;&gt;&lt;del&gt;DERBY-4944&lt;/del&gt;&lt;/a&gt;; Embedded Derby does not start when derby.jar is dynamically uploaded / added to the classpath&lt;br/&gt;
   merge -c of revision 1050000 from trunk&lt;/p&gt;</comment>
                            <comment id="14357250" author="myrna" created="Wed, 11 Mar 2015 17:33:02 +0000"  >&lt;p&gt;Closing again. Although the build at apache failed, that seemed to be because of a problem with ant, not with derby, and it worked fine in my environment when I ran suites.All.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12503516">DERBY-5178</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12467914">DERBY-4715</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12466220" name="BDFF.diff" size="619" author="michid" created="Tue, 14 Dec 2010 16:00:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 14 Dec 2010 17:02:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24545</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10427"><![CDATA[Workaround attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0gwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>