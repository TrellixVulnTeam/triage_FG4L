<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1583/DERBY-1583.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1583] With grant revoke enabled, defining a trigger whose actions updates a table (from different schema) results in NPE</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1583</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;While working on SQL authorization work, I ran across a test case where Derby will throw a NPE when a trigger is defined with it&apos;s action as update a table from another schema. I don&apos;t have much details on why but following is the test case. Derby is trying to put privilege requirement for a column into privilege requirements list and it expects the column&apos;s tableUUID to be not null but in this particular case, it is null.&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:c:/dellater/dbmain;create=true&apos; user &apos;mamta1&apos; as mamta1;&lt;br/&gt;
create table t11TriggerRevokeTest (c111 int not null primary key, c12 int);&lt;br/&gt;
grant TRIGGER on t11TriggerRevokeTest to mamta2;&lt;br/&gt;
create table t12TriggerRevokeTest (c121 int, c122 int, c123 int); &lt;br/&gt;
grant UPDATE(c122, c121) on t12TriggerRevokeTest to mamta2;&lt;br/&gt;
connect &apos;jdbc:derby:c:/dellater/dbmain;create=true&apos; user &apos;mamta2&apos; as mamta2;&lt;br/&gt;
create trigger tr11t11 after insert on mamta1.t11TriggerRevokeTest for each statement mode db2sql&lt;br/&gt;
        update mamta1.t12TriggerRevokeTest set c122 = 99;&lt;/p&gt;

&lt;p&gt;The stack trace looks as follows&lt;br/&gt;
ij(MAMTA2)&amp;gt; ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.CompilerContextImpl.addRequiredColumnPriv(CompilerContextImpl.java:741)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ResultColumn.bindResultColumnByName(ResultColumn.java:682)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ResultColumnList.bindResultColumnsByName(ResultColumnList.java:635)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ResultSetNode.bindResultColumns(ResultSetNode.java:682)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SelectNode.bindResultColumns(SelectNode.java:751)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.UpdateNode.bind(UpdateNode.java:348)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:344)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepareStorable(GenericStatement.java:591)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.SPSDescriptor.compileStatement(SPSDescriptor.java:353)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.SPSDescriptor.prepareAndRelease(SPSDescriptor.java:283)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.CreateTriggerConstantAction.createSPS(CreateTriggerConstantAction.java:367)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.CreateTriggerConstantAction.executeConstantAction(CreateTriggerConstantAction.java:272)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.MiscResultSet.open(MiscResultSet.java:56)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:357)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1181)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:584)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:516)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:310)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:207)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:173)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:60)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12346595">DERBY-1583</key>
            <summary>With grant revoke enabled, defining a trigger whose actions updates a table (from different schema) results in NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="mamtas">Mamta A. Satoor</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jul 2006 06:59:32 +0100</created>
                <updated>Thu, 13 Dec 2007 09:05:06 +0000</updated>
                            <resolved>Sun, 3 Sep 2006 01:46:18 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12423294" author="yipng" created="Tue, 25 Jul 2006 11:24:43 +0100"  >&lt;p&gt;Hi Mamta, I also hit this problem with one of my testcases, my first hunch is that Derby is not using the cache for table descriptor that was bound but created a new table descriptor from the system table with unbound info therefore causing the NPE.  I think the place to set a breakpoint to verify this is at verifyTargetTable() method of DMLModStatementNode class and see if the targetTableDescriptor return from there is different from the one that got bound.  If I recall correctly, Derby only use the cache to get the table descriptor when it is in compilation mode...  &lt;/p&gt;</comment>
                            <comment id="12423929" author="rhillegas" created="Thu, 27 Jul 2006 22:23:03 +0100"  >&lt;p&gt;Assigning normal priority.&lt;/p&gt;</comment>
                            <comment id="12430185" author="mamtas" created="Thu, 24 Aug 2006 08:19:28 +0100"  >&lt;p&gt;Bryan Pendleton ran existing test altertable.sql with derby.database.sqlAuthorization=true and the test ran into null pointer exceptions. (email thread can be found at &lt;a href=&quot;http://www.nabble.com/derby.database.sqlAuthorization-question----usage-error-or-bug--tf2153778.html#a5949205&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/derby.database.sqlAuthorization-question----usage-error-or-bug--tf2153778.html#a5949205&lt;/a&gt;) &lt;/p&gt;

&lt;p&gt;The stack trace of the first null pointer exception encountered by altertable.sql has similar code path as the stack trace encountered by this jira entry and might be related. I thought I would put this information here for someone who might look into this bug.&lt;/p&gt;</comment>
                            <comment id="12430247" author="rhillegas" created="Thu, 24 Aug 2006 15:13:37 +0100"  >&lt;p&gt;Bumping urgency.&lt;/p&gt;</comment>
                            <comment id="12430787" author="bryanpendleton" created="Sat, 26 Aug 2006 21:11:30 +0100"  >&lt;p&gt;I attached a possible patch for this as a comment to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1754&quot; title=&quot;sqlAuthorization mode causes Null Pointer Exception during ALTER TABLE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1754&quot;&gt;&lt;del&gt;DERBY-1754&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12430794" author="bryanpendleton" created="Sat, 26 Aug 2006 22:14:42 +0100"  >&lt;p&gt;Attached is setTableDescriptor.diff, a patch proposal with a simple test included.&lt;/p&gt;

&lt;p&gt;The patch is the same idea noted as a comment to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1754&quot; title=&quot;sqlAuthorization mode causes Null Pointer Exception during ALTER TABLE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1754&quot;&gt;&lt;del&gt;DERBY-1754&lt;/del&gt;&lt;/a&gt;; namely, to&lt;br/&gt;
set the tableDescriptor into the column descriptor when building the column&lt;br/&gt;
descriptor in SYSCOLUMNSRowFactory.&lt;/p&gt;

&lt;p&gt;Please have a look and tell me what you think.&lt;/p&gt;</comment>
                            <comment id="12430820" author="yipng" created="Sun, 27 Aug 2006 06:13:12 +0100"  >&lt;p&gt;Hi Bryan:&lt;/p&gt;

&lt;p&gt;The setTableDescriptor.diff only contains the svn stat.  &lt;/p&gt;</comment>
                            <comment id="12430821" author="yipng" created="Sun, 27 Aug 2006 07:11:04 +0100"  >&lt;p&gt;I haven&apos;t review Bryan&apos;s patch in details yet (listed in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1754&quot; title=&quot;sqlAuthorization mode causes Null Pointer Exception during ALTER TABLE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1754&quot;&gt;&lt;del&gt;DERBY-1754&lt;/del&gt;&lt;/a&gt;) but after the patch is applied, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1583&quot; title=&quot;With grant revoke enabled, defining a trigger whose actions updates a table (from different schema) results in NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1583&quot;&gt;&lt;del&gt;DERBY-1583&lt;/del&gt;&lt;/a&gt; (this jira) and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; (which also NPE on addRequiredColumnPriv method), the NullPointerException no longer surfaces.&lt;/p&gt;</comment>
                            <comment id="12430822" author="bryanpendleton" created="Sun, 27 Aug 2006 07:43:15 +0100"  >&lt;p&gt;Sorry about the bad attachment, Yip, thanks for catching it.&lt;/p&gt;

&lt;p&gt;Let&apos;s try this again: attaching setTableDescriptor.diff (again), this time with the actual diff.&lt;/p&gt;

&lt;p&gt;Meanwhile, my derbyall run completed, and I did have one failure, so I&apos;ll need to&lt;br/&gt;
investigate this to see if it was caused by the patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;
			&lt;ul&gt;
				&lt;li&gt;
				&lt;ul&gt;
					&lt;li&gt;
					&lt;ul&gt;
						&lt;li&gt;
						&lt;ul&gt;
							&lt;li&gt;
							&lt;ul&gt;
								&lt;li&gt;
								&lt;ul&gt;
									&lt;li&gt;Diff file derbyall/derbylang/update.diff&lt;/li&gt;
								&lt;/ul&gt;
								&lt;/li&gt;
							&lt;/ul&gt;
							&lt;/li&gt;
						&lt;/ul&gt;
						&lt;/li&gt;
					&lt;/ul&gt;
					&lt;/li&gt;
				&lt;/ul&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;Start: update jdk1.4.2_11 derbyall:derbylang 2006-08-26 14:42:38 ***&lt;br/&gt;
587 del&lt;br/&gt;
&amp;lt; ERROR 42X04: Column &apos;DERBY10431.A_COL&apos; is either not in any table in the FROM list or appears within a join specification and is outside the scope of the join specification or appears in a HAVING clause and is not in the GROUP BY list. If this is a CREATE or ALTER TABLE  statement then &apos;DERBY10431.A_COL&apos; is not a column in the target table.&lt;br/&gt;
587a587&lt;br/&gt;
&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
Test Failed.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12430870" author="bryanpendleton" created="Sun, 27 Aug 2006 16:58:31 +0100"  >&lt;p&gt;The update diff looks like a genuine interaction between the patch proposal and&lt;br/&gt;
the checkTableNameAndScrubResultColumns() method of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1043&quot; title=&quot;Invalid column references are not caught in a trigger action statement when the referencing table of the column is the triggered table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1043&quot;&gt;&lt;del&gt;DERBY-1043&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
I&apos;ll need to study the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1043&quot; title=&quot;Invalid column references are not caught in a trigger action statement when the referencing table of the column is the triggered table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1043&quot;&gt;&lt;del&gt;DERBY-1043&lt;/del&gt;&lt;/a&gt; change to understand how these patches interact.&lt;/p&gt;</comment>
                            <comment id="12430979" author="bryanpendleton" created="Mon, 28 Aug 2006 15:05:31 +0100"  >&lt;p&gt;The interaction with the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1043&quot; title=&quot;Invalid column references are not caught in a trigger action statement when the referencing table of the column is the triggered table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1043&quot;&gt;&lt;del&gt;DERBY-1043&lt;/del&gt;&lt;/a&gt; change persuades me that the setTableDescriptor.diff&lt;br/&gt;
proposal is incorrect. Specifically, if you look at ResultColumn.getTableName(), it is clear&lt;br/&gt;
that it is perfectly valid for a ColumnDescriptor to have a null tableDescriptor pointer. The&lt;br/&gt;
case exposed by the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1043&quot; title=&quot;Invalid column references are not caught in a trigger action statement when the referencing table of the column is the triggered table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1043&quot;&gt;&lt;del&gt;DERBY-1043&lt;/del&gt;&lt;/a&gt; tests involves a column reference in the setClause of&lt;br/&gt;
an update statement, where the ResultColumn contains a ColumnReference, but it also&lt;br/&gt;
contains an expression, and the expression is a separate ColumnReference which&lt;br/&gt;
refers to some particular table; it is the table of the expression that is the most important,&lt;br/&gt;
not the table of the column descriptor itself, since the column&apos;s value is to be set with the&lt;br/&gt;
value of the expression.&lt;/p&gt;

&lt;p&gt;Therefore, I shall now pursue a different theory, namely that CompilerContextImpl.&lt;br/&gt;
addRequiredColumnPriv is incorrectly assuming that a ColumnDescriptor will always&lt;br/&gt;
have an underlying TableDescriptor.&lt;/p&gt;

&lt;p&gt;I&apos;ll also add a link from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; to this bug, because they look closely related.&lt;/p&gt;</comment>
                            <comment id="12430997" author="mamtas" created="Mon, 28 Aug 2006 17:09:16 +0100"  >&lt;p&gt;Bryan, looking at the stack track, it seems that we are trying to add a column privilege requirement in the execute phase of create trigger. When I had first encountered this NPE, I vaguely remember that this same colunm requirement was already added during the compile phase of the trigger and hence we might not need to add any privilege requiement at execute phase. I think you will have todo more research to see if theory is good.&lt;/p&gt;</comment>
                            <comment id="12431140" author="bryanpendleton" created="Tue, 29 Aug 2006 05:57:04 +0100"  >&lt;p&gt;Attached is an alternate proposal for a patch to this issue.&lt;br/&gt;
skipAddPriv.diff is based on the idea that if a particular&lt;br/&gt;
ColumnDescriptor has no associated TableDescriptor at the&lt;br/&gt;
time that CompilerContextImpl.addRequiredColumnPriv is&lt;br/&gt;
called, then there is no column privilege that needs to be added.&lt;/p&gt;

&lt;p&gt;This patch passes derbyall, and in particular the update.sql test&lt;br/&gt;
which failed with the previous patch proposal does not fail with&lt;br/&gt;
this patch proposal. Moreover, I successfully tested the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1754&quot; title=&quot;sqlAuthorization mode causes Null Pointer Exception during ALTER TABLE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1754&quot;&gt;&lt;del&gt;DERBY-1754&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
test case as well as the test case for this bug (the test case for&lt;br/&gt;
this bug is included in the diff as a new regression test).&lt;/p&gt;

&lt;p&gt;Please have a look at this patch proposal and let me know what you think.&lt;/p&gt;</comment>
                            <comment id="12431143" author="mamtas" created="Tue, 29 Aug 2006 06:36:00 +0100"  >&lt;p&gt;Bryan, the patch looks good to me. Just couple minor comments&lt;br/&gt;
1)Can you please put a comment for if (td == nulll) check in CompilerContextImpl.addRequiredColumnPriv which says when this if condition will be true and may be reference to this jira entry in that comment?&lt;br/&gt;
2)Also, in the new test case for create trigger with update as trigger action, can you add couple dmls which demonstrates that the trigger gets fired and does what it is expected to do? Then revoke one of the required privileges to show that trigger gets dropped and some dmls after that which will show that the trigger doesn&apos;t fire anymore.&lt;/p&gt;

&lt;p&gt;Thanks for working on this issue&lt;/p&gt;</comment>
                            <comment id="12431247" author="bryanpendleton" created="Tue, 29 Aug 2006 15:15:28 +0100"  >&lt;p&gt;Thanks, Mamta! These are good ideas. I will submit a revised patch.&lt;/p&gt;</comment>
                            <comment id="12431353" author="bryanpendleton" created="Tue, 29 Aug 2006 21:19:44 +0100"  >&lt;p&gt;Attached is skipAddPriv_v2.diff. This patch proposal includes&lt;br/&gt;
improved comments in the code, as well as additional tests.&lt;br/&gt;
The grantRevokeDDL test is enhanced as Mamta suggested,&lt;br/&gt;
to verify that the trigger is operating as we expect it to, and to&lt;br/&gt;
verify that it is revoked as we expect. Also, the test case from&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1754&quot; title=&quot;sqlAuthorization mode causes Null Pointer Exception during ALTER TABLE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1754&quot;&gt;&lt;del&gt;DERBY-1754&lt;/del&gt;&lt;/a&gt; is included as part of this patch proposal.&lt;/p&gt;

&lt;p&gt;derbyall passes with this patch.&lt;/p&gt;

&lt;p&gt;Please let me know your reactions on this patch.&lt;/p&gt;</comment>
                            <comment id="12431363" author="mamtas" created="Tue, 29 Aug 2006 21:37:47 +0100"  >&lt;p&gt;Bryan, thanks for taking care of my comments. I will take a look at the new patch later tonight. &lt;/p&gt;

&lt;p&gt;I wondered though if you could try your patch with the test case attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; runs into NPE when grant is in a transaction. The NPE is in the same method where you added the null check for tabledescriptor and your check might fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt;. &lt;br/&gt;
I haven&apos;t researched into that bug and hence don&apos;t know why the NPE manifests itself only inside a transaction.&lt;/p&gt;</comment>
                            <comment id="12431365" author="bryanpendleton" created="Tue, 29 Aug 2006 21:41:30 +0100"  >&lt;p&gt;I will have a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="12431382" author="bryanpendleton" created="Tue, 29 Aug 2006 22:45:44 +0100"  >&lt;p&gt;Mamta, thanks for the suggestion about &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt;. &lt;br/&gt;
I think it is definitely another manifestation of the same bug.&lt;/p&gt;

&lt;p&gt;Attached is skipAddPriv_v3.diff, which includes the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
test case as part of the grantRevokeDDL.sql tests.&lt;/p&gt;

&lt;p&gt;I ran the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; test case interactively, and without the&lt;br/&gt;
patch I get the NPE, and with the patch I get reasonable results.&lt;/p&gt;

&lt;p&gt;So I think that we can mark &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; as a duplicate of this&lt;br/&gt;
bug, assuming that we decide to proceed with this patch.&lt;/p&gt;

&lt;p&gt;Reviewers, please review skipAddPriv_v3.diff instead of the v2 patch.&lt;/p&gt;</comment>
                            <comment id="12431462" author="mamtas" created="Wed, 30 Aug 2006 05:57:18 +0100"  >&lt;p&gt;I reviewed the patch skipAddPriv_v3.diff and looks like it should do the trick and take care of following 3 NPE bugs&lt;br/&gt;
1)This particular jira entry&lt;br/&gt;
2)&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1754&quot; title=&quot;sqlAuthorization mode causes Null Pointer Exception during ALTER TABLE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1754&quot;&gt;&lt;del&gt;DERBY-1754&lt;/del&gt;&lt;/a&gt; sqlAuthorization mode causes Null Pointer Exception during ALTER TABLE&lt;br/&gt;
3)&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&lt;/p&gt;

&lt;p&gt;If derbyall has run with no new failures, then I think this patch is good to go. Thanks for taking this on, Bryan.&lt;/p&gt;</comment>
                            <comment id="12431473" author="yipng" created="Wed, 30 Aug 2006 06:37:37 +0100"  >&lt;p&gt;Mamta, just curious, why did the NPE occurs in transaction mode in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; but not in autocommit mode?&lt;/p&gt;</comment>
                            <comment id="12431476" author="mamtas" created="Wed, 30 Aug 2006 06:42:18 +0100"  >&lt;p&gt;Yip, I haven&apos;t debugged &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; yet to know why NPE is only in transaction mode. &lt;/p&gt;</comment>
                            <comment id="12431603" author="bryanpendleton" created="Wed, 30 Aug 2006 16:28:07 +0100"  >&lt;p&gt;Thanks Mamta and Yip for the review! I will try to figure out why the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
NPE is related to transaction handling. I probably won&apos;t get to this until this weekend.&lt;br/&gt;
If anybody else figures this out in the meantime, please let us know!&lt;/p&gt;</comment>
                            <comment id="12431891" author="mikem" created="Thu, 31 Aug 2006 15:51:13 +0100"  >&lt;p&gt;I ran a successful run of a full set of tests on XP, sun1.42 jvm.  Committed change to trunk.  &lt;/p&gt;

&lt;p&gt;m3_142:174&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\sql\compile\CompilerContextImpl.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\altertable.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\grantRevokeDDL.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\altertable_derby.properties&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\grantRevokeDDL.sql&lt;br/&gt;
Transmitting file data .....&lt;br/&gt;
Committed revision 438942.&lt;/p&gt;</comment>
                            <comment id="12432260" author="bryanpendleton" created="Sat, 2 Sep 2006 00:52:16 +0100"  >&lt;p&gt;I&apos;m becoming increasingly convinced that the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; behavior is related to whether&lt;br/&gt;
the DataDictionary cache is in DDL mode or in COMPILE mode. This is coupled&lt;br/&gt;
with the fact that ColumnDescriptor objects in the dictionary cache don&apos;t have a&lt;br/&gt;
table descriptor field when they are first loaded; the table descriptor value gets set&lt;br/&gt;
by FromBaseTable.genResultColList. So if a data dictionary cache mode switch&lt;br/&gt;
occurs, which has the side effect of clearing the cache, and then addRequiredColumnPriv&lt;br/&gt;
comes along but there has been no intervening call to FBT.genResultColList, the&lt;br/&gt;
ColumnDescriptor&apos;s TableDescriptor will be null, leading to the NPE.&lt;/p&gt;

&lt;p&gt;I&apos;ll try to work up a more clear and coherent description of all of this processing; this is&lt;br/&gt;
just some rough notes to record what I think I see in the heat of debugging...&lt;/p&gt;</comment>
                            <comment id="12432292" author="bryanpendleton" created="Sat, 2 Sep 2006 17:07:37 +0100"  >&lt;p&gt;I&apos;ve tried to expand upon the rough notes above in the wiki, at&lt;br/&gt;
 &lt;a href=&quot;http://wiki.apache.org/db-derby/DataDictionary&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DataDictionary&lt;/a&gt;&lt;br/&gt;
and&lt;br/&gt;
 &lt;a href=&quot;http://wiki.apache.org/db-derby/DataDictionaryCaching&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DataDictionaryCaching&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please help by correcting any mistakes in those notes and expanding on any unclear sections.&lt;/p&gt;

&lt;p&gt;I&apos;ve satisfied myself that &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; is a duplicate of this bug and that the importance of&lt;br/&gt;
the transaction handling in the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1724&quot; title=&quot;Executing grant statement within a transaction leads to a NPE later when the db owner attempts to update a table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1724&quot;&gt;&lt;del&gt;DERBY-1724&lt;/del&gt;&lt;/a&gt; repro is indeed that it disables the DataDictionary&lt;br/&gt;
cache and hence makes it easier to hit the conditions for this bug.&lt;/p&gt;

&lt;p&gt;I am intending to merge the revision 438942 change (skipAddPriv_v3.diff) to the 10.2 branch today.&lt;/p&gt;

&lt;p&gt;Thanks again to everybody for their continued help on this bug!&lt;/p&gt;</comment>
                            <comment id="12432313" author="bryanpendleton" created="Sun, 3 Sep 2006 01:46:18 +0100"  >&lt;p&gt;Merged the fix to the 10.2 branch and marked the bug as resolved.&lt;/p&gt;

&lt;p&gt;Thanks Mamta and Yip for the reviews; thanks Mike for reviewing and committing to the trunk!&lt;/p&gt;</comment>
                            <comment id="12551381" author="fuzzylogic" created="Thu, 13 Dec 2007 09:05:06 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12345616">DERBY-1489</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12348513">DERBY-1754</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12348205">DERBY-1724</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12312336">DERBY-464</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12339650" name="setTableDescriptor.diff" size="3124" author="bryanpendleton" created="Sun, 27 Aug 2006 07:43:15 +0100"/>
                            <attachment id="12339646" name="setTableDescriptor.diff" size="344" author="bryanpendleton" created="Sat, 26 Aug 2006 22:14:42 +0100"/>
                            <attachment id="12339741" name="skipAddPriv.diff" size="3119" author="bryanpendleton" created="Tue, 29 Aug 2006 05:57:04 +0100"/>
                            <attachment id="12339803" name="skipAddPriv_v2.diff" size="8185" author="bryanpendleton" created="Tue, 29 Aug 2006 21:19:44 +0100"/>
                            <attachment id="12339808" name="skipAddPriv_v3.diff" size="9704" author="bryanpendleton" created="Tue, 29 Aug 2006 22:45:44 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 25 Jul 2006 10:24:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22578</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy104n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39671</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>