<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:21:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1130/DERBY-1130.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1130] Client should not allow databaseName to be set with setConnectionAttributes</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1130</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Per this thread,  setConnectionAttributes should not set databaseName. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/double-check-on-checkDataSource-t1187602.html#a3128621&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/double-check-on-checkDataSource-t1187602.html#a3128621&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Currently this is allowed for client but should be disabled.  I think it is OK to change because we have documented that client will be changed to match embedded for implementation defined behaviour.   Hopefully its use is rare as most folks would use the standard setDatabaseName.  Still there should be a release not when the change is made and it would be better to change it sooner than later:&lt;/p&gt;

&lt;p&gt;Below is the repro. &lt;/p&gt;

&lt;p&gt;Here is the output with Client&lt;br/&gt;
D&amp;gt;java DatabaseNameWithSetConnAttr&lt;br/&gt;
ds.setConnectionAttributes(databaseName=wombat;create=true)&lt;br/&gt;
ds.getDatabaseName() = null (should be null)&lt;br/&gt;
FAIL: Should not have been able to set databaseName with connection attributes&lt;/p&gt;

&lt;p&gt;Also look for tests  disabled with this bug number in the test checkDataSource30.java&lt;/p&gt;



&lt;p&gt;import java.sql.*;&lt;br/&gt;
import java.lang.reflect.Method;&lt;/p&gt;


&lt;p&gt;public class DatabaseNameWithSetConnAttr{&lt;/p&gt;

&lt;p&gt;	public static void main(String[] args) {&lt;br/&gt;
		try &lt;/p&gt;
{
		
			String attributes = &quot;databaseName=wombat;create=true&quot;;
			org.apache.derby.jdbc.ClientDataSource ds = new
			org.apache.derby.jdbc.ClientDataSource();

			//org.apache.derby.jdbc.EmbeddedDataSource ds = new
			//org.apache.derby.jdbc.EmbeddedDataSource();
			System.out.println(&quot;ds.setConnectionAttributes(&quot; + attributes + &quot;)&quot;);
			ds.setConnectionAttributes(attributes);
			System.out.println(&quot;ds.getDatabaseName() = &quot; +
							   ds.getDatabaseName() + &quot; (should be null)&quot; );

			Connection conn  = ds.getConnection();

			}
&lt;p&gt; catch (SQLException e) {&lt;br/&gt;
				String sqlState = e.getSQLState();&lt;br/&gt;
				if (sqlState != null &amp;amp;&amp;amp; sqlState.equals(&quot;XJ041&quot;))&lt;/p&gt;
				{
				System.out.println(&quot;PASS: An exception was thrown trying to get a connetion from a datasource after setting databaseName with setConnectionAttributes&quot;);
				System.out.println(&quot;EXPECTED EXCEPTION: &quot; + e.getSQLState() 
									   + &quot; - &quot; + e.getMessage());
				return;
				}
&lt;p&gt;				while (e != null)&lt;/p&gt;
				{
					System.out.println(&quot;FAIL - UNEXPECTED EXCEPTION: &quot; + e.getSQLState());
					e.printStackTrace();
					e = e.getNextException();
				}
&lt;p&gt;				return;&lt;br/&gt;
			}&lt;br/&gt;
		System.out.println(&quot;FAIL: Should not have been able to set databaseName with connection attributes&quot;);&lt;/p&gt;

&lt;p&gt;	}&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12330479">DERBY-1130</key>
            <summary>Client should not allow databaseName to be set with setConnectionAttributes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="deepa">Deepa Remesh</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Mar 2006 00:27:38 +0000</created>
                <updated>Tue, 30 Jun 2009 17:12:54 +0100</updated>
                            <resolved>Tue, 15 May 2007 20:50:20 +0100</resolved>
                                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.2.1</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12420465" author="deepa" created="Wed, 12 Jul 2006 08:01:47 +0100"  >&lt;p&gt;I would like to understand what the behaviour of client driver should be for the following scenario: &lt;br/&gt;
call getConnection method when no database name is set for the data source (using setDatabaseName method) and we set the database name using setConnectionAttributes method.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Code snippet for EmbeddedDataSource:&lt;br/&gt;
org.apache.derby.jdbc.EmbeddedDataSource ds = new org.apache.derby.jdbc.EmbeddedDataSource();&lt;br/&gt;
ds.setConnectionAttributes(&quot;databaseName=wombat;create=true&quot;);&lt;br/&gt;
Connection conn = ds.getConnection();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case, database name is set to &quot; &quot; and it gets trimmed to a zero-length string. And call to getConnection will give following exception: &lt;br/&gt;
XJ041 - Failed to create database &apos;&apos;, see the next exception for details.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Code snippet for ClientDataSource:&lt;br/&gt;
org.apache.derby.jdbc.ClientDataSource ds = new org.apache.derby.jdbc.ClientDataSource();&lt;br/&gt;
ds.setConnectionAttributes(&quot;databaseName=wombat;create=true&quot;);&lt;br/&gt;
Connection conn = ds.getConnection();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the solution I was thinking for ClientDataSource, I plan to catch the error at the client itself and make the client throw the following exception: &lt;br/&gt;
08001 - Required property databaseName not set. &lt;/p&gt;

&lt;p&gt;Is this solution okay?&lt;/p&gt;</comment>
                            <comment id="12420498" author="kmarsden" created="Wed, 12 Jul 2006 12:14:11 +0100"  >&lt;p&gt;What is the exception for embedded if create=true  is not specified?&lt;br/&gt;
 e.g. ds.setConnectionAttributes(&quot;databaseName=wombat&quot;)&lt;/p&gt;

&lt;p&gt;In general I think that the errors should be the same if it is not a tremendous amount of work to make them  match.  In the case of :&lt;br/&gt;
ds.setConnectionAttributes(&quot;databaseName=wombat;create=true&quot;); &lt;br/&gt;
I would think the client would just remove the databaseName part from the string and send the database name as &quot;create=true&quot;  and get the same error as embedded.&lt;/p&gt;</comment>
                            <comment id="12420626" author="deepa" created="Wed, 12 Jul 2006 22:24:56 +0100"  >&lt;p&gt;For Kathey&apos;s question:  What is the exception for embedded if create=true is not specified? e.g. ds.setConnectionAttributes(&quot;databaseName=wombat&quot;) &lt;br/&gt;
Exception for embedded is: XJ004 - Database &apos;&apos; not found.&lt;/p&gt;

&lt;p&gt;I think we do not have the same SQL state in the client for the above exception. The corresponding SQLState is &quot;08004 - The connection was refused because the database &lt;/p&gt;
{0} was not found.&quot;&lt;br/&gt;
&lt;br/&gt;
As the SQLStates do not match, I was thinking it would be okay to catch the exception at client itself and throw &quot;08001 - Required property databaseName not set. &quot; if database name is not set using setDatabaseName on the client data source. In case the database name is set using setDatabaseName and we try to over-ride it using &quot;databaseName&quot; property in setConnectionAttributes, the over-riding will fail. Only the database name set using setDatabaseName will be used. This was the behaviour in the patch I was working on.&lt;br/&gt;
&lt;br/&gt;
However, if the above exception is confusing, I&apos;ll try to set a dummy database name on the client and send it to server to get back &quot;08004 - The connection was refused because the database {0}
&lt;p&gt; was not found.&quot;. Please share your thoughts on this.&lt;/p&gt;</comment>
                            <comment id="12420895" author="kmarsden" created="Fri, 14 Jul 2006 00:44:14 +0100"  >&lt;p&gt;Your approach sounds ok to me, since the SQL states are already different.&lt;/p&gt;</comment>
                            <comment id="12421731" author="deepa" created="Mon, 17 Jul 2006 22:58:33 +0100"  >&lt;p&gt;Attaching a patch &apos;derby-1130-v1.diff&apos; which ensures that database name set using setConnectionAttributes does not get used by client driver. Changes are:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Appends the attributes in setConnectionAttributes method to database name only if database name has been already set on the data source. Database name is a required property and if it is not set, DataSource.getConnection method will throw the following exception:&lt;br/&gt;
08001 - Required property databaseName not set. &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Without the patch, if database name was not set, the code was using &quot;null&quot; as database name and creating a database named null if  &quot;create=true&quot; is specified or throwing an exception that it cannot connect to database named null.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Adds test to jdbcapi/checkDataSource.java. Adds a new method &quot;testClientDSConnectionAttributes&quot;. As we are testing the methods specific to Derby data sources, we cannot re-use the method used to test embedded data sources.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Ran derbynetclientmats with this patch using Sun jdk 1.4.2 on Windows XP. No failures. Also ran the modified tests jdbcapi/checkDataSource.java and jdbcapi/checkDataSource30.java in embedded mode. Please review/commit this patch. Thanks.&lt;/p&gt;</comment>
                            <comment id="12422212" author="davidvc" created="Wed, 19 Jul 2006 18:59:04 +0100"  >&lt;p&gt;Hi, Deepa.  I looked at the patch, and have a couple of questions/thoughts&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The driving requirement is that you can&apos;t set databaseName as a connection attribute&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think it&apos;s confusing that when someone does try to use connectionAttributes to set the database name, the error they get is &quot;Required property databaseName is not set&quot;.  They&apos;ll scratch their heads and say &quot;doggone it, right here in my code I&apos;m setting it using connectionAttributes!  What the heck am I doing wrong?  Doth mine eyes deceive me?&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not sure exactly how the logic of connection properties is managed in Derby, but this method seems to be working with a data source.  Shouldn&apos;t we just check to see if databaseName is in the attributes string (if connAttrs.contains(&quot;databaseName&quot;)) and raise an exception if it does?  &lt;/p&gt;

&lt;p&gt;I also think it&apos;s problematic that we just ignore the connection attributes if the database name is null.  Shouldn&apos;t we raise an exception at that point saying something like &quot;you can&apos;t set connection attributes for this connection because the database name is not specified&quot; ?&lt;/p&gt;

&lt;p&gt;I actually think the exception on the embedded side similarly is confusing, saying the database is not found.  I would like something that explicitly says something like &quot;you can not set the database name using connection attributes.  Please use setDatabaseName&quot;&lt;/p&gt;

&lt;p&gt;Finally, do we need to fix the client so that it has the same SQL State as the embedded driver when the database is not found?  I think so, perhaps that should be a separate bug.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;David&lt;/p&gt;</comment>
                            <comment id="12422246" author="djd" created="Wed, 19 Jul 2006 21:53:00 +0100"  >&lt;p&gt;David wrote:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think it&apos;s confusing that when someone does try to use connectionAttributes to set the database name, the error they get is &quot;Required property databaseName is not set&quot;. They&apos;ll scratch their heads and say &quot;doggone it, right here in my code I&apos;m setting it using connectionAttributes! What the heck am I doing wrong? Doth mine eyes deceive me?&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    djd&amp;gt; Probably not always clear, but &apos;connectionAttributes&apos;  sets JDBC attributes for the connection and here we have &apos;databaseName&apos; being an &lt;b&gt;attribute&lt;/b&gt; in connectionAttributes and a Java bean &lt;b&gt;property&lt;/b&gt; for the DataSource object. Thus the message is technically correct, the &lt;b&gt;property&lt;/b&gt; has not been set.&lt;/p&gt;

&lt;p&gt;David again:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I actually think the exception on the embedded side similarly is confusing, saying the database is not found. I would like something that explicitly says something like &quot;you can not set the database name using connection attributes. Please use setDatabaseName&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   djd&amp;gt; I think such a mesage needs to be more generic in how the Java bean property databaseName is set rather than stating use setDatabaseName. Most users will not be calling methods against Derby&apos;s DataSourrce implementations, but instead setting fields in a web GUI or modifying configuration files.&lt;/p&gt;

&lt;p&gt;Maybe the solution is to be more specific on the term property, replace with &apos;Derby DataSource property&apos;?&lt;/p&gt;
</comment>
                            <comment id="12422273" author="deepa" created="Wed, 19 Jul 2006 23:08:16 +0100"  >&lt;p&gt;Thanks David and Dan for looking at this issue.&lt;/p&gt;

&lt;p&gt;As David suggests, I think it would be better to throw an exception if database name property is set in setConnectionAttributes method for a DataSource. I think this will make both these cases clearer:&lt;br/&gt;
1. We need to set the &quot;databaseName&quot; Java bean &lt;b&gt;property&lt;/b&gt; for the DataSource object. We cannot expect that the databaseName property in connectionAttributes will get used.&lt;br/&gt;
2. If we have set &quot;databaseName&quot; Java bean &lt;b&gt;property&lt;/b&gt; for the DataSource object, we cannot over-ride it using databaseName property in connection attributes.&lt;/p&gt;

&lt;p&gt;As Dan suggests, use of &quot;Derby DataSource property&quot; in the message may help clarify the situation. However, I tend to think it could still be confusing why the databaseName property in connectionAttributes is not getting used. I plan to change setConnectionAttributes method in both embedded and client data sources to check that &quot;databaseName&quot; property cannot be set using this method. Please let me know if anyone thinks this is not okay.&lt;/p&gt;

&lt;p&gt;David, I did not understand the following comment:&lt;br/&gt;
&quot;&lt;br/&gt;
I also think it&apos;s problematic that we just ignore the connection attributes if the database name is null. Shouldn&apos;t we raise an exception at that point saying something like &quot;you can&apos;t set connection attributes for this connection because the database name is not specified&quot; ? &lt;br/&gt;
&quot;&lt;/p&gt;

&lt;p&gt;Isn&apos;t the check for the databaseName property (which is a required property) enough for this? If this required property is not set, then we will not be able to use the DataSource and will be throwing an exception.&lt;/p&gt;</comment>
                            <comment id="12426299" author="deepa" created="Mon, 7 Aug 2006 20:26:58 +0100"  >&lt;p&gt;Attaching a patch &apos;d1130-client-v1.diff&apos; which disallows databaseName attribute to be set using setConnectionAttributes method in client data sources. Tests added to jdbcapi/checkDataSource.java. &lt;/p&gt;

&lt;p&gt;Ran derbynetclientmats using Sun jdk1.4.2 on Windows XP. No new failures. Please take a look at this patch. If this is okay, I plan to upload another patch to add a similar check for embedded data sources.&lt;/p&gt;
</comment>
                            <comment id="12426671" author="davidvc" created="Tue, 8 Aug 2006 19:28:24 +0100"  >&lt;p&gt;Hi, Deepa.  I apologize, I don&apos;t know how I missed your response on July 19th.  Almost a month later I&apos;m getting back to you.  That&apos;s embarassing.  Thank goodness for the &apos;patch available&apos; report.&lt;/p&gt;

&lt;p&gt;I am not sure how to reach closure on this.  What I am seeing is the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the databaseName property is not set, then we get an exception that makes sense - &quot;Required property databaseName not set&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the databaseName property is not set, but the database name is set through connection attributes, we still get - &quot;Required property databaseName not set.&quot;  Now if I were a naive user this would be confusing - I set the databaseName property, why are you complaining? (Ignorant that I am not allowed to set it via connection attributes.) A much more helpful messages would be &quot;You can not set the databaseName property through connection attributes.  Please set this as a Derby DataSource property&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the databaseName property &lt;b&gt;is&lt;/b&gt; set, everything works right&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the databaseName property &lt;b&gt;is&lt;/b&gt; set &lt;b&gt;and&lt;/b&gt; the databaseName is specified through connection attributes, this is again potentially confusing.  The user sees that they are connecting to or creating database &apos;wombat&apos; when they explicitly set the database name to &apos;kangaroo&apos; (ignorant perhaps that they are setting it to &apos;wombat&apos; elsewhere in their code.  What is that about?  And that is even harder to track down.  Here I think there is value in saying something like &quot;WARNING: property databaseName can not be set through connection attributes.  Using the databaseName property &apos;wombat&apos; that was set through the Derby DataSource.&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;David&lt;/p&gt;</comment>
                            <comment id="12426683" author="deepa" created="Tue, 8 Aug 2006 20:23:57 +0100"  >&lt;p&gt;Thanks David for revisiting this issue. I too got back to this only this week. Yesterday, I uploaded a new patch &apos;d1130-client-v1.diff&apos; for client which disallows databaseName attribute to be set using setConnectionAttributes method in client data sources. Please take a look at the new patch to see if the solution is acceptable. If yes, I&apos;ll upload a similar patch for embedded.&lt;/p&gt;</comment>
                            <comment id="12427318" author="skambha" created="Thu, 10 Aug 2006 20:13:36 +0100"  >&lt;p&gt;Thanks Deepa for the d1130-client-v1 patch.  The patch applies cleanly in my eclipse ide &lt;span class=&quot;error&quot;&gt;&amp;#91;with a fuzz factor of 24 :) &amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&amp;#8211; the error messages that is thrown look good to me and it seems clean that we are doing the check in setConnectionAttributes itself.&lt;/p&gt;

&lt;p&gt;I just have one question. Can you please help me understand why the following change is necessary:&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; java/client/org/apache/derby/jdbc/ClientDataSource.java	(revision 429370)&lt;br/&gt;
@@ -181,7 +181,6 @@&lt;br/&gt;
         try&lt;br/&gt;
         {&lt;br/&gt;
             LogWriter dncLogWriter = super.computeDncLogWriterForNewConnection(&quot;_sds&quot;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;updateDataSourceValues(tokenizeAttributes(getConnectionAttributes(), null));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-----------&lt;br/&gt;
Thanks,&lt;br/&gt;
Sunitha.&lt;/p&gt;</comment>
                            <comment id="12427330" author="deepa" created="Thu, 10 Aug 2006 20:45:23 +0100"  >&lt;p&gt;Thanks Sunitha for looking at the patch.  &lt;/p&gt;

&lt;p&gt;I moved updateDataSourceValues method call from getConnection to setConnectionAttributes method. This method looks at the connectionAttributes and updates the fields relevant to client datasource. I have added the check for databaseName attribute to this method. Calling this earlier from setConnectionAttributes allows to throw an exception from here itself. Hope this answers the question.&lt;/p&gt;

</comment>
                            <comment id="12427337" author="skambha" created="Thu, 10 Aug 2006 21:13:30 +0100"  >&lt;p&gt;Thats makes sense. Thanks Deepa for the explanation.  &lt;br/&gt;
The patch (d1130-client-v1.patch) looks good to me.  My +1 for commit. &lt;/p&gt;</comment>
                            <comment id="12427407" author="kmarsden" created="Fri, 11 Aug 2006 04:37:43 +0100"  >&lt;p&gt;Thanks Deepa for the patch and Sunitha for the review.&lt;/p&gt;

&lt;p&gt;I checked in the patch for this issue.  I marked Existing Application impact because some existing applications may be trying to set the databaseName this way and hit issues upgrading to 10.2.  Can you add a release note?&lt;/p&gt;


&lt;p&gt;Date: Thu Aug 10 20:34:22 2006&lt;br/&gt;
New Revision: 430641&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=430641&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=430641&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1130&quot; title=&quot;Client should not allow databaseName to be set with setConnectionAttributes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1130&quot;&gt;&lt;del&gt;DERBY-1130&lt;/del&gt;&lt;/a&gt; Client should not allow databaseName to be set with setConnectionAttributes&lt;/p&gt;

&lt;p&gt;Attaching a patch &apos;d1130-client-v1.diff&apos; which disallows databaseName attribute to be set using setConnectionAttributes method in client data sources. Tests added to jdbcapi/checkDataSource.java.&lt;/p&gt;

</comment>
                            <comment id="12427546" author="davidvc" created="Fri, 11 Aug 2006 16:49:18 +0100"  >&lt;p&gt;Somehow again I missed your comments, Deepa.  Thanks for making the change, it looks good.  A small improvement might be if the databaseName property is null in the DataSource and databaseName is set in connectionAttributes, to raise the exception &quot;databaseName attribute cannot be set using the DataSource method setConnectionAttributes&quot; rather than &quot;required property databaseName not set.&quot; &amp;#8211; e.g. to give the former exception precedence.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;David&lt;/p&gt;</comment>
                            <comment id="12427551" author="deepa" created="Fri, 11 Aug 2006 17:36:31 +0100"  >&lt;p&gt;Thanks Sunitha, Kathey and David for looking at the patch. &lt;/p&gt;

&lt;p&gt;I noticed this patch is causing a failure in jdbcapi/dataSourceReference.java. Sorry about that. I had only run derbynetclientmats before submitting the patch as this was a client-only change. But found that client data sources are also tested in jdbcapi/dataSourceReference.java which is run only in embedded framework. I am attaching a patch &apos;d1130-test-dataSourceReference.diff&apos; which modifies dataSourceReference test to resolve this failure. The failure was because we now check the connection attributes in the call to setConnectionAttributes itself. Before the patch, this check was deferred to getConnection method. The patch only modifies this test and I checked that the test passes with it. Please take a look and commit if okay.&lt;/p&gt;

&lt;p&gt;For David&apos;s suggestion, &quot;if the databaseName property is null in the DataSource and databaseName is set in connectionAttributes, to raise the exception &quot;databaseName attribute cannot be set using the DataSource method setConnectionAttributes&quot; rather than &quot;required property databaseName not set.&quot; &amp;#8211; e.g. to give the former exception precedence.&quot;&lt;/p&gt;

&lt;p&gt;If I understand correctly, this is already being handled as David suggests. This is tested in jdbcapi/checkDataSource.java in &apos;&quot;testClientDSConnectionAttributes&quot; method.&lt;/p&gt;

&lt;p&gt;Kathey, I will post a release note for this. &lt;/p&gt;</comment>
                            <comment id="12427567" author="kmarsden" created="Fri, 11 Aug 2006 18:48:51 +0100"  >&lt;p&gt;I will  commit the test patch to get the test running again, but  it seems problematic to me that the client jar is required to run the embeded tests or derby.jar is required for client tests.  Perhaps another issue should be filed for that for the test.&lt;/p&gt;
</comment>
                            <comment id="12427578" author="djd" created="Fri, 11 Aug 2006 19:32:38 +0100"  >&lt;p&gt;With this change the setConnectionAttributes method now is declared to throw a SQLException.&lt;/p&gt;

&lt;p&gt;I thought such methods should not throw exceptions since it is a Java Bean property setter method.&lt;/p&gt;

&lt;p&gt;The suggestion above that this  method throw an exception if databaseName  has not been set but is set  with setConnectionAttributes is invalid.&lt;br/&gt;
Since DataSource properties may be set from a configuration file, the data source should not impose any ordering on the setting of the properties.&lt;/p&gt;

&lt;p&gt;I think typically any exception would be raised when a connection is requested.&lt;/p&gt;

&lt;p&gt;Also for any error text, it&apos;s clearer if the usage refers to setting the property connectionAttributes rather than instructions to use (or not use) setConnectionAttributes (the setter methods). Most configuration of these data sources is through gui&apos;s and sets of properties not through Java code directly.&lt;/p&gt;</comment>
                            <comment id="12427579" author="djd" created="Fri, 11 Aug 2006 19:35:43 +0100"  >&lt;p&gt;Also throwing SQLException on setConnectionAttributes is a regression from 10.1 and may cause applications to break, since previously this method did not throw the exception.&lt;/p&gt;</comment>
                            <comment id="12427597" author="deepa" created="Fri, 11 Aug 2006 20:33:06 +0100"  >&lt;p&gt;I was going to post a release note about the existing application impact. But based on what Dan just said, this change in the method does not look correct and maybe we need to revert it. Any thoughts on this? Other options I can think of are:&lt;/p&gt;

&lt;p&gt;1) Move the check of connectionAttributes into getConnection method. This way we throw the exception(that we cannot set databaseName attribute on a data source) when getConnection is called. &lt;/p&gt;

&lt;p&gt;2)  Go back to the first solution (derby-1130-v1.diff) which just ensures that database name set using setConnectionAttributes does not get used by client driver. This is more like what is being done in embedded driver , i.e, we just ignore the databaseName attribute. Also, modify the error message to explicitly indicate &quot;Derby datasource property&quot; and thus differentiate it from databaseName &quot;attribute&quot;.&lt;/p&gt;

&lt;p&gt;3) other options ?&lt;/p&gt;

&lt;p&gt;Please provide feedback about how to proceed on this issue. Thanks.&lt;/p&gt;</comment>
                            <comment id="12427600" author="davidvc" created="Fri, 11 Aug 2006 20:40:08 +0100"  >&lt;p&gt;Option 2 looks good to me if it&apos;s feasible.&lt;/p&gt;</comment>
                            <comment id="12427606" author="deepa" created="Fri, 11 Aug 2006 20:53:36 +0100"  >&lt;p&gt;As the current solution does not seem to be okay, can a committer please revert this change (svn revision# 430641)?&lt;/p&gt;

&lt;p&gt;Also, I have unchecked patch available as there is no need to commit the test patch &apos;d1130-test-dataSourceReference.diff&apos;. I will upload a revised patch based on option 2 in some time.&lt;/p&gt;</comment>
                            <comment id="12427624" author="kmarsden" created="Fri, 11 Aug 2006 21:58:51 +0100"  >&lt;p&gt;I Backed out the change. I didn&apos;t see David&apos;s mail right away.&lt;/p&gt;

&lt;p&gt;Thanks Dan for catching this. It is good to have many, many eyes on the code and always could use two more before and after commit.&lt;/p&gt;

&lt;p&gt;Date: Fri Aug 11 13:50:29 2006&lt;br/&gt;
New Revision: 430891&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=430891&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=430891&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12427626" author="djd" created="Fri, 11 Aug 2006 22:03:31 +0100"  >&lt;p&gt;Does it need to be backed out of the 10.2 branch, maybe not now, but at some point once the branch has stablized.&lt;br/&gt;
Or would the change to trunk just be merged up to 10.2?&lt;/p&gt;</comment>
                            <comment id="12427725" author="deepa" created="Sat, 12 Aug 2006 21:53:35 +0100"  >&lt;p&gt;Attaching a patch &apos;d1130-v2.diff&apos; which ensures that database name set using setConnectionAttributes does not get used by client data sources. Changes are:&lt;/p&gt;

&lt;p&gt;1) Appends the attributes in setConnectionAttributes method to database name only if database name has been already set on the data source. This will handle both these cases successfully:&lt;/p&gt;

&lt;p&gt;a) When database name is not set as a DataSource property - In this case, if we pass in database name as a connection attribute, it will not get used. databaseName is a required Derby DataSource property. If it is not set, we cannot get a connection using the DataSource. It will fail with the following exception: &lt;br/&gt;
08001 - Required Derby DataSource property databaseName not set.&lt;br/&gt;
So, there is no need to append the connectionAttributes to the database name variable if databaseName DataSource property is not set. This way, we can avoid using database name in case it is passed in as a connection attribute.  &lt;/p&gt;

&lt;p&gt;Without the patch, if database name was not set, the code was using &quot;null&quot; as database name and creating a database named null if &quot;create=true&quot; is specified or throwing an exception that it cannot connect to database named null.&lt;/p&gt;

&lt;p&gt;b) When database name is set as a DataSource property - In this case, if we pass in database name as a connection attribute, it will not be used. This is because database name set as DataSource property will over-ride it. This case is correctly handled (even without the patch).&lt;/p&gt;

&lt;p&gt;2) The exception message is changed to indicate we are referring to &quot;Derby DataSource&quot; property:&lt;br/&gt;
08001 - Required Derby DataSource property databaseName not set.&lt;/p&gt;

&lt;p&gt;3) Adds test to jdbcapi/checkDataSource.java. Adds a new method &quot;testClientDSConnectionAttributes&quot; which is run only in client framework. Modifies master files.&lt;/p&gt;

&lt;p&gt;Ran derbyall with this patch using Sun jdk 1.4.2 on Windows XP. No new failures. (6 failures also seen in tinderbox tests). Please take a look at this patch. Thanks.&lt;/p&gt;</comment>
                            <comment id="12428520" author="deepa" created="Wed, 16 Aug 2006 22:40:15 +0100"  >&lt;p&gt;Marking patch&apos;d1130-v2.diff&apos; available for review/commit.&lt;/p&gt;</comment>
                            <comment id="12431031" author="davidvc" created="Mon, 28 Aug 2006 19:35:03 +0100"  >&lt;p&gt;+1, this looks good, thanks for everyone&apos;s effort on this.&lt;/p&gt;</comment>
                            <comment id="12431055" author="mikem" created="Mon, 28 Aug 2006 21:18:45 +0100"  >&lt;p&gt;thanks for the review david, I&apos;ll run the tests and commit if they pass.  If anyone else is going to review let me know.&lt;/p&gt;</comment>
                            <comment id="12431298" author="mikem" created="Tue, 29 Aug 2006 18:24:37 +0100"  >&lt;p&gt;Committed to trunk, thanks for the review David.  I ran full set of tests against sun 1.4.2 jvm on XP.&lt;/p&gt;

&lt;p&gt;m3_142:1&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\client\org\apache\derby\client\am\Connection.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\loc\messages_en.properties&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\DerbyNetClient\checkDataSource.out&lt;br/&gt;
Sending     java\testing\org\apache\derbyTesting\functionTests\master\DerbyNetClient\checkDataSource30.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\jdbcapi\checkDataSource.java&lt;br/&gt;
Transmitting file data .....&lt;br/&gt;
Committed revision 438122.&lt;/p&gt;</comment>
                            <comment id="12432219" author="mikem" created="Fri, 1 Sep 2006 20:52:49 +0100"  >&lt;p&gt;patch merged to 10.2 as part of &quot;mega-merge&quot; change 439370&lt;/p&gt;</comment>
                            <comment id="12432244" author="deepa" created="Fri, 1 Sep 2006 22:17:50 +0100"  >&lt;p&gt;Verified the fix is in trunk (10.3) and 10.2 branch.&lt;/p&gt;

&lt;p&gt;Here is the release note for this issue:&lt;/p&gt;

&lt;p&gt;PROBLEM:&lt;/p&gt;

&lt;p&gt;Derby&apos;s client DataSources were using a wrong database name when getting a connection in the following case:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;databaseName is not set as a Derby DataSource property&lt;/li&gt;
	&lt;li&gt;databaseName is set as a connection attribute using setConnectionAttributes method&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;SYMPTOM:&lt;/p&gt;

&lt;p&gt;Instead of throwing an exception saying databaseName is a required Derby DataSource property and must be set, client driver was using &quot;null&quot; as database name and returning a connection to database named &quot;null&quot;.&lt;/p&gt;

&lt;p&gt;CAUSE:&lt;/p&gt;

&lt;p&gt;The database name was constructed wrongly in the client driver.&lt;/p&gt;

&lt;p&gt;SOLUTION:&lt;/p&gt;

&lt;p&gt;This was solved by setting the internal database name property in the client driver correctly. Also ensured that databaseName set as a connection attribute will not be used by Derby&apos;s client DataSources.. This fix will be available in Derby versions 10.2 and above.&lt;/p&gt;

&lt;p&gt;WORKAROUND:&lt;/p&gt;

&lt;p&gt;If using release prior to version 10.2, make sure database name is set only as a DataSource property when using Derby&apos;s client DataSources. &lt;/p&gt;</comment>
                            <comment id="12496101" author="rhillegas" created="Tue, 15 May 2007 20:47:28 +0100"  >&lt;p&gt;Re-opening the issue to remove 10.3 from the &quot;fix in&quot; list. It should be assumed that this fix appears in all releases after 10.2. Marking this as &quot;fix in&quot; 10.3 causes the 10.3 release notes to describe a larger delta than the delta from 10.2.&lt;/p&gt;</comment>
                            <comment id="12496103" author="rhillegas" created="Tue, 15 May 2007 20:49:50 +0100"  >&lt;p&gt;This issue was fixed in 10.2. Adjusting the &quot;fix in&quot; field to note that the issue was fixed in 10.2 and it may just be assumed that it is fixed in 10.3 and later releases.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12338310" name="d1130-client-v1.diff" size="15674" author="deepa" created="Mon, 7 Aug 2006 20:26:58 +0100"/>
                            <attachment id="12338311" name="d1130-client-v1.status" size="665" author="deepa" created="Mon, 7 Aug 2006 20:26:58 +0100"/>
                            <attachment id="12338710" name="d1130-test-dataSourceReference.diff" size="11089" author="deepa" created="Fri, 11 Aug 2006 17:36:31 +0100"/>
                            <attachment id="12338711" name="d1130-test-dataSourceReference.status" size="284" author="deepa" created="Fri, 11 Aug 2006 17:36:31 +0100"/>
                            <attachment id="12338752" name="d1130-v2.diff" size="23407" author="deepa" created="Sat, 12 Aug 2006 21:53:35 +0100"/>
                            <attachment id="12338753" name="d1130-v2.status" size="521" author="deepa" created="Sat, 12 Aug 2006 21:53:35 +0100"/>
                            <attachment id="12337063" name="derby-1130-v1.diff" size="20946" author="deepa" created="Mon, 17 Jul 2006 22:58:33 +0100"/>
                            <attachment id="12337064" name="derby-1130-v1.status" size="457" author="deepa" created="Mon, 17 Jul 2006 22:58:33 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 12 Jul 2006 07:01:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0udj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38739</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>