<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:54:45 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3214/DERBY-3214.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3214] Optimizer can see negative cost estimates when pulling Optimizables from the join order.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3214</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When iterating through join order permutations for a query the optimizer places &quot;Optimizables&quot; (FromTables) into a join order, estimates the cost, then &quot;pulls&quot; Optimizables out of the join order and re-places them in different positions.  For details see:&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://wiki.apache.org/db-derby/JoinOrderPermutations&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/JoinOrderPermutations&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As optimizables are added to the join order the optimizer keeps track of the accumulated cost estimate for the join order.  Then when an Optimizable is removed (&quot;pulled&quot;) from the join order, the optimizer substracts that Optimizable&apos;s cost from the total accumulated cost.&lt;/p&gt;

&lt;p&gt;In certain cases (esp. with very large queries) it&apos;s possible that the cost for some Optimizable OPT_A is so large that adding it to the accumulated cost of the join order leads to loss of the previous sum.  This happens due to normal Java addition of double values, see &quot;doubleAdd.java&quot; attached.&lt;/p&gt;

&lt;p&gt;As an example, assume our current join order is:&lt;/p&gt;

  { OPT_0, OPT_1, -- }&lt;br/&gt;
&lt;br/&gt;
and that the estimated costs for OPT_0 and OPT_1 are 700 and 800, respectively.  The accumulated cost for OPT_0 and OPT_1 is then 700 + 800 = 1500.  Then assume we place OPT_A into the final position in the join order:&lt;br/&gt;
&lt;br/&gt;
  { OPT_0, OPT_1, OPT_A }&lt;br/&gt;
&lt;br/&gt;
If the cost of OPT_A is something that is orders of magnitude larger than 1500, then by adding it to 1500 we will effectively &quot;lose&quot; the 1500.  Let&apos;s say the cost of OPT_A is estimated to be 3.14E50 (which is actually possible, esp. as a result of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1905&quot; title=&quot;Optimizer cost estimates for subqueries are way (way) too high.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1905&quot;&gt;DERBY-1905&lt;/a&gt;).  The size of OPT_A&apos;s cost makes the cost of OPT_0 + OPT_1 insignificant when using Java doubles (see attached doubleAdd.java):&lt;br/&gt;
&lt;br/&gt;
  1500 + 3.14E50 = 3.14E50&lt;br/&gt;
&lt;br/&gt;
So the total accumulated cost for the join order is now 3.14E50.  Later, when we go to pull OPT_A from the join order, we&apos;ll subtract its cost from the accumulated cost, yielding:&lt;br/&gt;
&lt;br/&gt;
  3.14E50 - 3.14E50 = 0&lt;br/&gt;
&lt;br/&gt;
Notice how the accumulated cost, which is supposed to represent the cost of OPT_0 plus the cost of OPT_1, is now ZERO.  And our join order goes back to:&lt;br/&gt;
&lt;br/&gt;
  { OPT_0, OPT_1, -- }

&lt;p&gt;Next we pull OPT_1 from the join order, which means we have to subtract it&apos;s cost from the accumulated cost:&lt;/p&gt;

&lt;p&gt;  0 - 800 = -800&lt;/p&gt;

&lt;p&gt;So we end up with a negative accumulated cost, which is WRONG. (Actually, the ZERO accumulated cost in the previous step was wrong; this is just a side effect).&lt;/p&gt;

&lt;p&gt;As it turns out, there is code in OptimizerImpl that tries to account for negative costs when the negative value comes from normal imprecise arithmetic.  In particular we see the following in the code that pulls Optimizables:&lt;/p&gt;

&lt;p&gt;    double newCost = currentCost.getEstimatedCost();&lt;br/&gt;
    if (pullCostEstimate != null)&lt;/p&gt;
    {
        pullCost = pullCostEstimate.getEstimatedCost();
        newCost -= pullCost;

        /*
         ** It&apos;s possible for newCost to go negative here due to
         ** loss of precision.
         */
         if (newCost &amp;lt; 0.0)
             newCost = 0.0;

        ...
    }

&lt;p&gt;This code hides the error mentioned above because when it sees &quot;-800&quot; it assumes that the negative stems from normal loss of precision.  So the cost for the plan is incorrectly set to &quot;0&quot;, which makes it cheaper than any other plan thus far (and probably cheaper than anything to come), and therefore the optimizer will probably choose the wrong plan.&lt;/p&gt;

&lt;p&gt;I think the check for negative newCost is only valid if the join position that we&apos;re pulling is 0-&lt;del&gt;i.e. if we just pulled the first optimizable in the join order.  In that case the accumulated cost &lt;b&gt;should&lt;/b&gt; be zero, so checking for a negative value and setting it to zero is fine&lt;/del&gt;-we&apos;re just accounting for the loss of precision that is mentioned in the current code comments.&lt;/p&gt;

&lt;p&gt;Note that the same issue also exists for &quot;sort avoidance costs&quot;, but in that code there is (currently) no check for negative costs.  So if a situation as described above occurs in the current code when the cost of OPT_A is for a sort avoidance plan, the code will throw an ASSERTION failure because the cost should be non-negative.&lt;/p&gt;

&lt;p&gt;I noticed this behavior somewhat accidentally while testing out a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3023&quot; title=&quot;Different result rows depending on the sequence of INNER JOIN and OUTER JOIN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3023&quot;&gt;&lt;del&gt;DERBY-3023&lt;/del&gt;&lt;/a&gt;: with my attempted fix applied, the query &quot;new-style-sql.txt&quot; was failing with an ASSERTION failure due to the negative cost estimate.  Hence this jira.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12382731">DERBY-3214</key>
            <summary>Optimizer can see negative cost estimates when pulling Optimizables from the join order.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Sun, 18 Nov 2007 01:36:20 +0000</created>
                <updated>Thu, 13 Jun 2013 22:41:15 +0100</updated>
                            <resolved>Wed, 12 Dec 2007 16:19:31 +0000</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12543328" author="army" created="Sun, 18 Nov 2007 01:38:36 +0000"  >&lt;p&gt;Attaching a quick patch, d3214_notTested_v1.patch, to &quot;recover&quot; the lost sum and avoid negative cost estimates.  I have &lt;b&gt;not&lt;/b&gt; run regression tests on this yet, I&apos;m just posting a quick fix that resolved for the problem for me while I was looking at &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3023&quot; title=&quot;Different result rows depending on the sequence of INNER JOIN and OUTER JOIN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3023&quot;&gt;&lt;del&gt;DERBY-3023&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12549161" author="army" created="Thu, 6 Dec 2007 20:00:34 +0000"  >&lt;p&gt;I ran suites.All and derbyall with d3214_notTested_v1.patch applied and there were no failures.  So I&apos;m re-attaching the patch with &quot;notTested&quot; removed from its name.&lt;/p&gt;</comment>
                            <comment id="12549210" author="thomanie" created="Thu, 6 Dec 2007 22:09:26 +0000"  >&lt;p&gt;A B, your patch looks good from what I can tell.&lt;br/&gt;
I&apos;ve started suites.All but don&apos;t expect any problems from this patch. &lt;/p&gt;</comment>
                            <comment id="12549466" author="army" created="Fri, 7 Dec 2007 16:35:43 +0000"  >&lt;p&gt;Thank you for taking the time to look at the patch, Thomas.  Did suites.All run cleanly for you with the patch applied?&lt;/p&gt;</comment>
                            <comment id="12549472" author="thomanie" created="Fri, 7 Dec 2007 16:50:56 +0000"  >&lt;p&gt;My suites.All did show some errors, but I haven&apos;t had the time to investigate wether it&apos;s related to your patch or not as of now. &lt;/p&gt;</comment>
                            <comment id="12549725" author="thomanie" created="Sat, 8 Dec 2007 17:08:58 +0000"  >&lt;p&gt;I get the same errors both with and without your patch A B, so it most likely not related. Since your tests passed without issues, I&apos;m +1 for commit.&lt;/p&gt;</comment>
                            <comment id="12551012" author="army" created="Wed, 12 Dec 2007 16:18:29 +0000"  >&lt;p&gt;Thank you for the review, Thomas.  I committed the patch to trunk with svn # 603659:&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://svn.apache.org/viewvc?rev=603659&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=603659&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12551013" author="army" created="Wed, 12 Dec 2007 16:19:31 +0000"  >&lt;p&gt;Marking as resolved.  Will wait a few days to see if any issues arise in the tinderbox runs before closing.&lt;/p&gt;</comment>
                            <comment id="12552139" author="army" created="Sat, 15 Dec 2007 20:52:11 +0000"  >&lt;p&gt;There was a glitch in the first patch: when recovering the cost for the sort avoidance plan, we need to look at the sort avoidance costs (not the default &quot;best access&quot; costs).  Attaching d3214_followup_1.patch, which I committed with svn # 604513:&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://svn.apache.org/viewvc?rev=604513&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=604513&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12562132" author="army" created="Thu, 24 Jan 2008 17:08:59 +0000"  >&lt;p&gt;I just noticed that this patch was not ported to 10.3, even though the issue that exposes it (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3023&quot; title=&quot;Different result rows depending on the sequence of INNER JOIN and OUTER JOIN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3023&quot;&gt;&lt;del&gt;DERBY-3023&lt;/del&gt;&lt;/a&gt;) was.  I merged the changes without problem and am now running the tests.  If all goes well, I plan to commit to 10.3 later today.&lt;/p&gt;</comment>
                            <comment id="12562293" author="army" created="Thu, 24 Jan 2008 23:20:43 +0000"  >&lt;p&gt;derbyall and suites.All ran cleanly with this patch using 10.3 jars and ibm142.  So I committed the changes to 10.3 with svn # 615076:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=615076&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=615076&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Adding 10.3 to the Fix In list.  If no problems arise in 10.3 tinderbox over the next couple of days, I plan to close this issue.&lt;/p&gt;</comment>
                            <comment id="12564397" author="army" created="Thu, 31 Jan 2008 16:40:03 +0000"  >&lt;p&gt;No apparent issues after port to 10.3, as tinderbox and daily test results for 10.3 have been clean for several days now.  So I&apos;m closing the issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12352101">DERBY-1905</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12362359">DERBY-2308</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12371736" name="d3214_followup_1.patch" size="1634" author="army" created="Sat, 15 Dec 2007 20:52:11 +0000"/>
                            <attachment id="12371171" name="d3214_v1.patch" size="3250" author="army" created="Thu, 6 Dec 2007 20:00:27 +0000"/>
                            <attachment id="12369736" name="doubleAdd.java" size="980" author="army" created="Sun, 18 Nov 2007 01:38:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 Dec 2007 22:09:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23496</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0zin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39572</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>