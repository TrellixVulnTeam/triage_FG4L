<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:45:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5792/DERBY-5792.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5792] Make it possible to turn off encryption on an already encrypted database.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5792</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Currently, you can encrypt an unencrypted database and you can change the encryption key on an already encrypted database. However, Derby does not expose a way to turn off (unencrypt) an already encrypted database.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12558594">DERBY-5792</key>
            <summary>Make it possible to turn off encryption on an already encrypted database.</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 May 2012 14:42:08 +0100</created>
                <updated>Fri, 14 Jun 2013 20:18:55 +0100</updated>
                            <resolved>Fri, 14 Jun 2013 20:18:49 +0100</resolved>
                                    <version>10.10.1.1</version>
                                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>JDBC</component>
                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                            <comments>
                            <comment id="13451949" author="kristwaa" created="Mon, 10 Sep 2012 14:13:51 +0100"  >&lt;p&gt;I&apos;m looking at implementing this feature.&lt;/p&gt;

&lt;p&gt;Patch 1a re-formats and changes the documentation for RawStore.configureDatabaseForEncryption. Except for one paragraph the content is kept mostly unchanged. The comment is converted to JavaDoc, and the method is made private.&lt;/p&gt;

&lt;p&gt;I expect that the documentation will be partly rewritten again as the decryption feature is implemented.&lt;/p&gt;</comment>
                            <comment id="13457609" author="kristwaa" created="Tue, 18 Sep 2012 06:25:58 +0100"  >&lt;p&gt;I decided to delete the patch, as I&apos;m changing strategy. I will first implement the changes required to support decryption, and then change existing comments and documentation as required. There are many occurrences where existing text must be changed to mention both encryption and decryption.&lt;br/&gt;
As for implementing the feature, I now have a working prototype. I have tests almost ready for:&lt;br/&gt;
 o decryption&lt;br/&gt;
 o decryption on un-encrypted database&lt;br/&gt;
 o decryption of booted database&lt;br/&gt;
 o DBO requirement (following existing rules on this topic)&lt;br/&gt;
 o conflicting attributes (may have to change, see below)&lt;/p&gt;

&lt;p&gt;Missing tests:&lt;br/&gt;
 o feature disabled on older databases&lt;br/&gt;
 o connecting while decrypting? (I&apos;m hoping this is dealt with already, testing may be a bit awkward)&lt;/p&gt;


&lt;p&gt;I&apos;m wondering how to best control the feature. There are two main possibilities:&lt;br/&gt;
 a) Add a new URL attribute (decryptDatabase=true).&lt;br/&gt;
 b) Reuse an existing URL attribute (dataEncryption=false?)&lt;/p&gt;

&lt;p&gt;Option (b) is possible, but may be confusing. Using a binary value, one must also take care to distinguish between false and unspecified.&lt;br/&gt;
Another possibility for (a) is &quot;dataDecryption&quot; to keep it similar to &quot;dataEncryption&quot;. That doesn&apos;t sound as good to me, since decryption in this sense is a one-time operation, but maybe the similarity is reason good enough?&lt;/p&gt;

&lt;p&gt;Any opinions on the choice of URL attribute?&lt;/p&gt;</comment>
                            <comment id="13457878" author="kristwaa" created="Tue, 18 Sep 2012 16:07:24 +0100"  >&lt;p&gt;Attaching patch 1a (second round), which makes a series of boilerplate changes and does some cleanup. Again, this patch shouldn&apos;t cause any functional changes.&lt;/p&gt;

&lt;p&gt;Description:&lt;br/&gt;
 o DataFactory.setDatabaseEncrypted: introduced boolean flag to be able to tell the data factory that encryption has been turned off&lt;br/&gt;
   Updated implementing method in BaseDataFileFactory&lt;br/&gt;
 o setDatabaseEncrypted: introduced second boolean flag to be able to tell the log factory that encryption has been turned off&lt;br/&gt;
   Updated implementing methods in LogToFile and ReadOnly.&lt;br/&gt;
 o RawContainerHandle.encryptContainer: renamed to encryptOrDecryptContainer, added boolean flag to control crypto operation&lt;br/&gt;
   Updated implementing method in BaseContainerHandle&lt;br/&gt;
 o BaseContainer.encryptContainer: renamed to encryptOrDecryptContainer, added boolean flag to control crypto operation&lt;br/&gt;
   Updated implementing methods in RAFContainer and InputStreamContainer&lt;br/&gt;
 o EncryptData: renamed to EncryptOrDecryptData, added method decryptAllContainers, whitespace changes&lt;br/&gt;
 o RawStore:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removed import&lt;/li&gt;
	&lt;li&gt;removed instance variable encryptDatabase&lt;/li&gt;
	&lt;li&gt;removed unused instance variable dataDirectory&lt;/li&gt;
	&lt;li&gt;renamed databaseEncrypted to databaseIsEncrypted&lt;/li&gt;
	&lt;li&gt;renamed configureDatabaseForEncryption to applyBulkCryptoOperation&lt;/li&gt;
	&lt;li&gt;made setupEncryptionEngines return a boolean: whether or not existing data must be transformed (applyBulkCryptoOperation)&lt;/li&gt;
	&lt;li&gt;simplified parts of the logic in setupEncryptionEngines&lt;/li&gt;
	&lt;li&gt;introduced isTrue/isSet for property sets&lt;/li&gt;
	&lt;li&gt;removed unused method privList(File)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Patch ready for review.&lt;br/&gt;
Re-running regression tests.&lt;/p&gt;</comment>
                            <comment id="13457897" author="chaase3" created="Tue, 18 Sep 2012 16:53:22 +0100"  >&lt;p&gt;I agree that using &quot;dataEncryption=false&quot; would create confusion &amp;#8211; currently that does seem to mean the same thing as not specifying anything, though it&apos;s not documented. Also, I think it might make more sense to use &quot;decryptDatabase=true&quot; than to use &quot;dataDecryption=true&quot;. If the decryption attribute is very different from the encryption one, people will be less likely to specify the wrong attribute by accident.&lt;/p&gt;

&lt;p&gt;The one-time operation point seems a bit less compelling, if my guess (just a guess) is correct that &quot;dataEncryption=true&quot; is also a one-time operation? Or can you re-encrypt an encrypted database, changing from, say, one encryption algorithm to another? Would that work, or would it totally mess up your database? Anyway, I think reducing the possibility of confusion is desirable.&lt;/p&gt;

&lt;p&gt;The docs say, &quot;The dataEncryption attribute must be combined with the bootPassword=key attribute or the newEncryptionKey=key attribute.&quot; But what it should say is &quot;The dataEncryption=true attribute must be combined ...&quot; It might also make sense to document the meaning of &quot;false&quot; explicitly. (If I specify false, I don&apos;t get an error message if I don&apos;t specify a key.)&lt;/p&gt;

&lt;p&gt;I&apos;m finding various issues with the encryption documentation as I poke through it &amp;#8211; for example, the &quot;encryptionAlgorithm&quot; topic doesn&apos;t say that you can use that attribute in combination with the &quot;encryptionKey&quot; one, though the &quot;encryptionKey&quot; topic has an example showing exactly that. Also, the Developer&apos;s Guide has one main section on encryption under &quot;Derby and Security&quot; and several more topics under &quot;Working with the database connection URL attributes&quot;. Might be a good idea to overhaul some of this.&lt;/p&gt;</comment>
                            <comment id="13458055" author="dagw" created="Tue, 18 Sep 2012 19:56:22 +0100"  >&lt;p&gt;The model for attributes are unclear, but they fall into two main categories &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;operation (e.g. create, shutdown, restoreFrom)&lt;/li&gt;
	&lt;li&gt;arguments for an operation (e.g. password)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There is precendence for no-op operations being ignored (dataEncryption=false always, dataEncryption=true on 2..n connect) and for raising SQLWarning (create=true on 2..n connect); the latter only in the embedded driver (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5907&quot; title=&quot;Warnings missing on client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5907&quot;&gt;DERBY-5907&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Sometimes meaningless combinations of operations/arguments give errors, others are ignored..&lt;/p&gt;

&lt;p&gt;I guess we can&apos;t resolve this state of things easily now, but it would be good to understand which way we should head with this....&lt;br/&gt;
In any case, I think of decrypting as an operation separate from encryption, so I&apos;d prefer it to have its own attribute.&lt;br/&gt;
It may be ignored on attempts 2..n, I guess. &quot;decryptDatabase=true&quot; seems fine to me.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;br/&gt;
Operations&lt;/p&gt;

&lt;p&gt;create=true attribute&lt;br/&gt;
createFrom=path attribute&lt;br/&gt;
dataEncryption=true attribute&lt;br/&gt;
failover=true attribute&lt;br/&gt;
restoreFrom=path attribute&lt;br/&gt;
shutdown=true attribute&lt;br/&gt;
rollForwardRecoveryFrom=path attribute&lt;br/&gt;
startMaster=true attribute&lt;br/&gt;
startSlave=true attribute&lt;br/&gt;
stopMaster=true attribute&lt;br/&gt;
stopSlave=true attribute&lt;br/&gt;
upgrade=true attribute&lt;br/&gt;
drop=true attribute&lt;/p&gt;


&lt;p&gt;Arguments&lt;/p&gt;

&lt;p&gt;bootPassword=key attribute&lt;br/&gt;
collation=collation attribute&lt;br/&gt;
databaseName=nameofDatabase attribute&lt;br/&gt;
deregister=false attribute&lt;br/&gt;
encryptionKey=key attribute&lt;br/&gt;
encryptionProvider=providerName attribute&lt;br/&gt;
encryptionAlgorithm=algorithm attribute&lt;br/&gt;
logDevice=logDirectoryPath attribute&lt;br/&gt;
newEncryptionKey=key attribute&lt;br/&gt;
newBootPassword=newPassword attribute&lt;br/&gt;
password=userPassword attribute&lt;br/&gt;
retrieveMessageText=false attribute&lt;br/&gt;
securityMechanism=value attribute&lt;br/&gt;
slaveHost=hostname attribute&lt;br/&gt;
slavePort=portValue attribute&lt;br/&gt;
ssl=sslMode attribute&lt;br/&gt;
territory=ll_CC attribute&lt;br/&gt;
traceDirectory=path attribute&lt;br/&gt;
traceFile=path attribute&lt;br/&gt;
traceFileAppend=true attribute&lt;br/&gt;
traceLevel=value attribute&lt;br/&gt;
user=userName attribute&lt;/p&gt;</comment>
                            <comment id="13458117" author="kristwaa" created="Tue, 18 Sep 2012 21:23:44 +0100"  >&lt;p&gt;---- Kim ----&lt;br/&gt;
The one-time operation point seems a bit less compelling, if my guess (just a guess) is correct that &quot;dataEncryption=true&quot; is also a one-time operation? Or can you re-encrypt an encrypted database, changing from, say, one encryption algorithm to another? Would that work, or would it totally mess up your database? Anyway, I think reducing the possibility of confusion is desirable.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Actually, dataEncryption isn&apos;t considered a one-time operation, although for the end user it appears to be so:&lt;br/&gt;
 a) We save dataEncryption=true in service.properties. Even if you specify dataEncryption=false when connecting, we will read dataEncryption=true if the database is &lt;span class=&quot;error&quot;&gt;&amp;#91;already&amp;#93;&lt;/span&gt; encrypted.&lt;br/&gt;
 b) You can re-encrypt &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; an encrypted database, but I haven&apos;t checked if you have to specify dataEncryption=true or only newBootPassword/newEncryptionKey (with bootPassword to access the database in addition) to do so.&lt;/p&gt;


&lt;p&gt;As for attribute handling I&apos;m going for what seems to be the default action:&lt;br/&gt;
 o ignore attributes when they don&apos;t cause any trouble, for instance decryptDatabase=true on un-encrypted or booted database. One could argue the latter case deserves a warning.&lt;br/&gt;
 o raise exception if the attributes are truly conflicting (dataEncryption=true;decryptDatabase=true on un-encrypted database, decryptDatabase=true;createFrom=myEncryptedDb)&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; I&apos;d have to look at the code / docs again to say exactly what re-encrypt entails in all cases. I seem to recall some differences between using the boot attributes and the system procedure for changing the boot password.&lt;/p&gt;</comment>
                            <comment id="13458561" author="kristwaa" created="Wed, 19 Sep 2012 11:54:57 +0100"  >&lt;p&gt;Not sure what went wrong, but the patch I uploaded was slightly outdated. While the correct file was dated 16:57, the upload at 17:07 used an older version of the patch file. Maybe the browser cached the older version, i.e. it read it before I pressed &quot;Attach&quot;?&lt;/p&gt;

&lt;p&gt;I&apos;m re-running the regression tests to verify that the errors go away.&lt;/p&gt;</comment>
                            <comment id="13458687" author="kristwaa" created="Wed, 19 Sep 2012 14:46:56 +0100"  >&lt;p&gt;Attaching patch 1b, where I have renamed &quot;databaseIsEncrypted&quot; to &quot;isEncryptedDatabase&quot; in RawStore. Otherwise unchanged from 1a.&lt;/p&gt;

&lt;p&gt;Both derbyall and suites.All passed with patch 1b.&lt;/p&gt;</comment>
                            <comment id="13464128" author="kristwaa" created="Wed, 26 Sep 2012 21:06:20 +0100"  >&lt;p&gt;Committed patch 1b to trunk with revision 1390712.&lt;br/&gt;
I&apos;ll follow up with the main patch that adds the functionality, and patches that adds tests (a separate test for the feature, a crash recovery test, a test for DBO powers, and possibly an upgrade test).&lt;/p&gt;</comment>
                            <comment id="13467627" author="kristwaa" created="Tue, 2 Oct 2012 12:43:22 +0100"  >&lt;p&gt;Patch 2a adds a basic test for database decryption. It tests the core functionality with the default encryption algorithm and with AES/OFB/NoPadding.&lt;br/&gt;
The test will be enabled when the required functionality has been added.&lt;/p&gt;

&lt;p&gt;Committed to trunk with revision 1392856.&lt;/p&gt;</comment>
                            <comment id="13468493" author="kristwaa" created="Wed, 3 Oct 2012 12:35:52 +0100"  >&lt;p&gt;Patch 3a adds the decryption feature:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;iapi/reference/Attribute&lt;br/&gt;
Adds the new connection URL &apos;decryptDatabase&apos; (true|false).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;iapi/store/raw/RawStoreFactory&lt;br/&gt;
Adds the new minor version 10.&lt;br/&gt;
Updated a comment.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;iapi/store/raw/DataFactory&lt;br/&gt;
Adds method decryptAllContainers(RawTransaction).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;impl/jdbc/EmbeddedConnection&lt;br/&gt;
Introduces notion of crypto boot, instead of looking just for encryption. Makes two-phase boot logic apply to decryption.&lt;br/&gt;
Adds check for conflicting high-level cryptographic attributes. Note that the checking here is incomplete due to missing knowledge about the state of the database (for instance, is it encrypted or not?).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;impl/store/RawStore&lt;br/&gt;
Adds logic to detect decryption request.&lt;br/&gt;
Denies decryption if the database is in certain states (read-only, has global prepared xact, log archived, store version too old).&lt;br/&gt;
Adds logic to update the service properties, that is to remove encryption properties after decryption has happened.&lt;br/&gt;
Decryption reuses the same crash recovery support as encryption uses.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;impl/store/raw/data/BaseDataFileFactory&lt;br/&gt;
Implements decryptAllContainers(RawTransaction.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;impl/store/raw/data/RAFContainer&lt;br/&gt;
Adds logic to skip encryption of page data. This is effectively where decryption happens, except that the data has already been decrypted when entering the page cache. We just don&apos;t encrypt it again before writing it out to disk.&lt;br/&gt;
Updates some error messages.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;loc/messages.xml&lt;br/&gt;
Adds two new error messages.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;shared/common/reference/SQLState&lt;br/&gt;
Adds two new SQLStates.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;tests/store/_Suite&lt;br/&gt;
Enables DecryptDatabaseTest.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Known missing tasks:&lt;br/&gt;
 o logic to deal with DBO powers&lt;br/&gt;
 o crash recovery test&lt;br/&gt;
 o may want to introduce a DecryptContainerOperation instead of reusing the log entry for encryption&lt;br/&gt;
 o some potential cleanup/refactoring&lt;br/&gt;
 o don&apos;t know if the error messages are satisfactory, or if we want to add separate messages for each of the failure situations&lt;br/&gt;
 o documentation (logged by Kim as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5939&quot; title=&quot;Document URL attribute for database decryption&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5939&quot;&gt;&lt;del&gt;DERBY-5939&lt;/del&gt;&lt;/a&gt;, thanks!), which should be very similar to encryption, but much simpler. There is only one knob &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; We probably want to mention the failure situations, which are mainly conflicting attributes and cases where decryption is unsupported/denied.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="13468591" author="knutanders" created="Wed, 3 Oct 2012 15:47:38 +0100"  >&lt;p&gt;&amp;gt; Known missing tasks:&lt;br/&gt;
&amp;gt;  o logic to deal with DBO powers&lt;/p&gt;

&lt;p&gt;What does this mean exactly? Can any user decrypt the database with the current state of the patch?&lt;/p&gt;

&lt;p&gt;In RAFContainer.java, the patch makes this change:&lt;/p&gt;

&lt;p&gt;         else &lt;br/&gt;
         {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (dataFactory.databaseEncrypted() || encryptWithNewEngine)&lt;br/&gt;
+            if (encryptionBuf != null &amp;amp;&amp;amp;&lt;br/&gt;
+                    (dataFactory.databaseEncrypted() || encryptWithNewEngine))&lt;br/&gt;
             {&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;I was a bit surprised that the original code checked for encryptWithNewEngine here. Is it really the case that it&apos;s possible to end up encrypting the page even if the data factory says it shouldn&apos;t be encrypted? If not, perhaps it could be simplified to just check for dataFactory.databaseEncrypted(), in which case we don&apos;t need to add an extra check for encryptionBuf to support decryption?&lt;/p&gt;

&lt;p&gt;The new DATABASE_DECRYPTION_DENIED message might be problematic to localize because it takes an English string as an argument. We may need multiple messages to allow them to be fully translated. Sharing SQL state between the messages would be fine, though.&lt;/p&gt;</comment>
                            <comment id="13468688" author="kristwaa" created="Wed, 3 Oct 2012 18:30:51 +0100"  >&lt;p&gt;Thanks for the review, Knut Anders.&lt;br/&gt;
Answers/comments below.&lt;/p&gt;

&lt;p&gt;&amp;gt; What does this mean exactly? Can any user decrypt the database with the current state of the patch?&lt;/p&gt;

&lt;p&gt;Any user that knows the boot password / encryption key can decrypt the database with patch 3a.&lt;br/&gt;
Nothing will happen if the database has already been booted. Assuming the DBO boots the database by supplying the boot credentials, JOE_USER can&apos;t decrypt the database. &quot;decryptDatabase=true&quot; will be ignored when JOE_USER connects to the booted database. This hasn&apos;t changed with this patch, encryption attributes are handled the same way.&lt;/p&gt;

&lt;p&gt;I have a patch adding the restriction that only the DBO can decrypt a database, given that authentication and authorization is enabled. The code will go in toghether with changes to the DboPowersTest.&lt;/p&gt;

&lt;p&gt;&amp;gt; Is it really the case that it&apos;s possible to end up encrypting the page even if the data factory says it shouldn&apos;t be encrypted?&lt;/p&gt;

&lt;p&gt;I think this is a chicken and egg issue. The state of the data factory, and log factory, isn&apos;t flipped until the operation has been carried out.&lt;br/&gt;
There are now three different data paths, where data goes in and out of the cache &quot;concurrently&quot;:&lt;br/&gt;
  encrypt existing: &lt;span class=&quot;error&quot;&gt;&amp;#91;disk&amp;#93;&lt;/span&gt; -&amp;gt; plain   -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cache&amp;#93;&lt;/span&gt; -&amp;gt; encrypt -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;disk&amp;#93;&lt;/span&gt;&lt;br/&gt;
  re-encrypt db   : &lt;span class=&quot;error&quot;&gt;&amp;#91;disk&amp;#93;&lt;/span&gt; -&amp;gt; decrypt -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cache&amp;#93;&lt;/span&gt; -&amp;gt; encrypt -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;disk&amp;#93;&lt;/span&gt;&lt;br/&gt;
  decrypt db      : &lt;span class=&quot;error&quot;&gt;&amp;#91;disk&amp;#93;&lt;/span&gt; -&amp;gt; decrypt -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cache&amp;#93;&lt;/span&gt; -&amp;gt; plain   -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;disk&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I&apos;d have to check how the databaseEncrypted flags affect the decryption process as data enters the page cache before trying to simplify/change this.&lt;br/&gt;
In any case, the existing check for encryptWithNewEngine is there to deal with the case of encrypting an existing plaintext database.&lt;/p&gt;

&lt;p&gt;I also see that setting the encryption buffer to null is used as an optimization in RAFContainer4, and in that case DataFactory.encryptedDatabase() is always false. This is normal operation though, not a case where the whole database will transition from plaintext to ciphertext or vice versa.&lt;/p&gt;

&lt;p&gt;&amp;gt; The new DATABASE_DECRYPTION_DENIED message might be problematic to localize because it takes an English string as an argument.&lt;/p&gt;

&lt;p&gt;Yes, I&apos;m aware of this. We need to nail down the messages.&lt;br/&gt;
I like the point about reusing the same SQL state. The important issue here is that the decryption request was denied, not why. I say that, because it is unlikely that this failure condition can be dealt with automatically by code. A DBA would likely have to read the message - which does tell you why the request was denied - and take corrective actions anyway. Also, encrypting and decrypting a database is hopefully not something you do frequently on a given database.&lt;/p&gt;

&lt;p&gt;Encryption has different states for each failure condition:&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot encrypt the database when there is a global transaction in the prepared state.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot re-encrypt the database with a new boot password or an external encryption key when there is a global transaction in the prepared state.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot configure a read-only database for encryption.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot re-encrypt a read-only database with a new boot password or an external encryption key .&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot configure a database for encryption, when database is in the log archive mode.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot re-encrypt a database with a new boot password or an external encryption key, when database is in the log archive mode.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Encryption of an un-encrypted database failed: &lt;/p&gt;
{0}&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Encryption of an encrypted database with a new key or a new password failed: {0}
&lt;p&gt;&amp;lt;/text&amp;gt;&lt;/p&gt;

&lt;p&gt;Guess I&apos;ll add another four messages to the heap:&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot decrypt the database when there is a global transaction in the prepared state.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot configure a read-only database for decryption.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Cannot configure a database for decryption, when database is in the log archive mode.&amp;lt;/text&amp;gt;&lt;br/&gt;
&amp;lt;text&amp;gt;Decryption of an encrypted database failed: &lt;/p&gt;
{0}
&lt;p&gt;&amp;lt;/text&amp;gt;&lt;/p&gt;

&lt;p&gt;The new messages follow the style of the existing messages. Are they good enough, or should they be rewritten?&lt;/p&gt;</comment>
                            <comment id="13468971" author="kristwaa" created="Thu, 4 Oct 2012 00:27:13 +0100"  >&lt;p&gt;Patch 4a adds test cases for DBO powers for decryption, it modifies the logic for crash recovery for cryptographic operations on a database, and it adds crash recovery tests for database decryption.&lt;br/&gt;
Patch 4a is generated on top of 3a.&lt;/p&gt;

&lt;p&gt;The crash recovery logic is getting pretty involved and delicate - I&apos;m not too happy about it...&lt;/p&gt;

&lt;p&gt;A correction on my own comment regarding DBO powers: patch 3a will also reject decryption attempts from non-DBO users if authentication and authorization are enabled, but it will say that the operation denied is (re-)encryption.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="13468977" author="kristwaa" created="Thu, 4 Oct 2012 00:34:48 +0100"  >&lt;p&gt;Attaching patch 4b - I forgot to update lang.ErrorCodeTest in patch 4a.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="13469219" author="knutanders" created="Thu, 4 Oct 2012 09:31:40 +0100"  >&lt;p&gt;Patch 4b looks fine to me, and it clears up my question about DBO rights. Since you&apos;re planning to fix the messages in a follow-up patch, I&apos;m +1 to both 3a and 4b.&lt;/p&gt;

&lt;p&gt;As to the messages, perhaps we could reduce the number of messages needed by using the same message for encryption, re-encryption and decryption. For example:&lt;/p&gt;

&lt;p&gt;  Cannot encrypt, re-encrypt or decrypt a database when there is a global transaction in the prepared state.&lt;br/&gt;
  Cannot reconfigure encryption for a read-only database.&lt;br/&gt;
  ...&lt;/p&gt;</comment>
                            <comment id="13469296" author="kristwaa" created="Thu, 4 Oct 2012 12:40:03 +0100"  >&lt;p&gt;Committed patches 3a and 4b to trunk with revision 1393993.&lt;/p&gt;

&lt;p&gt;I&apos;ll continue working on the remaining tasks, but the feature itself should now be complete (except for any bugs and problems we find of course).&lt;/p&gt;</comment>
                            <comment id="13469430" author="kristwaa" created="Thu, 4 Oct 2012 15:57:20 +0100"  >&lt;p&gt;Attaching patch 5a, which simplifies the method cleaning up the old container files in seg0. I haven&apos;t found a reason to keep the two implementations yet (filtering on disk and keeping list in-memory), and this isn&apos;t performance critical code.&lt;/p&gt;

&lt;p&gt;suites.All passed except for one failure in the compatibility test (10.3), so I&apos;m rerunning tests.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="13469644" author="kristwaa" created="Thu, 4 Oct 2012 21:10:23 +0100"  >&lt;p&gt;A rerun of suites.All passed without failures, so did my run of derbyall.&lt;/p&gt;</comment>
                            <comment id="13470229" author="knutanders" created="Fri, 5 Oct 2012 12:22:24 +0100"  >&lt;p&gt;5a looks like a good cleanup. I don&apos;t see any need for two different implementations either. +1&lt;/p&gt;</comment>
                            <comment id="13470323" author="kristwaa" created="Fri, 5 Oct 2012 14:51:00 +0100"  >&lt;p&gt;Thanks, Knut.&lt;/p&gt;

&lt;p&gt;Attaching patch 5b, which resolves a merge conflict.&lt;br/&gt;
Committed patch 5b to trunk with revision 1394522.&lt;/p&gt;</comment>
                            <comment id="13486299" author="rhillegas" created="Mon, 29 Oct 2012 20:01:17 +0000"  >&lt;p&gt;I have buddy-tested this feature against the user documentation. As far as I can tell, the feature behaves as described by the user documentation (see the script below). In addition, I was not able to discover any new defects which are not also shared with re-encryption. However, I believe that un-encryption and re-encryption share some defects which we should address. I have logged the following bugs:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5968&quot; title=&quot;A failed connection attempt may nevertheless manage to boot the database.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5968&quot;&gt;DERBY-5968&lt;/a&gt; - A failed connection attempt may nevertheless manage to boot the database.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5969&quot; title=&quot;Encryption, re-encryption, and un-encryption silently fail if the database is already booted.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5969&quot;&gt;&lt;del&gt;DERBY-5969&lt;/del&gt;&lt;/a&gt; - Re-encryption and un-encryption silently fail if the database is already booted.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5970&quot; title=&quot;Check that connection attributes have legal values.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5970&quot;&gt;DERBY-5970&lt;/a&gt; - Check that connection attributes have legal values.&lt;/p&gt;


&lt;p&gt;connect &apos;jdbc:derby:db;create=true;user=test_dbo;dataEncryption=true;bootPassword=foobarwibblewombat&apos;;&lt;/p&gt;

&lt;p&gt;call syscs_util.syscs_create_user( &apos;test_dbo&apos;, &apos;test_dbopassword&apos; );&lt;br/&gt;
call syscs_util.syscs_create_user( &apos;fred&apos;, &apos;fredpassword&apos; );&lt;/p&gt;

&lt;p&gt;call syscs_util.syscs_backup_database_and_enable_log_archive_mode( &apos;backups&apos;, 0 );&lt;/p&gt;

&lt;p&gt;&amp;#8211; shutdown the database&lt;br/&gt;
connect &apos;jdbc:derby:db;shutdown=true&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; need the bootpassword to boot the database&lt;br/&gt;
connect &apos;jdbc:derby:db;user=fred;password=fredpassword&apos;;&lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.systables;&lt;br/&gt;
connect &apos;jdbc:derby:db;user=fred;password=fredpassword;bootPassword=foobarwibblewombat&apos;;&lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.systables;&lt;/p&gt;

&lt;p&gt;&amp;#8211; only the dbo can shutdown the database&lt;br/&gt;
connect &apos;jdbc:derby:db;shutdown=true;user=fred;password=fredpassword&apos;;&lt;br/&gt;
connect &apos;jdbc:derby:db;shutdown=true;user=test_dbo;password=test_dbopassword&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; only the dbo can unencrypt the database&lt;br/&gt;
connect &apos;jdbc:derby:db;user=fred;password=fredpassword;bootPassword=foobarwibblewombat;decryptDatabase=true&apos;;&lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.systables;&lt;/p&gt;

&lt;p&gt;&amp;#8211; although the connection failed, the database is now booted so we need to shut it down. see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5968&quot; title=&quot;A failed connection attempt may nevertheless manage to boot the database.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5968&quot;&gt;DERBY-5968&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5969&quot; title=&quot;Encryption, re-encryption, and un-encryption silently fail if the database is already booted.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5969&quot;&gt;&lt;del&gt;DERBY-5969&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
connect &apos;jdbc:derby:db;shutdown=true;user=test_dbo;password=test_dbopassword&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; should fail because log archive mode is turned on&lt;br/&gt;
connect &apos;jdbc:derby:db;user=test_dbo;password=test_dbopassword;bootPassword=foobarwibblewombat;decryptDatabase=true&apos;;&lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.systables;&lt;/p&gt;

&lt;p&gt;&amp;#8211; turn off log archival mode&lt;br/&gt;
connect &apos;jdbc:derby:db;user=test_dbo;password=test_dbopassword;bootPassword=foobarwibblewombat&apos;;&lt;br/&gt;
call syscs_util.syscs_disable_log_archive_mode( 0 );&lt;/p&gt;

&lt;p&gt;&amp;#8211; shutdown the database&lt;br/&gt;
connect &apos;jdbc:derby:db;shutdown=true;user=test_dbo;password=test_dbopassword&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; try a bad setting for decryptDatabase. silently ignored. see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5970&quot; title=&quot;Check that connection attributes have legal values.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5970&quot;&gt;DERBY-5970&lt;/a&gt;.&lt;br/&gt;
connect &apos;jdbc:derby:db;user=test_dbo;password=test_dbopassword;bootPassword=foobarwibblewombat;decryptDatabase=fred&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211; shutdown the database&lt;br/&gt;
connect &apos;jdbc:derby:db;shutdown=true;user=test_dbo;password=test_dbopassword&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211;  fails because the database was not decrypted&lt;br/&gt;
connect &apos;jdbc:derby:db;user=fred;password=fredpassword&apos;;&lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.systables;&lt;/p&gt;

&lt;p&gt;&amp;#8211; now unencryption should work&lt;br/&gt;
connect &apos;jdbc:derby:db;user=test_dbo;password=test_dbopassword;bootPassword=foobarwibblewombat;decryptDatabase=true&apos;;&lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.systables;&lt;/p&gt;

&lt;p&gt;&amp;#8211; shutdown the database&lt;br/&gt;
connect &apos;jdbc:derby:db;shutdown=true;user=test_dbo;password=test_dbopassword&apos;;&lt;/p&gt;

&lt;p&gt;&amp;#8211;  now anyone can boot the database without a bootpassword&lt;br/&gt;
connect &apos;jdbc:derby:db;user=fred;password=fredpassword&apos;;&lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from sys.systables;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12608618">DERBY-5934</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12613922">DERBY-5968</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12613941">DERBY-5970</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12613925">DERBY-5969</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12609441">DERBY-5939</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12545708" name="derby-5792-1a-boilerplate_and_preparation.diff" size="66430" author="kristwaa" created="Wed, 19 Sep 2012 11:54:57 +0100"/>
                            <attachment id="12545730" name="derby-5792-1b-boilerplate_and_preparation.diff" size="66430" author="kristwaa" created="Wed, 19 Sep 2012 14:46:56 +0100"/>
                            <attachment id="12547366" name="derby-5792-2a-decryptdatabasetest.diff" size="15357" author="kristwaa" created="Tue, 2 Oct 2012 12:43:22 +0100"/>
                            <attachment id="12547522" name="derby-5792-3a-decryption_feature.diff" size="34428" author="kristwaa" created="Wed, 3 Oct 2012 12:35:52 +0100"/>
                            <attachment id="12547625" name="derby-5792-4a-crash_and_dbo.diff" size="31061" author="kristwaa" created="Thu, 4 Oct 2012 00:27:13 +0100"/>
                            <attachment id="12547627" name="derby-5792-4b-crash_and_dbo.diff" size="32444" author="kristwaa" created="Thu, 4 Oct 2012 00:34:48 +0100"/>
                            <attachment id="12547765" name="derby-5792-5a-old_container_removal_cleanup.diff" size="12258" author="kristwaa" created="Thu, 4 Oct 2012 15:57:20 +0100"/>
                            <attachment id="12547977" name="derby-5792-5b-old_container_removal_cleanup.diff" size="11569" author="kristwaa" created="Fri, 5 Oct 2012 14:51:00 +0100"/>
                    </attachments>
                <subtasks>
                            <subtask id="12607641">DERBY-5930</subtask>
                            <subtask id="12613627">DERBY-5962</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 10 Sep 2012 13:13:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240023</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxuq1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3039</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>