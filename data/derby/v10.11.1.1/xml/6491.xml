<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:54:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6491/DERBY-6491.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6491] SELECT statements incorrectly require USAGE privilege on column types</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6491</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A Derby SELECT requires that the user enjoy USAGE privilege on the types of all columns in the tables being read. This even includes USAGE privilege on the types of columns which are not being read. The latter privilege certainly seems overbroad. But I don&apos;t think that USAGE privilege should even be required on the types of columns being SELECTed. I can&apos;t find any language in the SQL Standard requiring this.&lt;/p&gt;

&lt;p&gt;This interpretation is in line with the general principle that the user who creates a table must enjoy privilege to use and execute functions and types mentioned in the table definition, but other users who access that table only need the correct INSERT/UPDATE/DELETE/SELECT privileges and otherwise operate under the aegis of the table owner.&lt;/p&gt;

&lt;p&gt;This interpretation of the Standard agrees with the behavior of DB2, as described here: &lt;a href=&quot;http://pic.dhe.ibm.com/infocenter/iseries/v7r1m0/index.jsp?topic=%2Fdb2%2Frbafzgntudtp.htm&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://pic.dhe.ibm.com/infocenter/iseries/v7r1m0/index.jsp?topic=%2Fdb2%2Frbafzgntudtp.htm&lt;/a&gt; I think that Derby also incorrectly requires USAGE privilege on the types of arguments/return values of routines when invoking those routines. But that is a separate issue which I do not want to address with this JIRA.&lt;/p&gt;

&lt;p&gt;The following script shows the overbroad USAGE requirements of SELECT statements:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;connect &apos;jdbc:derby:memory:db;user=test_dbo;create=true&apos;;

call syscs_util.syscs_create_user( &apos;TEST_DBO&apos;, &apos;test_dbopassword&apos; );
call syscs_util.syscs_create_user( &apos;RUTH&apos;, &apos;ruthpassword&apos; );

connect &apos;jdbc:derby:memory:db;shutdown=true&apos;;

connect &apos;jdbc:derby:memory:db;user=test_dbo;password=test_dbopassword&apos; as dbo;

create type SourceUnreferencedType_045 external name &apos;java.util.HashMap&apos; language java;
create type SourceValueType_045 external name &apos;java.util.HashMap&apos; language java;

create table sourceTable_045
(
    sourceUnreferencedColumn SourceUnreferencedType_045,
    sourceValueColumn SourceValueType_045
);

grant select( sourceValueColumn ) on sourceTable_045 to ruth;

connect &apos;jdbc:derby:memory:db;user=ruth;password=ruthpassword&apos; as ruth;

-- incorrectly fails because ruth does not have USAGE privilege on SourceUnreferencedType_045
select sourceValueColumn from test_dbo.sourceTable_045;

set connection dbo;

grant usage on type SourceUnreferencedType_045 to ruth;

set connection ruth;

-- incorrectly fails because ruth does not have USAGE privilege on SourceValueType_045
select sourceValueColumn from test_dbo.sourceTable_045;

set connection dbo;

grant usage on type SourceValueType_045 to ruth;

set connection ruth;

-- succeeds now that ruth has USAGE privilege on both types
select sourceValueColumn from test_dbo.sourceTable_045;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12697951">DERBY-6491</key>
            <summary>SELECT statements incorrectly require USAGE privilege on column types</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Feb 2014 15:23:04 +0000</created>
                <updated>Thu, 6 Mar 2014 02:35:22 +0000</updated>
                                            <version>10.11.1.1</version>
                                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13915967" author="rhillegas" created="Fri, 28 Feb 2014 16:44:18 +0000"  >&lt;p&gt;Attaching derby-6491-aa-stopRequiringUsagePriv.diff. This patch turns off the adding of USAGE privilege for types during table binding and during the binding of cursor nodes. I am running tests now.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/compile/CompilerContext.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/CompilerContextImpl.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java&lt;/p&gt;

&lt;p&gt;Give the compiler a way to turn off the addition of USAGE privileges for UDTs.&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/FromList.java&lt;/p&gt;

&lt;p&gt;Turn off the adding of USAGE privs for types while binding tables.&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/CursorNode.java&lt;/p&gt;

&lt;p&gt;Turn off the adding of USAGE privs for types while binding cursor nodes.&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/GenericStatement.java&lt;/p&gt;

&lt;p&gt;Turn off the adding of USAGE privs for types when we&apos;re done with the bind() phase.&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;


&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java&lt;/p&gt;

&lt;p&gt;Correct canonized wrong results. Add a test to verify that the repro succeeds now.&lt;/p&gt;</comment>
                            <comment id="13916166" author="rhillegas" created="Fri, 28 Feb 2014 18:45:13 +0000"  >&lt;p&gt;Attaching derby-6491-ab-stopRequiringUsagePriv.diff. Tests ran cleanly on the previous rev of the patch except for some cases in UDTPermsTest which used to fail but now succeed. I have adjusted that test to canonize the new, correct results.&lt;/p&gt;


&lt;p&gt;Touches the following additional file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/UDTPermsTest.java&lt;/p&gt;</comment>
                            <comment id="13916170" author="jira-bot" created="Fri, 28 Feb 2014 18:46:36 +0000"  >&lt;p&gt;Commit 1573030 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1573030&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1573030&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6491&quot; title=&quot;SELECT statements incorrectly require USAGE privilege on column types&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6491&quot;&gt;DERBY-6491&lt;/a&gt;: Don&apos;t require USAGE priv on the datatypes of SELECTed columns; commit derby-6491-ab-stopRequiringUsagePriv.diff.&lt;/p&gt;</comment>
                            <comment id="13919701" author="mamtas" created="Tue, 4 Mar 2014 17:55:04 +0000"  >&lt;p&gt;Rick, thanks for making these changes. One quick question - turning off USAGE privilege collection while binding tables will not turn it off for CREATE TABLE, right? Also, I am curious why do we need to turn off USAGE privilege collection during optimize time(I thought all privilege collection happens during bind time and not during optimize time)? Apologies if these are very basic questions.&lt;/p&gt;</comment>
                            <comment id="13919727" author="rhillegas" created="Tue, 4 Mar 2014 18:17:53 +0000"  >&lt;p&gt;Hi Mamta,&lt;/p&gt;

&lt;p&gt;Thanks for asking those questions. USAGE privilege is still checked during the execution of CREATE TABLE. I think this is verified by a test case in UDTTest. In any event, the following script shows that this privilege check is still performed:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;connect &apos;jdbc:derby:memory:db;user=test_dbo;create=true&apos;;
call syscs_util.syscs_create_user( &apos;TEST_DBO&apos;, &apos;test_dbopassword&apos; );
call syscs_util.syscs_create_user( &apos;RUTH&apos;, &apos;ruthpassword&apos; );
connect &apos;jdbc:derby:memory:db;shutdown=true&apos;;

connect &apos;jdbc:derby:memory:db;user=test_dbo;password=test_dbopassword&apos; as dbo;
create type PrivateType external name &apos;java.util.HashMap&apos; language java;

connect &apos;jdbc:derby:memory:db;user=ruth;password=ruthpassword&apos; as ruth;

-- fails because ruth does not have USAGE privilege on PrivateType
create table t( a test_dbo.PrivateType );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Your other question was about why privilege collection needs to be turned off during optimization. There are two reasons for this:&lt;/p&gt;

&lt;p&gt;1) Re-binding can occur during the pre-processing phase. I think this is a defect but it&apos;s one we have to workaround for the moment.&lt;/p&gt;

&lt;p&gt;2) I think that I did a bad job when I implemented USAGE collection for user-defined types. I made the compiler consider adding USAGE privilege every time a datatype was bound. That results in a lot of over-eager collection of USAGE privileges. Having read the SQL Standard more closely, I now think that we could probably limit USAGE collection to two situations:&lt;/p&gt;

&lt;p&gt;a) explicit declaration of a UDT type in a CREATE/ALTER statement&lt;/p&gt;

&lt;p&gt;b) explict CAST to a UDT type&lt;/p&gt;

&lt;p&gt;Cleaning up item 2) may be straightforward. I suspect that item 1) is trickier.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13921462" author="mamtas" created="Wed, 5 Mar 2014 21:41:09 +0000"  >&lt;p&gt;Rick, should those items be handled in a separate jira about collecting privileges in optimize phase?&lt;/p&gt;</comment>
                            <comment id="13921927" author="rhillegas" created="Thu, 6 Mar 2014 02:35:22 +0000"  >&lt;p&gt;Hi Mamta,&lt;/p&gt;

&lt;p&gt;Yes, I agree that overhauling UDT privilege management is outside the limited focus of this issue on the SELECT statement. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12631779" name="derby-6491-aa-stopRequiringUsagePriv.diff" size="8835" author="rhillegas" created="Fri, 28 Feb 2014 16:44:18 +0000"/>
                            <attachment id="12631810" name="derby-6491-ab-stopRequiringUsagePriv.diff" size="9899" author="rhillegas" created="Fri, 28 Feb 2014 18:45:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 28 Feb 2014 18:46:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376425</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzmpvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376721</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>