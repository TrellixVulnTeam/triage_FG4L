<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:21:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1132/DERBY-1132.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1132] Truncation Error with Concat</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1132</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Consider the table&lt;br/&gt;
CREATE TABLE CUSTOMER_TABLE ( ID VARCHAR(255)   PRIMARY KEY NOT NULL, NAMEZ VARCHAR(255) , COUNTRY VARCHAR(255) )&lt;/p&gt;

&lt;p&gt;Sql:&lt;br/&gt;
PreparedStatement ps = conn.prepateStatement (&quot;SELECT * FROM CUSTOMER_TABLE WHERE NAMEZ  = VARCHAR ( CAST (? AS VARCHAR(32672) ) || CAST (? AS VARCHAR(32672) ) )&quot; );&lt;br/&gt;
ps.setString(1, &quot;Alan E. &quot;);&lt;br/&gt;
ps.setString(2, &quot;Frechette&quot;);&lt;br/&gt;
ps.executeQuery()&lt;/p&gt;

&lt;p&gt;Error:&lt;br/&gt;
&quot;A truncation error was encountered trying to shrink VARCHAR &apos;Alan E. Frechette&apos; to length 15.&quot;&lt;br/&gt;
getErrorCode()-1&lt;br/&gt;
getSQLState()22001 &lt;/p&gt;

&lt;p&gt;Please note that&lt;br/&gt;
-The query executes ok against DB2 database&lt;br/&gt;
-The query executes ok if the total length of both the parameters bound is less than 15. That is as follows&lt;br/&gt;
   //Total length of parameters bound = len(&quot;Alan E. Fre&quot;) = 11&lt;br/&gt;
   ps.setString(1, &quot;Alan E. &quot;);&lt;br/&gt;
   ps.setString(2, &quot;Fre&quot;);&lt;br/&gt;
-The error occurs both with embedded and network mode of derby&lt;br/&gt;
-Omitting the casts as follows also gives the same error&lt;br/&gt;
   query: SELECT * FROM CUSTOMER_TABLE WHERE NAMEZ  = VARCHAR( &apos;Frechette&apos; || ? )&lt;br/&gt;
   error: SQLState: 22001 &quot;A truncation error was encountered trying to shrink VARCHAR &apos;FrechetteAlan E. &apos; to length 15&quot;&lt;br/&gt;
-Using parameter markers for both the variables without cast like as follows results in error&lt;br/&gt;
   query: SELECT * FROM CUSTOMER_TABLE WHERE NAMEZ  = ? || ?&lt;br/&gt;
   error: SQLState: 42X35 &quot;It is not allowed for both operands of &apos;||&apos; to be ? parameters.&quot;&lt;br/&gt;
-Using parameter markers for only one variables without cast like as follows results in error&lt;br/&gt;
   query: SELECT * FROM CUSTOMER_TABLE WHERE NAMEZ  = &apos;Frechette&apos; || ?&lt;br/&gt;
   error:SQLState: 42818 &quot;Comparisons between &apos;VARCHAR&apos; and &apos;LONG VARCHAR&apos; are not supported.&quot; &lt;br/&gt;
-It works to cast to VARCHAR(2000), but not VARCHAR(2001) or larger.  Regardless of length, if it fails, the magic number is always 15. &lt;/p&gt;</description>
                <environment>Solaris, Windwos, JDK 1.5</environment>
        <key id="12330481">DERBY-1132</key>
            <summary>Truncation Error with Concat</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sv204098">Saurabh Vyas</assignee>
                                    <reporter username="miteshm">Mitesh Meswani</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Mar 2006 02:28:01 +0000</created>
                <updated>Fri, 21 Jan 2011 17:48:34 +0000</updated>
                            <resolved>Mon, 12 Mar 2007 18:55:20 +0000</resolved>
                                    <version>10.1.1.0</version>
                                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12374452" author="bryanpendleton" created="Fri, 14 Apr 2006 10:57:52 +0100"  >&lt;p&gt;This is certainly a most curious bug! Here is the stack trace when the exception occurs:&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; ERROR 22001: A truncation error was encountered trying to shrink VARCHAR &apos;Alan E.Frechette&apos; to length 15.&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:355)&lt;br/&gt;
        at org.apache.derby.iapi.types.SQLChar.hasNonBlankChars(SQLChar.java:1316)&lt;br/&gt;
        at org.apache.derby.iapi.types.SQLChar.setWidth(SQLChar.java:1386)&lt;br/&gt;
        at org.apache.derby.exe.aca666c073x010ax964bx9307x000000169a300.e1(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGeneratedClass.java:140)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.GenericQualifier.getOrderable(GenericQualifier.java:96)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.NoPutResultSetImpl.clearOrderableCache(NoPutResultSetImpl.java:312)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.openScanController(BulkTableScanResultSet.java:176)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.TableScanResultSet.openCore(TableScanResultSet.java:390)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.openCore(BulkTableScanResultSet.java:224)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.open(BasicNoPutResultSetImpl.java:259)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:361)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1173)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1425)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeQuery(EmbedPreparedStatement.java:247)&lt;br/&gt;
        at repro.main(repro.java:35)&lt;/p&gt;

&lt;p&gt;I set a breakpoint in the debugger and I can see that variable &quot;start&quot; in SQLChar.hasNonBlankChars() is passed as &quot;15&quot;, and going up one level in the stack, that is because variable &quot;desiredWidth&quot; in SQLChar.setWidth() is passed as &quot;15&quot;.&lt;/p&gt;

&lt;p&gt;However, the next level up in the stack is generated Java byte code, and my skill with Derby does not reach to the point of knowing how to decrypt the generated Java byte code.&lt;/p&gt;

&lt;p&gt;Hopefully this information is helpful to the next person who looks at this problem.&lt;/p&gt;</comment>
                            <comment id="12374453" author="bryanpendleton" created="Fri, 14 Apr 2006 11:02:42 +0100"  >&lt;p&gt;Attached file &apos;repro.java&apos; is the repro program I put together following the poster&apos;s description.&lt;/p&gt;</comment>
                            <comment id="12450082" author="knutanders" created="Wed, 15 Nov 2006 16:08:53 +0000"  >&lt;p&gt;Here&apos;s another repro. It doesn&apos;t reproduce the the exception, but it could perhaps shed some more light on the magic number 15.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; values length(char(&apos;abc&apos;));&lt;br/&gt;
1          &lt;br/&gt;
-----------&lt;br/&gt;
15         &lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; values length(char(&apos;abcdefghijklmnopqrstuvwxyz&apos;));&lt;br/&gt;
1          &lt;br/&gt;
-----------&lt;br/&gt;
15         &lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; values length(varchar(&apos;abc&apos;));&lt;br/&gt;
1          &lt;br/&gt;
-----------&lt;br/&gt;
3          &lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; values length(varchar(&apos;abcdefghijklmnopqrstuvwxyz&apos;));&lt;br/&gt;
1          &lt;br/&gt;
-----------&lt;br/&gt;
15         &lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;

&lt;p&gt;When a string is cast to char with no length specified, the length is always 15. When a string is cast to varchar with no length specified, the length is always min(length(string), 15).&lt;/p&gt;</comment>
                            <comment id="12450760" author="sv204098" created="Fri, 17 Nov 2006 15:09:33 +0000"  >&lt;p&gt;The Char &amp;amp; Varchar functions were not handled separately to assign to length for the target type (in the bindExpression() method of CastNode.java) and thus a default value of 15 was getting assigned to it (from getColumnDisplaySize() method of DataTypeUtilities class)&lt;/p&gt;

&lt;p&gt;Now I added a check for the string types (i.e. both Char &amp;amp; Varchar) in the source type, and using the operand&apos;s maximum length or the maximum length for that data type (whichever is minimum) and assigning it to be the length for the target type. Thus avoiding the unwanted truncation error caused by the default value of 15.&lt;/p&gt;

&lt;p&gt;Corrospondingly I had to modify following 3 output files for the test cases. :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;java/testing/org/apache/derbyTesting/functionTests/master/cast.out&lt;/li&gt;
	&lt;li&gt;java/testing/org/apache/derbyTesting/functionTests/master/ejbql.ou&lt;br/&gt;
Note : The changes are made to have the new display in the result in ij as earlier the expected result was based on default 15 characters and now it is based on the actual max width of the target type.&lt;/li&gt;
	&lt;li&gt;java/testing/org/apache/derbyTesting/functionTests/master/implicitConversions.out&lt;br/&gt;
Note : In earlier implementation, the expected result was an exception. As the char function use to truncate 26 characters of a timestamp value to default 15 and thus the insertion of truncated value to timestamp type field use to fail. But now as this case is handled, the proper value can be inserted and thus no errors.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12451302" author="knutanders" created="Mon, 20 Nov 2006 13:22:37 +0000"  >&lt;p&gt;The fix and the test changes look correct. I have verified that the repro runs cleanly with the patch. Derbyall and the JUnit tests also run cleanly. Committed revision 477168. Thanks for fixing the bug, Saurabh!&lt;/p&gt;</comment>
                            <comment id="12480168" author="knutanders" created="Mon, 12 Mar 2007 18:52:24 +0000"  >&lt;p&gt;Reopening to back-port the fix to 10.2.&lt;/p&gt;</comment>
                            <comment id="12480170" author="knutanders" created="Mon, 12 Mar 2007 18:55:19 +0000"  >&lt;p&gt;Committed to 10.2 with revision 517332.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12364692">DERBY-2445</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12345227" name="derby_1132_v1.diff" size="5901" author="sv204098" created="Fri, 17 Nov 2006 15:09:33 +0000"/>
                            <attachment id="12345228" name="derby_1132_v1.stat" size="398" author="sv204098" created="Fri, 17 Nov 2006 15:09:33 +0000"/>
                            <attachment id="12325328" name="repro.java" size="1099" author="bryanpendleton" created="Fri, 14 Apr 2006 11:02:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 14 Apr 2006 09:57:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22329</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0n7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37577</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>