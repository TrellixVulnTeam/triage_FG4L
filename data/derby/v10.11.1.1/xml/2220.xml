<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:20:09 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2220/DERBY-2220.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2220] Uncommitted transactions executed throught XAResource will held locks after the application terminates (or crashes during the transaction).</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2220</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Using this piece of code derby will not release a table lock of &apos;dummy&apos; table.&lt;/p&gt;

&lt;p&gt;            String query = &quot;insert into dummy (field1) values (&apos;&quot; + Integer.toString(value) + &quot;&apos;)&quot;;&lt;br/&gt;
            XAConnection xaConnection = createXAConnection(&quot;jdbc:derby://localhost:1527/TestDB&quot;, &quot;&quot;, &quot;&quot;);&lt;br/&gt;
            XAResource xaResource = xaConnection.getXAResource();&lt;br/&gt;
            conn = xaConnection.getConnection();&lt;/p&gt;

&lt;p&gt;            Xid xid = createXid(value);        &lt;/p&gt;

&lt;p&gt;            xaResource.setTransactionTimeout(10);&lt;br/&gt;
            xaResource.start(xid, XAResource.TMNOFLAGS);&lt;/p&gt;

&lt;p&gt;            Statement statement = conn.createStatement();&lt;br/&gt;
            statement.execute(query);        &lt;/p&gt;

&lt;p&gt;            // terminate the client application&lt;br/&gt;
            // this will not release any locks&lt;br/&gt;
            System.exit(0);&lt;/p&gt;</description>
                <environment>Solaris Nevada build 49, Sun&amp;#39;s JDK1.6</environment>
        <key id="12360006">DERBY-2220</key>
            <summary>Uncommitted transactions executed throught XAResource will held locks after the application terminates (or crashes during the transaction).</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="julo">Julius Stroffek</assignee>
                                    <reporter username="julo">Julius Stroffek</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Jan 2007 13:16:40 +0000</created>
                <updated>Fri, 25 Jul 2008 18:36:41 +0100</updated>
                            <resolved>Fri, 23 Mar 2007 07:37:54 +0000</resolved>
                                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12463032" author="julo" created="Mon, 8 Jan 2007 13:22:08 +0000"  >&lt;p&gt;The way how to reproduce the error:&lt;/p&gt;

&lt;p&gt;Run the derby server on localhost (pass these options to java: -Dderby.locks.monitor=true -Dderby.locks.deadlockTrace=true). Execute a code in xxx.sql, run the XATransactionTest.java. Use ij tool to connect to a TestDB database on localhost. Execute the query &apos;select * from dummy;&apos; After a couple of seconds you will get a message&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from dummy;&lt;br/&gt;
ERROR 40XL2: A lock could not be obtained within the time requested.  The lockTable dump is:&lt;br/&gt;
2007-01-08 13:12:52.610 GMT&lt;br/&gt;
XID       |TYPE         |MODE|LOCKCOUNT|LOCKNAME                                                                        |STATE|TABLETYPE / LOCKOBJ                   |INDEXNAME / CONTAINER_ID / (MODE for LATCH only)  |TABLENAME / CONGLOM_ID                |&lt;br/&gt;
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;The following row is the victim ***&lt;br/&gt;
131       |ROW          |S   |0        |(1,7)                                                                           |WAIT |T                             |NULL                                              |DUMMY                                 |&lt;/li&gt;
			&lt;li&gt;The above row is the victim ***&lt;br/&gt;
130       |ROW          |X   |1        |(1,7)                                                                           |GRANT|T                             |NULL                                              |DUMMY                                 |&lt;br/&gt;
130       |TABLE        |IX  |1        |Tablelock                                                                       |GRANT|T                             |NULL                                              |DUMMY                                 |&lt;br/&gt;
131       |TABLE        |IS  |1        |Tablelock                                                                       |GRANT|T                             |NULL                                              |DUMMY                                 |&lt;br/&gt;
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12463055" author="julo" created="Mon, 8 Jan 2007 15:27:22 +0000"  >&lt;p&gt;The problem is in the org.apache.derby.impl.drda.Database class.&lt;/p&gt;

&lt;p&gt;The function close() contains the following code:&lt;/p&gt;

&lt;p&gt;			if ((conn != null) &amp;amp;&amp;amp; !conn.isClosed())&lt;br/&gt;
			{&lt;br/&gt;
				if (! forXA)&lt;/p&gt;
				{
					conn.rollback();
				}
&lt;p&gt;				conn.close();					&lt;br/&gt;
			}&lt;/p&gt;

&lt;p&gt;Thus, the rollback() is not executed for XA connection. Anybody knows the reason why?&lt;/p&gt;</comment>
                            <comment id="12466753" author="julo" created="Tue, 23 Jan 2007 15:27:48 +0000"  >&lt;p&gt;A discussion about the issue at derby-dev could be found at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/Rollback-is-not-executed-only-for-XA-sessions-after-the-socket-is-closed.-tf2940001.html#a8220033&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Rollback-is-not-executed-only-for-XA-sessions-after-the-socket-is-closed.-tf2940001.html#a8220033&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12466760" author="julo" created="Tue, 23 Jan 2007 16:16:14 +0000"  >&lt;p&gt;I spent more time trying to dig out something... There is a good description about the derby implementation in the source of org.apache.derby.iapi.jdbc.ResourceAdapter interface.&lt;/p&gt;

&lt;p&gt;There exist a 1:1 mapping between XAConnection instance and XAResource instance.&lt;/p&gt;

&lt;p&gt;The behaviour how the driver should behave if the connection willl be closed is not covered by the JTA specification at all. The XAResource could be in the following states:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Not Associated with global transaction&lt;/li&gt;
	&lt;li&gt;Associated with global transaction&lt;/li&gt;
	&lt;li&gt;Association Suspended&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;According the JTA Specification if the transaction is suspended, it have to be only resumed, finished with success or error on the same XAResource instance. At least transaction association table shows that the XAResource instance could not be used for something else than calling end(TMRESUME), end(TMFAIL) and end(TMSUCCESS). I found somewhere in code that the derby implements this in the same way (can not find the comment again, still trying &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;It seems that it should be fairly easy and safe to roll back an XA transaction when the logicall connection will be closed by the client and the transaction was in Associated state on that connection.&lt;/p&gt;

&lt;p&gt;However, there is still the case when all the transaction branches are dissassociated from the connections but the application had not done commit or roll back yet and will never do that in the future (wrong code, or application crash). It seems to me that the only one solution to this is to implement some sort of configurable time out for inactivity for global transaction on XAResource instances. Any other suggestions?&lt;/p&gt;</comment>
                            <comment id="12472356" author="julo" created="Mon, 12 Feb 2007 17:35:28 +0000"  >&lt;p&gt;I have created a proposal for the patch.&lt;/p&gt;

&lt;p&gt;It covers only the simple case (for the network driver) when the global transaction is associated with the connection and the application closes the socket. The last transaction associated with the connection will be aborted. I ran the derbyall and suites.All without any failures.&lt;/p&gt;

&lt;p&gt;I would add one more line to DRDAXAProtocol.endXA&lt;br/&gt;
    &quot;this.xid = null;&quot;&lt;br/&gt;
to do rollback only for transactions in unit of work.&lt;/p&gt;

&lt;p&gt;Please, provide any comments.&lt;/p&gt;

&lt;p&gt;Finally, I will write also a test.&lt;/p&gt;</comment>
                            <comment id="12472394" author="mamtas" created="Mon, 12 Feb 2007 19:35:01 +0000"  >&lt;p&gt;Julius, I went through the patch and it looks good and well commented. I was curious though if the existing method rollbackTransaction(Xid xid) in DRDAXAProtocol can be used to do some/all of the work done by the new method abortCurrentTransaction()&lt;/p&gt;</comment>
                            <comment id="12472407" author="knutanders" created="Mon, 12 Feb 2007 20:38:50 +0000"  >&lt;p&gt;I agree with Mamta that the patch looks good. I have one questions, though:&lt;/p&gt;

&lt;p&gt;The xid field in DRDAXAProtocol is only reset to null in abortCurrentTransaction(). Should it also be reset in other methods, for instance in endXA()? It seems to me that abortCurrentTransaction() will always be called when the client disconnects, even when it has done the required cleanup first.&lt;/p&gt;</comment>
                            <comment id="12472571" author="julo" created="Tue, 13 Feb 2007 08:35:24 +0000"  >&lt;p&gt;Mamta: The existing method will send also some DRDA stuff to the socket so the existing one can not be used. I can create a new method to do the common stuff for both methods but I decided that the code for it would be too simple.&lt;/p&gt;

&lt;p&gt;Knut: Yes, I agree with you but currently I am not quite sure in which methods I can disassociate the transaction to be aborted. To clear the xid in endXA() is quite safe but I would like to consider also to clear it only during commit. The question is whether the global transaction might be committed on a different connection. I will try to dig this out.&lt;/p&gt;</comment>
                            <comment id="12472796" author="julo" created="Tue, 13 Feb 2007 17:50:31 +0000"  >&lt;p&gt;What about the second patch?&lt;/p&gt;

&lt;p&gt;I changed the code to maintain the list of all uncommitted transactions and rollback all of them. This should cover the whole problem not only the previous simple case.&lt;/p&gt;

&lt;p&gt;The patch will forbid using the code like this one&lt;/p&gt;

&lt;p&gt;            XAConnection xaConnection = createXAConnection(&quot;jdbc:derby://localhost:1526/TestDB&quot;, &quot;&quot;, &quot;&quot;);&lt;br/&gt;
            XAResource xaResource = xaConnection.getXAResource();&lt;br/&gt;
            conn = xaConnection.getConnection();           &lt;br/&gt;
            XAConnection xaConnection2 = createXAConnection(&quot;jdbc:derby://localhost:1526/TestDB&quot;, &quot;&quot;, &quot;&quot;);&lt;br/&gt;
            XAResource xaResource2 = xaConnection2.getXAResource();&lt;br/&gt;
            Xid xid = createXid(value);        &lt;br/&gt;
            xaResource.start(xid, XAResource.TMNOFLAGS);&lt;br/&gt;
            Statement statement = conn.createStatement();&lt;br/&gt;
            statement.execute(query);            &lt;br/&gt;
            xaResource.end(xid, XAResource.TMSUCCESS);&lt;/p&gt;

&lt;p&gt;            // commiting a transaction on different resource&lt;br/&gt;
            xaResource2.prepare(xid);&lt;br/&gt;
            xaResource2.commit(xid, false);&lt;/p&gt;

&lt;p&gt;It will force the user to commit or rollback the transaction on a same connection as it was executed. I went through JTA API and have not found anything that will state that the JTA implementation have to allow commit/rollback of a transaction on different connection than the unit of work was executed on. At least the specification forbids resuming a suspended transaction on different connection than it was started on. Then I think made also no sense to require to commit or rollback the transaction on the different connection than the unit of work was executed on.&lt;/p&gt;

&lt;p&gt;There exists 1:1 mapping between XAConnection instance and XAResource instance. The XAResource methods use the corresponding logical connection to pass commands to a database.&lt;/p&gt;

&lt;p&gt;Please provide any further comments on this.&lt;/p&gt;</comment>
                            <comment id="12472822" author="djd" created="Tue, 13 Feb 2007 18:38:56 +0000"  >&lt;p&gt;JDBC spec is very clear on this (JDBC 3.0 section 12.4.1)&lt;/p&gt;

&lt;p&gt;&quot;The transaction manager is not required to use the same XAResource object to&lt;br/&gt;
commit/rollback a transaction branch as was used to execute the branch. If different&lt;br/&gt;
XAResource objects are used, however, they must be associated with&lt;br/&gt;
XAConnection objects that connect to the same resource manager.&quot;&lt;/p&gt;

&lt;p&gt;Thus you cannot  force the application to commit using the same XAResource.&lt;/p&gt;</comment>
                            <comment id="12472838" author="knutanders" created="Tue, 13 Feb 2007 19:21:30 +0000"  >&lt;p&gt;Hi Julo,&lt;/p&gt;

&lt;p&gt;I don&apos;t know enough about XA to answer your questions, but I have some general comments to the patch:&lt;/p&gt;

&lt;p&gt;I might be missing something, but doesn&apos;t this part of abortTransactions() cause a NullPointerException?&lt;/p&gt;

&lt;p&gt;+        Xid[] xids = null;&lt;br/&gt;
+        Collection coll = this.xids.values();&lt;br/&gt;
+        if (coll != null &amp;amp;&amp;amp; coll.size() &amp;gt; 0) {&lt;br/&gt;
+            xids = (Xid []) coll.toArray(xids);&lt;/p&gt;

&lt;p&gt;When calling coll.toArray(xids), xids is always null, isn&apos;t it? Also, I think abortTransactions() would be simpler if it used xids.values().iterator() directly instead of converting the collection to an array.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure I see the value of the removeXid parameter to rollbackTransaction(). It might micro-optimize abortTransactions(), but given that abortTransaction() is only invoked in exceptional situations, I don&apos;t think it justifies the extra complexity.&lt;/p&gt;

&lt;p&gt;The patch makes some of the lines in DRDAXAProtocol exceed 80 characters, which should be avoided.&lt;/p&gt;</comment>
                            <comment id="12473075" author="julo" created="Wed, 14 Feb 2007 12:59:32 +0000"  >&lt;p&gt;Dan: Thank you for explanation. It seems that I was reading a wrong book. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Knut: Yes, you are absolutely right - it will not work at all.&lt;/p&gt;</comment>
                            <comment id="12474106" author="julo" created="Mon, 19 Feb 2007 09:57:33 +0000"  >&lt;p&gt;I implemented a change as it was in first proposal. I added the same behaviour also to embedded connection and implemented a test. I added a JDBCXADataSource similar to JDBCDataSource to be able to obtain a XAConnection and XAResource instances.&lt;/p&gt;

&lt;p&gt;btw: Does anybody knows the use case for XADataSourceConnector? I think it is useless for XA transaction since it does not provide a way how to obtain a corresponding XAResource object.&lt;/p&gt;

&lt;p&gt;Comments are welcomed.&lt;/p&gt;</comment>
                            <comment id="12474210" author="julo" created="Mon, 19 Feb 2007 15:52:26 +0000"  >&lt;p&gt;Forgot to add that I ran derbyall and Suites.All with two failures in Suites.All. Both of these failures appear to me also on trunk without any modifications.&lt;/p&gt;

&lt;p&gt;The failing tests are:&lt;br/&gt;
org.apache.derbyTesting.functionTests.tests.jdbcapi.JDBCHarnessJavaTest&lt;br/&gt;
org.apache.derbyTesting.functionTests.tests.jdbcapi.DatabaseMetaDataTest&lt;/p&gt;
</comment>
                            <comment id="12474222" author="djd" created="Mon, 19 Feb 2007 16:23:40 +0000"  >&lt;p&gt;Could you confirm what the patch does. Your first proposal seems to say that if the socket is closed the connection is rolled back,&lt;br/&gt;
but then you add the same behaviour for embedded, but embedded doesn&apos;t use sockets, so I&apos;m not clear what you intend the&lt;br/&gt;
embedded behaviour to be. Thanks.&lt;/p&gt;


&lt;p&gt;Re XADataSourceConnector;&lt;br/&gt;
.&lt;br/&gt;
As its javadoc says &quot;Returns a connection in local mode obtained from getXAConnection().getConnection()&quot;&lt;br/&gt;
It probably could be named better, unless it could be expanded to also provide global transaction support)&lt;/p&gt;

&lt;p&gt;I think it&apos;s there to allow tests to run using a connection object from an XADataSource that remains in local mode.&lt;br/&gt;
Thus allowing increased coverage.&lt;br/&gt;
E.g. one could imagine running all the jdbcapi &amp;amp; jdbc4 tests in multiple connection modes to ensure complete testing:&lt;br/&gt;
  DriverManager.getConnection&lt;br/&gt;
  DataSource&lt;br/&gt;
  XADataSource (local &amp;amp; global)&lt;br/&gt;
  ConnectionPoolDataSource&lt;/p&gt;</comment>
                            <comment id="12474230" author="djd" created="Mon, 19 Feb 2007 17:06:26 +0000"  >&lt;p&gt;Looking at the patch I think you describe the same situation in three different ways:&lt;br/&gt;
  1) global transaction in unit of work   [ not sure if unit of work is the correct description here]&lt;br/&gt;
  2) XA transaction if it was not disassociated from the connection  [ double negative ] &lt;br/&gt;
  3) global/local transaction associated with the connetion [ local transactions are not associated]&lt;/p&gt;

&lt;p&gt;I think this makes the code confusing for later readers who will not have the benefit of seeing all three together.&lt;br/&gt;
I think the correct terminology would be (I assume this is what the patch intends):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the global transaction is associated with the XAResource and the physical connection is closed then rollback the&lt;br/&gt;
global transaction.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the changes to EmbedXAConnection I think two changes are needed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;end the transaction with TMFAIL (resource manager will mark it as rollback-only)&lt;/li&gt;
	&lt;li&gt;do not print the XAException to System.err. The embedded driver must throw its exceptions to&lt;br/&gt;
      the calling program, in this case you need to wrap it in a SQLException&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I didn&apos;t look at the network code, but can local transactions use the new abortCurrentTransaction method DRDAXAProtocol?&lt;br/&gt;
Using the term associated here with local connection is confusing, since associated is for XA global transactions..&lt;/p&gt;



</comment>
                            <comment id="12474689" author="julo" created="Wed, 21 Feb 2007 12:51:49 +0000"  >&lt;p&gt;Dan, I agree with your comments and I will update the patch.&lt;/p&gt;

&lt;p&gt;&amp;gt; I didn&apos;t look at the network code, but can local transactions use the new abortCurrentTransaction method DRDAXAProtocol?&lt;br/&gt;
&amp;gt; Using the term associated here with local connection is confusing, since associated is for XA global transactions..&lt;/p&gt;

&lt;p&gt;I call the existing method DRDAXAProtocol.rollbackTransaction method in a new abortCurrentTransaction. Since the rollbackTransaction could be used for local transactions abortCurrentTransaction could be also used.&lt;/p&gt;
</comment>
                            <comment id="12474776" author="julo" created="Wed, 21 Feb 2007 17:55:47 +0000"  >&lt;p&gt;I tried this simple test program to run against trunk to find out whether it is possible to join a global transaction after a connection is closed from a different connection and recover in this way. The following code stopped in endless wait on xaResource2.start(xid, XAResource.TMJOIN) waiting for a transaction to be disassociated from the connection already closed.&lt;/p&gt;

&lt;p&gt;            xaResource.start(xid, XAResource.TMNOFLAGS);           &lt;br/&gt;
            Statement statement = conn.createStatement();&lt;br/&gt;
            statement.execute(query);&lt;br/&gt;
            xaConnection.close();&lt;/p&gt;

&lt;p&gt;            xaResource2.start(xid, XAResource.TMJOIN);&lt;br/&gt;
            xaResource2.end(xid, XAResource.TMSUCCESS);&lt;br/&gt;
            xaResource2.commit(xid, true);&lt;/p&gt;

&lt;p&gt;            System.exit(0);&lt;br/&gt;
-------&lt;br/&gt;
Dan: I applied your comments except that in Embedded driver I do not used the TMFAIL flag because handling a one more exception separately would make the code a bit worse readable. I think there is no difference in this since the transaction is rollbacked on the following line. It will be explained in a comment. The only difference is a case when the rollback fails, but I am not sure what else we can do with a transaction which cannot be committed and fails to rollback.&lt;/p&gt;

&lt;p&gt;I am running test suites now and I will post a new patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="12475027" author="julo" created="Thu, 22 Feb 2007 14:39:19 +0000"  >&lt;p&gt;The test suites finished successfully except the junit JDBCHarnessJavaTest which fails me also on trunk.&lt;/p&gt;

&lt;p&gt;Just for explanation of changes to embedded driver:&lt;br/&gt;
When I wrote a test I tried it to run also using the embedded driver and it fails with the XAER_PROTO exception. However, I do not see any reason why this test should not succeed since closing the socket on network connection and closing an embedded connection should behave the same from this point of view.&lt;/p&gt;

&lt;p&gt;Any comments?&lt;/p&gt;</comment>
                            <comment id="12475048" author="djd" created="Thu, 22 Feb 2007 15:44:42 +0000"  >&lt;p&gt;Julius wrote: &quot;When I wrote a test I tried it to run also using the embedded driver and it fails with the XAER_PROTO exception. However, I do not see any reason why this test should not succeed since closing the socket on network connection and closing an embedded connection should behave the same from this point of view. &quot;&lt;/p&gt;

&lt;p&gt;I&apos;m a little lost here as I&apos;m still unclear of what you intend the patch to do (see my first comment on 19th feb).&lt;br/&gt;
For the network server I thought this was addressing the case when the socket became closed due to unexpected behaviour, like the client application quitting, or the network link going down.&lt;br/&gt;
For embedded however, the physical connection cannot break that way &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, so the code seems to be addressing the case where an explicit close is performed by the application or the transaction manager. Is this the intention? Does the network client work the same way? Should this infact be a protocol error as it is a violation of the api by the transaction manager?&lt;/p&gt;

&lt;p&gt;A quick summary of what you intend the patch to do would be great.&lt;/p&gt;

</comment>
                            <comment id="12475065" author="djd" created="Thu, 22 Feb 2007 16:10:41 +0000"  >&lt;p&gt;On the test changes in the patch:&lt;/p&gt;

&lt;p&gt;J2EEDataSource already has methods to get XADataSources, so I don&apos;t think you need to add JDBCXADataSource.&lt;/p&gt;

&lt;p&gt;This comment in the test concerns me:&lt;/p&gt;

&lt;p&gt;+        // We need to do such a special setup for the test&lt;br/&gt;
+        // because if the locks are not released when the&lt;br/&gt;
+        // XAConnection object is closed the database&lt;br/&gt;
+        // can not be cleaned by CleanDatabaseSetup (throught defaultSuite)&lt;br/&gt;
+        // but DropDatabaseSetup (throught singelUseDatabaseDecorator)&lt;br/&gt;
+        // have to be used instead. This will ensures that the database&lt;br/&gt;
+        // will be cleaned after the test&lt;/p&gt;

&lt;p&gt;Isn&apos;t this bug trying to address those issue? Having this style of cleanup will surely lead to bugs being hidden?&lt;br/&gt;
A safer approach would seem to be use the standard database and address/report issues as they appear.&lt;/p&gt;</comment>
                            <comment id="12475075" author="julo" created="Thu, 22 Feb 2007 16:28:02 +0000"  >&lt;p&gt;&amp;gt; Isn&apos;t this bug trying to address those issue? Having this style of cleanup will surely lead to bugs being hidden?&lt;br/&gt;
&amp;gt; A safer approach would seem to be use the standard database and address/report issues as they appear.&lt;/p&gt;

&lt;p&gt;Yes, the bug addresses exactly this issue.&lt;/p&gt;

&lt;p&gt;However, If I will use CleanDatabaseTesetSetup instead of the DropDatabaseTestSetup and the bug will appear again the test will lock for a while in CleanDatabaseTestSetup (need to timeout 5 times in CleanDatabaseTestSetup.removeObjects trying to obtain lock). I tried to run a test also on a code not fixied yet.&lt;/p&gt;

&lt;p&gt;If the lock is not released the following select statement raise an exception. The engine is shutted down afterwards and the database is dropped which is much faster and also detects the bug.&lt;/p&gt;</comment>
                            <comment id="12475081" author="djd" created="Thu, 22 Feb 2007 16:51:04 +0000"  >&lt;p&gt;The more worrying case is when locks are held on objects for which asserts do not exist on the test. Such a cleanup approach will hide those bugs.&lt;/p&gt;

&lt;p&gt;I personally would not optimize tests for the time that they fail.&lt;/p&gt;

&lt;p&gt;I also think that you&apos;ve found an issue in the clean database decorator and as such it would be good to fix it centrally there, rather than in a single test. for example, if the clean database decorator failed to cleanup the database, it could report the failure and then blow away the database. This would not need to be part of this issue or addressed urgently, as your test would not rely on it as it will be passing, right &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12475103" author="julo" created="Thu, 22 Feb 2007 17:49:11 +0000"  >&lt;p&gt;From the XA Transaction Specification from the OpenGroup:&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
It is an error, &lt;span class=&quot;error&quot;&gt;&amp;#91;XAER_PROTO&amp;#93;&lt;/span&gt;, for a transaction manager to call xa_close () within a&lt;br/&gt;
thread of control that is associated with a transaction branch (that is, the transaction&lt;br/&gt;
manager must call xa_end() before calling xa_close ()).&lt;br/&gt;
&amp;#8212;&lt;/p&gt;

&lt;p&gt;So a change proposed in a patch is against this spec. It should be possible to close a xa network connection on the trunk but not the ebedded one. To implement this according a spec should be:&lt;br/&gt;
1.) undo any changes made to embedded connection&lt;br/&gt;
2.) check in the network client code (ClientXAConnection) when closing a connection to a database whether it is already associated with the global transaction. If so, do not allow a connection to be closed.&lt;/p&gt;

&lt;p&gt;However, from my point of view it would be clearer to allow a connection to be closed and rollback the associated transactions. I do not know whether it would be possible to even make the behavior against the spec in some cases but I would like to discuss the difference.&lt;/p&gt;

&lt;p&gt;I would expect that a transaction manager or an application would call the XAConnection.close when it is associated with a transaction only in a exceptional case when it &apos;does not know what else to do&apos;. This could happen after throwing an unpredictable exceptions which do not have to be handled - like NullPointerException. The handling of such an exception usually propagates through couple of functions in the call stack. Usually, in this case the application do not have to know the valid xid of the transaction or it do not have to know even whether the xa connection is associated with the transaction or not. What the application should do?&lt;/p&gt;

&lt;p&gt;1.) If it uses a transaction manager, the xid is stored in a transaction manager and if it has a reference to transaction manager it can do some work with the transaction - probably roll back&lt;/p&gt;

&lt;p&gt;2.) If it uses XAResource and XAConnection directly, it may happen that the application will loose xid and not the XAResource or XAConnection references (these might be shared across the application). What to do in this case?&lt;/p&gt;

&lt;p&gt;I am trying to think of an application with not the optimal design. This leads me what happens if all the objects would be garbage collected? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;br/&gt;
Now I think that the best approach is to implement XAConnection.close according the specs and to provide the cleanup with rollback of transactions in XAConnectionImpls.finalize methods (as it is implemented now in close methods of the patch). I checked the code for this fastly and it looks like it is not handled this way. I&apos;ll check this in more detail and I&apos;ll create a new jira issue to address this separately.&lt;/p&gt;</comment>
                            <comment id="12475370" author="djd" created="Fri, 23 Feb 2007 15:49:53 +0000"  >&lt;p&gt;Patch (as comments show) does not implement the spec for close() correctly so unsetting the patch available flag.&lt;/p&gt;</comment>
                            <comment id="12477222" author="julo" created="Fri, 2 Mar 2007 08:18:34 +0000"  >&lt;p&gt;This patch implements the following:&lt;/p&gt;

&lt;p&gt;1.) Rollback the global transaction on a derby server when the network socket is closed.&lt;br/&gt;
2.) Forbid the call to XAConnection.close when there is a global transaction associated with the corresponding resource. Similar code is added to the embedded driver and client driver as well. The state of the connection is not changed at all.&lt;br/&gt;
3.) Test for 2.) is added. I did not write a test for 1.) because I find it a bit more difficult since a test does not have an access to the underlying code to close the socket.&lt;/p&gt;

&lt;p&gt;Because the XAConnection is a subclass of PooledConnection object the close method throws only SQLException and not XAException. According DTP XA Spec the xa_close should return XAER_PROTO which should map to XAException. This is not possible and the same SQLException is thrown now as the embedded driver did before. I added the code for embedded driver to handle XA case separately because the connection was left in a state when it could not be used anymore.&lt;/p&gt;

&lt;p&gt;Any comments?&lt;/p&gt;</comment>
                            <comment id="12478208" author="prashantbhagat" created="Mon, 5 Mar 2007 23:37:03 +0000"  >&lt;p&gt;Hi Lance,&lt;br/&gt;
I&apos;m working for the BPEL Service Engine team in the Alaska project. &lt;br/&gt;
Julius (from Java DB support team) has fixed a bug that I reported in &lt;br/&gt;
Derby and has created a patch. We would like to know&lt;br/&gt;
1. How and when do new releases of Derby get integrated in glassfish?&lt;br/&gt;
2. How do patches, such as this one, get integrated in glassfish?&lt;/p&gt;

&lt;p&gt;Binod from the glassfish team gave me your reference and said that you &lt;br/&gt;
might know this. If not, do you know who the right person is who can &lt;br/&gt;
give this information.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Prashant&lt;/p&gt;

</comment>
                            <comment id="12478794" author="knutanders" created="Wed, 7 Mar 2007 15:17:02 +0000"  >&lt;p&gt;Is point 2 (Forbid the call to XAConnection.close when there is a global transaction associated with the corresponding resource) a necessary part of this bug fix, or would it be better to discuss/fix it under a separate issue?&lt;/p&gt;

&lt;p&gt;It seems to me the patch correctly implements what you have described. I&apos;m a little confused after reading the discussion. Was there ever consensus that the described approach was correct? It does sound correct to me, but I haven&apos;t studied all the different standards mentioned.&lt;/p&gt;

&lt;p&gt;Some small questions and comments to the try4 patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;could NetXAResource.currentXid have been private?&lt;/li&gt;
	&lt;li&gt;abortCurrentTransaction() checks (e.errorCode != XAException.XA_RBOTHER &amp;amp;&amp;amp; e.errorCode != XAException.XA_RBROLLBACK). Would it make sense to test (errorCode &amp;lt; XA_RBBASE || errorCode &amp;gt; XA_RBEND) instead?&lt;/li&gt;
	&lt;li&gt;ClientPooledConnection (super class of ClientXAConnection) calls close() in its finalize method (existing code). With the new exception thrown by ClientXAConnection.close(), could that cause a problem when an active XAConnection is garbage collected?&lt;/li&gt;
	&lt;li&gt;should XATransactionTest have been added to jdbcapi._Suite so that it runs under suites.All?&lt;/li&gt;
	&lt;li&gt;I think the suite() method could be simplified to &quot;return TestConfiguration.defaultSuite(...)&quot;&lt;/li&gt;
	&lt;li&gt;the Statement objects in testXAConnection() are not closed&lt;/li&gt;
	&lt;li&gt;in previous discussions about JUnit tests it has been mentioned that referencing constants in org.apache.derby.shared.common.reference.SQLState in tests is not recommended. Instead one should hard code the SQL state (in this case &quot;25000&quot;) in the test. Also, I would recommend using BaseJDBCTestCase.assertSQLState() instead of assertTrue(ex.getSQLState().equals...).&lt;/li&gt;
	&lt;li&gt;there is a test for XAConnection.close() that is supposed to fail. What about adding a test case where it doesn&apos;t fail?&lt;/li&gt;
	&lt;li&gt;I&apos;m not a big fan of finally clauses in the tests, since exceptions in them might hide the original error. Putting the cleanup code outside the finally clause would only be a problem if the test fails, and I agree with Dan&apos;s previous comment about not optimizing tests for the time when they fail.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12479343" author="julo" created="Thu, 8 Mar 2007 15:52:50 +0000"  >&lt;p&gt;&amp;gt; Is point 2 (Forbid the call to XAConnection.close when there is a global transaction&lt;br/&gt;
&amp;gt; associated with the corresponding resource) a necessary part of this bug fix,&lt;br/&gt;
&amp;gt; or would it be better to discuss/fix it under a separate issue?&lt;/p&gt;

&lt;p&gt;Ok Knut, to make thinks simpler for discussion I have created a separate issue for this - &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2420&quot; title=&quot;XAConnection close method should throw an exception if it is called when the global transaction is associated with the connection.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2420&quot;&gt;DERBY-2420&lt;/a&gt;. I will move the discussion there...&lt;/p&gt;

&lt;p&gt;&amp;gt; abortCurrentTransaction() checks (e.errorCode != XAException.XA_RBOTHER &amp;amp;&amp;amp; e.errorCode != XAException.XA_RBROLLBACK).&lt;br/&gt;
&amp;gt; Would it make sense to test (errorCode &amp;lt; XA_RBBASE || errorCode &amp;gt; XA_RBEND) instead? &lt;/p&gt;

&lt;p&gt;Yes, it would. Thanks, I have not noticed that fields in XAException.&lt;/p&gt;

&lt;p&gt;&amp;gt; - there is a test for XAConnection.close() that is supposed to fail. What about adding a test case where it doesn&apos;t fail?&lt;/p&gt;

&lt;p&gt;I think, this case is already covered by xaSimplePositive.sql and xaSimpleNegative.sql and other XA tests.&lt;/p&gt;

&lt;p&gt;And I completely agree with all your other comments. I&apos;ll prepare a patch for those under the new issue.&lt;/p&gt;</comment>
                            <comment id="12479348" author="julo" created="Thu, 8 Mar 2007 16:19:07 +0000"  >&lt;p&gt;This patch covers only the case when the socket from the client&apos;s connection is closed and the global transaction was associated with the connection. In this case, the global transaction will be rolled back. The test for this behavior is not written yet and I plan to cover this in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2421&quot; title=&quot;implement the finalize method separately (currently, the close method is called) for both client and network drivers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2421&quot;&gt;&lt;del&gt;DERBY-2421&lt;/del&gt;&lt;/a&gt; with a test for the proper garbage collection.&lt;/p&gt;</comment>
                            <comment id="12479422" author="julo" created="Thu, 8 Mar 2007 20:43:21 +0000"  >&lt;p&gt;Knut, sorry I forgot to explain your important comment:&lt;/p&gt;

&lt;p&gt;&amp;gt; It seems to me the patch correctly implements what you have described. I&apos;m a little confused after reading the discussion.&lt;br/&gt;
&amp;gt; Was there ever consensus that the described approach was correct? It does sound correct to me, but I haven&apos;t studied&lt;br/&gt;
&amp;gt; all the different standards mentioned.&lt;/p&gt;

&lt;p&gt;In Derbby XAConnection and XAResource instances are mapped 1:1. The methods of XAResource instance in network driver use the XAConnection instance to send all the DRDA commands throught the socket. Thus if the socket will be closed when the transaction is associated with the connection, there is no way how to continue the work on that transaction. You can not join that transaction, you can not end the association of that transaction, you can not rollback nor commit the transaction. The locks held by the transaction will not be released. This is not covered by the any of these specs and the proposed behavior can be only done because of the way how derby implements the spec - it uses the same socket for both - XAConnection and XAResource.&lt;/p&gt;

&lt;p&gt;If derby would use a different socket for the XAResource object than the XAConnection, this would not be possible because if the connection would be closed you could still end the association of the transaction with the resource, but this is not possible in derby.&lt;/p&gt;

&lt;p&gt;I think all these facts are mentioned in the discussion but there is no summary explaining it.&lt;/p&gt;
</comment>
                            <comment id="12479537" author="knutanders" created="Fri, 9 Mar 2007 08:45:45 +0000"  >&lt;p&gt;Thanks for the explanation and for splitting the patch. It&apos;s much clearer to me now. I have started the regression tests. If they pass and no one objects to this approach within a couple of days, I will commit the try5 patch.&lt;/p&gt;</comment>
                            <comment id="12480012" author="knutanders" created="Mon, 12 Mar 2007 08:42:15 +0000"  >&lt;p&gt;Committed revision 517131. Should this fix be back-ported to the 10.2 branch?&lt;/p&gt;</comment>
                            <comment id="12480101" author="julo" created="Mon, 12 Mar 2007 14:12:58 +0000"  >&lt;p&gt;Thanks, Knut.&lt;/p&gt;

&lt;p&gt;Yes, I would like to back-port the patch also. I applied the patch committed to trunk to 10.2 branch and it succeeded. I checked the sources and everything looks alright. Now, I am running the tests and once they will finish without failures, I will submit a patch against 10.2 branch.&lt;/p&gt;</comment>
                            <comment id="12480106" author="knutanders" created="Mon, 12 Mar 2007 14:28:15 +0000"  >&lt;p&gt;I don&apos;t think a new patch is required. The fix merged cleanly to 10.2 with this command:&lt;br/&gt;
  svn merge -c 517131 ../trunk&lt;/p&gt;</comment>
                            <comment id="12480115" author="julo" created="Mon, 12 Mar 2007 15:09:01 +0000"  >&lt;p&gt;Oohhh, great. Thanks, Knut.&lt;/p&gt;</comment>
                            <comment id="12480162" author="knutanders" created="Mon, 12 Mar 2007 18:32:39 +0000"  >&lt;p&gt;Reopening to port to 10.2.&lt;/p&gt;</comment>
                            <comment id="12480163" author="knutanders" created="Mon, 12 Mar 2007 18:36:44 +0000"  >&lt;p&gt;Tests finished successfully on the 10.2 branch. Committed to 10.2 with revision 517320.&lt;/p&gt;</comment>
                            <comment id="12480166" author="knutanders" created="Mon, 12 Mar 2007 18:40:06 +0000"  >&lt;p&gt;Changing affects version from 10.2.3.0 to 10.2.2.0 since there is no 10.2.3.0 yet.&lt;/p&gt;</comment>
                            <comment id="12480421" author="julo" created="Tue, 13 Mar 2007 14:55:44 +0000"  >&lt;p&gt;I am sorry, Knut, I misunderstood the comment about merging to 10.2, so I thought It was also committed. Thanks again! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12482876" author="julo" created="Wed, 21 Mar 2007 19:03:29 +0000"  >&lt;p&gt;I found an error in the patch. The fix will follow immediately.&lt;/p&gt;</comment>
                            <comment id="12482880" author="julo" created="Wed, 21 Mar 2007 19:09:33 +0000"  >&lt;p&gt;In DRDAXAProtocol the null value was assigned to a local variable instead of the global one. This causes the last transaction to be rolled back after the connection will be closed even if the XAResource.end was called before.&lt;/p&gt;

&lt;p&gt;Lesson learned: Better, do not use the same names for arguments and class members.&lt;/p&gt;</comment>
                            <comment id="12483050" author="julo" created="Thu, 22 Mar 2007 08:12:11 +0000"  >&lt;p&gt;Forgot to add that I ran derbyall and suites.All without failures except &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2434&quot; title=&quot;HarnessJavaTest fails on UTF-8 locale.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2434&quot;&gt;&lt;del&gt;DERBY-2434&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12483447" author="knutanders" created="Fri, 23 Mar 2007 07:37:54 +0000"  >&lt;p&gt;Thanks for the fix, Julo!&lt;br/&gt;
Committed to trunk with revision 521609.&lt;br/&gt;
Committed to 10.2 with revision 521610.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12348498" name="XATranTest.java" size="3870" author="julo" created="Mon, 8 Jan 2007 13:17:35 +0000"/>
                            <attachment id="12350945" name="d2220_beta.diff" size="2594" author="julo" created="Mon, 12 Feb 2007 17:35:28 +0000"/>
                            <attachment id="12351064" name="d2220_beta2.diff" size="6791" author="julo" created="Tue, 13 Feb 2007 17:50:31 +0000"/>
                            <attachment id="12353884" name="d2220_fix.diff" size="503" author="julo" created="Wed, 21 Mar 2007 19:09:33 +0000"/>
                            <attachment id="12353885" name="d2220_fix.stat" size="157" author="julo" created="Wed, 21 Mar 2007 19:09:33 +0000"/>
                            <attachment id="12351483" name="d2220_try1.diff" size="20098" author="julo" created="Mon, 19 Feb 2007 09:57:33 +0000"/>
                            <attachment id="12351484" name="d2220_try1.stat" size="639" author="julo" created="Mon, 19 Feb 2007 09:57:33 +0000"/>
                            <attachment id="12351809" name="d2220_try2.diff" size="20819" author="julo" created="Thu, 22 Feb 2007 14:39:18 +0000"/>
                            <attachment id="12351810" name="d2220_try2.stat" size="639" author="julo" created="Thu, 22 Feb 2007 14:39:18 +0000"/>
                            <attachment id="12352401" name="d2220_try4.diff" size="15683" author="julo" created="Fri, 2 Mar 2007 08:18:33 +0000"/>
                            <attachment id="12352402" name="d2220_try4.stat" size="700" author="julo" created="Fri, 2 Mar 2007 08:18:34 +0000"/>
                            <attachment id="12352929" name="d2220_try5.diff" size="6317" author="julo" created="Thu, 8 Mar 2007 16:19:07 +0000"/>
                            <attachment id="12352930" name="d2220_try5.stat" size="326" author="julo" created="Thu, 8 Mar 2007 16:19:07 +0000"/>
                            <attachment id="12348499" name="xxx.sql" size="125" author="julo" created="Mon, 8 Jan 2007 13:17:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 12 Feb 2007 19:35:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22949</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ymv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39429</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>