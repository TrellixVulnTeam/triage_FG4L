<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6563/DERBY-6563.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6563] NOT elimination for CASE expressions is broken</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6563</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;NOT elimination for CASE expressions seems to be broken. Take this example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; select * from sysibm.sysdummy1 where not ( case when ibmreqd = &apos;Y&apos; then true else true end );
IBM&amp;amp;
----
Y   

1 row selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both branches of the CASE expression evaluate to TRUE, so one would expect the predicate &quot;not ( case ... )&quot; to evaluate to FALSE, and the query should return an empty result.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12712302">DERBY-6563</key>
            <summary>NOT elimination for CASE expressions is broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 May 2014 13:40:19 +0100</created>
                <updated>Wed, 15 Oct 2014 17:28:51 +0100</updated>
                            <resolved>Wed, 15 Oct 2014 17:28:51 +0100</resolved>
                                    <version>10.10.2.0</version>
                                    <fixVersion>10.10.2.1</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13989484" author="knutanders" created="Mon, 5 May 2014 14:01:26 +0100"  >&lt;p&gt;ConditionalNode.eliminateNots() eliminates NOTs by swapping the THEN and ELSE branch of the top-level ConditionalNode.&lt;/p&gt;

&lt;p&gt;For two-legged CASE expressions (such as the one in the bug description), it means that&lt;/p&gt;

&lt;p&gt;NOT CASE WHEN expr1 THEN expr2 ELSE expr3 END&lt;/p&gt;

&lt;p&gt;is rewritten to&lt;/p&gt;

&lt;p&gt;CASE WHEN expr1 THEN expr3 ELSE expr2 END&lt;/p&gt;

&lt;p&gt;For three-legged (or more) expressions,&lt;/p&gt;

&lt;p&gt;NOT CASE WHEN expr1 THEN expr2 WHEN expr3 THEN expr4 ELSE expr5 END&lt;/p&gt;

&lt;p&gt;becomes&lt;/p&gt;

&lt;p&gt;CASE WHEN expr1 THEN CASE WHEN expr3 THEN expr4 ELSE expr5 END ELSE expr2 END&lt;/p&gt;

&lt;p&gt;In neither of the cases, the rewritten expression is equivalent to the original expression.&lt;/p&gt;

&lt;p&gt;I believe a more correct rewrite would be&lt;/p&gt;

&lt;p&gt;CASE WHEN expr1 THEN NOT expr2 else NOT expr3 END&lt;/p&gt;

&lt;p&gt;in the two-legged case, and similar for the three-or-more-legged case.&lt;/p&gt;</comment>
                            <comment id="13989500" author="knutanders" created="Mon, 5 May 2014 14:21:17 +0100"  >&lt;p&gt;It also affects NULLIF, since ConditionalNode is used by both CASE and NULLIF.&lt;/p&gt;

&lt;p&gt;For example, these two queries are equivalent, but they return different results:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; select * from (values false) v(b) where not(nullif(b, true));
B    
-----

0 rows selected
ij&amp;gt; select * from (values false) v(b) where nullif(b, true) = false;
B    
-----
false

1 row selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is the second one that&apos;s correct.&lt;/p&gt;</comment>
                            <comment id="13990356" author="knutanders" created="Tue, 6 May 2014 07:51:30 +0100"  >&lt;p&gt;There are actually two problems with ConditionalNode.eliminateNots():&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;It&apos;s incomplete because
	&lt;ul&gt;
		&lt;li&gt;a) it doesn&apos;t descend into the testCondition field (the expression in the WHEN clause)&lt;/li&gt;
		&lt;li&gt;b) it doesn&apos;t do anything if the top-level node is not under a NOT node&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;When it actually does something, it changes the tree in a way that alters the meaning&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The former is not causing any wrong results. It&apos;s just that an optimization is skipped so that some NOT nodes that could have been eliminated from the child expressions, are not eliminated.&lt;/p&gt;

&lt;p&gt;The latter is causing wrong results.&lt;/p&gt;

&lt;p&gt;The attached patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12643490/12643490_d6563-1a.diff&quot; title=&quot;d6563-1a.diff attached to DERBY-6563&quot;&gt;d6563-1a.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; fixes both of the issues. The method now always descends into the THEN and ELSE clauses, and inverts them if (and only if) the node is under a NOT node. It now also descends into the WHEN clause to eliminate unnecessary NOT nodes below it, but it never inverts that clause, since that would alter the meaning of the expression.&lt;/p&gt;

&lt;p&gt;The regression tests passed with the patch.&lt;/p&gt;</comment>
                            <comment id="13991298" author="dagw" created="Wed, 7 May 2014 00:01:03 +0100"  >&lt;p&gt;Good catch!! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13991305" author="dagw" created="Wed, 7 May 2014 00:06:29 +0100"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13991654" author="jira-bot" created="Wed, 7 May 2014 08:56:38 +0100"  >&lt;p&gt;Commit 1592945 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1592945&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1592945&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6563&quot; title=&quot;NOT elimination for CASE expressions is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6563&quot;&gt;&lt;del&gt;DERBY-6563&lt;/del&gt;&lt;/a&gt;: NOT elimination for CASE expressions is broken&lt;/p&gt;</comment>
                            <comment id="13991655" author="knutanders" created="Wed, 7 May 2014 08:57:14 +0100"  >&lt;p&gt;Thanks for reviewing the patch, Dag!&lt;/p&gt;</comment>
                            <comment id="14165948" author="mikem" created="Fri, 10 Oct 2014 00:05:05 +0100"  >&lt;p&gt;reopening for 10.10 backport, temp assigning myself while working on this.&lt;/p&gt;</comment>
                            <comment id="14167203" author="jira-bot" created="Fri, 10 Oct 2014 18:51:36 +0100"  >&lt;p&gt;Commit 1630946 from mikem@apache.org in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1630946&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1630946&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6563&quot; title=&quot;NOT elimination for CASE expressions is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6563&quot;&gt;&lt;del&gt;DERBY-6563&lt;/del&gt;&lt;/a&gt;: NOT elimination for CASE expressions is broken&lt;/p&gt;

&lt;p&gt;backporting change #1592945 from trunk to 10.10 branch.  Had to resolve&lt;br/&gt;
conflicts and change code in tests to compile/run in pre-jdk15 environments.&lt;/p&gt;</comment>
                            <comment id="14168218" author="myrna" created="Sat, 11 Oct 2014 16:55:47 +0100"  >&lt;p&gt;After this check-in the build in one of my environments (windows) fails and this results in many test failures.&lt;br/&gt;
The build failure is like this:&lt;br/&gt;
---------------------------------------------------&lt;br/&gt;
Failed with following errors. Check details in buildZip.txt&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; D:\svnnightlies\v10_10\src\opensource\java\testing\org\apache\derbyTesting\functionTests\tests\lang\CaseExpressionTest.java:472: error: cannot find symbol&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;                 rows.add(Arrays.copyOf(row, 3));&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;                                ^&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;   symbol:   method copyOf(Object[],int)&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;   location: class Arrays&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; 1 error&lt;/p&gt;

&lt;p&gt;There are what I think are subsequent build errors:&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; D:\svnnightlies\v10_10\src\opensource\java\testing\org\apache\derbyTesting\functionTests\tests\lang\LangProcedureTest.java:26: error: cannot find symbol&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; import java.sql.DriverManager;&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;                ^&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;   symbol:   class DriverManager&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;   location: package java.sql&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; D:\svnnightlies\v10_10\src\opensource\java\testing\org\apache\derbyTesting\functionTests\tests\lang\RolesTest.java:30: error: cannot find symbol&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; import javax.sql.PooledConnection;&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;                 ^&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;   symbol:   class PooledConnection&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;   location: package javax.sql&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; D:\svnnightlies\v10_10\src\opensource\java\testing\org\apache\derbyTesting\functionTests\tests\lang\RolesTest.java:31: error: cannot find symbol&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; import javax.sql.ConnectionPoolDataSource;&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;                 ^&lt;br/&gt;
		    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;   symbol:   class ConnectionPoolDataSource&lt;/p&gt;</comment>
                            <comment id="14168390" author="jira-bot" created="Sat, 11 Oct 2014 23:38:06 +0100"  >&lt;p&gt;Commit 1631134 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631134&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1631134&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6563&quot; title=&quot;NOT elimination for CASE expressions is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6563&quot;&gt;&lt;del&gt;DERBY-6563&lt;/del&gt;&lt;/a&gt;; NOT elimination for CASE expressions is broken&lt;br/&gt;
   replacing usage of Java 1.6 method Arrays.copyOf with System.arraycopy call as 10.10 supports Java 1.5.&lt;/p&gt;</comment>
                            <comment id="14171210" author="myrna" created="Tue, 14 Oct 2014 17:52:37 +0100"  >&lt;p&gt;There is an additional failure with IBM&apos;s j2ME implementation:&lt;/p&gt;

&lt;p&gt;1) testParameters(org.apache.derbyTesting.functionTests.tests.lang.CaseExpressionTest)java.lang.NoSuchMethodError: java/sql/PreparedStatement.getParameterMetaData()Ljava/sql/ParameterMetaData;&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.CaseExpressionTest.testParameters(CaseExpressionTest.java:518)&lt;br/&gt;
	at java.lang.reflect.AccessibleObject.invokeV(AccessibleObject.java:195)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:119)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBareOverridable(BaseJDBCTestCase.java:442)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBare(BaseJDBCTestCase.java:459)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;

&lt;p&gt;(see: &lt;a href=&quot;http://people.apache.org/~myrnavl/derby_test_results/v10_10/windows/testlog/weme6.2/1631607-suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~myrnavl/derby_test_results/v10_10/windows/testlog/weme6.2/1631607-suites.All_diff.txt&lt;/a&gt;. The other failures are the result of backport attempt for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6629&quot; title=&quot;Restrict privileged operation in CreateXMLFile&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6629&quot;&gt;&lt;del&gt;DERBY-6629&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="14171650" author="jira-bot" created="Tue, 14 Oct 2014 23:37:24 +0100"  >&lt;p&gt;Commit 1631920 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631920&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1631920&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6563&quot; title=&quot;NOT elimination for CASE expressions is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6563&quot;&gt;&lt;del&gt;DERBY-6563&lt;/del&gt;&lt;/a&gt;; NOT elimination for CASE expressions is broken&lt;br/&gt;
   skipping a check not supported by JSR169&lt;/p&gt;</comment>
                            <comment id="14172545" author="mikem" created="Wed, 15 Oct 2014 17:28:51 +0100"  >&lt;p&gt;backported to 10.10, resolving and reassigning original owner.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12748024">DERBY-6762</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12746192">DERBY-6759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12643490" name="d6563-1a.diff" size="9046" author="knutanders" created="Tue, 6 May 2014 07:51:30 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 May 2014 23:01:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390618</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzp4yf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390864</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>