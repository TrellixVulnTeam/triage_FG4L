<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:27:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4960/DERBY-4960.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4960] Race condition in FileContainer#allocCache when reopening RAFContainer after interrupt</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4960</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The symptom is an ArrayIndexOutOfBoundsException:&lt;/p&gt;

&lt;p&gt;java.lang.ArrayIndexOutOfBoundsException: -1&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.AllocationCache.validate(AllocationCache.java:581)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.AllocationCache.getLastPageNumber(AllocationCache.java:122)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.FileContainer.pageValid(FileContainer.java:2067)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.FileContainer.getUserPage(FileContainer.java:2522)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.FileContainer.getInsertablePage(FileContainer.java:2867)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.FileContainer.getPageForInsert(FileContainer.java:3017)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.BaseContainerHandle.getPageForInsert(BaseContainerHandle.java:372)&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.HeapController.doInsert(HeapController.java:244)&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.HeapController.insertAndFetchLocation(HeapController.java:599)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:452)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:1028)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:505)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:317)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1241)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1686)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:308)&lt;br/&gt;
	at InterruptTest$WorkerThread.run(InterruptTest.java:261&lt;/p&gt;

&lt;p&gt;This can only happen if another thread has called allocCache.reset while the thread above is in the loop in validate, so as to set numExtents to 0.&lt;br/&gt;
The synchronization of allocCache is documented in the Javadoc of the FileContainer class: all accesses to allocCache should synchronize.&lt;br/&gt;
This is omitted when we reopen: FileContainer#openContainer calls readHeader -&amp;gt; readHeaderFromArray -&amp;gt; allocCache.reset&lt;/p&gt;</description>
                <environment></environment>
        <key id="12494893">DERBY-4960</key>
            <summary>Race condition in FileContainer#allocCache when reopening RAFContainer after interrupt</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Jan 2011 23:19:01 +0000</created>
                <updated>Tue, 19 Apr 2011 13:39:04 +0100</updated>
                            <resolved>Sat, 8 Jan 2011 01:55:13 +0000</resolved>
                                    <version>10.8.1.2</version>
                                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12978577" author="dagw" created="Thu, 6 Jan 2011 23:37:32 +0000"  >&lt;p&gt;Trying to synchronize here gave deadlock instead:&lt;/p&gt;

&lt;p&gt;One thread owns allocCache and is wait for latch. Another thread owns the latch, sees interrupt and tries to reopen the container and in that process need to call allocCache.reset: hence deadlock. &lt;/p&gt;

&lt;p&gt;Probably we can skip the call to allocCache.reset: when we reopen, since we are not really reusing the file container object for another container, we are just reopening it...&lt;/p&gt;</comment>
                            <comment id="12978611" author="dagw" created="Fri, 7 Jan 2011 01:48:48 +0000"  >&lt;p&gt;For the record, to reproduce this I ran the attached InterruptTest thus:&lt;/p&gt;

&lt;p&gt;java -XX:-UseVMInterruptibleIO -cp $CLASSPATH:. InterruptTest lock&lt;/p&gt;</comment>
                            <comment id="12978817" author="dagw" created="Fri, 7 Jan 2011 15:35:35 +0000"  >&lt;p&gt;Uploading a patch, derby-4960-1, which omits reading the page header when reopening the container after an interrupt. This sidesteps the problem seen. An new &quot;reopenContainer&quot; method is used for this purpose. Additionally the patch changes a couple of &quot;private final&quot; to just private, since final there is redundant.&lt;/p&gt;

&lt;p&gt;Running regressions.&lt;/p&gt;</comment>
                            <comment id="12979054" author="dagw" created="Sat, 8 Jan 2011 01:28:37 +0000"  >&lt;p&gt;Regressions passed. Note that the patch in itself does not make the repro work, since there is still outstanding parts of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4741&quot; title=&quot;Make embedded Derby work reliably in the presence of thread interrupts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4741&quot;&gt;&lt;del&gt;DERBY-4741&lt;/del&gt;&lt;/a&gt; that need to be committed first (I saw the error while preparing a patch for those outstanding parts, sorry, I should have been clear about that). I&apos;ll still commit this fix though, incremental improvement &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12979059" author="dagw" created="Sat, 8 Jan 2011 01:49:42 +0000"  >&lt;p&gt;Uploading version 2, simplified.&lt;/p&gt;</comment>
                            <comment id="12979061" author="dagw" created="Sat, 8 Jan 2011 01:55:13 +0000"  >&lt;p&gt;Committed version 2 as svn 1056591, closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12469090">DERBY-4741</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12467694" name="InterruptTest.java" size="17064" author="dagw" created="Fri, 7 Jan 2011 01:48:48 +0000"/>
                            <attachment id="12467734" name="derby-4960-1.diff" size="5903" author="dagw" created="Fri, 7 Jan 2011 15:35:35 +0000"/>
                            <attachment id="12467735" name="derby-4960-1.stat" size="386" author="dagw" created="Fri, 7 Jan 2011 15:35:35 +0000"/>
                            <attachment id="12467782" name="derby-4960-2.diff" size="4516" author="dagw" created="Sat, 8 Jan 2011 01:49:42 +0000"/>
                            <attachment id="12467783" name="derby-4960-2.stat" size="227" author="dagw" created="Sat, 8 Jan 2011 01:49:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0gpb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36524</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>