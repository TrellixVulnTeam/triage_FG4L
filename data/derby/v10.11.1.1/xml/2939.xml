<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:50:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2939/DERBY-2939.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2939] Log file is flushed every time a log buffer gets full</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2939</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;LogAccessFile consists of a number of log buffers: LinkedList&amp;lt;LogAccessFileBuffer&amp;gt; freeBuffers and dirtyBuffers, and LogAccessFileBuffer currentBuffer.&lt;/p&gt;

&lt;p&gt;When a log record is written to log, writeLogRecord wrongly assumes that the log record is too big to fit in any log buffer if there is not enough free space in the current log buffer. The code:&lt;/p&gt;

&lt;p&gt;if (total_log_record_length &amp;lt;= currentBuffer.bytes_free) {&lt;br/&gt;
&amp;lt;append log record to current buffer&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
} else {&lt;br/&gt;
&amp;lt;log record too big to fit in any buffer&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;should be modified to:&lt;/p&gt;

&lt;p&gt;if (total_log_record_length &amp;lt;= currentBuffer.bytes_free) {&lt;br/&gt;
&amp;lt;append log record to current buffer&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
} else if (total_log_record_length &amp;lt;= currentBuffer.length) {&lt;br/&gt;
&amp;lt;swap log buffer&amp;gt;&lt;br/&gt;
&amp;lt;append log record to new current buffer&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
} else {&lt;br/&gt;
&amp;lt;log record too big to fit in any buffer&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12373890">DERBY-2939</key>
            <summary>Log file is flushed every time a log buffer gets full</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jorgenlo">J&#248;rgen L&#248;land</assignee>
                                    <reporter username="jorgenlo">J&#248;rgen L&#248;land</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Jul 2007 13:50:07 +0100</created>
                <updated>Thu, 27 Mar 2008 09:36:47 +0000</updated>
                            <resolved>Wed, 26 Sep 2007 09:42:46 +0100</resolved>
                                    <version>10.3.1.4</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12529097" author="jorgenlo" created="Thu, 20 Sep 2007 13:48:19 +0100"  >&lt;p&gt;Seems that this is an issue of poor documentation rather than a bug. The assumption that the log record is too big to fit in any LogAccessFileBuffer is correct because the method LogAccessFile.reserveSpaceForChecksum is always called from LogToFile#appendLogRecord before LogAccessFile.writeLogRecord is called. reserveSpace... allocates a fresh LogAccessFileBuffer if the LogRecord is too big to fit in the current one. &lt;/p&gt;

&lt;p&gt;However, there are two remaining issues with LogAccessFile#writeLogRecord that I would like to address:&lt;/p&gt;

&lt;p&gt;1. Document the not too obvious behavior described above.&lt;br/&gt;
2. Change what happens when a log record is too big to fit into any of the allocated LogAccessFileBuffers the following way:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Current strategy:&lt;br/&gt;
------------------------&lt;br/&gt;
flushDirtyBuffers (1 disk write for every dirty buffer)&lt;br/&gt;
4x disk writes to put the very big log record to disk&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;New strategy&lt;br/&gt;
-----------------------&lt;br/&gt;
flushDirtyBuffers (as above)&lt;br/&gt;
allocate a big enough buffer&lt;br/&gt;
put the log record into the new buffer&lt;br/&gt;
1x disk write to put the giant log record to disk&lt;br/&gt;
remove the newly created buffer&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Hence, I want to swap 3 disk write operations with main memory operations, which should be much faster. Note that the writeLogRecord method is called from a synchronized context in LogToFile. Thus, the 4 current disk writes are blocking all other transactions that try to append log.&lt;/p&gt;</comment>
                            <comment id="12529439" author="jorgenlo" created="Fri, 21 Sep 2007 15:25:08 +0100"  >&lt;p&gt;Attaching a patch, v1, that adds some clearifying comments and makes the code change described above. I have added a private method, appendLogRecordToBuffer, that does the same work in both cases described in the previous comment.&lt;/p&gt;

&lt;p&gt;The tests are not done yet.&lt;/p&gt;</comment>
                            <comment id="12529796" author="jorgenlo" created="Mon, 24 Sep 2007 09:08:12 +0100"  >&lt;p&gt;Attaching a cleanup patch, v2, that replaces patch v1. Derbyall and allsuites runs without error.&lt;/p&gt;</comment>
                            <comment id="12529818" author="oysteing" created="Mon, 24 Sep 2007 11:11:22 +0100"  >&lt;p&gt;Thanks for the patch, J&#248;rgen.  The approach of the patch looks good,&lt;br/&gt;
and I have the following review comments:&lt;/p&gt;

&lt;p&gt;1. I am wondering whether the code would be simpler if you wrote the&lt;br/&gt;
   checksum for the big log record to the big buffer instead of to the&lt;br/&gt;
   current buffer.  That is, the big log record will have its separate&lt;br/&gt;
   check-sum.  I would think that would make it possible to avoid any&lt;br/&gt;
   special handling of this case in switchLogBuffers. &lt;/p&gt;

&lt;p&gt;2. I did not follow why you need to update the checksum of&lt;br/&gt;
   currentBuffer in the long-log-record case.  As far as I can tell,&lt;br/&gt;
   nothing new has been written to that buffer.&lt;/p&gt;

&lt;p&gt;3. The comment says that &quot;The log record is therefore written directly&lt;br/&gt;
   to log file instead of to buffer.&quot;, but this is not correct anymore&lt;br/&gt;
   since now large log records are also written to a buffer.&lt;/p&gt;

&lt;p&gt;4. With this code:&lt;br/&gt;
       currentBuffer.position = newpos;&lt;br/&gt;
       currentBuffer.bytes_free -=total_log_record_length;&lt;br/&gt;
   different values are used to update two dependent variables.  I&lt;br/&gt;
   think you should consider an assert that checks that&lt;br/&gt;
   position+bytes_free equals the size of the buffer.  (Minor nit: A&lt;br/&gt;
   missing space after &apos;=&apos; on the second code line shown above)&lt;/p&gt;

&lt;p&gt;5. Have you verified that the tests that you have run have ever&lt;br/&gt;
   executed the code for large log records?  I am a bit sceptical to&lt;br/&gt;
   checking in code that has not been tested.&lt;/p&gt;

</comment>
                            <comment id="12529865" author="jorgenlo" created="Mon, 24 Sep 2007 15:05:48 +0100"  >&lt;p&gt;Thanks for reviewing the patch, &#216;ystein. Patch 3 addresses your comments:&lt;/p&gt;

&lt;p&gt;Re 1: Very good point. This is modified in the current patch. Instead of letting writeChecksumLogRecord assume that it should write the checksum to the currentBuffer, the byte[] it should be written to is now sent as a parameter. &lt;/p&gt;

&lt;p&gt;Re 4: This code is copied from the old method, but with modified variable names and a simple call to a private method. It should therefore be well tested. That aside, an assert is still a good&lt;br/&gt;
idea, so I added one.&lt;/p&gt;

&lt;p&gt;Re 5: I understand your concerns about making mistakes in the logging subsystem. I have therefore executed all the junit tests on the patch, but with a modified buffer size of only 70&lt;br/&gt;
bytes (normally 32kB). Subtracting 37 bytes for the checksum log record, this means that almost all log records are too big to fit in a buffer. I have also played around with ij with this setting and not found any problems during recovery of a database stopped with C-c. Feel free to suggest other ways to test this ...&lt;/p&gt;

&lt;p&gt;I am currently running derbyall and all suites with normal buffer size. I&apos;ll report back with the results.&lt;/p&gt;</comment>
                            <comment id="12530058" author="oysteing" created="Tue, 25 Sep 2007 08:12:02 +0100"  >&lt;p&gt;Patch 3 looks very good.  I will commit it if the tests I have started does not show any problems.&lt;/p&gt;</comment>
                            <comment id="12530112" author="jorgenlo" created="Tue, 25 Sep 2007 15:05:16 +0100"  >&lt;p&gt;Patch v3bugfix removes a bug with the new checksumming and replaces patch v3. All tests pass.&lt;/p&gt;</comment>
                            <comment id="12530389" author="oysteing" created="Wed, 26 Sep 2007 09:42:46 +0100"  >&lt;p&gt;Tests passed for me, too.  Committed patch derby-2939-3bugfix.diff as revision  579511.&lt;/p&gt;</comment>
                            <comment id="12582571" author="dyret" created="Thu, 27 Mar 2008 09:36:47 +0000"  >&lt;p&gt;This issue has no fix version, but has been checked in to trunk after the 10.3 branch was cut, and has not been merged to the 10.3 branch (before the last release). &lt;br/&gt;
(Some have been checked into trunk after 10.4 was cut and then merged to 10.4).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12366366" name="derby-2939-1.diff" size="11669" author="jorgenlo" created="Fri, 21 Sep 2007 15:25:08 +0100"/>
                            <attachment id="12366365" name="derby-2939-1.stat" size="74" author="jorgenlo" created="Fri, 21 Sep 2007 15:25:07 +0100"/>
                            <attachment id="12366443" name="derby-2939-2.diff" size="12294" author="jorgenlo" created="Mon, 24 Sep 2007 09:08:12 +0100"/>
                            <attachment id="12366442" name="derby-2939-2.stat" size="74" author="jorgenlo" created="Mon, 24 Sep 2007 09:08:12 +0100"/>
                            <attachment id="12366463" name="derby-2939-3.diff" size="13864" author="jorgenlo" created="Mon, 24 Sep 2007 15:05:48 +0100"/>
                            <attachment id="12366531" name="derby-2939-3bugfix.diff" size="13903" author="jorgenlo" created="Tue, 25 Sep 2007 15:05:16 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 24 Sep 2007 10:11:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23330</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0z1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39497</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>