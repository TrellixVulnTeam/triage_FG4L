<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:22:18 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1004/DERBY-1004.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1004] Client should not require user to rollback the active transaction before call to PooledConnection.getConnection()</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1004</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;For a PooledConnection.getConnection() the connection gets closed.&lt;br/&gt;
 Embedded automatically rolls back any activity on the connection.&lt;br/&gt;
 Client requires the user to rollback and gives an SQLException  &lt;br/&gt;
 java.sql.Connection.close() requested while a transaction is in progress&lt;/p&gt;

&lt;p&gt;The test jdbcapi/checkDataSource.java shows this bug.   A boolean needRoolbackBeforePCGetConnection has been added to the test and  explicit rollback has been added to the test to get it to run with client.&lt;/p&gt;

&lt;p&gt;To reproduce take out instances of the explicit rollback for client from the test e.g.&lt;/p&gt;

&lt;p&gt;if (needRollbackBeforePCGetConnection)&lt;br/&gt;
			c1.rollback();&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12329141">DERBY-1004</key>
            <summary>Client should not require user to rollback the active transaction before call to PooledConnection.getConnection()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davidvc">David Van Couvering</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Sat, 18 Feb 2006 09:14:48 +0000</created>
                <updated>Sat, 1 Jul 2006 08:41:24 +0100</updated>
                            <resolved>Fri, 9 Jun 2006 05:29:40 +0100</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.1.3.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12366869" author="kmarsden" created="Sat, 18 Feb 2006 09:32:01 +0000"  >&lt;p&gt;Two notes on this.  &lt;br/&gt;
1)&lt;br/&gt;
The test does not yet fully run at the time this bug was filed, but this issue was discovered in the process.&lt;br/&gt;
2)&lt;br/&gt;
Dan posted this from the spec&lt;br/&gt;
JDBC 3.0 section 11.4&lt;/p&gt;

&lt;p&gt;A single physical PooledConnection object may generate many logical&lt;br/&gt;
Connection objects during its lifetime. For a given PooledConnection object,&lt;br/&gt;
only the most recently produced logical Connection object will be valid. Any&lt;br/&gt;
previously existing Connection object is automatically closed when the&lt;br/&gt;
associated PooledConnection.getConnection method is called. Listeners (connection&lt;br/&gt;
pool managers) are not notified in this case.&lt;br/&gt;
This gives the application server a way to take a connection away from a&lt;br/&gt;
client. This is an unlikely scenario but may be useful if the application server&lt;br/&gt;
is trying to force an orderly shutdown.&lt;/p&gt;
</comment>
                            <comment id="12366870" author="djd" created="Sat, 18 Feb 2006 09:34:36 +0000"  >&lt;p&gt;The same issue exists for the getConnection() on the XAConnection object for the client driver. I&apos;m adding a new tets jdbcapi/XATest.java that will replace the xa*.sql tests. It has a comment with this bug number when it forces a commit or rollback to make the test run under client.&lt;/p&gt;</comment>
                            <comment id="12366871" author="kmarsden" created="Sat, 18 Feb 2006 09:36:00 +0000"  >&lt;p&gt;Two notes on this bug.&lt;br/&gt;
1) At the time of its filing checkDataSource did not yet fully run with client, but ran at least to the point that this bug can be reproduced.&lt;/p&gt;

&lt;p&gt;2) Dan posted this quote from JDBC30 spec&lt;/p&gt;

&lt;p&gt;JDBC 3.0 section 11.4&lt;/p&gt;

&lt;p&gt;A single physical PooledConnection object may generate many logical&lt;br/&gt;
Connection objects during its lifetime. For a given PooledConnection object,&lt;br/&gt;
only the most recently produced logical Connection object will be valid. Any&lt;br/&gt;
previously existing Connection object is automatically closed when the&lt;br/&gt;
associated PooledConnection.getConnection method is called. Listeners (connection&lt;br/&gt;
pool managers) are not notified in this case.&lt;br/&gt;
This gives the application server a way to take a connection away from a&lt;br/&gt;
client. This is an unlikely scenario but may be useful if the application server&lt;br/&gt;
is trying toforce an orderly shutdown.&lt;/p&gt;</comment>
                            <comment id="12415027" author="davidvc" created="Wed, 7 Jun 2006 04:09:25 +0100"  >&lt;p&gt;I put a rollback into client.am.Connection.resetConnection and commented out the needRollbackBeforePCGetConnection, and it seems to fix this problem.  I can&apos;t find your XATest.java test, Dan, did you ever commit it?  If not, maybe I&apos;ll add a separate test to one of the derbynet tests.&lt;/p&gt;</comment>
                            <comment id="12415028" author="davidvc" created="Wed, 7 Jun 2006 04:10:19 +0100"  >&lt;p&gt;Never mind, I found XATest.java, a directory listing sort problem (capital XA goes ahead of lower case anything...)&lt;/p&gt;</comment>
                            <comment id="12415063" author="davidvc" created="Wed, 7 Jun 2006 06:31:36 +0100"  >&lt;p&gt;This patch should fix the problem.  Posting for review.  I am simultaneously running derbynetclientmats&lt;/p&gt;</comment>
                            <comment id="12415237" author="deepa" created="Thu, 8 Jun 2006 07:28:29 +0100"  >&lt;p&gt;I went through the patch and it looks good to me. I also checked that the test passes with the patch and fails without it.&lt;/p&gt;

&lt;p&gt;I have one minor comment which is just a readability issue. I am curious why you changed the place where rollback is called. In an earlier comment, you had mentioned you added a rollback to client.am.Connection.resetConnection. I thought this was better as it would keep all the changes to the physical connection at one place. Did it cause any problems? To match the method names to the actions, I think it would be good to have all changes to the physicalConnection in one method, something like resetPhysicalConnection. Then call createLogicalConnection to get the logical connection. This would be similar to what is being done in EmbedPooledConnection.getConnection.&lt;/p&gt;




</comment>
                            <comment id="12415389" author="davidvc" created="Fri, 9 Jun 2006 01:50:56 +0100"  >&lt;p&gt;Hi, Deepa, thanks for your review.  &lt;/p&gt;

&lt;p&gt;The problem was I was still getting the error in some cases when I put it there.  getConnection(), today, first calls createLogicalConnection().  This method calls closeWithoutRecyclingToPool(), which throws an exception if there are transactions in progress.  I can&apos;t get rid of this check because in some cases (e.g. when close() is called), this is a valid exception.&lt;/p&gt;

&lt;p&gt;After calling createLogicalConnection(), ClientPooledConnection.getConnection() calls reset on the physical connection.  Through a series of twisty passages this ends up calling Connection.resetPhysicalConnection(), and then at the network layer everything is cleaned up without actually closing the socket, and then calls Connection.completeReset(), which then calls a method completeLocalRollback() (I just discovered this), which appears to do a client-side-only rollback and closes any open cursors.&lt;/p&gt;

&lt;p&gt;I suppose another way to solve this would be, in ClientPooledConnection.getConnectio() to call physicalConnection_.reset() &lt;b&gt;first&lt;/b&gt;, and then createLogicalConnection(), and at that point the transactions would all be rolled back (accomplished by completeReset()).  But changing the order to me seems somewhat risky, I am not sure I fully comprehend the client semantics and am worried I&quot;d potentially introduce strange regressions.&lt;/p&gt;

&lt;p&gt;If you think this might actually be reasonable, I can go ahead and try this.  I&apos;ll probably try it while I&apos;m waiting to hear back from you &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;David&lt;/p&gt;</comment>
                            <comment id="12415409" author="deepa" created="Fri, 9 Jun 2006 03:05:00 +0100"  >&lt;p&gt;Hi David, My comment was only based on your previous comment which made me wonder why you did not add the rollback to resetConnection itself. Thanks for explaining your findings. As I said before, the patch looks good and solves this issue.&lt;/p&gt;</comment>
                            <comment id="12415436" author="davidvc" created="Fri, 9 Jun 2006 05:29:40 +0100"  >&lt;p&gt;Fixed in trunk, revision 412852.  Fixed in 10.1 branch, revision 412860.&lt;/p&gt;</comment>
                            <comment id="12418743" author="kmarsden" created="Sat, 1 Jul 2006 08:41:24 +0100"  >&lt;p&gt;Fix verified by reenabling test &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12335121" name="DERBY-1004.diff" size="5462" author="davidvc" created="Wed, 7 Jun 2006 06:31:36 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 18 Feb 2006 09:34:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22256</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy161b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40628</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>