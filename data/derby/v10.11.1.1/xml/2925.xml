<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:53:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2925/DERBY-2925.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2925] Prevent export from overwriting existing files</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2925</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Export should not overwrite existing files, but rather insist that the user remove them before writing to the file.  This will help prevent accidental or intentional corruption of the database with export.  This may introduce a compatibility issue with export but because export is usually an attended utility and not typically invoked as part of an application, I think the risk is worth the additional security this will provide.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12373566">DERBY-2925</key>
            <summary>Prevent export from overwriting existing files</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12364588">DERBY-2437</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="moazeni">Ramin Moazeni</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jul 2007 02:16:23 +0100</created>
                <updated>Wed, 12 Jan 2011 22:24:19 +0000</updated>
                            <resolved>Wed, 23 Jun 2010 18:36:27 +0100</resolved>
                                    <version>10.1.2.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                    <fixVersion>10.6.2.1</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12512316" author="moazeni" created="Fri, 13 Jul 2007 01:22:00 +0100"  >&lt;p&gt;To Reproduce this issue:&lt;br/&gt;
ij&amp;gt;  connect &apos;jdbc:derby:test1;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create table ex_emp(id int , name char(7) , skills varchar(200), salary decimal(10,2));&lt;br/&gt;
ij&amp;gt; insert into ex_emp values(99,&apos;smith&apos;,&apos;tennis&quot;p,l,ayer&quot;&apos;,190.55);&lt;br/&gt;
ij&amp;gt; call SYSCS_UTIL.SYSCS_EXPORT_TABLE (null, &apos;EX_EMP&apos; , &apos;/home/ramin/emp.dat&apos;, null, null, null);&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ramin@ramin ~&amp;#93;&lt;/span&gt;$ ls -ltr emp.dat&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 ramin ramin 43 Jul 12 04:57 emp.dat&lt;/p&gt;

&lt;p&gt;Calling SYSCS_UTIL.SYSCS_EXPORT_TABLE for a second time:&lt;br/&gt;
ij&amp;gt; call SYSCS_UTIL.SYSCS_EXPORT_TABLE (null, &apos;EX_EMP&apos; , &apos;/home/ramin/emp.dat&apos;, null, null, null);&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ramin@ramin ~&amp;#93;&lt;/span&gt;$ ls -ltr emp.dat&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 ramin ramin 43 Jul 12 05:04 emp.dat&lt;/p&gt;

&lt;p&gt;As you can see, the problem is reproduced this through the ij tool. I have yet to write a program &lt;br/&gt;
for this...but I think it is mentioned that this won&apos;t be invoked from an application.&lt;/p&gt;</comment>
                            <comment id="12512321" author="kmarsden" created="Fri, 13 Jul 2007 02:03:51 +0100"  >&lt;p&gt;I think it is fine to reproduce with IJ and update importExportThruIJ.sql to test your change.&lt;br/&gt;
The tests e.g. ImportExportBaseTest actually do call the procedure from a java program.  It would be good to add a test there too.&lt;/p&gt;

</comment>
                            <comment id="12512577" author="moazeni" created="Fri, 13 Jul 2007 19:47:02 +0100"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I am attaching an interim patch for this issue. I am still working on adding&lt;br/&gt;
the tests to ImportExportBaseTest.&lt;br/&gt;
Your review and feedback is greatly appreciated.&lt;/p&gt;

&lt;p&gt;To test the patch:&lt;br/&gt;
1) ij&amp;gt;  connect &apos;jdbc:derby:test1;create=true&apos;;&lt;br/&gt;
2) create table ex_emp(id int , name char(7) , skills varchar(200), salary decimal(10,2));&lt;br/&gt;
3) ij&amp;gt; call SYSCS_UTIL.SYSCS_EXPORT_TABLE (null, &apos;EX_EMP&apos; , &apos;/home/ramin/emp.dat&apos;, null, null, null);&lt;br/&gt;
4) ij&amp;gt; call SYSCS_UTIL.SYSCS_EXPORT_TABLE (null, &apos;EX_EMP&apos; , &apos;/home/ramin/emp.dat&apos;, null, null, null);&lt;br/&gt;
ERROR XSDF0: Could not create file /home/ramin/emp.dat as it already exists.&lt;br/&gt;
5) ij&amp;gt; CALL SYSCS_UTIL.SYSCS_EXPORT_QUERY_LOBS_TO_EXTFILE(&apos;SELECT * FROM EX_EMP&apos;,&apos;emp.del&apos;, &apos;,&apos; ,&apos;&quot;&apos;,&apos;UTF-8&apos;,&apos;pictures.dat&apos;);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
6) ij&amp;gt; CALL SYSCS_UTIL.SYSCS_EXPORT_QUERY_LOBS_TO_EXTFILE(&apos;SELECT * FROM EX_EMP&apos;,&apos;emp.del&apos;, &apos;,&apos; ,&apos;&quot;&apos;,&apos;UTF-8&apos;,&apos;pictures.dat&apos;);&lt;br/&gt;
ERROR XSDF0: Could not create file emp.del as it already exists.&lt;br/&gt;
7) ij&amp;gt; CALL SYSCS_UTIL.SYSCS_EXPORT_QUERY_LOBS_TO_EXTFILE(&apos;SELECT * FROM EX_EMP&apos;,&apos;staff.del&apos;, &apos;,&apos; ,&apos;&quot;&apos;,&apos;UTF-8&apos;,&apos;pictures.dat&apos;);&lt;br/&gt;
ERROR XSDF0: Could not create file pictures.dat as it already exists.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;
</comment>
                            <comment id="12512631" author="kmarsden" created="Fri, 13 Jul 2007 22:46:19 +0100"  >&lt;p&gt;Hi Ramin,&lt;/p&gt;

&lt;p&gt;The patch looks good except I think it would be good to give import/export its own  SQLState starting with XIE instead of reusing the existing store FILE_EXISTS message.  Also it would be good to have test cases for writing the lob files.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12514230" author="moazeni" created="Fri, 20 Jul 2007 16:55:37 +0100"  >&lt;p&gt;Hi Kathey&lt;/p&gt;

&lt;p&gt;Thanks for the review. I am attaching another patch&lt;br/&gt;
that I think addresses your comments. &lt;/p&gt;

&lt;p&gt;I appreciate your review.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12514355" author="bryanpendleton" created="Fri, 20 Jul 2007 23:19:17 +0100"  >&lt;p&gt;I&apos;m comfortable with the general technique; I think it is acceptable for the &lt;b&gt;EXPORT&lt;/b&gt; family of procedures to refuse to overwrite existing files.&lt;/p&gt;

&lt;p&gt;A couple comments on the v1 diff:&lt;/p&gt;

&lt;p&gt;1) The &quot;IJ&quot; tests don&apos;t seem quite right to me: the tests refer to table DERBY_2925_BOOK but it looks like the actual test table is called derby_2925_lob? Some of the tests seem to be getting table-not-found errors.&lt;/p&gt;

&lt;p&gt;2) I think we should put some effort into making the two messages as clear as possible, both to make it as clear as possible that this is intentional behavior (and not a bug), and to help people understand what they should do when this happens. For example, we don&apos;t want people to waste time thinking that there is a file permissions problem here, and trying to re-run the export after fiddling with file permissions.&lt;/p&gt;

&lt;p&gt;Here is a proposed suggestion for the text for the two messages:&lt;/p&gt;

&lt;p&gt;+	    &amp;lt;msg&amp;gt;&lt;br/&gt;
+                &amp;lt;name&amp;gt;XIE0S.S&amp;lt;/name&amp;gt;&lt;br/&gt;
+		&amp;lt;text&amp;gt;The export operation was not performed, because the specified output file (&lt;/p&gt;
{0}) already exists. Export processing will not overwrite an existing file, even if the process has permissions to write to that file, due to security concerns, and to avoid accidental file damage. Please either change the output file name in the export procedure arguments to specify a file which does not exist, or delete the existing file, then retry the export operation.&amp;lt;/text&amp;gt;&lt;br/&gt;
+                &amp;lt;arg&amp;gt;fileName&amp;lt;/arg&amp;gt;&lt;br/&gt;
+            &amp;lt;/msg&amp;gt;&lt;br/&gt;
 &lt;br/&gt;
+	    &amp;lt;msg&amp;gt;&lt;br/&gt;
+                &amp;lt;name&amp;gt;XIE0T.S&amp;lt;/name&amp;gt;&lt;br/&gt;
+		&amp;lt;text&amp;gt;The export operation was not performed, because the specified large object auxiliary file ({0}
&lt;p&gt;) already exists. Export processing will not overwrite an existing file, even if the process has permissions to write to that file, due to security concerns, and to avoid accidental file damage. Please either change the large object auxiliary file name in the export procedure arguments to specify a file which does not exist, or delete the existing file, then retry the export operation.&amp;lt;/text&amp;gt;&lt;br/&gt;
+                &amp;lt;arg&amp;gt;fileName&amp;lt;/arg&amp;gt;&lt;br/&gt;
+            &amp;lt;/msg&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="12514660" author="moazeni" created="Mon, 23 Jul 2007 17:06:55 +0100"  >&lt;p&gt;Thanks Bryan for your review. &lt;br/&gt;
Attachment please find another patch for review.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12514667" author="bryanpendleton" created="Mon, 23 Jul 2007 17:18:30 +0100"  >&lt;p&gt;Hi Ramin, thanks for the v2 patch, it looks very good.&lt;/p&gt;

&lt;p&gt;I noticed that part of the patch involves code that will delete the partially-written output file(s) if the EXPORT operation fails. Is that a new behavior of EXPORT? It doesn&apos;t seem exactly related to the main issue of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2925&quot; title=&quot;Prevent export from overwriting existing files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2925&quot;&gt;&lt;del&gt;DERBY-2925&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Do you think that the patch would still be valid without the deleteFile portion? Or is that a necessary component of the patch?&lt;/p&gt;

&lt;p&gt;thanks, &lt;/p&gt;

&lt;p&gt;bryan&lt;/p&gt;</comment>
                            <comment id="12514725" author="moazeni" created="Mon, 23 Jul 2007 19:56:16 +0100"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;Thanks for looking at the patch.&lt;br/&gt;
Correct...I added the deleteFile(...) after I got errors running the tests. In this case&lt;br/&gt;
i18n/iepnegativetests_ES.sql was failing and the reason for that was that in executing&lt;br/&gt;
the following call:&lt;br/&gt;
ij&amp;gt; call SYSCS_UTIL.SYSCS_EXPORT_QUERY(&apos;select * from iep.t1&apos;,&apos;t1.dat&apos; , null, null, &apos;NOSUCHCODESET&apos;) ;&lt;br/&gt;
ERROR XIE0I: An IOException occurred while writing data to the file.&lt;br/&gt;
ERROR XJ001: Java exception: &apos;NOSUCHCODESET: java.io.UnsupportedEncodingException&apos;.&lt;/p&gt;

&lt;p&gt;the output file gets created even though there is an exception and therefore, the rest of the tests were failing because&lt;br/&gt;
the file exists. &lt;/p&gt;

&lt;p&gt;I can remove the deleteFile(...) from the patch but to resolve the test errors, I think another way is to have&lt;br/&gt;
a java stored procedure in in the .sql test to delete the file or simply use different filenames in each&lt;br/&gt;
call to SYSCS_UTIL.SYSCS_EXPORT_... when we know a partially-written file will get created.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12514736" author="bryanpendleton" created="Mon, 23 Jul 2007 20:05:17 +0100"  >&lt;p&gt;Thanks Ramin, that explanation makes complete sense to me.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a strong opinion about this deleteFile issue. I think it is nice of the tool to avoid leaving partial files around. The only possible problem I can see is that I think there could be a scenario in which the export fails partway through, and it&apos;s not obvious which row of data caused the failure, but by looking at the end of the partial file, the user can see which rows were successfully written just &lt;b&gt;before&lt;/b&gt; the failure, and gain a clue about where the failure is occurring.&lt;/p&gt;

&lt;p&gt;So I don&apos;t have any particular guidance to give. I think the new deleteFile behavior is useful, but I think it would also be fine to remove that portion of the patch and handle it by changing the tests as you suggested.&lt;/p&gt;</comment>
                            <comment id="12514999" author="moazeni" created="Tue, 24 Jul 2007 16:14:48 +0100"  >&lt;p&gt;Thanks Bryan and Kathey for your comments.&lt;br/&gt;
I am attaching the v3 patch. I appreciate your review.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12515021" author="bryanpendleton" created="Tue, 24 Jul 2007 17:31:37 +0100"  >&lt;p&gt;The v3 patch looks great, Ramin! I have no further comments.&lt;/p&gt;</comment>
                            <comment id="12515083" author="myrna" created="Tue, 24 Jul 2007 21:03:53 +0100"  >&lt;p&gt;I think, as we&apos;re now requiring users to delete files before attempting to export, that this should have a release note, and it could affect existing applications.&lt;/p&gt;

&lt;p&gt;Please see &lt;a href=&quot;http://wiki.apache.org/db-derby/ReleaseNoteProcess#head-8bfe22837d50a10f61f410c927336eabc682b62f&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/ReleaseNoteProcess#head-8bfe22837d50a10f61f410c927336eabc682b62f&lt;/a&gt; about writing a release note&lt;/p&gt;</comment>
                            <comment id="12515386" author="moazeni" created="Wed, 25 Jul 2007 20:01:14 +0100"  >&lt;p&gt;Hello&lt;/p&gt;

&lt;p&gt;I am attaching the first draft of the release note.&lt;br/&gt;
I appreciate your review.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12515793" author="myrna" created="Thu, 26 Jul 2007 18:20:02 +0100"  >&lt;p&gt;I think this change has caused some failures in the tinderbox, see: &lt;a href=&quot;http://dbtg.thresher.com/derby/test/Daily/jvm1.6/testing/Limited/testSummary-559500.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/Daily/jvm1.6/testing/Limited/testSummary-559500.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think those should get resolved before backporting to 10.3.&lt;/p&gt;</comment>
                            <comment id="12515825" author="myrna" created="Thu, 26 Jul 2007 19:35:47 +0100"  >&lt;p&gt;Also, I think it would make sense to specify the need for removal of the files in the documentation.&lt;/p&gt;</comment>
                            <comment id="12515826" author="kmarsden" created="Thu, 26 Jul 2007 19:38:54 +0100"  >&lt;p&gt;Ramin, do you think the issue is that we now need read permission for  the extout directory in the policy file, so we can determine if the file exists? e.g.&lt;/p&gt;

&lt;p&gt;Index: java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy  (revision 559646)&lt;br/&gt;
+++ java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy  (working copy)&lt;br/&gt;
@@ -70,7 +70,7 @@&lt;br/&gt;
   // Import/export and other support files from these locations in tests&lt;br/&gt;
   permission java.io.FilePermission &quot;$&lt;/p&gt;
{user.dir}${/}extin${/}-&quot;, &quot;read&quot;;&lt;br/&gt;
   permission java.io.FilePermission &quot;${user.dir}
&lt;p&gt;$&lt;/p&gt;
{/}extinout${/}
&lt;p&gt;-&quot;, &quot;read,  write, delete&quot;;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;permission java.io.FilePermission &quot;$
{user.dir}${/}extout${/}-&quot;, &quot;write&quot;;&lt;br/&gt;
+  permission java.io.FilePermission &quot;${user.dir}
&lt;p&gt;$&lt;/p&gt;
{/}extout${/}
&lt;p&gt;-&quot;, &quot;read,write&quot;;&lt;br/&gt;
   permission java.io.FilePermission &quot;$&lt;/p&gt;
{user.dir}
&lt;p&gt;$&lt;/p&gt;
{/}
&lt;p&gt;extinout&quot;, &quot;read,write&quot;;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   // These permissions are needed to load the JCE for encryption with Sun and IBM JDK131.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;C:/svn2/trunk&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12516109" author="moazeni" created="Fri, 27 Jul 2007 23:45:15 +0100"  >&lt;p&gt;Attaching the v4 patch which resolve some of the tests errors.&lt;br/&gt;
Please review.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12516553" author="moazeni" created="Mon, 30 Jul 2007 22:52:20 +0100"  >&lt;p&gt;Hello&lt;/p&gt;

&lt;p&gt;I am attaching a possible fix for the AccessControl exception that is being thrown.&lt;br/&gt;
The fix contains changing the order for the tests that are being executed in &lt;br/&gt;
suites/AllPackages.java. I will log a separate issue for fixing possible&lt;br/&gt;
issues with the tests that might change the policy and have problem restoring &lt;br/&gt;
the policy.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12516610" author="kmarsden" created="Tue, 31 Jul 2007 04:37:27 +0100"  >&lt;p&gt;Running suites.All with the patch I see these failures:  Almost as though the permissions problem has moved.&lt;/p&gt;

&lt;p&gt;3) testIllegalOps(org.apache.derbyTesting.functionTests.tests.lang.XMLTypeAndOpsTest)junit.framework.ComparisonFailure:&lt;br/&gt;
Unexpected SQL state. expected:&amp;lt;42Z7...&amp;gt; but was:&amp;lt;XJ00...&amp;gt;&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:624)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:659)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:673)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertStatementError(BaseJDBCTestCase.java:854)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.lang.XMLTypeAndOpsTest.testIllegalOps(XMLTypeAndOpsTest.java:352)&lt;/p&gt;

&lt;p&gt;        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:95)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;Access denied (java.io.FilePermission xmlexport.del read): java.secur&lt;br/&gt;
ity.AccessControlException&apos;.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:88)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:245)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:398)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:1572)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1293)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1652)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedCallableStatement.executeStatement(EmbedCallableStatement.java:116)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(EmbedPreparedStatement.java:1304)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertStatementError(BaseJDBCTestCase.java:849)&lt;br/&gt;
        ... 34 more&lt;br/&gt;
Caused by: java.security.AccessControlException: Access denied (java.io.FilePermission xmlexport.del read)&lt;br/&gt;
        at java.security.AccessController.checkPermission(AccessController.java:104)&lt;br/&gt;
        at java.lang.SecurityManager.checkPermission(SecurityManager.java:547)&lt;br/&gt;
        at java.lang.SecurityManager.checkRead(SecurityManager.java:886)&lt;br/&gt;
        at java.io.File.exists(File.java:726)&lt;br/&gt;
        at org.apache.derby.iapi.util.PrivilegedFileOps$1.run(PrivilegedFileOps.java:60)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(AccessController.java:242)&lt;br/&gt;
        at org.apache.derby.iapi.util.PrivilegedFileOps.exists(PrivilegedFileOps.java:57)&lt;br/&gt;
        at org.apache.derby.impl.load.Export.dataFileExists(Export.java:146)&lt;br/&gt;
        at org.apache.derby.impl.load.Export.doExport(Export.java:57)&lt;br/&gt;
        at org.apache.derby.impl.load.Export.exportTable(Export.java:172)&lt;br/&gt;
        at org.apache.derby.catalog.SystemProcedures.SYSCS_EXPORT_TABLE(SystemProcedures.java:1128)&lt;br/&gt;
        at org.apache.derby.exe.ac592dcde3x0114x19dfx7bc8xffffa650e7100.g0(Unknown Source)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at org.apache.derby.impl.services.reflect.ReflectMethod.invoke(ReflectMethod.java:46)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.CallStatementResultSet.open(CallStatementResultSet.java:57)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:370)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1203)&lt;br/&gt;
        ... 38 more&lt;br/&gt;
4) testIllegalOps(org.apache.derbyTesting.functionTests.tests.lang.XMLTypeAndOpsTest)junit.framework.ComparisonFailure:&lt;br/&gt;
Unexpected SQL state. expected:&amp;lt;42Z7...&amp;gt; but was:&amp;lt;XJ00...&amp;gt;&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:624)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:659)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:673)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertStatementError(BaseJDBCTestCase.java:854)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.lang.XMLTypeAndOpsTest.testIllegalOps(XMLTypeAndOpsTest.java:352)&lt;/p&gt;

&lt;p&gt;        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:95)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;Access denied (java.io.FilePermission xmlexport.del read): java.secur&lt;br/&gt;
ity.AccessControlException&apos;.&lt;br/&gt;
        at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:46)&lt;br/&gt;
        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:362)&lt;br/&gt;
        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:371)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.execute(PreparedStatement.java:1572)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertStatementError(BaseJDBCTestCase.java:849)&lt;br/&gt;
        ... 43 more&lt;br/&gt;
Caused by: org.apache.derby.client.am.SqlException: Java exception: &apos;Access denied (java.io.FilePermission xmlexport.del&lt;br/&gt;
 read): java.security.AccessControlException&apos;.&lt;br/&gt;
        at org.apache.derby.client.am.SqlException.&amp;lt;init&amp;gt;(SqlException.java:290)&lt;br/&gt;
        at org.apache.derby.client.am.SqlException.&amp;lt;init&amp;gt;(SqlException.java:264)&lt;br/&gt;
        at org.apache.derby.client.am.Statement.completeExecute(Statement.java:1498)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(NetStatementReply.java:304)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.readExecuteCall(NetStatementReply.java:105)&lt;br/&gt;
        at org.apache.derby.client.net.StatementReply.readExecuteCall(StatementReply.java:75)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatement.readExecuteCall_(NetStatement.java:176)&lt;br/&gt;
        at org.apache.derby.client.am.Statement.readExecuteCall(Statement.java:1464)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2158)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeX(PreparedStatement.java:1578)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.execute(PreparedStatement.java:1563)&lt;br/&gt;
        ... 44 more&lt;/p&gt;</comment>
                            <comment id="12516763" author="moazeni" created="Tue, 31 Jul 2007 19:19:05 +0100"  >&lt;p&gt;Hi Kathey&lt;/p&gt;

&lt;p&gt;Thanks for posting the error messages.&lt;br/&gt;
I am attaching a new patch which hopefully resolve this issue.&lt;/p&gt;

&lt;p&gt;I did not get this error message since I didn&apos;t have xalan.jar in my classpath&lt;br/&gt;
and the test was being skipped.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Ramin&lt;/p&gt;</comment>
                            <comment id="12516822" author="moazeni" created="Wed, 1 Aug 2007 00:28:18 +0100"  >&lt;p&gt;To merge to 10.3 branch use the following commends:&lt;br/&gt;
svn merge -r 559168:559169 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;br/&gt;
svn merge -r 560423:560424 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;br/&gt;
svn merge -r 561545:561546 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="12516863" author="kmarsden" created="Wed, 1 Aug 2007 05:16:40 +0100"  >&lt;p&gt;resolved in trunk and 10.3&lt;/p&gt;</comment>
                            <comment id="12584134" author="rhillegas" created="Tue, 1 Apr 2008 14:33:30 +0100"  >&lt;p&gt;Re-attaching release note as releaseNote.html since this is the file name which the release notes generator looks for.&lt;/p&gt;</comment>
                            <comment id="12881204" author="rhillegas" created="Tue, 22 Jun 2010 15:00:58 +0100"  >&lt;p&gt;Re-opening this issue to handle another case.&lt;/p&gt;</comment>
                            <comment id="12881205" author="rhillegas" created="Tue, 22 Jun 2010 15:02:56 +0100"  >&lt;p&gt;Attaching derby-2925-07-aa-fileUrl.diff. This patch prevents users from subverting the file existence check by phrasing the filename as an url. The tests passed cleanly for me.&lt;/p&gt;

&lt;p&gt;The export procedure uses the user-supplied export file name twice:&lt;/p&gt;

&lt;p&gt;1) To check whether the file exists&lt;/p&gt;

&lt;p&gt;2) To open the file so that export can dump a table into the file&lt;/p&gt;

&lt;p&gt;For the second use, Derby checks to see whether the user-supplied name is actually an url rather than a plain file name. If the user-supplied name is an url, Derby transforms it into a plain file name. This transformation is not performed when checking for the file&apos;s existence. As a result, it is still possible to use export to overwrite an existing file by prefixing the file name with the string &quot;file:&quot;. This will be an illegal file name for the purposes of (1) and therefore not abort the export before step (2).&lt;/p&gt;

&lt;p&gt;This patch simply performs the same transformation in steps (1) and (2).&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/iapi/services/io/FileUtil.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/load/Export.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/load/ExportWriteData.java&lt;/p&gt;

&lt;p&gt;Factor out the file name transformation into FileUtil so that it can be used by both steps (1) and (2).&lt;/p&gt;

&lt;p&gt;------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/io/CPFile.java&lt;/p&gt;

&lt;p&gt;Removed an unneeded import.&lt;/p&gt;

&lt;p&gt;------------&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/tools/ImportExportBinaryDataTest.java&lt;/p&gt;

&lt;p&gt;Added a test case for this scenario.&lt;/p&gt;</comment>
                            <comment id="12881493" author="bryanpendleton" created="Wed, 23 Jun 2010 01:44:59 +0100"  >&lt;p&gt;Your patch looks good to me, thanks for tracking this down.&lt;/p&gt;

&lt;p&gt;I&apos;m a little surprised that in your test, you were able to do&lt;/p&gt;

&lt;p&gt;  &quot;file:&quot; + fileName&lt;/p&gt;

&lt;p&gt;rather than&lt;/p&gt;

&lt;p&gt;  &quot;file://&quot; + fileName&lt;/p&gt;

&lt;p&gt;No other comments. +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12881665" author="rhillegas" created="Wed, 23 Jun 2010 13:24:22 +0100"  >&lt;p&gt;Thanks for the quick review, Bryan. Committed patch at subversion revision 957171.&lt;/p&gt;</comment>
                            <comment id="12881777" author="rhillegas" created="Wed, 23 Jun 2010 18:34:01 +0100"  >&lt;p&gt;Ported 957171 from trunk to 10.6 branch at subversion revision 957278.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12374748">DERBY-2980</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12361803" name="DERBY-2925v0.diff" size="5761" author="moazeni" created="Fri, 13 Jul 2007 19:47:02 +0100"/>
                            <attachment id="12361804" name="DERBY-2925v0.stat" size="300" author="moazeni" created="Fri, 13 Jul 2007 19:47:02 +0100"/>
                            <attachment id="12362225" name="DERBY-2925v1.diff" size="45931" author="moazeni" created="Fri, 20 Jul 2007 16:55:37 +0100"/>
                            <attachment id="12362226" name="DERBY-2925v1.stat" size="1000" author="moazeni" created="Fri, 20 Jul 2007 16:55:37 +0100"/>
                            <attachment id="12362349" name="DERBY-2925v2.diff" size="58539" author="moazeni" created="Mon, 23 Jul 2007 17:06:54 +0100"/>
                            <attachment id="12362350" name="DERBY-2925v2.stat" size="1249" author="moazeni" created="Mon, 23 Jul 2007 17:06:55 +0100"/>
                            <attachment id="12362450" name="DERBY-2925v3.diff" size="69252" author="moazeni" created="Tue, 24 Jul 2007 16:24:43 +0100"/>
                            <attachment id="12362451" name="DERBY-2925v3.stat" size="1180" author="moazeni" created="Tue, 24 Jul 2007 16:24:43 +0100"/>
                            <attachment id="12362708" name="DERBY-2925v4.diff" size="2562" author="moazeni" created="Fri, 27 Jul 2007 23:45:15 +0100"/>
                            <attachment id="12362709" name="DERBY-2925v4.stat" size="177" author="moazeni" created="Fri, 27 Jul 2007 23:45:15 +0100"/>
                            <attachment id="12362816" name="DERBY-2925v5.diff" size="1141" author="moazeni" created="Mon, 30 Jul 2007 22:52:20 +0100"/>
                            <attachment id="12362817" name="DERBY-2925v5.stat" size="82" author="moazeni" created="Mon, 30 Jul 2007 22:52:20 +0100"/>
                            <attachment id="12362903" name="DERBY-2925v6.diff" size="2735" author="moazeni" created="Tue, 31 Jul 2007 19:19:05 +0100"/>
                            <attachment id="12362904" name="DERBY-2925v6.stat" size="174" author="moazeni" created="Tue, 31 Jul 2007 19:19:05 +0100"/>
                            <attachment id="12447701" name="derby-2925-07-aa-fileUrl.diff" size="5468" author="rhillegas" created="Tue, 22 Jun 2010 15:02:56 +0100"/>
                            <attachment id="12379029" name="releaseNote.html" size="4770" author="rhillegas" created="Tue, 1 Apr 2008 14:33:30 +0100"/>
                            <attachment id="12362552" name="releaseNotev0.html" size="4770" author="moazeni" created="Wed, 25 Jul 2007 20:01:06 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 13 Jul 2007 00:22:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30658</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0o3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37722</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>