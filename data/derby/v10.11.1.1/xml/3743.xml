<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:10:41 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3743/DERBY-3743.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3743] Revoking EXECUTE privilege on a function if used in a CHECK constraint: implementation problem </title>
                <link>https://issues.apache.org/jira/browse/DERBY-3743</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The docs say that REVOKE EXECUTE ... RESTRICT should &lt;br/&gt;
fail if there is a dependent constraint:&lt;/p&gt;

&lt;p&gt;&quot;The RESTRICT clause specifies that the EXECUTE privilege cannot be&lt;br/&gt;
 revoked if the specified routine is used in a view, trigger, or&lt;br/&gt;
 constraint, and the privilege is being revoked from the owner of the&lt;br/&gt;
 view, trigger, or constraint.&quot;&lt;/p&gt;

&lt;p&gt; Revoking the privilege will be correctly restricted, but possibly for the wrong reason.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12399286">DERBY-3743</key>
            <summary>Revoking EXECUTE privilege on a function if used in a CHECK constraint: implementation problem </summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Jun 2008 16:13:32 +0100</created>
                <updated>Tue, 30 Jun 2009 01:14:35 +0100</updated>
                            <resolved>Wed, 13 Aug 2008 13:21:26 +0100</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12609596" author="dagw" created="Tue, 1 Jul 2008 14:55:28 +0100"  >&lt;p&gt;Closing this, my repro was at error, sorry for the noise.&lt;/p&gt;</comment>
                            <comment id="12609803" author="dagw" created="Wed, 2 Jul 2008 07:00:47 +0100"  >&lt;p&gt;Reopening this. Although there is no Derby bug as such, I think the implementation&lt;br/&gt;
merits a look. So I change this issue from &quot;bug&quot; to &quot;improvement&quot;.&lt;/p&gt;</comment>
                            <comment id="12609805" author="dagw" created="Wed, 2 Jul 2008 07:04:14 +0100"  >&lt;p&gt;Changing description to my new understanding.&lt;/p&gt;</comment>
                            <comment id="12609816" author="dagw" created="Wed, 2 Jul 2008 07:45:09 +0100"  >&lt;p&gt;Enclosing two patches. The first, derby-3743-show-constraint-invalidate-actions,&lt;br/&gt;
adds a test case to GrantRevokeDDLTest.&lt;/p&gt;

&lt;p&gt;In this test case, an EXECUTE privilege on a function (f_abs) is attempted&lt;br/&gt;
revoked when there exists a CHECK constraint that is dependent on it.&lt;/p&gt;

&lt;p&gt;The patch also instruments ConstraintDescriptor to show what action is used&lt;br/&gt;
when prepareToInvalidate is called. Derby correctly restricts the revoke, but I&lt;br/&gt;
think the implementation is possibly wrong. I came upon this when trying to&lt;br/&gt;
make revoke work for roles.&lt;/p&gt;

&lt;p&gt;As can be seen from running GrantRevokeDDLTest with this patch, the action that&lt;br/&gt;
triggers LANG_PROVIDER_HAS_DEPENDENT_OBJECT (X0Y25) is&lt;br/&gt;
INTERNAL_RECOMPILE_REQUEST. I think it should properly be&lt;br/&gt;
REVOKE_PRIVILEGE_RESTRICT.&lt;/p&gt;

&lt;p&gt;However, when the constraint is created, there is no dependency registered on&lt;br/&gt;
the applicable permission descriptors when the constraint is a CHECK&lt;br/&gt;
constraint, cf the code section for &quot;case DataDictionary.CHECK_CONSTRAINT:&quot; in&lt;br/&gt;
CreateConstraintConstantAction#executeConstantAction. &lt;/p&gt;

&lt;p&gt;This is in contrast to the case for FOREIGN KEY constraints (which may&lt;br/&gt;
depend upon REFERENCES privileges). For the latter case, the method&lt;br/&gt;
storeConstraintDependenciesOnPrivileges is called, which does record&lt;br/&gt;
dependencies for the constraint on the applicable permissions.&lt;/p&gt;

&lt;p&gt;For the CHECK constraint case, the only dependeny registered is on the function&lt;br/&gt;
itself (the alias descriptor), cf. CreateConstraintConstantAction, ca line 398.&lt;/p&gt;

&lt;p&gt;So, when the EXECUTE privilege is revoked, in&lt;br/&gt;
RoutinePrivilegeInfo#executeGrantRevoke, there are two invalidation&lt;br/&gt;
actions called:&lt;/p&gt;

&lt;p&gt;        dd.getDependencyManager().invalidateFor&lt;br/&gt;
           (routinePermsDesc,&lt;br/&gt;
            DependencyManager.REVOKE_PRIVILEGE_RESTRICT, lcc);&lt;br/&gt;
        :&lt;br/&gt;
        dd.getDependencyManager().invalidateFor&lt;br/&gt;
            (aliasDescriptor,&lt;br/&gt;
            DependencyManager.INTERNAL_RECOMPILE_REQUEST, lcc);&lt;/p&gt;

&lt;p&gt;The former does not lead to the RESTRICT enforcement, since there is no such&lt;br/&gt;
dependency registered, as shown. The latter does lead to RESTRICT enforcement,&lt;br/&gt;
however, but I think this is just a side effect and not how&lt;br/&gt;
INTERNAL_RECOMPILE_REQUEST is intended used.&lt;/p&gt;

&lt;p&gt;I enclose a patch, derby-3743, which changes the implementation so&lt;br/&gt;
that REVOKE_PRIVILEGE_RESTRICT is the action that leads to the&lt;br/&gt;
RESTRICT enforcement by adding a dependency on the EXECUTE permission&lt;br/&gt;
descriptor for CHECK constraints.&lt;/p&gt;

&lt;p&gt;Running regressions, please review.&lt;/p&gt;</comment>
                            <comment id="12610158" author="dagw" created="Thu, 3 Jul 2008 09:16:10 +0100"  >&lt;p&gt;Regressions ran ok.&lt;/p&gt;</comment>
                            <comment id="12610913" author="dagw" created="Mon, 7 Jul 2008 09:46:33 +0100"  >&lt;p&gt;I should add that derby-3743 also adds the test case&lt;br/&gt;
from the patch derby-3743-show-constraint-invalidate-actions&lt;br/&gt;
to make sure the implementation change doesn&apos;t break the &lt;br/&gt;
behavior.&lt;/p&gt;

&lt;p&gt;I will commit this soon if no objections.&lt;/p&gt;</comment>
                            <comment id="12611959" author="dagw" created="Wed, 9 Jul 2008 10:55:02 +0100"  >&lt;p&gt;Committed derby-3743 as svn 675129, closing.&lt;/p&gt;</comment>
                            <comment id="12621486" author="dagw" created="Mon, 11 Aug 2008 16:57:17 +0100"  >&lt;p&gt;Follow-up patch needed.&lt;/p&gt;</comment>
                            <comment id="12621495" author="dagw" created="Mon, 11 Aug 2008 17:36:15 +0100"  >&lt;p&gt;This patch, derby-3743b-1, fixes two problems with the&lt;br/&gt;
earlier patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If there were several constraints on a a table, each referencing one&lt;br/&gt;
  or more routines for which a privilege was needed, each constraint&lt;br/&gt;
  would get a dependency on &lt;b&gt;all&lt;/b&gt; (potentially; see the next problem!)&lt;br/&gt;
  routines needed for the entire table, not just those needed for that&lt;br/&gt;
  constraint. As a consequence, if the constraint(s) really needing&lt;br/&gt;
  the privileges were dropped, revoking that privilege could risk&lt;br/&gt;
  being erroneously RESTRICTed, in spite of no constraint really&lt;br/&gt;
  needing that privilege any more.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the privileges of more than one routine were needed for a single&lt;br/&gt;
  constraint, only one dependency got registered due to an&lt;br/&gt;
  optimization in storeConstraintDependenciesOnPrivileges that was not&lt;br/&gt;
  applicable for CHECK constraints. As a result, a revoke on any&lt;br/&gt;
  remaining privileges would then incorrectly be allowed in spite of&lt;br/&gt;
  the RESTRICT.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I added two more test cases in GrantRevokeDDLTest to verify that it&lt;br/&gt;
works correctly now. Running regressions now, please review. &lt;/p&gt;</comment>
                            <comment id="12621808" author="dagw" created="Tue, 12 Aug 2008 14:09:36 +0100"  >&lt;p&gt;Regression tests passed.&lt;/p&gt;</comment>
                            <comment id="12621931" author="rhillegas" created="Tue, 12 Aug 2008 19:54:19 +0100"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;The patch looks good to me. You might want to adjust the header comment on DDLConstantAction.storeConstraintDependenciesOnPrivileges(). Right now the header says &quot; where as constraints only depend on REFERENCES privilege on a table&quot;. That statement used to be true, but with your patch that statement is no longer true for CHECK constraints.&lt;/p&gt;</comment>
                            <comment id="12622185" author="dagw" created="Wed, 13 Aug 2008 13:04:20 +0100"  >&lt;p&gt;Thanks for looking at the patch, Rick! I enclose a new version,&lt;br/&gt;
derby-3743b-2, which fixes the comment you pointed to, plus&lt;br/&gt;
sharpened another comment. I intend to commit this.&lt;/p&gt;</comment>
                            <comment id="12622192" author="dagw" created="Wed, 13 Aug 2008 13:21:26 +0100"  >&lt;p&gt;Committed as svn 685526, closing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12385083" name="derby-3743-show-constraint-invalidate-actions.diff" size="4036" author="dagw" created="Wed, 2 Jul 2008 07:16:02 +0100"/>
                            <attachment id="12385084" name="derby-3743-show-constraint-invalidate-actions.stat" size="175" author="dagw" created="Wed, 2 Jul 2008 07:16:02 +0100"/>
                            <attachment id="12385086" name="derby-3743.diff" size="3974" author="dagw" created="Wed, 2 Jul 2008 07:45:09 +0100"/>
                            <attachment id="12385087" name="derby-3743.stat" size="340" author="dagw" created="Wed, 2 Jul 2008 07:45:09 +0100"/>
                            <attachment id="12387964" name="derby-3743b-1.diff" size="10570" author="dagw" created="Mon, 11 Aug 2008 17:36:15 +0100"/>
                            <attachment id="12387965" name="derby-3743b-1.stat" size="346" author="dagw" created="Mon, 11 Aug 2008 17:36:15 +0100"/>
                            <attachment id="12388131" name="derby-3743b-2.diff" size="11340" author="dagw" created="Wed, 13 Aug 2008 13:04:20 +0100"/>
                            <attachment id="12388132" name="derby-3743b-2.stat" size="346" author="dagw" created="Wed, 13 Aug 2008 13:04:20 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 12 Aug 2008 18:54:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30979</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0v9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38884</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>