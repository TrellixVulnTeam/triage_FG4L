<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:35:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5210/DERBY-5210.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5210] Use java.nio.ByteBuffer in client.net.Request</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5210</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;We should see if we could use a java.nio.ByteBuffer instead of a byte array in org.apache.derby.client.net.Request, similar to what we did for DDMWriter in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2936&quot; title=&quot;Use java.nio.ByteBuffer for buffering in DDMWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2936&quot;&gt;&lt;del&gt;DERBY-2936&lt;/del&gt;&lt;/a&gt;. ByteBuffer provides some helper methods that allows us to simplify the code that puts multi-byte values into the buffer (like ByteBuffer.putShort(), putInt(), putLong()). It may also be a first step on the way to using a CharsetEncoder to encode strings without going via an intermediate throw-away byte array (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5068&quot; title=&quot;Investigate increased CPU usage on client after introduction of UTF-8 CcsidManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5068&quot;&gt;&lt;del&gt;DERBY-5068&lt;/del&gt;&lt;/a&gt; for details).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12505773">DERBY-5210</key>
            <summary>Use java.nio.ByteBuffer in client.net.Request</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                            <label>derby_backport_reject_10_8</label>
                    </labels>
                <created>Fri, 29 Apr 2011 11:53:38 +0100</created>
                <updated>Thu, 30 Jun 2011 10:21:42 +0100</updated>
                            <resolved>Fri, 13 May 2011 14:44:18 +0100</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13027365" author="knutanders" created="Sat, 30 Apr 2011 20:35:49 +0100"  >&lt;p&gt;Attaching a patch that removes the bytes_ and offset_ fields from the Request class and replaces them with a java.nio.ByteBuffer field. The Request class and its subclasses were changed to use the new field. Apart from the mechanical changes (that is, replacing the direct byte array accesses with accesses via ByteBuffer), the patch changes the following:&lt;/p&gt;

&lt;p&gt;1) Changed the meaning of the length parameter in the ensureLength() method. Previously, it represented the minimum total length of the byte buffer, whereas it now represents the minimum number of available bytes at the end of the buffer. (Actually, the existing comments in the method match the new behaviour, so it looks like that was how it was intended to work.) This seemed like a reasonable simplification now that ensureLength() needed to be rewritten in any case (because it needed to check and reallocate a ByteBuffer instead of a byte array) and also all calls needed to be changed (because almost all referred to the removed offset_ field).&lt;/p&gt;

&lt;p&gt;2) As I updated various pieces of the code, I noticed that there was a lot of duplication. The places where I had seen a helper method that did the exact same thing, I changed the code to use the helper methods instead of just mechanically translating it.&lt;/p&gt;

&lt;p&gt;3) Removed some helper methods in client.am.SignedBinary and client.am.FloatingPoint since we now use methods in java.nio.ByteBuffer that provide the same functionality.&lt;/p&gt;

&lt;p&gt;The patch adds 199 lines and removes 414 lines, so it results in a net removal of 215 lines.&lt;/p&gt;

&lt;p&gt;All the regression tests ran cleanly with the patch. I&apos;m currently running some performance tests to see if these changes affect the performance negatively.&lt;/p&gt;</comment>
                            <comment id="13028249" author="knutanders" created="Tue, 3 May 2011 15:38:15 +0100"  >&lt;p&gt;I ran the sr_select performance test client with 10 threads to see if the patch affected the performance of client/server communication (tested derbyclient.jar from 10.8.1.2 against trunk patched with the 1a patch). Taking the average of 100 runs with each version, I could not see any difference at all in the throughput with this kind of load. The number of CPU cycles per transaction spent in the client driver seems to have increased by 1% because of the patch. I hope, though, when we add the improvements suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5068&quot; title=&quot;Investigate increased CPU usage on client after introduction of UTF-8 CcsidManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5068&quot;&gt;&lt;del&gt;DERBY-5068&lt;/del&gt;&lt;/a&gt;, that we will end up reducing the number of CPU cycles spent in the client driver. I&apos;ll do some experimenting with the suggested &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5068&quot; title=&quot;Investigate increased CPU usage on client after introduction of UTF-8 CcsidManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5068&quot;&gt;&lt;del&gt;DERBY-5068&lt;/del&gt;&lt;/a&gt; changes in combination with this patch before I go ahead with committing it.&lt;/p&gt;</comment>
                            <comment id="13028250" author="knutanders" created="Tue, 3 May 2011 15:39:29 +0100"  >&lt;p&gt;I still intend to do some more testing, but I think the patch is ready for review, so I&apos;m setting the patch available flag.&lt;/p&gt;</comment>
                            <comment id="13029257" author="knutanders" created="Thu, 5 May 2011 11:11:27 +0100"  >&lt;p&gt;I changed Utf8CcsidManager to use a CharsetEncoder to encode strings directly into the ByteBuffer and reran the experiment (will post a patch on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5068&quot; title=&quot;Investigate increased CPU usage on client after introduction of UTF-8 CcsidManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5068&quot;&gt;&lt;del&gt;DERBY-5068&lt;/del&gt;&lt;/a&gt; soon). With these changes, I saw reduced CPU usage compared to 10.8.1.2 (still no observable change in throughput, though). So I think it&apos;s safe to assume that although the 1a patch seen in isolation makes the client driver use slightly more CPU, it enables us to add optimizations that outweigh the extra cost. And, regardless of that, the extra cost seems to be so small that it might be worthwhile to check in the patch in any case, just because it makes the code simpler.&lt;/p&gt;</comment>
                            <comment id="13029518" author="dagw" created="Thu, 5 May 2011 20:21:15 +0100"  >&lt;p&gt;Thanks for this cleanup! Nice to see so much bit-tweaking go away. In spite of the slight CPU increase of this patch in isolation, you say that with changes planned in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5068&quot; title=&quot;Investigate increased CPU usage on client after introduction of UTF-8 CcsidManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5068&quot;&gt;&lt;del&gt;DERBY-5068&lt;/del&gt;&lt;/a&gt; which reply on this change if I understand correctly, CPU usage will go down again, so on that basis also, I am positive to this change: +1&lt;/p&gt;</comment>
                            <comment id="13029921" author="knutanders" created="Fri, 6 May 2011 13:52:59 +0100"  >&lt;p&gt;Thanks for looking at the patch, Dag. We can probably wait with committing this patch until we&apos;ve decided which approach to go for in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5068&quot; title=&quot;Investigate increased CPU usage on client after introduction of UTF-8 CcsidManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5068&quot;&gt;&lt;del&gt;DERBY-5068&lt;/del&gt;&lt;/a&gt;. Then it will be clearer what the performance implications are.&lt;/p&gt;</comment>
                            <comment id="13033040" author="knutanders" created="Fri, 13 May 2011 14:44:18 +0100"  >&lt;p&gt;Committed revision 1102730.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12373752">DERBY-2936</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12499628">DERBY-5068</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12477882" name="d5210-1a.diff" size="53351" author="knutanders" created="Sat, 30 Apr 2011 20:35:49 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 5 May 2011 19:21:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31549</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36386</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>