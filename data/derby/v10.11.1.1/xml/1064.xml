<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:43:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1064/DERBY-1064.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1064] Delete cascade causes NULL values inserted into table when after delete Trigger fires</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1064</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When an after delete trigger which inserts into a table is created on a table that has a foreign key that references a primary key and uses the on delete cascade constraint, nulls are inserted into the table by the trigger.&lt;/p&gt;

&lt;p&gt;The SQL below shows that the cascade delete works correctly:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; CREATE TABLE TABLE1 ( X INT PRIMARY KEY );&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TABLE TABLE1_DELETIONS ( X INT );&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TABLE TABLE2 (&lt;br/&gt;
    Y INT,&lt;br/&gt;
    CONSTRAINT Y_AND_X FOREIGN KEY(Y) REFERENCES TABLE1(X) ON DELETE CASCADE&lt;br/&gt;
);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TABLE TABLE2_DELETIONS ( Y INT );&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO TABLE1 VALUES (0);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO TABLE2 VALUES (0);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO TABLE1 VALUES (1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO TABLE2 VALUES (1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from table1;&lt;br/&gt;
X&lt;br/&gt;
-----------&lt;br/&gt;
0&lt;br/&gt;
1&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;br/&gt;
ij&amp;gt; select * from table2;&lt;br/&gt;
Y&lt;br/&gt;
-----------&lt;br/&gt;
0&lt;br/&gt;
1&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;br/&gt;
ij&amp;gt; DELETE FROM TABLE1;&lt;br/&gt;
2 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from table1;&lt;br/&gt;
X&lt;br/&gt;
-----------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;br/&gt;
ij&amp;gt; select * from table2;&lt;br/&gt;
Y&lt;br/&gt;
-----------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;/p&gt;

&lt;p&gt;Now insert the rows again, create the triggers, delete the rows from the primary key table, verify the cascade delete worked and observe the values in the tables used by the triggers:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; INSERT INTO TABLE1 VALUES(0);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO TABLE2 VALUES(0);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO TABLE1 VALUES(1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO TABLE2 VALUES(1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TRIGGER TRIGGER1&lt;br/&gt;
    AFTER DELETE ON TABLE1&lt;br/&gt;
    REFERENCING OLD AS OLD_ROW&lt;br/&gt;
    FOR EACH ROW MODE DB2SQL&lt;br/&gt;
    INSERT INTO TABLE1_DELETIONS VALUES (OLD_ROW.X);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; CREATE TRIGGER TRIGGER2&lt;br/&gt;
    AFTER DELETE ON TABLE2&lt;br/&gt;
    REFERENCING OLD AS OLD_ROW&lt;br/&gt;
    FOR EACH ROW MODE DB2SQL&lt;br/&gt;
    INSERT INTO TABLE2_DELETIONS VALUES (OLD_ROW.Y);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; DELETE FROM TABLE1;&lt;br/&gt;
2 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from TABLE1;&lt;br/&gt;
X&lt;br/&gt;
-----------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;br/&gt;
ij&amp;gt; select * from TABLE2;&lt;br/&gt;
Y&lt;br/&gt;
-----------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;br/&gt;
ij&amp;gt; SELECT * FROM TABLE1_DELETIONS;&lt;br/&gt;
X&lt;br/&gt;
-----------&lt;br/&gt;
0&lt;br/&gt;
1&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;br/&gt;
ij&amp;gt; SELECT * FROM TABLE2_DELETIONS;&lt;br/&gt;
Y&lt;br/&gt;
-----------&lt;br/&gt;
NULL&lt;br/&gt;
NULL&lt;/p&gt;

&lt;p&gt;The TABLE2_DELETIONS table contains NULLs instead of the correct values which should be 0 and 1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12329523">DERBY-1064</key>
            <summary>Delete cascade causes NULL values inserted into table when after delete Trigger fires</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fernanda">Fernanda Pizzorno</assignee>
                                    <reporter username="slc">Susan Cline</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Feb 2006 08:22:25 +0000</created>
                <updated>Thu, 13 Dec 2007 09:04:49 +0000</updated>
                            <resolved>Fri, 7 Jul 2006 16:35:44 +0100</resolved>
                                    <version>10.1.1.0</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12417982" author="fernanda" created="Tue, 27 Jun 2006 17:01:31 +0100"  >&lt;p&gt;The problem is happening because the trigger TRIGGER2 is running with the trigger execution context (TEC) of TRIGGER1. Nulls will be inserted because this this is happening before the before and after result sets for the trigger execution context for TRIGGER1 are set.&lt;/p&gt;

&lt;p&gt;When deleting a row causes a cascade delete Derby will execute the following steps on both the target table and it&apos;s dependent tables:&lt;br/&gt;
 (1) get the affected rows; &lt;br/&gt;
 (2) fire before triggers;&lt;br/&gt;
 (3) delete the rows;&lt;br/&gt;
 (4) fire after triggers.&lt;/p&gt;

&lt;p&gt;The problem described in this JIRA issue is caused by the way the execution of before and after triggers happens. The TEC for triggers that are being executed are kept in a Vector. During the execution of a trigger, the TEC used by the trigger will be the last element in this Vector.&lt;br/&gt;
During the execution of before triggers, the following steps will happen: &lt;br/&gt;
 (1) for each dependent table, the TEC is added at the end of this Vector and the before trigger event is fired causing the execution of the before trigger on that table;&lt;br/&gt;
 (2) the TEC for the main table is added at the end of the Vector and the before trigger event is fired causing the execution of the before trigger on that table.&lt;/p&gt;

&lt;p&gt;In the example in this JIRA issue, the Vector would now contain &lt;/p&gt;
{TEC for TABLE2, TEC for TABLE1}
&lt;p&gt;.&lt;/p&gt;

&lt;p&gt;During the execution of after triggers, the following steps will happen:&lt;br/&gt;
 (1) for each dependent table, the after trigger even is fired causing the execution of the after trigger on that table;&lt;br/&gt;
 (2) the after trigger event is fired for the main table, causing the execution of the after trigger on that table;&lt;/p&gt;

&lt;p&gt;The content of the Vector has not changed for the execution of the after trigger, so both after triggers execute with the TEC that is the last element of the Vector (TEC for TABLE1). The before and after result sets are still added to the correct TEC, as this happens when the trigger event is fired if there is a trigger for that event. When TRIGGER2 is executed, the before and after result sets are set on the correct TEC (TEC for TABLE2) but the trigger is executed with the wrong TEC (TEC for TABLE1). TEC for TABLE1 at that moment still does not have before and after result sets, causing NULLs to be inserted.&lt;/p&gt;

&lt;p&gt;This patch (derby-1064.diff) fixes this problem by adding some steps to the execution of before and after triggers.&lt;/p&gt;

&lt;p&gt;For the before trigger this patch will cause the TEC for those triggers that have been executed to be removed from the Vector, and for the after trigger the TEC for each trigger will be added again to the Vector (in the same order as done for before triggers), and will be removed after the trigger is executed.&lt;/p&gt;

&lt;p&gt;I have successfully run derbyall with this patch. Can someone please review it?&lt;/p&gt;</comment>
                            <comment id="12419224" author="andreask" created="Wed, 5 Jul 2006 16:07:22 +0100"  >&lt;p&gt;Committed revision 419186 at trunk.&lt;/p&gt;
</comment>
                            <comment id="12551316" author="fuzzylogic" created="Thu, 13 Dec 2007 09:04:49 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12335981" name="derby-1064.diff" size="4499" author="fernanda" created="Tue, 27 Jun 2006 17:01:31 +0100"/>
                            <attachment id="12335982" name="derby-1064.stat" size="312" author="fernanda" created="Tue, 27 Jun 2006 17:01:31 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 27 Jun 2006 16:01:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22288</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy10cn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39707</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>