<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3316/DERBY-3316.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3316] Leak in client if ResultSet not closed</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3316</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If I run the attached program RepeatStatement.java with 32M of heap,&lt;br/&gt;
I will get an OutOfMemory error in the client.&lt;/p&gt;

&lt;p&gt;java -Xmx32M RepeatStatement&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
       at org.apache.derby.client.am.Cursor.allocateCharBuffer(Cursor.java:1260)&lt;br/&gt;
       at org.apache.derby.client.net.NetStatementReply.parseSQLDTARDarray(NetStatementReply.java:1356)&lt;br/&gt;
       at org.apache.derby.client.net.NetStatementReply.parseQRYDSC(NetStatementReply.java:1207)&lt;br/&gt;
       at org.apache.derby.client.net.NetStatementReply.parseOpenQuery(NetStatementReply.java:479)&lt;br/&gt;
       at org.apache.derby.client.net.NetStatementReply.parseOPNQRYreply(NetStatementReply.java:223)&lt;br/&gt;
       at org.apache.derby.client.net.NetStatementReply.readOpenQuery(NetStatementReply.java:64)&lt;br/&gt;
       at org.apache.derby.client.net.StatementReply.readOpenQuery(StatementReply.java:50)&lt;br/&gt;
       at org.apache.derby.client.net.NetStatement.readOpenQuery_(NetStatement.java:153)&lt;br/&gt;
       at org.apache.derby.client.am.Statement.readOpenQuery(Statement.java:1396)&lt;br/&gt;
       at org.apache.derby.client.am.Statement.flowExecute(Statement.java:2001)&lt;br/&gt;
       at org.apache.derby.client.am.Statement.executeQueryX(Statement.java:421)&lt;br/&gt;
       at org.apache.derby.client.am.Statement.executeQuery(Statement.java:406)&lt;br/&gt;
       at RepeatStatement.testInsertAndSelect(RepeatStatement.java:31)&lt;br/&gt;
       at RepeatStatement.main(RepeatStatement.java:10)&lt;/p&gt;

&lt;p&gt;If I close the ResultSet or Statement it does not leak. &lt;/p&gt;

&lt;p&gt;This occurs on trunk and 10.2.1.6. It does however not run out of memory on 10.1.3.1, so appears to be a regression.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12386056">DERBY-3316</key>
            <summary>Leak in client if ResultSet not closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jan 2008 15:26:37 +0000</created>
                <updated>Tue, 30 Jun 2009 16:55:52 +0100</updated>
                            <resolved>Tue, 15 Jan 2008 23:47:07 +0000</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.3.2.1</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12558126" author="kmarsden" created="Fri, 11 Jan 2008 21:07:00 +0000"  >&lt;p&gt;The leak appears to be in SectionManager.positionedUpdateCursorNameToQuerySection_ which contrary to its name holds cursor mapping for all cursors, not just positioned updates.  These are not getting cleaned up in finalization.&lt;/p&gt;</comment>
                            <comment id="12558778" author="kmarsden" created="Mon, 14 Jan 2008 20:56:40 +0000"  >&lt;p&gt;The leak was actually in SectionManager.positionedUpdateCursorNameToResultSet_ which kept a reference to the ResultSet so it wouldn&apos;t get garbage collected.  The solution was to use a WeakReference to the ResultSets in positionedUpdateCursorNameToResultSet_ so that they can  be garbage collected.  See C:\kmarsden\patches\derby-3316_diff.txt .  Running tests now.&lt;/p&gt;</comment>
                            <comment id="12558811" author="kmarsden" created="Mon, 14 Jan 2008 22:08:09 +0000"  >&lt;p&gt;There may be a problem with the patch, My suites.All run ran out of memory.&lt;/p&gt;</comment>
                            <comment id="12558991" author="knutanders" created="Tue, 15 Jan 2008 09:29:40 +0000"  >&lt;p&gt;Doesn&apos;t the Hashtable still leak with the patch? It allows the ResultSet objects to be freed, but the Hashtable doesn&apos;t remove the empty WeakReference objects, so it will still grow, I think.&lt;/p&gt;

&lt;p&gt;It seems like you planned to add a comment to mapCursorNameToResultSet() but forgot to finish it.&lt;/p&gt;</comment>
                            <comment id="12559109" author="kmarsden" created="Tue, 15 Jan 2008 16:42:38 +0000"  >&lt;p&gt;Thank you Knut for looking at the patch.  I verified that the entries get removed from the Hashtable as part of the markClosed processing.  I printed out the size after calls to removeCursorNameToResultSetMapping and verified that the Hashtable is not growing. I fixed up the comment in the revised patch derby-3316_diff2.txt&lt;/p&gt;</comment>
                            <comment id="12559112" author="djd" created="Tue, 15 Jan 2008 16:48:32 +0000"  >&lt;p&gt;Seems like that the Hashtable positionedUpdateCursorNameToResultSet should really be a java.util.WeakHashMap, this would simplify the code, not exposing WeakReference into get/puts.&lt;/p&gt;</comment>
                            <comment id="12559115" author="kmarsden" created="Tue, 15 Jan 2008 16:53:10 +0000"  >&lt;p&gt;Actually making it a WeakHashMap is what I tried first but a WeakHashMap only creates WeakReferences based on the keys not the values, so that did not work. See the implementation notes at: &lt;a href=&quot;http://java.sun.com/javase/6/docs/api/java/util/WeakHashMap.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/javase/6/docs/api/java/util/WeakHashMap.html&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="12559118" author="djd" created="Tue, 15 Jan 2008 16:55:54 +0000"  >&lt;p&gt;Ignore that, I don&apos;t think a WeakHashMap is suitable, as it puts the WeakReference on the key.&lt;/p&gt;</comment>
                            <comment id="12559254" author="knutanders" created="Tue, 15 Jan 2008 22:21:24 +0000"  >&lt;p&gt;&amp;gt; I verified that the entries get removed from the Hashtable as part of the markClosed processing.&lt;/p&gt;

&lt;p&gt;Thanks Kathey, that makes sense. +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12559516" author="jorgenlo" created="Wed, 16 Jan 2008 14:33:46 +0000"  >&lt;p&gt;r612262 | kmarsden | 2008-01-15 23:36:38 +0100 (Tue, 15 Jan 2008) | 5 lines&lt;/p&gt;

&lt;p&gt;Could this commit have made org.apache.derbyTesting.functionTests.tests.jdbcapi.JDBCHarnessJavaTest fail:&lt;/p&gt;

&lt;p&gt;From suites all:&lt;/p&gt;

&lt;p&gt;There was 1 failure:&lt;br/&gt;
1) derbyStress(org.apache.derbyTesting.functionTests.tests.jdbcapi.JDBCHarnessJa vaTest)junit.framework.ComparisonFailure: Output at line 6 expected:&amp;lt;Test derbyS tress finished.&amp;gt; but was:&amp;lt;FAIL &amp;#8211; unexpected exception ****************&amp;gt;&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.util.CanonTestCase.compareCanon (CanonTestCase.java:100)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.util.HarnessJavaTest.runTest(Ha rnessJavaTest.java:91)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java: 96)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57 )&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57 )&lt;/p&gt;</comment>
                            <comment id="12559596" author="kmarsden" created="Wed, 16 Jan 2008 17:26:57 +0000"  >&lt;p&gt;org.apache.derbyTesting.functionTests.tests.jdbcapi.JDBCHarnessJavaTest  is passing for me and I don&apos;t see a failure in the tinderbox.  What is the output that you see for the test?  Perhaps I can glean something from that.&lt;/p&gt;

&lt;p&gt;That said I wonder if derbyStress should be run as part of  JDBCHarnessJavaTest since it is supposed to run with -Xmx64M.  It seems instead that it should remain in derbyall, since we can&apos;t control the heap for JUnit tests. Thoughts?&lt;/p&gt;

</comment>
                            <comment id="12559840" author="jorgenlo" created="Thu, 17 Jan 2008 07:14:27 +0000"  >&lt;p&gt;Hi Kathey, &lt;/p&gt;

&lt;p&gt;I reran the tests without getting this error - seems like an intermittent test failure. Sorry for the noise. &lt;/p&gt;</comment>
                            <comment id="12559987" author="kmarsden" created="Thu, 17 Jan 2008 16:41:40 +0000"  >&lt;p&gt;Attached is a patch to move derbyStress back to derbyall so that we can run it with 64MB heap.  I will run tests tonight and commit tomorrow.&lt;/p&gt;</comment>
                            <comment id="12559990" author="djd" created="Thu, 17 Jan 2008 16:53:30 +0000"  >&lt;p&gt;An alternative is to add a target under ant that runs the junit test with 64mb rather than reverting back to the harness, which we are trying to get rid of.&lt;br/&gt;
Then it could become part of the ant junit-all target that runs all the junit tests (which is actually more that suites.All).&lt;/p&gt;</comment>
                            <comment id="12560009" author="kmarsden" created="Thu, 17 Jan 2008 17:41:17 +0000"  >&lt;p&gt;For the adding it to the junit-all target option I think a few things have to happen for it to be run as part of the nightlies.&lt;/p&gt;

&lt;p&gt;1) Convert derbyStress.java to junit.&lt;br/&gt;
2) create a junit-lomem target and make it part of junit-all.&lt;br/&gt;
3) Fix junit-all so that it can run with the nightlies. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2045&quot; title=&quot;Allow ant targets junit-all and junitreport to be run from a release or snapshot.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2045&quot;&gt;DERBY-2045&lt;/a&gt; + distribute ant to the testing machines make nightly script changes etc.&lt;/p&gt;

&lt;p&gt;I don&apos;t have time right now to pursue all of these, so am proposing we move derbyStress.java back to derbyall for now until these goals can be accomplished so at least the nightlies are testing the low memory scenarios.  Right now the test doesn&apos;t test much because it won&apos;t fail even if there is a leak.  I think it was moved to JDBCHarnessJavaTest prematurely.  I&apos;d like to move it back to derbyall and open an issue to covert derbyStress outlining the issues.  Does that sound ok? &lt;/p&gt;


</comment>
                            <comment id="12560551" author="djd" created="Fri, 18 Jan 2008 21:24:38 +0000"  >&lt;p&gt;Fine to move the test back, I&apos;d assumed it had been converted to Junit.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12386478">DERBY-3323</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12372984" name="RepeatStatement.java" size="1167" author="kmarsden" created="Fri, 11 Jan 2008 15:27:34 +0000"/>
                            <attachment id="12373122" name="derby-3316_diff.txt" size="3694" author="kmarsden" created="Mon, 14 Jan 2008 20:56:40 +0000"/>
                            <attachment id="12373176" name="derby-3316_diff2.txt" size="3870" author="kmarsden" created="Tue, 15 Jan 2008 16:42:38 +0000"/>
                            <attachment id="12373409" name="move_derbystress_to_derbyall_diff.txt" size="1249" author="kmarsden" created="Thu, 17 Jan 2008 16:41:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 15 Jan 2008 09:29:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23568</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0urr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38803</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>