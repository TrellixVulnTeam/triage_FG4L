<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:51:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-353/DERBY-353.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-353] It is desirable to have IDENTITY_VAL_LOCAL() function return last recent user specified value or system generated value for BY DEFAULT identity columns.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-353</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Derby was recently enhanced to support BY DEFAULT identity column. While the behavior of this feature is not documented yet, I think, it is desirable for IDENTITY_VAL_LOCAL() function, that is used to retrieve last single statement insert value for identity column, to return user specified value for the default column.&lt;/p&gt;

&lt;p&gt;For GENERATED ALWAYS identity columns, this issue doesn&apos;t apply, since users can&apos;t provide a value. But for GENERATED BY DEFAULT identity columns, users can optionally specify a value. IDENTITY_VAL_LOCAL() function should return this value. Derby currently doesn&apos;t support this behavior.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table tauto ( i int generated by default as identity, j int, k int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into tauto (j,k) values (1,1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; values identity_val_local();&lt;br/&gt;
1&lt;br/&gt;
-------------------------------&lt;br/&gt;
1&lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; insert into tauto (j,k) values (1,1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; values identity_val_local();&lt;br/&gt;
1&lt;br/&gt;
-------------------------------&lt;br/&gt;
2&lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; insert into tauto values (5,1,1);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; values identity_val_local();&lt;br/&gt;
1&lt;br/&gt;
-------------------------------&lt;br/&gt;
2                                                                     &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;============= This needs be &apos;5&apos;&lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; select * from tauto;&lt;br/&gt;
I          |J          |K&lt;br/&gt;
-----------------------------------&lt;br/&gt;
1          |1          |1&lt;br/&gt;
2          |1          |1&lt;br/&gt;
5          |1          |1&lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;</description>
                <environment>Generic</environment>
        <key id="12311324">DERBY-353</key>
            <summary>It is desirable to have IDENTITY_VAL_LOCAL() function return last recent user specified value or system generated value for BY DEFAULT identity columns.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="narayanan">V.Narayanan</assignee>
                                    <reporter username="bandaram">Satheesh Bandaram</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jun 2005 09:43:46 +0100</created>
                <updated>Thu, 10 Aug 2006 14:43:25 +0100</updated>
                            <resolved>Thu, 10 Aug 2006 14:43:12 +0100</resolved>
                                    <version>10.1.1.0</version>
                                    <fixVersion>10.1.3.2</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12318442" author="narayanan" created="Thu, 11 Aug 2005 14:23:08 +0100"  >&lt;p&gt;Hi,&lt;br/&gt;
I have attached with this email the diff file of the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-353&quot; title=&quot;It is desirable to have IDENTITY_VAL_LOCAL() function return last recent user specified value or system generated value for BY DEFAULT identity columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-353&quot;&gt;&lt;del&gt;DERBY-353&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-439&quot; title=&quot;IDENTITY_VAL_LOCAL() returns null after INSERT INTO table VALUES(DEFAULT)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-439&quot;&gt;&lt;del&gt;DERBY-439&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;About the fix&lt;br/&gt;
-------------&lt;/p&gt;

&lt;p&gt;a) Inside the InsertResultSet class getSetAutoincrementValue function the Data Dictionary is accessed to get the current identity value.Which is then updated in the identityVal variable which is then used by the identity_val_local() function to display to the user.&lt;/p&gt;

&lt;p&gt;b) The above process did not happen when there was a user supplied value. The system table was not accessed and the setIdentity() function in the GenericLanguageContext class was not called.&lt;/p&gt;

&lt;p&gt;c) My fix attacked the case when the user supplies a value for the identity column which can be done in the case of Generated by default and calls the setIdentity function to store the value in this case also.&lt;/p&gt;

&lt;p&gt;    This involved&lt;/p&gt;

&lt;p&gt;    c.1) Identifying if the column has a autoincremented value. Done by constants.hasAutoincrement()&lt;br/&gt;
    c.2) If it does then finding which of the columns is an autoincrement done by&lt;/p&gt;

&lt;p&gt;        for(col=1;col&amp;lt;=maxColumns;col++)&lt;br/&gt;
                {&lt;br/&gt;
                      ColumnDescriptor cd = td.getColumnDescriptor(col);&lt;br/&gt;
                      if(cd.isAutoincrement())&lt;/p&gt;
                      {
                                break;
                      }
&lt;p&gt;                }&lt;br/&gt;
    c.3) getting the user inserted value&lt;/p&gt;

&lt;p&gt;        if(col &amp;lt;= maxColumns)&lt;/p&gt;
            {
               DataValueDescriptor dvd = row.cloneColumn(col);
               user_autoinc = dvd.getLong();
            }

&lt;p&gt;      c.4) calling the setIdentity() function in the GenericLanguageContext class with this value.&lt;/p&gt;

&lt;p&gt;Pls review the patch and give me your comments&lt;br/&gt;
thanx&lt;br/&gt;
Narayanan&lt;/p&gt;
</comment>
                            <comment id="12318689" author="rhillegas" created="Sat, 13 Aug 2005 09:29:21 +0100"  >&lt;p&gt;I have given Narayanan the following feedback concerning this bugfix:&lt;/p&gt;

&lt;p&gt;1) Looks like the diffs in the following files are just vacuous formatting changes which make the text worse: GenericLanguageConnectionContext, GenericStatement, InsertNode.&lt;/p&gt;

&lt;p&gt;2) I don&apos;t understand why this bugfix entails changes to a build file or to EmbedStatement.&lt;/p&gt;

&lt;p&gt;3) I also have general misgivings about whether identity_val_local() has well defined semantics. The code seems to assume that a table can have only one generated column.&lt;/p&gt;

&lt;p&gt;Narayanan responded:&lt;/p&gt;

&lt;p&gt;1) He will remove the vacuously diffing files from the submission.&lt;/p&gt;

&lt;p&gt;2) I didn&apos;t get a response on this issue.&lt;/p&gt;

&lt;p&gt;3) He explained that an email thread on derby-dev established that a table can have only one generated column.&lt;/p&gt;</comment>
                            <comment id="12320516" author="rhillegas" created="Tue, 30 Aug 2005 10:28:57 +0100"  >&lt;p&gt;The patch looks good but derbyall fails with diffs in derbylang/autoincrement. Was a canon left out of the patch?&lt;/p&gt;</comment>
                            <comment id="12320694" author="narayanan" created="Thu, 1 Sep 2005 00:12:40 +0100"  >&lt;p&gt;Hi,&lt;br/&gt;
As Rick has pointed out the problem was because of a missed cannon only.  The patch now includes the missed changes. &lt;br/&gt;
Narayanan&lt;/p&gt;</comment>
                            <comment id="12320741" author="rhillegas" created="Thu, 1 Sep 2005 09:41:29 +0100"  >&lt;p&gt;Derbyall now runs cleanly. Satheesh, can you commit this patch now? Thanks-Rick&lt;/p&gt;</comment>
                            <comment id="12324482" author="bandaram" created="Wed, 14 Sep 2005 06:15:35 +0100"  >&lt;p&gt;This patch has been committed sometime ago... Narayanan, can you mark this bug as RESOLVED? Then either yourself or myself can CLOSE the bug.&lt;/p&gt;</comment>
                            <comment id="12324505" author="narayanan" created="Wed, 14 Sep 2005 13:12:12 +0100"  >&lt;p&gt;The patch submitted for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-353&quot; title=&quot;It is desirable to have IDENTITY_VAL_LOCAL() function return last recent user specified value or system generated value for BY DEFAULT identity columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-353&quot;&gt;&lt;del&gt;DERBY-353&lt;/del&gt;&lt;/a&gt; resolves this &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-439&quot; title=&quot;IDENTITY_VAL_LOCAL() returns null after INSERT INTO table VALUES(DEFAULT)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-439&quot;&gt;&lt;del&gt;DERBY-439&lt;/del&gt;&lt;/a&gt; also. This was the test case pointed out which was returning null. This returns the correct value now.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:mydb;create=true&apos;;&lt;br/&gt;
ij&amp;gt; CREATE TABLE MYTABLE&lt;br/&gt;
(&lt;br/&gt;
     MYTABLE_ID BIGINT NOT NULL generated always as identity (start with 1)&lt;br/&gt;
) ;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO MYTABLE VALUES (DEFAULT);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; VALUES IDENTITY_VAL_LOCAL();&lt;br/&gt;
1&lt;br/&gt;
-------------------------------&lt;br/&gt;
1&lt;/p&gt;

&lt;p&gt;1 row selected &lt;/p&gt;</comment>
                            <comment id="12324508" author="narayanan" created="Wed, 14 Sep 2005 13:14:38 +0100"  >&lt;p&gt;The patch submitted by me earlier resolves this issue and a related issue &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-439&quot; title=&quot;IDENTITY_VAL_LOCAL() returns null after INSERT INTO table VALUES(DEFAULT)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-439&quot;&gt;&lt;del&gt;DERBY-439&lt;/del&gt;&lt;/a&gt; also. I have linked the two issues and will mark this issue as resolved. &lt;/p&gt;</comment>
                            <comment id="12330875" author="bandaram" created="Fri, 30 Sep 2005 08:16:39 +0100"  >&lt;p&gt;Fix has been checked in. Closing the bug.&lt;/p&gt;</comment>
                            <comment id="12362891" author="kmarsden" created="Tue, 17 Jan 2006 07:08:14 +0000"  >&lt;p&gt;In looking at the master for autogeneratedJdbc30, I noticed that although the master was updated with this fix to reflect  the new results,  the  test output description of the results does not  match the new results. e.g.&lt;/p&gt;

&lt;p&gt;NEW OUTPUT:&lt;br/&gt;
Test 3 - insert multiple rows into a table with autogenerated key and request generated keys resultset&lt;br/&gt;
 We will get a row with NULL value because this insert sql inserted more than one row and&lt;br/&gt;
 there was no prior one-row insert into a table with autogenerated key&lt;br/&gt;
         1&lt;br/&gt;
         -&lt;/p&gt;
        {3} 


&lt;p&gt;OLD OUTPUT:&lt;br/&gt;
Test 3 - insert multiple rows into a table with autogenerated key and request generated keys resultset&lt;br/&gt;
 We will get a row with NULL value because this insert sql inserted more than one row and&lt;br/&gt;
 there was no prior one-row insert into a table with autogenerated key&lt;br/&gt;
         1&lt;br/&gt;
         -&lt;/p&gt;
        {null}</comment>
                            <comment id="12365000" author="bandaram" created="Fri, 3 Feb 2006 06:07:53 +0000"  >&lt;p&gt;Reopening to mark fix version.&lt;/p&gt;</comment>
                            <comment id="12365001" author="bandaram" created="Fri, 3 Feb 2006 06:08:27 +0000"  >&lt;p&gt;Fix part of 10.2.&lt;/p&gt;</comment>
                            <comment id="12365002" author="bandaram" created="Fri, 3 Feb 2006 06:08:49 +0000"  >&lt;p&gt;Closing after resolving the bug.&lt;/p&gt;</comment>
                            <comment id="12425528" author="kmarsden" created="Thu, 3 Aug 2006 15:17:49 +0100"  >&lt;p&gt;I received a request from a user to  put this issue in 10.1.   I think though that this issue is an improvement and not a straight bug  fix so wanted to mention that in case anyone has concerns.  I   would like to do the following:&lt;/p&gt;

&lt;p&gt;1)  Change this issue to improvement.&lt;br/&gt;
2) File a doc issue to change the IDENTIY_VAL_LOCAL  doc to reflect the change.&lt;br/&gt;
&lt;a href=&quot;http://db.apache.org/derby/docs/10.1/ref/rrefidentityvallocal.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/docs/10.1/ref/rrefidentityvallocal.html&lt;/a&gt; &lt;br/&gt;
I think we just need to remove &quot; The assigned value is an identity value generated by Derby. &quot; since it now can be the value inserted by the user.&lt;br/&gt;
3) Wait until &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1554&quot; title=&quot;IDENTITY_VAL_LOCAL() returned value is modified incorrectly by a multi-row INSERT statement.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1554&quot;&gt;&lt;del&gt;DERBY-1554&lt;/del&gt;&lt;/a&gt; is fixed.&lt;br/&gt;
4) Port both &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-353&quot; title=&quot;It is desirable to have IDENTITY_VAL_LOCAL() function return last recent user specified value or system generated value for BY DEFAULT identity columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-353&quot;&gt;&lt;del&gt;DERBY-353&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1554&quot; title=&quot;IDENTITY_VAL_LOCAL() returned value is modified incorrectly by a multi-row INSERT statement.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1554&quot;&gt;&lt;del&gt;DERBY-1554&lt;/del&gt;&lt;/a&gt; to 10.1.&lt;/p&gt;

&lt;p&gt;Please let me know if anyone has any concerns.&lt;br/&gt;
I tried and tried to think of a user scenario that might be reliant on the old behavior and couldn&apos;t come up with one.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12427216" author="kmarsden" created="Thu, 10 Aug 2006 14:41:23 +0100"  >&lt;p&gt;reopen to fix fix version&lt;/p&gt;</comment>
                            <comment id="12427217" author="kmarsden" created="Thu, 10 Aug 2006 14:42:52 +0100"  >&lt;p&gt;Fixed in 10.1.3.2&lt;/p&gt;

&lt;p&gt;Date: Thu Aug 10 06:43:20 2006&lt;br/&gt;
New Revision: 430381&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=430381&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=430381&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-353&quot; title=&quot;It is desirable to have IDENTITY_VAL_LOCAL() function return last recent user specified value or system generated value for BY DEFAULT identity columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-353&quot;&gt;&lt;del&gt;DERBY-353&lt;/del&gt;&lt;/a&gt; It is desirable to have IDENTITY_VAL_LOCAL() function return last recent user specified value or system generated value for BY DEFAULT identity columns.&lt;/p&gt;

&lt;p&gt;Merged from trunk 267331, contributed by V.Narayanan&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1554&quot; title=&quot;IDENTITY_VAL_LOCAL() returned value is modified incorrectly by a multi-row INSERT statement.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1554&quot;&gt;&lt;del&gt;DERBY-1554&lt;/del&gt;&lt;/a&gt; IDENTITY_VAL_LOCAL() returned value is modified incorrectly by a multi-row INSERT statement.&lt;/p&gt;

&lt;p&gt;Merged from trunk 429425, contributed by Yip Ng&lt;/p&gt;


</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12311977">DERBY-439</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12346367">DERBY-1554</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12312107" name="patch353.diff" size="25779" author="narayanan" created="Thu, 1 Sep 2005 00:12:40 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 11 Aug 2005 13:23:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21915</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy14xr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40450</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>