<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:14:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1817/DERBY-1817.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1817] Race condition in network server&apos;s thread pool</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1817</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If there is a free DRDAConnThread when a client connects to the network server, the session is put into a queue from which one of the free DRDAConnThreads can pick it up. However, if another client connects after the session was put into the queue, but before the DRDAConnThread has picked it up, one might end up with more sessions in the queue than there are free threads. This can lead to hangs like the ones that we currently see in many of Ole&apos;s tests (for instance checkDataSource - &lt;a href=&quot;http://www.multinet.no/~solberg/public/Apache/TinderBox_Derby/testlog/SunOS-5.10_i86pc-i386/440518-derbyall_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.multinet.no/~solberg/public/Apache/TinderBox_Derby/testlog/SunOS-5.10_i86pc-i386/440518-derbyall_diff.txt&lt;/a&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12349317">DERBY-1817</key>
            <summary>Race condition in network server&apos;s thread pool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Sep 2006 16:46:37 +0100</created>
                <updated>Tue, 19 Sep 2006 07:55:30 +0100</updated>
                            <resolved>Tue, 19 Sep 2006 07:55:30 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12432882" author="bryanpendleton" created="Wed, 6 Sep 2006 16:58:00 +0100"  >&lt;p&gt;For more thoughts on the issues involving Network Server session management,&lt;br/&gt;
see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1326&quot; title=&quot;Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1326&quot;&gt;&lt;del&gt;DERBY-1326&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;http://wiki.apache.org/db-derby/NetworkServerSessionManagement&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/NetworkServerSessionManagement&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I should unassign myself from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1326&quot; title=&quot;Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1326&quot;&gt;&lt;del&gt;DERBY-1326&lt;/del&gt;&lt;/a&gt; because I&apos;m not actively&lt;br/&gt;
working on it and won&apos;t have time to return to it right away. I&apos;ll do so now.&lt;/p&gt;</comment>
                            <comment id="12432885" author="deepa" created="Wed, 6 Sep 2006 17:03:46 +0100"  >&lt;p&gt;I think this issue generalizes the problem found in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1326&quot; title=&quot;Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1326&quot;&gt;&lt;del&gt;DERBY-1326&lt;/del&gt;&lt;/a&gt;. I am linking both the issues.&lt;/p&gt;

&lt;p&gt;Bryan created a nice wiki page discussing network server session management here: &lt;a href=&quot;http://wiki.apache.org/db-derby/NetworkServerSessionManagement&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/NetworkServerSessionManagement&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12433087" author="knutanders" created="Thu, 7 Sep 2006 12:41:58 +0100"  >&lt;p&gt;Thanks for the useful pointers, Deepa and Bryan. The wiki page was very interesting! I won&apos;t address the shutdown and restart problems as part of this issue, but I will take a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1326&quot; title=&quot;Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1326&quot;&gt;&lt;del&gt;DERBY-1326&lt;/del&gt;&lt;/a&gt; later and see if I can come up with a bright idea (or use one of the bright ideas on the wiki page).&lt;/p&gt;</comment>
                            <comment id="12433577" author="knutanders" created="Sat, 9 Sep 2006 09:19:59 +0100"  >&lt;p&gt;Attaching a patch for this bug. Instead of always putting new sessions in the run queue when there are free threads, the network server now compares the number of free threads and the size of the run queue. This is done to prevent the run queue from growing to a size greater than the number of free threads. Also, the server now synchronizes on runQueue until the session has been added to the queue. This is to prevent two threads from deciding that there are enough free threads and adding the session to the run queue, when there in fact only were enough free threads for one of them. With this patch, I am not able to reproduce &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1757&quot; title=&quot;checkDataSource30 produces no output, most likely hangs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1757&quot;&gt;&lt;del&gt;DERBY-1757&lt;/del&gt;&lt;/a&gt; on platforms where the failure was easily reproduced before.&lt;/p&gt;

&lt;p&gt;The patch passes derbyall (Sun JVM 1.4.2, FreeBSD) and is ready for review. Thanks!&lt;/p&gt;</comment>
                            <comment id="12433581" author="forsini" created="Sat, 9 Sep 2006 10:10:14 +0100"  >&lt;p&gt;Great changes Knut.&lt;/p&gt;

&lt;p&gt;My only comment thus far:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think there is a tiny and potential race condition upon retrieving the maximum number of threads to create in the network server (via getMaxThreads()) and adding a newly created one on the thread list. Not sure if this is possible if there is some some higher-level lock but it seems like &apos;max&apos; could be reset while holding the runQueue lock (as we&apos;re synchronizing on 2 different objects) - It seems like the number of maxThreads can be updated at runtime (see processCommands()) - just raising this issue for now - maybe something to investigate if you haven&apos;t done so already. Just from a quick review.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Cheers.&lt;/p&gt;</comment>
                            <comment id="12433592" author="knutanders" created="Sat, 9 Sep 2006 11:32:54 +0100"  >&lt;p&gt;Thanks Francois,&lt;/p&gt;

&lt;p&gt;I noticed that one myself too, that&apos;s why I created the local copy (max) instead of calling getMaxThreads() twice, as the original code did. I&apos;m not sure I understand exactly what you mean by &quot;seems like &apos;max&apos; could be reset&quot;. Since it is a local int variable, other threads cannot change it, if that&apos;s what you mean by &quot;reset&quot;.&lt;/p&gt;

&lt;p&gt;It is true that maxThreads could potentially change after it has been copied into max and before the new thread is added to the thread list. I don&apos;t think this is a problem since we could end up with more threads than maxThreads regardless of synchronization (for instance by setting maxThreads to 3 when there are five threads). However, I don&apos;t see that expanding the synchronization should cause any problems either, so I will update my patch.&lt;/p&gt;

&lt;p&gt;(Talking about synchronization in NetworkServerControlImpl, I also noticed that timeSlice has a mutex object, timeSliceSync, but only setTimeSlice() synchronizes on that object. Seems like a bug...)&lt;/p&gt;

&lt;p&gt;Thank you very much for looking at the patch!&lt;/p&gt;</comment>
                            <comment id="12433596" author="knutanders" created="Sat, 9 Sep 2006 12:35:12 +0100"  >&lt;p&gt;Updated the patch based on Francois&apos;s comment. Ran derbynetclientmats with no errors.&lt;/p&gt;</comment>
                            <comment id="12433610" author="bryanpendleton" created="Sat, 9 Sep 2006 16:12:56 +0100"  >&lt;p&gt;I looked at 1817-2.diff and I think it is a good change. I think that moving this logic&lt;br/&gt;
from ClientThread to NetworkServerControlImpl is the right way to go; I had tried&lt;br/&gt;
several variants that were quite similar to this as part of working on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1326&quot; title=&quot;Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1326&quot;&gt;&lt;del&gt;DERBY-1326&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
The code is simpler and cleaner after this change.&lt;/p&gt;

&lt;p&gt;My only substantive comment is that I think, with this change, you can now&lt;br/&gt;
encapsulate the thread list entirely within NetworkServerControlImpl, because&lt;br/&gt;
no other class now needs access to these server control internals. That is, I think&lt;br/&gt;
you can remove the getFreeThreads, getThreadList, etc. methods from the&lt;br/&gt;
NetworkServerControlImpl class because they were there only to allow that access&lt;br/&gt;
from ClientThread which you have now removed, and so you can now hide the&lt;br/&gt;
ThreadList inside NetworkServerControlImpl and not expose these internals.&lt;/p&gt;

&lt;p&gt;Thanks for working on this problem!&lt;/p&gt;</comment>
                            <comment id="12433616" author="knutanders" created="Sat, 9 Sep 2006 16:48:54 +0100"  >&lt;p&gt;Thank you for reviewing the patch, Bryan! I think you are right, those methods could be removed or made private now. I will address that in a follow-up patch. Committed 1817-2.diff into trunk with revision 441802. Leaving the issue open until the suggested clean-up of NetworkServerControlImpl has been performed.&lt;/p&gt;</comment>
                            <comment id="12433636" author="forsini" created="Sat, 9 Sep 2006 19:48:10 +0100"  >&lt;p&gt;  &amp;gt; It is true that maxThreads could potentially change after it has been copied into max and before the new thread is added to the thread list.&lt;/p&gt;

&lt;p&gt;This is what I meant Yes.&lt;/p&gt;

&lt;p&gt;  &amp;gt; I don&apos;t think this is a problem since we could end up with more threads than maxThreads regardless of synchronization&lt;br/&gt;
  &amp;gt; (for instance by setting maxThreads to 3 when there are five threads). However, I don&apos;t see that expanding the synchronization should cause&lt;br/&gt;
  &amp;gt; any problems either, so I will update my patch. &lt;/p&gt;

&lt;p&gt;Great.&lt;/p&gt;

&lt;p&gt;  &amp;gt; Thank you very much for looking at the patch!&lt;/p&gt;

&lt;p&gt;My pleasure Knut &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12433647" author="knutanders" created="Sat, 9 Sep 2006 22:16:32 +0100"  >&lt;p&gt;One &quot;unfortunate&quot; effect of my changes is that addSession() has become&lt;br/&gt;
thread safe. That is, multiple threads may invoke addSession()&lt;br/&gt;
concurrently without interfering with each other. Since addSession()&lt;br/&gt;
is only invoked from one thread (ClientThread), this is not strictly&lt;br/&gt;
necessary.&lt;/p&gt;

&lt;p&gt;Also, the last sentence of this comment is not true as long as only&lt;br/&gt;
one thread invokes addSession():&lt;/p&gt;

&lt;p&gt;  // Synchronize on runQueue to prevent other threads from updating&lt;br/&gt;
  // runQueue or freeThreads. Hold the monitor&apos;s lock until a thread is&lt;br/&gt;
  // started or the session is added to the queue. If we release the lock&lt;br/&gt;
  // earlier, we might start too few threads (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1817&quot; title=&quot;Race condition in network server&amp;#39;s thread pool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1817&quot;&gt;&lt;del&gt;DERBY-1817&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;When I wrote that comment, I was thinking about multiple threads&lt;br/&gt;
invoking addSession(), but that doesn&apos;t happen. The way the current&lt;br/&gt;
code works, it would be enough to synchronize on runQueue when&lt;br/&gt;
comparing runQueue.size() and freeThreads, like this:&lt;/p&gt;

&lt;p&gt;  boolean enoughThreads;&lt;br/&gt;
  synchronized (runQueue) &lt;/p&gt;
{
      enoughThreads = (runQueue.size() &amp;lt; freeThreads);
  }

&lt;p&gt;I am tempted to write a new patch which reduces the amount of code&lt;br/&gt;
synchronized on runQueue, but I also see the value of addSession()&lt;br/&gt;
being thread safe (in case the use of it changes, for instance by&lt;br/&gt;
having multiple ClientThreads listening to different ports). Does&lt;br/&gt;
anyone have an opinion on this?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12433780" author="knutanders" created="Mon, 11 Sep 2006 07:29:00 +0100"  >&lt;p&gt;Attached 1817-3-sync.diff which reduces the amount of code synchronized on runQueue in NetworkServerControlImpl.addSession(). There is still more code synchronized on runQueue after this patch than before the 1817-2 patch, but the synchronization that was not necessary for the fix has been removed. Patch passes derbyall and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1757&quot; title=&quot;checkDataSource30 produces no output, most likely hangs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1757&quot;&gt;&lt;del&gt;DERBY-1757&lt;/del&gt;&lt;/a&gt; still cannot be reproduced. Reviews are welcome. Thanks!&lt;/p&gt;</comment>
                            <comment id="12433826" author="knutanders" created="Mon, 11 Sep 2006 12:28:02 +0100"  >&lt;p&gt;The attached patch (1817-4-cleanup) contains the cleanup suggested by Bryan. It is independent of the 1817-3-sync patch, which is not committed yet.&lt;/p&gt;

&lt;p&gt;Description:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;moves generation of connection number into addSession()&lt;/li&gt;
	&lt;li&gt;adds new method removeThread() which can be used instead of getThreadList().remove()&lt;/li&gt;
	&lt;li&gt;removes methods that are no longer used&lt;/li&gt;
	&lt;li&gt;makes methods that are only used by NetworkServerControlImpl private&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12433966" author="bryanpendleton" created="Mon, 11 Sep 2006 21:08:08 +0100"  >&lt;p&gt;Both 1817-3 and 1817-4 look like good changes to me. Thanks for continuing&lt;br/&gt;
to clean up this code. I&apos;m eager for you to have a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1326&quot; title=&quot;Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1326&quot;&gt;&lt;del&gt;DERBY-1326&lt;/del&gt;&lt;/a&gt; now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12433981" author="forsini" created="Mon, 11 Sep 2006 21:49:40 +0100"  >&lt;p&gt;1817-3-sync.diff looks good to me Knut. Cheers.&lt;/p&gt;</comment>
                            <comment id="12434070" author="knutanders" created="Tue, 12 Sep 2006 07:04:26 +0100"  >&lt;p&gt;Thank you for the quick reviews, Francois and Bryan!&lt;br/&gt;
Committed 1817-3 with revision 442462, and 1817-4 with revision 442463.&lt;br/&gt;
Leaving the issue open until the fixes have been merged to 10.2.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12348535">DERBY-1757</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12340130">DERBY-1326</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12340513" name="1817-2.diff" size="4304" author="knutanders" created="Sat, 9 Sep 2006 12:35:11 +0100"/>
                            <attachment id="12340549" name="1817-3-sync.diff" size="2977" author="knutanders" created="Mon, 11 Sep 2006 07:29:00 +0100"/>
                            <attachment id="12340562" name="1817-4-cleanup.diff" size="4062" author="knutanders" created="Mon, 11 Sep 2006 12:28:02 +0100"/>
                            <attachment id="12340563" name="1817-4-cleanup.stat" size="200" author="knutanders" created="Mon, 11 Sep 2006 12:28:02 +0100"/>
                            <attachment id="12340510" name="1817.diff" size="3724" author="knutanders" created="Sat, 9 Sep 2006 09:19:59 +0100"/>
                            <attachment id="12340511" name="1817.stat" size="136" author="knutanders" created="Sat, 9 Sep 2006 09:19:59 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 Sep 2006 15:58:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22726</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy14lz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40397</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>