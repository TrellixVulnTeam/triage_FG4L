<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:37:11 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4122/DERBY-4122.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4122] ClassCastException in SQLClob when running in soft upgrade mode (10.4.2.0 -&gt; 10.5.1.0)</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4122</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This bug was found when doing soft upgrade testing from Derby version 10.4.2.0 to 10.5.1.0 (RC1)&lt;/p&gt;

&lt;p&gt;Steps followed are as follows.&lt;/p&gt;

&lt;p&gt;1. Run setEmbeddedCP.bat from version 10.4.2.0&apos;s bin folder&lt;br/&gt;
2. In a test folder run ij&lt;br/&gt;
3. create system/wombat database.&lt;br/&gt;
    ij&amp;gt; connect &apos;jdbc:derby:system/wombat;create=true&apos;;&lt;br/&gt;
4. exit ij&lt;br/&gt;
5. Copy the 10.5.1.0 derby jars (from lib folder) and the derbyTesting.jar from 10.4.2.0 to the test folder and set classpath with them (including junit and ORO)&lt;br/&gt;
6. Run suites.All &lt;br/&gt;
     java -Xmx512M -Xms512M -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.suites.All&lt;/p&gt;

&lt;p&gt;Result:&lt;br/&gt;
Tests run: 10479,  Failures: 56,  Errors: 34&lt;/p&gt;

&lt;p&gt;The exception stack trace from a failed test follows.&lt;/p&gt;

&lt;p&gt;-------------------------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;3) testClobInTriggerTable(org.apache.derbyTesting.functionTests.tests.lang.TriggerTest)java.sql.SQLException: Java exception: &apos;org.apache.derby.iapi.types.ReaderToUTF8Stream cannot be cast to org.apache.derby.iapi.types.Resetable: java.lang.ClassCastException&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.testClobInTriggerTable(TriggerTest.java:529)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.testClobInTriggerTable(TriggerTest.java:451)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:102)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;org.apache.derby.iapi.types.ReaderToUTF8Stream cannot be cast to org.apache.derby.iapi.types.Resetable: java.lang.ClassCastException&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)&lt;br/&gt;
	... 39 more&lt;br/&gt;
Caused by: java.lang.ClassCastException: org.apache.derby.iapi.types.ReaderToUTF8Stream cannot be cast to org.apache.derby.iapi.types.Resetable&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLClob.rewindStream(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLClob.readExternal(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.getString(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.loadStream(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.UpdateResultSet.objectifyStream(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.UpdateResultSet.collectAffectedRows(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.UpdateResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	... 32 more&lt;br/&gt;
------------------------------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;When looking at the SVN revisions for SQLClob with Kathey Marsden, we found the following statement in revision # 738408, related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3907&quot; title=&quot;Save useful length information for Clobs in store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3907&quot;&gt;&lt;del&gt;DERBY-3907&lt;/del&gt;&lt;/a&gt;, which might be related to this issue.&lt;/p&gt;

&lt;p&gt;&quot;NOTE: Databases created with this revision (or later) containing Clobs, cannot be accessed by earlier trunk revisions.&quot;&lt;br/&gt;
Patch file: derby-3907-7a3-use_new_header_format.diff&lt;/p&gt;



</description>
                <environment>Windows Vista 64, Sun JDK 1.6.0_10, Junit 3.8.2</environment>
        <key id="12419563">DERBY-4122</key>
            <summary>ClassCastException in SQLClob when running in soft upgrade mode (10.4.2.0 -&gt; 10.5.1.0)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="suranjay">Suran Jayathilaka</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Mar 2009 19:29:40 +0000</created>
                <updated>Wed, 1 Jul 2009 17:21:13 +0100</updated>
                            <resolved>Mon, 6 Apr 2009 16:37:14 +0100</resolved>
                                                    <fixVersion>10.5.1.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12689623" author="suranjay" created="Thu, 26 Mar 2009 19:53:55 +0000"  >&lt;p&gt;This is the stack trace from another failed test in the same test run, which may be related to the same issue as above. Should be investigated and filed separately if this is caused by a different problem.&lt;/p&gt;

&lt;p&gt;13) testTriggersWithClobColumn(org.apache.derbyTesting.functionTests.tests.jdbcapi.BlobClob4BlobTest)java.sql.SQLException: An IOException was thrown when reading a &apos;java.sql.String&apos; from an InputStream.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.seeNextException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.jdbcapi.BlobClob4BlobTest.testTriggersWithClobColumn(BlobClob4BlobTest.java:397)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:102)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
Caused by: java.sql.SQLException: An IOException was thrown when reading a &apos;java.sql.String&apos; from an InputStream.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)&lt;br/&gt;
	... 45 more&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;: java.io.EOFException&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	... 42 more&lt;br/&gt;
Caused by: java.io.EOFException&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.readExternal(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLClob.readExternal(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.getString(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.loadStream(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DMLWriteResultSet.objectifyStreams(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.UpdateResultSet.collectAffectedRows(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.UpdateResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	... 38 more&lt;/p&gt;</comment>
                            <comment id="12689688" author="kristwaa" created="Thu, 26 Mar 2009 21:50:26 +0000"  >&lt;p&gt;I&apos;m pretty sure &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3907&quot; title=&quot;Save useful length information for Clobs in store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3907&quot;&gt;&lt;del&gt;DERBY-3907&lt;/del&gt;&lt;/a&gt; introduced this bug. I&apos;ll have a look tomorrow.&lt;/p&gt;
</comment>
                            <comment id="12689896" author="kristwaa" created="Fri, 27 Mar 2009 13:50:07 +0000"  >&lt;p&gt;Posting two small patches;&lt;br/&gt;
 1a: makes a stream with a pre-10.5 header correctly positioned after the header has been investigated.&lt;br/&gt;
 2a: makes BlobClob4BlobTest.testTriggersWithClobColumn() select from the correct tables (probably a typo in the original test).&lt;/p&gt;

&lt;p&gt;Patch 1a should fix some of the EOFExceptions reported during soft upgrade testing (reported by Suran), but it doesn&apos;t fix the class cast errors.&lt;/p&gt;</comment>
                            <comment id="12689916" author="kmarsden" created="Fri, 27 Mar 2009 14:32:12 +0000"  >&lt;p&gt;Regarsding patch 1a, It would be good to have a new upgrade test to test the fix and also to have a brief code comment to explain the fix and mention the JIRA number for reference.  Perhaps, since it is a different problem than the ClassCastException (or at least has a different fix), another Jira might be appropriate.&lt;/p&gt;

&lt;p&gt;Since the test patch is not really related.  It would be good to have it as a separate commit.&lt;/p&gt;
</comment>
                            <comment id="12689922" author="kristwaa" created="Fri, 27 Mar 2009 14:47:18 +0000"  >&lt;p&gt;Sorry Kathey, I just committed the patches before I saw your comment.&lt;br/&gt;
Committed patch 1a to trunk with revision 759153, and patch 2a to trunk with revision 759155.&lt;/p&gt;

&lt;p&gt;Regarding tests, I believe our existing tests cover the issue &lt;b&gt;if&lt;/b&gt; they are run against a 10.4 database. I must admit, it is not clear to me what will be run and tested as part of our default upgrade tests. I need to look into this.&lt;/p&gt;</comment>
                            <comment id="12689923" author="kristwaa" created="Fri, 27 Mar 2009 14:51:41 +0000"  >&lt;p&gt;BTW, derbyall and suites.All passed.&lt;/p&gt;</comment>
                            <comment id="12689970" author="kristwaa" created="Fri, 27 Mar 2009 17:14:56 +0000"  >&lt;p&gt;Patch 3a is the first revision for a fix. I haven&apos;t had time to run extensive tests yet.&lt;br/&gt;
I found that the problem is that Derby tries to reset / rewind a stream that can&apos;t be reset.&lt;br/&gt;
These streams are coming directly from the user, wrapped in a ReaderToUTF8Stream. It would be best to avoid having to move backwards in the stream, but then we have to know we&apos;re dealing with a database in soft upgrade mode. This information hasn&apos;t been kept in SQLClob earlier.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4102&quot; title=&quot;Assert failure or ClassCastException in EmbedBlob when retrieving BLOB &amp;gt;= 32K&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4102&quot;&gt;&lt;del&gt;DERBY-4102&lt;/del&gt;&lt;/a&gt; is a related issue that has been logged.&lt;/p&gt;

&lt;p&gt;There is also a bug in the stream code to deal with the empty string (&quot;&quot;).&lt;br/&gt;
In the patch I have chosen to materialize the value if it is very small instead of keeping the stream (see SQLClob.setObject()). The Clob is also materialized when a clone is created in the existing code.&lt;br/&gt;
This problem should be investigated further to understand the root cause.&lt;/p&gt;

&lt;p&gt;Note that the patch doesn&apos;t solve all the issues. When running BlobClob4BlobTest in soft upgrade mode, you still get two failures:&lt;br/&gt;
junit.framework.ComparisonFailure: Unexpected SQL state. expected:&amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;XJ073&amp;#93;&lt;/span&gt;&amp;gt; but was:&amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;40XD0&amp;#93;&lt;/span&gt;&amp;gt;&lt;br/&gt;
My theory here is that the exception is being thrown in a different place in 10.5 than in 10.4, and in 10.5 there is no code wrapping the inner-most exception.&lt;/p&gt;


&lt;p&gt;I&apos;m starting derbyall and suites.All now.&lt;br/&gt;
Patch ready for review and comments.&lt;/p&gt;</comment>
                            <comment id="12693495" author="kristwaa" created="Sat, 28 Mar 2009 21:40:05 +0000"  >&lt;p&gt;derbyall and suites.All ran without failures (with freshly created test databases, not in soft upgrade mode).&lt;/p&gt;</comment>
                            <comment id="12693802" author="kristwaa" created="Mon, 30 Mar 2009 16:24:16 +0100"  >&lt;p&gt;Patch 3b also takes care of the incorrect SQLState errors seen during soft upgrade testing.&lt;/p&gt;</comment>
                            <comment id="12694146" author="kristwaa" created="Tue, 31 Mar 2009 16:19:52 +0100"  >&lt;p&gt;In patch 3b, there are some issues that need to be resolved:&lt;br/&gt;
 1) How to best determine if a stream is resetable or not.&lt;br/&gt;
 2) Is it okay to materialize small Clobs in SQLClob.setObject?&lt;br/&gt;
    And what should the threshold for a small Clob be?&lt;/p&gt;

&lt;p&gt;The problem in 1 is that no matter if the source stream is resetable or not, we wrap it in a FormatIdInputStream. This class implements the Resetable interface, and a test for instanceof Resetable will fail with the reported ClassCastException.&lt;br/&gt;
Some options from the top of my head (I&apos;ll spend more time investigating, but would appreciate comments);&lt;br/&gt;
 a) Introduce yet another class (a &quot;non-resetable-FormatIdInputStream&quot;)&lt;br/&gt;
 b) Add the method isResetable to the Resetable interface (kind of contradicting...)&lt;br/&gt;
 c) Try to reset / rewind, catch ClassCastException and fallback to passing along the &quot;bytes peeked at&quot;.&lt;br/&gt;
 d) Add instance variable in SQLChar, which allows us to do the instanceof check before we wrap the stream in a FormatIdInputStream.&lt;br/&gt;
 e) Your suggestion?&lt;/p&gt;

&lt;p&gt;Note that I haven&apos;t had time to throughly investigate this yet, so I may have missed something that&apos;s simpler and easier to implement.&lt;/p&gt;

&lt;p&gt;A few comments on some of the options I mentioned so far:&lt;br/&gt;
 a) This adds to the overhead, but the fact that this problem arises suggests there is a design problem in the current implementation. It is not clear to me  what kind of changes this approach requires.&lt;br/&gt;
 c) Probably doable, but this makes exception catching part of the &quot;flow control&quot; for Clobs written with the old header format.&lt;br/&gt;
 d) Adds more state to a central data type, which has to be maintained. I think the maintenance costs should be modest, but I haven&apos;t investigated that. It may be possible to add this information to the CharacterStreamDescriptor-object, but again I don&apos;t know how this will play out.&lt;/p&gt;

&lt;p&gt;That said, the current patch already works...&lt;br/&gt;
Feedback appreciated!&lt;/p&gt;</comment>
                            <comment id="12694429" author="kristwaa" created="Wed, 1 Apr 2009 10:06:29 +0100"  >&lt;p&gt;Backported patches 1a and 2a to 10.5 with revision 760820.&lt;/p&gt;</comment>
                            <comment id="12694436" author="knutanders" created="Wed, 1 Apr 2009 10:14:47 +0100"  >&lt;p&gt;&amp;gt; 1) How to best determine if a stream is resetable or not.&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; The problem in 1 is that no matter if the source stream is resetable&lt;br/&gt;
&amp;gt; or not, we wrap it in a FormatIdInputStream. This class implements&lt;br/&gt;
&amp;gt; the Resetable interface, and a test for instanceof Resetable will&lt;br/&gt;
&amp;gt; fail with the reported ClassCastException.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure I understand. The patch solved the ClassCastException by&lt;br/&gt;
checking stream instanceof ReaderToUTF8Stream. Where does the&lt;br/&gt;
FormatIdInputStream come into the picture?&lt;/p&gt;

&lt;p&gt;&amp;gt; 2) Is it okay to materialize small Clobs in SQLClob.setObject?&lt;br/&gt;
&amp;gt;    And what should the threshold for a small Clob be?&lt;/p&gt;

&lt;p&gt;That sounds OK to me. When we get the Clobs from store, isn&apos;t the&lt;br/&gt;
limit about 32K? Perhaps that could be used as a starting point.&lt;/p&gt;

&lt;p&gt;Nit: SQLChar.EMPTY could be replaced by ReuseFactory.getZeroLenByteArray().&lt;/p&gt;</comment>
                            <comment id="12694446" author="kristwaa" created="Wed, 1 Apr 2009 10:34:39 +0100"  >&lt;p&gt;&amp;gt; I&apos;m not sure I understand. The patch solved the ClassCastException by&lt;br/&gt;
&amp;gt; checking stream instanceof ReaderToUTF8Stream. Where does the&lt;br/&gt;
&amp;gt; FormatIdInputStream come into the picture? &lt;/p&gt;

&lt;p&gt;The instanceof ReaderToUTF8Stream happens in SQLClob.readExternal.&lt;br/&gt;
From SQLChar.getString():&lt;br/&gt;
&quot;&quot;&quot;&lt;br/&gt;
            } else if (stream != null) {&lt;/p&gt;

&lt;p&gt;                // data stored as a stream&lt;br/&gt;
                try {&lt;/p&gt;

&lt;p&gt;                    if (stream instanceof FormatIdInputStream) &lt;/p&gt;
{
                        readExternal((FormatIdInputStream) stream);
                    }
&lt;p&gt; else &lt;/p&gt;
{
                        readExternal(new FormatIdInputStream(stream));
                    }
&lt;p&gt;                    stream = null;&lt;/p&gt;

&lt;p&gt;                    // at this point the value is only in the char[]&lt;br/&gt;
                    // so call again to convert to a String&lt;br/&gt;
                    return getString();&lt;/p&gt;

&lt;p&gt;                } catch (IOException ioe) {&lt;br/&gt;
&quot;&quot;&quot;&lt;/p&gt;

&lt;p&gt;In the code above, the variable &apos;stream&apos; will be a FormatIdInputStream if it&lt;br/&gt;
comes from store, and ReaderToUTF8Stream if the value hasn&apos;t been&lt;br/&gt;
inserted into the store (i.e. we&apos;re working on this value from within a trigger,&lt;br/&gt;
or a VALUES clause).&lt;br/&gt;
At this point, doing the more general check &apos;stream instanceof Resetable&apos; is valid.&lt;/p&gt;

&lt;p&gt;And again, the reason why this was discovered during (soft) upgrade testing, is that&lt;br/&gt;
in a fresh 10.5 database you won&apos;t have to reset / rewind the stream.&lt;/p&gt;</comment>
                            <comment id="12694475" author="knutanders" created="Wed, 1 Apr 2009 12:24:41 +0100"  >&lt;p&gt;Is it possible to implement mark()/reset()/markSupported() in ReaderToUTF8Stream? Then we could use stream.mark(MAX_STREAM_HEADER_LENGTH) before the read operation and stream.reset() + InputStreamUtil.skipFully(stream, hdrInfo.headerLenght()) after on. We would still need separate code for the Resetable case, though, but we wouldn&apos;t need to check for exact class match, checks for InputStream.markSupported() and instanceof Resetable would do.&lt;/p&gt;</comment>
                            <comment id="12694621" author="kristwaa" created="Wed, 1 Apr 2009 18:07:18 +0100"  >&lt;p&gt;Thanks for the comments, Knut Anders!&lt;/p&gt;

&lt;p&gt;I have implemented a first &lt;b&gt;draft&lt;/b&gt; of the mark/reset approach. Please have a look.&lt;br/&gt;
I&apos;m also wondering what to do if we are still unable to reset the stream (i.e., that it doesn&apos;t support mark/reset nor Resetable).&lt;br/&gt;
Keep the &quot;bytesPeekedAt&quot;-mechanism or just fail with an IOException?&lt;/p&gt;

&lt;p&gt;I think the mark/reset approach you suggested looks better than the bytesPeekedAt-approach, and it may also be useful in other settings. Keeping the latter clutters the code to some degree, and I don&apos;t think it&apos;s possible for a user to inject a stream that doesn&apos;t support mark/reset nor Resetable.&lt;/p&gt;</comment>
                            <comment id="12694908" author="knutanders" created="Thu, 2 Apr 2009 09:18:35 +0100"  >&lt;p&gt;I agree that it sounds better to remove the bytesPeekedAt code since we are able to control which streams are passed in and can make sure that they implement one of the reset interfaces.&lt;/p&gt;

&lt;p&gt;I haven&apos;t reviewed the full patch yet, only the ReaderToUTF8Stream part. Here are my comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Since the buffer is not of constant size, I think we should remove the BUFSIZE constant so that no one incorrectly uses it instead of buffer.length. In fact, I think the available() method will return the wrong result now because it uses BUFSIZE.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Do we need to separate between MARK_UNSET and EXCEEDED_MARK_LIMIT? Seems like we can get away with using MARK_UNSET in both cases and get slightly simpler code, and one less error message to internationalize (the message for the new IOException should be internationalized, shouldn&apos;t it?)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think I would have removed the shrink logic in fillBuffer(). It&apos;s probably going to end up as code that&apos;s never called, so I don&apos;t think the benefit (potentially release memory earlier if mark() is called with a really large argument) justifies the extra code.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Should there be a comment and/or constant for the magic number 6 in fillBuffer()? I see that there is a comment in the existing code, but it is further down, so I scratched my head for a while trying to understand it before I got to that comment.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;One potential optimization (not needed in the first increment, but it&apos;s so simple that it&apos;s probably worth adding it later): When we allocate a new buffer, we could check if buffer.length &amp;lt;= (readAheadLimit + 6), and if it is, we can just reuse the old buffer. If oldBuf and buffer point to the same array, the call to arraycopy() will just shift the bytes to the left and free space at the right side of the array.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12694918" author="knutanders" created="Thu, 2 Apr 2009 09:54:29 +0100"  >&lt;p&gt;SQLClob.java:&lt;/p&gt;

&lt;p&gt;The approach seems fine to me. Some more detailed comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Won&apos;t the code below throw NPE if ioe.getCause() returns null?&lt;br/&gt;
Initializing rootCause to ioe would be safer, I think, and still do the right thing.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+                Throwable rootCause = ioe.getCause();&lt;br/&gt;
+                while (rootCause.getCause() != null) &lt;/p&gt;
{
+                    rootCause = rootCause.getCause();
+                }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Perhaps we should remove the instanceof check in the code below and remove the else branch? I think the ClassCastException we would get then is more informative than &quot;Unable to reset stream&quot; (and it saves us one translation &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+                } else if (stream instanceof Resetable) &lt;/p&gt;
{
+                    // We have a store stream.
+                    rewindStream(hdrInfo.headerLength());
+                }
&lt;p&gt; else &lt;/p&gt;
{
+                    throw new IOException(&quot;Unable to reset stream&quot;);
+                }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In readExternal() we now subtract the header length from the byte length before we pass it to super.readExternal(). As far as I can see, this is a code path taken in normal operation too, not only in soft upgrade. Was this a bug that was possible to see when not running with a soft upgraded db?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Both SQLClob and ReaderToUTF8Stream have code where they use Math.max(0, x-y) to prevent that an argument goes negative. I&apos;m not sure I see why the arguments will go negative, and isn&apos;t there a chance that we&apos;re hiding real bugs this way? It would be good if there at least was a comment stating which conditions that may make the result negative, so that it is easier to see that it is OK to use 0 in those cases.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12694932" author="kristwaa" created="Thu, 2 Apr 2009 10:30:02 +0100"  >&lt;p&gt;Knut, I&apos;m working on a new patch. The following items (taken from your comments) will be addressed:&lt;br/&gt;
 o remove BUFSIZE (and adjust code where required)&lt;br/&gt;
 o remove shrink logic&lt;br/&gt;
 o move and/or add more comments about the magic number 6&lt;br/&gt;
 o copy optimization&lt;br/&gt;
 o NPE possibility in root cause determination code&lt;br/&gt;
 o rewrite if in SQLClob&lt;/p&gt;

&lt;p&gt;Then some comments on some of the other items:&lt;br/&gt;
&amp;gt; Do we need to separate between MARK_UNSET and EXCEEDED_MARK_LIMIT?&lt;br/&gt;
No, only for more specific error reporting, I think.&lt;/p&gt;

&lt;p&gt;&amp;gt; In readExternal() we now subtract the header length from the byte length before we pass it to super.readExternal(). As far as I can see, this is a code path taken in normal operation too, not only in soft upgrade. Was this a bug that was possible to see when not running with a soft upgraded db? &lt;br/&gt;
No, it should not happen in a fresh 10.5 database. It can happen in soft and hard upgrade.&lt;br/&gt;
The reason why it doesn&apos;t happen in a fresh database, is that all lengths are stored as character counts.&lt;/p&gt;

&lt;p&gt;&amp;gt; Both SQLClob and ReaderToUTF8Stream have code where they use Math.max(0, x-y) to prevent that an argument goes negative. I&apos;m not sure I see why the arguments will go negative, and isn&apos;t there a chance that we&apos;re hiding real bugs this way?&lt;br/&gt;
The argument in SQLClob will go negative when the stored length in the byte header is 0. Since the header length is still two in this case, we get 0 - 2 = -2. There is a slight chance we may hide a bug with this, but the bug will be revealed when we actually try to read the value. In principle, what we&apos;re saying here is that if the length we obtained from the header is negative, assume it is unknown.&lt;br/&gt;
I can try to rewrite the check so that it is easier to understand, and add some comments.&lt;/p&gt;

&lt;p&gt;In ReaderToUTF8Stream, the variable blen will be -1 the first time we fill the buffer. Again, I&apos;ll rewrite or/and add a comment to make it easier to read the code.&lt;/p&gt;</comment>
                            <comment id="12695772" author="kristwaa" created="Sat, 4 Apr 2009 18:37:43 +0100"  >&lt;p&gt;New revision (4b) of the mark/reset fix.&lt;/p&gt;

&lt;p&gt;I&apos;m rerunning tests, plan to commit tomorrow if they pass.&lt;/p&gt;</comment>
                            <comment id="12695922" author="knutanders" created="Sun, 5 Apr 2009 22:39:44 +0100"  >&lt;p&gt;4b looks good to me. Two minor comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SQLState.LANG_STREAM_MARK_UNSET_OR_EXCEEDED should be moved to MessageId, since it&apos;s not used in an SQLException&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I don&apos;t think EOFException should be thrown by reset() when the stream is closed, as stream closed does not mean that EOF has been reached. What about a plain IOException with the message from SQLState.LANG_STREAM_CLOSED?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12696128" author="kristwaa" created="Mon, 6 Apr 2009 16:25:44 +0100"  >&lt;p&gt;Thanks for looking at the patch again, Knut Anders.&lt;/p&gt;

&lt;p&gt;I have moved the new message to MessageId. It wasn&apos;t immediately clear to me what to name the message and into which category it should be placed. We can move/rename it later if required.&lt;/p&gt;

&lt;p&gt;Regarding the EOFException, I have chosen to keep it as it is for now because other methods in the class use it too. It may be that it should be changed, but it must be tested. Since ReaderToUTF8Stream has been considered an &quot;internal stream class&quot; it is not clear to me whether Derby code expects the EOFException or not.&lt;/p&gt;

&lt;p&gt;I also want to improve the test a bit, by making the randomized test verify the content returned by the stream. Depending on when I get around to do it, I may do this under this issue or create a sub-issue.&lt;/p&gt;</comment>
                            <comment id="12696129" author="kristwaa" created="Mon, 6 Apr 2009 16:27:02 +0100"  >&lt;p&gt;Attached the correct file this time (4c)...&lt;/p&gt;</comment>
                            <comment id="12696134" author="kristwaa" created="Mon, 6 Apr 2009 16:37:14 +0100"  >&lt;p&gt;Committed patch 4c to trunk with revision 762384, and to 10.5 with revision 762389.&lt;/p&gt;

&lt;p&gt;I&apos;m marking this issue as resolved, but I may still add the last test improvement I have mentioned.&lt;br/&gt;
I don&apos;t believe any more changes are required to fix the reported bug. I don&apos;t see the reported problem when running in soft upgrade with the fix, but please verify.&lt;/p&gt;

&lt;p&gt;(BTW, I&apos;ll be unavailable for a week from today)&lt;/p&gt;</comment>
                            <comment id="12696135" author="knutanders" created="Mon, 6 Apr 2009 16:39:52 +0100"  >&lt;p&gt;Thanks. Keeping the EOFException for consistency with the other methods in the class sounds OK to me.&lt;/p&gt;</comment>
                            <comment id="12697190" author="suranjay" created="Wed, 8 Apr 2009 21:49:28 +0100"  >&lt;p&gt;Verified the fix with Snapshot build 10.5.1.1_2009-04-07T20-30-19_SVN762838 by running suites.All on a soft upgrade.&lt;br/&gt;
The ClassCastException failures did not occur.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12421688">DERBY-4135</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12403803" name="derby-4122-1a-incorrect_stream_positioning.diff" size="824" author="kristwaa" created="Fri, 27 Mar 2009 13:50:07 +0000"/>
                            <attachment id="12403804" name="derby-4122-2a-bc4btest.diff" size="792" author="kristwaa" created="Fri, 27 Mar 2009 13:50:07 +0000"/>
                            <attachment id="12403823" name="derby-4122-3a-classcast_fix.diff" size="9403" author="kristwaa" created="Fri, 27 Mar 2009 17:14:56 +0000"/>
                            <attachment id="12404147" name="derby-4122-3b-classcast_fix.diff" size="10687" author="kristwaa" created="Mon, 30 Mar 2009 16:24:16 +0100"/>
                            <attachment id="12404350" name="derby-4122-4a-classcast_fix_mark_reset.diff" size="17197" author="kristwaa" created="Wed, 1 Apr 2009 18:07:18 +0100"/>
                            <attachment id="12404652" name="derby-4122-4b-classcast_fix_mark_reset.diff" size="40109" author="kristwaa" created="Sat, 4 Apr 2009 18:37:43 +0100"/>
                            <attachment id="12404737" name="derby-4122-4c-classcast_fix_mark_reset.diff" size="40782" author="kristwaa" created="Mon, 6 Apr 2009 16:27:02 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 26 Mar 2009 21:50:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24039</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0sfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38423</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10050"><![CDATA[Blocker]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>