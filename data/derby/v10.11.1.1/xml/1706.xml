<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:18:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1706/DERBY-1706.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1706] NullPointerException occurs when trying to create a table in schema SESSION</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1706</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;NPE occurs when attempting to create a table in schema session:&lt;/p&gt;

&lt;p&gt;ij version 10.2&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:wombat;create=true&apos; user &apos;user1&apos;;&lt;br/&gt;
WARNING 01J14: SQL authorization is being used without first enabling authentica&lt;br/&gt;
tion.&lt;br/&gt;
ij&amp;gt; set schema session;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table t1 (i int);&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;/p&gt;

&lt;p&gt;derby.log:&lt;br/&gt;
----------------------------------------------------------------&lt;br/&gt;
2006-08-16 20:49:02.765 GMT:&lt;br/&gt;
 Booting Derby version The Apache Software Foundation - Apache Derby - 10.2.1.0 beta - (430903): instance c013800d-010d-18be-88cf-00000013f010&lt;br/&gt;
on database directory C:\work3\derby\tests\derby-10.2.1.0\lib\wombat  &lt;/p&gt;

&lt;p&gt;Database Class Loader started - derby.database.classpath=&apos;&apos;&lt;br/&gt;
2006-08-16 20:49:17.312 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 122), (SESSIONID = 0), (DATABASE = wombat), (DRDAID = null), Cleanup action starting&lt;br/&gt;
2006-08-16 20:49:17.312 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 122), (SESSIONID = 0), (DATABASE = wombat), (DRDAID = null), Failed Statement is: create table t1 (i int)&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.QueryTreeNode.getSchemaDescriptor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.DDLStatementNode.getSchemaDescriptor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.DDLStatementNode.getSchemaDescriptor(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.CreateTableNode.referencesSessionSchema(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.referencesSessionSchema(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepMinion(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericStatement.prepare(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.executeImmediate(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.doCatch(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.go(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.go(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.mainCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main14.main(Unknown Source)&lt;br/&gt;
	at org.apache.derby.tools.ij.main(Unknown Source)&lt;br/&gt;
Cleanup action completed&lt;/p&gt;

&lt;p&gt;2006-08-16 20:49:55.312 GMT:&lt;br/&gt;
Shutting down instance c013800d-010d-18be-88cf-00000013f010&lt;br/&gt;
----------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;sysinfo:&lt;/p&gt;

&lt;p&gt;------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.4.2_12&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
Java home:       C:\Program Files\Java\j2re1.4.2_12&lt;br/&gt;
Java classpath:  derby.jar;derbytools.jar;.&lt;br/&gt;
OS name:         Windows XP&lt;br/&gt;
OS architecture: x86&lt;br/&gt;
OS version:      5.1&lt;br/&gt;
Java user name:  Yip&lt;br/&gt;
Java user home:  C:\Documents and Settings\Yip&lt;br/&gt;
Java user dir:   C:\work3\derby\tests\derby-10.2.1.0\lib&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.4&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: J2SE 1.4.2 - JDBC 3.0&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;C:\work3\derby\tests\derby-10.2.1.0\lib\derby.jar&amp;#93;&lt;/span&gt; 10.2.1.0 beta - (430903)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;C:\work3\derby\tests\derby-10.2.1.0\lib\derbytools.jar&amp;#93;&lt;/span&gt; 10.2.1.0 beta - (430903&lt;br/&gt;
)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Locale Information -----------------&lt;br/&gt;
Current Locale :  [English/United States &lt;span class=&quot;error&quot;&gt;&amp;#91;en_US&amp;#93;&lt;/span&gt;]&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;de_DE&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;es&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;fr&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;it&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;ja_JP&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;ko_KR&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;pt_BR&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;zh_CN&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;zh_TW&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.2.1.0 - (430903)&lt;br/&gt;
------------------------------------------------------&lt;/p&gt;</description>
                <environment>Sun JDK 1.4.2</environment>
        <key id="12348098">DERBY-1706</key>
            <summary>NullPointerException occurs when trying to create a table in schema SESSION</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="yipng">Yip Ng</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Aug 2006 21:57:54 +0100</created>
                <updated>Fri, 22 Sep 2006 20:06:31 +0100</updated>
                            <resolved>Fri, 22 Sep 2006 20:06:31 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12434775" author="mamtas" created="Thu, 14 Sep 2006 20:04:16 +0100"  >&lt;p&gt;I have attached a patch(DERBY1706NPEwithSessionSchemaV1diff.txt) to this Jira entry to fix the null pointer exception problem. But before going into the details of the patch, I want to provide some background information about SESSION schema and global temporary tables.&lt;/p&gt;

&lt;p&gt;SESSION schema is a special schema which is used for global temporary tables. In order to handle global temporary table, Derby creates a in-memory SESSION schema descriptor which does not have any uuid associated with it. A physical SESSION schema(with it&apos;s uuid set properly) will be created &lt;b&gt;only&lt;/b&gt; if there is a persistent object created in it by a user. Global temporary tables can only reside in SESSION schema and Derby documentation recommends that SESSION schema should not be used for other persistent objects. This is because the same object name could be referencing different objects within SESSION schema depending on in what order they got created.&lt;br/&gt;
For instance&lt;br/&gt;
create table session.t1(c11 int);&lt;br/&gt;
&amp;#8211; the following select will get data from the persistent table t1 in SESSION schema&lt;br/&gt;
select * from session.t1;&lt;br/&gt;
declare global temporary table session.t1(c11 int, c12 int) on commit delete rows not logged;&lt;br/&gt;
&amp;#8211; the following select this time will return data from the temporary table t1 rather than persistent table t1&lt;br/&gt;
&amp;#8211; This is because, at any time, if there is a global temporary table by the table referenced by a statement,&lt;br/&gt;
&amp;#8211; then Derby will always pick up the global temporary table. If no global temporary table by that name is&lt;br/&gt;
&amp;#8211; found, then Derby will look for persistent table in SESSION schema. If none found, then error will be thrown&lt;br/&gt;
select * from session.t1;&lt;br/&gt;
&amp;#8211; following will drop the temporary table t1 and not the persistent table t1&lt;br/&gt;
drop table session.t1;&lt;br/&gt;
&amp;#8211; the following select will get data from the persistent table t1 in SESSION schema because temporary table&lt;br/&gt;
&amp;#8211; doesn&apos;t exist anymore&lt;br/&gt;
select * from session.t1;&lt;/p&gt;

&lt;p&gt;So, as can be seen from the example above, the statements referencing SESSION schema objects could have different meanings depending on what kind of objects exist in SESSION schema. Because of this, the compiled plans of statements referencing SESSION schema are not saved in the statement cache, rather they get compiled everytime they are executed. In order to enforce this, in the compilation phase, Derby checks if the statement at hand is referencing a SESSION schema object by calling referencesSessionSchema method. If this method returns true, the statement&apos;s compiled plan will not be saved in the statement cache. &lt;/p&gt;

&lt;p&gt;Now, taking the script provided by Yip which results in NPE&lt;br/&gt;
set schema session; &lt;br/&gt;
create table t1 (i int); &lt;/p&gt;

&lt;p&gt;Derby calls referencesSessionSchema while compiling &quot;create table t1 (i int); &quot; to see if it references SESSION schema object. Since, there is no schema associated with the table t1, Derby will check for the compilation schema which in this case is SESSION schema because we used &quot;set schema session; &quot;. (This happens in QueryTreeNode.getSchemaDescriptor(String schemaName, boolean raiseError) line 1486). The method&lt;br/&gt;
then tries to call an equal method on the UUID associated with the SESSION schema descriptor but since it is null(because no physical SESSION schema has been created yet), we end up with a null pointer exception. This will happen only if no physical SESSION schema has been created yet and user tries to create a first persistent object inside SESSION schema after doing a set schema session.&lt;/p&gt;

&lt;p&gt;Following will not give a NPE because user hand created SESSION schema before doing set schema SESSION and creating an object inside it.&lt;br/&gt;
create schema session;&lt;br/&gt;
set schema session; &lt;br/&gt;
create table t1 (i int); &lt;br/&gt;
The hand creation of SESSION schema causes Derby to have a schema descriptor for SESSION schema with it&apos;s uuid set correctly.&lt;/p&gt;

&lt;p&gt;The fix for the NPE is simple and that is to check if the UUID is null. I have added test to existing lang/declareGlobalTempTableJava and ran derbyall on Windows XP with Sun jdk 1.4 and everything ran fine.&lt;/p&gt;

&lt;p&gt;The svn stat -q o/p is as follows&lt;br/&gt;
M      java\engine\org\apache\derby\impl\sql\compile\QueryTreeNode.java&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\tests\lang\declareGlobalTempTableJava.java&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\master\declareGlobalTempTableJava.out&lt;/p&gt;

&lt;p&gt;Please let me know if anyone has any comments.&lt;/p&gt;</comment>
                            <comment id="12434802" author="mamtas" created="Thu, 14 Sep 2006 21:46:16 +0100"  >&lt;p&gt;I realized that I didn&apos;t change some of the println in the test case that I added and hence attaching a new patch DERBY1706NPEwithSessionSchemaV2diff.txt. Please diregard the earlier patch DERBY1706NPEwithSessionSchemaV1diff.txt. &lt;/p&gt;

&lt;p&gt;The engine changes are exactly the same in the 2 patches. The only thing that changed is comment and a println in lang/declareGlobalTempTableJava.java test &lt;/p&gt;</comment>
                            <comment id="12434833" author="yipng" created="Thu, 14 Sep 2006 23:13:31 +0100"  >&lt;p&gt;Thanks for the additonal background information, Mamta.  I have tried the second patch DERBY1706NPEwithSessionSchemaV2diff.txt and the NPE no longer exists.  &lt;/p&gt;

&lt;p&gt;Perhaps a comment is useful here for explaining why sdCatalog&apos;s UUID can be null in certain cases.&lt;/p&gt;

&lt;p&gt;if (sdCatalog != null &amp;amp;&amp;amp; sdCatalog.getUUID() != null)&lt;br/&gt;
...&lt;/p&gt;


&lt;p&gt;Otherwise, the patch looks good to me.  +1 &lt;/p&gt;</comment>
                            <comment id="12434974" author="mamtas" created="Fri, 15 Sep 2006 14:25:47 +0100"  >&lt;p&gt;Yip, thanks for doing the code review. Here is the patch DERBY1706NPEwithSessionSchemaV3diff.txt with comments in the code.&lt;/p&gt;</comment>
                            <comment id="12435075" author="tsuresh" created="Fri, 15 Sep 2006 19:25:17 +0100"  >&lt;p&gt;Hi Mamta, &lt;/p&gt;

&lt;p&gt;just a general question:&lt;/p&gt;

&lt;p&gt;Why is it necessary to allow users to create a non-temporary tables in the &quot;session&quot; schema , when the schema is not created explicitly ?&lt;/p&gt;


&lt;p&gt;Thanks&lt;br/&gt;
-suresh&lt;/p&gt;</comment>
                            <comment id="12435381" author="mikem" created="Mon, 18 Sep 2006 04:24:14 +0100"  >&lt;p&gt;ran full set of successful tests against ibm 1.4.2 except for &quot;expected/intermittent&quot; unrelated test failures.  Thank you Yip for review of changes.  Committed to trunk and change should be put into 10.2.&lt;/p&gt;

&lt;p&gt;m3_ibm142:36&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\sql\compile\QueryTreeNode.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\declareGlobalTempTableJava.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\declareGlobalTempTableJava.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 447212.&lt;/p&gt;</comment>
                            <comment id="12435704" author="mamtas" created="Tue, 19 Sep 2006 07:52:45 +0100"  >&lt;p&gt;Suresh, to answer your question &quot;Why is it necessary to allow users to create a non-temporary tables in the &quot;session&quot; schema , when the schema is not created explicitly ? &quot;&lt;/p&gt;

&lt;p&gt;I think it may have to do with the usability.&lt;/p&gt;

&lt;p&gt;Let me take the following generic eg &lt;br/&gt;
connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta1&apos; as mamta1;&lt;br/&gt;
select * from sys.syschemas; &amp;#8211; this will not show &lt;b&gt;mamta1&lt;/b&gt; as one of the schemas&lt;br/&gt;
create table t1(c11 int); &amp;#8211; the creation of first user-defined object will implicitly create the schema &lt;b&gt;mamta1&lt;/b&gt;&lt;br/&gt;
select * from sys.syschemas; &amp;#8211; this will &lt;b&gt;now&lt;/b&gt; show &lt;b&gt;mamta1&lt;/b&gt; as one of the schemas&lt;/p&gt;

&lt;p&gt;I think to avoid the confusion with the usability in case of temporary table and non-temporary tables, Derby chose to provide the same behavior for the 2 table types in &quot;session&quot; schema ie you can create either of the table types in &quot;session&quot; schema w/o first having to manually create the &quot;session&quot; schema. This behavior also matches the generic eg given above&lt;br/&gt;
So, extending the eg above for session schema to show Derby&apos;s current behavior&lt;br/&gt;
connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta1&apos; as mamta1;&lt;br/&gt;
select * from sys.syschemas; &amp;#8211; this will not show &lt;b&gt;session&lt;/b&gt; schema as one of the schemas&lt;br/&gt;
set schema session;&lt;br/&gt;
select * from sys.syschemas; &amp;#8211; still will not show &lt;b&gt;session&lt;/b&gt; schema as one of the schemas&lt;br/&gt;
create table t1(c11 int); &amp;#8211; the creation of first user-defined table will implicitly create the schema &lt;b&gt;session&lt;/b&gt;&lt;br/&gt;
select * from sys.syschemas; &amp;#8211; this will &lt;b&gt;now&lt;/b&gt; show &lt;b&gt;session&lt;/b&gt; as one of the schemas&lt;/p&gt;</comment>
                            <comment id="12435863" author="rhillegas" created="Tue, 19 Sep 2006 16:16:03 +0100"  >&lt;p&gt;Moving to 10.2.2.0.&lt;/p&gt;</comment>
                            <comment id="12436978" author="mamtas" created="Fri, 22 Sep 2006 20:06:30 +0100"  >&lt;p&gt;The fix also got merged into 10.2 with revision 448961.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12340862" name="DERBY1706NPEwithSessionSchemaV1diff.txt" size="3607" author="mamtas" created="Thu, 14 Sep 2006 20:04:16 +0100"/>
                            <attachment id="12340877" name="DERBY1706NPEwithSessionSchemaV2diff.txt" size="3629" author="mamtas" created="Thu, 14 Sep 2006 21:46:16 +0100"/>
                            <attachment id="12340920" name="DERBY1706NPEwithSessionSchemaV3diff.txt" size="3936" author="mamtas" created="Fri, 15 Sep 2006 14:25:47 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 14 Sep 2006 19:04:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22652</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy14if:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40381</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>