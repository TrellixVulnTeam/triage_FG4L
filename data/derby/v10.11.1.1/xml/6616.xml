<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:44:57 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6616/DERBY-6616.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6616] User procedures can call system procedures, circumventing SQL authorization.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6616</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;System procedures are implemented as public static methods in org.apache.derby.catalog.SystemProcedures. These methods can be called by code in user-written procedures. This allows a user-written procedure to circumvent the SQL authorization checks which are supposed to limit some procedures to being called only by the DBO. I will attach a repro.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12721680">DERBY-6616</key>
            <summary>User procedures can call system procedures, circumventing SQL authorization.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jun 2014 14:32:57 +0100</created>
                <updated>Thu, 10 Jul 2014 17:54:13 +0100</updated>
                            <resolved>Thu, 10 Jul 2014 17:54:13 +0100</resolved>
                                    <version>10.11.1.1</version>
                                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14033780" author="rhillegas" created="Tue, 17 Jun 2014 14:36:29 +0100"  >&lt;p&gt;Attaching SystemProcWrapper.java, which contains a procedure wrapping SYSCS_UTIL.SYSCS_EXPORT_TABLE. The following script shows how to use this procedure to circumvent SQL authorization checks on the system procedure:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;connect &apos;jdbc:derby:memory:db1;create=true;user=test_dbo&apos;;

call syscs_util.syscs_create_user( &apos;TEST_DBO&apos;, &apos;test_dbopassword&apos; );
call syscs_util.syscs_create_user( &apos;RUTH&apos;, &apos;ruthpassword&apos; );

-- shutdown in order to enable NATIVE authentication
connect &apos;jdbc:derby:memory:db1;shutdown=true&apos;;

connect &apos;jdbc:derby:memory:db1;user=test_dbo;password=test_dbopassword&apos; as dbo;

create table t( a int );
insert into t values ( 1 );

grant select on t to public;

connect &apos;jdbc:derby:memory:db1;user=ruth;password=ruthpassword&apos; as ruth;

-- ruth can&apos;t execute this procedure directly
call syscs_util.syscs_export_table( &apos;TEST_DBO&apos;, &apos;T&apos;, &apos;z.dat&apos;, null, null, null );

create procedure wrapSYSCS_EXPORT_TABLE
(
    in schemaname  varchar(128),
    in tablename varchar(128),
    in filename varchar(32672),
    in columndelimiter char(1),
    in characterdelimiter char(1),
    in codeset varchar(128)
)
language java parameter style java reads sql data
external name &apos;SystemProcWrapper.wrapSYSCS_EXPORT_TABLE&apos;;

-- but she can execute this wrapper procedure
call wrapSYSCS_EXPORT_TABLE( &apos;TEST_DBO&apos;, &apos;T&apos;, &apos;z.dat&apos;, null, null, null );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14054131" author="rhillegas" created="Mon, 7 Jul 2014 21:01:19 +0100"  >&lt;p&gt;Attaching a candidate patch for this issue. Needs to be tested and debugged before I describe it.&lt;/p&gt;</comment>
                            <comment id="14056400" author="rhillegas" created="Wed, 9 Jul 2014 17:06:51 +0100"  >&lt;p&gt;Tests passed cleanly for me on derby-6616-01-ad-reauthorize.diff. Let me describe the approach:&lt;/p&gt;


&lt;p&gt;1) I abstracted out the logic in GenericAuthorizer which we run when we check SQL authorization at execution time. This is the logic which computes the closure of the privileges granted to your current role and then checks that the closure contains all of the privileges on a list. For the normal execution path, that list is constructed when your SQL statement is compiled.&lt;/p&gt;

&lt;p&gt;2) I added an authorize() method to SecurityUtil which lets us check at any time whether the current session enjoys EXECUTE privilege on a system routine. Basically, the method cooks up a list with one EXECUTE permission on it and then calls the method which was exposed by the work in step (1).&lt;/p&gt;

&lt;p&gt;3) Then I peppered the engine with calls to SecurityUtil.authorize(). Many of these calls are in SystemProcedures itself, the class which contains the public entry points for the Derby system routines. However, it turns out that SystemProcedures often calls other public entry points, which may call further public entry points, and so on. In those cases, I have tried to push the call to SecurityUtil.authorize() as far down as possible.&lt;/p&gt;

&lt;p&gt;4) However, I have avoided pushing down the call to SecurityUtil.authorize() in cases where I thought that it might affect the performance of the main execution path. This means that there are still unprotected public entry points on internal objects like LanguageConnectionContext, DataDictionary, and TransactionController. I think that this exposure needs to be addressed by a solution to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6648&quot; title=&quot;Application code should not be able to call ContextService.getContextOrNull()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6648&quot;&gt;&lt;del&gt;DERBY-6648&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-------------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/conn/Authorizer.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/conn/GenericAuthorizer.java&lt;/p&gt;

&lt;p&gt;Changes for (1).&lt;/p&gt;

&lt;p&gt;-------------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/security/SecurityUtil.java&lt;br/&gt;
A       java/engine/org/apache/derby/iapi/security/Securable.java&lt;/p&gt;

&lt;p&gt;Changes for (2).&lt;/p&gt;

&lt;p&gt;-------------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/db/PropertyInfo.java&lt;br/&gt;
M       java/engine/org/apache/derby/iapi/db/ConsistencyChecker.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/load/Import.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/load/Export.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/execute/JarUtil.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/store/access/RAMAccessManager.java&lt;br/&gt;
M       java/engine/org/apache/derby/catalog/SystemProcedures.java&lt;/p&gt;

&lt;p&gt;Changes for (3).&lt;/p&gt;

&lt;p&gt;-------------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/DBOAccessTest.java&lt;/p&gt;

&lt;p&gt;Tests.&lt;/p&gt;</comment>
                            <comment id="14057661" author="jira-bot" created="Thu, 10 Jul 2014 17:50:35 +0100"  >&lt;p&gt;Commit 1609501 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1609501&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1609501&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6616&quot; title=&quot;User procedures can call system procedures, circumventing SQL authorization.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6616&quot;&gt;&lt;del&gt;DERBY-6616&lt;/del&gt;&lt;/a&gt;: Prevent applications from bypassing SQL authorization by directly calling system procedure entry points; commit derby-6616-01-ad-reauthorize.diff.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12724997">DERBY-6646</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12725352">DERBY-6648</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12650799" name="SystemProcWrapper.java" size="685" author="rhillegas" created="Tue, 17 Jun 2014 14:36:29 +0100"/>
                            <attachment id="12654369" name="derby-6616-01-ad-reauthorize.diff" size="64525" author="rhillegas" created="Mon, 7 Jul 2014 21:01:19 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 10 Jul 2014 16:50:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399876</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzqozj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399984</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>