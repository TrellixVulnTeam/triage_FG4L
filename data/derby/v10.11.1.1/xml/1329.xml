<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:40:39 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1329/DERBY-1329.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1329] ASSERT failure/IndexOutOfBoundsException with correlated subquery for UPDATE ... SET ... WHERE CURRENT OF ... statement.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1329</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If in a statement of the form &quot;UPDATE ... SET ... WHERE CURRENT OF ...&quot; the SET clause includes a correlated subquery that has a predicate referencing the table that is being updated, Derby will fail with an ASSERT failure in sane mode and an IndexOutOfBounds exception in insane mode.&lt;/p&gt;

&lt;p&gt;For example, if we have a cursor CUR1 for the results of a SELECT query on BASICTABLE1, and then we try to execute the following update statement:&lt;/p&gt;

&lt;p&gt;update BASICTABLE1 set C3 = (SELECT CC3 FROM&lt;br/&gt;
  BASICTABLE2 WHERE BASICTABLE1.ID=BASICTABLE2.IID) &lt;br/&gt;
where current of CUR1&lt;/p&gt;

&lt;p&gt;the result in SANE mode will be:&lt;/p&gt;

&lt;p&gt;org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED tableNumber is expected to be non-negative.&lt;/p&gt;

&lt;p&gt;and in INSANE mode will be:&lt;/p&gt;

&lt;p&gt;java.lang.IndexOutOfBoundsException: bitIndex &amp;lt; 0: -1&lt;/p&gt;

&lt;p&gt;The failure occurs during preprocessing of the subquery node when Derby is trying to &quot;categorize&quot; a predicate to see if it is pushable.  The exact code is in ColumnReference.categorize():&lt;/p&gt;

&lt;p&gt;  public boolean categorize(JBitSet referencedTabs, boolean simplePredsOnly)&lt;/p&gt;
  {
    if (SanityManager.DEBUG)
      SanityManager.ASSERT(tableNumber &amp;gt;= 0,
         &quot;tableNumber is expected to be non-negative&quot;);
    referencedTabs.set(tableNumber);

    return ( ! replacesAggregate ) &amp;amp;&amp;amp;
        ( (source.getExpression() instanceof ColumnReference) ||
        (source.getExpression() instanceof VirtualColumnNode) ||
        (source.getExpression() instanceof ConstantNode));
  }

&lt;p&gt;We get to this code for a ColumnReference who&apos;s tableNumber is -1, which means that, in sane mode, the assert will fire; in insane mode, we&apos;ll call &quot;referencedTabs.set()&quot; passing in a -1, which leads to the IndexOutOfBoundsException.&lt;/p&gt;

&lt;p&gt;This failure occurs in embedded and with both clients, and occurs in 10.0, 10.1, and the 10.2 trunk.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12343128">DERBY-1329</key>
            <summary>ASSERT failure/IndexOutOfBoundsException with correlated subquery for UPDATE ... SET ... WHERE CURRENT OF ... statement.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 May 2006 02:17:42 +0100</created>
                <updated>Fri, 9 Jun 2006 04:57:10 +0100</updated>
                            <resolved>Fri, 9 Jun 2006 04:56:59 +0100</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.1.3.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12412029" author="army" created="Wed, 17 May 2006 02:24:35 +0100"  >&lt;p&gt;Attaching a simple repro program for this issue.  Default is to run against the Derby Client, so you&apos;ll have to start the server on 1527 first.  &lt;/p&gt;

&lt;p&gt;&amp;gt; java d1329&lt;/p&gt;

&lt;p&gt;To run against embedded:&lt;/p&gt;

&lt;p&gt;&amp;gt; java d1329 embedded&lt;/p&gt;

&lt;p&gt;To run against JCC, start server on 1527 then:&lt;/p&gt;

&lt;p&gt;&amp;gt; java d1329 jcc&lt;/p&gt;</comment>
                            <comment id="12412032" author="army" created="Wed, 17 May 2006 03:05:12 +0100"  >&lt;p&gt;Just a note that it&apos;s also possible to reproduce this error using ij.  The following ij commands do the same thing as the attached Java program:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:testDB;create=true&apos;;&lt;br/&gt;
CREATE TABLE BASICTABLE1(ID INTEGER, C3 CHAR(10));&lt;br/&gt;
CREATE TABLE BASICTABLE2(IID INTEGER, CC3 CHAR(10));&lt;br/&gt;
insert into BASICTABLE1 (C3, ID) values (&apos;abc&apos;, 1);&lt;br/&gt;
insert into BASICTABLE2 (CC3, IID) values (&apos;def&apos;, 1);&lt;br/&gt;
autocommit off;&lt;br/&gt;
get cursor c1 as &apos;select c3, id from basictable1 for update&apos;;&lt;br/&gt;
next c1;&lt;br/&gt;
update BASICTABLE1 set C3 = (SELECT CC3 FROM BASICTABLE2 WHERE BASICTABLE1.ID=BASICTABLE2.IID) where current of c1;&lt;/p&gt;

&lt;p&gt;leads to:&lt;/p&gt;

&lt;p&gt;ERROR XJ001: Java exception: &apos;ASSERT FAILED tableNumber is expected to be non-negative: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;/p&gt;</comment>
                            <comment id="12413264" author="army" created="Thu, 25 May 2006 23:25:10 +0100"  >&lt;p&gt;Attaching a patch to address this issue.  In a word, the problem is that the ColumnReference in a CurrentOfNode can, in certain situations, end up with a tableNumber that is never set, and hence it defaults to &lt;del&gt;1.  The fix I&apos;ve made ensures that the ColumnReference&apos;s tableNumber will always be set when necessary&lt;/del&gt;-i.e. when we&apos;ve found the ResultColumn that matches the received ColumnReference.  I think this is the correct fix for two reasons:&lt;/p&gt;

&lt;p&gt;1) In FromList.bindColumnReferences(), there is the following comment:&lt;/p&gt;

&lt;p&gt;  /* TableNumbers are set in the CR in the underlying&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FromTable.  This ensures that they get the table&lt;/li&gt;
	&lt;li&gt;number from the underlying table, not the join node.&lt;/li&gt;
	&lt;li&gt;This is important for beging able to push predicates&lt;/li&gt;
	&lt;li&gt;down through join nodes.&lt;br/&gt;
   */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The place where &quot;TableNumbers are set&quot; is in the getMatchingColumn() call, which means that the underlying FromTable (which includes CurrentOfNode) is responsible for setting the table number.&lt;/p&gt;

&lt;p&gt;2) Inspection of all other FromTables that implement getMatchingColumn() shows that they all set the ColumnReference&apos;s table number if the corresponding ResultColumn is found.  The one exception is JoinNode, but the getMatchingColumn() method in JoinNode in turn calls the method of the same name on the join&apos;s left and right nodes, so we know that, eventually, the ColumnReference&apos;s tableNumber will get set by one of the other FromTable&apos;s getMatchingColumn() calls.  So the only FromTable that does not set the tableNumber is CurrentOfNode, and that&apos;s the reason for the failure described in this issue.&lt;/p&gt;

&lt;p&gt;The change seems fairly minor but if anyone has a chance to double-check it, that&apos;d be great.  I also added a test case (using the repro posted in the above comments) to lang/update.sql.&lt;/p&gt;

&lt;p&gt;I ran derbyall on Linux Red Hat (RHEL4) using ibm142 and saw no new failures.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Army&lt;/p&gt;</comment>
                            <comment id="12414557" author="bandaram" created="Sat, 3 Jun 2006 15:12:15 +0100"  >&lt;p&gt;Submitted this patch to trunk. If you have interest in putting this patch into 10.1.3, please post a 10.1 patch. Looks like this change will not apply directly to 10.1 as fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-171&quot; title=&quot;Need Correlation ID in UPDATE/DELETE statements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-171&quot;&gt;&lt;del&gt;DERBY-171&lt;/del&gt;&lt;/a&gt; is not in 10.1.&lt;/p&gt;</comment>
                            <comment id="12414969" author="army" created="Tue, 6 Jun 2006 23:09:18 +0100"  >&lt;p&gt;Thanks for the commit, Satheesh.&lt;/p&gt;

&lt;p&gt;Attaching a 10.1 version of the patch (d1329_10_1.patch).  I ran derbyall against sane jars built  from the latest 10.1 codeline on Red Hat Linux and saw no new failures.  If anyone has the chance to commit, that&apos;d be great...&lt;/p&gt;</comment>
                            <comment id="12415406" author="bandaram" created="Fri, 9 Jun 2006 02:58:20 +0100"  >&lt;p&gt;Submitted this patch to 10.1 branch. Please resolve and/or close accordingly.&lt;/p&gt;</comment>
                            <comment id="12415426" author="army" created="Fri, 9 Jun 2006 04:56:59 +0100"  >&lt;p&gt;Checked into trunk with svn # 411393 and into 10.1 with svn # 412832.  I have verified the fix in both codelines by running the repro and by running the new test case in lang/update.sql, so I&apos;m resolving and closingt the issue.  Thank you for committing, Satheesh.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12334196" name="d1329.java" size="3105" author="army" created="Wed, 17 May 2006 02:24:35 +0100"/>
                            <attachment id="12334566" name="d1329.patch" size="4826" author="army" created="Thu, 25 May 2006 23:25:10 +0100"/>
                            <attachment id="12335087" name="d1329_10_1.patch" size="4465" author="army" created="Tue, 6 Jun 2006 23:09:18 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 3 Jun 2006 14:12:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22441</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy1673:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>