<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:12:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6565/DERBY-6565.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6565] ROW_NUMBER function throws NullPointerException in UPDATE statement</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6565</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A NullPointerException is raised with this (possibly illegal?) UPDATE statement:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij version 10.10
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=true&apos;;
ij&amp;gt; create table t(x int);
0 rows inserted/updated/deleted
ij&amp;gt; insert into t values 1;
1 row inserted/updated/deleted
ij&amp;gt; update t set x = row_number() over ();
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12712555">DERBY-6565</key>
            <summary>ROW_NUMBER function throws NullPointerException in UPDATE statement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 May 2014 12:27:56 +0100</created>
                <updated>Fri, 10 Oct 2014 19:22:22 +0100</updated>
                            <resolved>Fri, 10 Oct 2014 19:22:22 +0100</resolved>
                                    <version>10.10.2.0</version>
                                    <fixVersion>10.10.2.1</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                    <fixVersion>10.12.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13990563" author="knutanders" created="Tue, 6 May 2014 12:54:31 +0100"  >&lt;p&gt;Here&apos;s what the stack trace looks like on trunk:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException
	at org.apache.derby.impl.sql.execute.UpdateResultSet.collectAffectedRows(UpdateResultSet.java:587)
	at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSet.java:260)
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:470)
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:349)
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1338)
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:704)
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:631)
	at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:367)
	at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:527)
	at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:369)
	at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:245)
	at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)
	at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)
	at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)
	at org.apache.derby.tools.ij.main(ij.java:59)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14085574" author="dagw" created="Tue, 5 Aug 2014 01:39:40 +0100"  >&lt;p&gt;I have looked at this issue, and it seems that the problem is that the rewrite of the ROW_LOCATION function in the query optimization phase of the SELECT node into a ProjectRestrictNode just isn&apos;t prepared for being part of an UPDATE statement. So, it is a mini-project to implement ROW_LOCATION for UPDATE: a) Modify the query tree re-write in the optimization phase to handle the simultaneous presence of UPDATE and ROW LOCATION, b) modify the code generation, and c) possibly some changes to the run-time result sets to accommodate that an update result set may also contain a WindowResultSet.&lt;/p&gt;</comment>
                            <comment id="14085706" author="dagw" created="Tue, 5 Aug 2014 03:55:44 +0100"  >&lt;p&gt;Here is a single line patch that makes the repro work. I am not sure if this change is sound, or we need more. If it is, it seems we are lucky and we can marry the windowing rather easily into the update. Reminder to self: any new tests should also include the new MERGE statement.  &lt;font color=&quot;green&quot;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Update: See DERBY-6688 and DERBY-6689.&amp;#93;&lt;/span&gt;&lt;/font&gt; The change only affects task a) mentioned.&lt;/p&gt;</comment>
                            <comment id="14085714" author="dagw" created="Tue, 5 Aug 2014 04:01:31 +0100"  >&lt;p&gt;The following now works:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;create table t(x &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt;);
s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert into t values -1,-2&quot;&lt;/span&gt;);
s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;update t set x = x - (row_number() over () * 2)&quot;&lt;/span&gt;);
BaseJDBCTestCase.dumpRs(s.executeQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from t&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;giving&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
         X
         -
        {-3}
        {-6}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14085720" author="dagw" created="Tue, 5 Aug 2014 04:03:16 +0100"  >&lt;p&gt;The existing OLAPTest passes with the patch, so at least the patch doesn&apos;t upset any &lt;b&gt;known&lt;/b&gt; usage of ROW_NUMBER.&lt;/p&gt;</comment>
                            <comment id="14085929" author="knutanders" created="Tue, 5 Aug 2014 08:31:34 +0100"  >&lt;p&gt;SQL 2011, part 2, 6.10 &amp;lt;window function&amp;gt;, syntax rule 4 seems to indicate that a window function can only appear in an &amp;lt;order by clause&amp;gt; or a &amp;lt;select list&amp;gt;. If so, we can probably fix it by making UpdateNode raise a StandardException at bind time.&lt;/p&gt;</comment>
                            <comment id="14086347" author="dagw" created="Tue, 5 Aug 2014 16:05:53 +0100"  >&lt;p&gt;Ah, well then. We&apos;d better stay with the standard, so I&apos;ll make a patch to make it illegal.&lt;/p&gt;</comment>
                            <comment id="14086526" author="dagw" created="Tue, 5 Aug 2014 18:41:59 +0100"  >&lt;p&gt;Uploading &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12659918/12659918_derby-6565-forbid.diff&quot; title=&quot;derby-6565-forbid.diff attached to DERBY-6565&quot;&gt;derby-6565-forbid.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which makes it illegal to use window functions in the update source. Adds a new test for this error condition.&lt;/p&gt;

&lt;p&gt;Running regressions &lt;font color=&quot;green&quot;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Update: regressions passed&amp;#93;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="14086633" author="jira-bot" created="Tue, 5 Aug 2014 20:22:05 +0100"  >&lt;p&gt;Commit 1615982 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dagw&quot; class=&quot;user-hover&quot; rel=&quot;dagw&quot;&gt;Dag H. Wanvik&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1615982&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1615982&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6565&quot; title=&quot;ROW_NUMBER function throws NullPointerException in UPDATE statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6565&quot;&gt;&lt;del&gt;DERBY-6565&lt;/del&gt;&lt;/a&gt; ROW_NUMBER function throws NullPointerException in UPDATE statement&lt;/p&gt;

&lt;p&gt;Patch &lt;b&gt;derby-6565-forbid.diff&lt;/b&gt; which makes it illegal to use window&lt;br/&gt;
functions in the update source. Adds a new test for this error&lt;br/&gt;
condition. Also cleans up some Javadocs and modernizes some loops.&lt;/p&gt;</comment>
                            <comment id="14087371" author="knutanders" created="Wed, 6 Aug 2014 08:26:08 +0100"  >&lt;p&gt;Thanks for fixing this bug, Dag. You mentioned that we should test the MERGE statement too. I didn&apos;t see a test for that, so I ran one manually. Your patch indeed fixes the UPDATE clause of the merge statement:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; merge into t1 using t2 on (t1.x=t2.x) when matched then update set x = row_number() over ();
ERROR 42ZC2: Window function is illegal in this context: &apos;&amp;lt;update source&amp;gt;&apos; clause
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, there seems to be a problem with the INSERT clause of the MERGE statement. I&apos;ve filed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6689&quot; title=&quot;Assert failure/NPE when using ROW_NUMBER in MERGE ... INSERT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6689&quot;&gt;&lt;del&gt;DERBY-6689&lt;/del&gt;&lt;/a&gt;. (Ordinary INSERT statements don&apos;t seem to have this problem though.)&lt;/p&gt;</comment>
                            <comment id="14089355" author="jira-bot" created="Thu, 7 Aug 2014 16:45:32 +0100"  >&lt;p&gt;Commit 1616512 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dagw&quot; class=&quot;user-hover&quot; rel=&quot;dagw&quot;&gt;Dag H. Wanvik&lt;/a&gt; in branch &apos;code/branches/10.11&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1616512&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1616512&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6565&quot; title=&quot;ROW_NUMBER function throws NullPointerException in UPDATE statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6565&quot;&gt;&lt;del&gt;DERBY-6565&lt;/del&gt;&lt;/a&gt; ROW_NUMBER function throws NullPointerException in UPDATE statement&lt;/p&gt;

&lt;p&gt;Backported cleanly from trunk as:&lt;/p&gt;

&lt;p&gt;svn merge -c 1615982 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Patch derby-6565-forbid.diff which makes it illegal to use window&lt;br/&gt;
functions in the update source. Adds a new test for this error&lt;br/&gt;
condition. Also cleans up some Javadocs and modernizes some loops.&lt;/p&gt;</comment>
                            <comment id="14165445" author="myrna" created="Thu, 9 Oct 2014 19:02:51 +0100"  >&lt;p&gt;reopen for evaluation for backport to 10.10&lt;/p&gt;</comment>
                            <comment id="14165536" author="jira-bot" created="Thu, 9 Oct 2014 19:51:29 +0100"  >&lt;p&gt;Commit 1630553 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;Myrna van Lunteren&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1630553&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1630553&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6565&quot; title=&quot;ROW_NUMBER function throws NullPointerException in UPDATE statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6565&quot;&gt;&lt;del&gt;DERBY-6565&lt;/del&gt;&lt;/a&gt;; ROW_NUMBER function throws NullPointerException in UPDATE statement&lt;br/&gt;
   backport of revision 1616512 from 10.11 branch&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12746192">DERBY-6759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12732235">DERBY-6689</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12659918" name="derby-6565-forbid.diff" size="7683" author="dagw" created="Tue, 5 Aug 2014 18:41:59 +0100"/>
                            <attachment id="12659919" name="derby-6565-forbid.status" size="884" author="dagw" created="Tue, 5 Aug 2014 18:41:59 +0100"/>
                            <attachment id="12659802" name="derby-6565.diff" size="1090" author="dagw" created="Tue, 5 Aug 2014 03:55:44 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 5 Aug 2014 00:39:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390871</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzp6gf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391107</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>