<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:13:11 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4752/DERBY-4752.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4752] CheapDateFormatter returns incorrect and invalid date strings</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4752</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;CheapDateFormatter has multiple problems. These are the ones I&apos;m aware of:&lt;/p&gt;

&lt;p&gt;1) On the boundary between non-leap years and leap years it will return first day of thirteenth month in previous year (for instance, 2011-13-01 instead of 2012-01-01)&lt;/p&gt;

&lt;p&gt;2) It treats all years divisible by four as leap years. Those divisible by 100 and not by 400 are not leap years. It attempts to adjust for that (see the snippet below) but it always ends up setting leapYear=true if (year%4)==0.&lt;/p&gt;

&lt;p&gt;		// It&apos;s a leap year if divisible by 4, unless divisible by 100,&lt;br/&gt;
		// unless divisible by 400.&lt;br/&gt;
		if ((year % 4L) == 0) {&lt;br/&gt;
			if ((year % 100L) == 0) {&lt;br/&gt;
				if ((year % 400L) == 0) &lt;/p&gt;
{
					leapYear = true;
				}
&lt;p&gt;			}&lt;br/&gt;
			leapYear = true;&lt;br/&gt;
		}&lt;/p&gt;

&lt;p&gt;3) More leap year trouble. To find out which year it is, it calculates the number of four year periods that have elapsed since 1970-01-01. A four year period is considered 365*3+366 days. Although most four year periods are of that length, some are shorter, so we&apos;ll get one day off starting from year 2100, two days off from year 2200, and so on.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12469809">DERBY-4752</key>
            <summary>CheapDateFormatter returns incorrect and invalid date strings</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Jul 2010 12:42:58 +0100</created>
                <updated>Fri, 26 Aug 2011 16:29:10 +0100</updated>
                            <resolved>Wed, 25 Aug 2010 09:26:02 +0100</resolved>
                                    <version>10.7.1.1</version>
                                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12890707" author="knutanders" created="Wed, 21 Jul 2010 13:30:44 +0100"  >&lt;p&gt;Examples:&lt;/p&gt;

&lt;p&gt;Issue 1:&lt;/p&gt;

&lt;p&gt;CheapDateFormatter.formatDate(1325376000000L) returns &quot;2011-13-01 00:00:00.000 GMT&quot;, expected: &quot;2012-01-01 00:00:00.000 GMT&quot;&lt;/p&gt;

&lt;p&gt;The returned date is wrong and invalid because there is no month 13.&lt;/p&gt;

&lt;p&gt;Issue 2:&lt;/p&gt;

&lt;p&gt;CheapDateFormatter.formatDate(4114195200000L) returns &quot;2100-05-16 00:00:00.000 GMT&quot;, expected: &quot;2100-05-17 00:00:00.000 GMT&quot;&lt;/p&gt;

&lt;p&gt;The returned date is one day off.&lt;/p&gt;

&lt;p&gt;Issue 3:&lt;/p&gt;

&lt;p&gt;CheapDateFormatter.formatDate(4107542400000L) returns &quot;2100-02-29 00:00:00.000 GMT&quot;, expected &quot;2100-03-01 00:00:00.000 GMT&quot;&lt;/p&gt;

&lt;p&gt;The returned date is invalid because there is no February 29 in the year 2100.&lt;/p&gt;</comment>
                            <comment id="12890803" author="knutanders" created="Wed, 21 Jul 2010 19:14:21 +0100"  >&lt;p&gt;Instead of trying to fix the algorithm, I think it would be better to rely on java.util.Calendar to do these calculations for us. That would require allocating a Calendar object each time the method is called (in addition to all the String objects the method already allocates), but it won&apos;t instantiate any ResourceBundles or Locales, which was the reason why CheapDateFormatter was written in the first place, according to the comments. I haven&apos;t found that CheapDateFormatter is used in any performance critical section of the code, so I&apos;m not sure if that&apos;s much of a concern in any case.&lt;/p&gt;</comment>
                            <comment id="12891086" author="knutanders" created="Thu, 22 Jul 2010 11:31:55 +0100"  >&lt;p&gt;Here&apos;s a patch that makes CheapDateFormatter.formatDate() use a Calendar object to calculate the components of the date. The patch also adds a unit test for the method. Running the full regression test suite now.&lt;/p&gt;</comment>
                            <comment id="12891088" author="knutanders" created="Thu, 22 Jul 2010 11:41:02 +0100"  >&lt;p&gt;Whoops! I meant to fix a typo in a comment before I uploaded the patch. 1b fixes the typo and removes an unintended blank line.&lt;/p&gt;</comment>
                            <comment id="12891092" author="knutanders" created="Thu, 22 Jul 2010 11:52:59 +0100"  >&lt;p&gt;Sigh... More typos... I had the wrong JIRA number in the test comments.&lt;/p&gt;</comment>
                            <comment id="12891137" author="knutanders" created="Thu, 22 Jul 2010 13:48:21 +0100"  >&lt;p&gt;All the regression tests passed with the 1c patch.&lt;/p&gt;</comment>
                            <comment id="12891147" author="kmarsden" created="Thu, 22 Jul 2010 14:29:25 +0100"  >&lt;p&gt;I am not really sure if this is at all relevant at this time, but this issue brought back memories because it touched on my first ever technical conversation regarding what was at that time Cloudscape with Jeff Lichtman.  I seem to recall he had implemented CheapDateFormatter because it was found just printing the date to the log was taking huge amounts of time.  Of course Calendar did not exist at that time, so I don&apos;t know if the performance is acceptable. Also I think any performance impact was probably more closely related to being able to test performance with statement logging, etc turned on than a typical user scenario, but I thought I would mention this bit of history in case performance of the new CheapDateFormatter needs to be measured.&lt;/p&gt;
</comment>
                            <comment id="12891220" author="knutanders" created="Thu, 22 Jul 2010 16:36:34 +0100"  >&lt;p&gt;Thanks for providing the historical background for the CheapDateFormatter class, Kathey.&lt;/p&gt;

&lt;p&gt;I wrote a small performance test (see the attached CheapFormatterPerfTest.java) to see the impact of the fix. On my laptop, running Java 6u21 with default options, the old implementation managed to format about 280000 timestamps per second. The new implementation only manages about 190000 timestamps per second, which is slower, but I cannot imagine that it would be noticed in any realistic scenario.&lt;/p&gt;</comment>
                            <comment id="12891355" author="lilywei" created="Thu, 22 Jul 2010 22:48:39 +0100"  >&lt;p&gt;I am not totally understand the performance impact for this issue. However, (280000-190000)/280000 is 32% slower. If we apply that to a big amount of timestamp implementation store procedure. Will that be a slower scenario case? &lt;/p&gt;</comment>
                            <comment id="12891365" author="kmarsden" created="Thu, 22 Jul 2010 23:20:25 +0100"  >&lt;p&gt;I think 190000 timestamps per second seems totally reasonable.  #&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I don&apos;t know why it was an issue back then.  I remember being surprised,  but didn&apos;t pursue it in more detail.&lt;/p&gt;
</comment>
                            <comment id="12891515" author="knutanders" created="Fri, 23 Jul 2010 09:15:19 +0100"  >&lt;p&gt;I committed the 1c patch to trunk with revision 967000.&lt;/p&gt;

&lt;p&gt;Lily: This class is only used for formatting timestamps when writing messages to derby.log, so it&apos;s not part of normal query processing unless statement logging is turned on. And even in the cases where logging is turned on, the 32% slow-down is only for the generation of the timestamp, which is just a small part of the total query cost, so the overall performance impact will probably more like 1% than 30% (depending on the complexity of the query, of course). I think that in environments where performance is critical, statement logging is almost certainly turned off, and that&apos;s why I don&apos;t worry too much about it.&lt;/p&gt;</comment>
                            <comment id="12891520" author="knutanders" created="Fri, 23 Jul 2010 09:34:08 +0100"  >&lt;p&gt;Out of curiosity, I changed the implementation of CheapDateFormatter.formatDate() to&lt;/p&gt;

&lt;p&gt;    public static String formatDate(long time) &lt;/p&gt;
{
        return new Date(time).toString();
    }

&lt;p&gt;and to&lt;/p&gt;

&lt;p&gt;    public static String formatDate(long time) &lt;/p&gt;
{
        return new Date(time).toGMTString();
    }

&lt;p&gt;The toString() variant (which localizes the timestamp) managed 390000 timestamps per second, whereas the toGMTString() variant managed 500000.&lt;/p&gt;

&lt;p&gt;So it seems like the performance of java.util.Date has improved a lot over these years and it&apos;s now way faster than CheapDateFormatter. Perhaps now it&apos;s time to remove the CheapDateFormatter class altogether and use java.util.Date instead?&lt;/p&gt;</comment>
                            <comment id="12891691" author="lilywei" created="Fri, 23 Jul 2010 18:59:59 +0100"  >&lt;p&gt;+1 &lt;br/&gt;
Use java.util.Date insteads of CheapDateFormatter. I was googleing the performance issue for java.util.Date. There are some issues before 2008. After 2008, I could not find people report performance issue related to java.util.Date. Also, with 500000 timestamps per second testing result, it looks very promise to me.&lt;/p&gt;</comment>
                            <comment id="12899829" author="knutanders" created="Wed, 18 Aug 2010 13:43:02 +0100"  >&lt;p&gt;Here&apos;s a patch that removes CheapDateFormatter and makes the callers&lt;br/&gt;
use java.util.Date instead. CheapDateFormatter used to convert the&lt;br/&gt;
timestamps to GMT, whereas Date.toString() will use the local time&lt;br/&gt;
zone. Date.toString() also formats the timestamp differently. So,&lt;br/&gt;
where CheapDateFormatter produces a timestamp like&lt;/p&gt;

&lt;p&gt;  2010-08-18 11:38:59.755 GMT&lt;/p&gt;

&lt;p&gt;we will now print something like this instead:&lt;/p&gt;

&lt;p&gt;  Wed Aug 18 13:38:59 CEST 2010&lt;/p&gt;

&lt;p&gt;I think either one of these two formats works just as well as the&lt;br/&gt;
other for logging purposes, but others may disagree.&lt;/p&gt;

&lt;p&gt;Full list of changes made by the patch:&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/services/monitor/BaseMonitor.java&lt;/p&gt;

&lt;p&gt;Removed unused imports, including CheapDateFormatter. No actual use of&lt;br/&gt;
CheapDateFormatter in this class.&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/services/locks/Timeout.java&lt;/p&gt;

&lt;p&gt;Use Date.toString() instead of CheapDateFormatter to format the&lt;br/&gt;
timestamp included in timeout exceptions when&lt;br/&gt;
derby.locks.deadlockTrace has been set.&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/services/stream/BasicGetLogHeader.java&lt;/p&gt;

&lt;p&gt;Use Date.toString() to produce the timestamp in the log stream header.&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/store/raw/data/BaseDataFileFactory.java&lt;/p&gt;

&lt;p&gt;Use Date.toString() instead of CheapDateFormatter when writing the&lt;br/&gt;
startup and shutdown messages to derby.log. Also removed unused&lt;br/&gt;
imports, including CheapDateFormatter.&lt;/p&gt;

&lt;p&gt;M       java/drda/org/apache/derby/impl/drda/NetworkServerControlImpl.java&lt;/p&gt;

&lt;p&gt;Use Date instead of CheapDateFormatter when server prints console&lt;br/&gt;
messages.&lt;/p&gt;

&lt;p&gt;D       java/engine/org/apache/derby/iapi/util/CheapDateFormatter.java&lt;br/&gt;
D       java/testing/org/apache/derbyTesting/unitTests/junit/CheapDateFormatterTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/unitTests/junit/_Suite.java&lt;/p&gt;

&lt;p&gt;Removed CheapDateFormatter class and its unit tests.&lt;/p&gt;

&lt;p&gt;A       java/testing/org/apache/derbyTesting/functionTests/tests/tools/derbyrunjartest_sed.properties&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/master/derbyrunjartest.out&lt;/p&gt;

&lt;p&gt;Filter out a line with a timestamp from derbyrunjartest since the&lt;br/&gt;
format of the timestamp has changed and isn&apos;t caught by the old&lt;br/&gt;
filters.&lt;/p&gt;</comment>
                            <comment id="12902342" author="knutanders" created="Wed, 25 Aug 2010 09:26:02 +0100"  >&lt;p&gt;Committed revision 988874.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12520243">DERBY-5391</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12450181" name="CheapFormatterPerfTest.java" size="947" author="knutanders" created="Thu, 22 Jul 2010 16:36:34 +0100"/>
                            <attachment id="12450155" name="derby-4752-1a.diff" size="10893" author="knutanders" created="Thu, 22 Jul 2010 11:31:55 +0100"/>
                            <attachment id="12450156" name="derby-4752-1b.diff" size="10891" author="knutanders" created="Thu, 22 Jul 2010 11:41:02 +0100"/>
                            <attachment id="12450158" name="derby-4752-1c.diff" size="10891" author="knutanders" created="Thu, 22 Jul 2010 11:52:59 +0100"/>
                            <attachment id="12452396" name="remove-cheap-formatter.diff" size="20122" author="knutanders" created="Wed, 18 Aug 2010 13:43:02 +0100"/>
                            <attachment id="12452395" name="remove-cheap-formatter.stat" size="805" author="knutanders" created="Wed, 18 Aug 2010 13:43:02 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 22 Jul 2010 13:29:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24445</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36315</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>