<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:12:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1386/DERBY-1386.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1386] Wrong results with query using LIKE and ESCAPE clause that includes &quot;%&quot;, &quot;\&quot;, and &quot;_&quot;</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1386</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;After the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1262&quot; title=&quot;Like-predicates: % does not match tab character&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1262&quot;&gt;&lt;del&gt;DERBY-1262&lt;/del&gt;&lt;/a&gt; was checked in, I&apos;m noticing that the following query now returns different results.  Prior to the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1262&quot; title=&quot;Like-predicates: % does not match tab character&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1262&quot;&gt;&lt;del&gt;DERBY-1262&lt;/del&gt;&lt;/a&gt; the query returned 2 rows; now it doesn&apos;t return any rows.&lt;/p&gt;

&lt;p&gt;create table escTable (c1 char(10));&lt;br/&gt;
insert into escTable values (&apos;%_\a&apos;);&lt;br/&gt;
insert into escTable values (&apos;%_b&apos;);&lt;br/&gt;
insert into escTable values (&apos;%c&apos;);&lt;br/&gt;
insert into escTable values (&apos;d&apos;);&lt;br/&gt;
insert into escTable values (&apos;%_\e&apos;);&lt;br/&gt;
select c1 from escTable where c1 like &apos;&amp;#37;&amp;#95;&lt;br class=&quot;atl-forced-newline&quot; /&gt;%&apos; ESCAPE &apos;\&apos;;&lt;/p&gt;

&lt;p&gt;Before &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1262&quot; title=&quot;Like-predicates: % does not match tab character&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1262&quot;&gt;&lt;del&gt;DERBY-1262&lt;/del&gt;&lt;/a&gt;, the SELECT returned:&lt;/p&gt;

&lt;p&gt;C1&lt;br/&gt;
----------&lt;br/&gt;
%_\a&lt;br/&gt;
%_\e&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;/p&gt;

&lt;p&gt;Now it returns:&lt;/p&gt;

&lt;p&gt;C1&lt;br/&gt;
----------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;/p&gt;

&lt;p&gt;Brief inspection of the query and data suggest to me that these new results (i.e. no rows) are wrong, and that Derby should in fact return 2 rows/.&lt;/p&gt;

&lt;p&gt;Based on comments in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1262&quot; title=&quot;Like-predicates: % does not match tab character&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1262&quot;&gt;&lt;del&gt;DERBY-1262&lt;/del&gt;&lt;/a&gt;, I&apos;m creating a new Jira issue for the regression since it has been checked into the 10.1 maintenance branch.  I&apos;ve set the priority to &quot;Critical&quot; since this could potentially delay a 10.1.3 release--I.e. I don&apos;t think we&apos;d want to release 10.1.3 knowing that we have a wrong results regression.  But if anyone thinks that&apos;s not the correct priority, feel free to speak up.&lt;/p&gt;

&lt;p&gt;Other option, of course, is to back out the change for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1262&quot; title=&quot;Like-predicates: % does not match tab character&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1262&quot;&gt;&lt;del&gt;DERBY-1262&lt;/del&gt;&lt;/a&gt; in 10.1 and then lower the priority accordingly.  &lt;/p&gt;

&lt;p&gt;Input/feedback/comments would be appreciated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12344089">DERBY-1386</key>
            <summary>Wrong results with query using LIKE and ESCAPE clause that includes &quot;%&quot;, &quot;\&quot;, and &quot;_&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Jun 2006 03:05:58 +0100</created>
                <updated>Tue, 30 Jun 2009 16:55:48 +0100</updated>
                            <resolved>Sat, 10 Jun 2006 02:53:59 +0100</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.1.3.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12415196" author="army" created="Thu, 8 Jun 2006 03:11:57 +0100"  >&lt;p&gt;Oops, forgot to change the priority to Critical, per my comments in the description.&lt;/p&gt;</comment>
                            <comment id="12415324" author="knutanders" created="Thu, 8 Jun 2006 19:28:23 +0100"  >&lt;p&gt;I see the same results. However, when I use like to test the same values as constants, it correctly evaluates to true:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from sysibm.sysdummy1 where &apos;%_\a&apos; like &apos;&amp;#37;&amp;#95;&lt;br class=&quot;atl-forced-newline&quot; /&gt;%&apos; escape &apos;\&apos;;&lt;br/&gt;
IBM&amp;amp;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Y   &lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;</comment>
                            <comment id="12415340" author="knutanders" created="Thu, 8 Jun 2006 20:29:55 +0100"  >&lt;p&gt;There is a bug in the unoptimized version of&lt;br/&gt;
Like.lessThanString(). The bug was not introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1262&quot; title=&quot;Like-predicates: % does not match tab character&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1262&quot;&gt;&lt;del&gt;DERBY-1262&lt;/del&gt;&lt;/a&gt;, just&lt;br/&gt;
exposed by it. I will try to fix it in trunk and 10.1.&lt;/p&gt;

&lt;p&gt;lessThanString() searches for the first occurrence of % or _ in the&lt;br/&gt;
pattern string, and if the preceding character is an escape character,&lt;br/&gt;
it is skipped. This leads to incorrect behaviour when % or _ is&lt;br/&gt;
preceded by an escaped escape character.&lt;/p&gt;</comment>
                            <comment id="12415547" author="knutanders" created="Fri, 9 Jun 2006 21:57:26 +0100"  >&lt;p&gt;Attached a patch (derby-1386-v1.diff) which removes the old, unused&lt;br/&gt;
version of lessThanString (the so-called optimized version) and&lt;br/&gt;
rewrites the unoptimized version.&lt;/p&gt;

&lt;p&gt;First a description of what lessThanString() is supposed to do&lt;br/&gt;
(somewhat simplified):&lt;/p&gt;

&lt;p&gt;When an SQL statement is compiled, LIKE expressions are rewritten to&lt;br/&gt;
make them more efficient. For instance,&lt;/p&gt;

&lt;p&gt;  SELECT * FROM T WHERE X LIKE &apos;abc_ef%&apos;&lt;/p&gt;

&lt;p&gt;is rewritten to&lt;/p&gt;

&lt;p&gt;  SELECT * FROM T WHERE X &amp;gt;= &apos;abc&apos; AND X &amp;lt; &apos;abd&apos; AND X LIKE &apos;abc_ef%&apos;&lt;/p&gt;

&lt;p&gt;(Well, &apos;abc&apos; and &apos;abd&apos; will actually be padded with nulls up to the&lt;br/&gt;
max length of X, but you get the point...)&lt;/p&gt;

&lt;p&gt;Rewriting the statement like this is done to reduce the number of LIKE&lt;br/&gt;
comparisons (which are more expensive than &amp;gt;= and &amp;lt;) and to make it&lt;br/&gt;
possible to use the index.&lt;/p&gt;

&lt;p&gt;The role of lessThanString() is to generate the string used in the&lt;br/&gt;
less than expression (&apos;abd&apos; in the example above). This string is the&lt;br/&gt;
sub-string leading up to the first wildcard, but with the last&lt;br/&gt;
character incremented by one (and, again, the string is padded with&lt;br/&gt;
nulls).&lt;/p&gt;

&lt;p&gt;Currently, lessThanString() does this:&lt;/p&gt;

&lt;p&gt;  1) Find the first wildcard character, if it is preceded by an escape&lt;br/&gt;
     character go to the next wildcard. (The error is in this step,&lt;br/&gt;
     because the escape character can be escaped.)&lt;/p&gt;

&lt;p&gt;  2) Take the character right before the first wildcard and increment&lt;br/&gt;
     it.&lt;/p&gt;

&lt;p&gt;  3) Build a new string of the pattern string up to the incremented&lt;br/&gt;
     character, but without the escape characters.&lt;/p&gt;

&lt;p&gt;  4) Pad the string with nulls and return it.&lt;/p&gt;

&lt;p&gt;With the patch, it does the following:&lt;/p&gt;

&lt;p&gt;  1) Build a new string based on the pattern string by walking the&lt;br/&gt;
     pattern string, skipping escape characters and stopping when the&lt;br/&gt;
     first unescaped wildcard is found.&lt;/p&gt;

&lt;p&gt;  2) Increment the last character of the newly built string.&lt;/p&gt;

&lt;p&gt;  3) Pad the string with nulls and return it.&lt;/p&gt;

&lt;p&gt;Other changes in the patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the unused version of lessThanString() was removed&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;some comments about what lessThanString() does were changed since&lt;br/&gt;
    the code didn&apos;t do what they said&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new test cases in lang/dynamicLikeOptimization.sql&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Derbyall ran without errors on Sun JVM 1.5.0 / Solaris 10 x86.&lt;/p&gt;

&lt;p&gt;Reviews would be most appreciated! Thanks!&lt;/p&gt;</comment>
                            <comment id="12415568" author="army" created="Sat, 10 Jun 2006 00:51:49 +0100"  >&lt;p&gt;I reviewed this patch and the changes look correct to me.  The old code matches the problem that Knut identified and the new code addresses the issues and does what is described in the previous comment.  I also verified that the repro passes with the patch applied, and that the new test cases fail without the patch and pass with it.&lt;/p&gt;

&lt;p&gt;I haven&apos;t run derbyall myself but since Knut ran it and said everything passed, I vote +1 to have this committed.&lt;/p&gt;

&lt;p&gt;Thanks again for volunteering to address this, Knut, and for doing it so quickly.&lt;/p&gt;</comment>
                            <comment id="12415597" author="knutanders" created="Sat, 10 Jun 2006 02:53:59 +0100"  >&lt;p&gt;Thanks Army for reporting the issue and reviewing the patch so quickly that we could make it before the 10.1.3 code freeze.&lt;/p&gt;

&lt;p&gt;I have now run derbyall on 10.1 (Sun JVM 1.5.0, Solaris 10 x86) with two failures. One is T_Diagnosticable, which Andreas just reported that he has seen on Solaris as well, and the other one is testSecMec, which fails because the message text is slightly different from the canon.&lt;/p&gt;

&lt;p&gt;Committed the patch into trunk with revision 413123 and into 10.1 with revision 413124. I have verified that the example provided by Army returns the correct results on both trunk and 10.1.&lt;/p&gt;</comment>
                            <comment id="12420385" author="army" created="Wed, 12 Jul 2006 02:03:49 +0100"  >&lt;p&gt;Fix verified in 10.1 and 10.2, so I&apos;m marking it closed.  Thanks Knut Anders!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12332422">DERBY-1231</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12335260" name="derby-1386-v1.diff" size="9266" author="knutanders" created="Fri, 9 Jun 2006 21:57:26 +0100"/>
                            <attachment id="12335261" name="derby-1386-v1.stat" size="247" author="knutanders" created="Fri, 9 Jun 2006 21:57:26 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 8 Jun 2006 18:28:23 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22473</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0uu7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38814</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>