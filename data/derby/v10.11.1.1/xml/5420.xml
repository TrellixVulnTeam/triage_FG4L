<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:33:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5420/DERBY-5420.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5420] Regression suite appears locale sensitive: failed in TableLockBasicTest: bug in RealBasicNoPutResultSetStatistics</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5420</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;TableLockBasicTest failed due to unexpected locale in the runtime statistics.&lt;/p&gt;

&lt;p&gt;The execution plans are asserted in this test and I saw this diff:&lt;/p&gt;

&lt;p&gt;Expected:&lt;br/&gt;
        :&lt;br/&gt;
	optimizer estimated row count:            6.00&lt;br/&gt;
	optimizer estimated cost:          100.40&amp;lt;&lt;br/&gt;
Found:&lt;br/&gt;
        :&lt;br/&gt;
        optimizer estimated row count:            6,00&lt;br/&gt;
	optimizer estimated cost:          100,40&amp;lt;&lt;/p&gt;

&lt;p&gt;the latter using a decimal comma whereas a decimal point is expected.&lt;/p&gt;</description>
                <environment>Windows Vista SP2, Norwegian locale, JDK 7.</environment>
        <key id="12523595">DERBY-5420</key>
            <summary>Regression suite appears locale sensitive: failed in TableLockBasicTest: bug in RealBasicNoPutResultSetStatistics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Sep 2011 19:17:44 +0100</created>
                <updated>Wed, 28 Sep 2011 17:10:56 +0100</updated>
                            <resolved>Tue, 27 Sep 2011 22:55:11 +0100</resolved>
                                    <version>10.8.1.2</version>
                                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Localization</component>
                    <component>SQL</component>
                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13108051" author="dagw" created="Mon, 19 Sep 2011 19:50:22 +0100"  >&lt;p&gt;I am a bit puzzled by this one, because it seems the test &lt;b&gt;does&lt;/b&gt; set the default locale to Locale.ENGLISH (something which in my small test does give the expected decimal character..)&lt;/p&gt;</comment>
                            <comment id="13108088" author="dagw" created="Mon, 19 Sep 2011 20:35:51 +0100"  >&lt;p&gt;Running the test stand-alone I don&apos;t see an error, I&apos;ll rerun the suitesAll to see if that is of importance.&lt;/p&gt;</comment>
                            <comment id="13109170" author="dagw" created="Wed, 21 Sep 2011 02:23:48 +0100"  >&lt;p&gt;This is now a confirmed Heisenbug.. I can only see it in a suite context, I have narrowed it down quite a bit, but it&apos;s proving elusive. I see it if I run only the derbynet suite ahead of the suite of the store test (in which this test resides). I have narrowed the store suite down to just running the two autoindex tests ahead of TableLockBasicTest, but it sometimes passes.&lt;/p&gt;</comment>
                            <comment id="13109314" author="knutanders" created="Wed, 21 Sep 2011 08:14:04 +0100"  >&lt;p&gt;Just a thought... Does it help if you change Locale.ENGLISH to Locale.US in the test setup? The former only specifies the language, whereas the latter specifies language and country. Maybe you can end up with some hybrid locale (like en_NO) when using the language-only variant. No idea why it would be intermittent if this is what&apos;s causing it, though.&lt;/p&gt;</comment>
                            <comment id="13112518" author="dagw" created="Thu, 22 Sep 2011 14:01:32 +0100"  >&lt;p&gt;Interesting idea, on my WIndows PC was actually running a &quot;hybrid&quot; locale: Norwegian language (&quot;display language&quot;, but US style numbers &amp;amp; dates (&quot;formatting&quot;). Unfortunately, Locale.US didn&apos;t correct the error.&lt;/p&gt;</comment>
                            <comment id="13112942" author="dagw" created="Thu, 22 Sep 2011 22:45:31 +0100"  >&lt;p&gt;It turns out that RealBasicNoPutResultSetStatistics#formatDouble caches the decimal format:&lt;br/&gt;
 :&lt;br/&gt;
 if (df == null)&lt;/p&gt;
 {
    // RESOLVE: This really should use the database locale to 
    // format the number.
    df = new DecimalFormat(&quot;###########0.00&quot;);
    df.setMinimumIntegerDigits(1);
}

&lt;p&gt;and even though we currently have correct Locale (language is English and country US), the cached decimal format descriptor has the wrong decimal character, i.e. a comma, presumably from an earlier test which did not specify locale and thus inherited the default locale on my box. Since this is an engine static variable, it will remain in the wrong form until the engine is rebooted, hence the error. Now, I just need to figure out which test first gives it the wrong form &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; As the comment indicates, this is broken...&lt;/p&gt;</comment>
                            <comment id="13112948" author="dagw" created="Thu, 22 Sep 2011 22:58:42 +0100"  >&lt;p&gt;A solution may be to save the default locale at the time of creating the decimal format, and check if the default locale has changed before deciding to use the hashed value or recompute it. The current code is an optimization, hopefully retrieving the current default locale will not void the optimization entirely.&lt;/p&gt;</comment>
                            <comment id="13113102" author="dagw" created="Fri, 23 Sep 2011 02:46:11 +0100"  >&lt;p&gt;Just to clearify, the bug is not really intermittent after all, it just appeared that way, since depending on which tests ahead of TableLockBasicTest I commented out, the first setting of the decimal format above might happen in a test running with a specific English locale, or in a test running with the default one. &lt;/p&gt;

&lt;p&gt;For example, AccessTest calls SYSCS_GET_RUNTIMESTATISTICS without setting explicit locale, but this test uses the RuntimeStatisticsParser and doesn&apos;t worry about the double number estimated row count, so AccessTest test is not impacted by (an unexpected form of) decimal printing.&lt;/p&gt;</comment>
                            <comment id="13113153" author="bryanpendleton" created="Fri, 23 Sep 2011 05:42:31 +0100"  >&lt;p&gt;Great catch! And thanks for the clear description of the behavior; it makes complete sense.&lt;br/&gt;
It&apos;s always nice to find a deterministic answer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;My initial reaction to the code you pasted in your earlier comment is that it seems like&lt;br/&gt;
the sort of thing that should be done in the ResultSetStatistics constructor.&lt;/p&gt;

&lt;p&gt;That is, it seems like the &quot;df&quot; object should not be static, and the code to set it up based&lt;br/&gt;
on the current locale should be in the constructor.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if that would be a performance problem, but it might be a place to start.&lt;/p&gt;</comment>
                            <comment id="13113234" author="knutanders" created="Fri, 23 Sep 2011 08:59:17 +0100"  >&lt;p&gt;I agree with Bryan that it sounds broken to cache the DecimalFormat in a static field. According to DecimalFormat&apos;s javadoc, it&apos;s not thread safe without external synchronization, so each result set needs to have its own instance.&lt;/p&gt;

&lt;p&gt;Another question is whether the correct fix is to use the default locale, or (as suggested by the comments in the code) the database locale. I lean towards the latter, as I think the rest of the runtime statistics output is generated with that locale.&lt;/p&gt;</comment>
                            <comment id="13113254" author="knutanders" created="Fri, 23 Sep 2011 09:27:24 +0100"  >&lt;p&gt;Just a thought... What if we change the message text of the RTS_OPT_EST_RC message in messages.xml from&lt;/p&gt;

&lt;p&gt;    &amp;lt;text&amp;gt;optimizer estimated row count&amp;lt;/text&amp;gt;&lt;br/&gt;
to&lt;br/&gt;
    &amp;lt;text&amp;gt;optimizer estimated row count: &lt;/p&gt;
{0,number,###########0.00}
&lt;p&gt;&amp;lt;/text&amp;gt;&lt;/p&gt;

&lt;p&gt;and in RealBasicNoPutResultSetStatistics.dumpEstimatedCosts() from&lt;/p&gt;

&lt;p&gt;				MessageService.getTextMessage(SQLState.RTS_OPT_EST_RC) +&lt;br/&gt;
					&quot;: &quot; +&lt;br/&gt;
				formatDouble(optimizerEstimatedRowCount) + &quot;\n&quot; +&lt;br/&gt;
to&lt;br/&gt;
				MessageService.getTextMessage(SQLState.RTS_OPT_EST_RC, new Double(optimizerEstimatedRowCount)) + &quot;\n&quot; +&lt;br/&gt;
?&lt;/p&gt;

&lt;p&gt;Similar changes would be needed for RTS_OPT_EST_COST too.&lt;/p&gt;

&lt;p&gt;Then we avoid the need to explicitly create and cache a DecimalFormat instance, and the number will be formatted using the same locale as the rest of the message (the database locale). And we can remove the formatDouble() method, so we&apos;ll reduce the code size too.&lt;/p&gt;</comment>
                            <comment id="13113541" author="dagw" created="Fri, 23 Sep 2011 17:37:12 +0100"  >&lt;p&gt;Thanks, folk! I had made a patch along the lines of Bryan&apos;s suggestion more or less, making the format non-static and initializing the db locale in the contructor. Knut&apos;s idea seemed attractive, however, and I made a try. It turns out the MessageBuilder chokes on it when it tries to generate DITA source, not being prepared for anything but &lt;/p&gt;
{&amp;lt;string&amp;gt;}
&lt;p&gt; parameters in message strings in messages.xml: it tries to put the name of the meta-variable in the string, cf this:&lt;/p&gt;

&lt;p&gt;&amp;lt;row&amp;gt;&lt;br/&gt;
  &amp;lt;entry colname=&quot;col1&quot;&amp;gt;01006&amp;lt;/entry&amp;gt;&lt;br/&gt;
  &amp;lt;entry colname=&quot;col2&quot;&amp;gt;Privilege not revoked from user &amp;lt;varname&amp;gt;&amp;lt;authorizationID&amp;gt;&amp;lt;/varname&amp;gt;.&amp;lt;/entry&amp;gt;&lt;br/&gt;
&amp;lt;/row&amp;gt;&lt;/p&gt;

&lt;p&gt;Obviously, trying to format a string like &quot;&amp;lt;varname&amp;gt;&amp;lt;number&amp;gt;&amp;lt;/varname&amp;gt;&quot; with the format &quot;&lt;/p&gt;
{0,number,###########0.00}
&lt;p&gt;&quot; doesn&apos;t work very well...&lt;/p&gt;

&lt;p&gt; I&apos;ll see it I can work around that somehow.&lt;/p&gt;</comment>
                            <comment id="13113716" author="dagw" created="Fri, 23 Sep 2011 21:04:54 +0100"  >&lt;p&gt;Uploading patch #1 for this issue using Knut&apos;s suggestion. It leads to a small behavioral change: the leading blanks before the double decimals are gone, cf the logic in RealBasicNoPutResultSetStatistics#formatDouble (removed). I don&apos;t think we&apos;ll miss those, though.&lt;/p&gt;

&lt;p&gt;Running regressions.&lt;/p&gt;</comment>
                            <comment id="13113753" author="dagw" created="Fri, 23 Sep 2011 21:45:57 +0100"  >&lt;p&gt;Renamed this issue to better reflect the problem.&lt;/p&gt;</comment>
                            <comment id="13113928" author="knutanders" created="Sat, 24 Sep 2011 08:52:14 +0100"  >&lt;p&gt;As to the renaming of the issue, isn&apos;t it rather RealBasicNoPutResultSetStatistics that&apos;s locale insensitive than the regression test suite being locale sensitive? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The patch looks fine to me. Two possible improvements:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Should we append &quot;: 
{0,number,###########0.00}
&lt;p&gt;&quot; to the localized versions of these messages?&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In MessageBuilder, it might be easier to clear the format specifier using MessageFormat.setFormatByArgumentIndex(). Something like:&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;&amp;#8212; a/java/build/org/apache/derbyBuild/MessageBuilder.java&lt;br/&gt;
+++ b/java/build/org/apache/derbyBuild/MessageBuilder.java&lt;br/&gt;
@@ -659,14 +659,16 @@ public class MessageBuilder extends Task&lt;br/&gt;
     {&lt;br/&gt;
         int             count = rawArgs.length;&lt;br/&gt;
         String[]    cookedArgs = new String[ count ];&lt;br/&gt;
+        MessageFormat format = new MessageFormat(message);&lt;/p&gt;

&lt;p&gt;         // add xml angle brackets around the args&lt;br/&gt;
         for ( int i = 0; i &amp;lt; count; i++ )&lt;/p&gt;
         {
             cookedArgs[ i ] = &quot;&amp;lt;varname&amp;gt;&amp;lt;&quot; + rawArgs[ i ] + &quot;&amp;gt;&amp;lt;/varname&amp;gt;&quot;;
+            format.setFormatByArgumentIndex(i, null);
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return MessageFormat.format( message, cookedArgs );&lt;br/&gt;
+        return format.format(cookedArgs);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /////////////////////////////////////////////////////////////////////////&lt;/p&gt;</comment>
                            <comment id="13114967" author="dagw" created="Mon, 26 Sep 2011 23:06:07 +0100"  >&lt;p&gt;Regression results: lang/subqueryFlattening.sql failed because the exisiting output of an execution plan was cut short by being longer than 32672 characters. Since the new formatting saves some whitespace, it managed to print more of the execution plan and failed (the script somewhat misleadingly had set maxcolumndisplaywidth to 40000, over the max for the VARCHAR column metadata returned for &quot;values SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS()&quot;.&lt;/p&gt;</comment>
                            <comment id="13114968" author="dagw" created="Mon, 26 Sep 2011 23:08:26 +0100"  >&lt;p&gt;Thanks Knut, yes, looks like a good simplification! As for the naming, I agree.&lt;/p&gt;
</comment>
                            <comment id="13115099" author="dagw" created="Tue, 27 Sep 2011 02:15:44 +0100"  >&lt;p&gt;Attaching version #2, which makes the simplification suggested by Knut, fixes the master file of subqueryFlattening.sql and adjusts the other locales&apos; message files. Running regressions over.&lt;/p&gt;</comment>
                            <comment id="13115362" author="knutanders" created="Tue, 27 Sep 2011 10:38:01 +0100"  >&lt;p&gt;Thanks, Dag. The patch looks good to me. Please also remove the added java.util.regex imports in MessageBuilder before you commit, since they aren&apos;t used in this version of the patch.&lt;/p&gt;</comment>
                            <comment id="13115960" author="dagw" created="Tue, 27 Sep 2011 22:53:24 +0100"  >&lt;p&gt;Committed at svn 1176633 and 1176636, resolving.&lt;/p&gt;</comment>
                            <comment id="13116573" author="dagw" created="Wed, 28 Sep 2011 17:10:37 +0100"  >&lt;p&gt;Backported to 10.8 branch as svn 1176939, closing. Note: the change to TableLockBasicTest on trunk was not backported since that test hasn&apos;t been backported.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12496313" name="derby-5420-1.diff" size="9199" author="dagw" created="Fri, 23 Sep 2011 21:04:54 +0100"/>
                            <attachment id="12496314" name="derby-5420-1.stat" size="307" author="dagw" created="Fri, 23 Sep 2011 21:04:54 +0100"/>
                            <attachment id="12496607" name="derby-5420-2.diff" size="22629" author="dagw" created="Tue, 27 Sep 2011 02:15:43 +0100"/>
                            <attachment id="12496608" name="derby-5420-2.stat" size="1246" author="dagw" created="Tue, 27 Sep 2011 02:15:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 21 Sep 2011 07:14:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3626</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0f93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36289</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>