<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:22:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4182/DERBY-4182.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4182] SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE  does not reclaim space lost from an aborted insert</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4182</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Because of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-691&quot; title=&quot;committed deleted row space reclamation may be missed if delete is actually an aborted insert.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-691&quot;&gt;&lt;del&gt;DERBY-691&lt;/del&gt;&lt;/a&gt; an aborted insert (for example due to a constraint violation or rollback) can cause space to not be reclaimed.  SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE  should reclaim this space. Even if it cannot return the space to the operating system it should show up as free pages after calling the procedure, but it currently does not.   SYSCS_UTIL.SYSCS_COMPRESS_TABLE works properly and returns the space to the operating system.&lt;/p&gt;

&lt;p&gt;See the attached program TestInPlaceCompressWithPKViolation.java to reproduce this problem.  The program attempts 10 3MB inserts. One is successful and 9 fail.   SpaceTable queries show only 18 pages are  marked as free after inplace compress and none returned to the os.&lt;/p&gt;


&lt;p&gt;The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or un&lt;br/&gt;
ique index identified by &apos;SQL090422155557650&apos; defined on &apos;TAB&apos;.&lt;br/&gt;
*****spaceTable before SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE(&apos;APP&apos;,&apos;TAB&apos;,1,1,1)&lt;br/&gt;
CONGLOMERATENAME&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ISIND&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMALLOCATEDPAGES   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMFREEPAGES        &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMUNFILLEDPAGES    &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;PAGESIZE   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ESTIMSPACESAVING&lt;br/&gt;
------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
---------------------------------------------------------------------------------------------------------------&lt;br/&gt;
TAB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0     &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;931                 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0                   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2                   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32768      &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0&lt;br/&gt;
*****spaceTable after SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE(&apos;APP&apos;,&apos;TAB&apos;,1,1,1)&lt;br/&gt;
CONGLOMERATENAME&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ISIND&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMALLOCATEDPAGES   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMFREEPAGES        &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMUNFILLEDPAGES    &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;PAGESIZE   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ESTIMSPACESAVING&lt;br/&gt;
------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
---------------------------------------------------------------------------------------------------------------&lt;br/&gt;
TAB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0     &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;913                 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;18                  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1                   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32768      &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;589824&lt;br/&gt;
*****spaceTable after SYSCS_UTIL.SYSCS_COMPRESS_TABLE(&apos;APP&apos;,&apos;TAB&apos;,1)&lt;br/&gt;
CONGLOMERATENAME&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ISIND&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMALLOCATEDPAGES   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMFREEPAGES        &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NUMUNFILLEDPAGES    &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;PAGESIZE   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ESTIMSPACESAVING&lt;br/&gt;
------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
---------------------------------------------------------------------------------------------------------------&lt;br/&gt;
TAB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0     &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;95                  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0                   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1                   &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32768      &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;




</description>
                <environment></environment>
        <key id="12423524">DERBY-4182</key>
            <summary>SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE  does not reclaim space lost from an aborted insert</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikem">Mike Matrigali</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Apr 2009 00:06:01 +0100</created>
                <updated>Wed, 12 Jan 2011 22:24:25 +0000</updated>
                            <resolved>Wed, 27 May 2009 00:31:13 +0100</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.2.0</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12701730" author="kmarsden" created="Thu, 23 Apr 2009 00:12:07 +0100"  >&lt;p&gt;linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4152&quot; title=&quot;mailjdbc test database  grows very fast with 10.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4152&quot;&gt;&lt;del&gt;DERBY-4152&lt;/del&gt;&lt;/a&gt; as at least some of the growth in the mailjdbc test is related to this issue.&lt;/p&gt;</comment>
                            <comment id="12710958" author="mikem" created="Wed, 20 May 2009 01:46:29 +0100"  >&lt;p&gt;tested against 10.3 also and it reproduces there.   The test program does not run in 10.1, because of some utility routines so have not tried it there.  &lt;/p&gt;</comment>
                            <comment id="12711243" author="mikem" created="Wed, 20 May 2009 18:24:51 +0100"  >&lt;p&gt;posting preliminary patch  file: derby4182.diff&lt;/p&gt;

&lt;p&gt;Still need to run a set of tests and add a new test to the suite, but this&lt;br/&gt;
seems to fix the posted repro.&lt;/p&gt;

&lt;p&gt;I believe this has always been a problem, and the behavior was &lt;br/&gt;
incorrectly thought to be &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-691&quot; title=&quot;committed deleted row space reclamation may be missed if delete is actually an aborted insert.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-691&quot;&gt;&lt;del&gt;DERBY-691&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;The problem is not with compress table.  When compress table runs it finds the deleted rows and reclaims them along with the 1st overflow page that that point to, so 2 pages per failed unique constraint insert in the sample program.  The problem is that the abort results in all of the other links of the overflow pages being broken and thus compress table can&apos;t find them.&lt;/p&gt;

&lt;p&gt;The fix is to use some existing functionality in the store to process the broken link pages during the abort insert as purges rather than deletes which will move them to free pages.  This is what is currently done when updates result in new overflow chains are aborted.&lt;/p&gt;</comment>
                            <comment id="12713328" author="mikem" created="Wed, 27 May 2009 00:31:13 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4182&quot; title=&quot;SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE  does not reclaim space lost from an aborted insert&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4182&quot;&gt;&lt;del&gt;DERBY-4182&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Before this fix abort of inserts that included clob or blob chains would&lt;br/&gt;
destroy the links of the allocated pages of the chains.  This would leave&lt;br/&gt;
allocated pages that could never be reclaimed either by subsequent post&lt;br/&gt;
commit processing or inplace compress.  Only offline compress could reclaim&lt;br/&gt;
the space.  This fix changes insert abort processing to automatically put&lt;br/&gt;
all pieces of long columns except for the head page on the free list as part&lt;br/&gt;
of the abort.&lt;/p&gt;

&lt;p&gt;Note this does not fix existing tables that have had this problem happen in&lt;br/&gt;
the past, only stops it from happening.  One must run an offline compress to&lt;br/&gt;
reclaim this space to fix any instances of this bug prior to this fix.&lt;/p&gt;

&lt;p&gt;svn 778926 fixes this bug in the trunk.  Once this change has passed nightly&lt;br/&gt;
tests in the community across a number of platforms I plan to backport it at&lt;br/&gt;
least to 10.3.&lt;/p&gt;

&lt;p&gt;m4_ibm16:147&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\store\Cl&lt;br/&gt;
obReclamationTest.java&lt;br/&gt;
Transmitting file data ..&lt;br/&gt;
Committed revision 778926.&lt;/p&gt;</comment>
                            <comment id="12714318" author="mikem" created="Fri, 29 May 2009 07:14:33 +0100"  >&lt;p&gt;check in svn 779849, backports the fix from the trunk to the 10.5 branch.&lt;/p&gt;</comment>
                            <comment id="12714319" author="mikem" created="Fri, 29 May 2009 07:16:40 +0100"  >&lt;p&gt;the fix is actually to abort processing, not really a problem with compress.  Thus the problem does&lt;br/&gt;
exist in releases previous to inplace compress.  setting affects to 10.1 and 10.2 also.&lt;/p&gt;</comment>
                            <comment id="12714495" author="mikem" created="Fri, 29 May 2009 17:09:04 +0100"  >&lt;p&gt;committed svn #780023, which is the backport of this fix from trunk to 10.4 branch.&lt;/p&gt;</comment>
                            <comment id="12714622" author="mikem" created="Fri, 29 May 2009 23:08:54 +0100"  >&lt;p&gt;committed svn #780124 which backports the change from the trunk to the 10.3 branch.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12422308">DERBY-4152</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12325461">DERBY-691</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12408605" name="DERBY4182.diff" size="6895" author="mikem" created="Wed, 20 May 2009 18:24:51 +0100"/>
                            <attachment id="12406181" name="TestInPlaceCompressWithPKViolation.java" size="2446" author="kmarsden" created="Thu, 23 Apr 2009 00:06:38 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 20 May 2009 00:46:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24084</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0o0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37709</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>