<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:45:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2349/DERBY-2349.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2349] Accessing a BLOB column twice in an INSERT trigger leads to errors in the value on-disk</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2349</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Either the BLOB is stored with the incorrect value or the value on disk does not match the stored length on disk and an exception is raised. The BLOB was supplied as a stream value.&lt;/p&gt;

&lt;p&gt;See this with the new TriggersTest. The text fixture will have a comment with this bug number showing how to reproduce the problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12363049">DERBY-2349</key>
            <summary>Accessing a BLOB column twice in an INSERT trigger leads to errors in the value on-disk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Feb 2007 21:36:11 +0000</created>
                <updated>Mon, 17 Jun 2013 10:19:20 +0100</updated>
                            <resolved>Thu, 11 Feb 2010 12:06:21 +0000</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12473830" author="djd" created="Fri, 16 Feb 2007 21:48:07 +0000"  >&lt;p&gt;Errors seen&lt;/p&gt;

&lt;p&gt;ERROR XSDA7: Restore of a serializable or SQLData object of class , attempted to read more data than was originally stored&lt;/p&gt;

&lt;p&gt;junit.framework.AssertionFailedError: Blobs have different lengths expected:&amp;lt;42879&amp;gt; but was:&amp;lt;14&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12539420" author="mamtas" created="Thu, 1 Nov 2007 17:41:12 +0000"  >&lt;p&gt;I have extracted a stand alone reproducible program for this jira entry and it is attached here as DERBY_2349_Repro.java I think it will make it easier to debug the problem outside of junit framework.&lt;/p&gt;</comment>
                            <comment id="12592421" author="kmarsden" created="Fri, 25 Apr 2008 17:00:26 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3645&quot; title=&quot;Insert into selecting BLOB column twice leads to SQLException: Restore of a serializable or SQLData object of class error selecting from the table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3645&quot;&gt;&lt;del&gt;DERBY-3645&lt;/del&gt;&lt;/a&gt; may be the root cause of this issue.&lt;/p&gt;</comment>
                            <comment id="12727754" author="rhillegas" created="Mon, 6 Jul 2009 21:14:54 +0100"  >&lt;p&gt;Triaging for 10.5.2: assigned normal urgency, flagged as data corruption, noted that a repro is available.&lt;/p&gt;</comment>
                            <comment id="12731873" author="kristwaa" created="Thu, 16 Jul 2009 10:34:23 +0100"  >&lt;p&gt;Investigation shows that the data is actually written incorrectly to disk. Only the last piece (what&apos;s written on the last overflow page) is written for the second BLOB column.&lt;br/&gt;
The same SQLBlob object is used as the source for both columns on input. Store updates the stream for this dvd to be a RememberBytesInputStream. During the insertion of the first column, this stream detects that the underlying stream (RawToBinaryInputStream) has been exhausted, and closes itself.&lt;br/&gt;
When the stream is asked to fill itself for the insertion of the second column, it only has the last piece of the previous column available.&lt;/p&gt;

&lt;p&gt;I note that for the row trigger, the values are materialized and we don&apos;t run into this problem. However, materializing a LOB (multiple times) is a bad idea if it is big.&lt;/p&gt;

&lt;p&gt;It seems we have several issues open that all have the same &quot;root cause&quot;; reading multiple times from the same stream. The difference is the source; (a) a user stream or (b) a Derby store stream.&lt;/p&gt;

&lt;p&gt;(a) User stream.&lt;br/&gt;
In this case we don&apos;t have a choice - we have to somehow store the user stream and then re-read the stored data. I immediately see two options, differing in performance and possibly complexity: write the value to the temporary area and use this as the source for further work, or write the value once to the store and then read from store on subsequent actions.&lt;/p&gt;

&lt;p&gt;b) Derby stream.&lt;br/&gt;
Since materializing the value isn&apos;t a good thing for large objects, there are at least two remaining basic options; use of single stream with repositioning, or cloning of streams.&lt;br/&gt;
There are challenges with both. For the former we have to make sure we reposition whenever it is required, but not excessively. For the latter, we would like to avoid cloning unless it is required.&lt;/p&gt;

&lt;p&gt;Another thing that would be nice for large objects, is the ability to let columns share the same field value representation. This may introduce a lot more complex bookkeeping, it requires investigation - and for this reason it sounds like a version 11 feature to me.&lt;/p&gt;

&lt;p&gt;There are many things I don&apos;t know the details about in the store, so this comment is aimed at generating feedback!&lt;/p&gt;</comment>
                            <comment id="12832458" author="kristwaa" created="Thu, 11 Feb 2010 12:06:21 +0000"  >&lt;p&gt;Fixed by the combination of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4477&quot; title=&quot;Selecting / projecting a column whose value is represented by a stream more than once fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4477&quot;&gt;&lt;del&gt;DERBY-4477&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4520&quot; title=&quot;Refactor and extend data type cloning facilities&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4520&quot;&gt;&lt;del&gt;DERBY-4520&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Verified against trunk revision 980933, but it would be nice if the reporter verified the fix as well.&lt;/p&gt;

&lt;p&gt;I do not plan to back-port the fix(es) due to the rather signficant changes involved, but it may be technically possible.&lt;/p&gt;</comment>
                            <comment id="13685208" author="knutanders" created="Mon, 17 Jun 2013 10:19:20 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12394818">DERBY-3645</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12368833" name="DERBY_2349_Repro.java" size="5859" author="mamtas" created="Thu, 1 Nov 2007 17:41:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 1 Nov 2007 17:41:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23011</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0r4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38213</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>