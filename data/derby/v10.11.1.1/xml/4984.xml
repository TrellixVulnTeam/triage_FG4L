<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:20:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4984/DERBY-4984.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4984] ALTER TABLE DROP COLUMN may leave triggers invalid even if they are not using the column getting dropped.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4984</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;While doing testing for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4887&quot; title=&quot;ALTER TABLE DROP COLUMN leaves the dependent trigger invalid rather than drop it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4887&quot;&gt;&lt;del&gt;DERBY-4887&lt;/del&gt;&lt;/a&gt;, I found a case where ALTER TABLE DROP COLUMN will leave triggers in invalid state even if those triggers are not using the column getting dropped. eg&lt;br/&gt;
CREATE TABLE tab ( &lt;br/&gt;
       element_id INTEGER NOT NULL, &lt;br/&gt;
       altered_id VARCHAR(30) NOT NULL&lt;br/&gt;
); &lt;br/&gt;
insert into tab values(1,&apos;aa&apos;);&lt;br/&gt;
&amp;#8211; Create a trigger against the table &lt;br/&gt;
CREATE TRIGGER mytrig &lt;br/&gt;
 AFTER UPDATE OF altered_id ON tab &lt;br/&gt;
 REFERENCING NEW AS newt OLD AS oldt &lt;br/&gt;
 FOR EACH ROW MODE DB2SQL &lt;br/&gt;
  SELECT newt.altered_id from tab;&lt;br/&gt;
--Drop the first column in the table. This will cause the column positions to be recalculated within the table&lt;br/&gt;
alter table tab drop column element_id; &lt;br/&gt;
--mytrig is still looking for column altered_id at position 2 but drop column has changed it&apos;s position within the table to 1&lt;br/&gt;
update tab set altered_id=&apos;bb&apos;;&lt;/p&gt;

&lt;p&gt;As shown in the example above, table &quot;TAB&quot; only has 2 columns. The trigger &quot;MYTRIG&quot; uses the 2nd column in it&apos;s trigger action through the REFERENCING clause. During trigger action sql parsing, every column referenced through REFERENCING clause gets transformed into a reference to the column through it&apos;s column position in the trigger table(this change to look for columns based on their column positions rather than the name went in as revision 397959 with following commit comments &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1258&quot; title=&quot;Wrong value returned in a row trigger action statement if the table has column names that are identical when upper-cased.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1258&quot;&gt;&lt;del&gt;DERBY-1258&lt;/del&gt;&lt;/a&gt; Change the generated code for a new/old column in a row trigger to access columns by position and not name to avoid the case-insensitive name lookup specified by JDBC.) When in the script above, we drop the column in position 1, the trigger &quot;MYTRIG&quot; ends up becoming invalid because column being used in the trigger action is no more in column position 2.&lt;/p&gt;

&lt;p&gt;One possible solution is to regenerate the SPSDescriptor associated with the trigger action for all the triggers defined on the table whose column is getting dropped. We could be little smarter and only regenerate the SPSDescriptor for the triggers who use the REFERENCING clause. But we need to do more testing to make sure that triggers without REFERENCING clause do not get impacted by a drop of column which is not the last column of the table. This optimization of recognizing the right triggers may not be worth it since performance may not be that big a criteria for an ALTER TABLE DROP COLUMN which should be a rare operation in a production system.&lt;/p&gt;

&lt;p&gt;An interim solution to this problem is obviously to drop and recreate the triggers&lt;/p&gt;</description>
                <environment></environment>
        <key id="12496736">DERBY-4984</key>
            <summary>ALTER TABLE DROP COLUMN may leave triggers invalid even if they are not using the column getting dropped.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="mamtas">Mamta A. Satoor</reporter>
                        <labels>
                            <label>derby_backport_reject_10_5</label>
                            <label>derby_backport_reject_10_6</label>
                    </labels>
                <created>Tue, 25 Jan 2011 22:49:33 +0000</created>
                <updated>Mon, 17 Jun 2013 10:19:35 +0100</updated>
                            <resolved>Mon, 19 Mar 2012 17:04:29 +0000</resolved>
                                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.3.3.0</version>
                    <version>10.4.1.3</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                    <version>10.5.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.2.2</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12995100" author="dagw" created="Wed, 16 Feb 2011 01:08:05 +0000"  >&lt;p&gt;What happens presently? Does the trigger with the wrong code cause a crash down the line, or ?&lt;/p&gt;</comment>
                            <comment id="12995670" author="mamtas" created="Thu, 17 Feb 2011 05:11:24 +0000"  >&lt;p&gt;The changes committed for this jira can be backported all the way to 10.3&lt;/p&gt;</comment>
                            <comment id="12995671" author="mamtas" created="Thu, 17 Feb 2011 05:13:19 +0000"  >&lt;p&gt;The trigger with the wrong column number in it&apos;s generated trigger action will cause the trigger to error out when it gets fired next time around after ALTER TABLE DROP COLUMN. I have committed changes today for this jira which will fix the generated trigger action to use the correct column positions for columns used through the REFERENCING clause.&lt;/p&gt;</comment>
                            <comment id="13229386" author="kmarsden" created="Wed, 14 Mar 2012 17:19:48 +0000"  >&lt;p&gt;Reopen for 10.5 backport consideration. If working on the backport for this issue. Temporarily assign yourself and add a comment that you are working on it. When finished, reresolve with the new fix versions or label backport_reject_10_x as appropriate.&lt;/p&gt;</comment>
                            <comment id="13232703" author="mamtas" created="Mon, 19 Mar 2012 16:17:03 +0000"  >&lt;p&gt;If we do not have a customer request for backporting &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4984&quot; title=&quot;ALTER TABLE DROP COLUMN may leave triggers invalid even if they are not using the column getting dropped.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4984&quot;&gt;&lt;del&gt;DERBY-4984&lt;/del&gt;&lt;/a&gt;, then I would rather us not backport this jira. The primary reason is we did work on several trigger related jiras around the same time and some of those jiras depended on changes to system tables. Those different jiras worked on quite a few common classes and around the same code and hence I am worried that we might backport something which depends on codes which should not be backported. &lt;/p&gt;</comment>
                            <comment id="13685291" author="knutanders" created="Mon, 17 Jun 2013 10:19:35 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12500077">DERBY-5079</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12546430">DERBY-5654</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 16 Feb 2011 01:08:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24574</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0cmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35865</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>