<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:32:20 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1694/DERBY-1694.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1694] derbynet/testProperties.java hangs</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1694</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The testProperties.execCmd() is used to fork a JVM and not handle its&lt;br/&gt;
streams. This will cause problems, as indicated by the javadoc for Process.&lt;/p&gt;

&lt;p&gt;&quot;The parent process uses these streams to feed input to and get output&lt;br/&gt;
from the subprocess. Because some native platforms only provide limited&lt;br/&gt;
buffer size for standard input and output streams, failure to promptly&lt;br/&gt;
write the input stream or read the output stream of the subprocess may&lt;br/&gt;
cause the subprocess to block, and even deadlock&quot;&lt;/p&gt;</description>
                <environment>Windows XP  IBM 142 JRE</environment>
        <key id="12347965">DERBY-1694</key>
            <summary>derbynet/testProperties.java hangs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="skambha">Sunitha Kambhampati</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Aug 2006 05:36:23 +0100</created>
                <updated>Mon, 29 Jun 2009 23:58:02 +0100</updated>
                            <resolved>Fri, 22 Sep 2006 18:10:35 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12428036" author="djd" created="Tue, 15 Aug 2006 05:38:00 +0100"  >&lt;p&gt;Patch for review - I will commit after running more tests.&lt;/p&gt;</comment>
                            <comment id="12428146" author="johnemb" created="Tue, 15 Aug 2006 15:59:43 +0100"  >&lt;p&gt;Thank you for uploading the patch (derby1694diff.txt)! I spent a few minutes studying it, along with the existing code for testProperties.java, and it looks to me that this a clear improvement. I have not run any tests apart from testProperties.java in the DerbyNetClient framework on Solaris 10 x86, Sun JVM 1.5. &lt;/p&gt;

&lt;p&gt;The only thing I would like to mention is that if this patch gets committed as is, the JavaDoc for the execCmdDumpResults(...) method will (if I have understood the code correctly) no longer match its behavior:&lt;/p&gt;

&lt;p&gt;        /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Execute the given command and dump the results to standard out&lt;br/&gt;
	 *&lt;/li&gt;
	&lt;li&gt;@param args	command and arguments&lt;/li&gt;
	&lt;li&gt;@param wait  true =wait for completion&lt;/li&gt;
	&lt;li&gt;@exception Exception&lt;br/&gt;
	 */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With the patch, if wait == false, results will &lt;b&gt;not&lt;/b&gt; be dumped to standard out.&lt;/p&gt;</comment>
                            <comment id="12428151" author="djd" created="Tue, 15 Aug 2006 16:11:32 +0100"  >&lt;p&gt;Thanks John, I need to fix up the javadoc and coments in the code. However I think that before my patch that wait=true did not dump&lt;br/&gt;
output to standard out. It called execCmd which just forks the process, it doesn&apos;t perform the extra magic that execCmdDumpResults does &lt;br/&gt;
to display the output.&lt;/p&gt;</comment>
                            <comment id="12428160" author="johnemb" created="Tue, 15 Aug 2006 17:17:38 +0100"  >&lt;p&gt;Yes, that is true. I see now that the JavaDoc must have been wrong before applying the patch as well, since there was no parameter to execCmdDumpResults called wait, although there is a JavaDoc @param tag saying so.&lt;/p&gt;

&lt;p&gt;By the way, can someone help me understand why derbynet/testProperties_derby.properties sets some of the properties multiple times? It seems that the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-706&quot; title=&quot;Improve testing and increase code coverage for Network Server classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-706&quot;&gt;&lt;del&gt;DERBY-706&lt;/del&gt;&lt;/a&gt; only set them once, but that something went wrong when applying/committing the patch... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12428433" author="djd" created="Wed, 16 Aug 2006 17:44:48 +0100"  >&lt;p&gt;Applied patch but test still hangs. Seems the time to wait for  the server is too short. though wary of changing it if others are not seeing the hang.&lt;/p&gt;</comment>
                            <comment id="12430045" author="mikem" created="Wed, 23 Aug 2006 17:53:30 +0100"  >&lt;p&gt;I see this test hang against ibm1.4.2, when running full suite against XP on a laptop.  Since switching I have tried 4 times and it has hung everytime.  Looks like time bomb does not work either as I have come back to it hours after leaving tests running overnight to find it hanging.&lt;/p&gt;</comment>
                            <comment id="12430343" author="djd" created="Thu, 24 Aug 2006 22:47:36 +0100"  >&lt;p&gt;I also see this failing on IBM 1.4.2 JVM on linux, not a hang but a failure to connect to the server.&lt;/p&gt;</comment>
                            <comment id="12431732" author="mikem" created="Wed, 30 Aug 2006 23:28:20 +0100"  >&lt;p&gt;I have now seen the test hang against sun jdk 1.4.2 in a 10.2 client branch.  What I see outside is the test hangs all night.  I thought it might be firewall related, but the other tests seem to work, and I just saw the &lt;br/&gt;
hang with firewall completely disabled.  &lt;/p&gt;

&lt;p&gt;I am bumping the urgency as it is starting to affect my ability to commit changes into the codeline as I&lt;br/&gt;
lose a day every time I run&lt;br/&gt;
The last part in the tmp file is:&lt;br/&gt;
Start testProperties to test property priority&lt;br/&gt;
Testing derby.properties Port 1528&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl start&lt;br/&gt;
Successfully Connected&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown&lt;br/&gt;
Apache Derby Network Server - 10.2.1.2 beta shutdown at 2006-08-30 19:01:54.666&lt;br/&gt;
GMT&lt;br/&gt;
Testing System properties  Port 1529&lt;br/&gt;
-Dderby.drda.portNumber=1529 org.apache.derby.drda.NetworkServerControl start&lt;br/&gt;
Successfully Connected&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown -p 1529&lt;br/&gt;
Apache Derby Network Server - 10.2.1.2 beta shutdown at 2006-08-30 19:01:57.170&lt;br/&gt;
GMT&lt;br/&gt;
Testing command line option. Port 1530&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl start -p 1530&lt;br/&gt;
Successfully Connected&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown -p 1530&lt;br/&gt;
Apache Derby Network Server - 10.2.1.2 beta shutdown at 2006-08-30 19:01:59.773&lt;br/&gt;
GMT&lt;br/&gt;
Testing start server by specifying system properties without values&lt;br/&gt;
First shutdown server started on default port by the test harness&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown -p 1527&lt;br/&gt;
Apache Derby Network Server - 10.2.1.2 beta shutdown at 2006-08-30 19:02:01.576&lt;br/&gt;
GMT&lt;br/&gt;
-Dderby.drda.logConnections -Dderby.drda.traceAll -Dderby.drda.traceDirectory -D&lt;br/&gt;
derby.drda.keepAlive -Dderby.drda.timeSlice -Dderby.drda.host -Dderby.drda.portN&lt;br/&gt;
umber -Dderby.drda.minThreads -Dderby.drda.maxThreads -Dderby.drda.startNetworkS&lt;br/&gt;
erver -Dderby.drda.debug org.apache.derby.drda.NetworkServerControl start&lt;br/&gt;
java.lang.Exception: DRDA_NoIO.S:Could not connect to Derby Network Server on ho&lt;br/&gt;
st 127.0.0.1, port 1527.&lt;br/&gt;
    at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessag&lt;br/&gt;
eWork(NetworkServerControlImpl.java:2648)&lt;br/&gt;
    at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessag&lt;br/&gt;
e(NetworkServerControlImpl.java:1470)&lt;br/&gt;
    at org.apache.derby.impl.drda.NetworkServerControlImpl.setUpSocket(NetworkSe&lt;br/&gt;
rverControlImpl.java:2049)&lt;br/&gt;
    at org.apache.derby.impl.drda.NetworkServerControlImpl.ping(NetworkServerCon&lt;br/&gt;
trolImpl.java:827)&lt;br/&gt;
    at org.apache.derby.drda.NetworkServerControl.ping(NetworkServerControl.java&lt;br/&gt;
:312)&lt;br/&gt;
    at org.apache.derbyTesting.functionTests.tests.derbynet.testProperties.waitF&lt;br/&gt;
orStart(testProperties.java:218)&lt;br/&gt;
    at org.apache.derbyTesting.functionTests.tests.derbynet.testProperties.main(&lt;br/&gt;
testProperties.java:297)&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown -p 1527&lt;br/&gt;
Could not connect to Derby Network Server on host localhost, port 1527.&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown -p 1528&lt;br/&gt;
Could not connect to Derby Network Server on host localhost, port 1528.&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown -p 1529&lt;br/&gt;
Could not connect to Derby Network Server on host localhost, port 1529.&lt;br/&gt;
org.apache.derby.drda.NetworkServerControl shutdown -p 1530&lt;br/&gt;
Could not connect to Derby Network Server on host localhost, port 1530.&lt;/p&gt;</comment>
                            <comment id="12431739" author="djd" created="Wed, 30 Aug 2006 23:54:29 +0100"  >&lt;p&gt;Just realized I didn&apos;t put all the info I learnt here.&lt;/p&gt;

&lt;p&gt;Increasing the wait time for booting the server makes the test pass.&lt;/p&gt;

&lt;p&gt;The hang seems to be due to the cleanup code when one of the waits for  server to start fails.&lt;br/&gt;
The code then tries to shutdown all possible servers it started, the code is around line 322&lt;br/&gt;
with this comment&lt;/p&gt;

&lt;p&gt;			// If something went wrong,&lt;br/&gt;
			// make sure all these servers are shutdown&lt;/p&gt;

&lt;p&gt;Not sure what is causing the hang though.&lt;/p&gt;</comment>
                            <comment id="12433188" author="mikem" created="Thu, 7 Sep 2006 19:20:24 +0100"  >&lt;p&gt;I have not seen this test fail since I increased the timeout as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1810&quot; title=&quot;derbynet/testProperties fails when timeout for successful ping is low.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1810&quot;&gt;&lt;del&gt;DERBY-1810&lt;/del&gt;&lt;/a&gt;.  Is this test still failing for anyone since then?&lt;br/&gt;
In a  little debugging of this I think the problem might be related to OS port resources being freed  from the previous startup/shutdown of the network server on the default port 1527.  &lt;/p&gt;

&lt;p&gt;There is definitely as separate test issue here, in that once the connect fails the test hangs - but I believe that is purely a test issue and not a product issue.  At least for me tests now run so I would not hold up 10.2 for this issue.  &lt;/p&gt;</comment>
                            <comment id="12433242" author="rhillegas" created="Thu, 7 Sep 2006 22:29:26 +0100"  >&lt;p&gt;Degrading the urgency of this issue. If this is just an artifact of the testing machinery, then this should not block the 10.2 release.&lt;/p&gt;</comment>
                            <comment id="12435129" author="skambha" created="Fri, 15 Sep 2006 22:38:28 +0100"  >&lt;p&gt;I was looking at the testProperties issue that caused problems because of test hang. The test doesnt hang in my environment but I thought I would look to see why the test didnt timeout. &lt;/p&gt;

&lt;p&gt;I found couple of issues here:&lt;br/&gt;
0. The testProperties.java and several networkserver tests exec new processes to start server, test properties,shutdown server etc. In some cases, we wait to capture the output from the subprocess that is started. ProcessStreamResult is used for this purpose.  ProcessStreamResult is part of the harness (see org.apache.derbyTesting.functionTests.harness.ProcessStreamResult) and it starts a thread to read data from the process&apos;s stream and writes it out. Once EOS (-1) is reached, the thread exits after doing a notifyAll. &lt;/p&gt;

&lt;p&gt;1. ProcessStreamResult.Wait() does not work with the timeout case. I think the original intention of the method that takes the timeout was to force the thread to stop, once the timeout period has elapsed. The method Wait() does not handle this case.&lt;br/&gt;
2. On timeout, the myThread needs to stop its work. The run() method does not handle this case.&lt;br/&gt;
3. testProperties test does not make use of the ProcessStreamResult timeout mechanism.  &lt;br/&gt;
4. Process&apos;s are exec&apos;d in the tests and they are not destroyed within a timeout period. The network server tests start server using Process, and then cleanup by shutting them down.  It will all work ok, if no deadlock or blocking of process&apos;s occur. It seems to me though, that we should have a way to destroy the processes that are &lt;br/&gt;
started as part of each test given a timeout period.  Each test must learn to do the cleanup when it leaves and the test has knowledge of all the sub-processes that it has exec&apos;d.  The current test harness has a class TimedProcess which could work. &lt;/p&gt;

&lt;p&gt;In the spirit of incremental development, I am attaching a patch(derby1694.p2.diff.txt and corresponding stat file - derby1694.p2.stat.txt)  that fixes problems 1,2 and 3.  I think #4 can be handled as a separate issue/patch.&lt;/p&gt;

&lt;p&gt;This patch &lt;br/&gt;
&amp;#8211; fixes the timeout handling in ProcessStreamResult.  Instance variable &apos;interrupted&apos; is a flag to indicate if a timeout has occurred or if the thread&apos;s work has been interrupted in between.  The flag &apos;finished&apos; indicates whether  the work has been finished by the thread. Changes are in Wait() method to make use of wait(timeoutms) if a timeout is specified in ProcessStreamResult. If timeout time has elapsed, then the interrupted flag is set to true.&lt;br/&gt;
&amp;#8211; Adds condition in the run() method to check if interrupted is true. If so, the thread will stop its work and leave.&lt;br/&gt;
&amp;#8211; correctly return if the thread&apos;s work was interrupted either because of a timeout or if it was interrupted.&lt;br/&gt;
&amp;#8211; Make use of the ProcessStreamResult with a timeout setting of 2 minutes in testProperties test. Note, the timeout handling only comes into effect when ProcessStreamResult.Wait() method is called.&lt;/p&gt;

&lt;p&gt;other notes:&lt;br/&gt;
&amp;#8211; when you run a test, the suite property for timeout does not get picked up. I think this is intentional behavior. &lt;br/&gt;
&amp;#8211; Issues mentioned above are not specific to just testProperties but exist for other networkserver tests. There are a total of 7 files in derbynet that make use of this.  &lt;/p&gt;

&lt;p&gt;I&apos;d like feedback on this patch. If this approach seems ok, then we can make these changes to the 6 other networkserver tests also.&lt;/p&gt;

&lt;p&gt;I ran derbyall on ibm142/linux and no new failures. Two tests failed, blobclob4BLOB(derby-1844) and the known DerbyNetAutoStart.   These 2 failures are not related to these changes. &lt;/p&gt;

&lt;p&gt;Thanks. &lt;/p&gt;</comment>
                            <comment id="12435130" author="skambha" created="Fri, 15 Sep 2006 22:39:21 +0100"  >&lt;p&gt;derby1694.p2.diff.txt patch available for review. &lt;/p&gt;</comment>
                            <comment id="12435505" author="mikem" created="Mon, 18 Sep 2006 16:57:32 +0100"  >&lt;p&gt;I ran full set of  successful tests against ibm 1.4.2 with the derby1694.p2.diff.txt.  The changes as described seem like an improvement to the current tests so I would be happy to commit these, let me know if you want this first patch committed or if I should wait for other comments/changes to other tests.&lt;br/&gt;
I welcome any incremental improvement to these network server tests which often intermittently fail in &lt;br/&gt;
my environment.  This test run was actually first in my last 6 or 7 that had no network server intermittent failures &amp;#8211; probably more related to my particular netork than this patch.  &lt;/p&gt;</comment>
                            <comment id="12435629" author="skambha" created="Tue, 19 Sep 2006 04:08:05 +0100"  >&lt;p&gt;Thanks Mike for looking at the derby1694.p2.diff.txt.  Yes, I would like this patch to be committed. &lt;/p&gt;</comment>
                            <comment id="12435657" author="mikem" created="Tue, 19 Sep 2006 06:10:01 +0100"  >&lt;p&gt;I committed the  derby1694.p2.diff.txt patch to the trunk.  It should be merged into 10.2.&lt;/p&gt;</comment>
                            <comment id="12436906" author="skambha" created="Fri, 22 Sep 2006 17:44:52 +0100"  >&lt;p&gt;The derby1694.p2.diff.txt is merged into 10.2 with ricks&apos;s mega merge &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=448961&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=448961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So unchecking the patch available flag. &lt;/p&gt;</comment>
                            <comment id="12436924" author="skambha" created="Fri, 22 Sep 2006 18:10:35 +0100"  >&lt;p&gt;For other improvements identified here, I have opened &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1878&quot; title=&quot;Improve error handling in network server tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1878&quot;&gt;&lt;del&gt;DERBY-1878&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="12551399" author="fuzzylogic" created="Thu, 13 Dec 2007 09:05:09 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12349135">DERBY-1810</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12350524">DERBY-1878</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12340970" name="derby1694.p2.diff.txt" size="7006" author="skambha" created="Fri, 15 Sep 2006 22:38:28 +0100"/>
                            <attachment id="12340971" name="derby1694.p2.stat.txt" size="1478" author="skambha" created="Fri, 15 Sep 2006 22:38:28 +0100"/>
                            <attachment id="12338855" name="derby1694diff.txt" size="3188" author="djd" created="Tue, 15 Aug 2006 05:38:00 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 15 Aug 2006 14:59:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22644</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0vjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38929</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>