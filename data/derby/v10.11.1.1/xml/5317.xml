<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5317/DERBY-5317.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5317]  NullPointerException in org.apache.derby.client.net.Request.sendBytes()  with client</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5317</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Investigating &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5308&quot; title=&quot;Investigate if largeData/LobLimits.java  can be run for client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5308&quot;&gt;&lt;del&gt;DERBY-5308&lt;/del&gt;&lt;/a&gt;, I found that the LobLimits.java test run with client fails with a NullPointerException.&lt;/p&gt;

&lt;p&gt;END setup&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #1  -insertClob of size = 2147483647&lt;br/&gt;
Rows inserted with clob of size (2147483647) = 2&lt;br/&gt;
========================================&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #2 - SELECT CLOB of size = 2147483647&lt;br/&gt;
Matched rows selected with clob of size(2147483647) =1&lt;br/&gt;
========================================&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #3 - SELECT CLOB of size = 2147483647&lt;br/&gt;
Matched rows selected with clob of size(2147483647) =1&lt;br/&gt;
========================================&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #4 - select and then update clob of size= 2147483647 - Uses setClob api&lt;br/&gt;
FAIL &amp;#8211; Unexpected exception:&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.client.net.Request.sendBytes(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.Request.flushScalarStreamSegment(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.Request.padScalarStreamForError(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writePlainScalarStream(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writeScalarStream(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writeScalarStream(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementRequest.buildEXTDTA(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementRequest.writeExecute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.net.NetPreparedStatement.writeExecute_(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.writeExecute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.flowExecute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeUpdateX(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeUpdate(Unknown Source)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.largedata.LobLimits.selectUpdateClob(LobLimits.java:115&lt;br/&gt;
7)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.largedata.LobLimits.clobTests(LobLimits.java:313)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.largedata.LobLimits.runTests(LobLimits.java:177)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.largedata.LobLimits.main(LobLimits.java:151)&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #12.1  -insertClob of size = 104857600&lt;br/&gt;
NEGATIVE TEST - Expected Exception:&lt;br/&gt;
EXPECTED SQL Exception: (08003) No current connection.&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #12.2 - SELECT CLOB of size = 104857600&lt;br/&gt;
FAIL &amp;#8211; Unexpected exception:&lt;br/&gt;
java.sql.SQLNonTransientConnectionException: No current connection.&lt;br/&gt;
        at org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.setInt(Unknown Source)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.largedata.LobLimits.selectClob(LobLimits.java:1007)&lt;/p&gt;


&lt;p&gt;In the derby.log I see&lt;/p&gt;

&lt;p&gt;derby.system.home=/local0/kmarsden/repro/largeData/testtrunkdnc/DerbyNetClient/LobLimits&lt;br/&gt;
Database Class Loader started - derby.database.classpath=&apos;&apos;&lt;br/&gt;
Tue Jul 05 17:50:01 PDT 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;DRDAConnThread_11,5,main&amp;#93;&lt;/span&gt; (DATABASE = wombat), (DRDAID = .-580681567053183&lt;br/&gt;
269&lt;/p&gt;
{2}), Execution failed because of a Distributed Protocol Error:  DRDA_Proto_SYNTAXRM; CODPNT arg  = 200d; E&lt;br/&gt;
rror Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
Tue Jul 05 17:50:01 PDT 2011 : Execution failed because of a Distributed Protocol Error:  DRDA_Proto_SYNTAXRM;&lt;br/&gt;
 CODPNT arg  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException: Execution failed because of a Distributed Protocol Error:  D&lt;br/&gt;
RDA_Proto_SYNTAXRM; CODPNT arg  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enable&lt;br/&gt;
d client?&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.invalidCodePoint(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;br/&gt;
Tue Jul 05 17:50:01 PDT 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;DRDAConnThread_11,5,main&amp;#93;&lt;/span&gt; (DATABASE = wombat), (DRDAID = .-580681567053183&lt;br/&gt;
269{2}
&lt;p&gt;), Execution failed because of a Distributed Protocol Error:  DRDA_Proto_SYNTAXRM; CODPNT arg  = 200d; E&lt;br/&gt;
rror Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
Tue Jul 05 17:50:01 PDT 2011 : Execution failed because of a Distributed Protocol Error:  DRDA_Proto_SYNTAXRM;&lt;br/&gt;
 CODPNT arg  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException: Execution failed because of a Distributed Protocol Error:  D&lt;br/&gt;
RDA_Proto_SYNTAXRM; CODPNT arg  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enable&lt;br/&gt;
d client?&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.invalidCodePoint(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;br/&gt;
----------------------------------------------------------------&lt;br/&gt;
Tue Jul 05 17:50:07 PDT 2011: Shutting down Derby engine&lt;br/&gt;
----------------------------------------------------------------&lt;br/&gt;
Tue Jul 05 17:50:07 PDT 2011:&lt;/p&gt;

&lt;p&gt;To run the test, you have to remove largeData from DerbyNetClient.exclude and run&lt;br/&gt;
java -Dframework=DerbyNetClient org.apache.derbyTesting.functionTests.harness.RunTest  org.apache.derbyTesting.functionTests.tests.lageData.LobLimits.&lt;br/&gt;
It took about 3.5 hours to occur.&lt;/p&gt;

&lt;p&gt;I will work on a smaller reproduction.&lt;/p&gt;

&lt;p&gt;                                                                                            5,9           36%&lt;/p&gt;</description>
                <environment></environment>
        <key id="12513038">DERBY-5317</key>
            <summary> NullPointerException in org.apache.derby.client.net.Request.sendBytes()  with client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dyret">Dyre Tjeldvoll</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                            <label>derby_triage10_11</label>
                    </labels>
                <created>Wed, 6 Jul 2011 22:17:01 +0100</created>
                <updated>Wed, 21 Jan 2015 00:22:56 +0000</updated>
                            <resolved>Mon, 3 Mar 2014 18:34:47 +0000</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13061482" author="kmarsden" created="Thu, 7 Jul 2011 19:48:18 +0100"  >&lt;p&gt;Here is a short running reproduction for the issue.&lt;br/&gt;
It is just an excerpt from LobLimits.java and uses just 2MB Clobs, so the problem is not associated with large data but rather the case that is being tested, which is described as:&lt;/p&gt;

&lt;p&gt;  /*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Basically this test will do an update using setClob api -&lt;/li&gt;
	&lt;li&gt;select row from clobtbl and then update a row in clobtbl&lt;/li&gt;
	&lt;li&gt;and verify updated data in clobtbl&lt;br/&gt;
    */    &lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;Here is the output. The server is started by the program and  output goes to the console so is here as well:&lt;br/&gt;
$java Repro5317&lt;/p&gt;

&lt;p&gt;Thu Jul 07 11:39:02 PDT 2011 : Apache Derby Network Server - 10.9.0.0 alpha - (1&lt;br/&gt;
143485) started and ready to accept connections on port 1527&lt;br/&gt;
========================================&lt;br/&gt;
START insert 2M clob  -insertClob of size = 2097152&lt;br/&gt;
Insert Clob (2097152) rows= 2 = 3188&lt;br/&gt;
Rows inserted with clob of size (2097152) = 2&lt;br/&gt;
========================================&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #4 - select and then update clob of size= 2097152 - Uses setClob&lt;br/&gt;
api&lt;br/&gt;
Thu Jul 07 11:39:11 PDT 2011 : Execution failed because of a Distributed Protoco&lt;br/&gt;
l Error:  DRDA_Proto_SYNTAXRM; CODPNT arg  = 200d; Error Code Value = 1d. Plaint&lt;br/&gt;
ext connection attempt from an SSL enabled client?&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException: Execution failed because of a&lt;br/&gt;
Distributed Protocol Error:  DRDA_Proto_SYNTAXRM; CODPNT arg  = 200d; Error Code&lt;br/&gt;
 Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(DRDAConnThrea&lt;br/&gt;
d.java:517)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.invalidCodePoint(DRDAConnTh&lt;br/&gt;
read.java:8205)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAC&lt;br/&gt;
onnThread.java:4324)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThre&lt;br/&gt;
ad.java:4133)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThr&lt;br/&gt;
ead.java:1021)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:294&lt;br/&gt;
)&lt;br/&gt;
Thu Jul 07 11:39:11 PDT 2011 : Execution failed because of a Distributed Protoco&lt;br/&gt;
l Error:  DRDA_Proto_SYNTAXRM; CODPNT arg  = 200d; Error Code Value = 1d. Plaint&lt;br/&gt;
ext connection attempt from an SSL enabled client?&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException: Execution failed because of a&lt;br/&gt;
Distributed Protocol Error:  DRDA_Proto_SYNTAXRM; CODPNT arg  = 200d; Error Code&lt;br/&gt;
 Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(DRDAConnThrea&lt;br/&gt;
d.java:517)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.invalidCodePoint(DRDAConnTh&lt;br/&gt;
read.java:8205)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAC&lt;br/&gt;
onnThread.java:4324)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThre&lt;br/&gt;
ad.java:4133)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThr&lt;br/&gt;
ead.java:1021)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:294&lt;br/&gt;
)&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.client.net.Request.sendBytes(Request.java:1212)&lt;br/&gt;
        at org.apache.derby.client.net.Request.flushScalarStreamSegment(Request.&lt;br/&gt;
java:604)&lt;br/&gt;
        at org.apache.derby.client.net.Request.padScalarStreamForError(Request.j&lt;br/&gt;
ava:660)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writePlainScalarStream(Request.ja&lt;br/&gt;
va:323)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writeScalarStream(Request.java:24&lt;br/&gt;
7)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writeScalarStream(Request.java:50&lt;br/&gt;
0)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementRequest.buildEXTDTA(NetStatem&lt;br/&gt;
entRequest.java:1043)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementRequest.writeExecute(NetState&lt;br/&gt;
mentRequest.java:152)&lt;br/&gt;
        at org.apache.derby.client.net.NetPreparedStatement.writeExecute_(NetPre&lt;br/&gt;
paredStatement.java:174)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.writeExecute(PreparedSta&lt;br/&gt;
tement.java:1800)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStat&lt;br/&gt;
ement.java:2030)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeUpdateX(PreparedS&lt;br/&gt;
tatement.java:417)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedSt&lt;br/&gt;
atement.java:403)&lt;br/&gt;
        at Repro5317.selectUpdateClob(Repro5317.java:163)&lt;br/&gt;
        at Repro5317.main(Repro5317.java:35)&lt;/p&gt;


&lt;p&gt;I ran with IBM 1.6.&lt;/p&gt;

&lt;p&gt;java version &quot;1.6.0&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build pwi3260sr9fp1-20110208_03(SR9 FP1))&lt;br/&gt;
IBM J9 VM (build 2.4, JRE 1.6.0 IBM J9 2.4 Windows XP x86-32 jvmwi3260sr9-201102&lt;br/&gt;
03_74623 (JIT enabled, AOT enabled)&lt;br/&gt;
J9VM - 20110203_074623&lt;br/&gt;
JIT  - r9_20101028_17488ifx3&lt;br/&gt;
GC   - 20101027_AA)&lt;br/&gt;
JCL  - 20110203_01&lt;/p&gt;</comment>
                            <comment id="13061528" author="kmarsden" created="Thu, 7 Jul 2011 20:35:01 +0100"  >&lt;p&gt;It appears this was a regression with 10.3.1.4.  The small test case passes with 10.2.2.0 and the latest on the 10.2 and 10.1 branches.  10.3.1.4 introduced  lob locators,  &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-208&quot; title=&quot;Add support to retrieve lobs for Network Server by locator rather than matierializing the LOB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-208&quot;&gt;&lt;del&gt;DERBY-208&lt;/del&gt;&lt;/a&gt; and more specifically for clobs &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2604&quot; title=&quot;Implement Clob support for locators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2604&quot;&gt;&lt;del&gt;DERBY-2604&lt;/del&gt;&lt;/a&gt;, so that might be a likely suspect.  I could not verify the exact checkin  for the regression.  I tried synching back to 535318 just before the checkin below but had trouble building.&lt;/p&gt;

&lt;p&gt;	#535319 	Fri May 04 16:32:39 UTC 2007 	rhillegas 	&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2604&quot; title=&quot;Implement Clob support for locators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2604&quot;&gt;&lt;del&gt;DERBY-2604&lt;/del&gt;&lt;/a&gt;: Commit Naryayan&apos;s ClobLocatorWork_v1.diff, adding locator support to clobs. &lt;/p&gt;


</comment>
                            <comment id="13061613" author="kmarsden" created="Thu, 7 Jul 2011 22:44:06 +0100"  >&lt;p&gt;I will take a look at this and see if it is something simple. I Since it is a regression it would be good to get it into 10.8.2.&lt;/p&gt;</comment>
                            <comment id="13061656" author="kmarsden" created="Fri, 8 Jul 2011 00:10:46 +0100"  >&lt;p&gt;Looking at the traces on 10.2 and trunk I see the following:&lt;/p&gt;

&lt;p&gt;In the 10.2 trace on execution of the prepared update statement with the stream selected from the table we have:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Time:1310077705922&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread:main&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Clob@4d7784be&amp;#93;&lt;/span&gt; getCharacterStream () called&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Time:1310077705922&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread:main&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Clob@4d7784be&amp;#93;&lt;/span&gt; getCharacterStream () returned java.io.StringReader@459484be&lt;/p&gt;

&lt;p&gt;Followed by an EXCSQLSTT, SQLDTA and then EXTDTA to send the data.  I believe in this case the entire Clob has been materialized on the client.&lt;/p&gt;


&lt;p&gt;With trunk we get an UpdateSensitiveClobLocater reader on the select instead of a regular StringReader:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Time:1310076968203&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread:main&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Clob@19981998&amp;#93;&lt;/span&gt; getCharacterStream () called&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Time:1310076968203&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread:main&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Clob@19981998&amp;#93;&lt;/span&gt; getCharacterStream () returned org.apache.derby.client.am.UpdateSensitiveClobLocatorReader@dfe0dfe&lt;/p&gt;

&lt;p&gt;followed by EXCSQLSTT, SQLDTA and then instead of the  EXTDTA a stored procedure call is attempted:&lt;br/&gt;
derby]        SEND BUFFER: PRPSQLSTT              (ASCII)           (EBCDIC)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt;        0 1 2 3 4 5 6 7   8 9 A B C D E F   0123456789ABCDEF  0123456789ABCDEF&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0000   0068D05100010062  200D005E21130026  .h.Q...b ..^!..&amp;amp;  ..}........;....&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0010   776F6D6261743B74  7261636546696C65  wombat;traceFile  .?_./..../....%.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0020   3D74726163652E6F  75743B6372656174  =trace.out;creat  .../...?....../.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0030   653D747275650012  4E554C4C49442020  e=true..NULLID    ........+.&amp;lt;&amp;lt;....&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0040   2020202020202020  202000125359534C            ..SYSL  ...............&amp;lt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0050   4E30303020202020  2020202020205359  N000          SY  +...............&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0060   534C564C30310004                    SLVL01..          .&amp;lt;.&amp;lt;....        &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt;        SEND BUFFER: SQLSTT                 (ASCII)           (EBCDIC)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0000   0039D04300010033  241400000000293F  .9.C...3$.....)?  ..}.............&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0010   203D2043414C4C20  53595349424D2E43   = CALL SYSIBM.C  .....&amp;lt;&amp;lt;......(..&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0020   4C4F424745545355  42535452494E4728  LOBGETSUBSTRING(  &amp;lt;|...........+..&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;derby&amp;#93;&lt;/span&gt; 0030   3F2C203F2C203F29  FF                ?, ?, ?).         .........       &lt;/p&gt;


&lt;p&gt;What seems to be happening is that we are all set up to stream the parameter data and that is what the server is expecting, but in order to get that  data from the stream  we need to make this stored procedure call, so we are stuck. Any thoughts on how to resolve this?  I don&apos;t see how we could interrupt the sending of the data to retrieve more with a stored procedure call. The current traces are too large to attach.  I will scale down the reproduction more to attach them.&lt;/p&gt;



</comment>
                            <comment id="13061688" author="kmarsden" created="Fri, 8 Jul 2011 01:09:23 +0100"  >&lt;p&gt;Here is an updated repro and the trace  file output with the clob at 31K.  It fails at even smaller sizes like 2K  but with a different error.&lt;/p&gt;</comment>
                            <comment id="13062081" author="kmarsden" created="Fri, 8 Jul 2011 18:52:00 +0100"  >&lt;p&gt;I think the description of the test, that it uses the setClob() api is incorrect.  It actually uses getClob() to get the Clob, as value, but then passes value.getCharacterStream() to the parameter.&lt;br/&gt;
       psUpd.setCharacterStream(1, value.getCharacterStream(), (int) l);&lt;/p&gt;

&lt;p&gt;If I change the test to actually use setClob,  changing the above statement to:&lt;br/&gt;
       psUpd.setClob(1, value);&lt;/p&gt;

&lt;p&gt;The statement completes, presumably sending the locator as the parameter instead of having to network the stream both directions (I need to double check that this is what is happening).&lt;/p&gt;


&lt;p&gt;The only simple solution I can think of  if an unmaterialized stream is passed as a parameter is one that I am loathe to implement.   That would be that if an unmaterialized character stream or binary stream are set as a parameter, that we materialize it as soon as the parameter is set, before starting execution of the statement.  Since we only have one channel of communication between client and server, we just can&apos;t stream the value from the server and back to it at the same time.&lt;/p&gt;
</comment>
                            <comment id="13065232" author="kmarsden" created="Thu, 14 Jul 2011 14:08:06 +0100"  >&lt;p&gt;A good solution to this issue is not clear to me without materializing the  stream parameter  so unassigning myself from this issue.&lt;/p&gt;

&lt;p&gt;Users can work around the issue by using setClob instead of setCharacterStream()  on clob.getCharacterStream()&lt;/p&gt;</comment>
                            <comment id="13066279" author="kmarsden" created="Fri, 15 Jul 2011 23:40:19 +0100"  >&lt;p&gt;With revision 1147335 this can be reproduced by removing the if(usingDerbyNetClient()  LobLimitsTest and running largedata.LobLimitsLiteTest in the following code:&lt;/p&gt;

&lt;p&gt;       // &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5317&quot; title=&quot; NullPointerException in org.apache.derby.client.net.Request.sendBytes()  with client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5317&quot;&gt;&lt;del&gt;DERBY-5317&lt;/del&gt;&lt;/a&gt; cannot use setCharacterStream with value from&lt;br/&gt;
        // Clob.getCharacterStream because server will try to stream&lt;br/&gt;
        // lob to and from server at the same time. setClob can be&lt;br/&gt;
        // used as a work around.&lt;br/&gt;
        if (!usingDerbyNetClient()) &lt;/p&gt;
{
            PreparedStatement psUpd =
                    conn.prepareStatement(&quot;update CLOBTBL set content=?, &quot; +
                            &quot;dlen =? where id = ?&quot;);
            psUpd.setCharacterStream(1, value.getCharacterStream(), (int) l);
            psUpd.setLong(2, l);
            psUpd.setInt(3, updateId);

            assertEquals(1, psUpd.executeUpdate());
            psUpd.close();
        }

</comment>
                            <comment id="13210413" author="kmarsden" created="Fri, 17 Feb 2012 17:53:12 +0000"  >&lt;p&gt;Triaged for 10.9.  Keeping urgency as urgent as it is a client crash and has a simple reproduction.&lt;/p&gt;

&lt;p&gt;I confirmed the issue reproduces with Repro5317.java  attached and very quickly (in case someone has been shying away from this issue because I mentioned it takes a long time to reproduce with LobLimitsTest.&lt;/p&gt;


&lt;p&gt;$ java Repro5317&lt;br/&gt;
Fri Feb 17 09:49:50 PST 2012 : Apache Derby Network Server - 10.9.0.0 alpha - (1242867M) started and ready to accept con&lt;br/&gt;
nections on port 1527&lt;br/&gt;
========================================&lt;br/&gt;
START insert  clob  -insertClob of size = 31744&lt;br/&gt;
Insert Clob (31744) rows= 2 = 382&lt;br/&gt;
Rows inserted with clob of size (31744) = 2&lt;br/&gt;
========================================&lt;br/&gt;
========================================&lt;br/&gt;
START ClobTest #4 - select and then update clob of size= 31744 - Uses setClob api&lt;br/&gt;
Fri Feb 17 09:49:52 PST 2012 : Execution failed because of a Distributed Protocol Error:  DRDA_Proto_SYNTAXRM; CODPNT ar&lt;br/&gt;
g  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException: Execution failed because of a Distributed Protocol Error:  DRDA_Proto_&lt;br/&gt;
SYNTAXRM; CODPNT arg  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(DRDAConnThread.java:537)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.invalidCodePoint(DRDAConnThread.java:8295)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:4366)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:4175)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:1063)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:295)&lt;br/&gt;
Fri Feb 17 09:49:52 PST 2012 : Execution failed because of a Distributed Protocol Error:  DRDA_Proto_SYNTAXRM; CODPNT ar&lt;br/&gt;
g  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException: Execution failed because of a Distributed Protocol Error:  DRDA_Proto_&lt;br/&gt;
SYNTAXRM; CODPNT arg  = 200d; Error Code Value = 1d. Plaintext connection attempt from an SSL enabled client?&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(DRDAConnThread.java:537)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.invalidCodePoint(DRDAConnThread.java:8295)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:4366)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:4175)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:1063)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:295)&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.client.net.Request.sendBytes(Request.java:1212)&lt;br/&gt;
        at org.apache.derby.client.net.Request.flushScalarStreamSegment(Request.java:604)&lt;br/&gt;
        at org.apache.derby.client.net.Request.padScalarStreamForError(Request.java:660)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writePlainScalarStream(Request.java:323)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writeScalarStream(Request.java:247)&lt;br/&gt;
        at org.apache.derby.client.net.Request.writeScalarStream(Request.java:500)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementRequest.buildEXTDTA(NetStatementRequest.java:1042)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementRequest.writeExecute(NetStatementRequest.java:151)&lt;br/&gt;
        at org.apache.derby.client.net.NetPreparedStatement.writeExecute_(NetPreparedStatement.java:174)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.writeExecute(PreparedStatement.java:1806)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2036)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeUpdateX(PreparedStatement.java:417)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedStatement.java:403)&lt;br/&gt;
        at Repro5317.selectUpdateClob(Repro5317.java:170)&lt;br/&gt;
        at Repro5317.main(Repro5317.java:42)&lt;/p&gt;

&lt;p&gt;kmarsden@IBM-JDPM42DBIO2 ~/repro/derby-5317&lt;/p&gt;























&lt;p&gt;think Urgent is correct as &lt;/p&gt;</comment>
                            <comment id="13699030" author="kmarsden" created="Wed, 3 Jul 2013 15:39:24 +0100"  >&lt;p&gt;Confirmed this still reproduces on trunk 10.11&lt;/p&gt;</comment>
                            <comment id="13760642" author="dyret" created="Fri, 6 Sep 2013 22:20:26 +0100"  >&lt;p&gt;Linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2017&quot; title=&quot;Client driver can insert and commit partial data when a LOB stream throws IOException or does not match the specified length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2017&quot;&gt;&lt;del&gt;DERBY-2017&lt;/del&gt;&lt;/a&gt; which added an extra message back to the server in case of certain errors to ensure that LOB-transactions were not &quot;partly&quot; committed. In this case the client attempts to send the extra message after a DisconnectException has been thrown. This does not work since the DisconnectException constructor will close and null the agent&apos;s stream objects, so that writing the extra message triggers an NPE when attempting to access the output stream.&lt;/p&gt;</comment>
                            <comment id="13760665" author="dyret" created="Fri, 6 Sep 2013 22:41:30 +0100"  >&lt;p&gt;There are a couple of issues here: &lt;/p&gt;

&lt;p&gt;1) That the DisconnectException&apos;s constructor closes down the connection, so that the connection is closed even if the exception is never thrown. And any caller wanting to catch this exception cannot prevent the connection from being closed.&lt;/p&gt;

&lt;p&gt;2) It is not clear to me that Reply.doSyntaxrmSemantics() should throw a DisconnectException at all. If it only has detected a protocol error it would make more sense to throw some other exception and leave the connection intact. That would make it possible to send a cleanup message, such as the one added in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2017&quot; title=&quot;Client driver can insert and commit partial data when a LOB stream throws IOException or does not match the specified length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2017&quot;&gt;&lt;del&gt;DERBY-2017&lt;/del&gt;&lt;/a&gt;, to the server as part of handling the exception. &lt;/p&gt;</comment>
                            <comment id="13761798" author="dyret" created="Mon, 9 Sep 2013 13:31:55 +0100"  >&lt;p&gt;I think it is possible (but ugly) to avoid the NPE by checking if the output stream is null, and then just rethrow the IOException from the Reader. When doing that you&apos;re left with the &quot;Bad codepoint&quot; error thrown by the server when encountering a PRPSQLSTT cp when reading the EXTDTA objects in the prepare message. That is better than getting an NPE, but it is still difficult to identify the cause of the problem (calling setClob() with a Reader that is a really an UpdateSensitiveClobLocatorReader() tied to the same agent as the ps). &lt;/p&gt;

&lt;p&gt;I think a reasonable first step would be to throw (some form of) UnsupportedException when attempting to use setX() with a Locator-backed Reader/Stream value. If the user is willing to incur the overhead of materializing the object in the client, they can always force that by reading the lob into a buffer and use setX with a Reader/Stream referencing that buffer.&lt;/p&gt;

&lt;p&gt;To make this efficient I guess we need to identify Locator-backed Readers/streams and somehow bind the locator value in place of the Reader/Stream, and only convert the locator value into the actual Reader/Stream value when required on the server. Don&apos;t know if that is feasible...&lt;/p&gt;</comment>
                            <comment id="13765535" author="dyret" created="Thu, 12 Sep 2013 16:33:35 +0100"  >&lt;p&gt;I have concluded that identifying Locator-based Readers/Streams is not really possible since the argument passed to setX() may be wrapped in any number of non-Locator Streams/Readers. So I think we must allow such values to be set, and instead intercept their use when generating the DRDA commands for executing the PS. To me it looks like we can trap this situation in Request.initialize() by detecting an un-ended writeChain for which data has been sent to the server. But as we are using the Stream interface we cannot signal this in any way other than throwing an exception. It is not really feasible to use a checked exception for this as it will be wrapped in SqlExceptions and IOExceptions on its way up the callstack, so I plan to throw a (new) subclass of Error and then catching that at the point where we read the Lob-parameter from the top-level stream and then throw a more informative checked exception.&lt;/p&gt;</comment>
                            <comment id="13770776" author="dyret" created="Wed, 18 Sep 2013 14:45:24 +0100"  >&lt;p&gt;Attaching patch which tries to identify this situation and provide a better error. Modifies test case accordingly. &lt;/p&gt;</comment>
                            <comment id="13771819" author="knutanders" created="Thu, 19 Sep 2013 13:04:11 +0100"  >&lt;p&gt;Thanks, Dyre. The approach looks reasonable to me. Some comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The license header for WriteChainAlreadyInUseError has the wrong class name.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Since the resulting exception is a DisconnectException, which takes down the connection, I think it should have session severity instead of statement severity. That is, its message id should end with &quot;.C&quot; instead of &quot;.S&quot;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Can we be sure that WriteChainAlreadyInUseError is only thrown when there is a corresponding catch block higher up in the call chain? Is there a way to make sure it won&apos;t escape to the application without being properly wrapped in the appropriate checked exception type (SQLException or IOException)?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We might want to internationalize WriteChainAlreadyInUseError&apos;s hard-coded error message, as it is chained to the DisconnectException and will be visible externally.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It would be good to have a code comment explaining the purpose of writeChainIsLocked_ and grabWriteChain().&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13778573" author="dyret" created="Thu, 26 Sep 2013 09:31:19 +0100"  >&lt;p&gt;Thanks for the review Knut. I&apos;ll create another patch to address your comments.&lt;/p&gt;

&lt;p&gt;Wrt. WriteChainAlreadyInUseError being caught: No I don&apos;t think we can guarantee that. And even if we analysed the code and concluded that it is safe, there is no guarantee that it will remain so if the code is modified later. My thoughts about this is that starting another writeChain without finishing the previous one, when you already have sent data to server, usually indicates a bug, in much the same way as an NPE or ArrayIndexOutOfBoundsException does. I&apos;m fairly certain that whenever this situation occurs the result would be some kind of hard-to-understand syntax/parsing error from the server, and my reasoning was that even an uncaught WriteChainAlreadyInUseError was a preferable.&lt;/p&gt;

&lt;p&gt;It is always possible to make it checked and let it be wrapped in SqlExceptions and IOExceptions on its way up the callstack, but then we need to traverse the cause-chain to trap the situation where you&apos;re setting a stream backed by your own connection.&lt;/p&gt;</comment>
                            <comment id="13778675" author="dyret" created="Thu, 26 Sep 2013 12:30:21 +0100"  >&lt;p&gt;New patch which incorporates review comments.&lt;/p&gt;</comment>
                            <comment id="13781717" author="knutanders" created="Mon, 30 Sep 2013 10:50:03 +0100"  >&lt;p&gt;Thanks for the new patch, Dyre. I&apos;m mostly fine with it. I&apos;m still a little worried that applications might get confused if the WriteChainAlreadyInUseError escapes out to them. Although it&apos;s similar to the NPE or ArrayIndexOutOfBoundsException that would have been thrown without the fix, I think an application is more likely to have reasonable handlers for Exception than for Error. So I think I would feel more comfortable if it had been a sub-class of RuntimeException, as that would make me more confident that if it should escape, the consequences for the application would be no worse than today (either the application handles RuntimeException and doesn&apos;t care whether it&apos;s a NullPointerException or WriteChainAlreadyInUseException, or it doesn&apos;t handle it and will get into trouble either way).&lt;/p&gt;</comment>
                            <comment id="13786078" author="dyret" created="Fri, 4 Oct 2013 12:25:41 +0100"  >&lt;p&gt;Knut also told me (offline) that he would have preferred WriteChainAlreadyInUse to be checked.&lt;/p&gt;

&lt;p&gt;I decided to try that (I actually replaced WriteChainAlreadyInUse with a DisconnectExecption with SQLState.NET_WRITE_CHAIN_IS_DIRTY) just to see how it would work. When doing so, it occurred to me that there really are three different situations that need to be handled when reading from the InputStream (in Request.writePlainScalarStream()):&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;in.read() throws an exception but leaves the connection intact. This case is handled correctly by the existing code (the exception is saved and the stream value is padded with 0 and sent to the server to finish the request).&lt;/li&gt;
	&lt;li&gt;in.read() throws an exception which renders the connection unusable (closed):
	&lt;ol&gt;
		&lt;li&gt;in.read() throws SQLState.NET_WRITE_CHAIN_IS_DIRTY. Inform the user that she cannot use setX with a locator stream from the same connection.&lt;/li&gt;
		&lt;li&gt;in.read() throws some other exception. Since the connection is closed we cannot continue the request as in 1) (that would give an NPE when accessing the output stream), but must throw an SqlException, which should probably be a .C version of XN014.S wrapping the IOException from in.read().&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;2.1 is really just a special case of 2.2 which lets us provide a better error message to the user, but in order to provide it we need to traverse the cause chain to see if it contains SQLState.NET_WRITE_CHAIN_IS_DIRTY. &lt;/p&gt;

&lt;p&gt;As an experiment, I tried running the repro without special handling of case 2.1:&lt;/p&gt;
 &lt;blockquote&gt;
&lt;p&gt;START ClobTest #4 - select and then update clob of size= 31744 - Uses setClob api&lt;br/&gt;
Exception in thread &quot;main&quot; java.sql.SQLNonTransientConnectionException: Encountered an exception which terminated the connection, while reading from the stream specified by parameter #1. The Exception had this message: `org.apache.derby.client.am.DisconnectException: A write chain that has transmitted &lt;br/&gt;
                    data to the server cannot be reset until the request&lt;br/&gt;
                    is finished and the chain terminated.&apos;.&lt;br/&gt;
	at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:104)&lt;br/&gt;
	at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:321)&lt;br/&gt;
	at org.apache.derby.client.am.ClientPreparedStatement.executeUpdate(ClientPreparedStatement.java:404)&lt;br/&gt;
	at Repro5317.selectUpdateClob(Repro5317.java:172)&lt;br/&gt;
	at Repro5317.main(Repro5317.java:43)&lt;br/&gt;
Caused by: org.apache.derby.client.am.SqlException: Encountered an exception which terminated the connection, while reading from the stream specified by parameter #1. The Exception had this message: `org.apache.derby.client.am.DisconnectException: A write chain that has transmitted &lt;br/&gt;
                    data to the server cannot be reset until the request&lt;br/&gt;
                    is finished and the chain terminated.&apos;.&lt;br/&gt;
	at org.apache.derby.client.net.Request.writePlainScalarStream(Request.java:332)&lt;br/&gt;
	at org.apache.derby.client.net.Request.writeScalarStream(Request.java:244)&lt;br/&gt;
	at org.apache.derby.client.net.Request.writeScalarStream(Request.java:515)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatementRequest.buildEXTDTA(NetStatementRequest.java:1070)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatementRequest.writeExecute(NetStatementRequest.java:166)&lt;br/&gt;
	at org.apache.derby.client.net.NetPreparedStatement.writeExecute_(NetPreparedStatement.java:156)&lt;br/&gt;
	at org.apache.derby.client.am.ClientPreparedStatement.writeExecute(ClientPreparedStatement.java:1832)&lt;br/&gt;
	at org.apache.derby.client.am.ClientPreparedStatement.flowExecute(ClientPreparedStatement.java:2047)&lt;br/&gt;
	at org.apache.derby.client.am.ClientPreparedStatement.executeUpdateX(ClientPreparedStatement.java:409)&lt;br/&gt;
	at org.apache.derby.client.am.ClientPreparedStatement.executeUpdate(ClientPreparedStatement.java:395)&lt;br/&gt;
	... 2 more&lt;br/&gt;
Caused by: java.io.IOException: org.apache.derby.client.am.DisconnectException: A write chain that has transmitted &lt;br/&gt;
                    data to the server cannot be reset until the request&lt;br/&gt;
                    is finished and the chain terminated.&lt;br/&gt;
	at org.apache.derby.client.am.ClobLocatorReader.readCharacters(ClobLocatorReader.java:233)&lt;br/&gt;
	at org.apache.derby.client.am.ClobLocatorReader.read(ClobLocatorReader.java:152)&lt;br/&gt;
	at java.io.BufferedReader.fill(BufferedReader.java:154)&lt;br/&gt;
	at java.io.BufferedReader.read1(BufferedReader.java:205)&lt;br/&gt;
	at java.io.BufferedReader.read(BufferedReader.java:279)&lt;br/&gt;
	at org.apache.derby.client.am.UpdateSensitiveClobLocatorReader.read(UpdateSensitiveClobLocatorReader.java:152)&lt;br/&gt;
	at org.apache.derby.client.net.EncodedInputStream.reEncode(EncodedInputStream.java:121)&lt;br/&gt;
	at org.apache.derby.client.net.EncodedInputStream.read(EncodedInputStream.java:180)&lt;br/&gt;
	at java.io.InputStream.read(InputStream.java:170)&lt;br/&gt;
	at org.apache.derby.client.net.Request.writePlainScalarStream(Request.java:316)&lt;br/&gt;
	... 11 more&lt;br/&gt;
Caused by: org.apache.derby.client.am.DisconnectException: A write chain that has transmitted &lt;br/&gt;
                    data to the server cannot be reset until the request&lt;br/&gt;
                    is finished and the chain terminated.&lt;br/&gt;
	at org.apache.derby.client.net.NetAgent.verifyWriteChainIsClean(NetAgent.java:488)&lt;br/&gt;
	at org.apache.derby.client.net.NetAgent.beginWriteChain(NetAgent.java:500)&lt;br/&gt;
	at org.apache.derby.client.am.ClientPreparedStatement.flowPrepareDescribeInputOutput(ClientPreparedStatement.java:1966)&lt;br/&gt;
	at org.apache.derby.client.am.ClientPreparedStatement.prepare(ClientPreparedStatement.java:314)&lt;br/&gt;
	at org.apache.derby.client.am.ClientConnection.prepareCallX(ClientConnection.java:2003)&lt;br/&gt;
	at org.apache.derby.client.am.CallableLocatorProcedures.clobGetSubString(CallableLocatorProcedures.java:892)&lt;br/&gt;
	at org.apache.derby.client.am.ClobLocatorReader.readCharacters(ClobLocatorReader.java:223)&lt;br/&gt;
	... 20 more&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So it is not strictly necessary to traverse the cause chain, but the resulting error message is undoubtedly harder to parse. So unless I&apos;m told otherwise, I&apos;ll keep the cause-chain traversal and the special error for locator streams from the same connection.&lt;/p&gt;</comment>
                            <comment id="13786132" author="knutanders" created="Fri, 4 Oct 2013 14:30:13 +0100"  >&lt;p&gt;Sounds like a good approach. I think it&apos;s an improvement (no NPE!) even with no special handling of 2.1, but having a more specific error message will make it much clearer what the problem is, so +1 to that.&lt;/p&gt;</comment>
                            <comment id="13789015" author="dyret" created="Tue, 8 Oct 2013 08:40:09 +0100"  >&lt;p&gt;Patch using only checked exceptions, as described.&lt;/p&gt;</comment>
                            <comment id="13790249" author="knutanders" created="Wed, 9 Oct 2013 12:03:13 +0100"  >&lt;p&gt;Thanks, Dyre! The patch looks fine to me. I found some tiny nits, but nothing that blocks the patch.&lt;/p&gt;

&lt;p&gt;The nits:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When checking the SQLState of the nested exception, maybe use ExceptionUtil.getSQLStateFromIdentifier(SQLState.NET_WRITE_CHAIN_IS_DIRTY) instead of the magic string &quot;XN022&quot;? (And maybe use equals() instead of contentEquals()? I think they are equivalent, and equals() is shorter and more familiar (to me, at least).)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The XN024.C message uses different characters for opening and closing quotes. I think most existing messages use a single-quote (&apos;) character both for opening and closing. I didn&apos;t find any existing message that used the backtick (`) character. It would be good to make the style of the new message consistent with the existing messages.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The (Object[]) null argument to DisconnectException&apos;s constructor in verifyWriteChainIsClean() is probably not needed, since it&apos;s a vararg.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13790284" author="dyret" created="Wed, 9 Oct 2013 13:06:13 +0100"  >&lt;p&gt;Good suggestions, thanks.&lt;/p&gt;

&lt;p&gt;Wrt. contentEquals - I thought the more specific method should be preferred - contentEquals(CharSquence) over equals(Object). I naively assumed that since someone has gone through the trouble of providing the former, it was because there is some benefit (performance or other) to be had if you already know that you are comparing to a CharSequence...&lt;/p&gt;

&lt;p&gt;Wrt. backtick - Changed - but see &lt;br/&gt;
&lt;a href=&quot;http://programmers.stackexchange.com/questions/75349/why-do-nix-y-folks-single-quote-like-this-instead-of-like-this&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://programmers.stackexchange.com/questions/75349/why-do-nix-y-folks-single-quote-like-this-instead-of-like-this&lt;/a&gt;&lt;br/&gt;
if you&apos;re bored &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Wrt. (Object[]) cast - Changed. However, I shamelessly blame Netbeans for this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I think I used Netbeans to refactor away the local var which was used as the last arg, which then became null, (or maybe I added the null myself just to make it compile). Then NB gives a warning and suggests &quot;cast to Object for a varargs call&quot; or &quot;cast to (Object[]) for a non-varargs call and to suppress this warning&quot;.  &lt;/p&gt;</comment>
                            <comment id="13790441" author="dyret" created="Wed, 9 Oct 2013 16:08:33 +0100"  >&lt;p&gt;New patch including all suggested changes. I have been persuaded that there is, in fact, no benefit to using contentEquals... quite the opposite.&lt;/p&gt;</comment>
                            <comment id="13790595" author="jira-bot" created="Wed, 9 Oct 2013 17:40:32 +0100"  >&lt;p&gt;Commit 1530704 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dyret&quot; class=&quot;user-hover&quot; rel=&quot;dyret&quot;&gt;Dyre Tjeldvoll&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1530704&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1530704&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5317&quot; title=&quot; NullPointerException in org.apache.derby.client.net.Request.sendBytes()  with client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5317&quot;&gt;&lt;del&gt;DERBY-5317&lt;/del&gt;&lt;/a&gt;: Detect attempts to reuse a connection that in the middle of sending a request to the server. Use this to provide a better error message and avoid the NPE.&lt;/p&gt;</comment>
                            <comment id="13916223" author="mikem" created="Fri, 28 Feb 2014 19:26:24 +0000"  >&lt;p&gt;opening for backport to 10.10.&lt;/p&gt;</comment>
                            <comment id="13917507" author="jira-bot" created="Sun, 2 Mar 2014 18:05:50 +0000"  >&lt;p&gt;Commit 1573334 from mikem@apache.org in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1573334&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1573334&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5317&quot; title=&quot; NullPointerException in org.apache.derby.client.net.Request.sendBytes()  with client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5317&quot;&gt;&lt;del&gt;DERBY-5317&lt;/del&gt;&lt;/a&gt;: Detect attempts to reuse a connection that in the middle of sending a request to the server. Use this to provide a better error message and avoid the NPE.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6386&quot; title=&quot;Errors in jdbc4.LobStreamTest if derbyclient.jar is first in the classpath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6386&quot;&gt;&lt;del&gt;DERBY-6386&lt;/del&gt;&lt;/a&gt; - Errors in jdbc4.LobStreamTest if derbyclient.jar is first in the classpath&lt;/p&gt;

&lt;p&gt;backported change #1530704 to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5317&quot; title=&quot; NullPointerException in org.apache.derby.client.net.Request.sendBytes()  with client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5317&quot;&gt;&lt;del&gt;DERBY-5317&lt;/del&gt;&lt;/a&gt; from trunk to 10.10, needed some&lt;br/&gt;
   hand merging to fix difference in argument ordering between 10.10 and trunk.&lt;br/&gt;
backported change #1534425 to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6386&quot; title=&quot;Errors in jdbc4.LobStreamTest if derbyclient.jar is first in the classpath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6386&quot;&gt;&lt;del&gt;DERBY-6386&lt;/del&gt;&lt;/a&gt; which was caused by DERBY5317 fix.&lt;/p&gt;</comment>
                            <comment id="13918292" author="jira-bot" created="Mon, 3 Mar 2014 17:27:27 +0000"  >&lt;p&gt;Commit 1573624 from mikem@apache.org in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1573624&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1573624&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5317&quot; title=&quot; NullPointerException in org.apache.derby.client.net.Request.sendBytes()  with client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5317&quot;&gt;&lt;del&gt;DERBY-5317&lt;/del&gt;&lt;/a&gt;: Detect attempts to reuse a connection that in the middle of sending a request to the server. Use this to provide a better error message and avoid the NPE.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6386&quot; title=&quot;Errors in jdbc4.LobStreamTest if derbyclient.jar is first in the classpath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6386&quot;&gt;&lt;del&gt;DERBY-6386&lt;/del&gt;&lt;/a&gt; - Errors in jdbc4.LobStreamTest if derbyclient.jar is first in the classpath&lt;/p&gt;

&lt;p&gt;backing out change #1573334 which caused problems in nightly 10.10 test runs.&lt;/p&gt;</comment>
                            <comment id="13918380" author="mikem" created="Mon, 3 Mar 2014 18:33:21 +0000"  >&lt;p&gt;issue does not backport cleanly to 10.10.  Also causes build problems in 10.10 in some environments.   Also it adds some exceptions that may not be appropriate for existing &lt;br/&gt;
applications on a released product, better to introduce these only in a new release.&lt;br/&gt;
Marking not appropriate for backport.&lt;/p&gt;</comment>
                            <comment id="13918382" author="mikem" created="Mon, 3 Mar 2014 18:34:47 +0000"  >&lt;p&gt;reassigning original owner.  Looked at backporting, but ran into both merge and build problems.  Marked not appropriate for backport at this time.&lt;/p&gt;</comment>
                            <comment id="14284717" author="myrna" created="Wed, 21 Jan 2015 00:22:56 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12512461">DERBY-5308</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12674894">DERBY-6386</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12352050">DERBY-1903</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12354260">DERBY-2017</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12512461">DERBY-5308</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12485669" name="Repro5317.java" size="20388" author="kmarsden" created="Fri, 8 Jul 2011 01:09:23 +0100"/>
                            <attachment id="12485639" name="Repro5317.java" size="20023" author="kmarsden" created="Thu, 7 Jul 2011 19:48:18 +0100"/>
                            <attachment id="12603824" name="derby-5317a.diff" size="10651" author="dyret" created="Wed, 18 Sep 2013 14:45:24 +0100"/>
                            <attachment id="12605236" name="derby-5317b.diff" size="12578" author="dyret" created="Thu, 26 Sep 2013 12:30:21 +0100"/>
                            <attachment id="12607330" name="derby-5317c.diff" size="15251" author="dyret" created="Tue, 8 Oct 2013 08:40:08 +0100"/>
                            <attachment id="12607574" name="derby-5317d.diff" size="15454" author="dyret" created="Wed, 9 Oct 2013 16:08:33 +0100"/>
                            <attachment id="12485670" name="traces_10_2and10_9.zip" size="801484" author="kmarsden" created="Fri, 8 Jul 2011 01:09:23 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10363"><![CDATA[Embedded/Client difference]]></customfieldvalue>
    <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 6 Sep 2013 21:20:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24770</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0dmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36026</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>