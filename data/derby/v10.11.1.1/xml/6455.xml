<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:40:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6455/DERBY-6455.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6455] Infinite loop in NetworkServerControlImpl.ensureDataInBuffer</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6455</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;NetworkServerControlImpl.ensureDataInBuffer missing check for return -1 (EOF) from &apos;clientIs.read&apos;. When read returns -1 thread consumes 100% CPU. Method NetworkServerControlImpl.fillReplyBuffer correctly throw exception.&lt;/p&gt;

&lt;p&gt;Fix: add two lines:&lt;br/&gt;
    private void ensureDataInBuffer(int minimumBytesNeeded) throws Exception&lt;br/&gt;
    {&lt;br/&gt;
        // make sure the buffer is large enough&lt;br/&gt;
        while ((replyBufferCount - replyBufferPos) &amp;lt; minimumBytesNeeded)&lt;br/&gt;
        {&lt;br/&gt;
            try &lt;/p&gt;
{
                int bytesRead = clientIs.read(replyBuffer, replyBufferCount, replyBuffer.length - replyBufferCount);
+                if (bytesRead == -1)
+                    consolePropertyMessage(&quot;DRDA_InvalidReplyTooShort.S&quot;, true);
                replyBufferCount += bytesRead;
        
            }
&lt;p&gt; catch (IOException e)&lt;/p&gt;
            {
                clientSocketError(e);
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;StackTrace:&lt;br/&gt;
  java.lang.Thread.State: RUNNABLE&lt;br/&gt;
          at java.net.SocketInputStream.read(Unknown Source:-1)&lt;br/&gt;
          at org.apache.derby.impl.drda.NetworkServerControlImpl.ensureDataInBuffer(Unknown Source:-1)&lt;br/&gt;
          at org.apache.derby.impl.drda.NetworkServerControlImpl.readLDString(Unknown Source:-1)&lt;br/&gt;
          at org.apache.derby.impl.drda.NetworkServerControlImpl.readStringReply(Unknown Source:-1)&lt;br/&gt;
          at org.apache.derby.impl.drda.NetworkServerControlImpl.runtimeInfo(Unknown Source:-1)&lt;br/&gt;
          at org.apache.derby.drda.NetworkServerControl.getRuntimeInfo(Unknown Source:-1)&lt;br/&gt;
          at com.crcdata.dbadmin.server.DerbyEngine.getRuntimeInfo(DerbyEngine.java:134)&lt;br/&gt;
          at com.crcdata.dbadmin.server.DerbyEngine$DerbyServerMonitorTask.run(DerbyEngine.java:305)&lt;br/&gt;
          at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source:-1)&lt;br/&gt;
          at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source:-1)&lt;br/&gt;
          at java.util.concurrent.FutureTask.run(Unknown Source:-1)&lt;br/&gt;
          at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source:-1)&lt;br/&gt;
          at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source:-1)&lt;br/&gt;
          at java.lang.Thread.run(Unknown Source:-1)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12688558">DERBY-6455</key>
            <summary>Infinite loop in NetworkServerControlImpl.ensureDataInBuffer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jandam@crcdata.cz">Martin JANDA</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Jan 2014 15:56:33 +0000</created>
                <updated>Wed, 21 Jan 2015 00:23:10 +0000</updated>
                            <resolved>Wed, 22 Jan 2014 13:10:17 +0000</resolved>
                                    <version>10.10.1.1</version>
                                    <fixVersion>10.10.2.0</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13869664" author="jandam@crcdata.cz" created="Mon, 13 Jan 2014 16:26:13 +0000"  >&lt;p&gt;setSoTimeout should be called in NetworkServerControlImpl.setUpSocket&lt;/p&gt;</comment>
                            <comment id="13876468" author="knutanders" created="Mon, 20 Jan 2014 14:28:21 +0000"  >&lt;p&gt;Thanks for the bug report and the patch, Martin.&lt;/p&gt;

&lt;p&gt;I&apos;m able to reproduce the problem in my environment by forcing the server to stop sending data too early. I&apos;m not seeing an infinite loop, but a delay of 15 seconds (at 100% CPU usage) before the expected error is raised. 15 seconds seems to be the time ensureDataInBuffer() needs to make replyBufferCount wrap around from Integer.MIN_VALUE to Integer.MAX_VALUE (after about 2 billion iterations), which makes the loop terminate.&lt;/p&gt;

&lt;p&gt;I&apos;ve reworked the patch a little (see the attached d6455-1a.diff):&lt;/p&gt;

&lt;p&gt;1) I made the error checking in ensureDataInBuffer() optional, so that callers that want to give a more specific error message (such as readCommandReplyHeader()) can still do that.&lt;/p&gt;

&lt;p&gt;2) I removed the now redundant checks for insufficient data done by the callers of ensureDataInBuffer().&lt;/p&gt;

&lt;p&gt;I didn&apos;t add a regression test case for the bug, since it would require changes to the network server to make it possible to force it to send false data, and also because I wasn&apos;t able to reproduce an infinite loop, only slow completion of the command, so it&apos;s difficult to make the regression test distinguish between the bug and a slow test server.&lt;/p&gt;

&lt;p&gt;I&apos;ve hand-tested the patch against a server that sends truncated data and verified that the command now fails immediately instead of looping at 100% CPU for a while before failing.&lt;/p&gt;

&lt;p&gt;All the regression tests passed with the patch.&lt;/p&gt;</comment>
                            <comment id="13877341" author="jira-bot" created="Tue, 21 Jan 2014 08:59:10 +0000"  >&lt;p&gt;Commit 1559946 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1559946&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1559946&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6455&quot; title=&quot;Infinite loop in NetworkServerControlImpl.ensureDataInBuffer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6455&quot;&gt;&lt;del&gt;DERBY-6455&lt;/del&gt;&lt;/a&gt;: Infinite loop in NetworkServerControlImpl.ensureDataInBuffer&lt;/p&gt;

&lt;p&gt;Make NetworkServerControlImpl.ensureDataInBuffer() stop immediately if&lt;br/&gt;
it reaches end-of-stream.&lt;/p&gt;

&lt;p&gt;Based on patch contributed by Martin Janda.&lt;/p&gt;</comment>
                            <comment id="13878622" author="jira-bot" created="Wed, 22 Jan 2014 13:09:51 +0000"  >&lt;p&gt;Commit 1560341 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1560341&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1560341&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6455&quot; title=&quot;Infinite loop in NetworkServerControlImpl.ensureDataInBuffer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6455&quot;&gt;&lt;del&gt;DERBY-6455&lt;/del&gt;&lt;/a&gt;: Infinite loop in NetworkServerControlImpl.ensureDataInBuffer&lt;/p&gt;

&lt;p&gt;Merged revision 1559946 from trunk.&lt;/p&gt;</comment>
                            <comment id="14284756" author="myrna" created="Wed, 21 Jan 2015 00:23:10 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12688576">DERBY-6456</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12623951" name="d6455-1a.diff" size="4638" author="knutanders" created="Mon, 20 Jan 2014 14:28:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 20 Jan 2014 14:28:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367577</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10426"><![CDATA[Known fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzl7if:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367885</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>