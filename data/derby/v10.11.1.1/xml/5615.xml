<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:12:35 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5615/DERBY-5615.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5615] NPE in Store  when running SELECT in a read-only database accessed via the classpath subprotocol when authentication, authorization, and Java security are turned on</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5615</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I get an NPE trying to select from a table on which I don&apos;t have select privilege. The database is stored in a jar file accessed via the classpath protocol. BUILTIN authentication and sql authorization are turned on in the database. Running under a Java security manager. I will attach a repro. Here is the NPE:&lt;/p&gt;

&lt;p&gt;Failed Statement is: select * from KIWI.t&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(BaseDataFileFactory.java:661)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(BaseDataFileFactory.java:591)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.xact.Xact.openContainer(Xact.java:1316)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.OpenBTree.init(OpenBTree.java:380)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.BTreeController.init(BTreeController.java:1250)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.index.B2IController.init(B2IController.java:140)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.index.B2I.open(B2I.java:821)&lt;br/&gt;
	at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTransaction.java:476)&lt;br/&gt;
	at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTransaction.java:1308)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.debugGenerateInfo(DataDictionaryImpl.java:9584)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getDescriptorViaIndexMinion(DataDictionaryImpl.java:9492)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getDescriptorViaIndex(DataDictionaryImpl.java:9303)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getColumnDescriptorsScan(DataDictionaryImpl.java:2887)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getColumnDescriptorsScan(DataDictionaryImpl.java:2851)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.finishTableDescriptor(DataDictionaryImpl.java:2408)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getTableDescriptorIndex1Scan(DataDictionaryImpl.java:2277)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getUncachedTableDescriptor(DataDictionaryImpl.java:2293)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.NameTDCacheable.setIdentity(NameTDCacheable.java:110)&lt;br/&gt;
	at org.apache.derby.impl.services.cache.ConcurrentCache.find(ConcurrentCache.java:295)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getTableDescriptor(DataDictionaryImpl.java:2224)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.faultInTabInfo(DataDictionaryImpl.java:9905)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getNonCoreTI(DataDictionaryImpl.java:9702)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getUncachedPermissionsDescriptor(DataDictionaryImpl.java:13712)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getUncachedTablePermsDescriptor(DataDictionaryImpl.java:13660)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.PermissionsCacheable.setIdentity(PermissionsCacheable.java:71)&lt;br/&gt;
	at org.apache.derby.impl.services.cache.ConcurrentCache.find(ConcurrentCache.java:295)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getPermissions(DataDictionaryImpl.java:13364)&lt;br/&gt;
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getTablePermissions(DataDictionaryImpl.java:13350)&lt;br/&gt;
	at org.apache.derby.iapi.sql.dictionary.StatementTablePermission.oneAuthHasPermissionOnTable(StatementTablePermission.java:239)&lt;br/&gt;
	at org.apache.derby.iapi.sql.dictionary.StatementTablePermission.hasPermissionOnTable(StatementTablePermission.java:160)&lt;br/&gt;
	at org.apache.derby.iapi.sql.dictionary.StatementColumnPermission.check(StatementColumnPermission.java:99)&lt;br/&gt;
	at org.apache.derby.impl.sql.conn.GenericAuthorizer.authorize(GenericAuthorizer.java:183)&lt;br/&gt;
	at org.apache.derby.exe.ac40348015x0135x7cc7x4621x0000040700000.fillResultSet(Unknown Source)&lt;br/&gt;
	at org.apache.derby.exe.ac40348015x0135x7cc7x4621x0000040700000.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:353)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:441)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:324)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1242)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:630)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:559)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:367)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:527)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:372)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:245)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)&lt;br/&gt;
	at org.apache.derby.tools.ij.main(ij.java:59)&lt;br/&gt;
Cleanup action completed&lt;/p&gt;</description>
                <environment></environment>
        <key id="12542566">DERBY-5615</key>
            <summary>NPE in Store  when running SELECT in a read-only database accessed via the classpath subprotocol when authentication, authorization, and Java security are turned on</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_triage10_9</label>
                    </labels>
                <created>Tue, 14 Feb 2012 17:02:56 +0000</created>
                <updated>Wed, 12 Nov 2014 20:29:21 +0000</updated>
                            <resolved>Wed, 12 Nov 2014 20:29:21 +0000</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.10.2.1</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13207887" author="rhillegas" created="Tue, 14 Feb 2012 18:32:01 +0000"  >&lt;p&gt;Attaching a repro for this bug:&lt;/p&gt;

&lt;p&gt;1) 5615_script - Bash script to drive the repro.&lt;/p&gt;

&lt;p&gt;2) 5615.policy - Java security policy used by the repro.&lt;/p&gt;

&lt;p&gt;3) 5615_init.sql - IJ script to create the database.&lt;/p&gt;

&lt;p&gt;4) 5615_bug.sql - IJ script to trigger the NPE.&lt;/p&gt;

&lt;p&gt;The header comment in the driving script explains how to run the repro. &lt;/p&gt;

&lt;p&gt;As you can see, the bug only appears if you run with a Java security  manager. Without the security manager, the 5615_bug.sql script runs fine.&lt;/p&gt;</comment>
                            <comment id="13207917" author="mikem" created="Tue, 14 Feb 2012 19:02:39 +0000"  >&lt;p&gt;can you post the full derby.log that has the error.  Sometimes there is more info there, especially if some of the background threads are getting&lt;br/&gt;
errors and then affecting the client thread.&lt;/p&gt;

&lt;p&gt;That line in my client is:&lt;br/&gt;
at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(BaseDataFileFactory.java:661) &lt;br/&gt;
FileContainer container = (FileContainer) containerCache.find(identity);&lt;/p&gt;

&lt;p&gt;So it looks like containerCache went null.  A quick search leads to one way this can happen is if some corrupt level error is encountered, then&lt;br/&gt;
we mark everything null as we don&apos;t know what state the db is in and need to insure all clients exit.&lt;/p&gt;</comment>
                            <comment id="13207947" author="rhillegas" created="Tue, 14 Feb 2012 19:42:51 +0000"  >&lt;p&gt;Attaching the full derby.log with the NPE. There&apos;s not a lot more information in there, though. Thanks.&lt;/p&gt;</comment>
                            <comment id="13207968" author="rhillegas" created="Tue, 14 Feb 2012 20:02:05 +0000"  >&lt;p&gt;Linking this issue to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-866&quot; title=&quot;Derby User Management Enhancements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-866&quot;&gt;&lt;del&gt;DERBY-866&lt;/del&gt;&lt;/a&gt;. The problem was discovered while writing a test case involving a database on a classpath running under a security manager. Currently, that test case is conditionalized so that it only runs when there is no security manager. That conditional logic can be revisited when this bug is fixed.&lt;/p&gt;</comment>
                            <comment id="13207998" author="mikem" created="Tue, 14 Feb 2012 20:40:00 +0000"  >&lt;p&gt;thanks for derby.log.  &lt;/p&gt;

&lt;p&gt;Looking closer at the stack, it looks like the nullpointer is likely a secondary issue coming from running in sane code.  Might be interesting&lt;br/&gt;
to run in insane and see what happens.  I think there&lt;br/&gt;
is a prior assert firing that then gets hidden by the nullpointer (maybe the assert closed down the db).  &lt;/p&gt;

&lt;p&gt;See this part of the stack:&lt;br/&gt;
at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.debugGenerateInfo(DataDictionaryImpl.java:9584) &lt;/p&gt;

&lt;p&gt;This code is trying to package up a bunch of extra info to print out after hitting an AssertFailure.  The assert came from store also.  &lt;/p&gt;</comment>
                            <comment id="13208010" author="rhillegas" created="Tue, 14 Feb 2012 21:09:00 +0000"  >&lt;p&gt;Here&apos;s the log running with insane jars. The debug printing by the DataDictionary disappears and the DD trundles along into another NPE.&lt;/p&gt;</comment>
                            <comment id="13212197" author="mikem" created="Mon, 20 Feb 2012 23:00:39 +0000"  >&lt;p&gt;10.9 triage. &lt;/p&gt;</comment>
                            <comment id="13947851" author="knutanders" created="Wed, 26 Mar 2014 12:28:04 +0000"  >&lt;p&gt;I tried the scripts that are attached to see if I could reproduce the problem. I am not able to reproduce the NPE, but I do see a FileNotFoundException when running against 10.9.1.0:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; connect &apos;jdbc:derby:classpath:nast;user=GRAPE;password=GRAPE_password&apos;;
ij(CONNECTION1)&amp;gt; -- NPE here
select * from KIWI.t;
ERROR XSDG0: Page Page(5,Container(0, 161)) could not be read from disk.
ERROR XJ001: Java exception: &apos;nast/seg0/ca1.dat: java.io.FileNotFoundException&apos;.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When running against 10.10.1.1 or trunk, it seems to behave as expected:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; connect &apos;jdbc:derby:classpath:nast;user=GRAPE;password=GRAPE_password&apos;;
ij(CONNECTION1)&amp;gt; -- NPE here
select * from KIWI.t;
ERROR 42502: User &apos;GRAPE&apos; does not have SELECT permission on column &apos;A&apos; of table &apos;KIWI&apos;.&apos;T&apos;.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Am I doing something wrong, or has this bug been fixed as part of some other issue?&lt;/p&gt;</comment>
                            <comment id="13949082" author="knutanders" created="Thu, 27 Mar 2014 09:29:47 +0000"  >&lt;p&gt;On the other hand, the test cases in NativeAuthenticationServiceTest that run without security manager because of this bug, still fail if the security manager is enabled:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;There was 1 error:
1) testAll(org.apache.derbyTesting.functionTests.tests.lang.NativeAuthenticationServiceTest)java.sql.SQLException: (40000) Failed to start database &apos;classpath:nast&apos; with class loader sun.misc.Launcher$AppClassLoader@3cd1a2f1, see the next exception for details.
...
Caused by: ERROR XJ040: (40000) Failed to start database &apos;classpath:nast&apos; with class loader sun.misc.Launcher$AppClassLoader@3cd1a2f1, see the next exception for details.
        at org.apache.derby.iapi.error.StandardException.plainWrapException(StandardException.java:537)
        at org.apache.derby.impl.jdbc.authentication.NativeAuthenticationServiceImpl.wrap(NativeAuthenticationServiceImpl.java:458)
        at org.apache.derby.impl.jdbc.authentication.NativeAuthenticationServiceImpl.authenticateRemotely(NativeAuthenticationServiceImpl.java:440)
        at org.apache.derby.impl.jdbc.authentication.NativeAuthenticationServiceImpl.authenticateUser(NativeAuthenticationServiceImpl.java:321)
        ... 192 more
Caused by: ERROR XSAI2: (20000) The conglomerate (16) requested does not exist.
        at org.apache.derby.iapi.error.StandardException.plainWrapException(StandardException.java:537)
        at org.apache.derby.iapi.error.StandardException.plainWrapException(StandardException.java:540)
        ... 195 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13949127" author="knutanders" created="Thu, 27 Mar 2014 10:31:40 +0000"  >&lt;p&gt;According to git bisect, the NPE was fixed by revision 1400024, with the following commit message:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5947&quot; title=&quot;Factor out common code from generated classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5947&quot;&gt;&lt;del&gt;DERBY-5947&lt;/del&gt;&lt;/a&gt;: Factor out common code from generated classes&lt;/p&gt;

&lt;p&gt;Move authorization check for CursorNodes from generated code to&lt;br/&gt;
CursorActivation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Maybe there&apos;s a check on a permission that we have granted to derby.jar (such as read permission on the jar file that contains the db?) that fails because the permission is not granted to the generated code, and the permission check succeeds now when it is not called from generated code. Two of the stack frames in the bug description are from generated code, so at least it is a possibility.&lt;/p&gt;</comment>
                            <comment id="13949242" author="knutanders" created="Thu, 27 Mar 2014 12:45:04 +0000"  >&lt;p&gt;The CPFile class reads the database files through ClassLoader methods such as getResource() and getSystemResource(). Those methods don&apos;t throw a SecurityException when they don&apos;t have permission to read the files. Instead, they return null, which leads to various symptoms such as NPE, FileNotFoundException or conglomerate not found errors, as reported here.&lt;/p&gt;

&lt;p&gt;The calls are not wrapped in calls to doPrivilege(), which means the entire call stack must have permission to access the files. The original repro failed because the generated code doesn&apos;t have any privileges, and this problem went away when the failing code no longer was called from generated code. The failures we still see in NativeAuthenticationServiceTest seem to happen because junit.jar doesn&apos;t have permission to read the files.&lt;/p&gt;

&lt;p&gt;Attached is a patch (d5615-1a.diff) that wraps doPrivileged() calls around the operations that require privileges. It also turns on the security manager for all test cases in NativeAuthenticationServiceTest, and for some more test cases in DatabaseClassLoadingTest. Those tests now run cleanly. I&apos;ve also started the full regression test suite.&lt;/p&gt;</comment>
                            <comment id="13949283" author="knutanders" created="Thu, 27 Mar 2014 13:20:04 +0000"  >&lt;p&gt;All regression tests passed.&lt;/p&gt;</comment>
                            <comment id="13949430" author="knutanders" created="Thu, 27 Mar 2014 15:04:33 +0000"  >&lt;p&gt;Attaching an updated patch, d5615-1b.diff. In the updated patch, yet another operation in CPFile is wrapped in a doPrivileged() call. The operation is a call to Thread.getContextClassLoader(), which may require RuntimePermission(&quot;getClassLoader&quot;).&lt;/p&gt;

&lt;p&gt;The tests did not fall over because of this, because the permission is not required when the caller&apos;s class loader (that is, CPFile&apos;s class loader) is an ancestor of the thread&apos;s context class loader, and that&apos;s exactly how ClasspathSetup sets up the context class loader used in the tests.&lt;/p&gt;</comment>
                            <comment id="13950543" author="jira-bot" created="Fri, 28 Mar 2014 09:44:40 +0000"  >&lt;p&gt;Commit 1582655 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1582655&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1582655&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5615&quot; title=&quot;NPE in Store  when running SELECT in a read-only database accessed via the classpath subprotocol when authentication, authorization, and Java security are turned on&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5615&quot;&gt;&lt;del&gt;DERBY-5615&lt;/del&gt;&lt;/a&gt;: Permission problems with classpath subsubprotocol&lt;/p&gt;

&lt;p&gt;Wrap CPFile&apos;s privileged operations in doPrivileged() so that&lt;br/&gt;
classpath databases can be accessed with a security manager.&lt;/p&gt;

&lt;p&gt;Make more of the test cases in DatabaseClassLoadingTest and&lt;br/&gt;
NativeAuthenticationServiceTest run with a security manager.&lt;/p&gt;</comment>
                            <comment id="13950657" author="knutanders" created="Fri, 28 Mar 2014 12:56:13 +0000"  >&lt;p&gt;The fix for this issue seems to cause problems for the tests on Windows. DatabaseClassLoadingTest fails to delete dclt.jar when it&apos;s done. Reopening the issue.&lt;/p&gt;

&lt;p&gt;I&apos;ve found out how to fix it, but I don&apos;t understand why it&apos;s failing in the first place.&lt;/p&gt;

&lt;p&gt;Originally, in CPFile, the getInputStream() method and the getURL() method were almost identical, only that the former used ClassLoader.getResourceAsStream() and ClassLoader.getSystemResourceAsStream() whereas the latter used ClassLoader.getResource() and ClassLoader.getSystemResource().&lt;/p&gt;

&lt;p&gt;To minimize the duplication, the 1b patch rewrote getInputStream() so that it essentially just returned getURL().openStream(), plus some error checking.&lt;/p&gt;

&lt;p&gt;If I reintroduce the code duplication, the test runs cleanly on Windows again. So there must be something different with that approach, I just haven&apos;t figured out what.&lt;/p&gt;</comment>
                            <comment id="13950734" author="knutanders" created="Fri, 28 Mar 2014 13:59:17 +0000"  >&lt;p&gt;Attaching d5615-2a.diff which changes the structure of CPFile.getInputStream() back to how it was before the 1b patch, but with the required doPrivileged() calls added. Now DatabaseClassLoadingTest and NativeAuthenticationServiceTest pass on Windows too.&lt;/p&gt;</comment>
                            <comment id="13950739" author="jira-bot" created="Fri, 28 Mar 2014 14:02:14 +0000"  >&lt;p&gt;Commit 1582754 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1582754&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1582754&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5615&quot; title=&quot;NPE in Store  when running SELECT in a read-only database accessed via the classpath subprotocol when authentication, authorization, and Java security are turned on&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5615&quot;&gt;&lt;del&gt;DERBY-5615&lt;/del&gt;&lt;/a&gt;: Permission problems with classpath subsubprotocol&lt;/p&gt;

&lt;p&gt;Change the structure of CPFile.getInputStream() back to what it was&lt;br/&gt;
before the original fix for this issue (revision 1582655), but with&lt;br/&gt;
doPrivileged() calls around all operations that require privileges.&lt;/p&gt;

&lt;p&gt;The restructuring in the original fix apparently prevented some&lt;br/&gt;
resources from being freed, so that DatabaseClassLoadingTest and&lt;br/&gt;
NativeAuthenticationServiceTest failed on Windows platforms because&lt;br/&gt;
they could not delete the jar file that contained the classpath&lt;br/&gt;
database.&lt;/p&gt;</comment>
                            <comment id="13955125" author="knutanders" created="Mon, 31 Mar 2014 13:15:40 +0100"  >&lt;p&gt;I think I understand why the first patch failed on Windows.&lt;/p&gt;

&lt;p&gt;It rewrote CPFile.getInputStream() to do getURL().openStream(). Since the only difference between the original getInputStream() method and getURL() was that the former used ClassLoader.getResourceAsStream() and the latter ClassLoader.getResource(), and getResourceAsStream() is essentially equivalent to getResource().openStream(), I assumed the rewritten method would be equivalent to the original one. However, URLClassLoader.getResourceAsStream() overrides ClassLoader.getResourceAsStream() and adds some resource tracking that URLClassLoader.close() needs in order to release all resources. When we acquired the stream directly by calling openStream() rather than going through getResourceAsStream(), that resource tracking was skipped, and there was still an open file handle on the jar file after the URLClassLoader had been closed. This open file handle prevented the test harness from deleting the jar file on Windows.&lt;/p&gt;

&lt;p&gt;Conclusion: Let&apos;s leave getInputStream() as it is for now.&lt;/p&gt;</comment>
                            <comment id="14169706" author="mamtas" created="Mon, 13 Oct 2014 19:29:32 +0100"  >&lt;p&gt;Will work on backporting this to 10.10&lt;/p&gt;</comment>
                            <comment id="14208624" author="jira-bot" created="Wed, 12 Nov 2014 20:27:56 +0000"  >&lt;p&gt;Commit 1639031 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mamtas&quot; class=&quot;user-hover&quot; rel=&quot;mamtas&quot;&gt;Mamta A. Satoor&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1639031&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1639031&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5615&quot; title=&quot;NPE in Store  when running SELECT in a read-only database accessed via the classpath subprotocol when authentication, authorization, and Java security are turned on&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5615&quot;&gt;&lt;del&gt;DERBY-5615&lt;/del&gt;&lt;/a&gt;(NPE in Store when running SELECT in a read-only database accessed via the classpath subprotocol when authentication, authorization, and Java security are turned on)&lt;/p&gt;

&lt;p&gt;Backporting to 10.10&lt;/p&gt;</comment>
                            <comment id="14208627" author="mamtas" created="Wed, 12 Nov 2014 20:29:21 +0000"  >&lt;p&gt;Backport to 10.10 done. Assigning back to Knut.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12328052">DERBY-866</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12746192">DERBY-6759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12514524" name="5615.policy" size="5966" author="rhillegas" created="Tue, 14 Feb 2012 18:32:01 +0000"/>
                            <attachment id="12514522" name="5615_bug.sql" size="236" author="rhillegas" created="Tue, 14 Feb 2012 18:32:01 +0000"/>
                            <attachment id="12514523" name="5615_init.sql" size="716" author="rhillegas" created="Tue, 14 Feb 2012 18:32:01 +0000"/>
                            <attachment id="12514525" name="5615_script" size="1117" author="rhillegas" created="Tue, 14 Feb 2012 18:32:01 +0000"/>
                            <attachment id="12637134" name="d5615-1a.diff" size="15543" author="knutanders" created="Thu, 27 Mar 2014 12:45:04 +0000"/>
                            <attachment id="12637158" name="d5615-1b.diff" size="16025" author="knutanders" created="Thu, 27 Mar 2014 15:04:33 +0000"/>
                            <attachment id="12637402" name="d5615-2a.diff" size="3939" author="knutanders" created="Fri, 28 Mar 2014 13:59:17 +0000"/>
                            <attachment id="12514548" name="derby.log" size="4886" author="rhillegas" created="Tue, 14 Feb 2012 21:09:00 +0000"/>
                            <attachment id="12514536" name="derby.log" size="5973" author="rhillegas" created="Tue, 14 Feb 2012 19:42:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 14 Feb 2012 19:02:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>227852</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ddz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35987</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>