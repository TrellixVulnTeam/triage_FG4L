<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:33:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6668/DERBY-6668.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6668] Truncating a table may silently violate a deferred foreign key.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6668</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If you truncate a table which is referenced by a deferred foreign key, orphaned tuples are left in the foreign table. That is, the foreign key is violated but no exception is raised.&lt;/p&gt;

&lt;p&gt;Since table truncation involves changing conglomerate ids, this may be another case of derby-6665. Or this may be a new bug.&lt;/p&gt;

&lt;p&gt;The following script shows this behavior:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;

create table tunique
(
  a int not null unique
);

create table tref
(
  a int references tunique( a ) initially deferred
);

insert into tunique values ( 1 );
insert into tref values ( 1 );

truncate table tunique;

-- the unique table is empty
select * from tunique;

-- but the table which references it has a row
select * from tref;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12727754">DERBY-6668</key>
            <summary>Truncating a table may silently violate a deferred foreign key.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Wed, 16 Jul 2014 20:27:42 +0100</created>
                <updated>Thu, 25 Sep 2014 00:15:39 +0100</updated>
                            <resolved>Thu, 17 Jul 2014 13:42:10 +0100</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14063997" author="knutanders" created="Wed, 16 Jul 2014 20:52:05 +0100"  >&lt;p&gt;We should probably forbid TRUNCATE TABLE on a table referenced by a foreign key. At least that&apos;s how I understand SQL:2011, part 2, 14.10 &amp;lt;truncate table statement&amp;gt;, SR 4: &quot;T shall not be identified by the name of the referenced table in any referential constraint descriptor.&quot;&lt;/p&gt;</comment>
                            <comment id="14064013" author="knutanders" created="Wed, 16 Jul 2014 21:10:13 +0100"  >&lt;p&gt;If I remove &quot;initially deferred&quot; from the fk definition in the repro script, TRUNCATE TABLE fails with this error:&lt;/p&gt;

&lt;p&gt;ERROR XCL48: TRUNCATE TABLE is not permitted on &apos;TUNIQUE&apos; because unique/primary key constraints on this table are referenced by enabled foreign key constraints from other tables.&lt;/p&gt;

&lt;p&gt;We could raise the same error in the deferred case, I guess.&lt;/p&gt;

&lt;p&gt;(Note that we are slightly more liberal than the standard, as we only disallow TRUNCATE TABLE when referenced from other tables. Self-referencing foreign keys are accepted. This deviation doesn&apos;t cause any integrity issues, though, as far as I can tell.)&lt;/p&gt;</comment>
                            <comment id="14064052" author="rhillegas" created="Wed, 16 Jul 2014 21:39:47 +0100"  >&lt;p&gt;I would support the meat-ax approach of forbidding TRUNCATE on referenced tables, per the Standard. We would need a release note to flag the backward incompatibility.&lt;/p&gt;</comment>
                            <comment id="14064247" author="rhillegas" created="Wed, 16 Jul 2014 23:25:51 +0100"  >&lt;p&gt;Attaching derby-6668-01-aa-disallowTruncateOnReferencedTable.diff. This patch forbids TRUNCATE on a referenced table regardless of whether the foreign key is deferred. I am running tests now.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/execute/AlterTableConstantAction.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/ForeignKeysDeferrableTest.java&lt;/p&gt;</comment>
                            <comment id="14064255" author="rhillegas" created="Wed, 16 Jul 2014 23:27:51 +0100"  >&lt;p&gt;Note that even if the tables are empty, the TRUNCATE is not allowed on 10.10.2.0 (for the non-deferabble constraints allowed in that release). So there should be no backward compatibility problem and no need for a release note.&lt;/p&gt;</comment>
                            <comment id="14064665" author="knutanders" created="Thu, 17 Jul 2014 08:24:48 +0100"  >&lt;p&gt;The patch looks good to me. Judging by the code comments, is sounds as if this was intentionally allowed, and violations were supposed to be detected later by AlterTableConstantAction.updateIndex(). Apparently, that doesn&apos;t work correctly. Anyways, disallowing it for now makes sense. We can always enable it later if we can make it work correctly.&lt;/p&gt;</comment>
                            <comment id="14064869" author="rhillegas" created="Thu, 17 Jul 2014 13:36:13 +0100"  >&lt;p&gt;Thanks for the review, Knut. Attaching derby-6668-01-ab-disallowTruncateOnReferencedTable.diff. The previous version tripped over two errors in ConstraintCharacteristicsTest: that test was verifying the edge case where truncating a referenced table does work.&lt;/p&gt;

&lt;p&gt;This patch removes the offending test case so that ConstraintCharacteristicsTest passes cleanly now.&lt;/p&gt;

&lt;p&gt;I suspect that some complexity was added to the code to make it support this non-Standard behavior. We should consider removing that complexity.   &lt;/p&gt;

&lt;p&gt;Touches the following additional file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java&lt;/p&gt;</comment>
                            <comment id="14064873" author="rhillegas" created="Thu, 17 Jul 2014 13:42:10 +0100"  >&lt;p&gt;Committed derby-6668-01-ab-disallowTruncateOnReferencedTable.diff at subversion revision 1611342. Resolving.&lt;/p&gt;</comment>
                            <comment id="14147009" author="mikem" created="Wed, 24 Sep 2014 23:40:44 +0100"  >&lt;p&gt;I believe this bugs is specific to deferrable constraints so marking as not appropriate to backport to 10.10 and previous releases.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12727497">DERBY-6665</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12313704">DERBY-532</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12656163" name="derby-6668-01-aa-disallowTruncateOnReferencedTable.diff" size="2969" author="rhillegas" created="Wed, 16 Jul 2014 23:25:51 +0100"/>
                            <attachment id="12656269" name="derby-6668-01-ab-disallowTruncateOnReferencedTable.diff" size="4585" author="rhillegas" created="Thu, 17 Jul 2014 13:36:13 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 16 Jul 2014 19:52:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405859</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzrp87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405879</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10050"><![CDATA[Blocker]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>