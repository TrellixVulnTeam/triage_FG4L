<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6521/DERBY-6521.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6521] Improve error handling when restricting file permissions</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6521</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6503&quot; title=&quot;Starting network server on a network drive fails with JDK 7 on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6503&quot;&gt;&lt;del&gt;DERBY-6503&lt;/del&gt;&lt;/a&gt; there was some discussion about changing how errors are handled when Derby fails to restrict the file permissions.&lt;/p&gt;

&lt;p&gt;There seemed to be consensus that Derby should raise an exception if the user had explicitly requested (by setting derby.storage.useDefaultFilePermissions=false) that it should try to restrict file permissions. Currently, it only raises an error on non-posix file systems that support access control lists.&lt;/p&gt;

&lt;p&gt;In the case were the user has not explicitly requested restriction of file permissions, two options have been suggested:&lt;/p&gt;

&lt;p&gt;1) Raise an exception&lt;/p&gt;

&lt;p&gt;2) Don&apos;t raise an exception, possibly print a warning in derby.log&lt;/p&gt;

&lt;p&gt;Option 1 is the more secure one, since it forces the user to make a decision on how to handle a possible security problem (either by addressing the underlying cause of the failure, so that permissions can be successfully restricted by Derby, or by disabling the file restriction functionality).&lt;/p&gt;

&lt;p&gt;Option 2 is the more backward compatible one, since it gracefully falls back to the pre-10.10/pre-Java 7 behaviour if it cannot restrict the file permissions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12702580">DERBY-6521</key>
            <summary>Improve error handling when restricting file permissions</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Mar 2014 08:36:00 +0000</created>
                <updated>Sat, 13 Sep 2014 01:46:43 +0100</updated>
                            <resolved>Wed, 23 Apr 2014 14:00:55 +0100</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13961830" author="knutanders" created="Mon, 7 Apr 2014 14:13:44 +0100"  >&lt;p&gt;Attaching a patch, d6521-1a.diff, which shows one possible and not so complex solution.&lt;/p&gt;

&lt;p&gt;The approach has the following characteristics:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;There is no difference between the case where restrictive file permissions are enabled by default and the case where they are explicitly enabled by the user.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When running on Java 7, and the file system supports restricting file permissions, and something goes wrong, fail and report the IOException.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;If we fall back to the Java 6 mechanism for restricting file permissions (either because we are in fact running on Java 6, or because the file system doesn&apos;t have the concept of a file owner) and something goes wrong, don&apos;t raise an error.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The reasons why I&apos;m leaning towards this approach are mainly of pragmatic nature:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Having the same behaviour in the default case and the explicitly enabled case is
	&lt;ul&gt;
		&lt;li&gt;Easier to explain.&lt;/li&gt;
		&lt;li&gt;Easier to code. The alternative (writing a warning in derby.log instead of failing in the default case) is problematic both because FileUtil.limitAccessToOwner() is used outside of the engine, and because these problems, if they occur, are very likely to pop up early before derby.system.home and derby.log have been created, so there&apos;s no derby.log to write to. (Both &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6410&quot; title=&quot;ClassCastException when launching derby from windows subst drive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6410&quot;&gt;&lt;del&gt;DERBY-6410&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6503&quot; title=&quot;Starting network server on a network drive fails with JDK 7 on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6503&quot;&gt;&lt;del&gt;DERBY-6503&lt;/del&gt;&lt;/a&gt; were seen when attempting to create derby.log.)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Reporting the IOExceptions thrown by the Java 7 FileAttributeViews sounds reasonable to do, also in the default case, since we only use the FileAttributeViews on file systems where we expect it to be possible to change the permissions, and we get an IOException that explains the root cause, so there&apos;s a good chance the user can fix the problem.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When the Java 6 mechanism is used, we only get a true/false response from the system, so it&apos;s difficult to give a good error message. I&apos;m not so worried about not reporting these errors on Java 6, since restrictive file permissions is primarily a feature for Java 7 and higher (for example, we only enable it by default on the network server if we are running Java 7 and higher).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When we are running on a file system that doesn&apos;t distinguish between the owner of the file and other users (such as FAT), there&apos;s not much that could be done, so regarding it as a successful no-op rather than an unsuccessful operation doesn&apos;t sound totally unreasonable. That would allow applications running on such legacy systems to continue working without any workarounds.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The only change in behaviour that results from this patch, is that failures to change permission on POSIX file systems with Java 7 or higher will be reported as errors. The behaviour in all other configurations should be unchanged. So it will be slightly stricter than before, and more consistent between Windows and *nix platforms, but not so strict that it will break compatibility with legacy systems.&lt;/p&gt;

&lt;p&gt;All the regression tests passed with the patch. I ran RestrictiveFilePermissionsTest both on Linux and Windows with JDK 6, 7 and 8.&lt;/p&gt;</comment>
                            <comment id="13978150" author="knutanders" created="Wed, 23 Apr 2014 13:43:15 +0100"  >&lt;p&gt;Attaching an updated patch, 1b, which adds some more details to the comments in FileUtil.limitAccessToOwner().&lt;/p&gt;</comment>
                            <comment id="13978152" author="jira-bot" created="Wed, 23 Apr 2014 13:44:24 +0100"  >&lt;p&gt;Commit 1589396 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1589396&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1589396&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6521&quot; title=&quot;Improve error handling when restricting file permissions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6521&quot;&gt;&lt;del&gt;DERBY-6521&lt;/del&gt;&lt;/a&gt;: Improve error handling when restricting file permissions&lt;/p&gt;</comment>
                            <comment id="14126097" author="mamtas" created="Mon, 8 Sep 2014 22:07:26 +0100"  >&lt;p&gt;Knut, had a question on this jira. Should have asked this earlier. With the fix, in the case were the user has not explicitly requested restriction of file permissions, will we be raising exception(this would be change in behavior from previous release) or would we just print a warning in derby.log. If we are going to raise an exception, I am wondering if we need to document that in release notes as change in behavior. Sorry if this has already taken care of.&lt;/p&gt;

&lt;p&gt;Also, thought would mention that RestrictiveFilePermissionsTest gets run only with jdk 1.7 and higher. Do we need to have an additional test for jdk 1.6 and higher to test the behavior in case of missing file permissions? Thanks&lt;/p&gt;</comment>
                            <comment id="14126860" author="knutanders" created="Tue, 9 Sep 2014 11:49:41 +0100"  >&lt;p&gt;The exception will be raised. This was already the behaviour when running on Windows. The change made in this issue was to make non-Windows platforms behave the same way. So the applications that might see a new exception now are those that start the network server from the command line on Java 7 or higher on a non-Windows platform where the underlying file system supports changing file permissions.&lt;/p&gt;

&lt;p&gt;I guess a release note could have been added for this change. Unfortunately, it&apos;s too late to get it into the 10.11.1.1 release notes now.&lt;/p&gt;

&lt;p&gt;In 10.9 and 10.10, there were asserts that would have raised exceptions if the permissions could not be changed in those configurations. We never saw those asserts fail in any of the platform tests, as far as I can recall. Hopefully, that&apos;s a good indication that this change isn&apos;t going to be noticed by many users.&lt;/p&gt;

&lt;p&gt;As to running RestrictiveFilePermissionsTest under Java 6, Dag said the following in a comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5363&quot; title=&quot;Tighten permissions of DB files to owner with &amp;gt;= JDK7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5363&quot;&gt;&lt;del&gt;DERBY-5363&lt;/del&gt;&lt;/a&gt; when the test was added:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Footnote: the reason why we can &lt;b&gt;restrict&lt;/b&gt; but not test permission with Java 6 is that this would require running a test with another OS user; there is no way to inspect the permissions, only to restrict them, essentially. Cf File.setWriteable &amp;amp; friends.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14132397" author="mamtas" created="Sat, 13 Sep 2014 01:46:12 +0100"  >&lt;p&gt;Thanks Knut. I will close the jira.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12699440">DERBY-6503</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12678190">DERBY-6410</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12353711">DERBY-1981</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12515817">DERBY-5363</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12638974" name="d6521-1a.diff" size="8401" author="knutanders" created="Mon, 7 Apr 2014 14:13:44 +0100"/>
                            <attachment id="12641464" name="d6521-1b.diff" size="10692" author="knutanders" created="Wed, 23 Apr 2014 13:43:15 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 23 Apr 2014 12:44:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380919</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hznhf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381198</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>