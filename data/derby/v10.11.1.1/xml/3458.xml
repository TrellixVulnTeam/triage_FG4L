<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:31:48 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3458/DERBY-3458.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3458] dblook fails on TERRITORY_BASED databases</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3458</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I&apos;ve created small patches for myself by replacing all related queries in the &apos;tools&apos; section with CASTs to CHARs and VARCHARs and would like to contribute these to the community in case anyone else can confirm this is a bug.&lt;/p&gt;

&lt;p&gt;A small test case to reproduce the problem is provided below, the version of Derby that provides the stacktrace is 10.3.2.1.&lt;/p&gt;


&lt;p&gt;Regards,&lt;/p&gt;


&lt;p&gt;Stephan van Loendersloot.&lt;/p&gt;




&lt;p&gt;Reproduction steps:&lt;/p&gt;

&lt;p&gt;---------- 1: create_territory_db.sql  ----------&lt;/p&gt;

&lt;p&gt;CONNECT &apos;jdbc:derby://localhost/dutch;user=dutch;password=dutch;create=true;territory=nl_NL;collation=TERRITORY_BASED&apos;;&lt;/p&gt;

&lt;p&gt;AUTOCOMMIT OFF;&lt;/p&gt;

&lt;p&gt;CREATE TABLE AIRLINES&lt;br/&gt;
 (&lt;br/&gt;
    AIRLINE CHAR(2) NOT NULL ,&lt;br/&gt;
    AIRLINE_FULL VARCHAR(24),&lt;br/&gt;
    BASIC_RATE DOUBLE PRECISION,&lt;br/&gt;
    DISTANCE_DISCOUNT DOUBLE PRECISION,&lt;br/&gt;
    BUSINESS_LEVEL_FACTOR DOUBLE PRECISION,&lt;br/&gt;
    FIRSTCLASS_LEVEL_FACTOR DOUBLE PRECISION,&lt;br/&gt;
    ECONOMY_SEATS INTEGER,&lt;br/&gt;
    BUSINESS_SEATS INTEGER,&lt;br/&gt;
    FIRSTCLASS_SEATS INTEGER&lt;br/&gt;
 );&lt;/p&gt;

&lt;p&gt;COMMIT;&lt;/p&gt;


&lt;p&gt;DISCONNECT;&lt;br/&gt;
EXIT;&lt;/p&gt;

&lt;p&gt;---------- 2: use dbloook ----------&lt;/p&gt;

&lt;p&gt;dblook -d &quot;jdbc:derby://localhost/dutch;user=dutch;password=dutch&quot; -o dutch.sql&lt;/p&gt;

&lt;p&gt;---------- 3: stacktrace ----------&lt;/p&gt;

&lt;p&gt;java.sql.SQLSyntaxErrorException: Comparisons between &apos;CHAR (UCS_BASIC)&apos; and &apos;CHAR (TERRITORY_BASED)&apos; are not supported. Types must be comparable. String types must also have matching collation. If collation does not match, a possible solution is to cast operands to force them to the default collation (e.g. select tablename from sys.systables where CAST(tablename as VARCHAR(128)) = &apos;T1&apos;)&lt;br/&gt;
  at org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.am.Statement.executeQuery(Unknown Source)&lt;br/&gt;
  at org.apache.derby.tools.dblook.prepForDump(Unknown Source)&lt;br/&gt;
  at org.apache.derby.tools.dblook.go(Unknown Source)&lt;br/&gt;
  at org.apache.derby.tools.dblook.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
  at org.apache.derby.tools.dblook.main(Unknown Source)&lt;br/&gt;
Caused by: org.apache.derby.client.am.SqlException: Comparisons between &apos;CHAR (UCS_BASIC)&apos; and &apos;CHAR (TERRITORY_BASED)&apos; are not supported. Types must be comparable. String types must also have matching collation. If collation does not match, a possible solution is to cast operands to force them to the default collation (e.g. select tablename from sys.systables where CAST(tablename as VARCHAR(128)) = &apos;T1&apos;)&lt;br/&gt;
  at org.apache.derby.client.am.Statement.completeSqlca(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.net.NetStatementReply.parsePrepareError(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.net.NetStatementReply.parsePRPSQLSTTreply(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.net.NetStatementReply.readPrepareDescribeOutput(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.net.StatementReply.readPrepareDescribeOutput(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.net.NetStatement.readPrepareDescribeOutput_(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.am.Statement.readPrepareDescribeOutput(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.am.Statement.flowExecute(Unknown Source)&lt;br/&gt;
  at org.apache.derby.client.am.Statement.executeQueryX(Unknown Source)&lt;br/&gt;
  ... 5 more&lt;br/&gt;
&amp;#8211; **--&amp;gt; DEBUG: Comparisons between &apos;CHAR (UCS_BASIC)&apos; and &apos;CHAR (TERRITORY_BASED)&apos; are not supported. Types must be comparable. String types must also have matching collation. If collation does not match, a possible solution is to cast operands to force them to the default collation (e.g. select tablename from sys.systables where CAST(tablename as VARCHAR(128)) = &apos;T1&apos;) &lt;/p&gt;</description>
                <environment></environment>
        <key id="12389390">DERBY-3458</key>
            <summary>dblook fails on TERRITORY_BASED databases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="whistle">Stephan van Loendersloot</assignee>
                                    <reporter username="whistle">Stephan van Loendersloot</reporter>
                        <labels>
                    </labels>
                <created>Sat, 23 Feb 2008 19:24:57 +0000</created>
                <updated>Fri, 25 Apr 2008 17:15:21 +0100</updated>
                            <resolved>Sun, 9 Mar 2008 17:04:15 +0000</resolved>
                                    <version>10.3.2.1</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12572245" author="whistle" created="Mon, 25 Feb 2008 21:32:29 +0000"  >&lt;p&gt;The patch has changed queries in the required files as stated in my original report.&lt;/p&gt;

&lt;p&gt;I&apos;ve added a functional test to the tools section which passes cleanly, but it isn&apos;t included in this patch, because I&apos;m not sure how to proceed.&lt;/p&gt;

&lt;p&gt;I&apos;d be glad if someone could inform me if  I should create a new issue, or a subtask, or do something else to contribute that as well.&lt;/p&gt;

</comment>
                            <comment id="12572249" author="mamtas" created="Mon, 25 Feb 2008 21:40:40 +0000"  >&lt;p&gt;Stephan, thanks for researhing AND fixing the issue. Great job. I looked through the code changes and they look good to me. You can go ahead and submit the functional test as part of this same jira entry. &lt;/p&gt;</comment>
                            <comment id="12572302" author="whistle" created="Mon, 25 Feb 2008 23:28:48 +0000"  >&lt;p&gt;The diff in patch_2 contains the function test for territory based databases. The original dblook_test.java has been slightly modified, to be able to extend it to the added dblook_test_territory.java.&lt;/p&gt;

&lt;p&gt;I&apos;ve only tested the &apos;derbytools&apos; suite (and it runs without errors), because my test environment is somehow not setup properly to run &apos;derbyAll&apos;, which hangs on network server tests. This doesn&apos;t seem to be due to this patch, it also happens when I test on released versions. I need to look into that some more, but I&apos;d appreciate it if someone else can verify that &apos;derbyAll&apos; works.&lt;/p&gt;

&lt;p&gt;Once I get my test environment right, I may add another function test which extends dblook_test_net.java, though for now, dblook works on our territory-based network servers (production).&lt;/p&gt;</comment>
                            <comment id="12572368" author="mamtas" created="Tue, 26 Feb 2008 06:36:09 +0000"  >&lt;p&gt;Stephan, I did not think through completely when I sent my feedback on the patch(&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3458&quot; title=&quot;dblook fails on TERRITORY_BASED databases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3458&quot;&gt;&lt;del&gt;DERBY-3458&lt;/del&gt;&lt;/a&gt;_patch_1.txt) earlier today. The patch is CASTing the system table columns (all the system table character columns have UCS_BASIC collation associated with them) to current schema&apos;s collation and then comparing the resultant character string with a constant character string (constant character strings always take the collation of the schema in which the statement is getting compiled). This is really not we want. We want to ensure that when dealing with system table character columns, we use UCS_BASIC for collation. This may or may not happen with the supplied patch because we may or may not be system schema when the queries get compiled. In other words, the patch could cause Derby to use territory based collation for system columns rather than using UCS_BASIC collation because the current schema is user schema and not system schema. (I am not familiar enough with dblook to know what the current schema is when these queries are run). &lt;/p&gt;

&lt;p&gt;I think the correct solution is to make sure that we are in the system schema when these queries are compiled. That will ensure that the character string constants will take the collation of the system schema. This will also ensure that we do not run into collation mismatch errors.&lt;/p&gt;

&lt;p&gt;I apologize if you ended up wasting lot of time on this issue based on my earlier feedback.&lt;/p&gt;</comment>
                            <comment id="12572621" author="whistle" created="Tue, 26 Feb 2008 19:23:18 +0000"  >&lt;p&gt;Hello Mamta,&lt;/p&gt;

&lt;p&gt;Thanks for taking time to review my proposed solution. I really don&apos;t think I&apos;ve wasted time, since the functional test took more time than creating the patch, but it provided some useful insights on how this stuff currently works in Derby. Besides, I&apos;ll need the test anyway when trying to resolve this issue.&lt;/p&gt;

&lt;p&gt;Now, if I understand correctly, you&apos;re basically implying that &lt;b&gt;all&lt;/b&gt; operations on system tables should be done with UCS_BASIC collation, which can be enforced by changing the current connection schema to SYS. I read about the UCS_BASIC part while lurking on the dev-list, but a proposed workaround seemed to use casting.&lt;/p&gt;

&lt;p&gt;Having investigated the internals of dblook, I found that only one connection to the database is made, which is passed on to all required (static) methods, with no other instances around. This would really make the patch a lot simpler.&lt;/p&gt;

&lt;p&gt;While poking around in a few other tests, but specifcally CollationTest.java, I came up with the idea to ensure that for &apos;dblook_test.java&apos; the UCS_BASIC collation type is used right after the database has been created and for &apos;dblook_test_territory&apos; the &apos;TERRITORY_BASED&apos; collation type is used, just to be sure.&lt;/p&gt;

&lt;p&gt;This will affect the network test as well, but that doesn&apos;t have a territory-based test yet (as I still have to correct my environment), so I don&apos;t think it causes any problems.&lt;/p&gt;

&lt;p&gt;I&apos;ll make the changes and return shortly with a report and most likely a new patch.&lt;/p&gt;


&lt;p&gt; --Stephan.&lt;/p&gt;
</comment>
                            <comment id="12572719" author="whistle" created="Tue, 26 Feb 2008 23:45:05 +0000"  >&lt;p&gt;Attached patch 3, as described in my earlier comment.&lt;/p&gt;

&lt;p&gt;Instead of returning shortly, I couldn&apos;t resist and figured out why my test-environment wasn&apos;t setup properly, so I could add function tests to the suite &apos;derbynetmats&apos; as well. &lt;/p&gt;

&lt;p&gt;The reason why I couldn&apos;t get it right the first time, is because the documentation at testing/README.htm refers to an incorrect download location for &apos;db2jcc.jar&apos; and &apos;db2jcc_license_c.jar&apos;. At that location, DB2 drivers for Linux can be downloaded, but they fail the Derby tests.&lt;/p&gt;

&lt;p&gt;It might be wise to update the readme and point to the right location, but maybe that&apos;s something for a new issue.&lt;/p&gt;

&lt;p&gt;Anyway..  now both &apos;derbytools&apos; and &apos;derbynetmats&apos; pass the tests... I will run &apos;derbyall&apos; later this night and review the outcome in the morning.&lt;/p&gt;

&lt;p&gt;In the meantime I&apos;d be happy to hear someone else confirming that this patch is working.&lt;/p&gt;

&lt;p&gt;Thanks, &lt;/p&gt;

&lt;p&gt;    --Stephan.&lt;/p&gt;


</comment>
                            <comment id="12572893" author="whistle" created="Wed, 27 Feb 2008 12:26:03 +0000"  >&lt;p&gt;Marking patch as unavailable. The test functionality for &apos;derbyall&apos; doesn&apos;t complete. It looks like I need to rename the output of dblook after each test to prevent successive tests from failing. Will be back with a new patch when &apos;derbyall&apos; completes successfully.&lt;/p&gt;</comment>
                            <comment id="12573618" author="mamtas" created="Fri, 29 Feb 2008 06:44:19 +0000"  >&lt;p&gt;Stephan, I looked at &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3458&quot; title=&quot;dblook fails on TERRITORY_BASED databases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3458&quot;&gt;&lt;del&gt;DERBY-3458&lt;/del&gt;&lt;/a&gt;_patch_3.txt and it looks good. It&apos;s good that we get that only one connection is made which makes the fix clean. Once you have the functional test, I will be happy to apply your patch and run the tests on my machine.&lt;/p&gt;</comment>
                            <comment id="12574860" author="whistle" created="Tue, 4 Mar 2008 06:42:18 +0000"  >&lt;p&gt;Hello again, and my apologies for the delay, my daily job required all of my attention.&lt;/p&gt;

&lt;p&gt;I attached a cumulative patch v4, which replaces all previous patches. All functional tests (derbyall) run without errors. Important changes are only in the tests, which now rename the output of dblook &lt;b&gt;after&lt;/b&gt; completion, instead of at the start. In addition, the master test for DerbyNetClient needed a .out file.&lt;/p&gt;

&lt;p&gt;Since multiple tests may run, it was insufficient to just rename dblook.log to f.e. dblook_test_net.log. The central method renameDbLookLog() in dblook_test.java now renames to dblook_test_net0.log, dblook_test_net1.log and so on.&lt;/p&gt;

&lt;p&gt;Please note that I haven&apos;t run tests for optional suites like mobile environments, though modifications have been made to incorporate them.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Stephan.&lt;/p&gt;</comment>
                            <comment id="12575250" author="mamtas" created="Wed, 5 Mar 2008 06:44:33 +0000"  >&lt;p&gt;Just an FYI that I will look at the patch tomorrow and if everything runs fine, I will go ahead and check it in.&lt;/p&gt;

&lt;p&gt;Thanks, Stephan, for your work on this jira entry. Also, just wanted to mention that you might consider submitting an ICLA with ASF if you plan on contributing more to Derby.&lt;/p&gt;

&lt;p&gt;These pages on the Derby wiki has information for getting involved in the Derby project.&lt;br/&gt;
&lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyDev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DerbyDev&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyContributorChecklist&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DerbyContributorChecklist&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12575500" author="mamtas" created="Wed, 5 Mar 2008 21:26:51 +0000"  >&lt;p&gt;Committed changes submitted by Stephan using revision 634037 into trunk. I will work on backporting it to 10.3&lt;/p&gt;</comment>
                            <comment id="12575634" author="dyret" created="Thu, 6 Mar 2008 09:54:08 +0000"  >&lt;p&gt;Patch has been committed.&lt;/p&gt;</comment>
                            <comment id="12576798" author="whistle" created="Sun, 9 Mar 2008 17:04:15 +0000"  >&lt;p&gt;Hi Mamta (and others),&lt;/p&gt;

&lt;p&gt;Thanks for reviewing and committing the patch, everything works fine now, so I&apos;ll close this bug.&lt;/p&gt;

&lt;p&gt;I will be looking into submitting an ICLA with the ASF, a couple of potential features and bugs caught my interest.&lt;/p&gt;

&lt;p&gt;I&apos;d first like to try to make myself more familiar with the Derby codebase, if and when time permits.&lt;/p&gt;

&lt;p&gt;Thanks again.&lt;/p&gt;

&lt;p&gt;    -Stephan.&lt;/p&gt;
</comment>
                            <comment id="12577056" author="mamtas" created="Mon, 10 Mar 2008 16:19:12 +0000"  >&lt;p&gt;Migrated the changes into 10.3 codeline with revision 635588.&lt;/p&gt;</comment>
                            <comment id="12592423" author="kmarsden" created="Fri, 25 Apr 2008 17:15:21 +0100"  >&lt;p&gt;Adding 10.3.2.2 to fix version as this fix was ported to the 10.3 branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12376447" name="DERBY-3458_patch_1.stat" size="334" author="whistle" created="Mon, 25 Feb 2008 21:32:29 +0000"/>
                            <attachment id="12376446" name="DERBY-3458_patch_1.txt" size="6062" author="whistle" created="Mon, 25 Feb 2008 21:32:29 +0000"/>
                            <attachment id="12376457" name="DERBY-3458_patch_2.stat" size="500" author="whistle" created="Mon, 25 Feb 2008 23:28:48 +0000"/>
                            <attachment id="12376456" name="DERBY-3458_patch_2.txt" size="80864" author="whistle" created="Mon, 25 Feb 2008 23:28:48 +0000"/>
                            <attachment id="12376570" name="DERBY-3458_patch_3.stat" size="1605" author="whistle" created="Tue, 26 Feb 2008 23:45:05 +0000"/>
                            <attachment id="12376568" name="DERBY-3458_patch_3.txt" size="1055" author="whistle" created="Tue, 26 Feb 2008 23:45:05 +0000"/>
                            <attachment id="12376569" name="DERBY-3458_patch_3_function_tests.txt" size="114968" author="whistle" created="Tue, 26 Feb 2008 23:45:05 +0000"/>
                            <attachment id="12377040" name="DERBY-3458_patch_4.stat" size="1811" author="whistle" created="Tue, 4 Mar 2008 06:42:18 +0000"/>
                            <attachment id="12377038" name="DERBY-3458_patch_4.txt" size="1055" author="whistle" created="Tue, 4 Mar 2008 06:42:18 +0000"/>
                            <attachment id="12377039" name="DERBY-3458_patch_4_function_tests.txt" size="138870" author="whistle" created="Tue, 4 Mar 2008 06:42:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 25 Feb 2008 21:40:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23649</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0yxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39476</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>