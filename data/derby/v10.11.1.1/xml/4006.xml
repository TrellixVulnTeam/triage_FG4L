<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:48:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4006/DERBY-4006.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4006] ALTER COLUMN ... WITH DEFAULT NULL does not change the default</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4006</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Reported on derby-user.&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/200901.mbox/%3c21349727.post@talk.nabble.com%3e&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/200901.mbox/%3c21349727.post@talk.nabble.com%3e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t (x varchar(5) default &apos;abc&apos;);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; alter table t alter column x with default null;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t values default;&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from t;&lt;br/&gt;
X    &lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;abc  &lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;</description>
                <environment></environment>
        <key id="12411940">DERBY-4006</key>
            <summary>ALTER COLUMN ... WITH DEFAULT NULL does not change the default</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Jan 2009 11:57:32 +0000</created>
                <updated>Tue, 30 Jun 2009 16:55:40 +0100</updated>
                            <resolved>Mon, 19 Jan 2009 18:09:38 +0000</resolved>
                                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.3.3.0</version>
                    <version>10.4.1.3</version>
                    <version>10.4.2.0</version>
                                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12661954" author="knutanders" created="Thu, 8 Jan 2009 12:04:43 +0000"  >&lt;p&gt;This is a regression introduced between 10.2.1.6 and 10.2.2.0.&lt;/p&gt;</comment>
                            <comment id="12661961" author="knutanders" created="Thu, 8 Jan 2009 13:02:20 +0000"  >&lt;p&gt;It looks like the behaviour changed after this commit:&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------------------&lt;br/&gt;
r474502 | bpendleton | 2006-11-13 21:36:51 +0100 (Mon, 13 Nov 2006) | 13 lines&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1495&quot; title=&quot;Attempt to modify an identity column error after resetting identity column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1495&quot;&gt;&lt;del&gt;DERBY-1495&lt;/del&gt;&lt;/a&gt;: Error modifying an identity column after altering the column&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1645&quot; title=&quot;ALTER TABLE ... SET INCREMENT BY X... Turns off the &amp;quot;Generated By Default&amp;quot; identity column constraint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1645&quot;&gt;&lt;del&gt;DERBY-1645&lt;/del&gt;&lt;/a&gt;: ALTER TABLE SET INCREMENT turns off &quot;Generated By Default&quot;&lt;/p&gt;

&lt;p&gt;This patch changes ModifyColumnNode.bindAndValidateDefault so that it&lt;br/&gt;
detects the case(s) where the user is altering aspects of an identity column,&lt;br/&gt;
and ensures that the other aspects of that identity column are preserved and&lt;br/&gt;
not lost. The crucial issue is that if the column is Generated By Default,&lt;br/&gt;
then the DefaultInfoImpl column in the SYSCOLUMNS table needs to get&lt;br/&gt;
retained when the user uses ALTER TABLE to change either the start value&lt;br/&gt;
or the increment value; otherwise the behavior effectively switches from&lt;br/&gt;
Generated By Default to Generated Always.&lt;/p&gt;


&lt;p&gt;------------------------------------------------------------------------&lt;/p&gt;</comment>
                            <comment id="12661980" author="bryanpendleton" created="Thu, 8 Jan 2009 14:40:52 +0000"  >&lt;p&gt;Thanks for tracking this down, Knut. I&apos;ll have a look and see if I can figure out what broke.&lt;/p&gt;</comment>
                            <comment id="12662003" author="bryanpendleton" created="Thu, 8 Jan 2009 15:30:12 +0000"  >&lt;p&gt;I think that &quot;default NULL&quot; is a very special case, and ModifyColumnNode is&lt;br/&gt;
having trouble distinguishing between the case where the user didn&apos;t&lt;br/&gt;
specify a default at all, versus the case where they explicitly specified a default&lt;br/&gt;
value of NULL.&lt;/p&gt;

&lt;p&gt;I think that the easiest thing is probably to enhance ModifyColumnNode to&lt;br/&gt;
have a boolean which states whether the user did or did not explicitly&lt;br/&gt;
specify a default value, so that we can change line 346 of ModifyColumnNode from&lt;/p&gt;

&lt;p&gt;  if (defaultNode == null)&lt;/p&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;p&gt;  if (! statementExplicitlySpecifiedDefaultForColumn)&lt;/p&gt;</comment>
                            <comment id="12662017" author="knutanders" created="Thu, 8 Jan 2009 15:58:16 +0000"  >&lt;p&gt;There is a method in sqlgrammar.jj called defaultNullOnlyClause() which appears to be meant for this case. It&apos;s currently not used, though.&lt;/p&gt;</comment>
                            <comment id="12662025" author="knutanders" created="Thu, 8 Jan 2009 16:20:09 +0000"  >&lt;p&gt;Shouldn&apos;t defaultNode be an object of type UntypedNullConstantNode in this case, and not null? At least, that&apos;s how I understand the code.&lt;/p&gt;</comment>
                            <comment id="12662029" author="knutanders" created="Thu, 8 Jan 2009 16:41:16 +0000"  >&lt;p&gt;Or actually... It seems like the defaultNode argument (with declared type Object) passed to ColumnDefinitionNode.init() is an UntypedNullConstantNode, but the instance variable defaultNode is declared to be of type DefaultNode, and it cannot hold an UntypedNullConstantNode, so it should be null in this case.&lt;/p&gt;

&lt;p&gt;Adding a boolean sounds like a good idea. +1&lt;/p&gt;</comment>
                            <comment id="12662040" author="bryanpendleton" created="Thu, 8 Jan 2009 17:06:09 +0000"  >&lt;p&gt;Attached is &apos;quickCodePatch.diff&apos;, which seems to make the test case pass.&lt;/p&gt;

&lt;p&gt;I haven&apos;t done any additional testing, and the patch is not for commit, just&lt;br/&gt;
to give an idea of a possible approach to a fix.&lt;/p&gt;

&lt;p&gt;I&apos;ll explore a full patch based on this idea, but would welcome any feedback&lt;br/&gt;
in the meantime.&lt;/p&gt;</comment>
                            <comment id="12662086" author="knutanders" created="Thu, 8 Jan 2009 19:41:36 +0000"  >&lt;p&gt;The check for (defaultNode == null) in ModifyColumnNode was supposed to mean &quot;no default value was specified&quot;. Ignoring for a moment that we don&apos;t currently have syntax for it in ALTER TABLE, a default value in a ModifyColumnNode could also be a generation clause, in which case the instance variable defaultNode is also null. So I&apos;m wondering if the new check for (defaultNode == null &amp;amp;&amp;amp; !defaultNULLExplicitlySpecified) still doesn&apos;t express exactly what we want to check (although I&apos;m convinced that it fixes the bug and does not cause any problems with the currently accepted syntax for ALTER TABLE).&lt;/p&gt;

&lt;p&gt;Do you think it would make sense to instead have a boolean called keepCurrentDefault that we initialized in ColumnDefinitionNode.init() like this? (note the difference between the local variable defaultNode being null and the instance variable defaultNode being null)&lt;/p&gt;

&lt;p&gt;    keepCurrentDefault = (defaultNode == null);&lt;/p&gt;

&lt;p&gt;Then the check in ModifyColumnNode would simply be &quot;if (keepCurrentDefaultValue) ...&quot;. This way we check that &quot;no default is associated with this ColumnDefinitionNode&quot; rather than &quot;no DefaultNode or UntypedNullConstantNode is associated with this ModifyColumnNode&quot;. Don&apos;t know if this makes any sense at all, though, but I thought I&apos;d raise the issue.&lt;/p&gt;</comment>
                            <comment id="12662109" author="bryanpendleton" created="Thu, 8 Jan 2009 20:33:11 +0000"  >&lt;p&gt;Thanks Knut, that seems like a cleaner wording for the variable name.&lt;/p&gt;

&lt;p&gt;Meanwhile, my regression test run with the &apos;quickCodePatch&apos; applied did not&lt;br/&gt;
find any additional problems.&lt;/p&gt;

&lt;p&gt;I&apos;ll re-work the patch slightly, incorporating your ideas, adding some comments&lt;br/&gt;
and some tests, and be back later with a reviewable patch.&lt;/p&gt;</comment>
                            <comment id="12662120" author="bryanpendleton" created="Thu, 8 Jan 2009 21:10:18 +0000"  >&lt;p&gt;Updated the patch with some early review comments and added a test.&lt;/p&gt;

&lt;p&gt;Please have a look at &apos;patchWithTest.diff&apos; at your convenience.&lt;/p&gt;</comment>
                            <comment id="12662264" author="knutanders" created="Fri, 9 Jan 2009 07:24:09 +0000"  >&lt;p&gt;The patch looks good to me, and thanks for writing such a clear and detailed comment.&lt;br/&gt;
+1 to commit if the regression tests pass.&lt;/p&gt;</comment>
                            <comment id="12662287" author="knutanders" created="Fri, 9 Jan 2009 09:11:30 +0000"  >&lt;p&gt;I played some more with the patch and didn&apos;t find any problems. I don&apos;t know if it warrants an extra test case, but I found another manifestation of the bug fixed by the patch. Without the patch, this does not raise an error:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; alter table t add column y int generated always as (-1);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; alter table t alter column y default null;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;Even though it doesn&apos;t raise an error, it doesn&apos;t actually change the default value. Specifying a non-null default would raise an error even without the patch.&lt;/p&gt;

&lt;p&gt;With the patch, it does raise an error:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; alter table t add column y int generated always as (-1);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; alter table t alter column y default null;&lt;br/&gt;
ERROR 42XA7: &apos;Y&apos; is a generated column. You cannot change its default value.&lt;/p&gt;

&lt;p&gt;(Strangely though, if the column is GENERATED ALWAYS AS IDENTITY, you are allowed to change the default value. But that&apos;s not related to this issue.)&lt;/p&gt;</comment>
                            <comment id="12662586" author="bryanpendleton" created="Sat, 10 Jan 2009 00:55:20 +0000"  >&lt;p&gt;Those test cases seem quite useful and relevant to me, thanks for sending them along.&lt;/p&gt;

&lt;p&gt;I&apos;ve updated the patch, and verified that the regression tests pass.&lt;/p&gt;

&lt;p&gt;If there are no additional comments, I&apos;ll submit addGenColTest.diff to the&lt;br/&gt;
trunk over the next few days.&lt;/p&gt;</comment>
                            <comment id="12662707" author="bryanpendleton" created="Sun, 11 Jan 2009 00:05:04 +0000"  >&lt;p&gt;Committed addGenColTest.diff to the trunk as revision 733401.&lt;/p&gt;

&lt;p&gt;If no new problems show up, I&apos;ll investigate merging this change to the 10.4 branch.&lt;/p&gt;</comment>
                            <comment id="12662834" author="bryanpendleton" created="Sun, 11 Jan 2009 23:17:18 +0000"  >&lt;p&gt;In order to successfully merge this patch back to the 10.4 branch,&lt;br/&gt;
the tests for the ALTER COLUMN behavior on generated columns&lt;br/&gt;
must be removed, as 10.4 does not have generated column support.&lt;/p&gt;</comment>
                            <comment id="12663028" author="bryanpendleton" created="Mon, 12 Jan 2009 18:09:04 +0000"  >&lt;p&gt;Attached &apos;tenFourPatch.diff&apos; is the patch I propose to apply to the 10.4 branch.&lt;/p&gt;

&lt;p&gt;The only difference between this patch and the mainline patch is the&lt;br/&gt;
removal of the &quot;generated as (-1)&quot; test case from the autoincrement suite.&lt;/p&gt;

&lt;p&gt;If my regression runs are clean, I intend to submit this patch to 10.4 this week.&lt;/p&gt;</comment>
                            <comment id="12663954" author="bryanpendleton" created="Thu, 15 Jan 2009 00:40:27 +0000"  >&lt;p&gt;Submitted the 10.4 change as revision 734585.&lt;/p&gt;

&lt;p&gt;Is there a need to merge this change to other branches? I&apos;m satisfied having&lt;br/&gt;
committed the fix to the trunk and to the 10.4 branch, so I propose to resolve&lt;br/&gt;
this issue at this point. Please let me know if you think more work is necessary&lt;br/&gt;
at this time.&lt;/p&gt;</comment>
                            <comment id="12665076" author="knutanders" created="Mon, 19 Jan 2009 09:31:17 +0000"  >&lt;p&gt;Thanks for fixing this, Bryan. I&apos;ve verified that it works on head of trunk and 10.4 now. I&apos;m happy with having the fix on those two branches, but anyone should feel free to merge it to 10.3 and 10.2 as well if they think that&apos;s required. It might be worth the extra effort to ensure that we don&apos;t have any known regressions on the stable branches.&lt;/p&gt;</comment>
                            <comment id="12665174" author="bryanpendleton" created="Mon, 19 Jan 2009 18:09:38 +0000"  >&lt;p&gt;Thanks Knut for all the help on this. If anyone decides later on that they wish&lt;br/&gt;
to have this fix in an earlier branch, I think it should be a straightforward&lt;br/&gt;
merge and I&apos;d be glad to help. For the time being, though, I&apos;m marking the&lt;br/&gt;
issue as resolved.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12397583" name="addGenColTest.diff" size="6120" author="bryanpendleton" created="Sat, 10 Jan 2009 00:55:20 +0000"/>
                            <attachment id="12397446" name="patchWithTest.diff" size="4490" author="bryanpendleton" created="Thu, 8 Jan 2009 21:10:18 +0000"/>
                            <attachment id="12397437" name="quickCodePatch.diff" size="1549" author="bryanpendleton" created="Thu, 8 Jan 2009 17:06:09 +0000"/>
                            <attachment id="12397702" name="tenFourPatch.diff" size="5525" author="bryanpendleton" created="Mon, 12 Jan 2009 18:09:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 8 Jan 2009 14:40:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23966</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0uzz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38840</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>