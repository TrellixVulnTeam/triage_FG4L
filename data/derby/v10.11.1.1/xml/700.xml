<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:43 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-700/DERBY-700.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-700] Derby does not prevent dual boot of database from different classloaders on Linux and Mac OS X</title>
                <link>https://issues.apache.org/jira/browse/DERBY-700</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Derby does not prevent dual boot from two different classloaders on Linux and Mac OS X.&lt;/p&gt;


&lt;p&gt;To reproduce run the  program DualBootRepro with no derby jars in your classpath. The program assumes derby.jar is in 10.1.2.1/derby.jar, you can change the location by changing the DERBY_LIB_DIR variable.&lt;/p&gt;

&lt;p&gt;On Linux the output is:&lt;/p&gt;

&lt;p&gt;$java -cp . DualBootRepro&lt;br/&gt;
Loading derby from &lt;a href=&quot;file:10.1.2.1/derby.jar&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:10.1.2.1/derby.jar&lt;/a&gt;&lt;br/&gt;
10.1.2.1/derby.jar&lt;br/&gt;
Booted database in loader java.net.URLClassLoader@8ed465&lt;br/&gt;
FAIL: Booted database in 2nd loader java.net.URLClassLoader@dc6a77&lt;/p&gt;


&lt;p&gt;On Windows I get the expected output.&lt;br/&gt;
$ java -cp . DualBootRepro&lt;br/&gt;
Loading derby from &lt;a href=&quot;file:10.1.2.1/derby.jar&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:10.1.2.1/derby.jar&lt;/a&gt;&lt;br/&gt;
10.1.2.1/derby.jar&lt;br/&gt;
Booted database in loader java.net.URLClassLoader@1ac04e8&lt;br/&gt;
PASS: Expected exception for dualboot:Another instance of Derby may have already booted the database D:\marsden\repro\dualboot\mydb.&lt;/p&gt;

</description>
                <environment>ava -version&lt;br/&gt;
java version &amp;quot;1.4.2_08&amp;quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.4.2_08-b03)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.4.2_08-b03, mixed mode)&lt;br/&gt;
&lt;br/&gt;
also&lt;br/&gt;
&lt;br/&gt;
java version &amp;quot;1.5.0_19&amp;quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_19-b02-304)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.5.0_19-137, mixed mode, sharing)&lt;br/&gt;
on Mac OS X 10.5.7.</environment>
        <key id="12325539">DERBY-700</key>
            <summary>Derby does not prevent dual boot of database from different classloaders on Linux and Mac OS X</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Nov 2005 06:36:34 +0000</created>
                <updated>Thu, 2 May 2013 03:29:06 +0100</updated>
                            <resolved>Thu, 27 Aug 2009 17:23:24 +0100</resolved>
                                    <version>10.1.3.3</version>
                    <version>10.2.2.1</version>
                    <version>10.3.3.1</version>
                    <version>10.4.2.1</version>
                    <version>10.5.3.1</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.1.3.3</fixVersion>
                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>2</watches>
                                                                                                            <comments>
                            <comment id="12357290" author="kmarsden" created="Fri, 11 Nov 2005 06:39:26 +0000"  >&lt;p&gt;DualBootRepro Program to reproduce dual boot from two classloaders in  Linux.&lt;/p&gt;

&lt;p&gt;Change DERBY_LIB_DIR   to derby directory and run without derby jars in our classpath.&lt;br/&gt;
java -cp  .  DualBootRepro&lt;/p&gt;</comment>
                            <comment id="12357292" author="kmarsden" created="Fri, 11 Nov 2005 06:51:20 +0000"  >&lt;p&gt;Sysinfo output.&lt;/p&gt;

&lt;p&gt;java -cp ./10.1.2.1/derby.jar org.apache.derby.tools.sysinfo&lt;br/&gt;
------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.4.2_08&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
Java home:       /usr/lib/SunJava2-1.4.2/jre&lt;br/&gt;
Java classpath:  ./10.1.2.1/derby.jar&lt;br/&gt;
OS name:         Linux&lt;br/&gt;
OS architecture: i386&lt;br/&gt;
OS version:      2.6.5-7.201-smp&lt;br/&gt;
...&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.4&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: J2SE 1.4.2 - JDBC 3.0&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;/.../derby.jar&amp;#93;&lt;/span&gt; 10.1.2.1 - (330608)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Locale Information -----------------&lt;br/&gt;
------------------------------------------------------&lt;/p&gt;
</comment>
                            <comment id="12357312" author="tsuresh" created="Fri, 11 Nov 2005 09:40:47 +0000"  >&lt;p&gt;My guess is , currently Derby seems to catch the IO exception and turn it into a readonly db , when file lock  fails with OverlappingFileLockException. By  correctly catching java.nio.channels.OverlappingFileLockException,  we might be able to prevent multi boots with in the same jvm using different class loaders. &lt;/p&gt;

</comment>
                            <comment id="12363295" author="tsuresh" created="Fri, 20 Jan 2006 05:23:55 +0000"  >&lt;p&gt;Hi Kathy , &lt;/p&gt;

&lt;p&gt;I  am attempting to fix this bug, just realized I may  not  be able to add the  repro in jira into the functional tests., repro is expecting   derby classes should not be in there in the   classpath,  I was wondering by chance did u write a custom class loader test for Derby  ?   I could not find one in the functional tests. &lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
-suresh&lt;/p&gt;
</comment>
                            <comment id="12363313" author="kmarsden" created="Fri, 20 Jan 2006 07:05:29 +0000"  >&lt;p&gt;Here is an updated repro with a classloader that  should not require the classpath remove other derby jars&lt;/p&gt;</comment>
                            <comment id="12363492" author="tsuresh" created="Sat, 21 Jan 2006 11:07:28 +0000"  >&lt;p&gt;After doing bit of testing realized  checking for  OverlappingFileLockException does not work.  This exception is reliable only   if   the same file channel instance  is used.,  With multiple class loaders  &lt;br/&gt;
I don&apos;t know  how it is possible to have a sigle  file channel object.   &lt;/p&gt;

&lt;p&gt;On Linux  ,  one can acquire the lock on the same region  using  diferent file channels on the same file. &lt;/p&gt;

&lt;p&gt;Realated info from the java docs:&lt;br/&gt;
java.nio.channel.FileLock &lt;br/&gt;
,On some systems, closing a channel releases all locks held by the Java virtual machine on the underlying file regardless of whether the locks were acquired via that channel or via another channel open on the same file. It is strongly recommended that, within a program, a unique channel be used to acquire all locks on any given file.&lt;/p&gt;
</comment>
                            <comment id="12363520" author="mikem" created="Sun, 22 Jan 2006 02:18:21 +0000"  >&lt;p&gt;Database corruption can result anytime 2 different systems boot the same Derby database.  DB corruption can happen&lt;br/&gt;
even if the booting systems perform no updates if the there is recovery to do during boot, in that case 2 separate recovery systems will be opertating in an uncoordinated manner on the same log file, and applying uncoordinated changes to the data files.  Without multiple class loaders or  with multiple JVM&apos;s derby uses file locking to prevent this.&lt;br/&gt;
It looks like file locking from the same jvm and 2 class loaders does not work, does anyone have any idea how to &lt;br/&gt;
implement a locking scheme that will work from the same jvm , with 2 class loaders.&lt;/p&gt;</comment>
                            <comment id="12423387" author="kmarsden" created="Tue, 25 Jul 2006 18:08:04 +0100"  >&lt;p&gt;Marking this issue Critical  as it is a corruption issue that has in the past and surely will in the future affect users and cause unrecoverable corruption in production environments.  The corruption is triggered by a usage error, but unrecoverable database corruption is a high price to pay for deciding to connect with IJ while your APP Server, Eclipse or other environment  has  loaded Derby with a classloader.&lt;/p&gt;


&lt;p&gt;Also marking this issue as 10.2 as a high value fix.  I think there may be technical issues that make it difficult to address in the 10.2 time frame, so if someone with expertise in the area thinks it is not possible to address in that timeframe, please move it to an appropriate release, maybe 10.2.2.  It is not a regression so as serious as it is I don&apos;t see it as an absolute showstopper for the release.&lt;/p&gt;






</comment>
                            <comment id="12423920" author="rhillegas" created="Thu, 27 Jul 2006 21:57:46 +0100"  >&lt;p&gt;Bumping urgency.&lt;/p&gt;</comment>
                            <comment id="12424848" author="narayanan" created="Tue, 1 Aug 2006 13:45:42 +0100"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;We could solve this problem by setting a System property before booting a database and checking for the property during subsequent boots. When the database is shutdown we set the property to false. For example when we boot a database named mydb then we set the property derby.dblock.mydb = true. Now during subsequent boots we could check for this system variable and if it is set to true throw an exception. During the shutdown of the database we set this variable to false. I tried an attempt along this line in the attached patch. &lt;/p&gt;

&lt;p&gt;I HAVE NOT run the patch with security manager enabled. The sample repro attached with this issue passes with this fix. &lt;/p&gt;

&lt;p&gt;Pls note that the patch is not for a commit but is just to represent what I have in mind as a solution, in the form of code. &lt;/p&gt;

&lt;p&gt;thanx&lt;br/&gt;
Narayanan&lt;/p&gt;</comment>
                            <comment id="12424948" author="djd" created="Tue, 1 Aug 2006 18:40:37 +0100"  >&lt;p&gt;Using system properties will require that every user running with the security manager grant a new permission in their policy file to allow setting these system properties. I thought an earlier discussion on the list had recommended not to use system properties this way.&lt;/p&gt;

&lt;p&gt;One issue with system properties is that how do atomically set and get the property, I think that is needed to perform locking?&lt;br/&gt;
In your current patch, there is a window between where you get and set the property where another thread in a anoter class loader could&lt;br/&gt;
come in and &quot;lock&quot; the database, resulting in two active derby instances connecting to the same database.&lt;/p&gt;

&lt;p&gt;I also don&apos;t understand why on getting the system property you are catching NullPointerException and IllegalArgumentException, how would these&lt;br/&gt;
be thrown by System.getProperty()?&lt;/p&gt;</comment>
                            <comment id="12424951" author="djd" created="Tue, 1 Aug 2006 18:46:49 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-305&quot; title=&quot;[PATCH] Lock Framework - allows custom lock mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-305&quot;&gt;&lt;del&gt;LUCENE-305&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-635&quot; title=&quot;[PATCH] Decouple locking implementation from Directory implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-635&quot;&gt;&lt;del&gt;LUCENE-635&lt;/del&gt;&lt;/a&gt; may be worth looking at, lucene is re-factoring their locking (similar requirements to Derby) and maybe they have a solution for the intra-jvm lock. Otherwise has anyone done a google search on the issue?&lt;/p&gt;</comment>
                            <comment id="12425154" author="narayanan" created="Wed, 2 Aug 2006 07:31:22 +0100"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;THESE ATTACHMENTS ARE JUST AN ATTEMPT IN THE SIMULATION OF THE COMMENTS ABOVE. THEY ARE NOT FOR A COMMIT. PLS FOLLOW BELOW COMMENTS FOR DETAILS.&lt;/p&gt;

&lt;p&gt;Thanx for going through the patch and giving comments&lt;/p&gt;

&lt;p&gt;&amp;gt;Using system properties will require that every user  running with the security &lt;br/&gt;
  manager grant a new  permission in their policy file to allow setting these system &lt;br/&gt;
  properties.&lt;/p&gt;

&lt;p&gt;   I Agree, My apologies for not having gone through the earlier thread on System &lt;br/&gt;
   Properties&lt;/p&gt;

&lt;p&gt;&amp;gt; One issue with system properties is that how do atomically set and get the &lt;br/&gt;
    property, I think that is needed to perform locking? In your current patch, there is a &lt;br/&gt;
    window between where you get and set the property where  another thread in a &lt;br/&gt;
    anoter class loader could come in and &quot;lock&quot; the database, resulting in two active &lt;br/&gt;
    derby instances connecting to the same database. &lt;/p&gt;

&lt;p&gt;   Again a very valid point. I wanted to try to simulate this. So converted the whole   &lt;br/&gt;
   repro into a crude multi -threaded  application. But found found it difficult to &lt;br/&gt;
   simulate it on  my machine since one of the threads always managed  to set this &lt;br/&gt;
   property before  the other. So modified my fix by creating a sort of sync point after &lt;br/&gt;
   the getProperties.  Just to show that two seperate threads could actually reach &lt;br/&gt;
   there.&lt;/p&gt;

&lt;p&gt;  This could actually occur without this modification&lt;/p&gt;

&lt;p&gt;  1) When one of the threads gets preempted after doing a getProperties and then &lt;br/&gt;
       the other does a  getProperties. And then they proceed to completion. &lt;/p&gt;

&lt;p&gt;      Also this might just be one of the cases when this could have occurred.&lt;/p&gt;

&lt;p&gt;&amp;gt; I also don&apos;t understand why on getting the system property you are catching &lt;br/&gt;
   NullPointerException and  IllegalArgumentException, how would these be thrown &lt;br/&gt;
   by System.getProperty()?&lt;/p&gt;

&lt;p&gt;   NullPointerException - System.getProperty(null);&lt;/p&gt;

&lt;p&gt;   IllegalArgumentException - System.getProperty(&quot;&quot;);&lt;/p&gt;

&lt;p&gt;   I found it interesting to simulate the condition where the above fix might fail. &lt;br/&gt;
   Thought I could share the same with the community. So attaching the relevant files &lt;br/&gt;
   I used for generating this condition. &lt;/p&gt;

&lt;p&gt;thanx once again for the patient comments&lt;br/&gt;
Narayanan&lt;/p&gt;</comment>
                            <comment id="12425259" author="rhillegas" created="Wed, 2 Aug 2006 16:20:08 +0100"  >&lt;p&gt;Where can Derby store VM-global state? It has been pointed out that System properties are an awkward kind of VM-global state for the following reasons:&lt;/p&gt;

&lt;p&gt;1) SecurityManager problems&lt;br/&gt;
2) Race conditions&lt;/p&gt;

&lt;p&gt;What other VM-global state can Derby access? One Derby object that&apos;s global across the VM is the Derby driver registered with the DriverManager.&lt;/p&gt;

&lt;p&gt;1) Could we use the registered Derby driver to anchor VM-global state?&lt;br/&gt;
2) Are there other VM-global Derby objects which we could use?&lt;/p&gt;</comment>
                            <comment id="12425512" author="rhillegas" created="Thu, 3 Aug 2006 13:42:29 +0100"  >&lt;p&gt;It appears that fixing this bug will require us to agree on some mechanism for caching VM-global Derby state. This seems to be an architectural decision which requires careful thought and experiment. I think we should defer this to a future release. I am moving this to 10.3 because thatt&apos;s the next release available in the dropdown. I agree with Kathey that this is a good candidate for a bug fix release in the 10.2 lineage.&lt;/p&gt;</comment>
                            <comment id="12425590" author="rhillegas" created="Thu, 3 Aug 2006 19:58:30 +0100"  >&lt;p&gt;Thanks for creating the new 10.2.2.0 option, Andrew! I&apos;ve reassigned this issue to that release.&lt;/p&gt;</comment>
                            <comment id="12426168" author="narayanan" created="Mon, 7 Aug 2006 09:32:41 +0100"  >&lt;p&gt;Hi,&lt;br/&gt;
I am not working actively on this issue. Hence unassigning myself from this issue and moving on to other issues I am working on.&lt;/p&gt;

&lt;p&gt;thanx&lt;br/&gt;
Narayanan&lt;/p&gt;</comment>
                            <comment id="12456126" author="rhillegas" created="Wed, 6 Dec 2006 17:31:43 +0000"  >&lt;p&gt;Move to 10.2.3.0.&lt;/p&gt;</comment>
                            <comment id="12467564" author="fuzzylogic" created="Thu, 25 Jan 2007 20:36:44 +0000"  >&lt;p&gt;Unsetting Fix Version for unassigned issues.&lt;/p&gt;</comment>
                            <comment id="12482927" author="tsuresh" created="Wed, 21 Mar 2007 21:47:09 +0000"  >&lt;p&gt;I took a quick  looks at fixes for  &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-305&quot; title=&quot;[PATCH] Lock Framework - allows custom lock mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-305&quot;&gt;&lt;del&gt;LUCENE-305&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-635&quot; title=&quot;[PATCH] Decouple locking implementation from Directory implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-635&quot;&gt;&lt;del&gt;LUCENE-635&lt;/del&gt;&lt;/a&gt;  , which are fixed now.   I did not see any code that is attempting to solve  locking  within a jvm  across class loaders boundaries.   May be I am missing something ! &lt;/p&gt;


</comment>
                            <comment id="12483798" author="tsuresh" created="Fri, 23 Mar 2007 23:55:06 +0000"  >&lt;p&gt;There  does not seem to be any  way to get process id info that can be used to fix this problem. Existing JVM enhancement requests  filed  to get process id info:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4250622&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4250622&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do;jsessionid=7c75c6fc92c662c739fb11f620a4:YfiG?bug_id=4244896&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do;jsessionid=7c75c6fc92c662c739fb11f620a4:YfiG?bug_id=4244896&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It was interesting to  reade these reports, other developers are finding it hard to generate unique id across jvms!&lt;/p&gt;
</comment>
                            <comment id="12484513" author="mikem" created="Tue, 27 Mar 2007 18:35:46 +0100"  >&lt;p&gt;Here is a description of a possible solution - any feedback is appreciated:&lt;/p&gt;

&lt;p&gt;I would like to see some solution to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-700&quot; title=&quot;Derby does not prevent dual boot of database from different classloaders on Linux and Mac OS X&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-700&quot;&gt;&lt;del&gt;DERBY-700&lt;/del&gt;&lt;/a&gt; go into the 10.3 release, as it is too easy currently for users to access their same database from 2 different classloaders in the same JVM and corrupt their database.&lt;/p&gt;

&lt;p&gt;Let me try to explain the problem again.  Derby protects multiple thread&lt;br/&gt;
access to databases using in memory locking.  Any situation where 2 instances of Derby can access the same on disk database but not coordinate through the same in-memory locking scheme creates a situation&lt;br/&gt;
that can lead to log/data corruption.&lt;/p&gt;

&lt;p&gt;Derby coordinates access to an ondisk database using a 2 level per db&lt;br/&gt;
locking scheme.  The following is high level and probably misses some&lt;br/&gt;
detail.&lt;/p&gt;

&lt;p&gt;1) first it obtains what I refer to as an OS file lock, this is not a java defined mechanism. It depends on an OS specific behavior that it&lt;br/&gt;
is not possible to delete a file on some OS&apos;s if the file is still open&lt;br/&gt;
(the most common OS where this is true are I believe all window&apos;s&lt;br/&gt;
OS&apos;s 98, NT, 2000, xp, ...).&lt;br/&gt;
    A)  If lock file does not exist we open it and leave it open --&amp;gt; lock granted&lt;br/&gt;
    B) If lock file does exist we try to delete it, if we can then&lt;br/&gt;
       we go back to A.  If we can&apos;t we assume file is locked and&lt;br/&gt;
       give up.&lt;/p&gt;

&lt;p&gt;2) The second level is that we use java base file locking.  This only&lt;br/&gt;
   became available in 1.4.2 and later jvm&apos;s.  This does standard locking and automatically takes care of releasing lock if JVM goes&lt;br/&gt;
away.&lt;/p&gt;

&lt;p&gt;We kept both steps, even though it seems that step 2 is sufficient to&lt;br/&gt;
provide backward compatible protection.   So anyone running on a JVM&lt;br/&gt;
prior to 1.4.2 on a windows platform would still be protected.  The&lt;br/&gt;
pre-derby code base also had to worry about protecting access against&lt;br/&gt;
versions of the code that did not have step 2 implemented.&lt;/p&gt;

&lt;p&gt;The problem is that in cases where derby is run in 2 class loaders in&lt;br/&gt;
the same jvm the step 2 file locking does not work.  It is meant only&lt;br/&gt;
to protect threads in different JVMS, so it provides no help in preventing access from 2 different class loaders in the same JVM.  It&lt;br/&gt;
turns out that step 1 on windows system solves the locking problem&lt;br/&gt;
on windows systems for multiple class loaders also.&lt;/p&gt;

&lt;p&gt;So a solution should provide 2 things:&lt;br/&gt;
1) prevent access from another classloader in the same JVM&lt;br/&gt;
2) not allow false positives.  So for instance a standard &quot;lock file&quot; could be used on unix systems, creating it and when one boots check&lt;br/&gt;
for existence of the lock file and give up if it exists.  The problem&lt;br/&gt;
is that it is very easy to cause a JVM to exit without properly cleaning&lt;br/&gt;
the lock file and thus one would get into situation where user may have&lt;br/&gt;
to clean lock files by hand.&lt;/p&gt;

&lt;p&gt;Here is my current proposal, but I really don&apos;t like it &amp;#8211; I am hoping someone out there can come up with something better.&lt;/p&gt;

&lt;p&gt;o keep the step 1 and step 2 locking as described above.  It solves cross JVM locking completely.&lt;br/&gt;
o create a step 3 locking step, the only purpose is to recognize situations step 1 and 2 can&apos;t.&lt;br/&gt;
o use simple file system lock file to implement step 3 locking:&lt;br/&gt;
    A) on db boot if no lock file exists, create it and put a timestamp in the file.  This db boot is responsible for updating that timestamp&lt;br/&gt;
every N seconds, for this we need to come up with a guaranteed executing background thread - there are known problems with current background thread, and long checkpoints for instance.  On shutdown of db we delete lock file.&lt;br/&gt;
    B) on db boot if lock file exists we open it, and get the timestamp and compare it with the current timestamp.  If the difference is greater&lt;br/&gt;
than N we assume the lock file has been left around incorrectly and we&lt;br/&gt;
delete the file and go to A (or just open it and update it with our&lt;br/&gt;
current timestamp).  It probably is worth logging this event in derby.log.&lt;/p&gt;

&lt;p&gt;One nice thing about the above solution is that I think it also solves&lt;br/&gt;
our problem with muliple machines accessing the same disk (as long as&lt;br/&gt;
their timestamps are the same or close).  I think we can pick a large N&lt;br/&gt;
as this should be an error case (ie. the purpose of N is to catch the&lt;br/&gt;
case where a classloader went away without allowing us to clean up - I don&apos;t know classloader stuff to know how likely this is), but it is probably worth making it&lt;br/&gt;
configurable so we could adjust in the field if necessary.&lt;/p&gt;

&lt;p&gt;I really don&apos;t like forcing Derby to run a job every N seconds.  It could be hard to explain to users why derby is doing work every N&lt;br/&gt;
seconds even when nothing else is happening.  I worked on a different&lt;br/&gt;
product a long time ago that required us to maintain our own timer for use in scheduling waits and users noticed and complained such that we&lt;br/&gt;
had to add a backoff mechanism based on the amount of work being done&lt;br/&gt;
just so the process would not show up at a steady 1% (or whatever) on&lt;br/&gt;
there process status monitors.  Now that timer was a lot shorter than&lt;br/&gt;
seconds so it may not be an issue.&lt;/p&gt;

&lt;p&gt;Some extensions I considered:&lt;br/&gt;
1) come up with a unique ID that is specific to a JVM and can be queried by any thread in any classloader in the JVM.  If we had that then we could write that value into the step 3 lock file and we know that if we&lt;br/&gt;
opened the file and saw a different ID, the lock file was invalid.  If&lt;br/&gt;
we did this then we narrow the chance of a false positive but we eliminate the chance to catch cross machine access.&lt;/p&gt;

&lt;p&gt;2) Have the opener db log some unique id specific to it in addition to the timestamp, maybe this is just the first timestamp of the open.  Then it could at least tell the next time if another&lt;br/&gt;
class loader had incorrectly started, and throw/log some error so we&lt;br/&gt;
could catch this problem.&lt;/p&gt;

&lt;p&gt;3) maybe the value of N should be logged in the file, I think it has to&lt;br/&gt;
   be if we allow it to be configurable.&lt;/p&gt;

</comment>
                            <comment id="12484550" author="tsuresh" created="Tue, 27 Mar 2007 20:11:51 +0100"  >&lt;p&gt;While reading comments for this issue yet again, noticed Rick mentioned long&lt;br/&gt;
time ago , it might be possible to make Derby jdbc driver hold a state that &lt;br/&gt;
is global to jvm, not specific to a class loader.  Is that how it really works&lt;br/&gt;
even if the user loads the driver using class loaders ? &lt;/p&gt;

&lt;p&gt;Basically , is it possible to make  org.apache.derby.jdbc.EmbeddedDriver.java &lt;br/&gt;
statically initialize an JVMID(a UUID) that can be accessed from any class loader ?&lt;/p&gt;</comment>
                            <comment id="12484562" author="mikem" created="Tue, 27 Mar 2007 20:36:20 +0100"  >&lt;p&gt;With respect to a global state in the jdbc driver when 2 class loaders are involved, how would that work with 2 different class loaders trying to run 2 different versions of derby - say 10.3 and 10.4.  &lt;/p&gt;</comment>
                            <comment id="12484565" author="djd" created="Tue, 27 Mar 2007 20:50:33 +0100"  >&lt;p&gt;if you alluding to this comment:&lt;/p&gt;

&lt;p&gt; rick&amp;gt; One Derby object that&apos;s global across the VM is the Derby driver registered with the DriverManager.&lt;/p&gt;

&lt;p&gt;then I think that is false. Derby will have multiple drivers registered, one per classloader that booted derby.&lt;br/&gt;
(see comments for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1228&quot; title=&quot;Make it possible to run multiple instances of Derby within the same VM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1228&quot;&gt;DERBY-1228&lt;/a&gt; or java.sql.DriverManager documentation)&lt;/p&gt;</comment>
                            <comment id="12484586" author="tsuresh" created="Tue, 27 Mar 2007 21:54:09 +0100"  >&lt;p&gt;Thanks  for confirming , Dan.   I was referring to the commnet you noted.  Looks like there is  NO way to maintain an in-memory state that is  global to JVM  across class loader , other than using  a system property.&lt;/p&gt;</comment>
                            <comment id="12484998" author="tsuresh" created="Wed, 28 Mar 2007 22:30:17 +0100"  >&lt;p&gt;Thanks a lot for summarizing the problems and possible solutions &lt;br/&gt;
for this issue, Mike. I think the timer base solution you mentioned&lt;br/&gt;
might work, but I am not comfortable with a timer based solution. As you&lt;br/&gt;
mentioned, users might complain about the background writes, and also &lt;br/&gt;
I think  configuring N to the right value to differentiate false &lt;br/&gt;
negatives/positives boots going to be hard. It will depend on the load &lt;br/&gt;
and the machine configuration (no of cpus ) ..etc.&lt;/p&gt;

&lt;p&gt;I was trying to find alternative solutions, without much success. Only&lt;br/&gt;
solution I could come up with involves using a system property. I &lt;br/&gt;
understand, earlier we discussed using the system properties and it was &lt;br/&gt;
decided as not a such a good idea. But considering there are NO other &lt;br/&gt;
better solutions found for this problem, so far. I was think having one &lt;br/&gt;
property to maintain a JVMID may not be so bad, user just need to give &lt;br/&gt;
security permission to set one property, i.e  if what I &lt;br/&gt;
describe below actually works!&lt;/p&gt;

&lt;p&gt;I would really appreciate  any  suggestions/feedback  for this solution . &lt;/p&gt;

&lt;p&gt;My understanding is a solution to this problem need to solve primarily &lt;br/&gt;
following three issues:&lt;/p&gt;

&lt;p&gt;1) Maintaining a state that a database is already booted, if the database&lt;br/&gt;
   if booted successfully. &lt;br/&gt;
2) Change the state to NOT_BOOTED, if it is not booted any more because of  a&lt;br/&gt;
    a) Shutdown of the database&lt;br/&gt;
    b) Class loader that booted the db is garbage collected.&lt;br/&gt;
    c) JVM exited. &lt;/p&gt;

&lt;p&gt;3) synchronization across class loaders. &lt;/p&gt;

&lt;p&gt;Pseudo code below that attempts to solve this problems by making the &lt;br/&gt;
following Assumptions :&lt;/p&gt;

&lt;p&gt; 1) It is ok to use ONE  system property  &quot;derby.storage.jvmid&quot; to identify &lt;br/&gt;
     a jvm instance id. &lt;br/&gt;
 2) It is ok to use interned strings to synchronize across class loader. &lt;br/&gt;
 3) It is ok to call getCanonicalPath(), i think this may require permission &lt;br/&gt;
    for &quot;user.dir&quot; property if it is not already required. Other solution&lt;br/&gt;
    may be to assign an ID string on create of the DB and user that for &lt;br/&gt;
    DB level synchronization. &lt;br/&gt;
 4) It is ok to rely on the class finalizer to cleanup db lock state, &lt;br/&gt;
    when the database  is NOT any more because the loader that booted &lt;br/&gt;
    the database is garbage  collected. &lt;/p&gt;


&lt;p&gt;/*&lt;br/&gt;
Pseudo code to lock the DB to prevent multiple instance of a database running &lt;br/&gt;
concurrently through class loaders in a single instance of jvm or&lt;br/&gt;
multiple instance of jvm.   &lt;/p&gt;

&lt;p&gt;Note: Following code class is in a separate class just to understand it &lt;br/&gt;
as separate issue , this code should probably go into the &lt;br/&gt;
dataFactory class where current db-locking is done. &lt;br/&gt;
*/&lt;br/&gt;
Class DbLock {&lt;/p&gt;

&lt;p&gt;    private static final String DERYB_JVM_ID  = &quot;derby.storage.jvmid&quot;;&lt;br/&gt;
    private String dbCannonicalPath;   // canonical of the db being booted.&lt;br/&gt;
    private FileLock fileLock  = null;&lt;br/&gt;
    private boolean dbLocked = false;&lt;/p&gt;

&lt;p&gt;    DbLock (String dbCannonicalPath) &lt;/p&gt;
{
        this.dbCannonicalPath = dbCannonicalPath;
    }

&lt;p&gt;    /* &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;get a unique JVM ID&lt;br/&gt;
     */&lt;br/&gt;
    private getJvmId () {&lt;br/&gt;
        // synchronize across class loaders.&lt;br/&gt;
        synchronize(DERYB_JVM_ID) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;            jvmid = System.getProperty(DERYB_JVM_ID);&lt;br/&gt;
            // if jvm id is not already exist, generate one &lt;br/&gt;
            // and save it into the &quot;derby.storage.jvmid&quot; system&lt;br/&gt;
            // property.&lt;br/&gt;
            if (jvmid == null) &lt;/p&gt;
{
                //generate a new UUID based on the time and IP ..etc. 
                jvmid = generateJvmId() 
                    System.setProperty(&quot;derby.storage.jvmid&quot;);
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    /*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Lock the db,  so that other class loader or&lt;/li&gt;
	&lt;li&gt;another jvm won&apos;t be able to boot the same database.&lt;br/&gt;
     */&lt;br/&gt;
    public lock_db_onboot(String dbCannonicalPath)  {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         // Get a file Lock on boot() ; // this already works &lt;br/&gt;
         fileLock = getFileLock(&quot;dbex.lck&quot;);&lt;br/&gt;
         if (lock == null) &lt;/p&gt;
{
             // if we don&apos;t get lock means , some other jvm already 
             // booted it throws  ALREADY_BOOTED error.
             throw ALREADY_BOOTED;
         }
&lt;p&gt; else {&lt;/p&gt;

&lt;p&gt;             // file lock can be acquired even if the database is already &lt;br/&gt;
             // booted by a different class loader. Check if another class &lt;br/&gt;
             // loader has booted  the DB.  This is done by checking the &lt;br/&gt;
             // JVMID written in the dbex.lck  file. If the JVMID is same &lt;br/&gt;
             // as what is stored in the system property,&lt;br/&gt;
             // then database is already booted , throw the error. &lt;br/&gt;
             currentJvmId =  getJvmId();&lt;br/&gt;
             synchronize(dbCannonicalPath) {&lt;br/&gt;
                 onDisk_JVM_ID = readIdFromDisk() ; // read ID from the dbex.lck file.&lt;br/&gt;
                 if (OnDisk_JVM_ID == current_jvm_id ) &lt;br/&gt;
                     throw (&quot;DATABASE IS ALREADY BOOTED&quot;);  &lt;br/&gt;
                 else&lt;/p&gt;
{
                     dbLocked = true;
                     writeId(currentJvmId);  //update the dbex.lck file) . 
                 }
&lt;p&gt;             }&lt;br/&gt;
         }&lt;br/&gt;
    }&lt;/p&gt;



&lt;p&gt;    /*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Called on shutdown/garbage collection.&lt;br/&gt;
     */ &lt;br/&gt;
    unlock_db() {&lt;br/&gt;
        if (dbLocked) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {            Strinng Ondisk_jvm_id =  &amp;quot;-1&amp;quot;;  //jvm id should never have been a -1.            synchronize(dbCannonicalPath) {
                writeIdToDisk(Ondisk_jvm_id);  //update the dbex.lck file) . 
            }            releaseFileLock(fileLock);            dbLocked =  false;        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;    /*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;if the db is not shutdown, this method should release&lt;/li&gt;
	&lt;li&gt;the  db lock related resources during this class finalization.&lt;br/&gt;
     */&lt;br/&gt;
    protected void finalize() throws Throwable 
    {
        unlock_db();
    }
&lt;p&gt;}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12496538" author="tsuresh" created="Thu, 17 May 2007 12:29:14 +0100"  >&lt;p&gt;Test to parallely boot the database using multiple threads in different class loaders might fail&lt;br/&gt;
with NPE if &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2649&quot; title=&quot;An unsuccessful boot attempt of an booted database can potentially delete files in the temp directory that are in use. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2649&quot;&gt;DERBY-2649&lt;/a&gt; is not fixed. Tempory workaround is to check for null in DirFile.java:deleteAll(). &lt;/p&gt;</comment>
                            <comment id="12496541" author="tsuresh" created="Thu, 17 May 2007 12:54:44 +0100"  >&lt;p&gt;Attached is a patch with partial implementation of  the intra-jvm db &lt;br/&gt;
lock mechanism to prevent users from running multiple instances of the same&lt;br/&gt;
database using different class loaders in the same jvm. Existing &lt;br/&gt;
solution already prevents users from running multiple instances across jvms.&lt;/p&gt;

&lt;p&gt;Although I have not assigned this issue to myself, have been working on this&lt;br/&gt;
issue on/off for some time. But I don&apos;t have free cycles to work on this bug for &lt;br/&gt;
the upcoming release. I am posting the patch with whatever work I have done&lt;br/&gt;
sofar. If some one can enhance the attached patch and fix this issue, &lt;br/&gt;
that will be great.&lt;/p&gt;

&lt;p&gt;Intra-jvm db lock is provided by using global derby specific jvm instance id.&lt;br/&gt;
On a first boot of any derby database in a jvm, an UUID is generated and &lt;br/&gt;
stored in a system property (&quot;derby.storage.jvmInstanceID&quot;). This id is written &lt;br/&gt;
to the dbex.lck file when the database is booted. If the ID in the dbex.lck file &lt;br/&gt;
and the current jvm id stored in the system property&lt;br/&gt;
&quot;derby.storage.jvmInstanceID&quot; are same then the database is already booted, and &lt;br/&gt;
an exception will be thrown and database will not be booted. On a database&lt;br/&gt;
shutdown , an Invalid JVM id is written to the dbex.lck file, so that if the &lt;br/&gt;
database booted again ID&apos;s will not be equal, which means database is not&lt;br/&gt;
already booted, the database will be booted successfully. I am using the &lt;br/&gt;
existing UUID factory in the derby to generate the derby jvm id.&lt;/p&gt;

&lt;p&gt;Synchronization is done by using the interned strings. Synchronization &lt;br/&gt;
across the JVM is done on &quot;derby.storage.jvmInstanceID&quot; string. And &lt;br/&gt;
Synchronization for a database is done on the database directory. This &lt;br/&gt;
may need to be changed to a database name, because it may not be possible &lt;br/&gt;
to get the canonical path always and it is necessary to synchronize on &lt;br/&gt;
a  string, that is unique to a database in a jvm. &lt;/p&gt;


&lt;p&gt;In my earlier proposed solution I mentioned about releasing the db &lt;br/&gt;
locks using finalizer. After doing some testing , I realized there is &lt;br/&gt;
no need to address unlocking the database on garbage collection, &lt;br/&gt;
using the finalizer. My understanding is unless users shutdown &lt;br/&gt;
the database rawStoreDaemon and antiGC thread will hold on to the &lt;br/&gt;
resources and the classes will not be unloaded. So the only way users&lt;br/&gt;
can boot an already booted database but not in use using another class &lt;br/&gt;
loader instance in the same jvm is by doing a shutdown from the class &lt;br/&gt;
loader that booted the database. If some thinks this is not &lt;br/&gt;
true,  please correct me. &lt;/p&gt;

&lt;p&gt;To do :&lt;/p&gt;

&lt;p&gt;1) cleanup error handling on IOExceptions and add new message for the &lt;br/&gt;
   intra-jvm db lock. &lt;/p&gt;

&lt;p&gt;2) Currently dataDirectory path string is is used for  synchronization to &lt;br/&gt;
   prevent multiple boots of a database. This may need to be changed to &lt;br/&gt;
   the db name.&lt;/p&gt;

&lt;p&gt;3) Make the classLoaderBootTest.java run under security manager. &lt;/p&gt;

&lt;p&gt;4)  Add test cases for booting different databases parallelly on different &lt;br/&gt;
    threads with different class loaders. May not be really required , because&lt;br/&gt;
    even booting a single database through different threads shoud test &lt;br/&gt;
    the same thing. But it may be better to add a test case, just to be safe!&lt;/p&gt;


&lt;p&gt;5) Run the test with large number of threads.&lt;/p&gt;

&lt;p&gt;6) Anything else I have forgotten !&lt;/p&gt;


&lt;p&gt;Thanks &lt;br/&gt;
-suresh&lt;/p&gt;
</comment>
                            <comment id="12498037" author="kmarsden" created="Tue, 22 May 2007 23:22:17 +0100"  >&lt;p&gt;Thanks Suresh for the patch!  I was wondering, why do we need  setContextClassLoader privileges for derby.jar with the change?&lt;/p&gt;</comment>
                            <comment id="12498050" author="tsuresh" created="Wed, 23 May 2007 00:00:04 +0100"  >&lt;p&gt;[ Show &#187; ] Kathey Marsden &lt;span class=&quot;error&quot;&gt;&amp;#91;22/May/07 03:22 PM&amp;#93;&lt;/span&gt; Thanks Suresh for the patch! I was wondering, why do we need &lt;br/&gt;
setContextClassLoader privileges for derby.jar with the change? &lt;/p&gt;

&lt;p&gt;I must have added that permission while debugging to run the test under security manager. &lt;br/&gt;
Only security permission that is required for derby.jar  is read/write  of derby.storage.jvmInstanceID &lt;br/&gt;
property.&lt;/p&gt;

&lt;p&gt;Thanks for for volunteering to fix the bug, Kathey.&lt;br/&gt;
.&lt;/p&gt;</comment>
                            <comment id="12499134" author="kmarsden" created="Fri, 25 May 2007 17:11:41 +0100"  >&lt;p&gt;Suresh said&lt;/p&gt;

&lt;p&gt;&amp;gt;2) Currently dataDirectory path string is is used for synchronization to&lt;br/&gt;
&amp;gt;   prevent multiple boots of a database. This may need to be changed to&lt;br/&gt;
&amp;gt;   the db name.&lt;/p&gt;

&lt;p&gt;Why does this need to be changed?  If we switched to databaseName might there be potential for duplicate database names?  The dataDirectory  path seems logical to me.&lt;/p&gt;</comment>
                            <comment id="12499137" author="djd" created="Fri, 25 May 2007 17:18:39 +0100"  >&lt;p&gt;The issue with the path is that the canonical path would be needed which requires permission to read system property user.dir, which might not be granted.&lt;br/&gt;
The base name of the path (&quot;database name&quot;) is easy to obtain and works just as well. The synchronization on this object is very short lived, thus it does not stop two databases with the same name but different paths from booting.&lt;/p&gt;</comment>
                            <comment id="12499894" author="kmarsden" created="Tue, 29 May 2007 20:16:00 +0100"  >&lt;p&gt;This patch is not yet ready for commit.  The multithreaded test testBootingDatabaseInMultipleThread fails intermittently allowing the database to be booted  twice.  I am looking to see where there may be a synchronization issue.&lt;/p&gt;</comment>
                            <comment id="12499906" author="kmarsden" created="Tue, 29 May 2007 21:04:48 +0100"  >&lt;p&gt;When the multithreaded failure occurs there is an NPE accessing the lockfile.  Attaching the derby.log.&lt;/p&gt;</comment>
                            <comment id="12500202" author="kmarsden" created="Wed, 30 May 2007 18:51:20 +0100"  >&lt;p&gt;Attached is a patch that fixes the NPE, but there are still issues with the multithreaded test.  Sometimes with 9 or more threads in startConcurrentDatabaseBoots we get dual boot without any message to the derby.log.   I think there is one of two issues here:&lt;/p&gt;

&lt;p&gt;1) There is no synchronization across classloaders, so even though we synchronize on the databaseName() it is not useful when two threads from different ClassLoaders come into the synchronized code.&lt;/p&gt;

&lt;p&gt;2) Since getting the exFileLock is not within the synchronized code.  It is possible that the state of the dbex.lck file on disk changes before the boot.&lt;/p&gt;

&lt;p&gt;I am not sure how to resolve these issues, especially 1.  I&apos;d appreciate any advice on the issue.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;
</comment>
                            <comment id="12501283" author="kmarsden" created="Mon, 4 Jun 2007 18:23:06 +0100"  >&lt;p&gt;Originally I thought I would make read/write access to the property mandatory but since policy files typically have to be changed out at the deployed site,  I think I will make it so it just prints a warning if access is not granted for the property.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12502063" author="mikem" created="Wed, 6 Jun 2007 20:45:57 +0100"  >&lt;p&gt;keep in mind that if we make setting/reading the property optional it presents a very mixed set of possiblities.  We need to at least document and maybe refer to them in the error message.  Each derby.jar in each different class loader may have a different property set so one set may be able to read but not write, another can&apos;t read or write, and another can read and write.  Some app may get different locking behaviors if they can read by not write based on whether they are the first one in or not ( they sometimes may get error message and sometimes not based on what someone else has done).&lt;/p&gt;
</comment>
                            <comment id="12502563" author="kmarsden" created="Fri, 8 Jun 2007 00:04:37 +0100"  >&lt;p&gt;Here is the latest patch for this issue.  I think we are getting close, but I have reached a sticking point that I can&apos;t seem to get past.  &lt;/p&gt;

&lt;p&gt;If I run with classes or even with jars from within Eclipse, it all runs fine and even 100 threads pass with no problem.  But for some unknown reason, when I run with jars from the commandline, it allows dual boot.  &lt;/p&gt;

&lt;p&gt;The primary change from the last patch is that I had to synchronize the entire call to privGetJBMSLockOnDB() to avoid intermittent dual boot failures in the multiThreaded test.&lt;/p&gt;

&lt;p&gt;I also added a warning instead of failure if the user did not have permission to access the system property.&lt;/p&gt;

&lt;p&gt;Anyway, if someone is so inclined it would be great to have another pair of eyes on this to figure out what the problem is running with jars.&lt;br/&gt;
I ran derbyall and suites.All. All passed with classes, but with jars ClassLoaderBootTest fails miserably.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;
</comment>
                            <comment id="12502848" author="kmarsden" created="Fri, 8 Jun 2007 16:44:20 +0100"  >&lt;p&gt;Run without security manager the test passes with jars.  So I will try to figure out what permission is missing/needed with jars.&lt;/p&gt;</comment>
                            <comment id="12503950" author="kmarsden" created="Tue, 12 Jun 2007 19:16:38 +0100"  >&lt;p&gt;I have been unable to figure out exactly what the permission issue is when running with security manager and jars.  I did find that it was corrected by giving AllPermissions to derbyTesting.jar.  I am thinking therfore that the issue is with the test and not the change itself.  I would like to go ahead and checkin the change, disabling security manager for the jars and file another issue to correct that problem.   Reviews welcome and let me  know if anyone has objections to going ahead and checking in the change.  Substantive changes from the initial patch are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fix intermittent NPE&lt;/li&gt;
	&lt;li&gt;Fix problem with dual boot with many threads, by expanding the synchronization to include the full privJBMSLockOnDB&lt;/li&gt;
	&lt;li&gt;Log  warning not fail if System Property permission is not granted instead of failing.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Kathey&lt;/p&gt;



</comment>
                            <comment id="12503967" author="djd" created="Tue, 12 Jun 2007 20:05:36 +0100"  >&lt;p&gt;From a very quick look at the code two things jumped out at me:&lt;/p&gt;

&lt;p&gt;1) Why does the test need a Derby specific class loader? The upgrade tests don&apos;t and there are performing the same style of operation.&lt;/p&gt;

&lt;p&gt;2) The new method StorageFile.getLockedFile() is part of the api so its definition needs to be clear.&lt;/p&gt;

&lt;p&gt;  2a) In the interface it says it returns the file for the lock file, but I don&apos;t think lock file is defined anywhere in the interface description.&lt;br/&gt;
  2b) The interface doesn&apos;t indicate it can return null, but one implementation of it does.&lt;br/&gt;
  2c) Why is this method on StorageFile, it&apos;s not an attribute of a specific file, at least I don;t think it is. Is there a lock file per open file?&lt;/p&gt;</comment>
                            <comment id="12504352" author="kmarsden" created="Wed, 13 Jun 2007 18:49:19 +0100"  >&lt;p&gt;Thanks Dan for the comment.&lt;/p&gt;

&lt;p&gt;getExclusiveLock()  and getLockedFile() are only substatively relevant to DirFile4 and for that file yes, I think there is a lock file per open file.   I will change the definition to say that getLockedFile()  will return a RandomAcess file to the lock file obtained by getExcluciveLock()  if an exclusive lock was successfully obtained with getExclusiveLock() otherwise it will return null.&lt;/p&gt;

&lt;p&gt;Does that sound right?&lt;/p&gt;

&lt;p&gt;I&apos;ll look at the test.  Maybe I will fix it post checkin if I am not able to get it fixed up today.&lt;/p&gt;
</comment>
                            <comment id="12504386" author="kmarsden" created="Wed, 13 Jun 2007 20:34:29 +0100"  >&lt;p&gt;Applications will need to set a new permission in their policy file.  So this will affect existing applications and release note is needed.&lt;/p&gt;</comment>
                            <comment id="12504389" author="kmarsden" created="Wed, 13 Jun 2007 20:47:25 +0100"  >&lt;p&gt;release note&lt;/p&gt;</comment>
                            <comment id="12504446" author="djd" created="Wed, 13 Jun 2007 22:49:01 +0100"  >&lt;p&gt;&amp;gt; I think there is a lock file per open file. I will change the definition to say that getLockedFile() will return a RandomAcess file to the lock file obtained by getExcluciveLock() if an exclusive lock was successfully obtained with getExclusiveLock() otherwise it will return null. &lt;/p&gt;

&lt;p&gt;Sorry, still somewhat lost. Why is a call to get a random access file on StorageFile needed since it already has such a method?&lt;/p&gt;</comment>
                            <comment id="12504471" author="djd" created="Thu, 14 Jun 2007 00:02:31 +0100"  >&lt;p&gt;-1 on this patch (now applied as 547042 &amp;amp; 547046):&lt;/p&gt;

&lt;p&gt; The additional method on StorageFile is not well defined.&lt;/p&gt;

&lt;p&gt;  StorageFile.getExclusiveFileLock() indicates it gets an exclusive lock on the name represented by StorageFile.&lt;/p&gt;

&lt;p&gt; The new method StorageFile.getLockedFile() seems to imply that if a StorageFile is locked, then there is a new&lt;br/&gt;
  different file created to perform the lock, thus one can modify the contents of the two files independently,&lt;br/&gt;
  using the existing StorageFile.getRandomAccessFile() and now the new StorageFile.getLockedFile().&lt;br/&gt;
  (Otherwise why have the new method, one can already get a random access to a StorageFile??).&lt;/p&gt;

&lt;p&gt;  This seems problematic for a few reasons:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;seems inefficient, creating a new file to lock another&lt;/li&gt;
	&lt;li&gt;seems to change the contract of the existing method getExclusiveFileLock() (no mention of requiring a separate file)&lt;/li&gt;
	&lt;li&gt;possibly hard to implement for an arbitary IO implementation.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   Maybe though I&apos;m misunderstanding what is going on, the javadoc comment for getLockedFile() does seem to have&lt;br/&gt;
a couple of typos in it (e.g. &quot;exclusing e lock&quot;). If there&apos;s some good explanation for what is going on and the relationship&lt;br/&gt;
between StorageFile.getLockedFile() and StorageFile.getRandomAccessFile() can be well defined then I can frop my veto.&lt;/p&gt;</comment>
                            <comment id="12504721" author="djd" created="Thu, 14 Jun 2007 14:25:26 +0100"  >&lt;p&gt;Note I&apos;m reviewing the patch called; derby-700_06_07_07_diff.txt &lt;br/&gt;
Comments on 6/12 seem to indicate a new patch for review but nothing seems to have been attached that day, I think those comments are about the previous version.&lt;/p&gt;

&lt;p&gt;Some comments on the patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In getIntraJvmDbLock() there is this comment:&lt;br/&gt;
   +        // synchronizing across the same database, by using interned &lt;br/&gt;
   +        // version of the database name&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  but I can&apos;t see any synchronization.  It seems the synchronization has moved to wrap the entire call to privGetJBMSLockOnDB().&lt;br/&gt;
  Since this synchronization is key it would be good to get the comments clear so that future readers can understand how this works.&lt;br/&gt;
  Also I think putting the synchronization in the privGetJBMSLockOnDB() method would be much clearer than hiding it in the run() method.&lt;br/&gt;
  I see the comment above indicating the synchronization was expanded to be the full privGetJBMSLockOnDB() method, but there is&lt;br/&gt;
  no reason given. Can you share your thoughts on why this is required?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the synchronization for getting the intra jvm lock and releasing it are using different objects. Don&apos;t they need to use the same object?&lt;br/&gt;
  If not it should be clearly commented how the synchronization is working.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In getIntraJvmDbLock() and releaseIntraJvmDbLock() the StorageAccessFile lckFileRaf is never closed, I think it needs to be or have comments indicating why it is not closed. Maybe it&apos;s related to the issue of the new method added to StorageFile??&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In releaseIntraJvmDbLock() I was a little unclear by the invalid uuid concept. Is it an invalid uuid such that recreateUUID will throw an exception in getIntraJvmDbLock() or is it a valid representation of a uuid that can never be created by Derby?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Using dataDirectory.intern() to synchronize across class loaders in  releaseIntraJvmDbLock() could probably use more comments, basically describing what guarantees that all derby systems have the same path for the data directory for a given database?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks for working on this, it will help stop users corrupting their own databases.&lt;/p&gt;
</comment>
                            <comment id="12504735" author="djd" created="Thu, 14 Jun 2007 14:40:28 +0100"  >&lt;p&gt;Couple of minor additonal comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The code would be a little simpler if getJvmId() just returned a String instead of a UUID. Then there&apos;s no need to convert&lt;br/&gt;
    the value read back from disk to a uuid. String&apos;s compare just as well as UUIDs for this purpose.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The reading of the on-disk identifier has this code:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+            try &lt;br/&gt;
+            &lt;/p&gt;
{
+                if (exFileLock.length() != 0)
+                    onDiskJvmId = uuidFactory.recreateUUID(lckFileRaf.readUTF());
+            }
&lt;p&gt;   &lt;br/&gt;
+            catch (Exception e)&lt;br/&gt;
+            &lt;/p&gt;
{
+                // The previous owner of the lock may have died before we
+                // finish writing its UUID down. Assume uuid file is invalid
+                // Set the id on the disk to null value.
+                onDiskJvmId = null;
+            }


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Why is the file length of zero special cased?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think the comment could be improved to&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+                // The previous owner of the lock may have died before we&lt;br/&gt;
+                // finish writing its UUID down. Assume uuid file is invalid&lt;br/&gt;
+                // and thus the database is not in use (locked).&lt;/p&gt;

</comment>
                            <comment id="12504896" author="mikem" created="Thu, 14 Jun 2007 21:14:46 +0100"  >&lt;p&gt;Dan I would like to understand your concerns with respect to the locking interfaces on StorageFile.    We are only going to call locking on the lock files, not on other RandomAccessFiles.  The current code is using the exising RandomAccessFile support&lt;br/&gt;
to do this - do you think we should be creating a different type of file rather than putting the interfaces on StorageFile?&lt;/p&gt;

&lt;p&gt;I agree the comments could be improved, and I guess since we are so close to a release it is better to get it right before checkin.  I was ok before with checking it in as it was and then fixing in subsequent checkin (I was planning on helping with this once code got in, instead of a patch).  &lt;/p&gt;

&lt;p&gt;At this point it looks like this won&apos;t make it into first release candidate, but I plan on helping to get this to a good state  for a subsequent release candidate or at least get it into the branch for anyone who wants it if we don&apos;t have another release candidate.  I would not hold up release candidate for this.  I think it is reasonable to get the documentation for the requested permission into the release even if we can&apos;t get the code in this week, is that a problem?&lt;/p&gt;</comment>
                            <comment id="12504902" author="djd" created="Thu, 14 Jun 2007 21:38:36 +0100"  >&lt;p&gt;Simple question is why is a new method needed on StorageFile. Since one can already get an object to perform random access i/o on a StorageFile, why is a new method needed to perform the same functionality.&lt;/p&gt;

&lt;p&gt;Either it is because for some reason the api requires the lock files hold different contents to the file being locked. I don&apos;t think this is the case.&lt;/p&gt;

&lt;p&gt;Or it is because it&apos;s not needed. I think this is the case, but there must have been some reason for adding it. I&apos;m just asking what is the reason for adding such a method.&lt;/p&gt;

&lt;p&gt;I think we are creating a StorageFile to represent &quot;dbex.lck&quot; (whatever the name is) and then locking that file. That&apos;s all good, but why can we not modify that file using the existing methods on StorageFactory?&lt;/p&gt;</comment>
                            <comment id="12504943" author="tsuresh" created="Thu, 14 Jun 2007 23:11:00 +0100"  >&lt;p&gt;I agree with Dan,  getLockedFile() is confusing and should not be added &lt;br/&gt;
to the storage factory interfaces , if it can be avoided or  have better &lt;br/&gt;
comments.&lt;/p&gt;

&lt;p&gt;Just thought I will take a moment and explain, why in the first place &lt;br/&gt;
I added this method, I hope it will help in finding an alternative solution &lt;br/&gt;
or make the interface better. &lt;/p&gt;

&lt;p&gt;I was testing and developing  my solution on Windows. When I &lt;br/&gt;
first implemented without adding the getLockedFile() method, by&lt;br/&gt;
just getting the RandomAccessFile using StorageFile.getRandomAccessFile(), &lt;br/&gt;
after it is locked. I was hitting the error , java.io.IOException: &lt;br/&gt;
&quot;&lt;br/&gt;
The process cannot access the file because another process has locked a &lt;br/&gt;
portion of the file. When it write UUID to the dbex.lck file. &lt;br/&gt;
&quot;&lt;/p&gt;

&lt;p&gt;After bit of debugging realized , I need access to the same &lt;br/&gt;
RandomAccesFile, that is used to the get the lock. So I simply&lt;br/&gt;
added the getLockedFile, which just return the same RandomAccessFile, &lt;br/&gt;
that is used to get the file lock.  &lt;/p&gt;


&lt;p&gt;public class writeLock {&lt;br/&gt;
	public static void main(String[] args) throws Exception &lt;/p&gt;
	{
        File lf = new File(&quot;dbex.lck&quot;);
        RandomAccessFile raf1 = new RandomAccessFile(lf, &quot;rw&quot;);
        FileChannel fc = raf1.getChannel();
        FileLock lock = fc.tryLock();

        // attempt to write to locked file using another
        //
        RandomAccessFile raf2 =  new RandomAccessFile(lf , &quot;rw&quot;);
        // the following write is failing on windows.
        raf2.writeChars(&quot;Derby is great &quot;);
    }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;For example , in the above code. Last write will fail with the error:&lt;br/&gt;
Exception in thread &quot;main&quot; java.io.IOException: The process cannot access the &lt;br/&gt;
file because another process has locked a portion of the file. &lt;/p&gt;

&lt;p&gt;I did not verify, if this is the case in the non-window environment too. This&lt;br/&gt;
fix is mainly  for non-window environment, so If on other platforms this is &lt;br/&gt;
not issue then  the getLockedFile() can be replaced with the &lt;br/&gt;
StorageFile.getRandomAccesFile(). My concern is, How to confirm all &lt;br/&gt;
non-window environments will not give the above error. &lt;/p&gt;

&lt;p&gt;First I thought of   putting the new intraJVM lock code in the storage&lt;br/&gt;
factory, where getExclusiveFileLock() is implemented, For me &lt;br/&gt;
It looked worse alternative too  getLockedFile() method, because then &lt;br/&gt;
getExlusiveFileLock() method semantics gets more confusing. &lt;/p&gt;

&lt;p&gt;Another solution I was thinking that may work without adding the &lt;br/&gt;
*getLockedFile() is  to use the range lock. like FileLock lock = &lt;br/&gt;
fc.tryLock(0, 10 ,false), and write to the file after the 10th byte. &lt;br/&gt;
This may need a new method getExclusiveLock() , which takes range.&lt;/p&gt;

&lt;p&gt;May be simple solution is to add a new call, getExclusiveFileLock() &lt;br/&gt;
method that takes RandomAcceesFile as the argument.&lt;/p&gt;

&lt;p&gt;To start with the reason we are in this mess is the getExclusiveLock() &lt;br/&gt;
implementation is not matching the way java interfaces work. Ideally &lt;br/&gt;
store code should hold on to the RandomAccessFile used for the lock,&lt;br/&gt;
not the storage factory implementraion. Ideally StorageRandomAccessFile &lt;br/&gt;
should give handle to the StorageFileChannel, which has the tryLock() &lt;br/&gt;
method, that returns FileLock.  &lt;/p&gt;


&lt;p&gt;Thanks&lt;br/&gt;
-suresh&lt;/p&gt;
</comment>
                            <comment id="12505310" author="kmarsden" created="Fri, 15 Jun 2007 18:04:42 +0100"  >&lt;p&gt;Dan, based on what Suresh said, does the solution to add a new call, getExclusiveFileLock()&lt;br/&gt;
method that takes RandomAcceesFile as the argument seem like a reasonable solution to get rid of getLockedFile or should we just document getLockedFile better, or something else ...?&lt;/p&gt;</comment>
                            <comment id="12505330" author="djd" created="Fri, 15 Jun 2007 18:53:53 +0100"  >&lt;p&gt;Thanks Suresh, that was very useful. The piece of missing information for me was that on windows one can only have one open descriptor against a locked file (from Suresh&apos;s description).&lt;/p&gt;

&lt;p&gt;So really this method was added because the existing (pre-patch)  &lt;b&gt;implementation&lt;/b&gt; of StorageFile does &lt;b&gt;not&lt;/b&gt; honour the contract of StorageFile. This is because with this implementation (on some platforms) if StorageFile.getExclusiveFileLock() is called then StorageFile.getRandomAccessFile() does &lt;b&gt;not&lt;/b&gt; return an object that can be used to modify the file.&lt;/p&gt;

&lt;p&gt;In fact looking at the DirFile implementation it seems the file locking implementation is not what a reader of the IO api (the javadoc for StorageFile) might expect. I read the StorageFile javadoc and expect that getExclusiveFileLock() puts a lock on the file, I can then use it as a regular file and then release the lock. Then another thread/jvm could perform the same action and we would have normal file locking sematics. That&apos;s why the change confused me, because I was expecting certain behaviour based upon the contract of StorageFile.&lt;/p&gt;

&lt;p&gt;But the DirFile/DirFile4 implementations are not that and are not even identical to each other (in terms of visible behaviour).&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DirFile Calling getExclusiveFileLock() deletes the file if it exists and then creates it&lt;/li&gt;
	&lt;li&gt;DirFile4 Creates the file and writes four bytes into it.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Once a storage file is locked, it can not be used as a regular file&lt;/li&gt;
	&lt;li&gt;releasing the lock deletes the file(!!)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I can see why all of this is done, it&apos;s for a specific purpose for locking Derby databases, but I don&apos;t think anyone would expect either&lt;br/&gt;
of those implementations from reading the api. &lt;/p&gt;

&lt;p&gt;Thus I think first the StorageFile javadoc should be changed to describe the behaviour implemented (since it&apos;s all that is required by Derby today).&lt;br/&gt;
I think the generalities of it are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Any StorageFile that has getExclusiveFileLock() called on it is not intended to be read from or written to. It&apos;s sole purpose is to provide&lt;br/&gt;
      a locked entity to avoid multiple instances of Derby accessing the same database.&lt;/li&gt;
	&lt;li&gt;getExclusiveFileLock() may delete or overwrite any existing file&lt;/li&gt;
	&lt;li&gt;releaseExclusiveFileLock() may delete the file&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then I wonder if this new locking mechanism for intra-jvm locks should be contained within the DirFile4 StorageFile implementation.&lt;br/&gt;
The code is completly reliant on that implementation, so why not enclose it? Then there would be no need to change the StorageFactory interface (after from the comments clarifying behaviour).&lt;/p&gt;</comment>
                            <comment id="12505499" author="rhillegas" created="Sat, 16 Jun 2007 18:36:57 +0100"  >&lt;p&gt;Scrubbing release note so that it can be digested by the SAX parser in the release note generator. Naked &amp;lt;br&amp;gt; tags replaced with &amp;lt;br/&amp;gt;.&lt;/p&gt;</comment>
                            <comment id="12505957" author="kmarsden" created="Mon, 18 Jun 2007 22:10:29 +0100"  >&lt;p&gt;I am working to move the intraJVM lock into StorageFile, getExclusiveLock()/ releaseExclusiveLock, but I wanted to comment on why I expanded the synchronization to include all of privGetJBMSLockOnDB as I think that will still be required.&lt;/p&gt;

&lt;p&gt;I found running the test with multiple threads that I would get occasional dual boot without any error message or warning with the original patch.  I expanded the synchronization and found that it corrected the problem.  I think there seems to be a window where two threads can get in and create or delete the lock file at the same time, e.g. &lt;br/&gt;
              if (fileLock.exists())&lt;br/&gt;
                {&lt;br/&gt;
                ...&lt;br/&gt;
                 ----&amp;gt; Another thread gets in and deletes the file here&lt;/p&gt;

&lt;p&gt;I am not totally sure that this is the hole and since this logic would remain in BaseDataFileFactory we would still need to synchronize on the interned databaseName there.   I am sure however that it works with the expanded synchronization but does not without it.  &lt;/p&gt;



</comment>
                            <comment id="12505976" author="kmarsden" created="Tue, 19 Jun 2007 00:03:07 +0100"  >&lt;p&gt;If I try to keep the interface the same and incorporate the intrajvm lock into getExclusiveLock() I  will lose granularity in the error message.  With the previous patch, we had a separate intrajvm dual boot messages as well as a warning if the property was not writable.  Should I add two new return possibilities from getExclusiveLock to handle these cases?&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;

</comment>
                            <comment id="12505980" author="djd" created="Tue, 19 Jun 2007 00:53:59 +0100"  >&lt;p&gt;Could the problem (needing to expand) with the synchronization be related to question I raised earlier?&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; - the synchronization for getting the intra jvm lock and releasing it are using different objects. Don&apos;t they need to use the same object?&lt;br/&gt;
&amp;gt;&amp;gt;   If not it should be clearly commented how the synchronization is working.&lt;/p&gt;

&lt;p&gt;In the comment above, I&apos;m not sure which piece of code you are referring to here?&lt;/p&gt;

&lt;p&gt;              if (fileLock.exists())&lt;br/&gt;
                {&lt;br/&gt;
                ...&lt;br/&gt;
                 ----&amp;gt; Another thread gets in and deletes the file here &lt;/p&gt;</comment>
                            <comment id="12506228" author="kmarsden" created="Tue, 19 Jun 2007 17:08:52 +0100"  >&lt;p&gt;Dan asked:&lt;br/&gt;
&amp;gt;Could the problem (needing to expand) with the synchronization be related to question I raised earlier?&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; - the synchronization for getting the intra jvm lock and releasing it are using different objects. Don&apos;t they need to use the same object?&lt;/p&gt;

&lt;p&gt;No even with that corrected the test still fails with only putting synchronization on getIntraJVMDBLock()&lt;/p&gt;

&lt;p&gt;In the comment above, I&apos;m not sure which piece of code you are referring to here?&lt;/p&gt;

&lt;p&gt;This is from privGetJBMSLockOnDB()&lt;/p&gt;</comment>
                            <comment id="12506290" author="kmarsden" created="Tue, 19 Jun 2007 21:50:20 +0100"  >&lt;p&gt;Mike asked me to post the patch that has changes from Dan&apos;s first round of review comments but does not have the move of getIntraJVMDbLock to DirFile4.  This is not for commit&lt;/p&gt;</comment>
                            <comment id="12509163" author="djd" created="Fri, 29 Jun 2007 18:37:09 +0100"  >&lt;p&gt;With the changes made for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2737&quot; title=&quot;Change documentation on permissions needed to include read/write for  system property derby.storage.jvmInstanceId &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2737&quot;&gt;&lt;del&gt;DERBY-2737&lt;/del&gt;&lt;/a&gt; it might be wise to get the template server policy file to include the permission on the property derby.storage.jvmInstanceId even if this fix doesn&apos;t make it into the first 10.3 release. At least then any user&apos;s policy file might have a better chance of having the permission.&lt;/p&gt;</comment>
                            <comment id="12509170" author="djd" created="Fri, 29 Jun 2007 19:02:11 +0100"  >&lt;p&gt;Expanding the synchronization &quot;because it works&quot; concerns me greatly as an engineering approach to addressing a synchronization issue.&lt;/p&gt;

&lt;p&gt;The purpose of the synchronization was intended to protect a small window while a unique identifier was being written into a file (exFileLock in privGetJBMSLockOnDB) used for lock control.&lt;/p&gt;

&lt;p&gt;Expanding this synchronization is now also protecting the writing of a &lt;b&gt;different&lt;/b&gt; file (fileLock in privGetJBMSLockOnDB), but why is that needed?&lt;br/&gt;
Especially when the system has to handle multiple jvm&apos;s writing to that same file, when object synchronization doesn&apos;t help.&lt;/p&gt;

&lt;p&gt;It maybe that the current locking across doesn&apos;t really work and there are windows where multiple jvms booting the same database at the same time would succeed when they should fail. E.g. the locking works correctly when two jvms boot the same database one after the other (ie the second would fail) but not when they concurrently boot the same db. Maybe your test is exposing that and so the synchronization is required, but then it doesn&apos;t address the cross jvm issue. &lt;/p&gt;

&lt;p&gt;The locking of database boot is already complicated and adding the new (required) mechanism for cross-class loader complicates it further.&lt;br/&gt;
It would be good to have a clear description of how the various schemes work and interact with each other. WIth that, one could then more easily determine what synchronization is required &lt;b&gt;and why&lt;/b&gt;.&lt;/p&gt;</comment>
                            <comment id="12510527" author="myrna" created="Fri, 6 Jul 2007 00:52:18 +0100"  >&lt;p&gt;I am unchecking the 10.3 fixin. It doesn&apos;t look like this is going to make it.&lt;/p&gt;</comment>
                            <comment id="12510834" author="djd" created="Sat, 7 Jul 2007 02:32:20 +0100"  >&lt;p&gt;This is an issue for every release/branch so far&lt;/p&gt;</comment>
                            <comment id="12534959" author="kmarsden" created="Mon, 15 Oct 2007 21:30:31 +0100"  >&lt;p&gt;Unassigning myself from this issue for now. I am not actively working on it and am not sure how to resolve the synchronization issue I was seeing when running the test with many threads.  Hopefully someone else will be able to find a solution which does not expand the synchronization so much.  &lt;/p&gt;


&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12688145" author="kmarsden" created="Sun, 22 Mar 2009 16:40:29 +0000"  >&lt;p&gt;I have been thinking about this issue and wonder:&lt;br/&gt;
If we put the name of the database in the name of the derby.rawStoreDaemon thread and then check for the existence of that thread before booting the database and fail if it exists, would that be a reasonable solution?&lt;/p&gt;
</comment>
                            <comment id="12706621" author="kmarsden" created="Wed, 6 May 2009 23:07:12 +0100"  >&lt;p&gt;I did some testing with the thread name idea (just in a separate stand-alone program) and found that it would probably be workable. Performance wasn&apos;t bad. It seemed to take only 16 milliseconds on my machine to iterate through 1000 thread names and synchronizing on an interned string seemed to work across ClassLoaders but  ...&lt;/p&gt;

&lt;p&gt;1) It would require RuntimePermissions getStackTrace and modifyThreadGroup to derby.jar, which seem like pretty powerful additions to our permissions requirements.&lt;/p&gt;

&lt;p&gt;2) I was looking back at Suresh&apos;s original implmentation (using the system property) and found that solution actually still holds promise.  There was just an issue with synchronization which needs to be resolved. This solution wouldn&apos;t collide with any effort to consolidate the daemon threads and we already have this permission requirement documented, so I think this is a cleaner solution that should be revisited.  &lt;/p&gt;

&lt;p&gt;I&apos;ll take a look again at the old patch and try to figure out why the synchronization expansion was required and how to avoid it.&lt;/p&gt;</comment>
                            <comment id="12737645" author="rhillegas" created="Fri, 31 Jul 2009 19:30:44 +0100"  >&lt;p&gt;Amended the title, description, and environment fields. This bug also appears on the Apple Java 5 VM on Mac OS X 10.5.7. It appears that this bug is not limited to Linux.&lt;/p&gt;</comment>
                            <comment id="12740196" author="rhillegas" created="Thu, 6 Aug 2009 19:51:58 +0100"  >&lt;p&gt;It appears to me that a workaround for this bug is to upgrade to Java 6. I am attaching a slightly revised version of the repro, DualBootRepro.java (this revision contains all of the helper classes needed to create the failure scenario). I see failures on the following platforms:&lt;/p&gt;

&lt;p&gt;Apple Java 5 on Mac OS X&lt;br/&gt;
Sun Java 5 on Ubuntu Linux&lt;br/&gt;
IBM Java 5 on Ubuntu Linux&lt;/p&gt;

&lt;p&gt;Happily, however, the second boot fails and raises java.nio.channels.OverlappingFileLockException on the following platforms:&lt;/p&gt;

&lt;p&gt;Apple Java 6 beta on Mac OS X&lt;br/&gt;
Sun Java 6 on Ubuntu Linux&lt;br/&gt;
IBM Java 6 on Ubuntu Linux&lt;/p&gt;

&lt;p&gt;Admittedly, that&apos;s a graceless failure. However, I think it should prevent the database from being corrupted and it&apos;s worth recommending an upgrade to Java 6 for users who encounter this bug.&lt;/p&gt;</comment>
                            <comment id="12740540" author="kmarsden" created="Fri, 7 Aug 2009 14:09:17 +0100"  >&lt;p&gt;Thank you Rick for looking at this issue.  I think it sorely needs a new pair of eyes. I know I have seen dual boot on SuSE Linux with IBM 1.6, but have not tried the recent fix packs.  I have seen the OverlappingFileLockException  on IBM 1.6 with z/OS, but thought it was a JVM bug working in our favor.  Has there been recent spec clarification that exclusive java.nio.FileLocks should prevent cross classloader access?  If we determine that the OverlappingFileLockException is the correct JVM behavior, then I think we can catch that exception and throw a dual boot message and then file JVM bugs where we don&apos;t see the OverlappingFileLockException.&lt;/p&gt;
</comment>
                            <comment id="12740552" author="rhillegas" created="Fri, 7 Aug 2009 14:45:33 +0100"  >&lt;p&gt;Hi Kathey. I&apos;m not aware of a spec clarification but I will ask around. I agree that we still need a solution for people whose VMs don&apos;t raise OverlappingFileLockException in this situation. Just thought that we might be able to spare some users a data corruption by recommending that they experiment with Java 6.&lt;/p&gt;</comment>
                            <comment id="12740588" author="rhillegas" created="Fri, 7 Aug 2009 16:35:14 +0100"  >&lt;p&gt;I have confirmed the following with Alan Bateman, the spec lead for NIO2:&lt;/p&gt;

&lt;p&gt;1) The call we are making (java.nio.channels.FileChannel.tryLock) is supposed to raise java.nio.channels.OverlappingFileLockException if an attempt is made to lock the same section of a file twice in the same VM, regardless of what ClassLoaders the calls come from. So the results I reported are expected.&lt;/p&gt;

&lt;p&gt;2) However, in Java 5 java.nio.channels.OverlappingFileLockException is NOT raised in this situation. This is a Java 5 bug. The bug was fixed in Java 6.&lt;/p&gt;

&lt;p&gt;3) Alan is not aware of any changes made by IBM to the nio code in this area. He is curious about the claim that java.nio.channels.OverlappingFileLockException is not raised by IBM Java 6 on SuSE Linux.&lt;/p&gt;

&lt;p&gt;Could someone run the repro on IBM Java 6 on SuSE Linux in order to resolve this confusion?&lt;/p&gt;

&lt;p&gt;One more wrinkle: When (2) was fixed, a compatibility flag was introduced so that people could continue to enjoy the old behavior, that is, the behavior we don&apos;t want. You will get the bad Java 5 behavior if you set the following system property to anything other than false:&lt;/p&gt;

&lt;p&gt;   sun.nio.ch.disableSystemWideOverlappingFileLockCheck	&lt;/p&gt;


&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="12740623" author="kmarsden" created="Fri, 7 Aug 2009 17:35:11 +0100"  >&lt;p&gt;This is indeed excellent news.&lt;/p&gt;

&lt;p&gt;I tried on SuSE  with:&lt;br/&gt;
java version &quot;1.6.0&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build pxi3260sr4-20090216_01(SR4))&lt;br/&gt;
IBM J9 VM (build 2.4, J2RE 1.6.0 IBM J9 2.4 Linux x86-32 jvmxi3260-20090215_29883 (JIT enabled, AOT enabled)&lt;br/&gt;
J9VM - 20090215_029883_lHdSMr&lt;br/&gt;
JIT  - r9_20090213_2028&lt;br/&gt;
GC   - 20090213_AA)&lt;br/&gt;
JCL  - 20090214_01&lt;/p&gt;

&lt;p&gt;and indeed got the OverlappingFileLockException and tried with the property you mentioned and saw dual boot.  When I get back from vacation, I will review my case records and revisit the dual boot case we saw with 1.6 and see if it is something else.&lt;/p&gt;

&lt;p&gt;I think the important thing is to have a solution moving forward, so think we should just catch this exception and throw a dual boot message.  While an older jvm solution would be great,  I think most of the legacy applications that have dual boot have learned their lesson the hard way with corruption and no longer do it.  It is in application development that we need to catch this and throw a clear message.   That development usually happens with newer JVM&apos;s.&lt;/p&gt;

&lt;p&gt;Do you have a bug number/link  for the  JVM fix?  &lt;/p&gt;</comment>
                            <comment id="12740635" author="rhillegas" created="Fri, 7 Aug 2009 18:04:12 +0100"  >&lt;p&gt;Hi Kathey. The bug id is 6332756. See &lt;a href=&quot;http://forums.sun.com/thread.jspa?threadID=5321079&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://forums.sun.com/thread.jspa?threadID=5321079&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12740641" author="kmarsden" created="Fri, 7 Aug 2009 18:29:28 +0100"  >&lt;p&gt;Thanks Rick for the reference. Was there consideration given to bakcporting the fix to 1.5, perhaps even with a different default for sun.nio.ch.disableSystemWideOverlappingFileLockCheck?&lt;/p&gt;


&lt;p&gt;The bug comments say &quot;Fixing this issue is straight-forward but it introduces a behaviour change&quot;.  At least having the property available in 1.5 to force the check would be helpful to eliminate the possibility of dual boot from corruption cases.&lt;/p&gt;
</comment>
                            <comment id="12740660" author="rhillegas" created="Fri, 7 Aug 2009 19:05:56 +0100"  >&lt;p&gt;&amp;gt; Was there consideration given to bakcporting the fix to 1.5, perhaps even with a different default for sun.nio.ch.disableSystemWideOverlappingFileLockCheck? &lt;/p&gt;

&lt;p&gt;I believe so. I think that proposal was rejected because the fix would introduce a compatibility change within a major version. The barrier to compatibility changes seems to be higher within major versions than between them. I suppose we could lobby to have that decision revisited but I doubt we would make much headway. The compatibility policy seems sensible to me.&lt;/p&gt;</comment>
                            <comment id="12740669" author="kmarsden" created="Fri, 7 Aug 2009 19:25:46 +0100"  >&lt;p&gt;If for 1.5 the property default is the current bad behavior, I think there would be no compatibility concern and it would provide a worthwhile supportability improvement especially if it is a low risk fix overall.   &lt;/p&gt;

&lt;p&gt;For now though it would be good to focus on getting a better error for Derby users using 1.6.   If we find ourselves using the &quot;Maybe they dual booted&quot; excuse in a corruption case we can revisit whether to lobby for the 1.5 option.   Sound ok?&lt;/p&gt;</comment>
                            <comment id="12740673" author="rhillegas" created="Fri, 7 Aug 2009 19:42:12 +0100"  >&lt;p&gt;I think it&apos;s a good idea to clean up how we handle java.nio.channels.OverlappingFileLockException . I agree that we can revisit this bug if that solution proves to be inadequate.&lt;/p&gt;</comment>
                            <comment id="12740691" author="rhillegas" created="Fri, 7 Aug 2009 20:57:27 +0100"  >&lt;p&gt;Attaching derby-700-01-aa-catchOverlappingFileLockException.diff. This patch catches the OverlappingFileLockException, releases the channel, and sets the status to indicate that another Derby instance has locked the database. I have not run any tests yet other than verifying that the repro runs correctly on Java 6, but I&apos;m posting this patch to see if the Store experts think this looks right. Once we agree that the code looks good, we can write some additional regression tests for this problem.&lt;/p&gt;

&lt;p&gt;Touches the following file:&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/io/DirFile4.java&lt;/p&gt;</comment>
                            <comment id="12742604" author="mikem" created="Wed, 12 Aug 2009 23:06:18 +0100"  >&lt;p&gt;The new code looks ok to me.  Maybe the comment could say what we expect to throw the&lt;br/&gt;
OverlappingFileLockException, I assume it is:&lt;br/&gt;
dbLock =lockFileChannel.tryLock();&lt;/p&gt;

&lt;p&gt;It will be great if we can count on jdk16 to fix this problem completely, finally.  Too bad if we can&apos;t&lt;br/&gt;
get a fix out of 15 as a lot of my users still use it also.&lt;/p&gt;</comment>
                            <comment id="12743395" author="rhillegas" created="Fri, 14 Aug 2009 20:53:33 +0100"  >&lt;p&gt;Thanks, Mike. I will add that comment. I will also add a test case. For the record, the regression tests ran cleanly for me.&lt;/p&gt;</comment>
                            <comment id="12743447" author="kmarsden" created="Fri, 14 Aug 2009 22:09:00 +0100"  >&lt;p&gt;There  was a test in the earlier patches that might be of use.&lt;/p&gt;</comment>
                            <comment id="12744166" author="rhillegas" created="Mon, 17 Aug 2009 19:46:34 +0100"  >&lt;p&gt;Attaching derby-700-01-ab-catchOverlappingFileLockException.diff. This adds the comment which Mike recommended and adds a test culled from one of the previous patches. I will run regression tests again.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/io/DirFile4.java&lt;/p&gt;

&lt;p&gt;Graceful handling of OverlappingFileLockException.&lt;/p&gt;


&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/store/_Suite.java&lt;br/&gt;
A      java/testing/org/apache/derbyTesting/functionTests/tests/store/ClassLoaderBootTest.java&lt;br/&gt;
M      java/testing/org/apache/derbyTesting/junit/JDBC.java&lt;/p&gt;

&lt;p&gt;Two test cases. One runs in all environments and checks that anyone can boot a database that has been shut down already. The other test case verifies that a database can&apos;t be booted twice if the VM is at Java 6 or higher.&lt;/p&gt;</comment>
                            <comment id="12744479" author="rhillegas" created="Tue, 18 Aug 2009 13:22:54 +0100"  >&lt;p&gt;The tests ran cleanly for me except for an error in ManagementMBeanTest. I ran the test by itself and it passed cleanly. I doubt that this fix affected that test. Here is the error:&lt;/p&gt;

&lt;p&gt;1) testStartStopManagementFromApplication(org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest)junit.framework.AssertionFailedError: expected:&amp;lt;2&amp;gt; but was:&amp;lt;8&amp;gt;&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest.startStopManagement(ManagementMBeanTest.java:86)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest.testStartStopManagementFromApplication(ManagementMBeanTest.java:56)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:109)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;</comment>
                            <comment id="12744548" author="rhillegas" created="Tue, 18 Aug 2009 16:25:50 +0100"  >&lt;p&gt;Committed derby-700-01-ab-catchOverlappingFileLockException.diff at subversion revision 805448.&lt;/p&gt;</comment>
                            <comment id="12744557" author="rhillegas" created="Tue, 18 Aug 2009 16:33:23 +0100"  >&lt;p&gt;Ported 805448 from trunk to 10.5 branch at subversion revision 805454.&lt;/p&gt;</comment>
                            <comment id="12744592" author="rhillegas" created="Tue, 18 Aug 2009 17:32:06 +0100"  >&lt;p&gt;Ported 805448 from trunk to 10.4 branch at subversion revision 805485.&lt;/p&gt;</comment>
                            <comment id="12744593" author="rhillegas" created="Tue, 18 Aug 2009 17:38:01 +0100"  >&lt;p&gt;Ported 805448 from trunk to 10.3 branch at subversion revision 805486.&lt;/p&gt;</comment>
                            <comment id="12744632" author="rhillegas" created="Tue, 18 Aug 2009 19:23:25 +0100"  >&lt;p&gt;Ported 805448 from trunk to 10.2 branch at subversion revision 805523.&lt;/p&gt;</comment>
                            <comment id="12744657" author="rhillegas" created="Tue, 18 Aug 2009 20:13:54 +0100"  >&lt;p&gt;At this point I have ported the patch to all branches from 10.2 forward. If someone would like to port the patch to 10.1, please do--my 10.1 build environment no longer works and the effort required to repair it does not seem justified.&lt;/p&gt;

&lt;p&gt;I am inclined to resolve this issue if there are no objections.&lt;/p&gt;</comment>
                            <comment id="12744938" author="knutanders" created="Wed, 19 Aug 2009 08:20:07 +0100"  >&lt;p&gt;ManagementMBeanTest started failing in the Tinderbox (trunk and 10.4) after the check-in:&lt;br/&gt;
&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/tinderbox_10.4_16/jvm1.6/testing/Limited/testSummary-805541.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/tinderbox_10.4_16/jvm1.6/testing/Limited/testSummary-805541.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/tinderbox_trunk16/jvm1.6/testing/Limited/testSummary-805576.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/tinderbox_trunk16/jvm1.6/testing/Limited/testSummary-805576.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;update: Ole has now logged this problem as DERBY-4356&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="12744946" author="knutanders" created="Wed, 19 Aug 2009 08:54:32 +0100"  >&lt;p&gt;I noticed this in the new test (ClassLoaderBootTest):&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it would be good to null out the three ClassLoader fields in tearDown() so that the class loaders and the classes they have loaded can be garbage collected (otherwise they&apos;ll stay in memory until the full JUnit run has finished)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the decorateSQL() method creates a table which is said to be used to test export, but I don&apos;t see any code for testing export&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the test cases are wrapped in try 
{...}
&lt;p&gt; catch (SQLException se) &lt;/p&gt;
{ dumpSQLException(se); }
&lt;p&gt;. Won&apos;t this prevent the reporting of the exception in JUnit? Better to let the exceptions be thrown and handled by the framework?&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the methods getFileWhichLoadedClass(Class) and getURL(File) have no callers&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12745050" author="rhillegas" created="Wed, 19 Aug 2009 14:29:14 +0100"  >&lt;p&gt;Thanks for those good suggestions, Knut. They are addressed by the patch I am attaching: derby-700-02-aa-testCleanup.diff.&lt;/p&gt;

&lt;p&gt;In particular, I added a tearDown() method which resets the class loader and releases resources. It looks to me like those extra try/catch blocks were resetting the class loader on the way out--I think tearDown() is a better place for that work.&lt;/p&gt;

&lt;p&gt;I&apos;ll run full regression tests against this fix.&lt;/p&gt;</comment>
                            <comment id="12745098" author="rhillegas" created="Wed, 19 Aug 2009 17:09:25 +0100"  >&lt;p&gt;Committted derby-700-02-aa-testCleanup.diff at subversion revision 805858. Tests ran cleanly for except for the spillover consequences for ManagementMBeanTest--the regression there is unchanged.&lt;/p&gt;</comment>
                            <comment id="12745229" author="myrna" created="Wed, 19 Aug 2009 23:05:00 +0100"  >&lt;p&gt;I backported the change to DirFile4.java of 805448 to 10.1 with revision 805978.&lt;/p&gt;</comment>
                            <comment id="12748427" author="rhillegas" created="Thu, 27 Aug 2009 17:23:24 +0100"  >&lt;p&gt;Resolving this issue. It looks like the noise in ManagementMBeanTest has been cleaned up.&lt;/p&gt;</comment>
                            <comment id="12750601" author="mamtas" created="Wed, 2 Sep 2009 19:35:41 +0100"  >&lt;p&gt;Rick, I was wondering if you knew the correlation between &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-700&quot; title=&quot;Derby does not prevent dual boot of database from different classloaders on Linux and Mac OS X&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-700&quot;&gt;&lt;del&gt;DERBY-700&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4361&quot; title=&quot;testDefault fixture in engine.ErrorStreamTest has been failing with junit.framework.AssertionFailedError: File C:\jartest\JarResults.XXdateXX\ibm15_suites.All\system\derby.log could not be deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4361&quot;&gt;&lt;del&gt;DERBY-4361&lt;/del&gt;&lt;/a&gt;. testDefault fixture in ErrorStreamTest has been failing consistently after the checkin went in for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-700&quot; title=&quot;Derby does not prevent dual boot of database from different classloaders on Linux and Mac OS X&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-700&quot;&gt;&lt;del&gt;DERBY-700&lt;/del&gt;&lt;/a&gt;. If the test orders are changed and ErrorStreamTest is run after the test ClassLoaderBootTest which was added for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-700&quot; title=&quot;Derby does not prevent dual boot of database from different classloaders on Linux and Mac OS X&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-700&quot;&gt;&lt;del&gt;DERBY-700&lt;/del&gt;&lt;/a&gt;, testDefault fixture does not fail anymore. I will look further into what the relationship between the 2 jira entries might be but I thought I would check if it rings a bell for you. Thanks&lt;/p&gt;</comment>
                            <comment id="12758822" author="kmarsden" created="Wed, 23 Sep 2009 19:40:00 +0100"  >&lt;p&gt;Adjusting fix version. Fix only works with JDK 1.6 which I think is first supported with 10.3, so even though the Derby part of the fix went back to 10.1, it will only be effective there if the older jvms get fixed.    I will put a request in for the IBM jvm to have the jvm fix backported to at least 1.5.&lt;/p&gt;
</comment>
                            <comment id="12759061" author="knutanders" created="Thu, 24 Sep 2009 09:17:47 +0100"  >&lt;p&gt;I think 10.1 is supposed to work with Java 6 as well. Support for JDBC 4.0 wasn&apos;t added until 10.2, but as long as your application only calls JDBC 3.0 functionality, you should be able to run it with older Derby versions under Java 6. I frequently run older versions with Java 6, for instance when I search for the version that introduced a certain bug.&lt;/p&gt;</comment>
                            <comment id="12762753" author="kmarsden" created="Tue, 6 Oct 2009 20:32:40 +0100"  >&lt;p&gt;Attaching a new release note. The old one referred to the original proposed fix which was not adopted.  Please review.&lt;/p&gt;</comment>
                            <comment id="12762759" author="myrna" created="Tue, 6 Oct 2009 20:55:50 +0100"  >&lt;p&gt;Looks good, but there were 2 typos...uploading a corrected version.&lt;/p&gt;</comment>
                            <comment id="12763113" author="rhillegas" created="Wed, 7 Oct 2009 17:34:33 +0100"  >&lt;p&gt;Thanks Kathey and Myrna. The release note looks good and it passes the ReleaseNoteReader&apos;s checks.&lt;/p&gt;</comment>
                            <comment id="12843843" author="kmarsden" created="Thu, 11 Mar 2010 00:17:18 +0000"  >&lt;p&gt;Updating fix version for 10.1 fix&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12463933">DERBY-4646</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12433427">DERBY-4356</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12369362">DERBY-2649</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12337890" name="DERBY-700.diff" size="5212" author="narayanan" created="Tue, 1 Aug 2006 13:45:42 +0100"/>
                            <attachment id="12337891" name="DERBY-700.stat" size="311" author="narayanan" created="Tue, 1 Aug 2006 13:45:42 +0100"/>
                            <attachment id="12337968" name="DERBY-700_v1_use_to_run_DualBootrepro_multithreaded.diff" size="5644" author="narayanan" created="Wed, 2 Aug 2006 07:31:22 +0100"/>
                            <attachment id="12337969" name="DERBY-700_v1_use_to_run_DualBootrepro_multithreaded.stat" size="311" author="narayanan" created="Wed, 2 Aug 2006 07:31:22 +0100"/>
                            <attachment id="12415769" name="DualBootRepro.java" size="5774" author="rhillegas" created="Thu, 6 Aug 2009 19:51:58 +0100"/>
                            <attachment id="12320620" name="DualBootRepro.java" size="2014" author="kmarsden" created="Fri, 11 Nov 2005 06:39:26 +0000"/>
                            <attachment id="12322149" name="DualBootRepro2.zip" size="2188" author="kmarsden" created="Fri, 20 Jan 2006 07:05:29 +0000"/>
                            <attachment id="12337970" name="DualBootRepro_mutltithreaded.tar.bz2" size="1775" author="narayanan" created="Wed, 2 Aug 2006 07:31:22 +0100"/>
                            <attachment id="12415881" name="derby-700-01-aa-catchOverlappingFileLockException.diff" size="1580" author="rhillegas" created="Fri, 7 Aug 2009 20:57:27 +0100"/>
                            <attachment id="12416791" name="derby-700-01-ab-catchOverlappingFileLockException.diff" size="16482" author="rhillegas" created="Mon, 17 Aug 2009 19:46:34 +0100"/>
                            <attachment id="12417018" name="derby-700-02-aa-testCleanup.diff" size="8276" author="rhillegas" created="Wed, 19 Aug 2009 14:29:14 +0100"/>
                            <attachment id="12359218" name="derby-700_06_07_07_diff.txt" size="77396" author="kmarsden" created="Fri, 8 Jun 2007 00:04:37 +0100"/>
                            <attachment id="12359221" name="derby-700_06_07_07_stat.txt" size="955" author="kmarsden" created="Fri, 8 Jun 2007 00:05:08 +0100"/>
                            <attachment id="12360139" name="derby-700_06_19_2007" size="72475" author="kmarsden" created="Tue, 19 Jun 2007 21:50:20 +0100"/>
                            <attachment id="12358451" name="derby-700_diff.txt" size="37430" author="kmarsden" created="Tue, 29 May 2007 20:16:00 +0100"/>
                            <attachment id="12358452" name="derby-700_stat.txt" size="959" author="kmarsden" created="Tue, 29 May 2007 20:16:42 +0100"/>
                            <attachment id="12358564" name="derby-700_with_NPE_fix_diff.txt" size="38902" author="kmarsden" created="Wed, 30 May 2007 18:51:20 +0100"/>
                            <attachment id="12358565" name="derby-700_with_NPE_fix_stat.txt" size="976" author="kmarsden" created="Wed, 30 May 2007 18:51:44 +0100"/>
                            <attachment id="12358470" name="derby.log" size="12425" author="kmarsden" created="Tue, 29 May 2007 21:04:48 +0100"/>
                            <attachment id="12357529" name="derby700_singleproperty_v1.diff" size="34642" author="tsuresh" created="Thu, 17 May 2007 12:54:44 +0100"/>
                            <attachment id="12357530" name="derby700_singleproperty_v1.stat" size="675" author="tsuresh" created="Thu, 17 May 2007 12:54:44 +0100"/>
                            <attachment id="12421456" name="releaseNote.html" size="3901" author="myrna" created="Tue, 6 Oct 2009 20:55:50 +0100"/>
                            <attachment id="12421454" name="releaseNote.html" size="3898" author="kmarsden" created="Tue, 6 Oct 2009 20:32:40 +0100"/>
                            <attachment id="12359938" name="releaseNote.html" size="3321" author="rhillegas" created="Sat, 16 Jun 2007 18:36:57 +0100"/>
                            <attachment id="12359626" name="releaseNote.html" size="3442" author="kmarsden" created="Wed, 13 Jun 2007 20:47:24 +0100"/>
                    </attachments>
                <subtasks>
                            <subtask id="12370624">DERBY-2737</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 11 Nov 2005 09:40:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22098</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0o4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37727</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>