<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:53:24 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3502/DERBY-3502.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3502] Unique Constraint&apos;s backing index when shared with existing indexes doesn&apos;t behave as expected</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3502</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Unique Constraint now uses non unique backing indexes with new attribute UniqueWithDuplicateNulls. This index has following sharing properties&lt;/p&gt;

&lt;p&gt;1. Can use an existing unique index.&lt;br/&gt;
2. Non Unique indexes (and foreign key) can use this index.&lt;/p&gt;

&lt;p&gt;While dropping a unique index a new index for unique constraint should be created.&lt;br/&gt;
when a unique constraint is dropped a new index for a non unique index or foreign key should be created. &lt;/p&gt;

&lt;p&gt;Army has found several issues in actual behavior. This problems are listed in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3456&quot; title=&quot;Allow removing not null from collumns particpating in unique constraint.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3456&quot;&gt;&lt;del&gt;DERBY-3456&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12390350">DERBY-3502</key>
            <summary>Unique Constraint&apos;s backing index when shared with existing indexes doesn&apos;t behave as expected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anurag">Anurag Shekhar</assignee>
                                    <reporter username="anurag">Anurag Shekhar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Mar 2008 14:07:09 +0000</created>
                <updated>Mon, 24 Mar 2008 08:28:00 +0000</updated>
                            <resolved>Mon, 24 Mar 2008 08:27:49 +0000</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12575739" author="anurag" created="Thu, 6 Mar 2008 15:21:52 +0000"  >&lt;p&gt;Description of Derby-3502.diff&lt;br/&gt;
This patch fixes backing index related issues described in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3456&quot; title=&quot;Allow removing not null from collumns particpating in unique constraint.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3456&quot;&gt;&lt;del&gt;DERBY-3456&lt;/del&gt;&lt;/a&gt;. &lt;br/&gt;
There were three problems&lt;/p&gt;

&lt;p&gt;1. While creating backing index for unique constraint it was sharing existing&lt;br/&gt;
 non unique constraint. This happened because while determining the &lt;br/&gt;
possibility of sharing an index the newly introduced attribute, &lt;br/&gt;
UniqueWithDuplicateNulls was ignored.&lt;/p&gt;

&lt;p&gt;2. While creating index descriptor for backing index when the index is shared with another unique index the newly introduced parameter was ignored. this resulted in creating of a non unique index when the unique index is dropped.&lt;/p&gt;


&lt;p&gt;3. While checking for the need of creation of a new replacement index the new parameter was ignored. So while dropping the unique constraint a new index &lt;br/&gt;
wasn&apos;t created instead the existing index was used if the sharing index was a &lt;br/&gt;
non unique index, This resulted in wrongly enforced uniqueness on non null keys.&lt;/p&gt;

&lt;p&gt;I have modified following files to fix these issues &lt;br/&gt;
java/engine/org/apache/derby/impl/sql/execute/CreateIndexConstantAction.java&lt;/p&gt;

&lt;p&gt;Modified to use  UniqueWithDuplicateNulls while deciding about sharing indexes.&lt;br/&gt;
Modified to pass UniqueWithDuplicateNulls attribute while creating descriptor for unique constraint even when there is no new index.&lt;/p&gt;

&lt;p&gt;java/engine/org/apache/derby/iapi/sql/dictionary/ConglomerateDescriptor.java&lt;br/&gt;
In drop method added additional check using UniqueWithDuplicateNulls to see if a new index is required.&lt;/p&gt;

&lt;p&gt;java/testing/org/apache/derbyTesting/functionTests/tests/lang/UniqueConstraintBackingIndexTest.java&lt;br/&gt;
Test case based on Army&apos;s descriptions.&lt;/p&gt;


</comment>
                            <comment id="12575821" author="army" created="Thu, 6 Mar 2008 18:22:43 +0000"  >&lt;p&gt;Have yet to review the engine changes, but re: the testing:&lt;/p&gt;

&lt;p&gt;  1) There is an existing test, lang/ConglomerateSharingTest.java, that exists for testing situations where constraints and/or indexes share a conglomerate.  Might be better to add your new test cases to that class instead of creating an entirely new test?&lt;/p&gt;

&lt;p&gt;  2) The new test fixtures do not close the statements they create, which may interfere with other tests when run as part of suites.All (unless something has been done to fix that lately...?).  Also, when moving the tests to ConglomerateSharingTest.java, it might be good to use that class&apos;s utility methods to confirm that conglomerate sharing is (or is not) happening as expected--esp. count the number of conglomerates before/after the statements of interest.  See existing test fixtures in ConglomerateSharingTest.java for examples...&lt;/p&gt;</comment>
                            <comment id="12575859" author="anurag" created="Thu, 6 Mar 2008 20:05:01 +0000"  >&lt;p&gt;Description of derby-3502v2.diff &lt;/p&gt;

&lt;p&gt;Moved tests to lang/ConglomerateSharingTest&lt;/p&gt;

&lt;p&gt;Rest of the changes are same as derby-3502v1.diff&lt;/p&gt;
</comment>
                            <comment id="12575915" author="army" created="Thu, 6 Mar 2008 22:04:14 +0000"  >&lt;p&gt;Thanks for v2, Anurag, the test changes look good now.&lt;/p&gt;

&lt;p&gt;As for the engine changes, I think what you have so far is good, and it does indeed solve the different scenarios that I described in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3456&quot; title=&quot;Allow removing not null from collumns particpating in unique constraint.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3456&quot;&gt;&lt;del&gt;DERBY-3456&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;There is, however, one more scenario that is still not quite right.  It is as follows:&lt;/p&gt;

&lt;p&gt;create table t1 (i int, j int not null, k int);&lt;br/&gt;
insert into t1 values (1, -1, 1), (2, -2, 4), (4, -4, 16), (3, -3, 9);&lt;/p&gt;

&lt;p&gt;create table t2 (a int not null, b int not null);&lt;br/&gt;
alter table t2 add constraint pkt2 primary key(a,b);&lt;br/&gt;
insert into t2 values (1, -1), (2, -2), (4, -4), (3, -3);&lt;/p&gt;

&lt;p&gt;&amp;#8211; First create a unique conglomerate on columns (i,j).&lt;br/&gt;
create unique index uix on t1(i,j);&lt;/p&gt;

&lt;p&gt;&amp;#8211; Now create a uniqueWhenNotNull constraint on the same columns.&lt;br/&gt;
&amp;#8211; This uniqueWhenNotNull constraint will share UIX&apos;s conglomerate.&lt;br/&gt;
alter table t1 add constraint uc unique(i,j);&lt;/p&gt;

&lt;p&gt;&amp;#8211; And finally, create a foreign key on the same columns.  This foreign&lt;br/&gt;
&amp;#8211; key will &lt;b&gt;also&lt;/b&gt; share UIX&apos;s conglomerate.&lt;br/&gt;
alter table t1 add constraint fkt1 foreign key (i,j) references t2;&lt;/p&gt;

&lt;p&gt;&amp;#8211; Should fail due to UIX (and it does).&lt;br/&gt;
insert into t1(i,j) values (1, -1);&lt;/p&gt;

&lt;p&gt;&amp;#8211; Drop the unique index UIX. The conglomerate for UC and FKT1 should&lt;br/&gt;
&amp;#8211; be re-created as non-unique with uniqueWhenNotNull set to true.  But&lt;br/&gt;
&amp;#8211; this does not currently happen: instead, the replacement conglomerate&lt;br/&gt;
&amp;#8211; is non-unique with uniqueWhenNotNull set to FALSE.&lt;br/&gt;
drop index uix;&lt;/p&gt;

&lt;p&gt;&amp;#8211; Should work.&lt;br/&gt;
insert into t1(i,j) values (null, 2);&lt;/p&gt;

&lt;p&gt;&amp;#8211; Should also work since UIX is no longer around.&lt;br/&gt;
insert into t1(i,j) values (null, 2);&lt;/p&gt;

&lt;p&gt;&amp;#8211; Should fail due to UC, but since the replacement conglomerate created&lt;br/&gt;
&amp;#8211; above is NOT uniqueWhenNotNull, this statement will succeed.&lt;br/&gt;
insert into t1 values (1, -1, 1);&lt;/p&gt;

&lt;p&gt;&amp;#8211; End result is that we have two rows with (1, -1, 1), which should not have&lt;br/&gt;
&amp;#8211; been allowed to due UC.&lt;br/&gt;
select * from t1;&lt;/p&gt;

&lt;p&gt;I think what&apos;s needed is additional logic in the &quot;describeSharedConglomerate()&quot; method of ConglomerateDescriptor.java.  In the absence of a unique conglomerate descriptor, that method will currently return the last non-unique conglomerate descriptor that it finds in the &quot;descriptors&quot; array.  Depending on the order in which the constraints are created, this might be the descriptor for UC and it might be the descriptor for FKT1.  In the above case it&apos;s FKT1, which means the method returns a non-unique conglomerate descriptor with uniqueWhenNotNull set to false.&lt;/p&gt;

&lt;p&gt;So I think you have to change describeSharedConglomerate() so that it will return a uniqueWhenNotNull conglomerate descriptor over normal non-unique conglomerate descriptor, similar to how it will currently return a unique conglomerate descriptor over a non-unique conglomerate descriptor.  Or put differently:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the array contains a unique descriptor, return that (already implemented).&lt;/li&gt;
	&lt;li&gt;Else if the array contains a non-unique descriptor with uniqueWhenNotNull set to true, return that.&lt;/li&gt;
	&lt;li&gt;Else return any non-unique descriptor.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you can do that, I think the above scenario will behave correctly.&lt;/p&gt;</comment>
                            <comment id="12576043" author="mikem" created="Fri, 7 Mar 2008 05:27:46 +0000"  >&lt;p&gt;bumping priority, i don&apos;t think 10.4 should go out with the new constraint feature without these issues resolved as it &lt;br/&gt;
can lead to constraint failures and incorrect behavior of other pre-existing indexes.&lt;/p&gt;</comment>
                            <comment id="12576099" author="anurag" created="Fri, 7 Mar 2008 09:31:13 +0000"  >&lt;p&gt;Description of derby-3502v3.diff&lt;/p&gt;

&lt;p&gt;fixed the new issue Army had found. &lt;br/&gt;
Updated test case to include this case too.&lt;/p&gt;</comment>
                            <comment id="12576271" author="army" created="Fri, 7 Mar 2008 16:46:11 +0000"  >&lt;p&gt;Thank you for the patch, Anurag--and esp. for updating the comments in &quot;describeSharedConglomerate()&quot; to agree with your changes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  I&apos;m running suites.All and derbyall now and plan to commit if all goes well.&lt;/p&gt;</comment>
                            <comment id="12576422" author="army" created="Fri, 7 Mar 2008 22:37:00 +0000"  >&lt;p&gt;I tweaked the v3 patch slightly by:&lt;/p&gt;

&lt;p&gt;  a) Adding more comments to CreateIndexConstantAction in hopes of making the&lt;br/&gt;
    &quot;share&quot; condition more clear.&lt;/p&gt;

&lt;p&gt;  b) Changed the name and javadoc of the new test fixture in ConglomerateSharingTest&lt;br/&gt;
    to more closely reflect what the fixture is testing.&lt;/p&gt;

&lt;p&gt;  c) Some minor formatting cleanup to keep lines under 80 chars.&lt;/p&gt;

&lt;p&gt;All code changes should be the same as v3.  I committed the modified patch, d3502v3_modified_1.diff, with svn # 634852:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=634852&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=634852&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for addressing this so quickly, Anurag.&lt;/p&gt;</comment>
                            <comment id="12581501" author="anurag" created="Mon, 24 Mar 2008 08:27:49 +0000"  >&lt;p&gt;Patch committed in revision  #634852 &lt;br/&gt;
There is no outstanding patch for this issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12386534">DERBY-3330</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12377402" name="d3502v3_modified_1.diff" size="14588" author="army" created="Fri, 7 Mar 2008 22:37:00 +0000"/>
                            <attachment id="12377260" name="derby-3502v1.diff" size="9771" author="anurag" created="Thu, 6 Mar 2008 15:21:52 +0000"/>
                            <attachment id="12377279" name="derby-3502v2.diff" size="8842" author="anurag" created="Thu, 6 Mar 2008 20:05:01 +0000"/>
                            <attachment id="12377326" name="derby-3502v3.diff" size="14086" author="anurag" created="Fri, 7 Mar 2008 09:31:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 Mar 2008 18:22:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23674</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0z2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39501</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>