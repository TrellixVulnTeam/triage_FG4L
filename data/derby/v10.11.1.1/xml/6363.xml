<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:11 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6363/DERBY-6363.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6363] Incorrect evaluation of logical expressions in CASE</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6363</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Logical expressions with AND and OR operators inside WHEN inside CASE expression nested in SELECT part of statement are wrongly evaluated.&lt;br/&gt;
Evaluation results depends on position of OR subexpression. If OR is placed on left side of AND it is evaluated incorrectly.&lt;/p&gt;

&lt;p&gt;Following code shows the error.&lt;/p&gt;

&lt;p&gt;create table t ( a int, b char );&lt;/p&gt;

&lt;p&gt;insert into t values (1, &apos;a&apos;);&lt;br/&gt;
insert into t values (2, &apos;b&apos;);&lt;br/&gt;
insert into t values (3, &apos;a&apos;);&lt;br/&gt;
insert into t values (4, &apos;b&apos;);&lt;br/&gt;
insert into t values (5, &apos;a&apos;);&lt;br/&gt;
insert into t values (6, &apos;b&apos;);&lt;/p&gt;

&lt;p&gt;select&lt;br/&gt;
a,&lt;br/&gt;
b,&lt;br/&gt;
case&lt;br/&gt;
    when (( b = &apos;a&apos; or b = &apos;b&apos; ) and a &amp;lt; 4) then &apos;x&apos;&lt;br/&gt;
    else &apos;-&apos;&lt;br/&gt;
end,&lt;br/&gt;
case&lt;br/&gt;
    when (a &amp;lt; 4 and ( b = &apos;a&apos; or b = &apos;b&apos; )) then &apos;y&apos;&lt;br/&gt;
    else &apos;-&apos;&lt;br/&gt;
end&lt;br/&gt;
from t;&lt;/p&gt;

&lt;p&gt;Actual result:&lt;br/&gt;
1 a x y&lt;br/&gt;
2 b - y&lt;br/&gt;
3 a x y&lt;br/&gt;
4 b - -&lt;br/&gt;
5 a - -&lt;br/&gt;
6 b - -&lt;/p&gt;

&lt;p&gt;Expected result&lt;br/&gt;
1 a x y&lt;br/&gt;
2 b x y&lt;br/&gt;
3 a x y&lt;br/&gt;
4 b - -&lt;br/&gt;
5 a - -&lt;br/&gt;
6 b - -&lt;/p&gt;</description>
                <environment></environment>
        <key id="12671762">DERBY-6363</key>
            <summary>Incorrect evaluation of logical expressions in CASE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="grzegorz.zur">Grzegorz &#379;ur</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Oct 2013 11:27:45 +0100</created>
                <updated>Wed, 21 Jan 2015 00:23:24 +0000</updated>
                            <resolved>Mon, 7 Oct 2013 11:48:25 +0100</resolved>
                                    <version>10.4.1.3</version>
                    <version>10.8.3.0</version>
                    <version>10.10.1.1</version>
                                    <fixVersion>10.8.3.3</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.2.0</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13783807" author="knutanders" created="Wed, 2 Oct 2013 11:42:49 +0100"  >&lt;p&gt;Can also be reproduced without the CASE expression:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; select a, b, (( b = &apos;a&apos; or b = &apos;b&apos; ) and a &amp;lt; 4), (a &amp;lt; 4 and ( b = &apos;a&apos; or b = &apos;b&apos; )) from t;
A          |B   |3    |4    
----------------------------
1          |a   |true |true 
2          |b   |false|true 
3          |a   |true |true 
4          |b   |false|false
5          |a   |false|false
6          |b   |false|false

6 rows selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Row 2 column 3 should have been true rather than false.&lt;/p&gt;</comment>
                            <comment id="13783836" author="knutanders" created="Wed, 2 Oct 2013 12:12:52 +0100"  >&lt;p&gt;The attached file, ac4d3680a5x0141x78ccx0cb1x000006c347101.java, contains the generated activation class for the statement &lt;tt&gt;select ( b = &apos;a&apos; or b = &apos;b&apos; ) and a &amp;lt; 4 from t&lt;/tt&gt;. As far as I can see from the method e0() in that class, the check for b = &apos;b&apos; has disappeared, and the expression has degenerated to &lt;tt&gt;(b = &apos;a&apos; and a &amp;lt; 4)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13783839" author="grzegorz.zur" created="Wed, 2 Oct 2013 12:17:07 +0100"  >&lt;p&gt;Linked to issues created as a result of problem with JIRA at issues.apache.org.&lt;/p&gt;</comment>
                            <comment id="13783872" author="knutanders" created="Wed, 2 Oct 2013 13:31:06 +0100"  >&lt;p&gt;It looks like something goes wrong during conversion of the OR expression to an IN list in OrNode.preprocess(), and &lt;tt&gt;( b = &apos;a&apos; or b = &apos;b&apos; )&lt;/tt&gt; gets incorrectly converted to &lt;tt&gt;( b IN (&apos;a&apos;) )&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I think the problem may be that OrNode.preprocess() expects the OrNode to be on conjunctive normal form. Currently, only WHERE, HAVING and ON clauses are converted to CNF, as far as I can see. (And the expression indeed evaluates to the correct value if it is moved from the SELECT list to a WHERE clause.)&lt;/p&gt;</comment>
                            <comment id="13785011" author="knutanders" created="Thu, 3 Oct 2013 12:24:29 +0100"  >&lt;p&gt;The attached patch, d6363-1a.diff, disables the IN list transformation if the OR node is not on conjunctive normal form. All the expressions that could be used as qualifiers in a multi-probe scan will be on CNF at this point in the code, and those expressions are the only ones that would benefit from such a transformation, as far as I know, so skipping the transformation in those cases should not hurt performance.&lt;/p&gt;

&lt;p&gt;The current code, without the the patch, partially checks that the OR chain is on CNF by checking that each left operand is either an equals operator or an IN operator. (This is a stricter condition than CNF, which only requires that the left operand is either an AND node on CNF or some node that is not an OR node.) It does however not check that the right operand satisfies the CNF requirements. Instead, it silently assumes that the right operand is either an OR node or a BooleanConstantNode whose value is false.&lt;/p&gt;

&lt;p&gt;The patch fixes this logic by verifying that the terminating right operand in the chain indeed is Boolean false. If it is not, the conversion to an IN list is skipped. In the examples above where the incorrect conversion happens, the terminating right operand is a node representing &lt;tt&gt;(b = &apos;b&apos;)&lt;/tt&gt;. Since the original logic assumed that the chain would be terminated by a dummy &lt;tt&gt;FALSE&lt;/tt&gt; value, which could safely be dropped, it would ignore the &lt;tt&gt;(b = &apos;b&apos;)&lt;/tt&gt; part of the expression when it created the IN list. Now it will check explicitly that the terminating node is safe to drop, and only do the rewrite if it is safe.&lt;/p&gt;

&lt;p&gt;The patch also fixes a small bug in OrNode.verifyChangeToCNF() which prevented it from detecting that the right side of the tree was not well-formed. This code is only invoked in debug builds. The check in OrNode.verifyChangeToCNF() now matches the check in AndNode.verifyChangeToCNF().&lt;/p&gt;

&lt;p&gt;All regression tests passed with the patch.&lt;/p&gt;</comment>
                            <comment id="13785990" author="jira-bot" created="Fri, 4 Oct 2013 09:22:31 +0100"  >&lt;p&gt;Commit 1529099 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1529099&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1529099&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6363&quot; title=&quot;Incorrect evaluation of logical expressions in CASE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6363&quot;&gt;&lt;del&gt;DERBY-6363&lt;/del&gt;&lt;/a&gt;: Incorrect evaluation of logical expressions in CASE&lt;/p&gt;

&lt;p&gt;Skip conversion of OR nodes to IN lists if the OR node is not on&lt;br/&gt;
conjunctive normal form.&lt;/p&gt;</comment>
                            <comment id="13788014" author="jira-bot" created="Mon, 7 Oct 2013 10:33:10 +0100"  >&lt;p&gt;Commit 1529805 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1529805&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1529805&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6363&quot; title=&quot;Incorrect evaluation of logical expressions in CASE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6363&quot;&gt;&lt;del&gt;DERBY-6363&lt;/del&gt;&lt;/a&gt;: Incorrect evaluation of logical expressions in CASE&lt;/p&gt;

&lt;p&gt;Merged revision 1529099 from trunk.&lt;/p&gt;</comment>
                            <comment id="13788053" author="jira-bot" created="Mon, 7 Oct 2013 11:45:19 +0100"  >&lt;p&gt;Commit 1529814 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/branches/10.9&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1529814&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1529814&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6363&quot; title=&quot;Incorrect evaluation of logical expressions in CASE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6363&quot;&gt;&lt;del&gt;DERBY-6363&lt;/del&gt;&lt;/a&gt;: Incorrect evaluation of logical expressions in CASE&lt;/p&gt;

&lt;p&gt;Merged revision 1529099 from trunk.&lt;/p&gt;</comment>
                            <comment id="13788056" author="jira-bot" created="Mon, 7 Oct 2013 11:46:27 +0100"  >&lt;p&gt;Commit 1529815 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/branches/10.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1529815&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1529815&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6363&quot; title=&quot;Incorrect evaluation of logical expressions in CASE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6363&quot;&gt;&lt;del&gt;DERBY-6363&lt;/del&gt;&lt;/a&gt;: Incorrect evaluation of logical expressions in CASE&lt;/p&gt;

&lt;p&gt;Merged revision 1529099 from trunk.&lt;/p&gt;</comment>
                            <comment id="14284796" author="myrna" created="Wed, 21 Jan 2015 00:23:24 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12671763">DERBY-6364</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12671764">DERBY-6365</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12671766">DERBY-6366</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12606279" name="ac4d3680a5x0141x78ccx0cb1x000006c347101.java" size="2776" author="knutanders" created="Wed, 2 Oct 2013 12:12:52 +0100"/>
                            <attachment id="12606565" name="d6363-1a.diff" size="5954" author="knutanders" created="Thu, 3 Oct 2013 12:24:29 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 2 Oct 2013 10:42:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351473</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzifzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351762</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>