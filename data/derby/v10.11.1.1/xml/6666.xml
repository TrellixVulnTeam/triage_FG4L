<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:29:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6666/DERBY-6666.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6666] Deferred constraint validation fails with &quot;dead statement&quot; when query plan logging is enabled</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6666</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Run the following script with the &lt;tt&gt;derby.language.logQueryPlan&lt;/tt&gt; system property set to &lt;tt&gt;true&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
connect &apos;jdbc:derby:memory:db;create=true&apos;;
create table t1(x int primary key);
create table t2(y int, constraint c check(y &amp;gt; 0) initially deferred, constraint fk foreign key(y) references t1 initially deferred);
autocommit off;
insert into t1 values -1, 1;
insert into t2 values 1;
&lt;span class=&quot;code-keyword&quot;&gt;update&lt;/span&gt; t2 set y = -1;
&lt;span class=&quot;code-keyword&quot;&gt;delete&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t1 &lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt; x = -1;
commit;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The commit statement will fail with the following error message: &quot;ERROR 40XC0: Dead statement. This may be caused by catching a transaction severity error inside this statement.&quot;&lt;/p&gt;

&lt;p&gt;If you run the script without setting the &lt;tt&gt;derby.language.logQueryPlan&lt;/tt&gt; system property, it will fail (correctly) with this error message: &quot;ERROR 23514: The transaction was aborted because of a deferred constraint violation: Check constraint identified by &apos;C&apos; defined on &quot;APP&quot;.&quot;T2&quot; as &apos;(y &amp;gt; 0)&apos;.&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12727634">DERBY-6666</key>
            <summary>Deferred constraint validation fails with &quot;dead statement&quot; when query plan logging is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Wed, 16 Jul 2014 12:04:16 +0100</created>
                <updated>Thu, 25 Sep 2014 00:14:11 +0100</updated>
                            <resolved>Thu, 31 Jul 2014 00:57:15 +0100</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14078684" author="dagw" created="Wed, 30 Jul 2014 01:23:59 +0100"  >&lt;p&gt; With the patch derby-6670-2-b, I can no longer see this problem.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ java -Dderby.language.logQueryPlan=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -jar jars/sane/derbyrun.jar ij foo.sql
ij version 10.11
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;;
ij&amp;gt; create table t1(x &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; primary key);
0 rows inserted/updated/deleted
ij&amp;gt; create table t2(y &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, constraint c check(y &amp;gt; 0) initially deferred, constraint fk foreign key(y) references t1 initially deferred);
0 rows inserted/updated/deleted
ij&amp;gt; autocommit off;
ij&amp;gt; insert into t1 values -1, 1;
2 rows inserted/updated/deleted
ij&amp;gt; insert into t2 values 1;
1 row inserted/updated/deleted
ij&amp;gt; update t2 set y = -1;
1 row inserted/updated/deleted
ij&amp;gt; delete from t1 where x = -1;
1 row inserted/updated/deleted
ij&amp;gt; commit;
ERROR 23516: The transaction was aborted because of a deferred constraint violation: Foreign key &apos;FK&apos; defined on &lt;span class=&quot;code-quote&quot;&gt;&quot;APP&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;T1&quot;&lt;/span&gt; referencing constraint &apos;SQL140730022103580&apos; defined on &lt;span class=&quot;code-quote&quot;&gt;&quot;APP&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;T1&quot;&lt;/span&gt;, key &apos;(-1)&apos;.
ij&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14078690" author="dagw" created="Wed, 30 Jul 2014 01:28:47 +0100"  >&lt;p&gt;Ah, when i modify the repro script by commenting out &quot;delete from t1 where x = -1;&quot;, I do see the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sb0$ java -Dderby.language.logQueryPlan=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -jar jars/sane/derbyrun.jar ij foo.sql
ij version 10.11
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;;
ij&amp;gt; create table t1(x &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; primary key);
0 rows inserted/updated/deleted
ij&amp;gt; create table t2(y &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, constraint c check(y &amp;gt; 0) initially deferred, constraint fk foreign key(y) references t1 initially deferred);
0 rows inserted/updated/deleted
ij&amp;gt; autocommit off;
ij&amp;gt; insert into t1 values -1, 1;
2 rows inserted/updated/deleted
ij&amp;gt; insert into t2 values 1;
1 row inserted/updated/deleted
ij&amp;gt; update t2 set y = -1;
1 row inserted/updated/deleted
ij&amp;gt; -- delete from t1 where x = -1;
commit;
ERROR 40XC0: Dead statement. This may be caused by catching a transaction severity error inside &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; statement.

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14079887" author="dagw" created="Wed, 30 Jul 2014 21:13:44 +0100"  >&lt;p&gt;Uploading a first patch that removes this issue by adding push and push of the statement context to the lcc before we execute the internal query to check for check constraint violation. We had neglected to do this, which caused a problem for the logging since the statement context should always be properly initialized during execution.&lt;/p&gt;

&lt;p&gt;I&apos;ll add a regression test in the next version of the patch.&lt;/p&gt;</comment>
                            <comment id="14080032" author="dagw" created="Wed, 30 Jul 2014 22:50:12 +0100"  >&lt;p&gt;Uploading version b of this patch; the XA test blew up with the first one since I had used the wrong parameter to set up the statement context (atomic): this caused the XA rollback to fail. &lt;/p&gt;

&lt;p&gt;NOTE: Dyre, I also saw the hang you referred to in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6665&quot; title=&quot;Violation of deferred constraints not detected when conglomerates are erroneously shared&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6665&quot;&gt;&lt;del&gt;DERBY-6665&lt;/del&gt;&lt;/a&gt; when trying to tear down the XA test - I had the wrong XA error for a while there. I didn&apos;t persue it, but it might be interesting to do so.&lt;/p&gt;

&lt;p&gt;This patch also adds a new test, derby6666 to ConstraintCharacteristicsTest which fails without the fix in this patch (equivalent to repro).&lt;/p&gt;

&lt;p&gt;Running regressions.&lt;/p&gt;</comment>
                            <comment id="14080087" author="dagw" created="Wed, 30 Jul 2014 23:28:44 +0100"  >&lt;p&gt;Uploading version c of this patch which uses a cleaner version of the lcc.pushStatementContext idiom: we now explicitly pop it in a finally block. This makes it possible to use the atomic flag, which is more logical. Re-running regressions. &lt;font color=&quot;green&quot;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Update: regression passed&amp;#93;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="14080246" author="jira-bot" created="Thu, 31 Jul 2014 00:56:32 +0100"  >&lt;p&gt;Commit 1614796 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dagw&quot; class=&quot;user-hover&quot; rel=&quot;dagw&quot;&gt;Dag H. Wanvik&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1614796&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1614796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6666&quot; title=&quot;Deferred constraint validation fails with &amp;quot;dead statement&amp;quot; when query plan logging is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6666&quot;&gt;&lt;del&gt;DERBY-6666&lt;/del&gt;&lt;/a&gt; Deferred constraint validation fails with &quot;dead statement&quot; when query plan logging is enabled&lt;/p&gt;

&lt;p&gt;Patch derby-6666c.&lt;/p&gt;

&lt;p&gt;It removes this issue by adding push and push of the statement context&lt;br/&gt;
to the lcc before we execute the internal query to check for check&lt;br/&gt;
constraint violation. We had neglected to do this, which caused a&lt;br/&gt;
problem for the logging since the statement context should always be&lt;br/&gt;
properly initialized during execution.&lt;/p&gt;

&lt;p&gt;This patch also adds a new test, derby6666 to&lt;br/&gt;
ConstraintCharacteristicsTest which fails without the fix in this&lt;br/&gt;
patch (equivalent to repro).&lt;/p&gt;</comment>
                            <comment id="14147011" author="mikem" created="Wed, 24 Sep 2014 23:42:00 +0100"  >&lt;p&gt;I believe this bugs is specific to deferrable constraints so marking as not appropriate to backport to 10.10 and previous releases.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12658722" name="derby-6666.diff" size="2226" author="dagw" created="Wed, 30 Jul 2014 21:13:44 +0100"/>
                            <attachment id="12658749" name="derby-6666b.diff" size="7253" author="dagw" created="Wed, 30 Jul 2014 22:50:12 +0100"/>
                            <attachment id="12658756" name="derby-6666c.diff" size="8050" author="dagw" created="Wed, 30 Jul 2014 23:28:44 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 30 Jul 2014 00:23:59 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzroi7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405762</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>