<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1030/DERBY-1030.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1030] In some situations a RETURNS NULL ON NULL function is called when one ot its parameters is NULL</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1030</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The NULL argument to the function has to come from another function and that function&apos;s Java method has to return a Java object type corresponding to a fixed length SQL type, such as DATE, TIME and TIMESTAMP.&lt;/p&gt;

&lt;p&gt;Will attach repro scripts.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12329346">DERBY-1030</key>
            <summary>In some situations a RETURNS NULL ON NULL function is called when one ot its parameters is NULL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Feb 2006 04:59:30 +0000</created>
                <updated>Fri, 21 Jan 2011 18:28:00 +0000</updated>
                            <resolved>Wed, 2 Dec 2009 19:29:36 +0000</resolved>
                                    <version>10.6.1.0</version>
                                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12367392" author="djd" created="Thu, 23 Feb 2006 05:00:57 +0000"  >&lt;p&gt;Called derby-479 as that&apos;s the issue I was looking at when I saw this related but separate issue.&lt;/p&gt;</comment>
                            <comment id="12367393" author="djd" created="Thu, 23 Feb 2006 05:02:10 +0000"  >&lt;p&gt;Single patch could fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-479&quot; title=&quot;Passing the return of  a RETURN NULL ON NULL INPUT function to another function call throws linkage error.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-479&quot;&gt;&lt;del&gt;DERBY-479&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1030&quot; title=&quot;In some situations a RETURNS NULL ON NULL function is called when one ot its parameters is NULL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1030&quot;&gt;&lt;del&gt;DERBY-1030&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12367395" author="djd" created="Thu, 23 Feb 2006 05:03:19 +0000"  >&lt;p&gt;Single patch could fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-479&quot; title=&quot;Passing the return of  a RETURN NULL ON NULL INPUT function to another function call throws linkage error.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-479&quot;&gt;&lt;del&gt;DERBY-479&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1030&quot; title=&quot;In some situations a RETURNS NULL ON NULL function is called when one ot its parameters is NULL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1030&quot;&gt;&lt;del&gt;DERBY-1030&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12423702" author="mamtas" created="Wed, 26 Jul 2006 20:45:48 +0100"  >&lt;p&gt;Busy with grant revoke work, so unassigning myself from this one.&lt;/p&gt;</comment>
                            <comment id="12435843" author="rhillegas" created="Tue, 19 Sep 2006 15:59:50 +0100"  >&lt;p&gt;Moving to 10.2.2.0.&lt;/p&gt;</comment>
                            <comment id="12456924" author="djd" created="Fri, 8 Dec 2006 17:54:37 +0000"  >&lt;p&gt;Not going to get to this in the 10.2.2 timeframe&lt;/p&gt;</comment>
                            <comment id="12784329" author="rhillegas" created="Tue, 1 Dec 2009 18:37:27 +0000"  >&lt;p&gt;The bug is caused by an optimization intended to eliminate needless switching between the Java domain and the SQL domain.&lt;/p&gt;

&lt;p&gt;Two compile-time classes manage this switching:&lt;/p&gt;

&lt;p&gt;JavaToSQLNode - This class is responsible for changing Java data values into SQL data values that can be used by other expressions in the query. So for instance, this class is responsible for compiling the code which changes Integer and primitive int into SQLInteger.&lt;/p&gt;

&lt;p&gt;SQLToJavaNode - This class is responsible for the reverse operation, that is, for turning SQL data values into Java data values before they are passed as arguments to Java methods. So for instance, this class is responsible for compiling the runtime code which changes a SQLInteger into a primitive int before invoking a Java method.&lt;/p&gt;


&lt;p&gt;SQLToJavaNode also compiles the NULL ON NULL INPUT check: If the SQL data value is going to be used as the argument to a NULL ON NULL INPUT routine, then the SQLToJavaNode compiles short-circuiting logic that prevents the routine from being called if the SQL data value is null.&lt;/p&gt;

&lt;p&gt;Some performance can be lost when switching between the Java and SQL domains. We eliminate this switching if a Java data value becomes a SQL data value only to become a Java data value immediately afterwards. This happens when the return value of a Function is passed as an argument to another Routine. E.g.:&lt;/p&gt;

&lt;p&gt;  values ( outerFunction( innerFunction( 1 ) ) )&lt;/p&gt;

&lt;p&gt;In this case the AST shows a SQLToJavaNode wrapping a JavaToSQLNode returned by innerFunction. An optimization was put in to eliminate both conversion nodes in this case and to pass the return value of innerFunction directly as an argument to outerFunction.&lt;/p&gt;

&lt;p&gt;This optimization has a couple problems:&lt;/p&gt;

&lt;p&gt;1) If innerFunction is a NULL ON NULL INPUT Function and innerFunction is called with null inputs, then Derby tries to pass a null to outerFunction. This produces a verification error if outerFunction takes primitive arguments. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-479&quot; title=&quot;Passing the return of  a RETURN NULL ON NULL INPUT function to another function call throws linkage error.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-479&quot;&gt;&lt;del&gt;DERBY-479&lt;/del&gt;&lt;/a&gt; fixes this by eliminating the optimization in this case.&lt;/p&gt;

&lt;p&gt;2) If outerFunction is a NULL ON NULL INPUT Function, then the elimination of the SQLToJavaNode means that the NULL ON NULL INPUT check is not performed. This is the bug described by this JIRA.&lt;/p&gt;

&lt;p&gt;The fix is to also eliminate the optimization if the outer function is NULL ON NULL INPUT.&lt;/p&gt;</comment>
                            <comment id="12784334" author="rhillegas" created="Tue, 1 Dec 2009 18:49:02 +0000"  >&lt;p&gt;Attaching derby-1030-01-aa-disableOptimization.diff. This removes the over-eager optimization of switching between language domains when the outer Function is NULL ON NULL INPUT.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/compile/StaticMethodCallNode.java&lt;/p&gt;

&lt;p&gt;Removes the optimization.&lt;/p&gt;


&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutineTest.java&lt;/p&gt;

&lt;p&gt;As part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-479&quot; title=&quot;Passing the return of  a RETURN NULL ON NULL INPUT function to another function call throws linkage error.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-479&quot;&gt;&lt;del&gt;DERBY-479&lt;/del&gt;&lt;/a&gt;, a test case was added for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1030&quot; title=&quot;In some situations a RETURNS NULL ON NULL function is called when one ot its parameters is NULL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1030&quot;&gt;&lt;del&gt;DERBY-1030&lt;/del&gt;&lt;/a&gt;, enshrining the wrong behavior described by this bug. The test case is changed to enshrine the correct behavior.&lt;/p&gt;


&lt;p&gt;The regression tests passed cleanly for me except for an error in GeneratedColumnsTest which was recently introduced into the trunk by other work:&lt;/p&gt;

&lt;p&gt;There was 1 failure:&lt;br/&gt;
1) test_031_derby_4413(org.apache.derbyTesting.functionTests.tests.lang.GeneratedColumnsTest)junit.framework.ComparisonFailure: expected:&amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&amp;gt; but was:&amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&amp;gt;&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.GeneratedColumnsHelper.assertResults(GeneratedColumnsHelper.java:346)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.GeneratedColumnsHelper.assertResults(GeneratedColumnsHelper.java:310)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.GeneratedColumnsTest.test_031_derby_4413(GeneratedColumnsTest.java:5442)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:109)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;/p&gt;

&lt;p&gt;FAILURES!!!&lt;br/&gt;
Tests run: 34,  Failures: 1,  Errors: 0&lt;/p&gt;</comment>
                            <comment id="12784566" author="bryanpendleton" created="Wed, 2 Dec 2009 00:31:41 +0000"  >&lt;p&gt;Thanks for the clear and detailed explanation, Rick, it was very interesting!&lt;/p&gt;

&lt;p&gt;&amp;gt; JavaToSQLNode - This class is responsible for turning SQL data values into Java data values before &lt;br/&gt;
&amp;gt; they are passed as arguments to Java methods. So for instance, this class is responsible for compiling &lt;br/&gt;
&amp;gt; the runtime code which changes a SQLInteger into a primitive int before invoking a Java method.&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; SQLToJavaNode - This class is responsible for the reverse operation, that is, for changing Java &lt;br/&gt;
&amp;gt; data values into SQL data values that can be used by other expressions in the query. So for instance, &lt;br/&gt;
&amp;gt; this class is responsible for compiling the code which changes Integer and primitive int into SQLInteger. &lt;/p&gt;

&lt;p&gt;Did I misread this? It seems backward to me. It seems like JavaToSQLNode should&lt;br/&gt;
be the one which turns a Java value into a SQL value, and SQLToJavaNode should be the one which&lt;br/&gt;
turns a SQL value into a Java value.&lt;/p&gt;</comment>
                            <comment id="12784809" author="rhillegas" created="Wed, 2 Dec 2009 13:15:25 +0000"  >&lt;p&gt;Thanks for catching that howler, Bryan. I have corrected the comment. Cheers.&lt;/p&gt;</comment>
                            <comment id="12784968" author="rhillegas" created="Wed, 2 Dec 2009 19:29:12 +0000"  >&lt;p&gt;Committed derby-1030-01-aa-disableOptimization.diff at subversion revision 886277.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12354628">DERBY-2034</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12312748">DERBY-479</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12442110">DERBY-4459</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12426561" name="derby-1030-01-aa-disableOptimization.diff" size="2170" author="rhillegas" created="Tue, 1 Dec 2009 18:49:02 +0000"/>
                            <attachment id="12323285" name="derby479.java" size="789" author="djd" created="Thu, 23 Feb 2006 05:00:57 +0000"/>
                            <attachment id="12323286" name="derby479.sql" size="909" author="djd" created="Thu, 23 Feb 2006 05:00:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 26 Jul 2006 19:45:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22273</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0jpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37012</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>