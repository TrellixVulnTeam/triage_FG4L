<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:22:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3875/DERBY-3875.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3875] Derby cannot replace a database after encountering corruption</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3875</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When Derby encounters a corrupt data file, it does not close the data file before throwing an exception to the caller.  If the user tries to replace the database with a backup in response to the corruption, Derby will first attempt to delete the contents of the corrupt database.  But since the corrupt file was never closed, it cannot be deleted, and Derby fails to start.&lt;/p&gt;

&lt;p&gt;The attached java code should reproduce the problem, and the attached patch should fix it.&lt;/p&gt;
</description>
                <environment>------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.6.0_06&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
Java home:       C:\Program Files\Java\jre1.6.0_06&lt;br/&gt;
Java classpath:  C:\Working\Derby-fileclose-fix\bin;C:\Working\Derby-fileclose-fix\lib\derby.jar&lt;br/&gt;
OS name:         Windows XP&lt;br/&gt;
OS architecture: x86&lt;br/&gt;
OS version:      5.1&lt;br/&gt;
Java user name:  Administrator&lt;br/&gt;
Java user home:  C:\Documents and Settings\Administrator&lt;br/&gt;
Java user dir:   C:\Working\Derby-fileclose-fix&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.6&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: Java SE 6 - JDBC 4.0&lt;br/&gt;
[C:\Working\Derby-fileclose-fix\lib\derby.jar] 10.4.2.0 - (689064)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Locale Information -----------------&lt;br/&gt;
------------------------------------------------------</environment>
        <key id="12404230">DERBY-3875</key>
            <summary>Derby cannot replace a database after encountering corruption</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmclaurin">Jason McLaurin</assignee>
                                    <reporter username="jmclaurin">Jason McLaurin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Sep 2008 09:24:49 +0100</created>
                <updated>Tue, 30 Jun 2009 17:02:45 +0100</updated>
                            <resolved>Sat, 11 Oct 2008 00:48:36 +0100</resolved>
                                    <version>10.4.2.0</version>
                                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <timeoriginalestimate seconds="7200">2h</timeoriginalestimate>
                            <timeestimate seconds="7200">2h</timeestimate>
                                        <comments>
                            <comment id="12630517" author="jmclaurin" created="Fri, 12 Sep 2008 09:26:54 +0100"  >&lt;p&gt;Test case&lt;/p&gt;</comment>
                            <comment id="12630518" author="jmclaurin" created="Fri, 12 Sep 2008 09:28:13 +0100"  >&lt;p&gt;Patch&lt;/p&gt;</comment>
                            <comment id="12630704" author="kristwaa" created="Sat, 13 Sep 2008 00:00:28 +0100"  >&lt;p&gt;Thank you for the repro and the patch, Jason.&lt;/p&gt;

&lt;p&gt;I can bring the issue forwards, unless you want to do it yourself?&lt;br/&gt;
If so, let me know and I&apos;ll add you to the Derby developer group so that you can assign yourself to the issue.&lt;br/&gt;
The way I see it, what remains is to fit the test case into Derby&apos;s &quot;test framework&quot; (requires some rewriting) and getting someone to review/commit the patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;FYI, I saw the described behavior on Windows (XP, SP2). Doesn&apos;t seem to be a problem on Solaris though. In any case, this is a problem that should be fixed by closing the opened resources.&lt;/p&gt;</comment>
                            <comment id="12630817" author="jmclaurin" created="Sat, 13 Sep 2008 21:10:12 +0100"  >&lt;p&gt;Hi Kristian,&lt;/p&gt;

&lt;p&gt;Although I&apos;d love to get more involved at some point, I don&apos;t quite have the time to learn Derby&apos;s test framework and adapt the test case.  Thanks for the quick response... I&apos;ll try to learn from how this issue gets carried forward, and maybe take a bigger role on the next one.&lt;/p&gt;</comment>
                            <comment id="12630950" author="kristwaa" created="Mon, 15 Sep 2008 08:48:46 +0100"  >&lt;p&gt;Hi Jason,&lt;/p&gt;

&lt;p&gt;Okay, I&apos;ll get the fix in.&lt;/p&gt;

&lt;p&gt;BTW, there is no license grant on the demo/repro. Was this intentional? If not, can you reattach it?&lt;/p&gt;


&lt;p&gt;thanks,&lt;/p&gt;</comment>
                            <comment id="12631048" author="jmclaurin" created="Mon, 15 Sep 2008 16:27:52 +0100"  >&lt;p&gt;Here&apos;s the repro with the ASF license.  Thanks for taking care of this.&lt;/p&gt;</comment>
                            <comment id="12636508" author="myrna" created="Fri, 3 Oct 2008 02:05:43 +0100"  >&lt;p&gt;I thought I&apos;d try making a test for this, and I&apos;ve got something started, but the patch doesn&apos;t actually seem to fix the problem for me.&lt;/p&gt;

&lt;p&gt;The repro attached gives this output for me, with, or without the patch applied:&lt;br/&gt;
Exception in thread &quot;main&quot; java.sql.SQLException: Failed to start database &apos;testDatabase&apos;, see the next exception for details.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:87)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.seeNextException(Util.java:223)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:2611)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.&amp;lt;init&amp;gt;(EmbedConnection.java:365)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection30.&amp;lt;init&amp;gt;(EmbedConnection30.java:73)&lt;br/&gt;
	at org.apache.derby.jdbc.Driver30.getNewEmbedConnection(Driver30.java:80)&lt;br/&gt;
	at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:238)&lt;br/&gt;
	at org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)&lt;br/&gt;
	at java.sql.DriverManager.getConnection(DriverManager.java:525)&lt;br/&gt;
	at java.sql.DriverManager.getConnection(DriverManager.java:193)&lt;br/&gt;
	at FileCloseBugDemo.main(FileCloseBugDemo.java:46)&lt;br/&gt;
Caused by: java.sql.SQLException: Directory database\&amp;lt;pathtomytestdir&amp;gt;\database\testDatabase cannot be removed.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:201)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:2609)&lt;br/&gt;
	... 8 more&lt;br/&gt;
Caused by: ERROR XBM0I: Directory database\&amp;lt;pathtomytestdir&amp;gt;\database\testDatabase cannot be removed.&lt;br/&gt;
	at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:286)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.StorageFactoryService$9.run(StorageFactoryService.java:666)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.StorageFactoryService.createServiceRoot(StorageFactoryService.java:650)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.StorageFactoryService.recreateServiceRoot(StorageFactoryService.java:582)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.StorageFactoryService.getServiceProperties(StorageFactoryService.java:248)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.findProviderAndStartService(BaseMonitor.java:1568)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.startPersistentService(BaseMonitor.java:1021)&lt;br/&gt;
	at org.apache.derby.iapi.services.monitor.Monitor.startPersistentService(Monitor.java:550)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:2572)&lt;br/&gt;
	... 8 more&lt;/p&gt;</comment>
                            <comment id="12636558" author="kristwaa" created="Fri, 3 Oct 2008 08:07:46 +0100"  >&lt;p&gt;I wrote a repro for our JUnit framework as well, and found that the patch did fix the problem.&lt;br/&gt;
The code is on another machine, but I&apos;ll upload it (latest on Monday) and we can compare and see what&apos;s different between the two repros.&lt;/p&gt;

&lt;p&gt;If you post your repro, I&apos;ll run it on a Windows box.&lt;/p&gt;</comment>
                            <comment id="12637137" author="myrna" created="Mon, 6 Oct 2008 17:48:03 +0100"  >&lt;p&gt;The output I printed was from the original repro posted by Jason McLaurin...&lt;/p&gt;

&lt;p&gt;I&apos;m tweaking some things on my junit test and will attach it soon.&lt;/p&gt;</comment>
                            <comment id="12637138" author="myrna" created="Mon, 6 Oct 2008 17:55:57 +0100"  >&lt;p&gt;Attaching my attempt at a junit test.&lt;/p&gt;</comment>
                            <comment id="12637522" author="kristwaa" created="Tue, 7 Oct 2008 16:42:47 +0100"  >&lt;p&gt;&apos;derby-3875-BackupRestoreTest.diff&apos; is also an attempt at a JUnit test/repro.&lt;br/&gt;
It is not ready for commit (for instance, it cannot run in a JSR169 environment).&lt;/p&gt;</comment>
                            <comment id="12637609" author="myrna" created="Tue, 7 Oct 2008 19:57:36 +0100"  >&lt;p&gt;I like the fact that you use the name BackupRestoreTest - we can maybe later convert some of other backup/restore test cases and add them in...&lt;br/&gt;
But yes, we should probably use DataSources like I did in my test case...&lt;/p&gt;

&lt;p&gt;And this one too fails for me with and without the fix to RAFContainer - on windows.&lt;/p&gt;</comment>
                            <comment id="12637652" author="myrna" created="Tue, 7 Oct 2008 22:04:45 +0100"  >&lt;p&gt;Ah, the tests and repro &lt;b&gt;pass&lt;/b&gt; when built insane...not when built sane...&lt;/p&gt;</comment>
                            <comment id="12637819" author="kristwaa" created="Wed, 8 Oct 2008 08:58:39 +0100"  >&lt;p&gt;Thanks Myrna.&lt;br/&gt;
I confirmed this on my Windows machine. This is not my primary developer platform, and for some reason Derby was built with insane, even though my ant properties file said sane.&lt;/p&gt;

&lt;p&gt;A quick investigation revealed the following assert as the cause - AllocPage.ReadContainerInfo, line 597: (code reformatted for brevity)&lt;br/&gt;
	public static void ReadContainerInfo(byte[] containerInfo, byte[] epage)	{&lt;br/&gt;
		int N = (int)epage&lt;span class=&quot;error&quot;&gt;&amp;#91;BORROWED_SPACE_OFFSET&amp;#93;&lt;/span&gt;;&lt;br/&gt;
		if (SanityManager.DEBUG) {&lt;br/&gt;
			if (N != containerInfo.length)&lt;br/&gt;
				SanityManager.THROWASSERT(&quot;N not what is expected : &quot; +  N); &amp;lt;---- THIS ONE IS TRIGGERED&lt;/p&gt;

&lt;p&gt;			if (BORROWED_SPACE_OFFSET + BORROWED_SPACE_LEN + N&lt;br/&gt;
								 						&amp;gt;= MAX_BORROWED_SPACE) &lt;/p&gt;
{
				SanityManager.THROWASSERT(&quot;exceed max borrowable space: &quot; + N);
            }
&lt;p&gt;		}&lt;/p&gt;

&lt;p&gt;		if (N != 0)&lt;br/&gt;
			System.arraycopy(epage, BORROWED_SPACE_OFFSET+BORROWED_SPACE_LEN, containerInfo, 0, N);&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;Disabling the triggered assert makes the repro pass.&lt;br/&gt;
I&apos;m not sure how to handle this issue, but we do need the repro to pass for sane builds. A few ideas:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;disable assert&lt;/li&gt;
	&lt;li&gt;make the catch clause in RAFContainer.openContainer broader to close the file handles on any error&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Any other ideas?&lt;/p&gt;</comment>
                            <comment id="12638001" author="myrna" created="Wed, 8 Oct 2008 18:48:00 +0100"  >&lt;p&gt;I think it&apos;s better to keep the assert and make the catch clause in RAFContainer.openContainer broader. &lt;br/&gt;
I looked briefly at catching an Exception, but that gets to be quite a big change, requiring adding throwing Exceptions in many places, and is that really necessary?&lt;br/&gt;
SanityManager.Asserts are RuntimeExceptions, and, very helpfully, you don&apos;t need to declare those. &lt;br/&gt;
So, all we need is to add a catch for RuntimeException:&lt;br/&gt;
        ....&lt;br/&gt;
        catch  (PrivilegedActionException pae) &lt;/p&gt;
{
             closeContainer();
             throw (StandardException) pae.getException();
        }
&lt;p&gt;        catch (RuntimeException e) &lt;/p&gt;
{
            closeContainer();
            throw e;
        }

&lt;p&gt;I think that will do...&lt;/p&gt;</comment>
                            <comment id="12638089" author="myrna" created="Wed, 8 Oct 2008 22:08:57 +0100"  >&lt;p&gt;Attached is a patch that combines elements from Jason&apos;s original patch, most of Kristian&apos;s test, and some additions/modifications:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;as discussed, the original fix didn&apos;t stop the error from occurring with sane builds; adding a RuntimeException catch block to closeContainer() in fixed that.&lt;/li&gt;
	&lt;li&gt;modified Kristian&apos;s test so it runs with JSR169:&lt;/li&gt;
	&lt;li&gt;copied StringUtil&apos;s split method to junit.Utilities and use that instead of the String.split method which isn&apos;t available in jclFoundation/j2ME&lt;br/&gt;
     (didn&apos;t want to use StringUtil.split as I worried about that possibly changing the build order or affecting what goes in the derbyTesting.jar)&lt;/li&gt;
	&lt;li&gt;used datasources to get the connection instead of DriverManager&lt;/li&gt;
	&lt;li&gt;added the test to tests.store._Suite&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I ran the new BackupRestoreTest on windows with insane and sane builds with ibm&apos;s j9-jclFoundation and jdk15, store._Suite on windows (insane build) with jdk15, j9-jclFoundation and ibm16, and all looks good. I&apos;m running suites.All for good measure on linux - if this all looks good, I can check it in...&lt;/p&gt;</comment>
                            <comment id="12638154" author="myrna" created="Thu, 9 Oct 2008 01:32:27 +0100"  >&lt;p&gt;suites.All and derbyall passed...&lt;/p&gt;</comment>
                            <comment id="12638376" author="myrna" created="Thu, 9 Oct 2008 21:23:09 +0100"  >&lt;p&gt;I&apos;ve committed the latest patch with revision 703246.&lt;/p&gt;

&lt;p&gt;I&apos;ll leave this unassigned - I&apos;d assign to Jason for identifying the issue, but he&apos;s not on the list.&lt;/p&gt;</comment>
                            <comment id="12638506" author="kristwaa" created="Fri, 10 Oct 2008 09:20:08 +0100"  >&lt;p&gt;Thanks Myrna.&lt;/p&gt;

&lt;p&gt;I was going to look at the patch yesterday, but got preempted. However, I did have a look at it today and it looks good to me. +1 to commit.&lt;br/&gt;
I suppose this fix should be backported to 10.4.&lt;/p&gt;

&lt;p&gt;Regarding Jason and the developer list, I can add him if he requests to be added.&lt;/p&gt;</comment>
                            <comment id="12638621" author="myrna" created="Fri, 10 Oct 2008 19:25:46 +0100"  >&lt;p&gt;reopen to backport to 10.4&lt;/p&gt;</comment>
                            <comment id="12638684" author="myrna" created="Sat, 11 Oct 2008 00:48:36 +0100"  >&lt;p&gt;backported to 10.4 with revision 703608. &lt;/p&gt;</comment>
                            <comment id="12639290" author="jmclaurin" created="Tue, 14 Oct 2008 05:06:42 +0100"  >&lt;p&gt;Verified the fix against the nightly trunk build.  Thanks Kristian and Myrna for your work improving and committing the code!&lt;/p&gt;</comment>
                            <comment id="12639316" author="kristwaa" created="Tue, 14 Oct 2008 07:31:41 +0100"  >&lt;p&gt;Assigned Jason to the issue (we spoke briefly offline).&lt;/p&gt;

&lt;p&gt;Thanks Myrna!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12391779" name="DERBY-3875_2.diff" size="10744" author="myrna" created="Wed, 8 Oct 2008 22:08:57 +0100"/>
                            <attachment id="12391552" name="DERBY-3875_tst1.diff" size="9644" author="myrna" created="Mon, 6 Oct 2008 17:55:57 +0100"/>
                            <attachment id="12390115" name="FileCloseBugDemo.java" size="1640" author="jmclaurin" created="Mon, 15 Sep 2008 16:27:52 +0100"/>
                            <attachment id="12389992" name="FileCloseBugDemo.java" size="1640" author="jmclaurin" created="Fri, 12 Sep 2008 09:26:54 +0100"/>
                            <attachment id="12389993" name="RAFContainerPatch.txt" size="911" author="jmclaurin" created="Fri, 12 Sep 2008 09:28:13 +0100"/>
                            <attachment id="12391641" name="derby-3875-BackupRestoreTest.diff" size="6902" author="kristwaa" created="Tue, 7 Oct 2008 16:42:47 +0100"/>
                            <attachment id="12391642" name="derby-3875-BackupRestoreTest.stat" size="187" author="kristwaa" created="Tue, 7 Oct 2008 16:42:47 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 12 Sep 2008 23:00:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23893</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0unz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38786</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>