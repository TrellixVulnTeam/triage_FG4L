<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:41:08 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4116/DERBY-4116.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4116] SYSCS_UTIL.SYSCS_UPDATE_STATISTICS should update the store estimated row count for the table</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4116</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When SYSCS_UTIL.SYSCS_UPDATE_STATISTICS is run, it doesn&apos;t update the store estimated row count.  The program oldSelectivity.java attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3955&quot; title=&quot;test lang/selectivity.sql can be revived&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3955&quot;&gt;&lt;del&gt;DERBY-3955&lt;/del&gt;&lt;/a&gt; shows that the statistics are not updated.&lt;/p&gt;

&lt;p&gt;See discussions in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3955&quot; title=&quot;test lang/selectivity.sql can be revived&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3955&quot;&gt;&lt;del&gt;DERBY-3955&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3955?focusedCommentId=12688789&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12688789&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-3955?focusedCommentId=12688789&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12688789&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3955?focusedCommentId=12688813&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12688813&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-3955?focusedCommentId=12688813&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12688813&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12419355">DERBY-4116</key>
            <summary>SYSCS_UTIL.SYSCS_UPDATE_STATISTICS should update the store estimated row count for the table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Mar 2009 21:43:17 +0000</created>
                <updated>Tue, 30 Jun 2009 17:02:43 +0100</updated>
                            <resolved>Thu, 2 Apr 2009 13:33:27 +0100</resolved>
                                    <version>10.6.1.0</version>
                                    <fixVersion>10.5.1.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12688894" author="kmarsden" created="Tue, 24 Mar 2009 21:45:14 +0000"  >&lt;p&gt;This issue blocks &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3955&quot; title=&quot;test lang/selectivity.sql can be revived&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3955&quot;&gt;&lt;del&gt;DERBY-3955&lt;/del&gt;&lt;/a&gt;.  The test won&apos;t be able to be converted until this issue is resolved.&lt;/p&gt;</comment>
                            <comment id="12688935" author="kmarsden" created="Tue, 24 Mar 2009 23:45:46 +0000"  >&lt;p&gt;Well just to see if this was a really easy fix, so I could continue my testing, I tried the trivial patch below:&lt;/p&gt;

&lt;p&gt;&amp;#8212; java/engine/org/apache/derby/impl/sql/execute/AlterTableConstantAction.java (revision 757498)&lt;br/&gt;
+++ java/engine/org/apache/derby/impl/sql/execute/AlterTableConstantAction.java (working copy)&lt;br/&gt;
@@ -744,6 +744,7 @@&lt;br/&gt;
                                        rowBufferArray&lt;span class=&quot;error&quot;&gt;&amp;#91;GROUP_FETCH_SIZE - 1&amp;#93;&lt;/span&gt; = lastUniqueKey;&lt;br/&gt;
                                        lastUniqueKey = tmp;&lt;br/&gt;
                                } // while&lt;br/&gt;
+                               gsc.setEstimatedRowCount(numRows);&lt;br/&gt;
                        } // try&lt;br/&gt;
                        finally&lt;br/&gt;
                        {&lt;/p&gt;


&lt;p&gt;but it doesn&apos;t affect my test case.  I verified that with this change the code goes through&lt;br/&gt;
OpenBTree.setEstimatedRowCount and sets the count to 4000, but there is this comment in OpenBTree.setEstimatedRowCount():&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;This call is currently only supported on Heap conglomerates, it&lt;/li&gt;
	&lt;li&gt;will throw an exception if called on btree conglomerates.&lt;br/&gt;
     *&lt;br/&gt;
It doesn&apos;t throw an exception, but it doesn&apos;t seem to do too much either. Any ideas what&apos;s wrong?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12689068" author="knutanders" created="Wed, 25 Mar 2009 10:22:45 +0000"  >&lt;p&gt;I guess it&apos;s only implemented for heap conglomerates because the row count should really be the same in the base table and all its indexes, and there&apos;s no need to store the estimated row count for a table more than one place. The optimizer will probably always look for the estimate in the heap conglomerate, so it doesn&apos;t notice the estimate in the index.&lt;/p&gt;

&lt;p&gt;Does it work as expected if you do something like this near the end of the method?&lt;/p&gt;

&lt;p&gt;        ScanController heapSC = tc.openScan(td.getHeapConglomerateId(), ...);&lt;br/&gt;
        heapSC.setEstimatedRowCount(rowCount);&lt;br/&gt;
        heapSC.close();&lt;/p&gt;</comment>
                            <comment id="12689098" author="kmarsden" created="Wed, 25 Mar 2009 12:45:32 +0000"  >&lt;p&gt;Thanks Knut, that seemed to do the trick.  I will make a proper patch for the issue and do testing.  I think I&apos;ll keep the index estimatedRowCount update since it does seem to be being set, just in case someone is using it for something.&lt;/p&gt;

</comment>
                            <comment id="12689170" author="kmarsden" created="Wed, 25 Mar 2009 17:25:27 +0000"  >&lt;p&gt;Attached is a patch for this issue. derby-4116_diff.txt.  It also included the initial partial conversion of selectivity.sql &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3955&quot; title=&quot;test lang/selectivity.sql can be revived&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3955&quot;&gt;&lt;del&gt;DERBY-3955&lt;/del&gt;&lt;/a&gt; which tests this issue.  suites.All and derbyall passed except for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3993&quot; title=&quot;With IBM 1.6 T_RawStoreFactory fails with There should be 0 observers, but we still have 1 observers on Win 2K&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3993&quot;&gt;&lt;del&gt;DERBY-3993&lt;/del&gt;&lt;/a&gt;, a known issue.&lt;/p&gt;

&lt;p&gt;Please review. Especially, please  check my arguments to openScan to make sure I got that right.&lt;/p&gt;

</comment>
                            <comment id="12689454" author="knutanders" created="Thu, 26 Mar 2009 11:35:08 +0000"  >&lt;p&gt;The arguments to openScan() look correct to me. Since we don&apos;t actually scan the conglomerate, many of them wouldn&apos;t make any difference anyway, I think.&lt;/p&gt;

&lt;p&gt;Now we update the heap conglomerate inside the for loop, which means that we&apos;ll update it once per index. Would it be enough to update it once, after we have gone through the last index?&lt;/p&gt;

&lt;p&gt;Nit: openScan() should be called outside the try block (if it fails, there&apos;s no open scan to close). If it&apos;s moved out of the try block, the check for heapSC!=null in the finally block can be removed too.&lt;/p&gt;</comment>
                            <comment id="12689462" author="kmarsden" created="Thu, 26 Mar 2009 12:52:48 +0000"  >&lt;p&gt;Thanks Knut for reviewing the changes, especially catching that I was doing the update inside the loop.  I will make the changes and post a new patch soon.&lt;/p&gt;

</comment>
                            <comment id="12689468" author="kmarsden" created="Thu, 26 Mar 2009 13:12:49 +0000"  >&lt;p&gt;Here is an updated patch for this issue.  I am rerunning tests and will check in later today if all goes well.&lt;/p&gt;</comment>
                            <comment id="12689472" author="knutanders" created="Thu, 26 Mar 2009 13:25:51 +0000"  >&lt;p&gt;With the latest patch, I think the row count estimate will always be set to 0 if you call SYSCS_UPDATE_STATISTICS on a table with no indexes, even if the table is not empty. Would it be possible to initialize rowCount to -1, so that we can detect that the row count was not calculated, and then add &quot;if (rowCount &amp;gt;= 0)&quot; around the call to setEstimatedRowCount()?&lt;/p&gt;</comment>
                            <comment id="12689661" author="kmarsden" created="Thu, 26 Mar 2009 21:09:46 +0000"  >&lt;p&gt;Unchecking patch available. I will make a new patch with Knut&apos;s suggestion., but it is looking like that won&apos;t happen today. Thanks again Knut for your valuable input.&lt;/p&gt;</comment>
                            <comment id="12689967" author="kmarsden" created="Fri, 27 Mar 2009 17:03:50 +0000"  >&lt;p&gt;Attached is an updated patch for this issue.  This patch will not update the store estimated row count if no index scan was performed.&lt;/p&gt;

&lt;p&gt;I tried to add a test to UpdateStatisticsTest to verify this, but ran into some trouble because the estimated row counts we get back from runtime statistics do not return this information directly.  I did manually verify that we do not go thre setEstimatedRowCount for update statistics on a table with no index.&lt;/p&gt;

&lt;p&gt;Regarding the use of internal interfaces in checkEstimatedRowCount, Myrna suggested that I clobber and build and make sure there were no build order issues and also that I make sure derbyTesting.jar didn&apos;t pick up the product classes.  I checked both and the change seems ok from a build perspective.&lt;/p&gt;

&lt;p&gt;I ran SelectivityTest and UpdateStatisticsTest and  am running tests  now but don&apos;t anticipate any problems since they don&apos;t exercise this code.  Please review.&lt;/p&gt;</comment>
                            <comment id="12693858" author="kmarsden" created="Mon, 30 Mar 2009 18:39:39 +0100"  >&lt;p&gt;The patch derby-4116_diff3.txt is the current patch as of this comment. Somehow it did not get attached with my last attempt.&lt;/p&gt;</comment>
                            <comment id="12693868" author="mikem" created="Mon, 30 Mar 2009 19:00:35 +0100"  >&lt;p&gt;patch looks good to me.  The only thing I noticed is that the current index scans use an open for read (argument 0), but your new heap open  does an open for update.  It seems like both&lt;br/&gt;
opens should use the same - either read or write, and since the existing scans and update of the estimate seems to work it seems better to open the heap for read also.  &lt;/p&gt;</comment>
                            <comment id="12694008" author="knutanders" created="Tue, 31 Mar 2009 09:13:30 +0100"  >&lt;p&gt;Patch 3 looks good to me too. Thanks for all the work.&lt;/p&gt;</comment>
                            <comment id="12694163" author="kmarsden" created="Tue, 31 Mar 2009 16:58:30 +0100"  >&lt;p&gt;I made the change recommended by Mike and committed revision 760497 to trunk.  I will wait for clean nightly results and backport to 10.5. Meanwhile I&apos;ll leave this issue open.  Thanks for the reviews!&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12408783">DERBY-3955</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="32488">DERBY-269</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12403623" name="derby-4116_diff.txt" size="10323" author="kmarsden" created="Wed, 25 Mar 2009 17:25:27 +0000"/>
                            <attachment id="12403710" name="derby-4116_diff2.txt" size="11113" author="kmarsden" created="Thu, 26 Mar 2009 13:12:49 +0000"/>
                            <attachment id="12404165" name="derby-4116_diff3.txt" size="12128" author="kmarsden" created="Mon, 30 Mar 2009 18:39:39 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 25 Mar 2009 10:22:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24033</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0uon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38789</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>