<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:49:04 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6006/DERBY-6006.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6006] NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6006</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A NullPointerException was reported by Harm-Jan Zwinderman on derby-user:&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/201211.mbox/%3C50B66527.5040906%40gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/201211.mbox/%3C50B66527.5040906%40gmail.com%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve managed to reproduce it on 10.9.1.0 like this:&lt;/p&gt;

&lt;p&gt;ij version 10.9&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create table t(x double);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t values (0);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; prepare ps as &apos;insert into t select 1 from t order by x&apos;;&lt;br/&gt;
ij&amp;gt; execute ps;&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; execute ps;&lt;br/&gt;
2 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; execute ps;&lt;br/&gt;
4 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; execute ps;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;/p&gt;

&lt;p&gt;Full stack trace:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.store.access.conglomerate.ConglomerateUtil.createFormatIds(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.Heap.create(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.HeapConglomerateFactory.createConglomerate(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.access.RAMTransaction.createConglomerate(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.TemporaryRowHolderImpl.insert(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.ExecuteStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.ijStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.go(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.go(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.mainCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.main(Unknown Source)&lt;br/&gt;
	at org.apache.derby.tools.ij.main(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.tools.run.main(Unknown Source)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12618560">DERBY-6006</key>
            <summary>NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Dec 2012 13:02:16 +0000</created>
                <updated>Fri, 12 Jul 2013 23:36:09 +0100</updated>
                            <resolved>Thu, 6 Dec 2012 16:34:37 +0000</resolved>
                                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                    <version>10.8.3.0</version>
                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.3.3</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13508712" author="knutanders" created="Mon, 3 Dec 2012 13:22:45 +0000"  >&lt;p&gt;Debug versions produce another error. And all executions of the INSERT ... ORDER BY statements fail with the debug version, not only the fourth execution.&lt;/p&gt;

&lt;p&gt;Stack trace with 10.9.1.0 debug:&lt;/p&gt;

&lt;p&gt;ERROR XSCH5: In a base table there was a mismatch between the requested column number 1 and the maximum number of columns 1.&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:295)&lt;br/&gt;
        at org.apache.derby.impl.store.access.heap.HeapController.doInsert(HeapController.java:235)&lt;br/&gt;
        at org.apache.derby.impl.store.access.heap.HeapController.insert(HeapController.java:575)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:457)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:1155)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:508)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:443)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:324)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1242)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1715)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(EmbedPreparedStatement.java:1370)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.ExecuteStatement(ij.java:2521)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.ijStatement(ij.java:1158)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:347)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:245)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:59)&lt;br/&gt;
        at org.apache.derby.iapi.tools.run.main(run.java:53)&lt;/p&gt;</comment>
                            <comment id="13508718" author="knutanders" created="Mon, 3 Dec 2012 13:27:23 +0000"  >&lt;p&gt;Before &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4397&quot; title=&quot;Allow ORDER BY in subqueries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4397&quot;&gt;&lt;del&gt;DERBY-4397&lt;/del&gt;&lt;/a&gt; (Derby 10.6.1.0), ORDER BY wasn&apos;t allowed in INSERT statements, so the statement would fail to compile. The NullPointerException is reproducible on 10.6 and all subsequent branches.&lt;/p&gt;</comment>
                            <comment id="13509768" author="knutanders" created="Tue, 4 Dec 2012 14:36:20 +0000"  >&lt;p&gt;The insert statement fails because it gets confused as to how many columns the nested select returns. Since the order by column is not in the select list, it gets added to the result columns of the underlying select. It should normally be removed before the insert sees it. However, since the select list contains an INT, and the target type in the table is DOUBLE, a NormalizeResultSetNode is added on top of the SelectNode. NormalizeResultSetNode.init() has code to remove columns added for GROUP BY, but not for ORDER BY. I think it should work if NRSN.init() also removed ORDER BY columns.&lt;/p&gt;</comment>
                            <comment id="13509824" author="knutanders" created="Tue, 4 Dec 2012 16:07:21 +0000"  >&lt;p&gt;The attached patch (d6006-1a-remove-extra-columns.diff) makes the suggested change to NormalizeResultSetNode.init() and adds a test case to verify the fix.&lt;/p&gt;

&lt;p&gt;I&apos;m running the full regression test suite now to verify that it doesn&apos;t break anything.&lt;/p&gt;</comment>
                            <comment id="13509983" author="knutanders" created="Tue, 4 Dec 2012 20:10:22 +0000"  >&lt;p&gt;All regression tests passed with the patch.&lt;/p&gt;</comment>
                            <comment id="13511445" author="dagw" created="Thu, 6 Dec 2012 15:13:29 +0000"  >&lt;p&gt;The fix looks correct to me, +1. Cf also similar code in the new patch I made for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6008&quot; title=&quot;Allow ORDER BY and FETCH/OFFSET in set operands&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6008&quot;&gt;&lt;del&gt;DERBY-6008&lt;/del&gt;&lt;/a&gt; in SetOperatorNode#buildRCL.&lt;/p&gt;</comment>
                            <comment id="13511498" author="knutanders" created="Thu, 6 Dec 2012 16:34:37 +0000"  >&lt;p&gt;Thanks, Dag.&lt;/p&gt;

&lt;p&gt;Committed revision 1417991.&lt;/p&gt;</comment>
                            <comment id="13526088" author="bryanpendleton" created="Fri, 7 Dec 2012 02:16:40 +0000"  >&lt;p&gt;As yes, the generated order by columns appearing where code doesn&apos;t expect them to.&lt;/p&gt;

&lt;p&gt;A nice clean patch, clearly described. Thanks for cleaning this up!&lt;/p&gt;

&lt;p&gt;Perhaps a future enhancement would be to have a single method that&lt;br/&gt;
removed &lt;b&gt;both&lt;/b&gt; generated GROUP BY columns and generated ORDER BY&lt;br/&gt;
columns, so that code like:&lt;/p&gt;

&lt;p&gt;        prRCList.removeGeneratedGroupingColumns();&lt;br/&gt;
        prRCList.removeOrderByColumns();&lt;/p&gt;

&lt;p&gt;would instead be a single call to something like:&lt;/p&gt;

&lt;p&gt;        prRCList.removeGeneratedColumns();&lt;/p&gt;</comment>
                            <comment id="13526232" author="knutanders" created="Fri, 7 Dec 2012 08:45:13 +0000"  >&lt;p&gt;Thanks, Bryan. I agree that it would be nice with a single call. But it looks like we still need to preserve the two original methods, since SelectNode.genProjectRestrict() and SelectNode.preprocess() handle GROUP BY and ORDER BY separately. It might of course be possible reorganize it somehow.&lt;/p&gt;

&lt;p&gt;On the bright side, it looks like we&apos;ve squashed this particular class of bugs for now. There are three calls to removeGeneratedGroupingColumns() in the code base: one in SelectNode.genProjectRestrict(), one in NormalizeResultSet.init(), and one in SetOperator.buildRCL(). SelectNode already had calls to removeOrderByColumns(). This issue adds it to NormalizeResultSet. And Dag will add it to SetOperator in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6008&quot; title=&quot;Allow ORDER BY and FETCH/OFFSET in set operands&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6008&quot;&gt;&lt;del&gt;DERBY-6008&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13706037" author="mikem" created="Thu, 11 Jul 2013 19:07:51 +0100"  >&lt;p&gt;temp assigning to myself for backport.&lt;/p&gt;

&lt;p&gt;backporting the following change from the 10.10 branch:&lt;br/&gt;
r1417991 | kahatlen | 2012-12-06 08:33:42 -0800 (Thu, 06 Dec 2012) | 4 lines&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6006&quot; title=&quot;NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6006&quot;&gt;&lt;del&gt;DERBY-6006&lt;/del&gt;&lt;/a&gt;: NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY&lt;/p&gt;

&lt;p&gt;A NormalizeResultSet should not expose generated ORDER BY columns to&lt;br/&gt;
its parent.&lt;/p&gt;

</comment>
                            <comment id="13706249" author="jira-bot" created="Thu, 11 Jul 2013 22:24:29 +0100"  >&lt;p&gt;Commit 1502371 from mikem@apache.org&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1502371&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1502371&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6006&quot; title=&quot;NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6006&quot;&gt;&lt;del&gt;DERBY-6006&lt;/del&gt;&lt;/a&gt;: NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY&lt;/p&gt;

&lt;p&gt;backporting change #1417991 by kahatlen from 10.10 to 10.9 branch.&lt;/p&gt;

&lt;p&gt;A NormalizeResultSet should not expose generated ORDER BY columns to&lt;br/&gt;
its parent.&lt;/p&gt;</comment>
                            <comment id="13707474" author="jira-bot" created="Fri, 12 Jul 2013 23:33:04 +0100"  >&lt;p&gt;Commit 1502717 from mikem@apache.org&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1502717&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1502717&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6006&quot; title=&quot;NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6006&quot;&gt;&lt;del&gt;DERBY-6006&lt;/del&gt;&lt;/a&gt;: NullPointerException in INSERT INTO ... SELECT FROM ... ORDER BY&lt;/p&gt;

&lt;p&gt;backporting change #1417991 by kahatlen from 10.10 to 10.8 branch.&lt;/p&gt;

&lt;p&gt;A NormalizeResultSet should not expose generated ORDER BY columns to&lt;br/&gt;
its parent.&lt;/p&gt;</comment>
                            <comment id="13707479" author="mikem" created="Fri, 12 Jul 2013 23:36:09 +0100"  >&lt;p&gt;backported to 10.9 and 10.8.  Could be backported more, but don&apos;t plan on it for now.  setting original owner back.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12437331">DERBY-4397</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12555948" name="d6006-1a-remove-extra-columns.diff" size="2688" author="knutanders" created="Tue, 4 Dec 2012 16:07:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 Dec 2012 15:13:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293396</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hymu27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>167225</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>