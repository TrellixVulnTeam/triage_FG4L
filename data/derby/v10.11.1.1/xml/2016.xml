<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:19 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2016/DERBY-2016.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2016] ArrayIndexOutOfBoundsException for COALESCE with aggregate functions</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2016</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following statements produce an ArrayIndexOutOfBoundsException:&lt;/p&gt;

&lt;p&gt;CREATE TABLE t1 (&lt;br/&gt;
   f1 INTEGER);&lt;/p&gt;

&lt;p&gt;SELECT COALESCE(MAX(f1),0) FROM t1;&lt;/p&gt;

&lt;p&gt;Workaround:&lt;br/&gt;
   VALUES COALESCE( (SELECT MAX(f1) FROM t1), 0);&lt;/p&gt;

&lt;p&gt;Stack trace:&lt;br/&gt;
----------------------------------------------------------------&lt;br/&gt;
2006-10-29 14:52:53.765 GMT:&lt;br/&gt;
 Booting Derby version The Apache Software Foundation - Apache Derby - 10.2.1.6 - (452058): instance c013800d-010e-948f-0faa-00000012f418&lt;br/&gt;
on database directory C:\temp_sys\temp_Derby_TestErr_db&lt;/p&gt;

&lt;p&gt;Database Class Loader started - derby.database.classpath=&apos;&apos;&lt;br/&gt;
2006-10-29 14:53:02.906 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 122), (SESSIONID = 0), (DATABASE = c:\temp_sys\temp_Derby_TestErr_db), (DRDAID = null), Cleanup action starting&lt;br/&gt;
2006-10-29 14:53:02.906 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 122), (SESSIONID = 0), (DATABASE = c:\temp_sys\temp_Derby_TestErr_db), (DRDAID = null), Failed Statement is: SELECT COALESCE(MAX(f1),0) FROM t1&lt;br/&gt;
java.lang.ArrayIndexOutOfBoundsException: -1&lt;br/&gt;
        at org.apache.derby.impl.services.bytecode.BCMethod.popStack(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.bytecode.BCMethod.callMethod(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ResultColumnList.generateCore(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ScrollInsensitiveResultSetNode.generate(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.CursorNode.generate(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.StatementNode.generate(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepare(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main14.main(Unknown Source)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(Unknown Source)&lt;/p&gt;</description>
                <environment>1.5.0_06-b05</environment>
        <key id="12354223">DERBY-2016</key>
            <summary>ArrayIndexOutOfBoundsException for COALESCE with aggregate functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="chdh@inventec.ch">Christian d&apos;Heureuse</reporter>
                        <labels>
                    </labels>
                <created>Sun, 29 Oct 2006 14:57:09 +0000</created>
                <updated>Mon, 5 May 2008 16:07:07 +0100</updated>
                            <resolved>Thu, 22 Nov 2007 00:53:01 +0000</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12452440" author="julo" created="Fri, 24 Nov 2006 12:45:52 +0000"  >&lt;p&gt;When I ran this example using &apos;insane&apos; I go this error:&lt;/p&gt;

&lt;p&gt;ERROR XJ001: Java exception: &apos;ASSERT FAILED generateExpression() should never be called on an AggregateNode.  replaceAggregatesWithColumnReferences should have been called prior to generateExpression: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;/p&gt;</comment>
                            <comment id="12452589" author="mkhettry" created="Sat, 25 Nov 2006 16:46:22 +0000"  >&lt;p&gt;The visit method is used to traverse the parse tree and in this case, replace aggregates with ColumnReferences. See ReplaceAggregatesWIthCRVisitior. CoalesceFunctionNode does seem to have a visit method but there is also a cached ValueNode in this class (firstNonParameterNode) which is not visited which causes this assert failure.&lt;/p&gt;</comment>
                            <comment id="12534916" author="kmarsden" created="Mon, 15 Oct 2007 18:55:33 +0100"  >&lt;p&gt;Julius, are you actively working on this issue? Please unassign yourself if you are not.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12535054" author="julo" created="Tue, 16 Oct 2007 05:25:12 +0100"  >&lt;p&gt;I moved my attention away and wanted to return back after some time. I am unassigning the issue from myself to leave it for others who  may want to work on that.&lt;/p&gt;</comment>
                            <comment id="12543229" author="dagw" created="Fri, 16 Nov 2007 23:14:59 +0000"  >&lt;p&gt;This is a patch which makes the repro work. It is for review only at&lt;br/&gt;
this point.&lt;/p&gt;

&lt;p&gt;Manish&apos;s analysis seems correct to me, and my patch builds on that&lt;br/&gt;
observation; I simply let the visitor visit firstNonParameterNode also&lt;br/&gt;
(which holds the aggregate function). &lt;/p&gt;

&lt;p&gt;Btw, the dumping of the query tree omits to show&lt;br/&gt;
firstNonParameterNode, but I added it temporarily and was able to see&lt;br/&gt;
that the rewriting had happened after optimization.&lt;/p&gt;

&lt;p&gt;I also added a new test to CoalesceTest. &lt;/p&gt;

&lt;p&gt;Running regression tests now.&lt;/p&gt;</comment>
                            <comment id="12543557" author="dagw" created="Mon, 19 Nov 2007 13:30:00 +0000"  >&lt;p&gt;All regression tests passed.&lt;/p&gt;</comment>
                            <comment id="12543560" author="dagw" created="Mon, 19 Nov 2007 13:38:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2016&quot; title=&quot;ArrayIndexOutOfBoundsException for COALESCE with aggregate functions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2016&quot;&gt;&lt;del&gt;DERBY-2016&lt;/del&gt;&lt;/a&gt;b supercedes the first patch. I decided to let the code for dumping &lt;br/&gt;
firstNonParameterNode permanent.&lt;/p&gt;</comment>
                            <comment id="12543883" author="knutanders" created="Tue, 20 Nov 2007 12:51:35 +0000"  >&lt;p&gt;Don&apos;t you call accept() twice on firstNonParameterNode now? I don&apos;t think the node is ever removed from argumentsList, so you only need to update the reference, I think. Perhaps it would be better to remove the firstNonParameterNode field and instead just store its index?&lt;/p&gt;</comment>
                            <comment id="12544142" author="dagw" created="Wed, 21 Nov 2007 02:10:47 +0000"  >&lt;p&gt;You may be correct that this will be equivalent. I will investigate; it would&lt;br/&gt;
simplify things a bit. That would yield only one copy (since the one in argumentlist is replaced)&lt;br/&gt;
so I was vary of changing the semantics; the generateExpression call would then &lt;br/&gt;
operate on an object still in argumentList, rather than on another tree, but that may be ok.&lt;/p&gt;</comment>
                            <comment id="12544151" author="dagw" created="Wed, 21 Nov 2007 03:16:02 +0000"  >&lt;p&gt;Preliminary testing indicates that the index approach works also.&lt;br/&gt;
So firstNonParameterNode was likely only ever meant to be an alias, but&lt;br/&gt;
unfortunately turned out not to be so in this issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Uploading patch &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2016&quot; title=&quot;ArrayIndexOutOfBoundsException for COALESCE with aggregate functions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2016&quot;&gt;&lt;del&gt;DERBY-2016&lt;/del&gt;&lt;/a&gt;c. Running regression tests.&lt;/p&gt;
</comment>
                            <comment id="12544423" author="knutanders" created="Wed, 21 Nov 2007 11:19:35 +0000"  >&lt;p&gt;Patch c looks good! Nits: Couldn&apos;t firstNonParameterNodeIdx be private? And perhaps you could add /** ... */ around the fine comment you wrote so that it turns up in the generated javadoc.&lt;/p&gt;

&lt;p&gt;By the way, would it be better to initialize firstNonParameterNodeIdx with an invalid index value (like -1) instead of 0? Not a big deal, since it must be an internal bug if we don&apos;t find a non-parameter node in the list. But the old code would cause a NullPointerException if it was not found, whereas the new code will silently ignore it. (Ideally, I guess we should have had a findFirstNonParameterNode() method in ValueNodeList instead of storing it in a field. It&apos;s only used once anyway, isn&apos;t it?)&lt;/p&gt;

&lt;p&gt;Regardless of what you choose to do with the above comments, I&apos;m +1 to committing patch c, as it&apos;s definitely an improvement.&lt;/p&gt;</comment>
                            <comment id="12544499" author="dagw" created="Wed, 21 Nov 2007 15:27:34 +0000"  >&lt;p&gt;All good ideas, thanks! Uploading &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2016&quot; title=&quot;ArrayIndexOutOfBoundsException for COALESCE with aggregate functions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2016&quot;&gt;&lt;del&gt;DERBY-2016&lt;/del&gt;&lt;/a&gt;d.&lt;br/&gt;
This patch also adds another test case to CoalesceTest&lt;br/&gt;
using two aggregates in a three argument coalesce. &lt;/p&gt;</comment>
                            <comment id="12544663" author="dagw" created="Thu, 22 Nov 2007 00:53:01 +0000"  >&lt;p&gt;All tests passed, committed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2016&quot; title=&quot;ArrayIndexOutOfBoundsException for COALESCE with aggregate functions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2016&quot;&gt;&lt;del&gt;DERBY-2016&lt;/del&gt;&lt;/a&gt;d as svn 597278.&lt;br/&gt;
Resolving. &lt;br/&gt;
Will merge to 10.3 in a day or two.&lt;/p&gt;</comment>
                            <comment id="12545299" author="dagw" created="Sun, 25 Nov 2007 21:10:46 +0000"  >&lt;p&gt;Merged &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2016&quot; title=&quot;ArrayIndexOutOfBoundsException for COALESCE with aggregate functions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2016&quot;&gt;&lt;del&gt;DERBY-2016&lt;/del&gt;&lt;/a&gt;d to 10.3 as svn 598054. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12369701" name="DERBY-2016.diff" size="3238" author="dagw" created="Fri, 16 Nov 2007 23:14:58 +0000"/>
                            <attachment id="12369702" name="DERBY-2016.stat" size="166" author="dagw" created="Fri, 16 Nov 2007 23:14:59 +0000"/>
                            <attachment id="12369784" name="DERBY-2016b.diff" size="3231" author="dagw" created="Mon, 19 Nov 2007 13:38:14 +0000"/>
                            <attachment id="12369785" name="DERBY-2016b.stat" size="166" author="dagw" created="Mon, 19 Nov 2007 13:38:14 +0000"/>
                            <attachment id="12369945" name="DERBY-2016c.diff" size="4604" author="dagw" created="Wed, 21 Nov 2007 03:16:02 +0000"/>
                            <attachment id="12369946" name="DERBY-2016c.stat" size="166" author="dagw" created="Wed, 21 Nov 2007 03:16:02 +0000"/>
                            <attachment id="12369984" name="DERBY-2016d.diff" size="4725" author="dagw" created="Wed, 21 Nov 2007 15:27:33 +0000"/>
                            <attachment id="12369985" name="DERBY-2016d.stat" size="166" author="dagw" created="Wed, 21 Nov 2007 15:27:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 24 Nov 2006 12:45:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22838</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0yv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39466</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>