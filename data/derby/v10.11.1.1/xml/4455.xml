<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:31:51 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4455/DERBY-4455.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4455] Prepared statement failure with CLOB: Stream has already been read and end-of-file reached and cannot be re-used.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4455</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Possibly related to #4332?&lt;/p&gt;

&lt;p&gt;We have encountered an error when using Prepared Statements and CLOBs.  I have read:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://db.apache.org/derby/papers/JDBCImplementation.html#setAsciiStream%2CsetBinaryStream%2CsetCharacterStream&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/papers/JDBCImplementation.html#setAsciiStream%2CsetBinaryStream%2CsetCharacterStream&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But it does not seem applicable, as we are not re-using a stream.&lt;/p&gt;

&lt;p&gt;The environment is this:&lt;/p&gt;

&lt;p&gt;1. Java 6&lt;br/&gt;
2. Derby 10.5.3.0&lt;br/&gt;
3. Bitronix JTA 1.3.3&lt;/p&gt;

&lt;p&gt;We&apos;re actually using Hibernate, but I eliminated it from the equation (and the problem persists).&lt;/p&gt;

&lt;p&gt;A summary of the failure flow is this:&lt;/p&gt;

&lt;p&gt;1. Start a transaction&lt;br/&gt;
2. Obtain a connection from a pool of connections (for this test, the pool size is pinned at 1)&lt;br/&gt;
3. Prepare a statement that inserts a CLOB.&lt;br/&gt;
4. Set the parameters&lt;br/&gt;
5. Add the prepared statement to a batch (but we only batch 1 &amp;#8211; this is to emulate what hibernate is doing as closely as possible).&lt;br/&gt;
6. Execute the batch.&lt;/p&gt;

&lt;p&gt;Everything up to this point works.&lt;/p&gt;

&lt;p&gt;7. Repeat steps 1-6.  But this time, the connection will be reused from the pool, and the statement will be gotten from a prepared statement cache (maintained by bitronix).  I.e. the prepared statement is re-used.&lt;br/&gt;
8. Observe the following failure:&lt;/p&gt;

&lt;p&gt;org.apache.derby.client.am.BatchUpdateException: Non-atomic batch failure.  The batch was submitted, but at least one exception occurred on an individual member of the batch. Use getNextException() to retrieve the exceptions for specific batched elements.&lt;br/&gt;
	at org.apache.derby.client.am.Agent.endBatchedReadChain(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeBatchRequestX(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeBatchX(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeBatch(Unknown Source)&lt;br/&gt;
	at bitronix.tm.resource.jdbc.JdbcPreparedStatementHandle.executeBatch(JdbcPreparedStatementHandle.java:248)&lt;br/&gt;
	at org.dancernetworks.TestFailure.doInsert(TestFailure.java:134)&lt;br/&gt;
	at org.dancernetworks.TestFailure.doPrepared(TestFailure.java:110)&lt;br/&gt;
	at org.dancernetworks.TestFailure.main(TestFailure.java:55)&lt;br/&gt;
Nov 30, 2009 10:29:31 PM bitronix.tm.BitronixTransactionManager shutdown&lt;br/&gt;
INFO: shutting down Bitronix Transaction Manager&lt;br/&gt;
An IOException was thrown when reading a &apos;java.sql.String&apos; from an InputStream.&lt;br/&gt;
java.sql.SQLException: An IOException was thrown when reading a &apos;java.sql.String&apos; from an InputStream.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.seeNextException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.noStateChangeException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.transferParameters(Unknown Source)&lt;br/&gt;
	at org.apache.derby.jdbc.XAStatementControl.getRealPreparedStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.getPreparedStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.getStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.jdbc.BrokeredStatement.close(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAStatement.close(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.Database.close(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.Session.close(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.closeSession(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;br/&gt;
Caused by: java.sql.SQLException: An IOException was thrown when reading a &apos;java.sql.String&apos; from an InputStream.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)&lt;br/&gt;
	... 15 more&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;Stream has already been read and end-of-file reached and cannot be re-used.: java.io.EOFException&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	... 12 more&lt;br/&gt;
Caused by: java.io.EOFException: Stream has already been read and end-of-file reached and cannot be re-used.&lt;br/&gt;
	at org.apache.derby.iapi.types.ReaderToUTF8Stream.read(Unknown Source)&lt;br/&gt;
	at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:320)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.readExternal(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.getString(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.setFrom(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.DataType.setValue(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericParameterValueSet.transferDataValues(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BaseActivation.setParameters(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericActivationHolder.setParameters(Unknown Source)&lt;br/&gt;
	... 10 more&lt;/p&gt;

&lt;p&gt;Attached is an archived Eclipse project of a self-contained reproduction.  It includes everything needed to run, including the Bitronix 1.3.3 jar.&lt;/p&gt;</description>
                <environment>Mac OS X 10.6.2, Java 6, Bitronix JTA</environment>
        <key id="12441958">DERBY-4455</key>
            <summary>Prepared statement failure with CLOB: Stream has already been read and end-of-file reached and cannot be re-used.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="brettw">Brett Wooldridge</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Nov 2009 13:53:49 +0000</created>
                <updated>Wed, 2 Jun 2010 18:13:48 +0100</updated>
                            <resolved>Tue, 26 Jan 2010 07:10:41 +0000</resolved>
                                    <version>10.5.3.0</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12783663" author="brettw" created="Mon, 30 Nov 2009 14:01:06 +0000"  >&lt;p&gt;Zipped eclipse java project with failure reproduction.&lt;/p&gt;</comment>
                            <comment id="12783725" author="kristwaa" created="Mon, 30 Nov 2009 16:19:20 +0000"  >&lt;p&gt;Patch 1a is one way of fixing the problem.&lt;br/&gt;
You still can&apos;t reuse streams, but this should address the issue you&apos;re seeing in the repro.&lt;br/&gt;
I haven&apos;t verified if this happens only in XA environments, or if some kind of reuse / pooling is enough to trigger the bug.&lt;/p&gt;

&lt;p&gt;I&apos;ve started the regression test suite, I&apos;ll post the results tomorrow.&lt;/p&gt;</comment>
                            <comment id="12783727" author="kristwaa" created="Mon, 30 Nov 2009 16:22:13 +0000"  >&lt;p&gt;Patch available for testing / review.&lt;/p&gt;</comment>
                            <comment id="12783854" author="knutanders" created="Mon, 30 Nov 2009 21:46:10 +0000"  >&lt;p&gt;Kristian, could you add some details about what&apos;s causing the bug? I didn&apos;t quite get that by reading the comments and the patch.&lt;/p&gt;

&lt;p&gt;The server-side stack trace appears to happen when the session is being closed. Do we really need to read the parameter values in order to close the statement?&lt;/p&gt;</comment>
                            <comment id="12783993" author="brettw" created="Tue, 1 Dec 2009 01:37:27 +0000"  >&lt;p&gt;Kristian, the patch works for me.  I don&apos;t particularly care about re-using streams.  Because we just found this issue when we enabled the PreparedStatement cache, I&apos;ll let it run for a day or two to see if any other issues are uncovered.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12784159" author="kristwaa" created="Tue, 1 Dec 2009 10:34:51 +0000"  >&lt;p&gt;Uploading a revised patch 1b, with some changed comments and some trivial changes to the code. It should be functionally equal to patch 1a.&lt;/p&gt;

&lt;p&gt;Knut&amp;gt; The server-side stack trace appears to happen when the session is being closed.&lt;/p&gt;

&lt;p&gt;Yes, it appears to, but I don&apos;t think it is any more. Printing a stack trace at GenericParameterValueSet.transferDataValue gives me:&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericParameterValueSet.transferDataValues(GenericParameterValueSet.java:249)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.BaseActivation.setParameters(BaseActivation.java:1300)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericActivationHolder.setParameters(GenericActivationHolder.java:246)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.transferParameters(EmbedPreparedStatement.java:1662)&lt;br/&gt;
        at org.apache.derby.jdbc.XAStatementControl.getRealPreparedStatement(XAStatementControl.java:169)&lt;br/&gt;
        at org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.getPreparedStatement(BrokeredPreparedStatement.java:531)&lt;br/&gt;
        at org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.setInt(BrokeredPreparedStatement.java:160)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.readAndSetParams(DRDAConnThread.java:4578)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA_work(DRDAConnThread.java:4507)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA(DRDAConnThread.java:4379)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:4254)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:4084)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:1003)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:290)&lt;/p&gt;

&lt;p&gt;Further investigation points to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4310&quot; title=&quot;Closing a prepared statement with an embedded   XAConnection can cause the statement to be reprepared and errors related to missing dependencies. This can interfere with network server closeSession()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4310&quot;&gt;&lt;del&gt;DERBY-4310&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4155&quot; title=&quot;jdbcapi/XATest.java  doesn&amp;#39;t seem to be running anywhere&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4155&quot;&gt;&lt;del&gt;DERBY-4155&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4334&quot; title=&quot;Invoking certain methods on PreparedStatements after the underlying connection changed forces repreparing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4334&quot;&gt;DERBY-4334&lt;/a&gt;, where a commit for the former two changed the code closing a statement. The stack trace you refer to must be from an earlier release. As a side note, I&apos;m not seeing the exception printed to derby.log, even with derby.error.stream.logSeverityLevel=0.&lt;br/&gt;
My understanding of XA isn&apos;t as good as it should have been, but running the repro with the embedded driver (using EmbeddedXADataSource) doesn&apos;t trigger the bug. My question then is whether the &quot;connection switching&quot; behavior (see XAStatementControl.getRealPreparedStatement) seen with the client driver is a necessity or if the implementation is suboptimal.&lt;br/&gt;
Out of curiosity I also enabled the Derby client side JDBC statement cache for XA (requires some code changes) and disabled the one in Bitronix. I observed the same behavior, including the bug.&lt;/p&gt;

&lt;p&gt;As for the issue addressed by the patch, what happens is that Derby detects that the application connection has changed when it is about to execute the prepared statement. It then has to create a new prepared statement on the current connection. After preparing a new statement, it transfers the arguments that were set on the old statement to the new one. This was done in a way that would materialize values represented as a stream. In this specific case, the stream had already been drained and an EOFException was thrown when trying to read it again.&lt;/p&gt;

&lt;p&gt;I believe the same bug can be triggered by using only the embedded driver, but it requires a different repro (switching between global and local XA transactions or something?).&lt;/p&gt;

&lt;p&gt;Finally, the regression test run with patch 1a was clean.&lt;/p&gt;</comment>
                            <comment id="12784180" author="brettw" created="Tue, 1 Dec 2009 11:17:55 +0000"  >&lt;p&gt;Kristian, if I could, I&apos;d like to ask a few questions about your comments.  You said, &quot; what happens is that Derby detects that the application connection has changed when it is about to execute the prepared statement&quot;, what exactly changed from Derby&apos;s perspective?  Then you said, &quot;After preparing a new statement, it transfers the arguments that were set on the old statement to the new one&quot;  Does this involve a &quot;real&quot; preparation of a statement?  And therefore does this behavior defeat the purpose of a PreparedStatement cache (either external or internal)?&lt;/p&gt;

&lt;p&gt;With respect to the first question, is the &quot;change&quot; in the application connection that is detected by Derby a result of XA management?  Given that the statement cache is per-connection, and that the connection is re-used (in this case), why does Derby require a &quot;re-prepare&quot; and copy of arguments?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12784214" author="kristwaa" created="Tue, 1 Dec 2009 13:02:07 +0000"  >&lt;p&gt;Hi Brett,&lt;/p&gt;

&lt;p&gt;Answering your questions requires some more investigation, and I don&apos;t have the cycles right now. I&apos;ll try to get back to them later.&lt;/p&gt;

&lt;p&gt;I can give some information right away though.&lt;br/&gt;
Brett&amp;gt; ... &lt;span class=&quot;error&quot;&gt;&amp;#91;a&amp;#93;&lt;/span&gt; Does this involve a &quot;real&quot; preparation of a statement? &lt;span class=&quot;error&quot;&gt;&amp;#91;b&amp;#93;&lt;/span&gt; And therefore does this behavior defeat the purpose of a PreparedStatement cache (either external or internal)? &lt;br/&gt;
a) In a way it does on the server side, yes. However, the server has a statement cache of its own, across connections.&lt;br/&gt;
b) Depends on what you mean. It helps a lot when using the client driver, because you don&apos;t have to go across the network as much. My experience comes from using a ClientConnectionPoolDataSource with the internal cache. I don&apos;t know how the internal cache compares to an external cache in terms of performance.&lt;br/&gt;
   On the server side, you still benefit from the cache (on the client side), because the &quot;connection change&quot; I mentioned doesn&apos;t happen for every operation (I&apos;ll need to investigate to figure out what causes this perceived change of state). If the server has to re-prepare the statement all the time, it will put unnecessary strain on the server side statement cache - and it may become a bottleneck. I don&apos;t remember having seen this as a problem earlier, but then I haven&apos;t been running benchmarks in an XA environment. We now also have session state piggy-backing (schema name and isolation level), which was required to implement the client side JDBC prepared statement cache.&lt;/p&gt;

&lt;p&gt;Brett&amp;gt; ... Given that the statement cache is per-connection, and that the connection is re-used (in this case), why does Derby require a &quot;re-prepare&quot; and copy of arguments?&lt;br/&gt;
I can&apos;t answer this properly, but my theory is that the embedded connection on the server side changes. Again, I&apos;ll have to confirm this, and figure out why it happens if the theory is correct. There might be an XA specific reason for this, some kind of mismatch between the client and embedded connection, or perhaps due to a side-effect of some internal mechanism.&lt;/p&gt;


&lt;p&gt;Two questions for you:&lt;br/&gt;
 1) Have you explicitly turned on connection validation using VALUES 1, or is this something Bitronix does by default?&lt;br/&gt;
 2) Are you having performance issues with your application?&lt;/p&gt;

&lt;p&gt;And thanks for providing the runnable repro and for taking the patch for a spin.&lt;/p&gt;</comment>
                            <comment id="12784221" author="brettw" created="Tue, 1 Dec 2009 13:16:53 +0000"  >&lt;p&gt;Q1) Have you explicitly turned on connection validation using VALUES 1, or is this something Bitronix does by default? &lt;br/&gt;
I set the test query in the config, but I think it was recommended by bitronix (or some other connection pool doc).&lt;/p&gt;

&lt;p&gt;Q2) Are you having performance issues with your application? &lt;br/&gt;
Not particularly, just trying to optimize things a bit.  SQL was showing up high during some profiling sessions.  But the SQL can&apos;t particularly be optimized &amp;#8211; it&apos;s just straight inserts.  Now batched.  In the past, my experience with MySQL and SQL Server was that re-using prepared statements made a huge difference &amp;#8211; like 10-20x in some cases.  I actually wrote the prepared statement cache in the jTDS (open source SQL Server) driver as a result of work at that job (probably 5 years ago now).&lt;/p&gt;

&lt;p&gt;No worries on runnable repro, I know it can cut the diagnostic time significantly.&lt;/p&gt;</comment>
                            <comment id="12790725" author="brettw" created="Tue, 15 Dec 2009 12:38:53 +0000"  >&lt;p&gt;I consider this bug fixed by the provided patch.  Therefore you are free to close the issue.&lt;/p&gt;

&lt;p&gt;However, if there is indeed &lt;b&gt;unnecessary&lt;/b&gt; server-side &quot;re-preparation&quot; of the statements (see org.apache.derby.impl.jdbc.EmbedPreparedStatement.transferParameters in the stack trace) in the case of XA connections, I would like a separate issue to be opened.  Other than that efficiency concern, the actual defect appears to be fixed by the patch and I have not encountered this exception since applying the patch.&lt;/p&gt;

&lt;p&gt;I would like to see this fix integrated into the next release because I prefer not to run non-released versions of jars.&lt;/p&gt;</comment>
                            <comment id="12790739" author="knutanders" created="Tue, 15 Dec 2009 13:28:48 +0000"  >&lt;p&gt;One comment to the patch:&lt;/p&gt;

&lt;p&gt;+                    // NOTE: The length is ignored (use a non-sense value, it&lt;br/&gt;
+                    //       hopefully fails if required in the future).&lt;br/&gt;
+                    pvstarget.getParameterForSet&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.setValue(is, -3);&lt;/p&gt;

&lt;p&gt;The length is only ignored by SQLChar.setValue() (and, by inheritance, SQLClob). SQLBinary.setValue() uses the length argument, as far as I can see. It may be more robust to create a new setValue() method with no length argument and with well-defined behaviour.&lt;/p&gt;</comment>
                            <comment id="12790759" author="kristwaa" created="Tue, 15 Dec 2009 14:36:18 +0000"  >&lt;p&gt;Knut Anders&amp;gt; ... It may be more robust to create a new setValue() method with no length argument and with well-defined behaviour. &lt;/p&gt;

&lt;p&gt;I agree adding another value would be more robust.&lt;br/&gt;
Looking at the existing code, it seems -1 is already used to indicate that the length is unknown. I found a total of 7 uses of the existing method, so it isn&apos;t heavily used.&lt;br/&gt;
Would it make sense to improve the documentation of the existing method (in DataValueDescriptor) and verifying the current use, instead of adding yet another method?&lt;/p&gt;

&lt;p&gt;After agreeing on this issue, I plan to commit the patch to trunk and backport it to the 10.5 branch. I might also merge it with 10.4 if it merges cleanly.&lt;br/&gt;
I think it is an incremental improvement, and it would be nice to follow up on the XA behavior later.&lt;/p&gt;</comment>
                            <comment id="12790786" author="knutanders" created="Tue, 15 Dec 2009 16:03:59 +0000"  >&lt;p&gt;Sounds reasonable, although I don&apos;t quite understand how the length argument is used. Could this somehow make the length parameter passed to one of the top-level JDBC streaming methods getting lost?&lt;/p&gt;</comment>
                            <comment id="12800701" author="kristwaa" created="Fri, 15 Jan 2010 13:49:36 +0000"  >&lt;p&gt;I logged &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4515&quot; title=&quot;Document and clarify the use of DataValueDescriptor.setValue(InputStream,int)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4515&quot;&gt;&lt;del&gt;DERBY-4515&lt;/del&gt;&lt;/a&gt; to clarify the usage of the length argument (a patch is awaiting review).&lt;br/&gt;
Regarding your concern about the top-level JDBC length parameter(s) getting lost, I think setValue(InputStream,int) is a way we can pass the information on. This is currently done for binary types, but not for the character types. In the latter case, there is another mechanism (CharacterStreamDescriptor) used to achieve the same effect - at least for Clobs where it may really matter.&lt;/p&gt;

&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4515&quot; title=&quot;Document and clarify the use of DataValueDescriptor.setValue(InputStream,int)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4515&quot;&gt;&lt;del&gt;DERBY-4515&lt;/del&gt;&lt;/a&gt; has been resolved, a small change has to be made to the patch attached this issue. I will then commit it and backport it to 10.5.&lt;/p&gt;</comment>
                            <comment id="12803350" author="kristwaa" created="Thu, 21 Jan 2010 16:29:57 +0000"  >&lt;p&gt;Attached patch 1c, adjusted to use the newly introduced constant DataValueDescriptor.UNKNOWN_LOGICAL_LENGTH when calling DVD.setStream.&lt;/p&gt;

&lt;p&gt;Committed 1c to trunk with revision 901760 and back-ported to the 10.5 branch with revision 901761.&lt;br/&gt;
I will mark this issue as resolved when the automated tests pass.&lt;/p&gt;</comment>
                            <comment id="12804921" author="kristwaa" created="Tue, 26 Jan 2010 07:10:41 +0000"  >&lt;p&gt;No problems reported by the nightly test runs.&lt;br/&gt;
Resolving issue.&lt;/p&gt;

&lt;p&gt;Brett, feel free to close this issue if you think it has been addressed.&lt;/p&gt;</comment>
                            <comment id="12805341" author="brettw" created="Wed, 27 Jan 2010 03:35:45 +0000"  >&lt;p&gt;Closed, fixed.&lt;/p&gt;</comment>
                            <comment id="12872311" author="kmarsden" created="Thu, 27 May 2010 19:10:41 +0100"  >&lt;p&gt;Was this issue a regression?  I am working with a user that is seeing something similar after upgrading to 10.5 from 10.3, but they don&apos;t have this fix yet.  I am hoping giving them the patch will fix their problem as it sounds so similar,  but don&apos;t actually see this marked as a regression from 10.3&lt;/p&gt;
</comment>
                            <comment id="12872324" author="kristwaa" created="Thu, 27 May 2010 19:54:48 +0100"  >&lt;p&gt;I don&apos;t know if this issue was a regression.&lt;/p&gt;

&lt;p&gt;I don&apos;t have the cycles right now, but finding out should be simple enough (fingers crossed...):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;download and unpack the repro&lt;/li&gt;
	&lt;li&gt;replace the Derby jars with older versions&lt;br/&gt;
(- delete existing database?)&lt;/li&gt;
	&lt;li&gt;run the repro&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The details are a bit murky for me, but I think running the repro is pretty simple.&lt;/p&gt;</comment>
                            <comment id="12872345" author="kmarsden" created="Thu, 27 May 2010 20:59:00 +0100"  >&lt;p&gt;Thanks Kristian for responding so quickly.  I will check it out and mark the box accordingly.  just wanted to check and see anyone knew off hand.&lt;/p&gt;
</comment>
                            <comment id="12874150" author="kmarsden" created="Tue, 1 Jun 2010 19:52:46 +0100"  >&lt;p&gt;I wanted to report that this was indeed the fix needed for the user that reported a regression from 10.3.  Thanks Kristian and Brett!&lt;/p&gt;

&lt;p&gt;I am trying to make a stand-alone reproduction/regression test to check in but am having some trouble popping the bug with 10.5.3.0 - (802917), before the fix. Attached is my ReproAttemptDerby4455.java.  &lt;/p&gt;

&lt;p&gt;I&apos;ll keep working on it. It would be good to have a regression test for this issue.&lt;/p&gt;</comment>
                            <comment id="12874671" author="kmarsden" created="Wed, 2 Jun 2010 18:13:48 +0100"  >&lt;p&gt;Marking as a regression as it was reported on upgrade to 10.5 from 10.3 with the same application.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12445630">DERBY-4515</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12426408" name="DerbyFailure.zip" size="3397697" author="brettw" created="Mon, 30 Nov 2009 14:01:06 +0000"/>
                            <attachment id="12446041" name="ReproAttemptDerby4455.java" size="2216" author="kmarsden" created="Tue, 1 Jun 2010 19:52:46 +0100"/>
                            <attachment id="12426420" name="derby-4455-1a.diff" size="2678" author="kristwaa" created="Mon, 30 Nov 2009 16:19:20 +0000"/>
                            <attachment id="12426521" name="derby-4455-1b.diff" size="2834" author="kristwaa" created="Tue, 1 Dec 2009 10:34:51 +0000"/>
                            <attachment id="12431037" name="derby-4455-1c.diff" size="2749" author="kristwaa" created="Thu, 21 Jan 2010 16:29:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 30 Nov 2009 16:19:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24267</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0q3r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38047</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>