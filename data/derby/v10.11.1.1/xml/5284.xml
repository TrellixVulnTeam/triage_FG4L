<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:17:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5284/DERBY-5284.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5284] A derby crash at exactly right time during a btree split can cause a corrupt db which can not be booted.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5284</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A derby crash at exactly wrong time during a btree split can cause a corrupt db which can not be booted.&lt;/p&gt;

&lt;p&gt;A problem in the split code and exact wrong timing of a crash can leave the database in as state &lt;br/&gt;
where undo of purge operations corrupts index pages during redo and can cause recovery boot&lt;br/&gt;
to never succeed and thus the database never to be booted.  At hight level what happens is that&lt;br/&gt;
a purge happens on a page and before it commits another transactions uses the space of the&lt;br/&gt;
purge to do an insert and then commits, then the system crashes before the purging transactions&lt;br/&gt;
gets a chance to commit.  During undo the purge expects there to be space to undo the purge&lt;br/&gt;
but there is not, and it corrupts the page in various ways depending on the size and placement&lt;br/&gt;
of the inserts.  The error that actually returns to user varies from sane to insane as the problem&lt;br/&gt;
is actually noticed after the corruption occurs rather than during the undo.&lt;/p&gt;




</description>
                <environment></environment>
        <key id="12510769">DERBY-5284</key>
            <summary>A derby crash at exactly right time during a btree split can cause a corrupt db which can not be booted.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikem">Mike Matrigali</assignee>
                                    <reporter username="mikem">Mike Matrigali</reporter>
                        <labels>
                    </labels>
                <created>Sat, 18 Jun 2011 18:18:19 +0100</created>
                <updated>Mon, 17 Jun 2013 10:19:46 +0100</updated>
                            <resolved>Thu, 30 Jun 2011 00:01:22 +0100</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                                    <fixVersion>10.1.3.3</fixVersion>
                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.2.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13051562" author="mikem" created="Sat, 18 Jun 2011 18:21:06 +0100"  >&lt;p&gt;I found this problem by code inspection and have not reproduced it myself.  This problem is another&lt;br/&gt;
code path of the same problem fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5258&quot; title=&quot;btree post commit releases latch before committing/aborting purges, possibly allowing other operation on page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5258&quot;&gt;&lt;del&gt;DERBY-5258&lt;/del&gt;&lt;/a&gt;.  I believe that either &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5258&quot; title=&quot;btree post commit releases latch before committing/aborting purges, possibly allowing other operation on page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5258&quot;&gt;&lt;del&gt;DERBY-5258&lt;/del&gt;&lt;/a&gt; or this&lt;br/&gt;
issue are causing the problems that have been reported as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5281&quot; title=&quot;Derby DB Corrupt After Crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5281&quot;&gt;&lt;del&gt;DERBY-5281&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5248&quot; title=&quot;Java Process Crash Causes Corrupt DB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5248&quot;&gt;&lt;del&gt;DERBY-5248&lt;/del&gt;&lt;/a&gt;.  See&lt;br/&gt;
those 2 issues for detailed description of order of log records and crash timing necessary to &lt;br/&gt;
reproduce this problem.&lt;/p&gt;

&lt;p&gt;At high abstract level the current code does:&lt;/p&gt;

&lt;p&gt;get latch&lt;br/&gt;
purge row&lt;br/&gt;
release latch&lt;br/&gt;
close table&lt;br/&gt;
commit&lt;/p&gt;

&lt;p&gt;If another transaction gets the latch and inserts rows between the release latch and the commit and the system crashes before &lt;br/&gt;
the commit then this problem can happen.  The fix is to not release the latch, and let commit release it.&lt;/p&gt;</comment>
                            <comment id="13051565" author="mikem" created="Sat, 18 Jun 2011 18:28:49 +0100"  >&lt;p&gt;patch for this issue.  Full set of tests on this patch against trunk passed.&lt;/p&gt;</comment>
                            <comment id="13051566" author="mikem" created="Sat, 18 Jun 2011 18:30:18 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5258&quot; title=&quot;btree post commit releases latch before committing/aborting purges, possibly allowing other operation on page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5258&quot;&gt;&lt;del&gt;DERBY-5258&lt;/del&gt;&lt;/a&gt; fixing the same kind of problem in the background cleaner code path.&lt;/p&gt;</comment>
                            <comment id="13051569" author="mikem" created="Sat, 18 Jun 2011 18:33:36 +0100"  >&lt;p&gt;This issue could cause the problem reported in either of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5281&quot; title=&quot;Derby DB Corrupt After Crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5281&quot;&gt;&lt;del&gt;DERBY-5281&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5248&quot; title=&quot;Java Process Crash Causes Corrupt DB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5248&quot;&gt;&lt;del&gt;DERBY-5248&lt;/del&gt;&lt;/a&gt;.  I can&apos;t tell for sure from the information provided.  And without a repro that I can run can&apos;t be absolutely sure this is their problem.&lt;/p&gt;</comment>
                            <comment id="13052990" author="mikem" created="Wed, 22 Jun 2011 02:47:33 +0100"  >&lt;p&gt;fixed in trunk.&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreeController.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapCompressScan.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapPostCommit.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1138275.&lt;/p&gt;</comment>
                            <comment id="13053373" author="mikem" created="Wed, 22 Jun 2011 19:21:31 +0100"  >&lt;p&gt;backported fix from trunk to 10.8 branch, clean merge.&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreeController.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapCompressScan.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapPostCommit.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1138570.&lt;/p&gt;</comment>
                            <comment id="13053565" author="mikem" created="Thu, 23 Jun 2011 01:33:52 +0100"  >&lt;p&gt;back ported to 10.7 branch.  clean merge.&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreeController.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapCompressScan.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapPostCommit.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1138701.&lt;/p&gt;</comment>
                            <comment id="13054043" author="mikem" created="Thu, 23 Jun 2011 20:13:01 +0100"  >&lt;p&gt;backported fix to 10.6 and 10.5 branch.  Both were clean merges.&lt;/p&gt;</comment>
                            <comment id="13054127" author="mikem" created="Thu, 23 Jun 2011 22:56:53 +0100"  >&lt;p&gt;backported fix from trunk to 10.4, minor conflict resolution required in merge.&lt;/p&gt;

&lt;p&gt;s104_jdk16:22&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreeController.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapCompressScan.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapPostCommit.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1139085.&lt;/p&gt;</comment>
                            <comment id="13054153" author="mikem" created="Thu, 23 Jun 2011 23:50:07 +0100"  >&lt;p&gt;backported fix from 10.4 branch to the 10.3 and 10.2 branches.  By doing the merge from 10.4 where I had done a conflict resolution I got clean merges into both 10.3 and 10.2.&lt;/p&gt;</comment>
                            <comment id="13054158" author="mikem" created="Thu, 23 Jun 2011 23:55:26 +0100"  >&lt;p&gt;merged change from 10.4 branch to 10.1 branch.&lt;/p&gt;

&lt;p&gt;s101_ibm16:9&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreeController.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\heap\HeapPostCommit.java&lt;br/&gt;
Transmitting file data ..&lt;br/&gt;
Committed revision 1139109.&lt;/p&gt;</comment>
                            <comment id="13057542" author="mikem" created="Thu, 30 Jun 2011 00:01:22 +0100"  >&lt;p&gt;Fixed and backported to all branches from 10.1 to 10.8.&lt;/p&gt;</comment>
                            <comment id="13685350" author="knutanders" created="Mon, 17 Jun 2013 10:19:46 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12509006">DERBY-5258</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12510500">DERBY-5281</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12508493">DERBY-5248</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12483055" name="DERBY-5284_diff.txt" size="5181" author="mikem" created="Sat, 18 Jun 2011 18:28:49 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 17 Jun 2013 09:19:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24758</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0esv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36216</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>