<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5313/DERBY-5313.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5313] Assert failure with CASE expression in GROUP BY clause</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5313</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I see the following assert failure with debug jars on 10.5.3.0 and later (doesn&apos;t fail on 10.5.1.1 and earlier):&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t values 1;&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select case when a=1 then 1 else 2 end&lt;br/&gt;
  from t t1(a) join t t2(b) on a=b&lt;br/&gt;
  group by case when a=1 then 1 else 2 end;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;ASSERT FAILED retVN expected to be instanceof ColumnReference, not org.apache.derby.impl.sql.compile.ConditionalNode: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12512870">DERBY-5313</key>
            <summary>Assert failure with CASE expression in GROUP BY clause</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                            <label>derby_triage10_11</label>
                            <label>derby_triage10_9</label>
                    </labels>
                <created>Tue, 5 Jul 2011 16:37:27 +0100</created>
                <updated>Mon, 6 Oct 2014 18:21:32 +0100</updated>
                            <resolved>Fri, 3 Oct 2014 16:49:20 +0100</resolved>
                                    <version>10.4.2.1</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                                    <fixVersion>10.10.2.1</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13450743" author="mamtas" created="Fri, 7 Sep 2012 17:05:45 +0100"  >&lt;p&gt;I ran the ij script on top of the trunk and saw the assert failure. I tried it in on top of 10.4 codeline which is 10.4.2.1 and saw the same failure there as well. Knut, did it not reproduce for you say on 10.4 codeline?&lt;/p&gt;

&lt;p&gt;The complete stack trace on trunk is as follows&lt;br/&gt;
ERROR XJ001: Java exception: &apos;ASSERT FAILED retVN expected to be instanceof ColumnReference, not org.apache.derby.impl.sql.compile.ConditionalNode: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;br/&gt;
java.sql.SQLException: Java exception: &apos;ASSERT FAILED retVN expected to be instanceof ColumnReference, not org.apache.derby.impl.sql.compile.ConditionalNode: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:98)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:142)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:299)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:436)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:353)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2363)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:82)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:619)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:559)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:367)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:527)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:369)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:245)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:59)&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;ASSERT FAILED retVN expected to be instanceof ColumnReference, not org.apache.derby.impl.sql.compile.ConditionalNode: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:42)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:122)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:71)&lt;br/&gt;
        ... 16 more&lt;br/&gt;
Caused by: org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED retVN expected to be instanceof ColumnReference, not org.apache.derby.impl.sql.compile.ConditionalNode&lt;br/&gt;
        at org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:120)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.GroupByList.remapColumnReferencesToExpressions(GroupByList.java:290)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.JoinNode.flatten(JoinNode.java:1482)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.FromList.flattenFromTables(FromList.java:763)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SelectNode.preprocess(SelectNode.java:1094)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.DMLStatementNode.optimizeStatement(DMLStatementNode.java:302)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.CursorNode.optimizeStatement(CursorNode.java:591)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:457)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:99)&lt;br/&gt;
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:1103)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:610)&lt;/p&gt;</comment>
                            <comment id="13451220" author="knutanders" created="Sat, 8 Sep 2012 03:01:05 +0100"  >&lt;p&gt;That&apos;s right, it does not reproduce on the debug versions of 10.4.1.3 and 10.4.2.0 in my environment.&lt;/p&gt;</comment>
                            <comment id="13451477" author="mamtas" created="Sun, 9 Sep 2012 04:36:37 +0100"  >&lt;p&gt;I brought my 10.4 codeline to revision 682719 which has revision comments &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3820&quot; title=&quot;Tasks for managing the 10.4.2 release&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3820&quot;&gt;&lt;del&gt;DERBY-3820&lt;/del&gt;&lt;/a&gt;: Bump release id on 10.4 branch to 10.4.2.0.&quot;. For this revision,with sane=true,  I get same exception. Not sure why? I will download official 10.4.2.0 debug version and try it but I don&apos;t understand why it will fail for revision 682719 if it works with 10.4.2.0.&lt;/p&gt;</comment>
                            <comment id="13451654" author="mamtas" created="Sun, 9 Sep 2012 20:00:41 +0100"  >&lt;p&gt;I downloaded db-derby-10.4.2.0-lib-debug.zip from &lt;a href=&quot;http://db.apache.org/derby/releases/release-10.4.2.0.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/releases/release-10.4.2.0.html&lt;/a&gt; and see the stack trace. Knut, I wonder why we are seeing different results. Following is the query I tried.&lt;/p&gt;

&lt;p&gt;java -Dij.exceptionTrace=true org.apache.derby.tools.ij&lt;br/&gt;
connect &apos;jdbc:derby:db1;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create table t(x int); &lt;br/&gt;
insert into t values 1; &lt;/p&gt;

&lt;p&gt;select case when a=1 then 1 else 2 end &lt;br/&gt;
  from t t1(a) join t t2(b) on a=b &lt;br/&gt;
  group by case when a=1 then 1 else 2 end; &lt;/p&gt;</comment>
                            <comment id="13451658" author="mamtas" created="Sun, 9 Sep 2012 20:17:57 +0100"  >&lt;p&gt;Following query is little bit simpler and gives the same exception&lt;br/&gt;
java -Dij.exceptionTrace=true org.apache.derby.tools.ij&lt;br/&gt;
connect &apos;jdbc:derby:db1;create=true&apos;;&lt;br/&gt;
create table t1(x1 int); &lt;br/&gt;
insert into t1 values 1; &lt;br/&gt;
create table t2(x2 int); &lt;br/&gt;
insert into t2 values 1;&lt;/p&gt;

&lt;p&gt;select 1 &lt;br/&gt;
  from t1 join t2 on x1=x2&lt;br/&gt;
  group by x1+x2;&lt;/p&gt;</comment>
                            <comment id="13451851" author="knutanders" created="Mon, 10 Sep 2012 10:42:01 +0100"  >&lt;p&gt;I ran my tests with old debug versions installed at a shared location and thought they matched what was found at the download page. But it looks like some of them have been compiled manually from the source distribution with debug=true and sane=false. That is, asserts are not compiled in. When I fetched fresh debug versions from the download page, I could reproduce it too on 10.4.1.3, 10.4.2.0 and 10.5.1.1.&lt;/p&gt;</comment>
                            <comment id="13468603" author="mamtas" created="Wed, 3 Oct 2012 16:16:16 +0100"  >&lt;p&gt;I debugged this jira further to see why following query will work &lt;br/&gt;
  select  x1+x2&lt;br/&gt;
    from t1 join t2 on x1=x2 &lt;br/&gt;
    group by x1, x2; &lt;br/&gt;
but following query won&apos;t work&lt;br/&gt;
  select  1&lt;br/&gt;
    from t1 join t2 on x1=x2 &lt;br/&gt;
    group by x1+x2; &lt;br/&gt;
Both of the queries above use the same binary arithmetic expression, one uses it in select clause and other one uses it in group by clause.&lt;/p&gt;

&lt;p&gt;What I found is that both the queries go through the same code during the bind time. But during optimization, while flattening the join node, in sane mode we check if group by columns are all instances of ColumnReference(this check happens in GroupByList.remapColumnReferencesToExpression code) and throw an exception if any of the group by column is found to be not an instance of ColumnReference.&lt;/p&gt;

&lt;p&gt;As mentioned in the earlier comments in this jira, this behavior has been in the code for many releases.&lt;/p&gt;
</comment>
                            <comment id="13468607" author="mamtas" created="Wed, 3 Oct 2012 16:21:31 +0100"  >&lt;p&gt;I do not plan to work on this jira at this point. If anyone else is interested, please feel free to pick up the issue.&lt;/p&gt;</comment>
                            <comment id="13699100" author="kmarsden" created="Wed, 3 Jul 2013 16:49:32 +0100"  >&lt;p&gt;Verified the reproduction on trunk 10.11. Marking HVF&lt;/p&gt;</comment>
                            <comment id="13922392" author="knutanders" created="Thu, 6 Mar 2014 12:12:06 +0000"  >&lt;p&gt;The problem is not limited to CASE expressions:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; create table t(x int);
0 rows inserted/updated/deleted
ij&amp;gt; select a+1, sum(a) from t t1(a) join t t2(b) on a=b group by a+1;
ERROR XJ001: Java exception: &apos;ASSERT FAILED retVN expected to be instanceof ColumnReference, not org.apache.derby.impl.sql.compile.BinaryArithmeticOperatorNode: org.apache.derby.shared.common.sanity.AssertFailure&apos;.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13922426" author="knutanders" created="Thu, 6 Mar 2014 12:32:26 +0000"  >&lt;p&gt;I missed that Mamta had already commented that it also failed without CASE. I agree with the analysis in the 03/Oct/12 comment.&lt;/p&gt;

&lt;p&gt;The failing assert predates &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-883&quot; title=&quot;Enhance GROUP BY clause to support expressions instead of just column references.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-883&quot;&gt;&lt;del&gt;DERBY-883&lt;/del&gt;&lt;/a&gt;. When it was added, it was perfectly reasonable to assume that the GROUP BY list contained only simple column references and no expressions. This changed with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-883&quot; title=&quot;Enhance GROUP BY clause to support expressions instead of just column references.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-883&quot;&gt;&lt;del&gt;DERBY-883&lt;/del&gt;&lt;/a&gt;. I don&apos;t see anything relying on its being a column reference, except the assertion. It looks like the code would work with expressions too. I&apos;ll try to remove the assert and write some tests to verify that it works.&lt;/p&gt;</comment>
                            <comment id="13923823" author="knutanders" created="Fri, 7 Mar 2014 12:08:24 +0000"  >&lt;p&gt;The attached patch, d5313-1a.diff, removes the failing assert and adds a test case to verify that the previously failing queries now return correct results.&lt;/p&gt;

&lt;p&gt;All the regression tests ran cleanly with this patch.&lt;/p&gt;</comment>
                            <comment id="13925539" author="jira-bot" created="Mon, 10 Mar 2014 08:09:08 +0000"  >&lt;p&gt;Commit 1575866 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1575866&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1575866&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5313&quot; title=&quot;Assert failure with CASE expression in GROUP BY clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5313&quot;&gt;&lt;del&gt;DERBY-5313&lt;/del&gt;&lt;/a&gt;: Assert failure with CASE expression in GROUP BY clause&lt;/p&gt;

&lt;p&gt;Remove assert that doesn&apos;t expect expressions in the GROUP BY list.&lt;/p&gt;</comment>
                            <comment id="14147926" author="mikem" created="Thu, 25 Sep 2014 17:24:02 +0100"  >&lt;p&gt;temp taking ownership while working on backport to 10.10.&lt;/p&gt;</comment>
                            <comment id="14156754" author="jira-bot" created="Thu, 2 Oct 2014 18:00:27 +0100"  >&lt;p&gt;Commit 1629018 from mikem@apache.org in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1629018&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1629018&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5313&quot; title=&quot;Assert failure with CASE expression in GROUP BY clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5313&quot;&gt;&lt;del&gt;DERBY-5313&lt;/del&gt;&lt;/a&gt;: Assert failure with CASE expression in GROUP BY clause&lt;/p&gt;

&lt;p&gt;backported change #1575866 from trunk to 10.10 branch, had to do hand&lt;br/&gt;
    merging due to jdk5 code differences in 10.11.&lt;/p&gt;

&lt;p&gt;Remove assert that doesn&apos;t expect expressions in the GROUP BY list.&lt;/p&gt;</comment>
                            <comment id="14158113" author="mikem" created="Fri, 3 Oct 2014 16:49:13 +0100"  >&lt;p&gt;backported fix to 10.10, returning ownership to original, not planning on backporting any more at this time.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12746192">DERBY-6759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12328186">DERBY-883</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12633364" name="d5313-1a.diff" size="3220" author="knutanders" created="Fri, 7 Mar 2014 12:08:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 7 Sep 2012 16:05:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24768</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy089b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35156</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>