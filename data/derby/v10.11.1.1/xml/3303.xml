<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:23:16 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3303/DERBY-3303.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3303] ArrayIndexOutOfBoundsException at MergeSort.compare</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3303</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Derby throws ArrayIndexOutOfBoundsException  when I try to execute SQL query shown below.&lt;/p&gt;

&lt;p&gt;This is a regression, since Derby 10.2.2.0 executes this query without problems.&lt;/p&gt;

&lt;p&gt;Attached are DDL statements to create DB tables, and database itself (with data).&lt;/p&gt;

&lt;p&gt;2008-01-08 12:32:34.461 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;DRDAConnThread_5,6,derby.daemons&amp;#93;&lt;/span&gt; (XID = 1497), (SESSIONID = 0), (DATABASE = InventorizacijaDB), (DRDAID = NF000001.G46A-666250070078662256&lt;/p&gt;
{1}
&lt;p&gt;), Failed Statement is: select MAX(preke0_.BARKODAS) as col_0_0_, MAX(preke0_.PAVADINIMAS) as col_1_0_, MAX(preke0_.KIEKIS) as col_2_0_, SUM(irasas1_.FAKTINIS_KIEKIS) as col_3_0_ from PREKE preke0_, IRASAS irasas1_, IRASU_BLOKAS irasubloka2_ where irasas1_.IRASU_BLOKAS=irasubloka2_.ID and preke0_.UNIKALUS_KODAS=irasas1_.UNIKALUS_KODAS and irasubloka2_.INVENTORIZACIJA=? group by irasas1_.UNIKALUS_KODAS order by abs(SUM(irasas1_.FAKTINIS_KIEKIS)-MAX(preke0_.KIEKIS)) DESC with 1 parameters begin parameter #1: 1 :end parameter &lt;br/&gt;
java.lang.ArrayIndexOutOfBoundsException: 5&lt;br/&gt;
	at org.apache.derby.impl.store.access.sort.MergeSort.compare(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.access.sort.SortBuffer.insert(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.access.sort.MergeInserter.insert(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.SortResultSet.loadSorter(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.SortResultSet.openCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;/p&gt;</description>
                <environment>------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.6.0_03&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
Java home:       D:\Programs\Java\jre1.6.0_03&lt;br/&gt;
Java classpath:  derbytools.jar&lt;br/&gt;
OS name:         Windows XP&lt;br/&gt;
OS architecture: x86&lt;br/&gt;
OS version:      5.1&lt;br/&gt;
Java user name:  Donatas&lt;br/&gt;
Java user home:  C:\Documents and Settings\Donatas&lt;br/&gt;
Java user dir:   d:\java\derby-10.3.2.1\lib&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.6&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: Java SE 6 - JDBC 4.0&lt;br/&gt;
[D:\java\derby-10.3.2.1\lib\derbytools.jar] 10.3.2.1 - (599110)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Locale Information -----------------&lt;br/&gt;
------------------------------------------------------</environment>
        <key id="12385772">DERBY-3303</key>
            <summary>ArrayIndexOutOfBoundsException at MergeSort.compare</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="donatasc">Donatas Ciuksys</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Jan 2008 13:24:15 +0000</created>
                <updated>Tue, 30 Jun 2009 16:55:51 +0100</updated>
                            <resolved>Thu, 21 Feb 2008 17:46:33 +0000</resolved>
                                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12556892" author="donatasc" created="Tue, 8 Jan 2008 13:26:06 +0000"  >&lt;p&gt;Actual database with data&lt;/p&gt;</comment>
                            <comment id="12556894" author="donatasc" created="Tue, 8 Jan 2008 13:28:06 +0000"  >&lt;p&gt;SQL that fails:&lt;/p&gt;

&lt;p&gt;SELECT MAX(Preke.pavadinimas) AS PAVADINIMAS, MAX(Preke.barkodas) AS BARKODAS, &lt;br/&gt;
        MAX(Preke.kiekis) AS KIEKIS, SUM(Irasas.faktinis_kiekis) AS FAKTINIS_KIEKIS,&lt;br/&gt;
        SUM(Irasas.faktinis_kiekis)-MAX(Preke.kiekis) AS TRUKUMAS&lt;br/&gt;
FROM Preke LEFT JOIN Irasas ON Preke.unikalus_kodas = Irasas.unikalus_kodas&lt;br/&gt;
    JOIN Irasu_Blokas ON Irasas.irasu_blokas = Irasu_Blokas.id&lt;br/&gt;
WHERE Irasu_Blokas.inventorizacija = 1&lt;br/&gt;
GROUP BY Irasas.unikalus_kodas  &lt;br/&gt;
ORDER BY ABS(SUM(Irasas.faktinis_kiekis) - MAX(Preke.kiekis)) DESC&lt;/p&gt;</comment>
                            <comment id="12556895" author="donatasc" created="Tue, 8 Jan 2008 13:31:10 +0000"  >&lt;p&gt;DDL script to create database (without data)&lt;/p&gt;</comment>
                            <comment id="12556925" author="army" created="Tue, 8 Jan 2008 16:08:43 +0000"  >&lt;p&gt;Thank you &lt;b&gt;very&lt;/b&gt; much for the reproduction script, Donatas.&lt;/p&gt;

&lt;p&gt;I ran your script against trunk and the bug reproduces there, as well.  Using a sane build the query fails with the following assertion error:&lt;/p&gt;

&lt;p&gt;org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED column ordering error&lt;br/&gt;
    at org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:120)&lt;br/&gt;
    at org.apache.derby.impl.store.access.sort.MergeSort.initialize(MergeSort.java:535)&lt;br/&gt;
    at org.apache.derby.impl.store.access.sort.ExternalSortFactory.createSort(ExternalSortFactory.java:216)&lt;br/&gt;
    at org.apache.derby.impl.store.access.RAMTransaction.createSort(RAMTransaction.java:1711)&lt;br/&gt;
    at org.apache.derby.impl.sql.execute.SortResultSet.loadSorter(SortResultSet.java:301)&lt;br/&gt;
    at org.apache.derby.impl.sql.execute.SortResultSet.openCore(SortResultSet.java:268)&lt;/p&gt;

&lt;p&gt;The query runs without error at svn # 516453, but fails with # 516454.  So it looks like this is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12568780" author="army" created="Thu, 14 Feb 2008 01:41:57 +0000"  >&lt;p&gt;A simpler way to reproduce the problem on trunk:&lt;/p&gt;

&lt;p&gt;  create table t1 (i int, j int, k int);&lt;br/&gt;
  insert into t1 values (1, 1, 2), (1, 3, 3), (2, 3, 1), (2, 2, 4);&lt;/p&gt;

&lt;p&gt;  &amp;#8211; Works.&lt;br/&gt;
  select sum(k) as s from t1 group by i order by 1;&lt;/p&gt;

&lt;p&gt;  &amp;#8211; Works.&lt;br/&gt;
  select sum(k) as s from t1 group by i order by s;&lt;/p&gt;

&lt;p&gt;  &amp;#8211; Fails (ArrayIndexOutOfBounds / ASSERT); should fail with ERROR 42X77...&lt;br/&gt;
  select sum(k) as s from t1 group by i order by 2;&lt;/p&gt;

&lt;p&gt;  &amp;#8211; Fails (ArrayIndexOutOfBounds / ASSERT)&lt;br/&gt;
  select sum(k) as s from t1 group by i order by abs(1);&lt;/p&gt;

&lt;p&gt;  &amp;#8211; Fails (ArrayIndexOutOfBounds / ASSERT)&lt;br/&gt;
  select sum(k) as s from t1 group by i order by sum(k);&lt;/p&gt;

&lt;p&gt;Confirmed that all of these run without error before &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt; changes were committed.&lt;/p&gt;</comment>
                            <comment id="12569360" author="army" created="Fri, 15 Feb 2008 18:42:35 +0000"  >&lt;p&gt;From what I could gather the failures mentioned in my previous comment were caused by two different problems, but both come down to the mistreatment (esp. ignoring) of columns in a ResultColumnList that have been &quot;pulled up&quot; for GROUP BY processing.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a patch, d3303_v1.patch, which makes two very small changes to OrderByColumn.java to account for &quot;pulled&quot; GROUP BY columns.  With this patch applied all of the queries posted in my previous comment run as expected.&lt;/p&gt;

&lt;p&gt;I also ran derbyall and suites.All with ibm142 and they ran cleanly.&lt;/p&gt;

&lt;p&gt;I &lt;em&gt;think&lt;/em&gt; this constitutes a complete fix for the issue, but I am not all that familiar with the GROUP BY and ORDER BY column &quot;pulling&quot; logic that exists in Derby.  I&apos;ve skimmed through the relevant code for reviews but have never actually changed it myself.  So if anyone out there can double-check the change, that would be great.  It&apos;s only two lines of code change plus some additional comments, so it should in theory be quick...&lt;/p&gt;</comment>
                            <comment id="12569369" author="bryanpendleton" created="Fri, 15 Feb 2008 18:51:50 +0000"  >&lt;p&gt;Hi Army, thanks for working on this problem. I&apos;ll try to have a look at your patch over the weekend (little busy today).&lt;/p&gt;</comment>
                            <comment id="12569449" author="bryanpendleton" created="Fri, 15 Feb 2008 23:08:26 +0000"  >&lt;p&gt;Hi Army, things lightened up a bit this afternoon so I had a look at the patch.&lt;/p&gt;

&lt;p&gt;The comments are excellent! Thank you very much; they make it very clear.&lt;br/&gt;
Your change seems correct to me. The code is also considerably cleaner&lt;br/&gt;
by using visibleSize(), and reads better.&lt;/p&gt;

&lt;p&gt;Here are a few suggestions; none are worth holding up the patch for.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It might be nice to format your detailed comment for resolveAddedColumns()&lt;br/&gt;
as a true javadoc comment for that method (which currently has no javadoc),&lt;br/&gt;
rather than as an inline comment.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I recalled from my investigations with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1861&quot; title=&quot;Column ordering ASSERT when combining column references and expressions in same ORDER BY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1861&quot;&gt;&lt;del&gt;DERBY-1861&lt;/del&gt;&lt;/a&gt; that some of this code&lt;br/&gt;
gets exercised by various combinations of including &quot;*&quot; in the select list, and&lt;br/&gt;
using expressions in the order by list. So I tried a couple more test cases.&lt;br/&gt;
They didn&apos;t find any additional problems, but here they are anyway, in case you&lt;br/&gt;
think that they might add value to the regression suite:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  select d3303.i as old_i, sum(d3303.k), d3303.* from d3303 group by k, i, j order by j;&lt;/p&gt;

&lt;p&gt;  select d3303.i as old_i, sum(d3303.k), d3303.* from d3303 group by k, i, j order by 4;&lt;/p&gt;

&lt;p&gt;  select d3303.i as old_i, sum(d3303.k), d3303.* from d3303 group by k, i, j order by k+2;&lt;/p&gt;

&lt;p&gt;+1 to commit.&lt;/p&gt;
</comment>
                            <comment id="12569459" author="army" created="Sat, 16 Feb 2008 00:24:28 +0000"  >&lt;p&gt;Thank you very much for taking the time to review, Bryan.  I appreciate it!&lt;/p&gt;

&lt;p&gt;Your suggestions are great ones so I&apos;m attaching a _v2 patch which incorporates them.  I did modify the comments a bit to try to be more accurate about what &quot;resolveAddedColumn()&quot; really does--esp. for the example query, it doesn&apos;t really look for a column corresponding to &quot;SUM(J)&quot;, rather it looks for a column corresponding to &quot;this.addedColumnOffset&quot;, which (in the old example) ends up being SUM(J).  I also changed the example to order by SUM(K) instead of SUM(J) in hopes of making it clearer (since there are two &quot;SUM(J)&quot;s in the old example).&lt;/p&gt;

&lt;p&gt;Hopefully the new comments are not worse than the old ones...&lt;/p&gt;

&lt;p&gt;Thanks again for the quick feedback!&lt;/p&gt;</comment>
                            <comment id="12569510" author="bryanpendleton" created="Sat, 16 Feb 2008 05:39:35 +0000"  >&lt;p&gt;Patch 2 looks great, and changing that extra SUM(J) in the comments&lt;br/&gt;
does indeed make it clearer. I have no additional suggestions to offer.&lt;/p&gt;</comment>
                            <comment id="12569955" author="army" created="Mon, 18 Feb 2008 17:22:18 +0000"  >&lt;p&gt;Many thanks for the timely and useful feedback, Bryan!&lt;/p&gt;

&lt;p&gt;I committed the _v2 patch with svn # 628823:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=628823&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=628823&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If tinderbox runs are clean over the next day or two, I plan to port this back to 10.3.&lt;/p&gt;</comment>
                            <comment id="12570304" author="army" created="Tue, 19 Feb 2008 16:41:20 +0000"  >&lt;p&gt;The &quot;svn merge&quot; command from trunk to 10.3 had a conflict in orderby.sql.  From what I can tell it was perhaps a line-ending issue, though I&apos;m not real sure.  In any event, I resolved the conflict and am attaching d3303_10_3_merge.patch, which is what I plan to commit.&lt;/p&gt;</comment>
                            <comment id="12570751" author="army" created="Wed, 20 Feb 2008 17:04:13 +0000"  >&lt;p&gt;Ported the fix for this issue back to 10.3 by commiting d3303_10_3_merge.patch with svn # 629535:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=629535&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=629535&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Donatas, if you have a moment can you check to see if your issue is fixed with this commit, and report back?&lt;/p&gt;</comment>
                            <comment id="12571111" author="donatasc" created="Thu, 21 Feb 2008 17:40:09 +0000"  >&lt;p&gt;Sorry, I have migrated to DB2 already (have changed jdbc driver, connection url, and so on), so I don&apos;t have development environment suitable for Derby any more. And I don&apos;t know, how to build version 10.3.2.2. I have attached db scripts, it shouldn&apos;t be difficult to run them and check whether this issue still holds.&lt;/p&gt;

&lt;p&gt;Good luck.&lt;/p&gt;</comment>
                            <comment id="12571114" author="army" created="Thu, 21 Feb 2008 17:46:33 +0000"  >&lt;p&gt;Fixed in trunk and 10.3, original repro now runs without error, and tinderbox tests on 10.3 ran with no errors.  So closing the issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12325311">DERBY-681</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12375940" name="d3303_10_3_merge.patch" size="12663" author="army" created="Tue, 19 Feb 2008 16:41:20 +0000"/>
                            <attachment id="12375702" name="d3303_v1.patch" size="10010" author="army" created="Fri, 15 Feb 2008 18:42:34 +0000"/>
                            <attachment id="12375732" name="d3303_v2.patch" size="12614" author="army" created="Sat, 16 Feb 2008 00:24:28 +0000"/>
                            <attachment id="12372712" name="db.zip" size="245357" author="donatasc" created="Tue, 8 Jan 2008 13:26:06 +0000"/>
                            <attachment id="12372713" name="ddl.sql" size="3748" author="donatasc" created="Tue, 8 Jan 2008 13:31:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 Jan 2008 16:08:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0usv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38808</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>