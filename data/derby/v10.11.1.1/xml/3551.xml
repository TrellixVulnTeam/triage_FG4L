<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:42:55 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3551/DERBY-3551.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3551] Implement procedure SYSCS_UTIL.SYSCS_PREPARE_REPLICATION()</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3551</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Jorgen says-&lt;/p&gt;

&lt;p&gt;I suggest that the replication step in which the master database is frozen is replaced by a new system procedure to solve index and import:&lt;/p&gt;

&lt;p&gt;Old: SYSCS_UTIL.SYSCS_FREEZE_DATABASE()&lt;br/&gt;
New: SYSCS_UTIL.SYSCS_PREPARE_REPLICATION()&lt;/p&gt;

&lt;p&gt;The new system procedure should:&lt;br/&gt;
1) Freeze the database&lt;br/&gt;
2) Check if there are any ongoing transactions with unlogged operations. If so - unfreeze and abort. Otherwise:&lt;br/&gt;
3) Enable logging of unlogged operations &lt;/p&gt;</description>
                <environment></environment>
        <key id="12391727">DERBY-3551</key>
            <summary>Implement procedure SYSCS_UTIL.SYSCS_PREPARE_REPLICATION()</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12391027">DERBY-3533</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="narayanan">V.Narayanan</assignee>
                                    <reporter username="narayanan">V.Narayanan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Mar 2008 10:26:02 +0000</created>
                <updated>Fri, 21 Jan 2011 17:51:47 +0000</updated>
                            <resolved>Mon, 24 Mar 2008 23:01:14 +0000</resolved>
                                    <version>10.4.1.3</version>
                    <version>10.5.1.1</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12580259" author="narayanan" created="Wed, 19 Mar 2008 07:16:11 +0000"  >&lt;p&gt;I have been trying to understand how I can enable logging for unlogged operations. &lt;br/&gt;
My guide so far has been JIRA comments and code related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-239&quot; title=&quot;Need a online backup feature  that does not block update operations   when online backup is in progress.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-239&quot;&gt;&lt;del&gt;DERBY-239&lt;/del&gt;&lt;/a&gt; - &lt;br/&gt;
Need a online backup feature that does not block update operations when online backup &lt;br/&gt;
is in progress.&lt;/p&gt;

&lt;p&gt;Derby-239 enables logging for unlogged operations by turning on the logArchived mode.&lt;br/&gt;
Turning on logArchived mode from my understanding, archives logs as well as logs unlogged&lt;br/&gt;
operations.&lt;/p&gt;

&lt;p&gt;But for replication archiving of logs is not necessary, we need to only turn on the logging.&lt;/p&gt;

&lt;p&gt;I am investigating further on how this alone can be done.&lt;/p&gt;</comment>
                            <comment id="12580335" author="narayanan" created="Wed, 19 Mar 2008 11:57:28 +0000"  >&lt;p&gt;In trying to search for a way to enable only logging of unlogged operations and&lt;br/&gt;
not the archiving support available the following observations were very important&lt;/p&gt;

&lt;p&gt;1) Logic to enable logging is found in the BaseDataFileFactory &lt;br/&gt;
  (org.apache.derby.impl.store.raw.data.BaseDataFileFactory, line no 672)&lt;br/&gt;
2) Logic for archiving is present in LogToFile&lt;/p&gt;

&lt;p&gt;This partitioning of logic was to the advantage of this issue and made the coding&lt;br/&gt;
logic very simple&lt;/p&gt;

&lt;p&gt;Follows a brief explanation of the solution developed&lt;/p&gt;

&lt;p&gt;When log archiving needs to be done it is enabled by using a flag in the&lt;br/&gt;
following way in the BaseDataFileFactory&lt;/p&gt;

&lt;p&gt;if (logFactory.logArchived()) &lt;/p&gt;
{
    mode &amp;amp;= ~(ContainerHandle.MODE_UNLOGGED | ContainerHandle.MODE_CREATE_UNLOGGED);
}&lt;br/&gt;
&lt;br/&gt;
(The ContainerHandle class contains a very good explanation of the MODE_UNLOGGED, &lt;br/&gt;
MODE_CREATE_UNLOGGED flags.)&lt;br/&gt;
&lt;br/&gt;
Now in addition to just enabling the flags when logArchiving is required the flags need&lt;br/&gt;
to be enabled when replication is active too. To achieve this the above code was changed to&lt;br/&gt;
&lt;br/&gt;
if (logFactory.logArchived() || logFactory.replicationLogUnlogged()) {
    mode &amp;amp;= ~(ContainerHandle.MODE_UNLOGGED | ContainerHandle.MODE_CREATE_UNLOGGED);
}

&lt;p&gt;Doing the above solved the problem for a simple index creation, what remains to be seen&lt;br/&gt;
is how it works for imports.&lt;/p&gt;

&lt;p&gt;Attaching a patch for people who might be interested in testing the solution.&lt;/p&gt;

&lt;p&gt;Another interesting decision will be as to whether a stored procedure will be required now?&lt;br/&gt;
(I do not have an answer for this right now, but I surely shall be revisiting Derby-239 to learn&lt;br/&gt;
more about unlogged operations being started before logging is enabled)&lt;/p&gt;</comment>
                            <comment id="12580338" author="narayanan" created="Wed, 19 Mar 2008 12:03:43 +0000"  >&lt;p&gt;Please note that Derby3551_1 is not for a commit. It is just for testing the solution.&lt;br/&gt;
There are many other questions remaining unanswered.&lt;/p&gt;

&lt;p&gt;1) Is a stored procedure for starting replication required?&lt;/p&gt;

&lt;p&gt;2) What are the behaviour of imports? (There is a separate issue for jars)&lt;/p&gt;

&lt;p&gt;3) Tests need to be written for unlogged operations in the context of replication&lt;br/&gt;
    (there is a separate JIRA for this too)&lt;/p&gt;
</comment>
                            <comment id="12581015" author="narayanan" created="Fri, 21 Mar 2008 07:12:52 +0000"  >&lt;p&gt;I feel that the stored procedure will not be required.&lt;/p&gt;

&lt;p&gt;Turning on logging with the present logic will happen when the master is booted (&lt;br/&gt;
connection url with startMaster=true)&lt;/p&gt;

&lt;p&gt;Turning our attention to the future enhancements planned for 10.5 as mentioned&lt;br/&gt;
in the functional specification&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------------------------------&lt;br/&gt;
How to start replication - Future enhancement (10.5)&lt;/p&gt;

&lt;p&gt;When replication is started, the slave checks that the database does not already exist, &lt;br/&gt;
and that the user is authorized to create a database. The slave then starts to listen for &lt;br/&gt;
a master on the specified host and port. The master connects to the slave and performs a &lt;br/&gt;
handshake to ensure that only one master connects to a slave. The master then sends the &lt;br/&gt;
whole database, including the active log files, to the slave via this connection. Hence, &lt;br/&gt;
the database is only booted, not created, on the slave.&lt;br/&gt;
------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;The database copying operation happens when the master is connection to the slave. This is&lt;br/&gt;
also where we turn on logging for unlogged operations.&lt;/p&gt;

&lt;p&gt;The stored procedure will then result in a series of redundant steps that would need to be&lt;br/&gt;
performed again when we do the shipping automatically in the future enhancements for 10.5.&lt;/p&gt;

&lt;p&gt;That said,&lt;/p&gt;

&lt;p&gt;I think we need to move the steps mentioned above, to when we start the master controller. But&lt;br/&gt;
I think this can wait till the above enhancements are implemented. &lt;/p&gt;

&lt;p&gt;For now the series of steps the user follows to start replication combined with the following &lt;br/&gt;
check during replication startup&lt;/p&gt;

&lt;p&gt;&quot;Check if any unlogged operations are currently running, if yes unfreeze and throw an exception&lt;br/&gt;
saying that replication cannot be started since the database has unlogged operations running&quot;&lt;/p&gt;

&lt;p&gt;Should suffice.&lt;/p&gt;</comment>
                            <comment id="12581020" author="narayanan" created="Fri, 21 Mar 2008 07:43:09 +0000"  >&lt;p&gt;&amp;gt;&quot;Check if any unlogged operations are currently running, if yes unfreeze and throw an exception&lt;br/&gt;
&amp;gt;saying that replication cannot be started since the database has unlogged operations running&quot; &lt;/p&gt;

&lt;p&gt;Not sure if we should unfreeze or just throw an exception informing an user about the unlogged&lt;br/&gt;
operations and let the user unfreeze the database&lt;/p&gt;</comment>
                            <comment id="12581038" author="narayanan" created="Fri, 21 Mar 2008 09:32:56 +0000"  >&lt;p&gt;I have modified Derby3551_1.diff to now throw an error when&lt;br/&gt;
unlogged operations are running. I feel we should not unfreeze&lt;br/&gt;
and instead should let the user unfreeze.&lt;/p&gt;</comment>
                            <comment id="12581140" author="narayanan" created="Fri, 21 Mar 2008 17:40:18 +0000"  >&lt;p&gt;I tested the patch Derby3551_2 with imports and it&lt;br/&gt;
worked fine. &lt;/p&gt;

&lt;p&gt;Attached is a ij script that automatically&lt;br/&gt;
exports and imports data, from tables it creates by&lt;br/&gt;
itself.&lt;/p&gt;

&lt;p&gt;It tests the procedures&lt;/p&gt;

&lt;p&gt;SYSCS_UTIL.SYSCS_IMPORT_DATA and&lt;/p&gt;

&lt;p&gt;SYSCS_UTIL.SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE&lt;/p&gt;

&lt;p&gt;To use it to test imports in replication just do the&lt;br/&gt;
initial replication setup in ij and then do&lt;/p&gt;

&lt;p&gt;run &apos;runscript_import.sql&apos;;&lt;/p&gt;

&lt;p&gt;I thought the script might be helpful for people&lt;br/&gt;
who wants to test imports with this patch without&lt;br/&gt;
going through the creation of the tables and files&lt;br/&gt;
necessary.&lt;/p&gt;</comment>
                            <comment id="12581141" author="narayanan" created="Fri, 21 Mar 2008 17:42:34 +0000"  >&lt;p&gt;I had also earlier tested this patch for a simple&lt;br/&gt;
index creation and it worked fine.&lt;/p&gt;</comment>
                            <comment id="12581159" author="oysteing" created="Fri, 21 Mar 2008 18:46:31 +0000"  >&lt;p&gt;Since I guess unlogged operations will be blocked when the database is frozen, I think it will be safe to delay the check until starting the master.&lt;/p&gt;

&lt;p&gt;I think the proposed patch looks good. Do you plan to add some test cases? &lt;br/&gt;
Some suggestions on wording:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;LogToFile#replicationLogUnlogged:  This method returns whether db is in master mode or not, and I think inReplicationMasterMode or something would be a better name.  (The way the javadoc is written, it may lead you to think that you should call this method to activate logging.)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;messages.xml: I would say &apos;cannot be started&apos; , not &apos;booted&apos; since the operation is called startMaster.&apos;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12581250" author="narayanan" created="Sat, 22 Mar 2008 06:36:55 +0000"  >&lt;p&gt;&amp;gt; Since I guess unlogged operations will be blocked when the database is frozen, &lt;br/&gt;
&amp;gt; I think it will be safe to delay the check until starting the master. &lt;/p&gt;

&lt;p&gt;correct, That is why I thought that a combination of the steps, the user should follow&lt;br/&gt;
and a check to see if the freeze has frozen any already started unlogged operation, should&lt;br/&gt;
suffice.&lt;/p&gt;

&lt;p&gt;&amp;gt; I think the proposed patch looks good. Do you plan to add some test cases?&lt;/p&gt;

&lt;p&gt;I intend to add tests in &lt;a href=&quot;http://issues.apache.org/jira/browse/Derby-3553&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/Derby-3553&lt;/a&gt;. I was hoping&lt;br/&gt;
to move to installation of jars and look at what will be required there and then move to&lt;br/&gt;
writing tests for unlogged operations.&lt;/p&gt;

&lt;p&gt;&amp;gt; * LogToFile#replicationLogUnlogged: This method returns whether db is in master &lt;br/&gt;
&amp;gt; mode or not, and I think inReplicationMasterMode or something would be a better name. &lt;br/&gt;
&amp;gt; (The way the javadoc is written, it may lead you to think that you should call this method to &lt;br/&gt;
&amp;gt; activate logging.)&lt;/p&gt;

&lt;p&gt;Changed the method name to inReplicationMasterMode(). I also changed the javadoc to the following&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Used to determine if the replication master mode has been started,&lt;/li&gt;
	&lt;li&gt;and the logging for unlogged operations needs to be enabled.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&amp;gt; * messages.xml: I would say &apos;cannot be started&apos; , not &apos;booted&apos; since the operation is called &lt;br/&gt;
&amp;gt; startMaster.&apos;&lt;/p&gt;

&lt;p&gt;Changed &apos;booted&apos; to &apos;started&apos;.&lt;/p&gt;</comment>
                            <comment id="12581715" author="oysteing" created="Mon, 24 Mar 2008 23:01:14 +0000"  >&lt;p&gt;Thanks for addressing my comments, Naraynan.&lt;br/&gt;
Committed version 3 of the patch at revision 640631.&lt;/p&gt;</comment>
                            <comment id="12581983" author="chaase3" created="Tue, 25 Mar 2008 15:26:23 +0000"  >&lt;p&gt;Just checking &amp;#8211; based on all the comments on this issue, it seems that what we ended up with was NOT a new system procedure after all, but the implementation of a check when the startMaster command is run &amp;#8211;&lt;/p&gt;

&lt;p&gt;&quot;Check if any unlogged operations are currently running, if yes unfreeze and throw an exception&lt;br/&gt;
saying that replication cannot be started since the database has unlogged operations running&quot;&lt;/p&gt;

&lt;p&gt;Is that correct? If so, I&apos;m guessing the information should be added to the description of the startMaster command as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3169&quot; title=&quot;Add documentation for replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3169&quot;&gt;&lt;del&gt;DERBY-3169&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="12582000" author="narayanan" created="Tue, 25 Mar 2008 16:14:20 +0000"  >&lt;p&gt;Thank you for watching this issue Kim.&lt;/p&gt;

&lt;p&gt;I decided that we should not unfreeze. So now we just throw an exception if it is found that&lt;br/&gt;
unlogged operations were running. The user needs to decide if he wants to unfreeze.&lt;/p&gt;

&lt;p&gt;So when the user calls the startMaster command we check to see if there were any unlogged&lt;br/&gt;
operations running when the user called a freeze. If there were any unlogged operations running&lt;br/&gt;
we throw an exception with the following message&lt;/p&gt;

&lt;p&gt;&quot;Replication master cannot be started since unlogged operations are in progress, unfreeze to allow unlogged operations to complete and restart replication&quot;&lt;/p&gt;</comment>
                            <comment id="12582292" author="oysteing" created="Wed, 26 Mar 2008 14:09:12 +0000"  >&lt;p&gt;Merged to 10.4 branch at revision 641318.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12378223" name="Derby3551_1.diff" size="3409" author="narayanan" created="Wed, 19 Mar 2008 11:57:28 +0000"/>
                            <attachment id="12378224" name="Derby3551_1.stat" size="291" author="narayanan" created="Wed, 19 Mar 2008 11:57:28 +0000"/>
                            <attachment id="12378371" name="Derby3551_2.diff" size="7100" author="narayanan" created="Fri, 21 Mar 2008 09:32:56 +0000"/>
                            <attachment id="12378372" name="Derby3551_2.stat" size="483" author="narayanan" created="Fri, 21 Mar 2008 09:32:56 +0000"/>
                            <attachment id="12378431" name="Derby3551_3.diff" size="7241" author="narayanan" created="Sat, 22 Mar 2008 06:36:55 +0000"/>
                            <attachment id="12378432" name="Derby3551_3.stat" size="483" author="narayanan" created="Sat, 22 Mar 2008 06:36:55 +0000"/>
                            <attachment id="12378388" name="runscript_import.sql" size="941" author="narayanan" created="Fri, 21 Mar 2008 17:40:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 21 Mar 2008 18:46:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30900</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0lin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37304</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>