<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:16:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-157/DERBY-157.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-157] Server throws DRDA protocol exception for certain date/time strings passed from an ODBC client.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-157</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;NOTE: This bug is NOT the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-149&quot; title=&quot;Server hang when invalid string is bound to datetime columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-149&quot;&gt;&lt;del&gt;DERBY-149&lt;/del&gt;&lt;/a&gt;, although the two bugs reproduce in the same kind of scenario.  &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-149&quot; title=&quot;Server hang when invalid string is bound to datetime columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-149&quot;&gt;&lt;del&gt;DERBY-149&lt;/del&gt;&lt;/a&gt; describes a problem that occurs when an invalid date/time string is specified using the Universal Driver (JDBC); this bug describes a problem that occurs when a date/time string is deemed as &quot;valid&quot; by an ODBC driver (in this case, the DB2 Runtime Client) but as &quot;invalid&quot; by the server.&lt;/p&gt;

&lt;p&gt;BACKGROUND:&lt;/p&gt;

&lt;p&gt;When a client program passes a datetime string value to Derby Network Server, the driver first does a check of the string to see if it&apos;s valid.  For JDBC programs using the Universal Driver (JCC), the JCC driver appears to base it&apos;s check on the java.sql.Date/Time/Timestamp specifications, which only allow specific forms of the strings.  For example, the JDBC spec for &quot;java.sql.Date.valueOf&quot; says that the string value must represent a date in the format &quot;yyyy-mm-dd&quot;.&lt;/p&gt;

&lt;p&gt;Derby Network Server &lt;em&gt;assumes&lt;/em&gt; that the java.sql.Date/Time/Timestamp specifications in this regard will hold true for the value in question, and so &amp;lt;b&amp;gt; it does NOT have logic to see if the received string causes an error &amp;lt;/b&amp;gt;.  This is fine when using the JCC driver because the formats rejected by Network Server are also the formats rejected by the JCC driver, and so invalid datetime strings shouldn&apos;t ever make it to the server (they&apos;ll be caught by the driver).&lt;/p&gt;

&lt;p&gt;PROBLEM:&lt;/p&gt;

&lt;p&gt;Other drivers-&lt;del&gt;and in particular, ODBC drivers&lt;/del&gt;-can have different notions about what a valid datetime string is.  In the particular case that prompted this bug, the DB2 Runtime Client allows a date string of the format &quot;yyyy/mm/dd&quot;, and so if it sees a string with this format, it will pass it on to Network Server.  However, since Network Server only recognizes the form &quot;yyyy-mm-dd&quot; (per JDBC spec), it will throw a java.lang.IllegalArgumentException.  &lt;/p&gt;

&lt;p&gt;Currently, Derby Network Server doesn&apos;t catch this exception (because it assumes the datetime is either valid or else caught by the driver, as is the case with JCC), and so the exception is interpreted by the server as &quot;unexpected&quot;.  This causes the server to throw a generic protocol exception and deallocate the connection.&lt;/p&gt;

&lt;p&gt;REPRO:&lt;/p&gt;

&lt;p&gt;Here is a fragment of a C++ program that shows how to recreate the problem, assuming that 1) table &quot;u.tt1&quot; has been created as &quot;u.tt1(d date)&quot;, 2) &quot;hstmt&quot; has been properly initalized as a statement on a connection to a Derby database, and 3) the DB2 Runtime Client is being used.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;SQLRETURN RetCode = SQL_SUCCESS;&lt;br/&gt;
SQLCHAR SQLStmt&lt;span class=&quot;error&quot;&gt;&amp;#91;255&amp;#93;&lt;/span&gt;;&lt;br/&gt;
SQLCHAR dateObj&lt;span class=&quot;error&quot;&gt;&amp;#91;10&amp;#93;&lt;/span&gt;;&lt;/p&gt;

&lt;p&gt;strcpy((char *) SQLStmt, &quot;insert into u.tt1 values &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&quot;);&lt;br/&gt;
RetCode = SQLPrepare(hstmt, SQLStmt, SQL_NTS);&lt;/p&gt;

&lt;p&gt;// Bind the parameter marker used in the SQL statement to&lt;br/&gt;
// an application variable&lt;br/&gt;
RetCode = SQLBindParameter(hstmt, 1, SQL_PARAM_INPUT, SQL_C_CHAR, &lt;br/&gt;
	SQL_DATE, sizeof(dateObj), &lt;br/&gt;
	0, dateObj, sizeof(dateObj), NULL);&lt;/p&gt;

&lt;p&gt;// Populate the bound variable with a datetime value that will&lt;br/&gt;
// pass the ODBC driver check but that is NOT recognized by the&lt;br/&gt;
// Derby Network Server.&lt;br/&gt;
strcpy(dateObj, &quot;1948/04/08&quot;);&lt;/p&gt;

&lt;p&gt;// Execute the SQL statement&lt;br/&gt;
RetCode = SQLExecute(hstmt);&lt;br/&gt;
if (RetCode == SQL_SUCCESS) {&lt;br/&gt;
	printf(&quot;OK, all good.\n&quot;);&lt;br/&gt;
}&lt;br/&gt;
else {&lt;br/&gt;
	printf(&quot;Error executing insert statement:\n&quot;);&lt;br/&gt;
	(error-handling-code)&lt;br/&gt;
}&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;The result of this fragment will be:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;IBM&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;CLI Driver&amp;#93;&lt;/span&gt; SQL30020N  Execution failed because of a Distributed Protocol Error that will affect the successful execution of subsequent commands and SQL statements:  Reason Code &quot;0x124C&quot;(&quot;011D&quot;)&quot;&quot;.  SQLSTATE=58009&lt;/p&gt;

&lt;p&gt;NOTES:&lt;/p&gt;

&lt;p&gt;The fix for this problem is straightforward; one just needs to add &quot;try-catch&quot; logic to catch the IllegalArgumentException in the server and then re-throw it as a valid SQLException.&lt;/p&gt;</description>
                <environment>I found this problem using Derby Network Server with the DB2 Runtime Client, but I imagine it could occur for other clients, as well...</environment>
        <key id="30565">DERBY-157</key>
            <summary>Server throws DRDA protocol exception for certain date/time strings passed from an ODBC client.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Mar 2005 04:32:15 +0000</created>
                <updated>Tue, 11 Apr 2006 01:40:48 +0100</updated>
                            <resolved>Tue, 11 Apr 2006 01:40:48 +0100</resolved>
                                                    <fixVersion>10.1.1.0</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="60173" author="jboynes" created="Fri, 4 Mar 2005 11:15:25 +0000"  >&lt;p&gt;Attach patch sent to list by Army &amp;lt;qozinx@sbcglobal.net&amp;gt;&lt;/p&gt;</comment>
                            <comment id="61568" author="army" created="Sat, 26 Mar 2005 06:34:11 +0000"  >&lt;p&gt;Patch committed 03/24/05, revision 158935.&lt;/p&gt;</comment>
                            <comment id="12373884" author="army" created="Tue, 11 Apr 2006 01:39:21 +0100"  >&lt;p&gt;Reopening issue to set Fixin...&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="19098" name="derby-157.patch" size="3548" author="jboynes" created="Fri, 4 Mar 2005 11:15:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 4 Mar 2005 11:15:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21803</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy16uv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40761</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>