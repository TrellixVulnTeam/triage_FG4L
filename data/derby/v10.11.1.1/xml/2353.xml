<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:41:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2353/DERBY-2353.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2353] intermittent NPEs during DELETE ops in a reasonably large transaction</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2353</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I&apos;m intermittently seeing NPEs thrown while using the embedded driver to rewrite several rows in a single transaction.  Here&apos;s the set of commands that were executed on the transaction; the last one is the one that failed:&lt;/p&gt;

&lt;p&gt;SELECT entry_id FROM zimbra.directory WHERE UPPER(zimbra_id) = &apos;0F850D84-7096-4534-9389-9D85AFC17E8A&apos; AND entry_type = &apos;acct&apos;&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRACONTACTMAXNUMENTRIES&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraContactMaxNumEntries&apos;, &apos;0&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAPREFGALAUTOCOMPLETEENABLED&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraPrefGalAutoCompleteEnabled&apos;, &apos;FALSE&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAPREFMAILPOLLINGINTERVAL&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraPrefMailPollingInterval&apos;, &apos;5m&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAPREFGROUPMAILBY&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraPrefGroupMailBy&apos;, &apos;conversation&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAFEATUREVIEWINHTMLENABLED&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraFeatureViewInHtmlEnabled&apos;, &apos;TRUE&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAPREFMESSAGEVIEWHTMLPREFERRED&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraPrefMessageViewHtmlPreferred&apos;, &apos;TRUE&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAPREFREADINGPANEENABLED&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraPrefReadingPaneEnabled&apos;, &apos;TRUE&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAFEATUREGALAUTOCOMPLETEENABLED&apos;&lt;br/&gt;
INSERT INTO zimbra.directory_attrs (entry_id, name, value) VALUES (8, &apos;zimbraFeatureGalAutoCompleteEnabled&apos;, &apos;TRUE&apos;)&lt;br/&gt;
DELETE FROM zimbra.directory_attrs WHERE entry_id = 8 AND UPPER(name) = &apos;ZIMBRAPREFCALENDARUSEQUICKADD&apos;&lt;/p&gt;


&lt;p&gt;Here&apos;s the stack trace:&lt;/p&gt;

&lt;p&gt;Caused by: java.sql.SQLException: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:89)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:100)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.javaException(Util.java:219)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:386)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:345)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:1378)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1272)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1635)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:299)&lt;br/&gt;
	at org.apache.commons.dbcp.DelegatingPreparedStatement.executeUpdate(DelegatingPreparedStatement.java:233)&lt;br/&gt;
	at com.zimbra.cs.db.DebugPreparedStatement.executeUpdate(DebugPreparedStatement.java:154)&lt;/p&gt;


&lt;p&gt;And here&apos;s the schema:&lt;/p&gt;

&lt;p&gt;CREATE TABLE directory (&lt;br/&gt;
   entry_id    INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,&lt;br/&gt;
   entry_type  CHAR(4) NOT NULL,&lt;br/&gt;
   entry_name  VARCHAR(128) NOT NULL,&lt;br/&gt;
   zimbra_id   CHAR(36),&lt;br/&gt;
   modified    SMALLINT NOT NULL&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;CREATE UNIQUE INDEX i_directory_zimbra_id ON directory(zimbra_id);&lt;br/&gt;
CREATE UNIQUE INDEX i_directory_entry_type_name ON directory(entry_type, entry_name);&lt;/p&gt;


&lt;p&gt;CREATE TABLE directory_attrs (&lt;br/&gt;
   entry_id    INTEGER NOT NULL,&lt;br/&gt;
   name        VARCHAR(255) NOT NULL,&lt;br/&gt;
   value       VARCHAR(10240) NOT NULL,&lt;/p&gt;

&lt;p&gt;   CONSTRAINT fk_dattr_entry_id FOREIGN KEY (entry_id) REFERENCES directory(entry_id)&lt;br/&gt;
      ON DELETE CASCADE&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;CREATE INDEX i_dattr_entry_id_name ON directory_attrs(entry_id, name);&lt;br/&gt;
CREATE INDEX i_dattr_name ON directory_attrs(name);&lt;/p&gt;</description>
                <environment>Seen on both Windows XP and Mac OS X 10.4</environment>
        <key id="12363089">DERBY-2353</key>
            <summary>intermittent NPEs during DELETE ops in a reasonably large transaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="dkarp">Dan Karp</reporter>
                        <labels>
                    </labels>
                <created>Sat, 17 Feb 2007 20:50:31 +0000</created>
                <updated>Fri, 21 Jan 2011 17:49:47 +0000</updated>
                            <resolved>Fri, 10 Apr 2009 14:28:26 +0100</resolved>
                                    <version>10.2.2.0</version>
                                    <fixVersion>10.5.1.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12474388" author="knutanders" created="Tue, 20 Feb 2007 09:46:11 +0000"  >&lt;p&gt;The stack trace doesn&apos;t provide very much information. Derby doesn&apos;t use initCause() or setStackTrace() on the exceptions because they are not available in Java 1.3, so the stack trace of the original exception is not shown. However, Derby&apos;s SQLException overrides printStackTrace() so that it prints the stack trace of the original exception (in this case the NullPointerException). If you could get a reference to the SQLException (invoke getCause() on your exception until you get the SQLException) and call printStackTrace() on that object, the stack trace of the NullPointerException would be printed. It is also possible that you will find the original stack trace in derby.log. Sorry for the inconvenience.&lt;/p&gt;</comment>
                            <comment id="12474606" author="dkarp" created="Tue, 20 Feb 2007 23:16:11 +0000"  >&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NoRowsResultSetImpl.finish(NoRowsResultSetImpl.java:410)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DeleteResultSet.finish(DeleteResultSet.java:650)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BaseActivation.close(BaseActivation.java:407)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:305)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:356)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1182)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1635)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:299)&lt;br/&gt;
	at org.apache.commons.dbcp.DelegatingPreparedStatement.executeUpdate(DelegatingPreparedStatement.java:233)&lt;br/&gt;
	at com.zimbra.cs.db.DebugPreparedStatement.executeUpdate(DebugPreparedStatement.java:154)&lt;/p&gt;</comment>
                            <comment id="12474650" author="knutanders" created="Wed, 21 Feb 2007 07:04:26 +0000"  >&lt;p&gt;Thanks for posting the complete stack trace! The NPE is thrown in some code that is only executed when the derby.language.logQueryPlan property is true. You might be able to work around this bug by disabling the logging of query plans.&lt;/p&gt;</comment>
                            <comment id="12482310" author="jjzhuang" created="Tue, 20 Mar 2007 05:19:12 +0000"  >&lt;p&gt;I still see it after I disabled derby logging.  The way I disabled logging is by setting system property &quot;derby.stream.error.method&quot; to a stub class.  That got rid of the derby.log output.&lt;/p&gt;

&lt;p&gt;Is there another logging mechanism I need to disable in order to workaround the NPE?  Thanks!&lt;/p&gt;</comment>
                            <comment id="12483054" author="kristwaa" created="Thu, 22 Mar 2007 08:23:18 +0000"  >&lt;p&gt;I don&apos;t think setting &apos;derby.stream.error.method&apos; actually disables logging, it just creates a &quot;black hole&quot; for all the logging output.&lt;br/&gt;
You should make sure &apos;derby.language.logQueryPlan&apos; is set to false, and also &apos;derby.language.logStatementText&apos; as well. You can keep the &apos;derby.stream.error.method&apos; if you want to get rid of derby.log, or you can remove it and check what is written to the log.&lt;/p&gt;

&lt;p&gt;If you still get the error, it would help to see your derby.properties file and also what is printed to derby.log.&lt;/p&gt;</comment>
                            <comment id="12566212" author="kmarsden" created="Wed, 6 Feb 2008 17:22:34 +0000"  >&lt;p&gt;I wonder if this issue still occurs. I noticed the code in question has been rearranged quite a bit.  I am curious to know if the NPE still occurrs and if so what is the new stack trace?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12611326" author="kmarsden" created="Mon, 7 Jul 2008 21:28:03 +0100"  >&lt;p&gt;No response since inquiry in Feb 2008.  Closing CNR. This can be reopened if it is still an issue.&lt;/p&gt;</comment>
                            <comment id="12668472" author="knutanders" created="Thu, 29 Jan 2009 13:53:21 +0000"  >&lt;p&gt;A repro was posted on derby-user: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/200901.mbox/%3c21725256.post@talk.nabble.com%3e&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/200901.mbox/%3c21725256.post@talk.nabble.com%3e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Note that you need to set derby.language.logQueryPlan=true in order to reproduce the NPE.&lt;/p&gt;</comment>
                            <comment id="12668492" author="bryanpendleton" created="Thu, 29 Jan 2009 14:59:37 +0000"  >&lt;p&gt;See also &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3091&quot; title=&quot;NullPointerException executing SYSCS_UTIL.SYSCS_IMPORT_TABLE when derby.language.logQueryPlan=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3091&quot;&gt;&lt;del&gt;DERBY-3091&lt;/del&gt;&lt;/a&gt;, which has a similar mystery NPE&lt;br/&gt;
related to logQueryPlan=true. Perhaps that issue was also&lt;br/&gt;
prematurely resolved?&lt;/p&gt;</comment>
                            <comment id="12669613" author="knutanders" created="Mon, 2 Feb 2009 14:39:11 +0000"  >&lt;p&gt;I think the problem may be that the NoRowsResultSet family of ResultSets doesn&apos;t know which ResultSet is the top-level ResultSet. NoPutResultSetImpl.close() makes sure that some code is only executed for the top node: printing of query plan and closing of activation for single-execution statements. NoRowsResultSetImpl.close() executes that code for all ResultSets.&lt;/p&gt;

&lt;p&gt;So here&apos;s what seems to be happening (using the repro from the derby-user thread): When close() is called on the top-level DeleteCascadeResultSet, it prints the query plan and closes the activation. Later the close() method of the child DeleteCascadeResultSet is called (the one that&apos;s performing the cascading delete), and because the activation is closed, the RuntimeStatistics object is null and we get the NPE when we try to print the query plan.&lt;/p&gt;

&lt;p&gt;Note that the activation is only closed by the ResultSet&apos;s close() method if it&apos;s a single-execution activation. This means that we won&apos;t see the problem if we&apos;re using prepared statements, as they are not single-execution. I verified this by replacing the following line in the repro script:&lt;/p&gt;

&lt;p&gt;delete from collectives;&lt;/p&gt;

&lt;p&gt;with&lt;/p&gt;

&lt;p&gt;prepare p as &apos;delete from collectives&apos;;&lt;br/&gt;
execute p;&lt;/p&gt;

&lt;p&gt;and then the statement didn&apos;t throw an exception.&lt;/p&gt;

&lt;p&gt;I guess we could fix it along these lines:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;make sure that the child DeleteCascadeResultSets don&apos;t close the activation&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;make sure DeleteCascadeResultSet.cleanUp() cleans up the child ResultSets before it calls super.cleanUp() (which ends up calling close() and closing the activation). Right now it closes itself first and then its children.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12669646" author="kmarsden" created="Mon, 2 Feb 2009 16:22:21 +0000"  >&lt;p&gt;This issue and possible dup DERBY_4043 seem to have been hit by quite a few users, marking it High Value.&lt;/p&gt;</comment>
                            <comment id="12697583" author="knutanders" created="Thu, 9 Apr 2009 19:03:46 +0100"  >&lt;p&gt;Here&apos;s a simple fix for the issue (patch file d2353.diff). The patch just adds an extra check for activation.isClosed() and skips printing the query plan if the activation has been closed. This means that if the top-level result set closes the activation, the child result sets won&apos;t print their own query plans. However, all that information is already printed by the parent, so there&apos;s no need to print it again by the children.&lt;/p&gt;

&lt;p&gt;The patch also has a test case that fails with a NullPointerException without the fix.&lt;/p&gt;

&lt;p&gt;Running the regression tests now.&lt;/p&gt;</comment>
                            <comment id="12697782" author="knutanders" created="Fri, 10 Apr 2009 11:23:14 +0100"  >&lt;p&gt;(Commenting via mail. JIRA is down so it&apos;s not possible to update the&lt;br/&gt;
status of the issue at the moment.)&lt;/p&gt;

&lt;p&gt;The regression tests passed, and I committed the patch to trunk&lt;br/&gt;
(revision 763900) and to 10.5 (revision 763901).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12413699">DERBY-4043</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12379213">DERBY-3091</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12405087" name="d2353.diff" size="5081" author="knutanders" created="Thu, 9 Apr 2009 19:03:46 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 20 Feb 2007 09:46:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23015</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0mnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37489</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>