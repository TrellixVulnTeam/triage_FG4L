<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:43:20 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5954/DERBY-5954.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5954] NPE in SELECT involving subselects and windows functions</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5954</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A user reports and I have verified an NPE on the following SELECT:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create table blah ( a int );&lt;br/&gt;
insert into blah values (1), (2), (3), (4), (5), (6), (7);&lt;/p&gt;

&lt;p&gt;SELECT rn, (SELECT rn FROM (SELECT row_number() over() rn FROM blah ) as T2&lt;br/&gt;
where T2.rn = T1.rn+1) rn2&lt;br/&gt;
FROM (SELECT row_number() over() rn from blah) as T1;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12612225">DERBY-5954</key>
            <summary>NPE in SELECT involving subselects and windows functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Oct 2012 14:40:15 +0100</created>
                <updated>Sun, 25 Nov 2012 20:14:47 +0000</updated>
                            <resolved>Tue, 6 Nov 2012 18:56:21 +0000</resolved>
                                    <version>10.6.1.0</version>
                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                    <version>10.8.2.2</version>
                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.3.3</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13477957" author="rhillegas" created="Wed, 17 Oct 2012 16:31:59 +0100"  >&lt;p&gt;The user reports:&lt;/p&gt;

&lt;p&gt;&quot;NOTE:&lt;/p&gt;

&lt;p&gt;I have tested this with Derby 10.5, 10.8 and 10.9&lt;/p&gt;

&lt;p&gt;The queries &lt;b&gt;work with Derby 10.5&lt;/b&gt; ; but fail with 10.8 and 10.9&quot;&lt;/p&gt;</comment>
                            <comment id="13478367" author="myrna" created="Wed, 17 Oct 2012 21:56:46 +0100"  >&lt;p&gt;This was on the following thread: &lt;a href=&quot;http://old.nabble.com/Nested-SELECT-in-selected-columns-list-causes-NullPointerException-if-it-references-ROW_NUMBER%28%29-OVER%28%29-function-td34567925.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://old.nabble.com/Nested-SELECT-in-selected-columns-list-causes-NullPointerException-if-it-references-ROW_NUMBER%28%29-OVER%28%29-function-td34567925.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13479089" author="dagw" created="Thu, 18 Oct 2012 16:48:19 +0100"  >&lt;p&gt;This query with only one row_number causes an assert with the debug build:&lt;/p&gt;

&lt;p&gt;SELECT rn_t1, ( &lt;br/&gt;
     SELECT rn_t2 FROM ( &lt;br/&gt;
         SELECT row_number() over() as rn_t2 FROM derby5954)  &lt;br/&gt;
         as T2&lt;br/&gt;
         where T2.rn_t2 = T1.rn_t1)  &lt;br/&gt;
     as rn_outer &lt;br/&gt;
     FROM (SELECT a as rn_t1 from derby5954) as T1&quot;)&lt;/p&gt;


&lt;p&gt;Caused by: org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED sourceResultSetNumber expected to be &amp;gt;= 0 for virtual column RN_T2&lt;br/&gt;
	at org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:120)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.VirtualColumnNode.generateExpression(VirtualColumnNode.java:231)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ResultColumn.generateExpression(ResultColumn.java:1059)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ResultColumnList.generateCore(ResultColumnList.java:1426)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(ProjectRestrictNode.java:1557)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(ProjectRestrictNode.java:1337)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.WindowResultSetNode.generate(WindowResultSetNode.java:409)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(ProjectRestrictNode.java:1482)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(ProjectRestrictNode.java:1337)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ScrollInsensitiveResultSetNode.generate(ScrollInsensitiveResultSetNode.java:109)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.CursorNode.generate(CursorNode.java:641)&lt;/p&gt;

&lt;p&gt;Interestingly, a similar query without row_number, gives a wrong result; i think:&lt;/p&gt;

&lt;p&gt;SELECT a_t1, ( &lt;br/&gt;
     SELECT a_t2 FROM ( &lt;br/&gt;
         SELECT a as a_t2 FROM derby5954)  &lt;br/&gt;
         as T2&lt;br/&gt;
         where T2.a_t2 = T1.a_t1 + 1  )  &lt;br/&gt;
     as a_outer &lt;br/&gt;
     FROM (SELECT a as a_t1 from derby5954) as T1&lt;/p&gt;

&lt;p&gt;gives:&lt;/p&gt;

&lt;p&gt;1 2&lt;br/&gt;
2 3&lt;br/&gt;
3 4&lt;br/&gt;
4 5&lt;br/&gt;
5 6&lt;br/&gt;
6 7&lt;br/&gt;
7 0&lt;/p&gt;

&lt;p&gt;In the last row, for the value of a=7, I think the scalar subquery in the select list should give &quot;null&quot;, not 0.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;#getInt, which will return 0 if the result column is NULL. So no error there.&quot;&gt;Update: The last above is misleading pilot error, the 0 comes from ResultSet#getInt, which will return 0 if the result column is NULL. So no error there.&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13480040" author="dagw" created="Fri, 19 Oct 2012 15:07:12 +0100"  >&lt;p&gt;Uploading patch derby-5954, which is a simple one-line patch that makes the row_number variants work, i.e.&lt;br/&gt;
it will work as &quot;well&quot; as the table select with similar nesting/correlated query above. &lt;/p&gt;

&lt;p&gt;The issue was the following: when looking for in-line window definitions in the select list, the visitor looked to deep: it should not move into subqueries in the select list. This error caused the query tree to become seriously garbled, hence the NPE and the assert seen.&lt;/p&gt;

&lt;p&gt;Still need to add a JUnit test, so not for commit yet.&lt;/p&gt;</comment>
                            <comment id="13480081" author="dagw" created="Fri, 19 Oct 2012 16:31:16 +0100"  >&lt;p&gt;Uploading the patch extended with a test case addition to OLAPTest. &lt;br/&gt;
Running regression, please review.&lt;/p&gt;</comment>
                            <comment id="13480462" author="dagw" created="Fri, 19 Oct 2012 23:28:45 +0100"  >&lt;p&gt;Regressions ran ok.&lt;/p&gt;</comment>
                            <comment id="13480526" author="bryanpendleton" created="Sat, 20 Oct 2012 00:39:16 +0100"  >&lt;p&gt;Thanks for working on this, Dag!&lt;/p&gt;

&lt;p&gt;The patch looks clear and straightforward.&lt;/p&gt;

&lt;p&gt;Just thinking abstractly, it seems like there are two different ways that the new&lt;br/&gt;
visitor code could be wrong:&lt;br/&gt;
1) It could fail to descend into a sub-query when in fact it should, or&lt;br/&gt;
2) It could descend into a sub-query that it shouldn&apos;t descend into.&lt;/p&gt;

&lt;p&gt;Trying to think more concretely, I wonder about the literal use of SelectNode&lt;br/&gt;
as the argument to the Visitor instance.&lt;/p&gt;

&lt;p&gt;What if, for example, there is a UNION in there; for example, what if we saw:&lt;/p&gt;

&lt;p&gt;SELECT rn_t1, ( &lt;br/&gt;
     SELECT rn_t2 FROM ( &lt;br/&gt;
         SELECT row_number() over() as rn_t2 FROM derby5954&lt;br/&gt;
                      UNION&lt;br/&gt;
          SELECT somecolumn FROM sometable) &lt;br/&gt;
         as T2 &lt;br/&gt;
         where T2.rn_t2 = T1.rn_t1) &lt;br/&gt;
     as rn_outer &lt;br/&gt;
     FROM (SELECT a as rn_t1 from derby5954) as T1&quot;) &lt;/p&gt;

&lt;p&gt;I&apos;m not even sure that what I&apos;m typing is syntactically valid; I&apos;m just trying&lt;br/&gt;
to inspire some other test cases that might be revealing.&lt;/p&gt;</comment>
                            <comment id="13482844" author="bryanpendleton" created="Wed, 24 Oct 2012 01:03:23 +0100"  >&lt;p&gt;To be clear:  I have no objections to moving forward with the proposed patch&lt;/p&gt;

&lt;p&gt;We could continue to try to add other ROW_NUMBER tests and window tests&lt;br/&gt;
as part of separate efforts in separate JIRA issues.&lt;/p&gt;</comment>
                            <comment id="13486181" author="kmarsden" created="Mon, 29 Oct 2012 17:33:42 +0000"  >&lt;p&gt;I would really like this fix in 10.8.3 and think it would be worthwhile to hold up the release up to another week as this is a regression and a fix needed by a user in 10.8 but Bryan&apos;s comments seem serious:&lt;/p&gt;

&lt;p&gt;&quot;Just thinking abstractly, it seems like there are two different ways that the new&lt;br/&gt;
visitor code could be wrong:&lt;br/&gt;
1) It could fail to descend into a sub-query when in fact it should, or&lt;br/&gt;
2) It could descend into a sub-query that it shouldn&apos;t descend into.&quot;&lt;/p&gt;


&lt;p&gt;Bryan, do you think the patch might potentially cause a  different regression?  Dag, what are your thoughts on this?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="13491597" author="dagw" created="Tue, 6 Nov 2012 16:42:50 +0000"  >&lt;p&gt;I&apos;ll try to explain why I believe the changed code is correct. Sorry for answering late, I have been out for a while.&lt;br/&gt;
What we are looking for here is any &quot;&amp;lt;in-line window specification&amp;gt;&quot; in the sense of SQL 2003 section 6.10 &quot;Window Function&quot; contained in a select list (syntax rule 3b). The meaning of the in-line window specification is described in Syntax Rule 7-9 of section 6.10.&lt;br/&gt;
Pertinent quote (simplified):&lt;/p&gt;

&lt;p&gt;7) Let SL be the &amp;lt;select list&amp;gt; that simply contains&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; OF (the window function)&lt;br/&gt;
8d) Let SLNEW be the &amp;lt;select list&amp;gt; that is obtained from SL by replacing OF by:&lt;br/&gt;
     OFT OVER WSN (where WSN is an equivalent synthesized window on the table expression TE)&lt;br/&gt;
Rule 9 f) and g) describes how our in-lined window is transformed to be appended to any existing windows for the table expression.&lt;/p&gt;

&lt;p&gt;Now, earlier, we found window functions &lt;b&gt;not&lt;/b&gt; simply contained in the SL, i.e. inside a nested SELECT since the visitor went to deep. The in-lined window specification properly belonged at the level of that nested SELECT&apos;s table expression.&lt;/p&gt;

&lt;p&gt;So, Bryan&apos;s Criterion 1) is satisfied, in that the visitor previously visited &lt;b&gt;all&lt;/b&gt; nodes contained in the select list.&lt;br/&gt;
After the change we do not visit nodes &lt;b&gt;under&lt;/b&gt; a simply contained (nested) SELECT statement. But that is OK, since any OF previously (erroneously) found there are not *simply contained in the outer SL.&lt;/p&gt;

&lt;p&gt;So 1) holds I believe. Now, as for 2) could we (still) be descending into any subquery we should not (we obviously did before)?&lt;br/&gt;
That would need to be in a case where we had some legal syntax in the select list (SL) containing in-lined window specification &lt;b&gt;not&lt;/b&gt; inside a SELECT node. Can that happen? Well, besides SELECT we can have a VALUES subquery in a SELECT list. But we forbid window functions inside a VALUES subquery, cf. this line in RowResultSetNode#bindExpressions:&lt;/p&gt;

&lt;p&gt;SelectNode.checkNoWindowFunctions(resultColumns, &quot;VALUES&quot;);&lt;/p&gt;

&lt;p&gt;So, since we now forbid the visitor to descend into nested SELECTs and any nested VALUES are innocuous, we can not find any &quot;wrong&quot; in-lined window function. So 2) also holds.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; A1 simply contains B1 if A1 contains B1 without an intervening instance of &amp;lt;A&amp;gt; or an intervening instance of&lt;br/&gt;
&amp;lt;B&amp;gt;.&lt;/p&gt;

&lt;p&gt;Makes sense?&lt;/p&gt;</comment>
                            <comment id="13491640" author="dagw" created="Tue, 6 Nov 2012 17:38:25 +0000"  >&lt;p&gt;Uploading &quot;derby-5954-with-test-2&quot;, which improves on the comment next to the change.&lt;/p&gt;</comment>
                            <comment id="13491644" author="dagw" created="Tue, 6 Nov 2012 17:43:52 +0000"  >&lt;p&gt;Committed patch &quot;derby-5954-with-test-2&quot; as svn 1406240, resolving. I plan to backport this change so please do not close this issue yet.&lt;/p&gt;</comment>
                            <comment id="13491664" author="dagw" created="Tue, 6 Nov 2012 18:05:21 +0000"  >&lt;p&gt;Backported to 10.9 as svn 1406247 and to 10.8 as svn 1406254. It should be possible to backport this all the way to 10.6, but I stop at 10.8 now. Feel free to close, Rick.&lt;/p&gt;</comment>
                            <comment id="13491688" author="rhillegas" created="Tue, 6 Nov 2012 18:34:28 +0000"  >&lt;p&gt;Closing. Thanks, Dag.&lt;/p&gt;</comment>
                            <comment id="13491708" author="dagw" created="Tue, 6 Nov 2012 18:55:18 +0000"  >&lt;p&gt;Opps, forgot to set all Fixed in items, reopening to do that&lt;/p&gt;</comment>
                            <comment id="13492904" author="bryanpendleton" created="Thu, 8 Nov 2012 02:35:42 +0000"  >&lt;p&gt;Dag, thanks for working through the reasoning with us. It helps me to understand your&lt;br/&gt;
thinking, and describing it as you did will also help future students of the code who&lt;br/&gt;
are trying to understand its behavior. It is much appreciated!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12612684">DERBY-5957</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12552315" name="derby-5954-with-test-2.diff" size="2207" author="dagw" created="Tue, 6 Nov 2012 17:38:25 +0000"/>
                            <attachment id="12552316" name="derby-5954-with-test-2.stat" size="154" author="dagw" created="Tue, 6 Nov 2012 17:38:25 +0000"/>
                            <attachment id="12549993" name="derby-5954-with-test.diff" size="1894" author="dagw" created="Fri, 19 Oct 2012 16:31:16 +0100"/>
                            <attachment id="12549992" name="derby-5954-with-test.stat" size="154" author="dagw" created="Fri, 19 Oct 2012 16:31:16 +0100"/>
                            <attachment id="12549982" name="derby-5954.diff" size="658" author="dagw" created="Fri, 19 Oct 2012 15:09:51 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 17 Oct 2012 20:56:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249299</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4187:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57355</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>