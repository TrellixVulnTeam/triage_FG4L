<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:24:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5395/DERBY-5395.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5395] By default, only the DBO should be allowed to run several of the diagnostic VTIs.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5395</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Only the DBO should be allowed to run the following VTIs:&lt;/p&gt;

&lt;p&gt;  syscs_diag.statement_cache&lt;br/&gt;
  syscs_diag.transaction_table&lt;br/&gt;
  syscs_diag.error_log_reader( )&lt;br/&gt;
  syscs_diag.statement_duration()&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12520580">DERBY-5395</key>
            <summary>By default, only the DBO should be allowed to run several of the diagnostic VTIs.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Aug 2011 16:03:25 +0100</created>
                <updated>Thu, 2 May 2013 03:29:44 +0100</updated>
                            <resolved>Fri, 2 Sep 2011 15:37:06 +0100</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.2.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13093089" author="rhillegas" created="Mon, 29 Aug 2011 19:58:49 +0100"  >&lt;p&gt;I can imagine two approaches to fixing this issue:&lt;/p&gt;

&lt;p&gt;1) Easy but inflexible &amp;#8211; In this approach, Derby would raise an error if someone other than the DBO tried to use these VTIs. For instance, the constructors for the underlying VTIs could raise an error if the current user wasn&apos;t the DBO. This could be implemented for the 10.8.2 maintenance release and could be backported to older branches. However, it would not be possible to grant other users SELECT privilege on statement_cache and transaction_table and it would not be possible to grant other users EXECUTE privilege on error_log_reader() and statement_duration().&lt;/p&gt;

&lt;p&gt;2) Involved but flexible &amp;#8211; In this approach, we would re-model these vtis as table functions. The error_log_reader and statement_duration vtis would be re-modelled as table functions and statement_cache and transaction_table would be remodelled as views on table functions. Corresponding metadata tuples would be stuffed into SYSALIASES, SYSVIEWS, and SYSTABLEPERMS. This would let the DBO grant EXECUTE privilege on the table functions. However, the metadata changes would mean that we could not implement this solution in a maintenance release like 10.8.2. and we could not backport the fix to older branches.&lt;/p&gt;

&lt;p&gt;I am leaning toward an incremental, hybrid approach: implement (1) in the 10.8.2 timeframe, close this issue, and create a new issue for the work on (2). I would be happy to do (1). We could consider implementing (2) if users clamor for it.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13094023" author="rhillegas" created="Tue, 30 Aug 2011 20:32:31 +0100"  >&lt;p&gt;Attaching derby-5395-01-ac-protectVTIs.diff. This patch implements approach (1), raising an error at instantiation time if these VTIs are invoked by someone other than the DBO when authorization is turned on. I have written a regression test but need to run the full suite.&lt;/p&gt;

&lt;p&gt;The regression test I wrote for this fix revealed that the StatementDuration and ErrorLogReader VTIs were reading a system property outside a privileged block. I wrapped those reads in a privileged block as part of this patch.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-------------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/loc/messages.xml&lt;br/&gt;
M      java/shared/org/apache/derby/shared/common/reference/SQLState.java&lt;br/&gt;
A      java/engine/org/apache/derby/diag/DiagUtil.java&lt;/p&gt;

&lt;p&gt;Logic to raise an exception if authorization is enabled and the current user isn&apos;t a DBO.&lt;/p&gt;

&lt;p&gt;-------------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/diag/StatementCache.java&lt;br/&gt;
M      java/engine/org/apache/derby/diag/StatementDuration.java&lt;br/&gt;
M      java/engine/org/apache/derby/diag/TransactionTable.java&lt;br/&gt;
M      java/engine/org/apache/derby/diag/ErrorLogReader.java&lt;/p&gt;

&lt;p&gt;Wires that check into the VTI constructors.&lt;/p&gt;

&lt;p&gt;-------------------&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/_Suite.java&lt;br/&gt;
A      java/testing/org/apache/derbyTesting/functionTests/tests/lang/DBOAccessTest.java&lt;/p&gt;

&lt;p&gt;New regression test for this behavior.&lt;/p&gt;</comment>
                            <comment id="13094765" author="rhillegas" created="Wed, 31 Aug 2011 19:37:03 +0100"  >&lt;p&gt;Attaching SafeCacheViewer.java. This is a table function which selects the safe columns from the statement cache vti. If the DBO registers this table function with definer&apos;s rights and grants EXECUTE privilege to PUBLIC, then anyone can view the safe columns of the statement cache. This technique can be used to grant other users privilege to view the safe bits of the diagnostic vtis whose access will be controlled when the patch is committed. Here&apos;s a script which shows this technique in action:&lt;/p&gt;

&lt;p&gt;ij version 10.9&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=true;user=test_dbo;password=test_dbopassword&apos; as admin_conn;&lt;br/&gt;
ij&amp;gt; create function safeCacheViewer()&lt;br/&gt;
returns table&lt;br/&gt;
(&lt;br/&gt;
    id char( 36 ),&lt;br/&gt;
    schemaName varchar( 128 ),&lt;br/&gt;
    valid boolean,&lt;br/&gt;
    compiled_at timestamp&lt;br/&gt;
)&lt;br/&gt;
language java parameter style derby_jdbc_result_set reads sql data&lt;br/&gt;
external security definer&lt;br/&gt;
external name &apos;SafeCacheViewer.safeCacheViewer&apos;;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; grant execute on function safeCacheViewer to public;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:memory:db;user=ruth;password=ruthpassword&apos; as ruth_conn;&lt;br/&gt;
ij(RUTH_CONN)&amp;gt; &amp;#8211; fails permissions hurdle&lt;br/&gt;
select * from syscs_diag.statement_cache;&lt;br/&gt;
ERROR 4251D: Only the database owner can view this data.&lt;br/&gt;
ij(RUTH_CONN)&amp;gt; &amp;#8211; succeeds&lt;br/&gt;
select * from table( test_dbo.safeCacheViewer() ) s;&lt;br/&gt;
ID                                  |SCHEMANAME                                                                                                                      |VALID|COMPILED_AT                  &lt;br/&gt;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
ace4c0a3-0132-211b-dc8c-0000042be988|RUTH                                                                                                                            |true |NULL                         &lt;br/&gt;
4d3680a5-0132-211b-dc8c-0000042be988|TEST_DBO                                                                                                                        |true |NULL                         &lt;br/&gt;
341cc09e-0132-211b-dc8c-0000042be988|TEST_DBO                                                                                                                        |true |NULL                         &lt;br/&gt;
0b5b0099-0132-211b-dc8c-0000042be988|TEST_DBO                                                                                                                        |true |NULL                         &lt;/p&gt;

&lt;p&gt;4 rows selected&lt;/p&gt;</comment>
                            <comment id="13094777" author="rhillegas" created="Wed, 31 Aug 2011 19:48:33 +0100"  >&lt;p&gt;Regression tests passed cleanly for me on derby-5395-01-ac-protectVTIs.diff. Committed at subversion revision 1163740.&lt;/p&gt;</comment>
                            <comment id="13094854" author="rhillegas" created="Wed, 31 Aug 2011 21:03:55 +0100"  >&lt;p&gt;Attaching the first rev of a release note for this issue.&lt;/p&gt;</comment>
                            <comment id="13095564" author="rhillegas" created="Thu, 1 Sep 2011 20:57:26 +0100"  >&lt;p&gt;Ported 1163740 to the following branches:&lt;/p&gt;

&lt;p&gt;  10.8 at subversion revision 1164198&lt;/p&gt;

&lt;p&gt;  10.7 at subversion revision 1164200&lt;/p&gt;

&lt;p&gt;  10.6 at subversion revision 1164214&lt;/p&gt;

&lt;p&gt;  10.5 at subversion revision 1164225&lt;/p&gt;

&lt;p&gt;I did not backport this fix further than 10.5 because it became difficult to reconcile the newly added test with the old test machinery.&lt;/p&gt;</comment>
                            <comment id="13096014" author="rhillegas" created="Fri, 2 Sep 2011 15:37:06 +0100"  >&lt;p&gt;The simple solution has been ported as far back as the 10.5 branch. I do not intend to do any more work on this issue. I will create a related issue in case someone wants to implement the more complicated solution.&lt;/p&gt;</comment>
                            <comment id="13099107" author="chaase3" created="Wed, 7 Sep 2011 18:12:21 +0100"  >&lt;p&gt;I believe the Reference Manual topic &quot;SYSCS_DIAG diagnostic tables and functions&quot; should be updated to include this new information for the four functions named in this issue. I&apos;ll file a JIRA for this. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12521192">DERBY-5399</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12521624">DERBY-5404</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12492499" name="SafeCacheViewer.java" size="402" author="rhillegas" created="Wed, 31 Aug 2011 19:37:03 +0100"/>
                            <attachment id="12492286" name="derby-5395-01-ac-protectVTIs.diff" size="10978" author="rhillegas" created="Tue, 30 Aug 2011 20:32:30 +0100"/>
                            <attachment id="12492517" name="releaseNote.html" size="4715" author="rhillegas" created="Wed, 31 Aug 2011 21:03:54 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 7 Sep 2011 17:12:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24815</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0exz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36239</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>