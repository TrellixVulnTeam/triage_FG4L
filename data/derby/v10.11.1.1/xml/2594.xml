<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:34:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2594/DERBY-2594.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2594] Revoking a privilege from an SQL Object should invalidate statements dependent on that object</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2594</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Revoking a privilege on a table will currently cause the DependencyManager.invalidateFor() to be called on the table&apos;s TablePermsDescriptor with the action=REVOKE_PRIVILEGE. However, the prepared statements that refer to that table are dependents of the table&apos;s TableDescriptor, but NOT its TablePermsDescriptor, so the statements are not invalidated after revoke.&lt;/p&gt;

&lt;p&gt;This problem is currently hidden by the fact that authorization is checked on every execution, but this will change when language result sets are no longer reused (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-827&quot; title=&quot;Performance can be improved by re-using language ResultSets across Activation executions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-827&quot;&gt;&lt;del&gt;DERBY-827&lt;/del&gt;&lt;/a&gt;). &lt;/p&gt;</description>
                <environment></environment>
        <key id="12368116">DERBY-2594</key>
            <summary>Revoking a privilege from an SQL Object should invalidate statements dependent on that object</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dyret">Dyre Tjeldvoll</assignee>
                                    <reporter username="dyret">Dyre Tjeldvoll</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Apr 2007 12:35:25 +0100</created>
                <updated>Tue, 8 Jul 2008 14:23:24 +0100</updated>
                            <resolved>Mon, 21 May 2007 11:42:32 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12491986" author="dyret" created="Thu, 26 Apr 2007 13:25:35 +0100"  >&lt;p&gt;There is a typo in the description. The last sentence should read &quot;...this will change when language result sets are reused&quot;.&lt;/p&gt;

&lt;p&gt;As an initial experiment I&apos;ve tried to modify DependencyManager.invalidateFor() so that it detects when REVOKE_PRIVILEGE is sent to a TablePermsDescriptor, and then adds an explicit call to invalidateFor() on the TableDescriptor:&lt;/p&gt;

&lt;p&gt;coreInvalidateFor(p, action, lcc);&lt;br/&gt;
                        if (p instanceof TablePermsDescriptor &amp;amp;&amp;amp; &lt;br/&gt;
                            action == DependencyManager.REVOKE_PRIVILEGE) {&lt;br/&gt;
                                final TablePermsDescriptor tpd = (TablePermsDescriptor) p;&lt;br/&gt;
                                final TableDescriptor td = dd.getTableDescriptor(tpd.getTableUUID());&lt;br/&gt;
                                coreInvalidateFor(td, DependencyManager.INTERNAL_RECOMPILE_REQUEST, lcc);&lt;/p&gt;

&lt;p&gt;But this fails with&lt;/p&gt;

&lt;p&gt;Caused by: java.sql.SQLException: Operation &apos;INTERNAL RECOMPILE REQUEST&apos; cannot be performed on object &apos;TSAT&apos; because VIEW &apos;V1&apos; is dependent on that object.&lt;/p&gt;</comment>
                            <comment id="12492026" author="djd" created="Thu, 26 Apr 2007 15:26:41 +0100"  >&lt;p&gt;I think this should be more generic than table, it should be for any SQL object, e.g.:&lt;/p&gt;

&lt;p&gt;Revoking a privilege from a (SQL) object should invalidate statements dependent on that object&lt;/p&gt;</comment>
                            <comment id="12492073" author="dyret" created="Thu, 26 Apr 2007 18:43:35 +0100"  >&lt;p&gt;My experimental change fails because a TableDescriptor can have&lt;br/&gt;
other Dependents besides GenericPreparedStatements. All possible&lt;br/&gt;
Dependents of TableDescriptor must be able to handle the action&lt;br/&gt;
being passed to them (the default is to trow an&lt;br/&gt;
exception). Passing on REVOKE_PRIVILEGE doesn&apos;t work because&lt;br/&gt;
that will cause views that depend on the TableDescriptor to be&lt;br/&gt;
dropped, and we will subsequently get a &apos;No such Table/View&apos;&lt;br/&gt;
error.&lt;/p&gt;

&lt;p&gt;I have now modified the experimental code to send a new&lt;br/&gt;
action (REVOKE_RECOMILE) to the TableDescriptor whenever the&lt;br/&gt;
TablePrivilegeInfo object sends a REVOKE_PRIVILEGE to the&lt;br/&gt;
TablePermsDescriptor. I have also extended ViewDescriptor and&lt;br/&gt;
SPSDescriptor and GenericPreparedStatement to handle the&lt;br/&gt;
REVOKE_RECOMILE action.&lt;/p&gt;

&lt;p&gt;With this hack I get lang.GrantRevokeDDLTest (The old&lt;br/&gt;
lang/grantRevokeDDL2.sql test that first revealed this problem&lt;br/&gt;
has been moved to JUnit) to pass with re-use of result sets and&lt;br/&gt;
without checking authorization on every execute.&lt;/p&gt;

&lt;p&gt;But I fear that this is the easy part. The real work is probably to: &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ensure that all SQL Objects for which a revoke will invalidate&lt;br/&gt;
  statements, actually have those statements as Dependents.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;That GrantRevokeCA actually calls DM.invalidateFor() on all&lt;br/&gt;
  relevant Providers (SQL object descriptors)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(Currently GrantRevokeCA can either refer to a&lt;br/&gt;
TablePrivilegeInfo, or a RoutinePrivilegeInfo. TablePrivilegeInfo&lt;br/&gt;
calls invalidateFor(TablePermsDescriptor, REVOKE_PRIVILEGE) and&lt;br/&gt;
RoutinePrivilegeInfo calls invalidateFor(RoutinePermsDescriptor,&lt;br/&gt;
REVOKE_PRIVILEGE_RESTRICT))&lt;/p&gt;</comment>
                            <comment id="12492079" author="djd" created="Thu, 26 Apr 2007 19:05:44 +0100"  >&lt;p&gt;Why is a new action required (REVOKE_RECOMPILE)?&lt;br/&gt;
Isn&apos;t the same amount of work to make other non GenericPreparedStatements dependents handle this as handling the existing INTERNAL_RECOMPILE_REQUEST notification?&lt;/p&gt;

&lt;p&gt;&amp;gt;. That GrantRevokeCA actually calls DM.invalidateFor() on all&lt;br/&gt;
  relevant Providers (SQL object descriptors) &lt;/p&gt;

&lt;p&gt;I think this is best handled in an OO approach, the TablePrivilege object  should be sending out the recompile invalidation on the table,&lt;br/&gt;
not the callers. Ie. when it is invalidated with a REVOKE, then it sends out a invalidate on the table with recompile. &lt;/p&gt;</comment>
                            <comment id="12492206" author="dyret" created="Fri, 27 Apr 2007 07:52:57 +0100"  >&lt;p&gt;It is quite possible that a new action isn&apos;t required. I wasn&apos;t&lt;br/&gt;
sure so I played it safe.&lt;/p&gt;

&lt;p&gt;I didn&apos;t mean to say that GrantRevokeConstantAction should call&lt;br/&gt;
invalidateFor directly (although it certainly could seem&lt;br/&gt;
so). Currently the stack looks like this:&lt;/p&gt;

&lt;p&gt;GrantRevokeConstantAction -&amp;gt; XPrivilegeInfo -&amp;gt; invalidateFor(XPermsDescriptor, ACTION)&lt;/p&gt;

&lt;p&gt;So we should add &lt;/p&gt;

&lt;p&gt;GrantRevokeConstantAction -&amp;gt; XPrivilegeInfo -&amp;gt; invalidateFor(XDescriptor, INTERNAL_COMPILE_REQUEST)&lt;/p&gt;

&lt;p&gt;?&lt;/p&gt;

&lt;p&gt;This will work for tables, but I haven&apos;t checked for&lt;br/&gt;
RoutinePermsDescriptor and RoutineDescriptor. That is, I haven&apos;t&lt;br/&gt;
verified that all statements that depend on a Routine actually&lt;br/&gt;
are Dependents of the RoutineDescr.&lt;/p&gt;</comment>
                            <comment id="12492283" author="dyret" created="Fri, 27 Apr 2007 13:53:54 +0100"  >&lt;p&gt;I&apos;ve attached a preliminary (as in not for commit)&lt;br/&gt;
) patch (revoke_prelim.diff) which implements this idea. It seems to be&lt;br/&gt;
working, in the sense that suites.All and derbyall pass, but I&lt;br/&gt;
don&apos;t know if the Routine stuff gets tested at all. But if the&lt;br/&gt;
basic idea is sound I can convert it into a real patch.&lt;/p&gt;</comment>
                            <comment id="12492867" author="dyret" created="Tue, 1 May 2007 13:13:15 +0100"  >&lt;p&gt;I added some trace to see what happens when a REVOKE is received&lt;br/&gt;
by RoutinePrivilegeInfo. I added the following to&lt;br/&gt;
BasicDependencyManager.coreInvalidate():&lt;/p&gt;

&lt;p&gt; @@ -300,6 +302,16 @@&lt;/p&gt;

&lt;p&gt;                                Dependent dep = dependency.getDependent();&lt;/p&gt;

&lt;p&gt;+                               if (p instanceof AliasDescriptor &amp;amp;&amp;amp; &lt;br/&gt;
+                                       action == INTERNAL_RECOMPILE_REQUEST &amp;amp;&amp;amp;&lt;br/&gt;
+                                       dep instanceof GenericPreparedStatement) &lt;/p&gt;
{
+                                       System.out.println
+                                               (&quot;REVOKE on &quot;+
+                                                ((AliasDescriptor)p).getObjectName()+
+                                                &quot; sends recompile to `&quot;+
+                                                ((GenericPreparedStatement)dep).statement.getSource()+&quot;&apos;&quot;);
+                               }
&lt;p&gt;+&lt;br/&gt;
                                if (affectedCols != null)&lt;/p&gt;

&lt;p&gt;Running lang.GrantRevokeDDLTest then produces the following output:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
REVOKE on F_ABS1 sends recompile to ` select * from v24&apos;&lt;br/&gt;
REVOKE on F_ABS1 sends recompile to ` create view v24 as select * from mamta1.v11&apos;&lt;br/&gt;
REVOKE on F_ABS1 sends recompile to ` select * from v11&apos;&lt;br/&gt;
REVOKE on F_ABS1 sends recompile to ` create view v11(c111) as values mamta1.f_abs1(-5)&apos;&lt;br/&gt;
REVOKE on F_ABS1 sends recompile to ` values f_abs1(-5)&apos;&lt;br/&gt;
REVOKE on SELECTFROMSPECIFICSCHEMA sends recompile to `revoke execute on function selectFromSpecificSchema from mamta3 restrict&apos;&lt;br/&gt;
REVOKE on SELECTFROMSPECIFICSCHEMA sends recompile to ` grant execute on function selectFromSpecificSchema to mamta3&apos;&lt;br/&gt;
REVOKE on F_ABS sends recompile to ` revoke execute on function f_abs from randy restrict&apos;&lt;br/&gt;
REVOKE on F_ABS sends recompile to ` grant execute on function f_abs to randy&apos;&lt;br/&gt;
REVOKE on F_ABS2 sends recompile to `revoke execute on function F_ABS2 from user2 restrict&apos;&lt;br/&gt;
REVOKE on F_ABS2 sends recompile to `grant execute on function F_ABS2 to user2&apos;&lt;br/&gt;
REVOKE on F_ABS2 sends recompile to `values user1.F_ABS1(10) + user1.F_ABS2(-10)&apos;&lt;br/&gt;
REVOKE on F_ABS1 sends recompile to ` revoke execute on function F_ABS1 from user2 restrict&apos;&lt;br/&gt;
REVOKE on F_ABS1 sends recompile to `values user1.F_ABS1(-8)&apos;&lt;/p&gt;


&lt;p&gt;which looks correct to me. So unless I hear otherwise, I&apos;ll start&lt;br/&gt;
making my preliminary patch ready for commit.&lt;/p&gt;</comment>
                            <comment id="12492897" author="bryanpendleton" created="Tue, 1 May 2007 16:42:28 +0100"  >&lt;p&gt;This tracing seems very useful, too &amp;#8211; can you include it as part of your patch?&lt;/p&gt;</comment>
                            <comment id="12492954" author="dyret" created="Tue, 1 May 2007 22:29:31 +0100"  >&lt;p&gt;Hi Bryan, I&apos;m glad you think it is useful. I guess I could include it, but there are some caveats:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Currently the trace is printed unconditionally. If it was to be committed I think I would have to put some SanityManager magic around it so that you only got this trace when setting a certain property (value).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The change I have shown above is not very general and makes use of &quot;bad&quot; downcasts that in turn requires the import of files the DependencyManager ideally shouldn&apos;t have to know about.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The DependencyManager already has a method called dumpDependencies() (or similar) which prints all the dependencies. I tried using that method but it generates so much output that it becomes really hard to find what you&apos;re looking for (especially if you call this method more than once). Part of the problem is that it relies on the Provider&apos;s and Dependent&apos;s toString() methods, which (for good reasons) generate far more output than is typically desired when looking at dependencies (in the case of GPSs it actually generates too little, only the UUID).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ideally the Provider and Dependent interfaces should provide a describe method that would give the right amount of info for printing dependencies. That way the DependencyManager itself would not have to downcast to the exact types. It would also be good to have the ability to filter out the subset of dependencies that you were interested in.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Finally I believe I have seen in another Jira that Dan would like to re-design/re-write the DependencyManager at some point.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So I guess I won&apos;t include this as part of the main patch, but I&apos;m happy to attach it as a separate patch. &lt;br/&gt;
And if the DependencyManager won&apos;t be re-written right away, I could try to make another patch based on my comments here (would need some more time for that though) &lt;/p&gt;</comment>
                            <comment id="12492967" author="bryanpendleton" created="Tue, 1 May 2007 22:58:36 +0100"  >&lt;p&gt;Thanks Dyre. Addressing this tracing later and separately seems reasonable to me.&lt;/p&gt;</comment>
                            <comment id="12493022" author="dyret" created="Wed, 2 May 2007 08:27:20 +0100"  >&lt;p&gt;Attaching a proper patch (derby-2594.v1). suites.All and derbyall pass. Reviews are appreciated, as always.&lt;br/&gt;
(Does not include any DependencyManager tracing).&lt;/p&gt;</comment>
                            <comment id="12493127" author="dyret" created="Wed, 2 May 2007 17:02:54 +0100"  >&lt;p&gt;Attaching a patch for the trace (DependencyTraceUntested.diff). I have only tried it with lang.GrantRevokeDDLTest and the resulting output is attached as out.txt.&lt;/p&gt;</comment>
                            <comment id="12494658" author="knutanders" created="Thu, 10 May 2007 08:51:18 +0100"  >&lt;p&gt;Thanks Dyre. derby-2594.v1.diff looks good. Committed revision 536767.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12399037">DERBY-3736</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12327853">DERBY-827</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12327853">DERBY-827</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12356641" name="DependencyTraceUntested.diff" size="1197" author="dyret" created="Wed, 2 May 2007 17:02:54 +0100"/>
                            <attachment id="12356603" name="derby-2594.v1.diff" size="4053" author="dyret" created="Wed, 2 May 2007 08:27:20 +0100"/>
                            <attachment id="12356604" name="derby-2594.v1.stat" size="447" author="dyret" created="Wed, 2 May 2007 08:27:20 +0100"/>
                            <attachment id="12356642" name="out.txt" size="103016" author="dyret" created="Wed, 2 May 2007 17:02:54 +0100"/>
                            <attachment id="12356406" name="revoke_prelim.diff" size="3283" author="dyret" created="Fri, 27 Apr 2007 13:53:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 26 Apr 2007 14:26:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30534</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0yrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39449</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>