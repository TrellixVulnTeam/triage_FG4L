<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:27:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2500/DERBY-2500.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2500] Assertion failure preparing query with AND and OR in where clause</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2500</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;See commented out test in DistinctTest, DistinctTest.testResultSetInOrderWhenUsingIndex.&lt;/p&gt;

&lt;p&gt;The actual assert is:&lt;/p&gt;

&lt;p&gt;ASSERT FAILED Found IN-list probing (NLR.LUSERNAME = &amp;lt;expr&amp;gt;) while generating HASH join, which should not happen.&lt;/p&gt;

&lt;p&gt;I was able to simplify the query a little:&lt;/p&gt;

&lt;p&gt;SELECT DISTINCT nb.name AS name, nb.summary AS summary FROM netbutton1 nb, netbuttonlibraryrole1 nlr, library_netbutton ln WHERE nlr.netbuttonlibrary_id = ln.netbuttonlibrary_id AND (nlr.lusername = ? OR nlr.lusername =?)&lt;/p&gt;

&lt;p&gt;Removing nlr.netbuttonlibrary_id = ln.netbuttonlibrary_id clause but leaving the &apos;nb.lname = ln.lname&apos; in front of the AND did not reproduce the problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12366071">DERBY-2500</key>
            <summary>Assertion failure preparing query with AND and OR in where clause</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="fuzzylogic">Andrew McIntyre</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Mar 2007 00:32:10 +0100</created>
                <updated>Fri, 21 Jan 2011 17:50:01 +0000</updated>
                            <resolved>Thu, 5 Apr 2007 19:41:46 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12485379" author="army" created="Fri, 30 Mar 2007 00:34:06 +0100"  >&lt;p&gt;Attaching d2500_v1.patch for review and commit.&lt;/p&gt;

&lt;p&gt;The comments just before the ASSERT reported in this issue include the following:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;... Checks elsewhere in the code should ensure that no probe&lt;/li&gt;
	&lt;li&gt;predicates have made it this far, but if we&apos;re running in SANE&lt;/li&gt;
	&lt;li&gt;mode it doesn&apos;t hurt to verify.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As it turns out, the &quot;checks elsewhere&quot; do not actually exist-&lt;del&gt;but they should (oops).  What we need is to recognize when we&apos;re doing a hash join and to explicitly avoid generating probe predicates in that case.  Failure to do so leads to this ASSERT failure in sane mode&lt;/del&gt;-and in insane mode it could actually lead to incorrect results.&lt;/p&gt;

&lt;p&gt;So the fix is, I think, fairly straightforward: we just need to add an appropriate check to the &quot;orderUsefulPredicates()&quot; method of PredicateList.  That&apos;s what d2500_v1.patch does.&lt;/p&gt;

&lt;p&gt;That said, I then noticed that the comments in HashJoinStrategy do not fully explain why we need to disallow probe predicates.  In particular the existing comments do not (but should) mention that the reason for such a restriction is simply one of &quot;not-yet-implemented&quot;--i.e. the appropriate IN-list multi-probing logic has not been added to HashScanResultSet.  &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt; added a new MultiProbeTableScanResult to handle multi-probing for nested loop joins, but did not extend that functionality to hash joins.  As a result, hash joins with multi-probing predicates will behave incorrectly, hence this Jira.&lt;/p&gt;

&lt;p&gt;So if at some point such functionality &lt;b&gt;is&lt;/b&gt; added then we should be able to remove the current restriction regarding IN-list probing and hash joins.  As I think there could indeed be benefits to doing so, I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2503&quot; title=&quot;Implement IN-list multi-probing logic for hash joins.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2503&quot;&gt;DERBY-2503&lt;/a&gt; for that enhancement.  Until that is done, though, d2500_v1.patch adds the necessary logic to prevent generation of probe predicates for hash joins, and also updates code comments to more clearly state what is going on.  The patch also renables &quot;testResultSetInOrderWhenUsingIndex()&quot; in lang/DistinctTest.java and adds another test case to demonstrate how, in the absence of an ASSERT failure, Derby could have returned incorrect results before this issue was fixed.&lt;/p&gt;

&lt;p&gt;I ran derbyall and suites.All with d2500_v1.patch applied and there were no failures.&lt;/p&gt;</comment>
                            <comment id="12485384" author="army" created="Fri, 30 Mar 2007 00:44:53 +0100"  >&lt;p&gt;Realized after I uploaded the patch that the comments for the test case in DistinctTest need to be updated to reflect the changes made in this issue.  Other than this change to the comments, v1 and v2 are identical.&lt;/p&gt;</comment>
                            <comment id="12487073" author="army" created="Thu, 5 Apr 2007 19:41:22 +0100"  >&lt;p&gt;Committed d2500_v3.patch, which is the same as the _v2 patch except that the second new test case was corrected so that, in the absence of the fix for this issue, the query would actually return incorrect results.&lt;/p&gt;

&lt;p&gt;Committed with svn # 525925:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=525925&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=525925&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="27899">DERBY-47</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12354561" name="d2500_v1.patch" size="7427" author="army" created="Fri, 30 Mar 2007 00:34:06 +0100"/>
                            <attachment id="12354562" name="d2500_v1.stat" size="305" author="army" created="Fri, 30 Mar 2007 00:34:06 +0100"/>
                            <attachment id="12354564" name="d2500_v2.patch" size="7756" author="army" created="Fri, 30 Mar 2007 00:44:53 +0100"/>
                            <attachment id="12355029" name="d2500_v3.patch" size="7818" author="army" created="Thu, 5 Apr 2007 19:41:22 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 29 Mar 2007 23:34:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23074</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0mhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37463</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>