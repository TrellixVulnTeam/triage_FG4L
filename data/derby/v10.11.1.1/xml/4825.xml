<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:07 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4825/DERBY-4825.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4825] Assert failure in LargeDataLocksTest.testGetCharacterStream() because of wrong number of locks</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4825</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I saw this failure when running suites.All on the 10.6.2.1 release candidate:&lt;/p&gt;

&lt;p&gt;1) testGetCharacterStream(org.apache.derbyTesting.functionTests.tests.jdbcapi.LargeDataLocksTest)junit.framework.AssertionFailedError: expected:&amp;lt;0&amp;gt; but was:&amp;lt;3&amp;gt;&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.jdbcapi.LargeDataLocksTest.testGetCharacterStream(LargeDataLocksTest.java:72)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:109)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:23)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:27)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;

&lt;p&gt;The assertion expects the lock table to have zero locks, but it finds three.&lt;/p&gt;

&lt;p&gt;The test succeeded when I later ran it 100 times outside of suites.All.&lt;/p&gt;

&lt;p&gt;The failure looks similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4301&quot; title=&quot;testGetBinaryStream failed with AssertionFailedError: (expected:&amp;lt;0&amp;gt; but was:&amp;lt;2&amp;gt;) with 10.3 server and 10.5 client testing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4301&quot;&gt;DERBY-4301&lt;/a&gt;, but I saw this in a pure 10.6 environment, whereas &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4301&quot; title=&quot;testGetBinaryStream failed with AssertionFailedError: (expected:&amp;lt;0&amp;gt; but was:&amp;lt;2&amp;gt;) with 10.3 server and 10.5 client testing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4301&quot;&gt;DERBY-4301&lt;/a&gt; happened in a mixed 10.3/10.5 environment. Also, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4301&quot; title=&quot;testGetBinaryStream failed with AssertionFailedError: (expected:&amp;lt;0&amp;gt; but was:&amp;lt;2&amp;gt;) with 10.3 server and 10.5 client testing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4301&quot;&gt;DERBY-4301&lt;/a&gt; is consistently reproducible, whereas this failure appears to be intermittent.&lt;/p&gt;</description>
                <environment>FreeBSD 8.1, i386&lt;br/&gt;
Diablo Java(TM) SE Runtime Environment (build 1.6.0_07-b02)</environment>
        <key id="12475494">DERBY-4825</key>
            <summary>Assert failure in LargeDataLocksTest.testGetCharacterStream() because of wrong number of locks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Sep 2010 10:51:16 +0100</created>
                <updated>Mon, 29 Nov 2010 14:23:21 +0000</updated>
                            <resolved>Sun, 10 Oct 2010 19:25:35 +0100</resolved>
                                    <version>10.6.2.1</version>
                                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12916636" author="knutanders" created="Thu, 30 Sep 2010 21:25:10 +0100"  >&lt;p&gt;I reran the entire suites.All on this platform and then it happened again (failed on the same assertion, but lock count was 2 not 3 this time):&lt;/p&gt;

&lt;p&gt;junit.framework.AssertionFailedError: expected:&amp;lt;0&amp;gt; but was:&amp;lt;2&amp;gt;&lt;br/&gt;
        at junit.framework.Assert.fail(Assert.java:47)&lt;br/&gt;
        at junit.framework.Assert.failNotEquals(Assert.java:283)&lt;br/&gt;
        at junit.framework.Assert.assertEquals(Assert.java:64)&lt;br/&gt;
        at junit.framework.Assert.assertEquals(Assert.java:195)&lt;br/&gt;
        at junit.framework.Assert.assertEquals(Assert.java:201)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.jdbcapi.LargeDataLocksTest.testGetCharacterStream(LargeDataLocksTest.java:72)&lt;/p&gt;</comment>
                            <comment id="12916716" author="knutanders" created="Thu, 30 Sep 2010 23:25:32 +0100"  >&lt;p&gt;And it failed when I swapped the Diablo JVM with OpenJDK 6 b19 too. I&apos;ll make the test dump the contents of the lock table and see if that gives us a clue.&lt;/p&gt;</comment>
                            <comment id="12916811" author="knutanders" created="Fri, 1 Oct 2010 08:27:26 +0100"  >&lt;p&gt;Assigning the issue to me while I&apos;m investigating it.&lt;/p&gt;</comment>
                            <comment id="12917939" author="knutanders" created="Tue, 5 Oct 2010 11:49:18 +0100"  >&lt;p&gt;Attaching a patch that makes LargeDataLocksTest report the contents of the lock table when the lock count is wrong. I now see this message when I run suites.All:&lt;/p&gt;

&lt;p&gt;junit.framework.AssertionFailedError: Unexpected lock count. Contents of lock table:&lt;br/&gt;
1: XID=601052 TYPE=ROW MODE=X TABLENAME=SYSSTATEMENTS LOCKNAME=(10,13) STATE=GRANT TABLETYPE=S LOCKCOUNT=1 INDEXNAME=null &lt;br/&gt;
2: XID=601052 TYPE=TABLE MODE=IX TABLENAME=SYSSTATEMENTS LOCKNAME=Tablelock STATE=GRANT TABLETYPE=S LOCKCOUNT=1 INDEXNAME=null &lt;br/&gt;
 expected:&amp;lt;0&amp;gt; but was:&amp;lt;2&amp;gt;&lt;/p&gt;

&lt;p&gt;Exclusive locks in SYSSTATEMENTS would usually mean that someone is recompiling a trigger or a meta-data query, I think.&lt;/p&gt;</comment>
                            <comment id="12917940" author="kristwaa" created="Tue, 5 Oct 2010 11:56:12 +0100"  >&lt;p&gt;I have been writing similar code myself many times when debugging, and I think it would be a nice addition to the test framework.&lt;br/&gt;
Do we have an appropriate home for such a method?&lt;/p&gt;

&lt;p&gt;It would also be nice to have a method do just dump the lock table to stdout (i.e. not doing any asserts).&lt;/p&gt;</comment>
                            <comment id="12917941" author="knutanders" created="Tue, 5 Oct 2010 12:14:57 +0100"  >&lt;p&gt;Committed the patch with revision 1004609 so that we get more info when the test fails.&lt;/p&gt;</comment>
                            <comment id="12917944" author="knutanders" created="Tue, 5 Oct 2010 12:37:49 +0100"  >&lt;p&gt;&amp;gt; I have been writing similar code myself many times when debugging,&lt;br/&gt;
&amp;gt; and I think it would be a nice addition to the test framework. Do&lt;br/&gt;
&amp;gt; we have an appropriate home for such a method?&lt;/p&gt;

&lt;p&gt;I suppose we could move this method to BaseJDBCTestCase to make it&lt;br/&gt;
available for other tests.&lt;/p&gt;

&lt;p&gt;&amp;gt; It would also be nice to have a method do just dump the lock table&lt;br/&gt;
&amp;gt; to stdout (i.e. not doing any asserts).&lt;/p&gt;

&lt;p&gt;I see that there are some tests with helper methods that print result&lt;br/&gt;
sets to stdout. Perhaps one of those can be moved to the&lt;br/&gt;
BaseJDBCTestCase class or the JDBC class? But I guess in most cases&lt;br/&gt;
where you&apos;re interested in the contents of the lock table you would&lt;br/&gt;
have an assert of some kind.&lt;/p&gt;</comment>
                            <comment id="12917948" author="kristwaa" created="Tue, 5 Oct 2010 12:52:31 +0100"  >&lt;p&gt;&amp;gt; But I guess in most cases where you&apos;re interested in the&lt;br/&gt;
&amp;gt; contents of the lock table you would have an assert of some kind. &lt;/p&gt;

&lt;p&gt;Yes, except when you are trying to understand when and where locks are being set during a debugging session. This code would only be enabled temporarily, I don&apos;t expect it to ever be committed.&lt;/p&gt;

&lt;p&gt;In any case, moving the current method would be a good incremental improvement in my opinion, as it gives you better information when the test fails.&lt;/p&gt;</comment>
                            <comment id="12918703" author="knutanders" created="Wed, 6 Oct 2010 22:59:11 +0100"  >&lt;p&gt;I found that the background thread obtains exclusive locks on rows the SYSSTATEMENTS table while doing post-commit work, so I suspect that&apos;s what making these locks turn up intermittently in the lock table.&lt;/p&gt;

&lt;p&gt;The attached patch makes assertLockCount() wait for post-commit work to complete before it counts the locks. On a machine where LargeDataLocksTest has failed every time I&apos;ve run it as part of suites.All, the entire test suite ran cleanly with the patch. I&apos;ll rerun suites.All to verify that it wasn&apos;t just pure luck that made it pass this one time. (I have never seen the failure outside of suites.All, so I don&apos;t have any quicker way to verify it.)&lt;/p&gt;

&lt;p&gt;If we make this change, I don&apos;t think we should move assertLockCount() to BaseJDBCTestCase just yet since it now depends on a stored procedure that won&apos;t be available in general.&lt;/p&gt;</comment>
                            <comment id="12918822" author="knutanders" created="Thu, 7 Oct 2010 09:08:20 +0100"  >&lt;p&gt;suites.All ran cleanly the second time with the patch too.&lt;/p&gt;</comment>
                            <comment id="12919635" author="knutanders" created="Sun, 10 Oct 2010 19:25:35 +0100"  >&lt;p&gt;Committed revision 1006332.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12430098">DERBY-4301</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12456377" name="dump-locks.diff" size="3444" author="knutanders" created="Tue, 5 Oct 2010 11:49:18 +0100"/>
                            <attachment id="12456546" name="postcommit.diff" size="1607" author="knutanders" created="Wed, 6 Oct 2010 22:59:11 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 5 Oct 2010 10:56:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24482</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ofr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37777</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>