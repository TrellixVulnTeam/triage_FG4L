<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:28:09 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2729/DERBY-2729.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2729] temporary lob file should be cleaned when the transaction or connection is no longer valid.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2729</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description></description>
                <environment></environment>
        <key id="12370514">DERBY-2729</key>
            <summary>temporary lob file should be cleaned when the transaction or connection is no longer valid.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anurag">Anurag Shekhar</assignee>
                                    <reporter username="anurag">Anurag Shekhar</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 May 2007 10:39:19 +0100</created>
                <updated>Wed, 5 May 2010 12:18:34 +0100</updated>
                            <resolved>Wed, 6 Jun 2007 10:13:50 +0100</resolved>
                                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12500153" author="anurag" created="Wed, 30 May 2007 16:01:51 +0100"  >&lt;p&gt;Life cycle of a lob object is within the a transaction. when a connection is closed or a rollback or commit is called, either explicitly by calling &lt;br/&gt;
connection.commit or connection.rollback, or a rollback called due to an &lt;br/&gt;
exception with severity  TRANSACTION or higher or an implicit commit when &lt;br/&gt;
autoCommit is set to true.&lt;/p&gt;

&lt;p&gt;Locator patch for client has introduced a hash map (lobHashMap) in &lt;br/&gt;
EmbeddedConnection to track all the lob associated with the connection &lt;br/&gt;
and at commit, rollback and close clearHashMap method is called to &lt;br/&gt;
cleanup the hashmap and calling free method on individual hash map.&lt;/p&gt;


&lt;p&gt;I am relying on same methods to do cleanup for embedded server. &lt;br/&gt;
In the constructor of EmbedBlob calls EmbeddedConnection.addLOBMapping method to add entry for the blob.&lt;/p&gt;

&lt;p&gt;I have also added code to call clearLOBMapping when transaction is commited when autoCommit mode is on. And when an StandardException with severity TRANSACTION or higher.&lt;/p&gt;

&lt;p&gt;Due to this change the EmbeddedBlob now any call to EmbeddedBlob after commit or rollback now results in exception with SQLState set to SQLState.LOB_OBJECT_INVALID. I have added additional check to see if connection is closed, this ensures the same sql state what is thrown right now without this patch.&lt;br/&gt;
Its not possible to determine whether the blob was closed due to explicit call to free or its because transaction is no more valid. So if a blob is accessed after commit/rollback it results in SQLException with SQL state set to  SQLState.LOB_OBJECT_INVALID.&lt;/p&gt;

&lt;p&gt;modified files&lt;br/&gt;
java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java&lt;br/&gt;
added code to call clearLOBMapping in commitIfNeeded, commitIfAutoCommit and handleException methods. &lt;/p&gt;


&lt;p&gt;java/engine/org/apache/derby/impl/jdbc/EmbedBlob.java&lt;/p&gt;

&lt;p&gt;added call to EmbedConnection to add entry for this object in lobMapping. &lt;br/&gt;
added additional check for validity of connection in checkValidity&lt;/p&gt;

&lt;p&gt;java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/BlobClob4BlobTest.java&lt;br/&gt;
updated the expected SQLStates.      &lt;/p&gt;

&lt;p&gt;java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/BlobStoredProcedureTest.java&lt;br/&gt;
updated the expected locator id. Now blob constructor is adding itself to  the lob so the id received by the stored procedure will be different. &lt;/p&gt;</comment>
                            <comment id="12500156" author="anurag" created="Wed, 30 May 2007 16:06:58 +0100"  >&lt;p&gt;this patch addresses only blob cleanup. I will be submitting another patch to enable clob cleanup.&lt;/p&gt;</comment>
                            <comment id="12500237" author="oysteing" created="Wed, 30 May 2007 22:00:34 +0100"  >&lt;p&gt;Unless the JDBC or SQL standards requires a specific error code, I think it is ok to not distinguish between a Lob being invalid because free has been called or because transaction has been terminated.  However, I think we should try to make sure the same error code is used both for embedded and client/server  and the error text need  reflect both causes.  It is very straight-forward to fix the client to use the same SQL state as the embedded.  I can do that, but we need to agree on which to use.&lt;/p&gt;</comment>
                            <comment id="12501567" author="bernt" created="Tue, 5 Jun 2007 15:12:37 +0100"  >&lt;p&gt;Patch seems ok to me. I&apos;ll commit tomorrow if no-one objects.&lt;/p&gt;</comment>
                            <comment id="12501862" author="bernt" created="Wed, 6 Jun 2007 10:13:50 +0100"  >&lt;p&gt;Committed revision 544777.&lt;/p&gt;</comment>
                            <comment id="12505070" author="anurag" created="Fri, 15 Jun 2007 08:23:43 +0100"  >&lt;p&gt;release notes for state change and life cycle of lob due to cleanup.&lt;/p&gt;</comment>
                            <comment id="12505187" author="oysteing" created="Fri, 15 Jun 2007 13:17:21 +0100"  >&lt;p&gt;Some comments on the release notes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The summary should be a one-liner&lt;/li&gt;
	&lt;li&gt;The bold text for embedded driver and client is confusing since they&lt;br/&gt;
  look similar to the section headings.  I suggest not using bold, but&lt;br/&gt;
  plain text with a succeeding colon, instead.&lt;/li&gt;
	&lt;li&gt;Since the behavior is now the same for both client and embedded, I&lt;br/&gt;
  do not think it is necessary to dwell with previous differences.&lt;br/&gt;
  That would make things a bit simpler.  E.g., instead of mentioning&lt;br/&gt;
  that the change is only for short lobs, you can just say that it now&lt;br/&gt;
  holds for all Lobs.  That way, I think you do not really need to&lt;br/&gt;
  write separate statements for client and embedded.&lt;/li&gt;
	&lt;li&gt;For the &apos;Application Changes Required&apos; section, you can refer to the&lt;br/&gt;
  release note for the locator-based implementation (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-208&quot; title=&quot;Add support to retrieve lobs for Network Server by locator rather than matierializing the LOB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-208&quot;&gt;&lt;del&gt;DERBY-208&lt;/del&gt;&lt;/a&gt;) for a&lt;br/&gt;
  discussion on the effects of changing the transaction life span.&lt;/li&gt;
	&lt;li&gt;For the first paragraph, I think it is sufficient to say:&lt;br/&gt;
      &quot;A Blob or Clob object is no longer valid after the termination&lt;br/&gt;
      (commit or rollback) of the transaction it were created in.&quot;&lt;br/&gt;
  Since transaction cannot live beyond a connection this should cover&lt;br/&gt;
  that case, but I guess it does not harm to state that explicitly.  I&lt;br/&gt;
  do not think it is necessary to discuss implicit or explicit&lt;br/&gt;
  commits/rollbacks here.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12505199" author="anurag" created="Fri, 15 Jun 2007 13:27:05 +0100"  >&lt;p&gt;thanks &#216;ystein for the review. I am posting revised release notes. &lt;/p&gt;</comment>
                            <comment id="12505477" author="rhillegas" created="Sat, 16 Jun 2007 16:35:46 +0100"  >&lt;p&gt;Attaching a new version of the release note. This adjusts the html formatting so that, hopefully, it can be digested by the release note generator.&lt;/p&gt;</comment>
                            <comment id="12505478" author="rhillegas" created="Sat, 16 Jun 2007 16:40:08 +0100"  >&lt;p&gt;Attaching another version of the release note, this time replacing the nbsp symbols with spaces.&lt;/p&gt;</comment>
                            <comment id="12505479" author="rhillegas" created="Sat, 16 Jun 2007 16:45:07 +0100"  >&lt;p&gt;Next rev of this release note. This time, I am turning the naked &amp;lt;br&amp;gt; tags into &amp;lt;br/&amp;gt; because the xml parser is less forgiving than browser parsers are and unterminated tags cause problems.&lt;/p&gt;</comment>
                            <comment id="12510326" author="anurag" created="Thu, 5 Jul 2007 10:18:22 +0100"  >&lt;p&gt;attaching revised released notes&lt;/p&gt;</comment>
                            <comment id="12864280" author="kristwaa" created="Wed, 5 May 2010 12:18:34 +0100"  >&lt;p&gt;Closing issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12371226">DERBY-2787</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12370414">DERBY-2715</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12358543" name="derby-2729.diff" size="11535" author="anurag" created="Wed, 30 May 2007 16:01:51 +0100"/>
                            <attachment id="12361184" name="releaseNote.html" size="2262" author="anurag" created="Thu, 5 Jul 2007 10:18:22 +0100"/>
                            <attachment id="12359927" name="releaseNote.html" size="5316" author="rhillegas" created="Sat, 16 Jun 2007 16:45:07 +0100"/>
                            <attachment id="12359926" name="releaseNote.html" size="5314" author="rhillegas" created="Sat, 16 Jun 2007 16:40:08 +0100"/>
                            <attachment id="12359925" name="releaseNote.html" size="5327" author="rhillegas" created="Sat, 16 Jun 2007 16:35:46 +0100"/>
                            <attachment id="12359858" name="releaseNote.html" size="4735" author="anurag" created="Fri, 15 Jun 2007 13:27:05 +0100"/>
                            <attachment id="12359812" name="releaseNote.html" size="4857" author="anurag" created="Fri, 15 Jun 2007 08:23:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 30 May 2007 21:00:34 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23205</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0qh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38107</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>