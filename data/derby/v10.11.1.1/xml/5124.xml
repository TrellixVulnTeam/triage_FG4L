<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:28:11 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5124/DERBY-5124.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5124] NPE or assert failure printed when dropping table while statistics are written out</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5124</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;To find out what would happen if a table was dropped while its statistics were being written to disk, I put a breakpoint in IndexStatisticsImpl.writeUpdatedStats() right after the call to dropStatisticsDescriptors(), started an ij session in the debugger and executed some statements to make the istat code kick in. When the breakpoint was hit, I dropped the table being updated in ij, before letting the istat thread continue.&lt;/p&gt;

&lt;p&gt;With insane jars, the following NPE was printed on the ij console:&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;index-stat-thread&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.writeUpdatedStats(IndexStatisticsDaemonImpl.java:556)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(IndexStatisticsDaemonImpl.java:486)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(IndexStatisticsDaemonImpl.java:323)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.processingLoop(IndexStatisticsDaemonImpl.java:759)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:675)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;Apart from the stack trace being printed, nothing bad happened. The istat thread was able to recover, and the ij session was unaffected too.&lt;/p&gt;

&lt;p&gt;Using a debug build, I got an assert failure instead:&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;index-stat-thread&quot; org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED transaction not pristine&lt;br/&gt;
	at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:162)&lt;br/&gt;
	at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:147)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.processingLoop(IndexStatisticsDaemonImpl.java:810)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:675)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;The assert failure prevented some cleanup from happening, so the istat thread seemed to hold on to a lock on SYSSTATISTICS, so the following statement would keep failing in ij after on:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from sys.sysstatistics;&lt;br/&gt;
STATID                              |REFERENCEID                         |TABLEID                             |CREATIONTIMESTAMP            |&amp;amp;|VALID|COLCOUNT   |STATISTICS     &lt;br/&gt;
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
ERROR 40XL1: A lock could not be obtained within the time requested&lt;/p&gt;</description>
                <environment></environment>
        <key id="12501142">DERBY-5124</key>
            <summary>NPE or assert failure printed when dropping table while statistics are written out</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Mar 2011 13:28:51 +0000</created>
                <updated>Thu, 30 Jun 2011 10:21:41 +0100</updated>
                            <resolved>Fri, 11 Mar 2011 14:13:16 +0000</resolved>
                                    <version>10.8.1.2</version>
                                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13005629" author="knutanders" created="Fri, 11 Mar 2011 13:32:53 +0000"  >&lt;p&gt;The NPE happens in the logging:&lt;/p&gt;

&lt;p&gt;            // Log some information.&lt;br/&gt;
            log(asBackgroundTask, td,&lt;br/&gt;
                    &quot;wrote stats for index &quot;  + &lt;br/&gt;
                    dd.getConglomerateDescriptor(index).getDescriptorName() +&lt;br/&gt;
                    &quot; (&quot; + index + &quot;): rows=&quot; + numRows +&lt;br/&gt;
                    &quot;, card=&quot; + cardToStr(cardinality));&lt;/p&gt;

&lt;p&gt;Presumably dd.getConglomerateDescriptor() returns null because the index doesn&apos;t exist anymore.&lt;/p&gt;</comment>
                            <comment id="13005643" author="knutanders" created="Fri, 11 Mar 2011 14:11:32 +0000"  >&lt;p&gt;The attached patch adds a null check to the logging code, so that it doesn&apos;t fail with a NullPointerException. This also fixes the assert failure in debug builds. The assert happened because the NPE prevented the istat tx from committing, and the cleanup code expected the tx to have no uncommitted operations.&lt;/p&gt;</comment>
                            <comment id="13005645" author="knutanders" created="Fri, 11 Mar 2011 14:13:16 +0000"  >&lt;p&gt;Committed revision 1080573.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12498732">DERBY-5045</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12500245">DERBY-5089</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12498732">DERBY-5045</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12473393" name="null.diff" size="879" author="knutanders" created="Fri, 11 Mar 2011 14:11:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24667</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36393</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>