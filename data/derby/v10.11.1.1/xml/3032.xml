<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:15:36 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3032/DERBY-3032.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3032] java.lang.ClassCastException returning null from a case statement  in subquery</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3032</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following query returning NULL date from a case statement in a subquery causees a ClassCastException in 10.3.&lt;br/&gt;
The query works fine in 10.2&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t (d date, vc varchar(30));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t values(CURRENT_DATE, &apos;hello&apos;);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; SELECT d from t where d = (SELECT CASE WHEN 1 = 1 THEN CURRENT_DATE ELSE NULL END from t);&lt;br/&gt;
D&lt;br/&gt;
----------&lt;br/&gt;
2007-08-28&lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; SELECT d from t where d = (SELECT CASE WHEN 1 = 0 THEN CURRENT_DATE  ELSE NULL END from t);&lt;br/&gt;
D&lt;br/&gt;
----------&lt;br/&gt;
ERROR 38000: The exception &apos;java.lang.ClassCastException: org.apache.derby.iapi.types.SQLChar incompatible with org.apac&lt;br/&gt;
he.derby.iapi.types.DateTimeDataValue&apos; was thrown while evaluating an expression.&lt;br/&gt;
java.sql.SQLException: The exception &apos;java.lang.ClassCastException: org.apache.derby.iapi.types.SQLChar incompatible wit&lt;br/&gt;
h org.apache.derby.iapi.types.DateTimeDataValue&apos; was thrown while evaluating an expression.&lt;br/&gt;
       at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:88)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.Util.seeNextException(Util.java:224)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:398)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:1572)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.closeOnTransactionError(EmbedResultSet.java:4323)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:464)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.next(EmbedResultSet.java:368)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:382)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:338)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:241)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.DisplayResults(JDBCDisplayUtil.java:229)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.displayResult(utilMain.java:449)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:523)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:364)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:262)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.Main.go(Main.java:215)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:181)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:56)&lt;br/&gt;
       at org.apache.derby.tools.ij.main(ij.java:71)&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;org.apache.derby.iapi.types.SQLChar incompatible with org.apache.derb&lt;br/&gt;
y.iapi.types.DateTimeDataValue: java.lang.ClassCastException&apos;.&lt;br/&gt;
       at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:88)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.Util.javaException(Util.java:245)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)&lt;br/&gt;
       ... 19 more&lt;br/&gt;
Caused by: java.lang.ClassCastException: org.apache.derby.iapi.types.SQLChar incompatible with org.apache.derby.iapi.typ&lt;br/&gt;
es.DateTimeDataValue&lt;br/&gt;
       at org.apache.derby.exe.ac12564092x0114xaec2x9627x0000002183d82.g0(Unknown Source)&lt;br/&gt;
       at org.apache.derby.exe.ac12564092x0114xaec2x9627x0000002183d82.e1(Unknown Source)&lt;br/&gt;
       at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGeneratedClass.java:141)&lt;br/&gt;
       at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(ProjectRestrictResultSet.java:267)&lt;br/&gt;
       at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:468)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:424)&lt;br/&gt;
       ... 13 more&lt;br/&gt;
ERROR XJ001: Java exception: &apos;org.apache.derby.iapi.types.SQLChar incompatible with org.apache.derby.iapi.types.DateTime&lt;br/&gt;
DataValue: java.lang.ClassCastException&apos;.&lt;br/&gt;
java.sql.SQLException: Java exception: &apos;org.apache.derby.iapi.types.SQLChar incompatible with org.apache.derby.iapi.type&lt;br/&gt;
s.DateTimeDataValue: java.lang.ClassCastException&apos;.&lt;br/&gt;
       at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:88)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.Util.javaException(Util.java:245)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:398)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:1572)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.closeOnTransactionError(EmbedResultSet.java:4323)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:464)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.next(EmbedResultSet.java:368)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:382)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:338)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:241)&lt;br/&gt;
       at org.apache.derby.tools.JDBCDisplayUtil.DisplayResults(JDBCDisplayUtil.java:229)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.displayResult(utilMain.java:449)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:523)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:364)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:262)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.Main.go(Main.java:215)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:181)&lt;br/&gt;
       at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:56)&lt;br/&gt;
       at org.apache.derby.tools.ij.main(ij.java:71)&lt;br/&gt;
Caused by: java.lang.ClassCastException: org.apache.derby.iapi.types.SQLChar incompatible with org.apache.derby.iapi.typ&lt;br/&gt;
es.DateTimeDataValue&lt;br/&gt;
       at org.apache.derby.exe.ac12564092x0114xaec2x9627x0000002183d82.g0(Unknown Source)&lt;br/&gt;
       at org.apache.derby.exe.ac12564092x0114xaec2x9627x0000002183d82.e1(Unknown Source)&lt;br/&gt;
       at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGeneratedClass.java:141)&lt;br/&gt;
       at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(ProjectRestrictResultSet.java:267)&lt;br/&gt;
       at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:468)&lt;br/&gt;
       at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:424)&lt;br/&gt;
       ... 13 more&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12377113">DERBY-3032</key>
            <summary>java.lang.ClassCastException returning null from a case statement  in subquery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Aug 2007 19:26:32 +0100</created>
                <updated>Tue, 30 Jun 2009 16:55:44 +0100</updated>
                            <resolved>Tue, 4 Sep 2007 23:12:24 +0100</resolved>
                                    <version>10.3.2.1</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12523883" author="kmarsden" created="Thu, 30 Aug 2007 18:02:15 +0100"  >&lt;p&gt;This issue was caused by svn 566217, the checkin for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2986&quot; title=&quot;Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2986&quot;&gt;&lt;del&gt;DERBY-2986&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
T&lt;/p&gt;</comment>
                            <comment id="12523923" author="kmarsden" created="Thu, 30 Aug 2007 20:53:33 +0100"  >
&lt;p&gt;The change comments for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2986&quot; title=&quot;Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2986&quot;&gt;&lt;del&gt;DERBY-2986&lt;/del&gt;&lt;/a&gt; say:&lt;br/&gt;
		/* Following call to &quot;findType()&quot; will indirectly bind the&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;expressions in the thenElseList, so no need to call&lt;/li&gt;
	&lt;li&gt;&quot;thenElseList.bindExpression(...)&quot; after we do this.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2986&quot; title=&quot;Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2986&quot;&gt;&lt;del&gt;DERBY-2986&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
			 */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The javadoc for findtype says:&lt;br/&gt;
	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This method is a &apos;prebind.&apos;  We need to determine what the types of&lt;/li&gt;
	&lt;li&gt;the nodes are going to be before we can set all the SQLParsed NULL&apos;s&lt;/li&gt;
	&lt;li&gt;to the appropriate type.  After we bind, however, we want to ignore&lt;/li&gt;
	&lt;li&gt;the SQLParsed NULL&apos;s which will be bound to CHAR.  Also, we might&lt;/li&gt;
	&lt;li&gt;have to delve into the CASE Expression tree.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So apparently findtype is not enough as it leaves all the SQL NULL&apos;s bound as CHARS.  Still we should be able to avoid the exponential processing, especially for the case where nulls are not involved as in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2986&quot; title=&quot;Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2986&quot;&gt;&lt;del&gt;DERBY-2986&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12523930" author="army" created="Thu, 30 Aug 2007 21:20:56 +0100"  >&lt;p&gt;&amp;gt; So apparently findtype is not enough as it leaves all the SQL NULL&apos;s bound as CHARS. &lt;/p&gt;

&lt;p&gt;Good catch, Kathey.  Thank you for picking this up and looking into it...&lt;/p&gt;</comment>
                            <comment id="12524176" author="kmarsden" created="Fri, 31 Aug 2007 21:01:57 +0100"  >&lt;p&gt;Attached is an initial patch for this issue.  My solution was to have recastNullNodes rebind the expressions whenever a cast is performed.  This corrected the ClassCastException  and preserved the performance for the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2986&quot; title=&quot;Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2986&quot;&gt;&lt;del&gt;DERBY-2986&lt;/del&gt;&lt;/a&gt; issue.&lt;/p&gt;

&lt;p&gt;While this approach seems to work fine, I somehow have the feeling that the indirect binding through both findType and recastNullNodes is a bit unclear.  I added comments to try to make it apparent that that is what is happenning, but wonder if there is better way to reorganize this to make it clearer.  Suggestions welcome.&lt;/p&gt;

&lt;p&gt;Tests are running now.  &lt;/p&gt;</comment>
                            <comment id="12524236" author="kmarsden" created="Sat, 1 Sep 2007 01:10:39 +0100"  >&lt;p&gt;Tests ran ok. Please review.&lt;/p&gt;</comment>
                            <comment id="12524774" author="army" created="Tue, 4 Sep 2007 17:07:17 +0100"  >&lt;p&gt;Thank you for the patch, Kathey.  I verified that it solves the reported problem and does not affect the performance as seen in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2986&quot; title=&quot;Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2986&quot;&gt;&lt;del&gt;DERBY-2986&lt;/del&gt;&lt;/a&gt;.  I also ran the new test case before and after applying the engine changes, and it behaved as expected (failed without the fix, passed with it).&lt;/p&gt;

&lt;p&gt;&amp;gt; I added comments to try to make it apparent that that is what is happenning, but wonder if &lt;br/&gt;
&amp;gt; there is better way to reorganize this to make it clearer&lt;/p&gt;

&lt;p&gt;I think the comments help (thanks for adding them), but I also agree that some sort of code reorganization might be good here.  The code as it is feels a tad awkward.  Nonetheless, the patch as posted solves the problem so I&apos;m +1 to commit.  If anyone has the time to do some re-org as follow-up work, that&apos;d be great--but I wouldn&apos;t let that block the current patch.&lt;/p&gt;

&lt;p&gt;Thank you again for picking this one up and resolving it so quickly.&lt;/p&gt;</comment>
                            <comment id="12524900" author="kmarsden" created="Tue, 4 Sep 2007 23:12:24 +0100"  >&lt;p&gt;fixed in trunk and 10.3 branch&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12375181">DERBY-2986</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12364915" name="derby-3032_diff.txt" size="6189" author="kmarsden" created="Fri, 31 Aug 2007 21:01:57 +0100"/>
                            <attachment id="12364916" name="derby-3032_stat.txt" size="169" author="kmarsden" created="Fri, 31 Aug 2007 21:01:57 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 30 Aug 2007 20:20:56 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23386</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ux3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38827</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>