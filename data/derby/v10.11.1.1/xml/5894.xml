<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:48:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5894/DERBY-5894.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5894] NPE in OnlineBackupTest1 while backing up in stubFileToRemoveAfterCheckPoint</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5894</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Saw this while running OnlineBackupTest1 trying to repro &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-973&quot; title=&quot;Restore fails in OnlineBackupTest1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-973&quot;&gt;DERBY-973&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;ERROR 38000: The exception &apos;java.lang.NullPointerException&apos; was thrown while evaluating an expression.&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:288)&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.unexpectedUserException(StandardException.java:575)&lt;br/&gt;
        at org.apache.derby.impl.services.reflect.ReflectMethod.invoke(ReflectMethod.java:63)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.CallStatementResultSet.open(CallStatementResultSet.java:75)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:443)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:324)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1242)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1715)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedCallableStatement.executeStatement(EmbedCallableStatement.java:118)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(EmbedPreparedStatement.java:1370)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.OnlineBackup.performBackup(OnlineBackup.java:89)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.store.OnlineBackup.run(OnlineBackup.java:60)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:637)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
        at java.util.Hashtable.put(Hashtable.java:401)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stubFileToRemoveAfterCheckPoint(BaseDataFileFactory.java:1613)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.RAFContainer.run(RAFContainer.java:1651)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.RAFContainer.backupContainer(RAFContainer.java:983)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseContainerHandle.backupContainer(BaseContainerHandle.java:1031)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.backupDataFiles(BaseDataFileFactory.java:2466)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.RawStore.backup(RawStore.java:978)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.RawStore.backup(RawStore.java:649)&lt;br/&gt;
        at org.apache.derby.impl.store.access.RAMAccessManager.backup(RAMAccessManager.java:964)&lt;br/&gt;
        at org.apache.derby.impl.db.BasicDatabase.backup(BasicDatabase.java:430)&lt;br/&gt;
        at org.apache.derby.catalog.SystemProcedures.SYSCS_BACKUP_DATABASE(SystemProcedures.java:961)&lt;br/&gt;
        at org.apache.derby.exe.acf33d40c7x0138x6d7cx6df3x0000720ad17b0.g0(Unknown Source)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:592)&lt;br/&gt;
        at org.apache.derby.impl.services.reflect.ReflectMethod.invoke(ReflectMethod.java:46)&lt;br/&gt;
        ... 10 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12601633">DERBY-5894</key>
            <summary>NPE in OnlineBackupTest1 while backing up in stubFileToRemoveAfterCheckPoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                            <label>derby_backport_reject_10_8</label>
                            <label>derby_triage10_10</label>
                    </labels>
                <created>Mon, 6 Aug 2012 23:42:58 +0100</created>
                <updated>Wed, 3 Sep 2014 09:31:42 +0100</updated>
                            <resolved>Mon, 17 Dec 2012 10:50:39 +0000</resolved>
                                                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13429544" author="dagw" created="Mon, 6 Aug 2012 23:55:33 +0100"  >&lt;p&gt;Attaching db files in d5894.zip (never mind the confusing top directory - cruft)&lt;/p&gt;</comment>
                            <comment id="13429559" author="dagw" created="Tue, 7 Aug 2012 00:08:07 +0100"  >&lt;p&gt;I checked the source for HashTable, and the NPE means the key is null, i.e. logInstant argument to stubFileToRemoveAfterCheckPoint.&lt;/p&gt;</comment>
                            <comment id="13455876" author="mikem" created="Fri, 14 Sep 2012 16:46:29 +0100"  >&lt;p&gt;triage for 10.10&lt;/p&gt;

&lt;p&gt;next step might be to run the test a number of times to get some idea how reproducible it&lt;br/&gt;
is.&lt;/p&gt;</comment>
                            <comment id="13527978" author="knutanders" created="Mon, 10 Dec 2012 14:58:31 +0000"  >&lt;p&gt;The stack trace says:&lt;/p&gt;

&lt;p&gt;        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stubFileToRemoveAfterCheckPoint(BaseDataFileFactory.java:1613)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.RAFContainer.run(RAFContainer.java:1651)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.RAFContainer.backupContainer(RAFContainer.java:983) &lt;/p&gt;

&lt;p&gt;However, backupContainer()&apos;s call to doPrivileged() is supposed to end up calling privBackupContainer(), not stubFileToRemoveAfterCheckPoint(). I think this may happen if backupContainer() is called concurrently with one of the other RAFContainer methods that call doPrivileged(). Since backupContainer() is not synchronized, a call to one of the other RAFContainer methods (in the case reported here: RAFContainer.stubbify()) in another thread may proceed and change the value of actionCode while backupContainer() is executing. This makes the switch statement in RAFContainer.run() pick the wrong action, and if the execution of stubbify() has come so far as to resetting the actionInstant field to null before backupContainer() has completed, backupContainer() may fail with the reported NullPointerException.&lt;/p&gt;

&lt;p&gt;The fix would be to synchronize backupContainer(). All the other methods in RAFContainer that call doPrivileged(), are already synchronized.&lt;/p&gt;</comment>
                            <comment id="13528857" author="knutanders" created="Tue, 11 Dec 2012 10:15:34 +0000"  >&lt;p&gt;Synchronizing backupContainer() might fix this particular NPE, but it made some tests trip over an assert in RAFContainer4.readPage(long,byte[],long). The problem is that readPage() checks whether the call is synchronized, and behaves differently if it is. And backupContainer() will end up calling readPage(), but now synchronized instead of unsynchronized, and this was unexpected. See the description of &quot;stealth mode&quot; in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4741&quot; title=&quot;Make embedded Derby work reliably in the presence of thread interrupts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4741&quot;&gt;&lt;del&gt;DERBY-4741&lt;/del&gt;&lt;/a&gt; for details.&lt;/p&gt;

&lt;p&gt;Synchronization in backupContainer() is only needed in order to protect the actionCode, actionContainerHandle and actionBackupLocation variables, and those variables are only needed because all of RAFContainer&apos;s privileged operations share one run() method, I think it&apos;s just as reasonable to keep it unsynchronized and instead let backupContainer() have its own run() method in an inner class. I even think that it&apos;s a cleaner approach in general, both because it avoids this class of bugs, and because it&apos;s more scalable as it avoids a global lock on the container for each privileged operation (not that relevant for backup, though, but still...).&lt;/p&gt;

&lt;p&gt;The tests that failed when RAFContainer.backupContainer() was made synchronized, were:&lt;/p&gt;

&lt;p&gt;lang.DatabaseClassLoadingTest&lt;br/&gt;
lang.TruncateTableAndOnlineBackupTest&lt;/p&gt;

&lt;p&gt;derbyall/storeall/storeall.fail:store/rollForwardBackup.sql&lt;br/&gt;
derbyall/storeall/storeall.fail:store/rollForwardRecovery.sql&lt;br/&gt;
derbyall/storeall/storeall.fail:store/backupRestore.sql&lt;br/&gt;
derbyall/storeall/storeall.fail:store/backupRestore1.java&lt;br/&gt;
derbyall/storeall/storeall.fail:store/OnlineBackupTest1.java&lt;br/&gt;
derbyall/storeall/storeall.fail:store/OnlineBackupTest3.java&lt;br/&gt;
derbyall/storeall/storeall.fail:storetests/st_1.sql&lt;br/&gt;
derbyall/encryptionAll/encryptionAll.fail:store/encryptDatabaseTest3.sql&lt;/p&gt;</comment>
                            <comment id="13530835" author="knutanders" created="Thu, 13 Dec 2012 09:49:06 +0000"  >&lt;p&gt;I&apos;m attaching two alternative fixes for this issue.&lt;/p&gt;

&lt;p&gt;d5894-1a-minimal-change.diff implements the minimal change to resolve the race condition. It makes backupContainer() have its own privileged action, so that there&apos;s no state shared with the other privileged operations, and hence no synchronization needed since there is no race.&lt;/p&gt;

&lt;p&gt;However, the current approach (not changed by the 1a patch) invokes the entire privBackupContainer() method in a privileged block. It&apos;s a relatively big method, and only some portions actually need to run with privileges.&lt;/p&gt;

&lt;p&gt;The alternative patch d5894-1b-minimal-privileges.diff changes backupContainer() so that it doesn&apos;t invoke all code in a privileged block. Instead, it uses helper methods with small privileged blocks that do as little as possible apart from invoking the operations that need privileges. In some cases existing helper methods could be used, but it also needed to add some new ones (for copying a file, removing a file, and creating a RandomAccessFile).&lt;/p&gt;

&lt;p&gt;Although the 1b patch adds more code than the 1a patch, I prefer the 1b patch, as it reduces the risk of accidentally giving permissions to code that&apos;s not supposed to have them. Both patches should solve the race condition, as they both ensure that backupContainer() does not use any shared state without synchronization. (I haven&apos;t reproduced the NPE, though, so I can&apos;t verify it.)&lt;/p&gt;

&lt;p&gt;Regression tests ran cleanly with both of the patches.&lt;/p&gt;</comment>
                            <comment id="13533833" author="knutanders" created="Mon, 17 Dec 2012 10:50:39 +0000"  >&lt;p&gt;I&apos;ve committed the 1b patch, revision 1422845.&lt;/p&gt;</comment>
                            <comment id="13713791" author="mamtas" created="Fri, 19 Jul 2013 17:08:34 +0100"  >&lt;p&gt;Temporarily assigning to me for the backport&lt;/p&gt;</comment>
                            <comment id="13713792" author="jira-bot" created="Fri, 19 Jul 2013 17:10:00 +0100"  >&lt;p&gt;Commit 1504928 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mamtas&quot; class=&quot;user-hover&quot; rel=&quot;mamtas&quot;&gt;Mamta A. Satoor&lt;/a&gt; in branch &apos;code/branches/10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1504928&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1504928&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5894&quot; title=&quot;NPE in OnlineBackupTest1 while backing up in stubFileToRemoveAfterCheckPoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5894&quot;&gt;&lt;del&gt;DERBY-5894&lt;/del&gt;&lt;/a&gt;(NPE in OnlineBackupTest1 while backing up in stubFileToRemoveAfterCheckPoint)&lt;/p&gt;

&lt;p&gt;Backporting to 10.9 Fix contributed by Knut.&lt;/p&gt;</comment>
                            <comment id="13714094" author="mamtas" created="Fri, 19 Jul 2013 22:26:19 +0100"  >&lt;p&gt;I tried to backport this jira (it backported fine on 10.9) to 10.8, but it turning out not to be simple svn merge. svn merge was running into conflict so I hand made the changes in 10.8 code. But this changed code is relying on code changes that are not available in 10.8(those changes went in as part of a huge check in for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5363&quot; title=&quot;Tighten permissions of DB files to owner with &amp;gt;= JDK7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5363&quot;&gt;&lt;del&gt;DERBY-5363&lt;/del&gt;&lt;/a&gt; and this jira has not made in 10.8. So, we will need to backport only partial changes from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5363&quot; title=&quot;Tighten permissions of DB files to owner with &amp;gt;= JDK7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5363&quot;&gt;&lt;del&gt;DERBY-5363&lt;/del&gt;&lt;/a&gt; to 10.8). Additionally, that partial change from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5363&quot; title=&quot;Tighten permissions of DB files to owner with &amp;gt;= JDK7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5363&quot;&gt;&lt;del&gt;DERBY-5363&lt;/del&gt;&lt;/a&gt; is using Java functionality that is not available with 10.8 JDK and hence will not compile in 10.8 without hand changing the code in quite a few places. I will go ahead and unassign myself from this jira.So far, it has been backported to 10.9. I don&apos;t plan on backporting to 10.8 right now.&lt;/p&gt;</comment>
                            <comment id="14119631" author="knutanders" created="Wed, 3 Sep 2014 09:31:42 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12560744" name="d5894-1a-minimal-change.diff" size="2888" author="knutanders" created="Thu, 13 Dec 2012 09:49:05 +0000"/>
                            <attachment id="12560745" name="d5894-1b-minimal-privileges.diff" size="10020" author="knutanders" created="Thu, 13 Dec 2012 09:49:05 +0000"/>
                            <attachment id="12539367" name="d5894.zip" size="641109" author="dagw" created="Mon, 6 Aug 2012 23:55:33 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 14 Sep 2012 15:46:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245813</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy09xb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35426</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>