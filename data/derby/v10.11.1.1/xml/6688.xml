<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:13:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6688/DERBY-6688.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6688] NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6688</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This subquery usage works:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select * from (select x from t order by row_number() over () fetch first 1 row only) tt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but this one leads to NPE in insane mode, or a Sanity ASSERT failure in sane mode:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select * from t where x =  (select x from t order by row_number() over () fetch first row only);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;leading to this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.sql.SQLException: Java exception: &apos;: java.lang.NullPointerException&apos;.
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.Util.seeNextException(Unknown Source)
        at org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)
        at derby6565.Derby6565.main(Derby6565.java:33)
Caused by: ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.
        at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.wrapArgsForTransportAcrossDRDA(Unknown Source)
        ... 11 more
Caused by: java.lang.NullPointerException
        at org.apache.derby.impl.sql.compile.UnaryOperatorNode.getReceiverInterfaceName(Unknown Source)
        at org.apache.derby.impl.sql.compile.UnaryOperatorNode.generateExpression(Unknown Source)
        at org.apache.derby.impl.sql.compile.ResultColumn.generateExpression(Unknown Source)
        at org.apache.derby.impl.sql.compile.ResultColumnList.generateEvaluatedRow(Unknown Source)
        at org.apache.derby.impl.sql.compile.ResultColumnList.generateCore(Unknown Source)
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(Unknown Source)
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.OrderByList.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.OrderByNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(Unknown Source)
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.RowCountNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.SubqueryNode.generateExpression(Unknown Source)
        at org.apache.derby.impl.sql.compile.BinaryOperatorNode.generateExpression(Unknown Source)
        at org.apache.derby.impl.sql.compile.ResultColumn.generateExpression(Unknown Source)
        at org.apache.derby.impl.sql.compile.ResultColumnList.generateEvaluatedRow(Unknown Source)
        at org.apache.derby.impl.sql.compile.ResultColumnList.generateCore(Unknown Source)
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(Unknown Source)
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.UpdateNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.StatementNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(Unknown Source)
        at org.apache.derby.impl.sql.GenericStatement.prepare(Unknown Source)
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(Unknown Source)
        ... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The immediate problem is that the field &lt;b&gt;#operand&lt;/b&gt; is null.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12732138">DERBY-6688</key>
            <summary>NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Aug 2014 22:09:13 +0100</created>
                <updated>Fri, 10 Oct 2014 19:13:30 +0100</updated>
                            <resolved>Fri, 10 Oct 2014 19:13:30 +0100</resolved>
                                    <version>10.10.2.0</version>
                                    <fixVersion>10.10.2.1</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                    <fixVersion>10.12.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14086775" author="dagw" created="Tue, 5 Aug 2014 22:15:49 +0100"  >&lt;p&gt;It is a contrived example, but there may be saner use cases, and the NPE should be addressed in any case.&lt;/p&gt;</comment>
                            <comment id="14086888" author="dagw" created="Tue, 5 Aug 2014 23:17:32 +0100"  >&lt;p&gt;It seems that in FromSubquery (used in the OK subquery) the phasing is different than in SubqueryNode (used in the failing query): the order by list is pushed down too late in the SubqueryNode (after the SelectNode#preprocess), so that the fact that the order by carries an implicit window definition isn&apos;t recorded, causing the &quot;windows&quot; field to be null, leading to missing rewriting in the getProjectRestrict phase, hence the error.&lt;/p&gt;

&lt;p&gt;In FromSubquery, the order by list is pushed down into the child select node just before calling its preprocess method, i.e. the order by is present what that happens.&lt;/p&gt;</comment>
                            <comment id="14086911" author="dagw" created="Tue, 5 Aug 2014 23:32:06 +0100"  >&lt;p&gt;This statement similarly crashes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
update t set x = x - (select x from t order by row_number() over () fetch first 1 row only)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and this is legal, I believe.&lt;/p&gt;</comment>
                            <comment id="14086915" author="dagw" created="Tue, 5 Aug 2014 23:35:40 +0100"  >&lt;p&gt;The following experimental patch makes the cited failing query and update statements work: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12659978/12659978_derby-6688.diff&quot; title=&quot;derby-6688.diff attached to DERBY-6688&quot;&gt;derby-6688.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. I need to check for regressions and add tests in any case, so not for commit.&lt;/p&gt;</comment>
                            <comment id="14086916" author="dagw" created="Tue, 5 Aug 2014 23:38:12 +0100"  >&lt;p&gt;The patch moves the pushing down of the order by in SubqueryNode#preprocess to the resultSet (the SelectNode) just before the call to preprocess of the resultSet, so the rest of the windows rewriting machinery kicks in.&lt;/p&gt;</comment>
                            <comment id="14087825" author="dagw" created="Wed, 6 Aug 2014 17:02:13 +0100"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Regressions passed.&lt;/font&gt; &lt;/p&gt;</comment>
                            <comment id="14087872" author="dagw" created="Wed, 6 Aug 2014 17:32:36 +0100"  >&lt;p&gt;Attaching version &quot;b&quot; of this patch - it now includes test cases. Please review.&lt;/p&gt;</comment>
                            <comment id="14088153" author="jira-bot" created="Wed, 6 Aug 2014 21:03:26 +0100"  >&lt;p&gt;Commit 1616332 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dagw&quot; class=&quot;user-hover&quot; rel=&quot;dagw&quot;&gt;Dag H. Wanvik&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1616332&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1616332&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6688&quot; title=&quot;NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6688&quot;&gt;&lt;del&gt;DERBY-6688&lt;/del&gt;&lt;/a&gt; NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries&lt;/p&gt;

&lt;p&gt;In FromSubquery (used in the OK subquery) the phasing is different&lt;br/&gt;
than in SubqueryNode (used in the failing query): the order by list is&lt;br/&gt;
pushed down too late in the SubqueryNode (after the&lt;br/&gt;
SelectNode#preprocess), so that the fact that the order by carries an&lt;br/&gt;
implicit window definition isn&apos;t recorded, causing the &quot;windows&quot; field&lt;br/&gt;
to be null, leading to missing rewriting in the getProjectRestrict&lt;br/&gt;
phase, hence the error.&lt;/p&gt;

&lt;p&gt;In FromSubquery, the order by list is pushed down into the child&lt;br/&gt;
select node just before calling its preprocess method, i.e. the order&lt;br/&gt;
by list is present what that happens.&lt;/p&gt;

&lt;p&gt;The patch (derby-6688-b) moves the pushing down of the order by list&lt;br/&gt;
in SubqueryNode#preprocess to the resultSet (the SelectNode) to just&lt;br/&gt;
before the call to preprocess of the resultSet, so the rest of the&lt;br/&gt;
windows rewriting machinery kicks in.&lt;/p&gt;</comment>
                            <comment id="14089368" author="jira-bot" created="Thu, 7 Aug 2014 16:55:23 +0100"  >&lt;p&gt;Commit 1616515 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dagw&quot; class=&quot;user-hover&quot; rel=&quot;dagw&quot;&gt;Dag H. Wanvik&lt;/a&gt; in branch &apos;code/branches/10.11&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1616515&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1616515&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6688&quot; title=&quot;NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6688&quot;&gt;&lt;del&gt;DERBY-6688&lt;/del&gt;&lt;/a&gt; NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries&lt;/p&gt;

&lt;p&gt;Backported from trunk with a manual merge as:&lt;/p&gt;

&lt;p&gt;svn merge -c 1616332 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In FromSubquery (used in the OK subquery) the phasing is different&lt;br/&gt;
than in SubqueryNode (used in the failing query): the order by list is&lt;br/&gt;
pushed down too late in the SubqueryNode (after the&lt;br/&gt;
SelectNode#preprocess), so that the fact that the order by carries an&lt;br/&gt;
implicit window definition isn&apos;t recorded, causing the &quot;windows&quot; field&lt;br/&gt;
to be null, leading to missing rewriting in the getProjectRestrict&lt;br/&gt;
phase, hence the error.&lt;/p&gt;

&lt;p&gt;In FromSubquery, the order by list is pushed down into the child&lt;br/&gt;
select node just before calling its preprocess method, i.e. the order&lt;br/&gt;
by list is present what that happens.&lt;/p&gt;

&lt;p&gt;The patch (derby-6688-b) moves the pushing down of the order by list&lt;br/&gt;
in SubqueryNode#preprocess to the resultSet (the SelectNode) to just&lt;br/&gt;
before the call to preprocess of the resultSet, so the rest of the&lt;br/&gt;
windows rewriting machinery kicks in.&lt;/p&gt;</comment>
                            <comment id="14164796" author="mamtas" created="Thu, 9 Oct 2014 06:42:55 +0100"  >&lt;p&gt;I will work on backporting this to 10.10&lt;/p&gt;</comment>
                            <comment id="14164798" author="mamtas" created="Thu, 9 Oct 2014 06:43:34 +0100"  >&lt;p&gt;reopening for backporting&lt;/p&gt;</comment>
                            <comment id="14167117" author="jira-bot" created="Fri, 10 Oct 2014 18:00:48 +0100"  >&lt;p&gt;Commit 1630938 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mamtas&quot; class=&quot;user-hover&quot; rel=&quot;mamtas&quot;&gt;Mamta A. Satoor&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1630938&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1630938&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6688&quot; title=&quot;NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6688&quot;&gt;&lt;del&gt;DERBY-6688&lt;/del&gt;&lt;/a&gt;(NPE (or sane: ASSERT failure) with ROW_NUMBER in some subqueries)&lt;/p&gt;

&lt;p&gt;Backporting to 10.10&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12746192">DERBY-6759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12660170" name="derby-6688-b.diff" size="4616" author="dagw" created="Wed, 6 Aug 2014 17:32:36 +0100"/>
                            <attachment id="12660171" name="derby-6688-b.status" size="802" author="dagw" created="Wed, 6 Aug 2014 17:32:36 +0100"/>
                            <attachment id="12659978" name="derby-6688.diff" size="2557" author="dagw" created="Tue, 5 Aug 2014 23:35:40 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 Aug 2014 20:03:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410167</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzsfg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410160</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>