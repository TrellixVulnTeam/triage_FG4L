<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:50:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1645/DERBY-1645.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1645] ALTER TABLE ... SET INCREMENT BY X... Turns off the &quot;Generated By Default&quot; identity column constraint</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1645</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I have a table which has an auto-generated key:&lt;/p&gt;

&lt;p&gt;create table MyTable  (&lt;br/&gt;
   TableId INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,&lt;br/&gt;
   StringValue           VARCHAR(20)           not null,&lt;br/&gt;
   constraint PK_MyTable primary key (TableId)&lt;br/&gt;
)&lt;/p&gt;

&lt;p&gt;I verify that GENERATED BY DEFAULT is set:&lt;/p&gt;

&lt;p&gt;SELECT * FROM &lt;br/&gt;
sys.syscolumns col &lt;br/&gt;
INNER JOIN sys.systables tab ON col.referenceId = tab.tableid &lt;br/&gt;
WHERE tab.tableName = &apos;MYTABLE&apos; AND ColumnName = &apos;TABLEID&apos;&lt;/p&gt;

&lt;p&gt;I&apos;m pulling in data for which I need to preserve the ID&apos;s:&lt;/p&gt;

&lt;p&gt;INSERT INTO MYTABLE (TableId, StringValue) VALUES (1, &apos;test1&apos;)&lt;br/&gt;
INSERT INTO MYTABLE (TableId, StringValue) VALUES (2, &apos;test2&apos;)&lt;br/&gt;
INSERT INTO MYTABLE (TableId, StringValue) VALUES (3, &apos;test3&apos;)&lt;/p&gt;

&lt;p&gt;In the absense of the Derby 10.2 feature (ALTER TABLE WITH RESTART X), I try to just change the INCREMENT BY value and insert a row so that I can reset the &quot;next&quot; key value:&lt;/p&gt;

&lt;p&gt;ALTER TABLE MyTable ALTER TableId SET INCREMENT BY 50&lt;/p&gt;

&lt;p&gt;Then I insert a &quot;dummy&quot; record (which I will delete later...) to move the key upwards:&lt;/p&gt;

&lt;p&gt;INSERT INTO MYTABLE (StringValue) VALUES (&apos;test53&apos;)&lt;/p&gt;

&lt;p&gt;However, I can now no longer insert explicit values into the primary key like this:&lt;/p&gt;

&lt;p&gt;INSERT INTO MYTABLE (TableId, StringValue) VALUES (-999, &apos;test3&apos;)&lt;/p&gt;

&lt;p&gt;I get this error:  SQL Exception: Attempt to modify an identity column &apos;TABLEID&apos;. &lt;/p&gt;

&lt;p&gt;Upon checking the sys.syscolumns table again, it verifies that the table no longer has an auto-generated key, but the TableId is still an identity column.&lt;/p&gt;</description>
                <environment>Both Ubuntu Linux, Windows XP... Java 1.4.2_x and Java 1.5</environment>
        <key id="12347331">DERBY-1645</key>
            <summary>ALTER TABLE ... SET INCREMENT BY X... Turns off the &quot;Generated By Default&quot; identity column constraint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="alanbrito">Alan Baldwin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Aug 2006 18:39:20 +0100</created>
                <updated>Tue, 30 Jun 2009 17:12:49 +0100</updated>
                            <resolved>Mon, 13 Nov 2006 20:41:28 +0000</resolved>
                                    <version>10.1.3.1</version>
                                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12438080" author="sv204098" created="Wed, 27 Sep 2006 11:39:16 +0100"  >&lt;p&gt;I have investigated on this issue and found out that when we create a table with &apos;GENERATED BY DEFAULT AS IDENTITY&apos; , the &apos;columnDefaultInfo&apos; attribute for ColumnDescriptor gets set to GENERATED_BY_DEFAULT. When we alter the table and set a new increment  by:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ALTER TABLE MyTable ALTER TableId SET INCREMENT BY 50&lt;br/&gt;
we override the value for &apos;columnDefaultInfo&apos; and set it to &apos;null&apos;. as &apos;GENERATED BY DEFAULT....&apos; clause is not allowed here. Now when we try to insert a row with specifying value of  &apos;TableId&apos; as :&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;INSERT INTO MYTABLE (TableId, StringValue) VALUES (-999, &apos;test3&apos;)&lt;br/&gt;
the ResultColumnList.checkAutoincrement() throws an exception&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;if ((sourceRC != null) &amp;amp;&amp;amp;&lt;br/&gt;
    (sourceRC.isAutoincrementGenerated()))&lt;br/&gt;
    &lt;/p&gt;
{
          sourceRC.setColumnDescriptor(cd.getTableDescriptor(), cd);
    }
&lt;p&gt;else&lt;/p&gt;
{
          if(cd.isAutoincAlways())   // &amp;lt;-----   SEE HERE !! 
              throw StandardException.newException(SQLState.LANG_AI_CANNOT_MODIFY_AI,
                  rc.getName());
    }

&lt;p&gt;Here, isAutoincAlways() is called for the ColumnDescriptor &apos;cd&apos; for TableId :&lt;/p&gt;

&lt;p&gt;public boolean isAutoincAlways()&lt;/p&gt;
{
        return (columnDefaultInfo == null) &amp;amp;&amp;amp; isAutoincrement();
    }

&lt;p&gt;it returns true as  &apos;columnDefaultInfo&apos; is now &apos;null&apos; and hence the exception.&lt;/p&gt;

&lt;p&gt;For this case to work correctly, ALTER TABLE should change the INCREMENT BY clause without setting the &apos;columnDefaultInfo&apos; to &apos;null&apos;. Correct me if I am wrong or if I am missing anything ??&lt;/p&gt;

&lt;p&gt;Comments / Suggestions please.&lt;/p&gt;

&lt;p&gt;Thanks in advance,&lt;br/&gt;
Saurabh&lt;/p&gt;</comment>
                            <comment id="12438133" author="bryanpendleton" created="Wed, 27 Sep 2006 15:22:33 +0100"  >&lt;p&gt;Possible duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1495&quot; title=&quot;Attempt to modify an identity column error after resetting identity column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1495&quot;&gt;&lt;del&gt;DERBY-1495&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="12438204" author="alanbrito" created="Wed, 27 Sep 2006 20:46:11 +0100"  >&lt;p&gt;They are definitely closely related.   Same symptom, different version of Derby.  1495 was logged against 10.1.3, 1645 was logged against 10.2.  Derby 10.2 introduced the &quot;ALTER TABLE WITH RESTART X&quot; clause, and 10.1.3 did not have this.  That is the only real difference.&lt;/p&gt;

&lt;p&gt;Disclaimer: I&apos;m not familiar with the code base, but I&apos;m guessing that one fix may solve both issues.&lt;/p&gt;</comment>
                            <comment id="12443455" author="sv204098" created="Thu, 19 Oct 2006 09:51:54 +0100"  >&lt;p&gt;I further investigated on this and following is the summary for that :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;when alter table is executed, ColumnDefinitionNode.validateDefault(DataDictionary dd, TableDescriptor td) get called.void&lt;/li&gt;
	&lt;li&gt;- - - - - - - - - -&lt;br/&gt;
validateDefault(DataDictionary dd, TableDescriptor td)&lt;br/&gt;
		throws StandardException&lt;br/&gt;
	{&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;		if (defaultNode == null )      // &amp;lt;--- See here&lt;br/&gt;
			return;&lt;/p&gt;

&lt;p&gt;		//Examin whether default value is autoincrement.&lt;br/&gt;
		if (isAutoincrement)&lt;/p&gt;
{
			defaultInfo = createDefaultInfoOfAutoInc();
			return;
		} &lt;br/&gt;
                ........................&lt;br/&gt;
                ........................&lt;br/&gt;
- - - - - - - - - -  &lt;br/&gt;
&lt;br/&gt;
While the alter table statement does not support &apos;GENERATED BY&apos; clause, the ModifiedColumnNode which gets created by the alter statement has defaultNode=null. Whereas for the original tree (before alter table), the defaultNode is not null and its value is available to ColumnDefinitionNode.validateDefault(DataDictionary dd, TableDescriptor td) in &apos;td&apos; but is not used in the current code. &lt;br/&gt;
&lt;br/&gt;
Thus leaving defaultInfo unset and hence  throws exception in ResultColumnList.checkAutoincrement() while checking for cd.isAutoincAlways() &lt;br/&gt;
&lt;br/&gt;
I tried to populate the defaultInfo for the  alter table case as follows : &lt;br/&gt;
&lt;br/&gt;
void validateDefault(DataDictionary dd, TableDescriptor td)&lt;br/&gt;
		throws StandardException&lt;br/&gt;
	{&lt;br/&gt;
		//Check for defalutInfo from the exisiting TableData td&lt;br/&gt;
		//and set defaultInfo &lt;br/&gt;
		if (defaultNode == null ) {
			ColumnDescriptorList cdl = td.getColumnDescriptorList();
			ColumnDescriptor cd = cdl.getColumnDescriptor(td.getUUID(), this.getColumnName());

			// Get the defaultInfo for the particular column from the exixiting values itself
			// and set it for the modified column.
			if (cd != null)
				defaultInfo = (DefaultInfoImpl)cd.getDefaultInfo();
			return;
		}&lt;br/&gt;
&lt;br/&gt;
		//Examin whether default value is autoincrement.&lt;br/&gt;
		if (isAutoincrement){
			defaultInfo = createDefaultInfoOfAutoInc();
			return;
		}
&lt;p&gt;                ................&lt;br/&gt;
                ................&lt;br/&gt;
This works fine for the following :  (For the same table MYTABLE)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ALTER TABLE MyTable ALTER TableId SET INCREMENT BY 50&lt;/li&gt;
	&lt;li&gt;INSERT INTO MYTABLE (TableId, StringValue) VALUES (123, &apos;NewTest&apos;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Well I could not provide a patch as derbyall was failing for lang/autoincrement.sql , it seems some where else it breaks the regression. I am not too clear with the sceniro. Correct me if I am wrong or if I am missing anything ??&lt;/p&gt;

&lt;p&gt;Comments / Suggestions please. &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Saurabh&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12443471" author="kristwaa" created="Thu, 19 Oct 2006 11:00:15 +0100"  >&lt;p&gt;Saurabh, your analysis seem to be identical to what &lt;br/&gt;
I reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1495&quot; title=&quot;Attempt to modify an identity column error after resetting identity column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1495&quot;&gt;&lt;del&gt;DERBY-1495&lt;/del&gt;&lt;/a&gt;. I also ran into trouble when trying to fix the problem.&lt;br/&gt;
In my case, Derby failed when clearing dependencies for the table when I dropped it.&lt;/p&gt;</comment>
                            <comment id="12449066" author="bryanpendleton" created="Sun, 12 Nov 2006 00:39:16 +0000"  >&lt;p&gt;I have attached a proposed patch to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1495&quot; title=&quot;Attempt to modify an identity column error after resetting identity column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1495&quot;&gt;&lt;del&gt;DERBY-1495&lt;/del&gt;&lt;/a&gt; which also addresses this problem, I believe.&lt;/p&gt;

&lt;p&gt;The proposed patch is slightly different from that suggested by Saurabh; I modified the&lt;br/&gt;
bindAndValidateDefault method in ModifyColumnNode to populate the defaultInfo as needed.&lt;/p&gt;</comment>
                            <comment id="12449487" author="bryanpendleton" created="Mon, 13 Nov 2006 20:41:28 +0000"  >&lt;p&gt;I&apos;ve committed the patch attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1495&quot; title=&quot;Attempt to modify an identity column error after resetting identity column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1495&quot;&gt;&lt;del&gt;DERBY-1495&lt;/del&gt;&lt;/a&gt; to subversion&lt;br/&gt;
as revision 474502. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1495&quot; title=&quot;Attempt to modify an identity column error after resetting identity column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1495&quot;&gt;&lt;del&gt;DERBY-1495&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1645&quot; title=&quot;ALTER TABLE ... SET INCREMENT BY X... Turns off the &amp;quot;Generated By Default&amp;quot; identity column constraint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1645&quot;&gt;&lt;del&gt;DERBY-1645&lt;/del&gt;&lt;/a&gt; are not&lt;br/&gt;
precisely speaking duplicates, but as was noted in the comments above,&lt;br/&gt;
a single fix resolves both problems. The patch changes the ALTER TABLE&lt;br/&gt;
handling so that the parts of the identify column that you aren&apos;t altering&lt;br/&gt;
are preserved and not incorrectly reset.&lt;/p&gt;</comment>
                            <comment id="12450028" author="alanbrito" created="Wed, 15 Nov 2006 13:53:14 +0000"  >&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1495&quot; title=&quot;Attempt to modify an identity column error after resetting identity column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1495&quot;&gt;&lt;del&gt;DERBY-1495&lt;/del&gt;&lt;/a&gt; was backported to version 10.2, can we assume that this issue was as well?&lt;/p&gt;</comment>
                            <comment id="12450058" author="bryanpendleton" created="Wed, 15 Nov 2006 15:20:57 +0000"  >&lt;p&gt;Thanks Alan for catching this. Yes, this fix is now in the 10.2 branch as well. Updated Fix Version to reflect this.&lt;/p&gt;</comment>
                            <comment id="12450059" author="kristwaa" created="Wed, 15 Nov 2006 15:21:44 +0000"  >&lt;p&gt;Yes, since the patch is a fix for both issues, you should not see the bug with the head of the 10.2 branch anymore (or with trunk).&lt;br/&gt;
I assume the Fix Version field will be updated properly.&lt;/p&gt;

&lt;p&gt;Note that to obtain the fix, you will have to build Derby yourself until a new release is out.&lt;br/&gt;
If you try it out, we would appreciate a confirmation that the patch fixes the problem you saw.&lt;/p&gt;</comment>
                            <comment id="12551391" author="fuzzylogic" created="Thu, 13 Dec 2007 09:05:08 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12345725">DERBY-1495</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Sep 2006 10:39:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22619</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0uhb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38756</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>