<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:48:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3710/DERBY-3710.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3710] cannot access a database using AES encryption with encryptionKeyLength=192 after it&apos;s been shutdown</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3710</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Accessing a database created using encryptionAlgorithm: AES/CBC/NoPadding, and encryptionKeyLength=192 after it&apos;s been shutdown fails like so:&lt;br/&gt;
-----------------------&lt;br/&gt;
ERROR XJ040: Failed to start database &apos;encdbcbc_192&apos;, see the next exception for details.&lt;br/&gt;
ERROR XBM06: Startup failed. An encrypted database cannot be accessed without the correct boot password.&lt;br/&gt;
----------------------&lt;/p&gt;

&lt;p&gt;This does not occur when you use encryptionKeyLength=128 (does not require unrestricted jars) nor encryptionKeyLength=256 (does require unrestricted policy jars).&lt;/p&gt;

&lt;p&gt;Note: our test (in derbyall): store/aes.sql does not test this, firstly it doesn&apos;t test the larger sizes (because it would diff &amp;amp; fail unless you have been able to adjust your jvm&apos;s policy jars), and secondly it doesn&apos;t shutdown before reconnecting.&lt;/p&gt;
</description>
                <environment>reproduced with ibm&amp;#39;s jdk 1.5 and 1.6, and sun&amp;#39;s jdk15. &lt;br/&gt;
AES encryption with encryptionKeyLength=192 requires unrestricted security policy jars on your jvm</environment>
        <key id="12397524">DERBY-3710</key>
            <summary>cannot access a database using AES encryption with encryptionKeyLength=192 after it&apos;s been shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="myrna">Myrna van Lunteren</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Jun 2008 23:12:04 +0100</created>
                <updated>Thu, 13 Jan 2011 21:36:04 +0000</updated>
                            <resolved>Tue, 4 Aug 2009 14:25:16 +0100</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.5.3.0</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12602485" author="myrna" created="Wed, 4 Jun 2008 23:18:37 +0100"  >&lt;p&gt;attaching an sql script based on store/aes.sql. Run with ij; if you have unrestricted policy jars in place, and the bug occurs, you&apos;ll see a failure only with encryptionKeyLength=192. &lt;br/&gt;
(if you don&apos;t have the unrestricted policy jars, creation of the database with 192 or 256 length will fail).&lt;/p&gt;</comment>
                            <comment id="12727033" author="knutanders" created="Fri, 3 Jul 2009 17:19:18 +0100"  >&lt;p&gt;Triaged for 10.5.2.&lt;/p&gt;</comment>
                            <comment id="12736761" author="rhillegas" created="Wed, 29 Jul 2009 20:09:45 +0100"  >&lt;p&gt;Attaching a slightly simpler repro-3710.sql. I have verified this behavior on the Apple Java 6 beta for 32-bit Intel machines.&lt;/p&gt;</comment>
                            <comment id="12737171" author="rhillegas" created="Thu, 30 Jul 2009 17:49:32 +0100"  >&lt;p&gt;I believe that the bug is caused by special logic in JCECipherFactory. For AES encryption, we pad the encryption key to a 16 byte boundary. This means that for AES encryption, a 192 bit key is extended to 256 bits. An MD5 digest is appended to the encrypted key. At initial boot time, this digest is computed on the unpadded value. But on subsequent boots, we check the stored digest against a digest computed on the padded value. The reboot fails because the unpadded digest does not equal the padded digest. I will submit a patch and test for this.&lt;/p&gt;</comment>
                            <comment id="12737233" author="rhillegas" created="Thu, 30 Jul 2009 19:59:33 +0100"  >&lt;p&gt;Attaching derby-3710-01-aa-digestPaddedPassword.diff. This patch fixes encryption to store a digest computed from the padded password rather than the unpadded password. Although this changes what is stored in service.properties, I don&apos;t believe that this affects existing applications. That is because this bug would have caused reboot failures in all cases where the value in service.properties has changed. I will run regression tests later today.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;


&lt;p&gt;M      java/engine/org/apache/derby/impl/services/jce/JCECipherFactory.java&lt;/p&gt;

&lt;p&gt;Store a digest computed from the padded password rather than the unpadded password.&lt;/p&gt;


&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/store/EncryptionAESTest.java&lt;/p&gt;

&lt;p&gt;Remove the logic which disabled tests for 192 bit encryption. Those tests had been disabled because of this bug. Now they run again.&lt;/p&gt;

&lt;p&gt;Also add a new test case to make sure that a different version of this bug isn&apos;t lurking. The new test case changes the bootpassword, shuts down, and then reboots using the new password.&lt;/p&gt;</comment>
                            <comment id="12737312" author="dagw" created="Thu, 30 Jul 2009 22:48:04 +0100"  >&lt;p&gt;Thanks for this fix, Rick. I had a look at it, and the fix seems reasonable (caveat: unfamiliar code to me). However, I could not make the (old or new) test fail even without the patch to JCECipherFactory - maybe this is just accidental because the digest ignores 0-filled bytes.&lt;/p&gt;

&lt;p&gt;The inner class EncryptedKeyResult should probably be made private.&lt;/p&gt;</comment>
                            <comment id="12737530" author="rhillegas" created="Fri, 31 Jul 2009 15:02:34 +0100"  >&lt;p&gt;Thanks for the quick review, Dag. Attaching a second rev of the patch which makes the tuple inner class private as you suggested: derby-3710-01-ab-digestPaddedPassword.diff.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure why the tests don&apos;t work in your environment. One thing I have noticed about this test class is that all sorts of unexpected errors are intercepted in EncryptionAESTest.createAndPopulateDB(). So, for instance, the 192 bit test cases don&apos;t run for me under Java 5 because I get an unsupported key length exception on that platform--the test class swallows that exception, skips the test case, and continues merrily along. Have you tried Myrna&apos;s repro with and without the patch? Don&apos;t bother with my repro: if your platform doesn&apos;t support 192 bit encryption, then my repro will fail because of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4329&quot; title=&quot;If you try to create an in-memory database with an illegal encryption key size, you get an ASSERT failure rather than a diagnostic telling you that the key size is unsupported.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4329&quot;&gt;DERBY-4329&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The full regression tests ran cleanly for me on Java 5 on my Mac-&lt;del&gt;however, as I noted, on that platform the 192 bit test cases are silently ignored. Those test cases do run correctly for me on the beta Java 6 which I&apos;m running on my Mac and, on that platform, the old-style harness tests run cleanly for me too. However, the full JUnit suite hangs for me on that platform&lt;/del&gt;-with and without this patch.&lt;/p&gt;

&lt;p&gt;It seems to me that this patch fixes the problem and does not introduce any regressions which I can detect.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12737638" author="myrna" created="Fri, 31 Jul 2009 19:23:41 +0100"  >&lt;p&gt;for what it&apos;s worth...&lt;br/&gt;
The troublesome thing with encryptionAESTest was that encryption lengths &amp;gt; 128 require unrestricted policy files which don&apos;t get installed by default, and aren&apos;t available to everyone in the world. So there was the choice between introducing false failures for  those people who might try to run the tests without them, or risking the tests cases not getting run unnoticed.&lt;br/&gt;
Perhaps we should at least &lt;b&gt;always&lt;/b&gt; print out the text indicating the unrestricted policy jar files aren&apos;t available (currently it&apos;s in a if (TestConfiguration.getCurrent().doTrace()) block, so only will show up if you run with -Dderby.tests.trace=true). &lt;/p&gt;

&lt;p&gt;Note also &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4325&quot; title=&quot;Add a property that forces testEncryptionKeyLenths to run with key lengths 192 and 256&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4325&quot;&gt;DERBY-4325&lt;/a&gt; which has a further suggestion for improvement to the encryptionAESTest.&lt;/p&gt;</comment>
                            <comment id="12737754" author="dagw" created="Fri, 31 Jul 2009 23:42:31 +0100"  >&lt;p&gt;Right; thanks Rick and Myrna, that was it apparently:&lt;/p&gt;

&lt;p&gt;with this change in the test:&lt;br/&gt;
        :&lt;br/&gt;
 @@ -383,6 +388,11 @@&lt;br/&gt;
         catch (SQLException e) {&lt;br/&gt;
             // if it fails, it should only be because of non-existing&lt;br/&gt;
             // support for unrestricted encryption policy.&lt;br/&gt;
+            System.err.println(&quot;restricted encryption policy: &quot; + algorithm);&lt;br/&gt;
+            for (int i=0; i &amp;lt; otherAttributes.length; i++) &lt;/p&gt;
{
+                System.err.println(&quot;attr: &quot; + otherAttributes[i]);
+            }
&lt;p&gt;+&lt;/p&gt;

&lt;p&gt;I see:&lt;/p&gt;

&lt;p&gt;java -client -Xms128M -Xmx512M -XX:MaxPermSize=128m -DderbyTesting.oldReleasePath=/usr/local/share/java/derby/lib-debug junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.store.EncryptionAESTest&lt;br/&gt;
...restricted encryption policy: AES/CBC/NoPadding&lt;br/&gt;
attr: encryptionKeyLength=192&lt;br/&gt;
attr: bootPassword=Thursday&lt;br/&gt;
restricted encryption policy: AES/CBC/NoPadding&lt;br/&gt;
attr: encryptionKeyLength=256&lt;br/&gt;
attr: bootPassword=Thursday&lt;/p&gt;

&lt;p&gt;so I guess what I saw is expected. I guess I can&apos;t get hold of the unrestricted policy jars? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="12738361" author="rhillegas" created="Mon, 3 Aug 2009 15:28:06 +0100"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;Have you tried downloading and installing the &quot;Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files 6&quot; from &lt;a href=&quot;http://java.sun.com/javase/downloads/index.jsp&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/javase/downloads/index.jsp&lt;/a&gt; ? Are you not allowed to use this strong encryption because you live in Norway?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="12738383" author="rhillegas" created="Mon, 3 Aug 2009 16:13:55 +0100"  >&lt;p&gt;Hi Myrna,&lt;/p&gt;

&lt;p&gt;Could you verify whether this patch fixes the problem? Thanks!&lt;/p&gt;</comment>
                            <comment id="12738401" author="dagw" created="Mon, 3 Aug 2009 16:56:59 +0100"  >&lt;p&gt;Rick, I was able to download it now. I just never realized I needed to download separately to be able to run all&lt;br/&gt;
tests. Should it mentioned in testing/README.htm?&lt;/p&gt;</comment>
                            <comment id="12738404" author="rhillegas" created="Mon, 3 Aug 2009 17:04:44 +0100"  >&lt;p&gt;Thanks, Dag, I think that is a good suggestion.&lt;/p&gt;</comment>
                            <comment id="12738465" author="myrna" created="Mon, 3 Aug 2009 19:06:52 +0100"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I confirmed that with the patch installed, the problem hit by the repros is no longer present. The patch looks good to me.  (I tested with IBM1.6 SR5 with unrestricted policy jars installed).&lt;/p&gt;</comment>
                            <comment id="12738967" author="rhillegas" created="Tue, 4 Aug 2009 14:20:41 +0100"  >&lt;p&gt;Thanks Dag and Myrna. I have committed derby-3710-01-ab-digestPaddedPassword.diff at subversion revision 800773.&lt;/p&gt;</comment>
                            <comment id="12738971" author="rhillegas" created="Tue, 4 Aug 2009 14:25:03 +0100"  >&lt;p&gt;Ported revision 800773 from trunk to 10.5 branch at revision 800774.&lt;/p&gt;</comment>
                            <comment id="12740250" author="dagw" created="Thu, 6 Aug 2009 22:05:32 +0100"  >&lt;p&gt;I have added a new section to platform specific hints on how to run JUnit tests:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/db-derby/JunitVmIssues&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/JunitVmIssues&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;called &quot;Sun Java 1.4.2, 1.5 and 1.6: unlimited cryptography policies&quot; so testers are able to install what&apos;s needed to run the complete set of encryption tests.&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12438802">DERBY-4418</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12431620">DERBY-4325</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12397526">DERBY-3711</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12415051" name="derby-3710-01-aa-digestPaddedPassword.diff" size="5922" author="rhillegas" created="Thu, 30 Jul 2009 19:59:33 +0100"/>
                            <attachment id="12415124" name="derby-3710-01-ab-digestPaddedPassword.diff" size="5923" author="rhillegas" created="Fri, 31 Jul 2009 15:02:34 +0100"/>
                            <attachment id="12414935" name="repro-3710.sql" size="2213" author="rhillegas" created="Wed, 29 Jul 2009 20:09:45 +0100"/>
                            <attachment id="12383421" name="repro.sql" size="2796" author="myrna" created="Wed, 4 Jun 2008 23:18:37 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Jul 2009 16:19:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23802</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0njz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37634</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>