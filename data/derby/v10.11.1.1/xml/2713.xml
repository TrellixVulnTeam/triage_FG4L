<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:20:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2713/DERBY-2713.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2713] Ensure that a temporary file is not created for a lob obtained from resultset unless user updates it.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2713</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Currently LOBStreamControl has a buffer limit of 4k if the lob is larger than this a temporary file is created. Ensure that lob data is kept in memory unless user start to update it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12370396">DERBY-2713</key>
            <summary>Ensure that a temporary file is not created for a lob obtained from resultset unless user updates it.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anurag">Anurag Shekhar</assignee>
                                    <reporter username="anurag">Anurag Shekhar</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 May 2007 11:12:49 +0100</created>
                <updated>Fri, 15 Jun 2007 13:37:33 +0100</updated>
                            <resolved>Thu, 7 Jun 2007 15:40:23 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12499524" author="anurag" created="Mon, 28 May 2007 11:23:12 +0100"  >&lt;p&gt;This patch conflicts with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2646&quot; title=&quot;Cleanup of Clob control/support structures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2646&quot;&gt;&lt;del&gt;DERBY-2646&lt;/del&gt;&lt;/a&gt;. I will redo this patch once &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2646&quot; title=&quot;Cleanup of Clob control/support structures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2646&quot;&gt;&lt;del&gt;DERBY-2646&lt;/del&gt;&lt;/a&gt; is done.&lt;/p&gt;

&lt;p&gt;In this patch I have modified LOBStreamControl to keep the buffer at least as big as the initial byte array. If the initial size is smaller than 4k the buffer size will be set to 4k.&lt;/p&gt;

&lt;p&gt;To ensure the initial byte array is kept in memory and not on file its necessary to pass the initial byte array in the constructor. If the LOBStreamControl receives byte array in constructor it sets the buffer size to max of 4k and buffer size.&lt;/p&gt;

&lt;p&gt;A similar constructor is introduced for CLOBStreamControl too.&lt;/p&gt;

&lt;p&gt;File affected&lt;br/&gt;
java/engine/org/apache/derby/impl/jdbc/EmbedBlob.java&lt;br/&gt;
java/engine/org/apache/derby/impl/jdbc/EmbedClob.java&lt;/p&gt;

&lt;p&gt;Modified the initialization of control class to use constructor with initial data.&lt;/p&gt;

&lt;p&gt;java/engine/org/apache/derby/impl/jdbc/ClobStreamControl.java&lt;br/&gt;
java/engine/org/apache/derby/impl/jdbc/LOBStreamControl.java&lt;/p&gt;


&lt;p&gt;Added new constructor to accept initial data (byte array for LOBStreamControl and String for ClobStreamControl).&lt;/p&gt;

&lt;p&gt;Both the constrictors now call newly introduced LOBStreamControl.initControl to ensure initial buffer size is set.&lt;/p&gt;</comment>
                            <comment id="12500721" author="knutanders" created="Fri, 1 Jun 2007 15:19:25 +0100"  >&lt;p&gt;Hi Anurag, I looked at the patch and have a couple of questions:&lt;/p&gt;

&lt;p&gt;1) LOBStreamControl calls a protected method initControl() from its constructor to set the buffer size. Wouldn&apos;t it be better to put that code into the new constructor? That would allow bufferSize to be final.&lt;/p&gt;

&lt;p&gt;2) The new constructor for LOBStreamControl is only used by EmbedBlob(byte[],EmbedConnection). Shouldn&apos;t it also have been used by EmbedBlob(DataValueDescriptor,EmbedConnection) when dvd.getStream() returns null?&lt;/p&gt;

&lt;p&gt;3) Should EmbedClob(String,EmbedConnection) have used the new ClobStreamControl constructor?&lt;/p&gt;

&lt;p&gt;4) I was wondering, should LOBStreamControl.init() set dataBytes to null? It doesn&apos;t seem to be used after init() has been called.&lt;/p&gt;

&lt;p&gt;5) I noticed this diff:&lt;br/&gt;
         while (sz &amp;lt; length) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int len = (int) (((length - sz) &amp;gt;= MAX_BUF_SIZE) ? MAX_BUF_SIZE&lt;br/&gt;
+            int len = (int) (((length - sz) &amp;gt;= bufferSize) ? bufferSize&lt;br/&gt;
                     : length - sz);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Would it have been clearer if it was written as Math.min(...)?&lt;/p&gt;

&lt;p&gt;6) Typos in class javadoc for LOBStreamControl: &quot;suplied&quot; -&amp;gt; &quot;supplied&quot;, &quot;indial&quot; -&amp;gt; &quot;initial&quot;&lt;/p&gt;

&lt;p&gt;7) Could you reword this comment in LOBStreamControl? It&apos;s not quite clear to me what it means.&lt;br/&gt;
&quot;If the class is created with initial data, the buffer &lt;br/&gt;
+ * size is set to the size of the byte array suplied the buffer size is set&lt;br/&gt;
+ * to DEFAULT_MAX_BUF_SIZE is an empty LOBStreamControl is created or if the &lt;br/&gt;
+ * initial data is smaller than DEFAULT_MAX_BUF_SIZE.&quot;&lt;/p&gt;

&lt;p&gt;8) Typos in javadoc for LOBStreamControl.initControl(): &quot;initialzes&quot; -&amp;gt; &quot;initializes&quot;, &quot;initialze&quot; -&amp;gt; &quot;initialize&quot;&lt;/p&gt;</comment>
                            <comment id="12502285" author="anurag" created="Thu, 7 Jun 2007 10:51:49 +0100"  >&lt;p&gt;1) LOBStreamControl calls a protected method initControl() from its constructor to set the buffer size. Wouldn&apos;t it be better to put that code into the new constructor? That would allow bufferSize to be final.&lt;/p&gt;

&lt;p&gt;changed it to final. &lt;/p&gt;

&lt;p&gt;2) The new constructor for LOBStreamControl is only used by EmbedBlob(byte[],EmbedConnection). Shouldn&apos;t it also have been used by EmbedBlob(DataValueDescriptor,EmbedConnection) when dvd.getStream() returns null?&lt;/p&gt;

&lt;p&gt;changed to use new constructor from EmbedBlob when dvd doesn&apos;t have stream.&lt;/p&gt;

&lt;p&gt;3) Should EmbedClob(String,EmbedConnection) have used the new ClobStreamControl constructor?&lt;/p&gt;

&lt;p&gt;This constructor is now removed as part of  clob cleanup.&lt;/p&gt;

&lt;p&gt;4) I was wondering, should LOBStreamControl.init() set dataBytes to null? It doesn&apos;t seem to be used after init() has been called.&lt;/p&gt;

&lt;p&gt;added code to set dataBytes to null in init&lt;/p&gt;

&lt;p&gt;5) I noticed this diff:&lt;br/&gt;
         while (sz &amp;lt; length) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int len = (int) (((length - sz) &amp;gt;= MAX_BUF_SIZE) ? MAX_BUF_SIZE&lt;br/&gt;
+ int len = (int) (((length - sz) &amp;gt;= bufferSize) ? bufferSize&lt;br/&gt;
                     : length - sz);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Would it have been clearer if it was written as Math.min(...)?&lt;/p&gt;

&lt;p&gt;changed it to use Math.min&lt;/p&gt;

&lt;p&gt;6) Typos in class javadoc for LOBStreamControl: &quot;suplied&quot; -&amp;gt; &quot;supplied&quot;, &quot;indial&quot; -&amp;gt; &quot;initial&quot;&lt;/p&gt;

&lt;p&gt;fixed&lt;/p&gt;

&lt;p&gt;7) Could you reword this comment in LOBStreamControl? It&apos;s not quite clear to me what it means.&lt;br/&gt;
&quot;If the class is created with initial data, the buffer&lt;br/&gt;
+ * size is set to the size of the byte array suplied the buffer size is set&lt;br/&gt;
+ * to DEFAULT_MAX_BUF_SIZE is an empty LOBStreamControl is created or if the&lt;br/&gt;
+ * initial data is smaller than DEFAULT_MAX_BUF_SIZE.&quot;&lt;/p&gt;

&lt;p&gt;rephrased to comment.&lt;/p&gt;

&lt;p&gt;8) Typos in javadoc for LOBStreamControl.initControl(): &quot;initialzes&quot; -&amp;gt; &quot;initializes&quot;, &quot;initialze&quot; -&amp;gt; &quot;initialize&quot;&lt;/p&gt;

&lt;p&gt;fixed&lt;/p&gt;</comment>
                            <comment id="12502367" author="knutanders" created="Thu, 7 Jun 2007 15:40:23 +0100"  >&lt;p&gt;Thanks, Anurag! Committed revision 545197.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12358362" name="derby-2713.diff" size="8016" author="anurag" created="Mon, 28 May 2007 11:23:12 +0100"/>
                            <attachment id="12359159" name="derby-2713v2.diff" size="8625" author="anurag" created="Thu, 7 Jun 2007 10:51:49 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 1 Jun 2007 14:19:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23197</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy11tj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39945</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>