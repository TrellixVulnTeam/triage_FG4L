<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5161/DERBY-5161.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5161] Cannot rollback after syntax error in internal statement</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5161</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;To reproduce, execute the statements below in ij. Can only be reproduced this way before &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5157&quot; title=&quot;Incomplete quoting of SQL identifiers in AlterTableConstantAction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5157&quot;&gt;&lt;del&gt;DERBY-5157&lt;/del&gt;&lt;/a&gt;. I don&apos;t know how to reproduce it when that bug is fixed.&lt;/p&gt;

&lt;p&gt;ij version 10.7&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:db;create=true&apos;;&lt;br/&gt;
ij&amp;gt; autocommit off;&lt;br/&gt;
ij&amp;gt; create table t(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; alter table t add column &quot;&quot;&quot;&quot; int default 42;&lt;br/&gt;
ERROR 42X01: Syntax error: Encountered &quot;\&quot;&quot; at line 1, column 22.&lt;br/&gt;
Issue the &apos;help&apos; command for general information on IJ command syntax.&lt;br/&gt;
Any unrecognized commands are treated as potential SQL commands and executed directly.&lt;br/&gt;
Consult your DBMS server reference documentation for details of the SQL syntax supported by your server.&lt;br/&gt;
ij&amp;gt; rollback;&lt;br/&gt;
ERROR X0Y67: Cannot issue rollback in a nested connection when there is a pending operation in the parent connection.&lt;/p&gt;

&lt;p&gt;The error message implies that we&apos;ve called rollback() on a nested transaction, whereas we&apos;re in fact called it on the parent transaction.&lt;/p&gt;

&lt;p&gt;Expected result: The rollback statement should abort the transaction without raising any errors.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12502679">DERBY-5161</key>
            <summary>Cannot rollback after syntax error in internal statement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Mar 2011 09:52:29 +0100</created>
                <updated>Fri, 9 Sep 2011 10:55:16 +0100</updated>
                            <resolved>Wed, 30 Mar 2011 13:14:51 +0100</resolved>
                                    <version>10.7.1.1</version>
                                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13012397" author="knutanders" created="Tue, 29 Mar 2011 10:00:01 +0100"  >&lt;p&gt;The rollback exception is raised by this code in GenericLanguageConnectionContext.doRollback():&lt;/p&gt;

&lt;p&gt;        StatementContext statementContext = getStatementContext();&lt;br/&gt;
        if (requestedByUser &amp;amp;&amp;amp;&lt;br/&gt;
            (statementContext != null) &amp;amp;&amp;amp;&lt;br/&gt;
            statementContext.inUse() &amp;amp;&amp;amp;&lt;br/&gt;
            statementContext.isAtomic())&lt;/p&gt;
        {
            throw StandardException.newException(SQLState.LANG_NO_ROLLBACK_IN_NESTED_CONNECTION);
        }

&lt;p&gt;So it seems the problem is that the statement context wasn&apos;t popped from the stack when the internal statement failed.&lt;/p&gt;

&lt;p&gt;Looking at the code in GenericStatement.prepMinion(), in which the failing call to parseStatement() is invoked, there is a try/finally block that ensures the compiler context is popped from the stack, but the statement context isn&apos;t popped until after the finally clause, and may therefore be forgotten in the case of a failure. I think we may want to move the call to popStatementContext() into the finally clause.&lt;/p&gt;</comment>
                            <comment id="13012400" author="knutanders" created="Tue, 29 Mar 2011 10:12:42 +0100"  >&lt;p&gt;Attaching a patch that moves popStatementContext() into a finally clause. Now the repro doesn&apos;t fail when invoking rollback:&lt;/p&gt;

&lt;p&gt;ij version 10.8&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:db;create=true&apos;;&lt;br/&gt;
ij&amp;gt; autocommit off;&lt;br/&gt;
ij&amp;gt; create table t(x int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; alter table t add column &quot;&quot;&quot;&quot; int default 42;&lt;br/&gt;
ERROR 42X01: Syntax error: Encountered &quot;\&quot;&quot; at line 1, column 22.&lt;br/&gt;
Issue the &apos;help&apos; command for general information on IJ command syntax.&lt;br/&gt;
Any unrecognized commands are treated as potential SQL commands and executed directly.&lt;br/&gt;
Consult your DBMS server reference documentation for details of the SQL syntax supported by your server.&lt;br/&gt;
ij&amp;gt; rollback;&lt;br/&gt;
ij&amp;gt; &lt;/p&gt;

&lt;p&gt;I haven&apos;t run any other tests yet. No regression tests have been added since I don&apos;t know how to reproduce the problem without backing out &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5157&quot; title=&quot;Incomplete quoting of SQL identifiers in AlterTableConstantAction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5157&quot;&gt;&lt;del&gt;DERBY-5157&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13012462" author="dagw" created="Tue, 29 Mar 2011 13:45:57 +0100"  >&lt;p&gt;So, this explains the hang I saw in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5157&quot; title=&quot;Incomplete quoting of SQL identifiers in AlterTableConstantAction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5157&quot;&gt;&lt;del&gt;DERBY-5157&lt;/del&gt;&lt;/a&gt; with the new test cases present and the code changes backed out. Looks like a good fix to me if regressions pass. Although we should not normally see syntax errors in internal statements, its good that&lt;br/&gt;
the error handling is correct if it ever happens.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13012472" author="knutanders" created="Tue, 29 Mar 2011 14:21:39 +0100"  >&lt;p&gt;I ran the regression tests on the finally.diff patch and saw two failures in derbyall:&lt;/p&gt;

&lt;p&gt;lang/subquery.sql&lt;br/&gt;
lang/subquery2.sql&lt;/p&gt;

&lt;p&gt;All diffs were similar to this one:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;
			&lt;ul&gt;
				&lt;li&gt;
				&lt;ul&gt;
					&lt;li&gt;
					&lt;ul&gt;
						&lt;li&gt;
						&lt;ul&gt;
							&lt;li&gt;
							&lt;ul&gt;
								&lt;li&gt;
								&lt;ul&gt;
									&lt;li&gt;Diff file derbyall/derbylang/subquery2.diff&lt;/li&gt;
								&lt;/ul&gt;
								&lt;/li&gt;
							&lt;/ul&gt;
							&lt;/li&gt;
						&lt;/ul&gt;
						&lt;/li&gt;
					&lt;/ul&gt;
					&lt;/li&gt;
				&lt;/ul&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;Start: subquery2 jdk1.6.0_21 derbyall:derbylang 2011-03-29 14:03:32 ***&lt;br/&gt;
1017 del&lt;br/&gt;
&amp;lt; 2 dependencies found                                                                                        &lt;br/&gt;
1017a1017&lt;br/&gt;
&amp;gt; 12 dependencies found                                                                                       &lt;br/&gt;
Test Failed.&lt;/li&gt;
			&lt;li&gt;End:   subquery2 jdk1.6.0_21 derbyall:derbylang 2011-03-29 14:03:44 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem appears to be that some dependencies aren&apos;t cleared when we pop the statement context after a syntax error. I think we should use StatementContext.cleanupOnError() instead of LanguageConnectionContext.popStatementContext() when an exception has been thrown. cleanupOnError() will call popStatementContext() after first clearing the dependencies that made subquery.sql and subquery2.sql fail.&lt;/p&gt;

&lt;p&gt;The attached patch cleanupOnError.diff changes GenericStatement.prepMinion() so that it uses cleanupOnError() in the exception case. subquery.sql and subquery2.sql pass with that change, and the patch still fixes the rollback error in the bug repro.&lt;/p&gt;</comment>
                            <comment id="13012925" author="knutanders" created="Wed, 30 Mar 2011 13:14:51 +0100"  >&lt;p&gt;All regression tests ran cleanly with the patch. Committed revision 1086920.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12502569">DERBY-5157</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12510497">DERBY-5280</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12522398">DERBY-5406</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12474878" name="cleanupOnError.diff" size="561" author="knutanders" created="Tue, 29 Mar 2011 14:21:39 +0100"/>
                            <attachment id="12474861" name="finally.diff" size="691" author="knutanders" created="Tue, 29 Mar 2011 10:12:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 29 Mar 2011 12:45:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24683</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36299</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>