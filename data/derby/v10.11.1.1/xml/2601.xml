<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:28:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2601/DERBY-2601.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2601] Server SQLException error codes are not returned to client</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2601</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;ErrorCodes from returned SQLExceptions are not retained in client.  e.g. in the example below, client reports an errorcode of -1 instead of 30000.    If DRDA allows it would be good for the errorCode to be retained&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;C:/test&amp;#93;&lt;/span&gt; java -Dij.showErrorCode=true org.apache.derby.tools.ij&lt;br/&gt;
ij version 10.3&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:wombat&apos;;&lt;br/&gt;
ij&amp;gt; create table t(i nt, s smallint);&lt;br/&gt;
ERROR 42X01: Syntax error: Encountered &quot;&quot; at line 1, column 18. (errorCode = 30000)&lt;br/&gt;
ij&amp;gt; exit;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;C:/test&amp;#93;&lt;/span&gt; ns start -noSecurityManager &amp;amp;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;     5712&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;C:/test&amp;#93;&lt;/span&gt; Apache Derby Network Server - 10.3.0.0 alpha - (1) started and ready to accept connections on port 1527 at 200&lt;br/&gt;
7-04-20 17:36:27.188 GMT&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;C:/test&amp;#93;&lt;/span&gt; java -Dij.showErrorCode=true org.apache.derby.tools.ij&lt;br/&gt;
ij version 10.3&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby://localhost:1527/wombat&apos;;&lt;br/&gt;
ij&amp;gt; create table t(i nt, s smallint);&lt;br/&gt;
ERROR 42X01: Syntax error: Encountered &quot;&quot; at line 1, column 18. (errorCode = -1)&lt;br/&gt;
ij&amp;gt;&lt;/p&gt;

&lt;p&gt;Once this has been fixed ErrorCodeTest can be enabled for client.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12368475">DERBY-2601</key>
            <summary>Server SQLException error codes are not returned to client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                            <label>derby_backport_reject_10_9</label>
                            <label>derby_triage10_9</label>
                    </labels>
                <created>Wed, 2 May 2007 17:48:10 +0100</created>
                <updated>Fri, 15 Nov 2013 08:15:17 +0000</updated>
                            <resolved>Tue, 18 Sep 2012 15:24:58 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13283283" author="knutanders" created="Fri, 25 May 2012 11:20:13 +0100"  >&lt;p&gt;Attaching d2601-1a.diff which makes the server send error codes to the&lt;br/&gt;
client. Derbyall, suites.All and the compatibility test passed with&lt;br/&gt;
the patch.&lt;/p&gt;

&lt;p&gt;In the current code, when an exception happens on the server, the&lt;br/&gt;
server always sends an SQLCARD with SQLCODE=-1, and this value is used&lt;br/&gt;
as error code when the client generates the SQLException.&lt;/p&gt;

&lt;p&gt;Simply changing the server to send the actual error code in the&lt;br/&gt;
SQLCODE field wouldn&apos;t work, though, since the client uses the sign of&lt;br/&gt;
the SQLCODE to tell whether the condition is a warning or an error.&lt;br/&gt;
Positive values are interpreted as warnings, and negative as errors.&lt;/p&gt;

&lt;p&gt;The client doesn&apos;t depend on the negative value being -1, so we could&lt;br/&gt;
send any negative value to tell that an error occurred. The patch&lt;br/&gt;
exploits this by encoding the always non-negative error code seen on&lt;br/&gt;
the server as a negative value in the SQL code:&lt;/p&gt;

&lt;p&gt;  sqlCode = -errorCode - 1&lt;/p&gt;

&lt;p&gt;When the client generates an SQLException, it can convert the SQL code&lt;br/&gt;
back to the original error code:&lt;/p&gt;

&lt;p&gt;  errorCode = -sqlCode - 1&lt;/p&gt;

&lt;p&gt;More detailed description of the changes:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;drda/org/apache/derby/impl/drda/DRDAConnThread.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Push down some of the logic that determines the SQLCODE from&lt;br/&gt;
    writeSQLCAGRP() to getSqlCode().&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Make getSqlCode() return the error code encoded in a negative&lt;br/&gt;
    integer if the exception represents an error.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Remove unused severity parameter in writeSQLCARD().&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;client/org/apache/derby/client/am/Sqlca.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added getErrorCode() method to convert SQL code to error code.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Promote STATEMENT_SEVERITY errors to TRANSACTION_SEVERITY errors&lt;br/&gt;
    if the connection is in auto-commit mode. This is needed in order&lt;br/&gt;
    to match the error codes returned by the embedded driver in&lt;br/&gt;
    auto-commit (see TransactionResourceImpl.handleException() for the&lt;br/&gt;
    corresponding code in the engine). (This does not happen&lt;br/&gt;
    automatically otherwise because the server-side connection is&lt;br/&gt;
    never auto-commit, even if the client-side connection is.)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getUnformattedMessage() now shows the error code instead of the&lt;br/&gt;
    SQL code.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;client/org/apache/derby/client/am/SqlException.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the exception is generated from an SQLCA, use getErrorCode()&lt;br/&gt;
    instead of getSqlCode() to initialize the error code.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;client/org/apache/derby/client/am/SQLExceptionFactory40.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Check for error code only if the sub-class of SQLException cannot&lt;br/&gt;
    be determined from the SQL state. (I don&apos;t know why the original&lt;br/&gt;
    code checked the error code in the first place. The embedded&lt;br/&gt;
    driver only looks at the SQL state.) Now that the error code is&lt;br/&gt;
    something else than -1, the early checks for error code for&lt;br/&gt;
    example made syntax errors that happened in auto-commit mode&lt;br/&gt;
    (whose error codes match TRANSACTION_SEVERITY) would be returned&lt;br/&gt;
    as SQLTransactionRollbackExceptions instead of&lt;br/&gt;
    SQLSyntaxErrorExceptions.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/functionTests/master/testclientij.out&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Update master to expect the correct error codes.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/junit/BaseJDBCTestCase.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added helper method that checks the error code.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/functionTests/tests/derbynet/BadConnectionTest.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Expect the correct error code.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/J2EEDataSourceTest.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Use new helper method to check error codes.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/functionTests/tests/lang/ErrorCodeTest.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Enable for client/server.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/functionTests/tests/replicationTests/ReplicationRun.java&lt;/li&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/functionTests/tests/replicationTests/ShutdownMaster.java&lt;/li&gt;
	&lt;li&gt;testing/org/apache/derbyTesting/functionTests/tests/replicationTests/ShutdownSlave.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Expect correct error codes.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13283288" author="knutanders" created="Fri, 25 May 2012 11:25:47 +0100"  >&lt;p&gt;One note about client/server compatibility.&lt;/p&gt;

&lt;p&gt;If, for example, a transaction-severity error happens on the server,&lt;br/&gt;
the server sees an exception whose getErrorCode() method returns&lt;br/&gt;
30000. Here&apos;s what getErrorCode() on the client-side exception will&lt;br/&gt;
return for the various combinations of new and old servers and&lt;br/&gt;
clients:&lt;/p&gt;

&lt;p&gt;(old server, old client) -&amp;gt; -1&lt;br/&gt;
(old server, new client) -&amp;gt; 0&lt;br/&gt;
(new server, old client) -&amp;gt; -30001&lt;br/&gt;
(new server, new client) -&amp;gt; 30000&lt;/p&gt;

&lt;p&gt;(&quot;old&quot; means any version without the fix, &quot;new&quot; means any version with&lt;br/&gt;
the fix)&lt;/p&gt;

&lt;p&gt;With an old server and a new client, 0 is returned because the old&lt;br/&gt;
servers always send SQLCODE -1, and the client converts that to an&lt;br/&gt;
error code by adding one and changing the sign. Since 0 matches&lt;br/&gt;
ExceptionSeverity.NO_APPLICABLE_SEVERITY (intended for &quot;when the&lt;br/&gt;
system was unable to determine the severity&quot;), I think it&apos;s slightly&lt;br/&gt;
less wrong than -1. But if someone thinks returning -1, as we did&lt;br/&gt;
before, is better, and that it&apos;s worthwhile adding logic to handle&lt;br/&gt;
that, it should be possible to change it.&lt;/p&gt;

&lt;p&gt;With a new server and an old client, the server will send an SQLCODE&lt;br/&gt;
that encodes the original error code, but the client doesn&apos;t know how&lt;br/&gt;
to transform that back to an error code, and will return the SQLCODE&lt;br/&gt;
unchanged (-30001). Again, it should be possible to make the server&lt;br/&gt;
send SQLCODE -1 when it&apos;s talking to an old client. However, since we&lt;br/&gt;
don&apos;t document the error codes, and since -30001 is no more or less&lt;br/&gt;
correct than -1 (they&apos;re both wrong), I&apos;m not sure if it&apos;s worth&lt;br/&gt;
adding special handling of this case. Maybe a release note?&lt;/p&gt;</comment>
                            <comment id="13290087" author="knutanders" created="Wed, 6 Jun 2012 12:55:17 +0100"  >&lt;p&gt;Committed revision 1346833. I&apos;ll leave the issue open for now until we&apos;ve decided whether more logic is needed to handle the case with mixed versions, and whether a release note would be required.&lt;/p&gt;</comment>
                            <comment id="13457847" author="knutanders" created="Tue, 18 Sep 2012 15:18:34 +0100"  >&lt;p&gt;Attaching a release note describing the changes.&lt;/p&gt;

&lt;p&gt;Since no one has voiced their support for adding special handling of the mixed version scenario, I&apos;ve mentioned the issue in the release notes under &quot;symptoms&quot;. Also, in the &quot;application changes required&quot; section, I&apos;ve added a recommendation that both the client and the server are upgraded to 10.10 or later if the error code is significant to the application.&lt;/p&gt;</comment>
                            <comment id="13457851" author="knutanders" created="Tue, 18 Sep 2012 15:24:58 +0100"  >&lt;p&gt;Marking as resolved, since I don&apos;t expect any more work on this issue. Also marking it as not for backport because of the behaviour change.&lt;/p&gt;</comment>
                            <comment id="13823449" author="knutanders" created="Fri, 15 Nov 2013 08:15:17 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update: close all resolved issues that haven&amp;#39;t had any activity the last year&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12556670">DERBY-5773</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="32841">DERBY-310</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12529700" name="d2601-1a.diff" size="23158" author="knutanders" created="Fri, 25 May 2012 11:20:13 +0100"/>
                            <attachment id="12545567" name="releaseNote.html" size="4913" author="knutanders" created="Tue, 18 Sep 2012 15:18:34 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10363"><![CDATA[Embedded/Client difference]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 25 May 2012 10:20:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23121</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy09uv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35415</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>