<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:40:51 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1620/DERBY-1620.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1620] SQL CASE statement returns ERROR 42X89 when including NULL as a return value</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1620</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This bug appears to be related to the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-7&quot; title=&quot;Bug in NULLIF Function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-7&quot;&gt;&lt;del&gt;DERBY-7&lt;/del&gt;&lt;/a&gt; bug (NULLIF() function).   When NULL is used during a CASE statement, Derby requires the NULL to be CAST to the appropriate type.  This does not appear to meet the SQL 2003 Standard for the Case Expression (see attached Word document).   See the attached Word document to view the Derby Community Discussion about this issue.  See the attached .TXT to view the SYSINFO and to see an example of the steps to reproduce using IJ.&lt;/p&gt;

&lt;p&gt;Steps to Reproduce:&lt;/p&gt;

&lt;p&gt;ij&amp;gt;values case when 1=2 then 3 else NULL end;&lt;br/&gt;
ERROR 42X89:  Types &apos;INTEGER&apos; and &apos;CHAR&apos; are not type compatible.  Neither type is assignable to the other type.&lt;/p&gt;

&lt;p&gt;Current Workaround:&lt;br/&gt;
ij&amp;gt;values case when 1=2 then 3 else cast(NULL as INT) end;&lt;/p&gt;</description>
                <environment>Windows XP</environment>
        <key id="12347067">DERBY-1620</key>
            <summary>SQL CASE statement returns ERROR 42X89 when including NULL as a return value</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="john.peterson@pega.com">John Peterson</assignee>
                                    <reporter username="john.peterson@pega.com">John Peterson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Aug 2006 15:53:24 +0100</created>
                <updated>Sun, 16 Dec 2007 19:56:46 +0000</updated>
                            <resolved>Wed, 6 Jun 2007 23:31:19 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12424894" author="john.peterson@pega.com" created="Tue, 1 Aug 2006 16:11:03 +0100"  >&lt;p&gt;These attachments are the SQL 2003 Standard for the Case Expression, the Derby Community Discussion about this issue, and the SysInfo along with an example of the Steps to Reproduce.&lt;/p&gt;</comment>
                            <comment id="12424927" author="jta" created="Tue, 1 Aug 2006 17:47:02 +0100"  >&lt;p&gt;For any who don&apos;t have Word, the start for the discussion in Derby_Community_Discussion.doc  can be viewed at these locations:&lt;/p&gt;

&lt;p&gt;ASF archives:&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/200607.mbox/%3cD867A529C569F64BAC09C622E55B4084010E2BF8@EXCHCLUSTUSA.rpega.com%3e&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/200607.mbox/%3cD867A529C569F64BAC09C622E55B4084010E2BF8@EXCHCLUSTUSA.rpega.com%3e&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://tinyurl.com/lceff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://tinyurl.com/lceff&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Nabble:&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/ERROR-42X89%3A-Types-%27INTEGER%27-and-%27CHAR%27-are-not-type-compatible.-Neither-type-is-assignable-to-the-other-type.-p5527265.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/ERROR-42X89%3A-Types-%27INTEGER%27-and-%27CHAR%27-are-not-type-compatible.-Neither-type-is-assignable-to-the-other-type.-p5527265.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://tinyurl.com/oomep&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://tinyurl.com/oomep&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12424967" author="john.peterson@pega.com" created="Tue, 1 Aug 2006 19:16:28 +0100"  >&lt;p&gt;It has been brought to my attention that the SQL2003_Standard_Case_Expression.doc is a violation of the ISO copyright, I suggest it be removed as soon as possible.  Instead, please refer to &lt;a href=&quot;http://en.wikipedia.org/wiki/SQL:2003&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/SQL:2003&lt;/a&gt; for a link to a .zip file (sql_2003_standard.zip), and open the 5WD-02-Foundation-2003-09.pdf within.  Turn to page 197 (221 of 1332) (Chapter 6.11) to view the Case Expression standard.&lt;/p&gt;</comment>
                            <comment id="12424969" author="fuzzylogic" created="Tue, 1 Aug 2006 19:19:33 +0100"  >&lt;p&gt;Removed SQL2003_Standard_Case_Expression.doc attachment at attcher&apos;s request.&lt;/p&gt;</comment>
                            <comment id="12447003" author="john.peterson@pega.com" created="Fri, 3 Nov 2006 16:39:41 +0000"  >&lt;p&gt;The org.apache.derby.impl.sql.compile.SQLParser parses NULL&apos;s found in SQL case expressions into UntypedNullConstantNode nodes and casts those nodes to the CHAR type.  (See SQLParser.caseExpression() on line ~13180).&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-7&quot; title=&quot;Bug in NULLIF Function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-7&quot;&gt;&lt;del&gt;DERBY-7&lt;/del&gt;&lt;/a&gt; bug fix took this into account to enable the NULLIF() function to work properly, but this code is only executed if NULLIF() is parsed.  (See SQLParser.valueSpecification() on line ~13111).  The SQL equivalent to NULLIF(), which is CASE V1=V2 THEN NULL ELSE V1 END, is not flagged to be given this special consideration, and therefore Derby returns the 42X89 error.  The error also afflicts the related statements CASE V1=V2 THEN NULL ELSE V3 and CASE V1=V2 THEN V3 ELSE NULL.&lt;/p&gt;

&lt;p&gt;In the attached proposed patch of  org.apache.derby.impl.sql.compile.ConditionalNode, Derby will now look more closely at the &quot;then&quot;  and &quot;else&quot; nodes during the bindExpression() method.  If the node meets the following four conditions, then it is cast to the type of the other node.  Otherwise nothing happens, and Derby will proceed as usual.&lt;/p&gt;

&lt;p&gt;1) The &quot;then&quot; or &quot;else&quot; node is a CAST_NODE&lt;br/&gt;
2) The CAST_NODE node operand is an UntypedNullConstantNode&lt;br/&gt;
3) The other node (&quot;else&quot; or &quot;then&quot;) has a type service&lt;br/&gt;
4) The &quot;else&quot; and &quot;then&quot; nodes don&apos;t have the same type&lt;/p&gt;

&lt;p&gt;These four conditions ensure only NULL&apos;s will be cast, and that they&apos;ll only be cast if the other node has a type assigned to it that is different than CHAR.&lt;/p&gt;

&lt;p&gt;We have been testing this fix by using our product with Derby, and it appears to be doing the job.  I&apos;ve also executed the derbyall test suite, and the problems which occurred do not seem to stem from this change.  The next step is a more extensive testing using all possible database types.  I&apos;m planning on moving forward with that, but I wanted to post this patch for review and comment. &lt;/p&gt;</comment>
                            <comment id="12462209" author="bernt" created="Thu, 4 Jan 2007 13:25:19 +0000"  >&lt;p&gt;The diff-file contains numerous white-space changes (27 regions out of 29). They should be removed. Otherwise, the patch looks sane to me.&lt;/p&gt;</comment>
                            <comment id="12462226" author="john.peterson@pega.com" created="Thu, 4 Jan 2007 14:57:56 +0000"  >&lt;p&gt;The ConditionalNode_diff.txt is a cleaner diff-file, I&apos;ve removed the white-space changes.&lt;/p&gt;</comment>
                            <comment id="12462834" author="bryanpendleton" created="Sun, 7 Jan 2007 16:41:23 +0000"  >&lt;p&gt;The new version of the diff looks very good, the code reads very well and the comments are&lt;br/&gt;
very well-written and clear.&lt;/p&gt;

&lt;p&gt;The only tiny little confusion I had is over sub-condition (4). In your 3-Nov comment you say:&lt;br/&gt;
      4) The &quot;else&quot; and &quot;then&quot; nodes don&apos;t have the same type&lt;br/&gt;
and that seems to be what the code implements. But in the code itself your comment says&lt;br/&gt;
     4) the other node&apos;s type isn&apos;t CHAR  (avoids duplicate work)&lt;br/&gt;
Can you explain that in just a bit more detail?&lt;/p&gt;

&lt;p&gt;Also, would it be possible for you to include some tests? Perhaps some various examples&lt;br/&gt;
of CASE statements with nulls in various combinations, and also some various&lt;br/&gt;
examples of NULLIF function calls? I see that you indicated in your 3-Nov comment that&lt;br/&gt;
you were working on that; let us know if you&apos;ve run into any snags or roadblocks.&lt;/p&gt;</comment>
                            <comment id="12463051" author="john.peterson@pega.com" created="Mon, 8 Jan 2007 15:03:28 +0000"  >
&lt;p&gt;Yes, that comment isn&apos;t very clear.  I was trying to remind the reader&lt;br/&gt;
that the SQLParser parses NULL&apos;s in the CASE expression into&lt;br/&gt;
UntypedNullConstantNode&apos;s and then casts those nodes into CHAR&apos;s.  Thus&lt;br/&gt;
the only situation in which the case statement is returning a CHAR will&lt;br/&gt;
this check need to be performed.  Ultimately to avoid having the NULL&lt;br/&gt;
casted to a CHAR for a second time (duplicate work).  Thanks for&lt;br/&gt;
pointing it out, I will have to clarify. &lt;/p&gt;

&lt;p&gt;I was working on some test cases, but while writing them I realized that&lt;br/&gt;
patch I provided doesn&apos;t handle nested WHEN&apos;s.  A rather severe&lt;br/&gt;
oversight.  So once solution is to recursively examine &quot;else&quot; nodes to&lt;br/&gt;
determine if they are another conditional node.  I have been delaying&lt;br/&gt;
updating the code, however, because it&apos;s not clear to me as to why Derby&lt;br/&gt;
is casting NULL&apos;s into CHAR&apos;s in the first place.  This question of&lt;br/&gt;
course begs a more detailed look into the underlying Derby code than I&lt;br/&gt;
have yet undergone.  In fact, I am planning on posing it to the Derby&lt;br/&gt;
community, for I would be most interested in any feedback.&lt;/p&gt;

</comment>
                            <comment id="12463374" author="john.peterson@pega.com" created="Tue, 9 Jan 2007 18:57:43 +0000"  >&lt;p&gt;A comment in the org.apache.derby.impl.sql.compile.SQLParser.valueSpecification() indicates an assumption that the NULL&apos;s in an SQL statement will be taken care of at bind time, from this I&apos;m deducing that it&apos;s not the parser&apos;s responsibility to ensure NULL&apos;s are cast correctly.  Perhaps it would be a more complete and efficient solution for the SQLParser to parse NULL&apos;s into a currently non-existent NULL type and modify Derby on a larger more complex scale, but I suspect this may not be an ideal solution because there currently doesn&apos;t seem to be any demand for a NULL type other than this particular bug.  With these thoughts as my motivation, I&apos;ve created a new patch that will handle NULL&apos;s in nested CASE statements.  I will provide more extensive tests and their results shortly, however, in the meantime opinions on this are welcome and invited.&lt;/p&gt;</comment>
                            <comment id="12476034" author="army" created="Mon, 26 Feb 2007 23:15:15 +0000"  >&lt;p&gt;John Peterson &amp;gt;  I will provide more extensive tests and their results shortly&lt;/p&gt;

&lt;p&gt;John, are you still planning to provide test cases for the changes you have contributed for this issue?  And is there anything else that needs to be done here or is the latest ConditionalNode.diff a complete resolution to this problem?&lt;/p&gt;

&lt;p&gt;I looked at what I think is the latest patch (ConditionalNode.diff from 01/09/2007) and it looks pretty good.  There are, however, a lot of whitespace diffs in the patch--in fact, if I&apos;m not mistaken the last 160 lines of the patch are whitespace-only changes?  It&apos;d be great if those could be removed.&lt;/p&gt;

&lt;p&gt;If you are still planning to contribtue test cases and there is nothing else to do for his issue (aside from whitespace cleanup), I&apos;d be willing to commit your changes to the Derby trunk for you.  Please post a comment if you are still interested.&lt;br/&gt;
Thank you for your time on this!&lt;/p&gt;</comment>
                            <comment id="12480182" author="john.peterson@pega.com" created="Mon, 12 Mar 2007 20:28:25 +0000"  >&lt;p&gt;The latest patch (March 12, 2007) fixes the two problems my last patch still had issues with.&lt;/p&gt;

&lt;p&gt;1) NULL&apos;s inside the THEN braches of the CASE Expressions where not being cast.   Causing the exception to be thrown.&lt;br/&gt;
  (e.g. VALUES CASE WHEN 1 = 1 THEN (CASE WHEN 1 = 1 THEN NULL ELSE 1 END) ELSE NULL END&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;2) Column References were ignored.  Causing the exception to be thrown.&lt;br/&gt;
  (e.g. SELECT Count(CASE WHEN 1 = 1 THEN aDecimalColumnName ELSE NULL END) FROM aTableName&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I have done extensive testing, and I believe this patch finally fixes this bug.  Therefore, once these changes are commited, I will close out this bug.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
John&lt;/p&gt;</comment>
                            <comment id="12480226" author="army" created="Mon, 12 Mar 2007 23:51:12 +0000"  >&lt;p&gt;&amp;gt; I have done extensive testing, and I believe this patch finally fixes this bug. &lt;/p&gt;

&lt;p&gt;That&apos;s great to hear.  Can I ask what you mean by &quot;extensive testing&quot;?  Did you run the Derby regression suites at all?  Do you have a list of queries that you ran to verify everything is working as it should?  And if so, is it possible to add those queries to one of Derby&apos;s existing regression tests?  This allows other developers to ensure that everything will continue to work in the future.&lt;/p&gt;

&lt;p&gt;If you do not feel like incorporating your test queries into an existing (or new) regression test, then it would be great if you could at least post the queries (ex. as an ij script) to this issue so that any other developers who may be interested can add the test cases to the regression suite.  It would, of course, be wonderful if you were willing and able to do that yourself.&lt;/p&gt;

&lt;p&gt;I as a committer am a bit hesitant to commit changes for which no new regression tests have been added.  There are exceptions, of course, but in this particular case I think it would be great to have some new test cases running every night to verify the fix.  And if you&apos;ve already done &quot;extensive testing&quot;, perhaps that means you have such test cases already written...?&lt;/p&gt;</comment>
                            <comment id="12480389" author="john.peterson@pega.com" created="Tue, 13 Mar 2007 13:17:09 +0000"  >
&lt;p&gt;I did run the entire test suite against it, and none of the problems&lt;br/&gt;
that occurred appeared to stem from the modification of the&lt;br/&gt;
ConditionalNode class.   My &quot;extensive&quot; testing can not be shared as&lt;br/&gt;
they are a set of proprietary queries not written by me against a&lt;br/&gt;
database not created by me.  You do make an excellent point, however, so&lt;br/&gt;
I&apos;ll write up a test suite that takes advantage of the existing tests&lt;br/&gt;
put into place by the author of the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-7&quot; title=&quot;Bug in NULLIF Function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-7&quot;&gt;&lt;del&gt;DERBY-7&lt;/del&gt;&lt;/a&gt; fix.  I&apos;ll shoot for this&lt;br/&gt;
week.&lt;/p&gt;

&lt;p&gt;John&lt;/p&gt;

</comment>
                            <comment id="12480787" author="john.peterson@pega.com" created="Wed, 14 Mar 2007 14:23:08 +0000"  >&lt;p&gt;The results of the test indicate that problems occur when trying to cast the casted NULL into something that can not be converted from a CHAR,  (e.g.  From line 2090 of resultset.tmp:&lt;/p&gt;

&lt;p&gt;     SELECT CASE WHEN 1 = 1 THEN REALCOL ELSE NULL END from AllDataTypesTable&lt;br/&gt;
     ERROR 42846: Cannot convert types &apos;CHAR&apos; to &apos;REAL&apos;. )&lt;/p&gt;

&lt;p&gt;Even though the statement is no longer issuing the 42X89 error, it&apos;s still not up to SQL Standard.  Since I am unsure of the impact of changing the SQLParser (which sets NULL&apos;s to type CHAR), I&apos;m going to change the cast type from CHAR to REAL instead of casting the casted NULL to a REAL (causing the error).  The good news is that this will be a substantial improvement for anyone who wants to use NULL&apos;s with a type that can&apos;t be casted from a CHAR in a CASE Expression, for which there is currently no workaround.&lt;br/&gt;
John&lt;/p&gt;</comment>
                            <comment id="12480922" author="john.peterson@pega.com" created="Wed, 14 Mar 2007 20:50:38 +0000"  >&lt;p&gt;The latest patch, test code, and test results.   The latest change was a simple one.  If required, the NULL is relieved of it&apos;s CHAR association and recast to a more appropriate type.&lt;/p&gt;</comment>
                            <comment id="12481228" author="army" created="Thu, 15 Mar 2007 17:06:36 +0000"  >&lt;p&gt;Thank you for your continued work on this, John.  I&apos;m hoping to review and commit the latest patch sometime in the next couple of days.&lt;/p&gt;

&lt;p&gt;One thing I did notice: We have been trying to move as many of the regression tests as possible into JUnit :&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://wiki.apache.org/db-derby/KillDerbyTestHarness&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/KillDerbyTestHarness&lt;/a&gt;&lt;br/&gt;
  &lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyJUnitTesting&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/DerbyJUnitTesting&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As part of that effort the jdbcapi/resultset.java test was recently converted (just a couple of days ago, actually), and thus that particular test file no longer exists--see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2429&quot; title=&quot;Convert jdbcapi/resultset.java to JUnit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2429&quot;&gt;&lt;del&gt;DERBY-2429&lt;/del&gt;&lt;/a&gt;.  So the test patch that you have won&apos;t actually apply to the latest codeline &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;My apologies here: I should have mentioned the preference for JUnit tests when I asked earlier, and I didn&apos;t realize that the test you were changing was going to be converted this week.  Ack.&lt;/p&gt;

&lt;p&gt;So that said, do you have any interest in porting your new test cases to JUnit based on the new JUnit tests added as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2429&quot; title=&quot;Convert jdbcapi/resultset.java to JUnit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2429&quot;&gt;&lt;del&gt;DERBY-2429&lt;/del&gt;&lt;/a&gt;?  I understand if you find that to be a bit too annoying; if so, we at least have the resultset.java changes (thank you!) so anyone else in the community who is so inclined can make the conversion.  But I thought I&apos;d ask just to see...&lt;/p&gt;

&lt;p&gt;Thank you very much for your continued patience with this effort.  As I said, I&apos;ll try to review/convert the engine changes over the next couple of days (maybe early next week if I can&apos;t get to it before then).&lt;/p&gt;</comment>
                            <comment id="12481289" author="john.peterson@pega.com" created="Thu, 15 Mar 2007 19:29:09 +0000"  >
&lt;p&gt;Of course, I&apos;ll be happy to.&lt;br/&gt;
John &lt;/p&gt;
</comment>
                            <comment id="12482262" author="army" created="Mon, 19 Mar 2007 23:35:50 +0000"  >&lt;p&gt;Hi John, just a few minor comments on the most recent patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The following two methods do not have any javadoc; it&apos;s not that big of a&lt;br/&gt;
   deal since it&apos;s pretty clear that what they are doing--but a line or two&lt;br/&gt;
   of javadoc content wouldn&apos;t hurt...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;isCastNode(ValueNode)&lt;/li&gt;
	&lt;li&gt;isCastToChar(CastNode)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There are several un-used versions of &quot;shouldCast()&quot; in this patch: the&lt;br/&gt;
   only one that is directly called is (DataTypeDescriptor, ValueNode), and&lt;br/&gt;
   that simply calls the version which takes two DTDs.  So I wonder if we could&lt;br/&gt;
   just have the single version that takes two DTDs and then call that&lt;br/&gt;
   directly, ex:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   Instead of:&lt;/p&gt;

&lt;p&gt;     if (isNullNode(thenNode) &amp;amp;&amp;amp; shouldCast(castType, thenNode)) {&lt;/p&gt;

&lt;p&gt;   just do:&lt;/p&gt;


&lt;p&gt;     if (isNullNode(thenNode) &amp;amp;&amp;amp;&lt;br/&gt;
        shouldCast(castType, thenNode.getTypeServices()))&lt;br/&gt;
     {&lt;/p&gt;

&lt;p&gt;    Then you could remove all of the other versions of the method.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The sequential &quot;if&quot; statements in the new &quot;findType()&quot; method are a tad&lt;br/&gt;
   hard to follow.  If we remove the underlying code blocks we end up with&lt;br/&gt;
   something like:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+        if ((thenType != null) &amp;amp;&amp;amp; !isCastNode(thenNode) &amp;amp;&amp;amp; !isConditionalNode(thenNode))&lt;br/&gt;
+        if (isCastNode(thenNode) &amp;amp;&amp;amp; !isCastToChar((CastNode)thenNode))&lt;br/&gt;
+        if ((elseType != null) &amp;amp;&amp;amp; !isCastNode(elseNode) &amp;amp;&amp;amp; !isConditionalNode(elseNode))&lt;br/&gt;
+        if (isCastNode(elseNode) &amp;amp;&amp;amp; !isCastToChar((CastNode)elseNode))&lt;br/&gt;
+        if (isConditionalNode(thenNode))&lt;br/&gt;
+        if (theType != null)&lt;br/&gt;
+        if (isConditionalNode(elseNode))&lt;br/&gt;
+        if (theType != null)&lt;/p&gt;

&lt;p&gt;   Maybe I&apos;m just being paranoid, but when I see code like this I have to&lt;br/&gt;
   stare for a long time to convince myself that all of the different paths&lt;br/&gt;
   have been covered.  It&apos;s especially tough given that certain conditions (ex.&lt;br/&gt;
   &quot;isCastNode(thenNode)&quot;) show up more than once.&lt;/p&gt;

&lt;p&gt;   Of course, you added good comments to this code which were very helpful--so&lt;br/&gt;
   thank you for that!  I don&apos;t think you need to change anything here, but since&lt;br/&gt;
   I spent a good deal of time scratching my head and trying to convince myself&lt;br/&gt;
   that all of this is correct, I thought I&apos;d mention it...&lt;/p&gt;

&lt;p&gt;But these are all minor things that can be addressed with a follow-up patch if you are so inclined.&lt;/p&gt;

&lt;p&gt;I ran derbyall and suites.All on Red Hat Linux with ibm142 and there were no failures, so I made some minor formatting changes to the patch (lines longer than 80 chars--it&apos;d be great if these could be avoided in the future...) and committed the &lt;b&gt;engine&lt;/b&gt; changes with svn #520173:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=520173&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=520173&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Since you have kindly agreed to work on rewriting the tests for JUnit (thank you!) I did not commit the &quot;resultset&quot; changes and am leaving the issue &apos;Open&apos; for now...&lt;/p&gt;

&lt;p&gt;Thank you for the contribution!&lt;/p&gt;</comment>
                            <comment id="12482267" author="army" created="Mon, 19 Mar 2007 23:41:00 +0000"  >&lt;p&gt;Oops, somehow I unassigned John Peterson from this issue (sorry!).  I tried to reassign it back to him but he doesn&apos;t show up on the available list.  John, please re-assign this issue back to you when you have the chance.  Sorry for the slip-up...not sure how that happened...&lt;/p&gt;</comment>
                            <comment id="12482294" author="fuzzylogic" created="Tue, 20 Mar 2007 02:39:04 +0000"  >&lt;p&gt;Reassign John Peterson to this issue. Needed to update his JIRA user profile to be a contributor to the derby-developers group.&lt;/p&gt;</comment>
                            <comment id="12500861" author="john.peterson@pega.com" created="Fri, 1 Jun 2007 22:13:59 +0100"  >&lt;p&gt;Per previous comments, I&apos;ve added javadoc information to the private methods isCastNode() and isCastToChar(), removed the unused shouldCast() methods, updated the recastNullNodes to use the remaining shouldCast() method, and tried to improve the comments on the if-then-else blocks determining recursive calls.  I&apos;ve also created a new class org.apache.derbyTesting.functionTests.tests.lang.CaseExpressionTest.java which converts my additions to the org.apache.derbyTesting.functionTests.tests.jdbcapi.resultset.java class over to the new junit testing suite.  If these last few small changes are acceptable, then I will close out this bug.&lt;/p&gt;</comment>
                            <comment id="12501730" author="army" created="Tue, 5 Jun 2007 23:51:07 +0100"  >&lt;p&gt;Hi John,&lt;/p&gt;

&lt;p&gt;Thank you for following through with my previous review comments, and for rewriting your test cases to run in JUnit.  That was very helpful.&lt;/p&gt;

&lt;p&gt;Just a few minor comments on the latest patch:&lt;/p&gt;

&lt;p&gt;1 - The Java class name at the top of the license header in the new JUnit test says &quot;NullIfTest&quot;, when it should say &quot;CaseExpressionTest&quot;.&lt;/p&gt;

&lt;p&gt;2 - There are a few unnecessary imports in CaseExpressionTest:&lt;/p&gt;

&lt;p&gt;  java.sql.Date&lt;br/&gt;
  java.sql.PreparedStatement&lt;br/&gt;
  java.sql.Time&lt;br/&gt;
  java.sql.Timestamp&lt;/p&gt;

&lt;p&gt;  org.apache.derbyTesting.junit.JDBC&lt;/p&gt;

&lt;p&gt;3 - In the &quot;suite()&quot; method I think it might be good to use existing convenience methods on TestConfiguration, instead of calling &quot;baseSuite&quot; directly.  Ex:&lt;/p&gt;

&lt;p&gt;  // For embedded:&lt;/p&gt;

&lt;p&gt;  suite.addTest(&lt;br/&gt;
      TestConfiguration.embeddedSuite(CaseExpressionTest.class));&lt;/p&gt;

&lt;p&gt;  // For client/server:&lt;/p&gt;

&lt;p&gt;  suite.addTest(&lt;br/&gt;
      TestConfiguration.clientServerSuite(CaseExpressionTest.class));&lt;/p&gt;

&lt;p&gt;  // For both embedded &lt;b&gt;and&lt;/b&gt; client/server:&lt;/p&gt;

&lt;p&gt;  suite.addTest(&lt;br/&gt;
      TestConfiguration.defaultSuite(CaseExpressionTest.class));&lt;/p&gt;

&lt;p&gt;That said, since the changes for Jira only effect SQL processing within the engine, it&apos;s probably good enough to just run the new JUnit test in embedded mode.&lt;/p&gt;

&lt;p&gt;4 - There are several System.out.printlns in the test.  I think that the preferred approach to JUnit testing is to avoid printing anything to System.out or System.err.  If the output is an important part of the test then is should be replaced with some kind of JUnit assertion.  But in the new CaseExpressionTest, it looks like the System.out.println statements are purely informational, in which case I think it&apos;s best to remove them altogether.  Or, if you think the output might be useful for debugging, you could move all of the System.outs into a &quot;debug&quot; method and add a flag that allows debugging information to be turned on/off (with default to &quot;off&quot;).  See, for example, lang/MathTrigFunctionsTest.java.&lt;/p&gt;

&lt;p&gt;5 - I think the new test has to be added to lang/_Suite.java in order to run as part of Derby&apos;s JUnit regression suite.  This should just be a one-line addition to the &quot;suite()&quot; method of lang/_Suite.java, something like:&lt;/p&gt;

&lt;p&gt;    suite.addTest(CaseExpressionTest.suite());&lt;/p&gt;

&lt;p&gt;6 - It might be nice if you can name your next patch something other than &quot;ConditionalNode.diff&quot;, in order to avoid confusion with the changes that have already been committed.  For example, something like &quot;derby1620_test.patch&quot; would, I think, be a tad more clear.&lt;/p&gt;

&lt;p&gt;Thanks again for your continued work (and patience) with this Jira!  I think that if the above comments can be addressed, the patch will be ready for commit and we can finally close this issue...&lt;/p&gt;</comment>
                            <comment id="12501953" author="john.peterson@pega.com" created="Wed, 6 Jun 2007 16:12:56 +0100"  >&lt;p&gt;I&apos;ve changed the comment headers to indicate this class is CaseExpressionTest, removed the unnecessary imports, removed the &quot;System.out&quot; statements (which are not needed), added the test to the lang/_Suite class, and renamed this patch from &quot;ConditionalNode.diff&quot; to &quot;derby1620_test.patch&quot; for clarification.  I&apos;ve also updated the suite() method by removing the client/server test, and removing the call to the local baseSuite() method which was clearly confusing.  &lt;/p&gt;</comment>
                            <comment id="12502135" author="army" created="Wed, 6 Jun 2007 23:28:37 +0100"  >&lt;p&gt;Thank you for the revised patch, John.  I applied it to my codeline and ran the regression tests (derbyall and suites.All) as a sanity check.  I then did some cleanup of the new CaseExpressionTest to a) keep lines under 80 characters, and b) move common code into a single testCaseExpressionQuery() method, to avoid code duplication.  I also verified that the new test fails if the fix for this issue is reverted, and passes with the fix applied.  So everything looks good.&lt;/p&gt;

&lt;p&gt;Committed derby1620_test_v2.patch (which has the changes I mentioned above) with svn # 544974:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=544974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=544974&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Marking issue as resolved in 10.3.  I&apos;ll leave it up to you close it if everything looks okay.&lt;/p&gt;

&lt;p&gt;Thanks for fixing this bug!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12384682">DERBY-3277</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12375181">DERBY-2986</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12358742" name="ConditionalNode.diff" size="14219" author="john.peterson@pega.com" created="Fri, 1 Jun 2007 22:13:58 +0100"/>
                            <attachment id="12353317" name="ConditionalNode.diff" size="13569" author="john.peterson@pega.com" created="Wed, 14 Mar 2007 20:50:38 +0000"/>
                            <attachment id="12353133" name="ConditionalNode.diff" size="8671" author="john.peterson@pega.com" created="Mon, 12 Mar 2007 20:09:18 +0000"/>
                            <attachment id="12348557" name="ConditionalNode.diff" size="13450" author="john.peterson@pega.com" created="Tue, 9 Jan 2007 17:50:22 +0000"/>
                            <attachment id="12337906" name="Derby_Community_Discussion.doc" size="38400" author="john.peterson@pega.com" created="Tue, 1 Aug 2006 16:11:03 +0100"/>
                            <attachment id="12359086" name="derby1620_test.patch" size="14049" author="john.peterson@pega.com" created="Wed, 6 Jun 2007 16:12:56 +0100"/>
                            <attachment id="12359127" name="derby1620_test_v2.patch" size="13343" author="army" created="Wed, 6 Jun 2007 23:28:37 +0100"/>
                            <attachment id="12344301" name="derbyall_report.txt" size="27902" author="john.peterson@pega.com" created="Fri, 3 Nov 2006 16:39:41 +0000"/>
                            <attachment id="12353318" name="resultset.tmp" size="104553" author="john.peterson@pega.com" created="Wed, 14 Mar 2007 20:50:38 +0000"/>
                            <attachment id="12353286" name="resultset.tmp" size="100633" author="john.peterson@pega.com" created="Wed, 14 Mar 2007 14:23:08 +0000"/>
                            <attachment id="12337907" name="sysinfo_and_example.txt" size="4223" author="john.peterson@pega.com" created="Tue, 1 Aug 2006 16:11:03 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 1 Aug 2006 16:47:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22603</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0zv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39628</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>