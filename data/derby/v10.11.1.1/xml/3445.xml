<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:36:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3445/DERBY-3445.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3445] Make it easier to use the EMMA tool to measure the code coverage of the Derby testing</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3445</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;It is a bit tricky to use EMMA to measure code coverage for the derby testing.&lt;/p&gt;

&lt;p&gt;Modifications must be made to the source both to avoid problems with the SecurityManager and individual tests. It would be good if these modifcations could be done once and for all so that it was easier for anyone to run the tests with EMMA.&lt;/p&gt;

&lt;p&gt;It would also be good to have ant tasks that would make it even easier to run the tests with EMMA.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12389226">DERBY-3445</key>
            <summary>Make it easier to use the EMMA tool to measure the code coverage of the Derby testing</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vemund">Vemund &#216;stgaard</assignee>
                                    <reporter username="vemund">Vemund &#216;stgaard</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Feb 2008 15:38:16 +0000</created>
                <updated>Fri, 21 Jan 2011 17:51:29 +0000</updated>
                            <resolved>Mon, 28 Apr 2008 14:48:31 +0100</resolved>
                                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Build tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12572122" author="vemund" created="Mon, 25 Feb 2008 16:49:01 +0000"  >&lt;p&gt;I&apos;ve made a patch that I think makes it a lot easier to run codecoverage measurements with the junit suites using EMMA and ant 1.7. Just download emma.jar and emma_ant.jar and place them under tools/java/ and everything should work, at least with ant 1.7.&lt;/p&gt;

&lt;p&gt;I have put the general changes in a patchfile named 3445-general-diff. The changes in this patch are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A lot of new permissions in derby_tests.policy, both for EMMA writing to its coverage.ec file, and for running junit from ant with ant version 1.7 which writes to some temporary files.&lt;/li&gt;
	&lt;li&gt;SecurityManagerSetup now sets a new property &quot;derbyTesting.emma&quot; to the location of emma.jar. This is used in the policy files to grant permissions to emma.jar, without having to know where it will be placed by the person running the test.&lt;/li&gt;
	&lt;li&gt;Several new tasks are added to build.xml for running tests with EMMA. The most important one is emma-report, which instruments your jar-files and places the instrumented copies under jars/emma/, and then runs the junit task &amp;lt;junit-all&amp;gt; before it creates three sets of coverage reports (txt, xml and html) linked to the derby source files. I&apos;ve adapted the old &amp;lt;junit-all&amp;gt; task to work with EMMA and ant 1.7.&lt;/li&gt;
	&lt;li&gt;Added properties for emma.jar and emma_ant.jar in tools/ant/extrapath.properties. If you&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have made some test-specific changes as well, and put them in a separate pathfile named 3445-testspecific-diff. These changes are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Extra permissions in SecurityPolicyReloadingTest.initial.policy, NetworkServerControlApiTest.policy and ServerPropertiesTest.policy to get these tests to run with EMMA and ant 1.7.&lt;/li&gt;
	&lt;li&gt;Added emma.jar to classpath for classloader used in SysinfoLocaleTest.java.&lt;/li&gt;
	&lt;li&gt;Added property emma.verbosity.level=silent to commandline used in SecureServerTest.java.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;This is a first step to make it easier to run with EMMA. Going forward, it might be useful to improve the emma-tasks in build.xml to be able to run codecoverage experiments with the classes in addition to the jars and to integrate with the other junit-tasks as well.&lt;/p&gt;</comment>
                            <comment id="12572126" author="vemund" created="Mon, 25 Feb 2008 16:58:37 +0000"  >&lt;p&gt;I forgot to mention that the patches I have uploaded also address the problem seen in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3153&quot; title=&quot;AccessControlException when running junit tests under the ant harness in ant 1.7.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3153&quot;&gt;&lt;del&gt;DERBY-3153&lt;/del&gt;&lt;/a&gt;, it didn&apos;t seem very useful to try to filter out the changes that were relevant for that report as some of them were just as relevant for this one. So, if these patches get committed I believe &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3153&quot; title=&quot;AccessControlException when running junit tests under the ant harness in ant 1.7.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3153&quot;&gt;&lt;del&gt;DERBY-3153&lt;/del&gt;&lt;/a&gt; can be closed as well.&lt;/p&gt;</comment>
                            <comment id="12572140" author="djd" created="Mon, 25 Feb 2008 17:43:01 +0000"  >&lt;p&gt;It&apos;s a concern that permissions are always granted to derby.jar, even though they are only needed if performing code coverage with EMMA.&lt;br/&gt;
This creates an opportunity where Derby code could unknowingly start to depend on those permissions.&lt;/p&gt;

&lt;p&gt;These permissions are as follows, are they needed for all code in the stack, or just a subset?&lt;/p&gt;

&lt;p&gt;+    // These permissions are needed when testing code instrumented with EMMA.&lt;br/&gt;
+    permission java.util.PropertyPermission &quot;user.dir&quot;, &quot;read&quot;;&lt;br/&gt;
+    permission java.io.FilePermission &quot;$&lt;/p&gt;
{user.dir}${/}coverage.ec&quot;, &quot;read&quot;;&lt;br/&gt;
+    permission java.lang.RuntimePermission &quot;writeFileDescriptor&quot;;&lt;br/&gt;
&lt;br/&gt;
A work-around may be to add separate sections in the policy file, e.g. if these permissions are only needed for a subset of jars then:&lt;br/&gt;
&lt;br/&gt;
 grant codebase &quot;${emmaActive}/derby.jar&quot; {&lt;br/&gt;
   permission java.util.PropertyPermission &quot;user.dir&quot;, &quot;read&quot;;&lt;br/&gt;
   permission java.io.FilePermission &quot;${user.dir}
&lt;p&gt;$&lt;/p&gt;
{/}coverage.ec&quot;, &quot;read&quot;;&lt;br/&gt;
   permission java.lang.RuntimePermission &quot;writeFileDescriptor&quot;;&lt;br/&gt;
};&lt;br/&gt;
&lt;br/&gt;
then emmaActive is only set when running code coverage with EMMA. It possible a similar trick could be done if they are needed for all code,&lt;br/&gt;
something that resolves to:&lt;br/&gt;
 grant  {&lt;br/&gt;
   permission java.util.PropertyPermission &quot;user.dir&quot;, &quot;read&quot;;&lt;br/&gt;
   permission java.io.FilePermission &quot;${user.dir}${/}
&lt;p&gt;coverage.ec&quot;, &quot;read&quot;;&lt;br/&gt;
   permission java.lang.RuntimePermission &quot;writeFileDescriptor&quot;;&lt;br/&gt;
};&lt;/p&gt;

&lt;p&gt;if and only if some emma property is set.&lt;/p&gt;</comment>
                            <comment id="12572160" author="djd" created="Mon, 25 Feb 2008 18:54:24 +0000"  >&lt;p&gt;I extracted the portions of the patch needed to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3153&quot; title=&quot;AccessControlException when running junit tests under the ant harness in ant 1.7.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3153&quot;&gt;&lt;del&gt;DERBY-3153&lt;/del&gt;&lt;/a&gt; and attached it to that issue.&lt;/p&gt;</comment>
                            <comment id="12572416" author="vemund" created="Tue, 26 Feb 2008 10:56:20 +0000"  >&lt;p&gt;About &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3153&quot; title=&quot;AccessControlException when running junit tests under the ant harness in ant 1.7.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3153&quot;&gt;&lt;del&gt;DERBY-3153&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The additions of junit.jar to the classpath of the &amp;lt;junit&amp;gt; tasks were also to make it easier to run with ant 1.7. This didn&apos;t work with 1.6.5, but with 1.7 it means you don&apos;t have to add junit.jar to your classpath when running ant or put it in ants lib/ directory:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+ &amp;lt;!-- ant 1.7 finds junit.jar if it is on the classpath of the &amp;lt;junit&amp;gt; task --&amp;gt;&lt;br/&gt;
+ &amp;lt;pathelement location=&quot;$&lt;/p&gt;
{junit}
&lt;p&gt;&quot;/&amp;gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There were a few changes in 3445-testspecific-diff that were specifically for running with ant 1.7 as well, so running with only the changes in the patch that was added to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3153&quot; title=&quot;AccessControlException when running junit tests under the ant harness in ant 1.7.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3153&quot;&gt;&lt;del&gt;DERBY-3153&lt;/del&gt;&lt;/a&gt; you will probably see a few errors in those tests.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12572541" author="vemund" created="Tue, 26 Feb 2008 16:11:40 +0000"  >&lt;p&gt;Attaching new versions of the two patches that I think addresses Dans first comment on the addition of permissions to derby.jar. &lt;/p&gt;

&lt;p&gt;The changes are that I have added a property &quot;emma.enabled&quot; to each EMMA-related permission so that they will be ignored if that property is not set. The property is set to an empty string by the SecurityManagerSetup if emma.jar is in the classpath.&lt;/p&gt;

&lt;p&gt;I tried granting the permissions to the whole stack, but then at least one test broke because of that as it got permission to something it wasn&apos;t supposed to.&lt;/p&gt;</comment>
                            <comment id="12572614" author="djd" created="Tue, 26 Feb 2008 19:01:26 +0000"  >&lt;p&gt;+ &amp;lt;!-- ant 1.7 finds junit.jar if it is on the classpath of the &amp;lt;junit&amp;gt; task --&amp;gt;&lt;br/&gt;
+ &amp;lt;pathelement location=&quot;$&lt;/p&gt;
{junit}
&lt;p&gt;&quot;/&amp;gt; &lt;/p&gt;

&lt;p&gt;Does this cause problems with ant 1.6?&lt;/p&gt;

&lt;p&gt;I run with junit in my ant&apos;s lib folder, solves all the issues.&lt;/p&gt;</comment>
                            <comment id="12572905" author="vemund" created="Wed, 27 Feb 2008 13:37:14 +0000"  >&lt;p&gt;I haven&apos;t found any problems with this change and ant 1.6. My experience with ant 1.6 is that to get things to work you need to use one of the workarounds described here: &lt;a href=&quot;http://ant.apache.org/faq.html#delegating-classloader-1.6:&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ant.apache.org/faq.html#delegating-classloader-1.6:&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   1.  put all external libraries you need in CLASSPATH as well this is not what you want, otherwise you wouldn&apos;t have found this FAQ entry.&lt;br/&gt;
   2. put all external libraries you need in ANT_HOME/lib or .ant/lib. This probably still isn&apos;t what you want, but you might reconsider the .ant/lib option.&lt;br/&gt;
   3. Always start Ant with the -lib command line switch and point to your external libraries (or the directories holding them).&lt;br/&gt;
   4. remove the class that loads the external library from the coreloader.&lt;/p&gt;

&lt;p&gt;So, basically my change has no effect with ant 1.6, it neither helps nor harms as far as I can understand. I am able to test with ant 1.6 if I for instance use the -lib option with ant.&lt;/p&gt;

&lt;p&gt;If you are using ant 1.7 with my patch you just need to have junit.jar under your tools/java/ directory where the ant properties expect it to be. In my work environment that is a better solution than the various workarounds for ant 1.6.&lt;/p&gt;
</comment>
                            <comment id="12573382" author="thomanie" created="Thu, 28 Feb 2008 18:02:20 +0000"  >&lt;p&gt;It would be great if targets for running emma with a single test were added too, not just for junit-all. But that could be solved in another commit.&lt;/p&gt;

&lt;p&gt;To enable something like&lt;br/&gt;
&amp;gt; ant emma-instrumentation&lt;br/&gt;
&amp;gt; java junit.textui.TestRunner org.apache....theTestIWantToRun&lt;br/&gt;
&amp;gt; ant emma-report-singletest&lt;/p&gt;</comment>
                            <comment id="12573458" author="djd" created="Thu, 28 Feb 2008 21:18:32 +0000"  >&lt;p&gt;As a follow on patch it would be great to have comments explaining the new emma targets in the top-level build.xml file including a quick summary of how to use them.&lt;/p&gt;

&lt;p&gt;E.g. what does one need to download (versions etc.), where does it get put.&lt;/p&gt;</comment>
                            <comment id="12573459" author="djd" created="Thu, 28 Feb 2008 21:24:06 +0000"  >&lt;p&gt;Won&apos;t the changes to SysinfoLocaleTest make the test fail if the tests are run without EMMA jars in the classpath, which is the typical case?&lt;/p&gt;

&lt;p&gt;     private static void runSysinfo() throws Exception {&lt;br/&gt;
         final String className = &quot;org.apache.derby.tools.sysinfo&quot;;&lt;br/&gt;
+        final String emmaClassName = &quot;com.vladium.emma.EMMAException&quot;;&lt;br/&gt;
         URL[] urls = &lt;/p&gt;
{
             Class.forName(className).getProtectionDomain().
+                    getCodeSource().getLocation(),
+            Class.forName(emmaClassName).getProtectionDomain().
                     getCodeSource().getLocation()
         }
&lt;p&gt;;&lt;/p&gt;</comment>
                            <comment id="12573463" author="mkutty" created="Thu, 28 Feb 2008 21:34:12 +0000"  >&lt;p&gt;Like Dan suggested, Can you please upload and readme file for how to use Emma with your changes? &lt;/p&gt;</comment>
                            <comment id="12573469" author="djd" created="Thu, 28 Feb 2008 21:46:24 +0000"  >&lt;p&gt;v2 patches mostly committed Revision: 632125 - Thanks Vemund.&lt;/p&gt;

&lt;p&gt;I did not commit the change to SysinfoLocaleTest as it causes the test to fail if emma jars are not in the classpath.&lt;/p&gt;

&lt;p&gt;Seems that ant junit-all continued to work with ant 1.6, I didn&apos;t perform a whole run, apart form SysinfoLocaleTest  it didn&apos;t look as though the changes would cause any failures.&lt;/p&gt;

&lt;p&gt;I didn&apos;t test it with EMMA.&lt;/p&gt;</comment>
                            <comment id="12573785" author="vemund" created="Fri, 29 Feb 2008 15:23:09 +0000"  >&lt;p&gt;Thank you all for the comments and suggestions, I&apos;ve added two more patches based on the feedback.&lt;/p&gt;

&lt;p&gt;3445-SysinfoLocaleTest-diff has a fix for the bug pointed out by Dan.&lt;/p&gt;

&lt;p&gt;3445-singletest-diff is a response to Thomas&apos; wish for a way to run a single test with EMMA using ant.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added a task &amp;lt;junit-single&amp;gt; which is in turn used by a task &amp;lt;emma-single&amp;gt;. Both need the property derby.junit.testclass set to some classname that will be attempted run as a junit test/suite.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, doing: &lt;br/&gt;
&quot;ant emma-single -Dderby.junit.testclass=org.apache.derbyTesting.functionTests.tests.tools.SysinfoLocaleTest&quot; &lt;br/&gt;
should run that particular test with codecoverage.&lt;/p&gt;

&lt;p&gt;I also changed my use of $&lt;/p&gt;
{junit}
&lt;p&gt; to $&lt;/p&gt;
{javatools.dir}
&lt;p&gt;/junit.jar, as the first property is set in tools/ant/extrapath.properties and those properties are only loaded for compilation and not when just running a junit test.&lt;/p&gt;

&lt;p&gt;I&apos;ll write up some information on what you need to test with EMMA and how to use the new junit and emma targets, probably on monday. I guess I will add some info to the junit wiki page and perhaps a new page for EMMA, and add some more explanations to the build.xml file.&lt;/p&gt;</comment>
                            <comment id="12574529" author="dyret" created="Mon, 3 Mar 2008 14:40:45 +0000"  >&lt;p&gt;I can confirm that SysinfoLocaleTest runs OK with this patch applied.&lt;/p&gt;

&lt;p&gt;Patch file: 3445-SysinfoLocaleTest-diff&lt;br/&gt;
Committed revision 633101.&lt;/p&gt;
</comment>
                            <comment id="12574532" author="dyret" created="Mon, 3 Mar 2008 14:43:44 +0000"  >&lt;p&gt;I would like to commit 3445-singletest-diff as well, but I can&apos;t figure out how to run junit-single or  emma-single (or any other junit target for that matter), so I&apos;ll wait until the wiki page becomes available.&lt;/p&gt;</comment>
                            <comment id="12574553" author="vemund" created="Mon, 3 Mar 2008 15:21:18 +0000"  >&lt;p&gt;Thank you Dyre!&lt;/p&gt;

&lt;p&gt;I&apos;ve started on a wiki page here: &lt;a href=&quot;http://wiki.apache.org/db-derby/CodeCoverageWithEMMA&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/CodeCoverageWithEMMA&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hopefully that has enough information for you to use the emma targets.&lt;/p&gt;

&lt;p&gt;The junit-single target works the same way as the junit-all and junit-system-mini targets. They all require you to set the classpath to point to your Derby classes or jars. If you are using ant 1.6.5 you must also have junit.jar and ant-junit.jar in your classpath. I don&apos;t have this problem with ant 1.7.&lt;/p&gt;

&lt;p&gt;To configure the classpath when running junit targets I have been using the property derby.junit.classpath. I guess you can just set your CLASSPATH env var as well, or use the -lib option for ant, I haven&apos;t tried.&lt;/p&gt;

&lt;p&gt;When you use the emma targets (emma-single and emma-all) you don&apos;t have to worry about the classpath, this is overridden by the emma targets. You have to download emma.jar and emma_ant.jar (in addition to junit.jar) and place them under tools/java/ in your sandbox. You must build your jars as usual, either sane or insane, and then you can use the emma targets.&lt;/p&gt;</comment>
                            <comment id="12574571" author="dyret" created="Mon, 3 Mar 2008 15:51:08 +0000"  >&lt;p&gt;Patch file: 3445-singletest-diff&lt;br/&gt;
Committed revision 633135.&lt;/p&gt;

&lt;p&gt;Thank you for the patch Vemund. Yes, I did get it to work. I was using ant 1.7, but I also needed to set ANT_HOME to ant 1.7. And, as you point out, I needed to set the classpath manually. I was a bit surprised by this as I had expected it to use classes or jars by default, and let you override as necessary. Setting it explicitly works fine, though.&lt;/p&gt;

&lt;p&gt;I even ran CacheSessionDataTest with emma and could confirm that all methods (except toString()) in the class I added for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3192&quot; title=&quot;Cache session data in the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3192&quot;&gt;&lt;del&gt;DERBY-3192&lt;/del&gt;&lt;/a&gt; (PiggyBackSessionData) had been executed. Nice!&lt;/p&gt;

</comment>
                            <comment id="12574990" author="vemund" created="Tue, 4 Mar 2008 13:55:21 +0000"  >&lt;p&gt;Another patch with two small changes:&lt;/p&gt;

&lt;p&gt;1. Some explanation in the build.xml file for how the emma-targets are to be used. &lt;/p&gt;

&lt;p&gt;2. A new target &apos;junit-single-codeline-jars&apos; which mirrors the &apos;junit-all-codeline-jars&apos; and &apos;junit-system-mini-codeline-jars&apos; targets. This target sets the classpath to your compiled jarfiles and runs &apos;junit-single&apos;, so if you don&apos;t want to set the classpath manually this target could be used.&lt;/p&gt;</comment>
                            <comment id="12575032" author="djd" created="Tue, 4 Mar 2008 15:59:36 +0000"  >&lt;p&gt;The target emma-clean fails if the folder to be removed does not exist, this causes problems with scripts that always attempt to do an emma-clean before running tests.&lt;br/&gt;
(junit-clean succeeds if there is nothing to clean up)&lt;/p&gt;</comment>
                            <comment id="12575098" author="djd" created="Tue, 4 Mar 2008 19:00:33 +0000"  >&lt;p&gt;Thanks Vemund, I was able to get code coverage running very easily now using the emma-all target.&lt;/p&gt;

&lt;p&gt;With the previous EMMA reports I was able to click down through the HTML report to an individual file and see which specific blocks had not been covered, I think with coloured source code. With the report I just generated using emma-all I was not able to see this information. The lowest level was the coverage breakdown by method.&lt;/p&gt;

&lt;p&gt;Anyone any idea what needs to be done to get the source code level information?&lt;/p&gt;</comment>
                            <comment id="12575102" author="djd" created="Tue, 4 Mar 2008 19:13:02 +0000"  >&lt;p&gt;In the build output twhen running emma-all here is something a little strange though I have no idea if it&apos;s a problem or not.&lt;/p&gt;

&lt;p&gt;The junit-jdbc4 target produces the message:&lt;/p&gt;

&lt;p&gt;  EMMA: collecting runtime coverage data ...&lt;/p&gt;

&lt;p&gt;but the junit-core target does not.&lt;/p&gt;

&lt;p&gt;Just seems strange.&lt;/p&gt;</comment>
                            <comment id="12575131" author="vemund" created="Tue, 4 Mar 2008 20:49:33 +0000"  >&lt;p&gt;Thanks again Dan for following up on this. Some answers to your comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I&apos;ll fix the &amp;lt;emma-clean&amp;gt; target so it doesn&apos;t fail if there is no folder there.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The difference in output when running the &amp;lt;junit-jdbc4&amp;gt; target is (I&apos;m guessing) because I didn&apos;t set emma.verbosity.level=silent for this target, as there was no tests that failed because of emma output. This property is set for the &amp;lt;junit-core&amp;gt; target, so no output from emma there.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You should have been able to click down to the source code level, at least that worked when I tested this out in my sandbox. The &amp;lt;emma-report&amp;gt; target sets this:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;               &amp;lt;sourcepath&amp;gt;&lt;br/&gt;
                    &amp;lt;pathelement path=&quot;$&lt;/p&gt;
{derby.client.src.dir}
&lt;p&gt;&quot; /&amp;gt;&lt;br/&gt;
                    &amp;lt;pathelement path=&quot;$&lt;/p&gt;
{derby.demo.src.dir}
&lt;p&gt;&quot; /&amp;gt;&lt;br/&gt;
                    &amp;lt;pathelement path=&quot;$&lt;/p&gt;
{derby.drda.src.dir}
&lt;p&gt;&quot; /&amp;gt;&lt;br/&gt;
                    &amp;lt;pathelement path=&quot;$&lt;/p&gt;
{derby.engine.src.dir}
&lt;p&gt;&quot; /&amp;gt;&lt;br/&gt;
                    &amp;lt;pathelement path=&quot;$&lt;/p&gt;
{derby.shared.src.dir}
&lt;p&gt;&quot; /&amp;gt;&lt;br/&gt;
                    &amp;lt;pathelement path=&quot;$&lt;/p&gt;
{derby.storeless.src.dir}
&lt;p&gt;&quot; /&amp;gt;&lt;br/&gt;
                    &amp;lt;pathelement path=&quot;$&lt;/p&gt;
{derby.tools.src.dir}
&lt;p&gt;&quot; /&amp;gt;&lt;br/&gt;
                &amp;lt;/sourcepath&amp;gt;&lt;/p&gt;

&lt;p&gt;which is supposed to take care of that. Hmm, what is written during the &amp;lt;emma-report&amp;gt; target in your run? When I run &amp;lt;emma-all&amp;gt; I see a lot of output as emma scans through my source and creates the reports.&lt;/p&gt;</comment>
                            <comment id="12575167" author="djd" created="Tue, 4 Mar 2008 22:13:21 +0000"  >&lt;p&gt;On the source code level, are you compiling with debug=true?&lt;br/&gt;
I see messages of the form package &lt;span class=&quot;error&quot;&gt;&amp;#91;yyy&amp;#93;&lt;/span&gt; contains class &lt;span class=&quot;error&quot;&gt;&amp;#91;xxx.class&amp;#93;&lt;/span&gt; without full debug info.&lt;/p&gt;</comment>
                            <comment id="12575174" author="djd" created="Tue, 4 Mar 2008 22:47:05 +0000"  >&lt;p&gt;Latest patch  (singletest-codeline) applied - revision 633690 - Thanks Vemund.&lt;/p&gt;</comment>
                            <comment id="12575317" author="vemund" created="Wed, 5 Mar 2008 12:00:22 +0000"  >&lt;p&gt;Attaching a patch &quot;3445-emma-clean-fix-diff&quot; with a one-line fix for the &amp;lt;emma-clean&amp;gt; target, so it doesn&apos;t fail when there is no directory to remove.&lt;/p&gt;

&lt;p&gt;About the missing link to sources. Yes, I have been compiling with debug=true (and sane=true). I tried with debug=false, and saw the following written by emma-report:&lt;/p&gt;

&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;report&amp;#93;&lt;/span&gt; not all instrumented classes were compiled with source file&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;report&amp;#93;&lt;/span&gt; debug data: no sources will be embedded in the report.&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;report&amp;#93;&lt;/span&gt; line coverage requested in a report of type &lt;span class=&quot;error&quot;&gt;&amp;#91;html&amp;#93;&lt;/span&gt; but&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;report&amp;#93;&lt;/span&gt; not all instrumented classes were compiled with line number&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;report&amp;#93;&lt;/span&gt; debug data: this column will be removed from the report.&lt;/p&gt;

&lt;p&gt;This report did not contain any links to the source, so it seems that you must compile with debug=true to get this.&lt;/p&gt;

&lt;p&gt;I&apos;ll add a note about this to the wikipage.&lt;/p&gt;</comment>
                            <comment id="12575987" author="djd" created="Fri, 7 Mar 2008 00:38:52 +0000"  >&lt;p&gt;There&apos;s a minor issue in that if the network server is run as a separate process then I don&apos;t think it can write out the coverage information due to the default policy file.&lt;br/&gt;
I see these errors now that by default spawning a process network server prints out any stderr.&lt;/p&gt;

&lt;p&gt;Not sure what a solution is, maybe the server should remove the security manager when it shuts down?&lt;/p&gt;

&lt;p&gt;I&apos;m seeing exceptions like this:&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; java.security.AccessControlException: Access denied (java.io.FilePermission coverage.ec read)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.security.AccessController.checkPermission(AccessController.java:104)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.lang.SecurityManager.checkPermission(SecurityManager.java:547)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.lang.SecurityManager.checkRead(SecurityManager.java:886)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.io.File.exists(File.java:726)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at com.vladium.emma.data.DataFactory.persist(DataFactory.java:525)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at com.vladium.emma.data.DataFactory.persist(DataFactory.java:86)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at com.vladium.emma.rt.RTCoverageDataPersister.dumpCoverageData(RTCoverageDataPersister.java:54)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at com.vladium.emma.rt.RTExitHook.run(RTExitHook.java:32)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.lang.Thread.run(Thread.java:801)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Exception in thread &quot;EMMA shutdown handler thread&quot; java.lang.RuntimeException: EMMA failed to dump coverage data: java.security.AccessControlException: Access denied (java.io.FilePermission coverage.ec read)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at com.vladium.emma.rt.RTCoverageDataPersister.dumpCoverageData(RTCoverageDataPersister.java:71)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at com.vladium.emma.rt.RTExitHook.run(RTExitHook.java:32)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.lang.Thread.run(Thread.java:801)&lt;/p&gt;</comment>
                            <comment id="12576251" author="vemund" created="Fri, 7 Mar 2008 15:57:33 +0000"  >&lt;p&gt;You are correct, emma tries to read and write to the coverage.ec file at system exit (and read $&lt;/p&gt;
{user.dir}
&lt;p&gt; but I guess that may be allowed by the default policy).&lt;/p&gt;

&lt;p&gt;I have no better suggestions for a solution, other than what you suggest. I guess the network server only needs to remove the security manager if it is being shut down and is running as a separate process (about to exit).&lt;/p&gt;</comment>
                            <comment id="12576300" author="djd" created="Fri, 7 Mar 2008 17:49:30 +0000"  >&lt;p&gt;Thinking a little more I&apos;m not sure the network server removing its security manager is a good idea. It would allow any code in shutdown hooks to have free use of the jvm.&lt;/p&gt;

&lt;p&gt;A better long term solution would be to allow a set of policies to be added into the network server&apos;s default set. E.g. could add this policy file  emma.policy:&lt;/p&gt;

&lt;p&gt;grant codebase &quot;... path to emma jars&quot; &lt;/p&gt;
{
   // permissions needed
}

&lt;p&gt;java -jar derbyrun.jar server -additionalPolicy emma.policy start&lt;/p&gt;

&lt;p&gt;This would then be logically added into the permission set that Derby installs automatically.&lt;/p&gt;</comment>
                            <comment id="12577982" author="djd" created="Wed, 12 Mar 2008 19:08:49 +0000"  >&lt;p&gt;When running junit-single, if the test fails the build is successful, it should fail.&lt;/p&gt;</comment>
                            <comment id="12578721" author="vemund" created="Fri, 14 Mar 2008 13:15:51 +0000"  >&lt;p&gt;Doesn&apos;t the &amp;lt;junit-all&amp;gt;, &amp;lt;junit-core&amp;gt;, &amp;lt;junit-jdbc4&amp;gt;, etc. behave in the same way as &amp;lt;junit-single&amp;gt; by not causing the build to fail if a test fails? At least I cannot from the code see that there is any difference. None of these targets have something like:&lt;/p&gt;

&lt;p&gt;  	&amp;lt;fail if=&quot;tests.failed&quot;&amp;gt;Tests Failed!&amp;lt;/fail&amp;gt;&lt;/p&gt;

&lt;p&gt;From my reading only the &amp;lt;junit-html&amp;gt;, the &amp;lt;junit-&lt;b&gt;&lt;del&gt;codeline-jars&amp;gt; and the &amp;lt;emma&lt;/del&gt;&lt;/b&gt;&amp;gt; targets do this.&lt;/p&gt;

&lt;p&gt;If all the junit targets were changed to cause build failure if a test fails, then targets like &amp;lt;junitreport&amp;gt; would abort without producing a report if there is a test failure? The same would be true if running with emma, no coverage reports, at least thats what happened when I tested it with &amp;lt;emma-single&amp;gt;. I don&apos;t know if it is possible to get ant to proceed with the next task even if one it depends on fails?&lt;/p&gt;

&lt;p&gt;Maybe a solution here would be to add a &amp;lt;junit-single-report&amp;gt; target to be the equivalent of the &amp;lt;junitreport&amp;gt; target, which would then build a report after the test is run and cause a build failure if the test/suite fails? The &amp;lt;junit-single-report&amp;gt; target can be used when it is important to get test failure translated to build failure, while the &amp;lt;junit-single&amp;gt; target would remain to be used by &amp;lt;emma-single&amp;gt; and &amp;lt;junit-single-report&amp;gt; or directly if you are not concerned about the build failure problem.&lt;/p&gt;</comment>
                            <comment id="12578722" author="vemund" created="Fri, 14 Mar 2008 13:18:17 +0000"  >&lt;p&gt;Seems I forgot to tick the patch available box when I uploaded the patch for emma-clean: 3445-emma-clean-fix-diff&lt;/p&gt;</comment>
                            <comment id="12583713" author="vemund" created="Mon, 31 Mar 2008 16:05:47 +0100"  >&lt;p&gt;&amp;gt; A better long term solution would be to allow a set of policies to be added into the network server&apos;s default set. E.g. could add this policy file emma.policy:&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; grant codebase &quot;... path to emma jars&quot; &lt;/p&gt;
{
&amp;gt;    // permissions needed
&amp;gt; }
&lt;p&gt;&amp;gt; &lt;br/&gt;
&amp;gt; java -jar derbyrun.jar server -additionalPolicy emma.policy start&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; This would then be logically added into the permission set that Derby installs automatically.&lt;/p&gt;

&lt;p&gt;As far as I understand your suggestion is to add a new option to the network server (-additionalPolicy, or something along those lines). This new option would then only have an effect if the network server is started in a way that causes it to install its own default security policy. The effect would then be to merge the contents of the default policy file (server.policy) with whatever policy file is added with the new argument (emma.policy) into a new file, and then set the java.security.policy property to point to this file before installing a SecurityManager. &lt;/p&gt;

&lt;p&gt;Would this be a feature added just to be able to test the product with EMMA, or do you think of other use cases as well?&lt;br/&gt;
Real users would be able to put a policy file under $&lt;/p&gt;
{user.home}
&lt;p&gt;/.java.policy or just set -Djava.security.policy, so I guess they wouldn&apos;t have a need for it. &lt;/p&gt;</comment>
                            <comment id="12584579" author="vemund" created="Wed, 2 Apr 2008 15:20:11 +0100"  >&lt;p&gt;&amp;gt; Thinking a little more I&apos;m not sure the network server removing its security manager is a good idea. It would allow any code in shutdown hooks to have free use of the jvm.&lt;/p&gt;

&lt;p&gt;I&apos;m pondering more about how to best solve this issue. How about having some way of triggering this behavior, a property or something else, that would only be used for the purpose of testing with EMMA? If property X is set, the network server removes the security manager right before doing shutdown, but only in the case were it has installed a security manager itself with the default policy.&lt;/p&gt;

&lt;p&gt;What is the view on adding such an interface (property or similar) to the product, which is only intended for testing purposes?&lt;/p&gt;</comment>
                            <comment id="12586716" author="dyret" created="Tue, 8 Apr 2008 09:55:08 +0100"  >&lt;p&gt;I&apos;m trying to follow the discussion here, but I&apos;m not quite sure if the latest comments (after 31/Mar) affect the 3445-emma-clean-fix-diff patch or not. If they do, I suggest removing &apos;patch-available&apos; from this issue.&lt;/p&gt;</comment>
                            <comment id="12586734" author="vemund" created="Tue, 8 Apr 2008 10:58:43 +0100"  >&lt;p&gt;The 3445-emma-clean-fix is unrelated to the discussions, so that patch should still be committed I think.&lt;/p&gt;</comment>
                            <comment id="12586763" author="dyret" created="Tue, 8 Apr 2008 12:35:27 +0100"  >&lt;p&gt;Patch file: 3445-emma-clean-fix-diff&lt;br/&gt;
Committed revision 645859.&lt;/p&gt;</comment>
                            <comment id="12592810" author="vemund" created="Mon, 28 Apr 2008 14:48:31 +0100"  >&lt;p&gt;I don&apos;t  plan to spend more time on this issue. To clearly separate the work that has been completed as part of this issue from what has not, I have created two new Jira reports related to running tests with EMMA to cover work that I think would be useful to do: &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3647&quot; title=&quot;EMMA is unable to write coverage information from network server when it is started in a separate process with default security policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3647&quot;&gt;&lt;del&gt;DERBY-3647&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3648&quot; title=&quot;Add emma.jar and emma_ant.jar to tools/java/ directory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3648&quot;&gt;&lt;del&gt;DERBY-3648&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12698632" author="myrna" created="Tue, 14 Apr 2009 03:47:55 +0100"  >&lt;p&gt;Majority of commits were before 10.4 branch creation.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12389902">DERBY-3483</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12394911">DERBY-3647</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12376833" name="3445-SysinfoLocaleTest-diff" size="1821" author="vemund" created="Fri, 29 Feb 2008 15:23:09 +0000"/>
                            <attachment id="12377161" name="3445-emma-clean-fix-diff" size="401" author="vemund" created="Wed, 5 Mar 2008 12:00:22 +0000"/>
                            <attachment id="12376417" name="3445-general-diff" size="10467" author="vemund" created="Mon, 25 Feb 2008 16:49:01 +0000"/>
                            <attachment id="12376500" name="3445-general-diffv2" size="10967" author="vemund" created="Tue, 26 Feb 2008 16:11:39 +0000"/>
                            <attachment id="12377083" name="3445-singletest-codeline-jars-diff" size="2796" author="vemund" created="Tue, 4 Mar 2008 13:55:21 +0000"/>
                            <attachment id="12376834" name="3445-singletest-diff" size="3913" author="vemund" created="Fri, 29 Feb 2008 15:23:09 +0000"/>
                            <attachment id="12376418" name="3445-testspecific-diff" size="6791" author="vemund" created="Mon, 25 Feb 2008 16:49:01 +0000"/>
                            <attachment id="12376501" name="3445-testspecific-diffv2" size="6014" author="vemund" created="Tue, 26 Feb 2008 16:11:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 25 Feb 2008 17:43:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30856</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0lp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37333</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>