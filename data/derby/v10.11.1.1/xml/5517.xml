<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:15:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5517/DERBY-5517.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5517] testReplication_Local_3_p1_StateNegativeTests failed with connection refused</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5517</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.6/testing/testlog/sles/1206494-suitesAll_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.6/testing/testlog/sles/1206494-suitesAll_diff.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There was 1 error:&lt;br/&gt;
1) testReplication_Local_3_p1_StateNegativeTests(org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun_Local_3_p1)java.lang.Exception: DRDA_NoIO.S:Could not connect to Derby Network Server on host 127.0.0.1, port 1532: Connection refused&lt;br/&gt;
	at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessageWork(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessage(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.NetworkServerControlImpl.setUpSocket(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.NetworkServerControlImpl.ping(Unknown Source)&lt;br/&gt;
	at org.apache.derby.drda.NetworkServerControl.ping(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun.ping(ReplicationRun.java:2419)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun.pingServer(ReplicationRun.java:2406)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun.startServer(ReplicationRun.java:2126)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun_Local_3_p1.testReplication_Local_3_p1_StateNegativeTests(ReplicationRun_Local_3_p1.java:90)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:116)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun.runBare(ReplicationRun.java:208)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12533668">DERBY-5517</key>
            <summary>testReplication_Local_3_p1_StateNegativeTests failed with connection refused</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Dec 2011 18:08:45 +0000</created>
                <updated>Thu, 1 Nov 2012 21:10:43 +0000</updated>
                            <resolved>Mon, 12 Dec 2011 14:22:33 +0000</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Replication</component>
                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13165218" author="knutanders" created="Thu, 8 Dec 2011 13:56:03 +0000"  >&lt;p&gt;I was wondering if the root cause for these failures could be similar the same problem that caused &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4201&quot; title=&quot;SecureServerTest AssertionFailedError: Timed out waiting for network server to start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4201&quot;&gt;&lt;del&gt;DERBY-4201&lt;/del&gt;&lt;/a&gt;, so I tried to run the replication tests with the repro patch attached to that issue. And indeed many of the replication tests failed with connection refused when they ran with the patched code.&lt;/p&gt;

&lt;p&gt;So it seems like one possible cause of the problem reported here, is that a server (slave or master) is not fully shut down after ReplicationRun.tearDown() has completed. tearDown() invokes a shutdown command on the slave server and on the master server. However, as seen in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4201&quot; title=&quot;SecureServerTest AssertionFailedError: Timed out waiting for network server to start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4201&quot;&gt;&lt;del&gt;DERBY-4201&lt;/del&gt;&lt;/a&gt;, a server shutdown command returns when the server stops responding, which happens before the server is fully closed down. So if a new network server is started shortly thereafter, it may not be able to start successfully because the port hasn&apos;t been released yet. Since the network server doesn&apos;t start, clients that try to connect will see &quot;connection refused&quot; errors.&lt;/p&gt;

&lt;p&gt;The attached patch attempts to address this issue by letting ReplicationRun.tearDown() wait until all server processes have completed. It does that by keeping a list of java.lang.Thread instances that read the output from the server processes, and calls join() on all those threads in tearDown(). This way, we won&apos;t start the next test case (and the next server) until the servers started by the previous test case have been terminated.&lt;/p&gt;

&lt;p&gt;With this patch, the replication test suite ran cleanly, even with the repro patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4201&quot; title=&quot;SecureServerTest AssertionFailedError: Timed out waiting for network server to start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4201&quot;&gt;&lt;del&gt;DERBY-4201&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13167503" author="knutanders" created="Mon, 12 Dec 2011 14:22:33 +0000"  >&lt;p&gt;Committed revision 1213251.&lt;/p&gt;</comment>
                            <comment id="13169944" author="myrna" created="Thu, 15 Dec 2011 02:50:05 +0000"  >&lt;p&gt;Is this fix suitable for backport to 10.8?&lt;/p&gt;</comment>
                            <comment id="13169998" author="knutanders" created="Thu, 15 Dec 2011 07:26:23 +0000"  >&lt;p&gt;Merged fix to 10.8 and committed revision 1214644.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12504587">DERBY-5197</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12501060">DERBY-5123</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12506607" name="d5517-1a.diff" size="3476" author="knutanders" created="Thu, 8 Dec 2011 13:56:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 15 Dec 2011 02:50:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>219395</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ayv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35595</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>