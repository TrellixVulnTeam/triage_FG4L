<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:07:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3997/DERBY-3997.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3997] ORDER BY causes column to be returned</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3997</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The ORDER BY is causing the ordered column to be retrieved even though it is not part of the SELECT clause. Here is a script to create a table, insert a row, and perform the select:&lt;/p&gt;


&lt;p&gt;CREATE TABLE &quot;REVIEWS&quot;.&quot;GEOFF_&lt;em&gt;REVIEWS&lt;/em&gt;_REVIEW&quot;&lt;br/&gt;
(&lt;br/&gt;
   PK INTEGER PRIMARY KEY not null,&lt;br/&gt;
   numstars BIGINT,&lt;br/&gt;
   body VARCHAR(32672),&lt;br/&gt;
   title VARCHAR(32672),&lt;br/&gt;
   authoremail VARCHAR(32672)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;INSERT INTO &quot;REVIEWS&quot;.&quot;GEOFF_&lt;em&gt;REVIEWS&lt;/em&gt;_REVIEW&quot; (PK,numstars,body,title,authoremail) VALUES (0 /&lt;b&gt;not nullable&lt;/b&gt;/,0,&apos;s&apos;,&apos;s&apos;,&apos;s&apos;);&lt;/p&gt;

&lt;p&gt;SELECT  &quot;review&quot;.&quot;numstars&quot;&lt;br/&gt;
FROM&lt;br/&gt;
    &quot;GEOFF_&lt;em&gt;REVIEWS&lt;/em&gt;_REVIEW&quot; AS &quot;review&quot;&lt;br/&gt;
WHERE&lt;br/&gt;
        &quot;review&quot;.&quot;PK&quot; = 1&lt;br/&gt;
ORDER BY&lt;br/&gt;
    &quot;review&quot;.PK&lt;/p&gt;</description>
                <environment>Mac OS 10.4, JDK 1,6</environment>
        <key id="12411288">DERBY-3997</key>
            <summary>ORDER BY causes column to be returned</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="geoff_hendrey">geoff hendrey</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Dec 2008 06:08:14 +0000</created>
                <updated>Fri, 21 Jan 2011 17:52:11 +0000</updated>
                            <resolved>Mon, 5 Jan 2009 15:32:04 +0000</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.3.0</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12659165" author="knutanders" created="Wed, 24 Dec 2008 22:33:36 +0000"  >&lt;p&gt;I managed to reproduce it with an even simpler script:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t (x int primary key, y int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select y from t where x = 1 order by x;&lt;br/&gt;
Y          |X          &lt;br/&gt;
-----------------------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;/p&gt;

&lt;p&gt;Remove the WHERE clause or the ORDER BY clause, and the column X disappears.&lt;/p&gt;</comment>
                            <comment id="12659166" author="bryanpendleton" created="Wed, 24 Dec 2008 22:47:17 +0000"  >&lt;p&gt;Thanks Geoff and Knut, these scripts are great. Perhaps the common element&lt;br/&gt;
is that in all these scripts, the &quot;extra&quot; column is in both the WHERE and ORDER BY clauses?&lt;/p&gt;</comment>
                            <comment id="12659521" author="geoff_hendrey" created="Mon, 29 Dec 2008 07:45:54 +0000"  >&lt;p&gt;Are you able to provide a target release for a fix? It would be a big help to know when a fix will come in as this bug causes a problem for me in a production environment.&lt;/p&gt;</comment>
                            <comment id="12659630" author="knutanders" created="Mon, 29 Dec 2008 20:03:24 +0000"  >&lt;p&gt;I think I&apos;ve found the cause of the problem. This code in SelectNode.preprocess() will be executed when all the columns in the ORDER BY clause are known to have constant values because of the WHERE clause:&lt;/p&gt;

&lt;p&gt;				/*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;It&apos;s possible for the order by list to shrink to nothing&lt;/li&gt;
		&lt;li&gt;as a result of removing constant columns.  If this happens,&lt;/li&gt;
		&lt;li&gt;get rid of the list entirely.&lt;br/&gt;
				*/&lt;br/&gt;
				if (orderByList.size() == 0)
				{
					orderByList = null;
				}&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Later, in SelectNode.genProjectRestrict() the extra ORDER BY columns are supposed to be removed from the result, but this is only done if orderByList != null, as it assumes that (orderByList == null) means that there are no columns to remove. Calling resultColumns.removeOrderByColumns() when we set orderByList to null appears to fix the problem, but I haven&apos;t run the regression tests yet.&lt;/p&gt;</comment>
                            <comment id="12659709" author="bryanpendleton" created="Tue, 30 Dec 2008 00:27:39 +0000"  >&lt;p&gt;Thanks Knut for having a go at this. Your analysis sounds quite good to me.&lt;/p&gt;

&lt;p&gt;One interesting variant will be when the select list contains *, as I think there are&lt;br/&gt;
some complexities about whether you can remove the ORDER BY column in&lt;br/&gt;
this case, since it should end up in the result after all.&lt;/p&gt;

&lt;p&gt;So it might be worth ensuring that you try a few test cases including select * queries&lt;br/&gt;
when testing the patch.&lt;/p&gt;</comment>
                            <comment id="12659778" author="knutanders" created="Tue, 30 Dec 2008 09:05:14 +0000"  >&lt;p&gt;Here&apos;s a patch with a fix and a test case. Both suites.All and derbyall ran cleanly.&lt;/p&gt;

&lt;p&gt;Thanks for the suggestion about * in the select list, Bryan. I tested that manually, and I didn&apos;t find any problem. ResultColumnList.removeOrderByColumns() should only remove columns that have been added for the order by, and it should leave the original select list intact. I haven&apos;t added any test case to ensure that elimination of the order by clause doesn&apos;t remove columns that should have been in the result, as that seems to be tested already.&lt;/p&gt;</comment>
                            <comment id="12659836" author="bryanpendleton" created="Tue, 30 Dec 2008 16:01:08 +0000"  >&lt;p&gt;Hi Knut, the patch looks fine to me. I verified that the new test fails&lt;br/&gt;
without the change to SelectNode.java and passes with the change.&lt;/p&gt;

&lt;p&gt;I also tried a few other test cases, and confirmed that their results&lt;br/&gt;
look reasonable. I&apos;m not sure that they add anything all that valuable&lt;br/&gt;
to the patch, but for completeness here&apos;s the new cases I tried:&lt;/p&gt;

&lt;p&gt;1) selecting an actual column from the table rather than a constant expression&lt;br/&gt;
2) selecting * from the table&lt;br/&gt;
3) selecting from the table with a WHERE clause that does NOT reduce&lt;br/&gt;
the ORDER BY to a a constant.&lt;/p&gt;

&lt;p&gt;If you think they&apos;re useful enough to add to the patch, go for it, otherwise&lt;br/&gt;
I think you can just commit the patch as is.&lt;/p&gt;

&lt;p&gt;Thanks again for picking this issue up!&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table d3997_a(a int, b int, c int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into d3997_a values (1,2,3);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select a from d3997_a where b = 2 order by b;&lt;br/&gt;
A&lt;br/&gt;
-----------&lt;br/&gt;
1&lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; select * from d3997_a where b != 2 order by b;&lt;br/&gt;
A          |B          |C&lt;br/&gt;
-----------------------------------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;br/&gt;
ij&amp;gt; select c from d3997_a where b &amp;gt; 1 order by b;&lt;br/&gt;
C&lt;br/&gt;
-----------&lt;br/&gt;
3&lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;</comment>
                            <comment id="12659853" author="knutanders" created="Tue, 30 Dec 2008 17:22:02 +0000"  >&lt;p&gt;Thanks for looking at the patch, Bryan, and for the extra test cases.&lt;/p&gt;

&lt;p&gt;I added some variations of your test cases and a test case for dynamic columns (see below) and committed revision 730188. I plan to back-port the fix to 10.4 so I&apos;m leaving the issue open.&lt;/p&gt;

&lt;p&gt;&amp;#8211; &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3997&quot; title=&quot;ORDER BY causes column to be returned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3997&quot;&gt;&lt;del&gt;DERBY-3997&lt;/del&gt;&lt;/a&gt;: Elimination of ORDER BY clause because all the columns&lt;br/&gt;
&amp;#8211; to order by were known to be constant, made extra columns appear in&lt;br/&gt;
&amp;#8211; the result.&lt;br/&gt;
create table d3997(x int, y int, z int);&lt;br/&gt;
&amp;#8211; These queries used to have two result columns, but should only have one&lt;br/&gt;
select 1 from d3997 where x=1 order by x;&lt;br/&gt;
select y from d3997 where x=1 order by x;&lt;br/&gt;
&amp;#8211; Used to have three columns, should only have two&lt;br/&gt;
select y,z from d3997 where x=1 order by x;&lt;br/&gt;
&amp;#8211; Used to have three columns, should only have one&lt;br/&gt;
select x from d3997 where y=1 and z=1 order by y,z;&lt;br/&gt;
&amp;#8211; Dynamic parameters are also constants (expect one column)&lt;br/&gt;
execute &apos;select x from d3997 where y=? order by y&apos; using &apos;values 1&apos;;&lt;br/&gt;
&amp;#8211; Order by columns should not be removed from the result here&lt;br/&gt;
select * from d3997 where x=1 order by x;&lt;br/&gt;
select x,y,z from d3997 where x=1 order by x;&lt;br/&gt;
select x,y,z from d3997 where x=1 and y=1 order by x,y;&lt;br/&gt;
&amp;#8211; Order by should not be eliminated here (not constant values). Insert some&lt;br/&gt;
&amp;#8211; data in reverse order to verify that the results are sorted.&lt;br/&gt;
insert into d3997 values (9,8,7),(6,5,4),(3,2,1);&lt;br/&gt;
select * from d3997 where y&amp;lt;&amp;gt;2 order by y;&lt;br/&gt;
select z from d3997 where y&amp;gt;2 order by y;&lt;br/&gt;
drop table d3997;&lt;/p&gt;</comment>
                            <comment id="12660205" author="geoff_hendrey" created="Thu, 1 Jan 2009 18:25:49 +0000"  >&lt;p&gt;Thanks guys. Do we know when a derby binary release will include this fix?&lt;/p&gt;</comment>
                            <comment id="12660243" author="knutanders" created="Thu, 1 Jan 2009 22:40:27 +0000"  >&lt;p&gt;There has been some talk about producing a 10.5 release in the first quarter of 2009, but no target date has been decided yet.&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200811.mbox/%3C491C864E.6010008@sun.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200811.mbox/%3C491C864E.6010008@sun.com%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12660788" author="knutanders" created="Mon, 5 Jan 2009 15:32:03 +0000"  >&lt;p&gt;Merged the fix to 10.4 and committed revision 731599.&lt;/p&gt;</comment>
                            <comment id="12721389" author="kmarsden" created="Thu, 18 Jun 2009 19:08:22 +0100"  >&lt;p&gt;This exists back to 10.1, fixing affects version&lt;/p&gt;</comment>
                            <comment id="12722744" author="kmarsden" created="Mon, 22 Jun 2009 19:28:08 +0100"  >&lt;p&gt;I  am backporting this patch to 10.2 and notice that it uses ResultColumnList.removeOderByColumns which was added in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt;. Just adding the  one method to the 10.2 ResultColumnList seems to make everything work ok and orderByElimination passes, but I just thought I would mention it in case it seems like a problem to anyone.  I will run the full regression tests.&lt;/p&gt;
</comment>
                            <comment id="12722771" author="kmarsden" created="Mon, 22 Jun 2009 20:15:45 +0100"  >&lt;p&gt;checked into 10.3. This will still go to 10.2 and 10.1&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12407399">DERBY-3926</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12396900" name="d3997.diff" size="2182" author="knutanders" created="Tue, 30 Dec 2008 09:05:14 +0000"/>
                            <attachment id="12396901" name="d3997.stat" size="249" author="knutanders" created="Tue, 30 Dec 2008 09:05:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 24 Dec 2008 22:33:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23963</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0l9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37263</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>