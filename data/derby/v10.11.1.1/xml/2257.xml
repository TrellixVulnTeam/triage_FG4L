<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:52:48 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2257/DERBY-2257.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2257] Implementing the stored procedures called by the LOB related JDBC methods</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2257</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description></description>
                <environment>All environments</environment>
        <key id="12360843">DERBY-2257</key>
            <summary>Implementing the stored procedures called by the LOB related JDBC methods</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="31583">DERBY-208</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="narayanan">V.Narayanan</assignee>
                                    <reporter username="narayanan">V.Narayanan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jan 2007 05:06:41 +0000</created>
                <updated>Fri, 15 Jun 2007 13:33:43 +0100</updated>
                            <resolved>Tue, 8 May 2007 16:30:44 +0100</resolved>
                                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12465960" author="narayanan" created="Fri, 19 Jan 2007 05:12:26 +0000"  >&lt;p&gt;This patch contains the implementation of one function (Clob.getSubString) which&lt;br/&gt;
is being done in order to get feedback from the community. In addition to other&lt;br/&gt;
comments I was also having the following queries in mind for which I was&lt;br/&gt;
looking for advice from the community.&lt;/p&gt;

&lt;p&gt;1) Would it be a problem if the stored functions are visible to users&lt;br/&gt;
2) Where should the functions be placed? I had the following options&lt;br/&gt;
 a) SYSFUN - did not seem the right place since all the functions here seemed to called by the&lt;br/&gt;
         users&lt;br/&gt;
 b) SYSIBM - used for metadata functions&lt;br/&gt;
 c) SYSCS_UTIL&lt;/p&gt;

&lt;p&gt;PLS NOTE THAT THE PATCH IS NOT FOR COMMIT. &lt;/p&gt;</comment>
                            <comment id="12465993" author="narayanan" created="Fri, 19 Jan 2007 09:03:13 +0000"  >&lt;p&gt;The Stored procedures that are being implemented here are related to adding support to retrieve lobs for Network Server by locator rather than materializing the LOB. This is the core of Derby-208.&lt;/p&gt;

&lt;p&gt;The following extracts from comments on Derby-208 are very relevant&lt;/p&gt;

&lt;p&gt;extract-1&lt;br/&gt;
-------------&lt;/p&gt;

&lt;p&gt;The network client will request LOB columns to be sent as LOB Locators instead of data value bytes. Since the client no longer has a copy of the LOB data value bytes, operations on the LOB data will be performed on the server side, and the results of these operations will be sent to the client. The client will request the execution of an operation by the server by calling a stored procedure.&lt;/p&gt;

&lt;p&gt;extract-2&lt;br/&gt;
--------------&lt;/p&gt;

&lt;p&gt;The implementation of LOB related JDBC methods in the network client must be converted to use LOB Locators instead of having a copy of the LOB data in the client side. Since the client will no longer have the data value bytes for the LOB, operations performed on the data must be performed on the server side. This will be done using stored procedures. Each time a LOB related JDBC method is called, the client driver will &quot;convert&quot; that call into a call to one or more stored procedures.&lt;/p&gt;

&lt;p&gt;The design document attached to Derby-208 will also give further insight into the bigger picture into which the stored procedure described here fits in.&lt;/p&gt;</comment>
                            <comment id="12473933" author="narayanan" created="Sat, 17 Feb 2007 14:22:40 +0000"  >&lt;p&gt;Pls find attached the patch containing the Stored procedures, related to adding support to retrieving lobs from Network Server by locator rather than by materializing the LOB. Also pls find attached a document explaining the changes in detail.&lt;/p&gt;

&lt;p&gt;thanx,&lt;br/&gt;
Narayanan&lt;/p&gt;</comment>
                            <comment id="12474182" author="oysteing" created="Mon, 19 Feb 2007 14:22:45 +0000"  >&lt;p&gt;I applied your patch and ran the Junit test suite with Java SE 6.  I got a few failures in jdbc4/TestDbMetaData. The new stored functions changes the result sets from metadata functions.  Either the test needs to be modified, or one needs to find some way to prevent these functions from being included in the metadata result set.&lt;/p&gt;</comment>
                            <comment id="12474350" author="narayanan" created="Tue, 20 Feb 2007 04:46:10 +0000"  >&lt;p&gt;Thank you for running the tests and for the subsequent pointers oystein. I will take a look at this.&lt;/p&gt;

&lt;p&gt;Narayanan&lt;/p&gt;</comment>
                            <comment id="12474405" author="oysteing" created="Tue, 20 Feb 2007 10:55:54 +0000"  >&lt;p&gt;I ran derbyall and got failures in these tests which seems to be related to changes in this patch:&lt;/p&gt;

&lt;p&gt;derbyall/derbyall.fail:jdbcapi/metadata.java&lt;br/&gt;
derbyall/derbyall.fail:jdbcapi/odbc_metadata.java&lt;br/&gt;
derbyall/derbyall.fail:lang/grantRevokeDDL2.sql&lt;br/&gt;
derbyall/derbynetclientmats/derbynetmats.fail:jdbcapi/metadata.java&lt;br/&gt;
derbyall/derbynetclientmats/derbynetmats.fail:jdbcapi/odbc_metadata.java&lt;/p&gt;

&lt;p&gt;The failures seems come from undexpected metadata output due the new procedures.&lt;/p&gt;</comment>
                            <comment id="12474654" author="knutanders" created="Wed, 21 Feb 2007 08:10:32 +0000"  >&lt;p&gt;A couple of questions after a quick look at the patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does EmbedConnection.lobHashTable need to be a Hashtable, or could it be an unsynchronized HashMap. The comments say that it is a HashMap, and I think all uses of it will already be synchronized on the connection object.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Could EmbedConnection.getIncLOBKey() be made private?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think all calls to getIncLOBKey() will be synchronized on getConnectionSynchronization(), so there should be no need to do explicit synchronization in that method.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;EmbedConnection.lobHTKey could be private.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOBStoredProcedure.getEmbedConnection() could be simplified to: return (EmbedConnection) DriverManager.getConnection(...);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;BrokeredConnection catches and ignores SQLExceptions. Wouldn&apos;t it be better to declare the methods as &quot;throws SQLException&quot; and let the exception be handled properly by the caller?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Comments for ClobStoredProcecedureTest.tearDown() and BlobStoredProcedureTest.tearDown() say &quot;drop the table and close the connection&quot;, but they don&apos;t drop any table.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tearDown() should call super.tearDown().&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Perhaps the suite() method could mention why the tests only run in embedded mode?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12474655" author="narayanan" created="Wed, 21 Feb 2007 08:22:21 +0000"  >&lt;p&gt;Thank you for taking a look at the patch. Pls find a couple of answers inline. The rest of the comments you have placed are very valid and I have no argument to offer to them except that I will do the same and post it in my next patch. Thank you for the review.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does EmbedConnection.lobHashTable need to be a Hashtable, or could it be an unsynchronized HashMap. The comments say that it is a HashMap, and I think all uses of it will already be synchronized on the connection object.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Ans: If you notice the doc I had written along with the patch i had requested for advice regarding this issue because I wasn&apos;t sure about the synchronization issue. I can change this to a HashMap in my next patch.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Perhaps the suite() method could mention why the tests only run in embedded mode?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will make this to run in the client mode in my next patch. Making them run in the embedded mode alone is a mistake which I had failed to catch while submitting the patch. I noticed it today morning and would&apos;ve placed a comment to the same effect.&lt;/p&gt;</comment>
                            <comment id="12474657" author="narayanan" created="Wed, 21 Feb 2007 08:29:06 +0000"  >&lt;p&gt;The following are a few questions I had highlighted in the txt file I had placed as an attachment to the issue and for which I was requesting for advice. &lt;/p&gt;

&lt;p&gt;Placing the stored functions&lt;br/&gt;
-------------------------------&lt;/p&gt;

&lt;p&gt;1) Would it be a problem if the stored functions are visible to users&lt;br/&gt;
2) Where should the functions be placed? I had the following options&lt;br/&gt;
a) SYSFUN - did not seem the right place since all the functions here seemed to&lt;br/&gt;
called by the&lt;br/&gt;
        users&lt;br/&gt;
b) SYSIBM - used for metadata functions&lt;br/&gt;
c) SYSCS_UTIL - I used this&lt;/p&gt;

&lt;p&gt;Synchronization of locator related code inside EmbedConnection&lt;br/&gt;
-------------------------------------------------------------------&lt;br/&gt;
would the rootConnection(EmbedConnection line no 157) shared across multiple&lt;br/&gt;
client connections? Would this result in a problem when adding code related to&lt;br/&gt;
adding locator to LOBReference mappings?&lt;/p&gt;

&lt;p&gt;Currently I use a HashTable(which is a synchronized) and ensure synchronization&lt;br/&gt;
when I increment locator value&lt;/p&gt;

&lt;p&gt;synchronized(getConnectionSynchronization()) &lt;/p&gt;
{
  rootConnection.lobHTKey = rootConnection.lobHTKey + 1;
  return rootConnection.lobHTKey;
}

&lt;p&gt;Is this required?&lt;br/&gt;
If it is required, is the synchronization I have done sufficient?&lt;/p&gt;

&lt;p&gt;Temporary code in CLOBSETSTRING to add data in a Clob object&lt;br/&gt;
------------------------------------------------------------------&lt;br/&gt;
Since the set methods in the Clob interface have not yet been implemented and&lt;br/&gt;
for testing the Stored procedure code we need a Clob object populated with data&lt;br/&gt;
from the database to be added in the HashTable storing the locator to&lt;br/&gt;
LOBReference mapping in the HashTable in EmbedConnection the following two&lt;br/&gt;
step procedure has been followed while doing a &lt;/p&gt;

&lt;p&gt;CLOBSETSTRING(LOCATOR).&lt;/p&gt;

&lt;p&gt;1) Create a new Clob object with the supplied data&lt;br/&gt;
newEmbedClob(&amp;lt;DATA&amp;gt;,&amp;lt;CONNECTION OBJECT&amp;gt;)&lt;br/&gt;
2) replace the Clob associated with LOCATOR in the HashTable with this&lt;br/&gt;
new Clob.&lt;/p&gt;


&lt;p&gt;I will be posting a new patch handling test failures and comments I have received soon. &lt;/p&gt;

&lt;p&gt;thanx,&lt;br/&gt;
Narayanan&lt;/p&gt;</comment>
                            <comment id="12474700" author="knutanders" created="Wed, 21 Feb 2007 13:48:55 +0000"  >&lt;p&gt;Sorry, I didn&apos;t read the doc first. Now you at least know my answer to one of the questions. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;As to your question about which schema to use for the procedures, I think I&apos;m leaning slightly towards SYSIBM. All the procedures in SYSCS_UTIL are meant to be invoked by the user, whereas the procedures in SYSIBM are for internal use. I don&apos;t think it&apos;s a problem that the procedures are visible, since there&apos;s not much harm a user can do with them.&lt;/p&gt;</comment>
                            <comment id="12474720" author="knutanders" created="Wed, 21 Feb 2007 15:03:56 +0000"  >&lt;p&gt;One more question: Is upgrade handled in the patch? I think DataDictionaryImpl.create_10_3_LOB_Specific_functions() has to be called from DD_Version.doFullUpgrade() in order to create the procedures when upgrading from 10.2 or earlier versions.&lt;/p&gt;</comment>
                            <comment id="12474915" author="narayanan" created="Thu, 22 Feb 2007 05:02:27 +0000"  >&lt;p&gt;That would take care of Hard Upgrade. Soft upgrade would still be an issue. I thought Upgrade for this issue should not be part of this JIRA. Instead it should be done as a separate JIRA. &lt;/p&gt;

&lt;p&gt;If u agree with this, I will go on to raise a separate JIRA and will propose what I have in mind there. &lt;/p&gt;

&lt;p&gt;Also this patch is independent of the upgrade patch and will not cause any failures until the code that uses these stored procedures is actually put into the client.&lt;/p&gt;

&lt;p&gt;Also I will take your suggestion of moving the stored procedures into SYSIBM. &lt;/p&gt;

&lt;p&gt;Thank you for the review and comments.&lt;/p&gt;</comment>
                            <comment id="12474918" author="narayanan" created="Thu, 22 Feb 2007 05:50:20 +0000"  >&lt;p&gt;calling the same function in applySafeChanges in DD_Version would help in the creation of the stored procedures during soft upgrade. But I still need more advice on if his is the right thing to do. I will raise a JIRA and put my findings there.&lt;/p&gt;
</comment>
                            <comment id="12474968" author="knutanders" created="Thu, 22 Feb 2007 10:18:07 +0000"  >&lt;p&gt;It is OK to fix upgrade in another patch since the procedures are not currently used and won&apos;t break anything.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure whether the procedures should be created during soft upgrade. Soft upgrade is usually handled by falling back to the old behaviour.  If you for instance have a read-only database created with Derby 10.2, you can&apos;t create the procedures when you do a soft upgrade, but all the lob functionality that was present in 10.2 should still work.&lt;/p&gt;</comment>
                            <comment id="12474973" author="narayanan" created="Thu, 22 Feb 2007 10:39:09 +0000"  >&lt;p&gt;Thank you for the comments again,&lt;/p&gt;

&lt;p&gt;The situation you have pointed out is when the database is read-only. This would mean that the create procedure calls would fail. The server should be able to detect this and will not send locators. It will send the LOB instead and the client should be intelligent enough to handle this. The comments on Derby-2347 also point towards the same. &lt;/p&gt;

&lt;p&gt;I have copied the following from comments on - Derby -2347 today morning&lt;br/&gt;
------------------------------------------------------------------------------------------------------&lt;br/&gt;
&quot;Anyhow, the client will be made so that it also handles receiving LOBs when it had requested locators.  &quot;&lt;/p&gt;

&lt;p&gt;If the procedures are created the client will receive locators. Otherwise it will receive LOB&apos;s and will handle that. &lt;/p&gt;

&lt;p&gt;Even if we decide not to do it the soft upgrade by creating all the procedures we would need a mechanism that would provide the functionality without locators. We can use that same when the procedures are not there and resort to the locator implementation if we were able to create the procedures.&lt;/p&gt;

&lt;p&gt;Note that this is still the way I think can be done. I do not have code to support what I propose at this juncture but will come up with it in the upgrade JIRA issue.&lt;/p&gt;</comment>
                            <comment id="12475342" author="oysteing" created="Fri, 23 Feb 2007 13:55:26 +0000"  >&lt;p&gt;Question on the ...GETPOSITIONFROM... procedures: Should not the pos parameter be BIGINT/long? &lt;br/&gt;
If return position is long, I would think start position needs to be long, too.&lt;/p&gt;
</comment>
                            <comment id="12476356" author="anurag" created="Tue, 27 Feb 2007 20:08:53 +0000"  >&lt;p&gt;can we have code to add lob in hash (getlobHTObj().put(new Integer(loc),LOBReference)) in lob constructors ? That way the lob (and associated files) cleanup will be taken care in case of embedded mode too. &lt;/p&gt;</comment>
                            <comment id="12476567" author="narayanan" created="Wed, 28 Feb 2007 12:38:20 +0000"  >&lt;p&gt;Main Changes from the earlier patch&lt;br/&gt;
-----------------------------------&lt;/p&gt;

&lt;p&gt;1) ClobStoredProcedureTest and BlobStoredProcedureTest run in both the embedded and the Network mode.&lt;br/&gt;
2) Fixed Failures in &lt;br/&gt;
   jdbcapi/metadata.java&lt;br/&gt;
   jdbcapi/odbc_metadata.java&lt;br/&gt;
   lang/grantRevokeDDL2.sql&lt;br/&gt;
   jdbc4/TestDbMetaData.java(junit test) &lt;br/&gt;
3) Have resorted to using a HashMap in EmbedConnection.&lt;br/&gt;
4) Used SYSIBM as the schema for the stored procedures&lt;/p&gt;</comment>
                            <comment id="12476568" author="narayanan" created="Wed, 28 Feb 2007 12:41:04 +0000"  >&lt;p&gt;Made a mistake by not granting license to ASF for inclusion in ASF works. Re-attaching with the same. &lt;/p&gt;
</comment>
                            <comment id="12476610" author="oysteing" created="Wed, 28 Feb 2007 15:22:15 +0000"  >&lt;p&gt;Patch looks very good.  I have one issue that I think needs to be&lt;br/&gt;
addressed in a follow-up patch.  In your patch, clean-up of the&lt;br/&gt;
locator to LOB mapping happens only on explicit calls to commit() and&lt;br/&gt;
rollback().  I think clean-up needs to be done in other situations&lt;br/&gt;
too.  (On auto-commit, when setting the isolation level causes commit&lt;br/&gt;
of current transaction, when an error causes a transaction to be&lt;br/&gt;
rolled back, and probably some more cases.)  Also, it would be nice&lt;br/&gt;
with some tests that test the clean-up mechanism.&lt;/p&gt;

&lt;p&gt;Some minor nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;EmbedConnection.getIncLOBKey(): Why not just use the ++ operator?&lt;/li&gt;
	&lt;li&gt;Comments for setUp() of tests says that it does a&lt;br/&gt;
     getClob/getBlob, but it does not.&lt;/li&gt;
	&lt;li&gt;BaseJDBCTestCase has a prepareCall method you can use to prepare&lt;br/&gt;
     a callable statement on the default connection.&lt;/li&gt;
	&lt;li&gt;tearDown(): super.tearDown() will close the connection.  Hence,&lt;br/&gt;
     the subsequent calls to commit and close will work on a new&lt;br/&gt;
     connection.  Also, note that you do not have to do&lt;br/&gt;
     getConnection() to commit on the default connection.  There is&lt;br/&gt;
     BaseJDBCTestCase.commit() that will do it for you.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12476884" author="narayanan" created="Thu, 1 Mar 2007 10:42:05 +0000"  >&lt;p&gt;I am raising separate JIRA&apos;s for handling cleanup of Hash Map and also for upgrade. &lt;/p&gt;

&lt;p&gt;I have handled the rest of the issues pointed.&lt;/p&gt;

&lt;p&gt;thanx,&lt;br/&gt;
Narayanan &lt;/p&gt;</comment>
                            <comment id="12477266" author="narayanan" created="Fri, 2 Mar 2007 11:23:15 +0000"  >&lt;p&gt;Added license header to LOBStoredProcedure.java.&lt;/p&gt;</comment>
                            <comment id="12477956" author="narayanan" created="Mon, 5 Mar 2007 09:38:37 +0000"  >&lt;p&gt;I have addressed the issues pointed out in this patch and have also run the tests. Also I did a svn update on my checkout to verify whether the patch has been broken by a recent checkin. It has not been broken.&lt;/p&gt;

&lt;p&gt;Can a interested person please take a look at the patch and if everything is fine recommend a commit or give a commit?&lt;/p&gt;</comment>
                            <comment id="12478067" author="knutanders" created="Mon, 5 Mar 2007 15:23:55 +0000"  >&lt;p&gt;Thanks for addressing my previous comments. Some more questions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In previous versions of the patch the methods in BrokeredConnection forwarded calls to the underlying connection, but in v6 these methods are empty. Was that an intended change?&lt;/li&gt;
	&lt;li&gt;Should there have been a message for LOB_LOCATOR_INVALID = &quot;XJ217.S&quot; in messages.xml?&lt;/li&gt;
	&lt;li&gt;Some of the test cases test that certain statements fail. Wouldn&apos;t it be better if they used assertSQLState() to make sure the failures are the ones we expect?&lt;/li&gt;
	&lt;li&gt;I think it would be good if the test cases called cs.close().&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12478264" author="narayanan" created="Tue, 6 Mar 2007 05:09:13 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In previous versions of the patch the methods in BrokeredConnection forwarded calls to the underlying connection, but in v6 these methods are empty. Was that an intended change?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;yes, sorry about not explaining it in the comments. All Brokered calls are forwarded to the rootConnection. Hence it wasn&apos;t necessary to have an implementation for these methods here&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Some of the test cases test that certain statements fail. Wouldn&apos;t it be better if they used assertSQLState() to make sure the failures are the ones we expect?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The test cases that test for failure are in the ClobStoredProcedureTest class. All of them can be explained by considering the following example. The explanation follows the code snippet.&lt;/p&gt;

&lt;p&gt;       String str = &quot;This is a test string&quot;;&lt;br/&gt;
        int locator = 0;&lt;br/&gt;
        getConnection().setAutoCommit(false);&lt;br/&gt;
        CallableStatement cs  = getConnection().prepareCall&lt;br/&gt;
            (&quot;? = CALL SYSIBM.CLOBCREATELOCATOR()&quot;);&lt;br/&gt;
        cs.registerOutParameter(1,java.sql.Types.INTEGER);&lt;br/&gt;
        cs.executeUpdate();&lt;br/&gt;
        locator = cs.getInt(1);&lt;/p&gt;

&lt;p&gt;        cs  = getConnection().&lt;br/&gt;
            prepareCall(&quot;CALL SYSIBM.CLOBSETSTRING(?,?,?,?)&quot;);&lt;br/&gt;
        cs.setInt(1,locator);&lt;br/&gt;
        cs.setInt(2,1);&lt;br/&gt;
        cs.setLong(3,str.length());&lt;br/&gt;
        cs.setString(4,str);&lt;br/&gt;
        try &lt;/p&gt;
{
            cs.execute();
        }
&lt;p&gt;        catch(SQLException sqle) {&lt;br/&gt;
            while(sqle != null) &lt;/p&gt;
{
                System.out.println(sqle.getSQLState());
                sqle=sqle.getNextException();
            }
&lt;p&gt;        }&lt;/p&gt;

&lt;p&gt;CLOBSETSTRING internally calls Clob.setString. This is notImplemented but as explained in my comments I have added temporary code here to create a Clob for the purpose of testing my stored procedures.&lt;/p&gt;

&lt;p&gt;This is expected to throw an Not Implemented exception (has a SQLState of 0A000)&lt;/p&gt;

&lt;p&gt;In the above exercise I have tried to go through the exception chain to determine the SQLState something like what assertSQLState does in order to determine of any of the chained exceptions have the SQLState it expects.&lt;/p&gt;

&lt;p&gt;In the embedded case my output is this&lt;/p&gt;

&lt;p&gt;38000&lt;br/&gt;
0A000&lt;/p&gt;

&lt;p&gt;In the Network Client case my output is this&lt;/p&gt;

&lt;p&gt;38000&lt;/p&gt;

&lt;p&gt;I haven&apos;t been able to dig deeper into this discrepancy in expected SQLStates. I will do further investigation into this. &lt;/p&gt;

&lt;p&gt;Also the code in which I check for the SQLException is temporary and will be removed once the Clob locator methods are added.&lt;/p&gt;

&lt;p&gt;Hence I decided to retain it the same way.&lt;/p&gt;

&lt;p&gt;Thank you for the review. I am attaching a patch addressing the other issues you have pointed.&lt;/p&gt;

&lt;p&gt;Narayanan&lt;/p&gt;
</comment>
                            <comment id="12478265" author="narayanan" created="Tue, 6 Mar 2007 05:10:53 +0000"  >&lt;p&gt;This patch addresses the issues pointed.&lt;/p&gt;</comment>
                            <comment id="12478438" author="knutanders" created="Tue, 6 Mar 2007 15:16:30 +0000"  >&lt;p&gt;Committed StoredProcedure_v7 with revision 515139 after making these changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removed trailing whitespace&lt;/li&gt;
	&lt;li&gt;removed newline character in the new error message&lt;/li&gt;
	&lt;li&gt;added more calls to cs.close() in the tests&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12478440" author="narayanan" created="Tue, 6 Mar 2007 15:19:43 +0000"  >&lt;p&gt;Thanx a ton for the commit and the additional changes to the patch knut!&lt;/p&gt;</comment>
                            <comment id="12478448" author="knutanders" created="Tue, 6 Mar 2007 15:51:06 +0000"  >&lt;p&gt;&amp;gt; All Brokered calls are forwarded to the rootConnection. Hence it wasn&apos;t necessary to have an implementation for these methods here&lt;/p&gt;

&lt;p&gt;Perhaps a comment in the code explaining this would be helpful?&lt;/p&gt;

&lt;p&gt;&amp;gt; The test cases that test for failure are in the ClobStoredProcedureTest class. All of them can be explained by considering the following example. &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This problem sounds related to the problems described in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1629&quot; title=&quot;Exceptions thrown by code in procedures or triggers are not handled/thrown correctly by Derby&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1629&quot;&gt;&lt;del&gt;DERBY-1629&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1440&quot; title=&quot;jdk 1.6 client driver omits SQLStates and chained exceptions in error messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1440&quot;&gt;&lt;del&gt;DERBY-1440&lt;/del&gt;&lt;/a&gt;. I think the exceptions thrown in stored procedures are supposed to be wrapped in an SQLException with a specific SQL state, but I don&apos;t know the details.&lt;/p&gt;

&lt;p&gt;&amp;gt; Also the code in which I check for the SQLException is temporary and will be removed once the Clob locator methods are added.&lt;/p&gt;

&lt;p&gt;The tests for BLOBRELEASELOCATOR and CLOBRELEASELOCATOR also ignore expected SQLExceptions without checking SQL state. That code is not temporary, is it?&lt;/p&gt;</comment>
                            <comment id="12478690" author="narayanan" created="Wed, 7 Mar 2007 06:23:32 +0000"  >&lt;p&gt;&amp;gt;The tests for BLOBRELEASELOCATOR and CLOBRELEASELOCATOR also ignore &amp;gt;expected SQLExceptions without checking SQL state. That code is not temporary, is it?&lt;/p&gt;

&lt;p&gt;No this is not temporary code. Sorry about not pointing out this specific case. The earlier issue of exception wrapping exists here too.&lt;/p&gt;

&lt;p&gt;&amp;gt;Perhaps a comment in the code explaining this would be helpful?&lt;/p&gt;

&lt;p&gt;The patch addresses this issue&lt;/p&gt;

&lt;p&gt;Thank you for the comments.&lt;/p&gt;

&lt;p&gt;Narayanan&lt;/p&gt;</comment>
                            <comment id="12478707" author="knutanders" created="Wed, 7 Mar 2007 08:25:12 +0000"  >&lt;p&gt;Thanks for the explanations and the new patch. Committed v8 with revision 515488.&lt;/p&gt;</comment>
                            <comment id="12494308" author="narayanan" created="Tue, 8 May 2007 16:30:44 +0100"  >&lt;p&gt;The final patch has been submitted and committed. Marking this issue as resolved.&lt;/p&gt;</comment>
                            <comment id="12505206" author="narayanan" created="Fri, 15 Jun 2007 13:33:43 +0100"  >&lt;p&gt;All patches submitted and committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12363011">DERBY-2347</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12363865">DERBY-2385</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12363864">DERBY-2384</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12349230" name="Expln_StoredProc_LOB.txt" size="4268" author="narayanan" created="Fri, 19 Jan 2007 05:11:13 +0000"/>
                            <attachment id="12351427" name="Expln_StoredProc_LOB_v2.txt" size="5258" author="narayanan" created="Sat, 17 Feb 2007 14:22:40 +0000"/>
                            <attachment id="12352212" name="StoredProcedure_v3.diff" size="126056" author="narayanan" created="Wed, 28 Feb 2007 12:38:16 +0000"/>
                            <attachment id="12352213" name="StoredProcedure_v3.stat" size="1417" author="narayanan" created="Wed, 28 Feb 2007 12:38:19 +0000"/>
                            <attachment id="12352214" name="StoredProcedure_v4.diff" size="126056" author="narayanan" created="Wed, 28 Feb 2007 12:41:04 +0000"/>
                            <attachment id="12352215" name="StoredProcedure_v4.stat" size="1417" author="narayanan" created="Wed, 28 Feb 2007 12:41:04 +0000"/>
                            <attachment id="12352314" name="StoredProcedure_v5.diff" size="125402" author="narayanan" created="Thu, 1 Mar 2007 10:42:05 +0000"/>
                            <attachment id="12352315" name="StoredProcedure_v5.stat" size="1417" author="narayanan" created="Thu, 1 Mar 2007 10:42:05 +0000"/>
                            <attachment id="12352418" name="StoredProcedure_v6.diff" size="126287" author="narayanan" created="Fri, 2 Mar 2007 11:23:14 +0000"/>
                            <attachment id="12352419" name="StoredProcedure_v6.stat" size="1417" author="narayanan" created="Fri, 2 Mar 2007 11:23:15 +0000"/>
                            <attachment id="12352704" name="StoredProcedure_v7.diff" size="127432" author="narayanan" created="Tue, 6 Mar 2007 05:10:53 +0000"/>
                            <attachment id="12352705" name="StoredProcedure_v7.stat" size="1470" author="narayanan" created="Tue, 6 Mar 2007 05:10:53 +0000"/>
                            <attachment id="12352811" name="StoredProcedure_v8.diff" size="1450" author="narayanan" created="Wed, 7 Mar 2007 06:23:32 +0000"/>
                            <attachment id="12352812" name="StoredProcedure_v8.stat" size="163" author="narayanan" created="Wed, 7 Mar 2007 06:23:32 +0000"/>
                            <attachment id="12349228" name="StoredProcedures_v1.diff" size="16493" author="narayanan" created="Fri, 19 Jan 2007 05:11:13 +0000"/>
                            <attachment id="12349229" name="StoredProcedures_v1.stat" size="631" author="narayanan" created="Fri, 19 Jan 2007 05:11:13 +0000"/>
                            <attachment id="12351425" name="StoredProcedures_v2.diff" size="76044" author="narayanan" created="Sat, 17 Feb 2007 14:22:40 +0000"/>
                            <attachment id="12351426" name="StoredProcedures_v2.stat" size="975" author="narayanan" created="Sat, 17 Feb 2007 14:22:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 19 Feb 2007 14:22:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30346</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy11vb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39953</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>