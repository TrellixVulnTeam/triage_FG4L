<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:16:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6693/DERBY-6693.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6693] Assert failure/ArrayIndexOutOfBoundsException when using COUNT in MERGE matching clause</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6693</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This (meaningless) statement gives NPE in insane builds and&lt;br/&gt;
assert failure in sane builds:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;create table t2(x &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt;);
s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;create table t1(x &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt;);
s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert into t2 values 3,4&quot;&lt;/span&gt;);
s.executeUpdate(&lt;span class=&quot;code-quote&quot;&gt;&quot;merge into t1 using t2 on (t1.x=t2.x) &quot;&lt;/span&gt; + 
   &lt;span class=&quot;code-quote&quot;&gt;&quot;when not matched then insert values (count(*))&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I see it also applies to other aggregates, e.g. MAX.&lt;br/&gt;
stack trace (insane):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.sql.SQLException: Java exception: &apos;-1: java.lang.ArrayIndexOutOfBoundsException&apos;.
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.Util.seeNextException(Unknown Source)
        at org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedStatement.executeLargeUpdate(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(Unknown Source)
        at derby6565.Derby6565.main(Derby6565.java:46)
Caused by: ERROR XJ001: Java exception: &apos;-1: java.lang.ArrayIndexOutOfBoundsException&apos;.
        at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.wrapArgsForTransportAcrossDRDA(Unknown Source)
        ... 12 more
Caused by: java.lang.ArrayIndexOutOfBoundsException: -1
        at org.apache.derby.impl.services.bytecode.BCMethod.popStack(Unknown Source)
        at org.apache.derby.impl.services.bytecode.BCMethod.callMethod(Unknown Source)
        at org.apache.derby.impl.sql.compile.ResultColumnList.generateEvaluatedRow(Unknown Source)
        at org.apache.derby.impl.sql.compile.MatchingClauseNode.generateInsertUpdateRow(Unknown Source)
        at org.apache.derby.impl.sql.compile.MatchingClauseNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.MergeNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.compile.StatementNode.generate(Unknown Source)
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(Unknown Source)
        at org.apache.derby.impl.sql.GenericStatement.prepare(Unknown Source)
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(Unknown Source)
        ... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12732355">DERBY-6693</key>
            <summary>Assert failure/ArrayIndexOutOfBoundsException when using COUNT in MERGE matching clause</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Wed, 6 Aug 2014 19:10:17 +0100</created>
                <updated>Wed, 8 Oct 2014 19:36:22 +0100</updated>
                            <resolved>Thu, 7 Aug 2014 17:38:24 +0100</resolved>
                                    <version>10.10.2.0</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                    <fixVersion>10.12.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="14088448" author="dagw" created="Thu, 7 Aug 2014 00:12:57 +0100"  >&lt;p&gt;Uploading patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12660262/12660262_derby-6693.diff&quot; title=&quot;derby-6693.diff attached to DERBY-6693&quot;&gt;derby-6693.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which forbids aggregates in the matching clauses, and adds a test case to MergeStatementTest.&lt;/p&gt;</comment>
                            <comment id="14089147" author="knutanders" created="Thu, 7 Aug 2014 12:39:21 +0100"  >&lt;p&gt;The patch looks fine to me.&lt;/p&gt;

&lt;p&gt;I was wondering if the code might be slightly simpler if we instead changed MatchingClauseNode.bindExpressions() to check the contents of the ArrayList&amp;lt;AggregateNode&amp;gt; that is passed recursively to rcl.bindExpressions(), and raised an error if it was not empty. Then we wouldn&apos;t need to collect the aggregates twice. But then I realized that we would have to add similar code to MergeNode.bindExpression() in order to cover the refinement clauses as well, so I suppose there&apos;s not much to save by changing it after all.&lt;/p&gt;

&lt;p&gt;Maybe we should add a test case for aggregates in the refinement clauses, though. Your fix does cover those clauses, but since they are bound in a different code path than the other parts of the matching clause, it might be worthwhile adding a separate test case for them. For example this statement which fails with an assert before your patch, and fails with the expected 42Z09 error after your patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
merge into t1 using t2 on (t1.x=t2.x) when not matched and count(t2.x) &amp;gt; 1 then insert values (1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14089162" author="knutanders" created="Thu, 7 Aug 2014 13:08:16 +0100"  >&lt;p&gt;Tiny nit: assertCompileError() is probably better than assertStatementError() in the test, since it additionally verifies that the error is raised during compilation.&lt;/p&gt;</comment>
                            <comment id="14089260" author="rhillegas" created="Thu, 7 Aug 2014 15:29:00 +0100"  >&lt;p&gt;Patch looks good to me. +1 Thanks.&lt;/p&gt;</comment>
                            <comment id="14089389" author="jira-bot" created="Thu, 7 Aug 2014 17:16:56 +0100"  >&lt;p&gt;Commit 1616523 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dagw&quot; class=&quot;user-hover&quot; rel=&quot;dagw&quot;&gt;Dag H. Wanvik&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1616523&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1616523&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6693&quot; title=&quot;Assert failure/ArrayIndexOutOfBoundsException when using COUNT in MERGE matching clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6693&quot;&gt;&lt;del&gt;DERBY-6693&lt;/del&gt;&lt;/a&gt; Assert failure/ArrayIndexOutOfBoundsException when using COUNT in MERGE matching clause&lt;/p&gt;

&lt;p&gt;Patch derby-6693 which forbids aggregates in the matching clauses, and&lt;br/&gt;
adds a test case to MergeStatementTest, but:&lt;br/&gt;
the checked in code using assertCompileError instead of&lt;br/&gt;
assertStatementError for more precision (in MergeStatementTest).&lt;/p&gt;</comment>
                            <comment id="14089422" author="jira-bot" created="Thu, 7 Aug 2014 17:36:06 +0100"  >&lt;p&gt;Commit 1616529 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dagw&quot; class=&quot;user-hover&quot; rel=&quot;dagw&quot;&gt;Dag H. Wanvik&lt;/a&gt; in branch &apos;code/branches/10.11&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1616529&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1616529&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6693&quot; title=&quot;Assert failure/ArrayIndexOutOfBoundsException when using COUNT in MERGE matching clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6693&quot;&gt;&lt;del&gt;DERBY-6693&lt;/del&gt;&lt;/a&gt; Assert failure/ArrayIndexOutOfBoundsException when using COUNT in MERGE matching clause&lt;/p&gt;

&lt;p&gt;Backported from trunk cleanly as:&lt;/p&gt;

&lt;p&gt;svn merge -c 1616523 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The patch forbids aggregates in the matching clauses, and adds a test&lt;br/&gt;
case to MergeStatementTest.&lt;/p&gt;</comment>
                            <comment id="14163936" author="myrna" created="Wed, 8 Oct 2014 19:35:26 +0100"  >&lt;p&gt;Marking backport_reject_10_10 because this fix adds a new message. (It was ok for backport to 10.11 because that wasn&apos;t released yet).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12660262" name="derby-6693.diff" size="4800" author="dagw" created="Thu, 7 Aug 2014 00:12:57 +0100"/>
                            <attachment id="12660263" name="derby-6693.status" size="987" author="dagw" created="Thu, 7 Aug 2014 00:12:57 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 7 Aug 2014 11:39:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410383</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzsgqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410372</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>