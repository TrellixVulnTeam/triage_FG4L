<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:42:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4803/DERBY-4803.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4803] Sequences do not work in INSERT/SELECT</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4803</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Using sequence in SELECT works fine whereas the same SELECT query used in INSERT/SELECT results in &quot;The statement references the following sequence more than once&quot; error. This happens even though the SELECT in question returns exactly 1 row of data.&lt;/p&gt;

&lt;p&gt;The Reference Manual states 1. &quot; NEXT VALUE FOR expression may occur in the following places: SELECT statement: As part of the expression defining a returned column in a SELECT list&quot; and 2. &quot; NEXT VALUE expression may not appear in any of these situations: CASE expression, WHERE clause, &lt;br/&gt;
ORDER BY clause, Aggregate expression, ROW_NUMBER function, DISTINCT select list&quot;.&lt;br/&gt;
Nowhere a restriction on INSERT/SELECT is mentioned. Additionally, other databases (i.e. Oracle) support use of sequences in INSERT/SELECT.&lt;/p&gt;

&lt;p&gt;Therefore, I consider it a bug.&lt;/p&gt;</description>
                <environment>Mac OS X, Derby Network Server 10.6.1.0</environment>
        <key id="12474315">DERBY-4803</key>
            <summary>Sequences do not work in INSERT/SELECT</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="dkroot">DK</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Sep 2010 20:59:17 +0100</created>
                <updated>Mon, 17 Jun 2013 10:19:48 +0100</updated>
                            <resolved>Wed, 22 Sep 2010 13:42:31 +0100</resolved>
                                    <version>10.6.1.0</version>
                                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12910295" author="rhillegas" created="Thu, 16 Sep 2010 21:12:33 +0100"  >&lt;p&gt;The following script shows this behavior:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create sequence sequence1;&lt;/p&gt;

&lt;p&gt;create table t1( a int );&lt;br/&gt;
create table t2( a int, b int );&lt;/p&gt;

&lt;p&gt;insert into t1( a ) values ( 1 );&lt;/p&gt;

&lt;p&gt;insert into t2&lt;br/&gt;
select next value for sequence1, a from t1;&lt;/p&gt;</comment>
                            <comment id="12913173" author="rhillegas" created="Tue, 21 Sep 2010 19:58:01 +0100"  >&lt;p&gt;Attaching derby-4803-01-aa-simpleInsertSelect.diff. This fixes the bug for a simple insert/select case. The pre-existing test cases in SequenceTest pass cleanly. I will run the full regression test suite.&lt;/p&gt;

&lt;p&gt;The problem is that the NextSequenceNode is needlessly re-bound for INSERT...SELECT statements. On the second attempt to bind the statement, we discover that the sequence has already been seen and this triggers the overly conservative check for illegal conditions discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4513&quot; title=&quot;Forbid NEXT VALUE FOR clause in certain contexts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4513&quot;&gt;&lt;del&gt;DERBY-4513&lt;/del&gt;&lt;/a&gt;. The fix is to short-circuit the second, needless binding of the NextSequenceNode.&lt;/p&gt;

&lt;p&gt;DK, could you post the INSERT statement which disclosed this bug? I would like to verify whether this patch fixes your problem or whether I have merely fixed a related test case. Thanks.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/compile/NextSequenceNode.java&lt;/p&gt;

&lt;p&gt;Short-circuit redundant bindings of NEXT VALUE FOR clauses.&lt;/p&gt;

&lt;p&gt;------&lt;/p&gt;


&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceTest.java&lt;/p&gt;

&lt;p&gt;Test-case for this bug.&lt;/p&gt;</comment>
                            <comment id="12913332" author="dkroot" created="Wed, 22 Sep 2010 01:54:25 +0100"  >&lt;p&gt;Rick,&lt;/p&gt;

&lt;p&gt;that was quick!&lt;/p&gt;

&lt;p&gt;See attached test case. It fails in 10.6.1.0.&lt;/p&gt;</comment>
                            <comment id="12913521" author="rhillegas" created="Wed, 22 Sep 2010 13:42:05 +0100"  >&lt;p&gt;Tests passed cleanly for me. Committed derby-4803-01-aa-simpleInsertSelect.diff at subversion revision 999908.&lt;/p&gt;

&lt;p&gt;Hi DK,&lt;/p&gt;

&lt;p&gt;Your script now passes. I had to edit your script because it was trying to insert integers into varchar columns. Those problems must have been masked by this bug. Here is the modified script which now runs:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;CREATE SEQUENCE CART_TXN_ID_SEQ START WITH 1;&lt;br/&gt;
CREATE TABLE TABLE_1&lt;br/&gt;
(&lt;br/&gt;
  DOCNO VARCHAR(60) NOT NULL&lt;br/&gt;
, OTHER_DOCNO VARCHAR(60)&lt;br/&gt;
, CAN VARCHAR(7) NOT NULL&lt;br/&gt;
, ICD VARCHAR(6)&lt;br/&gt;
, FY VARCHAR(4)&lt;br/&gt;
, SGL_DEBIT_AMT DECIMAL(12, 2)&lt;br/&gt;
, FACTS_TP_CODE VARCHAR(10)&lt;br/&gt;
, AUTHORITY_DOCNO VARCHAR(60)&lt;br/&gt;
, ACTION_CODE VARCHAR(20)&lt;br/&gt;
, CART_TXN_ID INT&lt;br/&gt;
, CART_ID VARCHAR(50)&lt;br/&gt;
, LAST_UPDATED_BY_USER_ID VARCHAR(20)&lt;br/&gt;
, CREATED_DATE TIMESTAMP&lt;br/&gt;
, CONSTRAINT TABLE_1 PRIMARY KEY&lt;br/&gt;
  (&lt;br/&gt;
    CART_TXN_ID&lt;br/&gt;
  )&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;CREATE TABLE TABLE_2&lt;br/&gt;
(&lt;br/&gt;
  PROJECT_BUDGET CHAR(1)&lt;br/&gt;
, ACS_CAN CHAR(7)&lt;br/&gt;
, DIRECT_REIMB_FLAG CHAR(1)&lt;br/&gt;
, INSTITUTE CHAR(25)&lt;br/&gt;
, PROJECT_NBR CHAR(6)&lt;br/&gt;
, CURRENT_IND CHAR(1)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;insert into TABLE_2(project_budget, acs_can, direct_reimb_flag, institute, project_nbr, current_ind)&lt;br/&gt;
values(&apos;P&apos;, &apos;1234567&apos;, &apos;R&apos;, &apos;XYZ&apos;, &apos;123456&apos;, &apos;C&apos;);&lt;/p&gt;

&lt;p&gt;INSERT INTO&lt;br/&gt;
  TABLE_1 (&lt;br/&gt;
  cart_id,&lt;br/&gt;
  can,&lt;br/&gt;
  docno,&lt;br/&gt;
  fy,&lt;br/&gt;
  icd,&lt;br/&gt;
  other_docno,&lt;br/&gt;
  facts_tp_code,&lt;br/&gt;
  authority_docno,&lt;br/&gt;
  SGL_DEBIT_AMT,&lt;br/&gt;
  action_code,&lt;br/&gt;
  cart_txn_id,&lt;br/&gt;
  last_updated_by_user_id,&lt;br/&gt;
  created_date&lt;br/&gt;
) SELECT&lt;br/&gt;
  &apos;Abc&apos;,&lt;br/&gt;
  &apos;1234567&apos;,&lt;br/&gt;
  &apos;Y21&apos;,&lt;br/&gt;
  &apos;2010&apos;,&lt;br/&gt;
  TRIM(acs.institute),&lt;br/&gt;
  &apos;Y3123456&apos;,&lt;br/&gt;
  &apos;123&apos;,&lt;br/&gt;
  &apos;Y3123456&apos;,&lt;br/&gt;
  100,&lt;br/&gt;
  &apos;Action&apos;,&lt;br/&gt;
  NEXT VALUE FOR CART_TXN_ID_SEQ,&lt;br/&gt;
  &apos;Qwerty&apos;,&lt;br/&gt;
  CURRENT_TIMESTAMP&lt;br/&gt;
FROM&lt;br/&gt;
  table_2 acs&lt;br/&gt;
WHERE&lt;br/&gt;
  acs.acs_can = &apos;1234567&apos;;&lt;/p&gt;

&lt;p&gt;select * from table_1;&lt;/p&gt;</comment>
                            <comment id="13685363" author="knutanders" created="Mon, 17 Jun 2013 10:19:48 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12445329">DERBY-4513</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12455214" name="DerbyTestCase.sql" size="1228" author="dkroot" created="Wed, 22 Sep 2010 01:54:25 +0100"/>
                            <attachment id="12455174" name="derby-4803-01-aa-simpleInsertSelect.diff" size="2357" author="rhillegas" created="Tue, 21 Sep 2010 19:58:00 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 16 Sep 2010 20:12:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24473</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0oqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37826</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>