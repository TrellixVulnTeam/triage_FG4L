<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-557/DERBY-557.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-557] Client driver gets OutOfMemoryError when re-executing statement without closing ResultSet</title>
                <link>https://issues.apache.org/jira/browse/DERBY-557</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When re-executing a statement without closing the old ResultSet, some of the old ResultSet&apos;s resources are not released, and the network client will eventually get an OutOfMemoryError.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;	Connection c = DriverManager.getConnection(&quot;jdbc:derby://localhost/mydb&quot;);&lt;br/&gt;
	PreparedStatement ps = c.prepareStatement(&quot;select * from sys.systables&quot;);&lt;br/&gt;
	while (true) &lt;/p&gt;
{
		ResultSet rs = ps.executeQuery();
	}

&lt;p&gt;This code will run for some time and then throw an OutOfMemoryError. Same thing happens with Statement instead of PreparedStatement. If rs.close() is added in the loop, the code works. Explicitly closing the ResultSet should not be necessary according to this quote from the JDBC 3.0 spec:&lt;/p&gt;

&lt;p&gt;  For Select statements, the statement is complete when the associated result set is closed. The result set is closed as soon as one of the following occurs:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;all of the rows have been retrieved&lt;/li&gt;
	&lt;li&gt;the associated Statement object is re-executed&lt;/li&gt;
	&lt;li&gt;another Statement object is executed on the same connection&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12314745">DERBY-557</key>
            <summary>Client driver gets OutOfMemoryError when re-executing statement without closing ResultSet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Sep 2005 01:31:52 +0100</created>
                <updated>Wed, 15 Feb 2006 22:11:44 +0000</updated>
                            <resolved>Wed, 15 Feb 2006 21:50:34 +0000</resolved>
                                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.1.2.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12322938" author="knutanders" created="Fri, 9 Sep 2005 01:39:46 +0100"  >&lt;p&gt;Quoting myself from derby-user:&lt;/p&gt;

&lt;p&gt;&amp;gt; FYI, I had a look in the client driver code. It seems like only&lt;br/&gt;
&amp;gt; markClosed() is called on the open ResultSets when a statement is&lt;br/&gt;
&amp;gt; re-executed. The difference between close() and markClosed() is&lt;br/&gt;
&amp;gt; basically that close() additionally checks whether it should&lt;br/&gt;
&amp;gt; auto-commit, nulls out the cursor and meta data, and calls&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;   connection_.CommitAndRollbackListeners_.remove(this);&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; Could this be our memory leak? Is there any situation where one&lt;br/&gt;
&amp;gt; shouldn&apos;t call close() on the result sets when re-executing?&lt;/p&gt;

&lt;p&gt;After I sent this mail, I ran a test with some println-statements in the client driver. When the OutOfMemoryError was thrown the CommitAndRollbackListeners_ list had around 17000 elements when using Statement, and around 300000 elements when using PreparedStatement.&lt;/p&gt;</comment>
                            <comment id="12323212" author="knutanders" created="Mon, 12 Sep 2005 19:44:02 +0100"  >&lt;p&gt;Attached a patch which fixes the bug. The patch ensures that the ResultSets associated with a Statement/PreparedStatement are removed from CommitAndRollbackListeners_ in org.apache.derby.client.am.Connection when the statement is re-executed.&lt;/p&gt;

&lt;p&gt;I have run derbyall with only one error (wrong length of encryption key, not related to the patch). I have also run the program in the problem description (both with Statement and PreparedStatement), and the memory usage doesn&apos;t increase over time.&lt;/p&gt;

&lt;p&gt;Could someone review this patch?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12329543" author="kmarsden" created="Fri, 16 Sep 2005 23:54:19 +0100"  >&lt;p&gt;Thanks Knut for the patch.&lt;br/&gt;
It looks good and I committed it to the trunk.  &lt;/p&gt;

&lt;p&gt;Date: Fri Sep 16 06:52:14 2005&lt;br/&gt;
New Revision: 289539&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewcvs?rev=289539&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs?rev=289539&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;A couple of questions though.&lt;/p&gt;

&lt;p&gt;1) What do you think about adding a test.?  The heap can be set  using jvmflags  in an app_properties  file as we do in tests/largedata&lt;/p&gt;

&lt;p&gt;2) Do you want this to go into the 10.1.2 release?  If so, you can just merge and test in your workspace and then post the svn merge command here and I&apos;ll port it to the branch. I think it would be a great to address some of these memory issues for 10.1.2.&lt;/p&gt;

</comment>
                            <comment id="12329549" author="knutanders" created="Sat, 17 Sep 2005 00:42:41 +0100"  >&lt;p&gt;Kathey,&lt;/p&gt;

&lt;p&gt;Thanks for committing. Answers to your questions follow.&lt;/p&gt;

&lt;p&gt;1) I could write a test like &quot;run this loop for x minutes and see if an OutOfMemoryError is thrown&quot;. With a small heap it would run out of memory fairly soon. Is this the kind of test you want? Where does such a test belong? derbylang? derby*mats?&lt;/p&gt;

&lt;p&gt;2) I merged the changes and tested with 10.1 earlier today. Didn&apos;t get OutOfMemoryError and derbyall ran successfully (except some encryption tests, as usual). Merge command: svn merge -r 289538:289539 trunk-directory 10.1-directory&lt;/p&gt;</comment>
                            <comment id="12329559" author="kmarsden" created="Sat, 17 Sep 2005 01:19:50 +0100"  >&lt;p&gt;That sounds fine to me for the test or just some large constant number of iterations.&lt;/p&gt;

&lt;p&gt;If you are adding a new test, I tend to think jdbcapi is a good place and something with a name generic enough  that we could put in a test for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-210&quot; title=&quot;Network Server will leak prepared statements if not explicitly closed by the user until the connection is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-210&quot;&gt;DERBY-210&lt;/a&gt;.    Alternately you could just change resultset.java to use a small heap if  this  doesn&apos;t add a huge amount of time to the test.  &lt;/p&gt;</comment>
                            <comment id="12331441" author="kmarsden" created="Thu, 6 Oct 2005 07:30:24 +0100"  >&lt;p&gt;Should I go ahead and port this to 10.1 or wait for the test?&lt;/p&gt;</comment>
                            <comment id="12331467" author="knutanders" created="Thu, 6 Oct 2005 16:33:00 +0100"  >&lt;p&gt;Kathey, I think you should just go ahead and port the fix to 10.1.&lt;/p&gt;

&lt;p&gt;Merge command:&lt;/p&gt;

&lt;p&gt;  svn merge -r 289538:289539 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have started working on a general check-that-resources-are-freed&lt;br/&gt;
test for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-23&quot; title=&quot;just booting jdbc driver and shutting down seem to leak memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-23&quot;&gt;&lt;del&gt;DERBY-23&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-210&quot; title=&quot;Network Server will leak prepared statements if not explicitly closed by the user until the connection is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-210&quot;&gt;DERBY-210&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-557&quot; title=&quot;Client driver gets OutOfMemoryError when re-executing statement without closing ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-557&quot;&gt;&lt;del&gt;DERBY-557&lt;/del&gt;&lt;/a&gt;, but while doing that I ran&lt;br/&gt;
into another resource leak (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-594&quot; title=&quot;Some rawStoreDaemon threads are not stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-594&quot;&gt;&lt;del&gt;DERBY-594&lt;/del&gt;&lt;/a&gt;) that I wanted to resolve first.&lt;/p&gt;</comment>
                            <comment id="12331559" author="knutanders" created="Fri, 7 Oct 2005 16:59:51 +0100"  >&lt;p&gt;Fixed in trunk (revision 289539) and 10.1 (revision 306950).&lt;/p&gt;</comment>
                            <comment id="12366039" author="knutanders" created="Sun, 12 Feb 2006 07:37:38 +0000"  >&lt;p&gt;Reopening to add regression test.&lt;/p&gt;</comment>
                            <comment id="12366042" author="knutanders" created="Sun, 12 Feb 2006 07:47:03 +0000"  >&lt;p&gt;Added a test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-557&quot; title=&quot;Client driver gets OutOfMemoryError when re-executing statement without closing ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-557&quot;&gt;&lt;del&gt;DERBY-557&lt;/del&gt;&lt;/a&gt; to jdbcapi/derbyStress.java. I have&lt;br/&gt;
verified that the test case fails without the fix.&lt;/p&gt;

&lt;p&gt;I had to enable the test for DerbyNetClient. Since the test case for&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-210&quot; title=&quot;Network Server will leak prepared statements if not explicitly closed by the user until the connection is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-210&quot;&gt;DERBY-210&lt;/a&gt; currently fails under DerbyNetClient, I disabled that test&lt;br/&gt;
case in the java code by adding this to prepStmtTest():&lt;/p&gt;

&lt;p&gt;  // Don&apos;t run under DerbyNetClient until &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-210&quot; title=&quot;Network Server will leak prepared statements if not explicitly closed by the user until the connection is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-210&quot;&gt;DERBY-210&lt;/a&gt; is fixed&lt;br/&gt;
  if (TestUtil.isDerbyNetClientFramework()) return;&lt;/p&gt;

&lt;p&gt;Derbyall ran cleanly.&lt;/p&gt;

&lt;p&gt;Could someone please review?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12366046" author="bryanpendleton" created="Sun, 12 Feb 2006 08:39:36 +0000"  >&lt;p&gt;This change looks good to me. The patch applies cleanly to the current trunk. I read through the test code and thought it was fine. With your patch applied, I ran&lt;/p&gt;

&lt;p&gt;java -Dframework=DerbyNetClient  -Dverbose=true org.apache.derbyTesting.functionTests.harness.RunTest jdbcapi/derbyStress.java&lt;/p&gt;

&lt;p&gt;and got the expected results (test passed, with the new print statement appearing in the output as expected).&lt;/p&gt;</comment>
                            <comment id="12366050" author="knutanders" created="Sun, 12 Feb 2006 09:11:27 +0000"  >&lt;p&gt;Whops! I forgot to close the connection in the regression test. Uploaded new patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-557&quot; title=&quot;Client driver gets OutOfMemoryError when re-executing statement without closing ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-557&quot;&gt;&lt;del&gt;DERBY-557&lt;/del&gt;&lt;/a&gt;-regression-test-v2.diff) with conn.close() added. I apologize the noise.&lt;/p&gt;</comment>
                            <comment id="12366457" author="knutanders" created="Wed, 15 Feb 2006 18:49:13 +0000"  >&lt;p&gt;Uploading new diff because of conflict with a recent commit.&lt;/p&gt;</comment>
                            <comment id="12366474" author="bernt" created="Wed, 15 Feb 2006 21:50:34 +0000"  >&lt;p&gt;Committed revision 377998.&lt;/p&gt;</comment>
                            <comment id="12366477" author="knutanders" created="Wed, 15 Feb 2006 22:11:44 +0000"  >&lt;p&gt;Regression test checked into revision 377998.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12322882" name="DERBY-557-regression-test-v2.diff" size="3048" author="knutanders" created="Sun, 12 Feb 2006 09:11:27 +0000"/>
                            <attachment id="12322988" name="DERBY-557-regression-test-v3.diff" size="3206" author="knutanders" created="Wed, 15 Feb 2006 18:49:12 +0000"/>
                            <attachment id="12322879" name="DERBY-557-regression-test.diff" size="3031" author="knutanders" created="Sun, 12 Feb 2006 07:47:03 +0000"/>
                            <attachment id="12322880" name="DERBY-557-regression-test.stat" size="258" author="knutanders" created="Sun, 12 Feb 2006 07:47:03 +0000"/>
                            <attachment id="12312832" name="DERBY-557.diff" size="4298" author="knutanders" created="Mon, 12 Sep 2005 19:44:02 +0100"/>
                            <attachment id="12312833" name="DERBY-557.stat" size="191" author="knutanders" created="Mon, 12 Sep 2005 19:44:02 +0100"/>
                            <attachment id="12312834" name="derbyall_report.txt" size="16207" author="knutanders" created="Mon, 12 Sep 2005 19:44:02 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 16 Sep 2005 22:54:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22014</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy175j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40809</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>