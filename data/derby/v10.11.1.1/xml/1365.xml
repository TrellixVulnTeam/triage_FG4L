<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:24:43 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1365/DERBY-1365.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1365] Address potential problems with optimizer logic in some rarely-exercised code.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1365</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;While looking at the optimization code in Derby for some other work I&apos;m doing, I&apos;ve noticed a couple of small pieces of code that could potentially lead to failures for some queries.  Thus far I have been unable to come up with any examples to demonstrate these problems with the current codeline (hence the term &quot;potential&quot; problems) because the relevant lines of code are hard to exercise-&lt;del&gt;they require large, complex databases and/or some tricky timing scenarios that I have thus far been unable to produce in the context of the test harness.  And in fact, a look at the code coverage results for the pieces of code shows that neither is actually exercised by the current derbyall suite&lt;/del&gt;-which I believe is more indicative of how hard it is to exercise the code in question than it is of incomplete/lacking tests.&lt;/p&gt;

&lt;p&gt;All of that said, analysis of the relevant code does indeed seem to indicate that some (minor) changes are in order.  In particular, consider the following two potential problems.&lt;/p&gt;

&lt;p&gt;1) Potential logic error when determining the best join order for a subquery that has more than one FROM table.&lt;/p&gt;

&lt;p&gt;This particular issue is very timing-sensitive.  It will only occur if there is an outer query which has a subquery and the optimization phase of the subquery &quot;times out&quot; in the middle of costing a join order.  The relevant point in the code can be found in OptimizerImpl.java, around line 420:&lt;/p&gt;

&lt;p&gt;    if (permuteState != JUMPING)&lt;/p&gt;
    {
        // By setting firstLookOrder to our target join order
        // and then setting our permuteState to JUMPING, we&apos;ll
        // jump to the target join order and get the cost.  That
        // cost will then be saved as bestCost, allowing us to
        // proceed with normal timeout logic.
        for (int i = 0; i &amp;lt; numOptimizables; i++)
            firstLookOrder[i] = bestJoinOrder[i];
        permuteState = JUMPING;

        // If we were in the middle of a join order when this
        // happened, then reset the join order before jumping.
        if (joinPosition &amp;gt; 0)
            rewindJoinOrder();
    }

&lt;p&gt;The problem occurs at the last part of this &quot;if&quot; block, with the call to rewind the join order.  The rewindJoinOrder() method will &quot;pull&quot; each optimizable that has an assigned position in the current join order and, for each one, decrement joinPosition--until all optimizables have been pulled and joinPosition has a value of &quot;0&quot;.  So far so good.&lt;/p&gt;

&lt;p&gt;The trick is that, unlike the other calls to rewindJoinOrder() in OptimizerImpl, this particular call occurs &lt;b&gt;before&lt;/b&gt; the joinPosition variable is incremented (it&apos;s incremented every time a call to find the &quot;next permutation&quot; is made, until all optimizables (FROM tables) have been assigned a position in the join order).  What this means is that, with the code as it currently stands, the call to rewindJoinOrder() will put joinPosition at 0, but shortly thereafter joinPosition will be incremented to &quot;1&quot;.  The subsequent search for a &quot;next permutation&quot; will then try to place an optimizable at position 1 in the join order-&lt;del&gt;but since there would be no optimizable at position 0 (we would have inadvertently skipped over it because of the increment after rewinding), the logic for finding/setting the next optimizable in the join order would break down.  So I think this needs to be addressed&lt;/del&gt;-and it should be as simple as setting joinPosition to -1 after the aforementioned call to rewindJoinOrder().  This -1 value is what joinPosition is set to before each round of optimization, so there is a precedent and, I believe, that is the right thing to do.  Once that&apos;s done all of the existing logic will work as normal.&lt;/p&gt;

&lt;p&gt;2) Potential NullPointerException if optimizer comes up with unreasonably high cost estimates (esp. Double.POSITIVE_INFINITY) and then, at execution time, Derby tries to do a hash join based on such an estimate with a ResultSet that has no rows.&lt;/p&gt;

&lt;p&gt;In this case, the code in question is in the constructor logic for BackingStoreHashtable.java.  In cases where the backing hash table receives an unreasonably high cost estimate (a &quot;red flag&quot; estimate as noted in the comments), it&apos;s possible that, for cases where the row_source field of the object is null or has no rows (which indicates an empty result set), the hash_table field will end up being null when we reach the end of the constructor.  But if we create a BackingStoreHashtable with a null hash_table, then any calls to the BackingStoreHashtable&apos;s methods that expect a valid (non-null) hash_table could fail with an NPE.  Thus there should be some additional logic to ensure that, upon completion of the constructor code, hash_table has been initialized to some appropriate non-null value--namely, an empy hash table if there are no rows to process.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12343799">DERBY-1365</key>
            <summary>Address potential problems with optimizer logic in some rarely-exercised code.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Jun 2006 00:10:29 +0100</created>
                <updated>Mon, 29 Jun 2009 15:33:33 +0100</updated>
                            <resolved>Wed, 7 Jun 2006 23:22:56 +0100</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.1.3.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12414252" author="army" created="Fri, 2 Jun 2006 00:16:55 +0100"  >&lt;p&gt;Attaching a patch (d1365_v1.patch) for the two problems described in this issue.  The changes are pretty minor and are, I believe, suitably described by the description of the problems above and by the comments in the patch.&lt;/p&gt;

&lt;p&gt;In addition to fixing the two issues described, the patch also resolves another potential problem: there are several places in OptimizerImpl.getNextPermutation() where calls to rewindJoinOrder() are made.  These calls typically indicate that the optimizer has decided to abandon or &quot;short circuit&quot; a join order before calculating the full cost.  For some of these calls-&lt;del&gt;esp. the ones that can occur in the middle of the join order (as opposed to those which will only occur on a complete join order)&lt;/del&gt;-the &quot;rewind&quot; operation needs to make sure to reload the best plans for the optimizables that are pulled as part of the &quot;rewind&quot; process.  Otherwise Derby could end up generating a plan for an optimizable even though that plan was part of a join order that was &quot;abandoned&quot; (i.e. rewound in the middle), which is logically incorrect and could lead to sub-optimal performance.  I&apos;ve included changes for this issue as part of d1365_v1.patch.&lt;/p&gt;

&lt;p&gt;I ran derbyall on Red Hat Linux with d1365_v1.patch applied and saw no new failures.  I would appreciate reviews/comments/commit if anyone has the time...&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12415035" author="army" created="Wed, 7 Jun 2006 04:28:34 +0100"  >&lt;p&gt;Marking fix-in as 10.2 &lt;b&gt;and&lt;/b&gt; 10.1.3, which is where I&apos;m hoping to see this patch checked in.  But so far it hasn&apos;t been committed to either...anyone out there have time for a review/commit?  I&apos;d appreciate it...&lt;/p&gt;</comment>
                            <comment id="12415056" author="bandaram" created="Wed, 7 Jun 2006 05:49:30 +0100"  >&lt;p&gt;Submitted this patch to trunk and 10.1 branches. Thanks Army.&lt;/p&gt;</comment>
                            <comment id="12415153" author="army" created="Wed, 7 Jun 2006 23:22:55 +0100"  >&lt;p&gt;Patch checked into 10.1 with svn # 412218 and into trunk with svn # 412222.  I have verified by inspection that the change is in both codelines and that there were no new failures in the nightly tests.  So I&apos;m resolving and closing this issue.&lt;/p&gt;

&lt;p&gt;Thanks for committing, Satheesh.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12334895" name="d1365_v1.patch" size="4353" author="army" created="Fri, 2 Jun 2006 00:16:55 +0100"/>
                            <attachment id="12334896" name="d1365_v1.stat" size="223" author="army" created="Fri, 2 Jun 2006 00:16:55 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 7 Jun 2006 04:49:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22463</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0win:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39086</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>