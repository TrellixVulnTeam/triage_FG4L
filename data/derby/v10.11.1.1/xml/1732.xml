<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:50:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1732/DERBY-1732.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1732] The language and store systems treat a JVM error such as OutOfMemoryError differently leading to the raw store protocol violation errors</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1732</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Don&apos;t have the exact details, but remember noticing it a while ago. I think the store transaction context closes the transaction on such an error, while the language conneciton context just rollsback the transaction or the statement. I think the best and consistent approach would be to close the connection.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12348278">DERBY-1732</key>
            <summary>The language and store systems treat a JVM error such as OutOfMemoryError differently leading to the raw store protocol violation errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="skambha">Sunitha Kambhampati</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Sat, 19 Aug 2006 19:55:15 +0100</created>
                <updated>Thu, 14 Dec 2006 01:31:43 +0000</updated>
                            <resolved>Thu, 14 Dec 2006 01:31:44 +0000</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12438457" author="skambha" created="Thu, 28 Sep 2006 15:53:53 +0100"  >&lt;p&gt;Notes:&lt;br/&gt;
On a JVM error, the cleanup at the store layer treats it as a session_severity error &amp;#8211; &lt;br/&gt;
see RAMTransactionContext.cleanupOnError(), XactContext.cleanupOnError().&lt;br/&gt;
the transaction is aborted,destroyed, transaction context is pop&apos;d from the context stack.&lt;/p&gt;

&lt;p&gt;At the language side however:&lt;br/&gt;
GenericStatementContext (SC) will treat a java error to be similar to STATEMENT_SEVERITY.&lt;br/&gt;
GenericLanguageConnectionContex (LCC) will treat a java error to be of TRANSACTION_SEVERITY.&lt;/p&gt;

&lt;p&gt;If an exception occurs, the contextManager.cleanupOnError is called to ensure corrective action can be taken. The context manager will unwind the contexts during cleanup in the reverse order they were placed in the global stack.  &lt;/p&gt;

&lt;p&gt;In ContextManager.cleanupOnError(), &lt;br/&gt;
&amp;#8211; A non StandardException (a jvm error) gets mapped to NO_APPLICABLE_SEVERITY here:&lt;br/&gt;
			int errorSeverity = error instanceof StandardException ?&lt;br/&gt;
				((StandardException) error).getSeverity() :&lt;br/&gt;
				ExceptionSeverity.NO_APPLICABLE_SEVERITY;&lt;/p&gt;

&lt;p&gt;&amp;#8211; Next, we walk down the stack calling cleanup on each context as long as if we reached the lastHandler or if we have reached end of stack. &lt;/p&gt;

&lt;p&gt;So if a given context is the last handler for an error of some severity, then we stop there and do not call cleanup on the context&apos;s below it.&lt;/p&gt;

&lt;p&gt;The derby1707 repro debugging shows that in this case  - at prepare time for the statement, a NPE is thrown from GenericStatement.prepMinion. In the context stack,store contexts are first cleaned up and then the SC cleanup is called. Note: LCC is below in the stack and LCC cleanup does not get called since the SC.isLastHandler returns true.&lt;/p&gt;

&lt;p&gt;Issue:&lt;br/&gt;
&amp;#8211; isLastHandler for GenericStatement is not right. JVM errors severity gets mapped to NO_APPLICABLE_SEVERITY in &lt;br/&gt;
ContextManager.cleanupOnError().  Thus on cleanup, for JVM error SC.isLastHandler can return true for some cases(when rollbackParentContext is false, and inUse is true).  This is incorrect because for JVM errors, it is necessary to let the outer contexts know and take necessary corrective action.&lt;/p&gt;


&lt;p&gt;This patch makes the following changes:&lt;br/&gt;
1. Make change to GenericStatementContext.isLastHandler() so it will return false for JVM errors thus allowing the outer contexts to take corrective action.&lt;br/&gt;
2. Store transaction context treats JVM errors as session severity. To ensure consistency, map severity for non StandardException instances to be SESSION_SEVERITY in GenericLanguageContext, and GenericStatementContext. &lt;/p&gt;

&lt;p&gt;There is an existing &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1528&quot; title=&quot;Preparing &amp;quot;INSERT INTO table SELECT FROM (...)&amp;quot; may cause NullPointerException and subsequent internal errors reported by RawStore module&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1528&quot;&gt;DERBY-1528&lt;/a&gt; which also results in a npe and then the raw store protocol violation error. With this change, if you run the repro (repro1528_npe), instead of a raw store protocol violation error, you will get a java.sql.SQLException &apos;No current exception&apos;&lt;/p&gt;

&lt;p&gt;Ran derbyall on ibm142/linux ok with 2 expected failures unrelated to this change. (NSInSameJVM and blobclob4BLOB)&lt;/p&gt;

&lt;p&gt;I have been using the derby1707 repro without the fix for this jira for testing purposes.  Are there any suggestions on how best to add a test for this case. One way is to simulate a java error using debug flags but I dont like that approach.  Suggestions welcome.  I can make the yet-to-be-fixed derby1528 repro as a test,but that will no longer test this fix when we eventually fix derby-1528.&lt;/p&gt;

&lt;p&gt;Please take a look at this patch. I am new to this area, so would appreciate more eyes on this patch.  Thanks.&lt;/p&gt;</comment>
                            <comment id="12438464" author="djd" created="Thu, 28 Sep 2006 16:27:42 +0100"  >&lt;p&gt;Patch looks good, I don&apos;t think there needs to be a test here. If the code had been correct in the first place there would never have been a test case because it is not functionality that is being developed.&lt;/p&gt;</comment>
                            <comment id="12440271" author="djd" created="Thu, 5 Oct 2006 22:40:44 +0100"  >&lt;p&gt;Patch  Committed revision 453395 - Thanks Sunitha.&lt;/p&gt;</comment>
                            <comment id="12440583" author="skambha" created="Fri, 6 Oct 2006 19:55:39 +0100"  >&lt;p&gt;Verified fix in trunk.   Thanks Dan for the review and commit. &lt;/p&gt;</comment>
                            <comment id="12453938" author="rhillegas" created="Tue, 28 Nov 2006 14:59:10 +0000"  >&lt;p&gt;Re-opening to record porting to 10.2 branch&lt;/p&gt;</comment>
                            <comment id="12453939" author="rhillegas" created="Tue, 28 Nov 2006 15:00:11 +0000"  >&lt;p&gt;Ported to 10.2 branch at subversion revision 480074.&lt;/p&gt;</comment>
                            <comment id="12458337" author="skambha" created="Thu, 14 Dec 2006 01:31:22 +0000"  >&lt;p&gt;Reopen to correct the assign to field.   &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12341900" name="derby1732.diff.txt" size="2804" author="skambha" created="Thu, 28 Sep 2006 15:53:53 +0100"/>
                            <attachment id="12341901" name="derby1732.stat.txt" size="169" author="skambha" created="Thu, 28 Sep 2006 15:53:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 28 Sep 2006 14:53:53 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22673</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy13rj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40260</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>