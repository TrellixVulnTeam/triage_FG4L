<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:37:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4128/DERBY-4128.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4128] Failure in ServerPropertiesTest due to java.security.AccessControlException on the server side, in 10.4 to 10.5.1. soft upgrade mode</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4128</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Soft upgrade from 10.4.2.0 to 10.5.1.0 (RC1).&lt;/p&gt;

&lt;p&gt;This test fails when run under suites.All as well as by itself.&lt;/p&gt;

&lt;p&gt;Steps to reproduce&lt;br/&gt;
---------------------------&lt;br/&gt;
Steps followed are as follows.&lt;br/&gt;
1. Run setEmbeddedCP.bat from version 10.4.2.0&apos;s bin folder&lt;br/&gt;
2. In a test folder run ij&lt;br/&gt;
3. create system/wombat database.&lt;br/&gt;
     ij&amp;gt; connect &apos;jdbc:derby:system/wombat;create=true&apos;;&lt;br/&gt;
4. exit ij&lt;br/&gt;
5. Copy the 10.5.1.0 derby jars (from lib folder) and the derbyTesting.jar from 10.4.2.0 to the test folder and set classpath with them (including junit and ORO)&lt;br/&gt;
6. Run test&lt;br/&gt;
      java -Xmx512M -Xms512M -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.derbynet.ServerPropertiesTest&lt;br/&gt;
-------------------------------&lt;/p&gt;


&lt;p&gt;The test failure stack trace is&lt;br/&gt;
---------------------------------------&lt;br/&gt;
testToggleTrace(org.apache.derbyTesting.functionTests.tests.derbynet.ServerPropertiesTest)junit.framework.AssertionFailedError: expected:&amp;lt;0&amp;gt; but was:&amp;lt;1&amp;gt;&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.assertExecJavaCmdAsExpected(BaseTestCase.java:505)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.derbynet.ServerPropertiesTest.assertSuccessfulCmd(ServerPropertiesTest.java:389)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.derbynet.ServerPropertiesTest.testToggleTrace(ServerPropertiesTest.java:586)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:102)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;/p&gt;


&lt;p&gt;The Server&apos;s log shows this exception.&lt;br/&gt;
----------------------------------------------------&lt;br/&gt;
2009-03-27 19:13:54.754 GMT : Apache Derby Network Server - 10.5.1.0 - (757599) started and ready to accept connections on port 1527&lt;br/&gt;
2009-03-27 19:13:55.475 GMT : access denied (java.io.FilePermission D:\projects\derby-testing\test-10.4-3\system read)&lt;br/&gt;
java.security.AccessControlException: access denied (java.io.FilePermission D:\projects\derby-testing\test-10.4-3\system read)&lt;br/&gt;
	at java.security.AccessControlContext.checkPermission(AccessControlContext.java:323)&lt;br/&gt;
	at java.security.AccessController.checkPermission(AccessController.java:546)&lt;br/&gt;
	at java.lang.SecurityManager.checkPermission(SecurityManager.java:532)&lt;br/&gt;
	at java.lang.SecurityManager.checkRead(SecurityManager.java:871)&lt;br/&gt;
	at java.io.File.exists(File.java:731)&lt;br/&gt;
	at java.io.File.mkdirs(File.java:1181)&lt;br/&gt;
	at org.apache.derby.impl.drda.DssTrace$1.run(Unknown Source)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at org.apache.derby.impl.drda.DssTrace.startComBufferTrace(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.Session.initTrace(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.Session.setTraceOn(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.NetworkServerControlImpl.setTrace(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.NetworkServerControlImpl.processCommands(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.sessionInitialState(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;/p&gt;






</description>
                <environment>Windows Vista 64, Sun JDK 1.6.0_10, Junit 3.8.2</environment>
        <key id="12419675">DERBY-4128</key>
            <summary>Failure in ServerPropertiesTest due to java.security.AccessControlException on the server side, in 10.4 to 10.5.1. soft upgrade mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="suranjay">Suran Jayathilaka</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Mar 2009 19:56:31 +0000</created>
                <updated>Fri, 21 Jan 2011 17:52:20 +0000</updated>
                            <resolved>Fri, 10 Apr 2009 19:01:48 +0100</resolved>
                                                    <fixVersion>10.5.1.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12690025" author="suranjay" created="Fri, 27 Mar 2009 19:58:26 +0000"  >&lt;p&gt;Linking as the issues might be related. &lt;/p&gt;</comment>
                            <comment id="12690026" author="kmarsden" created="Fri, 27 Mar 2009 20:02:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3701&quot; title=&quot;java.lang.Exception: DRDA_UnableToAccept.S:Unable to accept connections and client hang if tracing is turned on but traceDirectory does not exist&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3701&quot;&gt;&lt;del&gt;DERBY-3701&lt;/del&gt;&lt;/a&gt;  had a different fix for 10.5 than the older branches.    In 10.5 it attempts to create the trace directory if it doesn&apos;t exist. I am not sure yet, whether it requires a code change, default policy change, or just needs a 10.5 specific release note.  I will investigate.&lt;/p&gt;</comment>
                            <comment id="12694221" author="kmarsden" created="Tue, 31 Mar 2009 20:23:39 +0100"  >&lt;p&gt;I think there is a real bug here. It seems to be trying to make the directory even when the trace directory is not specified and we need to put the trace file in the default directory.  That is not correct. I don&apos;t think it is a show stopper for the release, but it sure would be nice to get it fixed, so as not to regress the product. I will post when I have a fix.&lt;/p&gt;
</comment>
                            <comment id="12694321" author="kmarsden" created="Wed, 1 Apr 2009 00:27:29 +0100"  >&lt;p&gt;I discovered that the change to the policy file and addition of the new permission  requirement  came later than &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3701&quot; title=&quot;java.lang.Exception: DRDA_UnableToAccept.S:Unable to accept connections and client hang if tracing is turned on but traceDirectory does not exist&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3701&quot;&gt;&lt;del&gt;DERBY-3701&lt;/del&gt;&lt;/a&gt;, with the removal of the PrivilegedFileOps class in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2556&quot; title=&quot;Code paths for db restore do not use doPrivileged-calls, causing SecurityException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2556&quot;&gt;&lt;del&gt;DERBY-2556&lt;/del&gt;&lt;/a&gt; (svn 691576) .  I am not sure yet why that change made the new permission necessary or more specifically why it wasn&apos;t necessary with just the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3701&quot; title=&quot;java.lang.Exception: DRDA_UnableToAccept.S:Unable to accept connections and client hang if tracing is turned on but traceDirectory does not exist&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3701&quot;&gt;&lt;del&gt;DERBY-3701&lt;/del&gt;&lt;/a&gt; change.  Looking ...&lt;/p&gt;
</comment>
                            <comment id="12694619" author="kmarsden" created="Wed, 1 Apr 2009 18:02:06 +0100"  >&lt;p&gt;The reason for the permission change in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2556&quot; title=&quot;Code paths for db restore do not use doPrivileged-calls, causing SecurityException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2556&quot;&gt;&lt;del&gt;DERBY-2556&lt;/del&gt;&lt;/a&gt; was because the mkdirs logic moved from derby.jar to derbynet.jar, so derbynet.jar now needed the permissions.  Still, we shouldn&apos;t require the permission if the trace is in the default location which already exists, so I will look at fixing that under this issue.&lt;/p&gt;

</comment>
                            <comment id="12696613" author="kmarsden" created="Tue, 7 Apr 2009 17:41:37 +0100"  >&lt;p&gt;Well, I can fix it so that it won&apos;t need read permission, just write permission if the trace directory is in user.dir or derby.system.home, because we know they exists,  but for other directories, even if they exist, we will have to add the requirement that the user grant read as well as write permission to the trace directory to derbynet.jar.&lt;/p&gt;

&lt;p&gt;Is this acceptable, or should I just revert back to the old behavior where it only needs write permission and will  just fail if the directory does not exist?  The downside is that the user will have to create the trace directory themselves instead of Derby doing it for them.&lt;/p&gt;

</comment>
                            <comment id="12696646" author="myrna" created="Tue, 7 Apr 2009 18:43:54 +0100"  >&lt;p&gt;If I understand correctly, we&apos;re talking about a bit of an edge case - the case where a user has got traceDirectory set, the directory exists, they&apos;ve got read and write permissions for derby.jar to the directory, but they&apos;ve got write, but not read permissions in the policy file for derbynet.jar to the directory?&lt;/p&gt;

&lt;p&gt;I think it would be acceptable to introduce the incompatibility of requiring the users to modify the policy files...It will only be for as long as they have traceDirectory on, which you probably wouldn&apos;t do for a production environment.&lt;br/&gt;
I think forcing a user to create the trace directory is a bigger incompatibility.&lt;/p&gt;

&lt;p&gt;But, do you need read permission to create a directory? Or would that overwrite what&apos;s in the directory if it exists?&lt;/p&gt;</comment>
                            <comment id="12696959" author="knutanders" created="Wed, 8 Apr 2009 10:12:37 +0100"  >&lt;p&gt;Does the attached patch d4128.diff help on this problem? It attempts to create the directory with mkdir() first, and only if that doesn&apos;t work, it attempts mkdirs(). Since mkdir() doesn&apos;t require read permission, it will work without read permission if the parent directory already exists, and it will still create the directory if the parent directory doesn&apos;t exist and the required read permission has been granted.&lt;/p&gt;</comment>
                            <comment id="12696960" author="knutanders" created="Wed, 8 Apr 2009 10:15:00 +0100"  >&lt;p&gt;By the way, that was the same approach we ended up with in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2673&quot; title=&quot;If derby.system.home does not exist Derby should only attempt to create that specific folder, not any missing parents (ie. use File.mkdir(), not File.mkdirs())&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2673&quot;&gt;&lt;del&gt;DERBY-2673&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12697039" author="knutanders" created="Wed, 8 Apr 2009 15:39:22 +0100"  >&lt;p&gt;My patch broke NetworkServerControlApiTest, GetCurrentPropertiesTest and SecureServerTest, so that&apos;s apparently &lt;b&gt;not&lt;/b&gt; the way to fix it...&lt;/p&gt;</comment>
                            <comment id="12697051" author="kmarsden" created="Wed, 8 Apr 2009 16:12:34 +0100"  >&lt;p&gt;I think it might be part of the solution though.  I think the problem is that mkdir() will return false if the directory already exists, so we  proceed to the mkdirs() call.&lt;/p&gt;

&lt;p&gt;This morning it occurred to me that maybe we can use File.canWrite() to determine if the trace directory exists and is writable without needing read permission and then  only if that returns false try the mkdir/mkdirs().&lt;/p&gt;

&lt;p&gt;I&apos;ll try that.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12697121" author="kmarsden" created="Wed, 8 Apr 2009 18:53:09 +0100"  >&lt;p&gt;Nope using traceDirectory.canWrite() won&apos;t work either because it still  requires a new permission if the directory already existed.    I think the only way to do this without creating a need for a new permission is to try to make the trace file and then if that fails, try to make the directory.  I will try that next.&lt;/p&gt;</comment>
                            <comment id="12697255" author="kmarsden" created="Wed, 8 Apr 2009 23:35:05 +0100"  >&lt;p&gt;ok. Here I think is a trunk patch which has the minimal required permissions (derby-4128_kmarsden_diff.txt)  If the trace directory already exists, it still only requires write permission on the contents of the directory.  The patch attempts to make the trace file and if that fails on the first try with a FileNotFoundException, it will attempt to make the directory and try again.&lt;/p&gt;

&lt;p&gt;SystemPropertiesTest and NetworkServerControlApiTest pass with the 10.4.2.0 derbyTesting.jar.  Running trunk tests now.&lt;/p&gt;

&lt;p&gt;We need to document that tracing will now attempt to create the directory and the permissions needed to do that. I will open an issue for that, but I don&apos;t see that it will cause any regression or require a release note, because turning on tracing where the directory did not exist would always fail before 10.5.&lt;/p&gt;
</comment>
                            <comment id="12697601" author="kmarsden" created="Thu, 9 Apr 2009 19:54:36 +0100"  >&lt;p&gt;Regression tests passed.  Please review.  I tried to do a soft upgrade run on trunk, but that doesn&apos;t seem to be possible without the upgrade logic in yet. I did run the 10.4.2.0 tests against 10.5 and saw no permissions related issues and 10.4.2.0  ServerPropertiesTest and NetworkServerControlApiTest now pass when run against 10.5.&lt;/p&gt;
</comment>
                            <comment id="12697838" author="kmarsden" created="Fri, 10 Apr 2009 16:29:42 +0100"  >&lt;p&gt;I noticed an issue with the patch I checked in yesterday for this issue. With the patch, we would not break out of the loop if we successfully created the trace file on the first try, so would create it a second time.  I will commit the attached patch (derby-4128_part2_diff.txt)  after running tests to correct that problem.&lt;/p&gt;</comment>
                            <comment id="12697890" author="kmarsden" created="Fri, 10 Apr 2009 19:01:46 +0100"  >&lt;p&gt;Checked in fix to trunk and 10.5 branch. Thank  you Suran for finding this issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12422418">DERBY-4153</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12397290">DERBY-3701</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12404938" name="d4128.diff" size="1626" author="knutanders" created="Wed, 8 Apr 2009 10:07:05 +0100"/>
                            <attachment id="12405017" name="derby-4128_kmarsden_diff.txt" size="8440" author="kmarsden" created="Wed, 8 Apr 2009 23:35:04 +0100"/>
                            <attachment id="12405161" name="derby-4128_part2_diff.txt" size="807" author="kmarsden" created="Fri, 10 Apr 2009 16:29:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 27 Mar 2009 20:02:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24044</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0l53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37243</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>