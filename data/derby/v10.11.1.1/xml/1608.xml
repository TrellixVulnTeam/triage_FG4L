<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:14:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1608/DERBY-1608.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1608] Execution of builtin functions by a user who is not the owner of system schemas gives NPE when authentication and SQL authorization are on.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1608</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;1. Create a database in 10.1&lt;br/&gt;
2. Full upgrade to 10.2 - Booting using 10.2 jars by specifying &quot;upgrade=true&quot; in the connection URL.&lt;br/&gt;
3. Execute a function e.g: VALUES &lt;/p&gt;
{ fn ACOS(0.0707) }. This passes as expected.&lt;br/&gt;
4. Set database property derby.database.sqlAuthorization=true.&lt;br/&gt;
5. Shutdown and reconnect to database for the property to take effect.&lt;br/&gt;
6. Re-execute the function. This gives NPE.&lt;br/&gt;
&lt;br/&gt;
Repro using ij:&lt;br/&gt;
&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
Steps using 10.1 jar:&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
ij version 10.1&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:old_db;create=true&apos;;&lt;br/&gt;
ij&amp;gt; exit;&lt;br/&gt;
&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
Steps using 10.2 jar:&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
ij version 10.2&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:old_db;upgrade=true&apos;;&lt;br/&gt;
ij&amp;gt; VALUES { fn ACOS(0.0707) }
&lt;p&gt;;&lt;br/&gt;
1&lt;br/&gt;
----------------------&lt;br/&gt;
1.5000372950430991&lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
ij&amp;gt; call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&apos;derby.database.sqlAuthorization&apos;, &apos;true&apos;);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:old_db;shutdown=true&apos;;&lt;br/&gt;
ERROR 08006: Database &apos;old_db&apos; shutdown.&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:old_db&apos;;&lt;br/&gt;
ij(CONNECTION1)&amp;gt; VALUES &lt;/p&gt;
{ fn ACOS(0.0707) }
&lt;p&gt;;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
ij(CONNECTION1)&amp;gt;&lt;/p&gt;

&lt;p&gt;--------------------------------------------------------------------------------&lt;br/&gt;
Stack trace of failure:&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.RoutinePermsDescriptor.&amp;lt;init&amp;gt;(RoutinePermsDescriptor&lt;br/&gt;
.java:54)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.RoutinePermsDescriptor.&amp;lt;init&amp;gt;(RoutinePermsDescriptor&lt;br/&gt;
.java:62)&lt;br/&gt;
        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getRoutinePermissions(DataDictionary&lt;br/&gt;
Impl.java:9902)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.StatementRoutinePermission.check(StatementRoutinePer&lt;br/&gt;
mission.java:55)&lt;br/&gt;
        at org.apache.derby.impl.sql.conn.GenericAuthorizer.authorize(GenericAuthorizer.java:157)&lt;br/&gt;
        at org.apache.derby.exe.ac6b91c056x010cxb687x3eb7x00000012d1c00.fillResultSet(Unknown Source&lt;br/&gt;
)&lt;br/&gt;
        at org.apache.derby.exe.ac6b91c056x010cxb687x3eb7x00000012d1c00.execute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:32&lt;br/&gt;
6)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:&lt;br/&gt;
355)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1181)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:584)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:516)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:312)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:207)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:173)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:60)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12346863">DERBY-1608</key>
            <summary>Execution of builtin functions by a user who is not the owner of system schemas gives NPE when authentication and SQL authorization are on.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bandaram">Satheesh Bandaram</assignee>
                                    <reporter username="deepa">Deepa Remesh</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Jul 2006 20:23:57 +0100</created>
                <updated>Tue, 1 Aug 2006 16:42:20 +0100</updated>
                            <resolved>Tue, 1 Aug 2006 07:15:17 +0100</resolved>
                                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12424204" author="deepa" created="Sat, 29 Jul 2006 00:06:04 +0100"  >&lt;p&gt;This problem is not related to upgrade. This was noticed in the upgraded database because of a known issue in upgrade (the owner of system schemas is not changed from &quot;DBA&quot; to the user invoking upgrade)&lt;/p&gt;

&lt;p&gt;Earlier, I could not repro it with a new database in 10.2 as I was trying only as default user. Looking at the code, it seemed that this could also happen in a new 10.2 database. I could repro this when I turned authentication on and tried executing a builtin function as a user who is not the owner of system schemas. To repro in 10.2: &lt;/p&gt;

&lt;p&gt;1)  Start ij with following in derby.properties file: &lt;/p&gt;

&lt;p&gt;derby.connection.requireAuthentication=true&lt;br/&gt;
derby.database.sqlAuthorization=true&lt;/p&gt;

&lt;p&gt;derby.user.creator=pswd&lt;br/&gt;
derby.user.deepa=pswd&lt;/p&gt;

&lt;p&gt;2) In ij, run the following commands:&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:newdb;create=true;user=creator;password=pswd&apos;;&lt;br/&gt;
ij&amp;gt; VALUES &lt;/p&gt;
{ fn ACOS(0.0707) };&lt;br/&gt;
1&lt;br/&gt;
----------------------&lt;br/&gt;
1.5000372950430991&lt;br/&gt;
&lt;br/&gt;
1 row selected&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:newdb;user=deepa;password=pswd&apos;;&lt;br/&gt;
ij(CONNECTION1)&amp;gt; VALUES { fn ACOS(0.0707) }
&lt;p&gt;;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
ij(CONNECTION1)&amp;gt; exit;&lt;/p&gt;

&lt;p&gt;In general, NPE is thrown whenever we try to execute a builtin function as a user who is not the owner of the system schemas.  &lt;/p&gt;</comment>
                            <comment id="12424333" author="bandaram" created="Sun, 30 Jul 2006 01:18:19 +0100"  >&lt;p&gt;I can fix this problem. Some of the newly added SYSFUN builtin functions don&apos;t exist in system catalogs but pretend to be routines during resolution process. Since these routines are builtin functions that don&apos;t need privilege checking, need to bypass creating StatementPermission objects for them. Currently SQL authorization mechanism is looking for routine descriptors to create StatementPermission and hence fails, as they don&apos;t really have aliasIDs.&lt;/p&gt;</comment>
                            <comment id="12424334" author="bandaram" created="Sun, 30 Jul 2006 01:20:52 +0100"  >&lt;p&gt;Deepa, I did not realize you had this defect assigned to you, until after I assigned it myself. If you want to fix it yourself, feel free to assign it back to yourself. Otherwise, I can take care of it. &lt;/p&gt;</comment>
                            <comment id="12424757" author="bandaram" created="Tue, 1 Aug 2006 07:15:16 +0100"  >&lt;p&gt;Submitted a fix to trunk and also added test cases.&lt;/p&gt;</comment>
                            <comment id="12424758" author="bandaram" created="Tue, 1 Aug 2006 07:18:00 +0100"  >&lt;p&gt;Deepa, I submitted a fix to trunk just now. If you can rerun your test and confirm the test passes now, can you either let me know or close this bug yourself? I think the submitter is supposed to close the bug after confirming, if possible, according to JIRA docs.&lt;/p&gt;</comment>
                            <comment id="12424904" author="deepa" created="Tue, 1 Aug 2006 16:42:20 +0100"  >&lt;p&gt;Verified fix by running the repros and the modified upgrade test. Thanks Satheesh.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 30 Jul 2006 00:18:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22596</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy1507:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40461</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>