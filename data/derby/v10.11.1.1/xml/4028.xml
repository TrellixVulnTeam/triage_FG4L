<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:07:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4028/DERBY-4028.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4028] two rows can be inserted with the same value in a column that a unique constraint on that column should prevent</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4028</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following DDL allows two rows to be inserted with the same value in a column when a unique constraint on that column should prevent it. The select statement (see the end of the mail) produces:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; ALBUMID             |RANK       |YEARRELEAS&amp;amp;|ALBUM&lt;/p&gt;

&lt;p&gt;--------------------------------------------------------------------------------&lt;br/&gt;
-----------------------------------------------------------------&lt;br/&gt;
11100               |1          |1945       |&lt;/p&gt;

&lt;p&gt;13300               |1          |1966       |&lt;/p&gt;

&lt;p&gt;2000                |7          |1974       |Songs in the Key of Life&lt;/p&gt;

&lt;p&gt;88000               |12         |1971       |&lt;/p&gt;


&lt;p&gt;4 rows selected&lt;/p&gt;

&lt;p&gt;The first two rows have the same rank value of 1 despite there being a unique constraint on that column.&lt;/p&gt;

&lt;p&gt;derby version: 10.4.1.3&lt;/p&gt;

&lt;p&gt;Bryan Pendleton reproduced this and suggested that the problem &quot;is related to the fairly new feature of Derby&lt;br/&gt;
which allows definition of a unique constraint on a null-able column&quot;.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3330&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-3330&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Redefining the rank column as &apos;not null&apos; made the problem go away.&lt;/p&gt;

&lt;p&gt;I came across this after running a program that randomly makes inserts, updates, and deletes into this table. It usually takes between 500-600 DDL statements to make it happen. I then took the results and hand-pruned out as many statements as I could and tried to minimize the number of rows produced by the select statement, while still reproducing the issue. At this point it is very sensitive to any changes. For example, re-running the test after removing what appear to be redundantly inserted rows will make the problem go away, as will modifications to band and album names. It&apos;s all very strange.&lt;/p&gt;

&lt;p&gt;A very old version of Cloudscape (3.6.9), from which I am trying to upgrade, does not have this problem.&lt;/p&gt;

&lt;p&gt;-------------------------------------------------------------------------&lt;br/&gt;
drop table tra;&lt;/p&gt;

&lt;p&gt;create table tra (&lt;br/&gt;
    albumId bigint,&lt;br/&gt;
    rank int,&lt;br/&gt;
    CONSTRAINT UNIQUE_RANK&lt;br/&gt;
        UNIQUE(rank),&lt;br/&gt;
    band varchar(100),&lt;br/&gt;
    album varchar(100),&lt;br/&gt;
    yearReleased int,&lt;br/&gt;
    CONSTRAINT PK_TOPROCKALBUMS&lt;br/&gt;
        PRIMARY KEY(albumId)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;insert into tra values(1000, 1, &apos;&apos;, &apos;&apos;, 1966);&lt;br/&gt;
insert into tra values(2000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(3000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(4000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(5000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(6000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(7000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(8000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(9000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(13000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(14000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(15000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(16000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(17000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(18000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(19000, 14, &apos;Joni &apos;, &apos;Blue&apos;, 1971);&lt;br/&gt;
insert into tra values(20000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(21000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(22000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(23000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(24000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(25000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(26000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(27000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(28000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(29000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(30000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(31000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(32000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(33000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(34000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(36000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(36000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(37000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(38000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(39000, 1, &apos;The Beatles&apos;, &apos;&apos;, 1966);&lt;br/&gt;
insert into tra values(40000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(41000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(42000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(43000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(44000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(45000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(46000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(47000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(48000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(49000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(50000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(51000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(52000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(53000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(54000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(55000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(56000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(57000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(59000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(60000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(61000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(62000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(63000, 1, &apos;The Beatles&apos;, &apos;&apos;, 1966);&lt;br/&gt;
delete from tra where rank=1;&lt;br/&gt;
insert into tra values(64000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(65000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(66000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(67000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(68000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(69000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(70000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(71000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(72000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(73000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(74000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(75000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(76000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(77000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(78000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(79000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
delete from tra where rank=14;&lt;br/&gt;
insert into tra values(80000, 14, &apos;Joni Mitchell&apos;, &apos;Blue&apos;, 1971);&lt;br/&gt;
insert into tra values(81000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(82000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(83000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(84000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(85000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(86000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(87000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(88000, 12, &apos;&apos;, &apos;&apos;, 1971);&lt;br/&gt;
insert into tra values(89000, 1, &apos;The Beatles&apos;, &apos;&apos;, 1966);&lt;br/&gt;
insert into tra values(90000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(91000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(92000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(93000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(94000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(95000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(96000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(97000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(98000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(99000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10100, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10200, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10300, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10400, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10500, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
delete from tra where rank=1;&lt;br/&gt;
insert into tra values(10600, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10700, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10800, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(10900, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11100, 1, &apos;The Beatles&apos;, &apos;&apos;, 1966);&lt;br/&gt;
insert into tra values(11200, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11300, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11400, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11500, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11600, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11700, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11800, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(11900, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12100, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12200, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
delete from tra where rank=14;&lt;br/&gt;
insert into tra values(12300, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12400, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
update tra set yearReleased=1945 where rank=1;&lt;br/&gt;
insert into tra values(12500, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12600, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12700, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12800, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(12900, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(13000, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(13100, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(13200, 7, &apos;Stevie Wonder&apos;, &apos;Songs in the Key of Life&apos;, 1974);&lt;br/&gt;
insert into tra values(13300, 1, &apos;The Beatles&apos;, &apos;&apos;, 1966);&lt;br/&gt;
select albumId, rank, yearReleased, album from tra order by rank;&lt;br/&gt;
exit;&lt;/p&gt;</description>
                <environment>Windows XP</environment>
        <key id="12413000">DERBY-4028</key>
            <summary>two rows can be inserted with the same value in a column that a unique constraint on that column should prevent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="gmbradford">Glenn Bradford</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Jan 2009 15:14:46 +0000</created>
                <updated>Fri, 21 Jan 2011 17:52:13 +0000</updated>
                            <resolved>Mon, 16 Mar 2009 12:53:13 +0000</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12666486" author="knutanders" created="Fri, 23 Jan 2009 11:25:16 +0000"  >&lt;p&gt;It seems like BTreeController.compareLeftAndRightSiblings() doesn&apos;t handle deleted records correctly. If it finds a committed deleted record with the same key, it thinks that it is OK to insert a new record with the same key. I guess this would have been an OK assumption in a unique index, but the UNIQUE constraint is backed by a non-unique index (because multiple NULLs are allowed), so if you find a deleted record you really need to move past that record and check again.&lt;/p&gt;</comment>
                            <comment id="12666530" author="knutanders" created="Fri, 23 Jan 2009 12:40:02 +0000"  >&lt;p&gt;The attached patch (check-deleted.diff) appears to fix the reported problem. What it does is:&lt;/p&gt;

&lt;p&gt;  1) Make BTreeController.compareRowsForInsert() return MATCH_FOUND even if the row is deleted, and say in its javadoc that callers should check if the row is deleted&lt;/p&gt;

&lt;p&gt;  2) Make BTreeController.comparePreviousRecord() and BTreeController.compareNextRecord() check if the found record is deleted, and if it is, move on to see if an existing record can be found&lt;/p&gt;

&lt;p&gt;  3) Make BTreeController.comparePreviousRecord() look at the record before the previous one instead of the record after the previous one if the previous doesn&apos;t match (probably a copy/paste error from compareNextRecord())&lt;/p&gt;

&lt;p&gt;I suspect that there may be other problems in comparePreviousRecord() and compareNextRecord(). At least it looks to me as if there are paths through those methods where we latch pages and never release them. I&apos;m not 100% convinced that the slot boundary checks are correct either, but I&apos;ll need to double check that.&lt;/p&gt;

&lt;p&gt;I haven&apos;t run any tests on the patch, except the script that reproduced the bug, and I&apos;m not sure if this is the correct way to fix it. But I&apos;m posting it in case someone else wants to investigate the bug.&lt;/p&gt;

&lt;p&gt;What I find strange, though, is that if I remove any of the failing inserts right before the insert that incorrectly succeeds, the insertion of the duplicate is correctly rejected. I thought that the rejected inserts shouldn&apos;t change anything in the B-tree, but apparently they do.&lt;/p&gt;</comment>
                            <comment id="12666550" author="bryanpendleton" created="Fri, 23 Jan 2009 14:42:58 +0000"  >&lt;p&gt;Perhaps the rejected insert causes an internal page split, and then discovers&lt;br/&gt;
the non-uniqueness. It then terminates the insert processing, but leaves&lt;br/&gt;
the split? &lt;/p&gt;

&lt;p&gt;Or, similar, perhaps the rejected insert causes a page allocation, and then&lt;br/&gt;
refuses the insert but leaves the page allocated?&lt;/p&gt;

&lt;p&gt;That is, maybe it&apos;s some sort of &quot;physical&quot; or &quot;structural&quot; change to the&lt;br/&gt;
BTree that doesn&apos;t &quot;logically&quot; change the content of the Btree, so when we&lt;br/&gt;
abort the user-level insert operation we leave the physical change as is?&lt;/p&gt;

&lt;p&gt;I&apos;m just guessing; your overall approach seems great to me, and many thanks&lt;br/&gt;
to the original reporter for tracking down this great repro script.&lt;/p&gt;</comment>
                            <comment id="12667234" author="knutanders" created="Mon, 26 Jan 2009 12:53:35 +0000"  >&lt;p&gt;I guess you&apos;re right. But I still find it a bit odd that there is a difference between failing to add the value 7 to the index 119 times and failing to do so 120 times. I would have expected that the next attempt to insert the value would try to reuse the unused space allocated by the previous failed attempt rather than allocating space once more.&lt;/p&gt;

&lt;p&gt;Out of curiosity, I tried this code:&lt;/p&gt;

&lt;p&gt;        s.execute(&quot;create table d4028(x int unique)&quot;);&lt;br/&gt;
        while (true) {&lt;br/&gt;
            try &lt;/p&gt;
{
                s.execute(&quot;insert into d4028 values 1&quot;);
            }
&lt;p&gt; catch (SQLException e) &lt;/p&gt;
{
                System.out.println(e);
            }
&lt;p&gt;        }&lt;/p&gt;

&lt;p&gt;Even though it only inserts one row, the disk footprint just keeps growing. It&apos;s the disk footprint of the table that&apos;s growing, though, not the index, so it looks like the free space in the index is reused.&lt;/p&gt;</comment>
                            <comment id="12673202" author="knutanders" created="Fri, 13 Feb 2009 10:23:43 +0000"  >&lt;p&gt;The problem with the growing table has been logged as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4056&quot; title=&quot;Space is not reclaimed when attempting to insert row that violates UNIQUE constraint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4056&quot;&gt;&lt;del&gt;DERBY-4056&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12673444" author="mikem" created="Sat, 14 Feb 2009 01:14:27 +0000"  >&lt;p&gt;I have not had time to debug this or review any of the patches.  &lt;/p&gt;

&lt;p&gt;Just wanted to say what I believe the assumptions are for the btree, so that we don&apos;t add the&lt;br/&gt;
wrong fixes.  &lt;/p&gt;

&lt;p&gt;A btree must be able to uniquely identify every row in the tree, it does this by comparing some&lt;br/&gt;
number of the columns in the tree.  In the case of a unique btree it does this by comparing all&lt;br/&gt;
columns except for last one.  In the case of a non-unique btree it does this by comparing all&lt;br/&gt;
collumns including the last one (which is the row id pointer of the base table).  To uniquely identify&lt;br/&gt;
this row, whether it is deleted or not does not matter, there is meant to be code in the case of&lt;br/&gt;
deleted rows to wait around to make sure there is only one value with respect to these cases.&lt;/p&gt;

&lt;p&gt;For the new feature which allows a unique constraint, but allows multiple nulls - the implementation is meant to use a &quot;non-unique&quot; btree.  This means that rows, including deleted &lt;br/&gt;
rows are allowed to be duplicate.   At insert time there is meant to be new code that allows duplicate null values but not other duplicates.  I assume there is a bug in that new code.&lt;/p&gt;</comment>
                            <comment id="12673446" author="mikem" created="Sat, 14 Feb 2009 01:22:24 +0000"  >&lt;p&gt;the code that knut&apos;s patch is going at, is the new code so very likely the right place to fix this one.  Keep an eye out for the &quot;isUniqueWithDuplicateNulls&quot; paths.&lt;/p&gt;</comment>
                            <comment id="12677315" author="knutanders" created="Fri, 27 Feb 2009 11:00:28 +0000"  >&lt;p&gt;Here&apos;s a simpler way to reproduce the bug:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t (x int unique);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t values 1,2,3;&lt;br/&gt;
3 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; delete from t where x = 2;&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; update t set x = 2;&lt;br/&gt;
2 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from t;&lt;br/&gt;
X          &lt;br/&gt;
-----------&lt;br/&gt;
2          &lt;br/&gt;
2          &lt;/p&gt;

&lt;p&gt;2 rows selected&lt;/p&gt;</comment>
                            <comment id="12677384" author="knutanders" created="Fri, 27 Feb 2009 14:54:08 +0000"  >&lt;p&gt;Uploading an updated patch (1a) which adds test cases to NullableUniqueConstraintTest. I haven&apos;t run any other tests yet. I still suspect that there are some problems with how the latches are released in these methods, but I&apos;ll investigate more and file a separate issue if that turns out to be the case.&lt;/p&gt;</comment>
                            <comment id="12677405" author="knutanders" created="Fri, 27 Feb 2009 16:09:24 +0000"  >&lt;p&gt;With the patch NullableUniqueConstraintTest.testMixedInsertDelete() starts failing intermittently with an exception indicating that there&apos;s an attempt to unlatch a page that is not latched. I haven&apos;t investigated whether it&apos;s a problem with the patch or if the patch has exposed some of the existing latch problems that I&apos;ve mentioned.&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED&lt;br/&gt;
        at org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:98)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BasePage.unlatch(BasePage.java:1319)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.ControlRow.release(ControlRow.java:926)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.BTreeController.comparePreviousRecord(BTreeController.java:419)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.BTreeController.compareLeftAndRightSiblings(BTreeController.java:579)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.BTreeController.doIns(BTreeController.java:841)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.BTreeController.insert(BTreeController.java:1289)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.index.B2IController.insert(B2IController.java:210)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexChanger.insertAndCheckDups(IndexChanger.java:439)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexChanger.doInsert(IndexChanger.java:383)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexChanger.insert(IndexChanger.java:589)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexSetChanger.insert(IndexSetChanger.java:268)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:453)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:1022)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:495)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:416)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:297)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1235)&lt;br/&gt;
        ... 28 more&lt;/p&gt;</comment>
                            <comment id="12678277" author="knutanders" created="Tue, 3 Mar 2009 10:50:41 +0000"  >&lt;p&gt;Attaching an updated patch (1b). The assert failure was caused by some changes in how the latches were released in the previous patches. I changed it back and also added comments explaining the logic behind the releasing of the latches (but I think there&apos;s still a bug there, see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4080&quot; title=&quot;Deadlock between locks and latches in BTreeController.compareRowsForInsert()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4080&quot;&gt;DERBY-4080&lt;/a&gt;). This change made the intermittent assert failures go away.&lt;/p&gt;

&lt;p&gt;I&apos;m running the regression tests now.&lt;/p&gt;</comment>
                            <comment id="12678329" author="knutanders" created="Tue, 3 Mar 2009 14:41:23 +0000"  >&lt;p&gt;All the regression tests ran cleanly. The patch is ready for review. A description of the approach can be found in the comment dated 23/Jan/09 04:40 AM. That comment mentioned possible problems with boundary checks. Those problems were fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4027&quot; title=&quot;An attempt was made to access an out of range slot on a page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4027&quot;&gt;&lt;del&gt;DERBY-4027&lt;/del&gt;&lt;/a&gt;. It also mentioned potential problems with releasing of latches, and those problems have now been logged as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4080&quot; title=&quot;Deadlock between locks and latches in BTreeController.compareRowsForInsert()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4080&quot;&gt;DERBY-4080&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4081&quot; title=&quot;BTreeController.comparePreviousRecord() may fail to release latch on left-most leaf&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4081&quot;&gt;&lt;del&gt;DERBY-4081&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12681248" author="knutanders" created="Thu, 12 Mar 2009 10:24:54 +0000"  >&lt;p&gt;There has been interest in doing a full rewrite of the code that inserts rows in an index backing a nullable unique constraint &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, which would make this fix unnecessary. But since it&apos;s getting close to the 10.5 release and the work on the rewrite hasn&apos;t started, I&apos;m checking in the fix anyway to ensure that it will be fixed 10.5.&lt;/p&gt;

&lt;p&gt;Committed revision 752826.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &amp;lt;URL:&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200903.mbox/%3C49AEBA96.5010609@sbcglobal.net%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200903.mbox/%3C49AEBA96.5010609@sbcglobal.net%3E&lt;/a&gt;&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12682304" author="knutanders" created="Mon, 16 Mar 2009 12:53:13 +0000"  >&lt;p&gt;Merged to 10.4 and committed revision 754881.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12398575" name="check-deleted.diff" size="5495" author="knutanders" created="Fri, 23 Jan 2009 12:40:02 +0000"/>
                            <attachment id="12401119" name="derby-4028-1a.diff" size="8467" author="knutanders" created="Fri, 27 Feb 2009 14:54:08 +0000"/>
                            <attachment id="12401298" name="derby-4028-1b.diff" size="10439" author="knutanders" created="Tue, 3 Mar 2009 10:50:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 23 Jan 2009 11:25:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23975</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0l87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37257</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>