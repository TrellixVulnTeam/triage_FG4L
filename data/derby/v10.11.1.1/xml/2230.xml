<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:23:21 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2230/DERBY-2230.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2230] AssertFailure: ByteCode Conditional then/else stack mismatch</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2230</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following statements produce an AssertFailure exception:&lt;/p&gt;

&lt;p&gt;CREATE TABLE table1 (&lt;br/&gt;
   s VARCHAR(10));&lt;/p&gt;

&lt;p&gt;SELECT 1&lt;br/&gt;
   FROM table1 a&lt;br/&gt;
      INNER JOIN table1 b ON&lt;br/&gt;
         a.s =&lt;br/&gt;
            CASE&lt;br/&gt;
               WHEN 1=1 THEN &apos;0&apos;&lt;br/&gt;
               ELSE SUBSTR(b.s,1,1) END;&lt;/p&gt;


&lt;p&gt;Stack trace:&lt;/p&gt;

&lt;p&gt;org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED ByteCode Conditional then/else stack mismatch: then: Lorg/apache/derby/iapi/types/StringDataValue; else: Lorg/apache/derby/iapi/types/ConcatableDataValue;&lt;br/&gt;
        at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:149)&lt;br/&gt;
        at org.apache.derby.impl.services.bytecode.Conditional.end(Conditional.java:216)&lt;br/&gt;
        at org.apache.derby.impl.services.bytecode.BCMethod.completeConditional(BCMethod.java:1063)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ConditionalNode.generateExpression(ConditionalNode.java:468)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.BinaryRelationalOperatorNode.generateQualMethod(BinaryRelationalOperatorNode.java:708)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.PredicateList.generateSingleQualifierCode(PredicateList.java:2723)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.PredicateList.generateQualifiers(PredicateList.java:2905)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.HashJoinStrategy.getScanArgs(HashJoinStrategy.java:348)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.FromBaseTable.getScanArguments(FromBaseTable.java:3368)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.FromBaseTable.generateResultSet(FromBaseTable.java:3059)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.FromBaseTable.generate(FromBaseTable.java:2986)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(ProjectRestrictNode.java:1352)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(ProjectRestrictNode.java:1303)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.JoinNode.getJoinArguments(JoinNode.java:1580)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.JoinNode.generateCore(JoinNode.java:1556)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.JoinNode.generate(JoinNode.java:1480)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(ProjectRestrictNode.java:1441)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(ProjectRestrictNode.java:1303)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ScrollInsensitiveResultSetNode.generate(ScrollInsensitiveResultSetNode.java:110)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.CursorNode.generate(CursorNode.java:583)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.StatementNode.generate(StatementNode.java:233)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:478)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:119)&lt;br/&gt;
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:745)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:568)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:517)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main14.main(Unknown Source)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(Unknown Source)&lt;/p&gt;</description>
                <environment>The AssertFailure error occurs only with the debug version of derby.jar.&lt;br/&gt;
Java 1.5</environment>
        <key id="12360249">DERBY-2230</key>
            <summary>AssertFailure: ByteCode Conditional then/else stack mismatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mayureshnirhali">Mayuresh Nirhali</assignee>
                                    <reporter username="chdh@inventec.ch">Christian d&apos;Heureuse</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Jan 2007 01:42:06 +0000</created>
                <updated>Fri, 21 Jan 2011 17:49:36 +0000</updated>
                            <resolved>Fri, 8 Jun 2007 19:04:09 +0100</resolved>
                                    <version>10.2.2.0</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12463880" author="chdh@inventec.ch" created="Thu, 11 Jan 2007 12:27:56 +0000"  >&lt;p&gt;I found a simpler version to produce the AssertFailure:&lt;/p&gt;

&lt;p&gt;CREATE TABLE table1 (&lt;br/&gt;
   s VARCHAR(10));&lt;/p&gt;

&lt;p&gt;SELECT CASE WHEN 1=1 THEN &apos;0&apos; ELSE SUBSTR(s,1,1) END&lt;br/&gt;
   FROM table1;&lt;/p&gt;</comment>
                            <comment id="12487794" author="mayureshnirhali" created="Tue, 10 Apr 2007 16:15:31 +0100"  >&lt;p&gt;I did NOT see any assert failures when I ran on the latest trunk.&lt;/p&gt;

&lt;p&gt;This failure is reproducible with 10.2.2.&lt;/p&gt;</comment>
                            <comment id="12488395" author="mayureshnirhali" created="Thu, 12 Apr 2007 16:05:44 +0100"  >&lt;p&gt;The assert is reproducible on trunk as well. When I tried the last time, I think I ran on non-debug version of trunk.&lt;/p&gt;

&lt;p&gt;The return types of &apos;else&apos; and &apos;then&apos; clauses in the conditional query must be matched. If they are not matched or if one of the types are not assignable to the other, 42X89 is thrown.&lt;/p&gt;

&lt;p&gt;In this particular example, when debug flag is set, type.vmName for return type of both &apos;else&apos; and &apos;then&apos; clause are checked and found to be not equal. This check does not validate if one of them is assignable to the other, hence the assert.&lt;/p&gt;</comment>
                            <comment id="12489373" author="mayureshnirhali" created="Tue, 17 Apr 2007 12:50:47 +0100"  >&lt;p&gt;The compiler/bytecode generator code does not load classes to check relationships or any other information. This is making things difficult to fix this bug. Also, I think it is not worth to go this way for a simple check that too in a DEBUG block.&lt;/p&gt;

&lt;p&gt;Check for non-matching return types of then and else blocks in Conditional statement is made during bindExpression call and 42X89 is thrown if false. Hence, During byte code generation, check for non-matching return types is not required. I believe the assert check was included just to make sure that the stacks are consistent. But, it seems they do not consider a valid case where the two return types can have different vmNames (StringValue, ConcatableDataValue) which are assignable.&lt;/p&gt;

&lt;p&gt;I have created a patch that works around this problem by adding another check for vmTypes. One of the reasons I chose vmType is because I saw BCMethod making its casting decision based on vmType.&lt;/p&gt;

&lt;p&gt;I have started testruns with this patch.&lt;br/&gt;
I am waiting for comments on this.&lt;/p&gt;</comment>
                            <comment id="12489481" author="mayureshnirhali" created="Tue, 17 Apr 2007 19:06:49 +0100"  >&lt;p&gt;derbyall, suites.All runs did not show new failures.&lt;/p&gt;

&lt;p&gt;Marking patch available flag!&lt;/p&gt;</comment>
                            <comment id="12494104" author="kmarsden" created="Mon, 7 May 2007 19:38:52 +0100"  >&lt;p&gt;I committed this patch but I do think it would be good to add this test case to an existing test.&lt;/p&gt;</comment>
                            <comment id="12495937" author="mayureshnirhali" created="Tue, 15 May 2007 11:09:35 +0100"  >&lt;p&gt;patch adds another testcase to GroupByExpressionTest for this particular bug.&lt;/p&gt;

&lt;p&gt;this new test patch is ready for review.&lt;/p&gt;</comment>
                            <comment id="12502894" author="myrna" created="Fri, 8 Jun 2007 19:04:09 +0100"  >&lt;p&gt;I applied and committed the test patch in 10.3 with revision 545573.&lt;br/&gt;
I don&apos;t personally feel the need to/intend to backport this to 10.2, although it probably isn&apos;t a big deal if someone wants to do it.&lt;br/&gt;
Thx for the patch, Mayuresh.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12355685" name="derby2230.diff" size="757" author="mayureshnirhali" created="Tue, 17 Apr 2007 12:50:47 +0100"/>
                            <attachment id="12357372" name="derby2230_testv1.diff" size="828" author="mayureshnirhali" created="Tue, 15 May 2007 11:09:35 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 10 Apr 2007 15:15:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22955</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0msf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37510</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>