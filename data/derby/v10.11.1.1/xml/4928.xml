<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:42:11 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4928/DERBY-4928.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4928] Deadlock-prone synchronization in BasicDependencyManager</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4928</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The synchronization in BasicDependencyManager is prone to deadlock, because database locks are obtained while holding the monitor on &quot;this&quot;.&lt;br/&gt;
Problem observed when testing the automatic index statistics update prototype.&lt;/p&gt;

&lt;p&gt;There are comments in the file suggesting that in-memory dependencies should be accessed while holding the Java monitor, but the monitor should not be held when accessing stored dependencies. The implementation is breaking this rule/suggestion.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12491877">DERBY-4928</key>
            <summary>Deadlock-prone synchronization in BasicDependencyManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Dec 2010 13:46:14 +0000</created>
                <updated>Tue, 19 Apr 2011 13:39:26 +0100</updated>
                            <resolved>Wed, 8 Dec 2010 11:47:09 +0000</resolved>
                                    <version>10.8.1.2</version>
                                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12967245" author="kristwaa" created="Mon, 6 Dec 2010 16:33:10 +0000"  >&lt;p&gt;Attaching patch 1a.&lt;/p&gt;

&lt;p&gt;This patch primarily addresses incorrect synchronization in BasicDependencyManager. The rule was already described in the class, but the implementation didn&apos;t obey them:&lt;br/&gt;
 o use synchronized (this) when accessing in-memory dependencies (deps stored in BasicDependencyManager)&lt;br/&gt;
 o don&apos;t use synchronized (this) when accessing stored dependencies, but rely on database locking (deps stored in the data dictionary / a system table)&lt;/p&gt;

&lt;p&gt;I haven&apos;t come across cases where we need to synchronize over both sets of dependencies (at the same time).&lt;/p&gt;

&lt;p&gt;Main changes in BasicDependecyManager:&lt;br/&gt;
 o split body of addDepencendy into addInMemoryDependency and addStoredDependency&lt;br/&gt;
 o corrected JavaDoc for coreInvalidateFor (the flag &apos;forSync&apos; doesn&apos;t exist)&lt;br/&gt;
 o fixed synchronization in clearDependencies (this is where the automatic index stats update feature got stuck in a deadlock)&lt;br/&gt;
 o reformatted (+tiny refactoring) clearInMemoryDependencies&lt;br/&gt;
 o deleted commented out methods getAllProviders and getAllProvidersInfos&lt;br/&gt;
 o removed synchronized for getPersistentProvidersInfos and rewrote method&lt;br/&gt;
 o removed synchronized for copyDependencies&lt;br/&gt;
 o fixed synchronization in countDependencies&lt;br/&gt;
 o deleted unused method dumpDependencies (and then bubbleSort)&lt;br/&gt;
 o rewrote methods getProviders and getDependents for new sync rules&lt;br/&gt;
 o replaced HashTable with Map&lt;br/&gt;
 o removed methods newSList&lt;/p&gt;

&lt;p&gt;Changes in ViewsTest and BaseJDBCTestCase:&lt;br/&gt;
 o added method assertStatementErrorUnordered, as the ordering of in-memory and stored dependencies changed to to the changes described above (this can easily be switched back, but I don&apos;t see why - decided to make the test more resilient to varying ordering instead).&lt;br/&gt;
 o used the new assert method were the test failed&lt;/p&gt;


&lt;p&gt;Re-running regression tests.&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12968701" author="kristwaa" created="Tue, 7 Dec 2010 12:30:31 +0000"  >&lt;p&gt;Regression tests passed.&lt;br/&gt;
I haven&apos;t seen the hang with the automatic index statistics update feature using this patch either,although I haven&apos;t run the tests that many times yet.&lt;/p&gt;</comment>
                            <comment id="12969269" author="knutanders" created="Wed, 8 Dec 2010 10:45:20 +0000"  >&lt;p&gt;Looks like a good cleanup to me. +1&lt;br/&gt;
(One small typo in a comment in BaseJDBCTestCase: &quot;Run throgh&quot; -&amp;gt; &quot;Run through&quot;)&lt;/p&gt;</comment>
                            <comment id="12969284" author="kristwaa" created="Wed, 8 Dec 2010 11:47:09 +0000"  >&lt;p&gt;Thanks for the review, Knut.&lt;br/&gt;
I fixed the comment before committing patch 1a to trunk with revision 1043367.&lt;/p&gt;

&lt;p&gt;I don&apos;t plan to backport this fix, at least not now. We don&apos;t have any reports for this problem for earlier versions, so I&apos;d rather see that the changes go through more testing before backporting.&lt;br/&gt;
For the record, it was the automatic index statistics update feature that triggered the bug.&lt;/p&gt;</comment>
                            <comment id="13001104" author="kristwaa" created="Tue, 1 Mar 2011 20:34:13 +0000"  >&lt;p&gt;Closing issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12493638">DERBY-4947</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12465385" name="derby-4928-1a-depman_sync_and_cleanup.diff" size="39926" author="kristwaa" created="Mon, 6 Dec 2010 16:33:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 8 Dec 2010 10:45:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24539</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ghr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36490</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>