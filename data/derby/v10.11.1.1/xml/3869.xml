<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:26:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3869/DERBY-3869.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3869] intermittent hang pinging  server on Linux</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3869</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt; am looking at a intermittent hang with IBM 1.6 on Linux with the ping &lt;br/&gt;
command.  I am not entirely sure it is a jvm issue, but I have not been &lt;br/&gt;
able to reproduce the hang with other jvms.  &lt;br/&gt;
The trace is&lt;/p&gt;

&lt;p&gt;3XMTHREADINFO      &quot;main&quot; TID:0x08072500, j9thread_t:0x08057AF4, state:R, prio=5&lt;br/&gt;
3XMTHREADINFO1            (native thread ID:0x1E05, native priority:0x5, native policy:UNKNOWN)&lt;br/&gt;
4XESTACKTRACE          at java/net/SocketInputStream.socketRead0(Native Method)&lt;br/&gt;
4XESTACKTRACE          at java/net/SocketInputStream.read(SocketInputStream.java:140)&lt;br/&gt;
4XESTACKTRACE          at java/net/SocketInputStream.read(SocketInputStream.java:101)&lt;br/&gt;
4XESTACKTRACE          at org/apache/derby/impl/drda/NetworkServerControlImpl.fillReplyBuffer(NetworkServerControlImpl.java:2764)&lt;br/&gt;
4XESTACKTRACE          at org/apache/derby/impl/drda/NetworkServerControlImpl.readResult(NetworkServerControlImpl.java:2708)&lt;br/&gt;
4XESTACKTRACE          at org/apache/derby/impl/drda/NetworkServerControlImpl.pingWithNoOpen(NetworkServerControlImpl.java:1169)&lt;br/&gt;
4XESTACKTRACE          at org/apache/derby/impl/drda/NetworkServerControlImpl.ping(NetworkServerControlImpl.java:1144(Compiled Code))&lt;br/&gt;
4XESTACKTRACE          at org/apache/derby/drda/NetworkServerControl.ping(NetworkServerControl.java:395(Compiled Code))&lt;br/&gt;
4XESTACKTRACE          at Repro.pingForServerUp(Repro.java:38(Compiled Code))&lt;br/&gt;
4XESTACKTRACE          at Repro.startAndShutdown(Repro.java:20)&lt;/p&gt;

&lt;p&gt;The client has sent the ping, but there is no corresponding session on &lt;br/&gt;
the server side to process the&lt;br/&gt;
command. The full thread dump is in.&lt;br/&gt;
javacore.20080903.183815.7684.0001.txt&lt;/p&gt;

&lt;p&gt;The  program Repro.java shows the problem. It repeatedly starts the server, pings until it &lt;br/&gt;
comes up, and then shuts down.&lt;/p&gt;

&lt;p&gt;In the derby.log I see a startup error, that the address is already in &lt;br/&gt;
use, so presumably the shutdown is not complete before we start the &lt;br/&gt;
server and then perhaps it shuts down mid ping causing the hang?&lt;/p&gt;

&lt;p&gt;2008-09-04 01:37:51.048 GMT : Could not listen on port 1527 on host 127.0.0.1:&lt;br/&gt;
 java.net.BindException: Address already in use&lt;br/&gt;
An exception was thrown during network server startup. DRDA_ListenPort.S:Could not listen on port 1527 on host 127.0.0.1:&lt;br/&gt;
 java.net.BindException: Address already in use&lt;br/&gt;
java.lang.reflect.InvocationTargetException&lt;br/&gt;
		 at sun.reflect.GeneratedMethodAccessor3.invoke(Unknown Source)&lt;br/&gt;
		 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)&lt;br/&gt;
		 at java.lang.reflect.Method.invoke(Method.java:599)&lt;br/&gt;
		 at org.apache.derby.iapi.jdbc.DRDAServerStarter.run(DRDAServerStarter.java:236)&lt;br/&gt;
		 at java.lang.Thread.run(Thread.java:735)&lt;br/&gt;
Caused by: java.lang.Exception: DRDA_ListenPort.S:Could not listen on port 1527 on host 127.0.0.1:&lt;br/&gt;
 java.net.BindException: Address already in use&lt;br/&gt;
		 at java.lang.Throwable.&amp;lt;init&amp;gt;(Throwable.java:67)&lt;br/&gt;
		 at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessageWork(NetworkServerControlImpl.java:3179)&lt;br/&gt;
		 at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessage(NetworkServerControlImpl.java:1861)&lt;br/&gt;
		 at org.apache.derby.impl.drda.NetworkServerControlImpl.blockingStart(NetworkServerControlImpl.java:731)&lt;br/&gt;
		 ... 5 more&lt;/p&gt;


&lt;p&gt;Full log is attached as derby.log&lt;/p&gt;

</description>
                <environment>java version &amp;quot;1.6.0&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build pxi3260sr1-20080416_01(SR1))&lt;br/&gt;
IBM J9 VM (build 2.4, J2RE 1.6.0 IBM J9 2.4 Linux x86-32 jvmxi3260-20080415_1876&lt;br/&gt;
J9VM - 20080415_018762_lHdSMr&lt;br/&gt;
JIT  - r9_20080415_1520&lt;br/&gt;
GC   - 20080415_AA)&lt;br/&gt;
JCL  - 20080412_01</environment>
        <key id="12403699">DERBY-3869</key>
            <summary>intermittent hang pinging  server on Linux</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Sep 2008 19:15:19 +0100</created>
                <updated>Mon, 4 May 2009 19:22:22 +0100</updated>
                            <resolved>Fri, 26 Sep 2008 22:57:09 +0100</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12630003" author="kmarsden" created="Wed, 10 Sep 2008 23:22:27 +0100"  >&lt;p&gt;Actually I reproduced this with the Sun JVM   on linux.&lt;/p&gt;

&lt;p&gt;java version &quot;1.6.0_07&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_07-b06)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 10.0-b23, mixed mode)&lt;/p&gt;

&lt;p&gt;So more likely a derby issue than a jvm  issue.&lt;/p&gt;</comment>
                            <comment id="12631601" author="kmarsden" created="Wed, 17 Sep 2008 00:41:42 +0100"  >&lt;p&gt;Changing title since I saw the hang also with the Sun JVM on Linux.&lt;/p&gt;</comment>
                            <comment id="12632722" author="kmarsden" created="Fri, 19 Sep 2008 16:26:22 +0100"  >&lt;p&gt;If I add in this sleep after interupting the client thread, and closing the sessions, but before closing down the connection threads and closing the server socket, I can reproduce the hang on windows. &lt;/p&gt;

&lt;p&gt;Sleeps in other places cause protocol errors, but no hang.  Ideally we wouldn&apos;t want shutdown to return until the server is totally shutdown, but that is not really possible since we wouldn&apos;t be able to return confirmation of the shutdown. Even if we could, a ping or connection attempt that came in during the shutdown process might potentially hang.&lt;/p&gt;</comment>
                            <comment id="12632814" author="kmarsden" created="Fri, 19 Sep 2008 21:49:49 +0100"  >&lt;p&gt;I am trying to emulate the hang just using Sockets (outside of network server) to try to understand what is going on. From my experimentation, it seems that as long as the server socket is closed, the backlog of blocked clients will be reset and give the message:&lt;br/&gt;
java.net.SocketException: Connection reset&lt;br/&gt;
        at java.net.SocketInputStream.read(SocketInputStream.java:197)&lt;br/&gt;
        at java.net.SocketInputStream.read(SocketInputStream.java:211)&lt;br/&gt;
        at TryHang$1.run(TryHang.java:49)&lt;/p&gt;

&lt;p&gt;as soon as the server socket is closed.  So I am not really sure why that is not happening with the pending ping request with network server.&lt;/p&gt;

</comment>
                            <comment id="12633867" author="kmarsden" created="Tue, 23 Sep 2008 21:06:06 +0100"  >&lt;p&gt;So I think I understand why we get the hang.  The ClientThread does not actually get interupted when clientThread.interrupt() is called.  This is because accept() is not one of the calls that gets interrupted with Thread.interrupt().  So the clientThreead sticks around and accepts the ping request.  Even after the server socket is closed that socket remains open.  Attached is my attempt to fix the problem, which closes the clientSocket if the server is shutting down.  This rectifies the hang.  The ping request may get an insufficient reply data message but I think that is appropriate if the server is shutting down.    It is certainly better than a hang.&lt;/p&gt;</comment>
                            <comment id="12633880" author="bryanpendleton" created="Tue, 23 Sep 2008 21:29:23 +0100"  >&lt;p&gt;&amp;gt; closes the clientSocket if the server is shutting down&lt;/p&gt;

&lt;p&gt;This seems like the right approach to me.&lt;/p&gt;

&lt;p&gt;And yes, it seems reasonable that a ping request might get an error&lt;br/&gt;
if attempted while the server is shutting down.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12389531" name="Repro.java" size="2798" author="kmarsden" created="Thu, 4 Sep 2008 19:16:35 +0100"/>
                            <attachment id="12390538" name="TryHang.java" size="1408" author="kmarsden" created="Fri, 19 Sep 2008 21:49:49 +0100"/>
                            <attachment id="12390780" name="derby-3869_diff.txt" size="976" author="kmarsden" created="Tue, 23 Sep 2008 21:06:06 +0100"/>
                            <attachment id="12390517" name="derby-3869_sleep_to_force_hang_diff.txt" size="987" author="kmarsden" created="Fri, 19 Sep 2008 16:26:22 +0100"/>
                            <attachment id="12389529" name="derby.log" size="4663" author="kmarsden" created="Thu, 4 Sep 2008 19:16:35 +0100"/>
                            <attachment id="12389530" name="javacore.20080903.183815.7684.0001.txt" size="174699" author="kmarsden" created="Thu, 4 Sep 2008 19:16:35 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 23 Sep 2008 20:29:23 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23888</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39280</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>