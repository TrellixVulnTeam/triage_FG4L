<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:23:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4571/DERBY-4571.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4571] Memory leak on server when using &quot;SET ROLE&quot; command</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4571</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Scenario:&lt;br/&gt;
-connect into database&lt;br/&gt;
-use command SET ROLE&lt;br/&gt;
-repeat simple selects many times -&amp;gt; memory consumtions ends with database &quot;outOfMemory: heap space&quot; crash.&lt;/p&gt;

&lt;p&gt;Sometimes this crash ends with loosing (of course previously commited) data in different tables - this is in the case using &quot;UPDATE&quot; etc. command.&lt;br/&gt;
Without command SET ROLE everythings works OK. &lt;/p&gt;</description>
                <environment>Windows XP, Java 6 (build doesn&amp;#39;t matter: 10-18)</environment>
        <key id="12457485">DERBY-4571</key>
            <summary>Memory leak on server when using &quot;SET ROLE&quot; command</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="rmusil">Roman Musil</reporter>
                        <labels>
                            <label>memory_leak</label>
                            <label>role</label>
                    </labels>
                <created>Thu, 25 Feb 2010 20:58:37 +0000</created>
                <updated>Mon, 17 Jun 2013 10:19:28 +0100</updated>
                            <resolved>Wed, 3 Mar 2010 08:13:30 +0000</resolved>
                                    <version>10.5.1.1</version>
                    <version>10.5.3.0</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12838547" author="kristwaa" created="Thu, 25 Feb 2010 21:33:02 +0000"  >&lt;p&gt;Hi Roman,&lt;/p&gt;

&lt;p&gt;Do you happen to have a stack trace from the OOME?&lt;br/&gt;
I know stack traces of OOMEs may be a red herring (due to concurrency / multithreading), but if you&apos;re consistently seeing OOMEs in the same spot of of the code it may be a good start for debugging.&lt;/p&gt;

&lt;p&gt;Also, are you sure you&apos;re loosing previously committed data?&lt;br/&gt;
If so, do you know if you&apos;re running with the disk cache enabled or not?&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;
</comment>
                            <comment id="12838582" author="knutanders" created="Thu, 25 Feb 2010 22:59:07 +0000"  >&lt;p&gt;Hi Roman,&lt;/p&gt;

&lt;p&gt;I tried to reproduce the OOME by following the steps you described, but it won&apos;t reproduce in my environment with Derby 10.5.3.0. I ran the attached program with limited heap size (java -Xmx6M). What do I need to change in the program in order to get the OOME?&lt;/p&gt;</comment>
                            <comment id="12838731" author="rmusil" created="Fri, 26 Feb 2010 06:58:46 +0000"  >&lt;p&gt;OK, it is little bit more complicated, than in your attached Java program. The SELECT command must use rights defined by the ROLE. If &quot;SET ROLE&quot; is executed, but SELECT is granted directly to the user, then it works OK.&lt;br/&gt;
I&apos;ll provide a sample Java program in a few hours.&lt;/p&gt;

&lt;p&gt;(I know, it has to be two different issue: one &quot;memory leak&quot; and second &quot;data loosing&quot;, but the &quot;data loosing&quot; is difficult to reproduce.&lt;br/&gt;
Database is installed &quot;as is&quot; - no special configuration -&amp;gt; no write disk cache.)&lt;br/&gt;
There is the stack trace from derby.log (btw: the database rapidly slows down before exception):&lt;br/&gt;
Exception in thread &quot;DRDAConnThread_8&quot; java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
        at java.util.Arrays.copyOf(Arrays.java:2882)&lt;br/&gt;
        at java.lang.AbstractStringBuilder.expandCapacity(AbstractStringBuilder.java:100)&lt;br/&gt;
        at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:390)&lt;br/&gt;
        at java.lang.StringBuffer.append(StringBuffer.java:224)&lt;br/&gt;
        at java.io.StringWriter.write(StringWriter.java:95)&lt;br/&gt;
        at java.io.PrintWriter.write(PrintWriter.java:412)&lt;br/&gt;
        at java.io.PrintWriter.write(PrintWriter.java:429)&lt;br/&gt;
        at java.io.PrintWriter.print(PrintWriter.java:559)&lt;br/&gt;
        at org.apache.derby.iapi.error.ErrorStringBuilder.appendln(Unknown Source)&lt;br/&gt;
        at org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAStatement.execute(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;/p&gt;</comment>
                            <comment id="12838982" author="rmusil" created="Fri, 26 Feb 2010 18:56:03 +0000"  >&lt;p&gt;If you create database with script memRole.sql and run attached Java program than memory is growing and growing. Execute command &quot;GRANT SELECT ON A TO U1&quot; makes Derby server happy, but revoking this rights from user (&quot;REVOKE SELECT ON A FROM U1&quot;) makes DB unhapy again.&lt;/p&gt;</comment>
                            <comment id="12839282" author="knutanders" created="Sat, 27 Feb 2010 18:29:24 +0000"  >&lt;p&gt;Two of the CALL statements lacked some characters at the end of the line. Uploading a fixed version of memRole.sql.&lt;/p&gt;</comment>
                            <comment id="12839285" author="knutanders" created="Sat, 27 Feb 2010 18:47:28 +0000"  >&lt;p&gt;Thanks, I&apos;m able to reproduce the OOME now.&lt;/p&gt;

&lt;p&gt;I&apos;m wondering, could this be because we have made activations dependent on the current role and the dependency table keeps references to activations even after they&apos;re no longer in use?&lt;/p&gt;</comment>
                            <comment id="12839289" author="knutanders" created="Sat, 27 Feb 2010 19:11:23 +0000"  >&lt;p&gt;It looks like the problem goes away if we make BaseActivation.close() clear its dependencies, see the attached patch clear_deps.diff. I haven&apos;t run any other tests on the patch yet, but clearing the dependencies on close does sound like the correct thing to do.&lt;/p&gt;</comment>
                            <comment id="12839689" author="knutanders" created="Mon, 1 Mar 2010 14:29:47 +0000"  >&lt;p&gt;Attaching patch test.diff which contains a regression test case for this bug. When it&apos;s run as part of the junit-lowmem suite, it fails with OOME without the fix and passes with the fix.&lt;/p&gt;</comment>
                            <comment id="12839700" author="knutanders" created="Mon, 1 Mar 2010 14:52:51 +0000"  >&lt;p&gt;I was a little bit worried about the performance impact of clearing the activation&apos;s dependencies unconditionally on each execution, since clearDependencies() ends up synchronizing on a Hashtable and on a BasicDependencyManager, both of which are shared between all threads accessing the same database. However, running the micro-benchmark attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3024&quot; title=&quot;Validation of shared plans hurts scalability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3024&quot;&gt;&lt;del&gt;DERBY-3024&lt;/del&gt;&lt;/a&gt; in noshare mode on a 32-way processor did not show any negative impact. I cannot think of any other test that would be more likely to be affected by this, so unless someone has an idea for a simple way to check whether the call to clearDependencies() is needed, I plan to go ahead with the unconditional call to clearDependencies() from BaseActivation.close().&lt;/p&gt;</comment>
                            <comment id="12840211" author="knutanders" created="Tue, 2 Mar 2010 15:46:09 +0000"  >&lt;p&gt;Attaching a new patch which includes both the fix and the test case. All the regression tests ran cleanly with this patch.&lt;/p&gt;

&lt;p&gt;As to my comment about performance implications above, I had forgotten that prepared statements reuse activations, so this code will not be invoked as frequently as I thought and it should not be an issue.&lt;/p&gt;</comment>
                            <comment id="12840351" author="dagw" created="Tue, 2 Mar 2010 22:11:18 +0000"  >&lt;p&gt;Patch looks right to me! Thanks for handling this, Knut.&lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="12840527" author="knutanders" created="Wed, 3 Mar 2010 08:13:30 +0000"  >&lt;p&gt;Thanks for reviewing the patch, Dag.&lt;br/&gt;
Committed revision 918359.&lt;/p&gt;</comment>
                            <comment id="12849715" author="knutanders" created="Thu, 25 Mar 2010 14:51:27 +0000"  >&lt;p&gt;Merged fix to the 10.5 branch and committed revision 927433.&lt;/p&gt;</comment>
                            <comment id="13685251" author="knutanders" created="Mon, 17 Jun 2013 10:19:28 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12437065" name="D4571.java" size="660" author="knutanders" created="Thu, 25 Feb 2010 22:59:07 +0000"/>
                            <attachment id="12437226" name="DbRoleMemoryLeak.java" size="771" author="rmusil" created="Fri, 26 Feb 2010 18:56:03 +0000"/>
                            <attachment id="12437349" name="clear_deps.diff" size="641" author="knutanders" created="Sat, 27 Feb 2010 19:11:23 +0000"/>
                            <attachment id="12437614" name="derby-4571-1a.diff" size="5263" author="knutanders" created="Tue, 2 Mar 2010 15:46:09 +0000"/>
                            <attachment id="12437615" name="derby-4571-1a.stat" size="255" author="knutanders" created="Tue, 2 Mar 2010 15:46:09 +0000"/>
                            <attachment id="12437348" name="memRole.sql" size="775" author="knutanders" created="Sat, 27 Feb 2010 18:29:24 +0000"/>
                            <attachment id="12437227" name="memRole.sql" size="778" author="rmusil" created="Fri, 26 Feb 2010 18:56:03 +0000"/>
                            <attachment id="12437486" name="test.diff" size="4415" author="knutanders" created="Mon, 1 Mar 2010 14:29:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 25 Feb 2010 21:33:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24343</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0qwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38178</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>