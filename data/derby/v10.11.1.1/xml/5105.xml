<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:36:36 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5105/DERBY-5105.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5105] NoSuchMethodError in upgrade tests (testTriggerBasic)</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5105</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If the test case BasicSetup.testTriggerBasic runs after the test cases testCreateTable and testIndex, the upgrade test will fail with a NoSuchMethodError in the post soft upgrade phase when testing upgrade from 10.5.x.&lt;/p&gt;

&lt;p&gt;Example from the nightly testing:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.7/testing/testlog/lin/1076682-suitesAll_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.7/testing/testlog/lin/1076682-suitesAll_diff.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2) testTriggerBasic(org.apache.derbyTesting.functionTests.tests.upgradeTests.BasicSetup)java.sql.SQLException: Java exception: &apos;org.apache.derby.iapi.sql.execute.ResultSetFactory.getProjectRestrictResultSet(Lorg/apache/derby/iapi/sql/execute/NoPutResultSet;Lorg/apache/derby/iapi/services/loader/GeneratedMethod;Lorg/apache/derby/iapi/services/loader/GeneratedMethod;ILorg/apache/derby/iapi/services/loader/GeneratedMethod;IIZZDD)Lorg/apache/derby/iapi/sql/execute/NoPutResultSet;: java.lang.NoSuchMethodError&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.upgradeTests.BasicSetup.testTriggerBasic(BasicSetup.java:82)&lt;/p&gt;

&lt;p&gt;It&apos;s seen occasionally on Java 7 and consistently on phoneME.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12500771">DERBY-5105</key>
            <summary>NoSuchMethodError in upgrade tests (testTriggerBasic)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Mar 2011 15:10:54 +0000</created>
                <updated>Thu, 30 Jun 2011 10:21:41 +0100</updated>
                            <resolved>Sun, 13 Mar 2011 10:57:41 +0000</resolved>
                                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13003990" author="knutanders" created="Tue, 8 Mar 2011 15:17:43 +0000"  >&lt;p&gt;To reproduce outside of the upgrade tests, and without using Java 7 or phoneME, perform the following steps:&lt;/p&gt;

&lt;p&gt;1) Using Derby 10.5.3.0, execute the following SQL statements:&lt;/p&gt;

&lt;p&gt;CREATE TABLE Trigger_t1 &lt;br/&gt;
(c1 INTEGER NOT NULL GENERATED ALWAYS &lt;br/&gt;
AS IDENTITY (START WITH 1, INCREMENT BY 1), &lt;br/&gt;
max_size INTEGER NOT NULL, &lt;br/&gt;
CONSTRAINT c1_pk PRIMARY KEY (c1));&lt;/p&gt;

&lt;p&gt;CREATE TABLE Trigger_t2 &lt;br/&gt;
(c1 INTEGER DEFAULT 0 NOT NULL);&lt;/p&gt;

&lt;p&gt;CREATE TRIGGER gls_blt_trg &lt;br/&gt;
AFTER INSERT ON Trigger_t1 FOR EACH ROW MODE DB2SQL&lt;br/&gt;
INSERT INTO Trigger_t2(c1) &lt;br/&gt;
VALUES ( (select max(c1) from Trigger_t1));&lt;/p&gt;

&lt;p&gt;INSERT INTO Trigger_t1(max_size)  VALUES(20);&lt;/p&gt;

&lt;p&gt;2) Connect to the same database using Derby 10.7.1.1 or Derby trunk, and execute the following SQL statement:&lt;/p&gt;

&lt;p&gt;INSERT INTO Trigger_t1(max_size) VALUES(20);&lt;/p&gt;

&lt;p&gt;3) Connect to the database again using Derby 10.5.3.0, and execute the INSERT statement again. You&apos;ll then see the NoSuchMethodError:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; INSERT INTO Trigger_t1(max_size)  VALUES(20);&lt;br/&gt;
ERROR XJ001: Java exception: &apos;org.apache.derby.iapi.sql.execute.ResultSetFactory.getProjectRestrictResultSet(Lorg/apache/derby/iapi/sql/execute/NoPutResultSet;Lorg/apache/derby/iapi/services/loader/GeneratedMethod;Lorg/apache/derby/iapi/services/loader/GeneratedMethod;ILorg/apache/derby/iapi/services/loader/GeneratedMethod;IIZZDD)Lorg/apache/derby/iapi/sql/execute/NoPutResultSet;: java.lang.NoSuchMethodError&apos;.&lt;/p&gt;</comment>
                            <comment id="13003992" author="knutanders" created="Tue, 8 Mar 2011 15:25:55 +0000"  >&lt;p&gt;If you between step 2 and 3 just reboot the database using 10.7.1.1 or higher, step 3 won&apos;t fail. I suppose that&apos;s because rebooting in soft-upgrade mode using a version on which &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4835&quot; title=&quot;Trigger plan does not recompile with upgrade from 10.5.3.0 to 10.6.1.0 causing  java.lang.NoSuchMethodError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4835&quot;&gt;&lt;del&gt;DERBY-4835&lt;/del&gt;&lt;/a&gt; is fixed, will invalidate the SPS so that 10.5.3.0 will correctly recompile it.&lt;/p&gt;

&lt;p&gt;This is also why the test passes on most platforms. testIndex and testCreateTable reboot the database, and since most platforms run those test cases after testTriggerBasic, the rebooting will hide this problem.&lt;/p&gt;</comment>
                            <comment id="13005208" author="kmarsden" created="Thu, 10 Mar 2011 17:55:59 +0000"  >&lt;p&gt;Is this something that is fixable on trunk or would resolution require time travel back to 10.5.3.0.  Is the core problem that &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4835&quot; title=&quot;Trigger plan does not recompile with upgrade from 10.5.3.0 to 10.6.1.0 causing  java.lang.NoSuchMethodError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4835&quot;&gt;&lt;del&gt;DERBY-4835&lt;/del&gt;&lt;/a&gt; can&apos;t be fixed on the old version, 10.5.3.0?  If a users uses  the latest from the 10.5 branch will they see this problem?&lt;/p&gt;</comment>
                            <comment id="13005346" author="knutanders" created="Thu, 10 Mar 2011 21:41:35 +0000"  >&lt;p&gt;The problem is not seen if the user uses head of the 10.5 branch. A fix in 10.8 might be to stop storing the SPS in soft upgrade, so that the incompatible plan isn&apos;t attempted used on 10.5. But it&apos;s probably not worth doing just for supporting downgrade from 10.8 to a couple of releases three branches back in time. Especially when the workaround seems to be as easy as rebooting the database once using 10.8 before going back to 10.5.x (alternatively, drop and recreate the trigger after moving back to 10.5).&lt;/p&gt;

&lt;p&gt;I&apos;m inclined to simply skip the post soft upgrade part of testTriggerBasic if the version we&apos;re testing against is in the range [10.5.0.0, 10.5.3.2). We could also make the test order explicit, to ensure that the tests that reboot the database run after testTriggerBasic and thereby work around the downgrade problem, but that may hide a regression in this area later, so I think the skipping sounds better. We may also want to skip the post soft upgrade phase of testTriggerBasic for 10.6.1.0, which is the only other released version that lacks a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4835&quot; title=&quot;Trigger plan does not recompile with upgrade from 10.5.3.0 to 10.6.1.0 causing  java.lang.NoSuchMethodError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4835&quot;&gt;&lt;del&gt;DERBY-4835&lt;/del&gt;&lt;/a&gt;. It&apos;s not causing a problem currently, since the signatures of the ResultSetFactory methods haven&apos;t changed after 10.6, but we may see similar problems on that version too if the signatures are changed in a future version. I think...&lt;/p&gt;</comment>
                            <comment id="13005347" author="knutanders" created="Thu, 10 Mar 2011 21:46:57 +0000"  >&lt;p&gt;Oops... 10.6.1.0 isn&apos;t the only 10.6.x without a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4835&quot; title=&quot;Trigger plan does not recompile with upgrade from 10.5.3.0 to 10.6.1.0 causing  java.lang.NoSuchMethodError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4835&quot;&gt;&lt;del&gt;DERBY-4835&lt;/del&gt;&lt;/a&gt;. It wasn&apos;t in 10.6.2.1 either. So to prevent this failure, and the reappearance the next time the signatures change, I suggest we skip that part of the test for 10.5.1.1, 10.5.2.0, 10.5.3.0, 10.6.1.0 and 10.6.2.1. Downgrade to any other version should work fine, as far as I understand.&lt;/p&gt;</comment>
                            <comment id="13005361" author="kmarsden" created="Thu, 10 Mar 2011 22:24:35 +0000"  >&lt;p&gt;That sounds reasonable.  To get some coverage on the 10.5 and 10.6 branches, I suppose we could check in a snapshot of the branch, but perhaps that would be too confusing.  It would be nice to see a stand alone fixture for this case that is not dependent on fixture ordering for this case.&lt;/p&gt;

&lt;p&gt;I think once the test issues are resolved  this issue could be closed Won&apos;t fix with instructions about work arounds or maybe even dup it to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4835&quot; title=&quot;Trigger plan does not recompile with upgrade from 10.5.3.0 to 10.6.1.0 causing  java.lang.NoSuchMethodError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4835&quot;&gt;&lt;del&gt;DERBY-4835&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="13006168" author="knutanders" created="Sun, 13 Mar 2011 10:49:52 +0000"  >&lt;p&gt;I&apos;ve checked in the attached patch (committed with revision 1081072) that disables the post soft upgrade phase of testTriggerBasic if the version we test suffers from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4835&quot; title=&quot;Trigger plan does not recompile with upgrade from 10.5.3.0 to 10.6.1.0 causing  java.lang.NoSuchMethodError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4835&quot;&gt;&lt;del&gt;DERBY-4835&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I don&apos;t think we need to check in jar files from head of 10.5 and 10.6 just to test this. If someone wants to set up their test environments to run upgrade tests against head of the release branches, it should be easy enough to do that by using the derbyTesting.oldVersionsPath to override the set of versions to test against, without any need to check in unreleased jar files in the repository.&lt;/p&gt;</comment>
                            <comment id="13006169" author="knutanders" created="Sun, 13 Mar 2011 10:57:41 +0000"  >&lt;p&gt;Resolving issue as &quot;Won&apos;t Fix&quot; now that the failing part of test has been disabled. The bug only affects downgrade to a specific set of versions, it doesn&apos;t fail against the latest sources in the branches for the affected versions, and workarounds exist.&lt;/p&gt;

&lt;p&gt;Workarounds:&lt;/p&gt;

&lt;p&gt;If you experience this after soft upgrade from one of the affected versions to 10.7.1.1 or later and reverting back to the old version, use one of the following workarounds:&lt;/p&gt;

&lt;p&gt;Workaround 1: Reboot the database using Derby 10.7.1.1 or later. Simply connect to the database and then disconnect without doing any other operations. When reverting to the old version again, the triggers should work correctly.&lt;/p&gt;

&lt;p&gt;Workaround 2: After reverting to the old version, drop and recreate the affected triggers.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12476689">DERBY-4835</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12509398">DERBY-5263</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12501060">DERBY-5123</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12473497" name="disable.diff" size="2783" author="knutanders" created="Sun, 13 Mar 2011 10:49:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 10 Mar 2011 17:55:59 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24651</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36392</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>