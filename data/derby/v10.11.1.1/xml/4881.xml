<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:24:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4881/DERBY-4881.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4881] Deadlock accessing SYS.SYSSTATISTICS</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4881</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Transactions accessing index statistics can deadlock if one of them inserts new entries and the other selects from the system table. Inserts happens for instance when update of index statistics are perform manually, or when a table is compressed (given that the table has indexes and contains some rows). This issue may be more problematic when automatic update of index statistics is implemented.&lt;br/&gt;
Issue discovered when writing a regression tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4849&quot; title=&quot;Re-compilation may cause duplicate entries in the XPLAIN table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4849&quot;&gt;&lt;del&gt;DERBY-4849&lt;/del&gt;&lt;/a&gt;, see discussion there. The bug is timing dependent, but has been observed on a variety of JVMs and platform architectures.&lt;/p&gt;

&lt;p&gt;To sum up:&lt;br/&gt;
  o using NO_WAIT + retry was suggested, but turned out to be an infeasible solution&lt;br/&gt;
  o current approach is to allow using read uncommitted isolation level when accessing statistics in the system table (take no locks)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12478877">DERBY-4881</key>
            <summary>Deadlock accessing SYS.SYSSTATISTICS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Nov 2010 11:42:55 +0000</created>
                <updated>Mon, 7 Feb 2011 19:14:01 +0000</updated>
                            <resolved>Mon, 7 Feb 2011 19:14:01 +0000</resolved>
                                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12927368" author="kristwaa" created="Tue, 2 Nov 2010 12:01:54 +0000"  >&lt;p&gt;Attached patch 1a.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;FromBaseTable&lt;br/&gt;
Minor change, avoid second call to TableDescriptor.statisticsExist if unnecessary.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;DataDictionaryImpl&lt;br/&gt;
 o Removed getDescriptorViaIndex-overload not taking isolation level as parameter (only used in once place).&lt;br/&gt;
 o getStatisticsDescriptors:&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new JavaDoc&lt;/li&gt;
	&lt;li&gt;use READ_UNCOMMITTED instead of REPEATABLE_READ&lt;br/&gt;
 o @@ -8455,16 +8466,16 @@: formatting change due to long line&lt;br/&gt;
 o getDescriptorViaIndexMinion&lt;/li&gt;
	&lt;li&gt;removed unused variable indexTemplateRow&lt;/li&gt;
	&lt;li&gt;removed assert allowing only a single result to be returned when using isolation level read uncommitted&lt;/li&gt;
	&lt;li&gt;modified if to ignore match if tuple descriptor is null (index row existed, but not base row)                   &amp;lt;=== Behavior change&lt;br/&gt;
 o computeSequenceRowLocation (cleanup only)&lt;/li&gt;
	&lt;li&gt;removed unused variable row&lt;/li&gt;
	&lt;li&gt;use getDescriptorViaIndex instead of getDescriptorViaIndexMinion&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Regression tests passed: derbyall (104 tests) and suites.All (13075 tests).&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12927386" author="knutanders" created="Tue, 2 Nov 2010 12:58:13 +0000"  >&lt;p&gt;The patch looks good to me. And it removes more code than it adds! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; It looks like Dag handled most of the edges for the read uncommitted case in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3678&quot; title=&quot;StackOverflowException in deadlock trace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3678&quot;&gt;&lt;del&gt;DERBY-3678&lt;/del&gt;&lt;/a&gt;, and with your change to ignore td==null, I think it should be safe in the list!=null case too.&lt;/p&gt;

&lt;p&gt;I was able to reproduce the deadlock in XplainStatisticsTest on nearly every run with an insane build in my environment. The patch seems to have fixed that, and now I&apos;m not able to reproduce it.&lt;/p&gt;

&lt;p&gt;+1 to commit.&lt;/p&gt;</comment>
                            <comment id="12927405" author="kristwaa" created="Tue, 2 Nov 2010 13:49:19 +0000"  >&lt;p&gt;Thanks for the quick review, Knut Anders &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Patch 1b is identical to 1a, except that I ditched the changes in FromBaseTable. Avoiding the second call to statisticsExists is moot because of caching and short-circuiting.&lt;/p&gt;

&lt;p&gt;Committed patch 1b to trunk with revision 1030043.&lt;/p&gt;</comment>
                            <comment id="12927406" author="kristwaa" created="Tue, 2 Nov 2010 13:50:52 +0000"  >&lt;p&gt;I will backport this fix once the nightlies show that it hasn&apos;t introduced any new problems, and that the regression test for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4849&quot; title=&quot;Re-compilation may cause duplicate entries in the XPLAIN table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4849&quot;&gt;&lt;del&gt;DERBY-4849&lt;/del&gt;&lt;/a&gt; passes.&lt;/p&gt;</comment>
                            <comment id="12928577" author="kristwaa" created="Fri, 5 Nov 2010 12:34:45 +0000"  >&lt;p&gt;The fix only merges cleanly with 10.6, and it seems it would be required to either rewrite the patch or pull in additional changes to backport it to 10.5.&lt;br/&gt;
Given that we haven&apos;t gotten any user reports of this issue, I plan to backport it to 10.6. only.&lt;/p&gt;

&lt;p&gt;Running tests.&lt;/p&gt;</comment>
                            <comment id="12928626" author="kristwaa" created="Fri, 5 Nov 2010 15:27:46 +0000"  >&lt;p&gt;Tests passed.&lt;/p&gt;

&lt;p&gt;Backported to the 10.6 branch with revision 1031623.&lt;/p&gt;</comment>
                            <comment id="12965164" author="kristwaa" created="Tue, 30 Nov 2010 09:19:16 +0000"  >&lt;p&gt;Closing issue.&lt;/p&gt;</comment>
                            <comment id="12989895" author="kmarsden" created="Wed, 2 Feb 2011 23:44:33 +0000"  >&lt;p&gt;Reopen for backport.&lt;/p&gt;</comment>
                            <comment id="12990838" author="kmarsden" created="Fri, 4 Feb 2011 23:53:13 +0000"  >&lt;p&gt;Assign to myself for backport to 10.5&lt;/p&gt;</comment>
                            <comment id="12990841" author="kmarsden" created="Sat, 5 Feb 2011 00:12:29 +0000"  >&lt;p&gt;Some manual merge was required for 10.5. Here is the patch. Running tests.&lt;/p&gt;</comment>
                            <comment id="12991518" author="kmarsden" created="Mon, 7 Feb 2011 19:14:01 +0000"  >&lt;p&gt;closing after merge 10.5&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12477327">DERBY-4849</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12497378">DERBY-4994</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12458628" name="derby-4881-1a-deadlock_fix.diff" size="7675" author="kristwaa" created="Tue, 2 Nov 2010 12:01:54 +0000"/>
                            <attachment id="12458634" name="derby-4881-1b-deadlock_fix.diff" size="6603" author="kristwaa" created="Tue, 2 Nov 2010 13:49:19 +0000"/>
                            <attachment id="12470311" name="derby-4881_10_5_diff.txt" size="6003" author="kmarsden" created="Sat, 5 Feb 2011 00:12:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 2 Nov 2010 12:58:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24506</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0j87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36933</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>