<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:52:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2256/DERBY-2256.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2256] Wrong Results: Use of decimal values in an IN-list with INTEGER left operand can lead to extra rows.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2256</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;While trying out some code changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt; I was running a few test cases and happened to notice that there are a couple of cases in which Derby behaves incorrectly (that or my understanding of what should be happening here is way off).&lt;/p&gt;

&lt;p&gt;First and most simply: the following query should return zero rows (unless I&apos;m missing something?), but it returns one:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t1 (i int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t1 values 1, 2, 3, 4, 5;&lt;br/&gt;
5 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;&amp;#8211; Correct returns zero rows.&lt;br/&gt;
ij&amp;gt; select * from t1 where i in (4.23);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;/p&gt;

&lt;p&gt;&amp;#8211; But this one returns 1 row...&lt;br/&gt;
ij&amp;gt; select * from t1 where i in (2.8, 4.23);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;br/&gt;
4&lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;

&lt;p&gt;Secondly, if the IN-list contains a non-constant value then Derby can incorrectly return rows that do not match the IN predicate.  I think this is because some internal casting is happening when it shouldn&apos;t?&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table t1 (i int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t1 values 1, 2, 3, 4, 5;&lt;br/&gt;
5 rows inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;&amp;#8211; Following values clause returns &quot;2.80&quot;, as expected.&lt;br/&gt;
ij&amp;gt; values cast (2.8 as decimal(4, 2));&lt;br/&gt;
1&lt;br/&gt;
-------&lt;br/&gt;
2.80&lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;

&lt;p&gt;&amp;#8211; But if we use it in an IN-list it gets cast to &quot;2&quot; and thus returns a match.&lt;br/&gt;
&amp;#8211; We get 2 rows when we should get NONE.&lt;br/&gt;
ij&amp;gt; select * from t1 where i in (cast (2.8 as decimal(4, 2)), 4.23);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;br/&gt;
2&lt;br/&gt;
4&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;/p&gt;

&lt;p&gt;I confirmed that we see these results on trunk, 10.2, 10.1, and even as far back as svn #201660 for 10.0.  I also ran the above statements on DB2 v8 as a sanity check to confirm that NO results were returned there.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12360835">DERBY-2256</key>
            <summary>Wrong Results: Use of decimal values in an IN-list with INTEGER left operand can lead to extra rows.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jan 2007 00:19:30 +0000</created>
                <updated>Wed, 19 Dec 2012 11:10:59 +0000</updated>
                            <resolved>Wed, 20 Jun 2007 02:32:47 +0100</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.0.2.2</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.1.3.2</version>
                    <version>10.1.3.3</version>
                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.2.2.1</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12465963" author="yipng" created="Fri, 19 Jan 2007 06:06:26 +0000"  >&lt;p&gt;Another error cases:&lt;/p&gt;

&lt;p&gt;&amp;#8211; ok&lt;br/&gt;
ij&amp;gt; select * from t1 where i in (4, 4.23);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;br/&gt;
4&lt;/p&gt;

&lt;p&gt;&amp;#8211; wrong&lt;br/&gt;
ij&amp;gt; select * from t1 where i in (4.23, 4);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;/p&gt;

&lt;p&gt;0 rows selected&lt;/p&gt;</comment>
                            <comment id="12466094" author="army" created="Fri, 19 Jan 2007 16:18:50 +0000"  >&lt;p&gt;There is code in InListOperatorNode.java that creates a BETWEEN clause from an IN-list if the size of the IN list is greater than 1 and all values are constants:&lt;/p&gt;

&lt;p&gt;	if (rightOperandList.size() == 1)&lt;/p&gt;
	{
		// just use an equality predicate
	}
&lt;p&gt;	else if ((leftOperand instanceof ColumnReference) &amp;amp;&amp;amp;&lt;br/&gt;
		 rightOperandList.containsAllConstantNodes())&lt;/p&gt;
	{
		// convert to BETWEEN.
	}

&lt;p&gt;As Bryan Pendleton pointed out on derby-dev, it looks like that could have something to do with why&lt;/p&gt;

&lt;p&gt;  select * from t1 where i in (2.8, 4.23);&lt;/p&gt;

&lt;p&gt;returns a row (&quot;4&quot; is between 2.8 and 4.23).  It also explains why&lt;/p&gt;

&lt;p&gt;  select * from t1 where i in (4.23);&lt;/p&gt;

&lt;p&gt;correctly returns zero rows (it is simply treated as an equality predicate).&lt;/p&gt;

&lt;p&gt;It&apos;s not clear to me how (or if) that explains the other error case posted by Yip above (thanks Yip!), but maybe it&apos;s related?&lt;/p&gt;</comment>
                            <comment id="12466114" author="yipng" created="Fri, 19 Jan 2007 18:18:26 +0000"  >&lt;p&gt;I think Derby will transform this statement&apos;s IN predicate&lt;/p&gt;

&lt;p&gt;i in (2.8, 4.23); &lt;/p&gt;

&lt;p&gt;to the following:&lt;/p&gt;

&lt;p&gt;i in (2.8, 4.23) AND i &amp;gt;= 2.8 AND i &amp;lt;= 4.23&lt;/p&gt;

&lt;p&gt;The original IN predicate should still be there.  So, I think perhaps the problem might have to do with row qualification in regard to integer comparison with the transformed query.    &lt;/p&gt;
</comment>
                            <comment id="12466118" author="army" created="Fri, 19 Jan 2007 18:30:43 +0000"  >&lt;p&gt;Yip&apos;s most recent comment agrees with what Mike wrote on derby-dev:&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://thread.gmane.org/gmane.comp.apache.db.derby.devel/35489/focus=35559&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://thread.gmane.org/gmane.comp.apache.db.derby.devel/35489/focus=35559&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To quote Mike: &quot;My guess would be that &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; some problem is applying the real qualifiers to integer comparisons, where for some reason that compare is different for transformed query.&quot;&lt;/p&gt;</comment>
                            <comment id="12482938" author="army" created="Wed, 21 Mar 2007 22:32:35 +0000"  >&lt;p&gt;It looks like the various incorrect results reported in this Jira are all caused by one of two different but related problems.&lt;/p&gt;

&lt;p&gt;Problem I) Compile-time comparisons.&lt;/p&gt;

&lt;p&gt;The first problem exists in the preprocessing code of InListOperatorNode, where an IN list comprised exclusively of constant literals undergoes three potential transformations:&lt;/p&gt;

&lt;p&gt;  0. First, if the list has a single value in it, it will be replaced by&lt;br/&gt;
     an equality predicate, and that&apos;s it.  So an IN list such as&lt;br/&gt;
     &quot;... i in (3)&quot; will become &quot;i = 3&quot;.&lt;br/&gt;
  1. Else, the list will be sorted in ascending order.&lt;br/&gt;
  2. Then, in the special case where the minimum and maximum values are&lt;br/&gt;
     the same, the IN list will be replaced with a simple equality&lt;br/&gt;
     predicate.  So an IN list such as &quot; ... i in (2, 2, 2)&quot; will actually&lt;br/&gt;
     turn into an equality of the form &quot;i = 2&quot;.&lt;/p&gt;

&lt;p&gt;The problem here is that the code to sort the list, and also the code to find the min/max values, always does comparisons using the type of the left operand, as can be seen from the following comment in the code:&lt;/p&gt;

&lt;p&gt;    /* When sorting or choosing min/max in the list, if types&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;are not an exact match, we use the left operand&apos;s type&lt;/li&gt;
	&lt;li&gt;as the &quot;judge&quot;, assuming that they are compatible, as&lt;/li&gt;
	&lt;li&gt;also the case with DB2.&lt;br/&gt;
     */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But it turns out that this is &lt;b&gt;not&lt;/b&gt; always the correct thing to do--and despite what the comment says, this does not appear to be what DB2 does, either (all of the queries referenced in this Jira issue return the correct results on DB2 v8).&lt;/p&gt;

&lt;p&gt;To see why this is wrong, let&apos;s assume we have a table T1 with an integer column &quot;I&quot; whose rows are simply:&lt;/p&gt;

&lt;p&gt;    I&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;    1&lt;br/&gt;
    2&lt;br/&gt;
    3&lt;br/&gt;
    4&lt;br/&gt;
    5&lt;/p&gt;

&lt;p&gt;Now let&apos;s take the following query:&lt;/p&gt;

&lt;p&gt;  select * from t1 where i in (4.23, 4);&lt;/p&gt;

&lt;p&gt;In this case &quot;i&quot; is the left operand, so the left operand&apos;s type is INTEGER.  Derby will then bubble-sort the IN list values using INTEGER as the &quot;judge&quot; type for comparisons.  When doing integer comparisons with decimal values, Derby will compare with a &lt;em&gt;truncated&lt;/em&gt; version of the decimal(s), which means that we will effectively end up with something like:&lt;/p&gt;

&lt;p&gt;  if (trunc(4.23) &amp;gt; 4)&lt;br/&gt;
    &amp;lt;swap &quot;4.23&quot; with &quot;4&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;which becomes:&lt;/p&gt;

&lt;p&gt;  if (4 &amp;gt; 4)&lt;br/&gt;
    &amp;lt;swap &quot;4.23&quot; with &quot;4&amp;gt;&lt;/p&gt;

&lt;p&gt;Since 4 is not greater than 4, the &quot;if&quot; condition will return false and thus we will not swap the values; we&apos;ll just leave them as they are and consider them &quot;sorted&quot;--which is wrong.&lt;/p&gt;

&lt;p&gt;If we keep going, we will then check to see if the mininum value is equal to the maximum value, and if so we&apos;ll rewrite the IN list as an equality predicate.  That said, the code assumes that the values have been correctly sorted, in which case the minimum value should simply be the first value in the list.  So Derby will at this point think that the minimum value is &quot;4.23&quot; (which is wrong).&lt;/p&gt;

&lt;p&gt;So in pseudo-code we&apos;ll have:&lt;/p&gt;

&lt;p&gt;  if (minVal == maxVal)&lt;br/&gt;
    &amp;lt;transform to equality&amp;gt;&lt;/p&gt;

&lt;p&gt;which becomes&lt;/p&gt;

&lt;p&gt;  if (trunc(4.23) == 4)&lt;br/&gt;
    &amp;lt;transform to equality&amp;gt;&lt;/p&gt;

&lt;p&gt;which becomes&lt;/p&gt;

&lt;p&gt;  if (4 == 4)&lt;br/&gt;
    &amp;lt;transform to equality&amp;gt;&lt;/p&gt;

&lt;p&gt;As a result, we transform the IN list into a simple equality of the form &quot;i = &amp;lt;minValue&amp;gt;&quot;.  But because of the incorrect sort we still think that our minimum value is &quot;4.23&quot;, so the query that we ultimately end up executing is:&lt;/p&gt;

&lt;p&gt;  select * from t1 where i = 4.23&lt;/p&gt;

&lt;p&gt;Thus the query returns no rows when it should have returned one.  Notice that if the IN list values are reversed, i.e.:&lt;/p&gt;

&lt;p&gt;  select * from t1 where i in (4, 4.23);&lt;/p&gt;

&lt;p&gt;then all of the same (incorrect) logic will apply, except that the minimum value will be &quot;4&quot; instead of &quot;4.23&quot; (because &quot;4&quot; appears first in the list).  Thus the query gets rewritten to:&lt;/p&gt;

&lt;p&gt;  select * from t1 where i = 4&lt;/p&gt;

&lt;p&gt;which returns the expected row (somewhat by accident).  So this explains the behavior posted by Yip in an earlier comment.&lt;/p&gt;

&lt;p&gt;Problem II) Execution-time comparisons.&lt;/p&gt;

&lt;p&gt;Even if the incorrect logic described above is fixed, we will still have cases where certain queries return the wrong results.  The reason is that the execution-time logic for IN lists has the same problem as the compilation-time logic: namely, Derby does all of the IN-list comparisons using the left operand&apos;s type, which is wrong.  The relevant code can be found in the DataType.in() method, where we start with the following comment:&lt;/p&gt;

&lt;p&gt;    /* Do a binary search if the list is ordered until the &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;range of values to search is 3 or less.&lt;br/&gt;
     *&lt;/li&gt;
	&lt;li&gt;NOTE: We&apos;ve ensured that the IN list and the left all have&lt;/li&gt;
	&lt;li&gt;the same precedence at compile time.  If we don&apos;t enforce&lt;/li&gt;
	&lt;li&gt;the same precendence then we could get the wrong result&lt;/li&gt;
	&lt;li&gt;when doing a binary search.&lt;br/&gt;
     */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Ironically enough, this comment makes reference to the problem at hand here: if we don&apos;t enforce the correct precedence when comparing values, we can get wrong results.  The problem is that the &quot;NOTE&quot; in this comment is WRONG-&lt;del&gt;despite what it says, we actually did &lt;b&gt;NOT&lt;/b&gt; ensure that the IN list and the left operand had the same precedence at compile time.  Even if we assume that the preprocessing logic is correct, it doesn&apos;t actually &lt;b&gt;change&lt;/b&gt; the types of any of the IN-list values&lt;/del&gt;-so when we get to execution, the values &lt;b&gt;can&lt;/b&gt; in fact have different type precedences.  Because of this broken assumption, the rest of the code in DataType.in() fails in certain cases.&lt;/p&gt;

&lt;p&gt;As an example we can use the same T1 mentioned above, but this time let our query be the following:&lt;/p&gt;

&lt;p&gt;  select * from t1 where i in (2.8, 4.23)&lt;/p&gt;

&lt;p&gt;Notice that the IN-list values are already in sorted order and that, when truncated, &quot;2.8&quot; does NOT equal &quot;4.23&quot;--so the incorrect preprocessing described above will (accidentally) do the correct thing.  But now when we get to execution, we&apos;re going to search the IN list values for each of the values in T1&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  Since the left operand is INTEGER, all comparisons will be integer-based comparisons, meaning that they will use truncated versions of the decimal values.  So we&apos;ll see something like:&lt;/p&gt;

&lt;p&gt;  Search for &quot;1&quot;:&lt;/p&gt;

&lt;p&gt;    (1 == trunc(2.8))  --&amp;gt; (1 == 2) --&amp;gt; false (no match)&lt;br/&gt;
    (1 == trunc(4.23)) --&amp;gt; (1 == 4) --&amp;gt; false (no match)&lt;/p&gt;

&lt;p&gt;  Search for &quot;2&quot;:&lt;/p&gt;

&lt;p&gt;    (2 == trunc(2.8))  --&amp;gt; (2 == 2) --&amp;gt; true (MATCH &amp;#8211; which is WRONG)&lt;/p&gt;

&lt;p&gt;  Search for &quot;3&quot;:&lt;/p&gt;

&lt;p&gt;    (3 == trunc(2.8))  --&amp;gt; (3 == 2) --&amp;gt; false (no match)&lt;br/&gt;
    (3 == trunc(4.23)) --&amp;gt; (3 == 4) --&amp;gt; false (no match)&lt;/p&gt;

&lt;p&gt;  Search for &quot;4&quot;:&lt;/p&gt;

&lt;p&gt;    (4 == trunc(2.8))  --&amp;gt; (4 == 2) --&amp;gt; false (no match)&lt;br/&gt;
    (4 == trunc(4.23)) --&amp;gt; (4 == 4) --&amp;gt; true (MATCH &amp;#8211; which is WRONG)&lt;/p&gt;

&lt;p&gt;  Search for &quot;5&quot;:&lt;/p&gt;

&lt;p&gt;    (5 == trunc(2.8))  --&amp;gt; (5 == 2) --&amp;gt; false (no match)&lt;br/&gt;
    (5 == trunc(4.23)) --&amp;gt; (5 == 4) --&amp;gt; false (no match)&lt;/p&gt;

&lt;p&gt;Thus the query will return two rows when in fact it should return NONE.&lt;/p&gt;

&lt;p&gt;One final note here: when this issue was first created, the above query actually only returned 1 row, not two.  That was because Derby used to create an additional BETWEEN predicate for the IN-list, and that predicate eliminated the row for &quot;i == 2&quot; (because 2 is not between 2.8 and 4.23).  But the changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt; replaced the BETWEEN optimization with a multi-probe approach, thus further exposing (but not causing) the execution-time bug described here.  This is further backed up by the fact that even before &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt; the following query returned two rows, as well:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from t1 where i in (cast (2.8 as decimal(4, 2)), 4.23);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;br/&gt;
2&lt;br/&gt;
4&lt;/p&gt;

&lt;p&gt;2 rows selected  &lt;/p&gt;

&lt;p&gt;The reason is that the explict CAST disabled the BETWEEN optimization, thereby leading to the same situation as just outlined.&lt;/p&gt;</comment>
                            <comment id="12482959" author="army" created="Wed, 21 Mar 2007 23:20:55 +0000"  >&lt;p&gt;Posting d2256_v1.patch, which is a first attempt at a patch for this issue.  The general idea is to always make sure that IN-list comparisons are done with the &quot;dominant&quot; type when two values have different type precedences.  More specifically:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When determining the &quot;judge&quot; type in InListOperatorNode.preprocess(), iterate through&lt;br/&gt;
    all of the values to find out what the dominant type is, and then use that as the&lt;br/&gt;
    &quot;judge&quot; for sorting.  Prior to these changes we just used the type of the left operand&lt;br/&gt;
    as judge, but that was not correct (as mentioned in my previous comment).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The obvious downside to this approach is that we may have to iterate through a potentially&lt;br/&gt;
    large list of IN values in order to determine the dominant type.  I thought about leaving&lt;br/&gt;
    InListOpNode.preprocess() alone and adding new logic to ValueNodeList.sortInAscendingOrder()&lt;br/&gt;
    to account for different precedences, but it seemed to me like that wouldn&apos;t really save&lt;br/&gt;
    us anything and it is not as &quot;clean&quot; as the InListOpNode.preprocess() changes.&lt;/p&gt;

&lt;p&gt;    Of course I am open to suggestions if anyone disagrees here.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;At execution time (i.e. in DataType.in()), add logic to ensure that all search&lt;br/&gt;
    comparisons are done using the dominant type of the values being compared.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    An alternative here would have been to explicitly &lt;em&gt;cast&lt;/em&gt; the IN-list values to&lt;br/&gt;
    the dominant type during preprocessing, in which case we would have satisfied&lt;br/&gt;
    the original assumption in DataType.in() and thus no changes to that file would&lt;br/&gt;
    have been necessary.  But in the end I think it is quite a bit more costly to&lt;br/&gt;
    add CAST nodes to every IN value at compile time than it is to just do a&lt;br/&gt;
    precedence check at execution-time (which is what d2256_v1.patch does).&lt;/p&gt;

&lt;p&gt;    Again, I am willing to change this approach if anyone feels strongly about it.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added the test cases referenced in this Jira to the lang/inbetween.sql test.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I ran derbyall and suites.All on Red Hat Linux with ibm142 and saw no new failures. I think the changes are fairly contained and my hope is that the comments are sufficient, so if anyone is available for a review, that&apos;d be great... &lt;/p&gt;</comment>
                            <comment id="12484306" author="bryanpendleton" created="Tue, 27 Mar 2007 06:01:59 +0100"  >&lt;p&gt;Hi Army, the comments and explanation are great and they make a lot of sense.&lt;/p&gt;

&lt;p&gt;   select * from t1 where i in (4.23, 4); &lt;/p&gt;

&lt;p&gt;Did you consider having this query return an error? If the user provides a&lt;br/&gt;
floating point value for an integer column, wouldn&apos;t they prefer to have an&lt;br/&gt;
error message, rather than have the database quietly return zero rows?&lt;/p&gt;</comment>
                            <comment id="12484514" author="army" created="Tue, 27 Mar 2007 18:36:50 +0100"  >&lt;p&gt;&amp;gt; Did you consider having this query return an error? If the user provides a&lt;br/&gt;
&amp;gt; floating point value for an integer column, wouldn&apos;t they prefer to have an&lt;br/&gt;
&amp;gt; error message, rather than have the database quietly return zero rows?&lt;/p&gt;

&lt;p&gt;Well first I should point out that &quot;quietly return&lt;span class=&quot;error&quot;&gt;&amp;#91;ing&amp;#93;&lt;/span&gt; zero rows&quot; is not the correct behavior in the example you gave.  That&apos;s what Derby currently does (before the patch for this issue) but that is not correct.  The correct behavior is to return a single row matching the &quot;4&quot;.&lt;/p&gt;

&lt;p&gt;Given that, the question becomes &quot;Did you consider having this query return an error?&quot;  And this is a great question--thank you for bringing it up.&lt;/p&gt;

&lt;p&gt;The short answer is No, I didn&apos;t consider throwing an error--but that was just because it didn&apos;t occur to me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  The longer and more relevant answer is that, after looking at the SQL 2003 spec for IN lists, my own reading is that we should not throw an error in the example that you mentioned.  Here&apos;s why...(feel free to skip if you&apos;re not interested):&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;From SQL 2003 spec, 8.4 &amp;lt;in predicate&amp;gt; grammar shows:&lt;/p&gt;

&lt;p&gt;  &amp;lt;in predicate&amp;gt; ::= &amp;lt;row value predicand&amp;gt; &amp;lt;in predicate part 2&amp;gt;&lt;br/&gt;
  &amp;lt;in predicate part 2&amp;gt; ::= [ NOT ] IN &amp;lt;in predicate value&amp;gt;&lt;br/&gt;
  &amp;lt;in value list&amp;gt; ::= &amp;lt;row value expression&amp;gt; [ &lt;/p&gt;
{ &amp;lt;comma&amp;gt; &amp;lt;row value expression&amp;gt; }
&lt;p&gt;... ]&lt;br/&gt;
  &amp;lt;in predicate value&amp;gt; ::=&lt;br/&gt;
       &amp;lt;table subquery&amp;gt;&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &amp;lt;left paren&amp;gt; &amp;lt;in value list&amp;gt; &amp;lt;right paren&amp;gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Note that &amp;lt;in value list&amp;gt; in this grammar does not include parentheses. Now if we look at syntax Rule #2 in the same section, we see:&lt;/p&gt;

&lt;p&gt;&amp;lt;begin quote&amp;gt;&lt;/p&gt;

&lt;p&gt;  Let IVL be an &amp;lt;in value list&amp;gt;.&lt;/p&gt;

&lt;p&gt;    ( IVL )&lt;/p&gt;

&lt;p&gt;  is equivalent to the &amp;lt;table value constructor&amp;gt;:&lt;/p&gt;

&lt;p&gt;    ( VALUES IVL )&lt;/p&gt;

&lt;p&gt;&amp;lt;end quote&amp;gt;&lt;/p&gt;

&lt;p&gt;So if our example query is:&lt;/p&gt;

&lt;p&gt;  select * from t1 where i in (4.23, 4);&lt;/p&gt;

&lt;p&gt;then &amp;lt;in value list&amp;gt; is simply &quot;4.23, 4&quot;, and thus&lt;/p&gt;

&lt;p&gt;    ( IVL )  ==&amp;gt; ( 4.23, 4 )&lt;/p&gt;

&lt;p&gt;  is equivalent to the &amp;lt;table value constructor&amp;gt;:&lt;/p&gt;

&lt;p&gt;    ( VALUES 4.23, 4 )&lt;/p&gt;

&lt;p&gt;This particular VALUES clause is legal in Derby--i.e. we do not throw an error:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; values 4.23, 4;&lt;br/&gt;
1&lt;br/&gt;
---------------&lt;br/&gt;
4.23&lt;br/&gt;
4.00&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;/p&gt;

&lt;p&gt;The next question is whether or not Derby &lt;b&gt;should&lt;/b&gt; throw an error here.  The specs for a VALUES clause are given in section 7.3 as &quot;&amp;lt;table value constructor&amp;gt;&quot; and include the following:&lt;/p&gt;

&lt;p&gt; Section 7.3, Syntax Rule #4:&lt;/p&gt;

&lt;p&gt;  The row type of TVC is determined by applying Subclause 9.3, &quot;Data types of results&lt;br/&gt;
  of aggregations&quot;, to the row types &lt;span class=&quot;error&quot;&gt;&amp;#91;of the values in the list&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;If we go on to look at subclause 9.3 we see the following rule:&lt;/p&gt;

&lt;p&gt; Section 9.3, Syntax Rule #2:&lt;/p&gt;

&lt;p&gt;  All of the data types in DTS shall be comparable.&lt;/p&gt;

&lt;p&gt;In our example we have an integer column and a decimal value, and those two types are indeed comparable with each other.  So we satisfy rule #2 and therefore should not throw an error here.&lt;/p&gt;

&lt;p&gt;That said, we now go back to section 8.4 (IN predicate) and look at syntax rules #3 and #5, where we see the following:&lt;/p&gt;

&lt;p&gt;&amp;lt;begin quote&amp;gt;&lt;/p&gt;

&lt;p&gt; 3) Let RVC be the &amp;lt;row value predicand&amp;gt; and let IPV be the &amp;lt;in predicate value&amp;gt;.&lt;/p&gt;

&lt;p&gt; 5) The expression&lt;/p&gt;

&lt;p&gt;     RVC IN IPV&lt;/p&gt;

&lt;p&gt;    is equivalent to&lt;/p&gt;

&lt;p&gt;     RVC = ANY IPV&lt;/p&gt;

&lt;p&gt;&amp;lt;end quote&amp;gt;&lt;/p&gt;

&lt;p&gt;In our example RVC is the column &quot;i&quot; and IPV is &quot;(4.23, 4)&quot;.  So then we have:&lt;/p&gt;

&lt;p&gt;    i IN (4.23, 4)&lt;/p&gt;

&lt;p&gt;  is equivalent to&lt;/p&gt;

&lt;p&gt;    i = ANY (4.23, 4)&lt;/p&gt;

&lt;p&gt;Then if we use syntax rule #2 again, we end up with:&lt;/p&gt;

&lt;p&gt;    i = ANY (VALUES 4.23, 4)&lt;/p&gt;

&lt;p&gt;Putting that back into our original query we now have:&lt;/p&gt;

&lt;p&gt;   select * from t1 where i = any (values 4.23, 4);&lt;/p&gt;

&lt;p&gt;This latter query executes without error in Derby and returns 1 row (even before the patch for this issue is applied):&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from t1 where i = any (values 4.23, 4);&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;br/&gt;
4&lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;

&lt;p&gt;Since the type of the VALUES clause is decimal (section 9.3, rule #3), we are doing a comparison of an integer with a decimal.  Such a comparison should not throw an error and should only return true if the values are algebraically equal.  Thus the above query is correctly returning a single row--and that&apos;s what the equivalent IN list query should be doing, too.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Putting all of that together, my conclusion is that we should not throw an error if if the user specifies a decimal or floating point value for an integer column.  Whether or not the user would &quot;prefer&quot; an error I can&apos;t say, but standards-wise I think the correct thing is to compare using the dominant type and only return the rows that match.&lt;/p&gt;

&lt;p&gt;Feel free to comment if I&apos;ve overlooked something or otherwise misread the spec.  Spec-reading is &lt;b&gt;not&lt;/b&gt; one of my gifts...&lt;/p&gt;</comment>
                            <comment id="12484671" author="bryanpendleton" created="Wed, 28 Mar 2007 02:50:30 +0100"  >&lt;p&gt;I&apos;m sold!&lt;/p&gt;

&lt;p&gt;I see that while integer and decimal are compatible, there do exist other&lt;br/&gt;
types which are not compatible. For example:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; values 4.23, &apos;hot dog&apos;, 4;&lt;br/&gt;
ERROR 42X61: Types &apos;DECIMAL&apos; and &apos;CHAR&apos; are not UNION compatible.&lt;/p&gt;

&lt;p&gt;And therefore, sure enough:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from t1 where i in (4, 4.23, &apos;tomato&apos;);&lt;br/&gt;
ERROR 42818: Comparisons between &apos;INTEGER&apos; and &apos;CHAR&apos; are not supported.&lt;/p&gt;

&lt;p&gt;So I believe I&apos;m following along with your chain of reasoning and it seems sound to me.&lt;/p&gt;

&lt;p&gt;Thanks for taking the time to clarify the underlying mechanisms.&lt;/p&gt;</comment>
                            <comment id="12484931" author="army" created="Wed, 28 Mar 2007 18:09:06 +0100"  >&lt;p&gt;Thank you very much for the review and feedback, Bryan.  I committed d2256_v1.patch with svn # 523411:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=523411&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=523411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Marking this issue as resolved...&lt;/p&gt;</comment>
                            <comment id="12500255" author="army" created="Wed, 30 May 2007 23:58:00 +0100"  >&lt;p&gt;Attaching a simple release note for this issue.&lt;/p&gt;</comment>
                            <comment id="12501746" author="army" created="Wed, 6 Jun 2007 00:49:22 +0100"  >&lt;p&gt;Very slight tweak to the release note.&lt;/p&gt;</comment>
                            <comment id="12501993" author="army" created="Wed, 6 Jun 2007 18:09:18 +0100"  >&lt;p&gt;Fix is in trunk (10.3) and I haven&apos;t heard any objections to the release note, so closing.&lt;/p&gt;</comment>
                            <comment id="12505548" author="myrna" created="Sat, 16 Jun 2007 23:16:13 +0100"  >&lt;p&gt;scrubbed releasenote&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12354628">DERBY-2034</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12624466">DERBY-6017</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12353905" name="d2256_v1.patch" size="8733" author="army" created="Wed, 21 Mar 2007 23:20:54 +0000"/>
                            <attachment id="12353906" name="d2256_v1.stat" size="372" author="army" created="Wed, 21 Mar 2007 23:20:55 +0000"/>
                            <attachment id="12359945" name="releaseNote.html" size="4053" author="myrna" created="Sat, 16 Jun 2007 23:16:13 +0100"/>
                            <attachment id="12359006" name="releaseNote.html" size="4199" author="army" created="Wed, 6 Jun 2007 00:49:22 +0100"/>
                            <attachment id="12358582" name="releaseNote.html" size="4213" author="army" created="Wed, 30 May 2007 23:57:59 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 19 Jan 2007 06:06:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22969</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0pof:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37978</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>