<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:21:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3304/DERBY-3304.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3304] Explicit commit inside a java procedure makes a dynamic result sets passed out unavailable</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3304</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Repro (Main.java) that shows changed behavior after svn 602991&lt;br/&gt;
(the patch committed for this issue). It seems a regression: (originally from Dag H. Wanvik attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1585&quot; title=&quot;derbylang/procedureInTrigger: not able to create trigger due to an open ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1585&quot;&gt;&lt;del&gt;DERBY-1585&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;An explicit commit inside a stored procedure makes a dynamic result sets passed out unavailable, even if the commit is executed &lt;b&gt;prior&lt;/b&gt; to the result set; as in the repro.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12385785">DERBY-3304</key>
            <summary>Explicit commit inside a java procedure makes a dynamic result sets passed out unavailable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Jan 2008 16:26:08 +0000</created>
                <updated>Thu, 10 Jan 2013 10:35:36 +0000</updated>
                            <resolved>Thu, 6 Mar 2008 17:18:54 +0000</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12556933" author="djd" created="Tue, 8 Jan 2008 16:26:36 +0000"  >&lt;p&gt;Dag H. Wanvik originally attached this to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1585&quot; title=&quot;derbylang/procedureInTrigger: not able to create trigger due to an open ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1585&quot;&gt;&lt;del&gt;DERBY-1585&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12556941" author="djd" created="Tue, 8 Jan 2008 16:54:57 +0000"  >&lt;p&gt;I can&apos;t reproduce this problem, using Main.java I get::&lt;/p&gt;

&lt;p&gt;$ java -cp classes commitInProc.Main&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing with org.apache.derby.jdbc.EmbeddedDriver&lt;br/&gt;
Got: APP&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;which shows that the ResultSet is returned correctly. I was using IBM&apos;s 1.5 jvm.&lt;/p&gt;</comment>
                            <comment id="12556978" author="dagw" created="Tue, 8 Jan 2008 19:00:46 +0000"  >&lt;p&gt;Interesting. It seems to have been fixed as a side effect of 606106 which is for &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3037&quot; title=&quot;Language ResultSet.finish() is called even when the ResultSet is going to be re-used.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3037&quot;&gt;DERBY-3037&lt;/a&gt; (my sandbox wasn&apos;t up to date). &lt;br/&gt;
A comment there contains this piece of info which may be relevant:&lt;/p&gt;

&lt;p&gt;&amp;gt;  In order to achieve that, I have added following code in NoRowsResultSetImpl.close&lt;br/&gt;
&amp;gt;  to take care of the activation &lt;br/&gt;
&amp;gt;  + if (activation.isSingleExecution()) &lt;br/&gt;
&amp;gt;  + activation.close(); &lt;/p&gt;
</comment>
                            <comment id="12556987" author="djd" created="Tue, 8 Jan 2008 19:31:49 +0000"  >&lt;p&gt;Not sure how that code could be related, I modified the repro to use a PreparedStatement and continued to see the correct behaviour.&lt;/p&gt;</comment>
                            <comment id="12557476" author="dagw" created="Wed, 9 Jan 2008 23:25:26 +0000"  >&lt;p&gt;My preliminary analysis shows that the added code in svn 606106 does&lt;br/&gt;
indeed make the difference, but I am not convinced all is kosher, see&lt;br/&gt;
below.&lt;/p&gt;

&lt;p&gt;When the stored procedure (f2) commits, it leads to a call of&lt;br/&gt;
GenericLanguageConnectionContext#resetActivations, which in turn leads&lt;br/&gt;
to a call to CallStatementResultSet#close. At this point the dynamic&lt;br/&gt;
result set has not yet been constructed.&lt;/p&gt;

&lt;p&gt;Here is the call stack (line numbers correspond to svn 606106).&lt;br/&gt;
Interestingly, CallStatementResultSet#close is called as part of&lt;br/&gt;
CallStatementResultSet#open... Is this correct?&lt;/p&gt;

&lt;p&gt;   org.apache.derby.impl.sql.execute.NoRowsResultSetImpl.close(NoRowsResultSetImpl.java:393)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.CallStatementResultSet.close(CallStatementResultSet.java:108)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.BaseActivation.reset(BaseActivation.java:312)&lt;br/&gt;
   org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.resetActivations(GenericLanguageConnectionContext.java:2764)&lt;br/&gt;
   org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.doCommit(GenericLanguageConnectionContext.java:1113)&lt;br/&gt;
   org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.userCommit(GenericLanguageConnectionContext.java:991)&lt;br/&gt;
   org.apache.derby.impl.jdbc.TransactionResourceImpl.commit(TransactionResourceImpl.java:237)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedConnection.commit(EmbedConnection.java:1202)&lt;br/&gt;
   commitInProc.Main.f2(Main.java:95)&lt;br/&gt;
   org.apache.derby.exe.ac601a400fx0117x605dx1c0ex0000003d76c00.g0&lt;br/&gt;
   sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java)&lt;br/&gt;
   sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
   sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
   java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
   org.apache.derby.impl.services.reflect.ReflectMethod.invoke(ReflectMethod.java:46)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.CallStatementResultSet.open(CallStatementResultSet.java:74)&lt;br/&gt;
   org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:370)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1234)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:624)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:556)&lt;br/&gt;
   commitInProc.Main.doSingleDriver(Main.java:58)&lt;br/&gt;
   commitInProc.Main.main(Main.java:83)&lt;/p&gt;


&lt;p&gt;Now, this close leads to &lt;b&gt;another&lt;/b&gt; recursive call to&lt;br/&gt;
CallStatementResultSet.close, but this time isOpen is false, so&lt;br/&gt;
NoRowsResultSetImpl.close returns immediately. At this point we have&lt;br/&gt;
CallStatementResultSet#open, #close and #close(frame 2!) on the stack.&lt;/p&gt;

&lt;p&gt;   org.apache.derby.impl.sql.execute.NoRowsResultSetImpl.close(NoRowsResultSetImpl.java:334)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.CallStatementResultSet.close(CallStatementResultSet.java:108)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.BaseActivation.reset(BaseActivation.java:312)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.BaseActivation.close(BaseActivation.java:346)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.NoRowsResultSetImpl.close(NoRowsResultSetImpl.java:396)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.CallStatementResultSet.close(CallStatementResultSet.java:108)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.BaseActivation.reset(BaseActivation.java:312)&lt;br/&gt;
   org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.resetActivations(GenericLanguageConnectionContext.java:2764)&lt;br/&gt;
   org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.doCommit(GenericLanguageConnectionContext.java:1113)&lt;br/&gt;
   org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.userCommit(GenericLanguageConnectionContext.java:991)&lt;br/&gt;
   org.apache.derby.impl.jdbc.TransactionResourceImpl.commit(TransactionResourceImpl.java:237)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedConnection.commit(EmbedConnection.java:1202)&lt;br/&gt;
   commitInProc.Main.f2(Main.java:95)&lt;br/&gt;
   org.apache.derby.exe.ac601a400fx0117x605dx1c0ex0000003d76c00.g0&lt;br/&gt;
   sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java)&lt;br/&gt;
   sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
   sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
   java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
   org.apache.derby.impl.services.reflect.ReflectMethod.invoke(ReflectMethod.java:46)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.CallStatementResultSet.open(CallStatementResultSet.java:74)&lt;br/&gt;
   org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:370)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1234)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:624)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:556)&lt;br/&gt;
   commitInProc.Main.doSingleDriver(Main.java:58)&lt;br/&gt;
    commitInProc.Main.main(Main.java:83)&lt;/p&gt;

&lt;p&gt;No dynamic result set is closed here since none has yet been&lt;br/&gt;
constructed. Anyway, next, as part of the commit call chain, the&lt;br/&gt;
activation of the call statement is also closed.&lt;/p&gt;

&lt;p&gt;Now, &lt;b&gt;before&lt;/b&gt; svn 606106, the activation for the call statement is&lt;br/&gt;
closed later; as shown here (numbers correspond to svn 606105):&lt;/p&gt;

&lt;p&gt;   org.apache.derby.impl.sql.execute.CallStatementResultSet.close(CallStatementResultSet.java:149)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.BaseActivation.reset(BaseActivation.java:312)&lt;br/&gt;
   org.apache.derby.impl.sql.execute.BaseActivation.close(BaseActivation.java:346)&lt;br/&gt;
   org.apache.derby.impl.sql.GenericActivationHolder.close(GenericActivationHolder.java:463)&lt;br/&gt;
   org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:397)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1234)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:624)&lt;br/&gt;
   org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:556)&lt;br/&gt;
   commitInProc.Main.doSingleDriver(Main.java:58)&lt;br/&gt;
   commitInProc.Main.main(Main.java:83)&lt;/p&gt;

&lt;p&gt;At line 149 of CallStatementResultSet, the dynamic result set is&lt;br/&gt;
closed and is thus unavailable. &lt;/p&gt;

&lt;p&gt;But after &lt;b&gt;606106&lt;/b&gt;, the activation has already been closed &lt;b&gt;before&lt;/b&gt;&lt;br/&gt;
the dynamic result set is assigned, so the dynamic result set is not&lt;br/&gt;
closed as part of closing the activation when the call to f2 finishes&lt;br/&gt;
and is thus available!&lt;/p&gt;

&lt;p&gt;Not sure what to make of all this, but it seems weird that the commit&lt;br/&gt;
should close the CallStatementResultSet when is in the process of&lt;br/&gt;
being opened. Also, the fact that the commit closes the activation of&lt;br/&gt;
the call statement looks wrong&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="12557480" author="djd" created="Wed, 9 Jan 2008 23:42:15 +0000"  >&lt;p&gt;Nice findings!&lt;/p&gt;

&lt;p&gt;&amp;gt; Interestingly, CallStatementResultSet#close is called as part of&lt;br/&gt;
&amp;gt; CallStatementResultSet#open... Is this correct? &lt;/p&gt;

&lt;p&gt; I think it is confusing. Language result sets that do not return rows tend to do this because all of their work is performed in the open(), thus to free up any resources their open() call also calls close().  Now since the close will be called from some external source anyway, I think it would be cleaner if the open-close cycle was driven from the outside and not from within the open.&lt;/p&gt;

&lt;p&gt;From what you have found, it looks like a CallStatementResultSet  should always be held across commits, though since that logic is applied to result sets that return rows, I don&apos;t know what real effect it would have here.&lt;/p&gt;</comment>
                            <comment id="12557483" author="djd" created="Wed, 9 Jan 2008 23:53:30 +0000"  >&lt;p&gt;Since holdability is at the activation, not the result set, I wonder if this would make sense in CallStatementResultSet&apos;s constructor?&lt;/p&gt;

&lt;p&gt;  a.setResultSetHoldability(true);&lt;/p&gt;</comment>
                            <comment id="12557829" author="dagw" created="Thu, 10 Jan 2008 22:40:46 +0000"  >&lt;p&gt;Tried this, but it is not sufficient, it seems..&lt;br/&gt;
BaseActivation.reset will close the result set even if holdability is true, cf. this line:&lt;/p&gt;

&lt;p&gt;			if (!resultSetHoldability || !resultSet.returnsRows()) {			&lt;br/&gt;
				// would really like to check if it is open,&lt;br/&gt;
				// this is as close as we can approximate that.&lt;br/&gt;
				resultSet.close();&lt;/p&gt;

&lt;p&gt;Since CallStatementResultSet extends NoRowsResultSetImpl, the call to resultSet.returnsRows() returns false, so the second condition holds, and close ensues. NoRowsResultSetImpl#returnsRows is final so CallStatementResultSet can&apos;t really override it. I tried it though, by removing the final, but then I get an assert error since EmbedStatement#executeStatement, which also calls ResultSet#returnsRows will now try to create a result set (line 1249 in EmbedStatement.java). Which is reasonable &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;br/&gt;
Maybe the test in BaseActivation.reset can test for CallStatementResultSet? Not OO, though..Thinking aloud, maybe a new interface method of ResultSet: canReturnDynamicResultSet?&lt;/p&gt;</comment>
                            <comment id="12560264" author="mamtas" created="Fri, 18 Jan 2008 07:28:30 +0000"  >&lt;p&gt;i will investigate more into this.&lt;/p&gt;</comment>
                            <comment id="12561389" author="mamtas" created="Tue, 22 Jan 2008 17:42:08 +0000"  >&lt;p&gt;Following seems to say that CallStatementResultSet#open makes a direct call to CallStatementResultSet#close but that is not true. When I check the code for CallStatementResultSet#open, I do not see a call to close method. The call to close from open does happen in MiscResultSet#open but that ResultSet does not come into play when dealing with CallStatementResultSet. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;
			&lt;ul&gt;
				&lt;li&gt;
				&lt;ul&gt;
					&lt;li&gt;
					&lt;ul&gt;
						&lt;li&gt;
						&lt;ul&gt;
							&lt;li&gt;
							&lt;ul&gt;
								&lt;li&gt;
								&lt;ul&gt;
									&lt;li&gt;
									&lt;ul&gt;
										&lt;li&gt;
										&lt;ul&gt;
											&lt;li&gt;
											&lt;ul&gt;
												&lt;li&gt;
												&lt;ul&gt;
													&lt;li&gt;
													&lt;ul&gt;
														&lt;li&gt;
														&lt;ul&gt;
															&lt;li&gt;
															&lt;ul&gt;
																&lt;li&gt;
																&lt;ul&gt;
																	&lt;li&gt;
																	&lt;ul&gt;
																		&lt;li&gt;
																		&lt;ul&gt;
																			&lt;li&gt;
																			&lt;ul&gt;
																				&lt;li&gt;
																				&lt;ul&gt;
																					&lt;li&gt;
																					&lt;ul&gt;
																						&lt;li&gt;
																						&lt;ul&gt;
																							&lt;li&gt;
																							&lt;ul&gt;
																								&lt;li&gt;
																								&lt;ul&gt;
																									&lt;li&gt;
																									&lt;ul&gt;
																										&lt;li&gt;
																										&lt;ul&gt;
																											&lt;li&gt;
																											&lt;ul&gt;
																												&lt;li&gt;&lt;p&gt;&amp;gt; Interestingly, CallStatementResultSet#close is called as part of &lt;br/&gt;
&amp;gt; CallStatementResultSet#open... Is this correct? &lt;/p&gt;&lt;/li&gt;
																											&lt;/ul&gt;
																											&lt;/li&gt;
																										&lt;/ul&gt;
																										&lt;/li&gt;
																									&lt;/ul&gt;
																									&lt;/li&gt;
																								&lt;/ul&gt;
																								&lt;/li&gt;
																							&lt;/ul&gt;
																							&lt;/li&gt;
																						&lt;/ul&gt;
																						&lt;/li&gt;
																					&lt;/ul&gt;
																					&lt;/li&gt;
																				&lt;/ul&gt;
																				&lt;/li&gt;
																			&lt;/ul&gt;
																			&lt;/li&gt;
																		&lt;/ul&gt;
																		&lt;/li&gt;
																	&lt;/ul&gt;
																	&lt;/li&gt;
																&lt;/ul&gt;
																&lt;/li&gt;
															&lt;/ul&gt;
															&lt;/li&gt;
														&lt;/ul&gt;
														&lt;/li&gt;
													&lt;/ul&gt;
													&lt;/li&gt;
												&lt;/ul&gt;
												&lt;/li&gt;
											&lt;/ul&gt;
											&lt;/li&gt;
										&lt;/ul&gt;
										&lt;/li&gt;
									&lt;/ul&gt;
									&lt;/li&gt;
								&lt;/ul&gt;
								&lt;/li&gt;
							&lt;/ul&gt;
							&lt;/li&gt;
						&lt;/ul&gt;
						&lt;/li&gt;
					&lt;/ul&gt;
					&lt;/li&gt;
				&lt;/ul&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; I think it is confusing. Language result sets that do not return rows tend to do this because all of their work is performed in the open(), thus to free up any resources their open() call also calls close(). Now since the close will be called from some external source anyway, I think it would be cleaner if the open-close cycle was driven from the outside and not from within the open. &lt;br/&gt;
*****************************&lt;/p&gt;</comment>
                            <comment id="12561435" author="mamtas" created="Tue, 22 Jan 2008 19:36:40 +0000"  >&lt;p&gt;I added a junit test case for the test case provided by Dag to this Jira entry. The changes went into the trunk as part of revision 614292. The commit comments were as follows&lt;/p&gt;

&lt;p&gt;Adding a junit test for the standalone test case provided by Dag for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3304&quot; title=&quot;Explicit commit inside a java procedure makes a dynamic result sets passed out unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3304&quot;&gt;&lt;del&gt;DERBY-3304&lt;/del&gt;&lt;/a&gt;. Here, we are adding a Java procedure which does a commit and then returns a resultset back to the caller. The resultset should not get closed as part of the commit.&lt;/p&gt;</comment>
                            <comment id="12561565" author="dagw" created="Wed, 23 Jan 2008 02:48:51 +0000"  >&lt;p&gt;I meant only that CallStatementResultSet#close is called (indirectly) from CallStatementResultSet#open (see stack trace in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3304?focusedCommentId=12557476#action_12557476&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-3304?focusedCommentId=12557476#action_12557476&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="12561582" author="mamtas" created="Wed, 23 Jan 2008 05:26:53 +0000"  >&lt;p&gt;Sorry for misinterpreting your comment, Dag. You are right, in this specific test case, where there is a commit inside the java stored procedure, close is getting called on CallStatementResultSet which is just getting opened. I think work on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3037&quot; title=&quot;Language ResultSet.finish() is called even when the ResultSet is going to be re-used.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3037&quot;&gt;DERBY-3037&lt;/a&gt; will help resolve this issue too. In &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3037&quot; title=&quot;Language ResultSet.finish() is called even when the ResultSet is going to be re-used.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3037&quot;&gt;DERBY-3037&lt;/a&gt;, we have an example of Java Stored routine which is a function, which also does a commit inside it. And that commit causes the resultset that will be returned by the function to close.  I am hoping to get some pointers on how to recognize which resultsets should be closed and which should be left often.&lt;/p&gt;</comment>
                            <comment id="12565435" author="mamtas" created="Mon, 4 Feb 2008 17:53:42 +0000"  >&lt;p&gt;Based on the research/comments on this issue and Dan&apos;s comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3037&quot; title=&quot;Language ResultSet.finish() is called even when the ResultSet is going to be re-used.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3037&quot;&gt;DERBY-3037&lt;/a&gt; &quot;What is the purpose of commit() closing the language result sets? If it&apos;s to close JDBC ResultSets that are marked close at commit then a possibility is to only close language result sets that return rows (returnRows() returns true). That would leave language result sets that do not return rows open, but by definition (I think) those are the ones that are actively executing and the very ones we don&apos;t want to close. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &quot;, I thought of keeping the language resultsets that do not return rows open when BaseActivation.reset() is trying to decide what resultsets to close. This will ensure that we do not close the CallStatementResultSet(since it does not return rows) while it is still being constructed when the java procedure issues commit/rollback. The change involved is as follows&lt;br/&gt;
$ svn stat -q&lt;br/&gt;
M      java\engine\org\apache\derby\impl\sql\execute\BaseActivation.java&lt;br/&gt;
$ svn diff&lt;br/&gt;
Index: java/engine/org/apache/derby/impl/sql/execute/BaseActivation.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; java/engine/org/apache/derby/impl/sql/execute/BaseActivation.java   (revision 617013)&lt;br/&gt;
+++ java/engine/org/apache/derby/impl/sql/execute/BaseActivation.java   (working copy)&lt;br/&gt;
@@ -334,7 +334,8 @@&lt;br/&gt;
        {&lt;br/&gt;
                // if resultset holdability after commit is false, close it&lt;br/&gt;
                if (resultSet != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!resultSetHoldability || !resultSet.returnsRows()) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+                       //Do not close resultsets that do not return any rows.&lt;br/&gt;
+                       if ((!resultSetHoldability &amp;amp;&amp;amp; resultSet.returnsRows()==true)){&lt;br/&gt;
                                // would really like to check if it is open,&lt;br/&gt;
                                // this is as close as we can approximate that.&lt;br/&gt;
                                resultSet.close();&lt;/p&gt;

&lt;p&gt;So, as can be seen from diff above, rather than always closing the resultsets that do not return rows, we want to leave them alone. &lt;/p&gt;

&lt;p&gt;This works good for CallStatementResultSet but this is causing a problem for DML like update for instance below. &lt;/p&gt;

&lt;p&gt;The following ij script demonstrates the problem with the patch. The script creates 2 tables with foreign key relationship. Then it tries to violate the foreign key by doing an update. With my changes, Derby fails to generate any statistics for update. This is because the statistics collection happens in the language resultset close method but since with my patch, we do not close the resultset if it does not return row, we do not get a chance to collect the statistics. Without my patch, the statistics get collected in language resultset close which is called by BaseActivation.reset &lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:c:/dellater/db;create=true&apos;;&lt;br/&gt;
drop table basic;&lt;br/&gt;
drop table p;&lt;br/&gt;
create table p (ccharForBitData char(1) for bit data not null, unindexed smallint, cchar char(10) not null, &lt;br/&gt;
		constraint pk1 primary key (cchar, ccharForBitData));&lt;br/&gt;
insert into p values (x&apos;22&apos;, 33, &apos;22&apos;);&lt;br/&gt;
create table basic (cint int, cchar char(10),  ccharForBitData char(1) for bit data, unindexed int);&lt;br/&gt;
insert into basic values (22, &apos;22&apos;, x&apos;22&apos;, 22);&lt;br/&gt;
alter table basic add constraint fk1 foreign key (cchar, ccharForBitData) references p;&lt;br/&gt;
maximumdisplaywidth 2000;&lt;br/&gt;
call SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS(1);&lt;br/&gt;
update p set ccharForBitData = x&apos;22&apos;, cchar = CAST(unindexed as CHAR(10));&lt;br/&gt;
values SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS();&lt;/p&gt;

&lt;p&gt;To avoid this statistics collection problem, we could change language resultset close criteria in BaseActivation.reset to follow Dag&apos;s suggestion &quot;Maybe the test in BaseActivation.reset can test for CallStatementResultSet?&apos; but like Dag said, &quot;Not OO, though&quot;. Will like to hear if anyone has any comments?&lt;/p&gt;</comment>
                            <comment id="12565446" author="djd" created="Mon, 4 Feb 2008 18:10:32 +0000"  >&lt;p&gt;+                       //Do not close resultsets that do not return any rows.&lt;br/&gt;
+                       if ((!resultSetHoldability &amp;amp;&amp;amp; resultSet.returnsRows()==true)){&lt;/p&gt;

&lt;p&gt;Minor comment, but I think this code would be a lot easier for future readers to understand if the &quot;double negative&quot; comment was switched into a positive comment.&lt;br/&gt;
I.e. the comment should state what the desired behaviour is, not what you don&apos;t want to happen.&lt;br/&gt;
Then switching the order of the tests around, would make the code more naturally follow the comment.&lt;/p&gt;

&lt;p&gt;  // Close result sets that return rows and are not held across commit. This is to implement&lt;br/&gt;
  // closing JDBC result sets that are CLOSE_CURSOR_ON_COMMIT at commit time.&lt;br/&gt;
  if (resultSet.returnsRows() &amp;amp;&amp;amp; !resultSetHoldability)&lt;/p&gt;




</comment>
                            <comment id="12565471" author="djd" created="Mon, 4 Feb 2008 19:02:09 +0000"  >&lt;p&gt;I think the issue with the statistics is that functionality is being implemented in the incorrect location.&lt;/p&gt;

&lt;p&gt;Activation.reset() states that its role is to reset the activation for future executions. Using Activation.reset() to implement closing open JDBC result sets on a commit() just seems the wrong approach. Having an explicit method for commit that performed the close of a result set as required would be cleaner. Then Activation.reset() could have a clear purpose.&lt;/p&gt;

&lt;p&gt;Longer term the fix to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2485&quot; title=&quot;Add OO callback scheme for transaction commit &amp;amp; rollback at LanguageConnectionContext layer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2485&quot;&gt;DERBY-2485&lt;/a&gt; would address this as then a result set that needed to be closed upon commit would simply register itself with the transaction manager such that it received notification of a commit.&lt;/p&gt;</comment>
                            <comment id="12565649" author="mamtas" created="Tue, 5 Feb 2008 05:46:34 +0000"  >&lt;p&gt;I agree that Activation.reset should be able to just close the resultset associated with it without having to look at holdability or returnsRows() method. This functionality of looking at holdability and returnsRows should be implemented separately. I will work on cleaning up code for Activation.reset and putting the functionality required by commit in the appropriate method.&lt;/p&gt;</comment>
                            <comment id="12565901" author="mamtas" created="Tue, 5 Feb 2008 21:57:25 +0000"  >&lt;p&gt;Committed changes into trunk with revision 618788. The commit comments were as follows&lt;/p&gt;

&lt;p&gt;***********************************************&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3304&quot; title=&quot;Explicit commit inside a java procedure makes a dynamic result sets passed out unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3304&quot;&gt;&lt;del&gt;DERBY-3304&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This commit addresses two issues. First of all, it cleanups up reset method in BaseActivation which was doing more than just bringing the Activation back to pre-execution state. The method had to make itself aware of holdability and what kind of resultset it was dealing with before closing or clearing the row of the resultset. The reason for this behavior is commit code path was relying on Activation.reset to do more than just bringing the activation to pre-execution state. I fixed this by moving this code from BaseActivation.reset to GenericLanguageConnectionContext.resetActivations.&lt;/p&gt;

&lt;p&gt;Additionally, in the new code in GenericLanguageConnectionContext.resetActivations, I added the code to not close the language result sets associated with activations that do not return rows even if activation may have holdability set to false. This will ensure that a commit inside a java procedure will not inadvertantly close the resultset associated with the java procedure call.&lt;br/&gt;
***********************************************&lt;/p&gt;

&lt;p&gt;I ran the Junit tests and derbyall on my Windows XP machine with jdk1.6 and saw no new failures.&lt;/p&gt;

&lt;p&gt;As part of my committing the changes for this jira entry, I copied some of the cleanup work(as shown below) from BaseActivation.reset into new code in GenericLanguageConnectionContext.resetActivations&lt;br/&gt;
		a.clearHeapConglomerateController();&lt;br/&gt;
		if (!a.isSingleExecution())&lt;br/&gt;
			a.clearWarnings();&lt;/p&gt;

&lt;p&gt;This code was always getting executed at the time of commit before my commit and because of that, I decided to copy it in GenericLanguageConnectionContext.resetActivations If anyone has any comments on this, please let me know.&lt;/p&gt;
</comment>
                            <comment id="12565902" author="mamtas" created="Tue, 5 Feb 2008 21:57:53 +0000"  >&lt;p&gt;I will work on migrating this change into 10.3 codeline&lt;/p&gt;</comment>
                            <comment id="12565921" author="djd" created="Tue, 5 Feb 2008 22:44:17 +0000"  >&lt;p&gt;I think that revision 618788 makes this code in resetActivations() unnecessary. It was used to force held cursors into non-held state to be closed on rollback() in Activation.reset(), since reset() used to check the holdability. Your change is good in that it removes this link between two methods that should be independent of each other (ie. resetActivations() should not have had internal knowledge of what reset() was doing). &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;			/*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;andClose true means we are here for rollback.&lt;/li&gt;
		&lt;li&gt;In case of rollback, we don&apos;t care for holding&lt;/li&gt;
		&lt;li&gt;cursors and that&apos;s why I am resetting holdability&lt;/li&gt;
		&lt;li&gt;to false for all activations just before rollback&lt;br/&gt;
			*/	&lt;br/&gt;
			if (andClose)&lt;br/&gt;
				a.setResultSetHoldability(false);&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Now (and to some extent before the change) the javadoc for resetActivations() is incorrect, in addition the method name is misleading. It would be good to clean this up.&lt;/p&gt;</comment>
                            <comment id="12565924" author="djd" created="Tue, 5 Feb 2008 22:46:15 +0000"  >&lt;p&gt;Even the &apos;andClose&apos; parameter of resetActivations is misleading, it means forRollback (I think this was true before 618788)&lt;/p&gt;</comment>
                            <comment id="12566033" author="mamtas" created="Wed, 6 Feb 2008 06:35:37 +0000"  >&lt;p&gt;The commit comments for 618788 did not include the bit about why I added following to GenericLanguageConnectionContext.resetActivations &lt;br/&gt;
a.clearHeapConglomerateController(); &lt;br/&gt;
if (!a.isSingleExecution()) &lt;br/&gt;
a.clearWarnings(); &lt;/p&gt;

&lt;p&gt;Because of this, I (Andrew changed it for me since I kept getting errors while using svn propedit --revprop -r 618788 svn:log) changed the commit comments for 618788 to read as follows&lt;/p&gt;

&lt;p&gt;************************&lt;b&gt;start of new commit comments associated with revision 618788&lt;/b&gt;****************************&lt;br/&gt;
This commit addresses two issues.&lt;/p&gt;

&lt;p&gt;First of all, it cleanups up reset method in BaseActivation which was doing more than just bringing the Activation back to pre-execution state. The method had to make itself aware of holdability and what kind of resultset it was dealing with before closing or clearing the row of the resultset. The reason for this behavior is commit code path was relying on Activation.reset to do more than just bringing the activation to pre-execution state.  I fixed this by moving this code from BaseActivation.reset to GenericLanguageConnectionContext.resetActivations.&lt;/p&gt;

&lt;p&gt;Additionally, in the new code in GenericLanguageConnectionContext.resetActivations, I added the code to not close the  language result sets associated with activations that do not return rows even if activation may have holdability set to  false. This will ensure that a commit inside a java procedure will not inadvertantly close the resultset associated with the java procedure call. Additionally, I copied some of the cleanup work(as shown below) from BaseActivation.reset into new code in GenericLanguageConnectionContext.resetActivations&lt;br/&gt;
   a.clearHeapConglomerateController();&lt;br/&gt;
   if (!a.isSingleExecution())&lt;br/&gt;
      a.clearWarnings();&lt;/p&gt;

&lt;p&gt;This code above was always getting executed at the time of commit before my commit and because of that, I decided to copy it in GenericLanguageConnectionContext.resetActivations. If anyone has any comments on this, please let me know.&lt;br/&gt;
************************&lt;b&gt;end of new commit comments associated with revision 618788&lt;/b&gt;****************************&lt;/p&gt;</comment>
                            <comment id="12566034" author="mamtas" created="Wed, 6 Feb 2008 06:42:08 +0000"  >&lt;p&gt;I need to admit that I do not completely understand why BaseActivation.reset() has following code&lt;br/&gt;
		updateHeapCC = null;&lt;br/&gt;
		// REMIND: do we need to get them to stop input as well?&lt;/p&gt;

&lt;p&gt;		if (!isSingleExecution())&lt;br/&gt;
			clearWarnings();&lt;/p&gt;

&lt;p&gt;But since this piece of code was getting exectued for an activation at the time of commit, I decided to copy similar code in GenericLanguageConnectionContext.resetActivations since a commit code path now is not going to goto BaseActivation.reset(). &lt;/p&gt;

&lt;p&gt;Would appreciate if someone knows more about this code and can share if this piece of code is needed at the time of commit or not. I &lt;b&gt;quickly&lt;/b&gt; looked at JDBC Connection,commit api and did not see anything about clearing the warnings at the time of commit. So, maybe we do not need to clear the warnings in GenericLanguageConnectionContext.resetActivations when a commit is executed. I am even more unclear about the purpose of a.clearHeapConglomerateController(); at the time of commit. But I copied it just to be on the safe side so that we execute the same set of code as before my checkin.&lt;/p&gt;

&lt;p&gt;Does anyone have any insight into whether or not this code is needed at commit time?&lt;/p&gt;</comment>
                            <comment id="12566040" author="mamtas" created="Wed, 6 Feb 2008 07:03:11 +0000"  >&lt;p&gt;Since we do not reset the activations at the time of commit, the name of the method, resetActivations() in GenericLanguageConnectionContext is misleading. I am not too creative with names but I am thinking of changing the name resetActivations to activationRelatedCleanup. If anyone has any other suggestion for the name change, please let me know.&lt;/p&gt;

&lt;p&gt;In addition, i am changing the javadoc for resetActivations to reflect what it is really doing. The new javadoc comments that I am planning to have are as follows&lt;br/&gt;
	/**&lt;br/&gt;
		If we are called as part of rollback code path, then we will reset all &lt;br/&gt;
		the activations. &lt;/p&gt;

&lt;p&gt;		If we are called as part of commit code path, then we will do one of &lt;br/&gt;
		the following if the activation has resultset assoicated with it&lt;br/&gt;
		1)Close result sets that return rows and are not held across commit.&lt;br/&gt;
		2)Clear the current row of the resultsets that return rows and are&lt;br/&gt;
		held across commit.&lt;br/&gt;
		3)Leave the result sets untouched if they do not return rows&lt;/p&gt;

&lt;p&gt;		Additionally, clean up (close()) activations that have been&lt;br/&gt;
		marked as unused during statement finalization.&lt;/p&gt;

&lt;p&gt;		@exception StandardException thrown on failure&lt;br/&gt;
	 */&lt;/p&gt;

&lt;p&gt;In addition, I am checking to see if following code can be removed from resetActivations&lt;br/&gt;
/* &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;andClose true means we are here for rollback.&lt;/li&gt;
		&lt;li&gt;In case of rollback, we don&apos;t care for holding&lt;/li&gt;
		&lt;li&gt;cursors and that&apos;s why I am resetting holdability&lt;/li&gt;
		&lt;li&gt;to false for all activations just before rollback&lt;br/&gt;
*/ &lt;br/&gt;
if (andClose) &lt;br/&gt;
a.setResultSetHoldability(false); &lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12566168" author="djd" created="Wed, 6 Feb 2008 15:53:01 +0000"  >&lt;p&gt;mamta&amp;gt; I am thinking of changing the name resetActivations to activationRelatedCleanup.&lt;/p&gt;

&lt;p&gt;The purpose of the method is to handle (process?) activations at end transaction time, thus maybe something like:&lt;/p&gt;

&lt;p&gt;  endTransactionActivationHandling&lt;/p&gt;</comment>
                            <comment id="12566169" author="djd" created="Wed, 6 Feb 2008 15:56:54 +0000"  >&lt;p&gt;Thanks for the info about the moved code, I missed it in the jira comment.&lt;/p&gt;

&lt;p&gt;I think the clearing of warnings on commit can go, as you say it&apos;s not required for a commit. I looked at it and think it has the potential to incorrectly clear warnings so that the application never sees them. I don&apos;t think there&apos;s a code path today that is subject to the bug, but one could appear in the future. So I&apos;d say remove the clearing of warnings since it&apos;s not required and a no-op at the moment.&lt;/p&gt;

&lt;p&gt;For the update conglomerate clearing, I think that&apos;s code that is in the wrong location, probably should be in the result set that set that field. That&apos;s probably a separate issue.&lt;/p&gt;</comment>
                            <comment id="12566199" author="mamtas" created="Wed, 6 Feb 2008 17:00:31 +0000"  >&lt;p&gt;Dan, thanks for your feedback. &lt;/p&gt;

&lt;p&gt;I will work on renaming the method and removing the clear warning code from the commit path. &lt;/p&gt;

&lt;p&gt;What I am not sure about is update conglomerate clearing. You suggested that it can be taken up as a separate issue. Does that mean that for now(until we address that new jira entry), we should continue to do update conglomerate clearing at the time of commit?&lt;/p&gt;</comment>
                            <comment id="12566453" author="mamtas" created="Thu, 7 Feb 2008 05:56:32 +0000"  >&lt;p&gt;After re-reading Dan&apos;s comment about update conglomerate clearing, I think Dan is suggesting that we leave the update conglomerate clearing code as it is for now and tackle that as a separate jira entry. Based on this and other comments, I have just commited changes into trunk which will take care of removing the clear warning code in the commit code path, fix the javadoc for resetActivations, rename resetActivations and remove the holdability false setting for activations at the time rollback code path. These changes went in as revision 619279. I will merge 619279 and 618788 into 10.3 codeline. I will also see if I can add some more testing for these changes.&lt;/p&gt;</comment>
                            <comment id="12566482" author="mamtas" created="Thu, 7 Feb 2008 07:47:08 +0000"  >&lt;p&gt;Created jira entry &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3396&quot; title=&quot;At the end transaction time(through commit/rollback), is clearing of the conglomerate (used for scans for update and delete) for an activation happening in the right place?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3396&quot;&gt;DERBY-3396&lt;/a&gt;(At the end transaction time(through commit/rollback), is clearing of the conglomerate (used for scans for update and delete) for an activation happening in the right place?) for the issue discovered while working on the current jira entry.&lt;/p&gt;</comment>
                            <comment id="12566928" author="mamtas" created="Fri, 8 Feb 2008 06:17:50 +0000"  >&lt;p&gt;Made some code cleanup changes into GenericLanguageConnectionContext.endTransactionActivationHandling  This will make code easier to understand and maintain. The changes went as part of revision 619772 into trunk.&lt;/p&gt;</comment>
                            <comment id="12568817" author="mamtas" created="Thu, 14 Feb 2008 06:34:42 +0000"  >&lt;p&gt;Added a junit test case for number of code changes for transaction ending time that went in as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3304&quot; title=&quot;Explicit commit inside a java procedure makes a dynamic result sets passed out unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3304&quot;&gt;&lt;del&gt;DERBY-3304&lt;/del&gt;&lt;/a&gt;. This new test will check those code changes for specific case of rollback inside a java procedure call. The test went into trunk(revision 627673) and 10.3 codeline(revision 627674). &lt;/p&gt;

&lt;p&gt;The test case runs in embedded mode to show the correct behavior for rollback inside a java procedure causing all the resultsets to close. The test case for now has been commented out for network server mode and it should be enabled when &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3414&quot; title=&quot;In Network server, rollback inside a java procedure does not close the resultsets created before the call to the java procedure.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3414&quot;&gt;DERBY-3414&lt;/a&gt; is fixed. The reason for network server test disability is that rollback inside the procedure does not close all the resultsets in Network server mode.&lt;/p&gt;</comment>
                            <comment id="12571144" author="mamtas" created="Thu, 21 Feb 2008 18:49:46 +0000"  >&lt;p&gt;I just finished making code changes and added a test case with revision 629926. These code changes ensure that a user initiated rollback through JDBC Connection object will not close the resultsets that do not return rows. More detailed info on the patch can be found through the commit comments for 629926.&lt;/p&gt;

&lt;p&gt;As next 2 tasks, I will merge these changes into 10.3 codeline and I will work on the case where a rollback is caused because of an exception. In such a case, we should close all the resultsets no matter if they return rows or not.&lt;/p&gt;</comment>
                            <comment id="12572131" author="knutanders" created="Mon, 25 Feb 2008 17:12:26 +0000"  >&lt;p&gt;I read through the commit log and found a couple of nits in commit&lt;br/&gt;
#629926:&lt;/p&gt;

&lt;p&gt;I think this change in EmbedStatement could be simplified:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (lrs.isClosed)&lt;/li&gt;
	&lt;li&gt;return null;&lt;br/&gt;
+        try 
{
+        	//following will check if the JDBC ResultSet or the language
+        	//ResultSet is closed. If yes, then it will throw an exception.
+        	//So, the exception indicates that the ResultSet is closed and
+        	//hence we should ignore it. 
+        	lrs.checkIfClosed(&quot;&quot;);
+        }
&lt;p&gt; catch (SQLException ex) &lt;/p&gt;
{
+            return null;        	
+        }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;EmbedResultSet.isClosed() does the same thing, I think, so the above&lt;br/&gt;
code could be written as &quot;if (lrs.isClosed()) return null;&quot;, which&lt;br/&gt;
looks a bit clearer to me. (Note, it&apos;s the isClosed &lt;em&gt;method&lt;/em&gt;, not the&lt;br/&gt;
field.)&lt;/p&gt;

&lt;p&gt;In GenericLanguageConnectionContext.endTransactionActivationHandling()&lt;br/&gt;
I saw this change:&lt;/p&gt;

&lt;p&gt;+			ResultSet activationResultSet = null;&lt;br/&gt;
+			boolean resultsetReturnsRows = false;&lt;br/&gt;
+			if (a.getResultSet() != null) &lt;/p&gt;
{
+				activationResultSet = a.getResultSet();
+				resultsetReturnsRows = activationResultSet.returnsRows();
+			}

&lt;p&gt;There&apos;s no reason to initialize activationResultSet to null first and&lt;br/&gt;
modify it inside the if statement. Just set it to a.getResultSet()&lt;br/&gt;
when it is initialized. Perhaps this would be clearer:&lt;/p&gt;

&lt;p&gt;    final ResultSet activationResultSet = a.getResultSet();&lt;br/&gt;
    final boolean resultsetReturnsRows =&lt;br/&gt;
        (activationResultSet != null) &amp;amp;&amp;amp; activationResultSet.returnsRows();&lt;/p&gt;

&lt;p&gt;Also, since resultsetReturnsRows is always false when&lt;br/&gt;
activationResultSet is null, it&apos;s not necessary to check that&lt;br/&gt;
activationResultSet is not null before checking that&lt;br/&gt;
resultsetReturnsRows is true later in that method.&lt;/p&gt;</comment>
                            <comment id="12572185" author="mamtas" created="Mon, 25 Feb 2008 19:33:24 +0000"  >&lt;p&gt;Knut, I appreciate your code review. I will work on it.&lt;/p&gt;</comment>
                            <comment id="12572374" author="mamtas" created="Tue, 26 Feb 2008 07:38:08 +0000"  >&lt;p&gt;Before addressing Knut&apos;s comments, I wanted to commit changes that were already in my codeline. The changes went in as revision 631108 into trunk. These changes ensured that when an exception is raised, the rollback caused by it will cleanup CallableStatementResultset such that all the resultsets associated with it are closed and CallableStatementResultset is available for reuse during next execution. More info can be found in commit comments.&lt;/p&gt;

&lt;p&gt;Next, I will work on migrating these changes into 10.3 codeline and addressing Knut&apos;s comments on revision 629926.&lt;/p&gt;</comment>
                            <comment id="12572567" author="mamtas" created="Tue, 26 Feb 2008 17:27:45 +0000"  >&lt;p&gt;Merged 631108 from trunk into 10.3.2.2 codeline with revision 631302.&lt;/p&gt;</comment>
                            <comment id="12572641" author="mamtas" created="Tue, 26 Feb 2008 20:29:37 +0000"  >&lt;p&gt;Knut suggested if we can use EmbedResultSet.isClosed() rather than EmbedResultSet.checkIfClosed() which requires us to catch the exception and determine if the resultset is closed. I had gone that path when I was working on the patch but EmbedResultSet.isClosed() is doing more than just checking if the JDBC resultset or language resultset is closed. It causes following additional code to execute&lt;/p&gt;

&lt;p&gt;EmbedResultSet.isClosed() calls EmbedResultSet.checkExecIfClosed which has the following extra piece of code&lt;br/&gt;
        // Currently disconnected, i.e. a detached gobal transaction&lt;br/&gt;
        if (appConn == null)&lt;br/&gt;
            throw Util.noCurrentConnection();&lt;/p&gt;

&lt;p&gt;        if (appConn.isClosed()) &lt;/p&gt;
{
            closeCurrentStream();
            isClosed = true;
            throw Util.noCurrentConnection();
        }

&lt;p&gt;I can&apos;t remember which test failed when I used EmbedResultSet.isClosed() rather than EmbedResultSet.checkIfClosed() but the cuplrit was the connection related code in checkExecIfClosed.&lt;/p&gt;</comment>
                            <comment id="12572789" author="mamtas" created="Wed, 27 Feb 2008 04:56:33 +0000"  >&lt;p&gt;Made some code cleanup changes based on the 2nd half of Knut&apos;s review comments for revision 629926. The code cleanup went in as revision 631481 into 10.4 codeline. &lt;/p&gt;

&lt;p&gt;629926 and 631481 are not merged into 10.3 codeline yet because they depend on merge of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3404&quot; title=&quot;EmbedResultSet.getString() returns wrong value after auto-commit with CLOSE_CURSORS_AT_COMMIT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3404&quot;&gt;&lt;del&gt;DERBY-3404&lt;/del&gt;&lt;/a&gt; into 10.3. The merge of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3404&quot; title=&quot;EmbedResultSet.getString() returns wrong value after auto-commit with CLOSE_CURSORS_AT_COMMIT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3404&quot;&gt;&lt;del&gt;DERBY-3404&lt;/del&gt;&lt;/a&gt; into 10.3 is running into locking issues.&lt;/p&gt;</comment>
                            <comment id="12572792" author="mamtas" created="Wed, 27 Feb 2008 05:01:21 +0000"  >&lt;p&gt;Forgot to add a comment about 2 trivial checkins, 631307(trunk) and 631311(10.3), that I made today. These checkins fixed the comments in LangProcedureTest in both trunk and 10,3 codeline. I was referring to incorrect jira entry in the test comments when I added the tests for engine changes. &lt;/p&gt;</comment>
                            <comment id="12573002" author="mamtas" created="Wed, 27 Feb 2008 17:46:21 +0000"  >&lt;p&gt;Number of fixes have gone in this jira entry and I think I have tackled all the issues related to this jira entry through them. The only thing I am aware of is that revisions 629926 and 631481 from trunk have not been merged into 10.3 codeline because they depend on merge of fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3404&quot; title=&quot;EmbedResultSet.getString() returns wrong value after auto-commit with CLOSE_CURSORS_AT_COMMIT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3404&quot;&gt;&lt;del&gt;DERBY-3404&lt;/del&gt;&lt;/a&gt; into 10.3 and that merge is running into locking issues.&lt;/p&gt;

&lt;p&gt;If I have missed any other issue on this jira entry, please let me know.&lt;/p&gt;</comment>
                            <comment id="12573246" author="knutanders" created="Thu, 28 Feb 2008 12:22:48 +0000"  >&lt;p&gt;Regarding isClosed() vs checkIfClose(), when you saw a test failing, was that before or after the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3404&quot; title=&quot;EmbedResultSet.getString() returns wrong value after auto-commit with CLOSE_CURSORS_AT_COMMIT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3404&quot;&gt;&lt;del&gt;DERBY-3404&lt;/del&gt;&lt;/a&gt; was checked in? I had to change a couple of tests because they would throw different exceptions with and without the fix (could change from connection closed to result set closed), so it might be that it&apos;s a similar problem here. It sounds a bit strange to me that we can return ResultSets where isClosed() returns false. But then perhaps the problem is that appConn is null when this code is executed because the ownership for the ResultSet is being transferred from the nested connection to the top-level connection?&lt;/p&gt;

&lt;p&gt;Anyway, it&apos;s not that many code lines extra, so don&apos;t spend too much energy on it. Thanks for checking it out and addressing my other comments.&lt;/p&gt;</comment>
                            <comment id="12573355" author="mamtas" created="Thu, 28 Feb 2008 17:06:38 +0000"  >&lt;p&gt;I haven&apos;t investigated why the isClosed() not working but using isClosed() makes .jdbc4/ResultSetTest.testGetHoldability() run into null pointer exception at line 1525. This test seems to indicate that for some reason, the dynamic resultset from the Java procedure has been closed hence unavailable whereas the test expects it to be open,&lt;/p&gt;</comment>
                            <comment id="12575249" author="mamtas" created="Wed, 5 Mar 2008 06:31:05 +0000"  >&lt;p&gt;Checked in 628130, 629926 and 631481 into 10.3.2.2 codeline.&lt;/p&gt;</comment>
                            <comment id="12575784" author="mamtas" created="Thu, 6 Mar 2008 17:18:53 +0000"  >&lt;p&gt;The changes for this jira issue are in 10.4 and 10.3 codelines.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12626909">DERBY-6038</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12372721" name="Main.java" size="2880" author="djd" created="Tue, 8 Jan 2008 16:26:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 Jan 2008 19:00:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23559</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ltr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37354</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>