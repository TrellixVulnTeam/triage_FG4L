<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:32 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2694/DERBY-2694.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2694] org.apache.derby.impl.drda.DDMWriter uses wrong algorithm to avoid spliting varchar in the middle of a multibyte char.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2694</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;org.apache.derby.impl.drda.DDMWriter uses wrong algorithm to avoid splitting varchar in the middle of a multibyte char.&lt;/p&gt;

&lt;p&gt;When DMWriter finds that it has to split a varchar while sending it to client it checks if the last byte is a part of a multibyte char and in case it is it tries to find the last byte of previous char and sends only till that byte leaving rest of it for the next send.&lt;/p&gt;

&lt;p&gt;The code it uses is having a bug so it fails when the last byte its checking for is the third byte of a char of 3 byte length.&lt;/p&gt;</description>
                <environment>all</environment>
        <key id="12370260">DERBY-2694</key>
            <summary>org.apache.derby.impl.drda.DDMWriter uses wrong algorithm to avoid spliting varchar in the middle of a multibyte char.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anurag">Anurag Shekhar</assignee>
                                    <reporter username="anurag">Anurag Shekhar</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 May 2007 12:21:00 +0100</created>
                <updated>Fri, 8 Jun 2007 06:41:52 +0100</updated>
                            <resolved>Fri, 8 Jun 2007 06:41:52 +0100</resolved>
                                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12499133" author="anurag" created="Fri, 25 May 2007 17:11:31 +0100"  >&lt;p&gt;TestProc.java is reproduces this bug. In this class I am inserting a 300000 char long clob with tamil char set. And using a function to get the substring of 20000 char. &lt;/p&gt;

&lt;p&gt;The substring returned has \ufffd at the position 10899. The string should have char between \u0B85 and \u0BCC&lt;/p&gt;

&lt;p&gt;This class needs derbyTesting.jar in classpath.&lt;/p&gt;</comment>
                            <comment id="12499173" author="anurag" created="Fri, 25 May 2007 18:29:52 +0100"  >&lt;p&gt;TestProc_TruncateRep is similar to TestProc except that it prints the string size from function and also the length of string received by the client. I am getting the size 10900 in client and 20000 on the server console.&lt;/p&gt;</comment>
                            <comment id="12499184" author="anurag" created="Fri, 25 May 2007 18:45:43 +0100"  >&lt;p&gt;org.apache.derby.impl.drda.DDMWriter.writeLDString (String s)  has a code to check if the splited utf-8 byte array ends with a multibyte char (while loop near 1223). In case the last byte is part of the multibyte char it tries to reduce the length of byte array so that it ends at the last byte of last character.&lt;/p&gt;

&lt;p&gt;This logic has a small mistake. An if block which should have been after while loop was placed inside it.&lt;/p&gt;

&lt;p&gt;junit.All tests run clean with this patch but I am still seeing truncating issue I have mentioned in my previous comments after this patch it client receives string of length 10899.&lt;/p&gt;
</comment>
                            <comment id="12500302" author="anurag" created="Thu, 31 May 2007 08:18:38 +0100"  >&lt;p&gt;I have made minor modification in my patch so that it doesn&apos;t skips the last char if thats the last byte of a multibyte char,&lt;/p&gt;</comment>
                            <comment id="12500304" author="anurag" created="Thu, 31 May 2007 08:24:00 +0100"  >&lt;p&gt;I think my comments in this issue has been little confusing. &lt;br/&gt;
The patch I have submitted fix of the bug which was corrupting last char while returning from a function. Apart from this issue I have also mentioned another issue in my comments which causes the a large string (containing multibyte chars). These are two different issue. My patch fixes the first issue alone.&lt;/p&gt;</comment>
                            <comment id="12500527" author="rhillegas" created="Fri, 1 Jun 2007 00:39:27 +0100"  >&lt;p&gt;Hi, Anurag. I think that the patch does the right thing. However, it&apos;s a little tricky to read. I think that the following approach is easier to understand. What do you think? I&apos;m not an expert on utf-8 encoding, but the following web page was useful to me: &lt;a href=&quot;http://www.unix.org.ua/orelly/java/fclass/appb_01.htm&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.unix.org.ua/orelly/java/fclass/appb_01.htm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;private static final byte MULTI_BYTE_MASK = (byte) 0xC0;&lt;br/&gt;
private static final byte CONTINUATION_BYTE = (byte) 0x80;&lt;/p&gt;

&lt;p&gt;if (writeLen != origLen) // if we&apos;re truncating the string&lt;br/&gt;
{&lt;br/&gt;
    while ( isContinuationChar( byteval[ writeLen ] ) ) &lt;/p&gt;
{ writeLen--; }

&lt;p&gt;   //&lt;br/&gt;
   // Now byteval[ writeLen ] is either a standalone 1-byte char&lt;br/&gt;
   // or the first byte of a multi-byte character. That means that&lt;br/&gt;
   // byteval[ writeLen -1 ] is the last (perhaps only) byte of the&lt;br/&gt;
   // previous character.&lt;br/&gt;
   //&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;private boolean isContinuationChar( byte b )&lt;/p&gt;
{    
    return ( (b &amp;amp; MULTI_BYTE_MASK) == CONTINUATION_BYTE );
}</comment>
                            <comment id="12501102" author="anurag" created="Mon, 4 Jun 2007 07:03:51 +0100"  >&lt;p&gt;updated the code with Rick&apos;s snippet.&lt;/p&gt;</comment>
                            <comment id="12501103" author="anurag" created="Mon, 4 Jun 2007 07:05:23 +0100"  >&lt;p&gt;reattaching the patch with license grant&lt;/p&gt;</comment>
                            <comment id="12501302" author="rhillegas" created="Mon, 4 Jun 2007 19:10:21 +0100"  >&lt;p&gt;Thanks for the revised patch, Anurag. Committed at subversion revision 544195..&lt;/p&gt;

&lt;p&gt;I saw 70 failures and 21 errors in the junit tests, but they were identical to the problems I saw when running without the patch.&lt;/p&gt;</comment>
                            <comment id="12501467" author="knutanders" created="Tue, 5 Jun 2007 07:40:17 +0100"  >&lt;p&gt;I noticed that the local variable multiByteTrunc is no longer used and can be removed. The attached patch removes it and a couple of unused imports in DDMWriter. Committed revision 544407.&lt;/p&gt;</comment>
                            <comment id="12502656" author="myrna" created="Fri, 8 Jun 2007 06:14:25 +0100"  >&lt;p&gt;Is this issue now complete?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12370325">DERBY-2702</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12358256" name="TestProc.java" size="2445" author="anurag" created="Fri, 25 May 2007 17:11:31 +0100"/>
                            <attachment id="12358267" name="TestProc_TruncateRep.java" size="2506" author="anurag" created="Fri, 25 May 2007 18:29:52 +0100"/>
                            <attachment id="12358594" name="derby-2694-v2.diff" size="1463" author="anurag" created="Thu, 31 May 2007 08:18:38 +0100"/>
                            <attachment id="12358811" name="derby-2694-v3.diff" size="1881" author="anurag" created="Mon, 4 Jun 2007 07:05:23 +0100"/>
                            <attachment id="12358810" name="derby-2694-v3.diff" size="1881" author="anurag" created="Mon, 4 Jun 2007 07:03:50 +0100"/>
                            <attachment id="12358272" name="derby-2694.diff" size="1257" author="anurag" created="Fri, 25 May 2007 18:45:43 +0100"/>
                            <attachment id="12358927" name="unused.diff" size="1101" author="knutanders" created="Tue, 5 Jun 2007 07:40:17 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 31 May 2007 23:39:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23186</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy11z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39970</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>