<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:42:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-504/DERBY-504.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-504] SELECT DISTINCT returns duplicates when selecting from subselects</title>
                <link>https://issues.apache.org/jira/browse/DERBY-504</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When one performs a select distinct on a table generated by a subselect, there sometimes are duplicates in the result. The following example shows the problem:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; CREATE TABLE names (id INT PRIMARY KEY, name VARCHAR(10));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; INSERT INTO names (id, name) VALUES&lt;br/&gt;
       (1, &apos;Anna&apos;), (2, &apos;Ben&apos;), (3, &apos;Carl&apos;),&lt;br/&gt;
       (4, &apos;Carl&apos;), (5, &apos;Ben&apos;), (6, &apos;Anna&apos;);&lt;br/&gt;
6 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; SELECT DISTINCT(name) FROM (SELECT name, id FROM names) AS n;&lt;br/&gt;
NAME      &lt;br/&gt;
----------&lt;br/&gt;
Anna      &lt;br/&gt;
Ben       &lt;br/&gt;
Carl      &lt;br/&gt;
Carl      &lt;br/&gt;
Ben       &lt;br/&gt;
Anna      &lt;/p&gt;

&lt;p&gt;Six names are returned, although only three names should have been returned.&lt;/p&gt;

&lt;p&gt;When the result is explicitly sorted (using ORDER BY) or the id column is removed from the subselect, the query returns three names as expected:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; SELECT DISTINCT(name) FROM (SELECT name, id FROM names) AS n ORDER BY name;&lt;br/&gt;
NAME      &lt;br/&gt;
----------&lt;br/&gt;
Anna      &lt;br/&gt;
Ben       &lt;br/&gt;
Carl      &lt;/p&gt;

&lt;p&gt;3 rows selected&lt;br/&gt;
ij&amp;gt; SELECT DISTINCT(name) FROM (SELECT name FROM names) AS n;&lt;br/&gt;
NAME      &lt;br/&gt;
----------&lt;br/&gt;
Anna      &lt;br/&gt;
Ben       &lt;br/&gt;
Carl      &lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;</description>
                <environment>Latest development sources (SVN revision 232227), Sun JDK 1.5, Solaris/x86</environment>
        <key id="12313341">DERBY-504</key>
            <summary>SELECT DISTINCT returns duplicates when selecting from subselects</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Aug 2005 19:07:11 +0100</created>
                <updated>Thu, 2 May 2013 03:28:57 +0100</updated>
                            <resolved>Thu, 11 Jan 2007 09:49:28 +0000</resolved>
                                    <version>10.1.2.1</version>
                                    <fixVersion>10.1.2.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12319194" author="knutanders" created="Fri, 19 Aug 2005 02:33:33 +0100"  >&lt;p&gt;Fixes the optimization bug which caused the trouble. Disables some optimization, so maybe we should fix it in another way?&lt;/p&gt;</comment>
                            <comment id="12319391" author="knutanders" created="Sat, 20 Aug 2005 00:56:30 +0100"  >&lt;p&gt;The GROUP BY in the test is rewritten to DISTINCT, and the DISTINCT is lost in the optimization.&lt;/p&gt;</comment>
                            <comment id="12320130" author="knutanders" created="Fri, 26 Aug 2005 21:40:22 +0100"  >&lt;p&gt;I have attached a patch which fixes the optimization bug by checking that a subquery has the same columns as the top-level query before pushing the duplicate elimination into the subquery. This patch supersedes the previously submitted patch.&lt;/p&gt;

&lt;p&gt;This patch does not remove the optimization of SELECT DISTINCT in other cases than those that were incorrectly optimized in the original Derby code.&lt;/p&gt;

&lt;p&gt;I have run derbyall successfully with the exception of two tests:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;lang/groupBy.sql fails because of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-519&quot; title=&quot;GROUP BY test depends on incorrect behaviour&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-519&quot;&gt;&lt;del&gt;DERBY-519&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;store/encryptionKey.sql fails, but I have seen that others have had trouble with this test too, so I believe it is not related to my patch&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will submit tests for this bug later.&lt;/p&gt;</comment>
                            <comment id="12320353" author="knutanders" created="Mon, 29 Aug 2005 00:10:21 +0100"  >&lt;p&gt;Added tests for the bug. No code changes from the previous patch.&lt;/p&gt;

&lt;p&gt;The following tests were modified:&lt;/p&gt;

&lt;p&gt;   1) lang/distinct.sql: Tests for this bug was added and the master file was updated. There are master files for this test in the j9_13 and j9_22 subdirectories, but I haven&apos;t changed those files.&lt;/p&gt;

&lt;p&gt;   2) lang/groupBy.sql: No changes in the test, but the master files were updated to reflect the new behaviour (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-519&quot; title=&quot;GROUP BY test depends on incorrect behaviour&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-519&quot;&gt;&lt;del&gt;DERBY-519&lt;/del&gt;&lt;/a&gt;). The j9_13 and j9_22 versions of the master file were also updated, but I haven&apos;t actually tested them.&lt;/p&gt;

&lt;p&gt;Could someone with access to the j9_13 and j9_22 platforms have a look at these tests and update the master files?&lt;/p&gt;

&lt;p&gt;This patch is now ready for review.&lt;/p&gt;</comment>
                            <comment id="12320737" author="rhillegas" created="Thu, 1 Sep 2005 08:51:29 +0100"  >&lt;p&gt;This is a clean, compact bug fix. It could be made a little more compact: SelectNode and ProjectRestrictNode have almost identical while loops for extracting the base column reference. Please don&apos;t miss the opportunity to abstract out a common method here.&lt;/p&gt;

&lt;p&gt;Once this change is made, I will apply the patch on my machine and run derbyall against jdk1.4.&lt;/p&gt;</comment>
                            <comment id="12320786" author="knutanders" created="Thu, 1 Sep 2005 22:19:27 +0100"  >&lt;p&gt;Changed the patch as suggested by Rick.&lt;/p&gt;</comment>
                            <comment id="12320805" author="rhillegas" created="Fri, 2 Sep 2005 01:46:10 +0100"  >&lt;p&gt;The patch seems to be broken. I can&apos;t apply the changes to the j2me canons. Here&apos;s the output from applying the patch:&lt;/p&gt;

&lt;p&gt;patching file java/engine/org/apache/derby/impl/sql/compile/ResultSetNode.java&lt;br/&gt;
patching file java/engine/org/apache/derby/impl/sql/compile/SelectNode.java&lt;br/&gt;
patching file java/engine/org/apache/derby/impl/sql/compile/ProjectRestrictNode.java&lt;br/&gt;
patching file java/engine/org/apache/derby/impl/sql/compile/ResultColumn.java&lt;br/&gt;
patching file java/engine/org/apache/derby/impl/sql/compile/FromBaseTable.java&lt;br/&gt;
patching file java/testing/org/apache/derbyTesting/functionTests/tests/lang/distinct.sql&lt;br/&gt;
patching file java/testing/org/apache/derbyTesting/functionTests/master/groupBy.out&lt;br/&gt;
patching file java/testing/org/apache/derbyTesting/functionTests/master/distinct.out&lt;br/&gt;
patching file java/testing/org/apache/derbyTesting/functionTests/master/j9_13/distinct.out&lt;br/&gt;
patching file java/testing/org/apache/derbyTesting/functionTests/master/j9_13/groupBy.out&lt;br/&gt;
patching file java/testing/org/apache/derbyTesting/functionTests/master/j9_22/distinct.out&lt;br/&gt;
Hunk #1 FAILED at 2477.&lt;br/&gt;
1 out of 1 hunk FAILED &amp;#8211; saving rejects to file java/testing/org/apache/derbyTesting/functionTests/master/j9_22/distinc&lt;br/&gt;
t.out.rej&lt;br/&gt;
patching file java/testing/org/apache/derbyTesting/functionTests/master/j9_22/groupBy.out&lt;br/&gt;
Hunk #1 FAILED at 293.&lt;br/&gt;
1 out of 1 hunk FAILED &amp;#8211; saving rejects to file java/testing/org/apache/derbyTesting/functionTests/master/j9_22/groupBy&lt;br/&gt;
.out.rej&lt;/p&gt;</comment>
                            <comment id="12320813" author="knutanders" created="Fri, 2 Sep 2005 02:35:49 +0100"  >&lt;p&gt;Uploaded a new patch with windows line terminators.&lt;/p&gt;

&lt;p&gt;Perhaps one of the committers could set svn:eol-style=native on the canon files in the j9_22 directory?&lt;/p&gt;</comment>
                            <comment id="12320814" author="knutanders" created="Fri, 2 Sep 2005 02:38:59 +0100"  >&lt;p&gt;Uploaded a new patch with windows line terminators.&lt;/p&gt;

&lt;p&gt;Perhaps one of the committers could set svn:eol-style=native on the canon files in the j9_22 directory?&lt;/p&gt;</comment>
                            <comment id="12320834" author="rhillegas" created="Fri, 2 Sep 2005 11:43:14 +0100"  >&lt;p&gt;Looks great. Derball passes. Ready for a committer to check in.&lt;/p&gt;</comment>
                            <comment id="12320856" author="knutanders" created="Fri, 2 Sep 2005 17:12:00 +0100"  >&lt;p&gt;After this last patch is applied, the only difference between the main canons and the j9_22 canons is the eol-style. This means that the committer could just remove the entire java/testing/org/apache/derbyTesting/functionTests/master/j9_22 directory if he or she pleases.&lt;/p&gt;</comment>
                            <comment id="12320917" author="bandaram" created="Sat, 3 Sep 2005 04:14:14 +0100"  >&lt;p&gt;I have submitted this patch to trunk. I wonder if the change in SelectNode.java may be doing redundant work by getting BaseColumnColumnNode and checking for simpleColumns. Since we have already matched (resultColumns.countNumberOfSimpleColumnReferences() == resultColumns.size()), doesn&apos;t that guarantee resultColumns to be only simpleColumns?&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\sql\compile\FromBaseTable.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\ProjectRestrictNode.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\ResultColumn.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\ResultSetNode.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\SelectNode.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\distinct.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\groupBy.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\j9_13\distinct.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\j9_13\groupBy.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\j9_22\distinct.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\j9_22\groupBy.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\distinct.sql&lt;br/&gt;
Transmitting file data ............&lt;br/&gt;
Committed revision 267239.&lt;/p&gt;</comment>
                            <comment id="12322650" author="knutanders" created="Mon, 5 Sep 2005 19:25:50 +0100"  >&lt;p&gt;It is true that the change in SelectNode is doing redundant work, but not because (resultColumns.countNumberOfSimpleColumnReferences() == resultColumns.size()) guarantees that all result columns are simple columns (if we by &quot;simple columns&quot; mean a column in a base table, no aggregates etc). E.g. in the query &apos;SELECT a FROM (SELECT AVG(age) AS a FROM names) AS n&apos;, resultColumns.countNumberOfSimpleColumnReferences() equals resultColumns.size(), but the result column is not simple. The redundancy is the other way around: If (but not only if) all colums are simple, then (countNumberOfSimpleColumnReferences() == size()) is true.&lt;/p&gt;

&lt;p&gt;I can submit a patch which removes this redundant checking. It doesn&apos;t seem like ResultColumnList.countNumberOfSimpleColumnReferences() is used anywhere else in the code. If I remove the call to countNumberOfSimpleColumnReferences() and it is not used anywhere else, should I then also remove the definition of the method to make the code cleaner, or should I leave the method in case it would be needed in the future?&lt;/p&gt;</comment>
                            <comment id="12322818" author="knutanders" created="Wed, 7 Sep 2005 19:17:49 +0100"  >&lt;p&gt;Attached a clean-up patch against trunk which removes a redundant check pointed out by Satheesh. I have run derbyall successfully.&lt;/p&gt;</comment>
                            <comment id="12322819" author="knutanders" created="Wed, 7 Sep 2005 19:27:37 +0100"  >&lt;p&gt;I have attached a patch for 10.1. Because of the svn:eol-style issue in some of the tests, I have included one patch which can be applied on windows and one which can be applied on unix-like systems. The j9_13 and j9_22 canons are modified but not tested.&lt;/p&gt;</comment>
                            <comment id="12322857" author="djd" created="Thu, 8 Sep 2005 02:58:43 +0100"  >&lt;p&gt;Couple of questions on the 10.1 patch:&lt;/p&gt;

&lt;p&gt;1) Does this include the cleanup patch posted 07/Sep/05 11:17 AM], or just the committed change?&lt;br/&gt;
2) Is it a clean merge, generated from an svn merge command,  or did you need to make changes?&lt;/p&gt;</comment>
                            <comment id="12322909" author="knutanders" created="Thu, 8 Sep 2005 17:01:10 +0100"  >&lt;p&gt;About the 10.1 patch:&lt;/p&gt;

&lt;p&gt;1) Yes, it includes the cleanup patch.&lt;br/&gt;
2) No, it is not generated from an svn merge command, but it could be done. I incorrectly assumed that it wouldn&apos;t work since applying the trunk patch directly failed. Seems like subversion is smarter than me... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Applying this command will merge the committed changes into 10.1:&lt;/p&gt;

&lt;p&gt;     svn merge -r 267238:267239 mytrunkdir my10.1dir&lt;/p&gt;

&lt;p&gt;This doesn&apos;t include the cleanup patch, but it will fix the bug. The cleanup patch could be applied directly, but it is not important in the 10.1 backport.&lt;/p&gt;

&lt;p&gt;There is one difference between my 10.1 patch and the svn merge. One of the j9_22 canons (java/testing/org/apache/derbyTesting/functionTests/master/j9_22/distinct.out) is different. Since I haven&apos;t tested the j9_&lt;/p&gt;
{13,22}
&lt;p&gt; files, that canon must be checked by someone else anyway.&lt;/p&gt;</comment>
                            <comment id="12324420" author="knutanders" created="Tue, 13 Sep 2005 16:37:33 +0100"  >&lt;p&gt;Bug fixed in revision 267239.&lt;/p&gt;

&lt;p&gt;The clean-up patch removing redundant checking and the backport are still not committed.&lt;/p&gt;</comment>
                            <comment id="12329962" author="knutanders" created="Tue, 20 Sep 2005 17:08:41 +0100"  >&lt;p&gt;Reopen the bug so the fix can be included in 10.1.2. Since the bug was reported on derby-user before 10.1.1 was released, I think it should be fixed in 10.1.2.&lt;/p&gt;</comment>
                            <comment id="12329964" author="knutanders" created="Tue, 20 Sep 2005 17:09:54 +0100"  >&lt;p&gt;Changed fix version.&lt;/p&gt;</comment>
                            <comment id="12331560" author="knutanders" created="Fri, 7 Oct 2005 17:02:06 +0100"  >&lt;p&gt;Fixed in trunk (revision 267239) and 10.1 (revision 306964).&lt;/p&gt;</comment>
                            <comment id="12463852" author="knutanders" created="Thu, 11 Jan 2007 09:46:19 +0000"  >&lt;p&gt;Reopen to commit cleanup patch.&lt;/p&gt;</comment>
                            <comment id="12463854" author="knutanders" created="Thu, 11 Jan 2007 09:49:28 +0000"  >&lt;p&gt;Committed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-504&quot; title=&quot;SELECT DISTINCT returns duplicates when selecting from subselects&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-504&quot;&gt;&lt;del&gt;DERBY-504&lt;/del&gt;&lt;/a&gt;-cleanup.diff to trunk with revision 495171.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12313572">DERBY-519</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12312764" name="DERBY-504-10.1-unix.diff" size="65524" author="knutanders" created="Wed, 7 Sep 2005 19:27:37 +0100"/>
                            <attachment id="12312765" name="DERBY-504-10.1-windows.diff" size="66440" author="knutanders" created="Wed, 7 Sep 2005 19:27:37 +0100"/>
                            <attachment id="12312766" name="DERBY-504-10.1.stat" size="1008" author="knutanders" created="Wed, 7 Sep 2005 19:27:37 +0100"/>
                            <attachment id="12312762" name="DERBY-504-cleanup.diff" size="1825" author="knutanders" created="Wed, 7 Sep 2005 19:17:48 +0100"/>
                            <attachment id="12312763" name="DERBY-504-cleanup.stat" size="144" author="knutanders" created="Wed, 7 Sep 2005 19:17:49 +0100"/>
                            <attachment id="12312053" name="DERBY-504.diff" size="27786" author="knutanders" created="Mon, 29 Aug 2005 00:10:21 +0100"/>
                            <attachment id="12312054" name="DERBY-504.stat" size="694" author="knutanders" created="Mon, 29 Aug 2005 00:10:21 +0100"/>
                            <attachment id="12312097" name="DERBY-504_b.diff" size="66149" author="myrna" created="Wed, 31 Aug 2005 11:16:04 +0100"/>
                            <attachment id="12312098" name="DERBY-504_b.stat" size="873" author="myrna" created="Wed, 31 Aug 2005 11:16:04 +0100"/>
                            <attachment id="12312139" name="DERBY-504_c-CRLF.diff" size="65773" author="knutanders" created="Fri, 2 Sep 2005 02:38:58 +0100"/>
                            <attachment id="12312138" name="DERBY-504_c-CRLF.diff" size="65773" author="knutanders" created="Fri, 2 Sep 2005 02:35:49 +0100"/>
                            <attachment id="12312126" name="DERBY-504_c.diff" size="64894" author="knutanders" created="Thu, 1 Sep 2005 22:19:27 +0100"/>
                            <attachment id="12312127" name="DERBY-504_c.stat" size="933" author="knutanders" created="Thu, 1 Sep 2005 22:19:27 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>13.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 31 Aug 2005 10:16:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21988</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy13mn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40238</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>