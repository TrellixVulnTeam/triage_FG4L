<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:16:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6692/DERBY-6692.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6692] Self-deadlock when inserting row with identity column in soft-upgraded database</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6692</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Create a database called &quot;wombat&quot; with Derby 10.10.2.0.&lt;/p&gt;

&lt;p&gt;Then, in the same directory, execute the following code using the 10.11.1.0 release candidate:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        Connection c = DriverManager.getConnection(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:derby:wombat&quot;&lt;/span&gt;);
        c.setAutoCommit(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        Statement s = c.createStatement();
        s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;create table t(i &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; generated always as identity)&quot;&lt;/span&gt;);
        s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert into t values (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;)&quot;&lt;/span&gt;);
        c.rollback();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The INSERT statement will fail with a self-deadlock:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;main&quot; java.sql.SQLTransactionRollbackException: Self-deadlock.
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
	at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)
	at Kladd.main(Kladd.java:12)
Caused by: ERROR 40XL2: Self-deadlock.
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
	at org.apache.derby.impl.services.locks.ConcurrentLockSet.lockObject(Unknown Source)
	at org.apache.derby.impl.services.locks.AbstractPool.lockObject(Unknown Source)
	at org.apache.derby.impl.services.locks.ConcurrentPool.lockObject(Unknown Source)
	at org.apache.derby.impl.store.raw.xact.RowLocking3.lockRecordForWrite(Unknown Source)
	at org.apache.derby.impl.store.access.conglomerate.OpenConglomerate.lockPositionForWrite(Unknown Source)
	at org.apache.derby.impl.store.access.conglomerate.GenericConglomerateController.fetch(Unknown Source)
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getSetAutoincrementValue(Unknown Source)
	at org.apache.derby.impl.sql.execute.InsertResultSet.getOldStyleIdentityValue(Unknown Source)
	at org.apache.derby.impl.sql.execute.InsertResultSet.getSetAutoincrementValue(Unknown Source)
	at org.apache.derby.impl.sql.execute.BaseActivation.getSetAutoincrementValue(Unknown Source)
	at org.apache.derby.exe.acaaeec04ex0147xab31x1ccax000007dedc900.e0(Unknown Source)
	at org.apache.derby.impl.services.reflect.DirectCall.invoke(Unknown Source)
	at org.apache.derby.impl.sql.execute.RowResultSet.getNextRowCore(Unknown Source)
	at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(Unknown Source)
	at org.apache.derby.impl.sql.execute.InsertResultSet.getNextRowCore(Unknown Source)
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(Unknown Source)
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)
	... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12732287">DERBY-6692</key>
            <summary>Self-deadlock when inserting row with identity column in soft-upgraded database</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Wed, 6 Aug 2014 13:09:23 +0100</created>
                <updated>Wed, 24 Sep 2014 23:30:56 +0100</updated>
                            <resolved>Thu, 7 Aug 2014 13:30:28 +0100</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                    <fixVersion>10.12.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14087619" author="rhillegas" created="Wed, 6 Aug 2014 13:54:50 +0100"  >&lt;p&gt;Linking to derby-6554. Seems to be failing in the self-deadlock detection code introduced to fix that issue.&lt;/p&gt;</comment>
                            <comment id="14087660" author="rhillegas" created="Wed, 6 Aug 2014 14:30:14 +0100"  >&lt;p&gt;Attaching derby-6692-01-aa-handleSelfDeadlock.diff. This patch fixes the bug.&lt;/p&gt;

&lt;p&gt;This situation is exactly the self-deadlock scenario addressed by the machinery which derby-6554 introduced. In 10.10, a lock-timeout exception is thrown in this case. That exception is caught by InsertResultSet, which then escalates the identity-bumping into the parent transaction. The fix is to make InsertResultSet check for self-deadlock as well as lock-timeout.&lt;/p&gt;


&lt;p&gt;Touches the following file:&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/execute/InsertResultSet.java&lt;/p&gt;</comment>
                            <comment id="14087801" author="rhillegas" created="Wed, 6 Aug 2014 16:43:28 +0100"  >&lt;p&gt;Attaching derby-6692-01-ab-withTests.diff. This version of the patch adds an upgrade test case for this problem. I am running regression tests now.&lt;/p&gt;

&lt;p&gt;Touches the following additional file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/upgradeTests/Changes10_11.java&lt;/p&gt;</comment>
                            <comment id="14088012" author="rhillegas" created="Wed, 6 Aug 2014 19:40:01 +0100"  >&lt;p&gt;Tests ran cleanly for me on derby-6692-01-ab-withTests.diff except for the following error in RuntimeInfoTest. That test runs cleanly for me standalone. The test is in the derbynet suite. I created a slimmed down version of the master JUnit suite (All.java), including only the tests up through the derbynet suite. I ran that mini-suite 5 times but did not see the error. I intend to check in this patch and see if the heisenbug can be tripped by the full platform tests.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;There was 1 failure:
1) testRunTests(org.apache.derbyTesting.functionTests.tests.derbynet.RuntimeInfoTest)junit.framework.ComparisonFailure: Output doesn&apos;t match expected:&amp;lt;...--------
Session # :[8


-------------------------------------------------------------
# Connection Threads : 4
# Active Sessions : 1]
# Waiting  Sessions...&amp;gt; but was:&amp;lt;...--------
Session # :[5
Database :singleUse/oneuse4
User :APP
# Statements:2
Prepared Statement Information: 
	Stmt ID		SQLText
	-------------	-----------
	null
	null



Session # :8


-------------------------------------------------------------
# Connection Threads : 4
# Active Sessions : 2]
# Waiting  Sessions...&amp;gt;
	at org.apache.derbyTesting.functionTests.tests.derbynet.RuntimeInfoTest.x_testRuntimeInfoAfterConnClose(RuntimeInfoTest.java:192)
	at org.apache.derbyTesting.functionTests.tests.derbynet.RuntimeInfoTest.testRunTests(RuntimeInfoTest.java:97)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:118)
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBareOverridable(BaseJDBCTestCase.java:440)
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBare(BaseJDBCTestCase.java:457)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)

FAILURES!!!
Tests run: 19211,  Failures: 1,  Errors: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14088015" author="jira-bot" created="Wed, 6 Aug 2014 19:43:51 +0100"  >&lt;p&gt;Commit 1616299 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1616299&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1616299&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6692&quot; title=&quot;Self-deadlock when inserting row with identity column in soft-upgraded database&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6692&quot;&gt;&lt;del&gt;DERBY-6692&lt;/del&gt;&lt;/a&gt;: Fix self-deadlock regression in soft-upgraded database; commit derby-6692-01-ab-withTests.diff.&lt;/p&gt;</comment>
                            <comment id="14089174" author="rhillegas" created="Thu, 7 Aug 2014 13:30:28 +0100"  >&lt;p&gt;Tests ran cleanly on all platforms during last night&apos;s automated run. We should keep our eyes open for the heisenbug. I am not inclined to let this test heisenbug hold up the release. Resolving this issue.&lt;/p&gt;</comment>
                            <comment id="14089179" author="jira-bot" created="Thu, 7 Aug 2014 13:39:29 +0100"  >&lt;p&gt;Commit 1616483 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/branches/10.11&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1616483&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1616483&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6692&quot; title=&quot;Self-deadlock when inserting row with identity column in soft-upgraded database&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6692&quot;&gt;&lt;del&gt;DERBY-6692&lt;/del&gt;&lt;/a&gt;: Port 1616299 from trunk to 10.11 branch.&lt;/p&gt;</comment>
                            <comment id="14146983" author="mikem" created="Wed, 24 Sep 2014 23:30:56 +0100"  >&lt;p&gt;adding label to stop backport to 10.10.  The problem was a regression added into 10.11 and did not affect 10.10 and previous releases.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12710537">DERBY-6554</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12732825">DERBY-6701</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12732814">DERBY-6698</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12660133" name="derby-6692-01-aa-handleSelfDeadlock.diff" size="695" author="rhillegas" created="Wed, 6 Aug 2014 14:30:14 +0100"/>
                            <attachment id="12660156" name="derby-6692-01-ab-withTests.diff" size="2187" author="rhillegas" created="Wed, 6 Aug 2014 16:43:28 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 Aug 2014 12:54:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410315</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzsgbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410305</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10050"><![CDATA[Blocker]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>