<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:49:39 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3379/DERBY-3379.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3379] &quot;No Current connection&quot; on PooledConnection.getConnection() if pooled connection is reused during connectionClosed processing</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3379</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This is the client version of bug &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2142&quot; title=&quot;NullPointerException while using XAConnection/PooledConnection in a heavily contended multithreaded scenario&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2142&quot;&gt;&lt;del&gt;DERBY-2142&lt;/del&gt;&lt;/a&gt;.  It can be reproduced by enabling the test, DataSourceTest.testPooledReuseOnClose() for client. I am opening a new issue for client as the embedded fix was backported to 10.1 and I am guessing the client fix won&apos;t be backported that far.  Better to keep it as  a separate issue.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12387665">DERBY-3379</key>
            <summary>&quot;No Current connection&quot; on PooledConnection.getConnection() if pooled connection is reused during connectionClosed processing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Feb 2008 19:52:31 +0000</created>
                <updated>Mon, 4 May 2009 19:22:38 +0100</updated>
                            <resolved>Mon, 31 Mar 2008 10:51:58 +0100</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12567132" author="kristwaa" created="Fri, 8 Feb 2008 17:54:30 +0000"  >&lt;p&gt;I had a look at this one.&lt;/p&gt;

&lt;p&gt;After some DRDA debugging and various ad-hoc tests, I think I have a basic idea of what is happening.&lt;br/&gt;
Note that there are several problems with the current implementation.&lt;/p&gt;

&lt;p&gt;First of all, the &quot;No current connection&quot; exception is thrown in the client because the client side state of the connection is not maintained/handled properly. The variable &apos;open_&apos; in the connection is false (but &apos;availableForReuse&apos; is true) and the exception is raised when you try to create a new logical connection.&lt;/p&gt;

&lt;p&gt;Secondly, the client driver has the same bug as the embedded driver regarding nulling out the connection pointers.&lt;/p&gt;

&lt;p&gt;Finally, when getting past the obstacles above, the test causes Derby to hang.&lt;br/&gt;
I found out that the reason is that the chaining bits indicate there is more to come from the client, so the server doesn&apos;t send the reply.&lt;br/&gt;
This is in fact wrong, and both sides end up waiting for each other.&lt;/p&gt;

&lt;p&gt;After some more testing and code review, I found out that opening a ResultSet before closing the statement in the test makes the hang go away. This is because the client has to send a command to the server asking it to close the ResultSet, and this time the chaining bit is apparently set correctly.&lt;/p&gt;


&lt;p&gt;I&apos;m a bit unsure how to proceed with fixing this bug. I&apos;m assuming the reset is required, which indicates we somehow have to make sure the chaining bit of the deferred reset is set correctly. The most obvious fix now I can see right away, is to make sure we end the chain if there are no other commands going to the server.&lt;br/&gt;
For instance, can we force the last chaining bit to indicate no chaining in Agent.endWriteChain, or will this break something?&lt;br/&gt;
(transmission of large continued objects, bigger than 32K?)&lt;br/&gt;
Maybe we have to take the continuation bits into account as well?&lt;/p&gt;

&lt;p&gt;If someone wants to have a closer look, the reset commands are constructed as part of the ClientPooledConnection.close method, and the commands are pushed onto the wire as part of Statement.close in the test (DataSourceTest.testPooledReuseOnClose).&lt;/p&gt;

&lt;p&gt;I haven&apos;t worked much with the client code, so some advice would be helpful.&lt;/p&gt;</comment>
                            <comment id="12567651" author="kristwaa" created="Mon, 11 Feb 2008 14:50:14 +0000"  >&lt;p&gt;&apos;derby-3379-1a-enforce_no_chaining.diff&apos; is an attempt to fix both the NPE and the bug hiding underneath.&lt;/p&gt;

&lt;p&gt;The basic strategy is to make sure the last DSS has the chaining bits set to no chaining when endWriteChain is called and the data is flushed (sent over the wire).&lt;/p&gt;

&lt;p&gt;I am not sure if this is the best approach, but it fixes the bug. I have run suites.All successfully with an earlier version of the patch, and I&apos;m now running both derbyall and suites.All with this version to confirm that nothing breaks.&lt;/p&gt;

&lt;p&gt;Patch is ready for review, but not for commit. There is an unnecessary method rename in there that will go into a separate commit.&lt;/p&gt;</comment>
                            <comment id="12567654" author="kristwaa" created="Mon, 11 Feb 2008 14:52:13 +0000"  >&lt;p&gt;Forgot to tick off the ASF license grant...&lt;/p&gt;</comment>
                            <comment id="12568005" author="kristwaa" created="Tue, 12 Feb 2008 08:28:57 +0000"  >&lt;p&gt;&apos;derby-3379-1b-enforce_no_chaining.diff&apos; deprecates version 1a, which due to a last minute change broke quite a few tests...&lt;/p&gt;

&lt;p&gt;I&apos;m still asking for comments on the approach, as there are other ways to solve it as well.&lt;br/&gt;
I&apos;m rerunning all tests, and expect these to be done by the end of the day.&lt;/p&gt;</comment>
                            <comment id="12568248" author="kristwaa" created="Tue, 12 Feb 2008 17:45:13 +0000"  >&lt;p&gt;suites.All and derbyall ran successfully with Sun JDK 1.4.2, 1.5 and 1.6.&lt;/p&gt;</comment>
                            <comment id="12568594" author="knutanders" created="Wed, 13 Feb 2008 15:44:03 +0000"  >&lt;p&gt;The 1b patch conflicts with the latest changes in DataSourceTest (testPooledReuseOnClose() has been moved to J2EEDataSourceTest) and doesn&apos;t apply cleanly.&lt;/p&gt;</comment>
                            <comment id="12568824" author="kristwaa" created="Thu, 14 Feb 2008 07:40:43 +0000"  >&lt;p&gt;&apos;derby-3379-1c-enforce_no_chaining.diff&apos; patches the new test (J2EEDataSourceTest) instead of the old one.&lt;br/&gt;
No changes to the logic/functionality in the patch.&lt;/p&gt;

&lt;p&gt;Still awaiting comments on the approach taken.&lt;/p&gt;</comment>
                            <comment id="12569260" author="knutanders" created="Fri, 15 Feb 2008 12:55:42 +0000"  >&lt;p&gt;I think the approach is OK, although it sounds better if the chaining bits were set correctly in the first place. It&apos;s not quite clear to me where/how the chaining bits are set the first time, but if I understand correctly, Statement.flowCloseOutsideUOW() will only be called if nothing needs to be sent to the server on Statement.close(). Could we somehow use this to send a flag down the call tree so that the chaining bits are set correctly?&lt;/p&gt;

&lt;p&gt;Should previousUsedDssMark have been reset in clearBuffer()?&lt;/p&gt;

&lt;p&gt;Should endDssChain() also check that (dssLengthLocation_ == offset_) so that we&apos;re completely sure the last DSS is empty/missing?&lt;/p&gt;</comment>
                            <comment id="12579368" author="kristwaa" created="Mon, 17 Mar 2008 09:46:26 +0000"  >&lt;p&gt;&apos;derby-3379-2a-comment_and_JavaDoc.diff&apos; cleans up some comments in buildDss.&lt;br/&gt;
One of the comments confused me at first, because it said chaining bits were always set, followed by two 0xFF assignments in the byte array. Turned out this was the length bytes, and that the chaining bits are not unconditionally set (as part of this method).&lt;br/&gt;
It also converts comments for method finalizeDssLength into JavaDoc.&lt;/p&gt;

&lt;p&gt;I committed 2a to trunk with revision 637805.&lt;br/&gt;
I  plan to merge all commits for this issue to the 10.4 branch when the issue has been resolved.&lt;/p&gt;

&lt;p&gt;My further work here looks like this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Address Knut&apos;s comments and upload a new &quot;base patch&quot;.&lt;/li&gt;
	&lt;li&gt;Upload two enabling patches, one broad (current) and  one isolated fix.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will spend a little more time looking into the issue and see if the fix can be made smaller. If not, I hope the isolated fix can go in. The plan is to only change the chaining flag if there are no result sets to close, as opposed to checking and possibly resetting the chaining flag on every flush (broad approach).&lt;/p&gt;

&lt;p&gt;My opinion is that even if the isolated fix may not be perfect, it should go in. We have users seeing the problem, and the patch fixes it without breaking any of the regression tests.&lt;br/&gt;
If others want to pursue a different fix, they are welcome to do so &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
(but please let me know so we don&apos;t duplicate our efforts)&lt;/p&gt;

&lt;p&gt;I do plan to get this in for the 10.4 release. &lt;/p&gt;</comment>
                            <comment id="12579486" author="kristwaa" created="Mon, 17 Mar 2008 15:41:38 +0000"  >&lt;p&gt;&apos;derby-3379-3a-minimal_fix_and_test_enabling.diff&apos; is a minimal fix (basically a one-liner) and it also enables the regression test that was commented out.&lt;/p&gt;

&lt;p&gt;Seems some other change has somehow changed the characteristics of the problem. Earlier I got a hang with only the fix for ClientPooledConnection. Now it works fine. Without the CPC-fix, I get a &quot;No current connection&quot;.&lt;br/&gt;
It is not clear to me what has caused the change. I have run the test both with and without statement pooling enabled, and also both with trunk and the 10.4 branch.&lt;/p&gt;

&lt;p&gt;Can someone please try this patch out and verify that jdbcapi.J2EEDataSourceTest runs cleanly, and that the repro is actually run?&lt;br/&gt;
I have started the full regression suite, and will report back with the results tomorrow.&lt;br/&gt;
If I get the cycles, I&apos;ll try to hunt down the commit that made the hang go away. Would be nice to know...&lt;/p&gt;</comment>
                            <comment id="12581862" author="knutanders" created="Tue, 25 Mar 2008 10:39:49 +0000"  >&lt;p&gt;J2EEDataSourceTest ran cleanly in my environment, and testPooledReuseOnClose was invoked twice (embedded and client).&lt;/p&gt;</comment>
                            <comment id="12581933" author="knutanders" created="Tue, 25 Mar 2008 13:26:33 +0000"  >&lt;p&gt;It seems like the hang disappeared after this commit:&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------------------&lt;br/&gt;
r628679 | kristwaa | 2008-02-18 11:56:23 +0100 (Mon, 18 Feb 2008) | 3 lines&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3421&quot; title=&quot;Remove unused code for caching of connect bytes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3421&quot;&gt;&lt;del&gt;DERBY-3421&lt;/del&gt;&lt;/a&gt;: Remove unused code for caching of connect bytes.&lt;br/&gt;
Patch file: derby-3421-1b-removal.diff&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------------------&lt;/p&gt;</comment>
                            <comment id="12582326" author="kristwaa" created="Wed, 26 Mar 2008 15:52:48 +0000"  >&lt;p&gt;Thanks for the verification and the detective work Knut Anders!&lt;/p&gt;

&lt;p&gt;I&apos;ll look into the patch I committed and see if I understand why it changes the behavior. That was not the intention, so I have to determine if the removed code was buggy or there is another reason for the changed behavior.&lt;/p&gt;</comment>
                            <comment id="12583611" author="kristwaa" created="Mon, 31 Mar 2008 10:51:58 +0100"  >&lt;p&gt;Committed &apos;derby-3379-3a-minimal_fix_and_test_enabling.diff&apos;  to trunk with revision 642942 and merged it to the 10.4 branch with revision 642944.&lt;/p&gt;

&lt;p&gt;It turned out that the deleted method &apos;cacheConnectBytes&apos; changed the state in the request object, which caused the hang. The reason for the state change was that it needed the correct offsets to copy the raw connect bytes, and it obtained these offsets by finalizing the DSS. The chaining bits were set as part of this, but when there are no more commands to send, the server will hang waiting for the next command and the client will hang waiting for the reply to the first (and only) command. The bug will not be triggered if the statement being closed has open result sets, as that will cause another command to be written to the chain and the chaining bits are set correctly in this case.&lt;/p&gt;

&lt;p&gt;I&apos;m of the opinion that the patch makes the driver behave more correctly, and therefore I proceeded with committing patch 3a.&lt;/p&gt;

&lt;p&gt;For reference, here is the stack trace for the client during the hang. The server stack trace doesn&apos;t show anything useful for this bug.&lt;br/&gt;
&quot;main&quot; prio=10 tid=0x08070000 nid=0x2 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0xfe4fe000..0xfe4fed48&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
        at java.net.SocketInputStream.socketRead0(Native Method)&lt;br/&gt;
        at java.net.SocketInputStream.read(SocketInputStream.java:129)&lt;br/&gt;
        at org.apache.derby.client.net.Reply.fill(Reply.java:174)&lt;br/&gt;
        at org.apache.derby.client.net.Reply.ensureALayerDataInBuffer(Reply.java:215)&lt;br/&gt;
        at org.apache.derby.client.net.Reply.readDssHeader(Reply.java:317)&lt;br/&gt;
        at org.apache.derby.client.net.Reply.startSameIdChainParse(Reply.java:1147)&lt;br/&gt;
        at org.apache.derby.client.net.NetConnectionReply.readExchangeServerAttributes(NetConnectionReply.java:54)&lt;br/&gt;
        at org.apache.derby.client.net.NetConnection.readServerAttributesAndKeyExchange(NetConnection.java:862)&lt;br/&gt;
        at org.apache.derby.client.net.NetConnection.readAllConnectCommandsChained(NetConnection.java:832)&lt;br/&gt;
        at org.apache.derby.client.net.NetConnection.readDeferredReset(NetConnection.java:994)&lt;br/&gt;
        at org.apache.derby.client.net.NetAgent.readDeferredResetConnection(NetAgent.java:474)&lt;br/&gt;
        at org.apache.derby.client.net.NetAgent.beginReadChainOutsideUOW(NetAgent.java:490)&lt;br/&gt;
        at org.apache.derby.client.am.Agent.flowOutsideUOW(Agent.java:197)&lt;br/&gt;
        at org.apache.derby.client.am.Statement.flowCloseOutsideUOW(Statement.java:1686)&lt;br/&gt;
        at org.apache.derby.client.am.Statement.closeX(Statement.java:604)&lt;br/&gt;
        at org.apache.derby.client.am.Statement.close(Statement.java:564)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0xf4157648&amp;gt; (a org.apache.derby.client.net.NetConnection40)&lt;br/&gt;
        at d3379.main(d3379.java:30)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12583613" author="kristwaa" created="Mon, 31 Mar 2008 10:55:19 +0100"  >&lt;p&gt;Added link to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3421&quot; title=&quot;Remove unused code for caching of connect bytes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3421&quot;&gt;&lt;del&gt;DERBY-3421&lt;/del&gt;&lt;/a&gt;. If you want to backport the fix for 3379 to the 10.3 branch, the fix for 3421 must be included as well. Failing to do so will cause Derby to hang instead of throwing the &quot;No current connection&quot; exception.&lt;/p&gt;

&lt;p&gt;I do not plan to backport to 10.3 unless someone makes a request to do so.&lt;/p&gt;</comment>
                            <comment id="12592577" author="kmarsden" created="Sat, 26 Apr 2008 16:38:18 +0100"  >&lt;p&gt;Committed revision 651835 to 10.3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12357598">DERBY-2142</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12388763">DERBY-3421</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12375234" name="derby-3379-1a-enforce_no_chaining.diff" size="6937" author="kristwaa" created="Mon, 11 Feb 2008 14:52:13 +0000"/>
                            <attachment id="12375232" name="derby-3379-1a-enforce_no_chaining.diff" size="6937" author="kristwaa" created="Mon, 11 Feb 2008 14:50:14 +0000"/>
                            <attachment id="12375235" name="derby-3379-1a-enforce_no_chaining.stat" size="353" author="kristwaa" created="Mon, 11 Feb 2008 14:52:13 +0000"/>
                            <attachment id="12375233" name="derby-3379-1a-enforce_no_chaining.stat" size="353" author="kristwaa" created="Mon, 11 Feb 2008 14:50:14 +0000"/>
                            <attachment id="12375333" name="derby-3379-1b-enforce_no_chaining.diff" size="5707" author="kristwaa" created="Tue, 12 Feb 2008 08:28:57 +0000"/>
                            <attachment id="12375554" name="derby-3379-1c-enforce_no_chaining.diff" size="5700" author="kristwaa" created="Thu, 14 Feb 2008 07:40:43 +0000"/>
                            <attachment id="12375555" name="derby-3379-1c-enforce_no_chaining.stat" size="288" author="kristwaa" created="Thu, 14 Feb 2008 07:40:43 +0000"/>
                            <attachment id="12378025" name="derby-3379-2a-comment_and_JavaDoc.diff" size="3481" author="kristwaa" created="Mon, 17 Mar 2008 09:46:26 +0000"/>
                            <attachment id="12378040" name="derby-3379-3a-minimal_fix_and_test_enabling.diff" size="2635" author="kristwaa" created="Mon, 17 Mar 2008 15:41:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 8 Feb 2008 17:54:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23606</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xhb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39242</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>