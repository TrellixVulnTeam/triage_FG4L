<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:30:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5916/DERBY-5916.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5916] java.lang.NullPointerException org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop() connecting to network server</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5916</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt; I got a report of the exception below trying to connect to  database with absolute path and network server and the database name attribute.  I haven&apos;t gotten  information  on the derby version or  platform, Below is the url I received with some characters replaced.&lt;/p&gt;


&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby://localhost:1527/;databaseName=/home/uxxxx/Installs/hxxx_ext/mxxxxxxxx_db;create=true&apos; ;&lt;/p&gt;


&lt;p&gt; java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.TopService.stop(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.TopService.shutdown(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.bootService(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.startProviderService(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.findProviderAndStartService(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.startPersistentService(Unknown Source)&lt;br/&gt;
        at org.apache.derby.iapi.services.monitor.Monitor.startPersistentService(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
        at org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Unknown Source)&lt;br/&gt;
        at org.apache.derby.jdbc.InternalDriver.connect(Unknown Source)&lt;br/&gt;
        at org.apache.derby.jdbc.AutoloadedDriver.connect(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.Database.makeConnection(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.getConnFromDatabaseName(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.verifyUserIdPassword(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSECCHK(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseDRDAConnection(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;br/&gt;
Cleanup action completed&lt;br/&gt;
2012-08-31 22:41:09.216 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;DRDAConnThread_10,5,main&amp;#93;&lt;/span&gt; (DATABASE = ), (DRDAID = &lt;/p&gt;
{1}
&lt;p&gt;), Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;/p&gt;

&lt;p&gt;I wanted to go ahead and file it even without much information as I noticed there was a similar issue reported on the list but never filed:&lt;br/&gt;
&lt;a href=&quot;http://old.nabble.com/Random-DRDA-Error-on-IBM-J9-JVM-td33532717.html#a33532717&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://old.nabble.com/Random-DRDA-Error-on-IBM-J9-JVM-td33532717.html#a33532717&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12605839">DERBY-5916</key>
            <summary>java.lang.NullPointerException org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop() connecting to network server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                            <label>derby_triage10_10</label>
                    </labels>
                <created>Sat, 1 Sep 2012 05:16:09 +0100</created>
                <updated>Wed, 3 Sep 2014 09:31:26 +0100</updated>
                            <resolved>Mon, 8 Oct 2012 22:50:54 +0100</resolved>
                                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                            <comments>
                            <comment id="13446724" author="bryanpendleton" created="Sat, 1 Sep 2012 15:40:49 +0100"  >&lt;p&gt;This part of the stack is interesting:&lt;/p&gt;

&lt;p&gt;        at org.apache.derby.impl.services.monitor.TopService.shutdown(Unknown Source) &lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.bootService(Unknown Source) &lt;/p&gt;

&lt;p&gt;There&apos;s only one place where bootService calls shutdown like this, and it&apos;s&lt;br/&gt;
in the catch (Throwable) block.&lt;/p&gt;

&lt;p&gt;It sounds like there was such a severe error trying to start up the database that&lt;br/&gt;
we were trying to abort the startup and shutdown the parts that did start.&lt;/p&gt;

&lt;p&gt;But we were in a state where, having failed to start up, we couldn&apos;t shut down, either.&lt;/p&gt;

&lt;p&gt;BaseDataFileFactory.stop is very thorough with its null pointer checks, so it&apos;s not&lt;br/&gt;
easy to see how that code could get a NPE.&lt;/p&gt;

&lt;p&gt;But I notice that line 532, the call to storageFactory.shutdown in this:&lt;/p&gt;

&lt;p&gt;        if (isReadOnly())       // do enough to close all files, then return &lt;/p&gt;
        {
            storageFactory.shutdown();
            return;
        }

&lt;p&gt;isn&apos;t protected by &quot;if( storageFactory != null )&quot;&lt;/p&gt;

&lt;p&gt;Perhaps you could reproduce this artificially by arranging by forcing&lt;br/&gt;
the startup code to throw an exception at just the right point...&lt;/p&gt;
</comment>
                            <comment id="13455874" author="mikem" created="Fri, 14 Sep 2012 16:43:23 +0100"  >&lt;p&gt;triaged for 10.10&lt;/p&gt;

&lt;p&gt;Without a repro, probably not much can be done.  We should at least implement the subtask&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5922&quot; title=&quot;BaseDataFileFactory.stop() should provide better protection for a null storageFactory. Can cause NullPointerException if boot fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5922&quot;&gt;&lt;del&gt;DERBY-5922&lt;/del&gt;&lt;/a&gt;, and maybe that will provide information in the field why this is happening.  &lt;/p&gt;</comment>
                            <comment id="13468743" author="mamtas" created="Wed, 3 Oct 2012 20:01:43 +0100"  >&lt;p&gt;Hi Kathey, do you happen to have the derby.log for the above NPE case?&lt;/p&gt;</comment>
                            <comment id="13468783" author="mamtas" created="Wed, 3 Oct 2012 21:09:34 +0100"  >&lt;p&gt;Attaching a patch with simple change to look if storageFactory is null before calling shutdown on it in BaseDataFileFactory.stop(). This should not break anything but I am running the tests just in case. &lt;/p&gt;</comment>
                            <comment id="13468805" author="kmarsden" created="Wed, 3 Oct 2012 21:35:34 +0100"  >&lt;p&gt;No Sorry Mamta. I wasn&apos;t able to get the derby.log.&lt;/p&gt;
</comment>
                            <comment id="13469044" author="mamtas" created="Thu, 4 Oct 2012 01:57:57 +0100"  >&lt;p&gt;Kathey, do we know what release of Derby was getting used?&lt;/p&gt;</comment>
                            <comment id="13469060" author="mamtas" created="Thu, 4 Oct 2012 02:28:03 +0100"  >&lt;p&gt;It definitely is a good idea to check if storageFactory is null before calling shutdown on it in BaseDataFileFactory.stop(). But I believe we may have gotten NPE somewhere else, especially if we are talking about Derby 10.6 or prior.&lt;/p&gt;

&lt;p&gt;I spent some more time looking at the code in trunk and right before the following check in BaseDataFileFactory.stop()&lt;br/&gt;
        if (isReadOnly()) // do enough to close all files, then return &lt;/p&gt;
        {
            storageFactory.shutdown();
            return;
        }
&lt;p&gt;there is following code&lt;br/&gt;
		removeTempDirectory();&lt;br/&gt;
The call to removeTempDirectory() leads to &lt;br/&gt;
    public final Object run() throws IOException, StandardException&lt;br/&gt;
    {&lt;br/&gt;
        switch( actionCode)&lt;br/&gt;
        {&lt;br/&gt;
        .....;&lt;/p&gt;

&lt;p&gt;        case REMOVE_TEMP_DIRECTORY_ACTION:&lt;br/&gt;
            StorageFile tempDir = storageFactory.getTempDir();&lt;br/&gt;
            if( tempDir != null)&lt;br/&gt;
                tempDir.deleteAll();&lt;br/&gt;
            return null;&lt;br/&gt;
If storageFactory was null, we would have gotten NPE here before we even reach the code where we call storageFactory.stop() in BaseDataFileFactory.stop()&lt;/p&gt;

&lt;p&gt;I will be interested in knowing what version of Derby was being used by the user of this jira. If my theory is correct, then may be they were using 10.6 or earlier release. In 10.6 and prior codelines, we have following piece of code in BaseDataFileFactory.stop() towards the beginning of the method&lt;br/&gt;
		long shutdownTime = System.currentTimeMillis();&lt;br/&gt;
		boolean logBootTrace = PropertyUtil.getSystemBoolean(Property.LOG_BOOT_TRACE);&lt;br/&gt;
		istream.println(LINE);&lt;br/&gt;
		logMsg(&quot;\n&quot; + new Date() +&lt;br/&gt;
Note, that we call istream.println(LINE) without checking if istream is null. This was fixed by Knut as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4873&quot; title=&quot;NullPointerException in testBoundaries with ibm jvm 1.6 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4873&quot;&gt;&lt;del&gt;DERBY-4873&lt;/del&gt;&lt;/a&gt; but that fix went into 10.7. The fix was to use the helper method logMsg() which looks for istream being null and initializing it properly in case it is found null. I think it will be good idea to backport this change from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4873&quot; title=&quot;NullPointerException in testBoundaries with ibm jvm 1.6 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4873&quot;&gt;&lt;del&gt;DERBY-4873&lt;/del&gt;&lt;/a&gt; to 10.6 and earlier releases.&lt;/p&gt;</comment>
                            <comment id="13469130" author="mamtas" created="Thu, 4 Oct 2012 05:00:26 +0100"  >&lt;p&gt;I want to clarify that removeTempDirectory() call from BaseDataFileFactory.stop() will not result into a NPE even if storageFactory is null. This is because removeTempDirectory() checks for the nullability of storageFactory. Part of code in BaseDataFileFactory.stop() is as follows&lt;br/&gt;
       removeTempDirectory();&lt;/p&gt;

&lt;p&gt;       if (isReadOnly())		// do enough to close all files, then return &lt;/p&gt;
       {
	storageFactory.shutdown();
	return;
       }

&lt;p&gt;      // re-enable stub removal until a better method can be found.&lt;br/&gt;
     // only remove stub if caches are cleaned&lt;br/&gt;
    if (removeStubsOK &amp;amp;&amp;amp; OK)	&lt;br/&gt;
	removeStubs();&lt;/p&gt;

&lt;p&gt;With this existing code in trunk, we can run into NPE if storageFactory is null and isReadOnly() returns true. If isReadOnly() returns false, and next if condition is true, then removeStubs() can run into NPE because we do not check for storageFactory nullability.&lt;/p&gt;

&lt;p&gt;So, in addition to nullabiliuty check before calling storageFactory,shutdown(), I will also add a nullability check inside removeStubs().&lt;/p&gt;</comment>
                            <comment id="13469394" author="bryanpendleton" created="Thu, 4 Oct 2012 15:23:17 +0100"  >&lt;p&gt;&amp;gt; in addition to nullabiliuty check before calling storageFactory,shutdown(), I will also add a nullability check inside removeStubs(). &lt;/p&gt;

&lt;p&gt;+1. This seems like a simple and solid approach.&lt;/p&gt;</comment>
                            <comment id="13469547" author="mamtas" created="Thu, 4 Oct 2012 18:48:16 +0100"  >&lt;p&gt;BTW, just for testing purposes, I set storageFactory to null at the beginning of BaseDataFileFactory.stop() and verified that we don&apos;t run into NPE after adding storageFactory nullability check in BaseDataFileFactory.stop() and in BaseDataFileFactory.removeStubs()&lt;/p&gt;</comment>
                            <comment id="13470838" author="mamtas" created="Sat, 6 Oct 2012 02:11:46 +0100"  >&lt;p&gt;Committed changes into trunk with revision 1394883 with following commit comments&lt;br/&gt;
********************&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5916&quot; title=&quot;java.lang.NullPointerException org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop() connecting to network server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5916&quot;&gt;&lt;del&gt;DERBY-5916&lt;/del&gt;&lt;/a&gt; (java.lang.NullPointerException org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop() connecting to network server)&lt;/p&gt;

&lt;p&gt;Check for the nullability of storageFactory before using it in shutdown code&lt;br/&gt;
********************&lt;/p&gt;</comment>
                            <comment id="13471084" author="mamtas" created="Sat, 6 Oct 2012 20:09:49 +0100"  >&lt;p&gt;Backported to 10.9 with revision 1395148&lt;/p&gt;</comment>
                            <comment id="13471110" author="mamtas" created="Sun, 7 Oct 2012 00:03:22 +0100"  >&lt;p&gt;Backported to 10.8 with revision 1395186&lt;/p&gt;</comment>
                            <comment id="13471746" author="mamtas" created="Mon, 8 Oct 2012 19:40:10 +0100"  >&lt;p&gt;Backported to 10.7 with revision 1395709&lt;/p&gt;</comment>
                            <comment id="13471751" author="mamtas" created="Mon, 8 Oct 2012 19:43:19 +0100"  >&lt;p&gt;Backported to 10.6 with revision 1395712&lt;/p&gt;</comment>
                            <comment id="13471898" author="mamtas" created="Mon, 8 Oct 2012 22:49:22 +0100"  >&lt;p&gt;Backported to 10.5 with revision 1395788&lt;/p&gt;</comment>
                            <comment id="14119564" author="knutanders" created="Wed, 3 Sep 2014 09:31:26 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12547586" name="DERBY5916_patch1_diff.txt" size="574" author="mamtas" created="Wed, 3 Oct 2012 21:09:34 +0100"/>
                    </attachments>
                <subtasks>
                            <subtask id="12607097">DERBY-5922</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 1 Sep 2012 14:40:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240053</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxuqxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3181</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>