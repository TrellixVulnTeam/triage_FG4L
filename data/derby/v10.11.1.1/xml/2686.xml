<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:08:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2686/DERBY-2686.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2686] The skip method for some InputStreams and Readers return invalid values</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2686</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The Java API docs for InputStream.skip and Reader.skip seem to indicate that returning a negative value is breaking the contract.&lt;br/&gt;
The contract for Reader.skip is the more clear one, while I have taken the assumption that all Derby InputStreams will return 0 only when EOF has been reached or 0 is passed in as the amount of bytes to skip.&lt;/p&gt;

&lt;p&gt;Bad checking in a skip method also caused Derby to enter an infinite loop in a skip method.&lt;/p&gt;

&lt;p&gt;It should also be noted that skipping bytes/characters should be done in a loop, as skip  is free to skip a smaller amount of bytes than requested. This is true even if EOF is not reached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12370098">DERBY-2686</key>
            <summary>The skip method for some InputStreams and Readers return invalid values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 May 2007 22:43:33 +0100</created>
                <updated>Wed, 20 Jun 2007 08:13:21 +0100</updated>
                            <resolved>Mon, 28 May 2007 17:43:54 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12498393" author="kristwaa" created="Wed, 23 May 2007 22:51:01 +0100"  >&lt;p&gt;Attaching a proposal for a patch for this issue. I&apos;m running tests now and will report back tomorrow.&lt;br/&gt;
If the tests run fine, I plan to commit the patch rather quickly as it causes Derby to hang infinitely in another patch I am working on. I will of course take feedback into account &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The Java API docs leave room for interpretation, but since the InputStreams in question are internal I think the assumption that 0 means EOF is safe. We do not depend on this behavior for user-land streams.&lt;/p&gt;</comment>
                            <comment id="12498396" author="kristwaa" created="Wed, 23 May 2007 22:51:58 +0100"  >&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12498409" author="djd" created="Wed, 23 May 2007 23:23:34 +0100"  >&lt;p&gt;It might be dangerous to make the assumption that 0 means EOF for internal streams. Future changes may wrap/push non-internal streams (e.g. buffering) around internal streams. Thus some code that thought it was reading an internal stream suddenly starts reading a non-internal stream where as defined by InputStream.skip() 0 is a valid return for any number of reasons:&lt;/p&gt;

&lt;p&gt;  &quot;This may result from any of a number of conditions; reaching end of file before n bytes have been skipped is only one possibility. &quot;&lt;/p&gt;

&lt;p&gt;I think it&apos;s wise to use InputStreams according to their contract.&lt;/p&gt;

&lt;p&gt;What problem is being solved here?&lt;/p&gt;

</comment>
                            <comment id="12498575" author="kristwaa" created="Thu, 24 May 2007 11:46:04 +0100"  >&lt;p&gt;As I said, this area is a bit &quot;fuzzzy&quot;...&lt;br/&gt;
What exactly is the contract of InputStream.skip?&lt;/p&gt;

&lt;p&gt;The problem being solved, is an infinite loop when skip returns 0. Since you really can&apos;t tell if the stream just chooses to skip zero bytes, or if EOF has been reached, it is hard to know when to stop calling skip.&lt;br/&gt;
To be more on the safe side, I plan to investigate the possibility of checking for 0 inside the higher level skip-method, then do a read() to check if EOF has been reached or not.&lt;br/&gt;
Have a look at BufferedByteHolderInputStream.skip for an example of code that hangs.&lt;/p&gt;


&lt;p&gt;Secondly, we have readers in Derby that returns -1 in skip, which definitely breaks the contract:&lt;br/&gt;
&quot;This method will block until some characters are available, an I/O error occurs, or the end of the stream is reached.&lt;br/&gt;
Returns:&lt;br/&gt;
    The number of characters actually skipped&quot;&lt;/p&gt;

&lt;p&gt;I will split the patch I submitted into at least two smaller ones, and the patch 1a is also buggy. I forgot to update a check in EmbedClob from -1 to 0, which causes length() to hang.&lt;/p&gt;</comment>
                            <comment id="12498624" author="kristwaa" created="Thu, 24 May 2007 13:35:38 +0100"  >&lt;p&gt;FYI, from this years JavaOne, session &lt;a href=&quot;https://issues.apache.org/jira/browse/TS-2707&quot; title=&quot;Migrate TSRedirectUrlSet/Get to TSHttpTxnRedirectUrlSet/Get&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TS-2707&quot;&gt;&lt;del&gt;TS-2707&lt;/del&gt;&lt;/a&gt; - &quot;Java Puzzlers Episode VI: The Phantom-Reference Menace/Attack of the Clone/Revenge of the Shift&quot; by Joshua Bloch, Google, Inc.; William Pugh, Univ. of Maryland, pdf page 35 and 36:&lt;/p&gt;

&lt;p&gt;&quot;static void skipFully(InputStream in, long nBytes)&lt;br/&gt;
        throws IOException {&lt;br/&gt;
    long remaining = nBytes;&lt;br/&gt;
    while (remaining != 0) &lt;/p&gt;
{
        long skipped = in.skip(remaining);
        if (skipped == 0)
            throw new EOFException();
        remaining -= skipped;
    }
&lt;p&gt;}&quot;&lt;/p&gt;

&lt;p&gt;And the following statements:&lt;br/&gt;
&quot;Moral&lt;br/&gt;
&#8226; The skip method is hard to use and error prone&lt;br/&gt;
&#8226; Use your skipFully instead of skip&lt;br/&gt;
&#8226; There is an RFE to add it to InputStream&lt;br/&gt;
&#8226; More generally, if an API is broken, wrap it&lt;br/&gt;
&#8226; For API designers&lt;br/&gt;
  &#8226; Don&apos;t violate the principle of least astonishment&lt;br/&gt;
  &#8226; Make it easy to do simple things&quot;&lt;/p&gt;

&lt;p&gt;Again, this does not necessarily justify a specific solution/implementation, it is just another data point.&lt;/p&gt;</comment>
                            <comment id="12498816" author="kristwaa" created="Thu, 24 May 2007 21:37:51 +0100"  >&lt;p&gt;&apos;derby-2686-2a-reader.diff&apos; makes UTF8Reader.skip compliant with the contract described in the Java API docs.&lt;/p&gt;

&lt;p&gt;suites.All ran without failures. Running derbyall now.&lt;br/&gt;
The class is only used in one other class, so the change should be quite safe.&lt;/p&gt;

&lt;p&gt;Will wait a little while with the commit in case there are comments.&lt;/p&gt;</comment>
                            <comment id="12498872" author="kristwaa" created="Thu, 24 May 2007 23:31:14 +0100"  >&lt;p&gt;&apos;derby-2686-3a.diff&apos; makes a few changes to some streams. The most important change is that BufferedByteHolderStream jumps out of the loop when the parent reader returns 0. It is up to higher level streams/code to make conclusions about the state of the stream (if EOF is reached etc).&lt;/p&gt;

&lt;p&gt;suites.All ran without failures. Ready for review.&lt;/p&gt;</comment>
                            <comment id="12499418" author="kristwaa" created="Sun, 27 May 2007 18:24:04 +0100"  >&lt;p&gt;Committed &apos;derby-2686-3a.diff&apos; to trunk with revision 542005.&lt;/p&gt;</comment>
                            <comment id="12499608" author="kristwaa" created="Mon, 28 May 2007 17:43:54 +0100"  >&lt;p&gt;Committed &apos;derby-2686-2a-reader.diff&apos; to trunk with revision 542269.&lt;br/&gt;
No more work is expected on this issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12358034" name="derby-2686-1a.diff" size="4874" author="kristwaa" created="Wed, 23 May 2007 22:51:01 +0100"/>
                            <attachment id="12358035" name="derby-2686-1a.stat" size="502" author="kristwaa" created="Wed, 23 May 2007 22:51:01 +0100"/>
                            <attachment id="12358157" name="derby-2686-2a-reader.diff" size="1609" author="kristwaa" created="Thu, 24 May 2007 21:37:51 +0100"/>
                            <attachment id="12358158" name="derby-2686-2a-reader.stat" size="123" author="kristwaa" created="Thu, 24 May 2007 21:37:51 +0100"/>
                            <attachment id="12358169" name="derby-2686-3a.diff" size="2468" author="kristwaa" created="Thu, 24 May 2007 23:31:13 +0100"/>
                            <attachment id="12358170" name="derby-2686-3a.stat" size="240" author="kristwaa" created="Thu, 24 May 2007 23:31:13 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 23 May 2007 22:23:34 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23179</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy11m7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39912</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>