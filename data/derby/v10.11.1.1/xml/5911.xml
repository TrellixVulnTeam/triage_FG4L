<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:30:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5911/DERBY-5911.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5911] WHERE condition getting pushed into sub-query with FETCH</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5911</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Derby pushes query conditions down into subqueries with FETCH limits, thus creating wrong results. Take the following snippet:&lt;/p&gt;

&lt;p&gt;    CREATE TABLE COFFEES (COF_NAME VARCHAR(254),PRICE INTEGER);&lt;/p&gt;

&lt;p&gt;    INSERT INTO COFFEES (COF_NAME,PRICE) VALUES (&apos;Colombian&apos;,       5);&lt;br/&gt;
    INSERT INTO COFFEES (COF_NAME,PRICE) VALUES (&apos;French_Roast&apos;,    5);&lt;br/&gt;
    INSERT INTO COFFEES (COF_NAME,PRICE) VALUES (&apos;Colombian_Decaf&apos;, 20);&lt;/p&gt;

&lt;p&gt;    select COF_NAME, PRICE from COFFEES order by COF_NAME fetch next 2 rows only;&lt;/p&gt;

&lt;p&gt;    select * from (&lt;br/&gt;
      select COF_NAME, PRICE from COFFEES order by COF_NAME fetch next 2 rows only&lt;br/&gt;
    ) t where t.PRICE &amp;lt; 10;&lt;/p&gt;

&lt;p&gt;The first query correctly returns the rows (Colombian,5), (Colombian_Decaf,20).&lt;/p&gt;

&lt;p&gt;The second query (which filters the result of the first one) returns (Colombian,5), (French_Roast,5). The row (French_Roast,5) should not be there since it is not a result of the first query. It shows up because (supposedly) the filter condition has been evaluated before the fetch limit.&lt;/p&gt;</description>
                <environment>Tested with Derby 10.9.1.0 on Windows 7 x64, Java 1.6.0_27-b07 server</environment>
        <key id="12605202">DERBY-5911</key>
            <summary>WHERE condition getting pushed into sub-query with FETCH</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="szeiger">Stefan Zeiger</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Aug 2012 12:18:36 +0100</created>
                <updated>Sun, 25 Nov 2012 20:14:47 +0000</updated>
                            <resolved>Wed, 12 Sep 2012 23:53:44 +0100</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13443082" author="szeiger" created="Tue, 28 Aug 2012 12:36:43 +0100"  >&lt;p&gt;Note that this attempt at a work-around suffers from the same issue:&lt;/p&gt;

&lt;p&gt;    select cof_name, price from (&lt;br/&gt;
      select row_number() over() as rownum, COF_NAME, PRICE from (select * from COFFEES order by COF_NAME) t&lt;br/&gt;
    ) as t where t.rownum &amp;lt;= 2 and t.PRICE &amp;lt; 10&lt;/p&gt;</comment>
                            <comment id="13446534" author="dagw" created="Sat, 1 Sep 2012 01:46:01 +0100"  >&lt;p&gt;Uploading a patch for this issue. The problem is, as suggested, that the predicate is pushed down during optimization. In presence of ROW_NUMBER and/or FETCH/OFFSET, this cannot be presumed not be correct.&lt;/p&gt;

&lt;p&gt;The patch adds logic to check for this, and adds new test cases to OrderByAndOffsetFetchInSubqueries.&lt;/p&gt;

&lt;p&gt;Running regressions.&lt;/p&gt;</comment>
                            <comment id="13447946" author="knutanders" created="Tue, 4 Sep 2012 19:56:53 +0100"  >&lt;p&gt;The fix looks right to me. The patch seems to prevent the predicate from being pushed if any of the sub-queries under the query with the fetch clause is ordered. Is that broader than it needs to be? Could it be pushed further down until it reaches the node on top of the ordered one?&lt;/p&gt;</comment>
                            <comment id="13452134" author="dagw" created="Mon, 10 Sep 2012 17:47:45 +0100"  >&lt;p&gt;Yes that is true, and we&apos;d want to stop pushing one level above the FETCH/OFFSET or windowing, since the WHERE clause is evaluated before the ORDER BY. I&apos;ll see if I can make it better without complicating the code too much.&lt;/p&gt;</comment>
                            <comment id="13452143" author="dagw" created="Mon, 10 Sep 2012 17:53:41 +0100"  >&lt;p&gt;If there is no ORDER BY inside the FETCH/OFFSET or windowing, one could push the predicate all the way without breaking SQL semantics, but it might still confuse users (give unexpected results), since the row order is usually deterministic in Derby, so it might be a good idea to never push past FETCH/OFFSET or windowing, what do you think?&lt;/p&gt;</comment>
                            <comment id="13452369" author="mamtas" created="Mon, 10 Sep 2012 20:50:38 +0100"  >&lt;p&gt;Can the OFFSET clause in combination with order by cause any problems? &lt;/p&gt;</comment>
                            <comment id="13452402" author="mamtas" created="Mon, 10 Sep 2012 21:14:07 +0100"  >&lt;p&gt;I tried following script in ij for OFFSET(notice the data here is different than the earlier script in this jira)&lt;/p&gt;

&lt;p&gt;CREATE TABLE COFFEES (COF_NAME VARCHAR(254),PRICE INTEGER); &lt;br/&gt;
INSERT INTO COFFEES (COF_NAME,PRICE) VALUES (&apos;Colombian&apos;, 5);&lt;br/&gt;
INSERT INTO COFFEES (COF_NAME,PRICE) VALUES (&apos;French_Roast&apos;, 15);&lt;br/&gt;
INSERT INTO COFFEES (COF_NAME,PRICE) VALUES (&apos;Colombian_Decaf&apos;, 15);&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select COF_NAME, PRICE from COFFEES order by COF_NAME offset 1 rows;&lt;br/&gt;
COF_NAME                                                                                                                        |PRICE&lt;br/&gt;
--------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
Colombian_Decaf                                                                                                                 |15&lt;br/&gt;
French_Roast                                                                                                                    |15&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from(&lt;br/&gt;
select COF_NAME, PRICE from COFFEES order by  COF_NAME offset 1 rows&lt;br/&gt;
)t where t.price&amp;gt;10;&lt;br/&gt;
COF_NAME                                                                                                                        |PRICE&lt;br/&gt;
--------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
French_Roast                                                                                                                    |15&lt;/p&gt;

&lt;p&gt;If I understand this correctly, the last query should have returned two rows.&lt;/p&gt;</comment>
                            <comment id="13452515" author="dagw" created="Mon, 10 Sep 2012 23:14:07 +0100"  >&lt;p&gt;Yes, the OFFSET clause alone is also susceptible to the problem. I thought my patch addressed that also? Did you run this query against the patch, Mamta?&lt;/p&gt;</comment>
                            <comment id="13452521" author="mamtas" created="Mon, 10 Sep 2012 23:18:56 +0100"  >&lt;p&gt;Dag, I will try the patch for the OFFSET clause query and see how that goes. We probably should add a test case for OFFSET in the new test fixture. Also, I was wondering if the comments in ProjectRestrictNode.java should mention OFFSET and FETCH along with windows function for ORDER BY. Thanks&lt;/p&gt;</comment>
                            <comment id="13452555" author="dagw" created="Tue, 11 Sep 2012 00:09:29 +0100"  >&lt;p&gt;Thanks, Mamta. Uploaded version b of this patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added comment as suggested in PRN also for FETCH/OFFSET&lt;/li&gt;
	&lt;li&gt;added test case for OFFSET alone&lt;/li&gt;
	&lt;li&gt;removed check for nested ORDER BY: there should always be one if windowing or FETCH/OFFSET is used, and if the user has omitted it, I think it&apos;s better to avoid pushing in any case (least surprise principle)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Running regressions.&lt;/p&gt;</comment>
                            <comment id="13452561" author="dagw" created="Tue, 11 Sep 2012 00:15:47 +0100"  >&lt;p&gt;Knut: I refrained from pushing inside, cf item #3 above.&lt;/p&gt;</comment>
                            <comment id="13452818" author="knutanders" created="Tue, 11 Sep 2012 09:23:57 +0100"  >&lt;p&gt;&amp;gt; Knut: I refrained from pushing inside, cf item #3 above.&lt;/p&gt;

&lt;p&gt;+1. It makes sense to keep the fix simple for now. If someone comes up with a real-world example that&apos;s meaningful without ORDER BY, and whose performance would benefit from predicate push-down, we can always add more sophisticated logic later.&lt;/p&gt;</comment>
                            <comment id="13454122" author="dagw" created="Wed, 12 Sep 2012 17:54:58 +0100"  >&lt;p&gt;Regressions ran ok, committed as svn 1384035.&lt;/p&gt;</comment>
                            <comment id="13454134" author="dagw" created="Wed, 12 Sep 2012 18:13:18 +0100"  >&lt;p&gt;Backported to 10.9 as svn 1384041.&lt;/p&gt;</comment>
                            <comment id="13454456" author="dagw" created="Wed, 12 Sep 2012 23:53:00 +0100"  >&lt;p&gt;Backported to 10.8 as svn 1384155, resolving. Stefan, if you are OK with the fix, please close this issue.&lt;/p&gt;</comment>
                            <comment id="13455344" author="mamtas" created="Thu, 13 Sep 2012 22:45:14 +0100"  >&lt;p&gt;I forgot to add a comment that I ran ij script with OFFSET(from jira comment 10/Sep/12 21:14) after applying Dag&apos;s patch and it gave the correct results.&lt;/p&gt;</comment>
                            <comment id="13455955" author="dagw" created="Fri, 14 Sep 2012 18:18:28 +0100"  >&lt;p&gt;Thanks for confirming that, Mamta!&lt;/p&gt;</comment>
                            <comment id="13457772" author="szeiger" created="Tue, 18 Sep 2012 13:28:35 +0100"  >&lt;p&gt;The fix works for me (tested with current source from branches/10.9 vs 10.9.1.0 binaries).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12543383" name="derby5911a.diff" size="5449" author="dagw" created="Sat, 1 Sep 2012 01:46:01 +0100"/>
                            <attachment id="12543384" name="derby5911a.stat" size="258" author="dagw" created="Sat, 1 Sep 2012 01:46:01 +0100"/>
                            <attachment id="12544556" name="derby5911b.diff" size="4042" author="dagw" created="Tue, 11 Sep 2012 00:12:51 +0100"/>
                            <attachment id="12544555" name="derby5911b.stat" size="188" author="dagw" created="Tue, 11 Sep 2012 00:09:29 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 1 Sep 2012 00:46:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245806</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy09vb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35417</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>