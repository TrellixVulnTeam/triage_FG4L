<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:33:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3934/DERBY-3934.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3934] Improve performance of reading modified Clobs</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3934</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The performance of reading modified Clobs is poor, which is demonstrated by running a test program selecting a 10 MB Clob and then getting the contents using getSubString:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;unmodified Clob (StoreStreamClob) : ~1 300 ms&lt;/li&gt;
	&lt;li&gt;modified Clob (TemporaryClob): ~156 000 ms&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case, the Clob was modified by changing the first character.&lt;/p&gt;

&lt;p&gt;A number of subtasks will be created to handle the various issues, which will be related to both performance and code cleanup.&lt;br/&gt;
For a brief overview, see &lt;a href=&quot;http://www.nabble.com/Suggestion-for-improving-ClobUpdatableReader-and-related-code-to20308303.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Suggestion-for-improving-ClobUpdatableReader-and-related-code-to20308303.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12407840">DERBY-3934</key>
            <summary>Improve performance of reading modified Clobs</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Nov 2008 10:41:41 +0000</created>
                <updated>Mon, 4 May 2009 19:22:26 +0100</updated>
                            <resolved>Mon, 2 Mar 2009 12:23:32 +0000</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="12650617" author="kristwaa" created="Tue, 25 Nov 2008 16:36:15 +0000"  >&lt;p&gt;&apos;derby-3934-1a-clob_replace_test.diff&apos; adds two simple tests where the characters of a Clob containing multi-byte chars are replaced one by one - forwards and backwards.&lt;br/&gt;
This test can detect errors in the positioning logic and incorrect offsets/positions in the internal stream descriptors.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;br/&gt;
I will commit this patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="12650659" author="kristwaa" created="Tue, 25 Nov 2008 18:14:52 +0000"  >&lt;p&gt;&apos;derby-3934-2a-intclob_new_methods.diff&apos; adds two new methods to the InternalClob interface; getUpdateCount and isReleased.&lt;br/&gt;
They can be used to determine if the content of a Clob has been changed, and if the internal Clob representation has been changed or the Clob has been closed.&lt;br/&gt;
The isReleased() method will be used to detect when a read-only Clob representation is changed to a writable representation due to a user&apos;s request to modify the content (i.e. setString).&lt;/p&gt;

&lt;p&gt;The code is currently not being used, but it will be by the new implementation of ClobUpdatableReader (not yet posted - I do have a prototype if anyone is interested).&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12650900" author="kristwaa" created="Wed, 26 Nov 2008 08:43:29 +0000"  >&lt;p&gt;Committed patch 1a to trunk with revision 720767.&lt;/p&gt;</comment>
                            <comment id="12651333" author="kristwaa" created="Thu, 27 Nov 2008 11:53:27 +0000"  >&lt;p&gt;Committed patch 2a to trunk with revision 721162.&lt;/p&gt;</comment>
                            <comment id="12653338" author="kristwaa" created="Thu, 4 Dec 2008 16:08:35 +0000"  >&lt;p&gt;&apos;derby-3934-3a-clobupdreader_utf8reader.diff&apos; makes the handling of&lt;br/&gt;
StoreStreamClob and TemporaryClob consistent.&lt;/p&gt;

&lt;p&gt;The following files are touched (all in derby.impl.jdbc):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;EmbedClob.&lt;br/&gt;
 Updated call to ClobUpdatableReader. The change of the position argument is&lt;br/&gt;
 intentional.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;TemporaryClob&lt;br/&gt;
 Replaced the ClobUpdatableReader returned by getReader with a UTF8Reader.&lt;br/&gt;
 Internal handling of TemporaryClob should deal with changing contents&lt;br/&gt;
 specifically, or create a ClobUpdatableReader where required.&lt;br/&gt;
 Note also the use of the new CharacterStreamDescriptor class. This piece of&lt;br/&gt;
 code will probably be changed later on, when there is more information about&lt;br/&gt;
 the stream available. For instance, caching byte/char positions allows to skip&lt;br/&gt;
 directly to the byte position through the underlying file API. This way, we&lt;br/&gt;
 don&apos;t have to decode all the raw bytes to skip the correct number of chars.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;ClobUpdatableReader&lt;br/&gt;
 More or less rewritten. It now uses the new methods exposed by InternalClob to&lt;br/&gt;
 detect changes in the underlying Clob content. Note that this class doesn&apos;t&lt;br/&gt;
 handle repositioning, only detection of changes and forwarding of read/skip&lt;br/&gt;
 calls.&lt;br/&gt;
 Note the lazy initialization of the underlying reader.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; WARNING: There is one thing missing, which is proper synchronization. Access to&lt;br/&gt;
 store will be synchronized in other locations, but this class is not thread&lt;br/&gt;
 safe. I haven&apos;t decided yet whether to synchronize on the reader object or the&lt;br/&gt;
 root connection. I think the latter is the best choice. Does anyone know&lt;br/&gt;
 anything about the cost of taking locks on the same object multiple times?&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;StoreStreamClob&lt;br/&gt;
 Replaced old UTF8Reader constructor with the new one. Again, this code needs&lt;br/&gt;
 to be updated when more information about the stream is available. This is to&lt;br/&gt;
 allow UTF8Reader to perform better.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;UTF8Reader&lt;br/&gt;
 Added a new constructor, using the new CharacterStreamDescriptor class.&lt;br/&gt;
 Removed one constructor.&lt;br/&gt;
 Retrofitted the second old constructor to use CharacterStreamDescriptor. This&lt;br/&gt;
 will be removed when the calling code has been updated.&lt;br/&gt;
 The old method calculating the buffer size will also be removed.&lt;br/&gt;
 Stopped referencing PositionedStoreStream, using PositionedStream interface&lt;br/&gt;
 instead. This allows the positioning logic to be used for both store streams&lt;br/&gt;
 and LOBInputStream streams.&lt;br/&gt;
 The reader has been prepared to be able to deal with multiple data offsets,&lt;br/&gt;
 i.e. handling several store stream formats. For instance, the current&lt;br/&gt;
 implementations has an offset of two bytes, where as the planned new one will&lt;br/&gt;
 have an offset of at least five bytes. LOBInputStream has an offset of zero&lt;br/&gt;
 bytes (no header information).&lt;br/&gt;
 From now on, position aware streams are not closed as early as before, because&lt;br/&gt;
 we might have go backwards in the stream. Streams that can only move forwards&lt;br/&gt;
 are closed as soon as possible (as before).&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Tests are running, and about 3/4 finished. No errors so far. I will post final&lt;br/&gt;
 results later.&lt;br/&gt;
 Patch ready for review.&lt;/p&gt;


&lt;p&gt; The plan forwards&lt;br/&gt;
 -----------------&lt;br/&gt;
 After patch 3a is in, I plan to do the following;&lt;br/&gt;
  1) Implement TemporaryClob.getInternalReader().&lt;br/&gt;
     This will dramatically improve the Clob.getSubString performance for&lt;br/&gt;
     modified Clobs.&lt;br/&gt;
  2) I will consider adding a simple byte/char position cache.&lt;br/&gt;
     The point of this is to be able to skip to a given byte position without&lt;br/&gt;
     having to decode byte into chars. This is a mechanism that will only help&lt;br/&gt;
     certain access patterns, but it should come with a very low overhead.&lt;br/&gt;
  3) Continue working with the new Clob format.&lt;br/&gt;
     When it is in place, care must be taken to utilize the new steam&lt;br/&gt;
     information where possible. The primary one is returning the length through&lt;br/&gt;
     Clob.length(). A second opportunity is using the length information to take&lt;br/&gt;
     decisions in the byte/char position cache.&lt;br/&gt;
     This work is mostly related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3907&quot; title=&quot;Save useful length information for Clobs in store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3907&quot;&gt;&lt;del&gt;DERBY-3907&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;m using the simple Clob regression tests in my work, and it has already&lt;br/&gt;
revealed a bug &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I had forgotten to include the know byte length in the&lt;br/&gt;
CharacterStreamDescription, which caused UTF8Reader to allocate a buffer that&lt;br/&gt;
was way too big (8K instead of 100 bytes).&lt;br/&gt;
The last step in my LOB work will be to write a simple report documenting the&lt;br/&gt;
improvements.&lt;/p&gt;</comment>
                            <comment id="12654353" author="kristwaa" created="Mon, 8 Dec 2008 09:09:21 +0000"  >&lt;p&gt;Tests ran without errors.&lt;/p&gt;

&lt;p&gt;Committed patch 3a to trunk with revision 724294.&lt;/p&gt;</comment>
                            <comment id="12655169" author="kristwaa" created="Wed, 10 Dec 2008 10:30:16 +0000"  >&lt;p&gt;Patch &apos;derby-3934-4a-getinternalreader_cachedlength.diff&apos; improves the performance of Clob.getSubString when the Clob is represented by a TemporaryClob.&lt;/p&gt;

&lt;p&gt;The main change in the patch is the implementation of TemporaryClob.getInternalReader(long).&lt;br/&gt;
The second important change is that TemporaryClob now caches the character length. When the contents are changed, the length is either reset or updated accordingly if possible.&lt;br/&gt;
I also added some length to verify that the length is correctly updated on Clob modifications.&lt;/p&gt;

&lt;p&gt;On my machine I see the following durations (one iteration) for ClobAccessTest.testFetchLargeClobPieceByPieceModified:&lt;br/&gt;
trunk ~76&apos;000 ms&lt;br/&gt;
with patch 4a ~600 ms&lt;br/&gt;
So with the patch the test completes in less than 1% of the time used by trunk. This is saved CPU time.&lt;/p&gt;

&lt;p&gt;Regressing tests are running.&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12656604" author="kristwaa" created="Mon, 15 Dec 2008 11:40:49 +0000"  >&lt;p&gt;Committed patch 4a to trunk with revision 726683.&lt;/p&gt;

&lt;p&gt;Work remaining:&lt;br/&gt;
  o See if a byte/char position cache can be used &lt;span class=&quot;error&quot;&gt;&amp;#91;more efficiently&amp;#93;&lt;/span&gt; to improve repositioning performance.&lt;br/&gt;
  o Cleaning up after the changes in UTF8Reader.&lt;/p&gt;</comment>
                            <comment id="12665122" author="kristwaa" created="Mon, 19 Jan 2009 13:35:40 +0000"  >&lt;p&gt;Patch 5a removes a constructor and a method called only from that constructor.&lt;br/&gt;
Updated the code in EmbedCallableStatement20 to use the new constructor.&lt;/p&gt;

&lt;p&gt;Running regression tests, will commit tomorrow if the tests pass.&lt;/p&gt;</comment>
                            <comment id="12665418" author="kristwaa" created="Tue, 20 Jan 2009 12:26:31 +0000"  >&lt;p&gt;Regression tests for patch 5a ran without failures.&lt;br/&gt;
Committed to trunk with revision 736000.&lt;/p&gt;</comment>
                            <comment id="12671800" author="kristwaa" created="Mon, 9 Feb 2009 10:46:44 +0000"  >&lt;p&gt;Patch 6a removes the now unused method &apos;readUnsignedShort&apos;. It is no longer used because the reading of the header bytes have been moved outside the reader class.&lt;/p&gt;

&lt;p&gt;Committed to trunk with revision 742380.&lt;/p&gt;</comment>
                            <comment id="12677971" author="kristwaa" created="Mon, 2 Mar 2009 12:23:32 +0000"  >&lt;p&gt;Closing this issue.&lt;br/&gt;
Some performance results (embedded only) can be seen here: &lt;a href=&quot;http://www.nabble.com/CLOB-performance-td21831259.html#a21831259&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/CLOB-performance-td21831259.html#a21831259&lt;/a&gt;&lt;br/&gt;
The most relevant result is testFetchLargeClobPieceByPieceModified, followed by testFetchLargeClobOneByOneCharModified and testFetchLargeClobsModified.&lt;/p&gt;

&lt;p&gt;There&apos;s a small performance hit for the testFetchLargeClobsModified, this may be because we create update sensitive streams unconditionally and that UTF8Reader has been equipped with more functionality. However, the changes to UTF8Reader are required to obtain acceptable performance with the client driver, which always fetches CLOBs piece by piece (through a callable statement using Clob.getSubString).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12394660" name="derby-3934-1a-clob_replace_test.diff" size="3106" author="kristwaa" created="Tue, 25 Nov 2008 16:36:15 +0000"/>
                            <attachment id="12394677" name="derby-3934-2a-intclob_new_methods.diff" size="3650" author="kristwaa" created="Tue, 25 Nov 2008 18:14:52 +0000"/>
                            <attachment id="12395294" name="derby-3934-3a-clobupdreader_utf8reader.diff" size="30315" author="kristwaa" created="Thu, 4 Dec 2008 16:08:35 +0000"/>
                            <attachment id="12395295" name="derby-3934-3a-clobupdreader_utf8reader.stat" size="326" author="kristwaa" created="Thu, 4 Dec 2008 16:08:35 +0000"/>
                            <attachment id="12395725" name="derby-3934-4a-getinternalreader_cachedlength.diff" size="12631" author="kristwaa" created="Wed, 10 Dec 2008 10:30:16 +0000"/>
                            <attachment id="12398233" name="derby-3934-5a-UTF8Reader_cleanup.diff" size="8302" author="kristwaa" created="Mon, 19 Jan 2009 13:35:40 +0000"/>
                            <attachment id="12399809" name="derby-3934-6a-UTF8Reader_remove_method.diff" size="1137" author="kristwaa" created="Mon, 9 Feb 2009 10:46:44 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12407843">DERBY-3935</subtask>
                            <subtask id="12407845">DERBY-3936</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31066</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>