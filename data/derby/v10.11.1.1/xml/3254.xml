<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:17:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3254/DERBY-3254.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3254] Implement the replication failover functionality</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3254</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description></description>
                <environment></environment>
        <key id="12383943">DERBY-3254</key>
            <summary>Implement the replication failover functionality</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12372418">DERBY-2872</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="narayanan">V.Narayanan</assignee>
                                    <reporter username="narayanan">V.Narayanan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Dec 2007 05:06:16 +0000</created>
                <updated>Tue, 14 Apr 2009 04:01:56 +0100</updated>
                            <resolved>Thu, 6 Mar 2008 23:10:42 +0000</resolved>
                                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12553206" author="narayanan" created="Wed, 19 Dec 2007 02:31:01 +0000"  >&lt;p&gt;Upon receiving a failover command the following sequence will be followed&lt;/p&gt;

&lt;p&gt;1) Stop the master&lt;br/&gt;
2) Flush the buffer&lt;br/&gt;
3) Send the failover command to the slave.&lt;br/&gt;
4) slave receives the failover command and performs failover.&lt;/p&gt;

&lt;p&gt;The flush buffer implementation can be shared with the stop command implementation. Also&lt;br/&gt;
the stop implementation will conflict with the stop implementation as they affect the same&lt;br/&gt;
files. Hence I am posting a preliminary patch for now, which I hope to refine later.&lt;/p&gt;</comment>
                            <comment id="12554093" author="narayanan" created="Sat, 22 Dec 2007 07:55:50 +0000"  >&lt;p&gt;I have removed the conflicts and generated a fresh patch. I request for this patch to be&lt;br/&gt;
please considered for a review.&lt;/p&gt;</comment>
                            <comment id="12555521" author="oysteing" created="Thu, 3 Jan 2008 10:04:41 +0000"  >&lt;p&gt;Thanks for the patch, Narayanan.  My main question about this patch is&lt;br/&gt;
about failure handling during failover.  If failover is not&lt;br/&gt;
successful, I think the current master should continue as master.&lt;br/&gt;
Also, I am not sure that just being able to send the failover message&lt;br/&gt;
is sufficient to decide that failover was successful.  Maybe some&lt;br/&gt;
acknowledgement from the slave is needed?&lt;/p&gt;

&lt;p&gt;As it is, the implementation of stop and failover is identical at the&lt;br/&gt;
slave.  I guess it is the implementation of stop that is missing&lt;br/&gt;
something?&lt;/p&gt;

&lt;p&gt;Some minor issues:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LogToFile#stopReplicationSlaveRole(): I think the javadoc here is&lt;br/&gt;
    a bit inaccurate.  AFAIU, setting the inReplicationSlaveMode flag&lt;br/&gt;
    will make the slave complete recovery and boot the database.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There is a double ; in SlaveController#failover.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think a successful failover should also be recorded in derby.log&lt;br/&gt;
    also at the (former) slave.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There is a typo in the message text for R011: &quot;perfomed&quot;&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12557915" author="narayanan" created="Fri, 11 Jan 2008 06:26:11 +0000"  >&lt;p&gt;I will change this patch to do the following&lt;/p&gt;

&lt;p&gt;1) Master initiates failover by sending a failover message to the slave and waits for the &lt;br/&gt;
   acknowledgment from the slave. (Slave will send an acknowledgement if its attempt to&lt;br/&gt;
   failover succeeds.)&lt;br/&gt;
2) If the acknowledgment is received it proceeds with failover.&lt;br/&gt;
3) Otherwise it continues as master without doing anything.&lt;/p&gt;</comment>
                            <comment id="12557916" author="narayanan" created="Fri, 11 Jan 2008 06:29:19 +0000"  >&lt;p&gt;I am proceeding to remove the stopSlave method implementation I had added here&lt;br/&gt;
to the stop issue which needs to be reopened to address the comments there, the&lt;br/&gt;
slave issue seemed to me the better context to address this issue.&lt;/p&gt;</comment>
                            <comment id="12558198" author="narayanan" created="Sat, 12 Jan 2008 04:19:14 +0000"  >&lt;p&gt;Before starting to make the patch there are a few things I thought I should detail out&lt;/p&gt;

&lt;p&gt;I had earlier decided on the following set of steps to implement failover&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The failover command is given to the master.&lt;/li&gt;
	&lt;li&gt;The master flushes the log buffer&lt;/li&gt;
	&lt;li&gt;The master sends this command to the slave and waits for a response&lt;/li&gt;
	&lt;li&gt;The slave responds with an acknowledgement&lt;/li&gt;
	&lt;li&gt;The master stops replication&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There are a few refinements to these steps that would become necessary because of the&lt;br/&gt;
following issues&lt;/p&gt;

&lt;p&gt;1) When the master stops replication is it necessary for it to shutdown the database?&lt;/p&gt;

&lt;p&gt;I believe the answer is YES because there is no point in having the master serving clients &lt;br/&gt;
when the slave is doing likewise for the same database. Having two databases serving clients&lt;br/&gt;
would create trouble for the users.&lt;/p&gt;

&lt;p&gt;2) In the aforementioned steps there is a window between the stop master operation &lt;br/&gt;
(not shutting down database), sending a failover command to the slave, not succeeding, &lt;br/&gt;
restarting master operation.&lt;/p&gt;

&lt;p&gt;Stopping master, flushes the log buffer, and stops the log buffer from buffering more records.&lt;/p&gt;

&lt;p&gt;But this does not stop the clients being served. So the next time you start replication you &lt;br/&gt;
would be inconsistent. &lt;/p&gt;

&lt;p&gt;Therefore we would need to stop clients in some way before flushing the log buffer.&lt;/p&gt;

&lt;p&gt;The above two issues lead to the following refinements in the steps mentioned earlier&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The failover command is given to the master&lt;/li&gt;
	&lt;li&gt;We stop the clients upon receiving this command&lt;/li&gt;
	&lt;li&gt;The master Flushes the log buffer&lt;/li&gt;
	&lt;li&gt;The master sends the failover command to the slave and waits for&lt;br/&gt;
a response&lt;/li&gt;
	&lt;li&gt;The slave responds with a acknowledgement&lt;/li&gt;
	&lt;li&gt;The master stops replication and shuts down the database.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the event of a failure the master would resume serving clients.&lt;/p&gt;</comment>
                            <comment id="12558726" author="narayanan" created="Mon, 14 Jan 2008 18:53:23 +0000"  >&lt;p&gt;I have implemented the failover in keeping with the steps mentioned in the aforementioned comments.&lt;br/&gt;
I have made one small change in that the failover implementation will now throw an exception&lt;br/&gt;
in both the cases of the failover succeeding and failing. I decided on this because when failover&lt;br/&gt;
succeeds the master database is shutdown, at this juncture there might be number of clients connected&lt;br/&gt;
which need to be informed of this shutdown. A good way to do this would be to throw an exception.&lt;/p&gt;

&lt;p&gt;I am yet to run tests on this patch. I shall run the tests and shall revert back with the results.&lt;/p&gt;</comment>
                            <comment id="12559451" author="narayanan" created="Wed, 16 Jan 2008 11:36:50 +0000"  >&lt;p&gt;The stopmaster patch had a conflict with v2. fixed it here.&lt;/p&gt;</comment>
                            <comment id="12559458" author="oysteing" created="Wed, 16 Jan 2008 12:00:32 +0000"  >&lt;p&gt;Thanks for the patch, Narayanan.  Her are my comments:&lt;/p&gt;

&lt;p&gt;1. Instead of using Database#freeze, think you should use&lt;br/&gt;
   RawStoreFactory#freeze since MasterController relates to the store,&lt;br/&gt;
   and not the SQL layer.  This also removes the need for importing&lt;br/&gt;
   SQLException.&lt;/p&gt;

&lt;p&gt;2. Maybe I am wrong, but it seems to me that you are shutting down the&lt;br/&gt;
   entire system.  At least, you do not specify which database to shut&lt;br/&gt;
   down.  Instead of an explicit shutdown, I think you should consider&lt;br/&gt;
   to just use database severity for the exception you throw.  I think&lt;br/&gt;
   that will make the connection close down the database&lt;br/&gt;
   automatically.&lt;/p&gt;

&lt;p&gt;3. MasterController#handleFailoverFailure:  Don&apos;t you mean to use&lt;br/&gt;
   REPLICATION_FAILOVER_UNSUCCESSFUL also for the else part?&lt;/p&gt;

&lt;p&gt;4. Some of my comments to the previous version of the patch does not&lt;br/&gt;
   seem to have been addressed.&lt;/p&gt;
</comment>
                            <comment id="12559898" author="narayanan" created="Thu, 17 Jan 2008 11:09:52 +0000"  >&lt;p&gt;Thank you for the comments/reviews of the patch Oystein. I addressed all the issues pointed out by you (including those of the previous reviews). My apologies for having missed out on this on the earlier patch.&lt;/p&gt;

&lt;p&gt;I request for this patch to be please considered for reviews/comments.&lt;/p&gt;

&lt;p&gt;I will run tests in this patch and shall revert back with the results.&lt;/p&gt;</comment>
                            <comment id="12560520" author="oysteing" created="Fri, 18 Jan 2008 19:41:57 +0000"  >&lt;p&gt;With the latest patch,  failover_impl_v4.diff , I get an error in the ErrorCodeTest. &lt;br/&gt;
It is probably related to the fact that a database severity error as been added.&lt;/p&gt;

&lt;p&gt;While fixing this, here is some minor issues that should also be addressed:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Update javadoc of MasterFactory/MasterController#startFailover to indicate that it will throw an exception also on success.&lt;/li&gt;
	&lt;li&gt;Some unecessary imports (Property, SQLException)&lt;/li&gt;
	&lt;li&gt;The text of the javadoc for LogToFile#stopReplicationSlaveRole could still be improved.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12560787" author="narayanan" created="Sun, 20 Jan 2008 09:04:54 +0000"  >&lt;p&gt;1) The exception being thrown upon successful failover in MasterController#startFailover &lt;br/&gt;
     needs to moved outside the try catch block.&lt;br/&gt;
2) If failover is successful AsynchonousLogShipper#stopLogShippment needs to be called&lt;br/&gt;
    to terminate the log shipper thread.&lt;/p&gt;</comment>
                            <comment id="12560927" author="narayanan" created="Mon, 21 Jan 2008 03:56:27 +0000"  >&lt;p&gt;I have addressed all the comments pointed out and have also fixed&lt;br/&gt;
the ErrorCodeTest failure.&lt;/p&gt;

&lt;p&gt;I am running tests on this patch and shall post the results of the&lt;br/&gt;
run by today afternoon.&lt;/p&gt;

&lt;p&gt;I request for this patch to be considered for reviews and comments.&lt;/p&gt;</comment>
                            <comment id="12560983" author="oysteing" created="Mon, 21 Jan 2008 10:55:48 +0000"  >&lt;p&gt;I do not understand the change to MasterController#startFailover.  It seems like handleFailoverFailure will be called in all cases now.  Also, exceptions thrown by handleFailoverFailure called from the try block, will be caught and passed to handeFailoverFailure by the catch block.  That seems a bit unnecessary.  I think the whole handling of ack, as it was in v4 of the patch, should be moved outside the try block.&lt;/p&gt;</comment>
                            <comment id="12561214" author="narayanan" created="Tue, 22 Jan 2008 04:11:44 +0000"  >&lt;p&gt;I have moved the handling of ack outside the try catch block.&lt;br/&gt;
I shall run tests on this patch and shall revert back with the&lt;br/&gt;
results.&lt;/p&gt;</comment>
                            <comment id="12561310" author="narayanan" created="Tue, 22 Jan 2008 11:38:41 +0000"  >&lt;p&gt;I ran the tests on this patch and had a clean run of the junit all suite. &lt;/p&gt;</comment>
                            <comment id="12561650" author="oysteing" created="Wed, 23 Jan 2008 12:22:21 +0000"  >&lt;p&gt;Committed v6 of the patch with some minor changes to a few comments as revision 614514.&lt;/p&gt;</comment>
                            <comment id="12575945" author="narayanan" created="Thu, 6 Mar 2008 23:10:42 +0000"  >&lt;p&gt;All related patches have been committed. Resolving issue!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12387454">DERBY-3364</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12371915" name="failover_impl_notforcommit.diff" size="5732" author="narayanan" created="Wed, 19 Dec 2007 02:31:01 +0000"/>
                            <attachment id="12371916" name="failover_impl_notforcommit.stat" size="466" author="narayanan" created="Wed, 19 Dec 2007 02:31:01 +0000"/>
                            <attachment id="12372124" name="failover_impl_v1.diff" size="5974" author="narayanan" created="Sat, 22 Dec 2007 07:55:50 +0000"/>
                            <attachment id="12372125" name="failover_impl_v1.stat" size="493" author="narayanan" created="Sat, 22 Dec 2007 07:55:50 +0000"/>
                            <attachment id="12373114" name="failover_impl_v2.diff" size="9943" author="narayanan" created="Mon, 14 Jan 2008 18:53:23 +0000"/>
                            <attachment id="12373115" name="failover_impl_v2.stat" size="465" author="narayanan" created="Mon, 14 Jan 2008 18:53:23 +0000"/>
                            <attachment id="12373264" name="failover_impl_v3.diff" size="9950" author="narayanan" created="Wed, 16 Jan 2008 11:36:50 +0000"/>
                            <attachment id="12373265" name="failover_impl_v3.stat" size="465" author="narayanan" created="Wed, 16 Jan 2008 11:36:50 +0000"/>
                            <attachment id="12373379" name="failover_impl_v4.diff" size="10313" author="narayanan" created="Thu, 17 Jan 2008 11:09:52 +0000"/>
                            <attachment id="12373380" name="failover_impl_v4.stat" size="540" author="narayanan" created="Thu, 17 Jan 2008 11:09:52 +0000"/>
                            <attachment id="12373652" name="failover_impl_v5.diff" size="10478" author="narayanan" created="Mon, 21 Jan 2008 03:56:27 +0000"/>
                            <attachment id="12373653" name="failover_impl_v5.stat" size="628" author="narayanan" created="Mon, 21 Jan 2008 03:56:27 +0000"/>
                            <attachment id="12373718" name="failover_impl_v6.diff" size="10788" author="narayanan" created="Tue, 22 Jan 2008 04:11:44 +0000"/>
                            <attachment id="12373719" name="failover_impl_v6.stat" size="628" author="narayanan" created="Tue, 22 Jan 2008 04:11:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 3 Jan 2008 10:04:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30785</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0y7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39362</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>