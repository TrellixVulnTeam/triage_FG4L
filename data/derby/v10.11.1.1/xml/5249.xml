<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:24:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5249/DERBY-5249.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5249] A table created with 10.0.2.1 with constraints cannot be dropped with 10.5 due to NullPointerException with insane build or ASSERT FAILED Failed to find sharable conglomerate descriptor for index conglomerate  with sane build</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5249</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;In 10.0.2.1  there was some bug that caused a duplicate entry in sys.sysconglomerates.&lt;br/&gt;
After running the attached repro_create.sql with 10.0.2.1, you will see two rows returned instead of one with:&lt;/p&gt;

&lt;p&gt;select c.constraintname, c.constraintid,  cong.conglomerateid, cong.conglomeratename  from sys.sysconglomerates cong, sys.syskeys k, sys.sysconstraints c where c.constraintname = &apos;PK_RS&apos; and c.constraintid =k.constraintid and k.conglomerateid = cong.conglomerateid  ;&lt;/p&gt;

&lt;p&gt;I am not sure what practical impact this has with 10.0 as you can still drop the table s.rs with that version.&lt;br/&gt;
On connecting to the  database with 10.5, either soft or hard upgrade with 10.5.3.2 - 1103924&lt;/p&gt;

&lt;p&gt;DROP TABLE S.RS  fails with:&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;ASSERT FAILED Failed to find&lt;br/&gt;
sharable conglomerate descriptor for index conglomerate # 785: org.apache.derby.&lt;br/&gt;
shared.common.sanity.AssertFailure&apos;.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExc&lt;br/&gt;
eptionFactory.java:45)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransport&lt;br/&gt;
AcrossDRDA(SQLExceptionFactory40.java:119)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLE&lt;br/&gt;
xceptionFactory40.java:70)&lt;br/&gt;
        ... 17 more&lt;br/&gt;
Caused by: org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Fa&lt;br/&gt;
iled to find sharable conglomerate descriptor for index conglomerate # 785&lt;br/&gt;
        at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(Sanit&lt;br/&gt;
yManager.java:162)&lt;br/&gt;
        at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(Sanit&lt;br/&gt;
yManager.java:147)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.ConglomerateDescriptor.describeS&lt;br/&gt;
haredConglomerate(ConglomerateDescriptor.java:638)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.ConglomerateDescriptor.drop(Cong&lt;br/&gt;
lomerateDescriptor.java:428)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.ConstraintDescriptor.drop(Constr&lt;br/&gt;
aintDescriptor.java:738)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.DDLSingleTableConstantAction.dropCo&lt;br/&gt;
nstraint(DDLSingleTableConstantAction.java:144)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.DDLSingleTableConstantAction.dropCo&lt;br/&gt;
nstraint(DDLSingleTableConstantAction.java:107)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.DropTableConstantAction.dropAllCons&lt;br/&gt;
traintDescriptors(DropTableConstantAction.java:315)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.DropTableConstantAction.executeCons&lt;br/&gt;
tantAction(DropTableConstantAction.java:222)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.MiscResultSet.open(MiscResultSet.ja&lt;br/&gt;
va:61)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Generi&lt;br/&gt;
cPreparedStatement.java:416)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPre&lt;br/&gt;
paredStatement.java:297)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedState&lt;br/&gt;
ment.java:1235)&lt;br/&gt;
        ... 10 more&lt;/p&gt;


&lt;p&gt;and with an insane build with a NullPointerException:&lt;br/&gt;
java.lang.NullPointerException &lt;br/&gt;
      at &lt;br/&gt;
   org.apache.derby.iapi.sql.dictionary.ConglomerateDescriptor.drop(Unknown &lt;br/&gt;
   Source) &lt;br/&gt;
      at &lt;br/&gt;
   org.apache.derby.iapi.sql.dictionary.ConstraintDescriptor.drop(Unknown &lt;br/&gt;
   Source) &lt;br/&gt;
      at &lt;br/&gt;
   org.apache.derby.impl.sql.execute.DDLSingleTableConstantAction.dropConst &lt;br/&gt;
   raint(Unknown Source) &lt;br/&gt;
      at &lt;br/&gt;
   org.apache.derby.impl.sql.execute.DDLSingleTableConstantAction.dropConst &lt;br/&gt;
   raint(Unknown Source) &lt;br/&gt;
      at &lt;br/&gt;
   org.apache.derby.impl.sql.execute.DropTableConstantAction.dropAllConstra &lt;br/&gt;
   intDescriptors(Unknown Source) &lt;br/&gt;
      at &lt;br/&gt;
   org.apache.derby.impl.sql.execute.DropTableConstantAction.executeConstan &lt;br/&gt;
   tAction(Unknown Source) &lt;br/&gt;
      at org.apache.derby.impl.sql.execute.MiscResultSet.open(Unknown &lt;br/&gt;
   Source) &lt;br/&gt;
      at &lt;br/&gt;
   org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown &lt;br/&gt;
   Source) &lt;br/&gt;
      at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown &lt;br/&gt;
   Source) &lt;br/&gt;
      at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown &lt;br/&gt;
   Source) &lt;br/&gt;
      at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source) &lt;br/&gt;
      at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(Unknown &lt;br/&gt;
   Source) &lt;/p&gt;

&lt;p&gt;Still need to figure out the exact versions affected, when the dup row was fixed, and when the drop stopped working.&lt;/p&gt;

&lt;p&gt;To reproduce connect to a database with 10.0.2.1 &lt;br/&gt;
(can be accessed at &lt;a href=&quot;http://svn.apache.org/repos/asf/db/derby/jars/10.0.2.1&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/db/derby/jars/10.0.2.1&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;run the attached script repro_create.sql;&lt;/p&gt;

&lt;p&gt;connect with the latest on the trunk or 10.5 branch&lt;/p&gt;

&lt;p&gt;DROP TABLE S.RS;&lt;/p&gt;

&lt;p&gt;The table will not drop. The work around is to drop the table with the old version 10.0.2.1&lt;/p&gt;



</description>
                <environment></environment>
        <key id="12508599">DERBY-5249</key>
            <summary>A table created with 10.0.2.1 with constraints cannot be dropped with 10.5 due to NullPointerException with insane build or ASSERT FAILED Failed to find sharable conglomerate descriptor for index conglomerate  with sane build</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 May 2011 23:16:43 +0100</created>
                <updated>Mon, 17 Jun 2013 10:19:14 +0100</updated>
                            <resolved>Fri, 10 Jun 2011 15:52:32 +0100</resolved>
                                    <version>10.5.3.0</version>
                                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.2.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13040474" author="kmarsden" created="Fri, 27 May 2011 23:18:03 +0100"  >&lt;p&gt;Attaching reproduction. Run repro_create.sql with 10.0 and notice the extra row.  Then connect with 10.5 and &lt;/p&gt;

&lt;p&gt;DROP TABLE S.RS;&lt;/p&gt;
</comment>
                            <comment id="13040491" author="kmarsden" created="Fri, 27 May 2011 23:58:23 +0100"  >&lt;p&gt;Here is the repro_create.sql with the unnecessary columns removed.&lt;/p&gt;</comment>
                            <comment id="13040502" author="kmarsden" created="Sat, 28 May 2011 00:38:43 +0100"  >
&lt;p&gt;I accidentally added this comment or something like it to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3299&quot; title=&quot;Uniqueness violation error (23505) occurs after dropping a PK constraint if there exists a foreign key on the same columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3299&quot;&gt;&lt;del&gt;DERBY-3299&lt;/del&gt;&lt;/a&gt; by mistake. Moving it here.&lt;/p&gt;

&lt;p&gt;I think it makes sense to add in tests for both the extra rows and the drop problem to the upgrade tests to &lt;br/&gt;
get an exact understanding of what versions are affected.&lt;/p&gt;

&lt;p&gt;But just as a data point, I noticed that the duplicate row is created with 10.1.1.0 but not the latest on the 10.1.&lt;br/&gt;
branch, so likely a backported bug fix. 10.3.1.4 the earliest release of 10.3 didn&apos;t show the problem.&lt;br/&gt;
I didn&apos;t do any manual checking of when the drop problem was introduced.  Presumably any database that ever created problematic constraints may be affected by the drop issue, even if they had upgraded to intervening versions.&lt;/p&gt;

</comment>
                            <comment id="13042487" author="kmarsden" created="Wed, 1 Jun 2011 23:29:04 +0100"  >&lt;p&gt;I am not 100% sure, but I think the original duplicate row on create problem fixed with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1854&quot; title=&quot;SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1854&quot;&gt;&lt;del&gt;DERBY-1854&lt;/del&gt;&lt;/a&gt;.  I think the drop problem started with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3299&quot; title=&quot;Uniqueness violation error (23505) occurs after dropping a PK constraint if there exists a foreign key on the same columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3299&quot;&gt;&lt;del&gt;DERBY-3299&lt;/del&gt;&lt;/a&gt; in 10.4.&lt;/p&gt;
</comment>
                            <comment id="13042909" author="kmarsden" created="Thu, 2 Jun 2011 18:35:53 +0100"  >&lt;p&gt;I am trying to understand the situation when we need to deal with the duplicate row &lt;br/&gt;
from the 10.0 db.  In the problematic database we see:&lt;/p&gt;

&lt;p&gt;select c.constraintname, c.constraintid,  cong.conglomerateid, cong.conglomerate&lt;br/&gt;
name, cong.conglomeratenumber  from sys.sysconglomerates cong, sys.syskeys k, sy&lt;br/&gt;
s.sysconstraints c where c.constraintname = &apos;PK_RS&apos; and c.constraintid =k.constr&lt;br/&gt;
aintid and k.conglomerateid = cong.conglomerateid  ;&lt;br/&gt;
CONSTRAINTNAME&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONSTRAINTID&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATEID                      &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATENAME&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATENUMBER&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------&lt;br/&gt;
PK_RS&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8ca44062-0130-4d54-e465-0000002&lt;br/&gt;
87600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;848c0061-0130-4d54-e465-000000287600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SQL110601033139780&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;785&lt;br/&gt;
PK_RS&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8ca44062-0130-4d54-e465-0000002&lt;br/&gt;
87600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;848c0061-0130-4d54-e465-000000287600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SQL110601033139890&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;785&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;



&lt;p&gt;and &lt;/p&gt;

&lt;p&gt;ij&amp;gt; select * from sys.sysconglomerates where conglomeratenumber =785;&lt;br/&gt;
SCHEMAID                            |TABLEID                             |CONGLOMERATENUMBER  |CONGLOMERATENAME&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ISIN&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DESCRIPTOR     &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ISCO&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATEID&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
------------------------------------------------&lt;br/&gt;
1c16805c-0130-4d54-e465-000000287600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2c44c05e-0130-4d54-e465-000000287600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;785&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SQL110601033139780&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;UNIQUE BTREE (&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;848c0061-0130-4d54-e465-000000287600&lt;br/&gt;
1c16805c-0130-4d54-e465-000000287600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2c44c05e-0130-4d54-e465-000000287600&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;785&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SQL110601033139890&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;UNIQUE BTREE (&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;848c0061-0130-4d54-e465-000000287600&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;



&lt;p&gt;The second entry for conglomerate number 785 appeared upon creation of the foreign key.&lt;br/&gt;
I will attached the zipped database my10db.zip.  I am thinking at a high level that describeSharedConglomerate should return this second conglomerate but am not totally sure. &lt;/p&gt;

</comment>
                            <comment id="13042910" author="kmarsden" created="Thu, 2 Jun 2011 18:36:46 +0100"  >&lt;p&gt;10.0 database with problematic sys.sysconglomerates entry.&lt;/p&gt;</comment>
                            <comment id="13042949" author="mikem" created="Thu, 2 Jun 2011 19:03:23 +0100"  >&lt;p&gt;I don&apos;t know this code so can&apos;t answer details but here is what I would do to debug this.  From what you have&lt;br/&gt;
posted so far I believe that what we are looking at is there was a bug in one or more very old releases that&lt;br/&gt;
created bad system catalog entries.  Some number of problems resulted from these entries but not sure what.&lt;br/&gt;
A number releases after that bug was fixed could still drop the tables with the bad system catalogs.  Then at&lt;br/&gt;
some point a new bug was fixed but as a side effect could no longer deal with buggy system catalogs on drop.&lt;/p&gt;

&lt;p&gt;1) Determine exactly the releases that built the bad system catalog.&lt;br/&gt;
2) determine exactly the releases that could drop the bad system catalog.  Maybe looking at how drop worked&lt;br/&gt;
    before can help you understand what needs to be done now.  &lt;br/&gt;
3) You have posted the bad catalog entries, what is the correct catalog entries.&lt;br/&gt;
4) Can you describe overall what is the problem that current drop is encountering - not just what you have&lt;br/&gt;
    already posted but something higher level.  For instance did we already drop an index but didn&apos;t catch the &lt;br/&gt;
    extra row and now when we see the extra row it being an orphan is causing the problem.  &lt;br/&gt;
    This is probably more clear once&lt;br/&gt;
    you post answer to 3.  For instance do we just have bad rows in catalogs, or are there &quot;extra&quot; real files that&lt;br/&gt;
    need to be dealt with.&lt;br/&gt;
5) The routine you mention changing has a name that seems like a utility routine that may be used for more than &lt;br/&gt;
    just drop.  If so it may not be appropriate to make it handle buggy catalog entries.  It would seem reasonable to&lt;br/&gt;
    limit the fix to just allowing a drop of the bad tables.  Worst case maybe we have to handle this as a fix to &lt;br/&gt;
    catalogs on upgrade but that would be messy.  It might be cleaner if we could somehow recognize the problem&lt;br/&gt;
    and possible fork off to a one off set of code.  &lt;/p&gt;</comment>
                            <comment id="13043082" author="kmarsden" created="Thu, 2 Jun 2011 22:50:26 +0100"  >&lt;p&gt;Thank you Mike for the pointers. Here are some answers to some of your questions.&lt;/p&gt;

&lt;p&gt;1) Determine exactly the releases that built the bad system catalog. &lt;/p&gt;

&lt;p&gt;Apache Released Versions with bad catalogs:&lt;br/&gt;
10.0.2.1&lt;br/&gt;
10.1.1.0&lt;br/&gt;
10.1.2.1&lt;/p&gt;

&lt;p&gt;and fixed in Apache Release &lt;br/&gt;
10.1.3.1&lt;/p&gt;

&lt;p&gt;10.2 forward does not have the problem.&lt;br/&gt;
The exact fix for the bad catalogs on the 10.1 branch was revision 411398.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; getImportedKeys returns duplicate rows in some cases.&lt;br/&gt;
I verified this by backing that fix out of 10.1.&lt;br/&gt;
(Note &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; introduced  a regression, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1854&quot; title=&quot;SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1854&quot;&gt;&lt;del&gt;DERBY-1854&lt;/del&gt;&lt;/a&gt;. Also note I was wrong in my initial theory that &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1854&quot; title=&quot;SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1854&quot;&gt;&lt;del&gt;DERBY-1854&lt;/del&gt;&lt;/a&gt; was what fixed the dup conglomerate, but it looks like while &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; corrected the dup it introduced some other bad catalog problem which would cause corruption on compress. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1854&quot; title=&quot;SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1854&quot;&gt;&lt;del&gt;DERBY-1854&lt;/del&gt;&lt;/a&gt; went into the head of the 10.1 and 10.0 branches (never released).  Both &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1854&quot; title=&quot;SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1854&quot;&gt;&lt;del&gt;DERBY-1854&lt;/del&gt;&lt;/a&gt; fexes  were in 10.2.1.6.&lt;/p&gt;


&lt;p&gt;2) determine exactly the releases that could drop the bad system catalog. Maybe looking at how drop worked &lt;/p&gt;

&lt;p&gt;The drop error was introduced in Apache Release 10.4.1.3 with the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3299&quot; title=&quot;Uniqueness violation error (23505) occurs after dropping a PK constraint if there exists a foreign key on the same columns.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3299&quot;&gt;&lt;del&gt;DERBY-3299&lt;/del&gt;&lt;/a&gt; Uniqueness violation error (23505) occurs after dropping a PK constraint if there exists a foreign key on the same columns.  This was a pretty extensive fix and had upgrade implications so was not backported, so all 10.4, 10.5, 10.6, 10.7, and 10.8 releases are affected by the drop problem, but lower branches are not.&lt;/p&gt;



&lt;p&gt;3) You have posted the bad catalog entries, what is the correct catalog entries. &lt;br/&gt;
Here is an example with trunk and the repro_create script.  This is actually surprising to me as there are still two entries in sys.sysconglomerates but the join query with sys.sysconstraints and sys.syskeys returns a single row.  I think maybe the problem with the old one is that both say UNIQUE but I am not sure about that.  I need to understand it better.&lt;/p&gt;


&lt;p&gt;ij&amp;gt; select c.constraintname, c.constraintid,  cong.conglomerateid, cong.conglome&lt;br/&gt;
ratename, cong.conglomeratenumber  from sys.sysconglomerates cong, sys.syskeys k&lt;br/&gt;
, sys.sysconstraints c where c.constraintname = &apos;PK_RS&apos; and c.constraintid =k.co&lt;br/&gt;
nstraintid and k.conglomerateid = cong.conglomerateid  ;&lt;br/&gt;
CONSTRAINTNAME&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONSTRAINTID&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATEID                      &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATENAME&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATENUMBER&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------&lt;br/&gt;
PK_RS&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;e50d80a4-0130-524c-af38-0000001&lt;br/&gt;
c6908&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;94bc40a2-0130-524c-af38-0000001c6908&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SQL110602144057310&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1153&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;



&lt;p&gt;ij&amp;gt; select * from sys.sysconglomerates where conglomeratenumber=1153;&lt;br/&gt;
SCHEMAID                            |TABLEID                             |CONGLO&lt;br/&gt;
MERATENUMBER  |CONGLOMERATENAME&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ISIN&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DESCRIPTOR&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ISCO&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CONGLOMERATEID&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
------------------------------------------------&lt;br/&gt;
23ce809c-0130-524c-af38-0000001c6908&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6c44409f-0130-524c-af38-0000001c6908&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1153&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SQL110602144057310&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;UNIQUE BTR&lt;br/&gt;
EE (&amp;amp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;94bc40a2-0130-524c-af38-0000001c6908&lt;br/&gt;
23ce809c-0130-524c-af38-0000001c6908&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6c44409f-0130-524c-af38-0000001c6908&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1153&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SQL110602144057610&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BTREE (1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;true &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;070a00b0-0130-524c-af38-0000001c6908&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;2 rows selected&lt;/p&gt;



&lt;p&gt;for 4 and 5 I am going to do some more debugging and also try to understand what is really wrong with the old catalogs. Any insight appreciated.&lt;/p&gt;



</comment>
                            <comment id="13043140" author="kmarsden" created="Fri, 3 Jun 2011 00:48:46 +0100"  >&lt;p&gt;So in the bad catalogs, the conglomerateid for the two rows is the same. This is what &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; fixed. In the current code the method:&lt;br/&gt;
public ConglomerateDescriptor describeSharedConglomerate(&lt;br/&gt;
		ConglomerateDescriptor [] descriptors, boolean ignoreThis)&lt;/p&gt;

&lt;p&gt;if ignoreThis is set, has the code below to determine whether we are looking at &quot;this&quot; as we loop through the two descriptors  passed in &lt;/p&gt;

&lt;p&gt;// Skip if ignoreThis is true and it describes &quot;this&quot;.&lt;br/&gt;
			if (ignoreThis &amp;amp;&amp;amp;&lt;br/&gt;
				getUUID().equals(descriptors&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getUUID()))&lt;/p&gt;
			{
				continue;
			}

&lt;p&gt;With the bad catalogs the getUUID()  matches for both entries so we continue and do not return the shared descriptor.  A quick hack to return the second match allows the table to be dropped, but I am not sure that is the right fix or if I might actually return &quot;this&quot; in some instances by doing that.  describeSharedConglomerate is currently only used by drop.&lt;/p&gt;




</comment>
                            <comment id="13043174" author="kmarsden" created="Fri, 3 Jun 2011 02:39:18 +0100"  >&lt;p&gt;Linking relevant issues.&lt;br/&gt;
There is an interesting conversation regarding the duplicates in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1343&quot; title=&quot;It is possible to have duplicate entries in conglomerateId of sysconglomerates before DERBY-655 was fixed in 10.0 or 10.1 databases. It is desirable to patch these databases on upgrade to 10.2 so conglomerateId becomes unique again.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1343&quot;&gt;&lt;del&gt;DERBY-1343&lt;/del&gt;&lt;/a&gt;.  Dan said:&lt;/p&gt;

&lt;p&gt;&quot;... both ConglomerateDescriptors (rows) have the same key information and so it actually doesn&apos;t matter which gets dropped. The only difference is the conglomerate name for the backing index which is never used. As far as I can see the ConstraintDescriptor only links to the ConglomerateDescriptor through the UUID (which is the same in the two rows in the 10.0 code before the fix to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;So I don&apos;t see any real need to write upgrade code that handles this situation. I will add some comments to the code to clarify it.&quot;&lt;/p&gt;

&lt;p&gt;Perhaps it does not matter which descriptor gets returned from describeSharedConglomerate either, but I will look more closely tomorrow.&lt;/p&gt;
</comment>
                            <comment id="13043374" author="kmarsden" created="Fri, 3 Jun 2011 15:41:19 +0100"  >&lt;p&gt;Attaching a patch for this issue derby-5249_diff.txt.&lt;br/&gt;
The change is to change the check when ignoreThis is set to compare not only getUUID() but also getConglomerateName(). That way we can handle the pre &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; cases where the UUID might be the same.&lt;/p&gt;

&lt;p&gt;Also in the patch are some fixes needed to the test that showed up after the the test progressed further.&lt;/p&gt;

&lt;p&gt;Running tests now.&lt;/p&gt;</comment>
                            <comment id="13043878" author="mikem" created="Fri, 3 Jun 2011 18:11:41 +0100"  >&lt;p&gt;Given the info you tracked down posted already and after reviewing the posted patch, the patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="13045198" author="kmarsden" created="Tue, 7 Jun 2011 00:05:23 +0100"  >&lt;p&gt;Running regression tests on 10.8 I hit &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5263&quot; title=&quot;xmlTestTriggerWithXMLOperators(org.apache.derbyTesting.functionTests.tests.upgradeTests.BasicSetup) fails with java.lang.NoSuchMethodError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5263&quot;&gt;&lt;del&gt;DERBY-5263&lt;/del&gt;&lt;/a&gt; but went ahead and checked in as it did not seem related to this change.&lt;br/&gt;
Running regression tests on 10.7, I hit &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5119&quot; title=&quot; testQualifiers(org.apache.derbyTesting.functionTests.tests.store.AccessTest)java.sql.SQLException: Table/View &amp;#39;FOO&amp;#39; already exists in Schema &amp;#39;APP&amp;#39;.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5119&quot;&gt;&lt;del&gt;DERBY-5119&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4540&quot; title=&quot;&amp;#39;AssertionFailedError&amp;#39; in &amp;#39;store.AccessTest.testCS4595B_UniqueIndex(AccessTest.java:1729)&amp;#39; on SUSE Linux / IBM JIT  - r9&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4540&quot;&gt;&lt;del&gt;DERBY-4540&lt;/del&gt;&lt;/a&gt;. These were also seen in the previous tinderbox.&lt;br/&gt;
&lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/tinderbox_10.7_16/jvm1.6/testing/Limited/testSummary-1131298.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/tinderbox_10.7_16/jvm1.6/testing/Limited/testSummary-1131298.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13685172" author="knutanders" created="Mon, 17 Jun 2013 10:19:14 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12325084">DERBY-655</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12385459">DERBY-3299</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12343486">DERBY-1343</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12481350" name="derby-5249_diff.txt" size="3344" author="kmarsden" created="Fri, 3 Jun 2011 15:41:19 +0100"/>
                            <attachment id="12481264" name="my10db.zip" size="46325" author="kmarsden" created="Thu, 2 Jun 2011 18:36:46 +0100"/>
                            <attachment id="12480715" name="repro_create.sql" size="731" author="kmarsden" created="Fri, 27 May 2011 23:58:23 +0100"/>
                            <attachment id="12480706" name="repro_create.sql" size="1046" author="kmarsden" created="Fri, 27 May 2011 23:18:03 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 2 Jun 2011 18:03:23 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24735</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10427"><![CDATA[Workaround attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0et3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36217</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>