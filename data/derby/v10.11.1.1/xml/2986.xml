<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:18:40 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2986/DERBY-2986.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2986] Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2986</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A select of a CASE statement that performed acceptably in 10.2.2.0 is very slow in 10.3.1.4 the first time it is executed.&lt;/p&gt;

&lt;p&gt;The following example ij script:&lt;/p&gt;

&lt;p&gt;ELAPSEDTIME ON;&lt;br/&gt;
CREATE table test1(id integer);&lt;br/&gt;
CREATE table test2(id varchar(10));&lt;/p&gt;

&lt;p&gt;SELECT CASE  WHEN t.id = 1 THEN &apos;a&apos;&lt;br/&gt;
             WHEN t.id = 2 THEN &apos;b&apos;&lt;br/&gt;
             WHEN t.id = 3 THEN &apos;c&apos;&lt;br/&gt;
             WHEN t.id = 4 THEN &apos;d&apos;&lt;br/&gt;
             WHEN t.id = 5 THEN &apos;e&apos;&lt;br/&gt;
             WHEN t.id = 6 THEN &apos;f&apos;&lt;br/&gt;
             WHEN t.id = 7 THEN &apos;g&apos;&lt;br/&gt;
             WHEN t.id = 8 THEN &apos;h&apos;&lt;br/&gt;
             WHEN t.id = 11 THEN &apos;i&apos;&lt;br/&gt;
             WHEN t.id = 12 THEN &apos;j&apos; &lt;br/&gt;
             WHEN t.id = 15 THEN &apos;k&apos;&lt;br/&gt;
             WHEN t.id = 16 THEN &apos;l&apos;&lt;br/&gt;
             WHEN t.id = 23 THEN &apos;m&apos; &lt;br/&gt;
             WHEN t.id = 24 THEN &apos;n&apos;&lt;br/&gt;
             WHEN t.id = 27 THEN &apos;o&apos;&lt;br/&gt;
             WHEN t.id = 31 THEN &apos;p&apos;&lt;br/&gt;
             WHEN t.id = 41 THEN &apos;q&apos;&lt;br/&gt;
             WHEN t.id = 42 THEN &apos;r&apos;&lt;br/&gt;
             WHEN t.id = 50 THEN &apos;s&apos;&lt;br/&gt;
             ELSE (SELECT t2.id&lt;br/&gt;
                     FROM test2 t2&lt;br/&gt;
                  )&lt;br/&gt;
       END&lt;br/&gt;
FROM test1 t;&lt;/p&gt;

&lt;p&gt;When run on 10.2.2.0 the select results in ELAPSED TIME = 187 milliseconds.&lt;br/&gt;
When run on 10.3.1.4 the select results in ELAPSED TIME = 62281 milliseconds.&lt;/p&gt;</description>
                <environment>Windows XP</environment>
        <key id="12375181">DERBY-2986</key>
            <summary>Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="james.f.adams">James F. Adams</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Aug 2007 01:06:57 +0100</created>
                <updated>Wed, 1 Jul 2009 17:46:30 +0100</updated>
                            <resolved>Thu, 16 Aug 2007 19:04:56 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12517416" author="james.f.adams" created="Fri, 3 Aug 2007 01:50:27 +0100"  >&lt;p&gt;The following simplified version of the script:&lt;/p&gt;

&lt;p&gt;ELAPSEDTIME ON;&lt;/p&gt;

&lt;p&gt;values CASE  WHEN 10 = 1 THEN &apos;a&apos;&lt;br/&gt;
             WHEN 10 = 2 THEN &apos;b&apos;&lt;br/&gt;
             WHEN 10 = 3 THEN &apos;c&apos;&lt;br/&gt;
             WHEN 10 = 4 THEN &apos;d&apos;&lt;br/&gt;
             WHEN 10 = 5 THEN &apos;e&apos;&lt;br/&gt;
             WHEN 10 = 6 THEN &apos;f&apos;&lt;br/&gt;
             WHEN 10 = 7 THEN &apos;g&apos;&lt;br/&gt;
             WHEN 10 = 8 THEN &apos;h&apos;&lt;br/&gt;
             WHEN 10 = 11 THEN &apos;i&apos;&lt;br/&gt;
             WHEN 10 = 12 THEN &apos;j&apos; &lt;br/&gt;
             WHEN 10 = 15 THEN &apos;k&apos;&lt;br/&gt;
             WHEN 10 = 16 THEN &apos;l&apos;&lt;br/&gt;
             WHEN 10 = 23 THEN &apos;m&apos; &lt;br/&gt;
             WHEN 10 = 24 THEN &apos;n&apos;&lt;br/&gt;
             WHEN 10 = 27 THEN &apos;o&apos;&lt;br/&gt;
             WHEN 10 = 31 THEN &apos;p&apos;&lt;br/&gt;
             WHEN 10 = 41 THEN &apos;q&apos;&lt;br/&gt;
             WHEN 10 = 42 THEN &apos;r&apos;&lt;br/&gt;
             WHEN 10 = 50 THEN &apos;s&apos;&lt;br/&gt;
             ELSE &apos;*&apos;&lt;br/&gt;
       END;&lt;/p&gt;

&lt;p&gt;results in:&lt;/p&gt;

&lt;p&gt;10.2.2.0     ELAPSED TIME = 297 milliseconds&lt;br/&gt;
10.3.1.4     ELAPSED TIME = 52000 milliseconds&lt;/p&gt;
</comment>
                            <comment id="12517489" author="james.f.adams" created="Fri, 3 Aug 2007 09:34:34 +0100"  >&lt;p&gt;This problem appears to be introduced by Derby-1620.&lt;/p&gt;</comment>
                            <comment id="12518190" author="army" created="Tue, 7 Aug 2007 18:03:52 +0100"  >&lt;p&gt;Thank you for filing this issue, James, and for investigating the cause.  I did some quick tracing through the code added with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1620&quot; title=&quot;SQL CASE statement returns ERROR 42X89 when including NULL as a return value&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1620&quot;&gt;&lt;del&gt;DERBY-1620&lt;/del&gt;&lt;/a&gt; and it it looks like the problem is that the code re-binds nested ConditionalNode expressions in an exponential way.&lt;/p&gt;

&lt;p&gt;As a simple example, I traced the following query:&lt;/p&gt;

&lt;p&gt;  values CASE WHEN 10 = 1 THEN &apos;a&apos;&lt;br/&gt;
              WHEN 10 = 2 THEN &apos;b&apos;&lt;br/&gt;
         END;&lt;/p&gt;

&lt;p&gt;Let &quot;CN(1)&quot; denote one ConditionalNode and &quot;CN(2)&quot; denote another ConditionalNode, which is the &quot;else&quot; part of CN(1).  Then we see the following calls to bind the &quot;then&quot; and &quot;else&quot; expressions:&lt;/p&gt;

&lt;p&gt;  &amp;#8211; CN(1) : findType() ==&amp;gt; thenElseList.elementAt(0).bindExpression()&lt;br/&gt;
  &amp;#8211; CN(1) : findType() ==&amp;gt; thenElseList.elementAt(1).bindExpression()&lt;br/&gt;
    ++ CN(2) : findType() ==&amp;gt; thenElseList.elementAt(0).bindExpression()&lt;br/&gt;
    ++ CN(2) : findType() ==&amp;gt; thenElseList.elementAt(1).bindExpression()&lt;br/&gt;
    ++ CN(2) : bindExpression() ==&amp;gt; thenElseList.bindExpression() &amp;#8211; 2 DUPLICATE BINDS&lt;br/&gt;
  &amp;#8211; CN(1) : bindExpression() ==&amp;gt; thenElseList.bindExpression() &amp;#8211; 2 DUPLICATE BINDS&lt;br/&gt;
    ++ CN(2) : findType() ==&amp;gt; thenElseList.elementAt(0).bindExpression() &amp;#8211; DUPLICATE BIND&lt;br/&gt;
    ++ CN(2) : findType() ==&amp;gt; thenElseList.elementAt(1).bindExpression() &amp;#8211; DUPLICATE BIND&lt;br/&gt;
    ++ CN(2) : bindExpression() ==&amp;gt; thenElseList.bindExpression() &amp;#8211; 2 DUPLICATE BINDS&lt;/p&gt;

&lt;p&gt;From this it&apos;s clear that we are unnecessarily rebinding ConditionalNodes that appear in the &quot;THEN&quot; or &quot;ELSE&quot; clause of outer conditional nodes.  In this case each expression of CN(2) is bound 2 * 2 = 4 times when we should only be binding it once.  If CN(2) in turn had another sub-conditional CN(3), then CN(3)&apos;s expressions would be bound 2 * 2 * 2 = 8 times.  Hence the exponential rebinding.  &lt;/p&gt;

&lt;p&gt;I made a quick change to the code to remove the call to thenElseList.bindExpression(...) from ConditionalNode.bindExpression(...) in cases where we call &quot;findType()&quot;, and that seems to have brought the times back to something more reasonable.  I&apos;m attaching that change as d2986_notTested_v1.patch as I have not run the regression tests with this change.  I did run lang/CaseExpressionTest, which was added for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1620&quot; title=&quot;SQL CASE statement returns ERROR 42X89 when including NULL as a return value&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1620&quot;&gt;&lt;del&gt;DERBY-1620&lt;/del&gt;&lt;/a&gt;, and that still passes with my quick change.  So if the patch isn&apos;t entirely complete (I won&apos;t know that until the full regression suites are run), it should hopefully be a good starting point... &lt;/p&gt;</comment>
                            <comment id="12519352" author="james.f.adams" created="Mon, 13 Aug 2007 00:25:57 +0100"  >&lt;p&gt;A B,&lt;/p&gt;

&lt;p&gt;Thanks for looking into this.  I ran derbyAll and suites.All and did not see any errors that I would attribute to this patch.&lt;/p&gt;</comment>
                            <comment id="12520008" author="army" created="Wed, 15 Aug 2007 16:37:18 +0100"  >&lt;p&gt;Thank you for running the regression tests, James.  Since everything ran cleanly I committed the patch to trunk with svn # 566217:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=566217&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=566217&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The merge command for porting back to 10.3 executed cleanly:&lt;/p&gt;

&lt;p&gt;  svn merge -r 566216:566217 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;so it should hopefully be straightforward enough.  If no problems show up in the nightlies from the commit to trunk, and if 10.3 tests run cleanly with the changes, then I&apos;ll commit there, as well.&lt;/p&gt;

&lt;p&gt;Note that I didn&apos;t include any new tests with my changes as the regression is performance only (query plan and results stay the same), and thus I don&apos;t think there&apos;s a good way to test for it.  (A variation of 60 seconds is probably not going to be noticed in the scope of the full regression suites).  If anyone disagrees with this I can add the repro shown above to lang/CaseExpressionTest.java with a follow-on commit.&lt;/p&gt;</comment>
                            <comment id="12520012" author="army" created="Wed, 15 Aug 2007 16:59:31 +0100"  >&lt;p&gt;I changed my mind about the regression test as it was easy to do and it could prove useful if lang/CaseExpressionTest is run standalone.  So I commited &quot;d2986_test.patch&quot; with svn # 566235:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=566235&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=566235&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12520324" author="army" created="Thu, 16 Aug 2007 19:04:56 +0100"  >&lt;p&gt;I merged the commits back to 10.3 and ran derbyall and suites.All with no failures.  So committed the changes with svn #566789:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=566789&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=566789&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m marking the issue as resolved.  James, if you can verify that things work correctly for you with 10.3, then please close this issue as appropriate.  Thank you again for finding this issue and providing the initial investigation!&lt;/p&gt;</comment>
                            <comment id="12520433" author="james.f.adams" created="Fri, 17 Aug 2007 02:32:52 +0100"  >&lt;p&gt;Thanks for working on this A B.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12377113">DERBY-3032</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12347067">DERBY-1620</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12363339" name="d2986_notTested_v1.patch" size="2837" author="army" created="Tue, 7 Aug 2007 18:03:51 +0100"/>
                            <attachment id="12363857" name="d2986_test.patch" size="2247" author="army" created="Wed, 15 Aug 2007 16:59:31 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Aug 2007 17:03:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23361</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0sdz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38417</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>