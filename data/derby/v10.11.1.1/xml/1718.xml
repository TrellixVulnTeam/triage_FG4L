<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:21:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1718/DERBY-1718.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1718] creating an after insert trigger with trigger action involving  xml datatype throws  java.io.NottSerializableException</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1718</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;creating an after insert trigger with trigger action involving  xml datatype throws following error :&lt;br/&gt;
ij&amp;gt; create trigger trigxml after insert on t1 for each statement mode db2sql&lt;br/&gt;
insert into t2 values (1,&lt;br/&gt;
xmlparse(document &apos;&amp;lt;name&amp;gt; ram &amp;lt;/name&amp;gt;&apos; preserve whitespace));&lt;br/&gt;
ERROR XSDAJ: Exception during write of a serializable or SQLData object&lt;br/&gt;
ERROR XJ001: Java exception: &apos;org.apache.derby.iapi.types.SqlXmlUtil: java.io.No&lt;br/&gt;
ton&apos;.SerializableExcepti&lt;br/&gt;
ij&amp;gt;&lt;/p&gt;


&lt;p&gt;repro:&lt;br/&gt;
connect &apos;jdbc:derby:wombat;create=true&apos;;&lt;br/&gt;
create table t1 (i int, x xml);&lt;br/&gt;
create table t2 (i int, x xml);&lt;/p&gt;

&lt;p&gt;insert into t2 values (1, &lt;br/&gt;
xmlparse(document &apos;&amp;lt;name&amp;gt; suresh &amp;lt;/name&amp;gt;&apos; preserve whitespace));&lt;br/&gt;
&amp;#8212; following trigger creation is failing ,. &lt;br/&gt;
create trigger trigxml after insert on t1 for each statement mode db2sql &lt;br/&gt;
insert into t2 values (1, &lt;br/&gt;
xmlparse(document &apos;&amp;lt;name&amp;gt; ram &amp;lt;/name&amp;gt;&apos; preserve whitespace));&lt;/p&gt;</description>
                <environment>Java Version:    1.4.2&lt;br/&gt;
Java Vendor:     IBM Corporation</environment>
        <key id="12348177">DERBY-1718</key>
            <summary>creating an after insert trigger with trigger action involving  xml datatype throws  java.io.NottSerializableException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yipng">Yip Ng</assignee>
                                    <reporter username="tsuresh">Suresh Thalamati</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Aug 2006 22:13:04 +0100</created>
                <updated>Thu, 13 Dec 2007 09:05:11 +0000</updated>
                            <resolved>Fri, 22 Sep 2006 19:47:07 +0100</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12435290" author="yipng" created="Sun, 17 Sep 2006 08:17:04 +0100"  >&lt;p&gt;From looking at the stack trace, it appears that the SqlXmlUtil class which is used as a &quot;saved object&quot; didn&apos;t implement the org.apache.derby.iapi.services.io.Formatable interface; thus, causing the java.io.NonSerializableException when the system is externalizing the SPS object during execution of create trigger statement.&lt;/p&gt;</comment>
                            <comment id="12435516" author="yipng" created="Mon, 18 Sep 2006 17:26:08 +0100"  >&lt;p&gt;Attaching initial patch derby1718-trunk-diff01.txt for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1718&quot; title=&quot;creating an after insert trigger with trigger action involving  xml datatype throws  java.io.NottSerializableException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1718&quot;&gt;&lt;del&gt;DERBY-1718&lt;/del&gt;&lt;/a&gt;.  The fix basically implements the Formatable interface for SqlXmlUtil class.  Currently, it writes out the query expression string instead of the XPath object(its serializable I think), and then later recompiles the query once at evaluation time.  The reason behind this is that I don&apos;t  want the stored form to be tied to a particular XML implementation.  But I am open if anyone feels that the Xalan XPath object should be serialized instead.  &lt;/p&gt;

&lt;p&gt;To run the lang/xml_general.sql and lang/xmlBinding.java, please refer to the instructions in this thread:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/25793&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/25793&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;derbylang and the above xml tests passes.  Running derbyall now.  Appreciate if someone can review this patch.  Thanks.&lt;/p&gt;
</comment>
                            <comment id="12435554" author="army" created="Mon, 18 Sep 2006 20:16:50 +0100"  >&lt;p&gt;Thanks for picking this up, figuring out the problem, and providing a fix, Yip!&lt;/p&gt;

&lt;p&gt;I reviewed the patch and I agree that it&apos;s best to write/read the query expression itself instead of reading/writing a Xalan-specific object-&lt;del&gt;so I think you did this the right way.  I applied the patch and did a full build with no problems.  I also ran the new test case with and without your changes and it behaved as expected&lt;/del&gt;-i.e. failed without the patch and passed with it.&lt;/p&gt;

&lt;p&gt;I then ran the xmlSuite (using ibm142) with these changes applied and I noticed that xml_general.sql fails with DerbyNet and DerbyNet client.  Based on your stat file, it looks like only the embedded master file was updated.  Can you run the new test with DerbyNet and DerbyNetClient, as well, and update the master files accordingly?&lt;/p&gt;

&lt;p&gt;One other very minor comment is the age-old comment of whitespace: prior to this patch all lines in SqlXmlUtil.java used 4 spaces, but I see that the diff01 patch introduces tabs.  I think it&apos;d be best if you could do a find/replace of tabs with spaces in just the SqlXmlUtil file--since the spacing is uniform in that file already, it&apos;d be nice to keep it that way (even if the whole tab/space issue is still far from resolved for the codeline as a whole).&lt;/p&gt;

&lt;p&gt;The whitespace isssue is a nit and should not block the patch; I do, however, think that the master updates for DerbyNet and DerbyNetClient should be made before the patch is committed...&lt;/p&gt;

&lt;p&gt;Note: assuming you have the required classes in your classpath, you can run all of the XML tests against embedded, JCC, and Derby client by running the &quot;xmlSuite&quot; suite.&lt;br/&gt;
Thanks again for your work on this!&lt;/p&gt;</comment>
                            <comment id="12435568" author="yipng" created="Mon, 18 Sep 2006 21:33:09 +0100"  >&lt;p&gt;Attaching derby1718-trunk-diff02.txt.  This patch fixes  the whitespace issue + the missing master files from derbynet and derbynetclient.  Thanks for reviewing the patch, Army.  derbyall + xmlSuite passes. &lt;/p&gt;</comment>
                            <comment id="12435577" author="army" created="Mon, 18 Sep 2006 22:15:34 +0100"  >&lt;p&gt;Thank you for the quick follow-up, Yip.  I ran xmlSuite with ibm142 and all tests passed.  I also verified that most of the whitespace in SqlXmlUtil.java has been fixed (there are 3 tabs remaining, but who&apos;s counting? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;+1 to commit  derby1718-trunk-diff02.txt&lt;/p&gt;

&lt;p&gt;Thanks again.&lt;/p&gt;</comment>
                            <comment id="12435612" author="mikem" created="Tue, 19 Sep 2006 01:10:11 +0100"  >&lt;p&gt;patch is available,  marking it a candidate for 10.2&lt;/p&gt;</comment>
                            <comment id="12435616" author="tsuresh" created="Tue, 19 Sep 2006 01:19:37 +0100"  >&lt;p&gt;Thanks for working on this issue Yip. I will  run derbyall and commit the patch.  Thanks  a lot   for taking time to review the patch , Army. &lt;/p&gt;

&lt;p&gt;/suresh&lt;/p&gt;</comment>
                            <comment id="12436061" author="tsuresh" created="Wed, 20 Sep 2006 00:43:01 +0100"  >&lt;p&gt;I did a quick review of this patch. One change that caught my attention is the new&lt;br/&gt;
format id  added in this patch ,  I am wondering if this will cause any upgrade&lt;br/&gt;
issues, if some one does soft-upgrade to 10.2, creates the trigger and then&lt;br/&gt;
reverts back to 10.1  I think it should not cause any problems during recovery, &lt;br/&gt;
because it is written as part of another higher level object (Storable Prepared Statement). &lt;/p&gt;

&lt;p&gt;Any one know if the new format id will cause any errors when building the stored&lt;br/&gt;
prepared statement descriptors list or when the trigger gets executed on 10.1  ?&lt;/p&gt;


&lt;p&gt;Thanks&lt;br/&gt;
-suresh&lt;/p&gt;</comment>
                            <comment id="12436076" author="army" created="Wed, 20 Sep 2006 02:19:03 +0100"  >&lt;p&gt;&amp;gt; Any one know if the new format id will cause any errors when building the stored&lt;br/&gt;
&amp;gt; prepared statement descriptors list or when the trigger gets executed on 10.1  ?&lt;/p&gt;

&lt;p&gt;I don&apos;t really know all of the details on how SPS descriptors are &quot;built&quot; or what is/is not written to disk for triggers, but I did run the following scenario and everything appears to be working as expected:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Create a 10.1 database&lt;/li&gt;
	&lt;li&gt;Create tables t1 and t2 as shown in the description for this issue&lt;/li&gt;
	&lt;li&gt;Disconnect/shutdown 10.1 database.&lt;/li&gt;
	&lt;li&gt;Connect to 10.1 database with Derby 10.3 codeline, effectively doing a soft upgrade.&lt;/li&gt;
	&lt;li&gt;Create the trigger trigxml as shown in the description for this issue&lt;/li&gt;
	&lt;li&gt;Disconnect/shutdown the database.&lt;/li&gt;
	&lt;li&gt;Reconnect to the database using Derby 10.1 codeline (effectively &quot;soft downgrade&quot;)&lt;/li&gt;
	&lt;li&gt;Execute an insert statement that fires the trigger.  The insert statement was successful,&lt;br/&gt;
    as was the trigger statement action.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I admit I was a bit surprised to see this work at first.  However, I then looked at the SYS.SYSSTATEMENTs table and I noticed that when I first create the trigger in 10.3, the &quot;VALID&quot; column is set to &quot;true&quot;.  But when I reconnect with 10.1, the &quot;VALID&quot; column becomes &quot;false&quot;.  My understanding is that the &quot;false&quot; value means that when the trigger is fired, it will first be RE-compiled before getting executed.  This would in turn mean that the new format id for the 10.3 SqlXmlUtil class will never actually be read when running in 10.1--instead, the trigger statement will be recompiled using 10.1 and thus we don&apos;t see any failures.&lt;/p&gt;

&lt;p&gt;I don&apos;t know for sure what the mechanism is, but based on this behavior it appears that any attempts to boot a database from a version that is different from the most-recently-booted version causes all stored prepared statements to be marked invalid and thus forces recompilation.  It is this recompilation of the trigger statements which allows the 10.3 trigxml to execute successfully against a 10.1 database after a &quot;soft downgrade&quot; back to 10.1.&lt;/p&gt;

&lt;p&gt;That&apos;s my understanding based on the tests I ran; if anyone knows otherwise or would like to add more, please feel free...&lt;/p&gt;

&lt;p&gt;And thanks Suresh for taking the time to review the patch.  I wasn&apos;t even thinking about upgrade issues when I did my review.  Definitely true that more eyes are better...&lt;/p&gt;</comment>
                            <comment id="12436093" author="yipng" created="Wed, 20 Sep 2006 03:54:24 +0100"  >&lt;p&gt;For this type of minor revision upgrade, all the SPSs stored in SYS.SYSSTATEMENTS will get invalidated at database boot time.  This logic is handled in the DD_Version class.  When the trigger is fired, the SPS will get recompiled.  &lt;/p&gt;</comment>
                            <comment id="12436121" author="tsuresh" created="Wed, 20 Sep 2006 07:12:37 +0100"  >&lt;p&gt;Committed  to trunk on  revision  448085.. &lt;/p&gt;</comment>
                            <comment id="12436966" author="fuzzylogic" created="Fri, 22 Sep 2006 19:47:07 +0100"  >&lt;p&gt;Marking resolved, merged to 10.2 with revision 448085.&lt;/p&gt;</comment>
                            <comment id="12551405" author="fuzzylogic" created="Thu, 13 Dec 2007 09:05:11 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12339047" name="ASF.LICENSE.NOT.GRANTED--stk.txt" size="6825" author="tsuresh" created="Thu, 17 Aug 2006 22:13:04 +0100"/>
                            <attachment id="12341064" name="derby1718-trunk-diff01.txt" size="11162" author="yipng" created="Mon, 18 Sep 2006 17:26:08 +0100"/>
                            <attachment id="12341081" name="derby1718-trunk-diff02.txt" size="16873" author="yipng" created="Mon, 18 Sep 2006 21:33:09 +0100"/>
                            <attachment id="12341063" name="derby1718-trunk-stat01.txt" size="482" author="yipng" created="Mon, 18 Sep 2006 17:26:08 +0100"/>
                            <attachment id="12341080" name="derby1718-trunk-stat02.txt" size="670" author="yipng" created="Mon, 18 Sep 2006 21:33:09 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 17 Sep 2006 07:17:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22662</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy100f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39652</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>