<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:43:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2822/DERBY-2822.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2822] Add caching of store stream length in StoreStreamClob, if appropriate</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2822</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Currently StoreStreamClob reads the whole Clob stream, including decoding it, to find the length of it. It also does this the second time the length is asked for.&lt;br/&gt;
StoreStreamClob is the internal Clob representation for Clobs that are read-only. As soon as the user updates the Clob, it is transferred to a modifiable Clob representation.&lt;/p&gt;

&lt;p&gt;It should be determined if it is safe to cache the length (both in bytes and in characters) of the store stream to improve the performance and reduce the load on Derby for certain Clob operations.&lt;br/&gt;
To do this, the locking mechanism used for Clobs must be analyzed.&lt;/p&gt;

&lt;p&gt;If you have obtained a Clob object, is there a lock in place that stops others from changing the content?&lt;br/&gt;
For all isolation levels?&lt;br/&gt;
What about scrollable result sets?&lt;br/&gt;
Can the streamed content from store be changed under us, and thus invalidate a cached length?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12371699">DERBY-2822</key>
            <summary>Add caching of store stream length in StoreStreamClob, if appropriate</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Jun 2007 23:20:13 +0100</created>
                <updated>Mon, 4 May 2009 19:22:21 +0100</updated>
                            <resolved>Wed, 29 Oct 2008 14:21:22 +0000</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12619883" author="kristwaa" created="Tue, 5 Aug 2008 14:54:05 +0100"  >&lt;p&gt;&apos;derby-2822-1a-cacheCharLength.diff&apos; is a suggestion on how to add caching of the char length for store stream Clobs.&lt;/p&gt;

&lt;p&gt;Unfortunately we won&apos;t be able to reach the optimal performance on getting the length of a Clob, because we don&apos;t store the required information. There are two issues:&lt;br/&gt;
 a) The number of bytes set aside for storing length information is insufficient (2 bytes).&lt;br/&gt;
    This means longer Clobs won&apos;t have the byte length stored at the head of the stream.&lt;br/&gt;
 b) We store only the number of bytes, not the number of characters.&lt;br/&gt;
    Since we are using the UTF-8 format, knowing the byte length doesn&apos;t give us the character length.&lt;/p&gt;

&lt;p&gt;As a first step we should add caching of the length.&lt;br/&gt;
On a longer term we should implement a reasonable scheme for storing length information. There are several issues to consider, so we need a discussion on this.&lt;/p&gt;

&lt;p&gt;suites.All ran without failures with patch 1a.&lt;br/&gt;
Patch ready for review/comments.&lt;/p&gt;</comment>
                            <comment id="12625746" author="kristwaa" created="Tue, 26 Aug 2008 15:43:18 +0100"  >&lt;p&gt;Increasing priority, as this issue may severely reduce performance.&lt;br/&gt;
As far as I can see, both user code and internal Derby code would benefit from caching the length.&lt;/p&gt;

&lt;p&gt;For instance, Clob.setString in the client driver causes the length to be obtained for validating the input from the user. Worst case scenario is that ~2G characters are skipped to insert one char.&lt;/p&gt;</comment>
                            <comment id="12637907" author="kristwaa" created="Wed, 8 Oct 2008 13:55:30 +0100"  >&lt;p&gt;It should be noted that the client driver already caches the LOB lengths (for both Clobs and Blobs).&lt;br/&gt;
I planning to go ahead with the patch for StoreStreamClob in the embedded driver.&lt;/p&gt;</comment>
                            <comment id="12643196" author="knutanders" created="Tue, 28 Oct 2008 13:16:49 +0000"  >&lt;p&gt;I think this patch is OK. It wasn&apos;t immediately clear to me that it was correct to set the variable once and never update it or invalidate it, but it seems like the StoreStreamClob object isn&apos;t changed when the underlying Clob changes, even without your patch, so it looks safe to me.&lt;/p&gt;</comment>
                            <comment id="12643480" author="kristwaa" created="Wed, 29 Oct 2008 13:09:45 +0000"  >&lt;p&gt;Thanks for looking at the patch Knut Anders.&lt;/p&gt;

&lt;p&gt;To confirm your observations, the StoreStreamClob is indeed a read-only representation of a Clob. This is a requirement for the patch.&lt;br/&gt;
I removed some invalid comments from the patch and uploaded a new version (1b). When my test runs are done, I will commit it.&lt;/p&gt;

&lt;p&gt;In the &quot;near future&quot; (TM) I hope the length information will be stored in the stream for all Clobs. This will require changes in the same area of the code.&lt;br/&gt;
Even if this patch helps performance for subsequent length calls, we still have to decode the data once to get the length.&lt;/p&gt;</comment>
                            <comment id="12643496" author="kristwaa" created="Wed, 29 Oct 2008 14:21:22 +0000"  >&lt;p&gt;Committed patch 1b to trunk with revision 708912.&lt;/p&gt;</comment>
                            <comment id="12650544" author="kristwaa" created="Tue, 25 Nov 2008 11:50:14 +0000"  >&lt;p&gt;Backported patch 1b to the 10.4 branch with revision 720472.&lt;br/&gt;
I will close this issue when the nightly/tinderbox tests have been run.&lt;/p&gt;</comment>
                            <comment id="12650902" author="kristwaa" created="Wed, 26 Nov 2008 09:01:43 +0000"  >&lt;p&gt;10.4 tinderbox ran cleanly.&lt;/p&gt;

&lt;p&gt;Closing the issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12387567" name="derby-2822-1a-cacheCharLength.diff" size="2483" author="kristwaa" created="Tue, 5 Aug 2008 14:54:05 +0100"/>
                            <attachment id="12392982" name="derby-2822-1b-cacheCharLength.diff" size="2192" author="kristwaa" created="Wed, 29 Oct 2008 13:09:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 28 Oct 2008 13:16:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30610</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39282</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>