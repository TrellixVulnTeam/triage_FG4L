<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1574/DERBY-1574.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1574] NullPointerException in UPDATE with COALESCE and subquery</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1574</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following statements generate a NullPointerException:&lt;/p&gt;

&lt;p&gt;CREATE TABLE t1 (i INTEGER);&lt;br/&gt;
CREATE TABLE t2 (i INTEGER);&lt;/p&gt;

&lt;p&gt;UPDATE t1&lt;br/&gt;
   SET i = COALESCE(&lt;br/&gt;
      (SELECT i FROM t2 WHERE t2.i=t1.i),&lt;br/&gt;
      0);&lt;/p&gt;

&lt;p&gt;Any further SQL statements generate an internal error in RawStore, e.g.:&lt;br/&gt;
SELECT * FROM t1;&lt;/p&gt;</description>
                <environment>Java 1.5.0_06</environment>
        <key id="12346494">DERBY-1574</key>
            <summary>NullPointerException in UPDATE with COALESCE and subquery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="chdh@inventec.ch">Christian d&apos;Heureuse</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Jul 2006 02:01:09 +0100</created>
                <updated>Mon, 5 Jul 2010 18:32:55 +0100</updated>
                            <resolved>Tue, 15 Aug 2006 13:57:45 +0100</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.0.2.2</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.1.3.2</version>
                    <version>10.1.3.3</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12423439" author="mikem" created="Tue, 25 Jul 2006 21:24:28 +0100"  >&lt;p&gt;If at all possible always include the full stack trace from derby.log when reporting a bug.  Here is the &lt;br/&gt;
stack  from the original problem against the trunk showing that the issue is in the optimizer:&lt;/p&gt;

&lt;p&gt;2006-07-25 20:19:59.104 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 131), (SESSIONID = 0), (D&lt;br/&gt;
ATABASE = wombat), (DRDAID = null), Failed Statement is: UPDATE t1^M&lt;br/&gt;
   SET i = COALESCE(^M&lt;br/&gt;
      (SELECT i FROM t2 WHERE t2.i=t1.i),^M&lt;br/&gt;
      0)^M&lt;br/&gt;
java.lang.NullPointerException^M&lt;br/&gt;
    at org.apache.derby.iapi.util.JBitSet.or(JBitSet.java:241)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.OptimizerImpl.&amp;lt;init&amp;gt;(OptimizerImpl.java&lt;br/&gt;
:254)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.Level2OptimizerImpl.&amp;lt;init&amp;gt;(Level2Optimi&lt;br/&gt;
zerImpl.java:76)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.Level2OptimizerFactoryImpl.getOptimizer&lt;br/&gt;
Impl(Level2OptimizerFactoryImpl.java:98)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.OptimizerFactoryImpl.getOptimizer(Optim&lt;br/&gt;
izerFactoryImpl.java:159)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.ResultSetNode.getOptimizer(ResultSetNod&lt;br/&gt;
e.java:1635)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.SelectNode.optimize(SelectNode.java:163&lt;br/&gt;
9)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.SubqueryNode.optimize(SubqueryNode.java&lt;br/&gt;
:1683)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.SubqueryList.optimize(SubqueryList.java&lt;br/&gt;
:121)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.SelectNode.optimize(SelectNode.java:166&lt;br/&gt;
4)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.DMLStatementNode.optimize(DMLStatementN&lt;br/&gt;
ode.java:328)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.DMLModStatementNode.optimize(DMLModStat&lt;br/&gt;
ementNode.java:1352)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.ja&lt;br/&gt;
va:395)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:&lt;br/&gt;
118)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareIn&lt;br/&gt;
ternalStatement(GenericLanguageConnectionContext.java:713)^M&lt;br/&gt;
    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:567&lt;br/&gt;
)^M&lt;br/&gt;
    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:516&lt;br/&gt;
)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:310)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.Main.go(Main.java:207)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:173)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)^M&lt;br/&gt;
    at org.apache.derby.tools.ij.main(ij.java:60)^M&lt;br/&gt;
Cleanup action completed^M&lt;/p&gt;

&lt;p&gt;Subsequent errors in raw store indicates there is also an error handling problem in the optimizer code&lt;br/&gt;
which leaves the execution context unusable for subsequent queries.  The error is:&lt;/p&gt;

&lt;p&gt;ERROR 40XT0: An internal error was identified by RawStore module.^M&lt;br/&gt;
    at org.apache.derby.iapi.error.StandardException.newException(StandardExcept&lt;br/&gt;
ion.java:294)^M&lt;br/&gt;
    at org.apache.derby.impl.store.raw.xact.Xact.setActiveState(Xact.java:1772)^&lt;br/&gt;
M&lt;br/&gt;
    at org.apache.derby.impl.store.raw.xact.Xact.openContainer(Xact.java:1271)^M&lt;br/&gt;
    at org.apache.derby.impl.store.access.conglomerate.OpenConglomerate.init(Ope&lt;br/&gt;
nConglomerate.java:865)^M&lt;br/&gt;
    at org.apache.derby.impl.store.access.heap.Heap.open(Heap.java:614)^M&lt;br/&gt;
    at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTra&lt;br/&gt;
nsaction.java:478)^M&lt;br/&gt;
    at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTra&lt;br/&gt;
nsaction.java:1315)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getDescriptorViaInde&lt;br/&gt;
x(DataDictionaryImpl.java:7339)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.locateSchemaRow(Data&lt;br/&gt;
DictionaryImpl.java:1532)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getSchemaDescriptor(&lt;br/&gt;
DataDictionaryImpl.java:1442)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.QueryTreeNode.getSchemaDescriptor(Query&lt;br/&gt;
TreeNode.java:1504)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.QueryTreeNode.getSchemaDescriptor(Query&lt;br/&gt;
TreeNode.java:1456)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.FromBaseTable.bindTableDescriptor(FromB&lt;br/&gt;
aseTable.java:2379)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.FromBaseTable.bindNonVTITables(FromBase&lt;br/&gt;
Table.java:2107)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.FromList.bindTables(FromList.java:300)^&lt;br/&gt;
M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.SelectNode.bindNonVTITables(SelectNode.&lt;br/&gt;
java:472)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.DMLStatementNode.bindTables(DMLStatemen&lt;br/&gt;
tNode.java:220)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.DMLStatementNode.bind(DMLStatementNode.&lt;br/&gt;
java:158)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.compile.CursorNode.bind(CursorNode.java:252)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.ja&lt;br/&gt;
va:344)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:&lt;br/&gt;
118)^M&lt;br/&gt;
    at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareIn&lt;br/&gt;
ternalStatement(GenericLanguageConnectionContext.java:713)^M&lt;br/&gt;
    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:567&lt;br/&gt;
)^M&lt;br/&gt;
    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:516&lt;br/&gt;
)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:312)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.Main.go(Main.java:207)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:173)^M&lt;br/&gt;
    at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)^M&lt;br/&gt;
    at org.apache.derby.tools.ij.main(ij.java:60)^M&lt;br/&gt;
Cleanup action completed^M&lt;/p&gt;</comment>
                            <comment id="12423449" author="army" created="Tue, 25 Jul 2006 21:46:17 +0100"  >&lt;p&gt;&amp;gt; Here is the stack from the original problem against the trunk showing that the issue is in the optimizer: &lt;/p&gt;

&lt;p&gt;For the record, I ran the simple repro against an early version of 10.1(10.1.2.3) and also against 10.0, and the NPE reproduces for both of those codelines, as well.  So in case anyone is wondering (I know I was), this is &lt;b&gt;not&lt;/b&gt; a regression.  For what that&apos;s worth...&lt;/p&gt;</comment>
                            <comment id="12423453" author="mikem" created="Tue, 25 Jul 2006 21:57:57 +0100"  >&lt;p&gt;AS posted to list:&lt;br/&gt;
A B commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1574&quot; title=&quot;NullPointerException in UPDATE with COALESCE and subquery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1574&quot;&gt;&lt;del&gt;DERBY-1574&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
----------------------------&lt;br/&gt;
For the record, I ran the simple repro against an early version of 10.1(10.1.2.3) and also against 10.0, and the NPE reproduces for both of those codelines, as well.  So in case anyone is wondering (I know I was), this is &lt;b&gt;not&lt;/b&gt; a regression.  For what that&apos;s worth...&lt;/p&gt;</comment>
                            <comment id="12423456" author="army" created="Tue, 25 Jul 2006 22:03:08 +0100"  >&lt;p&gt;Adding additional versions to the &quot;Affects&quot; list, per my previous comment.  Since I was able to reproduce the problem in my 10.0, 10.1, and 10.2 codelines I just set everything from 10.0 and forward as affected.  If that&apos;s not the correct thing to do, please advise and/or update as appropriate.  Thanks.&lt;/p&gt;</comment>
                            <comment id="12423755" author="dagw" created="Thu, 27 Jul 2006 03:41:44 +0100"  >&lt;p&gt;I looked at it out of curiosity (I am not very familiar with this part&lt;br/&gt;
of the code); it seems the problem is related to the fact that the&lt;br/&gt;
preprocess phase has not been run prior to the optimize phase for the&lt;br/&gt;
subquery, leading to the referencedTableMap being empty (immediate&lt;br/&gt;
cause for NPE).&lt;/p&gt;

&lt;p&gt;I made this experiment patch which seems to work for the case in the&lt;br/&gt;
issue.  It should not be committed until someone more knowledgeable of&lt;br/&gt;
this part of the code has looked at it (it may be altogether the wrong&lt;br/&gt;
solution for all I know). Also I had to guess a bit at where the call to&lt;br/&gt;
preprocess should be placed as well as the arguments, so caveats apply.&lt;/p&gt;

&lt;p&gt;I ran derbylang, but had a small diff in the execution plan (enclosed).&lt;br/&gt;
It may not be a problem, not sure.&lt;/p&gt;
</comment>
                            <comment id="12423885" author="mkhettry" created="Thu, 27 Jul 2006 19:26:20 +0100"  >&lt;p&gt;To me it seems CoalesceFunctionNode should provide a preprocess method but I&apos;m not an authority either! While working on 883, I noticed that CoalesceFunctionNode didn&apos;t implement the accept method which caused a NPE with group by&apos;s. &lt;/p&gt;</comment>
                            <comment id="12424182" author="dagw" created="Fri, 28 Jul 2006 22:40:43 +0100"  >&lt;p&gt;Thanks, Manish!&lt;br/&gt;
So I tried to put the preprocess forwarding into CoalesceFunctionNode,&lt;br/&gt;
and that works too. It also looks more in line with the&lt;br/&gt;
present design, so I have proceeded with that solution.&lt;/p&gt;

&lt;p&gt;This patch &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;adds a preprocess method to CoalesceFunctionNode to override the one&lt;br/&gt;
  in ValueNode, thus making sure the arguments get handled.&lt;/li&gt;
	&lt;li&gt;adds a printSubNodes method to CoalesceFunctionNode (was missing&lt;br/&gt;
  too, I discovered, when I was trying to look at the parse tree after&lt;br/&gt;
  binding).&lt;/li&gt;
	&lt;li&gt;adds a new test case to coalesceTests.java and an updated master&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have run derbyall without errors and also run the modified test to verify that &lt;br/&gt;
it exposes the problem in absence of the fix. The patch is ready for review.&lt;/p&gt;</comment>
                            <comment id="12426994" author="yipng" created="Wed, 9 Aug 2006 18:57:13 +0100"  >&lt;p&gt;I have reviewed the latest patch and it looks good.  I confirmed that without this patch, it will throw NPE from the above case.  After applying the patch, The arguments in the coalesce now gets handled properly and returns the expected result:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; update t1 set i = coalesce((select i from t2 where t2.i=t1.i), 0);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
WARNING 02000: No row was found for FETCH, UPDATE or DELETE; or the result of a query is an empty table.&lt;/p&gt;

&lt;p&gt;I think this patch is ready to be committed.  +1&lt;/p&gt;</comment>
                            <comment id="12428124" author="knutanders" created="Tue, 15 Aug 2006 13:57:45 +0100"  >&lt;p&gt;Thanks Dag for fixing the bug, and Yip for reviewing the patch. Committed revision 431593.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12456398">DERBY-4549</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12337733" name="derby1574-2.diff" size="3963" author="dagw" created="Fri, 28 Jul 2006 22:40:43 +0100"/>
                            <attachment id="12337734" name="derby1574-2.stat" size="305" author="dagw" created="Fri, 28 Jul 2006 22:40:43 +0100"/>
                            <attachment id="12337609" name="derby1574.diff" size="1623" author="dagw" created="Thu, 27 Jul 2006 03:41:44 +0100"/>
                            <attachment id="12337608" name="predicatePushdown.diff" size="735" author="dagw" created="Thu, 27 Jul 2006 03:41:44 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 25 Jul 2006 20:24:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22573</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0pnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37974</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>