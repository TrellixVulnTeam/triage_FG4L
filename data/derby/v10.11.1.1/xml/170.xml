<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-170/DERBY-170.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-170] Inserting large string value into non-existent table causes communication link failure over Network Server.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-170</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following failure, along with the 2 sub-tasks created under this issue, are reproducible both from a JDBC client (JCC) and from an ODBC client (in this case, DB2 Runtime Client).  I&apos;ve grouped them all together because they all share the characteristic of &quot;large data transfer&quot;, though the context in which the transfer occurs is different for each failure.&lt;/p&gt;

&lt;p&gt;Failure: When trying to insert a large string value (ex. 1 million chars) into a non-existent table using a prepared statement, an ASSERT failure occurs on the Derby side (because data size &amp;lt; 0), which leads to connection closure and communication link failure.  Note that the problem does NOT happen if the target table actually exists.  Repro can be found in the &quot;assert_repro.java&quot; file attached to this bug.&lt;/p&gt;</description>
                <environment>Derby Network Server running with either JDBC or ODBC driver.</environment>
        <key id="30720">DERBY-170</key>
            <summary>Inserting large string value into non-existent table causes communication link failure over Network Server.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Mar 2005 02:14:41 +0000</created>
                <updated>Wed, 24 May 2006 05:01:56 +0100</updated>
                            <resolved>Sat, 29 Apr 2006 01:33:06 +0100</resolved>
                                                    <fixVersion>10.1.3.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="60505" author="army" created="Thu, 10 Mar 2005 02:17:56 +0000"  >&lt;p&gt;Adding sample Java files to reproduce the three failures mentioned.&lt;/p&gt;</comment>
                            <comment id="12317556" author="kmarsden" created="Thu, 4 Aug 2005 11:25:28 +0100"  >&lt;p&gt;I tend to think three separate bugs subtasks for this bug would be good &lt;/p&gt;</comment>
                            <comment id="12317669" author="army" created="Fri, 5 Aug 2005 05:08:37 +0100"  >&lt;p&gt;I separated the three issues into different Jira tasks, per Kathy Marsden&apos;s suggestion.   Thus this issue now only talks about one of the failures; the other two are subtasks.&lt;/p&gt;</comment>
                            <comment id="12360519" author="bryanpendleton" created="Fri, 16 Dec 2005 02:59:10 +0000"  >&lt;p&gt;(This comment refers &lt;b&gt;just&lt;/b&gt; to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-170&quot; title=&quot;Inserting large string value into non-existent table causes communication link failure over Network Server.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-170&quot;&gt;&lt;del&gt;DERBY-170&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-491&quot; title=&quot;Protocol exception when Network Server tries to return ~32K of data or greater in a result set for a Java stored procedure.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-491&quot;&gt;&lt;del&gt;DERBY-491&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-492&quot; title=&quot;Server hangs when trying to return high number (hundreds) of columns from a Java procedure to the client.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-492&quot;&gt;&lt;del&gt;DERBY-492&lt;/del&gt;&lt;/a&gt; are completely different problems and I&apos;ll have more to say about them later.)&lt;/p&gt;

&lt;p&gt;The basis of the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-170&quot; title=&quot;Inserting large string value into non-existent table causes communication link failure over Network Server.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-170&quot;&gt;&lt;del&gt;DERBY-170&lt;/del&gt;&lt;/a&gt; problem is the method DDMReader.skipDss; this method does not properly handle large DDM Objects which are written using continued DSS data structures.&lt;/p&gt;

&lt;p&gt;The way that the bug gets to this point is as follows:&lt;br/&gt;
1) The client sends a PRPSQLSTT to prepare the insert statement&lt;br/&gt;
2) The prepare fails because the table doesn&apos;t exist; the server correctly sends back an error message.&lt;br/&gt;
3) The client has already moved on to sending the DSCSQLSTT request. The server reads this, notices that the prepare failed, and skips through the request.&lt;br/&gt;
4) The client has already moved on to sending the EXCSQLSTT request. The server reads this, notices that the prepare failed, and calls skipRemainder to skip through the request.&lt;/p&gt;

&lt;p&gt;This is where the problem occurs. The client has included the enormous character string as the parameter to the EXCSQLSTT; this parameter string is so long that it is continued through multiple 32K blocks. However, the skipRemainder method can&apos;t handle continued objects properly. What it does is to read the first block, note that it is a continued object, and then calls skipDSS to skip it. But skipDSS only skips the first 32K segment of the giant parameter; it doesn&apos;t skip the continued object segments. So the skipRemainder() method terminates without having digested the entire parameter object, and control pops out to the main processCommands loop, which then reads the  next parameter object segment, tries to interpret it as a new DSS, and rejects it with an assert.&lt;/p&gt;

&lt;p&gt;Here is the diff that I am currently experimenting with; so far, results have been promising. Please let me know your opinions on my analysis of the problem so far.&lt;/p&gt;

&lt;p&gt;Index: DDMReader.java^M&lt;br/&gt;
===================================================================^M&lt;br/&gt;
&amp;#8212; DDMReader.java  (revision 357039)^M&lt;br/&gt;
+++ DDMReader.java  (working copy)^M&lt;br/&gt;
@@ -1348,6 +1348,11 @@^M&lt;br/&gt;
     */&lt;br/&gt;
    protected void skipDss() throws DRDAProtocolException&lt;br/&gt;
    {&lt;br/&gt;
+       while (dssIsContinued)&lt;br/&gt;
+       &lt;/p&gt;
{
+           skipBytes((int)dssLength);
+           readDSSContinuationHeader();
+       }
&lt;p&gt;        skipBytes((int)dssLength);&lt;br/&gt;
        topDdmCollectionStack = EMPTY_STACK;&lt;br/&gt;
        ddmScalarLen = 0;&lt;/p&gt;
</comment>
                            <comment id="12362554" author="bryanpendleton" created="Fri, 13 Jan 2006 01:59:49 +0000"  >&lt;p&gt;Attached is a proposed patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-170&quot; title=&quot;Inserting large string value into non-existent table causes communication link failure over Network Server.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-170&quot;&gt;&lt;del&gt;DERBY-170&lt;/del&gt;&lt;/a&gt;, which teaches the skipDSS method how to handle segmented DDM objects. There is also a small HTML file which provides a bit of background and discussion for the reviewer. I have successfully run derbyall with this patch. The patch includes a new test, and new master output files. Please review this patch at your convenience.&lt;/p&gt;</comment>
                            <comment id="12362657" author="kmarsden" created="Sat, 14 Jan 2006 00:29:11 +0000"  >&lt;p&gt;The change looks good.  Thanks as always for the superb documentation.    &lt;/p&gt;

&lt;p&gt;A couple comments. &lt;/p&gt;

&lt;p&gt;ensureBLayerDataInBuffer in client&apos;s Reply.java  appears to have the same issue as ensureBLayerDataInBuffer in  DDMReader.java.   This could be a separate  patch if you don&apos;t want to include client changes with this issue.  &lt;/p&gt;

&lt;p&gt;Knut&apos;s patch also changed DDMReader, so I applied to the older revision to review.  Can you submit a new patch against the lastest trunk?&lt;/p&gt;
</comment>
                            <comment id="12362678" author="bryanpendleton" created="Sat, 14 Jan 2006 03:27:58 +0000"  >&lt;p&gt;I will investigate the client-side code, and I&apos;ll submit an updated patch against the latest trunk after doing so. If the client-side code appears to be the identical issue, I&apos;ll include it in the updated patch.&lt;/p&gt;</comment>
                            <comment id="12362734" author="bryanpendleton" created="Sun, 15 Jan 2006 01:48:23 +0000"  >&lt;p&gt;Hi Kathey,&lt;/p&gt;

&lt;p&gt;I looked at Reply.ensureBLayerDataInBuffer, and I believe that it does &lt;b&gt;not&lt;/b&gt; have the same problem. The issue in DDMReader.java on the server side is that its implementation of ensureBLayerDataInBuffer, in the &quot;is continued&quot; case, was not calling ensureALayerDataInBuffer. The implementation on the client side is slightly different, and it always calls ensureALayerDataInBuffer, in both the &quot;is continued&quot; case and in the non-continued case. So I believe that the client code is correct with respect to this problem.&lt;/p&gt;

&lt;p&gt;While stepping through the Reply.java code, I did see a few things that worried me:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the comment which accompanies Reply.compressBLayerData seems almost totally wrong to me and I fear it could substantially mislead future readers of the code&lt;/li&gt;
	&lt;li&gt;the implementation of Reply.compressBLayerData uses an inline for() loop to shift the bytes around, rather than calling System.arraycopy, which seems like it could be a performance problem.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;However, neither of these seemed serious enough to warrant including into this particular patch.&lt;/p&gt;

&lt;p&gt;Can you take another look at the client&apos;s Reply.java and let me know if you think I&apos;ve misunderstood it?&lt;/p&gt;</comment>
                            <comment id="12362747" author="bryanpendleton" created="Sun, 15 Jan 2006 04:55:31 +0000"  >&lt;p&gt;I updated my sandbox and attached a new diff against the latest trunk. Tests still run fine.&lt;/p&gt;</comment>
                            <comment id="12362883" author="kmarsden" created="Tue, 17 Jan 2006 04:36:35 +0000"  >&lt;p&gt;I checked in this change.  Thanks Bryan for the patch.  &lt;/p&gt;

&lt;p&gt;Date: Mon Jan 16 11:19:26 2006&lt;br/&gt;
New Revision: 369549&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewcvs?rev=369549&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs?rev=369549&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One thing that would be good I think is to get more  the great information in changes.html into the code comments.&lt;br/&gt;
Of course the comments  probably needn&apos;t contain as detailed an explanation  as in the changes.html but  a comment with the bug number pointing out the changes.html attached to the bug might be helpful to others looking at the code in the future.&lt;/p&gt;</comment>
                            <comment id="12363911" author="bryanpendleton" created="Wed, 25 Jan 2006 11:06:11 +0000"  >&lt;p&gt;Fixed in the trunk by commit of revision 369549.&lt;/p&gt;</comment>
                            <comment id="12376944" author="bryanpendleton" created="Fri, 28 Apr 2006 22:17:13 +0100"  >&lt;p&gt;Reopened to merge this fix to the 10.1 branch.&lt;/p&gt;</comment>
                            <comment id="12376973" author="bryanpendleton" created="Sat, 29 Apr 2006 01:33:06 +0100"  >&lt;p&gt;Merged the fix from the trunk to 10.1 branch with subversion revision 397963. Updated Fix Version.&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewcvs?rev=397963&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs?rev=397963&amp;amp;view=rev&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="12412996" author="army" created="Wed, 24 May 2006 05:01:56 +0100"  >&lt;p&gt;Issue has been fixed, tested, and ported back to 10.1, so I&apos;m now marking it as closed.  Thanks Bryan!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="19182" name="assert_repro.java" size="1377" author="army" created="Thu, 10 Mar 2005 02:17:56 +0000"/>
                            <attachment id="12321896" name="changes.html" size="9135" author="bryanpendleton" created="Fri, 13 Jan 2006 01:59:49 +0000"/>
                            <attachment id="19184" name="storedProcs.java" size="13352" author="army" created="Thu, 10 Mar 2005 02:17:56 +0000"/>
                            <attachment id="19183" name="stored_proc_repro.java" size="3785" author="army" created="Thu, 10 Mar 2005 02:17:56 +0000"/>
                            <attachment id="12321898" name="svn_jan12_2006.status" size="416" author="bryanpendleton" created="Fri, 13 Jan 2006 01:59:49 +0000"/>
                            <attachment id="12321960" name="svn_jan14_2006.diff" size="6264" author="bryanpendleton" created="Sun, 15 Jan 2006 04:55:31 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12313045">DERBY-491</subtask>
                            <subtask id="12313046">DERBY-492</subtask>
                            <subtask id="12344903">DERBY-1454</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 4 Aug 2005 10:25:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21814</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy16d3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40681</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>