<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:31:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5222/DERBY-5222.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5222] Compatibility tests fail to delete database directory</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5222</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The compatibility tests fail frequently on one platform (Solaris 10, x86 (32-bit), Java 7 ea b131). For example here: &lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.7/testing/testlog/sol32/1100759-compatibility_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.7/testing/testlog/sol32/1100759-compatibility_diff.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;From what&apos;s printed to the console, it looks like it fails to delete the database directory:&lt;/p&gt;

&lt;p&gt;&amp;gt; Failed deleting database dir &apos;/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat&apos;&lt;/p&gt;

&lt;p&gt;And then, when running the actual test, it fails to create the log directory on that location (presumably because one already exists):&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; java.sql.SQLException: Failed to start database &apos;wombat&apos; with class loader sun.misc.Launcher$AppClassLoader@53c015, see the next exception for details.&lt;br/&gt;
(...)&lt;br/&gt;
Caused by: java.sql.SQLException: cannot create log file at directory /export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/log.&lt;br/&gt;
(...)&lt;br/&gt;
Caused by: ERROR XSLAQ: cannot create log file at directory /export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/log.&lt;br/&gt;
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.getLogDirectory(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.getControlFileName(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.boot(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.boot(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.TopService.bootModule(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.startModule(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.services.monitor.Monitor.bootServiceModule(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.bootLogFactory(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.setRawStoreFactory(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.RawStore.boot(Unknown Source)&lt;br/&gt;
(...)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12506617">DERBY-5222</key>
            <summary>Compatibility tests fail to delete database directory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 May 2011 15:23:59 +0100</created>
                <updated>Tue, 25 Oct 2011 18:09:40 +0100</updated>
                            <resolved>Mon, 23 May 2011 09:42:00 +0100</resolved>
                                    <version>10.8.1.2</version>
                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.2.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13030770" author="knutanders" created="Mon, 9 May 2011 16:20:35 +0100"  >&lt;p&gt;The patch d5222-1a-logging.diff makes CompatibilityCombinations use a helper method from BaseTestCase to delete the database directory. That helper method has better logging when something goes wrong. At least we should be able to see which files it cannot delete. Committed to trunk with revision 1101059.&lt;/p&gt;</comment>
                            <comment id="13031167" author="knutanders" created="Tue, 10 May 2011 14:04:32 +0100"  >&lt;p&gt;This test has failed every day for a week now. But, of course, once we added extra logging to see what was going on, it didn&apos;t fail...&lt;/p&gt;</comment>
                            <comment id="13032399" author="knutanders" created="Thu, 12 May 2011 14:23:56 +0100"  >&lt;p&gt;Failed again today: &lt;a href=&quot;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.7/testing/testlog/sol32/1101932-compatibility_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.7/testing/testlog/sol32/1101932-compatibility_diff.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It looks like there&apos;s a problem with deleting some of the files in the seg0 directory, but it&apos;s hard to say exactly what the problem is.&lt;/p&gt;

&lt;p&gt;Deleting database dir &apos;/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat&apos;&lt;br/&gt;
&amp;lt;assertDirectoryDeleted&amp;gt; attempt 1 left 37 files/dirs behind: 0=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d480.dat 1=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d490.dat 2=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d4b0.dat 3=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d4f0.dat 4=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d510.dat 5=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d4d0.dat 6=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d520.dat 7=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d550.dat 8=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d580.dat 9=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d5a0.dat 10=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d560.dat 11=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d5b0.dat 12=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d5d0.dat 13=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d630.dat 14=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d670.dat 15=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d690.dat 16=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d650.dat 17=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d6c0.dat 18=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d6f0.dat 19=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d720.dat 20=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d760.dat 21=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d770.dat 22=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d7e0.dat 23=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d810.dat 24=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d850.dat 25=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d880.dat 26=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d8b0.dat 27=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d8d0.dat 28=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d890.dat 29=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d8e0.dat 30=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d8c0.dat 31=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d930.dat 32=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d960.dat 33=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d9f0.dat 34=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/d9b0.dat 35=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/da10.dat 36=/export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat/seg0/da60.dat&lt;/p&gt;</comment>
                            <comment id="13032849" author="kristwaa" created="Fri, 13 May 2011 07:57:49 +0100"  >&lt;p&gt;I&apos;m puzzled by the output from the delete method and the test log file, but here is what I see:&lt;br/&gt;
 a) The first round of attempted deletes fails to delete 37 files.&lt;br/&gt;
 b) The next round fails with an assert because the database root directory isn&apos;t found:&lt;br/&gt;
     junit.framework.AssertionFailedError: directory doesn&apos;t exist: /export/home/tmp/jagtmp/autoderbyN_regression/compatibility_3/log/wombat&lt;/p&gt;

&lt;p&gt;At this point, these facts supports at least these two theories (assuming the Derby delete method is correct):&lt;br/&gt;
 1) A &quot;delete race&quot; taking place (directory/files deleted from two or more threads/processes concurrently).&lt;br/&gt;
 2) A bug in the VM, either misreporting the outcome of the deletions, or allowing non-empty directories to be deleted.&lt;/p&gt;

&lt;p&gt;However, looking at the files that couldn&apos;t be deleted, one sees that they are all stub files (starting with &apos;d&apos; instead of &apos;c&apos;). I don&apos;t know the specifics, but I believe stub files are deleted by Derby itself at certain times (for instance during/after a checkpoint?). That makes this bug a timing and/or order sensitive bug with respect to when the files are attempted deleted. One explanation is that Derby is still shutting down when the delete method obtains the list of files to delete, and when it tries to delete the stub files they have already been deleted by Derby.&lt;/p&gt;

&lt;p&gt;This is merely a hypothesis, and it depends on whether the database server is shut down completely when the deletion begins.&lt;br/&gt;
Anyone with knowledge about the runtime characteristics of the upgrade test around?&lt;/p&gt;</comment>
                            <comment id="13032896" author="knutanders" created="Fri, 13 May 2011 09:07:30 +0100"  >&lt;p&gt;Thanks for those observations, Kristian!&lt;/p&gt;

&lt;p&gt;How&apos;s this theory:&lt;/p&gt;

&lt;p&gt;The embedded variant of the compat test doesn&apos;t wait for the forked process to shut down before it moves on to the next version (it does wait until is sees that the process prints &quot;OK&quot;, but that doesn&apos;t mean every database thread has stopped). If a checkpoint happens to be running, the forked process could be deleting the stub conglomerates when we invoke removeDirectory().&lt;/p&gt;

&lt;p&gt;If such a stub is deleted after removeDirectory() calls File.list() and before it actually calls delete(), it&apos;ll fail to delete it (since it&apos;s already deleted) and add it to the list of failed deletes. However, it will still try to delete the parent directory, and that&apos;s successful since there aren&apos;t any files there.&lt;/p&gt;

&lt;p&gt;The code that deleted the directory before we switched to using BaseTestCase.removeDirectory() would give up as soon as one of the files couldn&apos;t be deleted, so the next test would fail because it found a half-deleted database. BaseTestCase.removeDirectory() is on the other extreme: it goes on trying to delete files even after it has failed to delete one, and gets surprised when it sees that it actually had succeeded.&lt;/p&gt;

&lt;p&gt;I can see these possible solutions (not mutually exclusive):&lt;/p&gt;

&lt;p&gt;1) Make the compatibility test wait for the forked process to complete.&lt;/p&gt;

&lt;p&gt;2) Stop BaseTestCase.removeDirectory() from failing if the reason why it couldn&apos;t delete a file was that the file no longer existed.&lt;/p&gt;

&lt;p&gt;We should probably at least do 1. Not so sure about 2, since it usually means that there is a problem if we have a delete race, and it would be good to get it reported.&lt;/p&gt;</comment>
                            <comment id="13032918" author="kristwaa" created="Fri, 13 May 2011 09:57:50 +0100"  >&lt;p&gt;If that&apos;s how the test works, the theory sounds very reasonable.&lt;/p&gt;

&lt;p&gt;Regarding improvements, I&apos;d opt for fixing the test logic and keeping BaseTestCase.removeDirectory as it is, exactly for the reason you mention, even though the method has actually succeeded in removing the directory.&lt;/p&gt;</comment>
                            <comment id="13032926" author="knutanders" created="Fri, 13 May 2011 10:19:34 +0100"  >&lt;p&gt;I think that&apos;s how the test works, yes. Attaching a patch (2a) that calls Process.waitFor() after having read the output from the process. The compatibility tests ran cleanly in my environment with the patch, so I committed it to trunk with revision 1102620. Let&apos;s see if this silences the test.&lt;/p&gt;</comment>
                            <comment id="13033949" author="knutanders" created="Mon, 16 May 2011 11:13:37 +0100"  >&lt;p&gt;Nope, that didn&apos;t do the trick. It&apos;s still failing...&lt;/p&gt;</comment>
                            <comment id="13033996" author="knutanders" created="Mon, 16 May 2011 13:38:16 +0100"  >&lt;p&gt;There are more processes that get started by the compatibility test and that we don&apos;t wait for to complete (for example the process in which the network server runs). Attaching yet another patch (3a) that waits for all processes started by the compatibility test before moving on to the next combination. Maybe this isn&apos;t what&apos;s causing the failures, but it&apos;s probably worth fixing in any case. The compatibility test ran cleanly in my environment with the patch.&lt;/p&gt;</comment>
                            <comment id="13034021" author="knutanders" created="Mon, 16 May 2011 15:01:57 +0100"  >&lt;p&gt;Committed revision 1103742.&lt;/p&gt;</comment>
                            <comment id="13035324" author="knutanders" created="Wed, 18 May 2011 12:56:24 +0100"  >&lt;p&gt;The test hasn&apos;t failed on that platform in the first two test cycles after the commit. It failed five times in a row just before the commit. So it looks promising, but let&apos;s give it a few more days before we declare victory.&lt;/p&gt;</comment>
                            <comment id="13037798" author="knutanders" created="Mon, 23 May 2011 09:42:00 +0100"  >&lt;p&gt;The failure hasn&apos;t been seen again after the last commit. Marking the issue as resolved.&lt;/p&gt;</comment>
                            <comment id="13053190" author="knutanders" created="Wed, 22 Jun 2011 12:37:23 +0100"  >&lt;p&gt;Merged to 10.8. Committed revision 1138409.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12501953">DERBY-5144</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12501953">DERBY-5144</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12478611" name="d5222-1a-logging.diff" size="1682" author="knutanders" created="Mon, 9 May 2011 16:20:35 +0100"/>
                            <attachment id="12479072" name="d5222-2a-waitForProc.diff" size="940" author="knutanders" created="Fri, 13 May 2011 10:19:33 +0100"/>
                            <attachment id="12479321" name="d5222-3a.diff" size="2783" author="knutanders" created="Mon, 16 May 2011 13:38:16 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 13 May 2011 06:57:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0euf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36223</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>