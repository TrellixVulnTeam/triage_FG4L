<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:37:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4054/DERBY-4054.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4054] Multithreaded clob update with exclusive table locking causes table growth that is not reclaimed</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4054</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If I do a multithreaded clob update which gets an exclusive table lock on the table, space will not be reclaimed.  This case is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4050&quot; title=&quot;Multithreaded clob update causes growth in table that does not get reclaimed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4050&quot;&gt;&lt;del&gt;DERBY-4050&lt;/del&gt;&lt;/a&gt; except that the test gets an exclusive table lock and the growth happens whether or not the update is synchronized.  I will add a disabled test for this to ClobReclamationTest and reference this bug.    &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12414680">DERBY-4054</key>
            <summary>Multithreaded clob update with exclusive table locking causes table growth that is not reclaimed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                            <label>derby_triage10_11</label>
                    </labels>
                <created>Thu, 12 Feb 2009 17:50:56 +0000</created>
                <updated>Wed, 3 Jul 2013 16:26:43 +0100</updated>
                                            <version>10.1.3.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                            <comments>
                            <comment id="12673019" author="kmarsden" created="Thu, 12 Feb 2009 18:14:46 +0000"  >&lt;p&gt;Committed a test that demonstrates the issue  with revision  743820 store/ClobReclamationTest.xtestMultiThreadedUpdateTableLocking()&lt;br/&gt;
Enable this test to reproduce the problem.&lt;/p&gt;

</comment>
                            <comment id="12673376" author="kmarsden" created="Fri, 13 Feb 2009 21:14:53 +0000"  >&lt;p&gt;So the interesting thing here is that in ReclaimSpaceHelper.reclaimSpace() the call to &lt;br/&gt;
openContainerNW(tran, container_rlock, work.getContainerId());&lt;br/&gt;
does not return null if it can&apos;t get the lock right away as I would have expected.  It actually throws an Exception:&lt;/p&gt;


&lt;p&gt;ERROR 40XL1: A lock could not be obtained within the time requested&lt;br/&gt;
        at java.lang.Throwable.&amp;lt;init&amp;gt;(Throwable.java:67)&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.&amp;lt;init&amp;gt;(StandardException.java:80)&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.&amp;lt;init&amp;gt;(StandardException.java:69)&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseContainerHandle.useContainer(BaseContainerHandle.java:823)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(BaseDataFileFactory.java:735)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(BaseDataFileFactory.java:551)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.xact.Xact.openContainer(Xact.java:1313)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.ReclaimSpaceHelper.openContainerNW(ReclaimSpaceHelper.java)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.ReclaimSpaceHelper.reclaimSpace(ReclaimSpaceHelper.java:246)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.reclaimSpace(BaseDataFileFactory.java:1256)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.ReclaimSpace.performWork(ReclaimSpace.java:148)&lt;br/&gt;
        at org.apache.derby.impl.services.daemon.BasicDaemon.serviceClient(BasicDaemon.java:331)&lt;br/&gt;
        at org.apache.derby.impl.services.daemon.BasicDaemon.work(BasicDaemon.java:668)&lt;br/&gt;
        at org.apache.derby.impl.services.daemon.BasicDaemon.run(BasicDaemon.java:394)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:735)&lt;/p&gt;

&lt;p&gt;This exception gets throw right away. It doesn&apos;t wait for the timeout.&lt;br/&gt;
This exception causes us to leave reclaimSpace and somehow this exception gets gobbled up somewhere  and never reported, so the space does not get reclaimed and we don&apos;t get a report of a problem  I haven&apos;t quite figured out where we decide to ignore the exception and move on.  If I run in the debugger the exception just get&apos;s thrown and not ignored for some reason.&lt;/p&gt;

&lt;p&gt;If I hack in the change:&lt;br/&gt;
ContainerHandle containerHdl = null;&lt;br/&gt;
       try &lt;/p&gt;
{
            containerHdl = 
			openContainerNW(tran, container_rlock, work.getContainerId());
        }
&lt;p&gt; catch (StandardException e) &lt;/p&gt;
{
            e.printStackTrace();
            if (e.getSQLState().equals(&quot;40XL1&quot;))
                containerHdl = null;            
        }

&lt;p&gt;Then I will proceed and will hit the message &quot;  gave up after 3 tries to get container lock &quot; described in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4055&quot; title=&quot;Space may not be reclaimed if  row locks are not available after three retries &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4055&quot;&gt;DERBY-4055&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Based on this finding I think I am going to rearrange the Jira issues a little bit. I am going to make &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4055&quot; title=&quot;Space may not be reclaimed if  row locks are not available after three retries &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4055&quot;&gt;DERBY-4055&lt;/a&gt; just be for the row lock case and keep this one for the table lock case.&lt;/p&gt;</comment>
                            <comment id="12726877" author="knutanders" created="Fri, 3 Jul 2009 11:43:06 +0100"  >&lt;p&gt;Triaged for 10.5.2.&lt;/p&gt;</comment>
                            <comment id="12874581" author="kristwaa" created="Wed, 2 Jun 2010 14:49:53 +0100"  >&lt;p&gt;Is BLOB affected by this problem as well?&lt;/p&gt;</comment>
                            <comment id="13212449" author="mikem" created="Tue, 21 Feb 2012 08:19:02 +0000"  >&lt;p&gt;derby 10.9 triage.  no changes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12414163">DERBY-4050</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12515565">DERBY-5356</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="12414884">DERBY-4059</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Jul 2009 10:43:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23996</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0dan:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35972</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>