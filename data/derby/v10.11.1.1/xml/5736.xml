<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:29:32 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5736/DERBY-5736.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5736] NullPointerException in GenericTriggerExecutor.executeSPS() caused by OutOfMemoryError</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5736</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If I run TriggerTest with the flags -server and -Xmx150M passed to the JVM, I fairly consistently see a NPE being thrown:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.GenericTriggerExecutor.executeSPS(GenericTriggerExecutor.java:221)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.RowTriggerExecutor.fireTrigger(RowTriggerExecutor.java:114)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.TriggerEventActivator.notifyEvent(TriggerEventActivator.java:281)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.UpdateResultSet.fireAfterTriggers(UpdateResultSet.java:818)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSet.java:280)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:443)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:324)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1242)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1715)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(EmbedPreparedStatement.java:1370)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.testBlobInTriggerTable(TriggerTest.java:880)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.testBlobInTriggerTable(TriggerTest.java:779)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:601)&lt;br/&gt;
        at junit.framework.TestCase.runTest(TestCase.java:164)&lt;br/&gt;
        at junit.framework.TestCase.runBare(TestCase.java:130)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:113)&lt;br/&gt;
        at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
        at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
        at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
        at junit.framework.TestCase.run(TestCase.java:120)&lt;br/&gt;
        at junit.framework.TestSuite.runTest(TestSuite.java:230)&lt;br/&gt;
        at junit.framework.TestSuite.run(TestSuite.java:225)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
        at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
        at junit.textui.TestRunner.doRun(TestRunner.java:121)&lt;br/&gt;
        at junit.textui.TestRunner.start(TestRunner.java:185)&lt;br/&gt;
        at junit.textui.TestRunner.main(TestRunner.java:143)&lt;/p&gt;

&lt;p&gt;In derby.log, there is an OOME right before the NPE:&lt;/p&gt;

&lt;p&gt;java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
        at org.apache.derby.impl.jdbc.LOBStreamControl.updateData(LOBStreamControl.java:154)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.LOBStreamControl.write(LOBStreamControl.java:247)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.LOBStreamControl.&amp;lt;init&amp;gt;(LOBStreamControl.java:89)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedBlob.&amp;lt;init&amp;gt;(EmbedBlob.java:189)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedResultSet.getBlob(EmbedResultSet.java:4072)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedResultSet.getObject(EmbedResultSet.java:1704)&lt;br/&gt;
        at org.apache.derby.exe.ac56961bb1x0137x0d04x3d17x00005ffb0f6356.e0(Unknown Source)&lt;br/&gt;
        at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGeneratedClass.java:139)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.RowResultSet.getNextRowCore(RowResultSet.java:148)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(DMLWriteResultSet.java:127)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:507)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:443)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.executeSubStatement(GenericPreparedStatement.java:313)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.GenericTriggerExecutor.executeSPS(GenericTriggerExecutor.java:176)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.RowTriggerExecutor.fireTrigger(RowTriggerExecutor.java:114)&lt;br/&gt;
(...)&lt;/p&gt;

&lt;p&gt;The code that fails with NPE, is this call to cleanupOnError() in a catch block in GenericTriggerExecutor.executeSPS():&lt;/p&gt;

&lt;p&gt;				/* retrieve the current active SC */&lt;br/&gt;
				StatementContext sc = lcc.getStatementContext();&lt;/p&gt;

&lt;p&gt;				/* make sure that the cleanup is on the new SC */&lt;br/&gt;
				if (active_sc != sc) &lt;/p&gt;
				{
					sc.cleanupOnError(e);
				}</description>
                <environment>java version &amp;quot;1.7.0_02&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_02-b13)&lt;br/&gt;
Java HotSpot(TM) Server VM (build 22.0-b10, mixed mode)&lt;br/&gt;
&lt;br/&gt;
Oracle Solaris 11.1 X86</environment>
        <key id="12553605">DERBY-5736</key>
            <summary>NullPointerException in GenericTriggerExecutor.executeSPS() caused by OutOfMemoryError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 May 2012 11:22:42 +0100</created>
                <updated>Thu, 1 Aug 2013 22:30:14 +0100</updated>
                            <resolved>Tue, 8 May 2012 12:26:46 +0100</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.3.3</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13266484" author="knutanders" created="Wed, 2 May 2012 11:48:22 +0100"  >&lt;p&gt;It looks like lcc.getStatementContext() returns null if the trigger action failed with OOME, because the context stack has already been cleaned up at a lower level in the finally clause of EmbedResultSet.getBlob().&lt;/p&gt;

&lt;p&gt;Guarding the call to sc.cleanupOnError(e) with a check for sc!=null seems to fix the problem. That is, the test starts failing with the underlying OutOfMemoryError instead of a NullPointerException trying to clean up after the OOME.&lt;/p&gt;</comment>
                            <comment id="13266507" author="knutanders" created="Wed, 2 May 2012 13:20:50 +0100"  >&lt;p&gt;Attaching a patch that changes the error handler so it only attempts to clean up the statement context if it is non-null. This should only affect the cases where the error handler would otherwise fail with a NullPointerException that would mask the original error.&lt;/p&gt;

&lt;p&gt;Running the regression test suites.&lt;/p&gt;</comment>
                            <comment id="13266608" author="knutanders" created="Wed, 2 May 2012 15:52:12 +0100"  >&lt;p&gt;Regression tests passed.&lt;/p&gt;</comment>
                            <comment id="13267320" author="kristwaa" created="Thu, 3 May 2012 10:12:38 +0100"  >&lt;p&gt;The fix looks reasonable to me.&lt;br/&gt;
It doesn&apos;t make sense to attempt to clean up if there is no context.&lt;/p&gt;</comment>
                            <comment id="13270372" author="knutanders" created="Tue, 8 May 2012 12:26:47 +0100"  >&lt;p&gt;Thanks, Kristian!&lt;br/&gt;
Committed revision 1335418.&lt;/p&gt;</comment>
                            <comment id="13726769" author="kmarsden" created="Thu, 1 Aug 2013 20:13:01 +0100"  >&lt;p&gt;Temporarily assign to myself for backport.&lt;/p&gt;</comment>
                            <comment id="13726918" author="jira-bot" created="Thu, 1 Aug 2013 22:28:07 +0100"  >&lt;p&gt;Commit 1509434 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kmarsden&quot; class=&quot;user-hover&quot; rel=&quot;kmarsden&quot;&gt;Kathey Marsden&lt;/a&gt; in branch &apos;code/branches/10.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1509434&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1509434&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5736&quot; title=&quot;NullPointerException in GenericTriggerExecutor.executeSPS() caused by OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5736&quot;&gt;&lt;del&gt;DERBY-5736&lt;/del&gt;&lt;/a&gt;  NullPointerException in GenericTriggerExecutor.executeSPS() caused by OutOfMemoryError&lt;/p&gt;

&lt;p&gt;merge revision  1335418 from trunk to 10.8&lt;br/&gt;
Contributed by Knut Anders Hatlen&lt;/p&gt;</comment>
                            <comment id="13726922" author="kmarsden" created="Thu, 1 Aug 2013 22:29:14 +0100"  >&lt;p&gt;Assigning back after backport.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12656863">DERBY-6289</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12525281" name="d5736-1a.diff" size="1640" author="knutanders" created="Wed, 2 May 2012 13:20:50 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 3 May 2012 09:12:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237791</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0bxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35753</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>