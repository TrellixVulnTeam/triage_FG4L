<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:21:48 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5258/DERBY-5258.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5258] btree post commit releases latch before committing/aborting purges, possibly allowing other operation on page</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5258</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;From code inspection found the following problem.  BTreePostCommit.purgeCommittedDeletes gives up the latch in it&apos;s finally block, before the internal transaction is&lt;br/&gt;
committed.  The transaction is committed no sync upon return from this routine leaving a very small window when some other thread could get latch on the page and&lt;br/&gt;
perform operations on the page.&lt;/p&gt;

&lt;p&gt;This can be a problem if for some reason the internal transaction is never committed.  Purges actually return space to the page, unlike deletes.  In order to backout the &lt;br/&gt;
purges one must add the rows back, taking up space on the page.  If another tranaction comes in before the internal transaction is committed and does inserts there may&lt;br/&gt;
be no space for the backout of the purges.  This is why normal delete processing only sets flags on the rows and purge processing is handled differently.  &lt;/p&gt;

&lt;p&gt;I found this problem while debugging a database submitted as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5248&quot; title=&quot;Java Process Crash Causes Corrupt DB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5248&quot;&gt;&lt;del&gt;DERBY-5248&lt;/del&gt;&lt;/a&gt;.  I believe this issue can cause the problem there, but since we have no repro have&lt;br/&gt;
decided to create a new issue to target this specific problem/solution.  Later can close the other issue if it can never be reproduce after the fix.   In DEBY-5248 there &lt;br/&gt;
are purges without a commit followed immediated by an insert in another transaction that is commited and the purge transaction is never committed.  On recovery the&lt;br/&gt;
system tries to abort the internal transaction and eventually trashes the page when it does not actually have enough space to abort the purge.  See that issue for more&lt;br/&gt;
detail.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12509006">DERBY-5258</key>
            <summary>btree post commit releases latch before committing/aborting purges, possibly allowing other operation on page</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikem">Mike Matrigali</assignee>
                                    <reporter username="mikem">Mike Matrigali</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Jun 2011 18:50:38 +0100</created>
                <updated>Mon, 17 Jun 2013 10:19:21 +0100</updated>
                            <resolved>Thu, 30 Jun 2011 00:00:15 +0100</resolved>
                                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.2.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13043925" author="mikem" created="Fri, 3 Jun 2011 19:08:54 +0100"  >&lt;p&gt;Attaching proposed fix.  This has not passed tests yet.&lt;br/&gt;
I have not been able to reproduce the problem in my environment so the fix is just from code inspection.  One change from previous comments is that this fix is to &lt;br/&gt;
purgeRowLevelCommittedDeletes().  The purgeCommittedDeletes() routine is ok, as it holds a table&lt;br/&gt;
level exclusive lock until end of transaction.&lt;/p&gt;

&lt;p&gt;I will run full set of tests before committing to trunk.&lt;/p&gt;

&lt;p&gt;I will try for another day to reproduce, but if I can&apos;t will probably go ahead and check in to trunk unless anyone&lt;br/&gt;
feels I should not.&lt;/p&gt;</comment>
                            <comment id="13044417" author="bryanpendleton" created="Sun, 5 Jun 2011 00:55:00 +0100"  >&lt;p&gt;Wow! Great find, Mike! Your description is quite clear and your theory makes sense to me.&lt;br/&gt;
Your detective work is wonderful to read, thanks very much for taking the time to describe&lt;br/&gt;
the sequence of actions that lead to this case.&lt;/p&gt;

&lt;p&gt;The patch has a few whitespace issues, I think, but other than that it looked fine to me.&lt;/p&gt;

&lt;p&gt;I think that the comment could read  &quot;The commit will clear the latch&quot; rather than&lt;br/&gt;
&quot;The commit should clear the latch&quot;, as the &quot;should&quot; doesn&apos;t quite sound right.&lt;/p&gt;
</comment>
                            <comment id="13044983" author="mikem" created="Mon, 6 Jun 2011 18:58:59 +0100"  >&lt;p&gt;All the tests passed, and I integrated Bryan&apos;s suggested comment changes.  Committed to trunk:&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreePostCommit.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\StoredPage.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1132711.&lt;/p&gt;</comment>
                            <comment id="13045812" author="timwu" created="Wed, 8 Jun 2011 07:48:37 +0100"  >&lt;p&gt;Hi Mike, Any chance this fix can be merged back to 10.8?&lt;/p&gt;</comment>
                            <comment id="13046052" author="mikem" created="Wed, 8 Jun 2011 17:28:55 +0100"  >&lt;p&gt;i plan to backport once I verify that tests passed across all nightly&apos;s on trunk and I run tests on 10.8.  &lt;/p&gt;</comment>
                            <comment id="13046084" author="mikem" created="Wed, 8 Jun 2011 18:09:17 +0100"  >&lt;p&gt;backported change from trunk to 10.8 branch:&lt;/p&gt;

&lt;p&gt;s108_ibm16:11&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreePostCommit.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\StoredPage.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1133470.&lt;/p&gt;</comment>
                            <comment id="13046825" author="mikem" created="Thu, 9 Jun 2011 22:33:52 +0100"  >&lt;p&gt;backported the fix from trunk to 10.7 branch.&lt;/p&gt;

&lt;p&gt;s107_ibm16:5&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreePostCommit.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\StoredPage.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1134092.&lt;/p&gt;</comment>
                            <comment id="13046838" author="mikem" created="Thu, 9 Jun 2011 22:47:03 +0100"  >&lt;p&gt;back ported to 10.6 branch, with minor conflict fix:&lt;/p&gt;

&lt;p&gt;s106_ibm16:31&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreePostCommit.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\StoredPage.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1134098.&lt;/p&gt;</comment>
                            <comment id="13046844" author="mikem" created="Thu, 9 Jun 2011 22:58:49 +0100"  >&lt;p&gt;backported from trunk to 10.5 branch with minor conflict fix:&lt;/p&gt;

&lt;p&gt;s105_ibm16:18&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreePostCommit.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\StoredPage.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1134103.&lt;/p&gt;</comment>
                            <comment id="13049311" author="mikem" created="Tue, 14 Jun 2011 18:58:23 +0100"  >&lt;p&gt;backported fix from trunk to 10.4 branch, required some manual merging of conflicts.&lt;/p&gt;

&lt;p&gt;s104_jdk16:18&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\store\access\btree\BTreePostCommit.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\BasePage.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\StoredPage.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1135720.&lt;/p&gt;</comment>
                            <comment id="13049466" author="mikem" created="Tue, 14 Jun 2011 23:10:16 +0100"  >&lt;p&gt;fixing Affects version field.  This bug was introduced in 10.3 when row level purging of btree rows during post commit was added.  &lt;br/&gt;
Earlier releases were not affected.&lt;/p&gt;</comment>
                            <comment id="13057541" author="mikem" created="Thu, 30 Jun 2011 00:00:15 +0100"  >&lt;p&gt;Found issue by code inspection, fixed and backported to all affectected branches.  10.5 branch is oldest branch affected by this issue.  &lt;/p&gt;</comment>
                            <comment id="13685209" author="knutanders" created="Mon, 17 Jun 2013 10:19:21 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12508493">DERBY-5248</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12510500">DERBY-5281</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12508493">DERBY-5248</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12510769">DERBY-5284</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12481383" name="DERBY-5258_diff.txt" size="11240" author="mikem" created="Fri, 3 Jun 2011 19:08:54 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 4 Jun 2011 23:55:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24741</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0f1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>