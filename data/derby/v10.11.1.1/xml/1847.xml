<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:31:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1847/DERBY-1847.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1847] SELECT statement asserts with XJ001 when attempted to select a newly added column in SQL authorization mode</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1847</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Following script causes the select statement below to assert in sane build. &lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:wombat;create=true&apos; user &apos;user1&apos; as user1;&lt;br/&gt;
WARNING 01J14: SQL authorization is being used without first enabling authentication.&lt;br/&gt;
ij&amp;gt; create table t1 (c1 int, c2 int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; grant select(c1,c2) on t1 to user2;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:wombat;create=true&apos; user &apos;user2&apos; as user2;&lt;br/&gt;
WARNING 01J01: Database &apos;wombat&apos; not created, connection made to existing database instead.&lt;br/&gt;
WARNING 01J14: SQL authorization is being used without first enabling authentication.&lt;br/&gt;
ij(USER2)&amp;gt; set connection user1;&lt;br/&gt;
ij(USER1)&amp;gt; alter table t1 add c3 int;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij(USER1)&amp;gt; set connection user2;&lt;br/&gt;
ij(USER2)&amp;gt; select c3 from user1.t1;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;ASSERT FAILED Attempt to get a bit position (2)that exceeds the max length (2): org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;/p&gt;

&lt;p&gt;stack trace:&lt;/p&gt;

&lt;p&gt;org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Attempt to get a bit position (1)that exceeds the max length (1)&lt;br/&gt;
	at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:149)&lt;br/&gt;
	at org.apache.derby.iapi.services.io.FormatableBitSet.isSet(FormatableBitSet.java:614)&lt;br/&gt;
	at org.apache.derby.iapi.services.io.FormatableBitSet.get(FormatableBitSet.java:643)&lt;br/&gt;
	at org.apache.derby.iapi.sql.dictionary.StatementColumnPermission.check(StatementColumnPermission.java:119)&lt;br/&gt;
	at org.apache.derby.impl.sql.conn.GenericAuthorizer.authorize(GenericAuthorizer.java:158)&lt;br/&gt;
	at org.apache.derby.exe.ac601a400fx010dxaa5bx09e8x00000013b9400.fillResultSet(Unknown Source)&lt;br/&gt;
	at org.apache.derby.exe.ac601a400fx010dxaa5bx09e8x00000013b9400.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:327)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:356)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1182)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:585)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:517)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:321)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:517)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:370)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:268)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.go(Main.java:204)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:170)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:56)&lt;br/&gt;
	at org.apache.derby.tools.ij.main(ij.java:71)&lt;/p&gt;

&lt;p&gt;sysinfo:&lt;/p&gt;

&lt;p&gt;------------------ Java Information ------------------&lt;br/&gt;
Java Version:    1.4.2_12&lt;br/&gt;
Java Vendor:     Sun Microsystems Inc.&lt;br/&gt;
Java home:       C:\Program Files\Java\j2re1.4.2_12&lt;br/&gt;
Java classpath:  classes;.&lt;br/&gt;
OS name:         Windows XP&lt;br/&gt;
OS architecture: x86&lt;br/&gt;
OS version:      5.1&lt;br/&gt;
Java user name:  Yip&lt;br/&gt;
Java user home:  C:\Documents and Settings\Yip&lt;br/&gt;
Java user dir:   C:\work3\derby\trunk&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.4&lt;br/&gt;
--------- Derby Information --------&lt;br/&gt;
JRE - JDBC: J2SE 1.4.2 - JDBC 3.0&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;C:\work3\derby\trunk\classes&amp;#93;&lt;/span&gt; 10.3.0.0 alpha - (443080)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Locale Information -----------------&lt;br/&gt;
Current Locale :  [English/United States &lt;span class=&quot;error&quot;&gt;&amp;#91;en_US&amp;#93;&lt;/span&gt;]&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;de_DE&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;es&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;fr&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;it&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;ja_JP&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;ko_KR&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;pt_BR&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;zh_CN&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
Found support for locale: &lt;span class=&quot;error&quot;&gt;&amp;#91;zh_TW&amp;#93;&lt;/span&gt;&lt;br/&gt;
         version: 10.3.0.0 alpha - (443080)&lt;br/&gt;
------------------------------------------------------&lt;/p&gt;</description>
                <environment>Any</environment>
        <key id="12349878">DERBY-1847</key>
            <summary>SELECT statement asserts with XJ001 when attempted to select a newly added column in SQL authorization mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="yipng">Yip Ng</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Sep 2006 00:56:19 +0100</created>
                <updated>Mon, 5 Jul 2010 18:12:33 +0100</updated>
                            <resolved>Fri, 5 Jan 2007 16:18:19 +0000</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12434721" author="mamtas" created="Thu, 14 Sep 2006 17:08:01 +0100"  >&lt;p&gt;It looks like at alter table add column/drop column time, we need to go update the column &quot;COLUMNS&quot; in SYSCOLPERMS to incorporate the change in the table&apos;s column structure.&lt;/p&gt;</comment>
                            <comment id="12435048" author="yipng" created="Fri, 15 Sep 2006 18:17:43 +0100"  >&lt;p&gt;Unassigning myself from this jira, just realized that I still have another jira issue open.&lt;/p&gt;</comment>
                            <comment id="12437111" author="bryanpendleton" created="Sat, 23 Sep 2006 16:32:57 +0100"  >&lt;p&gt;At a very high level, it seems like we need to:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;run through each row in SYSCOLPERMS and call FormatableBitSet.grow(1) on the COLUMNS column&lt;/li&gt;
	&lt;li&gt;clear the PermissionsCache so that in-memory descriptors will get re-read&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The clearing of the PermissionsCache seems like it should happen in&lt;br/&gt;
DataDictionaryImpl.clearCaches.&lt;/p&gt;</comment>
                            <comment id="12437615" author="mamtas" created="Mon, 25 Sep 2006 18:21:39 +0100"  >&lt;p&gt;Thanks for sharing your findings from ALTER TABLE DROP COLUMN, Bryan. I will investigate further into this Jira entry to see how &lt;br/&gt;
1)SYSCOLPERMS should be updated and &lt;br/&gt;
2)clear the permission cache so that we don&apos;t use stale column permission descriptors.&lt;/p&gt;</comment>
                            <comment id="12437626" author="yipng" created="Mon, 25 Sep 2006 19:02:28 +0100"  >&lt;p&gt;It looks like the permission cache is handled differently than the other descriptor caches.  When DataDictionary&apos;s startWriting()  is called, the other caches will be &lt;b&gt;ALL&lt;/b&gt; cleared out except for the permission cache, where the actual removal of its cached items are done in various DDL contant actions(DROP TABLE/VIEW, etc.) and it only removes those associated cached permission descriptor(s) and not &lt;b&gt;ALL&lt;/b&gt; of them.  So it seems like the permission cache clearing was left out  intentionally in clearCaches().  It would be helpful to know if this is indeed the case.&lt;/p&gt;</comment>
                            <comment id="12438664" author="mamtas" created="Fri, 29 Sep 2006 09:07:21 +0100"  >&lt;p&gt;Just wanted to mention that I was distracted by other work during last few days but have started working on this jira entry again and making progress. Hope to have something to propose by early next week.&lt;/p&gt;</comment>
                            <comment id="12439614" author="mamtas" created="Tue, 3 Oct 2006 19:24:44 +0100"  >&lt;p&gt;I have attached a patch as DERBY1846_V1_diff_AddColumnAndGrantRevoke.txt&lt;br/&gt;
The output of svn stat -q is attached as DERBY1846_V1_stat_AddColumnAndGrantRevoke.txt&lt;/p&gt;

&lt;p&gt;To recap the problem, in SQL Authorization mode, when a new column is added to a table, the rows in SYSCOLPERMS for the table in question were not getting updated to incorporate the new column. This caused ASSERT failure when a non-table owner attempted to select the new column.&lt;/p&gt;

&lt;p&gt;Some background information on system table involved: SYSCOLPERMS keeps track of column level privileges on a given table. One of the columns in SYSCOLPERMS is &quot;COLUMNS&quot; and it has a bit map to show which columns have the given permission granted on them. When a new column is added to the user table, the &quot;COLUMNS&quot; need to be expanded by one bit and that bit should be initialized to zero since no privileges have been granted on that column at the ALTER TABLE...ADD COLUMN time.&lt;/p&gt;

&lt;p&gt;I have fixed this problem by having AlterTableConstantAction.addNewColumnToTable call the new method in DataDictionary called updateSYSCOLPERMSforAddColumnToUserTable. At this point, we know of only the TableDescriptor&apos;s uuid which can help us determine all the rows in SYSCOLPERMS for that given table uuid. I get ColPermsDescriptor for each one of those rows and then use the ColPermsDescriptor&apos;s uuid to update the &quot;COLUMNS&quot; column so SYSCOLPERMS is aware of the newly added column in user table. This fixes the problem because at the time of SELECT, when we do privilege lookup in SYSCOLPERMS, we have info on the newly added column.&lt;/p&gt;

&lt;p&gt;I have added few tests for this Jira entry in lang/grantRevokeDDL.sql The derbyall suite ran fine on Windows XP with Sun&apos;s jdk 1.4&lt;/p&gt;

&lt;p&gt;Any feedback will be greatly appreciated.&lt;/p&gt;</comment>
                            <comment id="12439707" author="bryanpendleton" created="Wed, 4 Oct 2006 03:20:35 +0100"  >&lt;p&gt;Hi Mamta, I took a look at your patch and it makes sense to me. A handful of questions:&lt;/p&gt;

&lt;p&gt;1) I was interested in why you chose to put the new logic into DataDictionaryImpl as&lt;br/&gt;
opposed to, perhaps, TablePrivilegeInfo.&lt;/p&gt;

&lt;p&gt;2) I was wondering whether you thought that updateSYSCOLPERMSforAddColumnToUserTable()&lt;br/&gt;
could also be used, in the future, as part of solving &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1909&quot; title=&quot;ALTER TABLE DROP COLUMN needs to update GRANTed column privileges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1909&quot;&gt;&lt;del&gt;DERBY-1909&lt;/del&gt;&lt;/a&gt;, and, if so, whether the&lt;br/&gt;
possible future reuse of this routine might run into any complications trying to share the code.&lt;/p&gt;

&lt;p&gt;3) I was confused by this part of your change to DataDictionaryImpl (see below). Is this a&lt;br/&gt;
necessary part of the change, or is it some cleanup that you were doing as part of working&lt;br/&gt;
in this class?&lt;/p&gt;

&lt;p&gt;@@ -2528,7 +2606,6 @@&lt;/p&gt;

&lt;p&gt; 	{&lt;br/&gt;
 		ExecRow curRow;&lt;br/&gt;
 		PermissionsDescriptor perm;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ExecIndexRow newKey;&lt;br/&gt;
 		TabInfoImpl	ti = getNonCoreTI(SYSTABLEPERMS_CATALOG_NUM);&lt;br/&gt;
 		SYSTABLEPERMSRowFactory rf = (SYSTABLEPERMSRowFactory) ti.getCatalogRowFactory();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -2560,7 +2637,6 @@&lt;/p&gt;

&lt;p&gt; 	{&lt;br/&gt;
 		ExecRow curRow;&lt;br/&gt;
 		PermissionsDescriptor perm;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ExecIndexRow newKey;&lt;br/&gt;
 		TabInfoImpl	ti = getNonCoreTI(SYSCOLPERMS_CATALOG_NUM);&lt;br/&gt;
 		SYSCOLPERMSRowFactory rf = (SYSCOLPERMSRowFactory) ti.getCatalogRowFactory();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -10223,9 +10299,7 @@&lt;/p&gt;

&lt;p&gt;         // Remove cached permissions data. The cache may hold permissions data for this key even if&lt;br/&gt;
         // the row in the permissions table is new. In that case the cache may have an entry indicating no&lt;br/&gt;
         // permissions&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Cacheable cacheEntry = getPermissionsCache().findCached( perm);&lt;/li&gt;
	&lt;li&gt;if( cacheEntry != null)&lt;/li&gt;
	&lt;li&gt;getPermissionsCache().remove( cacheEntry);&lt;br/&gt;
+		removePermEntryInCache(perm);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         //If we are dealing with grant, then the caller does not need to send &lt;br/&gt;
         //any invalidation actions to anyone and hence return false&lt;/p&gt;</comment>
                            <comment id="12439918" author="mamtas" created="Wed, 4 Oct 2006 18:50:16 +0100"  >&lt;p&gt;Bryan, thanks for taking the time to review the code.&lt;/p&gt;

&lt;p&gt;Let me answer attempt to answer your questions &lt;br/&gt;
1)Main reason behind putting the update system table code in DataDictionary was that for some reason, I thought DataDictionary class was the place to put all the code related to updating the system tables. &lt;/p&gt;

&lt;p&gt;2)I think &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1909&quot; title=&quot;ALTER TABLE DROP COLUMN needs to update GRANTed column privileges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1909&quot;&gt;&lt;del&gt;DERBY-1909&lt;/del&gt;&lt;/a&gt; might need the some of the same code as updateSYSCOLPERMSforAddColumnToUserTable(), in particular, getting the affected rows from SYSCOLPERMS using the tableid. May be I should go ahead and put some comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1909&quot; title=&quot;ALTER TABLE DROP COLUMN needs to update GRANTed column privileges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1909&quot;&gt;&lt;del&gt;DERBY-1909&lt;/del&gt;&lt;/a&gt; for this so whoever works on it will be aware of the code in updateSYSCOLPERMSforAddColumnToUserTable() &lt;/p&gt;

&lt;p&gt;3)I always tend to cleanup code around when I work on a Jira entry although it is not related to actual work that I am doing (wish, I did that at home, my house will look much cleaner). So, sorry about the confusion about the cleanup work that went into this patch. They were not related to the bug and I should have said something in my patch description about it.&lt;/p&gt;</comment>
                            <comment id="12440237" author="mikem" created="Thu, 5 Oct 2006 21:16:47 +0100"  >&lt;p&gt;committed patch to the trunk and marked fixed in 10.3.&lt;/p&gt;

&lt;p&gt;m3_ibm142:148&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\iapi\sql\dictionary\DataDictionary.j&lt;br/&gt;
ava&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\catalog\DataDictionaryImpl.&lt;br/&gt;
java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\catalog\SYSCOLPERMSRowFacto&lt;br/&gt;
ry.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\execute\AlterTableConstantA&lt;br/&gt;
ction.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\grantRe&lt;br/&gt;
vokeDDL.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\gra&lt;br/&gt;
ntRevokeDDL.sql&lt;br/&gt;
Transmitting file data ......&lt;br/&gt;
Committed revision 453352.&lt;/p&gt;</comment>
                            <comment id="12440606" author="mikem" created="Fri, 6 Oct 2006 22:28:28 +0100"  >&lt;p&gt;backported fix from trunk to 10.2 branch.&lt;/p&gt;</comment>
                            <comment id="12460938" author="bryanpendleton" created="Wed, 27 Dec 2006 02:49:26 +0000"  >&lt;p&gt;I think there is a problem in this fix. I think that the problem is that&lt;br/&gt;
when DataDictionaryImpl.updateSYSCOLPERMSforAddColumnToUserTable&lt;br/&gt;
updates the SYSCOLPERMS table, it updates the table by partial&lt;br/&gt;
key value. That means that each time the updateRow() call is made,&lt;br/&gt;
the COLUMNS column in SYSCOLPERMS is updated for &lt;b&gt;all&lt;/b&gt; the&lt;br/&gt;
SYSCOLPERMS in that particular table, not just for the particular&lt;br/&gt;
SYSCOLPERMS row that we are working with at that instant.&lt;/p&gt;

&lt;p&gt;I think that the routine uses a partial key to find all the ColPermsDescriptor&lt;br/&gt;
entries for this table, but when it updates those rows, I think it needs&lt;br/&gt;
to use a full key, not a partial key.&lt;/p&gt;

&lt;p&gt;Here&apos;s a short script which I believe demonstrates the problem. Note that&lt;br/&gt;
in the second fetch from SYSCOLPERMS, all the COLUMNS values have&lt;br/&gt;
been changed to &lt;/p&gt;
{0}.&lt;br/&gt;
&lt;br/&gt;
-bash-2.05b$ java -Dderby.database.sqlAuthorization=true org.apache.derby.tools.ij repro.sql&lt;br/&gt;
ij version 10.3&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:d1847;create=true&apos;;&lt;br/&gt;
WARNING 01J14: SQL authorization is being used without first enabling authentication.&lt;br/&gt;
ij&amp;gt; create table t (a int, b int, c int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; grant select (a) on t to first_user;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; grant update (b) on t to second_user;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; grant select (c) on t to third_user;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select grantee, type, columns from sys.syscolperms;&lt;br/&gt;
GRANTEE                                                                                                                         |&amp;amp;|COLUMNS&lt;br/&gt;
--------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
FIRST_USER                                                                                                                      |s|{0}
&lt;p&gt;SECOND_USER                                                                                                                     |u|&lt;/p&gt;
{1}
&lt;p&gt;THIRD_USER                                                                                                                      |s|&lt;/p&gt;
{2}

&lt;p&gt;3 rows selected&lt;br/&gt;
ij&amp;gt; alter table t add column d int;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select grantee, type, columns from sys.syscolperms;&lt;br/&gt;
GRANTEE                                                                                                                         |&amp;amp;|COLUMNS&lt;br/&gt;
--------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
FIRST_USER                                                                                                                      |s|&lt;/p&gt;
{0}&lt;br/&gt;
SECOND_USER                                                                                                                     |u|{0}
&lt;p&gt;THIRD_USER                                                                                                                      |s|&lt;/p&gt;
{0}

&lt;p&gt;3 rows selected&lt;br/&gt;
ij&amp;gt; quit;&lt;br/&gt;
-bash-2.05b$ cat repro.sql&lt;br/&gt;
connect &apos;jdbc:derby:d1847;create=true&apos;;&lt;br/&gt;
create table t (a int, b int, c int);&lt;br/&gt;
grant select (a) on t to first_user;&lt;br/&gt;
grant update (b) on t to second_user;&lt;br/&gt;
grant select (c) on t to third_user;&lt;br/&gt;
select grantee, type, columns from sys.syscolperms;&lt;br/&gt;
alter table t add column d int;&lt;br/&gt;
select grantee, type, columns from sys.syscolperms;&lt;br/&gt;
quit;&lt;/p&gt;</comment>
                            <comment id="12461040" author="bryanpendleton" created="Wed, 27 Dec 2006 17:08:11 +0000"  >&lt;p&gt;I believe that updateSYSCOLPERMSforAddColumnToUserTable&lt;br/&gt;
actually has the correct index row available, because it&apos;s just used&lt;br/&gt;
that row to fetch the base table row to update. So I think the fix is as&lt;br/&gt;
simple as passing that index row to the ti.updateRow() call and&lt;br/&gt;
specifying the COLPERMSID_INDEX_NUM rather than the&lt;br/&gt;
TABLEID_INDEX_NUM. Attached is d1847_useCPID_index.diff,&lt;br/&gt;
a proposed patch for this issue which includes the above code&lt;br/&gt;
change, and a simple new regression test based on the repro&lt;br/&gt;
script I posted before.&lt;/p&gt;

&lt;p&gt;I&apos;m running all the tests now, to see if this causes any other problems.&lt;/p&gt;

&lt;p&gt;Please review the change and let me know what you think.&lt;/p&gt;</comment>
                            <comment id="12461634" author="yipng" created="Mon, 1 Jan 2007 18:49:23 +0000"  >&lt;p&gt;Thanks Bryan for the patch/  I am running some tests with it.  I&apos;ll be able to review the patch fully tomorrow and provide some &lt;br/&gt;
feedback.&lt;/p&gt;</comment>
                            <comment id="12461911" author="yipng" created="Wed, 3 Jan 2007 05:31:12 +0000"  >&lt;p&gt;Hi Bryan, the changes look reasonable to me.  +1 commit if regression passes successfully.&lt;/p&gt;</comment>
                            <comment id="12462414" author="bryanpendleton" created="Fri, 5 Jan 2007 06:06:16 +0000"  >&lt;p&gt;Hi Yip, thanks for the review! My derbyall and suites.All runs were clean,&lt;br/&gt;
so I&apos;ve committed d1847_useCPID_index.diff to the trunk as revision 492919.&lt;/p&gt;

&lt;p&gt;I intend to merge this change to 10.2 and commit it there as well.&lt;/p&gt;</comment>
                            <comment id="12462521" author="bryanpendleton" created="Fri, 5 Jan 2007 16:18:19 +0000"  >&lt;p&gt;use_CPID follow-on patch applied to 10.2 as revision 493063.&lt;br/&gt;
Marking issue resolved.&lt;/p&gt;</comment>
                            <comment id="12562054" author="dyret" created="Thu, 24 Jan 2008 13:10:07 +0000"  >&lt;p&gt;This issue is resolved and has not been updated in the last 12 months (since 24/Jan/07). &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12345616">DERBY-1489</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12352140">DERBY-1909</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12345616">DERBY-1489</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12312336">DERBY-464</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12342206" name="DERBY1846_V1_diff_AddColumnAndGrantRevoke.txt" size="13216" author="mamtas" created="Tue, 3 Oct 2006 19:24:44 +0100"/>
                            <attachment id="12342207" name="DERBY1846_V1_stat_AddColumnAndGrantRevoke.txt" size="562" author="mamtas" created="Tue, 3 Oct 2006 19:24:44 +0100"/>
                            <attachment id="12347944" name="d1847_useCPID_index.diff" size="4605" author="bryanpendleton" created="Wed, 27 Dec 2006 17:08:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 14 Sep 2006 16:08:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22747</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0puf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38005</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>