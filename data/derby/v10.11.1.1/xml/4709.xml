<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:52:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4709/DERBY-4709.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4709] Create test that parse client trace file to detect round-trips for Derby-4653</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4709</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4653&quot; title=&quot;Avoid unnecessary round-trip for commit  in the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4653&quot;&gt;&lt;del&gt;DERBY-4653&lt;/del&gt;&lt;/a&gt;, Kristian suggested we have a test that parse the trace file to detect round-trip Connection.flowcommit() instead of calling getClientTransactionID() method. The existing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4653&quot; title=&quot;Avoid unnecessary round-trip for commit  in the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4653&quot;&gt;&lt;del&gt;DERBY-4653&lt;/del&gt;&lt;/a&gt; is in J2EEDataSourceTest.testConnectionFlowCommit(). When this issue get fixed, the call for getClientTransactionID can be replace with trace file parsing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12467635">DERBY-4709</key>
            <summary>Create test that parse client trace file to detect round-trips for Derby-4653</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="lilywei">Lily Wei</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Jun 2010 23:20:24 +0100</created>
                <updated>Tue, 30 Nov 2010 19:50:52 +0000</updated>
                            <resolved>Mon, 12 Jul 2010 12:44:17 +0100</resolved>
                                    <version>10.7.1.1</version>
                                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12881435" author="lilywei" created="Tue, 22 Jun 2010 23:58:27 +0100"  >&lt;p&gt;Kristian suggests to parsing trace file mechanism to test&lt;/p&gt;</comment>
                            <comment id="12881677" author="kristwaa" created="Wed, 23 Jun 2010 14:05:25 +0100"  >&lt;p&gt;Attached a proposal (1a) for the alternative test.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;

&lt;p&gt;BTW, now that the other test is in use, I don&apos;t think it it necessary to remove it  even if this issue is completed. At least it would be good to keep both around for some time to make sure the additional test is stable.&lt;/p&gt;</comment>
                            <comment id="12881888" author="lilywei" created="Wed, 23 Jun 2010 22:24:02 +0100"  >&lt;p&gt;Thanks Kristian for the alternative test. I think it is very promising. I just have two heads up.&lt;br/&gt;
1. typo on invokations for testConnectionFlowCommitRollback. I am assuming it intent for invocation for comments and variable name&lt;br/&gt;
2. When we check RDBCMM or RDBLLBCK,  do care about when it was print to the trace file? I think it is also matter because it will show whether the Connection.commit() flow the commit or not and same goes to rollback.&lt;br/&gt;
3. Do we care about how frequent the token is print to trace file? Will it be persistent throught out different releases? Does it depend on different department effort in turn of the trace message?&lt;/p&gt;</comment>
                            <comment id="12882073" author="kristwaa" created="Thu, 24 Jun 2010 07:55:01 +0100"  >&lt;p&gt;Hi Lily,&lt;/p&gt;

&lt;p&gt;Thanks for looking at the patch. Below are my answers to your comments. When I say commit below, I mean both commit and rollback.&lt;/p&gt;

&lt;p&gt; 1. That&apos;s a spelling error, yes. I&apos;ll correct it in an upcoming revision of the patch.&lt;/p&gt;

&lt;p&gt; 2. I&apos;m not sure I follow. Do you mean that we should correlate each commit flow to a JDBC call in the test?&lt;br/&gt;
   Since the only thing differing between the base end the extra run of the test sequence is the number of commits, my working theory has been that an increase in the number of commit flows must be caused by the redundant commits.&lt;/p&gt;

&lt;p&gt; 3. No, we only care about the fact that invoking commit redundantly doesn&apos;t cause more commit commands to be flowed to the server.&lt;br/&gt;
   Without your fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4653&quot; title=&quot;Avoid unnecessary round-trip for commit  in the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4653&quot;&gt;&lt;del&gt;DERBY-4653&lt;/del&gt;&lt;/a&gt;, I think the base count was 13 and the extra count 339. The test only compares these two numbers, expecting them to be equal if the optimization is working. If an unrelated change causes Derby to flow two more commits for the test sequence, it doesn&apos;t matter as it will apply to both the base count and the extra count.&lt;br/&gt;
   The trace file is not part of our public API. However, the token I&apos;ve used comes from the DRDA specification, and I don&apos;t see any reason why someone would change that. It has at least remained unchanged since the code was donated to Apache.&lt;/p&gt;

&lt;p&gt;If you enable the rollback-test and run the test you should hopefully see a reasonable failure message.&lt;/p&gt;

&lt;p&gt;Now, the most annoying issue I&apos;ve found so far is the fact that the support files directories are deleted - which means that the trace file itself goes away...&lt;br/&gt;
Has anyone solved this problem before?&lt;/p&gt;</comment>
                            <comment id="12882452" author="lilywei" created="Fri, 25 Jun 2010 06:40:34 +0100"  >&lt;p&gt;Thanks Kristian for the explanation and comments. I only want to bring to your attention in turn of the working theory. While it is true the increase in the number of commit flows caused by the redundant commits. The verification will be more accurate if we know the increase number between the base end and unconditional commit. The accurate number does not need to be exact. However, it will help if it is in a range.  &lt;/p&gt;

&lt;p&gt;When I run J2EEDataSourceTest, I am also getting a failure due to the support files directories are deleted. It will be nice to know we had solved this problem before.&lt;/p&gt;</comment>
                            <comment id="12882505" author="kristwaa" created="Fri, 25 Jun 2010 10:32:43 +0100"  >&lt;p&gt;Hi Lily,&lt;/p&gt;

&lt;p&gt;I&apos;m sorry, I do not understand what you mean regarding a more accurate verification.&lt;br/&gt;
With the exception of the extra commits, the exact same test sequence is run twice on a fresh connection. The test criteria may be expressed like:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;common_work&amp;#93;&lt;/span&gt; = &lt;span class=&quot;error&quot;&gt;&amp;#91;common_work&amp;#93;&lt;/span&gt; + &lt;span class=&quot;error&quot;&gt;&amp;#91;unnecessary_commit_work&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;What number do you want to know the value of?&lt;/p&gt;

&lt;p&gt;Regarding the failure you are seeing, can you post the stack trace?&lt;br/&gt;
Is the test itself failing, or is SupportFilesSetup.tearDown failing?&lt;/p&gt;</comment>
                            <comment id="12882616" author="lilywei" created="Fri, 25 Jun 2010 16:52:43 +0100"  >&lt;p&gt;I want the number of RDBCMM or RDBRLLBCK right after &lt;span class=&quot;error&quot;&gt;&amp;#91;common_wok&amp;#93;&lt;/span&gt;, then after &lt;span class=&quot;error&quot;&gt;&amp;#91;unnecessary_commit_work&amp;#93;&lt;/span&gt;. As I recall I was reading them from the trace number, the number is different. Is that true?&lt;/p&gt;

&lt;p&gt;This is the stack trace I am getting when applying your patch:&lt;br/&gt;
$ java junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.jdbcap&lt;br/&gt;
i.J2EEDataSourceTest&lt;br/&gt;
.........................................&lt;br/&gt;
..........F.......&lt;br/&gt;
Time: 36.77&lt;br/&gt;
There was 1 failure:&lt;br/&gt;
1) Client/Serverjunit.framework.AssertionFailedError: extinout\ds_cp_base_commit.trace&lt;br/&gt;
        at org.apache.derbyTesting.junit.DropDatabaseSetup.removeDir(DropDatabaseSetup.java:130)&lt;br/&gt;
        at org.apache.derbyTesting.junit.DropDatabaseSetup.access$000(DropDatabaseSetup.java:35)&lt;br/&gt;
        at org.apache.derbyTesting.junit.DropDatabaseSetup$1.run(DropDatabaseSetup.java:105)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
        at org.apache.derbyTesting.junit.DropDatabaseSetup.removeDirectory(DropDatabaseSetup.java:10&lt;br/&gt;
2)&lt;br/&gt;
        at org.apache.derbyTesting.junit.DropDatabaseSetup.removeDirectory(DropDatabaseSetup.java:98&lt;br/&gt;
)&lt;br/&gt;
        at org.apache.derbyTesting.junit.SupportFilesSetup.tearDown(SupportFilesSetup.java:128)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:20)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)&lt;br/&gt;
        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)&lt;br/&gt;
        at junit.extensions.TestSetup.run(TestSetup.java:23)&lt;br/&gt;
        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;

&lt;p&gt;FAILURES!!!&lt;br/&gt;
Tests run: 58,  Failures: 1,  Errors: 0&lt;/p&gt;

&lt;p&gt;Do I miss something or is it something in my environment?&lt;/p&gt;</comment>
                            <comment id="12882729" author="kristwaa" created="Fri, 25 Jun 2010 22:43:23 +0100"  >&lt;p&gt;Well, the first iteration of  testConnectionFlowCommitRollback gives you the count after &lt;span class=&quot;error&quot;&gt;&amp;#91;common_work&amp;#93;&lt;/span&gt; (15 as the test stands now).&lt;br/&gt;
The second iteration of  testConnectionFlowCommitRollback gives you the count after (&lt;span class=&quot;error&quot;&gt;&amp;#91;common_work&amp;#93;&lt;/span&gt; + &lt;span class=&quot;error&quot;&gt;&amp;#91;unnecessary_commit_work&amp;#93;&lt;/span&gt;) (also 15 when the optimization works).&lt;br/&gt;
If these two counts differ, the test fails. Note that &lt;span class=&quot;error&quot;&gt;&amp;#91;common_work&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;unnecessary_commit_work&amp;#93;&lt;/span&gt; are interspersed (in the second iteration of testConnectionFlowCommitRollback ), so there isn&apos;t really a notion of before and after.&lt;br/&gt;
Before the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4653&quot; title=&quot;Avoid unnecessary round-trip for commit  in the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4653&quot;&gt;&lt;del&gt;DERBY-4653&lt;/del&gt;&lt;/a&gt;, the second count was 340 (15+325).&lt;/p&gt;

&lt;p&gt;If I add another query to the test sequence, the numbers will change. Thats why I first run only &lt;span class=&quot;error&quot;&gt;&amp;#91;common_work&amp;#93;&lt;/span&gt; to obtain the base count, and then (&lt;span class=&quot;error&quot;&gt;&amp;#91;common_work&amp;#93;&lt;/span&gt; + &lt;span class=&quot;error&quot;&gt;&amp;#91;unnecessary_commit_work&amp;#93;&lt;/span&gt;). If I used a hard-coded number for the base run, the test would be more sensitive to changes in other areas of the code.&lt;br/&gt;
You can easily obtain these counts from the trace file manually during debugging. The trace level can be changed from PROTOCOL to ALL (I&apos;ll do that in the next revision of the patch), then it will be a lot easier to assoicate a commit flow with a JDBC call.&lt;/p&gt;


&lt;p&gt;You are probably seeing the error because you are running on Windows. The behavior of the file operations are different there, specifically you aren&apos;t allowed to delete a file when it is open for reading.&lt;br/&gt;
Looking at the test and client driver tracing code, the real reasons are:&lt;br/&gt;
 1) I forgot to close the pysical connection (i.e. getPooledConnection() and getXAConnection()).&lt;br/&gt;
 2) There&apos;s a bug in the client driver tracing code, where the stream to the trace file isn&apos;t closed.&lt;/p&gt;

&lt;p&gt;I&apos;ll address 1 in the next revision of the patch, and will do Jira search for issue 2. If I can&apos;t find that it has been logged, I will do so.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;</comment>
                            <comment id="12883057" author="kristwaa" created="Mon, 28 Jun 2010 08:51:54 +0100"  >&lt;p&gt;Attached patch 1b, with the following changes:&lt;br/&gt;
 o changed trace level from TRACE_PROTOCOL_FLOW to TRACE_ALL&lt;br/&gt;
 o fixed typo&lt;br/&gt;
 o added logic for closing the underlying physical connection (i.e. for ConnectionPool and XA data sources)&lt;/p&gt;

&lt;p&gt;I also logged &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4717&quot; title=&quot;Driver trace file isn&amp;#39;t closed/released on physical connection close when specified with the traceFile attribute/setter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4717&quot;&gt;&lt;del&gt;DERBY-4717&lt;/del&gt;&lt;/a&gt; for the issue with the open trace files, which is blocking a successful run of the test on Windows.&lt;/p&gt;</comment>
                            <comment id="12887348" author="kristwaa" created="Mon, 12 Jul 2010 12:42:58 +0100"  >&lt;p&gt;Attached patch 1c, and committed it to trunk with revision 963243.&lt;/p&gt;

&lt;p&gt;Besides from a comment change, it is just a refreshed version of 1b.&lt;/p&gt;</comment>
                            <comment id="12887350" author="kristwaa" created="Mon, 12 Jul 2010 12:44:17 +0100"  >&lt;p&gt;Resolved issue, awaits confirmation.&lt;/p&gt;</comment>
                            <comment id="12965185" author="kristwaa" created="Tue, 30 Nov 2010 10:18:27 +0000"  >&lt;p&gt;Lily, can this issue be closed?&lt;/p&gt;</comment>
                            <comment id="12965270" author="lilywei" created="Tue, 30 Nov 2010 16:13:17 +0000"  >&lt;p&gt;Thanks Kristian. Yes, please close this issue. Great job. I really appreciated it. &lt;/p&gt;</comment>
                            <comment id="12965362" author="kristwaa" created="Tue, 30 Nov 2010 19:29:26 +0000"  >&lt;p&gt;Thanks, Lily.&lt;/p&gt;

&lt;p&gt;I asked because you are listed as reporter. In general I prefer that the reporter closes the issue he/she filed, as the reporter is generally in a better position to tell if the issue has indeed been addressed or not.&lt;/p&gt;</comment>
                            <comment id="12965386" author="lilywei" created="Tue, 30 Nov 2010 19:50:52 +0000"  >&lt;p&gt;Sorry about that. I did not realize that. Thanks Kristian. I will do that next time. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12468022">DERBY-4717</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12464327">DERBY-4653</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12447827" name="derby-4709-1a-alternative_test.diff" size="11127" author="kristwaa" created="Wed, 23 Jun 2010 14:05:25 +0100"/>
                            <attachment id="12448185" name="derby-4709-1b-alternative_test.diff" size="11323" author="kristwaa" created="Mon, 28 Jun 2010 09:09:50 +0100"/>
                            <attachment id="12449239" name="derby-4709-1c-alternative_test.diff" size="11355" author="kristwaa" created="Mon, 12 Jul 2010 12:42:58 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 23 Jun 2010 13:05:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10423"><![CDATA[Newcomer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0obr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37759</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>