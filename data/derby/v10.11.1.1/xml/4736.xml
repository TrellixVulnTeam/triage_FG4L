<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:07:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4736/DERBY-4736.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4736] ASSERT FAIL when code generating a column reference in a join predicate in presence of other outer join reordering</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4736</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;From schema given in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4712&quot; title=&quot;Complex nested joins problems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4712&quot;&gt;&lt;del&gt;DERBY-4712&lt;/del&gt;&lt;/a&gt;, this query gives an ASSERT with sane Derby:&lt;/p&gt;

&lt;p&gt;rs = s.executeQuery(&quot;SELECT 1 FROM (T0 LEFT JOIN (T1 LEFT JOIN (T2 LEFT JOIN &quot; +&lt;br/&gt;
                               &quot; (T3 LEFT JOIN T4 ON 1=1) ON T2.X = T3.X) ON 1=1) ON 1=1) &quot; +&lt;br/&gt;
                               &quot; LEFT JOIN &quot; +&lt;br/&gt;
                               &quot; (T5 INNER JOIN T6 ON 1=1) &quot; +&lt;br/&gt;
                               &quot; ON T2.X = 1 &quot;);&lt;/p&gt;

&lt;p&gt;Cf the attachments in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4712&quot; title=&quot;Complex nested joins problems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4712&quot;&gt;&lt;del&gt;DERBY-4712&lt;/del&gt;&lt;/a&gt; assert-bind-opt-trees.*. &lt;br/&gt;
From preliminary analysis, this error seems to be unrelated to the NPEs reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4712&quot; title=&quot;Complex nested joins problems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4712&quot;&gt;&lt;del&gt;DERBY-4712&lt;/del&gt;&lt;/a&gt;, so filing this as a sub-issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12468737">DERBY-4736</key>
            <summary>ASSERT FAIL when code generating a column reference in a join predicate in presence of other outer join reordering</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12467824">DERBY-4712</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Jul 2010 18:02:35 +0100</created>
                <updated>Mon, 7 Feb 2011 22:49:06 +0000</updated>
                            <resolved>Mon, 7 Feb 2011 22:49:06 +0000</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.3.3.0</version>
                    <version>10.4.1.3</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                    <version>10.5.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.1</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12885990" author="dagw" created="Wed, 7 Jul 2010 18:07:09 +0100"  >&lt;p&gt;for preliminary analysis, see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4712?focusedCommentId=12885701&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12885701&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-4712?focusedCommentId=12885701&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12885701&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12886049" author="dagw" created="Wed, 7 Jul 2010 20:45:33 +0100"  >&lt;p&gt;Attaching a patch which makes the ASSERT go away and the query complete, as well as a new fixture to OuterJoinTest: testDerby4736.&lt;br/&gt;
The problem is that a LOJ reordering has happened (cf. assert-bind-opt-trees.txt: positions of T2, T3 and T4), &lt;br/&gt;
the result column lists are regenerated for the affected join nodes.&lt;/p&gt;

&lt;p&gt;The change is detected in SelectNode#preprocess, cf. this if-statement, ca line 997:&lt;/p&gt;

&lt;p&gt;if (anyChange)&lt;/p&gt;
{
   FromList afromList = (FromList) getNodeFactory().getNode(C_NodeTypes.FROM_LIST,
       getNodeFactory().doJoinOrderOptimization(),
       getContextManager());
   bindExpressions(afromList);
}

&lt;p&gt;However, the call to bindExpressions does &lt;b&gt;not&lt;/b&gt; lead to rebinding of the join clause ON T2.X = 1, since the join clauses are&lt;br/&gt;
bound as part of JoinNode#BindResultColumns, cf call to deferredBindExpressions. Adding the call&lt;/p&gt;

&lt;p&gt;   bindResultColumns(aFromList)&lt;/p&gt;

&lt;p&gt;to the above if-block makes the ASSERT go away.&lt;/p&gt;

&lt;p&gt;I am not convinced that the execution results are correct, though, since it returns a different number of rows that does PostgreSQL.&lt;br/&gt;
I will investigate.&lt;/p&gt;

</comment>
                            <comment id="12886095" author="dagw" created="Wed, 7 Jul 2010 22:34:50 +0100"  >&lt;p&gt;Uploading a new version of the preliminary patch, derby-4736-1b, which makes the test&lt;br/&gt;
correctly expect a row count of 1280 (the same as postgresql). By commenting out the LOJ reordering code in SelectNode, Derby produces the same number of rows also, so there is another bug in the reordering logic somewhere. The test currently fails, although the assert is gone.&lt;/p&gt;</comment>
                            <comment id="12886105" author="dagw" created="Wed, 7 Jul 2010 22:59:22 +0100"  >&lt;p&gt;This smaller part of the query gives a wrong result, too, unless I comment out the reorder logic:&lt;/p&gt;

&lt;p&gt; SELECT count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM (T2 LEFT JOIN (T3 left outer JOIN T4 ON 1=1) ON T2.X = T3.X)&lt;/p&gt;

&lt;p&gt;returns 32 rows, but should return 20, and does if I comment out the reorder logic. So does PostgreSQL. Manually rewriting this query to be left-deep gives 32 rows with both Derby and PostgreSQL.  &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4471&quot; title=&quot;Left outer join reassociation rewrite gives wrong result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4471&quot;&gt;&lt;del&gt;DERBY-4471&lt;/del&gt;&lt;/a&gt;?&lt;br/&gt;
(Answer: yes. Edited dhw 2010-08-20)&lt;/p&gt;</comment>
                            <comment id="12886135" author="dagw" created="Wed, 7 Jul 2010 23:38:27 +0100"  >&lt;p&gt;The analysis in &quot;loj-analysis.txt&quot; which I upload, shows why the result gets different (and wrong) with the reordering, by spelling out the intermediate results of the two orderings variants.&lt;/p&gt;
</comment>
                            <comment id="12887208" author="nirmal" created="Sun, 11 Jul 2010 16:17:52 +0100"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m attaching the query plan created using PlanExporter tool (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4587&quot; title=&quot;Add tools for improved analysis and understanding of query plans and execution statistics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4587&quot;&gt;&lt;del&gt;DERBY-4587&lt;/del&gt;&lt;/a&gt;)&lt;br/&gt;
(I created a PDF, using screen shots of the generated HTML), for the query&lt;br/&gt;
SELECT count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM (T2 LEFT JOIN (T3 left outer JOIN T4 ON 1=1) ON T2.X = T3.X) ,&lt;br/&gt;
since I saw Dag&apos;s comment saying incorrect results returned for that query.&lt;/p&gt;

&lt;p&gt;Hope this helps!&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12888650" author="dagw" created="Thu, 15 Jul 2010 01:53:30 +0100"  >&lt;p&gt;Actually, it was Knut&apos;s simplified query that got an erroneous reordering. &lt;br/&gt;
If I use the original query from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4712&quot; title=&quot;Complex nested joins problems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4712&quot;&gt;&lt;del&gt;DERBY-4712&lt;/del&gt;&lt;/a&gt;, we get a correct reordering &lt;b&gt;and&lt;/b&gt; the ASSERT&lt;br/&gt;
error seen. So, we will address the wrong reordering in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4471&quot; title=&quot;Left outer join reassociation rewrite gives wrong result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4471&quot;&gt;&lt;del&gt;DERBY-4471&lt;/del&gt;&lt;/a&gt; and use the original query&lt;br/&gt;
in our test for this issue.&lt;/p&gt;

&lt;p&gt;Uploading &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4736&quot; title=&quot;ASSERT FAIL when code generating a column reference in a join predicate in presence of other outer join reordering&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4736&quot;&gt;&lt;del&gt;DERBY-4736&lt;/del&gt;&lt;/a&gt;-1c using the original query,  checking that we get the correct result and also that the expected reordering takes place. Running regressions, ready for review.&lt;/p&gt;</comment>
                            <comment id="12889900" author="rhillegas" created="Mon, 19 Jul 2010 17:02:31 +0100"  >&lt;p&gt;Thanks for the patch, Dag. It&apos;s a hopeful sign that this only involves a 1 line change to the engine code. If I understand this change correctly, it seems that you have replaced a full rebinding of all expressions with a more limited rebinding of just the result columns. I would think that a full rebinding would include the more limited rebinding of the result columns. Since you have just been through this pinball machine, can you explain why this fixes the problem? Thanks.&lt;/p&gt;</comment>
                            <comment id="12899842" author="dagw" created="Wed, 18 Aug 2010 14:24:54 +0100"  >&lt;p&gt;Thanks for looking at this, Rick. &lt;br/&gt;
Actually, I don&apos;t &lt;b&gt;replace&lt;/b&gt; the binding of expressions, I just &lt;b&gt;added&lt;/b&gt; a call to bind the result columns which was missing and necessary, cf the explanation here: &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4736?focusedCommentId=12886049&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12886049&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-4736?focusedCommentId=12886049&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12886049&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(JoinNode#bindResultColumns is not called as part of JoinNode#bindExpressions.)&lt;/p&gt;</comment>
                            <comment id="12900508" author="dagw" created="Thu, 19 Aug 2010 23:44:40 +0100"  >&lt;p&gt;Uploading version 1d of this patch, which just improves legibility a bit in the new RuntimeStatisticsParser#assertSequence argument strings, by interpreting &quot;_&quot; as TAB and removing the explicit newline in favor if it being implicit.&lt;/p&gt;

&lt;p&gt;I think this patch is pretty safe, so if there are no objections, I&apos;ll commit it tomorrow.&lt;/p&gt;</comment>
                            <comment id="12900727" author="dagw" created="Fri, 20 Aug 2010 16:13:02 +0100"  >&lt;p&gt;Committed derby-4736-1d as svn 987539, closing.&lt;/p&gt;</comment>
                            <comment id="12902188" author="dagw" created="Wed, 25 Aug 2010 01:11:06 +0100"  >&lt;p&gt;In some cases, with this fix, the nullability of columns from the null-producing (right) side of the LOJ&lt;br/&gt;
gets set to NOT NULL after reassociation.&lt;/p&gt;
</comment>
                            <comment id="12902192" author="dagw" created="Wed, 25 Aug 2010 01:15:54 +0100"  >&lt;p&gt;Attaching a patch which fixes the nullability issue and adds a new test case.&lt;/p&gt;

&lt;p&gt;The problem is that the added call to SelectNode#bindResultColumns, in addition to calling&lt;br/&gt;
fromList.bindResultColumns, which what we need in for this issue, also calls super.bindResultColumns,&lt;br/&gt;
which sets up the datatypes over again, erroneously (i.e. without taking into consideration the nature of outer join which can make values stemming from otherwise NOT NULL columns be null in the final result set).&lt;/p&gt;

&lt;p&gt;Replacing the call to SelectNode#bindResultColumns with fromTable.bindResultColumns avoids this problem. Running regressions.&lt;/p&gt;

</comment>
                            <comment id="12902437" author="dagw" created="Wed, 25 Aug 2010 14:31:28 +0100"  >&lt;p&gt;Committed follow-up patch as snv 989099, closing again.&lt;/p&gt;</comment>
                            <comment id="12910187" author="dagw" created="Thu, 16 Sep 2010 16:28:09 +0100"  >&lt;p&gt;Backported to 10.6 branch as svn 997790.&lt;/p&gt;</comment>
                            <comment id="12991575" author="kmarsden" created="Mon, 7 Feb 2011 20:24:15 +0000"  >&lt;p&gt;Assign to myself for backport&lt;/p&gt;</comment>
                            <comment id="12991676" author="kmarsden" created="Mon, 7 Feb 2011 22:49:06 +0000"  >&lt;p&gt;Closing after backport to 10.5. Note only code change was backported as OuterJoinTest is not in 10.5 branch.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12443160">DERBY-4471</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12497378">DERBY-4994</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12448906" name="derby-4736-1a.diff" size="7987" author="dagw" created="Wed, 7 Jul 2010 20:46:23 +0100"/>
                            <attachment id="12448907" name="derby-4736-1a.stat" size="159" author="dagw" created="Wed, 7 Jul 2010 20:46:23 +0100"/>
                            <attachment id="12448922" name="derby-4736-1b.diff" size="8724" author="dagw" created="Wed, 7 Jul 2010 22:34:50 +0100"/>
                            <attachment id="12448923" name="derby-4736-1b.stat" size="159" author="dagw" created="Wed, 7 Jul 2010 22:34:50 +0100"/>
                            <attachment id="12449512" name="derby-4736-1c.diff" size="9522" author="dagw" created="Thu, 15 Jul 2010 01:53:30 +0100"/>
                            <attachment id="12449513" name="derby-4736-1c.stat" size="239" author="dagw" created="Thu, 15 Jul 2010 01:53:30 +0100"/>
                            <attachment id="12452587" name="derby-4736-1d.diff" size="10300" author="dagw" created="Thu, 19 Aug 2010 23:44:40 +0100"/>
                            <attachment id="12452588" name="derby-4736-1d.stat" size="239" author="dagw" created="Thu, 19 Aug 2010 23:44:40 +0100"/>
                            <attachment id="12452995" name="derby-4736-followup-a.diff" size="3432" author="dagw" created="Wed, 25 Aug 2010 01:15:54 +0100"/>
                            <attachment id="12452996" name="derby-4736-followup-a.stat" size="159" author="dagw" created="Wed, 25 Aug 2010 01:15:54 +0100"/>
                            <attachment id="12448929" name="loj-analysis.txt" size="3726" author="dagw" created="Wed, 7 Jul 2010 23:38:27 +0100"/>
                            <attachment id="12449191" name="query_plan_derby_4736.pdf" size="87704" author="nirmal" created="Sun, 11 Jul 2010 16:17:52 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 11 Jul 2010 15:17:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31355</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0j7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36931</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>