<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:35:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-889/DERBY-889.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-889] with client getTimestamp on a TIME column will print the date  1900-01-01 instead of the current date</title>
                <link>https://issues.apache.org/jira/browse/DERBY-889</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;On client getTimestamp on a TIME column will print date   1900-01-01 instead of the current date like the embedded driver.&lt;br/&gt;
To repro run the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-877&quot; title=&quot;zOS - with DerbyClient getDate(#) fails with IllegalArgumentException - unsupported date format - resultset.java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-877&quot;&gt;&lt;del&gt;DERBY-877&lt;/del&gt;&lt;/a&gt; repro without specifying a file.encoding&lt;/p&gt;

&lt;p&gt;java TestEnc derbynetclient&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;snip&amp;#93;&lt;/span&gt;&lt;br/&gt;
COLUMN 2:TM TIME&lt;br/&gt;
        getString:      16:27:35&lt;br/&gt;
        getTimeStamp:   1900-01-01 16:27:35.0&lt;br/&gt;
        getTime:        16:27:35&lt;br/&gt;
        getDate         Exception SQLSTATE:null  (EXPECTED)&lt;/p&gt;


&lt;p&gt;With Embedded  it prints the current date for getTimestamp&lt;br/&gt;
java TestEnc  derby&lt;/p&gt;

&lt;p&gt;COLUMN 2:TM TIME&lt;br/&gt;
        getString:      16:27:35&lt;br/&gt;
        getTimeStamp:   2006-01-28 16:27:35.0&lt;br/&gt;
        getTime:        16:27:35&lt;br/&gt;
        getDate         Exception SQLSTATE:22005  (EXPECTED)&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12328223">DERBY-889</key>
            <summary>with client getTimestamp on a TIME column will print the date  1900-01-01 instead of the current date</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Sun, 29 Jan 2006 13:31:12 +0000</created>
                <updated>Wed, 3 Apr 2013 09:56:32 +0100</updated>
                            <resolved>Fri, 11 May 2007 19:08:34 +0100</resolved>
                                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12368965" author="bryanpendleton" created="Mon, 6 Mar 2006 09:54:24 +0000"  >&lt;p&gt;I&apos;m not quite sure I understand what reason there is to believe that the client code is wrong here. Why is 1900-01-01 incorrect? In some ways, I think that the client code is more correct. There is no value for the date portion of the data, so providing a value of 1900-01-01 has certain advantages compared to providing &quot;today&apos;s&quot; date. I hunted around in the JDBC specs for a while but couldn&apos;t find a clear statement about which behavior is correct.&lt;/p&gt;</comment>
                            <comment id="12369150" author="djd" created="Tue, 7 Mar 2006 11:49:11 +0000"  >&lt;p&gt;The current date comes from the SQL standard where the conversion of a TIME to a TIMESTAMP takes the date information from CURRENT_DATE&lt;/p&gt;</comment>
                            <comment id="12369162" author="bryanpendleton" created="Tue, 7 Mar 2006 13:34:20 +0000"  >&lt;p&gt;Returning the current date makes sense, and it seems like a simple change to DateTime.timeBytesToTimestamp() should be able to accomplish that. I&apos;ll pursue that path.&lt;/p&gt;

&lt;p&gt;Meanwhile, however, when I run &quot;java TestEnc derby&quot;, which runs the test program with the embedded driver, I &lt;b&gt;don&apos;t&lt;/b&gt; get the current date! Instead, the value that is printed by the program is &lt;/p&gt;

&lt;p&gt;COLUMN 2:TM TIME&lt;br/&gt;
        getString:      16:27:35&lt;br/&gt;
        getTimeStamp:   2006-01-28 16:27:35.0&lt;br/&gt;
        getTime:        16:27:35&lt;br/&gt;
        getDate         Exception SQLSTATE:22005  (EXPECTED)&lt;/p&gt;

&lt;p&gt;which seems to indicate that Embedded is preserving the date information in the TIME column itself.&lt;/p&gt;

&lt;p&gt;That is, embedded seems to be printing 2006-01-28, which is the value that the program originally stores in the table:&lt;/p&gt;

&lt;p&gt;       // Insert same timestamp string into all columns&lt;br/&gt;
       String tsString = &quot;2006-01-28 16:27:35.801&quot;;&lt;br/&gt;
       ps.setString(1,tsString);&lt;br/&gt;
       ps.setString(2,tsString);&lt;br/&gt;
       ps.setString(3,tsString);&lt;br/&gt;
       ps.executeUpdate();&lt;/p&gt;

&lt;p&gt;I&apos;ll study this some more; maybe I&apos;m making a simple mistake here because it&apos;s late at night.&lt;/p&gt;</comment>
                            <comment id="12369352" author="bryanpendleton" created="Wed, 8 Mar 2006 09:46:28 +0000"  >&lt;p&gt;EmbedResultSet extends ConnectionChild. ConnectionChild has a private field &quot;cal&quot; of type Calendar which it re-uses from call to call (see ConnectionChild.getCal() ). This looks like a performance optimization of some sort, but it has the effect that when we call getTimestamp() on a TIME column in the embedded driver, the date portion of the returned timestamp will come back with whatever date information happened to be lying around in ConnectionChild&apos;s &quot;cal&quot; object.&lt;/p&gt;

&lt;p&gt;Thus if getTimestamp(TIME) is the very first time that we make a calendar-related call on this embedded result set, everything is fine, but if the getTimestamp(TIME) call is made after some other call which has populated the cached calendar object, we get the data value of that other call back in our result.&lt;/p&gt;

&lt;p&gt;So I think there is definitely an Embedded bug here, in addition to the Network Client bug discussed in earlier comments.&lt;/p&gt;

&lt;p&gt;One simple way to fix this is to have EmbedResultSet.getTimestamp() always initialize the calendar with today&apos;s date and time:&lt;/p&gt;

&lt;p&gt;Index: java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java  (revision 383160)&lt;br/&gt;
+++ java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java  (working copy)&lt;br/&gt;
@@ -1032,6 +1032,7 @@&lt;/p&gt;

&lt;p&gt;             if( cal == null)&lt;br/&gt;
                 cal = getCal();&lt;br/&gt;
+                       cal.setTime(new java.util.Date());&lt;br/&gt;
                        return dvd.getTimestamp( cal);&lt;/p&gt;

&lt;p&gt;                } catch (StandardException t) &lt;/p&gt;
{

Another possibility, since the underlying SqlTime.java code is prepared to receive a NULL calendar object, is for EmbedResultSet.getTimestamp to skip the optimization of trying to re-use the calendar object, and just allow SqlTime.getTimestamp to allocate a new one:

Index: java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java
===================================================================
--- java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java  (revision 383160)
+++ java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java  (working copy)
@@ -1030,8 +1030,6 @@
                        if (wasNull = dvd.isNull())
                                return null;

-            if( cal == null)
-                cal = getCal();
                        return dvd.getTimestamp( cal);

                }
&lt;p&gt; catch (StandardException t) {&lt;/p&gt;

&lt;p&gt;Since I&apos;m not really sure about the purpose of the cached Calendar object in&lt;br/&gt;
ConnectionChild.java, I&apos;m not quite sure whether one or the other of the above proposals&lt;br/&gt;
is better, or maybe there are other alternatives I should consider instead.&lt;/p&gt;

&lt;p&gt;Comments, anyone?&lt;/p&gt;</comment>
                            <comment id="12369591" author="bryanpendleton" created="Thu, 9 Mar 2006 12:08:42 +0000"  >&lt;p&gt;The JCC driver has the same behavior as the Network Client driver: it prints 1900-01-01 for the date portion.&lt;/p&gt;</comment>
                            <comment id="12369593" author="bryanpendleton" created="Thu, 9 Mar 2006 12:13:12 +0000"  >&lt;p&gt;Here is a proposed patch, including changes to both the embedded driver and the network client driver, and a regression test.&lt;/p&gt;

&lt;p&gt;For the embedded driver, the patch causes the driver to skip using the cached calendar, and instead allow the time conversion code to allocate a fresh new calendar initialized with today&apos;s date.&lt;/p&gt;

&lt;p&gt;For the network client driver, the patch explicitly allocates a java.util.Date object and uses it to set the date portion of the returned timestamp to contain today&apos;s date.&lt;/p&gt;

&lt;p&gt;The regression test is added to jdbcapi/resultset.java, and simply calls getTimestamp() on a field of type TIME and verifies that the date portion of the timestamp that is returned contains today&apos;s date. For good measure, the regression test also calls getTimestamp() on fields of type DATE and type TIMESTAMP and verifies that the expected results are returned there, too. That is possibly overkill, except in the case of the embedded driver it is important for the purposes of reproducing the bug that we force the ConnectionChild cached calendar object to have an &quot;interesting&quot; calendar value, so that is why we call getTimestamp on the other two fields first.&lt;/p&gt;

&lt;p&gt;Please have a look and tell me what you think.&lt;/p&gt;</comment>
                            <comment id="12369602" author="djd" created="Thu, 9 Mar 2006 13:17:03 +0000"  >&lt;p&gt;The cached calendar is a performance optimization.  Ideally we would re-use it as I think we found out that Calendar objects are expensive to create.&lt;br/&gt;
I don&apos;t understand your change to EmbedResultSet, the cal field can be set by other calls so what exactly is removing the lines doing here?&lt;/p&gt;

&lt;p&gt;There is a slight difference between what the SQL standard says and what you have implemented.&lt;br/&gt;
The SQL standard says the DATE fields are taken from CURRENT_DATE which is not exactly the same as today&apos;s date.&lt;/p&gt;

&lt;p&gt;The difference is the CURRENT_DATE remains fixed for the lifetime of a SQL statement, thus if a query crosses midnight&lt;br/&gt;
the value CURRENT_DATE does not change. (and similar for CURRENT_TIMESTAMP)&lt;/p&gt;

&lt;p&gt;Now I have not looked into this to see if the engine performs this correctly for a cast of a TIME to a TIMESTAMP. &lt;/p&gt;

&lt;p&gt;The other question would then be, should the JDBC operation getTimestamp() on a TIME column be the same as cast?&lt;/p&gt;</comment>
                            <comment id="12369883" author="bryanpendleton" created="Sat, 11 Mar 2006 00:47:59 +0000"  >&lt;p&gt;&amp;gt; the cal field can be set by other calls &lt;/p&gt;

&lt;p&gt;I am continuing to struggle with the requirements for this issue, I&apos;m afraid.&lt;/p&gt;

&lt;p&gt;The ResultSet javadoc defines 4 overloads of getTimestamp():&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getTimestamp(int columnIndex)&lt;/li&gt;
	&lt;li&gt;getTimestamp(int columnIndex, Calendar cal)&lt;/li&gt;
	&lt;li&gt;getTimestamp(String columnName)&lt;/li&gt;
	&lt;li&gt;getTimestamp(String columnName, Calendar cal)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The javadoc for the methods which take Calendar arguments say:&lt;br/&gt;
         This method uses the given calendar to construct an appropriate millisecond value for the &lt;br/&gt;
         timestamp if the underlying database does not store timezone information.&lt;br/&gt;
Which is pretty darn terse, unfortunately, and doesn&apos;t give us much guidance.&lt;/p&gt;

&lt;p&gt;With the current unpatched code, I believe, the embedded driver was already not using the&lt;br/&gt;
cached connection from the ConnectionChild if the caller passed in their own Calendar&lt;br/&gt;
object (I will do more testing to confirm this). So I wasn&apos;t  changing that flow. The only&lt;br/&gt;
case where we use the cached Calendar object is when we don&apos;t already have a Calendar object.&lt;/p&gt;

&lt;p&gt;What EmbedResultSet..getTimestamp() does is to call the underlying DataValueDescriptor&apos;s&lt;br/&gt;
getTimestamp() call, passing&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the Calendar object that the application gave us, if it gave us one, or&lt;/li&gt;
	&lt;li&gt;the Calendar object that was cached in ConnectionChild, otherwise&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Now, the SqlTime DataValueDescriptor already knows how to handle the case of a NULL&lt;br/&gt;
Calendar object; in that case it allocates a fresh new Calendar object and initializes it&lt;br/&gt;
with today&apos;s date and time, then fills in the time information from the database column value.&lt;br/&gt;
This is the desired behavior, as I understand it, so all I was doing in the patch was to&lt;br/&gt;
remove the cached Calendar object which was getting in the way of this behavior (and&lt;br/&gt;
which wasn&apos;t providing any other useful behavior that I could see other than the performance&lt;br/&gt;
optimization of not needing to allocate a new Calendar object).&lt;/p&gt;

&lt;p&gt;However, I realize as a result of your comments that there are a number of other issues here:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;how do DataValue objects other than SqlTime handle the Calendar object which is passed&lt;br/&gt;
   into the getTimestamp() method. I will need to research this some more.&lt;/li&gt;
	&lt;li&gt;what is the intended semantic of the JDBC API when the client application passes in a&lt;br/&gt;
   Calendar object to getTimestamp() while fetching a value from a TIME field. Is the&lt;br/&gt;
   intended behavior:&lt;/li&gt;
	&lt;li&gt;that we should preserve the date information in the client&apos;s Calendar object?&lt;/li&gt;
	&lt;li&gt;that we should overwrite the date information in the client&apos;s Calendar object with&lt;br/&gt;
     the current date and time?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Sigh. I&apos;ve got a lot more things to study and learn about. That&apos;s a good thing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; But if you can&lt;br/&gt;
provide any additional guidance in here, either from the SQL standard, or from other areas,&lt;br/&gt;
that would be most helpful.&lt;/p&gt;</comment>
                            <comment id="12369967" author="djd" created="Sat, 11 Mar 2006 14:11:10 +0000"  >&lt;p&gt;I said:&lt;/p&gt;

&lt;p&gt;&amp;gt;The cached calendar is a performance optimization. Ideally we would re-use it as I think we found out that Calendar objects are expensive to create.&lt;br/&gt;
&amp;gt;I don&apos;t understand your change to EmbedResultSet, the cal field can be set by other calls so what exactly is removing the lines doing here?&lt;/p&gt;

&lt;p&gt;This is the piece of your patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if( cal == null)&lt;/li&gt;
	&lt;li&gt;cal = getCal();&lt;br/&gt;
 			return dvd.getTimestamp( cal);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I now see I was confused, I thought from the diff that &apos;cal&apos; was referring to the instance field cal,&lt;br/&gt;
but it&apos;&apos;s referring to the method parameter cal. Sorry.&lt;/p&gt;
</comment>
                            <comment id="12427766" author="bryanpendleton" created="Sun, 13 Aug 2006 17:56:00 +0100"  >&lt;p&gt;Attached is derby-889-updated-Aug-2006.diff. The previous patch &lt;br/&gt;
was getting quite hard to apply, so I updated to the head of trunk &lt;br/&gt;
and regenerated the patch. &lt;/p&gt;

&lt;p&gt;I will mark this issue Patch Available. Please have a look.&lt;/p&gt;</comment>
                            <comment id="12432299" author="djd" created="Sat, 2 Sep 2006 19:06:44 +0100"  >&lt;p&gt;I will look at this patch since I think I might need it before I can write a test for changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1700&quot; title=&quot;Remove passing of closeCleanup method to every ResultSet type since only the top ResultSet requires it.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1700&quot;&gt;&lt;del&gt;DERBY-1700&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12432311" author="djd" created="Sun, 3 Sep 2006 01:08:55 +0100"  >&lt;p&gt;Regardless of any Derby implementation details, it&apos;s not clear that we have agreement on the expected behaviour for getTimestamp() on a TIME column.&lt;/p&gt;

&lt;p&gt;JDBC spec says it is allowed (conversion table B6)&lt;/p&gt;

&lt;p&gt;However this similar conversion are not allowed&lt;br/&gt;
    setObject() with a java.sql.Time value into a TIMESTAMP column (table B5)&lt;/p&gt;

&lt;p&gt;The ResultSet.getTimestamp javadoc as Bryan pointed out is not much help.&lt;/p&gt;

&lt;p&gt;The question is what should be the date portion be for the java.sql.Timestamp value.&lt;/p&gt;

&lt;p&gt;First case is the getTimestamp() methods that do &lt;b&gt;not&lt;/b&gt; pass a Calendar object.&lt;/p&gt;

&lt;p&gt;There seem to be four options:&lt;/p&gt;

&lt;p&gt;A) 1900-01-01 (which client does)&lt;br/&gt;
B) 1970-01-01 &lt;br/&gt;
C) the current date at the time the getTimestamp() is called (which embedded tries to do, though has with bugs in the handling)&lt;br/&gt;
D) the value of the SQL function CURRENT_DATE&lt;br/&gt;
E) 0000-01-01 (earliest date supported by Derby)&lt;/p&gt;


&lt;p&gt;The 1970 date in B) comes from the requirement for the java.sql.Time value to have date components of 1970-01-01, see javadoc for java.sql.Time.&lt;/p&gt;

&lt;p&gt;C) is what Bryan implemented/fixed (I think) - Can you confirm?&lt;/p&gt;

&lt;p&gt;D) Would map to the behaviour defined by CAST (&amp;lt;TIME expression&amp;gt; TO TIMESTAMP)&lt;/p&gt;

&lt;p&gt;Note that the dates in C) and D) can be different, basically when a query crosses midnight or takes multiple days to run.&lt;/p&gt;

&lt;p&gt;Thinking about it  D) seems to be not an option, this would be impossible for a client driver to implement unless it added an extra column into every query that had a returned TIME column. That extra column would be the CURRENT_DATE. Thus the logic for the conversion has to be isolated to the driver.&lt;/p&gt;

&lt;p&gt;Option A) seems invalid to me, why 1900-01-01, that&apos;s not the start of the Derby DATE range or the java.sql.Timestamp DATE range, why is that date better than any other?&lt;/p&gt;

&lt;p&gt;Option B) has some merit it&apos;s the epoch date for Java time values, doesn&apos;t seem that useful though.&lt;/p&gt;

&lt;p&gt;Note that the same issue exists for DATE to TIMESTAMP, comments in the embedded code indicate the intended behaviour is to generate&lt;br/&gt;
a TIMSTAMP with a time portion of 00:00:00 (midnight). That would correspond to E) in the TIME to TIMESTAMP conversion.&lt;/p&gt;

&lt;p&gt;So the intended embedded behaviour is&lt;/p&gt;

&lt;p&gt;TIME-&amp;gt;java.sql.Timestamp - date component set to current date&lt;br/&gt;
DATE -&amp;gt; java.sql.Timestamp - time component set to 00:00:00 (midnight)&lt;/p&gt;

&lt;p&gt;These both seem reasonable, even though they are not symmetric.&lt;/p&gt;

&lt;p&gt;I would then assert for the getTimestamp() methods with a passed in Calendar, that the behaviour&lt;br/&gt;
is exactly the same. The only difference is that the long milliseconds value (since 1970)  in the java.sql.Timestamp&lt;br/&gt;
is different to account for the time zone of the passed in Calendar, which I think matches the javadoc for these methods.&lt;/p&gt;

&lt;p&gt;Seems good?&lt;/p&gt;

















</comment>
                            <comment id="12432312" author="djd" created="Sun, 3 Sep 2006 01:13:27 +0100"  >&lt;p&gt;I think this is in-line with the current documented handling of the DATE-&amp;gt;java.sql.Date, TIME-&amp;gt;java.sql.Time and TIMESTAMP-&amp;gt;java.sql.Timestamp in&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://db.apache.org/derby/papers/JDBCImplementation.html#Date+Handling&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/papers/JDBCImplementation.html#Date+Handling&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That document could be updated with for conversions of DATE to java.sql.Timestamp and TIME to java.sql.Timestamp&lt;/p&gt;</comment>
                            <comment id="12432323" author="djd" created="Sun, 3 Sep 2006 06:16:34 +0100"  >&lt;p&gt;I entered &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt; for the problem with the embedded driver, the code in the patch is incorrect for the embedded driver for two reasons:&lt;/p&gt;

&lt;p&gt;1) It removes the optimization of using a re-ussable Calendar object from EmbedResultSet&lt;/p&gt;

&lt;p&gt;2) It leaves the bug in the SQLTime.getTimestamp() method where if a non-null Calendar is passed in the incorrect Timestamp can be returned.&lt;/p&gt;</comment>
                            <comment id="12432344" author="bryanpendleton" created="Sun, 3 Sep 2006 16:35:58 +0100"  >&lt;p&gt;Hi Dan, thanks for the feedback and pointers.&lt;/p&gt;

&lt;p&gt;Yes, behavior (C): the current date at the time the getTimestamp() is called, is the&lt;br/&gt;
behavior that I was attempting to achieve with the patch.&lt;/p&gt;

&lt;p&gt;Am I understanding correctly that your idea with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt; is to split this issue&lt;br/&gt;
into a client issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-889&quot; title=&quot;with client getTimestamp on a TIME column will print the date  1900-01-01 instead of the current date&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-889&quot;&gt;&lt;del&gt;DERBY-889&lt;/del&gt;&lt;/a&gt;) and an embedded issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt;)? That&lt;br/&gt;
seems like a good plan to me.&lt;/p&gt;

&lt;p&gt;Regarding your critique of the EmbedResultSet change, I agree that it is undesirable&lt;br/&gt;
to lose the optimization of re-using the shared Calendar object, and I agree that it&lt;br/&gt;
leaves a hole in that it doesn&apos;t actively ensure any particular value for the DATE portion&lt;br/&gt;
in the case of getTimestamp(&amp;lt;TIME column&amp;gt;, cal).&lt;/p&gt;

&lt;p&gt;It sounds like your preferred fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt; would be:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;always re-use the cached calendar object if the user does not pass one in&lt;/li&gt;
	&lt;li&gt;set the date portion of the calendar object (either the cached one or the user-provided one)&lt;br/&gt;
   to contain the current date when converting a TIME value into a TIMESTAMP&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks for your continued review and your help understanding the intended behavior.&lt;/p&gt;</comment>
                            <comment id="12432352" author="djd" created="Sun, 3 Sep 2006 17:03:22 +0100"  >&lt;p&gt;Yes, I split t because the embedded behaviour (I think) is a more serious bug, it can return a totally incorrect date even though simple tests can show it as working. The client side had fixed behaviour.&lt;/p&gt;

&lt;p&gt;I attached a patch to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt; for the embedded changes. Not ready for commit yet, need some more testing, I&apos;m adding a JUnit test case.&lt;/p&gt;

&lt;p&gt;For your client changes they look correct in that they perform the desired behaviour, but I wonder if they should use the correct mechanism&lt;br/&gt;
and use a Calendar object. java.sql.Timstamp is a strange class in that its javadoc states its super class of java.util.Date should be&lt;br/&gt;
seen as an implementation detail and not  part of its api. So methods like setDate() etc. are not really part of the contract of java.sql.Timestamp.&lt;br/&gt;
How does the client handle the getTimestamp methods that pass in a Calendar?&lt;/p&gt;</comment>
                            <comment id="12432379" author="bryanpendleton" created="Sun, 3 Sep 2006 21:39:14 +0100"  >&lt;p&gt;The client&apos;s implementation of the &quot;with-calendar&quot; form of the getTimestamp methods uses the passed-in calendar &lt;br/&gt;
only to perform a timezone adjustment. getDate(), getTime(), and getTimestamp() are all similar in this respect. So the &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-889&quot; title=&quot;with client getTimestamp on a TIME column will print the date  1900-01-01 instead of the current date&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-889&quot;&gt;&lt;del&gt;DERBY-889&lt;/del&gt;&lt;/a&gt; bug also occurs when a Calendar is passed to getTimestamp().&lt;/p&gt;

&lt;p&gt;The relevant code is around lines 875-1050 in org.apache.derby.client.am.ResultSet&lt;/p&gt;

&lt;p&gt;I see your point about the strange contract of java.sql.Timestamp, though we&apos;ve clearly been getting away with this for many years.&lt;/p&gt;

&lt;p&gt;I think that, now that &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt; is broken out, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-889&quot; title=&quot;with client getTimestamp on a TIME column will print the date  1900-01-01 instead of the current date&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-889&quot;&gt;&lt;del&gt;DERBY-889&lt;/del&gt;&lt;/a&gt; no longer blocks &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1700&quot; title=&quot;Remove passing of closeCleanup method to every ResultSet type since only the top ResultSet requires it.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1700&quot;&gt;&lt;del&gt;DERBY-1700&lt;/del&gt;&lt;/a&gt;, right?&lt;/p&gt;

&lt;p&gt;So I think that the right plan is this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fix &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt; first&lt;/li&gt;
	&lt;li&gt;then I&apos;ll revisit this patch, removing the embedded fix, adding tests for the &quot;with-calendar&quot; form of getTimestamp,&lt;br/&gt;
   and looking at the issue you raised about java.sql.Timestamp&apos;s inheritance from java.util.Date.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the time being, I&apos;m going to clear Patch Available because the current patch needs further work.&lt;/p&gt;</comment>
                            <comment id="12432380" author="bryanpendleton" created="Sun, 3 Sep 2006 21:45:12 +0100"  >&lt;p&gt;Attached is derby-889-withCalTests.diff. This patch file just contains some tests of the &quot;with-calendar&quot;&lt;br/&gt;
version of the ResultSet.getTimestamp methods.&lt;/p&gt;

&lt;p&gt;At a later time, I intend to combine derby-889-updated-Aug-2006.diff and&lt;br/&gt;
derby-889-withCalTests.diff, to produce a new proposed patch, but this&lt;br/&gt;
will probably not happen until &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1811&quot; title=&quot;Embedded ResultSet.getTimestamp on a TIME column returns a java.sql.Timestamp with a date portion that can be incorrect.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1811&quot;&gt;&lt;del&gt;DERBY-1811&lt;/del&gt;&lt;/a&gt; has been fixed since that patch&lt;br/&gt;
will supercede the embedded patch proposed in derby-889-updated-Aug-2006.diff &lt;/p&gt;</comment>
                            <comment id="12437887" author="bryanpendleton" created="Tue, 26 Sep 2006 17:57:10 +0100"  >&lt;p&gt;tests/lang/TimeHandlingTest.java may provide some good ideas about&lt;br/&gt;
ways to improve the testing of these changes.&lt;/p&gt;

&lt;p&gt;Marked the bug as unassigned; I&apos;m not actively working on this problem.&lt;/p&gt;</comment>
                            <comment id="12495112" author="kmarsden" created="Fri, 11 May 2007 19:08:34 +0100"  >&lt;p&gt;Committed Bryan&apos;s fix for this issue. &lt;br/&gt;
revision 537252.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12354628">DERBY-2034</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12349136">DERBY-1811</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12390676">DERBY-3519</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12349305">DERBY-1816</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12338764" name="derby-889-updated-Aug-2006.diff" size="8260" author="bryanpendleton" created="Sun, 13 Aug 2006 17:56:00 +0100"/>
                            <attachment id="12340115" name="derby-889-withCalTests.diff" size="4491" author="bryanpendleton" created="Sun, 3 Sep 2006 21:45:12 +0100"/>
                            <attachment id="12323962" name="derby-889.diff" size="8276" author="bryanpendleton" created="Thu, 9 Mar 2006 12:13:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 6 Mar 2006 09:54:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22189</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0k53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37081</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>