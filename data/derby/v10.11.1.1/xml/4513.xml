<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:17:08 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4513/DERBY-4513.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4513] Forbid NEXT VALUE FOR clause in certain contexts</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4513</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This is part of the work needed to implement ANSI/ISO sequences. The functional spec attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-712&quot; title=&quot;Support for sequences&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-712&quot;&gt;&lt;del&gt;DERBY-712&lt;/del&gt;&lt;/a&gt; lists various situations in which the NEXT VALUE FOR clause is illegal. These include:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;CASE expression&lt;/li&gt;
	&lt;li&gt;WHERE clause&lt;/li&gt;
	&lt;li&gt;ORDER BY clause&lt;/li&gt;
	&lt;li&gt;AGGREGATE expression&lt;/li&gt;
	&lt;li&gt;WINDOW function&lt;/li&gt;
	&lt;li&gt;DISTINCT select list&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In addition, I propose that we make it illegal for a statement to have more than one NEXT VALUE FOR clause on the same sequence generator. This is a tighter restriction than the ANSI/ISO standard calls for. The standard requires that if two columns in a row are populated by NEXT VALUE FOR clauses on the same sequence, then the values should be the same. I don&apos;t feel confident that I could track down all of the cases which could give rise to this situation--so I propose to limit the number of NEXT VALUE FOR clauses on a given sequence generator to just 1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12445329">DERBY-4513</key>
            <summary>Forbid NEXT VALUE FOR clause in certain contexts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Jan 2010 18:34:28 +0000</created>
                <updated>Wed, 12 Jan 2011 19:08:01 +0000</updated>
                            <resolved>Wed, 10 Feb 2010 18:53:24 +0000</resolved>
                                    <version>10.6.1.0</version>
                                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12799675" author="knutanders" created="Wed, 13 Jan 2010 10:02:07 +0000"  >&lt;p&gt;Hi Rick,&lt;/p&gt;

&lt;p&gt;I&apos;m fine with extra restrictions in the initial implementation, but I&apos;m afraid I didn&apos;t understand exactly what limitation you&apos;re suggesting. Are you suggesting to limit the number of NEXT VALUE FOR clauses per row or per statement?&lt;/p&gt;</comment>
                            <comment id="12799725" author="rhillegas" created="Wed, 13 Jan 2010 12:47:40 +0000"  >&lt;p&gt;Hi Knut. I&apos;m suggesting that we allow one NEXT VALUE FOR clause per sequence per statement. Thanks.&lt;/p&gt;</comment>
                            <comment id="12799731" author="knutanders" created="Wed, 13 Jan 2010 13:17:57 +0000"  >&lt;p&gt;Thanks for clarifying, Rick.&lt;/p&gt;

&lt;p&gt;So both of these (presumably SQL compliant) statements will be rejected?&lt;/p&gt;

&lt;p&gt;  SELECT NEXT VALUE FOR S, NEXT VALUE FOR S FROM T  &amp;#8211; two clauses per row&lt;/p&gt;

&lt;p&gt;  VALUES (NEXT VALUE FOR S), (NEXT VALUE FOR S) &amp;#8211; two clauses in the statement, but only one per row&lt;/p&gt;

&lt;p&gt;The VALUES case is probably more useful than the SELECT case, especially as part of an INSERT statement. The restriction would basically prevent us from using a sequence generator in a multi-row insert. That&apos;s probably fine in the initial implementation, though, and anyone could scratch that itch later if they want to.&lt;/p&gt;</comment>
                            <comment id="12799745" author="rhillegas" created="Wed, 13 Jan 2010 13:51:32 +0000"  >&lt;p&gt;Hi Knut,&lt;/p&gt;

&lt;p&gt;Yes, that&apos;s an accurate summary of the restriction I&apos;m proposing. Note that there is an ungainly workaround for the insert case you mention. Instead of a values clause, you can use a subquery which selects from sysibm.sysdummy1:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:dummy;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create table t( a int, b int );&lt;br/&gt;
create sequence seq1;&lt;/p&gt;

&lt;p&gt;insert into t( a, b )&lt;br/&gt;
 select s.c, s.c&lt;br/&gt;
 from ( select next value for seq1 as c from sysibm.sysdummy1 ) as s;&lt;/p&gt;

&lt;p&gt;select * from t;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="12830610" author="rhillegas" created="Sun, 7 Feb 2010 02:08:38 +0000"  >&lt;p&gt;Attaching derby-4513_01-aa-illegalContexts.diff. This patch prevents you from using a NEXT VALUE FOR clause in the following situations:&lt;/p&gt;

&lt;p&gt;o WHERE/HAVING/ON clauses&lt;/p&gt;

&lt;p&gt;o Aggregates and GROUP BY expressions&lt;/p&gt;

&lt;p&gt;o DISTINCT and ORDER BY expressions&lt;/p&gt;

&lt;p&gt;o CASE expressions&lt;/p&gt;

&lt;p&gt;o CHECK constraints and generation clauses&lt;/p&gt;


&lt;p&gt;The limitations imposed by this patch are more restrictive than what the SQL Standard allows:&lt;/p&gt;

&lt;p&gt;o Only one NEXT VALUE FOR expression is allowed per sequence per statement.&lt;/p&gt;

&lt;p&gt;o NEXT VALUE FOR is not allowed in any statement which has a DISTINCT or ORDER BY expression.&lt;/p&gt;


&lt;p&gt;When these limitations are checked in, I will create another JIRA to track the fact that Derby is more restrictive than the Standard allows. We can consider relaxing limitations which users find onerous.&lt;/p&gt;


&lt;p&gt;Touches the following files&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/iapi/sql/compile/CompilerContext.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/compile/CompilerContextImpl.java&lt;/p&gt;

&lt;p&gt;The compiler context now tracks which sequences are mentioned in the statement.&lt;/p&gt;


&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/compile/sqlgrammar.jj&lt;/p&gt;

&lt;p&gt;Statements which have DISTINCT and ORDER BY expressions are marked so that the bind() logic can reject NEXT VALUE FOR clauses.&lt;/p&gt;


&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/compile/SelectNode.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/compile/AggregateNode.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/compile/GroupByColumn.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/compile/ConditionalNode.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/compile/JoinNode.java&lt;br/&gt;
M      java/engine/org/apache/derby/impl/sql/compile/NextSequenceNode.java&lt;/p&gt;

&lt;p&gt;Bind() logic to reject NEXT VALUE FOR in illegal situations.&lt;/p&gt;


&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/loc/messages.xml&lt;br/&gt;
M      java/shared/org/apache/derby/shared/common/reference/SQLState.java&lt;/p&gt;

&lt;p&gt;New error messages.&lt;/p&gt;


&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequencePermsTest.java&lt;br/&gt;
M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceTest.java&lt;/p&gt;

&lt;p&gt;Regression tests.&lt;/p&gt;


&lt;p&gt;-------------&lt;/p&gt;</comment>
                            <comment id="12831985" author="knutanders" created="Wed, 10 Feb 2010 13:37:18 +0000"  >&lt;p&gt;I downloaded and applied the patch, but I still seem to be able to use NEXT VALUE FOR in WHERE clauses:&lt;/p&gt;

&lt;p&gt;ij version 10.6&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:seqdb;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create sequence s;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from sysibm.sysdummy1 where (next value for s) &amp;lt; 4;&lt;br/&gt;
IBM&amp;amp;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Y   &lt;/p&gt;

&lt;p&gt;1 row selected&lt;/p&gt;

&lt;p&gt;What am I missing?&lt;/p&gt;</comment>
                            <comment id="12832002" author="rhillegas" created="Wed, 10 Feb 2010 14:22:53 +0000"  >&lt;p&gt;Thanks for looking at the patch, Knut. I don&apos;t know what&apos;s going on. I did notice merge errors when I resynced this patch client with the trunk. I&apos;ve brought the patch up-to-date with the head of the trunk and am attaching a merged revision: derby-4513_01-ab-illegalContexts.diff&lt;/p&gt;

&lt;p&gt;Here&apos;s what I see with this patch when I run your experiment:&lt;/p&gt;

&lt;p&gt;ij version 10.6&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:memory:dummy;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create sequence s;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from sysibm.sysdummy1 where (next value for s) &amp;lt; 4;&lt;br/&gt;
ERROR 42XAH: A NEXT VALUE FOR expression may not appear in many contexts, including WHERE, ON, HAVING, ORDER BY, DISTINCT, CASE, GENERATION, and AGGREGATE clauses as well as WINDOW functions and CHECK constraints.&lt;/p&gt;

&lt;p&gt;Let me know if this still doesn&apos;t fix the problem. Thanks.&lt;/p&gt;</comment>
                            <comment id="12832009" author="knutanders" created="Wed, 10 Feb 2010 14:43:25 +0000"  >&lt;p&gt;Thanks! It works as expected now.&lt;/p&gt;</comment>
                            <comment id="12832124" author="rhillegas" created="Wed, 10 Feb 2010 18:53:03 +0000"  >&lt;p&gt;Thanks, Knut. Committed derby-4513_01-ab-illegalContexts.diff at subversion revision 908627.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12325742">DERBY-712</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12474315">DERBY-4803</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12435100" name="derby-4513_01-aa-illegalContexts.diff" size="23099" author="rhillegas" created="Sun, 7 Feb 2010 02:08:38 +0000"/>
                            <attachment id="12435447" name="derby-4513_01-ab-illegalContexts.diff" size="23026" author="rhillegas" created="Wed, 10 Feb 2010 14:22:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 13 Jan 2010 10:02:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24308</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0o6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37736</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>