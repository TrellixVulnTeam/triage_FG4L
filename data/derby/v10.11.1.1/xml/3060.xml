<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:32:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3060/DERBY-3060.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3060] Network Server incorrectly assumes that all SQLExceptions with error code 08004 are caused by an authentication failure.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3060</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;DRDAConnThread#getConnFromDatabaseName incorrectly assumes that all SQLExceptions with error code 08004 thrown when trying to connect to a database are caused by an authentication failure.&lt;/p&gt;

&lt;p&gt;DRDAConnThread lines 1295-1296:&lt;br/&gt;
-----&lt;del&gt;8&amp;lt;&lt;/del&gt;----- &lt;br/&gt;
if (sqlState.regionMatches(0,SQLState.LOGIN_FAILED,0,5)) &lt;br/&gt;
    return CodePoint.SECCHKCD_USERIDINVALID;&lt;br/&gt;
-----&lt;del&gt;&amp;gt;8&lt;/del&gt;-----&lt;/p&gt;


&lt;p&gt;I have added an exception to BasicDatabase#setupConnection with error code 08004.C.7. The exception is thrown if the connection is refused because the database has been booted in slave replication mode. This exception is, however, translated into an authentication exception by DRDAConnThread:&lt;/p&gt;


&lt;p&gt;When the NetworkServer has already booted a database &apos;test&apos; in slave replication mode, I get the following output from ij:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby://localhost/test&apos;;&lt;br/&gt;
ERROR 08004: Connection authentication failure occurred.  Reason: userid or password invalid.&lt;/p&gt;

&lt;p&gt;If I change the SQL code of the exception to XRE02.C and repeat, I get:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby://localhost/test&apos;;&lt;br/&gt;
ERROR XRE02: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE02, SQLERRMC: Connect refused to database &apos;test&apos; because it is in replication slave mode.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12377640">DERBY-3060</key>
            <summary>Network Server incorrectly assumes that all SQLExceptions with error code 08004 are caused by an authentication failure.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jorgenlo">J&#248;rgen L&#248;land</assignee>
                                    <reporter username="jorgenlo">J&#248;rgen L&#248;land</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Sep 2007 10:51:13 +0100</created>
                <updated>Wed, 12 Sep 2007 11:57:15 +0100</updated>
                            <resolved>Wed, 12 Sep 2007 11:39:06 +0100</resolved>
                                    <version>10.3.1.4</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12525385" author="jorgenlo" created="Thu, 6 Sep 2007 10:52:33 +0100"  >&lt;p&gt;The network server was started with -noSecurityManager&lt;/p&gt;</comment>
                            <comment id="12525429" author="djd" created="Thu, 6 Sep 2007 15:52:17 +0100"  >&lt;p&gt;I assume this is an issue with the Network Server and not the standard DRDA protocol&lt;/p&gt;</comment>
                            <comment id="12525701" author="jorgenlo" created="Fri, 7 Sep 2007 14:00:25 +0100"  >&lt;p&gt;Attaching a patch, v1, that does the following:&lt;/p&gt;

&lt;p&gt;M      java/drda/org/apache/derby/impl/drda/DRDAConnThread.java&lt;/p&gt;

&lt;p&gt;Added a method, isAuthenticationException, that checks if the EmbedSQLException.getMessageId field is equal to the authentication error code in SQLState.java. getMessageId returns the whole 9-character error code (e.g. 08004.C.1) instead of only the first five chars returned by getSqlState, allowing us to check if the exception is, in fact, authentication related. &lt;/p&gt;

&lt;p&gt;If the exception turns out to not be an EmbedSQLException, the pre-patch strategy of assuming the cause is an authentication failure is used.&lt;/p&gt;

&lt;p&gt;The described method is used in two cases that previously only checked if the SQL state was 08004 and concluded on an authentication failure.&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java&lt;br/&gt;
M      java/engine/org/apache/derby/jdbc/InternalDriver.java&lt;/p&gt;

&lt;p&gt;Changed two uses of SQLState.LOGIN_FAILED where the causes of the exceptions were failed authentication. Changed these to use the more explicit SQLState for authentication error: NET_CONNECT_AUTH_FAILED &lt;/p&gt;


&lt;p&gt;I have started the tests and will revert back with results once these have completed. I attached the patch now in case someone wants to comment on the solution.&lt;/p&gt;</comment>
                            <comment id="12526086" author="jorgenlo" created="Mon, 10 Sep 2007 09:19:48 +0100"  >&lt;p&gt;derbyall and allsuites completed without error&lt;/p&gt;</comment>
                            <comment id="12526394" author="oysteing" created="Tue, 11 Sep 2007 10:29:25 +0100"  >&lt;p&gt;J&#248;rgen, thank you for the patch.  It looks very good, and is very well commented.  I am running tests, and will commit the patch if nothing new shows up.  While at it, I will take the liberty to fix a mistaken bit-wise or in getRdbAccessErrorCodePoint, and also add some curly braces to make it more readable.  (None of this was introduced by this patch.)&lt;/p&gt;</comment>
                            <comment id="12526737" author="oysteing" created="Wed, 12 Sep 2007 11:39:06 +0100"  >&lt;p&gt;Patch derby-3060-1.diff committed in version 574870.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12376584">DERBY-3021</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12365348" name="derby-3060-1.diff" size="6461" author="jorgenlo" created="Fri, 7 Sep 2007 14:00:19 +0100"/>
                            <attachment id="12365349" name="derby-3060-1.stat" size="192" author="jorgenlo" created="Fri, 7 Sep 2007 14:00:22 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 Sep 2007 14:52:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23405</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy113r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39829</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>