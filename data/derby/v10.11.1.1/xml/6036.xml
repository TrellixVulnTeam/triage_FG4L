<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:45:59 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6036/DERBY-6036.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6036] If you wrap a SELECT * view around a table, all of the columns are read from the base row even when you SELECT only a subset of the view columns.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6036</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This also affects SELECTs from views wrapping RestrictedVTIs. Restrictions are pushed into a restricted VTI if you wrap it in a view. However, projections are not. I will attach a script showing this problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12626358">DERBY-6036</key>
            <summary>If you wrap a SELECT * view around a table, all of the columns are read from the base row even when you SELECT only a subset of the view columns.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_triage10_11</label>
                    </labels>
                <created>Mon, 7 Jan 2013 15:10:26 +0000</created>
                <updated>Fri, 13 Dec 2013 14:44:43 +0000</updated>
                                            <version>10.10.1.1</version>
                                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13545951" author="rhillegas" created="Mon, 7 Jan 2013 15:12:22 +0000"  >&lt;p&gt;Attaching a repro, derby-6036.sql.&lt;/p&gt;</comment>
                            <comment id="13546022" author="rhillegas" created="Mon, 7 Jan 2013 16:45:41 +0000"  >&lt;p&gt;If you wrap a base table in a view, it appears that the projection is not passed through to the base table. I am attaching derbyAST.xml, which is the printout of parse(), bind(), and optimize() ASTs produced by the following script when you use the XmlASTPrinter attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4415&quot; title=&quot;Make it easy to plug custom AST printers into the compiler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4415&quot;&gt;&lt;del&gt;DERBY-4415&lt;/del&gt;&lt;/a&gt;. From the printout, you can see the following:&lt;/p&gt;

&lt;p&gt;1) For the SELECT from a base table (select s_nr from t where ns_r = 3000), the optimizer wraps the base table in a ProjectRestrict node which projects out only two columns.&lt;/p&gt;

&lt;p&gt;2) However, for the SELECT from a view on that base table (select s_nr from vt where ns_r = 3000), the optimizer wraps the base table in a ProjectRestrict node which projects out ALL four columns in the table.&lt;/p&gt;

&lt;p&gt;Here is the script:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;&lt;/p&gt;

&lt;p&gt;create function integerList()&lt;br/&gt;
returns table( s_r int, s_nr int, ns_r int, ns_nr int )&lt;br/&gt;
language java&lt;br/&gt;
parameter style derby_jdbc_result_set&lt;br/&gt;
no sql&lt;br/&gt;
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.RestrictedVTITest.integerList&apos;;&lt;/p&gt;

&lt;p&gt;create view vf as select * from table( integerList() ) s;&lt;/p&gt;

&lt;p&gt;create table t ( s_r int, s_nr int, ns_r int, ns_nr int );&lt;br/&gt;
insert into t values ( 1, 2, 3, 4 ), ( 100, 200, 300, 400 ), ( 1000, 2000, 3000, 4000 ), ( 10000, 20000, 30000, 40000 );&lt;br/&gt;
create view vt as select * from t;&lt;/p&gt;

&lt;p&gt;create procedure setInspector( visitorClassName varchar( 32672 ) )&lt;br/&gt;
language java&lt;br/&gt;
parameter style java&lt;br/&gt;
modifies sql data&lt;br/&gt;
external name &apos;ASTInspector.setInspector&apos;&lt;br/&gt;
;&lt;/p&gt;

&lt;p&gt;call setInspector( &apos;XmlASTPrinter&apos; );&lt;/p&gt;

&lt;p&gt;select s_nr from t where ns_r = 3000;&lt;br/&gt;
select s_nr from table( integerList() ) s where ns_r = 3000;&lt;/p&gt;

&lt;p&gt;select s_nr from vt where ns_r = 3000;&lt;br/&gt;
select s_nr from vf where ns_r = 3000;&lt;/p&gt;

&lt;p&gt;call setInspector( null );&lt;/p&gt;</comment>
                            <comment id="13547178" author="rhillegas" created="Tue, 8 Jan 2013 19:42:44 +0000"  >&lt;p&gt;I have verified that there is no special jiggery-pokery to reduce the number of columns read from the base table when it is wrapped in a view. For the SELECT from the view (select s_nr from vt where ns_r = 3000), the whole row is read from the Store.&lt;/p&gt;

&lt;p&gt;Fixing this performance problem may be a little tricky. The ProjectRestrict nodes are added by the optimizer AFTER the bind-phase has expanded the * in the view and concluded that ALL of the columns are being referenced.&lt;/p&gt;</comment>
                            <comment id="13548547" author="rhillegas" created="Wed, 9 Jan 2013 14:49:24 +0000"  >&lt;p&gt;I don&apos;t think I&apos;m ready to propose a solution to this issue. My feeling is that this requires more thought and experiment than I have time for right now. Before putting this issue aside, I want to record a couple notes:&lt;/p&gt;

&lt;p&gt;1) There is a workaround for this issue, viz., rewrite the query to eliminate the view.&lt;/p&gt;

&lt;p&gt;2) What queries are really affected by this problem? Affected queries are those in which the cost of materializing the unneeded columns is significant. For instance,&lt;/p&gt;

&lt;p&gt;a) SELECTs of base tables with large rows which span multiple pages.&lt;/p&gt;

&lt;p&gt;b) SELECTs where the needed columns live in a covering index and a base table probe is needed to fetch the unneeded columns.&lt;/p&gt;

&lt;p&gt;3) Here are some problem cases which a solution needs to address:&lt;/p&gt;

&lt;p&gt;a) SELECT * views. This is the original test case discussed by this issue:&lt;/p&gt;

&lt;p&gt;    create view vt as select * from t;&lt;br/&gt;
    select s_nr from vt where ns_r = 3000;&lt;/p&gt;

&lt;p&gt;b) Views which explicitly SELECT columns not needed by the outer query:&lt;/p&gt;

&lt;p&gt;    create view vt1 as select s_r, s_nr from t where ns_r = 3000;&lt;br/&gt;
    select s_nr from vt1;&lt;/p&gt;</comment>
                            <comment id="13548677" author="rhillegas" created="Wed, 9 Jan 2013 16:54:20 +0000"  >&lt;p&gt;Attaching derby-6036-01-aa-testForRestrictionPushing.diff. This adds a test case to verify that restrictions are passed through the view but not projections. Committed at subversion revision 1430957.&lt;/p&gt;

&lt;p&gt;When we address this issue, we should adjust RestrictedVTITest.test_12_6036() to verify that projections are passed through also.&lt;/p&gt;


&lt;p&gt;Touches the following file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/RestrictedVTITest.java&lt;/p&gt;</comment>
                            <comment id="13687744" author="dagw" created="Wed, 19 Jun 2013 08:55:22 +0100"  >&lt;p&gt;Triaged for 10.11.&lt;/p&gt;</comment>
                            <comment id="13687745" author="dagw" created="Wed, 19 Jun 2013 08:57:29 +0100"  >&lt;p&gt;The &quot;Affects version&quot; field could probably include all older versions here, but I didn&apos;t mark then now them since it&apos;s a fair amount of work to verify.&lt;/p&gt;</comment>
                            <comment id="13846261" author="rhuddusa" created="Thu, 12 Dec 2013 12:02:24 +0000"  >&lt;p&gt;i&apos;m working on a project that uses 1 derby function and n views of that 1 function to access data in a foreign database. for each foreign database table, we have a corresponding view in derby with the EXACT name of the table in the foreign database.&lt;/p&gt;

&lt;p&gt;we were able to port our code over to derby by simply changing the jdbc connection params to derby instead of our foreign database, and all the code magically worked.  if we had to change to functions instead of views, we&apos;d lose the flexibility of our code running against the foreign database or derby. i have 30+ developers who have existing sql in tons of different places and development languages that reference the table names / matching derby view name, it&apos;s not practical for us to change all the table.&lt;/p&gt;

&lt;p&gt;why performance matters.  i created a derby facade to our foreign database out there that supports bulk extractions .  that database shards data into 16 or more different slave machines. i use derby to issue a query to the &quot;master&quot; machine instructing all the slaves to send data back to derby. those slave machines in aggregate pump data to our derby facade machine at greater than 1 gigabit/sec, where the data flow lasts more than 30 seconds and we are network bandwidth constrained.  so, it&apos;s LOTS of data.  we have more than 8 fields, and this is a common thing in our facade:&lt;br/&gt;
select some_id from my_derby_function_view where theDate = &apos;12/11/2013&apos;&lt;br/&gt;
select count(some_id) from my_derby_function_view where theDate = &apos;12/11/2013&apos;&lt;br/&gt;
because derby doesn&apos;t pass down the field names from the view into our function via initscan, our data flow is more than 8x larger than needed. if this bug were fixed, instead of say 32 seconds, our query would in 4 seconds if we knew which columns derby really needed.&lt;/p&gt;

&lt;p&gt;is there any way to motivate a fix for this bug ?&lt;/p&gt;



</comment>
                            <comment id="13846298" author="rhillegas" created="Thu, 12 Dec 2013 13:27:08 +0000"  >&lt;p&gt;Hi Richard,&lt;/p&gt;

&lt;p&gt;Thanks for your detailed description of how this problem affects your production app. I have marked the issue as &quot;Seen in production.&quot; That will boost its urgency slightly. Voting for the issue will boost its urgency too.&lt;/p&gt;

&lt;p&gt;One workaround would be to define a family of table functions and views for each table, one table function/view for each SELECT list. Then use those views in your queries. Unfortunately, that would involve changing the queries in your app.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13847246" author="rhuddusa" created="Fri, 13 Dec 2013 08:08:05 +0000"  >&lt;p&gt;We are trying to work around this issue by calling the function directly instead of the view, but have noticed that it would be much simpler if Derby VTI exposed the function name to the VTI implementation ResultSet .  i don&apos;t believe there currently is a way to access the function name in the VTI ResultSet class. &lt;/p&gt;

&lt;p&gt;We are accessing n different remote data tables, each with its own table definition.  Thus in Derby, we must register n different functions. Note, we only need 1 implementation class of the function to actually get the data and return our custom ResultSet implementation. We&apos;d prefer to NOT write a separate class and redeploy our application each time someone adds a new remote data table, as we have many actually derby instances running this codebase.&lt;/p&gt;

&lt;p&gt;pseudo code / sql&lt;/p&gt;

&lt;p&gt;we have to create register n function definitions in , for i in 1 .. n, where tableName_i is our ith table name, (tableName_i is like customers)&lt;br/&gt;
register derby function selectFromRemote_tableName_i(&apos;tableName_i&apos;)  java method is selectFromRemote.read , &lt;/p&gt;

&lt;p&gt;then to call any specific function we have to write (pseudo sql)&lt;/p&gt;

&lt;p&gt;select s.* from table ( selectFromRemote_customers(&apos;customers&apos;) ) s where custId = 2&lt;/p&gt;

&lt;p&gt;it would be MUCH cleaner if we could just&lt;/p&gt;

&lt;p&gt;register a derby function with different names and no parameters &lt;br/&gt;
so instead of selectFromRemote_customers, we would just register function &quot;customers&quot;&lt;br/&gt;
and derby function customers is java method selectFromRemote.read , &lt;/p&gt;

&lt;p&gt;and then be able to call&lt;br/&gt;
select c.* from table ( customers() ) c where custId = 2&lt;/p&gt;

&lt;p&gt;then our ResultSet implementation could access some variable about the function name, and we would use that in lieu of a function parameters (it would also save us having to declare function params when we register functions, which is tedious )&lt;/p&gt;

&lt;p&gt;i think in the future you may want to add more information about VTI function context, &lt;br/&gt;
would it be logical to add more stuff to VTIEnvironment and make VTIEnvironment available / applicable to all VTI resultsets, not just those that implement VTICosting ?  side question, if we did implement VTICosting , is it guaranteed that its methods will be called ?&lt;/p&gt;

&lt;p&gt;perhaps there should be a new VTIContextAware interface that has something like&lt;br/&gt;
init(VTIContext context)&lt;br/&gt;
that VTIContext for now could have just getFunctionName, but it would be also nice to have things like getFunctionComment so that instead of params to a function, we could also dynamically change a function&apos;s behaviour by altering JUST the comments of a regstered function, and NOT having to change all the queries which call the function and pass arguments.&lt;/p&gt;

&lt;p&gt;because that VTIContext is an interface you could continue to add methods to in the future you expose more information to the function., note it would have been nice if in RestrictedVTI, the initScan method took in an interface object like InitScanParams which had currently getColumnNames and getRestriction, that would probably have allowed this bug to be solved rather easily by just adding &quot;getFunctionName&quot; on that InitScanParams interface. &lt;/p&gt;

&lt;p&gt;Perhaps I should stop just being a writing critic and start writing something myself how easy would it be for me to start hacking up and contributing to the derby project myself ?&lt;/p&gt;</comment>
                            <comment id="13847492" author="rhillegas" created="Fri, 13 Dec 2013 13:55:26 +0000"  >&lt;p&gt;Hi Richard,&lt;/p&gt;

&lt;p&gt;These are all interesting suggestions for improving the api for table functions. I think this discussion deserves its own, separate JIRA.&lt;/p&gt;

&lt;p&gt;I understand your comments about the tedium of declaring table functions. Much of this tedium may be addressed by the optional foreignViews tool introduced in release 10.10.1: &lt;a href=&quot;http://db.apache.org/derby/docs/10.10/tools/rtoolsoptforeignviews.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/docs/10.10/tools/rtoolsoptforeignviews.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you&apos;re interested in contributing to Derby, a good place to start is here: &lt;a href=&quot;http://db.apache.org/derby/derby_comm.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/derby_comm.html&lt;/a&gt;. Once you subscribe to the derby-dev mailing list, the community can guide you through the process.&lt;/p&gt;

&lt;p&gt;Welcome!&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13847533" author="rhuddusa" created="Fri, 13 Dec 2013 14:44:43 +0000"  >&lt;p&gt;unfortunately we cannot use the foreign views / ForeignTableVTI as we are writing our own adapter to greenplum. &lt;/p&gt;

&lt;p&gt;we use derby as a front end to greenplum. we use derby to parse the sql and then we submit the query to the greenplum master and instead of getting a result in the jdbc connection,  we do an ETL write to an external servlet which is running in derby.  ETLs in greenplum are VERY fast and prevent the bandwidth crunch on the master greenplum node.  In the ETL, EACH of our greenplum slaves reaches out individually to the derby instance to post back result sets, and does NOT use any resources on the master. Data gets pushed back to our derby instance at greater than 1 gbit/sec, and our resultset merges the multiple http posts back into a single result.  People love our derby frontend to greenplum, and now are thinking about other systems we should expose through derby. but our system is not as fast as it could be.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12636820">DERBY-6109</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12563958" name="derby-6036-01-aa-testForRestrictionPushing.diff" size="2799" author="rhillegas" created="Wed, 9 Jan 2013 16:54:20 +0000"/>
                            <attachment id="12563576" name="derby-6036.sql" size="1301" author="rhillegas" created="Mon, 7 Jan 2013 15:12:22 +0000"/>
                            <attachment id="12563590" name="derbyAST.xml" size="273011" author="rhillegas" created="Mon, 7 Jan 2013 16:45:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Jun 2013 07:55:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302949</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    <customfieldvalue key="10427"><![CDATA[Workaround attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz11bz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250058</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>