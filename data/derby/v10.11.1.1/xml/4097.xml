<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:29:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4097/DERBY-4097.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4097] &apos;testMixedInsertDelete(org.apache.derbyTesting.functionTests.tests.lang.NullableUniqueConstraintTest)org.apache.derby.client.am.BatchUpdateException&apos;</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4097</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Seen twice....&lt;/p&gt;

&lt;p&gt;See &lt;br/&gt;
&lt;a href=&quot;http://dbtg.thresher.com/derby/test/trunk15/jvm1.5/testing/testlog/SunOS-5.9_sun4u-sparc/754716-org.apache.derbyTesting.functionTests.suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/trunk15/jvm1.5/testing/testlog/SunOS-5.9_sun4u-sparc/754716-org.apache.derbyTesting.functionTests.suites.All_diff.txt&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://dbtg.thresher.com/derby/test/trunk15/jvm1.5/testing/testlog/SunOS-5.10_i86pc-i386/753342-org.apache.derbyTesting.functionTests.suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/trunk15/jvm1.5/testing/testlog/SunOS-5.10_i86pc-i386/753342-org.apache.derbyTesting.functionTests.suites.All_diff.txt&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;1) testMixedInsertDelete(org.apache.derbyTesting.functionTests.tests.lang.NullableUniqueConstraintTest)org.apache.derby.client.am.BatchUpdateException: Non-atomic batch failure.  The batch was submitted, but at least one exception occurred on an individual member of the batch. Use getNextException() to retrieve the exceptions for specific batched elements.&lt;br/&gt;
	at org.apache.derby.client.am.Agent.endBatchedReadChain(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeBatchRequestX(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeBatchX(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeBatch(Unknown Source)&lt;br/&gt;
	at org.apache.derbyTesting.functionTests.tests.lang.NullableUniqueConstraintTest.testMixedInsertDelete(NullableUniqueConstraintTest.java:481)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:105)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)&lt;br/&gt;
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)&lt;br/&gt;
	at junit.extensions.TestSetup.run(TestSetup.java:25)&lt;br/&gt;
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)&lt;/p&gt;</description>
                <environment>OS: &lt;br/&gt;
Solaris 9 9/04 s9s_u7wos_09 SPARC 64bits &lt;br/&gt;
SunOS 5.9 Generic_118558-11&lt;br/&gt;
JVM: &lt;br/&gt;
Sun Microsystems Inc.&lt;br/&gt;
java version &amp;quot;1.5.0_14&amp;quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_14-b03)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.5.0_14-b03, mixed mode)&lt;br/&gt;
&lt;br/&gt;
OS:&lt;br/&gt;
Solaris 10 5/08 s10x_u5wos_10 X86 64bits&lt;br/&gt;
SunOS 5.10 Generic_127128-11&lt;br/&gt;
JVM:&lt;br/&gt;
Sun Microsystems Inc.&lt;br/&gt;
java version &amp;quot;1.5.0_14&amp;quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_14-b03)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.5.0_14-b03, mixed mode)&lt;br/&gt;
</environment>
        <key id="12416964">DERBY-4097</key>
            <summary>&apos;testMixedInsertDelete(org.apache.derbyTesting.functionTests.tests.lang.NullableUniqueConstraintTest)org.apache.derby.client.am.BatchUpdateException&apos;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="olesolberg">Ole Solberg</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Mar 2009 12:02:57 +0000</created>
                <updated>Thu, 16 Jul 2009 22:24:28 +0100</updated>
                            <resolved>Wed, 22 Apr 2009 12:55:03 +0100</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.2.0</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Store</component>
                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12682366" author="knutanders" created="Mon, 16 Mar 2009 16:50:52 +0000"  >&lt;p&gt;The use of batch update in this test makes it difficult to see what the real error is, since one needs to call getNextException() on the BatchUpdateException. There&apos;s no real need for batch update in the failing test case. I wrote it, and I think I used batch update because I was struggling with some networking issues at that time (high latency on local connections) so that batch update was much faster.&lt;/p&gt;

&lt;p&gt;Removing the use of batch update is one alternative to expose the real error. However, that will change the timing and may hide this failure if it is timing-sensitive. Another alternative is to add a wrapper around executeBatch() and call getException() in the test. I have also noticed that in embedded mode, the underlying exception is available with getCause() and is therefore reported by JUnit, whereas the client driver (where we see this problem now) does not do that. So a third option is to make the client driver report these errors the same way as the embedded driver.&lt;/p&gt;</comment>
                            <comment id="12682380" author="bryanpendleton" created="Mon, 16 Mar 2009 17:17:25 +0000"  >&lt;p&gt;Good insight on the getCause() interaction with JUnit &amp;#8211; it would be great if there was&lt;br/&gt;
something simple we could do to make the client exceptions more automatically visible&lt;br/&gt;
to generic software such as JUnit that knows how to unwind getCause but doesn&apos;t&lt;br/&gt;
know about the DBMS-specific exception chaining techniques.&lt;/p&gt;</comment>
                            <comment id="12682477" author="knutanders" created="Mon, 16 Mar 2009 21:43:12 +0000"  >&lt;p&gt;Here&apos;s a patch that makes the client driver use initCause() on BatchUpdateExceptions, like the embedded driver already does. It also adds a test case which checks that the output from printStackTrace() on a BUE contains the string &quot;duplicate key&quot; if the batch job caused a violation of a unique constraint (without the patch, the test passed with embedded and failed with the client driver). No other tests have been run yet.&lt;/p&gt;</comment>
                            <comment id="12682593" author="knutanders" created="Tue, 17 Mar 2009 08:30:26 +0000"  >&lt;p&gt;All tests ran cleanly with the patch. Committed revision 755147. So now we just have to wait until the failure happens again and see what the underlying exception is.&lt;/p&gt;

&lt;p&gt;I&apos;m planning to backport this change to 10.5 since it improves the error reporting and has very low risk.&lt;/p&gt;</comment>
                            <comment id="12682605" author="knutanders" created="Tue, 17 Mar 2009 09:05:30 +0000"  >&lt;p&gt;Committed the improved error reporting to 10.5 with revision 755156.&lt;/p&gt;</comment>
                            <comment id="12683190" author="knutanders" created="Wed, 18 Mar 2009 21:50:50 +0000"  >&lt;p&gt;More detailed stack trace is available here:&lt;br/&gt;
&lt;a href=&quot;http://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/755167-org.apache.derbyTesting.functionTests.suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/755167-org.apache.derbyTesting.functionTests.suites.All_diff.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.derby.client.am.SqlException: Error for batch element #67: Java exception: &apos;org.apache.derby.impl.store.access.btree.WaitError: &apos;.&lt;br/&gt;
	at org.apache.derby.client.am.Statement.completeExecute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatementReply.readExecute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.StatementReply.readExecute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetPreparedStatement.readExecute_(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.readExecute(Unknown Source)&lt;br/&gt;
	... 44 more&lt;/p&gt;

&lt;p&gt;The WaitError is probably thrown by BTreeController.comparePreviousRecord() when it tries to walk backwards in the B-tree and cannot latch the left sibling page without waiting (probably because post commit work is done on that page by a different thread simultaneously). This is an intended feature of the current implementation, I think.&lt;/p&gt;

&lt;p&gt;There are a couple of alternatives:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;comparePreviousRecord() could release its latches and return RESCAN_REQUIRED when it detects a WaitError&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;A reimplementation of the nullable unique constraint insert code has been suggested &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and it would probably fix this issue. Then the test would fail intermittently for a while, but it may be possible to rewrite the test to prevent it. (I think we could turn off auto-commit and run the test in one transaction. Then there won&apos;t be post-commit work done in parallel with the execution of the test, and I think it will still expose the bug that it was supposed to expose, but I would have to test that to be sure.)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &amp;lt;URL:&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200903.mbox/%3C49AEBA96.5010609@sbcglobal.net%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200903.mbox/%3C49AEBA96.5010609@sbcglobal.net%3E&lt;/a&gt;&amp;gt; &lt;/p&gt;</comment>
                            <comment id="12700148" author="knutanders" created="Fri, 17 Apr 2009 13:10:02 +0100"  >&lt;p&gt;&amp;gt; I think we could turn off auto-commit and run the test in one&lt;br/&gt;
&amp;gt; transaction. Then there won&apos;t be post-commit work done in parallel&lt;br/&gt;
&amp;gt; with the execution of the test, and I think it will still expose the&lt;br/&gt;
&amp;gt; bug that it was supposed to expose, but I would have to test that to&lt;br/&gt;
&amp;gt; be sure.&lt;/p&gt;

&lt;p&gt;I commented out the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4027&quot; title=&quot;An attempt was made to access an out of range slot on a page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4027&quot;&gt;&lt;del&gt;DERBY-4027&lt;/del&gt;&lt;/a&gt; and turned off auto-commit in&lt;br/&gt;
the test and didn&apos;t see a failure, so if we turn off auto-commit the&lt;br/&gt;
test will no longer expose the bug that it&apos;s supposed to expose.&lt;/p&gt;</comment>
                            <comment id="12700150" author="knutanders" created="Fri, 17 Apr 2009 13:15:18 +0100"  >&lt;p&gt;Increasing the number of iterations in testMixedInsertDelete() from 10 to 100 reliably reproduces the WaitError both with in embedded and client/server in my environment.&lt;/p&gt;</comment>
                            <comment id="12700163" author="knutanders" created="Fri, 17 Apr 2009 13:53:43 +0100"  >&lt;p&gt;The attached patch d4097-1a-rescanOnWaitError.diff increases the number of iterations in the test case to more reliably reproduce the WaitError, and it modifies BTreeController.comparePreviousRecord() so that it releases all latches and returns RESCAN_REQUIRED when a WaitError is detected. This is not an ideal solution, as the thread that gets the WaitError may need many tries before it manages to latch the left sibling, and it will be constantly spending CPU until it manages to acquire the latch. Anyways, it should not happen very frequently, and I think a spin-wait loop is better than failing in this situation. (This is yet another reason to rewrite the nullable unique insert code as suggested by Mike in the thread mentioned in an earlier comment.)&lt;/p&gt;

&lt;p&gt;NullableUniqueConstraintTest passed with this patch. Will start the rest of the regression test suite now.&lt;/p&gt;</comment>
                            <comment id="12700336" author="knutanders" created="Fri, 17 Apr 2009 22:31:51 +0100"  >&lt;p&gt;Derbyall and suites.All ran cleanly. The patch is ready for review.&lt;/p&gt;</comment>
                            <comment id="12701155" author="knutanders" created="Tue, 21 Apr 2009 14:45:05 +0100"  >&lt;p&gt;Committed to trunk with revision 767143.&lt;/p&gt;

&lt;p&gt;I guess this fix should be backported to 10.5, since it was seen a couple of times during release testing, and possibly also to 10.4, so I&apos;m leaving the issue open.&lt;/p&gt;</comment>
                            <comment id="12701497" author="knutanders" created="Wed, 22 Apr 2009 12:55:02 +0100"  >&lt;p&gt;Committed to 10.5 with revision 767475.&lt;/p&gt;</comment>
                            <comment id="12701857" author="knutanders" created="Thu, 23 Apr 2009 10:03:11 +0100"  >&lt;p&gt;Committed to 10.4 with revision 767861.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12402318" name="batchexception.diff" size="4006" author="knutanders" created="Mon, 16 Mar 2009 21:43:12 +0000"/>
                            <attachment id="12405761" name="d4097-1a-rescanOnWaitError.diff" size="2581" author="knutanders" created="Fri, 17 Apr 2009 13:53:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 16 Mar 2009 16:50:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24022</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0s2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38365</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>