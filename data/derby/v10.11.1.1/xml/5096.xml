<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:18:04 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5096/DERBY-5096.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5096] DisconnectException: &quot;Connection was refused because the database DB was not found&quot; when creating db for first time</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5096</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A process starts derby as network server (new NetworkServerControl, start) and waits for derby to respond (retry ping until success). After the server has started, the same process makes a connection with DriverManager.getConnection().&lt;/p&gt;

&lt;p&gt;The first time this process runs, this will always fail with  &quot;SQLNonTransientConnectionException: The connection was refused because the database Flows;create=true was not found.&quot; However, at the same time, &quot;derby.log&quot; and &quot;Flows&quot; directory are created in the derby home. The &quot;Flows&quot; directory contains &quot;log&quot;, &quot;seg0&quot;, &quot;tmp&quot;, &quot;db.lck&quot;, &quot;service.properties&quot;, etc ...&lt;/p&gt;

&lt;p&gt;The second time the process is started, the connection will succeed and the &quot;Flows&quot; database can be used successfully. From now on, every start will be successful. After cleaning the derby home directory, you get the exception again after the first start.&lt;/p&gt;

&lt;p&gt;The attachment contains a Java program (DerbyGetConnection.java) that reproduces this problem consistently on our OS/400 V7R1M0 with IBM J9 VM. Probably this may happen on other systems too (Win7), but we were unable to reproduce it there (on my machine with Win7, this same program ran successful every run; might be a threading or I/O issue that occurs easily on slower hardware?).&lt;br/&gt;
The attachment contains also derby tracing (&quot;derby.drda.traceAll&quot;) and logging/tracing of the DriverManager.&lt;/p&gt;</description>
                <environment>System: OS/400 V7R1M0 on PowerPC; JVM: IBM J9 VM 2.4 (consistently reproducible). &lt;br/&gt;
But also: Windows 2008 R2 on VMWare and Windows 7 64 bit with Sun VM (1.6) too (but not as consistently reproducible)</environment>
        <key id="12500641">DERBY-5096</key>
            <summary>DisconnectException: &quot;Connection was refused because the database DB was not found&quot; when creating db for first time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="stevenhendrickx">Steven Hendrickx</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Mar 2011 15:06:37 +0000</created>
                <updated>Fri, 15 Nov 2013 08:15:15 +0000</updated>
                            <resolved>Wed, 21 Dec 2011 16:59:17 +0000</resolved>
                                    <version>10.7.1.1</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13003380" author="stevenhendrickx" created="Mon, 7 Mar 2011 15:07:54 +0000"  >&lt;p&gt;ZIP containing&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DerbyGetConnection.java to reproduce problem&lt;/li&gt;
	&lt;li&gt;Derby tracing&lt;/li&gt;
	&lt;li&gt;JDBC/DriverManager trace&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13003383" author="stevenhendrickx" created="Mon, 7 Mar 2011 15:09:57 +0000"  >&lt;p&gt;Mind, since this is a SQLNonTransientConnectionException, we cannot retry to create the connection.&lt;/p&gt;</comment>
                            <comment id="13004877" author="kmarsden" created="Wed, 9 Mar 2011 23:40:30 +0000"  >&lt;p&gt;Hi Steven,&lt;/p&gt;

&lt;p&gt;On iseries I believe there is a java bug with getCanonicalPath() that can cause  this problem. If you run the attached program TestLowerCaseTraversal.java on iseries,  I think you will see that getCanonical path is not properly resolving the case in the parent directories &lt;/p&gt;

&lt;p&gt;$ java TestLowerCaseTraversal &lt;br/&gt;
mkdirs to create dir with mixedcase string: test/NDee = true&lt;br/&gt;
Original string: test/ndee/subdir&lt;br/&gt;
cannonical path before mkdirs(), should be mixed case as that&apos;s what&apos;s on the machine: /home/MYRNA/tst/test/b11740/try4/test/ndee/subdir  &amp;lt;&amp;lt;== Should be NDee!&lt;br/&gt;
created the subdir? true&lt;br/&gt;
cannonical path after  mkdirs(): /home/MYRNA/tst/test/b11740/try4/test/NDee/subdir&lt;/p&gt;

&lt;p&gt;On Windows XP, I see the case properly resolved:&lt;/p&gt;

&lt;p&gt;mkdirs to create dir with mixedcase string: test/NDee = true&lt;br/&gt;
Original string: test/ndee/subdir&lt;br/&gt;
cannonical path before mkdirs(), should be mixed case as that&apos;s what&apos;s on the ma&lt;br/&gt;
chine: C:\cygwin\home\kmarsden\repro\11740\test\NDee\subdir&lt;br/&gt;
created the subdir? true&lt;br/&gt;
cannonical path after  mkdirs(): C:\cygwin\home\kmarsden\repro\11740\test\NDee\s&lt;br/&gt;
ubdir&lt;/p&gt;

&lt;p&gt;The workaround on iseries is to use the matching case for  the  path of the database. &lt;/p&gt;

&lt;p&gt;Another situation where there is a problem with getCanonicalPath() on iseries that can cause this symptom is if there are multi-byte characters in the database name. (See &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4149&quot; title=&quot;test failure in jdbcapi.InternationalConnectSimpleDSTest fixture  testSimpleDSConnect on IBM iseries - Database &amp;#39;?&amp;#39; not found.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4149&quot;&gt;&lt;del&gt;DERBY-4149&lt;/del&gt;&lt;/a&gt;). I don&apos;t know a good work around for that one.&lt;/p&gt;

&lt;p&gt;I cannot speak to the vmware issues, but wonder if there is a casing or getCanonicalPath issue there too.&lt;/p&gt;
</comment>
                            <comment id="13004879" author="kmarsden" created="Wed, 9 Mar 2011 23:47:35 +0000"  >&lt;p&gt;linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4149&quot; title=&quot;test failure in jdbcapi.InternationalConnectSimpleDSTest fixture  testSimpleDSConnect on IBM iseries - Database &amp;#39;?&amp;#39; not found.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4149&quot;&gt;&lt;del&gt;DERBY-4149&lt;/del&gt;&lt;/a&gt; as both are database not found that can be due to getCanonicalPath() problems.&lt;/p&gt;
</comment>
                            <comment id="13005568" author="stevenhendrickx" created="Fri, 11 Mar 2011 09:47:19 +0000"  >&lt;p&gt;Kathey, you are correct: Basically our code does something like: &lt;/p&gt;

&lt;p&gt;new File(System.getProperty(&quot;user.home&quot;), &quot;productsubdir&quot;); &lt;/p&gt;

&lt;p&gt;On the OS/400 system, System.getProperty(&quot;user.home&quot;)  returned &quot;/home/SHENDRIC&quot; for me, while this should be &quot;/home/shendric&quot; (ls in qsh or qp2term). This seems the root of all evil. When the code is changed to:&lt;/p&gt;

&lt;p&gt;new File(new File(System.getProperty(&quot;user.home&quot;)).getCanonicalFile, &quot;productsubdir&quot;);&lt;/p&gt;

&lt;p&gt;the exception no longer occurs. Although this change seems to solve our problem, is there any plan to update Derby to anticipate this problem from within Derby itself?&lt;/p&gt;

&lt;p&gt;Anyway, thanks for the fast feed back and the great help.&lt;/p&gt;


</comment>
                            <comment id="13005719" author="kmarsden" created="Fri, 11 Mar 2011 17:02:43 +0000"  >&lt;p&gt;It would be great to  see a fix in the JVM&apos;s  with the problem , so I think it would be  worthwhile to report  that you have hit the  problem to the various JVM support organizations if you have support.  &lt;/p&gt;

&lt;p&gt;   I haven&apos;t looked into a possible workaround in Derby, but since it seems to affect not only OS/400 but also other platforms running on VMWare, it seems like it would be worthwhile to look into working around the problem in DERBY if possible.  If you would like to work on that, I am sure members of the community can point you to the code area in question.&lt;/p&gt;</comment>
                            <comment id="13016589" author="myrna" created="Wed, 6 Apr 2011 23:36:24 +0100"  >&lt;p&gt;I&apos;m marking this as invalid as it&apos;s not really a problem in derby, the problem is in the jvm on iseries.&lt;br/&gt;
If someone wants to implement a workaround within the derby code, they can reopen at that time.&lt;/p&gt;</comment>
                            <comment id="13093922" author="kmarsden" created="Tue, 30 Aug 2011 18:28:23 +0100"  >
&lt;p&gt;Looking again at this issue, I think it is actually a usage issue, external to Derby and to getCanonicalPath.&lt;br/&gt;
Here the user is using the System Property  &quot;user.home&quot;)  which has CAPS &lt;br/&gt;
/home/SHENDRIC where the actual directory does not.&lt;/p&gt;

&lt;p&gt;When the user called getCanonicalPath() on user home, e.g.&lt;/p&gt;

&lt;p&gt;, new File(new File(System.getProperty(&quot;user.home&quot;)).getCanonicalFile, &quot;productsubdir&quot;); &lt;/p&gt;

&lt;p&gt;getCanonicalPath actually corrected the casing properly.  I wonder if passed the whole string, if getCanonicalPath would resolve the whole thing properly.&lt;/p&gt;

&lt;p&gt;Also I would like to look at the actual exception and see what call is actually failing with the uppercase path and whether that should fail on iseries which generally ignores case.&lt;/p&gt;</comment>
                            <comment id="13151395" author="kmarsden" created="Wed, 16 Nov 2011 18:18:57 +0000"  >&lt;p&gt;I am going to see if we can find an  internal workaround for this issue in Derby as it can be confusing to users.&lt;/p&gt;</comment>
                            <comment id="13154717" author="kmarsden" created="Mon, 21 Nov 2011 23:13:22 +0000"  >&lt;p&gt;I can get past the database creation issue if I change StroageFactoryService.createServiceRoot() to get the canonical path with:&lt;/p&gt;

&lt;p&gt;return serviceDirectory.getCanonicalPath();&lt;br/&gt;
rather than&lt;br/&gt;
return storageFactory.getCanonicalName();&lt;/p&gt;

&lt;p&gt;The real problem is that DirStorageFactory.java holds a canonicalName value which is cached from the very first call to getCanonicalPath() in its doInit() method which occurs before the directory is created,  so has the wrong casing on iSeries.   I think probably the best comprehensive solution would be to only cache that value once we have a call to getCanonicalName when the directory exists.&lt;/p&gt;

</comment>
                            <comment id="13156274" author="kmarsden" created="Wed, 23 Nov 2011 20:56:33 +0000"  >&lt;p&gt;Here is a patch for this issue.  It adjusts the canonicalName after mkdirs() if it does not match getCanonicalPath().&lt;/p&gt;

&lt;p&gt;I had considered have a fix in DirStorageFactory which would upon getting the canonicalPath search back and ensure the correct casing for the directories that existed, but opted for the other approach as it should not exist in situations where there is not a casing issue.&lt;/p&gt;</comment>
                            <comment id="13159254" author="knutanders" created="Tue, 29 Nov 2011 13:27:26 +0000"  >&lt;p&gt;+                                String serviceDirCanonicalPath = serviceDirectory.getCanonicalPath();&lt;br/&gt;
+                                if (storageFactory.getCanonicalName() != serviceDirCanonicalPath) &lt;/p&gt;
{
+                                    storageFactory.setCanonicalName(serviceDirCanonicalPath);
+                                }

&lt;p&gt;I suppose we should have used the equals() method to compare the strings here. Or maybe just set the canonical name unconditionally (advantages: less code, and the new code path will also be tested on non-iSeries machines).&lt;/p&gt;</comment>
                            <comment id="13160264" author="kmarsden" created="Wed, 30 Nov 2011 19:26:23 +0000"  >&lt;p&gt;Thank you Knut. That is a good idea to make it unconditional as I recall one user reporting they also saw this intermittently on Windows vmware.  This way the code path will be fully tested.&lt;/p&gt;

&lt;p&gt;attaching derby-5096_uncondset_diff.txt to do that.&lt;/p&gt;</comment>
                            <comment id="13164468" author="kmarsden" created="Wed, 7 Dec 2011 16:02:15 +0000"  >&lt;p&gt; This is now checked into the 10.8 branch,10.7, and 10.5 as well..  Not closing as still need verification of the fix and to check into 10.6 and maybe go back even further.&lt;/p&gt;</comment>
                            <comment id="13174210" author="kmarsden" created="Wed, 21 Dec 2011 16:59:17 +0000"  >&lt;p&gt;ported fix back to all branches through 10.5. The 10.6 fix doesn&apos;t show up on subversion commits, but was checked in with revision 1212214&lt;/p&gt;</comment>
                            <comment id="13823436" author="knutanders" created="Fri, 15 Nov 2013 08:15:15 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update: close all resolved issues that haven&amp;#39;t had any activity the last year&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12422162">DERBY-4149</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12473218" name="TestLowerCaseTraversal.java" size="2159" author="kmarsden" created="Wed, 9 Mar 2011 23:40:30 +0000"/>
                            <attachment id="12504925" name="derby-5096_diff.txt" size="4175" author="kmarsden" created="Wed, 23 Nov 2011 20:56:33 +0000"/>
                            <attachment id="12505650" name="derby-5096_uncondset_diff.txt" size="1592" author="kmarsden" created="Wed, 30 Nov 2011 19:26:23 +0000"/>
                            <attachment id="12472822" name="getconnection_reproduce.zip" size="7073" author="stevenhendrickx" created="Mon, 7 Mar 2011 15:07:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 9 Mar 2011 23:40:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24642</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ecv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36144</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>