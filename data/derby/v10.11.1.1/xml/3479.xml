<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:24:41 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3479/DERBY-3479.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3479] Changed/unexpected query plan when running test &apos;lang/predicatePushdown.sql&apos;</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3479</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Seen in tinderbox since r631930.&lt;/p&gt;

&lt;p&gt;See e.g. &lt;a href=&quot;http://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/631932-derbyall_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/631932-derbyall_diff.txt&lt;/a&gt; :&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Start: predicatePushdown jdk1.6.0_04 derbyall:derbylang 2008-02-28 14:02:49 ***&lt;br/&gt;
9285 del&lt;br/&gt;
&amp;lt; 		Rows seen from the left = 20&lt;br/&gt;
9285a9285&lt;br/&gt;
&amp;gt; 		Rows seen from the left = 10&lt;br/&gt;
9297 del&lt;br/&gt;
&amp;lt; 			Rows seen from the right = 20&lt;br/&gt;
9297a9297&lt;br/&gt;
&amp;gt; 			Rows seen from the right = 10&lt;br/&gt;
9299 del&lt;br/&gt;
&amp;lt; 			Rows returned = 20&lt;br/&gt;
9299a9299&lt;br/&gt;
&amp;gt; 			Rows returned = 10&lt;br/&gt;
.&lt;br/&gt;
.&lt;br/&gt;
.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>OS: Solaris 10 6/06 s10x_u2wos_09a X86 64bits - SunOS 5.10 Generic_118855-14&lt;br/&gt;
JVM: Sun Microsystems Inc., java version &amp;quot;1.6.0_04&amp;quot;, Java(TM) SE Runtime Environment (build 1.6.0_04-b12), Java HotSpot(TM) Client VM (build 10.0-b19, mixed mode)&lt;br/&gt;
</environment>
        <key id="12389818">DERBY-3479</key>
            <summary>Changed/unexpected query plan when running test &apos;lang/predicatePushdown.sql&apos;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="olesolberg">Ole Solberg</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Feb 2008 20:06:18 +0000</created>
                <updated>Mon, 29 Jun 2009 23:58:07 +0100</updated>
                            <resolved>Thu, 6 Mar 2008 22:50:55 +0000</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12573767" author="olesolberg" created="Fri, 29 Feb 2008 14:42:49 +0000"  >&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/Re%3A-failures-in-org.apache.derbyTesting.functionTests.tests.lang.LangScripts-p15759641.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Re%3A-failures-in-org.apache.derbyTesting.functionTests.tests.lang.LangScripts-p15759641.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12574917" author="knutanders" created="Tue, 4 Mar 2008 10:26:52 +0000"  >&lt;p&gt;I also see this failure in my sandbox, but only intermittently. The predicatePushdown test is known to be unstable due to varying query plans (see for instance &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1902&quot; title=&quot;Intermittent failures in predicatePushdown.sql&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1902&quot;&gt;&lt;del&gt;DERBY-1902&lt;/del&gt;&lt;/a&gt;). Unless someone can tell that one of the query plans is wrong, I think we should regard it as a test issue, not as a product defect. Rewriting the unstable parts of the test in JUnit and only check the relevant parts of the query plan (that is, whether or not the predicates are pushed down) sounds like a reasonable approach to me.&lt;/p&gt;</comment>
                            <comment id="12575050" author="army" created="Tue, 4 Mar 2008 16:54:45 +0000"  >&lt;p&gt;&amp;gt; The predicatePushdown test is known to be unstable due to varying query plans&lt;/p&gt;

&lt;p&gt;True, though I don&apos;t think this particular difference has ever shown up before?  Usually the diffs are rather large, but this one is relatively small--the join order of two tables for a single query has been switched, and that&apos;s it.&lt;/p&gt;

&lt;p&gt;&amp;gt; Rewriting the unstable parts of the test in JUnit and only check the relevant parts&lt;br/&gt;
&amp;gt; of the query plan sounds like a reasonable approach to me.&lt;/p&gt;

&lt;p&gt;I agree.  Probably not a trivial task, but one worth doing if anyone is so inclined.&lt;/p&gt;

&lt;p&gt;The question of &lt;b&gt;why&lt;/b&gt; we intermittently get different plans even though the &quot;noTimeout&quot; property is set to true remains a mystery.  And in particular, how does the buffer manager come into play for optimizer path decisions?  But that&apos;s probably a separate issue; fixing the predicatePushdown test by converting it to JUnit seems like a good move regardless.&lt;/p&gt;</comment>
                            <comment id="12575373" author="knutanders" created="Wed, 5 Mar 2008 14:47:15 +0000"  >&lt;p&gt;I noticed that other tests that depend on stable query plans (wisconsin and StalePlansTest) set derby.storage.checkpointInterval=100000. I tried to add this property to predicatePushdown_derby.properties, and that seemed to stabilize the test.&lt;/p&gt;

&lt;p&gt;StalePlansTest contains some magic to flush the row count for the tables. I don&apos;t understand exactly what it does, in particular I don&apos;t understand why &quot;select count(c1) from flusher&quot; is needed to make the row count for other tables than flusher visible. Perhaps changing the concurrency/timing in the buffer manager somehow changes when the row count is flushed, and thereby it makes the optimizer choose a different plan?&lt;/p&gt;</comment>
                            <comment id="12575441" author="army" created="Wed, 5 Mar 2008 18:05:46 +0000"  >&lt;p&gt;&amp;gt; I noticed that other tests that depend on stable query plans (wisconsin and StalePlansTest)&lt;br/&gt;
&amp;gt; set derby.storage.checkpointInterval=100000.&lt;/p&gt;

&lt;p&gt;This is an interesting observation.  When I read it I assumed that this number was greater than the default and that by setting it we were avoiding checkpoints.  But it turns out that the opposite is true: the default checkpoint interval is 10*1024*1024, while 100000 is the &lt;b&gt;minimum&lt;/b&gt; checkpoint interval allowed (see raw/LogToFile.java).  With the default interval we will not do any checkpoints during the running of predicatePushdown.sql; but with the minimum interval of 100000, we do THREE checkpoints (at least on my machine).&lt;/p&gt;

&lt;p&gt;So I wonder if the checkpoint does something which updates the row counts and/or statistics for the tables, thus affecting the optimizer&apos;s decisions?  I have no idea what the answer to that might be...&lt;/p&gt;

&lt;p&gt;&amp;gt; Perhaps changing the concurrency/timing in the buffer manager somehow changes when&lt;br/&gt;
&amp;gt; the row count is flushed&lt;/p&gt;

&lt;p&gt;While scanning LogToFile.java for the default checkpoint interval, I noticed the following:&lt;/p&gt;

&lt;p&gt;        /////////////////////////////////////////////////////////////&lt;br/&gt;
        // setup checkpoint daemon and cache cleaner&lt;br/&gt;
        /////////////////////////////////////////////////////////////&lt;br/&gt;
        checkpointDaemon = rawStoreFactory.getDaemon();&lt;br/&gt;
        if (checkpointDaemon != null)&lt;/p&gt;
        {
            myClientNumber =
                checkpointDaemon.subscribe(this, true /*onDemandOnly */);

            // use the same daemon for the cache cleaner
            dataFactory.setupCacheCleaner(checkpointDaemon);
        }

&lt;p&gt;Note how the &lt;b&gt;same&lt;/b&gt; daemon service is used for checkpointing and for cleaning the cache.  The call to &quot;setupCacheCleaner&quot; ultimately ends up at CacheManager.java, which was modified by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2911&quot; title=&quot;Implement a buffer manager using java.util.concurrent classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2911&quot;&gt;&lt;del&gt;DERBY-2911&lt;/del&gt;&lt;/a&gt;.  So I wonder if this daemon &quot;sharing&quot; could explain a) why a different cache manager has an effect on predicatePushdown.sql, and/or b) why changing the checkpoint interval seems to alleviate the effect?&lt;/p&gt;

&lt;p&gt;Not sure if that&apos;s useful info or not, as I&apos;m completely out of my knowledge base here.  But I thought I&apos;d mention it.&lt;/p&gt;

&lt;p&gt;In the meantime, do you think it would be worth it set checkpointInterval to 100000 to see if that gets predicatePushdown passing in the tinderbox again?&lt;/p&gt;</comment>
                            <comment id="12575456" author="army" created="Wed, 5 Mar 2008 18:51:39 +0000"  >&lt;p&gt;Some feedback from Mike:&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/56229&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/56229&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12575465" author="army" created="Wed, 5 Mar 2008 19:15:44 +0000"  >&lt;p&gt;Per Mike&apos;s suggestion in the above email, namely:&lt;/p&gt;

&lt;p&gt;&quot;solutions include &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; call compress table on all tables before query which will update all statistics and remove dependency on any outstanding per page row count updates&quot;&lt;/p&gt;

&lt;p&gt;I updated predicatePushdown.sql to compress all test tables before running any of the queries which expect a specific query plan.  When I did that a lot of diffs showed up for predicatePushdown.out in the form of:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Number of pages visited=1&lt;br/&gt;
  + Number of pages visited=2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I.e. seems we now visit one more page than we did without the compress.  That seems a tad counter-intuitive to me (I figured compression would make it so that we visited fewer pages), but given my lack of knowledge here I&apos;m assuming that&apos;s an okay diff.&lt;/p&gt;

&lt;p&gt;With this change I ran predicatePushdown.sql 10 times using ibm15 and it passed every time.  I&apos;m not sure how useful that is, though, since this same machine ran 6 times in a row without failing even without this change...&lt;/p&gt;

&lt;p&gt;Nonetheless, I&apos;m posting the change as d3479_1.diff in case anyone has comments.  I&apos;ll probably commit the patch sometime pretty soon since, even if it doesn&apos;t resolve this particular issue, it sounds like it&apos;s a good idea to compress the tables anyway (per Mike&apos;s email)...&lt;/p&gt;</comment>
                            <comment id="12575474" author="knutanders" created="Wed, 5 Mar 2008 19:45:53 +0000"  >&lt;p&gt;The buffer manager from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2911&quot; title=&quot;Implement a buffer manager using java.util.concurrent classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2911&quot;&gt;&lt;del&gt;DERBY-2911&lt;/del&gt;&lt;/a&gt; delegates more of the page cleaning to the background thread. This could perhaps explain why the row count statistics are different. Where the old buffer manager cleans a page synchronously in the user thread and thereby updates the statistics, the new buffer manager may have given the page to the background thread and therefore doesn&apos;t update the statistics until a moment later.&lt;/p&gt;

&lt;p&gt;Compressing the tables sounds like a good idea, but it does indeed look strange with the extra page. Aren&apos;t all of these tables so small that they should fit on a single page?&lt;/p&gt;</comment>
                            <comment id="12575514" author="army" created="Wed, 5 Mar 2008 22:31:15 +0000"  >&lt;p&gt;Thanks for the insight, Knut.  I don&apos;t know much about how it all works, but your theory seems reasonable to me...for what very little that may be worth.&lt;/p&gt;

&lt;p&gt;&amp;gt; Aren&apos;t all of these tables so small that they should fit on a single page?&lt;/p&gt;

&lt;p&gt;I would think so, at least for the first part of the test.  I have no idea why that&apos;s not the case--nor why compression appears to lead to an &lt;b&gt;extra&lt;/b&gt; page...&lt;/p&gt;

&lt;p&gt;I went ahead and committed d3479_1.diff with svn # 634064:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=634064&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=634064&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If it turns out the extra page is undesirable and/or the change is not a good one, then the commit can always be backed out.&lt;/p&gt;</comment>
                            <comment id="12575619" author="knutanders" created="Thu, 6 Mar 2008 09:07:39 +0000"  >&lt;p&gt;Thanks Army! Compressing the tables seems to have fixed the problem. I&apos;ve run the test more than 20 times without seeing the failure (before I would see it perhaps 50% of the times).&lt;/p&gt;</comment>
                            <comment id="12575939" author="army" created="Thu, 6 Mar 2008 22:50:55 +0000"  >&lt;p&gt;&amp;gt; Compressing the tables seems to have fixed the problem.  I&apos;ve run the test more&lt;br/&gt;
&amp;gt; than 20 times without seeing the failure.&lt;/p&gt;

&lt;p&gt;Great, thanks for testing it out, Knut Anders.  Based on that feedback, along with the fact that a) the test has not failed in the past several tinderbox runs, and b) it appears the extra page after compression is &quot;odd&quot; but explainable&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, I&apos;m marking this as resolved.  Please feel to re-open if the diff shows up again...&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/56253&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/56253&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12352048">DERBY-1902</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12373154">DERBY-2911</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12377189" name="d3479_1.diff" size="39086" author="army" created="Wed, 5 Mar 2008 19:15:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 4 Mar 2008 10:26:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23660</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0vfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38910</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>