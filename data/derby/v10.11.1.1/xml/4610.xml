<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:19:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4610/DERBY-4610.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4610] Error attempting delete with cascade and triggers</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4610</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The scenario is a parent and child table with a cascade delete and triggers on both tables.  Here are the steps to reproduce.&lt;/p&gt;

&lt;p&gt;First, compile TestFunctions.java and put it on the classpath:&lt;/p&gt;

&lt;p&gt;public class TestFunctions&lt;br/&gt;
{&lt;br/&gt;
   public static void test(String str)&lt;br/&gt;
   {&lt;br/&gt;
   }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Next, enter commands into interactive SQL:&lt;/p&gt;

&lt;p&gt;create table testtable (id integer, name varchar(20), primary key(id));&lt;/p&gt;

&lt;p&gt;create table testchild (&lt;br/&gt;
id integer&lt;br/&gt;
constraint fk_id references testtable on delete cascade,&lt;br/&gt;
ordernum int,&lt;br/&gt;
primary key(id));&lt;/p&gt;

&lt;p&gt;create procedure testproc (str varchar(20))&lt;br/&gt;
PARAMETER STYLE JAVA LANGUAGE JAVA EXTERNAL NAME &apos;TestFunctions.test&apos;;&lt;/p&gt;

&lt;p&gt;create trigger testtabletrigger after delete on testtable referencing old as old&lt;br/&gt;
for each row mode db2sql call testproc(char(old.id));&lt;/p&gt;

&lt;p&gt;create trigger testchildtrigger after delete on testchild referencing old as old&lt;br/&gt;
for each row mode db2sql call testproc(char(old.ordernum));&lt;/p&gt;

&lt;p&gt;insert into testtable values (1, &apos;test1&apos;);&lt;/p&gt;

&lt;p&gt;insert into testchild values (1, 10);&lt;/p&gt;

&lt;p&gt;delete from testtable where id = 1;&lt;/p&gt;

&lt;p&gt;The expected result is that deleting a row from &quot;testtable&quot; will cascade the delete to &quot;testchild&quot;, and the triggers will be called for each delete.  The actual result is that the delete is rolled back with the following error:&lt;/p&gt;

&lt;p&gt;Error: An attempt was made to put a data value of type &apos;java.lang.String&apos; into a data value of&lt;br/&gt;
type &apos;INTEGER&apos;.&lt;br/&gt;
SQLState:  XCL12&lt;br/&gt;
ErrorCode: 30000&lt;/p&gt;

&lt;p&gt;There are no additional entries in the derby.log after the error.  If only one trigger is used, or if the cascade is removed, then the delete will succeed.&lt;/p&gt;

&lt;p&gt;This issue was found while using SymmetricDS, which uses triggers to replicate tables between Derby databases.&lt;/p&gt;</description>
                <environment>Apache Derby 10.5.3.0 and Sun JDK 1.6.0_07</environment>
        <key id="12461658">DERBY-4610</key>
            <summary>Error attempting delete with cascade and triggers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="elong">Eric Long</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Apr 2010 13:28:28 +0100</created>
                <updated>Mon, 17 Jun 2013 10:19:21 +0100</updated>
                            <resolved>Wed, 14 Jul 2010 04:23:30 +0100</resolved>
                                    <version>10.4.1.3</version>
                    <version>10.4.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.2.1</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12855376" author="rhillegas" created="Fri, 9 Apr 2010 13:55:07 +0100"  >&lt;p&gt;Thanks for finding this bug, Eric. I have verified this failure on the trunk. I unchecked the &quot;Wrong query result&quot; box. To the derby developers, that box indicates that a query succeeds but silently does the wrong thing. In this case the query complains as it outright fails. I also set Fix Versions to &quot;Unknown&quot; since we don&apos;t know yet what release will fix this defect. Thanks.&lt;/p&gt;</comment>
                            <comment id="12859382" author="gmbradford" created="Wed, 21 Apr 2010 15:55:10 +0100"  >&lt;p&gt;Is anyone looking at this bug? I would be very interested in trying a patch fix for this when it&apos;s available, or being notified of a possible workaround, as this is a serious issue for our project. Thank you.&lt;/p&gt;</comment>
                            <comment id="12860212" author="knutanders" created="Fri, 23 Apr 2010 11:54:55 +0100"  >&lt;p&gt;Hi Glenn,&lt;/p&gt;

&lt;p&gt;Thanks for volunteering to help testing a fix.&lt;/p&gt;

&lt;p&gt;I found that this error is not seen on Derby 10.3.3.0 and earlier, so I&apos;m marking it as a regression. This will increase the visibility of the bug and the likelihood that someone picks it up.&lt;/p&gt;</comment>
                            <comment id="12860222" author="knutanders" created="Fri, 23 Apr 2010 12:36:45 +0100"  >&lt;p&gt;The test case in the bug description started failing with this commit:&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------------------&lt;br/&gt;
r572753 | djd | 2007-09-04 19:48:20 +0200 (Tue, 04 Sep 2007) | 1 line&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; (partial) Change EmbedResultSet to get a ResultDescription from the activation. Cleanup some ResultSet implementations of getResultDescription()&lt;br/&gt;
------------------------------------------------------------------------&lt;/p&gt;</comment>
                            <comment id="12861292" author="knutanders" created="Tue, 27 Apr 2010 08:50:32 +0100"  >&lt;p&gt;The bug was caused by this part of the 572753 check-in:&lt;/p&gt;

&lt;p&gt;Index: java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java	(revision 572752)&lt;br/&gt;
+++ java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java	(working copy)&lt;br/&gt;
@@ -251,7 +251,7 @@&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Fill in the column types&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;resultDescription = theResults.getResultDescription();&lt;br/&gt;
+		resultDescription = theResults.getActivation().getResultDescription();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// Only incur the cost of allocating and maintaining&lt;br/&gt;
 		// updated column information if the columns can be updated.&lt;/p&gt;


&lt;p&gt;One assumption for the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; changes was that the result description was an attribute of the activation. However, DeleteResultSet and UpdateResultSet, when called from a trigger, get their result descriptions from the saved plan, not from the activation. So the above change appears to have made EmbedResultSet pick up the result description for the statement that caused the trigger to execute, not the one executing in the trigger.&lt;/p&gt;

&lt;p&gt;Reverting the changes on that single line in revision 572753 makes the test case pass. However, the getResultDescription() methods in the language result set classes have later been removed, so that simple fix is no longer possible.&lt;/p&gt;

&lt;p&gt;We may fix this by reintroducing some of the getResultDescription() methods removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt;. Since &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; removed this method because its name could cause confusion, we should probably also rename it to something that makes it clearer what it does, for example getTopLevelResultDescription().&lt;/p&gt;</comment>
                            <comment id="12861660" author="bryanpendleton" created="Wed, 28 Apr 2010 04:22:57 +0100"  >&lt;p&gt;Hmmm. That&apos;s a fairly subtle interaction. Maybe Dan wasn&apos;t thinking about&lt;br/&gt;
triggers when he did the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; work?&lt;/p&gt;

&lt;p&gt;What does the call stack look like when the repro script reaches the&lt;br/&gt;
code at line 251 of EmbedResultSet?&lt;/p&gt;

&lt;p&gt;I see the following interesting code at around line 185 of UpdateResultSet:&lt;/p&gt;

&lt;p&gt;        ResultDescription resultDescription;&lt;br/&gt;
                if(passedInRsd ==null)&lt;br/&gt;
                        resultDescription = activation.getResultDescription();&lt;br/&gt;
                else&lt;br/&gt;
                        resultDescription = passedInRsd;&lt;br/&gt;
                /*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;We NEED a result description when we are going to&lt;/li&gt;
		&lt;li&gt;to have to kick off a trigger.  In a replicated environment&lt;/li&gt;
		&lt;li&gt;we don&apos;t get a result description when we are replaying&lt;/li&gt;
		&lt;li&gt;source xacts on the target, which should never be the&lt;/li&gt;
		&lt;li&gt;case for an UpdateResultSet.&lt;br/&gt;
                */&lt;br/&gt;
                if (SanityManager.DEBUG)
                &lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {                        if (resultDescription == null)                        {
                                SanityManager.ASSERT(triggerInfo == null, &quot;triggers need a result description to pass to result sets given to users&quot;);
                        }                }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Would it work to have UpdateResultSet send &apos;passedInRsd&apos; up to the&lt;br/&gt;
superclass constructor, and then EmbedResultSet&apos;s constructor could&lt;br/&gt;
have similar logic to use either passedInRsd or the activation&apos;s resultDescription,&lt;br/&gt;
depending on whether passedInRsd was null or not?&lt;/p&gt;</comment>
                            <comment id="12861710" author="knutanders" created="Wed, 28 Apr 2010 08:54:42 +0100"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;Here&apos;s the stack trace for the call to getResultDescription() from EmbedResultSet:&lt;/p&gt;

&lt;p&gt;java.lang.Exception: Stack trace&lt;br/&gt;
	at java.lang.Thread.dumpStack(Thread.java:1206)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.&amp;lt;init&amp;gt;(EmbedResultSet.java:259)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet20.&amp;lt;init&amp;gt;(EmbedResultSet20.java:71)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet40.&amp;lt;init&amp;gt;(EmbedResultSet40.java:53)&lt;br/&gt;
	at org.apache.derby.jdbc.Driver40.newEmbedResultSet(Driver40.java:136)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnectionContext.getResultSet(EmbedConnectionContext.java:132)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InternalTriggerExecutionContext.getOldRowSet(InternalTriggerExecutionContext.java:496)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InternalTriggerExecutionContext.getOldRow(InternalTriggerExecutionContext.java:561)&lt;br/&gt;
	at org.apache.derby.exe.ac0b5b0099x0128x435ex16eex0000003b00901.g0(Unknown Source)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.derby.impl.services.reflect.ReflectMethod.invoke(ReflectMethod.java:46)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.CallStatementResultSet.open(CallStatementResultSet.java:75)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeSubStatement(GenericPreparedStatement.java:306)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.GenericTriggerExecutor.executeSPS(GenericTriggerExecutor.java:159)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.RowTriggerExecutor.fireTrigger(RowTriggerExecutor.java:111)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.TriggerEventActivator.notifyEvent(TriggerEventActivator.java:269)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DeleteResultSet.fireAfterTriggers(DeleteResultSet.java:459)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DeleteCascadeResultSet.fireAfterTriggers(DeleteCascadeResultSet.java:263)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DeleteCascadeResultSet.fireAfterTriggers(DeleteCascadeResultSet.java:256)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DeleteCascadeResultSet.open(DeleteCascadeResultSet.java:136)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:317)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1232)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:625)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:555)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:367)&lt;/p&gt;</comment>
                            <comment id="12861739" author="knutanders" created="Wed, 28 Apr 2010 10:13:53 +0100"  >&lt;p&gt;&amp;gt; Would it work to have UpdateResultSet send &apos;passedInRsd&apos; up to the&lt;br/&gt;
&amp;gt; superclass constructor, and then EmbedResultSet&apos;s constructor could&lt;br/&gt;
&amp;gt; have similar logic to use either passedInRsd or the activation&apos;s resultDescription,&lt;br/&gt;
&amp;gt; depending on whether passedInRsd was null or not?&lt;/p&gt;

&lt;p&gt;That might work. A couple of things to notice are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There&apos;s similar logic in DeleteResultSet&apos;s constructor. I&apos;m not&lt;br/&gt;
  quite sure if it&apos;s UpdateResultSet or DeleteResultSet that comes&lt;br/&gt;
  into play here. We probably need to change both.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The result set in EmbedResultSet.theResults is a&lt;br/&gt;
  TemporaryRowHolderImplResultSet, and there&apos;s a number of indirection&lt;br/&gt;
  levels between the source and the holder result set. The code that&lt;br/&gt;
  passes the result description from the source to the holder result&lt;br/&gt;
  set would need to be restored.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; commits that followed 572753, lots of other calls&lt;br/&gt;
  to ResultSet.getResultDescription() were replaced by calls to&lt;br/&gt;
  Activation.getResultDescription(). It&apos;s difficult to say if those&lt;br/&gt;
  are safe, or if the same logic as you suggested in EmbedResultSet&lt;br/&gt;
  needs to be added to each of these calls.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12861766" author="knutanders" created="Wed, 28 Apr 2010 12:00:55 +0100"  >&lt;p&gt;We always have the option to back out &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt;. Since that issue was just a cleanup issue that wasn&apos;t supposed to fix or change the behaviour of anything, backing it out shouldn&apos;t do much harm. As long as it seems that one of the assumptions in that issue isn&apos;t sound and we don&apos;t fully understand which consequences this has for the various parts of the code, backing out the whole thing may be safer than trying to guess which parts have to be changed and which are safe to leave as they are.&lt;/p&gt;

&lt;p&gt;For the record, the following svn command successfully reverted all the commits from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt;, with no conflicts:&lt;/p&gt;

&lt;p&gt;$ svn merge -c -601395,-600678,-598739,-572753 .&lt;/p&gt;

&lt;p&gt;To get it to compile, I had to add import statements for the ResultDescription class in BasicNoPutResultSetImpl and TemporaryRowHolderImpl, since they apparently had been removed later. With that change, it compiled and the repro script ran without error. I&apos;m running derbyall and suites.All now to see if any of the regression tests are affected by it.&lt;/p&gt;</comment>
                            <comment id="12861783" author="knutanders" created="Wed, 28 Apr 2010 13:06:05 +0100"  >&lt;p&gt;I wrote a JUnit test case based on the repro in the bug description. See the attached patch junit.diff.&lt;br/&gt;
The test case is not yet enabled as part of a test suite, since it currently fails.&lt;br/&gt;
Committed to trunk with revision 938959.&lt;/p&gt;

&lt;p&gt;The test case can be run with the following command:&lt;/p&gt;

&lt;p&gt;java junit.textui.TestRunner -m org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.xtestDerby4610WrongDataType&lt;/p&gt;</comment>
                            <comment id="12861787" author="knutanders" created="Wed, 28 Apr 2010 13:26:53 +0100"  >&lt;p&gt;All the regression tests ran cleanly with the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; changes backed out.&lt;/p&gt;</comment>
                            <comment id="12861805" author="bryanpendleton" created="Wed, 28 Apr 2010 14:46:14 +0100"  >&lt;p&gt;&amp;gt; backing out the whole thing may be safer than trying to guess &lt;br/&gt;
&amp;gt; which parts have to be changed and which are safe to leave as they are. &lt;/p&gt;

&lt;p&gt;I agree. I&apos;m comfortable with that resolution, though I might use a&lt;br/&gt;
word like &quot;discover&quot; or &quot;determine&quot; rather than &quot;guess&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Since backing out &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; reveals no new problems, and since it&lt;br/&gt;
resolves the scenarios raised by this issue, it definitely seems the safest.&lt;/p&gt;

&lt;p&gt;Your new test case seems good to me. Is it worth having a separate&lt;br/&gt;
test case which fires the trigger by way of an UPDATE statement rather&lt;br/&gt;
than a DELETE statement, to demonstrate the code path via UpdateResultSet?&lt;/p&gt;</comment>
                            <comment id="12862184" author="knutanders" created="Thu, 29 Apr 2010 13:41:50 +0100"  >&lt;p&gt;I agree that a test case that demonstrates the path through UpdateResultSet would be useful. Unfortunately, I don&apos;t know how to construct one that fails. There seems to be some interaction between delete triggers and cascading deletes in the original repro, and since we don&apos;t have cascading updates (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-735&quot; title=&quot;Need implementation for `ON UPDATE CASCADE`&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-735&quot;&gt;DERBY-735&lt;/a&gt;), there&apos;s no obvious translation into a test case for update.&lt;/p&gt;

&lt;p&gt;One interesting point, though: When running the original repro, none of the DeleteResultSets use the passed in ResultDescription. They all take the one from the activation. What seems to happen, is that the Activation instance is reinitialized (setupActivation() is called) sometime between the call to DeleteResultSet&apos;s constructor and the call to getResultDescription() in EmbedResultSet. So even though it&apos;s true that ResultSet.getResultDescription() returns the same as Activation.getResultSetDescription() at the time the DeleteResultSet is created, this is not true when we reach the point in around line 251 in EmbedResultSet, because the ResultDescription in the activation has changed.&lt;/p&gt;</comment>
                            <comment id="12862207" author="bryanpendleton" created="Thu, 29 Apr 2010 15:13:58 +0100"  >&lt;p&gt;Perhaps this problem can be managed in InternalTriggerExecutionContext?&lt;/p&gt;

&lt;p&gt;It seems like that is the place where we are trying to manage the beforeResultSet&lt;br/&gt;
and ensure it can be used by the trigger. So maybe when&lt;br/&gt;
InternalTriggerExecutionContext.setBeforeResultSet is called, it can, in addition&lt;br/&gt;
to saving the beforeResultSet, also save a clone of the beforeResultSet&apos;s activation,&lt;br/&gt;
or perhaps just the resultDescription, so that, later, when&lt;br/&gt;
InternalTriggerExecutionContext.getOldResultSet is called, it can arrange for&lt;br/&gt;
the beforeResultSet&apos;s activation to point to the correct result description.&lt;/p&gt;

&lt;p&gt;This would confine the work to trigger context management, which seems like&lt;br/&gt;
the appropriate place for the work to be occurring.&lt;/p&gt;</comment>
                            <comment id="12862589" author="knutanders" created="Fri, 30 Apr 2010 09:54:19 +0100"  >&lt;p&gt;Possibly. I&apos;m afraid I&apos;m not very familiar with this code and don&apos;t know how it&apos;s supposed to work. I&apos;ve noticed though that there is some code that attempts something similar in GenericTriggerExecutor.executeSPS(), by setting up a separate activation for the SPS.&lt;/p&gt;</comment>
                            <comment id="12863358" author="knutanders" created="Mon, 3 May 2010 15:16:53 +0100"  >&lt;p&gt;I reverse merged the commits from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3049&quot; title=&quot;Remove (Language) ResultSet.getResultDescription() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3049&quot;&gt;&lt;del&gt;DERBY-3049&lt;/del&gt;&lt;/a&gt; for now and committed revision 940462. If we find a safe way to add those changes, we can always reintroduce them later. I&apos;ll look into back-porting to 10.6 in a couple of days if there are no problems in the nightly tests.&lt;/p&gt;</comment>
                            <comment id="12863363" author="knutanders" created="Mon, 3 May 2010 15:32:35 +0100"  >&lt;p&gt;Attaching a patch that enables the regression test case for this bug.&lt;br/&gt;
Committed revision 940469.&lt;/p&gt;</comment>
                            <comment id="12865079" author="knutanders" created="Fri, 7 May 2010 09:22:47 +0100"  >&lt;p&gt;Merged the fix and the test to the 10.6 branch and committed revision 942027.&lt;br/&gt;
Marking the issue as resolved.&lt;/p&gt;</comment>
                            <comment id="12865164" author="gmbradford" created="Fri, 7 May 2010 15:17:16 +0100"  >&lt;p&gt;Thanks Knut Anders for resolving this! When can I expect to see a stable version with the fix in it? Or is 10.6.1.1 available now.&lt;/p&gt;</comment>
                            <comment id="12865338" author="knutanders" created="Fri, 7 May 2010 23:24:00 +0100"  >&lt;p&gt;Hi Glenn,&lt;/p&gt;

&lt;p&gt;Unfortunately, the fix was too late to get into the 10.6.1.0 release candidate that&apos;s currently being tested and voted on. So unless the current release candidate is rejected, it won&apos;t be part of the upcoming 10.6.1 release and will have to wait to the first 10.6 maintenance release (no plans exist for that release yet, I&apos;m afraid).&lt;/p&gt;

&lt;p&gt;If you&apos;re interested in testing the fix without building from source, the binaries built for the nightly regression tests of the 10.6 branch can be found here: &lt;a href=&quot;http://dbtg.foundry.sun.com/derby/bits/10.6/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.foundry.sun.com/derby/bits/10.6/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12886792" author="mamtas" created="Fri, 9 Jul 2010 18:45:44 +0100"  >&lt;p&gt;Will backport this to 10.5&lt;/p&gt;</comment>
                            <comment id="12886810" author="mamtas" created="Fri, 9 Jul 2010 19:17:22 +0100"  >&lt;p&gt;sorry, unassigning myself from this backport. Another backport (for a different jira) of mine is failing and I want to see if I can figure out what might be wrong there before doing a new backport.&lt;/p&gt;</comment>
                            <comment id="12887805" author="mamtas" created="Tue, 13 Jul 2010 16:37:01 +0100"  >&lt;p&gt;I will work on backporting this to 10.5&lt;/p&gt;</comment>
                            <comment id="12889925" author="mamtas" created="Mon, 19 Jul 2010 18:22:20 +0100"  >&lt;p&gt;Attaching a patch which will log the Engine shutdown message in derby.log. The existing message logging for each individual connection close which happen because of engine shutdown will still be logged but they will now print the name of the database being shutdown. &lt;/p&gt;

&lt;p&gt;The existing regression tests ran fine. If there is no objection to this patch, I will commit it by Wednesday morning.&lt;/p&gt;</comment>
                            <comment id="12890220" author="knutanders" created="Tue, 20 Jul 2010 10:17:08 +0100"  >&lt;p&gt;I suppose the patch was meant to be attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4601&quot; title=&quot;Shutting down just a single database should log a different message than shutting down the system&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4601&quot;&gt;&lt;del&gt;DERBY-4601&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="12890224" author="knutanders" created="Tue, 20 Jul 2010 10:40:51 +0100"  >&lt;p&gt;Mamta, I&apos;ve posted my comments to the patch over at &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4601&quot; title=&quot;Shutting down just a single database should log a different message than shutting down the system&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4601&quot;&gt;&lt;del&gt;DERBY-4601&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12890314" author="mamtas" created="Tue, 20 Jul 2010 17:52:58 +0100"  >&lt;p&gt;Yes, I did mean to post the patch to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4601&quot; title=&quot;Shutting down just a single database should log a different message than shutting down the system&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4601&quot;&gt;&lt;del&gt;DERBY-4601&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12923862" author="knutanders" created="Fri, 22 Oct 2010 14:56:08 +0100"  >&lt;p&gt;Reassigning the issue now that the back-port to 10.5 has been completed.&lt;/p&gt;</comment>
                            <comment id="13685211" author="knutanders" created="Mon, 17 Jun 2013 10:19:21 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12377478">DERBY-3049</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12468384">DERBY-4728</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12443463" name="enable_test.diff" size="994" author="knutanders" created="Mon, 3 May 2010 15:32:35 +0100"/>
                            <attachment id="12443077" name="junit.diff" size="2471" author="knutanders" created="Wed, 28 Apr 2010 13:06:05 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 9 Apr 2010 12:55:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24364</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0oev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37773</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>