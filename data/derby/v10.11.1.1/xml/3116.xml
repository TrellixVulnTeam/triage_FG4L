<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:32:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3116/DERBY-3116.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3116] totalSpace not properly initialized in AllocPage</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3116</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;There are some problems with the initialization of totalSpace in AllocPage. It is initialized in StoredPage.initSpace() which is again called from StoredPage.usePageBuffer(), and it is set to the value returned from AllocPage.getMaxFreeSpace(). The problems are:&lt;/p&gt;

&lt;p&gt;  1) The calculation in getMaxFreeSpace() uses borrowedSpace, but when createIdentity() is called on an AllocPage, borrowedSpace has not been initialized when getMaxFreeSpace() is called and the calculated size is wrong.&lt;/p&gt;

&lt;p&gt;  2) When a page object is reused, usePageBuffer() is only called if a new byte array must be allocated (because the new page has a different size than the old page). This means that the totalSize field gets the same value as in the old page if their sizes are equal, which is not necessarily correct.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12379869">DERBY-3116</key>
            <summary>totalSpace not properly initialized in AllocPage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Oct 2007 15:05:15 +0100</created>
                <updated>Mon, 4 May 2009 19:22:54 +0100</updated>
                            <resolved>Fri, 4 Apr 2008 23:30:05 +0100</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12533134" author="knutanders" created="Mon, 8 Oct 2007 15:25:07 +0100"  >&lt;p&gt;I haven&apos;t run any tests on it yet, but this patch seems to make totalSpace have the correct value for all pages created in unit/T_RawStoreFactory.unit (verified by printing and comparing totalSpace to getMaxFreeSpace()). Will start a full run of regression tests and report back. I&apos;ll also see if I can add some asserts (since I know of no other way to expose the bug).&lt;/p&gt;

&lt;p&gt;What this patch does, is:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in AllocPage.createPage(), set borrowedSpace before super.createPage() is called so that getMaxFreeSpace() returns the correct value when totalSpace is initialized&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in CachedPage.setPageArray(), call usePageBuffer() also when the old buffer is reused. This ensures that totalSpace is recalculated when a page object is reused.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12533187" author="knutanders" created="Mon, 8 Oct 2007 19:51:37 +0100"  >&lt;p&gt;suites.All and derbyall ran cleanly with the d3116-1 patch.&lt;/p&gt;</comment>
                            <comment id="12534775" author="jorgenlo" created="Mon, 15 Oct 2007 10:10:04 +0100"  >&lt;p&gt;Hi Knut Anders.&lt;/p&gt;

&lt;p&gt;Patch d3116-1 looks correct to me, but it seems a little overkill to always reinitiate the byte[] in StoredPage. Could you achieve the same thing by moving the initSpace call from StoredPage#usePageBuffer to StoredPage#createPage? Alternatively make initSpace protected and call StoredPage#initSpace from CachedPage#setPageArray when the page is reused?&lt;/p&gt;

&lt;p&gt;Another bug? In StoredPage#initSpace, slotEntrySize is used when setting maxFieldSize. However, initSpace is called before slotEntrySize has been updated in usePageBuffer. &lt;/p&gt;

&lt;p&gt;Not related to your patch: There is a problem with the Javadoc in AllocPage (unclosed paragraph &quot;&amp;lt;p&quot;). Fixing that would show more javadoc in the html files.&lt;/p&gt;</comment>
                            <comment id="12534795" author="knutanders" created="Mon, 15 Oct 2007 11:23:21 +0100"  >&lt;p&gt;Thanks for looking at the patch, J&#248;rgen!&lt;/p&gt;

&lt;p&gt;&amp;gt; it seems a little overkill to always reinitiate the byte[] in StoredPage.&lt;/p&gt;

&lt;p&gt;Note that setPageBuffer() doesn&apos;t reallocate the byte array, it only sets the reference to the byte array and refreshes some of the instance variables. I think the cost of these operations is negligible compared to the cost of evicting the old page and initializing the new one.&lt;/p&gt;

&lt;p&gt;&amp;gt; Could you achieve the same thing by moving the initSpace call from StoredPage#usePageBuffer to StoredPage#createPage?&lt;/p&gt;

&lt;p&gt;That might be possible, but then I think we would also have to move it into StoredPage.initFromData() as the same problem may occur if you read an alloc page from disk instead of creating a new one. It also seems like initSpace() depends on other variables initialized in usePageBuffer() (slotEntrySize in particular) so we&apos;d probably end up with moving most of the code in usePageBuffer() into initSpace() anyway.&lt;/p&gt;

&lt;p&gt;&amp;gt; Another bug? In StoredPage#initSpace, slotEntrySize is used when setting maxFieldSize. However, initSpace is called before slotEntrySize has been updated in usePageBuffer.&lt;/p&gt;

&lt;p&gt;This is supposed to be fixed in the current trunk (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3099&quot; title=&quot;Possible bug in interaction with buffer manager causing pages not to be freed on rollback to savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3099&quot;&gt;&lt;del&gt;DERBY-3099&lt;/del&gt;&lt;/a&gt;). But thanks for verifiying that it in fact is a bug! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; Not related to your patch: There is a problem with the Javadoc in AllocPage (unclosed paragraph &quot;&amp;lt;p&quot;). Fixing that would show more javadoc in the html files.&lt;/p&gt;

&lt;p&gt;Good catch! I fixed the tag and checked it in. Now I see one more line in the javadoc, but still there&apos;s much of it that doesn&apos;t show up. Perhaps there&apos;s a problem with the custom javadoc tags (format_id, purpose, etc)?&lt;/p&gt;</comment>
                            <comment id="12585435" author="knutanders" created="Fri, 4 Apr 2008 08:39:07 +0100"  >&lt;p&gt;Uploading a new patch which resolves a conflict with a recent commit. The new patch also contains an assert which exposes the bug in the lack of a test for it.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Without the fixes, the assert will cause database creation to fail.&lt;/li&gt;
	&lt;li&gt;With the fix in AllocPage.createPage(), unit/T_RawStoreFactory.unit will fail when an AllocPage is evicted from the page cache to make room for an AllocPage with a different borrowedSpace value.&lt;/li&gt;
	&lt;li&gt;With the fix in CachedPage.setPageArray(), unit/T_RawStoreFactory.unit passes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m re-running derbyall and suites.All now. Since there were no more comments on the previous patch, I intend to commit the updated patch to trunk and 10.4 if all the tests pass.&lt;/p&gt;</comment>
                            <comment id="12585511" author="knutanders" created="Fri, 4 Apr 2008 13:47:19 +0100"  >&lt;p&gt;Committed to trunk with revision 644698.&lt;/p&gt;</comment>
                            <comment id="12585806" author="knutanders" created="Fri, 4 Apr 2008 23:30:05 +0100"  >&lt;p&gt;Committed to 10.4 with revision 644967.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12367264" name="d3116-1.diff" size="1502" author="knutanders" created="Mon, 8 Oct 2007 15:25:07 +0100"/>
                            <attachment id="12379364" name="d3116-2.diff" size="2532" author="knutanders" created="Fri, 4 Apr 2008 08:39:07 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 15 Oct 2007 09:10:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23444</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xaf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39211</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>