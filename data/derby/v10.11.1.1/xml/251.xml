<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:53:07 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-251/DERBY-251.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-251] DISTINCT query is returning duplicate rows</title>
                <link>https://issues.apache.org/jira/browse/DERBY-251</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Following query on a table with primary key returns duplicate rows&lt;br/&gt;
select  distinct  q1.&quot;NO1&quot; from IDEPT q1, IDEPT q2 &lt;br/&gt;
where  ( q2.&quot;DISCRIM_DEPT&quot; = &apos;HardwareDept&apos;) &lt;br/&gt;
 and  ( q1.&quot;DISCRIM_DEPT&quot; = &apos;SoftwareDept&apos;)  and  ( q1.&quot;NO1&quot; &lt;br/&gt;
&amp;lt;&amp;gt; ALL  ( select  q3.&quot;NO1&quot; from IDEPT q3 where  (  q3.&quot;REPORTTO_NO&quot; =  q2.&quot;NO1&quot;) ) )  ;&lt;/p&gt;

&lt;p&gt;The sql script to create the table and load data into it is as follows&lt;br/&gt;
CREATE TABLE &quot;APP&quot;.&quot;IDEPT&quot; (&quot;DISCRIM_DEPT&quot; VARCHAR(32), &quot;NO1&quot; INTEGER NOT NULL, &lt;br/&gt;
&quot;NAME&quot; VARCHAR(50), &quot;AUDITOR_NO&quot; INTEGER, &quot;REPORTTO_NO&quot; INTEGER, &quot;HARDWAREASSET&quot;&lt;br/&gt;
 VARCHAR(15), &quot;SOFTWAREASSET&quot; VARCHAR(15));&lt;br/&gt;
&amp;#8211; primary/unique&lt;br/&gt;
ALTER TABLE &quot;APP&quot;.&quot;IDEPT&quot; ADD CONSTRAINT &quot;PK_IDEPT&quot; PRIMARY KEY (&quot;NO1&quot;);&lt;br/&gt;
insert into idept values (&apos;Dept&apos;, 1, &apos;Department1&apos;, null, null, null, null);&lt;br/&gt;
insert into idept values (&apos;HardwareDept&apos;, 2, &apos;Department2&apos;, 25, 1, &apos;hardwareaset2&apos;, null);&lt;br/&gt;
insert into idept values (&apos;HardwareDept&apos;, 3, &apos;Department3&apos;, 25, 2, &apos;hardwareaset3&apos;, null);&lt;br/&gt;
insert into idept values (&apos;SoftwareDept&apos;, 4, &apos;Department4&apos;, 25, 1, null, &apos;softwareasset4&apos;);&lt;br/&gt;
insert into idept values (&apos;SoftwareDept&apos;, 5, &apos;Department5&apos;, 30, 4, null, &apos;softwareasset5&apos;);&lt;/p&gt;


&lt;p&gt;The problem appears to be in org.apache.derby.impl.sql.compile.FromList.returnsAtMostSingleRow() method. This method along with other things tries to determine if the DISTINCT can be dropped without causing duplicate rows. For the query in question, this method decides that DISTINCT is not necessary which I think is incorrect.&lt;/p&gt;

&lt;p&gt;If the table above is created with no primary key, the DISTINCT query does not return duplicate rows. That is because one of the several criterias for dropping DISTINCT is that there should be a unique index on the columns in the where clause.&lt;/p&gt;</description>
                <environment></environment>
        <key id="32143">DERBY-251</key>
            <summary>DISTINCT query is returning duplicate rows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="mamtas">Mamta A. Satoor</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 Apr 2005 06:44:06 +0100</created>
                <updated>Thu, 12 May 2005 23:04:22 +0100</updated>
                            <resolved>Thu, 12 May 2005 23:04:22 +0100</resolved>
                                    <version>10.1.1.0</version>
                                    <fixVersion>10.1.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="65125" author="mamtas" created="Thu, 12 May 2005 23:04:22 +0100"  >&lt;p&gt;The above query gets transformed into following at optimization time&lt;br/&gt;
select  distinct  q1.&quot;NO1&quot; from IDEPT q1, IDEPT q2&lt;br/&gt;
where  ( q2.&quot;DISCRIM_DEPT&quot; = &apos;HardwareDept&apos;)&lt;br/&gt;
and  ( q1.&quot;DISCRIM_DEPT&quot; = &apos;SoftwareDept&apos;)  and  not exists (&lt;br/&gt;
(select  q3.&quot;NO1&quot; from IDEPT q3 where&lt;br/&gt;
(  q3.&quot;REPORTTO_NO&quot; =  q2.&quot;NO1&quot;  and q3.&quot;NO1&quot; = q1.&quot;NO1&quot;) ) )  ;&lt;/p&gt;

&lt;p&gt;On this query, the distinct elimination logic is called. That logic incorrectly used the equality condition from the not exists clause to determine elimination of distinct on the outer query. I have changed the logic to ignore equality predicates associated with the exists clause while deciding to drop distinct in the outer query.&lt;/p&gt;

&lt;p&gt;This change got committed as Revision 169735.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21862</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy18hj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41025</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>