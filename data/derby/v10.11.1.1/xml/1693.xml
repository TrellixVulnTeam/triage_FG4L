<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:32:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1693/DERBY-1693.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1693] Out of Memory Error with derby.language.logStatementText=true</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1693</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;While running a test with blobs and clobs of random size but not exceeding more than 5MB , with derby.language.logStatementText=true , The inserts are faling with out of memory error. Once that error occurs then the test loses all connections to the database. If I take off the derby.language.logStatementText=true property from derby.properties, the test runs fine. Here is the stack Trace&lt;/p&gt;


&lt;p&gt;java.lang.OutOfMemoryError: Java heap space&lt;/p&gt;

&lt;p&gt;--&lt;del&gt;SQLException Caught&lt;/del&gt;--&lt;/p&gt;

&lt;p&gt;SQLState:   XJ001&lt;br/&gt;
Severity: 0&lt;br/&gt;
Message:  Java exception: &apos;Java heap space: java.lang.OutOfMemoryError&apos;.&lt;br/&gt;
java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
java.sql.SQLException: No current connection.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExc&lt;br/&gt;
eptionFactory.java:45)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:89)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:105)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.noCurrentConnection(Util.java:209)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.checkIfClosed(EmbedConnect&lt;br/&gt;
ion.java:1351)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.setupContextStack(EmbedCon&lt;br/&gt;
nection.java:1529)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.rollback(EmbedConnection.j&lt;br/&gt;
ava:946)&lt;br/&gt;
        at com.ibm.db2j.tests.scenario.utils.DbTasks.insertMail(DbTasks.java:400&lt;br/&gt;
)&lt;br/&gt;
        at com.ibm.db2j.tests.scenario.tasks.Refresh.insertMail(Refresh.java:62)&lt;br/&gt;
        at com.ibm.db2j.tests.scenario.tasks.Refresh.doWork(Refresh.java:43)&lt;br/&gt;
        at com.ibm.db2j.tests.scenario.tasks.Refresh.run(Refresh.java:21)&lt;/p&gt;</description>
                <environment>JVM INFO :&lt;br/&gt;
java version &amp;quot;1.5.0_02&amp;quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_02-b09)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.5.0_02-b09, mixed mode)&lt;br/&gt;
&lt;br/&gt;
OS : Windows XP Professional</environment>
        <key id="12347943">DERBY-1693</key>
            <summary>Out of Memory Error with derby.language.logStatementText=true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="mkutty">Manjula Kutty</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Aug 2006 00:27:17 +0100</created>
                <updated>Fri, 19 Oct 2007 17:11:45 +0100</updated>
                            <resolved>Thu, 16 Nov 2006 17:08:25 +0000</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.3.1.4</version>
                                    <fixVersion>10.1.3.2</fixVersion>
                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12428074" author="kristwaa" created="Tue, 15 Aug 2006 09:52:47 +0100"  >&lt;p&gt;I think I have seen the same issue earlier.&lt;br/&gt;
My mind might be playing a trick on me, but I mean to remember the problem was that the statement text logging mechanism tries to log the contents of LOBs. Based on my testing, insertion of a 10 MB clob fails without tracing (this will change when some fixes get in), which may support the observation that insertion of a 5 MB clob fails if its content is cloned when being logged.&lt;/p&gt;</comment>
                            <comment id="12428169" author="mikem" created="Tue, 15 Aug 2006 18:08:19 +0100"  >&lt;p&gt;I agree, my guess is that we are trying to print out the whole blob/clob in the log statement text. This is &lt;br/&gt;
very unlikely what the user wants.   And in the current architecture anytime you try to do 2 different things&lt;br/&gt;
with streamed blob/clob then the blob/clob is going to get instantiated in memory.  So for instance on &lt;br/&gt;
an insert we can stream the blob to the store, but if we need to print it to the log first we are going to call&lt;br/&gt;
toString and end up with it in memory (of course you could stream to disk and back but doesn&apos;t seem &lt;br/&gt;
worth it for logstatement text).  &lt;/p&gt;

&lt;p&gt;My question is what should log statement text do.  The easiest is just not print values for the blob/clob.  Is&lt;br/&gt;
that ok?  &lt;/p&gt;</comment>
                            <comment id="12428183" author="kristwaa" created="Tue, 15 Aug 2006 18:43:13 +0100"  >&lt;p&gt;When a very similar problem was fixed in the network server code, I think the length of the LOB was included.&lt;br/&gt;
Maybe something like &apos;BLOB(2048)&apos;. This looks useful to me, but we may not always know the length (for instance when a BLOB with an associated stream is used as input). For these, I guess marking the length as unknown is okay.&lt;/p&gt;</comment>
                            <comment id="12428186" author="mkutty" created="Tue, 15 Aug 2006 18:57:34 +0100"  >&lt;p&gt;My question is what should log statement text do. The easiest is just not print values for the blob/clob. Is&lt;br/&gt;
that ok?&lt;/p&gt;

&lt;p&gt;I  have more prefrence to not to print the values for the blob /clob. This will solve 2 problems:&lt;/p&gt;

&lt;p&gt;1. The out of memory error&lt;br/&gt;
2.  the derby.log will become more cleaner (without  those binary values for the blob)&lt;/p&gt;</comment>
                            <comment id="12429382" author="kristwaa" created="Mon, 21 Aug 2006 11:45:18 +0100"  >&lt;p&gt;I agree that the values for LOBs should not be printed.&lt;br/&gt;
The question is what should be printed instead?&lt;br/&gt;
I would go for either &apos;BLOB&apos;/&apos;CLOB&apos; or &apos;BLOB(&amp;lt;length&amp;gt;)&apos;/&apos;CLOB(&amp;lt;length&amp;gt;)&apos;.&lt;br/&gt;
I fancy the latter the most, but I do not fully understand the complications of obtaining the length wrt &quot;length less LOBs&quot;. For instance, materializing it to determine the length is unacceptable in my opinion.&lt;/p&gt;</comment>
                            <comment id="12443030" author="kristwaa" created="Tue, 17 Oct 2006 19:40:28 +0100"  >&lt;p&gt;Having looked a little bit at this, I suggest adding (yet) another method to the DataValueDescriptor interface, say getTraceString().&lt;/p&gt;

&lt;p&gt;The reason for this, is that today the method getString() is used to obtain the text logged to derby.log when derby.language.logStatementText is set to true. At the same time, this call is also used for getting the values of data types to do other operations. If getString() is changed to return a representation of the data that is only suitable for tracing, Derby will stop working. NetBeans counted 207 usages of the method.&lt;/p&gt;

&lt;p&gt;I tried changing getString(), and when executing a simple insert with a prepared statement, Derby went down miserably with a stack overflow error.&lt;br/&gt;
I also tried adding the suggested getTraceString(), and things seemd to work (no LOB contents in derby.log and the test succeded).&lt;/p&gt;

&lt;p&gt;I think we can get away with a general implementation of getTraceString() that forwards to getString() in DataType and then write specific implementations for the types that require this (Clob and Blob).&lt;/p&gt;


&lt;p&gt;Have I overlooked something, or will this approach cause trouble?&lt;br/&gt;
If I don&apos;t get pushback, I will create a patch for the suggested approach.&lt;/p&gt;</comment>
                            <comment id="12444272" author="kristwaa" created="Tue, 24 Oct 2006 10:53:00 +0100"  >&lt;p&gt;&apos;ReproDerby1693.java&apos; is a repro for the bug.&lt;/p&gt;</comment>
                            <comment id="12444308" author="kristwaa" created="Tue, 24 Oct 2006 14:08:48 +0100"  >&lt;p&gt;&apos;derby-1693-1a.diff&apos; adds the method &apos;getTraceString&apos; to the &apos;DataValueDescriptor&apos;-interface, and it is intended to be used for debugging/tracing.&lt;/p&gt;

&lt;p&gt;Things to consider:&lt;br/&gt;
  a) The name of the new method (one could go for toString() instead)&lt;br/&gt;
  b) The information being printed to derby.log&lt;/p&gt;

&lt;p&gt;Currently, the value returned by &apos;getString&apos; is logged for all data types except BLOB and CLOB.&lt;br/&gt;
For LOBs, one of the following is logged:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;NULL&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BC&amp;#93;&lt;/span&gt;LOB(&amp;lt;size in bytes as returned by getLength()&amp;gt;)&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BC&amp;#93;&lt;/span&gt;LOB(&amp;lt;toString() of associated stream&amp;gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If there is a stream associated with the LOB, it is not materialized when logging information to derby.log.&lt;/p&gt;

&lt;p&gt;I ran the All suite without errors. derbyall was also run without errors, but I changed something afterwards and is running derbyall again to be sure. Patch is ready for review.&lt;/p&gt;</comment>
                            <comment id="12445877" author="kristwaa" created="Tue, 31 Oct 2006 11:54:43 +0000"  >&lt;p&gt;Attaching the patch (&apos;derby-1693-1a.diff&apos;)...&lt;br/&gt;
Someone with Jira super-powers can delete the class file if they want to.&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12446145" author="bryanpendleton" created="Wed, 1 Nov 2006 01:36:28 +0000"  >&lt;p&gt;I downloaded the patch and applied it. I was able to run the ReproDerby1693 program,&lt;br/&gt;
and I can see in the derby.log that the logged statement text is just as I expected: only&lt;br/&gt;
a token for the large object&apos;s stream is logged, not the large object itself.&lt;/p&gt;</comment>
                            <comment id="12450381" author="knutanders" created="Thu, 16 Nov 2006 12:56:58 +0000"  >&lt;p&gt;The patch looks good. +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12450459" author="kristwaa" created="Thu, 16 Nov 2006 17:08:25 +0000"  >&lt;p&gt;Committed &apos;derby-1693-1a.diff&apos; to trunk with revision 475817.&lt;br/&gt;
I also plan to merge this fix into the 10.2 branch.&lt;/p&gt;</comment>
                            <comment id="12450460" author="kristwaa" created="Thu, 16 Nov 2006 17:09:53 +0000"  >&lt;p&gt;Forgot to say that I ran derbyall and suites.All without failures (except for CompatibilityTest, which I believe has been fixed by now).&lt;/p&gt;</comment>
                            <comment id="12451678" author="kristwaa" created="Tue, 21 Nov 2006 15:41:50 +0000"  >&lt;p&gt;Merged to 10.2 branch with revision 477699 and the following merge command:&lt;br/&gt;
svn merge -r 475816:475817 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ran derbyall with no failures.&lt;/p&gt;</comment>
                            <comment id="12461721" author="kristwaa" created="Tue, 2 Jan 2007 12:39:35 +0000"  >&lt;p&gt;No further work expected, and no problems reported.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12317543">DERBY-598</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12343540" name="ReproDerby1693.class" size="1779" author="kristwaa" created="Tue, 24 Oct 2006 14:08:48 +0100"/>
                            <attachment id="12343525" name="ReproDerby1693.java" size="1738" author="kristwaa" created="Tue, 24 Oct 2006 10:53:00 +0100"/>
                            <attachment id="12343997" name="derby-1693-1a.diff" size="4319" author="kristwaa" created="Tue, 31 Oct 2006 11:54:43 +0000"/>
                            <attachment id="12343541" name="derby-1693-1a.stat" size="632" author="kristwaa" created="Tue, 24 Oct 2006 14:08:48 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 15 Aug 2006 08:52:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22643</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy10x3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39799</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>