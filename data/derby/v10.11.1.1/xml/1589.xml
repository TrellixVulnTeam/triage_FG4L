<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:21 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1589/DERBY-1589.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1589] CREATE TABLE throws NullPointerException in Derby SQL Standard Authorization after DROPs and REVOKES</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1589</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Currently, the last sql statement in following set of sql statements will raise a null pointer exception&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta1&apos; as mamta1;&lt;br/&gt;
create table t11ConstraintTest (c111 int not null, c112 int not null, primary key (c111, c112));&lt;br/&gt;
grant references on t11ConstraintTest to mamta3;&lt;br/&gt;
connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta3&apos; as mamta3;&lt;br/&gt;
drop table t31ConstraintTest;&lt;br/&gt;
&amp;#8211; the following statement should remember that it depends on REFERENCES privilege on mamta1.t11ConstraintTest&lt;br/&gt;
create table t31ConstraintTest (c311 int, c312 int, foreign key(c311, c312) references mamta1.t11ConstraintTest);&lt;br/&gt;
drop table t31ConstraintTest;&lt;br/&gt;
set connection mamta1;&lt;br/&gt;
&amp;#8211; following should revoke all the privileges granted on it&lt;br/&gt;
drop table t11ConstraintTest;&lt;br/&gt;
create table t11ConstraintTest (c111 int not null, c112 int not null, primary key (c111, c112));&lt;br/&gt;
grant references(c111) on t11ConstraintTest to mamta3;&lt;br/&gt;
grant references(c112) on t11ConstraintTest to PUBLIC;&lt;br/&gt;
--connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta3&apos; as mamta3;&lt;br/&gt;
set connection mamta3;&lt;br/&gt;
drop table t31ConstraintTest;&lt;br/&gt;
&amp;#8211; following sql should recompie itself because the earlier plan depended on a privilege which doesn&apos;t&lt;br/&gt;
&amp;#8211; exist anymore. Instead, new privileges have been granted and the plan for following statement should depend&lt;br/&gt;
&amp;#8211; on those new privileges&lt;br/&gt;
create table t31ConstraintTest (c311 int, c312 int, foreign key(c311, c312) references mamta1.t11ConstraintTest); &lt;/p&gt;</description>
                <environment></environment>
        <key id="12346651">DERBY-1589</key>
            <summary>CREATE TABLE throws NullPointerException in Derby SQL Standard Authorization after DROPs and REVOKES</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jul 2006 21:27:08 +0100</created>
                <updated>Thu, 13 Dec 2007 09:05:06 +0000</updated>
                            <resolved>Tue, 19 Sep 2006 00:51:30 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12423442" author="djd" created="Tue, 25 Jul 2006 21:28:03 +0100"  >&lt;p&gt;Original entered as &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1523&quot; title=&quot;Statements in cache need to depend on privileges and the appropriate statements in cache should get invalidated if those privileges change.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1523&quot;&gt;&lt;del&gt;DERBY-1523&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12430246" author="rhillegas" created="Thu, 24 Aug 2006 15:12:49 +0100"  >&lt;p&gt;Assign to 10.2 and bump urgency.&lt;/p&gt;</comment>
                            <comment id="12433215" author="mamtas" created="Thu, 7 Sep 2006 21:01:15 +0100"  >&lt;p&gt;I noticed that the stack trace for null pointer exception was not included in this jira entry. So, I ran the following sql script using ij in the trunk&lt;br/&gt;
connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta1&apos; as mamta1; &lt;br/&gt;
create table t11ConstraintTest (c111 int not null, c112 int not null, primary key (c111, c112)); &lt;br/&gt;
grant references on t11ConstraintTest to mamta3; &lt;br/&gt;
connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta3&apos; as mamta3; &lt;br/&gt;
drop table t31ConstraintTest; &lt;br/&gt;
create table t31ConstraintTest (c311 int, c312 int, foreign key(c311, c312) references mamta1.t11ConstraintTest); &lt;br/&gt;
drop table t31ConstraintTest; &lt;br/&gt;
set connection mamta1; &lt;br/&gt;
drop table t11ConstraintTest; &lt;br/&gt;
create table t11ConstraintTest (c111 int not null, c112 int not null, primary key (c111, c112)); &lt;br/&gt;
grant references(c111) on t11ConstraintTest to mamta3; &lt;br/&gt;
grant references(c112) on t11ConstraintTest to PUBLIC; &lt;br/&gt;
set connection mamta3; &lt;br/&gt;
drop table t31ConstraintTest; &lt;br/&gt;
create table t31ConstraintTest (c311 int, c312 int, foreign key(c311, c312) references mamta1.t11ConstraintTest); &lt;/p&gt;


&lt;p&gt;And the last create table always gave null pointer exception. The stack trace looks as follows&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.TablePermsDescriptor.&amp;lt;init&amp;gt;(TablePermsDescriptor.java:70)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.TablePermsDescriptor.&amp;lt;init&amp;gt;(TablePermsDescriptor.java:81)&lt;br/&gt;
        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getTablePermissions(DataDictionaryImpl.java:9962)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.StatementTablePermission.oneAuthHasPermissionOnTable(StatementTablePermission.java:148)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.StatementTablePermission.hasPermissionOnTable(StatementTablePermission.java:141)&lt;br/&gt;
        at org.apache.derby.iapi.sql.dictionary.StatementColumnPermission.check(StatementColumnPermission.java:94)&lt;br/&gt;
        at org.apache.derby.impl.sql.conn.GenericAuthorizer.authorize(GenericAuthorizer.java:158)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.GenericResultSetFactory.getDDLResultSet(GenericResultSetFactory.java:1020)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.ConstantActionActivation.execute(ConstantActionActivation.java:54)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:327)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:356)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1182)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:585)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:517)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:321)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:517)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:370)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:268)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:204)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:170)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:56)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:71)&lt;/p&gt;</comment>
                            <comment id="12434491" author="bryanpendleton" created="Wed, 13 Sep 2006 17:40:45 +0100"  >&lt;p&gt;I need to learn more about Grant/Revoke data dictionary&lt;br/&gt;
handling as part of the work I&apos;m doing on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1489&quot; title=&quot;Provide ALTER TABLE DROP COLUMN functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1489&quot;&gt;&lt;del&gt;DERBY-1489&lt;/del&gt;&lt;/a&gt;, so&lt;br/&gt;
I&apos;ll have a look at this one and see what I can figure out.&lt;/p&gt;</comment>
                            <comment id="12434577" author="bryanpendleton" created="Thu, 14 Sep 2006 03:32:39 +0100"  >&lt;p&gt;I think that the problem involves the prepared statement cache and how statements&lt;br/&gt;
get invalidated. Notice that the very last statement is a CREATE TABLE statement&lt;br/&gt;
which is identical in text to a CREATE TABLE statement issued earlier in the script,&lt;br/&gt;
though it refers to table t11ConstraintTest which has been dropped and recreated&lt;br/&gt;
in the meantime.&lt;/p&gt;

&lt;p&gt;Tracing through the code, it seems that when we hit the last line of the script, the&lt;br/&gt;
compiler locates information about the first CREATE TABLE statement and&lt;br/&gt;
re-uses it, but since that cached statement refers to a table that no longer exists,&lt;br/&gt;
the permission checking code gets an NPE trying to look up information about&lt;br/&gt;
the non-existent table.&lt;/p&gt;

&lt;p&gt;If I change the last line of the script to:&lt;br/&gt;
create table t31ConstraintTest (c311 int, c312 int, a int, foreign key(c311, c312) references mamta1.t11ConstraintTest); &lt;br/&gt;
then the problem does not occur. I believe this is because the old statement&lt;br/&gt;
information does not get re-used because the statement text is different.&lt;/p&gt;

&lt;p&gt;I think this means I get to go learn about how prepared statements are cached&lt;br/&gt;
and how that cache is invalidated.&lt;/p&gt;</comment>
                            <comment id="12434592" author="bryanpendleton" created="Thu, 14 Sep 2006 06:31:27 +0100"  >&lt;p&gt;I think that the problem here may be that FKConstraintDefinitionNode, which is the&lt;br/&gt;
compiler implementation code for the &quot;foreign key ... references ... &quot; constraint&lt;br/&gt;
in the compiler, is not properly registering that the statement containing the&lt;br/&gt;
foreign key constraint has a dependency on the table being referenced. Due&lt;br/&gt;
to the lack of the dependency, when the referenced table (t11ConstraintTest)&lt;br/&gt;
is dropped, the statement is not invalidated.&lt;/p&gt;

&lt;p&gt;The following diff seems to make the test script pass. More study and testing&lt;br/&gt;
is needed, plus the construction of a real patch proposal.&lt;/p&gt;

&lt;p&gt;Index: FKConstraintDefinitionNode.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; FKConstraintDefinitionNode.java     (revision 441800)&lt;br/&gt;
+++ FKConstraintDefinitionNode.java     (working copy)&lt;br/&gt;
@@ -104,6 +104,8 @@&lt;/p&gt;

&lt;p&gt;                getConstraintMoniker(),&lt;/p&gt;

&lt;p&gt;                refTableName.getTableName());&lt;/p&gt;

&lt;p&gt;+               getCompilerContext().createDependency(td);&lt;br/&gt;
+&lt;br/&gt;
                // Verify if REFERENCES_PRIV is granted to columns referenced&lt;br/&gt;
                getCompilerContext().pushCurrentPrivType(getPrivType());&lt;/p&gt;</comment>
                            <comment id="12434689" author="mamtas" created="Thu, 14 Sep 2006 15:08:02 +0100"  >&lt;p&gt;Bryan, you definitely look like on the right track with the dependency manager. I was just wondering though if this null pointer exception also happens outside of SQL authorization mode since &quot;foreign key ... references...&quot; gets implemented the same with or without SQL authorization mode. But I have a feeling it might be SQL authorization mode specific otherwise we would have probably run into this npe by now.&lt;/p&gt;</comment>
                            <comment id="12434716" author="mamtas" created="Thu, 14 Sep 2006 16:46:00 +0100"  >&lt;p&gt;Bryan, I tried the following ij session (which is similar to the problem script except that there are no grant revoke statements involved) with connection authorization (ie using the old scheme of authorization in Derby) and didn&apos;t get a null pointer exception. So, this null pointer exception is specifc to SQL authorization mode only.&lt;/p&gt;

&lt;p&gt;$ java org.apache.derby.tools.ij&lt;br/&gt;
ij version 10.3&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta1&apos; as mamta1;&lt;br/&gt;
ij&amp;gt; create table t11ConstraintTest (c111 int not null, c112 int not null, primary key (c111, c112));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:c:/dellater/dbmaintest2;create=true&apos; user &apos;mamta3&apos; as mamta3;&lt;br/&gt;
WARNING 01J01: Database &apos;c:/dellater/dbmaintest2&apos; not created, connection made to existing database instead.&lt;br/&gt;
ij(MAMTA3)&amp;gt; drop table t31ConstraintTest;&lt;br/&gt;
ERROR 42Y07: Schema &apos;MAMTA3&apos; does not exist&lt;br/&gt;
ij(MAMTA3)&amp;gt; create table t31ConstraintTest (c311 int, c312 int, foreign key(c311, c312) references mamta1.t11ConstraintTest);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij(MAMTA3)&amp;gt; drop table t31ConstraintTest;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij(MAMTA3)&amp;gt; set connection mamta1;&lt;br/&gt;
ij(MAMTA1)&amp;gt; drop table t11ConstraintTest;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij(MAMTA1)&amp;gt; create table t11ConstraintTest (c111 int not null, c112 int not null, primary key (c111, c112));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij(MAMTA1)&amp;gt; set connection mamta3;&lt;br/&gt;
ij(MAMTA3)&amp;gt; drop table t31ConstraintTest;&lt;br/&gt;
ERROR 42Y55: &apos;DROP TABLE&apos; cannot be performed on &apos;T31CONSTRAINTTEST&apos; because it does not exist.&lt;br/&gt;
ij(MAMTA3)&amp;gt; create table t31ConstraintTest (c311 int, c312 int, foreign key(c311, c312) references mamta1.t11ConstraintTest);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij(MAMTA3)&amp;gt; exit;&lt;/p&gt;</comment>
                            <comment id="12434722" author="bryanpendleton" created="Thu, 14 Sep 2006 17:21:40 +0100"  >&lt;p&gt;Thanks Mamta! That is very helpful. My feeling is that the basic dependency&lt;br/&gt;
manager issue is generic, but the NPE symptom is specific to SQL Auth. I think&lt;br/&gt;
that without SQL Auth in place, the system is re-using the old prepared statement&lt;br/&gt;
without re-preparing it, but in this case there are no errors that result.&lt;/p&gt;

&lt;p&gt;That is, SQL Auth converts this scenario from &quot;harmless incorrect re-use of an invalid&lt;br/&gt;
prepared statement&quot; to &quot;NPE in permission descriptor handling due to incorrect&lt;br/&gt;
re-use of an invalid prepared statement&quot;.&lt;/p&gt;

&lt;p&gt;I will work up a complete patch with regression tests, comments, etc.&lt;/p&gt;

&lt;p&gt;Thanks again for the feedback and extra testing.&lt;/p&gt;</comment>
                            <comment id="12434729" author="rhillegas" created="Thu, 14 Sep 2006 17:42:24 +0100"  >&lt;p&gt;Downgrading the urgency of this issue. I do not think it should block the release of 10.2.&lt;/p&gt;</comment>
                            <comment id="12435177" author="bryanpendleton" created="Sat, 16 Sep 2006 05:41:44 +0100"  >&lt;p&gt;After some more testing, I think that this patch is a reasonable fix.&lt;br/&gt;
Attached is createDependency.diff, which changes the compiler so&lt;br/&gt;
that it creates a dependency from a statement with a FOREIGN KEY&lt;br/&gt;
clause in it to the table which is referenced by that clause. The patch&lt;br/&gt;
also contains a simple regression test, based on the original bug&lt;br/&gt;
script. derbyall passed without errors.&lt;/p&gt;

&lt;p&gt;Please have  a look and tell me what you think of this patch proposal.&lt;/p&gt;</comment>
                            <comment id="12435540" author="yipng" created="Mon, 18 Sep 2006 18:34:10 +0100"  >&lt;p&gt;I have reviewed the patch and the fix looks reasonable to me.  I confirm that with Bryan&apos;s patch, the NPE no longer occurs and without it, the NPE can be reproduced by the above test.  +1 for commit.&lt;/p&gt;</comment>
                            <comment id="12435609" author="bryanpendleton" created="Tue, 19 Sep 2006 00:51:30 +0100"  >&lt;p&gt;Thanks very much Yip for the review!&lt;/p&gt;

&lt;p&gt;I&apos;ve committed the patch to subversion as revision 447644.&lt;/p&gt;</comment>
                            <comment id="12551383" author="fuzzylogic" created="Thu, 13 Dec 2007 09:05:06 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12346116">DERBY-1523</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12312336">DERBY-464</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12340980" name="createDependency.diff" size="4990" author="bryanpendleton" created="Sat, 16 Sep 2006 05:41:44 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 24 Aug 2006 14:12:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22584</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy1047:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39669</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>