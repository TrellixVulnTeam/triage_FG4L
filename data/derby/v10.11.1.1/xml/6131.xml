<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:48:45 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6131/DERBY-6131.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6131] select from view with &quot;upper&quot; and &quot;in&quot; list throws a ClassCastException</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6131</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;the issue can be reproduced&lt;br/&gt;
1. create table myTbl1 (name varchar(1000));&lt;br/&gt;
2. create table myTbl2 (name varchar(1000));&lt;br/&gt;
3. create view myView (name) as select t1.name from myTbl1 t1 union all select t2.name from myTbl2 t2;&lt;br/&gt;
4. select name from myView where upper(name) in (&apos;AA&apos;, &apos;BB&apos;);&lt;br/&gt;
#4 failed with &quot;org.apache.derby.impl.sql.compile.SimpleStringOperatorNode incompatible with org.apache.derby.impl.sql.compile.ColumnReference: java.lang.ClassCastException&quot;&lt;/p&gt;

&lt;p&gt;If the view is created as &quot;create myView (name) as select t1.name from myTbl1 t1&quot;, the query worked fine.&lt;/p&gt;</description>
                <environment>windows</environment>
        <key id="12639305">DERBY-6131</key>
            <summary>select from view with &quot;upper&quot; and &quot;in&quot; list throws a ClassCastException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikem">Mike Matrigali</assignee>
                                    <reporter username="rqu">Rong Qu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Mar 2013 13:17:37 +0000</created>
                <updated>Wed, 21 Jan 2015 00:22:57 +0000</updated>
                            <resolved>Wed, 10 Apr 2013 20:12:46 +0100</resolved>
                                    <version>10.1.3.3</version>
                    <version>10.2.2.1</version>
                    <version>10.3.3.1</version>
                    <version>10.4.2.1</version>
                    <version>10.5.3.2</version>
                    <version>10.6.2.4</version>
                    <version>10.7.1.4</version>
                    <version>10.8.3.0</version>
                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.3.3</fixVersion>
                    <fixVersion>10.9.2.2</fixVersion>
                    <fixVersion>10.10.2.0</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13615378" author="kmarsden" created="Wed, 27 Mar 2013 15:22:45 +0000"  >&lt;p&gt;I was able to reproduce the issue. Here is the full stack trace:&lt;br/&gt;
ij&amp;gt; select name from myView where upper(name) in (&apos;AA&apos;, &apos;BB&apos;);&lt;br/&gt;
ERROR XJ001: Java exception: &apos;org.apache.derby.impl.sql.compile.SimpleStringOperatorNode incompatible with org.apache.de&lt;br/&gt;
rby.impl.sql.compile.ColumnReference: java.lang.ClassCastException&apos;.&lt;br/&gt;
java.sql.SQLException: Java exception: &apos;org.apache.derby.impl.sql.compile.SimpleStringOperatorNode incompatible with org&lt;br/&gt;
.apache.derby.impl.sql.compile.ColumnReference: java.lang.ClassCastException&apos;.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:98)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:148)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:305)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:436)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:353)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2400)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:85)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:700)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:640)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:367)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:527)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:369)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:245)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:59)&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;org.apache.derby.impl.sql.compile.SimpleStringOperatorNode incompatib&lt;br/&gt;
le with org.apache.derby.impl.sql.compile.ColumnReference: java.lang.ClassCastException&apos;.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:42)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:12&lt;br/&gt;
2)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:71)&lt;br/&gt;
        ... 16 more&lt;br/&gt;
Caused by: java.lang.ClassCastException: org.apache.derby.impl.sql.compile.SimpleStringOperatorNode incompatible with or&lt;br/&gt;
g.apache.derby.impl.sql.compile.ColumnReference&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.PredicateList.pushExpressionsIntoSelect(PredicateList.java:1523)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.UnionNode.pushExpressions(UnionNode.java:354)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ProjectRestrictNode.pushExpressions(ProjectRestrictNode.java:1135)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.FromList.pushPredicates(FromList.java:846)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SelectNode.preprocess(SelectNode.java:1292)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.DMLStatementNode.optimizeStatement(DMLStatementNode.java:300)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.CursorNode.optimizeStatement(CursorNode.java:601)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:457)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:99)&lt;br/&gt;
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConne&lt;br/&gt;
ctionContext.java:1103)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:691)&lt;br/&gt;
        ... 9 more&lt;/p&gt;












































</comment>
                            <comment id="13617459" author="mikem" created="Fri, 29 Mar 2013 16:02:53 +0000"  >&lt;p&gt;the following query using OR rather than IN list works so is a possible workaround:&lt;/p&gt;

&lt;p&gt;select name from myView where upper(name) = (&apos;AA&apos;) or upper(name) = &apos;BB&apos;;&lt;/p&gt;</comment>
                            <comment id="13617461" author="mikem" created="Fri, 29 Mar 2013 16:04:12 +0000"  >&lt;p&gt;i have been looking for a workaround using some sort of casting, any suggestions are welcome.  &lt;/p&gt;</comment>
                            <comment id="13617586" author="rqu" created="Fri, 29 Mar 2013 18:30:09 +0000"  >&lt;p&gt;In our application, the SQL statement (select  .... from viewName where upper() IN ....) is generated at runtime. We understand it can also be done by using &quot;OR&quot;, however, that means we need to change our code as well, hope we could avoid that.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="13617763" author="mikem" created="Fri, 29 Mar 2013 21:55:26 +0000"  >&lt;p&gt;I checked the head of all old branches back to 10.1 and get same crash, so this issue&lt;br/&gt;
is in the original code and not a regression.  It may be architectural in nature, and not&lt;br/&gt;
easy to fix.&lt;/p&gt;</comment>
                            <comment id="13617774" author="mikem" created="Fri, 29 Mar 2013 22:07:15 +0000"  >&lt;p&gt;The following query without the view also works, so view handling interacting with in list is likely causing issue:&lt;/p&gt;

&lt;p&gt;select name from myTbl1 t1 union all select t2.name from myTbl2 t2 where&lt;br/&gt;
    upper(name) in (&apos;AA&apos;, &apos;BB&apos;);&lt;/p&gt;</comment>
                            <comment id="13617888" author="mikem" created="Fri, 29 Mar 2013 23:46:04 +0000"  >&lt;p&gt;working on a fix for this.  &lt;/p&gt;</comment>
                            <comment id="13618884" author="mikem" created="Mon, 1 Apr 2013 17:32:26 +0100"  >&lt;p&gt;I still need to write some tests for this issue.  I think the attached patch just avoids pushing the upper predicate in this case.  It just checks if the operand is a column reference and if not skips the pushdown like other tests in surrounding code.  The comments in the routine seem to indicate that is the intent of the routine, ie. only push consants and thinks that are direct column references.  &lt;/p&gt;

&lt;p&gt;With the change the user example does not throw an exception and a nightly run passed.  &lt;/p&gt;

&lt;p&gt;I want to write a few tests to also make sure the results are as expected.  &lt;/p&gt;

&lt;p&gt;A review from soneone who knows this area would be appreciated.&lt;/p&gt;</comment>
                            <comment id="13620641" author="mamtas" created="Wed, 3 Apr 2013 06:41:15 +0100"  >&lt;p&gt;I reviewed the patch and the changes seems to be in line with the comment at the method level which says&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A predicate can be pushed into an underlying select if the source of&lt;/li&gt;
	&lt;li&gt;every ColumnReference in the predicate is itself a ColumnReference.&lt;br/&gt;
So if the in list left operate is itself not a column reference, then it probably shoul not be pused down. &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have a question about the right operands of the in list. Currently we check if right operand list is list of constant. If yes, then we go ahead and push the predicate. I am wondering ifthat check should be changed to if the right operand list is a list of ColumnReference and or Constants and if so then we should be able to push the predicate down. This can go as a separate jira if it is the right thing to do.&lt;/p&gt;</comment>
                            <comment id="13621156" author="mikem" created="Wed, 3 Apr 2013 19:35:07 +0100"  >&lt;p&gt;attaching new updated patch.  This patch does not alter the code change.  It adds tests and some support routines for the tests.  It passed nighlty, and I plan to commit if there are no more comments by tommorow.&lt;/p&gt;</comment>
                            <comment id="13621160" author="mikem" created="Wed, 3 Apr 2013 19:39:35 +0100"  >&lt;p&gt;mamta, i don&apos;t know the answer to your question.  At this time I would rather concentrate what I commit to what I have as I have tests that exercise that&lt;br/&gt;
codepath.  I know in this case the left operand was the upper call, I don&apos;t know what the right operand was.  Your change suggestion seems right, but would rather it&lt;br/&gt;
go in as a separate jira issue, and hopefully with tests that exercise it.&lt;/p&gt;</comment>
                            <comment id="13621177" author="mikem" created="Wed, 3 Apr 2013 19:51:03 +0100"  >&lt;p&gt;Do note that when this issue is fixed, the query will run but it will not be able to use any indexes, so will have to table scan the tables.  Derby&lt;br/&gt;
provides a couple ways to do case insenstive searching that uses indexes:&lt;br/&gt;
o setting database wide collation to be case insensitive&lt;br/&gt;
o sql generated columns &lt;/p&gt;</comment>
                            <comment id="13621290" author="mamtas" created="Wed, 3 Apr 2013 21:18:46 +0100"  >&lt;p&gt;Mike, I agree about the right operand list investigation/work going into a separate jira.&lt;/p&gt;</comment>
                            <comment id="13622416" author="mikem" created="Thu, 4 Apr 2013 16:28:41 +0100"  >&lt;p&gt;committed fix to trunk as change #1464594&lt;br/&gt;
s1_ibm16:4&amp;gt;svn commit&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\PredicateList.java&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\lang\Derby6131.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang&amp;#95;Suite.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\junit\BaseJDBCTestCase.java&lt;br/&gt;
Transmitting file data ....&lt;br/&gt;
Committed revision 1464594.&lt;/p&gt;</comment>
                            <comment id="13622417" author="mikem" created="Thu, 4 Apr 2013 16:29:21 +0100"  >&lt;p&gt;will be working on backporting this fix to at least 10.8, once nightly&apos;s pass across all systems.&lt;/p&gt;</comment>
                            <comment id="13624451" author="mikem" created="Sat, 6 Apr 2013 16:59:07 +0100"  >&lt;p&gt;back ported fix to 10.10:&lt;br/&gt;
r1465110 | mikem | 2013-04-05 13:11:17 -0700 (Fri, 05 Apr 2013) | 12 lines&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6131&quot; title=&quot;select from view with &amp;quot;upper&amp;quot; and &amp;quot;in&amp;quot; list throws a ClassCastException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6131&quot;&gt;&lt;del&gt;DERBY-6131&lt;/del&gt;&lt;/a&gt; select from view with &quot;upper&quot; and &quot;in&quot; list throws a ClassCastException&lt;/p&gt;

&lt;p&gt;backporting change #1464594 from trunk to 10.10 branch.&lt;/p&gt;

</comment>
                            <comment id="13624456" author="mikem" created="Sat, 6 Apr 2013 17:04:02 +0100"  >&lt;p&gt;backported to 10.9:&lt;br/&gt;
s10_9_ibm16:11&amp;gt;svn commit&lt;br/&gt;
Sending        .&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\PredicateList.java&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\lang\Derby6131.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang&amp;#95;Suite.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\junit\BaseJDBCTestCase.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1465265.&lt;/p&gt;</comment>
                            <comment id="13625063" author="mikem" created="Mon, 8 Apr 2013 01:58:48 +0100"  >&lt;p&gt;backported change to 10.8 branch with change #1465525&lt;br/&gt;
s10_8_ibm17:8&amp;gt;svn commit&lt;br/&gt;
Sending        .&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\PredicateList.java&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\lang\Derby6131.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang&amp;#95;Suite.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\junit\BaseJDBCTestCase.java&lt;br/&gt;
Transmitting file data ...&lt;br/&gt;
Committed revision 1465525.&lt;/p&gt;</comment>
                            <comment id="13628134" author="mikem" created="Wed, 10 Apr 2013 20:12:46 +0100"  >&lt;p&gt;this fix could be backported more, but I am stopping at 10.8 for now.&lt;/p&gt;</comment>
                            <comment id="14284720" author="myrna" created="Wed, 21 Jan 2015 00:22:57 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12576395" name="derby-6131-patch.txt" size="1644" author="mikem" created="Mon, 1 Apr 2013 17:32:26 +0100"/>
                            <attachment id="12576827" name="derby-6131-patch_2.txt" size="13150" author="mikem" created="Wed, 3 Apr 2013 19:35:07 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Mar 2013 15:22:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>319775</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzd0xb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320116</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>