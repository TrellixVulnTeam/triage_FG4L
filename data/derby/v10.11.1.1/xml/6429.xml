<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:19:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6429/DERBY-6429.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6429] Privilege checks for UPDATE statements are wrong.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6429</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;UPDATE statements confuse SELECT and UPDATE privileges. Consider the following SET clause:&lt;/p&gt;

&lt;p&gt;   SET updateColumn = selectColumn&lt;/p&gt;

&lt;p&gt;According to part 2 of the 2011 edition of the SQL Standard, that SET clause requires the following privileges:&lt;/p&gt;

&lt;p&gt;1) UPDATE privilege on updateColumn. Privileges for the left side of a SET clause are described by section 14.14 (update statement: searched), access rule 1b.&lt;/p&gt;

&lt;p&gt;2) SELECT privilege on selectColumn. Privileges for the right side of a SET clause are described by section 14.15 (set clause list) and the various productions underneath value expression. In this case, we have a column reference, whose privileges are governed by section 6.7 (column reference), access rule 2.&lt;/p&gt;

&lt;p&gt;However, Derby requires the following:&lt;/p&gt;

&lt;p&gt;1&apos;) UPDATE privilege on both updateColumn and selectColumn&lt;/p&gt;

&lt;p&gt;When we address this bug, we should make corresponding changes to the MERGE statement.&lt;/p&gt;

&lt;p&gt;The following script shows the current behavior:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;user=test_dbo;create=true&apos;;&lt;/p&gt;

&lt;p&gt;call syscs_util.syscs_create_user( &apos;TEST_DBO&apos;, &apos;test_dbopassword&apos; );&lt;br/&gt;
call syscs_util.syscs_create_user( &apos;RUTH&apos;, &apos;ruthpassword&apos; );&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;shutdown=true&apos;;&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;user=test_dbo;password=test_dbopassword&apos; as dbo;&lt;/p&gt;

&lt;p&gt;create table t1_025&lt;br/&gt;
(&lt;br/&gt;
    a int primary key,&lt;br/&gt;
    updateColumn int,&lt;br/&gt;
    selectColumn int,&lt;br/&gt;
    privateColumn int&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;grant update ( updateColumn ) on t1_025 to ruth;&lt;br/&gt;
grant select ( selectColumn ) on t1_025 to ruth;&lt;/p&gt;

&lt;p&gt;insert into t1_025 values ( 1, 100, 1000, 10000 );&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;user=ruth;password=ruthpassword&apos; as ruth;&lt;/p&gt;

&lt;p&gt;&amp;#8211; correctly succeeds because ruth has UPDATE privilege on updateColumn&lt;br/&gt;
update test_dbo.t1_025 set updateColumn = 17;&lt;/p&gt;

&lt;p&gt;&amp;#8211; the error message incorrectly states that the missing privilege&lt;br/&gt;
&amp;#8211; is UPDATE privilege on privateColumn&lt;br/&gt;
update test_dbo.t1_025 set updateColumn = privateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrectly fails.&lt;br/&gt;
&amp;#8211; ruth does have UPDATE privilege on updateColumn&lt;br/&gt;
&amp;#8211; and SELECT privilege on selectColumn, which should be good enough.&lt;br/&gt;
&amp;#8211; however, the error message incorrectly states that the missing privilege&lt;br/&gt;
&amp;#8211; is UPDATE privilege on selectColumn.&lt;br/&gt;
update test_dbo.t1_025 set updateColumn = selectColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrectly succeeds even though ruth does not have SELECT privilege on updateColumn&lt;br/&gt;
update test_dbo.t1_025 set updateColumn = 2 * updateColumn;&lt;/p&gt;

&lt;p&gt;set connection dbo;&lt;/p&gt;

&lt;p&gt;select * from t1_025 order by a;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12683643">DERBY-6429</key>
            <summary>Privilege checks for UPDATE statements are wrong.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Mon, 9 Dec 2013 17:49:29 +0000</created>
                <updated>Wed, 21 Jan 2015 00:23:52 +0000</updated>
                            <resolved>Thu, 16 Jan 2014 15:50:54 +0000</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                            <comments>
                            <comment id="13844297" author="rhillegas" created="Tue, 10 Dec 2013 14:22:35 +0000"  >&lt;p&gt;Here is a more extensive script, which shows the incorrect permissions behavior of UPDATEs interacting with generated columns, constraints, and triggers.&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;user=test_dbo;create=true&apos;;&lt;/p&gt;

&lt;p&gt;call syscs_util.syscs_create_user( &apos;TEST_DBO&apos;, &apos;test_dbopassword&apos; );&lt;br/&gt;
call syscs_util.syscs_create_user( &apos;RUTH&apos;, &apos;ruthpassword&apos; );&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;shutdown=true&apos;;&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;user=test_dbo;password=test_dbopassword&apos; as dbo;&lt;/p&gt;

&lt;p&gt;create table t2_6429_primary&lt;br/&gt;
(&lt;br/&gt;
    key1 int,&lt;br/&gt;
    key2 int,&lt;br/&gt;
    primary key( key1, key2 )&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create table t1_6429_plain&lt;br/&gt;
(&lt;br/&gt;
    a int primary key,&lt;br/&gt;
    updateColumn int,&lt;br/&gt;
    selectColumn int,&lt;br/&gt;
    privateColumn int&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create table t1_6429_generated&lt;br/&gt;
(&lt;br/&gt;
    a int primary key,&lt;br/&gt;
    updateColumn int,&lt;br/&gt;
    selectColumn int,&lt;br/&gt;
    privateColumn int,&lt;br/&gt;
    generatedColumn generated always as ( -updateColumn )&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create table t1_6429_check&lt;br/&gt;
(&lt;br/&gt;
    a int primary key,&lt;br/&gt;
    updateColumn int,&lt;br/&gt;
    selectColumn int,&lt;br/&gt;
    privateColumn int,&lt;br/&gt;
    checkColumn int,&lt;br/&gt;
    check ( updateColumn &amp;gt; checkColumn )&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create table t1_6429_foreign&lt;br/&gt;
(&lt;br/&gt;
    a int primary key,&lt;br/&gt;
    updateColumn int,&lt;br/&gt;
    selectColumn int,&lt;br/&gt;
    privateColumn int,&lt;br/&gt;
    foreignColumn int,&lt;br/&gt;
    foreign key ( updateColumn, foreignColumn ) references t2_6429_primary( key1, key2 )&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create table t1_6429_trigger&lt;br/&gt;
(&lt;br/&gt;
    a int primary key,&lt;br/&gt;
    updateColumn int,&lt;br/&gt;
    selectColumn int,&lt;br/&gt;
    privateColumn int,&lt;br/&gt;
    triggerContentColumn int&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create procedure addHistoryRow_6429&lt;br/&gt;
(&lt;br/&gt;
    actionString varchar( 20 ),&lt;br/&gt;
    actionValue int&lt;br/&gt;
)&lt;br/&gt;
language java parameter style java reads sql data&lt;br/&gt;
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.MergeStatementTest.addHistoryRow&apos;;&lt;/p&gt;

&lt;p&gt;create trigger t1_6429_upd_before&lt;br/&gt;
no cascade before update of updateColumn on t1_6429_trigger&lt;br/&gt;
referencing old as old&lt;br/&gt;
for each row&lt;br/&gt;
call addHistoryRow_6429( &apos;before&apos;, old.triggerContentColumn );&lt;/p&gt;

&lt;p&gt;grant update ( updateColumn ) on t1_6429_plain to ruth;&lt;br/&gt;
grant select ( selectColumn ) on t1_6429_plain to ruth;&lt;/p&gt;

&lt;p&gt;grant update ( updateColumn ) on t1_6429_generated to ruth;&lt;br/&gt;
grant select ( selectColumn ) on t1_6429_generated to ruth;&lt;/p&gt;

&lt;p&gt;grant update ( updateColumn ) on t1_6429_check to ruth;&lt;br/&gt;
grant select ( selectColumn ) on t1_6429_check to ruth;&lt;/p&gt;

&lt;p&gt;grant update ( updateColumn ) on t1_6429_foreign to ruth;&lt;br/&gt;
grant select ( selectColumn ) on t1_6429_foreign to ruth;&lt;/p&gt;

&lt;p&gt;grant update ( updateColumn ) on t1_6429_trigger to ruth;&lt;br/&gt;
grant select ( selectColumn ) on t1_6429_trigger to ruth;&lt;br/&gt;
grant select ( triggerContentColumn ) on t1_6429_trigger to ruth;&lt;br/&gt;
grant execute on procedure addHistoryRow_6429 to ruth;&lt;/p&gt;

&lt;p&gt;insert into t2_6429_primary values ( 100, 1 ), ( 17, 1 ), ( 34, 1 );&lt;/p&gt;

&lt;p&gt;insert into t1_6429_plain( a, updateColumn, selectColumn, privateColumn ) values ( 1, 100, 1000, 10000 );&lt;br/&gt;
insert into t1_6429_generated( a, updateColumn, selectColumn, privateColumn ) values ( 1, 100, 1000, 10000 );&lt;br/&gt;
insert into t1_6429_check( a, updateColumn, selectColumn, privateColumn, checkColumn ) values ( 1, 100, 1000, 10000, -1000 );&lt;br/&gt;
insert into t1_6429_foreign( a, updateColumn, selectColumn, privateColumn, foreignColumn ) values ( 1, 100, 1000, 10000, 1 );&lt;br/&gt;
insert into t1_6429_trigger( a, updateColumn, selectColumn, privateColumn, triggerContentColumn ) values ( 1, 100, 1000, 10000, 1 );&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:memory:db;user=ruth;password=ruthpassword&apos; as ruth;&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
-- plain&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;&amp;#8211; correct. succeeds.&lt;br/&gt;
update test_dbo.t1_6429_plain set updateColumn = 17;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; the error message incorrectly states that the missing privilege&lt;br/&gt;
&amp;#8211; is UPDATE privilege on privateColumn&lt;br/&gt;
update test_dbo.t1_6429_plain set updateColumn = privateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; ruth does have UPDATE privilege on updateColumn&lt;br/&gt;
&amp;#8211; and SELECT privilege on selectColumn, which should be good enough.&lt;br/&gt;
&amp;#8211; however, the error message incorrectly states that the missing privilege&lt;br/&gt;
&amp;#8211; is UPDATE privilege on selectColumn.&lt;br/&gt;
update test_dbo.t1_6429_plain set updateColumn = selectColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect. should not succeed. ruth does not have SELECT privilege on updateColumn&lt;br/&gt;
update test_dbo.t1_6429_plain set updateColumn = 2 * updateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
-- generated&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; sometimes fails because Derby wants UPDATE priv for generatedColumn.&lt;br/&gt;
&amp;#8211; sometimes fails because Derby wants SELECT permission on updateColumn.&lt;br/&gt;
update test_dbo.t1_6429_generated set updateColumn = 17;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; sometimes fails because Derby wants UPDATE priv for generatedColumn.&lt;br/&gt;
&amp;#8211; sometimes fails because Derby wants SELECT permission on updateColumn.&lt;br/&gt;
update test_dbo.t1_6429_generated set updateColumn = privateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have SELECT permission on updateColumn&lt;br/&gt;
update test_dbo.t1_6429_generated set updateColumn = selectColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect. should fail because ruth does not have SELECT privilege on updateColumn&lt;br/&gt;
update test_dbo.t1_6429_generated set updateColumn = 2 * updateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
-- check&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on checkColumn&lt;br/&gt;
update test_dbo.t1_6429_check set updateColumn = 17;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on privateColumn&lt;br/&gt;
update test_dbo.t1_6429_check set updateColumn = privateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on selectColumn&lt;br/&gt;
update test_dbo.t1_6429_check set updateColumn = selectColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
-- incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on checkColumn&lt;br/&gt;
update test_dbo.t1_6429_check set updateColumn = 2 * updateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
-- foreign&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on foreignColumn&lt;br/&gt;
update test_dbo.t1_6429_foreign set updateColumn = 17;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on privateColumn&lt;br/&gt;
update test_dbo.t1_6429_foreign set updateColumn = privateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on selectColumn&lt;br/&gt;
update test_dbo.t1_6429_foreign set updateColumn = selectColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on foreignColumn&lt;br/&gt;
update test_dbo.t1_6429_foreign set updateColumn = 2 * updateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
-- trigger&lt;br/&gt;
&amp;#8211;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on triggerContentColumn&lt;br/&gt;
update test_dbo.t1_6429_trigger set updateColumn = 17;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on privateColumn&lt;br/&gt;
update test_dbo.t1_6429_trigger set updateColumn = privateColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on selectColumn&lt;br/&gt;
update test_dbo.t1_6429_trigger set updateColumn = selectColumn;&lt;/p&gt;

&lt;p&gt;&amp;#8211; incorrect.&lt;br/&gt;
&amp;#8211; fails because ruth does not have UPDATE permission on triggerContentColumn&lt;br/&gt;
update test_dbo.t1_6429_trigger set updateColumn = 2 * updateColumn;&lt;/p&gt;

&lt;p&gt;set connection dbo;&lt;/p&gt;

&lt;p&gt;select * from t1_6429_plain order by a;&lt;br/&gt;
select * from t1_6429_generated order by a;&lt;br/&gt;
select * from t1_6429_check order by a;&lt;br/&gt;
select * from t1_6429_foreign order by a;&lt;br/&gt;
select * from t1_6429_trigger order by a;&lt;/p&gt;</comment>
                            <comment id="13844457" author="rhillegas" created="Tue, 10 Dec 2013 17:44:29 +0000"  >&lt;p&gt;Here are my thoughts about how foreign keys, generated columns, check constraints, and triggers affect the permissions needed to execute an UPDATE statement. Does anyone have a different opinion?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;

&lt;p&gt;-----------------------------------------&lt;/p&gt;

&lt;p&gt;Foreign Keys&lt;/p&gt;

&lt;p&gt;Permissions for foreign keys are checked when the foreign key is declared. The owner of the foreign table must have REFERENCES privilege on the referenced columns in the primary key table. See part 2, section 11.8 (referential constraint definition), access rule 1. No further permissions checking is required at execution time. I do not see any language indicating that foreign keys become invalid or un-runnable if the owner of the foreign table later loses REFERENCES privilege on the referenced columns. I do not see any indication that the user issuing the UPDATE statement is required to have SELECT privilege on the referenced columns.&lt;/p&gt;


&lt;p&gt;-----------------------------------------&lt;/p&gt;

&lt;p&gt;Generated Columns&lt;/p&gt;

&lt;p&gt;There are two kinds of permissions related to generation clauses:&lt;/p&gt;

&lt;p&gt;G1) SELECT permission on the columns mentioned in the generation clause. I do not see any language in the Standard suggesting that you need explicit SELECT permission on all of the columns mentioned by the generation clause. That permission seems to be implied by the INSERT privilege you enjoy  on the table and the UPDATE privilege you may enjoy on a column mentioned by the generation clause.&lt;/p&gt;

&lt;p&gt;G2) EXECUTE permission on functions invoked by the generation clause. This is addressed by part 2, section 4.28.3 (Execution of SQL-invoked routines). The user executing the UPDATE statement must enjoy EXECUTE permission on the functions invoked by the generation clause if the generation clause is run as a consequence of UPDATing a column.&lt;/p&gt;


&lt;p&gt;-----------------------------------------&lt;/p&gt;

&lt;p&gt;Check Constraints&lt;/p&gt;

&lt;p&gt;Similarly, there are two kinds of permissions related to CHECK constraints:&lt;/p&gt;

&lt;p&gt;C1) SELECT permission on the columns mentioned in the CHECK constraint. I do not see any language in the Standard suggesting that you need explicit SELECT permission on all of the columns mentioned by the CHECK constraint. That permission seems to be implied by the INSERT privilege you enjoy  on the table and the UPDATE privilege you may enjoy on a column mentioned by the CHECK constraint.&lt;/p&gt;

&lt;p&gt;C2) EXECUTE permission on functions invoked by the CHECK constraint. This is addressed by part 2, section 4.28.3 (Execution of SQL-invoked routines). The user executing the UPDATE statement must enjoy EXECUTE permission on the functions invoked by the CHECK constraint.&lt;/p&gt;


&lt;p&gt;-----------------------------------------&lt;/p&gt;

&lt;p&gt;Triggers&lt;/p&gt;

&lt;p&gt;There are two kinds of permissions related to triggers:&lt;/p&gt;

&lt;p&gt;T1) The permission to SELECT columns from the source table in order to construct transition variables and transition tables. These permissions are described by part 2 of the Standard, section 11.49 (trigger definition), access rule 3. In order to declare a trigger, the trigger owner must have SELECT privilege on the whole source table if the trigger has transition variables or tables. It is my understanding that the SELECTion of source columns at runtime happens under the original aegis of the trigger owner. Moreover, I don&apos;t see any language suggesting that the trigger becomes un-runnable if the trigger owner later loses TRIGGER and/or SELECT privilege on the source table. &lt;/p&gt;

&lt;p&gt;T2) The permission to execute the trigger action. I can&apos;t find any language specifying special treatment of permissions for the trigger action. I believe that the trigger action runs with the privileges of the user who invoked the original, triggering INSERT/UPDATE/DELETE.&lt;/p&gt;</comment>
                            <comment id="13844677" author="dagw" created="Tue, 10 Dec 2013 21:15:24 +0000"  >&lt;p&gt;&amp;gt; -----------------------------------------&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; Foreign Keys&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; Permissions for foreign keys are checked when the foreign key is&lt;br/&gt;
&amp;gt; declared. The owner of the foreign table must have REFERENCES&lt;br/&gt;
&amp;gt; privilege on the referenced columns in the primary key table. &lt;/p&gt;

&lt;p&gt;&quot;have&quot; meaning have a privilege granted (to user of PUBLIC), or&lt;br/&gt;
granted to the current role, right?&lt;/p&gt;

&lt;p&gt;&amp;gt; See part 2, section 11.8 (referential constraint definition), access&lt;br/&gt;
&amp;gt; rule 1. No further permissions checking is required at execution&lt;br/&gt;
&amp;gt; time. I do not see any language indicating that foreign keys become&lt;br/&gt;
&amp;gt; invalid or un-runnable if the owner of the foreign table later loses&lt;br/&gt;
&amp;gt; REFERENCES privilege on the referenced columns. &lt;/p&gt;

&lt;p&gt;Hmm.. this seems wrong to me. I&apos;d expect this dependency to be&lt;br/&gt;
tracked, and Derby to barf (with RESTRICT semantics by default) when&lt;br/&gt;
that privilege was revoked (or cascades as the case might be)...&lt;/p&gt;

&lt;p&gt;&amp;gt; I do not see any&lt;br/&gt;
&amp;gt; indication that the user issuing the UPDATE statement is required to&lt;br/&gt;
&amp;gt; have SELECT privilege on the referenced columns.&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; -----------------------------------------&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; Generated Columns&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; There are two kinds of permissions related to generation clauses:&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; G1) SELECT permission on the columns mentioned in the generation&lt;br/&gt;
&amp;gt; clause. I do not see any language in the Standard suggesting that you&lt;br/&gt;
&amp;gt; need explicit SELECT permission on all of the columns mentioned by the&lt;br/&gt;
&amp;gt; generation clause. That permission seems to be implied by the INSERT&lt;br/&gt;
&amp;gt; privilege you enjoy on the table and the UPDATE privilege you may&lt;br/&gt;
&amp;gt; enjoy on a column mentioned by the generation clause.&lt;/p&gt;

&lt;p&gt;Makes sense to me.&lt;/p&gt;

&lt;p&gt;&amp;gt; G2) EXECUTE permission on functions invoked by the generation&lt;br/&gt;
&amp;gt; clause. This is addressed by part 2, section 4.28.3 (Execution of&lt;br/&gt;
&amp;gt; SQL-invoked routines). The user executing the UPDATE statement must&lt;br/&gt;
&amp;gt; enjoy EXECUTE permission on thes functions invoked by the generation&lt;br/&gt;
&amp;gt; clause if the generation clause is run as a consequence of UPDATing a&lt;br/&gt;
&amp;gt; column.&lt;/p&gt;

&lt;p&gt;Hmm.. this doesn&apos;t seem right to me. I would have thought the&lt;br/&gt;
definer/owner of the table containing the generation clause would&lt;br/&gt;
carry that burden alone. In section 10.4 6 SR 6 a), the wording is &lt;/p&gt;

&lt;p&gt;&quot;If RI is contained in an &amp;lt;SQL schema statement&amp;gt;, then an SQL-invoked&lt;br/&gt;
routine R is an executable routine if and only if R is a possibly&lt;br/&gt;
candidate routine and the applicable privileges for the &amp;lt;authorization&lt;br/&gt;
identifier&amp;gt; that owns the containing schema include EXECUTE on R.&quot;&lt;/p&gt;

&lt;p&gt;A create table statement is a SQL schema statement, so I think the&lt;br/&gt;
above will apply?&lt;/p&gt;


&lt;p&gt;&amp;gt; &lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; -----------------------------------------&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; Check Constraints&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; Similarly, there are two kinds of permissions related to CHECK constraints:&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; C1) SELECT permission on the columns mentioned in the CHECK&lt;br/&gt;
&amp;gt; constraint. I do not see any language in the Standard suggesting&lt;br/&gt;
&amp;gt; that you need explicit SELECT permission on all of the columns&lt;br/&gt;
&amp;gt; mentioned by the CHECK constraint. That permission seems to be&lt;br/&gt;
&amp;gt; implied by the INSERT privilege you enjoy on the table and the&lt;br/&gt;
&amp;gt; UPDATE privilege you may enjoy on a column mentioned by the CHECK&lt;br/&gt;
&amp;gt; constraint.&lt;/p&gt;

&lt;p&gt;Again, makes sense.&lt;/p&gt;

&lt;p&gt;&amp;gt; &lt;br/&gt;
&amp;gt; C2) EXECUTE permission on functions invoked by the CHECK&lt;br/&gt;
&amp;gt; constraint. This is addressed by part 2, section 4.28.3 (Execution&lt;br/&gt;
&amp;gt; of SQL-invoked routines). The user executing the UPDATE statement&lt;br/&gt;
&amp;gt; must enjoy EXECUTE permission on the functions invoked by the CHECK&lt;br/&gt;
&amp;gt; constraint.&lt;/p&gt;

&lt;p&gt;Same objection as above for generation clause.&lt;/p&gt;



&lt;p&gt;&amp;gt; -----------------------------------------&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; Triggers&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; There are two kinds of permissions related to triggers:&lt;br/&gt;
&amp;gt; &lt;br/&gt;
&amp;gt; T1) The permission to SELECT columns from the source table in order&lt;br/&gt;
&amp;gt; to construct transition variables and transition tables. These&lt;br/&gt;
&amp;gt; permissions are described by part 2 of the Standard, section 11.49&lt;br/&gt;
&amp;gt; (trigger definition), access rule 3. In order to declare a trigger,&lt;br/&gt;
&amp;gt; the trigger owner must have SELECT privilege on the whole source&lt;br/&gt;
&amp;gt; table if the trigger has transition variables or tables. It is my&lt;br/&gt;
&amp;gt; understanding that the SELECTion of source columns at runtime&lt;br/&gt;
&amp;gt; happens under the original aegis of the trigger owner. Moreover, I&lt;br/&gt;
&amp;gt; don&apos;t see any language suggesting that the trigger becomes&lt;br/&gt;
&amp;gt; un-runnable if the trigger owner later loses TRIGGER and/or SELECT&lt;br/&gt;
&amp;gt; privilege on the source table.&lt;/p&gt;

&lt;p&gt;Again, I&apos;d expect a revoke to barf in this case unless we have drop&lt;br/&gt;
cascading...&lt;/p&gt;

&lt;p&gt;&amp;gt; &lt;br/&gt;
&amp;gt; T2) The permission to execute the trigger action. I can&apos;t find any&lt;br/&gt;
&amp;gt; language specifying special treatment of permissions for the trigger&lt;br/&gt;
&amp;gt; action. I believe that the trigger action runs with the privileges&lt;br/&gt;
&amp;gt; of the user who invoked the original, triggering&lt;br/&gt;
&amp;gt; INSERT/UPDATE/DELETE.&lt;/p&gt;

&lt;p&gt;Yes, that is my understanding, too.&lt;/p&gt;</comment>
                            <comment id="13844813" author="mamtas" created="Tue, 10 Dec 2013 23:25:15 +0000"  >&lt;p&gt;I went through the SQL spec for UPDATE statement with simple columns (ie with no special clause on the columns involved in the SET clause) and the spec interpretation seems right that the column on the left would require UPDATE privilege and column on the right will require SELECT privilege.&lt;/p&gt;

&lt;p&gt;As for unique cases for foreign keys,and trigger action, with a quick glance at the spec, from a quick glance at the spec, I was also not able to find information in the spec about what would happen if the REFERENCES or TRIGGER privileges are revoked. It would seem that Derby will/should catch the existing dependencies when those privileges are revoked and  revoke would fail.&lt;/p&gt;

&lt;p&gt;I have question about generated column &quot;permission related to generation clause : SELECT permission on the columns mentioned in the generation clause. I do not see any language in the Standard suggesting that you need explicit SELECT permission on all of the columns mentioned by the generation clause. That permission seems to be implied by the INSERT privilege you enjoy on the table and the UPDATE privilege you may enjoy on a column mentioned by the generation clause. &quot; I don&apos;t quite understand what you mean by &quot;the UPDATE privilege you may enjoy on a column mentioned by the generation clause.&quot;&lt;/p&gt;</comment>
                            <comment id="13845382" author="rhillegas" created="Wed, 11 Dec 2013 13:21:08 +0000"  >&lt;p&gt;Thanks for the feedback, Dag and Mamta. Dag, I will respond to your comments later.&lt;/p&gt;

&lt;p&gt;Hi Mamta,&lt;/p&gt;

&lt;p&gt;I&apos;m sorry about that confusing wording. I was trying to say the following:&lt;/p&gt;

&lt;p&gt;Given the following definition...&lt;/p&gt;

&lt;p&gt;create table fred.t&lt;br/&gt;
(&lt;br/&gt;
    a int,&lt;br/&gt;
    b int,&lt;br/&gt;
    c generated always as ( a + b )&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;...RUTH can issue the following UDPATE...&lt;/p&gt;

&lt;p&gt;update fred.t set a = 1;&lt;/p&gt;

&lt;p&gt;...provided that she enjoys the following GRANT...&lt;/p&gt;

&lt;p&gt;grant update ( a ) on fred.t to ruth;&lt;/p&gt;

&lt;p&gt;...and she does not need the following additional GRANTs...&lt;/p&gt;

&lt;p&gt;grant select ( b ) on fred.t to ruth;&lt;br/&gt;
grant update ( c ) on fred.t to ruth;&lt;/p&gt;

&lt;p&gt;Hope that&apos;s less confusing.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13845426" author="rhillegas" created="Wed, 11 Dec 2013 14:18:34 +0000"  >&lt;p&gt;Thanks again for the feedback, Dag. Let me continue the discussion of privileges related to foreign keys.&lt;/p&gt;

&lt;p&gt;-----------------------------&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; &quot;have&quot; meaning have a privilege granted (to user of PUBLIC), or&lt;br/&gt;
&amp;gt;&amp;gt; granted to the current role, right?&lt;/p&gt;

&lt;p&gt;Part 2, section 11.8 (referential constraint definition), access rule 1 is all I have to go on:&lt;/p&gt;

&lt;p&gt;&quot;The applicable privileges for the owner of T shall include REFERENCES for each referenced column.&quot;&lt;/p&gt;

&lt;p&gt;Note that the Standard is talking about the privileges of the owner of T, not the privileges of the person issuing the DDL. So consider the following statements issued by the DBO:&lt;/p&gt;

&lt;p&gt;create table alice.primaryTable&lt;br/&gt;
(&lt;br/&gt;
    a int primary key&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;grant references ( a ) on table alice.primary to ref_role;&lt;/p&gt;

&lt;p&gt;grant ref_role to fred;&lt;/p&gt;

&lt;p&gt;Now suppose that the DBO issues the following statement:&lt;/p&gt;

&lt;p&gt;create table fred.foreignTable&lt;br/&gt;
(&lt;br/&gt;
    b int references alice.primaryTable( a )&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;I don&apos;t think that FRED has a meaningful default role here which can be used to supplement the privileges needed for this statement. I think that the CREATE TABLE statement should fail. The following GRANT is needed to make it succeed:&lt;/p&gt;

&lt;p&gt;grant references ( a ) on table alice.primary to fred;&lt;/p&gt;

&lt;p&gt;-----------------------------&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; Hmm.. this seems wrong to me. I&apos;d expect this dependency to be&lt;br/&gt;
&amp;gt;&amp;gt; tracked, and Derby to barf (with RESTRICT semantics by default) when&lt;br/&gt;
&amp;gt;&amp;gt; that privilege was revoked (or cascades as the case might be)...&lt;/p&gt;

&lt;p&gt;Yes, I agree with you. The following statement will fail...&lt;/p&gt;

&lt;p&gt;revoke references ( a ) on table alice.primary from fred restrict;&lt;/p&gt;

&lt;p&gt;...if the foreign key was created. The following statement will drop the foreign key...&lt;/p&gt;

&lt;p&gt;revoke references ( a ) on table alice.primary from fred cascade;&lt;/p&gt;

&lt;p&gt;That, at least, is my reading of the extensive general rules in part 2, section 12.7 (revoke statement).&lt;/p&gt;

&lt;p&gt;Note that all of this is orthogonal to the privileges required for an UPDATE of fred.foreignTable. If there is a foreign key, it imposes no privilege-checking burden on an UPDATE statement. The UPDATE statement may need to be re-compiled if a foreign key is added or dropped, but the foreign key does not add any privilege checks to the UPDATE statement.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13845428" author="rhillegas" created="Wed, 11 Dec 2013 14:22:50 +0000"  >&lt;p&gt;Thanks again for the feedback, Dag. Let me continue the discussion of privileges related to triggers.&lt;/p&gt;

&lt;p&gt;-----------------------------&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; Again, I&apos;d expect a revoke to barf in this case unless we have drop&lt;br/&gt;
&amp;gt;&amp;gt; cascading...&lt;/p&gt;

&lt;p&gt;Yes, I agree with you.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13846484" author="rhillegas" created="Thu, 12 Dec 2013 17:38:07 +0000"  >&lt;p&gt;In offline conversations with Dag, Knut, Dyre, and Kim, I have come to the conclusion that the authorization context stack (described in the 2011 SQL Standard, part 2, section 4.28.3 (Execution of SQL-invoked routines)) refers to the pushing of a new authorization context AFTER you enter a routine and start executing nested SQL statements inside it. I cannot find any language in the Standard suggesting that the user who issues an INSERT/UPDATE/MERGE statement must have privilege to run routines invoked by CHECK constraints or generated columns. Those routines execute under the aegis of the table owner. So I agree with Dag that we should strike the privilege restrictions mentioned in C2 and G2 above.&lt;/p&gt;

&lt;p&gt;I also think we should strike claim T2 above. The SQL Standard explicitly states that triggered actions execute under the aegis of the trigger owner. Here is the relevant language from the 2011 SQL Standard, part 2, section 4.39.1 (General description of triggers):&lt;/p&gt;

&lt;p&gt;&quot;A triggered action is always executed under the authorization of the owner of the schema that includes the trigger.&quot;&lt;/p&gt;

&lt;p&gt;Much of this is asserted by the Developer&apos;s Guide section titled &quot;Privileges on views, triggers, and constraints&quot;: &lt;a href=&quot;http://db.apache.org/derby/docs/10.10/devguide/cdevcsecureprivileges.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/docs/10.10/devguide/cdevcsecureprivileges.html&lt;/a&gt;. That section should be expanded to include generated columns as expressions which execute under the aegis of the table owner.    &lt;/p&gt;</comment>
                            <comment id="13846518" author="rhillegas" created="Thu, 12 Dec 2013 18:06:28 +0000"  >&lt;p&gt;As a result of the discussion over the past couple days, I have come to the conclusion that constraints, generated columns, and triggers do not impose any privilege burdens on INSERT/UPDATE/DELETE/MERGE statements. The privilege burdens related to constraints, generated columns, and triggers are satisfied at DDL time.&lt;/p&gt;

&lt;p&gt;As a result, I would revise the privilege requirements for UPDATE statements as follows. Let P be the union of the privileges granted to the current user and the privileges granted to the current role.&lt;/p&gt;

&lt;p&gt;1) P must contain UPDATE privilege for all columns on the left side of SET operators.&lt;/p&gt;

&lt;p&gt;2) P must contain all privileges needed to evaluate the right side of SET operators and run the WHERE clause. That includes:&lt;/p&gt;

&lt;p&gt;a) SELECT privilege on all columns mentioned on the right side of SET operators and by the WHERE clause&lt;/p&gt;

&lt;p&gt;b) EXECUTE privilege on all functions invoked on the right side of SET operators and by the WHERE clause&lt;/p&gt;

&lt;p&gt;c) USAGE privilege on all types, sequences, and aggregates mentioned on the right side of SET operators and by the WHERE clause.&lt;/p&gt;

&lt;p&gt;Other opinions?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13854291" author="rhillegas" created="Fri, 20 Dec 2013 17:45:30 +0000"  >&lt;p&gt;Attaching derby-6429-01-ab-privilegeFilters.diff. This is a preliminary version of a fix to this bug. I expect that errors will pop up when I run the full regression tests. In addition, I plan to write additional tests. I&apos;m attaching this preliminary version because I think it is a promising approach.&lt;/p&gt;

&lt;p&gt;My first attempt to fix this bug failed. This is what I tried inside UpdateNode.bindStatement():&lt;/p&gt;

&lt;p&gt;1) Analyze - Collect a list of all the nodes which should give rise to privilege checks.&lt;/p&gt;

&lt;p&gt;2) Bind - Continue binding as usual.&lt;/p&gt;

&lt;p&gt;3) Rebind - At the end of UpdateNode.bindStatement(), create a new CompilerContext and rebind just the nodes which were identified in step 1.&lt;/p&gt;

&lt;p&gt;This approach failed because step 2 ended up changing the AST in a way which made it impossible to determine the correct permissions during step 3 for certain edge-cases. These cases involved views.&lt;/p&gt;

&lt;p&gt;The current patch does something subtler:&lt;/p&gt;

&lt;p&gt;1&apos;) Analyze - Mark all nodes which should give rise to privilege checks at run time.&lt;/p&gt;

&lt;p&gt;2&apos;) Bind - Bind as usual. However, only add privilege checks for the nodes marked during step 1&apos;.&lt;/p&gt;

&lt;p&gt;3&apos;) Rebind - Rebind UDT references. These can occur on any ValueNode and so can&apos;t be picked up during step 1&apos;.&lt;/p&gt;

&lt;p&gt;The patch introduces the following abstractions:&lt;/p&gt;

&lt;p&gt;VisitableFilter - This is a generic filter for qualifying QueryTreeNodes&lt;/p&gt;

&lt;p&gt;QueryTreeNode tags - QueryTreeNodes can be tagged for various purposes now.&lt;/p&gt;

&lt;p&gt;The patch works by tagging QueryTreeNodes during step 1&apos; and then only compiling privilege checks for nodes which pass a TagFilter during step 2&apos;.&lt;/p&gt;

&lt;p&gt;I am hoping that VisitableFilters and QueryTreeNode tags are general tools which may be useful for other purposes.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;A       java/engine/org/apache/derby/iapi/sql/compile/TagFilter.java&lt;br/&gt;
M       java/engine/org/apache/derby/iapi/sql/compile/Visitable.java&lt;br/&gt;
A       java/engine/org/apache/derby/iapi/sql/compile/VisitableFilter.java&lt;/p&gt;

&lt;p&gt;Support for filtering QueryTreeNodes based on tags.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/compile/CompilerContext.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/CompilerContextImpl.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java&lt;/p&gt;

&lt;p&gt;Adds the ability to declare filters for privilege checking.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/UpdateNode.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/FromBaseTable.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/StaticMethodCallNode.java&lt;/p&gt;

&lt;p&gt;Changes to limit which QueryTreeNodes give rise to privilege checks for UPDATE statements.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GeneratedColumnsHelper.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby5234Test.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/junit/BaseJDBCTestCase.java&lt;/p&gt;

&lt;p&gt;Moves some helper methods which I&apos;ve been using for years. I want to use these helper method in other test classes, so I&apos;m moving the methods up to BaseJDBCTestCase.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/UDTTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java&lt;/p&gt;

&lt;p&gt;New test for this patch.&lt;/p&gt;</comment>
                            <comment id="13854462" author="rhillegas" created="Fri, 20 Dec 2013 19:26:12 +0000"  >&lt;p&gt;Attaching derby-6429-01-ac-privilegeFilters.diff. The previous rev of the patch tripped some errors:&lt;/p&gt;

&lt;p&gt;1) An NPE introduced by the patch&lt;/p&gt;

&lt;p&gt;2) A number of wrong results which had been canonized in in privilege tests.&lt;/p&gt;

&lt;p&gt;The new patch addresses these problems and touches the following additional file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GeneratedColumnsPermsTest.java&lt;/p&gt;</comment>
                            <comment id="13855607" author="knutanders" created="Mon, 23 Dec 2013 12:47:50 +0000"  >&lt;p&gt;Thanks for looking into this bug, Rick. Your approach sounds good to me.&lt;/p&gt;

&lt;p&gt;When I looked through the patch the first time, I was a little confused by some of the naming. Nothing major, but here&apos;s what confused me:&lt;/p&gt;

&lt;p&gt;1) I had a hard time wrapping my head around the new concept of &quot;visitable tags&quot;. Until I found out there was no such thing as a &quot;visitable tag&quot;. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; It became much clearer to me when I learnt to read &quot;addVisitableTag&quot; as &quot;add a tag to this visitable&quot; instead of &quot;add a visitable tag&quot;. Maybe dropping &quot;visitable&quot; (which is redundant, anyway, since the methods live in the Visitable interface) and calling the new methods &quot;addTag&quot; and &quot;getTags&quot; would be sufficient?&lt;/p&gt;

&lt;p&gt;2) TagFilter.UPDATE_PRIVS is very similar to Authorizer.UPDATE_PRIV. However, the nodes that get tagged with UPDATE_PRIVS will actually be checked for SELECT_PRIV. Maybe the constant in TagFilter could be called something that more clearly states that it is for privilege checking of the UPDATE statement (as opposed to checking that the UPDATE privilege is granted).&lt;/p&gt;

&lt;p&gt;Some more nits:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TagFilter.accept() could have called visitableTags.contains(_tag) instead of doing it manually in a for loop.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Maybe it would be a cleaner interface to have&lt;br/&gt;
  boolean hasTag(String tag)&lt;br/&gt;
  instead of the method that returns the list of tags in the Visitable interface. That would avoid exposing the internal representation through the interface method (which some static code analyzers tend to frown upon and flag as potential security warnings), and it would simplify two of the three callers of getVisitableTags(). (The third caller, StaticMethodCallNode, still needs the list of tags in order to copy it, but this could be done using a package-private method in QTN instead of via the interface.)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13855622" author="knutanders" created="Mon, 23 Dec 2013 13:18:28 +0000"  >&lt;p&gt;I ran the following test on the patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij version 10.11
ij&amp;gt; connect &apos;jdbc:derby:memory:db;create=true;user=dbo&apos;;
ij&amp;gt; call syscs_util.syscs_set_database_property(&apos;derby.database.sqlAuthorization&apos;, &apos;true&apos;);
0 rows inserted/updated/deleted
ij&amp;gt; connect &apos;jdbc:derby:memory:db;shutdown=true&apos;;
ERROR 08006: Database &apos;memory:db&apos; shutdown.
ij&amp;gt; connect &apos;jdbc:derby:memory:db;user=u1&apos; as u1;
WARNING 01J14: SQL authorization is being used without first enabling authentication.
ij(U1)&amp;gt; create table t1(x int, y int, z int);
0 rows inserted/updated/deleted
ij(U1)&amp;gt; grant update on t1 to u2;
0 rows inserted/updated/deleted
ij(U1)&amp;gt; connect &apos;jdbc:derby:memory:db;user=u2&apos; as u2;
WARNING 01J14: SQL authorization is being used without first enabling authentication.
ij(U2)&amp;gt; update u1.t1 set x = y;
0 rows inserted/updated/deleted
WARNING 02000: No row was found for FETCH, UPDATE or DELETE; or the result of a query is an empty table.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Shouldn&apos;t the UPDATE statement have failed because U2 didn&apos;t have SELECT permission on U1.T1(Y)?&lt;/p&gt;</comment>
                            <comment id="13855651" author="rhillegas" created="Mon, 23 Dec 2013 14:06:06 +0000"  >&lt;p&gt;Thanks for those excellent suggestions, Knut. Attaching derby-6429-01-ad-privilegeFilters.diff, which makes the following changes:&lt;/p&gt;

&lt;p&gt;1) Visitable.addVisitableTag() is renamed to addTag()&lt;/p&gt;

&lt;p&gt;2) Visitable.getVisitableTags() is replaced with taggedWith()&lt;/p&gt;

&lt;p&gt;3) New copyTagsFrom() method is added to QueryTreeNode&lt;/p&gt;

&lt;p&gt;4) TagFilter.UPDATE_PRIVS is renamed to NEED_PRIVS_FOR_UPDATE_STMT&lt;/p&gt;</comment>
                            <comment id="13855655" author="rhillegas" created="Mon, 23 Dec 2013 14:10:57 +0000"  >&lt;p&gt;Thanks for test-driving this patch, Knut. I am able to reproduce the behavior you are seeing. It&apos;s wrong. I&apos;ll look into it. Thanks.&lt;/p&gt;</comment>
                            <comment id="13855673" author="rhillegas" created="Mon, 23 Dec 2013 15:01:01 +0000"  >&lt;p&gt;Attaching derby-6429-01-ae-privilegeFilters.diff. This patch fixes the bug Knut tripped across.&lt;/p&gt;

&lt;p&gt;The problem was that a ColumnReference was being cloned and the tags from the original ColumnReference weren&apos;t propagated to the clone. I have added a copyTagsFrom() call to ColumnReference.copyFields(). That fixes this bug. I added a regression test case for this problem to GrantRevokeDDLTest.&lt;/p&gt;

&lt;p&gt;Let me know if you can think of other instances of this bug. The only other parallel to this bug which I found by code inspection was the cloning of ResultColumns. I added a copyTagsFrom() call to ResultColumn.cloneMe().&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13855732" author="knutanders" created="Mon, 23 Dec 2013 16:26:54 +0000"  >&lt;p&gt;Thanks for making these changes, Rick.&lt;/p&gt;

&lt;p&gt;I found another anomaly (also seen without the patch):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; connect &apos;jdbc:derby:memory:db;user=u1&apos; as u1;
WARNING 01J14: SQL authorization is being used without first enabling authentication.
ij(U1)&amp;gt; create table t1(x int);
0 rows inserted/updated/deleted
ij(U1)&amp;gt; create table t2(x int);
0 rows inserted/updated/deleted
ij(U1)&amp;gt; insert into t2 values 1, 2;
2 rows inserted/updated/deleted
ij(U1)&amp;gt; grant update on t1 to u2;
0 rows inserted/updated/deleted
ij(U1)&amp;gt; connect &apos;jdbc:derby:memory:db;user=u2&apos; as u2;
WARNING 01J14: SQL authorization is being used without first enabling authentication.
ij(U2)&amp;gt; update u1.t1 set x = (select x from u1.t2);
ERROR 21000: Scalar subquery is only allowed to return a single row.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I would have expected the UPDATE statement to fail with a privilege error. Instead, it fails with an error message that reveals that U1.T2 contains more than one row. U2 shouldn&apos;t be able to get that info without a SELECT privilege on U1.T2, I think.&lt;/p&gt;

&lt;p&gt;If U1.T2 is empty or contains only one row, the UPDATE statement fails with the expected permission error.&lt;/p&gt;</comment>
                            <comment id="13855751" author="rhillegas" created="Mon, 23 Dec 2013 16:53:29 +0000"  >&lt;p&gt;Thanks for continuing to test-drive this patch, Knut. I am able to reproduce your results. Looking at the stack traces for both experiments (with and without rows in the table in the subquery), here is my theory about what is happening:&lt;/p&gt;

&lt;p&gt;1) The subquery result is being materialized as a OnceResultSet which runs before the UPDATE runs.&lt;/p&gt;

&lt;p&gt;2) But all of the permissions attached to the statement are checked just before the UpdateResultSet executes.&lt;/p&gt;

&lt;p&gt;3) If the OnceResultSet contains more than one row, then it raises the &quot;Scalar subquery is only allowed to return a single row&quot; error before the permissions associated with the UpdateResultSet are checked.&lt;/p&gt;

&lt;p&gt;Fixing this may required some thought. The permissions are attached to the CompilerContext during the bind() phase. They are not attached to individual query blocks. I think that the decision to materialize the subquery is made during the pre-processing phase of optimization. By that time, we have lost all memory of which query block the permissions came from.&lt;/p&gt;

&lt;p&gt;I would tend to regard this as another bug with privilege management, which deserves its own JIRA. What are your thoughts?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="13855761" author="rhillegas" created="Mon, 23 Dec 2013 16:59:42 +0000"  >&lt;p&gt;Maybe we don&apos;t have to change the compiler much in order to fix this new issue you&apos;ve found. The fix may be as simple as performing the runtime privilege checks on the first ResultSet that is materialized. Authorization checks are performed by GenericResultSetFactory.getUpdateResultSet() but not by GenericResultSetFactory.getOnceResultSet().&lt;/p&gt;</comment>
                            <comment id="13855781" author="knutanders" created="Mon, 23 Dec 2013 17:20:18 +0000"  >&lt;p&gt;It sounds reasonable to handle it as a separate bug, as it can also be seen outside of UPDATE:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij(U2)&amp;gt; values (select x from u1.s);
ERROR 21000: Scalar subquery is only allowed to return a single row.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve filed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6439&quot; title=&quot;Privileges not checked before scalar subquery is materialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6439&quot;&gt;DERBY-6439&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13855811" author="rhillegas" created="Mon, 23 Dec 2013 18:12:43 +0000"  >&lt;p&gt;Attaching derby-6429-01-af-privilegeFilters.diff. This patch adds some more test cases. I am running regression tests now.&lt;/p&gt;

&lt;p&gt;This patch adds tests for cases when views and table functions appear in the WHERE clause and on the right side of SET operators.&lt;/p&gt;

&lt;p&gt;Touches the same files as the previous versions of the patch.&lt;/p&gt;</comment>
                            <comment id="13855895" author="jira-bot" created="Mon, 23 Dec 2013 20:07:45 +0000"  >&lt;p&gt;Commit 1553197 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1553197&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1553197&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6429&quot; title=&quot;Privilege checks for UPDATE statements are wrong.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6429&quot;&gt;&lt;del&gt;DERBY-6429&lt;/del&gt;&lt;/a&gt;: Bring privilege checks on UPDATE statements into closer alignment with the SQL Standard; tests passed cleanly on derby-6429-01-af-privilegeFilters.diff.&lt;/p&gt;</comment>
                            <comment id="13864809" author="mamtas" created="Tue, 7 Jan 2014 22:43:49 +0000"  >&lt;p&gt;It seems like we should mark this jira as not suitable for backport because of compatibility reasons. The privileges required for UPDATE statement with this fix will now be different than those required by previous releases.&lt;/p&gt;</comment>
                            <comment id="13865418" author="rhillegas" created="Wed, 8 Jan 2014 13:35:46 +0000"  >&lt;p&gt;That sounds like a reasonable suggestion, Mamta. This bugfix might be especially disruptive. Your question prompted me to mark this issue as needing a release note. How are we tagging issues which are unsuitable for backport? I didn&apos;t see an appropriate label, but maybe I need another cup of coffee this morning. Thanks.&lt;/p&gt;</comment>
                            <comment id="13866871" author="mamtas" created="Thu, 9 Jan 2014 18:17:29 +0000"  >&lt;p&gt;Rick, I just put a new label &quot;backport_reject_10_10&quot; in the label field. Hope that is the right way to mark it reject for backport to 10.10 and prior releases.&lt;/p&gt;</comment>
                            <comment id="13866872" author="mamtas" created="Thu, 9 Jan 2014 18:19:04 +0000"  >&lt;p&gt;Also, there were number of privileges related jira that were created while researching on this jira. I am wondering if those should be marked reject for backport and release note required as well. &lt;/p&gt;</comment>
                            <comment id="13866875" author="rhillegas" created="Thu, 9 Jan 2014 18:22:45 +0000"  >&lt;p&gt;Thanks, Mamta. I have added the backport_reject_10_10 label to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3434&quot; title=&quot;Send master database to the slave location using the replication network&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3434&quot;&gt;DERBY-3434&lt;/a&gt;. That&apos;s where I&apos;m doing the corresponding work for INSERTs and DELETEs. I&apos;ve already flagged that it needs a release note. I think that should be good enough for the moment. Thanks.&lt;/p&gt;</comment>
                            <comment id="13872580" author="rhillegas" created="Wed, 15 Jan 2014 20:56:22 +0000"  >&lt;p&gt;Attaching a first draft of a release note for this issue.&lt;/p&gt;</comment>
                            <comment id="13873520" author="rhillegas" created="Thu, 16 Jan 2014 15:50:54 +0000"  >&lt;p&gt;I believe that I am done with the changes which I intend to make for this issue.&lt;/p&gt;</comment>
                            <comment id="13873542" author="rhillegas" created="Thu, 16 Jan 2014 16:08:42 +0000"  >&lt;p&gt;Attaching a second rev of the release note (corrected a typo).&lt;/p&gt;</comment>
                            <comment id="14284879" author="myrna" created="Wed, 21 Jan 2015 00:23:52 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12678827">DERBY-6414</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12381347">DERBY-3155</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12684313">DERBY-6431</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12685244">DERBY-6436</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12686174">DERBY-6439</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12684332">DERBY-6432</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12684337">DERBY-6433</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12684343">DERBY-6434</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12687468">DERBY-6446</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12619865" name="derby-6429-01-ab-privilegeFilters.diff" size="49145" author="rhillegas" created="Fri, 20 Dec 2013 17:45:30 +0000"/>
                            <attachment id="12619896" name="derby-6429-01-ac-privilegeFilters.diff" size="52805" author="rhillegas" created="Fri, 20 Dec 2013 19:26:12 +0000"/>
                            <attachment id="12620194" name="derby-6429-01-ad-privilegeFilters.diff" size="59994" author="rhillegas" created="Mon, 23 Dec 2013 14:06:06 +0000"/>
                            <attachment id="12620200" name="derby-6429-01-ae-privilegeFilters.diff" size="61604" author="rhillegas" created="Mon, 23 Dec 2013 15:01:01 +0000"/>
                            <attachment id="12620232" name="derby-6429-01-af-privilegeFilters.diff" size="75094" author="rhillegas" created="Mon, 23 Dec 2013 18:12:43 +0000"/>
                            <attachment id="12623410" name="releaseNote.html" size="2537" author="rhillegas" created="Thu, 16 Jan 2014 16:08:42 +0000"/>
                            <attachment id="12623223" name="releaseNote.html" size="2536" author="rhillegas" created="Wed, 15 Jan 2014 20:56:22 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12684313">DERBY-6431</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 10 Dec 2013 21:15:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362715</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzkd8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363009</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>