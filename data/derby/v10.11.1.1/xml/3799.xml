<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:20:48 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3799/DERBY-3799.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3799] NullPointerException when accessing a clob through a pooled connection</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3799</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;After returning a pooled connection to the pool and getting it again a NullPointerException is thrown when a clob field is accessed again. This may be related to the following post: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/200803.mbox/%3C47CD3431.5020205@sun.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/200803.mbox/%3C47CD3431.5020205@sun.com%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here is the stack trace:&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.setIntX(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.CallableLocatorProcedures.clobGetLength(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.Clob.getLocatorLength(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.Lob.sqlLength(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.Clob.length(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.Cursor.getString(Unknown Source)&lt;br/&gt;
        at org.apache.derby.client.am.ResultSet.getString(Unknown Source)&lt;br/&gt;
        at derbyerr.Main.main(Main.java:65)&lt;/p&gt;


&lt;p&gt;Here is the code to reproduce the problem:&lt;/p&gt;

&lt;p&gt;package derbyerr;&lt;/p&gt;

&lt;p&gt;import java.sql.Connection;&lt;br/&gt;
import java.sql.PreparedStatement;&lt;br/&gt;
import java.sql.ResultSet;&lt;br/&gt;
import java.sql.SQLException;&lt;br/&gt;
import javax.sql.PooledConnection;&lt;br/&gt;
import org.apache.derby.jdbc.ClientConnectionPoolDataSource;&lt;/p&gt;


&lt;p&gt;public class Main {&lt;/p&gt;

&lt;p&gt;  public static void main (String[] args) {&lt;br/&gt;
    org.apache.derby.tools.sysinfo.main (args) ;&lt;/p&gt;

&lt;p&gt;    ClientConnectionPoolDataSource creator = new ClientConnectionPoolDataSource () ;&lt;br/&gt;
    // There should be an empty db named testdb&lt;br/&gt;
    creator.setDatabaseName (&quot;testdb&quot;) ;&lt;/p&gt;

&lt;p&gt;    try {&lt;br/&gt;
      PooledConnection pc = creator.getPooledConnection () ;&lt;/p&gt;

&lt;p&gt;      Connection c = pc.getConnection () ;&lt;br/&gt;
      PreparedStatement ps ;&lt;br/&gt;
      ResultSet rs ;&lt;br/&gt;
      String s ;&lt;/p&gt;

&lt;p&gt;      // Drop the table &quot;test&quot;, if it exsists&lt;br/&gt;
      try &lt;/p&gt;
{
        ps = c.prepareStatement (&quot;drop table test&quot;) ;
        ps.execute () ;
        ps.close () ;
      }
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
      }&lt;/p&gt;

&lt;p&gt;      // Create a test table with a clob field&lt;br/&gt;
      ps = c.prepareStatement (&quot;create table test (pkey varchar(255) not null primary key, value clob)&quot;) ;&lt;br/&gt;
      ps.execute () ;&lt;br/&gt;
      ps.close () ;&lt;/p&gt;

&lt;p&gt;      // Insert a record&lt;br/&gt;
      ps = c.prepareStatement (&quot;insert into test values (&apos;123&apos;, &apos;abc&apos;)&quot;) ;&lt;br/&gt;
      ps.execute () ;&lt;br/&gt;
      ps.close () ;&lt;/p&gt;

&lt;p&gt;      // Query the record and...&lt;br/&gt;
      ps = c.prepareStatement (&quot;select * from test&quot;) ;&lt;br/&gt;
      rs = ps.executeQuery () ;&lt;br/&gt;
      rs.next () ;&lt;br/&gt;
      // ...access the clob field - this works&lt;br/&gt;
      s = rs.getString (2) ;&lt;br/&gt;
      assert s.equals (&quot;abc&quot;) ;&lt;br/&gt;
      rs.close () ;&lt;br/&gt;
      ps.close () ;&lt;/p&gt;

&lt;p&gt;      // Simulate connection pooling: close the connection and get it again&lt;br/&gt;
      c.close () ;&lt;br/&gt;
      c = pc.getConnection () ;&lt;/p&gt;

&lt;p&gt;      // Now again query the record...&lt;br/&gt;
      ps = c.prepareStatement (&quot;select * from test&quot;) ;&lt;br/&gt;
      rs = ps.executeQuery () ;&lt;br/&gt;
      rs.next () ;&lt;br/&gt;
      // ...and access the clob - this fails&lt;br/&gt;
      s = rs.getString (2) ;&lt;br/&gt;
      assert s.equals (&quot;abc&quot;) ;&lt;br/&gt;
      rs.close () ;&lt;br/&gt;
      ps.close () ;&lt;/p&gt;

&lt;p&gt;    } catch (Exception e) &lt;/p&gt;
{
      e.printStackTrace () ;
    }
&lt;p&gt;  }&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;</description>
                <environment>------------------ Java-Informationen ------------------&lt;br/&gt;
Java-Version: 1.6.0&lt;br/&gt;
Java-Anbieter: Sun Microsystems Inc.&lt;br/&gt;
Java-Home: C:\Program Files\Java\jdk1.6.0\jre&lt;br/&gt;
Java-Klassenpfad: C:\PHS\db-derby\db-derby-10.4.1.3-bin\lib\derbyclient.jar;C:\PHS\db-derby\db-derby-10.4.1.3-bin\lib\derbytools.jar;C:\PHS\Dvlp\Schop\derby-err\build\classes&lt;br/&gt;
Name des Betriebssystems: Windows XP&lt;br/&gt;
Architektur des Betriebssystems: x86&lt;br/&gt;
Betriebssystemversion: 5.1&lt;br/&gt;
Java-Benutzername: Ralf Lovec&lt;br/&gt;
Java-Benutzerausgangsverzeichnis: C:\Documents and Settings\Ralf Lovec&lt;br/&gt;
Java-Benutzerverzeichnis: C:\PHS\Dvlp\Schop\derby-err&lt;br/&gt;
java.specification.name: Java Platform API Specification&lt;br/&gt;
java.specification.version: 1.6&lt;br/&gt;
--------- Derby-Informationen --------&lt;br/&gt;
JRE - JDBC: Java SE 6 - JDBC 4.0&lt;br/&gt;
[C:\PHS\db-derby\db-derby-10.4.1.3-bin\lib\derbytools.jar] 10.4.1.3 - (648739)&lt;br/&gt;
[C:\PHS\db-derby\db-derby-10.4.1.3-bin\lib\derbyclient.jar] 10.4.1.3 - (648739)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
----------------- Informationen zur L&#65533;ndereinstellung -----------------&lt;br/&gt;
Aktuelle L&#65533;ndereinstellung:  [Deutsch/Deutschland [de_DE]]&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [cs]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [de_DE]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [es]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [fr]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [hu]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [it]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [ja_JP]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [ko_KR]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [pl]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [pt_BR]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [ru]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [zh_CN]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
Es wurde Unterst&#65533;tzung f&#65533;r die folgende L&#65533;ndereinstellung gefunden: [zh_TW]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Version: 10.4.1.3 - (648739)&lt;br/&gt;
------------------------------------------------------&lt;br/&gt;
</environment>
        <key id="12401011">DERBY-3799</key>
            <summary>NullPointerException when accessing a clob through a pooled connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="rlovec">Ralf Lovec</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Jul 2008 14:55:50 +0100</created>
                <updated>Mon, 4 May 2009 19:22:10 +0100</updated>
                            <resolved>Fri, 1 Aug 2008 15:00:15 +0100</resolved>
                                    <version>10.4.1.3</version>
                    <version>10.5.1.1</version>
                                    <fixVersion>10.4.2.0</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12616919" author="kristwaa" created="Fri, 25 Jul 2008 16:01:37 +0100"  >&lt;p&gt;I had a quick look at the bug. Thank you very much for the repro. I verified that the bug is also present in trunk (development version).&lt;/p&gt;

&lt;p&gt;At the moment I don&apos;t have much to offer, but you can run with JDBC statement caching as a workaround by adding &quot;creator.setMaxStatements(&amp;lt;how-many-statements-you-want-to-cache&amp;gt;);&quot;.&lt;br/&gt;
Please note that the client-side JDBC statement cache is not ready for production with 10.4.1.3. There were some bugs on the server in how the connections were handled, causing a resource leak that lead to increased GC overhead.&lt;/p&gt;

&lt;p&gt;The cause of the NPE is that the parameter meta data has been nulled out and not been reset. I hope to be able to have a closer look on Monday.&lt;/p&gt;</comment>
                            <comment id="12617438" author="kristwaa" created="Mon, 28 Jul 2008 15:38:37 +0100"  >&lt;p&gt;&apos;derby-3799-1a-checkIfClosed.diff&apos; fixes the reported problem and adds a regression test.&lt;/p&gt;

&lt;p&gt;When a logical connection is closed all open statements are closed. The LOB stored procedure code did not detect this, as it only checked if the reference to the CallableStatement was null or not.&lt;br/&gt;
I fixed this by also checking if the CallableStatement is open on the client. The fix implies that the stored procedure calls must be prepared for each logical connection, if the LOB stored procedures are needed. This does not happen when the JDBC statement cache is enabled.&lt;/p&gt;

&lt;p&gt;Comments on the fix approach and the patch are welcome!&lt;/p&gt;</comment>
                            <comment id="12619018" author="kristwaa" created="Fri, 1 Aug 2008 15:00:15 +0100"  >&lt;p&gt;Committed patch 1a to trunk with revision 681694.&lt;br/&gt;
Backported to 10.4 with revision 681697.&lt;/p&gt;

&lt;p&gt;Issue can be closed when the fix has been verified.&lt;/p&gt;</comment>
                            <comment id="12619375" author="rlovec" created="Sun, 3 Aug 2008 21:41:47 +0100"  >&lt;p&gt;I have tested trunk and the backport to 10.4 and in both versions the problem has been resolved.&lt;/p&gt;</comment>
                            <comment id="12619427" author="kristwaa" created="Mon, 4 Aug 2008 07:34:42 +0100"  >&lt;p&gt;Thanks for the quick feedback, Ralf &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12387031" name="derby-3799-1a-checkIfClosed.diff" size="9784" author="kristwaa" created="Mon, 28 Jul 2008 15:38:37 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 25 Jul 2008 15:01:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23849</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39313</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>