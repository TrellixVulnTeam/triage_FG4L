<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3355/DERBY-3355.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3355] Alter Column ... NULL ignores double quotes around column name</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3355</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;&apos; is not a column in the target table., SQL State: 42X04, Error Code: -1&lt;br/&gt;
Hi:&lt;br/&gt;
I think I have isolated a bug involving the use of double quotes to define a column name. Here s the SQL to reproduce the bug, followed by the error message generated by the final SQL statement. In order to make the bug go away, eliminate all use of double quotes in the SQL statements below. Note that the identical alter statement succeeds before the insert, and fail after. I have spent a long time trying to isolate this problem, so please take a look.&lt;/p&gt;

&lt;p&gt;CREATE TABLE Table2&lt;br/&gt;
(&lt;br/&gt;
   &quot;c&quot; VARCHAR(32672)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;alter table Table2 ALTER COLUMN &quot;c&quot; NULL;&lt;br/&gt;
alter table Table2 ALTER COLUMN &quot;c&quot; NOT NULL;&lt;br/&gt;
INSERT INTO Table2(&quot;c&quot;) VALUES(&apos;yo&apos;);&lt;br/&gt;
alter table Table2 ALTER COLUMN &quot;c&quot; NULL;&lt;br/&gt;
alter table Table2 ALTER COLUMN &quot;c&quot; NOT NULL;&lt;/p&gt;


&lt;p&gt;Query 1 of 6 elapsed time (seconds) - Total: 0.012, SQL query: 0.012, Building output: 0&lt;/p&gt;

&lt;p&gt;Query 2 of 6 elapsed time (seconds) - Total: 0.003, SQL query: 0.003, Building output: 0&lt;/p&gt;

&lt;p&gt;Query 3 of 6 elapsed time (seconds) - Total: 0.003, SQL query: 0.003, Building output: 0&lt;br/&gt;
1 Row(s) Inserted&lt;br/&gt;
Query 4 of 6 elapsed time (seconds) - Total: 0.009, SQL query: 0.009, Building output: 0&lt;/p&gt;

&lt;p&gt;Query 5 of 6 elapsed time (seconds) - Total: 0.003, SQL query: 0.003, Building output: 0&lt;br/&gt;
Error: java.sql.SQLException: Column &apos;C&apos; is either not in any table in the FROM list or appears within a join specification and is outside the scope of the join specification or appears in a HAVING clause and is not in the GROUP BY list. If this is a CREATE or ALTER TABLE  statement then &apos;C&apos; is not a column in the target table., SQL State: 42X04, Error Code: -1&lt;/p&gt;


&lt;p&gt;----&lt;del&gt;Inline Message Follows&lt;/del&gt;----&lt;/p&gt;

&lt;p&gt;Geoff hendrey wrote:&lt;br/&gt;
&amp;gt; I think I have isolated a bug involving the use of double quotes to&lt;br/&gt;
&amp;gt; define a column name.&lt;/p&gt;

&lt;p&gt;Hi Geoff, I agree, that is definitely a bug. Your script reproduces&lt;br/&gt;
the problem for me, on the current Derby trunk.&lt;/p&gt;

&lt;p&gt;It appears that AlterTableConstantAction.validateNotNullConstraint&lt;br/&gt;
is internally generating and executing a statement of the form:&lt;/p&gt;

&lt;p&gt;    select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from tab where not (col is not null)&lt;/p&gt;

&lt;p&gt;The code which generates this SQL staement is not properly enclosing&lt;br/&gt;
the column name in double quotes, as you noticed, so the compiler&lt;br/&gt;
converts the column name to upper case, and gets the no-such-column error.&lt;/p&gt;

&lt;p&gt;Can you open a problem report in Jira so that we can track this down&lt;br/&gt;
and get it fixed?&lt;br/&gt;
&lt;a href=&quot;http://db.apache.org/derby/DerbyBugGuidelines.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/DerbyBugGuidelines.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;thanks,&lt;/p&gt;

&lt;p&gt;bryan&lt;/p&gt;</description>
                <environment>mac 0s x</environment>
        <key id="12387341">DERBY-3355</key>
            <summary>Alter Column ... NULL ignores double quotes around column name</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="geoff_hendrey">geoff hendrey</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Jan 2008 02:22:27 +0000</created>
                <updated>Fri, 25 Jul 2008 18:15:30 +0100</updated>
                            <resolved>Sun, 3 Feb 2008 18:58:31 +0000</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12563583" author="bryanpendleton" created="Tue, 29 Jan 2008 17:29:42 +0000"  >&lt;p&gt;Attached is &apos;patch.diff&apos;, a patch proposal.&lt;/p&gt;

&lt;p&gt;The patch modifies AlterTableConstantAction.validateNotNullConstraint&lt;br/&gt;
to enclose the column name in double quotes when generating&lt;br/&gt;
SQL on-the-fly.&lt;/p&gt;

&lt;p&gt;The patch also adds a variety of test cases to altertable.sql, based&lt;br/&gt;
on the repro script for this issue, using a variety of table and column&lt;br/&gt;
names in both mixed case and all upper case.&lt;/p&gt;

&lt;p&gt;I&apos;m still running the full regression suite; I&apos;ll report back on the results.&lt;/p&gt;</comment>
                            <comment id="12563592" author="djd" created="Tue, 29 Jan 2008 17:42:55 +0000"  >&lt;p&gt;Any explanation for why the same statement worked once with &quot;c&quot; and then failed later?&lt;/p&gt;</comment>
                            <comment id="12563599" author="bryanpendleton" created="Tue, 29 Jan 2008 18:06:55 +0000"  >&lt;p&gt;ALTER TABLE conditionally checks the not null constraint. It first looks&lt;br/&gt;
to see if the table is empty or not, by calling getSemiRowCount, which&lt;br/&gt;
classifies the table into having 0, 1, or &amp;gt;1 rows. Then, if the table has&lt;br/&gt;
at least 1 row, it generates and executes the problematic SQL with&lt;br/&gt;
the unquoted column name.&lt;/p&gt;

&lt;p&gt;So the first invocation in the repro script succeeds because the table is empty.&lt;/p&gt;

&lt;p&gt;The code in question is around line 2420 of AlterTableConstantAction.java:&lt;/p&gt;

&lt;p&gt;            if (cd.getType().isNullable())&lt;br/&gt;
            {&lt;br/&gt;
                if (numRows &amp;gt; 0)&lt;/p&gt;
                {
                    // already found a nullable column so add &quot;AND&quot;
                    if (foundNullable)
                        constraintText.append(&quot; AND &quot;);
                    constraintText.append(&quot;\&quot;&quot; + columnNames[colCtr] +
                        &quot;\&quot; IS NOT NULL &quot;);
                }
&lt;p&gt;                foundNullable = true;&lt;br/&gt;
                nullCols&lt;span class=&quot;error&quot;&gt;&amp;#91;colCtr&amp;#93;&lt;/span&gt; = true;&lt;br/&gt;
            }&lt;/p&gt;

&lt;p&gt;The first time through the repro script, numRows is 0.&lt;/p&gt;</comment>
                            <comment id="12563687" author="bryanpendleton" created="Tue, 29 Jan 2008 21:55:15 +0000"  >&lt;p&gt;Suites.all and derbyall completed without errors. Please let me know of&lt;br/&gt;
any feedback on the patch proposal.&lt;/p&gt;</comment>
                            <comment id="12564102" author="army" created="Wed, 30 Jan 2008 17:21:07 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;I reviewed at the patch and it looks good to me.  The new test cases fail without the change and pass with it, as expected.&lt;/p&gt;

&lt;p&gt;Two very minor things that occurred to me while reading the patch:&lt;/p&gt;

&lt;p&gt;  1. Might be nice (though not by any means necessary) to include a comment in AlterTableConstantAction&lt;br/&gt;
      that explicitly mentions the motivation for double-quoting the column name.  On the other hand, maybe&lt;br/&gt;
      the presence of the double quotes is itself enough to make that clear?  Not a big deal either way.&lt;/p&gt;

&lt;p&gt;  2. I instinctively found myself wondering if column names which had double quotes in them would work&lt;br/&gt;
      correctly.  I ran some tests and the answer is Yes, they do work correctly.  Do you think it might be useful&lt;br/&gt;
      to add a few test cases for that, just for completeness?  The quick tests that I ran were simply:&lt;/p&gt;

&lt;p&gt;      ij&amp;gt; create table t1 (&quot;&quot;&quot;c&quot;&quot;2&quot; int, &quot;&quot;&quot;&quot;&quot;C3&quot; int);&lt;br/&gt;
      0 rows inserted/updated/deleted&lt;br/&gt;
      ij&amp;gt; select * from t1;&lt;br/&gt;
      &quot;c&quot;2       |&quot;&quot;C3&lt;br/&gt;
      -----------------------&lt;/p&gt;

&lt;p&gt;      0 rows selected&lt;br/&gt;
      ij&amp;gt; alter table t1 alter column &quot;&quot;&quot;c&quot;&quot;2&quot; not null;&lt;br/&gt;
      0 rows inserted/updated/deleted&lt;br/&gt;
      ij&amp;gt; insert into t1 values (null, 2);&lt;br/&gt;
      ERROR 23502: Column &apos;&quot;c&quot;2&apos;  cannot accept a NULL value.&lt;br/&gt;
      ij&amp;gt; alter table t1 alter column &quot;&quot;&quot;&quot;&quot;C3&quot; not null;&lt;br/&gt;
      0 rows inserted/updated/deleted&lt;br/&gt;
      ij&amp;gt; insert into t1 values (1, null);&lt;br/&gt;
      ERROR 23502: Column &apos;&quot;&quot;C3&apos;  cannot accept a NULL value.&lt;br/&gt;
      ij&amp;gt; alter table t1 alter column &quot;&quot;&quot;&quot;&quot;c3&quot; not null;&lt;br/&gt;
      ERROR 42X14: &apos;&quot;&quot;c3&apos; is not a column in table or VTI &apos;T1&apos;.&lt;br/&gt;
      ij&amp;gt;   alter table t1 alter column &quot;&quot;&quot;c3&quot; not null;&lt;br/&gt;
      ERROR 42X14: &apos;&quot;c3&apos; is not a column in table or VTI &apos;T1&apos;.&lt;br/&gt;
      ij&amp;gt; alter table t1 alter column &quot;c2&quot; not null;&lt;br/&gt;
      ERROR 42X14: &apos;c2&apos; is not a column in table or VTI &apos;T1&apos;.&lt;br/&gt;
      ij&amp;gt; alter table t1 alter column &quot;C3&quot; not null;&lt;br/&gt;
      ERROR 42X14: &apos;C3&apos; is not a column in table or VTI &apos;T1&apos;.&lt;/p&gt;

&lt;p&gt;Neither of these nits should block the patch, though.  As the regression tests ran cleanly and I can see no other problems with the changes, I&apos;m +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12564114" author="djd" created="Wed, 30 Jan 2008 18:18:53 +0000"  >&lt;p&gt;I&apos;m not sure those quote examples prove anything, not a single one is executed after the table has rows in it, which is where the bug originally was.&lt;/p&gt;

&lt;p&gt;My guess is that is does not work. The column name in the alter table is &quot;&quot;&quot;c&quot;&quot;2&quot;, which will be converted to &quot;c&quot;2 internally (as a Java string),&lt;br/&gt;
then the SELECT to check the constraint will use   &quot;&quot;c&quot;2&quot; which will cause a syntax error.&lt;/p&gt;

&lt;p&gt;When writing an identifier as an input for a SQL statement as well as making it delimited value needs to have its double quotes escaped (by using two double quotes). Either no Derby code does this or there is a utility somewhere to output the CNF of an identifier in a form acceptable to a SQL statement.&lt;/p&gt;

&lt;p&gt;Good thinking to raise the issue though.&lt;/p&gt;</comment>
                            <comment id="12564119" author="army" created="Wed, 30 Jan 2008 18:34:09 +0000"  >&lt;p&gt;&amp;gt; I&apos;m not sure those quote examples prove anything, not a single one is&lt;br/&gt;
&amp;gt; executed after the table has rows in it&lt;/p&gt;

&lt;p&gt;Good catch!  Sorry for missing that.  Building on the example I mentioned above:&lt;/p&gt;

&lt;p&gt;  ij&amp;gt; insert into t1 values (1, 2);&lt;br/&gt;
  1 row inserted/updated/deleted&lt;br/&gt;
  ij&amp;gt; alter table t1 alter column &quot;&quot;&quot;&quot;&quot;C3&quot; null;&lt;br/&gt;
  0 rows inserted/updated/deleted&lt;br/&gt;
  ij&amp;gt; alter table t1 alter column &quot;&quot;&quot;&quot;&quot;C3&quot; not null;&lt;br/&gt;
  ERROR 42X01: Syntax error: Encountered &quot;\&quot;&quot; at line 1, column 43.&lt;/p&gt;

&lt;p&gt;So it looks like you&apos;re right, the quotes will lead to a syntax error.  Though the specific error in this case seems a tad odd...where&apos;d the slash (&amp;#41; come from?&lt;/p&gt;</comment>
                            <comment id="12564125" author="bryanpendleton" created="Wed, 30 Jan 2008 18:46:39 +0000"  >&lt;p&gt;Thanks Dan and Army for the suggestions and fiendishly good tests!&lt;/p&gt;

&lt;p&gt;I cleared the patch available flag; I&apos;ve got more work to do here.&lt;/p&gt;</comment>
                            <comment id="12564140" author="djd" created="Wed, 30 Jan 2008 19:29:14 +0000"  >&lt;p&gt;or in the spirit of open source and incremental development commit the patch and address the quote issues in a follow up patch.&lt;/p&gt;

&lt;p&gt;The current patch improves the situation and makes most cases work.&lt;/p&gt;</comment>
                            <comment id="12564223" author="bryanpendleton" created="Wed, 30 Jan 2008 23:42:24 +0000"  >&lt;p&gt;I tried running dblook against a database with Army&apos;s fiendish T1 table in it,&lt;br/&gt;
and dblook politely produced:&lt;/p&gt;

&lt;p&gt;&amp;#8211; ----------------------------------------------&lt;br/&gt;
&amp;#8211; DDL Statements for tables&lt;br/&gt;
&amp;#8211; ----------------------------------------------&lt;/p&gt;

&lt;p&gt;CREATE TABLE &quot;APP&quot;.&quot;T1&quot; (&quot;&quot;&quot;c&quot;&quot;2&quot; INTEGER, &quot;&quot;&quot;&quot;&quot;C3&quot; INTEGER);&lt;/p&gt;

&lt;p&gt;So it seems that somewhere within the Derby source tree there is some code that&lt;br/&gt;
understands how to take table and column names and properly enquote them.&lt;/p&gt;

&lt;p&gt;Hopefully I can track that code down, and have a look to see if it can be easily&lt;br/&gt;
repurposed for use by the ALTER TABLE execution.&lt;/p&gt;
</comment>
                            <comment id="12564226" author="djd" created="Wed, 30 Jan 2008 23:46:10 +0000"  >&lt;p&gt;Within the engine I think this will work:&lt;/p&gt;

&lt;p&gt;  org.apache.derby.iapi.util.IdUtil.normalToDelimited&lt;/p&gt;</comment>
                            <comment id="12564549" author="bryanpendleton" created="Thu, 31 Jan 2008 23:33:25 +0000"  >&lt;p&gt;Thanks Dan! IdUtil.normalToDelimited looks perfect.&lt;/p&gt;

&lt;p&gt;Attached is handleQuotes.diff, which uses IdUtil to&lt;br/&gt;
handle the construction of the properly delimited&lt;br/&gt;
form of the column name, and also includes more&lt;br/&gt;
test cases in altertable.sql inspired by Army&apos;s test cases.&lt;/p&gt;

&lt;p&gt;Additional feedback is welcome.&lt;/p&gt;</comment>
                            <comment id="12564823" author="army" created="Fri, 1 Feb 2008 16:51:09 +0000"  >&lt;p&gt;Thanks for the updated patch, Bryan.  I re-ran my quoted-column-name queries and they all seem to be working correctly with handleQuotes.diff.  I see no other issues with the patch, so +1 to commit from me.&lt;/p&gt;</comment>
                            <comment id="12565080" author="bryanpendleton" created="Sat, 2 Feb 2008 15:52:50 +0000"  >&lt;p&gt;Committed handleQuotes.diff to the trunk as revision 617818.&lt;/p&gt;

&lt;p&gt;If no additional problems show up over the next few days, I&apos;ll&lt;br/&gt;
investigate merging this fix back to the 10.3 branch.&lt;/p&gt;</comment>
                            <comment id="12565187" author="bryanpendleton" created="Sun, 3 Feb 2008 16:31:28 +0000"  >&lt;p&gt;The merge to the 10.3 branch had no conflicts, and all the regression tests passed against 10.3.&lt;/p&gt;</comment>
                            <comment id="12565202" author="bryanpendleton" created="Sun, 3 Feb 2008 18:58:31 +0000"  >&lt;p&gt;Committed the merged change to the 10.3 branch as revision 618054.&lt;/p&gt;

&lt;p&gt;Thanks much to the reviewers for your help and suggestions!&lt;/p&gt;

&lt;p&gt;Geoff, if you can confirm that this fix works for you and close the issue,&lt;br/&gt;
that would be appeciated.&lt;/p&gt;</comment>
                            <comment id="12565633" author="geoff_hendrey" created="Tue, 5 Feb 2008 03:34:47 +0000"  >&lt;p&gt;I dowloaded the latest 10.3.2.2 build, and the problem seems to be fixed.  thanks for the rapid turnaround.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12374511" name="handleQuotes.diff" size="6311" author="bryanpendleton" created="Thu, 31 Jan 2008 23:33:25 +0000"/>
                            <attachment id="12374273" name="patch.diff" size="4613" author="bryanpendleton" created="Tue, 29 Jan 2008 17:29:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 29 Jan 2008 17:29:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23591</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ypr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39442</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>