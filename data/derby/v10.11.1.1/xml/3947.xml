<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:37:04 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3947/DERBY-3947.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3947] Cannot insert 994 character long string into indexed column</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3947</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Inserting a 994 character string into a varchar(1000) column with an index fails.&lt;/p&gt;

&lt;p&gt;These steps&lt;/p&gt;

&lt;p&gt;1. &quot;create table t (x varchar(1000) primary key)&quot;&lt;br/&gt;
2. &quot;insert into t values &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&quot; where ? holds a 994 character string&lt;/p&gt;

&lt;p&gt;produce the following error:&lt;/p&gt;

&lt;p&gt;ERROR XSCB6: Limitation: Record of a btree secondary index cannot be updated or inserted due to lack of space on the page.  Use the parameters derby.storage.pageSize and/or derby.storage.pageReservedSpace to work around this limitation.&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:276)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.BTreeController.doIns(BTreeController.java:845)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.BTreeController.insert(BTreeController.java:1264)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.index.B2IController.insert(B2IController.java:210)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexChanger.insertAndCheckDups(IndexChanger.java:439)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexChanger.doInsert(IndexChanger.java:383)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexChanger.insert(IndexChanger.java:589)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.IndexSetChanger.insert(IndexSetChanger.java:268)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:453)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:1011)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:487)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:372)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1235)&lt;/p&gt;

&lt;p&gt;The page size should be set sufficiently high at index creation time to hold columns with the specified maximum size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12408430">DERBY-3947</key>
            <summary>Cannot insert 994 character long string into indexed column</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Nov 2008 13:57:43 +0000</created>
                <updated>Tue, 2 Feb 2010 09:54:27 +0000</updated>
                            <resolved>Wed, 2 Dec 2009 14:50:29 +0000</resolved>
                                    <version>10.4.2.0</version>
                                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12647293" author="knutanders" created="Thu, 13 Nov 2008 13:59:27 +0000"  >&lt;p&gt;Attaching test case which reproduces the bug.&lt;/p&gt;</comment>
                            <comment id="12647297" author="kristwaa" created="Thu, 13 Nov 2008 14:16:19 +0000"  >&lt;p&gt;Similar problem reported by Alan Burlison on the user list, see &lt;a href=&quot;http://www.nabble.com/btree-overflow-during-insert-to20460876.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/btree-overflow-during-insert-to20460876.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12726936" author="kristwaa" created="Fri, 3 Jul 2009 13:16:31 +0100"  >&lt;p&gt;Triaged July 3, 2009: Assigned normal urgency, marked as Repro attached, Workaround attached and as Seen in production (even though &apos;m not 100% sure if the bug was seen in production or in the pre-deployment phase).&lt;/p&gt;</comment>
                            <comment id="12781770" author="bryanpendleton" created="Tue, 24 Nov 2009 04:37:30 +0000"  >&lt;p&gt;I fiddled with this problem for a little while, and I think that the&lt;br/&gt;
problem is that the index which is created behind-the-scenes to&lt;br/&gt;
implement the PRIMARY KEY constraint goes through a different&lt;br/&gt;
code path than the normal index which is created by CREATE INDEX.&lt;/p&gt;

&lt;p&gt;In the case of&lt;/p&gt;

&lt;p&gt;  create table t (x varchar(1000));&lt;br/&gt;
  create index t_ix on t&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/p&gt;

&lt;p&gt;we go through CreateIndexNode.makeConstantAction, where there&lt;br/&gt;
is code that looks at the size of the columns in the index and notices&lt;br/&gt;
that we need a larger page size for this index, and chooses the&lt;br/&gt;
larger page size automatically.&lt;/p&gt;

&lt;p&gt;But in the case from the issue description&lt;/p&gt;

&lt;p&gt;   create table t (x varchar(1000) primary key)&lt;/p&gt;

&lt;p&gt;we &lt;b&gt;instead&lt;/b&gt; go through TableElementNode.genIndexAction,&lt;br/&gt;
which doesn&apos;t have any logic to notice that a larger page size is needed.&lt;/p&gt;

&lt;p&gt;I think that we could fix this problem by arranging for the colInfos data&lt;br/&gt;
from the CreateTableNode to be passed through to TableElementNode.genIndexAction&lt;br/&gt;
so that it can check the size of the columns and see if it needs to create the&lt;br/&gt;
PRIMARY KEY index with a larger page size.&lt;/p&gt;

&lt;p&gt;Ideally, it would be great if we could somehow share this code between&lt;br/&gt;
CreateIndexNode and TableElementNode, but I think that the data&lt;br/&gt;
structures are unfortunately not very similar so we may end up&lt;br/&gt;
with two bits of code instead.&lt;/p&gt;

&lt;p&gt;At least, I can &lt;b&gt;start&lt;/b&gt; by writing a second bit of code and demonstrating&lt;br/&gt;
that it fixes the problem, and then we can try to figure out how to share&lt;br/&gt;
the code and only compute the index&apos;s needed page size once.&lt;/p&gt;</comment>
                            <comment id="12783262" author="bryanpendleton" created="Sat, 28 Nov 2009 18:45:55 +0000"  >&lt;p&gt;Attached is my first try at fixing this problem. The patch contains a regression&lt;br/&gt;
test case, based on Knut&apos;s repro program, and a change to TableElementList&lt;br/&gt;
to check, when creating the index which backs up a constraint, whether the&lt;br/&gt;
index needs to use a large page size rather than the default page size.&lt;/p&gt;

&lt;p&gt;The change makes the repro case passes, but does NOT handle the similar,&lt;br/&gt;
but different, cases of ALTER TABLE ADD CONSTRAINT, so the patch is&lt;br/&gt;
not ready for commit.&lt;/p&gt;

&lt;p&gt;But I think the basic idea is workable, so I&apos;ll see if I can extend it to handle &lt;br/&gt;
the special needs of ALTER TABLE.&lt;/p&gt;</comment>
                            <comment id="12783464" author="bryanpendleton" created="Sun, 29 Nov 2009 20:13:49 +0000"  >&lt;p&gt;Upon more study, I don&apos;t think that ALTER TABLE takes a different code path&lt;br/&gt;
when adding a constraint; i think the flow still goes through TableElementList.&lt;/p&gt;

&lt;p&gt;I did, however, add some more tests, including a test of trying to add a constraint&lt;br/&gt;
which mentions a column which doesn&apos;t exist, which caught the fact that the&lt;br/&gt;
patch needs to be careful when looking at the column lengths, because if the&lt;br/&gt;
column doesn&apos;t exist, we can&apos;t access its length.&lt;/p&gt;

&lt;p&gt;I added more tests to the patch proposal, and am running a full set of regression tests.&lt;/p&gt;</comment>
                            <comment id="12783513" author="bryanpendleton" created="Mon, 30 Nov 2009 01:29:57 +0000"  >&lt;p&gt;Regression testing was uneventful. I think that &apos;moreTests.diff&apos; is worthy&lt;br/&gt;
of consideration as a resolution to this, and would appreciate any input.&lt;/p&gt;</comment>
                            <comment id="12783636" author="knutanders" created="Mon, 30 Nov 2009 12:48:23 +0000"  >&lt;p&gt;Thanks for investigating this issue, Bryan. The fix looks correct to me. +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12784858" author="bryanpendleton" created="Wed, 2 Dec 2009 14:50:29 +0000"  >&lt;p&gt;Thanks for the review, Knut. Committed to the trunk as revision 886162.&lt;/p&gt;</comment>
                            <comment id="12828568" author="knutanders" created="Tue, 2 Feb 2010 09:54:27 +0000"  >&lt;p&gt;Verified on trunk (table is still created with page size 4K, but index is created with page size 32K, and the insert does not fail). Closing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12393870" name="VarcharIndex.java" size="567" author="knutanders" created="Thu, 13 Nov 2008 13:59:27 +0000"/>
                            <attachment id="12426330" name="firstTry.diff" size="5238" author="bryanpendleton" created="Sat, 28 Nov 2009 18:45:55 +0000"/>
                            <attachment id="12426369" name="moreTests.diff" size="6276" author="bryanpendleton" created="Sun, 29 Nov 2009 20:13:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 13 Nov 2008 14:16:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23931</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    <customfieldvalue key="10427"><![CDATA[Workaround attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0r93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38233</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>