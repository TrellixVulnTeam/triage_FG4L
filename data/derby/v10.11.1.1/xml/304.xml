<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:41:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-304/DERBY-304.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-304] If by mistake you give he location for the db backup as the db itself , then windows created directories recursively until windows crashes!</title>
                <link>https://issues.apache.org/jira/browse/DERBY-304</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If by mistake you give he location for the db backup as the db itself , then windows created directories recursively until it crashes! &lt;/p&gt;

&lt;p&gt;Repro:&lt;/p&gt;

&lt;p&gt;			CallableStatement cs = conn.prepareCall(&quot;CALL SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE(?, ?)&quot;);&lt;br/&gt;
			cs.setString(1, &quot;c:/maildb&quot;);&lt;br/&gt;
			cs.setInt(2, 1);&lt;br/&gt;
			cs.execute();&lt;br/&gt;
			cs.close();&lt;/p&gt;

&lt;p&gt;result:&lt;/p&gt;

&lt;p&gt;C:\maildb\maildb\maildb\maildb\maildb\maildb\maildb\maildb\maildb\maildb\maildb\maildb\maildb\maildb\..................... Until windows can not show the path!!!&lt;/p&gt;</description>
                <environment>With JDK 142 on Windows XP</environment>
        <key id="32767">DERBY-304</key>
            <summary>If by mistake you give he location for the db backup as the db itself , then windows created directories recursively until windows crashes!</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tsuresh">Suresh Thalamati</assignee>
                                    <reporter username="mkutty">Manjula Kutty</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 May 2005 04:14:43 +0100</created>
                <updated>Tue, 20 Mar 2007 21:53:59 +0000</updated>
                            <resolved>Wed, 1 Mar 2006 04:49:27 +0000</resolved>
                                    <version>10.1.1.0</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12364909" author="tsuresh" created="Thu, 2 Feb 2006 10:59:12 +0000"  >&lt;p&gt;I tried the repro for this bug on my laptop with Windows XP , backup failed while copying the directories., with the error:ERROR XSRS5: Error copying file (during backup) from C:\maildb to c:\maildb\maildb.&lt;br/&gt;
OS did not crash for me.. &lt;/p&gt;

&lt;p&gt;I think  it is very rare any user will make mistake  of  giving backup path same as database home or one of its subdirectories. But I agree it might be nice to throw a better error message,  but that might add some addtional restrictions or overhead.&lt;/p&gt;

&lt;p&gt;Some thought one possible way to fix this::&lt;/p&gt;

&lt;p&gt;1)  Get absolute paths for both the database home directory and the backup directory  then  find if  backup path is a subdirectory under the database directory.   Problem with this approach is :&lt;br/&gt;
    a)   Backup would always  require   read permission for &quot;user.dir&quot;  when run under security manager. &lt;br/&gt;
    b)   If there are symbolic links involved ,  this fix will not work. &lt;/p&gt;

&lt;p&gt;2)   Add a counter to  keep track  how many level of deep the   directories are  being created  from the backup directory while doing the copy.  If   the  directory level is deeper than the database normally has then  throw error.  This will work  if  user create backup under &amp;lt;dbname&amp;gt;/jar  or &amp;lt;dbname&amp;gt;  but  if the given backup path is under  &quot;log&quot; and &quot;seg0&quot;  then we can not identify this case becuase these directoties are not copied any more.&lt;/p&gt;


&lt;p&gt;3)   At the start of  the backup create a uniue file using a UUID under the backup directory ,  then search for that file under the database home directory. If  that file is not  found then one can be sure backup path is not  mapping to a subdirectiory  of  database directory.   Delete the new file created and then proceed with the backup.  I think this fix will work ,  but  there is overhead of searching through all the files under the  database directory for  a error case.    &lt;/p&gt;

&lt;p&gt;4) Don&apos;t  bother to fix it ,  No one is going hit this problem again  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


&lt;p&gt;Any suggestions ?&lt;/p&gt;


&lt;p&gt;Thanks&lt;br/&gt;
-suresht&lt;/p&gt;









</comment>
                            <comment id="12364919" author="kartha" created="Thu, 2 Feb 2006 13:41:09 +0000"  >&lt;p&gt;The (file.getCanonicalFile()) gives you the actual path for symbolic links. I am wondering  if that could be used to compare the&lt;br/&gt;
backup  location and the actual database to be the same.  &lt;/p&gt;

&lt;p&gt;Something like:&lt;/p&gt;

&lt;p&gt;f.getCanonicalFile().equals(f1.getCanonicalFile())&lt;/p&gt;

&lt;p&gt;This will return true is&apos;f1&apos; is a symbolic link to &apos;f&apos;. I know for sure this works on Linux.&lt;/p&gt;


&lt;p&gt;-Rajesh&lt;/p&gt;
</comment>
                            <comment id="12367110" author="tsuresh" created="Tue, 21 Feb 2006 09:11:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-304&quot; title=&quot;If by mistake you give he location for the db backup as the db itself , then windows created directories recursively until windows crashes!&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-304&quot;&gt;&lt;del&gt;DERBY-304&lt;/del&gt;&lt;/a&gt;:  If the given backup path is same as the database home, backup &lt;br/&gt;
was failing in trying to copy the backup onto itself, while copying the &lt;br/&gt;
directories in the database home recursively into the backup. &lt;/p&gt;

&lt;p&gt;Fix :&lt;/p&gt;

&lt;p&gt;1) Do not allow backup path to be any derby database directory. A directory is&lt;br/&gt;
   assumed to be a derby database directory if it has service.properties file in it. &lt;/p&gt;

&lt;p&gt;2) copy files needed from the database home into the backup  one by one &lt;br/&gt;
   instead of recursive copy from the top directory. &lt;/p&gt;

&lt;p&gt;3) while copying the directories under jar directory, copy each sub directory&lt;br/&gt;
   separately without copying any subdirectories under them (There should not&lt;br/&gt;
   be any unless if user has created explicitly or created backup at that location).&lt;/p&gt;

&lt;p&gt;4) Log and Seg0 directory are NOT already copied recursively, this was changed as part of&lt;br/&gt;
   online backup work (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-239&quot; title=&quot;Need a online backup feature  that does not block update operations   when online backup is in progress.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-239&quot;&gt;&lt;del&gt;DERBY-239&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;


&lt;p&gt;TESTS : derbyall test suite passed on Windows XP/JDK142, except for known failures.&lt;/p&gt;

&lt;p&gt;It would be great if some can review and commit this patch. &lt;/p&gt;

&lt;p&gt;svn stat:&lt;br/&gt;
M      java\engine\org\apache\derby\impl\sql\execute\JarDDL.java&lt;br/&gt;
M      java\engine\org\apache\derby\impl\store\raw\RawStore.java&lt;br/&gt;
M      java\engine\org\apache\derby\iapi\services\io\FileUtil.java&lt;br/&gt;
M      java\engine\org\apache\derby\iapi\store\access\FileResource.java&lt;br/&gt;
M      java\engine\org\apache\derby\loc\messages_en.properties&lt;br/&gt;
M      java\shared\org\apache\derby\shared\common\reference\SQLState.java&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\tests\store\copyfiles.ant&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\tests\store\BackupPathTests.java&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\tests\store\BackupPathTests_app.properties&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\master\BackupPathTests.out&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\suites\storemore.runall&lt;/p&gt;</comment>
                            <comment id="12367279" author="mikem" created="Wed, 22 Feb 2006 08:17:49 +0000"  >&lt;p&gt;I reviewed, ran tests and committed this patch:&lt;br/&gt;
m1_142:204&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\iapi\services\io\FileUtil.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\iapi\store\access\FileResource.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\execute\JarDDL.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\RawStore.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\loc\messages_en.properties&lt;br/&gt;
Sending        java\shared\org\apache\derby\shared\common\reference\SQLState.jav&lt;br/&gt;
a&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\master\BackupP&lt;br/&gt;
athTests.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\suites\storemo&lt;br/&gt;
re.runall&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\store\Ba&lt;br/&gt;
ckupPathTests.java&lt;br/&gt;
Adding         java\testing\org\apache\derbyTesting\functionTests\tests\store\Ba&lt;br/&gt;
ckupPathTests_app.properties&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\store\co&lt;br/&gt;
pyfiles.ant&lt;br/&gt;
Transmitting file data ...........&lt;br/&gt;
Committed revision 379620.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12323218" name="derby-304.diff" size="27717" author="tsuresh" created="Tue, 21 Feb 2006 09:11:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 2 Feb 2006 10:59:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>21885</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy12zz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40136</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>