<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:38:19 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1861/DERBY-1861.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1861] Column ordering ASSERT when combining column references and expressions in same ORDER BY</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1861</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;An ORDER BY clause wihch combines both column references and expressions causes the&lt;br/&gt;
sort engine to throw an ASSERT failure in sane builds.&lt;/p&gt;

&lt;p&gt;Here&apos;s a repro script:&lt;/p&gt;

&lt;p&gt;-bash-2.05b$ java org.apache.derby.tools.ij&lt;br/&gt;
ij version 10.3&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:brydb;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create table t (a int, b int, c int, d int);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t values (1, 2, 3, 4);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select * from t order by a, b, c+2;&lt;br/&gt;
ERROR XJ001: Java exception: &apos;ASSERT FAILED column ordering error: org.apache.derby.shared.common.sanity.AssertFailure&apos;.&lt;/p&gt;

&lt;p&gt;As a first theory to check, I believe that when columns in the ORDER BY clause go through &quot;pullup&quot; processing,&lt;br/&gt;
they are generated into the select statement&apos;s ResultColumnList and then are later removed at bind time because&lt;br/&gt;
they are determined to duplicate the columns implicitly selected by the &quot;*&quot; column list. But the expression &quot;c+2&quot; is not&lt;br/&gt;
removed from the result list because it does not duplicate any existing column in the table. During this processing,&lt;br/&gt;
I think that the field &quot;addedColumnOffset&quot; in class OrderByColumn is not managed correctly and ends up generating&lt;br/&gt;
a bogus column position for the &quot;c+2&quot; column (it doesn&apos;t reflect that pulled-up columns &quot;a&quot; and &quot;b&quot; have disappeared&lt;br/&gt;
from the ResultColumnList), causing the sanity assertion at execution time.&lt;/p&gt;

&lt;p&gt;I stumbled across this problem while writing regression tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-147&quot; title=&quot;ERROR 42X79 not consistant ? - same column name specified twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-147&quot;&gt;&lt;del&gt;DERBY-147&lt;/del&gt;&lt;/a&gt;, but the problem occurs&lt;br/&gt;
with or without the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-147&quot; title=&quot;ERROR 42X79 not consistant ? - same column name specified twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-147&quot;&gt;&lt;del&gt;DERBY-147&lt;/del&gt;&lt;/a&gt; fix, so I decided to log it as a separate problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12350104">DERBY-1861</key>
            <summary>Column ordering ASSERT when combining column references and expressions in same ORDER BY</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="bryanpendleton">Bryan Pendleton</reporter>
                        <labels>
                    </labels>
                <created>Sun, 17 Sep 2006 18:00:48 +0100</created>
                <updated>Wed, 23 May 2007 22:20:25 +0100</updated>
                            <resolved>Mon, 19 Mar 2007 18:45:53 +0000</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12435327" author="bryanpendleton" created="Sun, 17 Sep 2006 18:05:47 +0100"  >&lt;p&gt;Found this bug while writing tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-147&quot; title=&quot;ERROR 42X79 not consistant ? - same column name specified twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-147&quot;&gt;&lt;del&gt;DERBY-147&lt;/del&gt;&lt;/a&gt;. Both bugs involve&lt;br/&gt;
processing of columns in the ORDER BY clause, but are probably&lt;br/&gt;
no more related than that.&lt;/p&gt;</comment>
                            <comment id="12460706" author="bryanpendleton" created="Sun, 24 Dec 2006 20:36:53 +0000"  >&lt;p&gt;Attaching some background notes that will be helpful to reviewers (I hope).&lt;/p&gt;</comment>
                            <comment id="12460819" author="bryanpendleton" created="Mon, 25 Dec 2006 22:20:11 +0000"  >&lt;p&gt;Attached is adjustOffsets_v1.patch, a proposed patch, and proposedPatchNotes.html, which provides some additional notes for reviewers. This patch passes derbyall and suites.All.&lt;/p&gt;</comment>
                            <comment id="12463085" author="army" created="Mon, 8 Jan 2007 18:05:04 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;Thank you for writing up the issue so clearly!  It was nice that I could understand your changes just by reading your notes, even though I didn&apos;t have knowledge of order by &quot;pull up&quot; processing prior to this.&lt;/p&gt;

&lt;p&gt;The write-up is great, and the code is clean, contained, and well-commented.  I ran lang/orderby.sql after applying the patch and it ran cleanly.  When I reverted your engine changes and re-ran the new test cases, they failed as expected.&lt;/p&gt;

&lt;p&gt;I only have two questions: one from your notes, one for the patch.&lt;/p&gt;

&lt;p&gt;1) Question on the notes:&lt;/p&gt;

&lt;p&gt;&amp;gt; it also seemed like the call to pullUpOrderByColumns had been placed&lt;br/&gt;
&amp;gt; very carefully, as there is a big comment in CursorNode stating that&lt;br/&gt;
&amp;gt; this order of operations was deliberate, so I decided there was a&lt;br/&gt;
&amp;gt; good reason for it.&lt;/p&gt;

&lt;p&gt;Out of simple curiosity, were you able to figure out why this order was specifically chosen?  I read through the comments in CursorNode a couple of times but still couldn&apos;t quite understand the significance.  Did you try re-ordering the code to see what happened?  Were you able to come up with any cases where such reordering caused problems?  As I said, this is just a question bred from curiosity--I&apos;m not asking you to try it out (but if you already tried it, I&apos;m wondering what the results were).&lt;/p&gt;

&lt;p&gt;For the record, I have no problems with your decision to leave the code as it is for safety.  I think it&apos;s better to do what you did--namely, fix the data structures so that they do what they were intended to do.  As you said the changes are pretty small and they make sense, so that seems like a good choice.&lt;/p&gt;

&lt;p&gt;2) Question on the patch:&lt;/p&gt;

&lt;p&gt;As you mentioned when you posted the patch for for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-147&quot; title=&quot;ERROR 42X79 not consistant ? - same column name specified twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-147&quot;&gt;&lt;del&gt;DERBY-147&lt;/del&gt;&lt;/a&gt;, there are two versions of the &quot;getOrderByColumn()&quot; method in ResultColumnList.  For &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-147&quot; title=&quot;ERROR 42X79 not consistant ? - same column name specified twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-147&quot;&gt;&lt;del&gt;DERBY-147&lt;/del&gt;&lt;/a&gt; it looks like you made the same changes to both of the methods, despite (or perhaps because of) your comment saying:&lt;/p&gt;

&lt;p&gt;&amp;gt; I reverted to a smaller patch, which doesn&apos;t combine the nearly-&lt;br/&gt;
&amp;gt; redundant versions of getOrderByColumn, but which preserves the&lt;br/&gt;
&amp;gt; existing behavior in the case of table correlation names.&lt;/p&gt;

&lt;p&gt;That said, I noticed that for this &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1861&quot; title=&quot;Column ordering ASSERT when combining column references and expressions in same ORDER BY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1861&quot;&gt;&lt;del&gt;DERBY-1861&lt;/del&gt;&lt;/a&gt; patch, the changes that you made to the two methods are different.  For one method you added the new calls described in proposedPatchNotes.html; but for the other you replaced the old code with code to throw an assertion failure:&lt;/p&gt;

&lt;p&gt;@@ -506,10 +525,10 @@&lt;br/&gt;
                 }&lt;br/&gt;
                 else if (index &amp;gt;= size - orderBySelect)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{// remove the column due to pullup of orderby item&lt;/li&gt;
	&lt;li&gt;removeElement(resultColumn);&lt;/li&gt;
	&lt;li&gt;decOrderBySelect();&lt;/li&gt;
	&lt;li&gt;break;&lt;br/&gt;
+                
{
+                    SanityManager.THROWASSERT(
+                            &quot;Unexpectedly found ORDER BY column &apos;&quot; +
+                            columnName + &quot;&apos; pulled up at position &quot; +index);
                 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Can you explain (at a high level) the difference between the two methods and maybe indicate why the latter method was changed to throw an ASSERT failure?  And would it make sense to add such an explanation to the code itself?&lt;/p&gt;</comment>
                            <comment id="12463689" author="yipng" created="Wed, 10 Jan 2007 20:02:34 +0000"  >&lt;p&gt;Hi Bryan, I have reviewed your proposal patch.  Great writeup on the pull-up processing for ORDER BY.  &lt;br/&gt;
I was able to apply the patch cleanly and ran it successfully and fails without the fix with the newly added testcases.  I am fine with the proposed solution.  +1 on commit if regression passes.&lt;/p&gt;
</comment>
                            <comment id="12463706" author="bryanpendleton" created="Wed, 10 Jan 2007 20:34:42 +0000"  >&lt;p&gt;Thanks much Yip and Army for the reviews and suggestions.&lt;/p&gt;

&lt;p&gt;I&apos;m intending to investigate the issues that Army noted, but I probably won&apos;t&lt;br/&gt;
get to it for a little while. Depending on what I find, I&apos;ll either come back with&lt;br/&gt;
a revised patch, or proceed with this patch.&lt;/p&gt;</comment>
                            <comment id="12481866" author="bryanpendleton" created="Sat, 17 Mar 2007 15:43:03 +0000"  >&lt;p&gt;I still haven&apos;t had any more time to look at this. I&apos;m considering committing the patch as is, because I think it&apos;s solid and fixes the identified issue, and filing a follow-on issue to investigate consolidating (or at least better documenting) the two closely-similar versions of getOrderByColumn. Having bumped into that confusing bit of code twice now (in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-147&quot; title=&quot;ERROR 42X79 not consistant ? - same column name specified twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-147&quot;&gt;&lt;del&gt;DERBY-147&lt;/del&gt;&lt;/a&gt; and in this issue) I&apos;d like to follow it up and improve it, but I&apos;d also like to get this patch committed before it &quot;spoils&quot;. If nobody objects, I&apos;ll proceed with this plan in the next week or so.&lt;/p&gt;</comment>
                            <comment id="12481970" author="bryanpendleton" created="Sun, 18 Mar 2007 20:29:05 +0000"  >&lt;p&gt;OK, I changed my mind again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; In the process of bringing the patch&lt;br/&gt;
up to date with the current head of trunk, I decided to try and add some&lt;br/&gt;
more comments and JavaDoc and try to address Army&apos;s comment about&lt;br/&gt;
the two similar, but not identical, getOrderByColumn routines in&lt;br/&gt;
ResultColumnList.&lt;/p&gt;

&lt;p&gt;Attached is adjustOffsets_v2_moreJavaDoc.diff, which differs from the&lt;br/&gt;
original patch only by:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it is up to date with the head of trunk&lt;/li&gt;
	&lt;li&gt;I&apos;ve added more JavaDoc comments to the two confusing routines&lt;br/&gt;
  in ResultColumnList, and&lt;/li&gt;
	&lt;li&gt;I&apos;ve renamed the two routines to getOrderByColumnToBind and&lt;br/&gt;
  findResultColumnForOrderBy to try to make their usage more clear&lt;br/&gt;
  (in addition to adding the JavaDoc)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please let me know any comments or feedback, in particular whether&lt;br/&gt;
the modified routines are more clear now.&lt;/p&gt;</comment>
                            <comment id="12482167" author="army" created="Mon, 19 Mar 2007 17:38:04 +0000"  >&lt;p&gt;Thank you very much for the second patch with additional javadoc, Bryan.  The new comments do indeed make things clearer, as does the renaming of the two similar-but-not-quite-identical methods.&lt;/p&gt;

&lt;p&gt;I vote +1 for committing the patch with this additional javadoc--especially since, as you said, &quot;it&apos;s solid and fixes the identified issue&quot;.&lt;br/&gt;
Thanks for addressing my comments!&lt;/p&gt;</comment>
                            <comment id="12482179" author="bryanpendleton" created="Mon, 19 Mar 2007 18:45:53 +0000"  >&lt;p&gt;Thanks Army for the feedback and good suggestions. I committed&lt;br/&gt;
the v2 patch to subversion as revision 520038.&lt;/p&gt;</comment>
                            <comment id="12482537" author="army" created="Tue, 20 Mar 2007 21:18:37 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;There&apos;s one thing that I missed when reviewing your changes--and I only just now noticed it by sheer accident.&lt;/p&gt;

&lt;p&gt;In order to get some numbers for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt; I did an INSANE build and then tried to build jars.  The building of the jars was successful, but I just happened to notice one unusal line in the output, namely:&lt;/p&gt;

&lt;p&gt;filteractivator:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;echo&amp;#93;&lt;/span&gt;  creating derby.jar class list&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; SANITY &amp;gt;&amp;gt;&amp;gt; /org/apache/derby/impl/sql/compile/ResultColumnList.class&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;echo&amp;#93;&lt;/span&gt;  creating new DBMS.properties file&lt;/p&gt;

&lt;p&gt;Confused by this, I opened ResultColumnList.java and did a search for SanityManager--and it turns out that the patch for this issue adds a call to SanityManager.THROWASSERT that is &lt;b&gt;not&lt;/b&gt; contained inside an &quot;if (SanityManager.DEBUG)&quot; block.&lt;/p&gt;

&lt;p&gt;Apparently this isn&apos;t a big deal since all of the nightly tests have been running just fine--but for the sake of correctness, I think we need to wrap the THROWASSERT call inside a SanityManager.DEBUG check.  It&apos;s a one-line change that should be easy enough to make (esp. since you&apos;re a committer... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12482539" author="bryanpendleton" created="Tue, 20 Mar 2007 21:24:32 +0000"  >&lt;p&gt;Thanks Army! I&apos;ll take care of it straightaway.&lt;/p&gt;</comment>
                            <comment id="12482630" author="bryanpendleton" created="Wed, 21 Mar 2007 01:51:10 +0000"  >&lt;p&gt;Committed a simple change to enclose the ThrowAssert in a Debug check,&lt;br/&gt;
and confirmed that the SANITY warning now disappears from an insane jar build.&lt;br/&gt;
Committed to the trunk as revision 520699.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="30160">DERBY-147</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12365097">DERBY-2459</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12325311">DERBY-681</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12347851" name="adjustOffsets_v1.diff" size="12972" author="bryanpendleton" created="Mon, 25 Dec 2006 22:20:11 +0000"/>
                            <attachment id="12353605" name="adjustOffsets_v2_moreJavaDoc.diff" size="17645" author="bryanpendleton" created="Sun, 18 Mar 2007 20:29:05 +0000"/>
                            <attachment id="12347802" name="dataStructureNotes.html" size="10043" author="bryanpendleton" created="Sun, 24 Dec 2006 20:36:53 +0000"/>
                            <attachment id="12347850" name="proposedPatchNotes.html" size="3625" author="bryanpendleton" created="Mon, 25 Dec 2006 22:20:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 8 Jan 2007 18:05:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22757</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy123r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39991</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>