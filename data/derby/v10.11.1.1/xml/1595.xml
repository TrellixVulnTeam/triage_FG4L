<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:28:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1595/DERBY-1595.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1595] Network server fails with DRDAProtocolException if a BLOB with size 2147483647 is streamed from client</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1595</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When executing a program which inserts a BLOB of size 2GB-1, the Network server fails with DRDAProtocolException.  This happens before it starts handling the actual LOB data:&lt;/p&gt;

&lt;p&gt;java org.apache.derby.drda.NetworkServerControl start&lt;br/&gt;
Apache Derby Network Server - 10.2.0.4 alpha started and ready to accept connections on port 1527 at 2006-07-26 14:15:21.284 GMT&lt;br/&gt;
Execution failed because of a Distributed Protocol Error:  DRDA_Proto_SYNTAXRM; CODPNT arg  = 0; Error Code Value = c&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(DRDAConnThread.java:441)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.readLengthAndCodePoint(DDMReader.java:554)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.getCodePoint(DDMReader.java:617)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA_work(DRDAConnThread.java:4072)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA(DRDAConnThread.java:3928)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:3806)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:3640)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:928)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:254)&lt;br/&gt;
null&lt;br/&gt;
org.apache.derby.impl.drda.DRDAProtocolException&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.throwSyntaxrm(DRDAConnThread.java:441)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.readLengthAndCodePoint(DDMReader.java:554)&lt;br/&gt;
        at org.apache.derby.impl.drda.DDMReader.getCodePoint(DDMReader.java:617)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA_work(DRDAConnThread.java:4072)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA(DRDAConnThread.java:3928)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:3806)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:3640)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:928)&lt;br/&gt;
        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:254)&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12346695">DERBY-1595</key>
            <summary>Network server fails with DRDAProtocolException if a BLOB with size 2147483647 is streamed from client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="andreask">Andreas Korneliussen</reporter>
                        <labels>
                            <label>LOB</label>
                            <label>derby_backport_reject_10_5</label>
                    </labels>
                <created>Wed, 26 Jul 2006 15:21:47 +0100</created>
                <updated>Thu, 2 May 2013 03:29:32 +0100</updated>
                            <resolved>Tue, 15 Mar 2011 21:36:04 +0000</resolved>
                                    <version>10.0.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                    <version>10.7.1.1</version>
                                    <fixVersion>10.6.2.1</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>Network Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12451347" author="julo" created="Mon, 20 Nov 2006 15:55:11 +0000"  >&lt;p&gt;I was able to reproduce this but when I decreased the size of LOB to 2GB-2, I got a different exception only on client:&lt;/p&gt;

&lt;p&gt;java.sql.SQLException: A network protocol error was encountered and the connection has been terminated: the requested command encountered an unarchitected and implementation-specific condition for which there was no architected message&lt;br/&gt;
        at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:46)&lt;br/&gt;
        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:345)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.execute(PreparedStatement.java:1565)&lt;br/&gt;
        at com.sun.stroffek.Main.main(Main.java:45)&lt;br/&gt;
Caused by: org.apache.derby.client.am.DisconnectException: A network protocol error was encountered and the connection has been terminated: the requested command encountered an unarchitected and implementation-specific condition for which there was no architected message&lt;br/&gt;
        at org.apache.derby.client.net.NetConnectionReply.parseCMDCHKRM(NetConnectionReply.java:888)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.parseExecuteError(NetStatementReply.java:661)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(NetStatementReply.java:332)&lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.readExecute(NetStatementReply.java:70)&lt;br/&gt;
        at org.apache.derby.client.net.StatementReply.readExecute(StatementReply.java:55)&lt;br/&gt;
        at org.apache.derby.client.net.NetPreparedStatement.readExecute_(NetPreparedStatement.java:183)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.readExecute(PreparedStatement.java:1788)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2108)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.executeX(PreparedStatement.java:1571)&lt;br/&gt;
        at org.apache.derby.client.am.PreparedStatement.execute(PreparedStatement.java:1556)&lt;br/&gt;
        ... 1 more&lt;/p&gt;</comment>
                            <comment id="12451686" author="julo" created="Tue, 21 Nov 2006 16:03:27 +0000"  >&lt;p&gt;The exception in my comment was caused by the lack of disk space. I had started the derby with traceAll and run out of disk space very fast... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="12534926" author="kmarsden" created="Mon, 15 Oct 2007 19:12:30 +0100"  >&lt;p&gt;Julius, were you ever able to reproduce this issue? Are you actively working on it.&lt;/p&gt;
</comment>
                            <comment id="12535057" author="julo" created="Tue, 16 Oct 2007 05:27:24 +0100"  >&lt;p&gt;Yes, I was able to reproduce the bug, I tried also other size near 2GB-1 but just 2GB-1 exploits the bug.&lt;/p&gt;

&lt;p&gt;I moved my attention away and wanted to return back after some time. I am unassigning the issue from myself to leave it for others who  may want to work on that.&lt;/p&gt;</comment>
                            <comment id="12729192" author="knutanders" created="Thu, 9 Jul 2009 12:15:20 +0100"  >&lt;p&gt;Triaged for 10.5.2.&lt;/p&gt;</comment>
                            <comment id="12878985" author="kristwaa" created="Tue, 15 Jun 2010 15:36:33 +0100"  >&lt;p&gt;The fix for this bug consists of two parts:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;make the client and the server agree on how the length is represented.&lt;br/&gt;
   Currently the client writes a long (8 bytes), whereas the server expects 6 bytes.&lt;/li&gt;
	&lt;li&gt;switch to using long instead of int where appropriate in the client.&lt;br/&gt;
   There are several places where using int may result in an overflow (i.e. user data length + overhead).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I hope to post the first patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="12879322" author="kristwaa" created="Wed, 16 Jun 2010 13:04:50 +0100"  >&lt;p&gt;Attaching patch 1a, which is client change only.&lt;/p&gt;

&lt;p&gt;The number of extended length bytes depends on the length of the value to be transferred. The code is capable of choosing between 2, 4, 6 or 8 bytes. At some point an invalid change was introduced into the client, where a long (8 bytes) was written onto the wire when only 6 bytes were required for the length. The server expected 6 bytes, and this disagreement resulted in a protocol error.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure using 6 instead of 8 bytes matters regarding performance, but I chose to use 6 bytes because:&lt;br/&gt;
 o the DRDA spec may mandate this (I haven&apos;t checked)&lt;br/&gt;
 o the server already expects 6 bytes, using 8 would require server side changes as well and would lead to incompatibilities when using the new client driver with old server versions&lt;/p&gt;

&lt;p&gt;Note that this patch itself doesn&apos;t necessarily solve the reported problem, as the client code is likely to run into an int overflow. I&apos;ll address this in a separate patch.&lt;br/&gt;
suites.All ran without failures, I&apos;m running derbyall now&lt;/p&gt;

&lt;p&gt;Patch ready for review. I expect to commit the patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="12879706" author="knutanders" created="Thu, 17 Jun 2010 09:00:09 +0100"  >&lt;p&gt;The 1a patch looks fine to me. Two questions, though:&lt;/p&gt;

&lt;p&gt;1) Is the value of MAX_LONG_6_BYTES_SIGNED correct? Looking at the corresponding code at the server side, it seems like it should have been 0xFFFFFFFFFFFFL, not 0x7FFFFFFFFFFFL. See for example DDMWriter.calculateExtendedLengthByteCount():&lt;/p&gt;

&lt;p&gt;		else if (ddmSize &amp;lt;= 0xffffffffffffL)&lt;br/&gt;
			return 6;&lt;/p&gt;

&lt;p&gt;And DDMReader.readNetworkSixByteLong() is also coded to handle that extra bit:&lt;/p&gt;

&lt;p&gt;		return (&lt;br/&gt;
				((buffer&lt;span class=&quot;error&quot;&gt;&amp;#91;pos++&amp;#93;&lt;/span&gt; &amp;amp; 0xffL) &amp;lt;&amp;lt; 40) +&lt;br/&gt;
				...&lt;/p&gt;

&lt;p&gt;2) Are you planning to internationalize the new error message that was added?&lt;/p&gt;</comment>
                            <comment id="12879714" author="kristwaa" created="Thu, 17 Jun 2010 10:11:29 +0100"  >&lt;p&gt;Hi Knut,&lt;/p&gt;

&lt;p&gt;1) Here&apos;s what I got:&lt;/p&gt;

&lt;p&gt; a) DRDA vol 3, page 300:&lt;br/&gt;
   &quot;The length of the extended total length field must be a multiple of two bytes, and it cannot be longer than necessary to express the length of the object&apos;s data.&quot;&lt;/p&gt;

&lt;p&gt; b) .../client/net/Request:&lt;br/&gt;
        // according to Jim and some tests perfomred on Lob data,&lt;br/&gt;
        // the extended length bytes are signed.  Assume that&lt;br/&gt;
        // if this is the case for Lobs, it is the case for&lt;br/&gt;
        // all extended length scenarios.&lt;/p&gt;

&lt;p&gt;  It sounds reasonable to expect that the code never sends negative lengths, but:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;negative values may be reserved for a special purpose&lt;/li&gt;
	&lt;li&gt;the DRDA spec may have made a wrong turn in this area (i.e &quot;wasting space&quot; by using signed instead of unsigned)&lt;/li&gt;
	&lt;li&gt;since the client only sends signed positive values that are small enough so that the most significant bit isn&apos;t used, the difference between client and server doesn&apos;t cause problems&lt;/li&gt;
	&lt;li&gt;if the server is correct, our client is breaking the spec for  a series of ranges of LOB lengths (point a, the client uses 0x7FFFL, 0x7FFFFFFF and 0x7FFFFFFFFFFF). This doesn&apos;t matter, as the server doesn&apos;t seem to enforce point a.&lt;br/&gt;
   (- btw, I haven&apos;t investigated if the extended length bytes are used when transferring data from the server to the client)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  To move on with the reported issue, I have logged &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4702&quot; title=&quot;Determine if the DRDA Layber B DSS extended total length field should carry a signed or unsigned integer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4702&quot;&gt;DERBY-4702&lt;/a&gt; to track further discussion of this topic.&lt;/p&gt;

&lt;p&gt;2) No, I&apos;m not. This is more like an assert, and I&apos;d rather have it fail than to silently ignore the most significant parts of the long.&lt;/p&gt;</comment>
                            <comment id="12879724" author="knutanders" created="Thu, 17 Jun 2010 10:47:53 +0100"  >&lt;p&gt;1) I agree that it won&apos;t cause any problems since the server knows how to handle the values both when sent as a 6-byte value and as an 8-byte value (given that the type specifier matches the actual length). It&apos;s probably fine to leave it as it is. I see that NetStatementRequest.buildPlaceholderLength() also uses 0x7F(...) so I think it&apos;s true that a higher value won&apos;t ever be attempted written as a 6-byte integer.&lt;/p&gt;

&lt;p&gt;2) Sounds OK, although I think the established pattern is to exclude asserts in production jars.&lt;/p&gt;</comment>
                            <comment id="12879739" author="kristwaa" created="Thu, 17 Jun 2010 11:34:19 +0100"  >&lt;p&gt;Thanks, Knut Anders.&lt;/p&gt;

&lt;p&gt;I committed patch 1a to trunk with revision 955540.&lt;br/&gt;
If it turns out that the length field should be unsigned, we have to change more code and that&apos;s better addressed as a separate issue.&lt;/p&gt;</comment>
                            <comment id="12880839" author="kristwaa" created="Mon, 21 Jun 2010 15:12:21 +0100"  >&lt;p&gt;Linked &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4706&quot; title=&quot;Remove stale and potentially unused code Request.writeEncryptedScalarStream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4706&quot;&gt;&lt;del&gt;DERBY-4706&lt;/del&gt;&lt;/a&gt;, since that issue removes some code that would otherwise have to be changed with regards to the switch from int to long.&lt;/p&gt;</comment>
                            <comment id="12880842" author="kristwaa" created="Mon, 21 Jun 2010 15:14:59 +0100"  >&lt;p&gt;Attached patch 2a, which fixes the int overflow issues.&lt;br/&gt;
Since CLOBs that aren&apos;t transferred using layer B streaming are represented as UTF-16, this results in a maximum length of ~4 GB.&lt;/p&gt;

&lt;p&gt;Running regression tests.&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12882112" author="kristwaa" created="Thu, 24 Jun 2010 11:10:49 +0100"  >&lt;p&gt;Regression tests ran without failures.&lt;br/&gt;
I plan to commit this patch shortly.&lt;/p&gt;</comment>
                            <comment id="12883522" author="kristwaa" created="Tue, 29 Jun 2010 13:14:05 +0100"  >&lt;p&gt;Committed patch 2a to trunk with revision 958939.&lt;/p&gt;

&lt;p&gt;After the fix has seen some more testing, I&apos;ll backport it. The fix is client-side only, which means that older client versions can make use of it (assuming the merge is clean).&lt;/p&gt;</comment>
                            <comment id="12887714" author="kristwaa" created="Tue, 13 Jul 2010 12:06:31 +0100"  >&lt;p&gt;Backported to 10.6 with revision 963673.&lt;br/&gt;
Since the merge isn&apos;t clean for older versions, I don&apos;t plan more backports.&lt;/p&gt;</comment>
                            <comment id="12893156" author="kristwaa" created="Wed, 28 Jul 2010 13:19:31 +0100"  >&lt;p&gt;Closing issue.&lt;/p&gt;</comment>
                            <comment id="13007208" author="kmarsden" created="Tue, 15 Mar 2011 21:35:41 +0000"  >&lt;p&gt;reopen for backport_reject label&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12467471">DERBY-4706</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12447218" name="derby-1595-1a-client_write6bytes.diff" size="4006" author="kristwaa" created="Wed, 16 Jun 2010 13:04:50 +0100"/>
                            <attachment id="12447600" name="derby-1595-2a-client_int_overflow.diff" size="8640" author="kristwaa" created="Mon, 21 Jun 2010 15:14:59 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 20 Nov 2006 15:55:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0hd3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36631</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>