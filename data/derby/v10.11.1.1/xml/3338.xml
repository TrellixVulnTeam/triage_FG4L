<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:18:16 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3338/DERBY-3338.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3338] CancelQueryTask.forgetContext() could be simplified.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3338</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Minor issue but CancelQueryTask.forgetContext() has this code (in GenericStatementContext.java)&lt;/p&gt;

&lt;p&gt;        public void forgetContext() {&lt;br/&gt;
            boolean mayStillRun = !cancel();&lt;br/&gt;
            if (mayStillRun) {&lt;br/&gt;
                synchronized (this) &lt;/p&gt;
{
                    statementContext = null;
                }&lt;br/&gt;
            }&lt;br/&gt;
        }&lt;br/&gt;
&lt;br/&gt;
The mayStillRun = !cancel() is somewhat confusing. I can&apos;t see from the javadoc of TimerTask.cancel() how its return value could indicate the task may still run.&lt;br/&gt;
Less confusing code could be:&lt;br/&gt;
&lt;br/&gt;
        public void forgetContext() {&lt;br/&gt;
               synchronized (this) {                    statementContext = null;                }
&lt;p&gt;                cancel();&lt;br/&gt;
        }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12386811">DERBY-3338</key>
            <summary>CancelQueryTask.forgetContext() could be simplified.</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="djd">Daniel John Debrunner</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Jan 2008 22:56:43 +0000</created>
                <updated>Fri, 21 Jan 2011 17:51:18 +0000</updated>
                            <resolved>Wed, 11 Jun 2008 05:36:01 +0100</resolved>
                                                    <fixVersion>10.4.2.0</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Services</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12603667" author="mamtas" created="Mon, 9 Jun 2008 20:58:13 +0100"  >&lt;p&gt;Reworking the code as suggested by Dan may actually fix the problem experienced on weme6.1 (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1848&quot; title=&quot;jdbcapi/SetQueryTimeoutTest.java fails on IBM  wctme 5.7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1848&quot;&gt;&lt;del&gt;DERBY-1848&lt;/del&gt;&lt;/a&gt; for jdbcapi/SetQueryTimeoutTest.java) The way the CancelQueryTask.forgetContext()  is written right now, it leaves a small window of code path through it that leaves the CancelTimerTask linked to the StatementContext, a timing window allows the CancelTimerTask&apos;s run method to later cancel a different statement once the StatementContext is re-used. A short example here might be helpful.&lt;/p&gt;

&lt;p&gt;Let Stmt1A be a JDBC Statement object(with set query timeout set on it) and SC1 be a StatementContext. Say that user has requested a ResultSet object movement for Stmt1A. At the start of the ResultSet movement code, we use a StatementContext (say in this case it is SC1) and push that StatementContext for Stmt1A. During the push, we start a Timer say CQt1 since user has set query timeout for Stmt1A. After the ResultSet movement code, Stmt1A starts its pop on SC1. During the pop, say the Timer CQt1 expires and so CQT1 is queued upto run. Before CQT1 runs, say the control goes back to finish the rest of the pop SC1 code. During the pop, we call CancelQueryTask.forgetContext(). The current code here checks if the Timer has been cancelled. If not cancelled, then we mark the StatementContext associated with CQT1 as null otherwise we don&apos;t touch StatementContext object associated with CQT1. Since in our specific case, the Timer has already been cancelled, we leave SC1 associated with CQT1. After this we finish the rest of the code to pop SC1 for Stmt1A. Keep in mind that CQT1 has not run yet. Since SC1 is available for some other Statement to use, say Stmt2B pushes SC1 before it does it&apos;s ResultSet movement. So, now SC1 is associated with Stmt2B. At this point, say CQT1&apos;s run gets scheduled. Since it still has SC1 associated with it (because we never cleared it in forgetContext), CQT1 is going to mark SC1 as timedout. This is where we run into problem. We are indirectly marking wrong JDBC Statement as timed out (in this particular case Stmt2B) and that is what I think is causing occassional timeouts in jdbcapi/SetQueryTimeoutTest.java. I have rearranged the code and run the tests and I have not been able to reproduce the problem with jdbcapi/SetQueryTimeoutTest.java even after 30 runs (normally it reproduces for me in about 3-5 runs). I will attach the simple patch for review and will plan on committing it tomorrow if no one has any comments.&lt;/p&gt;</comment>
                            <comment id="12603754" author="dagw" created="Tue, 10 Jun 2008 03:28:43 +0100"  >&lt;p&gt;Your explanation sounds reasonable and  the patch looks safe to me.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12604116" author="mamtas" created="Wed, 11 Jun 2008 05:36:01 +0100"  >&lt;p&gt;Thanks, Dag, for the review. I have committed the changes into trunk with revision 666519.&lt;/p&gt;</comment>
                            <comment id="12604360" author="mamtas" created="Wed, 11 Jun 2008 23:11:43 +0100"  >&lt;p&gt;Migrated the changes into 10.4(with revision 666871) codeline. Will work on migrating next to 10.3 codeline.&lt;/p&gt;</comment>
                            <comment id="12604552" author="mamtas" created="Thu, 12 Jun 2008 16:56:37 +0100"  >&lt;p&gt;Migrated the changes into 10.3.3.1 codeline also with revision 667136.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12349880">DERBY-1848</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12383707" name="DERBY_3338_rework_forgetContext_v1.diff" size="768" author="mamtas" created="Mon, 9 Jun 2008 20:59:06 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 9 Jun 2008 19:58:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30816</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0lsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>