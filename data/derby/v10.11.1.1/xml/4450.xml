<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:41:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4450/DERBY-4450.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4450] GROUP BY in an IN-subquery inside HAVING clause whose select list is subset of group by columns, gives NPE</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4450</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Found this while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4397&quot; title=&quot;Allow ORDER BY in subqueries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4397&quot;&gt;&lt;del&gt;DERBY-4397&lt;/del&gt;&lt;/a&gt; for a similar case with ORDER BY inside an IN-subquery:&lt;/p&gt;

&lt;p&gt;Repro:&lt;/p&gt;

&lt;p&gt;create table t(i int not null, constraint c unique &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, j int, k int);&lt;br/&gt;
insert into t values (1,10,1),(2,40,1),(3,45,1),(4,46,1),(5,90,1);&lt;br/&gt;
select sum(j) from t group by i having i in (select i from t group by i,j );&lt;/p&gt;

&lt;p&gt;gives NPE:&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
java.sql.SQLException: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:87)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.Util.javaException(Util.java:244)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:398)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2201)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.closeOnTransactionError(EmbedResultSet.java:4338)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:467)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.next(EmbedResultSet.java:371)&lt;br/&gt;
	at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:382)&lt;br/&gt;
	at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:338)&lt;br/&gt;
	at org.apache.derby.tools.JDBCDisplayUtil.indent_DisplayResults(JDBCDisplayUtil.java:241)&lt;br/&gt;
	at org.apache.derby.tools.JDBCDisplayUtil.DisplayResults(JDBCDisplayUtil.java:229)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.displayResult(utilMain.java:448)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:522)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:363)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:261)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)&lt;br/&gt;
	at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)&lt;br/&gt;
	at org.apache.derby.tools.ij.main(ij.java:59)&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)&lt;br/&gt;
	... 22 more&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BaseActivation.getColumnFromRow(BaseActivation.java:1451)&lt;br/&gt;
	at org.apache.derby.exe.acf81e0010x0125x09b5xf628x000003d4bf801.e5(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGeneratedClass.java:149)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(ProjectRestrictResultSet.java:268)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.AnyResultSet.getNextRowCore(AnyResultSet.java:171)&lt;br/&gt;
	at org.apache.derby.exe.acf81e0010x0125x09b5xf628x000003d4bf801.g0(Unknown Source)&lt;br/&gt;
	at org.apache.derby.exe.acf81e0010x0125x09b5xf628x000003d4bf801.e3(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGeneratedClass.java:145)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(ProjectRestrictResultSet.java:268)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:471)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:427)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12441126">DERBY-4450</key>
            <summary>GROUP BY in an IN-subquery inside HAVING clause whose select list is subset of group by columns, gives NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="dagw">Dag H. Wanvik</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Nov 2009 23:55:33 +0000</created>
                <updated>Mon, 5 Jul 2010 18:07:59 +0100</updated>
                            <resolved>Sat, 21 Nov 2009 18:55:19 +0000</resolved>
                                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.3.3.0</version>
                    <version>10.4.1.3</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                    <version>10.5.2.0</version>
                    <version>10.5.3.0</version>
                                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12779755" author="dagw" created="Thu, 19 Nov 2009 00:22:20 +0000"  >&lt;p&gt;The problem here is that an extra PRN is added for this case in&lt;br/&gt;
SelectNode to project away the unselected group by columns. This PRN&lt;br/&gt;
is added at the end of SelectNode#genProjectRestrict, ca line 1620.&lt;/p&gt;

&lt;p&gt;However, the predicate of the PRN (for the &quot;IN&quot;) constructed in&lt;br/&gt;
SubqueryNode#pushNewPredicate as a part of SubqueryNode#preprocess,&lt;br/&gt;
has already happened, and knows nothing of the new PRN added by&lt;br/&gt;
SelectNode for this case.&lt;/p&gt;

&lt;p&gt;The consequence is that the IN predicate at code generation time has a&lt;br/&gt;
result column list corresponding to the inner Select node (later&lt;br/&gt;
becoming a PRN), not the PRN sitting on top of it and thus has a wrong&lt;br/&gt;
idea of what result set number to use at execution time. In this case,&lt;br/&gt;
the subquery&apos;s rows are materialized and the SelectNode/PRN result set&lt;br/&gt;
is closed after this is done. Closing clears the current row for that&lt;br/&gt;
result set.&lt;/p&gt;

&lt;p&gt;But since the generated code &quot;thinks&quot; that the result set number for&lt;br/&gt;
the SelectNode/PRN is sitting directly below it, it uses that result&lt;br/&gt;
set number when it synthesizes the materialized UnionResultSet, it&lt;br/&gt;
&lt;b&gt;reuses&lt;/b&gt; that result set number for the UnionResultSet,&lt;br/&gt;
cf. BaseActivation#materializeResultSetIfPossible.&lt;/p&gt;

&lt;p&gt;In reality, at run-time, that result set is two levels below the&lt;br/&gt;
Subquery (AnyResultSet in this case). So, when the predicate is&lt;br/&gt;
evaluated it gives the NPE, since it accesses a result set two levels&lt;br/&gt;
below it, which has already been closed by the materialization, and&lt;br/&gt;
would have been wrong anyway, since the projection PRN is necessary&lt;br/&gt;
and the IN&apos;s PRN predicate needs to have the correct view of what&apos;s under it.&lt;/p&gt;

&lt;p&gt;A possible solution would be to reuse the result column list from the&lt;br/&gt;
original Select in the PRN added by for group by&apos;s projection, so the&lt;br/&gt;
the IN predicate would point to the right result set at code&lt;br/&gt;
generation time. I think that trick is used elsewhere.&lt;/p&gt;</comment>
                            <comment id="12779757" author="bryanpendleton" created="Thu, 19 Nov 2009 00:23:16 +0000"  >&lt;p&gt;&amp;gt; select sum(j) from t group by i having i in (select i from t group by i,j );&lt;/p&gt;

&lt;p&gt;Is this legal? I thought that a HAVING clause could only mention items in the result column list.&lt;/p&gt;</comment>
                            <comment id="12779759" author="dagw" created="Thu, 19 Nov 2009 00:29:56 +0000"  >&lt;p&gt;Bryan, I thought that the requirement is that the HAVING column be present in the GROUP BY list?&lt;br/&gt;
At least Derby barks if it isn&apos;t:&lt;/p&gt;

&lt;p&gt;ERROR 42X24:  Column I is referenced in the HAVING clause but is not in the GROUP BY list.&lt;/p&gt;

&lt;p&gt;But I&apos;ll have a look, thanks!&lt;/p&gt;</comment>
                            <comment id="12779760" author="dagw" created="Thu, 19 Nov 2009 00:33:57 +0000"  >&lt;p&gt;Btw, adding &quot;i&quot; to the column list doesn&apos;t change the outcome:&lt;/p&gt;

&lt;p&gt;select sum(j),i from t group by i having i in (select i from t group by i,j );&lt;/p&gt;

&lt;p&gt;gives the same NPE.&lt;/p&gt;</comment>
                            <comment id="12779762" author="bryanpendleton" created="Thu, 19 Nov 2009 00:38:21 +0000"  >&lt;p&gt;You&apos;re right of course. Column I is the grouping column, and so can certainly be in the HAVING clause.&lt;/p&gt;

&lt;p&gt;Sorry for the red herring.&lt;/p&gt;</comment>
                            <comment id="12779779" author="dagw" created="Thu, 19 Nov 2009 01:05:49 +0000"  >&lt;p&gt;Uploading a patch which makes this example work, but keeping the top RCL when adding the PRN for the projection. The GroupByTest still works, running full regressions. Not for commit; I need to add a new test case as well.&lt;/p&gt;</comment>
                            <comment id="12780153" author="dagw" created="Thu, 19 Nov 2009 17:27:59 +0000"  >&lt;p&gt;Regressions ran cleanly.&lt;/p&gt;</comment>
                            <comment id="12780255" author="dagw" created="Thu, 19 Nov 2009 20:27:21 +0000"  >&lt;p&gt;Attaching derby-4450b which adds a new test case for this bug. Ready for review.&lt;/p&gt;</comment>
                            <comment id="12780660" author="dagw" created="Fri, 20 Nov 2009 17:15:35 +0000"  >&lt;p&gt;This bug first appeared in 10.3, marking as regression.&lt;/p&gt;</comment>
                            <comment id="12780668" author="knutanders" created="Fri, 20 Nov 2009 17:36:30 +0000"  >&lt;p&gt;Thanks for the thorough explanation, Dag. The fix looks clear and correct as far as I can see. +1 to commit.&lt;/p&gt;

&lt;p&gt;Nit: Using the helper method BaseJDBCTestCase.setAutoCommit() would allow you to skip the call to getConnection() in the test case.&lt;/p&gt;</comment>
                            <comment id="12780681" author="dagw" created="Fri, 20 Nov 2009 18:03:17 +0000"  >&lt;p&gt;This regression was introduced by svn 516454 (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="12780779" author="dagw" created="Fri, 20 Nov 2009 22:01:35 +0000"  >&lt;p&gt;Committed on trunk as svn 882732, including Knut&apos;s proposed simplification; thanks for looking at this!&lt;/p&gt;</comment>
                            <comment id="12781026" author="dagw" created="Sat, 21 Nov 2009 18:54:18 +0000"  >&lt;p&gt;Backported to 10.3 as svn 882958.&lt;br/&gt;
Backported to 10.4 as svn 882965.&lt;br/&gt;
Backported to 10.5 as svn 882966, closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12325311">DERBY-681</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12425416" name="derby-4450.diff" size="1406" author="dagw" created="Thu, 19 Nov 2009 01:05:49 +0000"/>
                            <attachment id="12425520" name="derby-4450b.diff" size="2794" author="dagw" created="Thu, 19 Nov 2009 20:27:21 +0000"/>
                            <attachment id="12425521" name="derby-4450b.stat" size="157" author="dagw" created="Thu, 19 Nov 2009 20:27:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 19 Nov 2009 00:23:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24263</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0pxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>