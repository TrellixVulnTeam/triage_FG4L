<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:41 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3235/DERBY-3235.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3235] Implement the replication stop functionality</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3235</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description></description>
                <environment></environment>
        <key id="12383494">DERBY-3235</key>
            <summary>Implement the replication stop functionality</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12372418">DERBY-2872</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="narayanan">V.Narayanan</assignee>
                                    <reporter username="narayanan">V.Narayanan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Nov 2007 08:47:09 +0000</created>
                <updated>Thu, 6 Mar 2008 23:09:35 +0000</updated>
                            <resolved>Thu, 6 Mar 2008 23:09:16 +0000</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12546621" author="narayanan" created="Thu, 29 Nov 2007 09:11:24 +0000"  >&lt;p&gt;The stop message is basically given to the master. The master then transmits this to the slave.&lt;/p&gt;

&lt;p&gt;The basic steps that will be performed when a stop command is given to the master are&lt;/p&gt;

&lt;p&gt;1) Stop adding log records to the log buffer&lt;br/&gt;
2) Flush all the log records in the log buffer and send&lt;br/&gt;
    them to the slave.&lt;br/&gt;
3) Send the Stop replication message to the slave&lt;/p&gt;</comment>
                            <comment id="12546624" author="narayanan" created="Thu, 29 Nov 2007 09:18:17 +0000"  >&lt;p&gt;Since the stop message needs to be sent from the master to the slave, &lt;br/&gt;
this issue will need the Stop message type being introduced in Derby-3206.&lt;/p&gt;</comment>
                            <comment id="12546625" author="narayanan" created="Thu, 29 Nov 2007 09:21:03 +0000"  >&lt;p&gt;This issue needs the log shipper to transmit messages to the slave and also for&lt;br/&gt;
flushing the log buffer and transmitting the log records to the slave. It therefore&lt;br/&gt;
depends on the log shipper integration patch that has been submitted in 3064.&lt;/p&gt;</comment>
                            <comment id="12546629" author="narayanan" created="Thu, 29 Nov 2007 09:37:47 +0000"  >&lt;p&gt;Pls find attached a preliminary patch that contains the implementation &lt;br/&gt;
of the above mentioned steps..&lt;/p&gt;

&lt;p&gt;Pls note that the patch is not for commit.&lt;/p&gt;</comment>
                            <comment id="12551503" author="oysteing" created="Thu, 13 Dec 2007 13:38:39 +0000"  >&lt;p&gt;Narayanan, the patch does not apply cleanly to head of trunk anymore.  Could you please generate a new version of the patch?&lt;/p&gt;</comment>
                            <comment id="12552261" author="narayanan" created="Sun, 16 Dec 2007 18:08:29 +0000"  >&lt;p&gt;Thank you for taking a look at the preliminary patch. I have attached a new version of the stop patch.&lt;/p&gt;</comment>
                            <comment id="12552435" author="oysteing" created="Mon, 17 Dec 2007 15:11:43 +0000"  >&lt;p&gt;Thanks for the patch Narayanan.  It looks good. Will there be more&lt;br/&gt;
code coming for clean-up of the slave?  (I see there is a todo tag in&lt;br/&gt;
StopSlave, but I am not quite sure what needs to be done.)&lt;/p&gt;

&lt;p&gt;Why is AsynchronousLogShipper#flushBuffer not synchronized while&lt;br/&gt;
shipALogChunk is?  Another question is whether these two methods could&lt;br/&gt;
share some code.  Could flushBuffer be implemented as&lt;br/&gt;
&quot;while(shipALogChunk());&quot;?&lt;/p&gt;

&lt;p&gt;One minor issue:  Javadoc for stopMaster() says that it throws&lt;br/&gt;
StandardException.  It does not.&lt;/p&gt;
</comment>
                            <comment id="12553220" author="narayanan" created="Wed, 19 Dec 2007 03:31:50 +0000"  >&lt;p&gt;Thank you for the comments on the patch Oystein.&lt;/p&gt;

&lt;p&gt;&amp;gt;Thanks for the patch Narayanan. It looks good. Will there be more &lt;br/&gt;
&amp;gt;code coming for clean-up of the slave? (I see there is a todo tag in &lt;br/&gt;
&amp;gt;StopSlave, but I am not quite sure what needs to be done.)&lt;/p&gt;

&lt;p&gt;I have posted a preliminary patch for failover in which I have posted implementation&lt;br/&gt;
for logToFile.stopReplicationSlaveRole. The other todos will be addressed in incremental&lt;br/&gt;
patches. I will move the stopReplicationRole implementation to this patch if the community&lt;br/&gt;
feels that is the better way to do. I however do not see much difference however since the &lt;br/&gt;
code is not used for now.&lt;/p&gt;

&lt;p&gt;&amp;gt;Why is AsynchronousLogShipper#flushBuffer not synchronized while &lt;br/&gt;
&amp;gt;shipALogChunk is? Another question is whether these two methods could &lt;br/&gt;
&amp;gt;share some code. Could flushBuffer be implemented as &lt;br/&gt;
&amp;gt;&quot;while(shipALogChunk());&quot;? &lt;/p&gt;

&lt;p&gt;Agreed! Implemented in the suggested way.&lt;/p&gt;

&lt;p&gt;&amp;gt;One minor issue: Javadoc for stopMaster() says that it throws &lt;br/&gt;
&amp;gt;StandardException. It does not.&lt;/p&gt;

&lt;p&gt;fixed!&lt;/p&gt;</comment>
                            <comment id="12553375" author="oysteing" created="Wed, 19 Dec 2007 15:02:50 +0000"  >&lt;p&gt;Thank you for addressing my comments, Narayanan.&lt;br/&gt;
Took the liberty to change the wording of the javadoc for the return valueof shipALogChunk&lt;br/&gt;
before committing the patch as version 605556.&lt;/p&gt;</comment>
                            <comment id="12553377" author="knutanders" created="Wed, 19 Dec 2007 15:10:18 +0000"  >&lt;p&gt;Hi, I noticed this diff in MasterFactory:&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Will perform all work that is needed to shut down replication&lt;br/&gt;
+     *&lt;br/&gt;
+     * @throws StandardException Standard Derby exception policy,&lt;br/&gt;
+     *                           thrown on replication stop failure.&lt;br/&gt;
      */&lt;br/&gt;
     public void stopMaster();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The javadoc says that an exception is thrown, whereas the signature doesn&apos;t. The implementation in MasterController seems to log the exceptions instead of throwing them, so perhaps the @throws tag should be removed?&lt;/p&gt;</comment>
                            <comment id="12553388" author="oysteing" created="Wed, 19 Dec 2007 15:59:13 +0000"  >&lt;p&gt;Good catch, Knut Anders.  Fixed in revision 605595.&lt;/p&gt;</comment>
                            <comment id="12555516" author="narayanan" created="Thu, 3 Jan 2008 09:23:26 +0000"  >&lt;p&gt;All the patches for this issue have been committed.&lt;/p&gt;</comment>
                            <comment id="12555522" author="oysteing" created="Thu, 3 Jan 2008 10:13:22 +0000"  >&lt;p&gt;It seems to me that there are still pieces that are missing from the implementation of stop replication.  I cannot find any code that interrupts the ongoing booting of the database at the slave.  When the patch for failover (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3254&quot; title=&quot;Implement the replication failover functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3254&quot;&gt;&lt;del&gt;DERBY-3254&lt;/del&gt;&lt;/a&gt;) is committed, executing stop will cause the slave to complete its booting and be able to start serving clients.  I guess that is not the intention.&lt;/p&gt;</comment>
                            <comment id="12558719" author="narayanan" created="Mon, 14 Jan 2008 18:43:13 +0000"  >&lt;p&gt;re-opened to address comments and issues pointed out by Oystein&lt;/p&gt;</comment>
                            <comment id="12558721" author="narayanan" created="Mon, 14 Jan 2008 18:45:32 +0000"  >&lt;p&gt;Oystein says&lt;/p&gt;

&lt;p&gt;&quot;I tried a connnection with stopMaster=true in ij and it seemed to work well. However, when I tried to exit ij, nothing happened. A QUIT signal to the java process, showed that the LogShipper thread is still around:&lt;/p&gt;

&lt;p&gt;Full thread dump Java HotSpot(TM) Server VM (1.6.0_01-b06 mixed mode):&lt;/p&gt;

&lt;p&gt;&quot;DestroyJavaVM&quot; prio=10 tid=0x08070c00 nid=0x2 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00000000..0xfe56bbb0&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;/p&gt;

&lt;p&gt;&quot;Thread-1&quot; prio=10 tid=0x08412400 nid=0x10 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0xb64cd000..0xb64cd970&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (on object monitor)&lt;br/&gt;
       at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0xf408f0e0&amp;gt; (a org.apache.derby.impl.services.replication.master.AsynchronousLogShipper)&lt;br/&gt;
  at org.apache.derby.impl.services.replication.master.AsynchronousLogShipper.run(AsynchronousLogShipper.java:133)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0xf408f0e0&amp;gt; (a org.apache.derby.impl.services.replication.master.AsynchronousLogShipper)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;[ Show &#187; ]&lt;br/&gt;
&#216;ystein Gr&#248;vlen - 14/Jan/08 07:09 AM I tried a connnection with stopMaster=true in ij and it seemed to work well. However, when I tried to exit ij, nothing happened. A QUIT signal to the java process, showed that the LogShipper thread is still around: Full thread dump Java HotSpot(TM) Server VM (1.6.0_01-b06 mixed mode): &quot;DestroyJavaVM&quot; prio=10 tid=0x08070c00 nid=0x2 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00000000..0xfe56bbb0&amp;#93;&lt;/span&gt;    java.lang.Thread.State: RUNNABLE &quot;Thread-1&quot; prio=10 tid=0x08412400 nid=0x10 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0xb64cd000..0xb64cd970&amp;#93;&lt;/span&gt;    java.lang.Thread.State: TIMED_WAITING (on object monitor)        at java.lang.Object.wait(Native Method)  - waiting on &amp;lt;0xf408f0e0&amp;gt; (a org.apache.derby.impl.services.replication.master.AsynchronousLogShipper)   at org.apache.derby.impl.services.replication.master.AsynchronousLogShipper.run(AsynchronousLogShipper.java:133)         - locked &amp;lt;0xf408f0e0&amp;gt; (a org.apache.derby.impl.services.replication.master.AsynchronousLogShipper)&lt;br/&gt;
&quot;&lt;/p&gt;</comment>
                            <comment id="12560931" author="narayanan" created="Mon, 21 Jan 2008 04:58:34 +0000"  >&lt;p&gt;I encountered a similar problem while working on the failover issue,&lt;br/&gt;
I resolved the issue using AsynchronousLogShipper#stopLogShippment.&lt;br/&gt;
I have done the same for the issue pointed out by using AsynchronousLogShipper#stopLogShippment in MasterController#stopMaster. &lt;/p&gt;

&lt;p&gt;I am yet to run tests on this patch, will run the tests and shall revert back with the&lt;br/&gt;
results.&lt;/p&gt;</comment>
                            <comment id="12560979" author="narayanan" created="Mon, 21 Jan 2008 10:45:13 +0000"  >&lt;p&gt;Ran junit all on this issue and did not see any failures (except the usual access control exceptions I get on a freshworkspace also). I do not expect any failures&lt;br/&gt;
in the old tests since this patch does not affect any part of that code.&lt;/p&gt;

&lt;p&gt;I request for this patch to be considered for a commit.&lt;/p&gt;</comment>
                            <comment id="12560995" author="oysteing" created="Mon, 21 Jan 2008 12:59:41 +0000"  >&lt;p&gt;Patch, StopImplementation_v3.diff, committed as revision 613866.&lt;br/&gt;
I tested that it is now possible to quit ij after the master has been stopped.&lt;/p&gt;

&lt;p&gt;However, if I shut down the database without stopping replication, I still get the hang.&lt;br/&gt;
I think we need to stop the LogShipperThread in that case, too.  (Alternatively, we could prevent&lt;br/&gt;
shut down of replicated databases). &lt;/p&gt;</comment>
                            <comment id="12561003" author="jorgenlo" created="Mon, 21 Jan 2008 13:17:07 +0000"  >&lt;p&gt;&amp;gt; Alternatively, we could prevent shut down of replicated databases&lt;/p&gt;

&lt;p&gt;I don&apos;t think that&apos;s an option since that would break the shutdown server functionality. From the top of my head, I think server shutdown is implemented by first shutting down all booted databases and then shut down the server. If you throw an exception, e.g., shutdown server would result in a shutdown of the databases that by chance were iterated over before the replicated database was attempted shut down, but not the rest. Unless, of course, you want to change the shutdown server functionality as well...&lt;/p&gt;</comment>
                            <comment id="12575944" author="narayanan" created="Thu, 6 Mar 2008 23:09:16 +0000"  >&lt;p&gt;Derby-3447 has been raised to address issues concerned.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12377881">DERBY-3064</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12382576">DERBY-3206</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12371757" name="StopImplementation_v1.diff" size="6346" author="narayanan" created="Sun, 16 Dec 2007 18:08:29 +0000"/>
                            <attachment id="12371758" name="StopImplementation_v1.stat" size="450" author="narayanan" created="Sun, 16 Dec 2007 18:08:29 +0000"/>
                            <attachment id="12370515" name="StopImplementation_v1_NotForCommit.diff" size="5599" author="narayanan" created="Thu, 29 Nov 2007 09:37:47 +0000"/>
                            <attachment id="12370516" name="StopImplementation_v1_NotForCommit.stat" size="362" author="narayanan" created="Thu, 29 Nov 2007 09:37:47 +0000"/>
                            <attachment id="12371924" name="StopImplementation_v2.diff" size="6522" author="narayanan" created="Wed, 19 Dec 2007 03:31:50 +0000"/>
                            <attachment id="12371925" name="StopImplementation_v2.stat" size="450" author="narayanan" created="Wed, 19 Dec 2007 03:31:50 +0000"/>
                            <attachment id="12373657" name="StopImplementation_v3.diff" size="675" author="narayanan" created="Mon, 21 Jan 2008 04:58:33 +0000"/>
                            <attachment id="12373658" name="StopImplementation_v3.stat" size="91" author="narayanan" created="Mon, 21 Jan 2008 04:58:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 13 Dec 2007 13:38:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0z73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39520</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>