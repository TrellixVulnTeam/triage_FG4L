<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:28 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3567/DERBY-3567.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3567] AsynchronousLogShipper#forceFlush should time out</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3567</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If the network connection to the slave is lost, ObjectOutputStream#writeObject may be blocked for 2 minutes before failing (not configurable TCP property). &lt;/p&gt;

&lt;p&gt;Currently, ALS#forceFlush sends a chunk of log to the slave using the client thread. The client thread cannot be blocked for 2 minutes before giving up. Rather, it should notify the log shipper that it has to send log immediately, and then wait for a short while (until notified or e.g. maximum 5 seconds). If the log shipper has not been able to empty some space in the log buffer by then, replication should be stopped.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12392235">DERBY-3567</key>
            <summary>AsynchronousLogShipper#forceFlush should time out</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jorgenlo">J&#248;rgen L&#248;land</assignee>
                                    <reporter username="jorgenlo">J&#248;rgen L&#248;land</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Mar 2008 09:16:46 +0000</created>
                <updated>Wed, 2 Jun 2010 12:12:59 +0100</updated>
                            <resolved>Fri, 4 Apr 2008 15:59:46 +0100</resolved>
                                    <version>10.4.1.3</version>
                    <version>10.5.1.1</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12583657" author="jorgenlo" created="Mon, 31 Mar 2008 13:27:05 +0100"  >&lt;p&gt;Attaching patch 1a which makes ALS#forceFlush time out after 5 seconds. The patch passed the replication suite. &lt;/p&gt;

&lt;p&gt;Not assigning since I most likely will not have time to work on this issue for a while.&lt;/p&gt;</comment>
                            <comment id="12584502" author="narayanan" created="Wed, 2 Apr 2008 11:16:35 +0100"  >&lt;p&gt;The patch looks complete and very good,&lt;/p&gt;

&lt;p&gt;Work has been done to remove the dependency of the forceFlush function on the client&lt;br/&gt;
thread and instead make the log shipper thread do the work.&lt;/p&gt;

&lt;p&gt;I request the patch attached to this issue to be pls considered for a commit.&lt;/p&gt;</comment>
                            <comment id="12584504" author="narayanan" created="Wed, 2 Apr 2008 11:20:07 +0100"  >&lt;p&gt;The patch attached by Jorgen to this issue looks good to me.&lt;br/&gt;
Jorgen has also indicated that the replication suite of tests&lt;br/&gt;
pass. Hence assigning this issue to him.&lt;/p&gt;</comment>
                            <comment id="12584520" author="oysteing" created="Wed, 2 Apr 2008 12:40:38 +0100"  >&lt;p&gt;Thanks for the patch, J&#248;rgen.  &lt;br/&gt;
If I am not wrong, I think that with this patch there is a chance that threads that are waiting for a flush, will not be notified.&lt;br/&gt;
Consider the case when two threads are calling forceFlush concurrently.  As far as I can tell, both may be waiting for a log send to complete, but only one thread will be notified when the sending has been completed.  Since, forceFlushed is then false, no further notification may be done.  Hence, the second thread may time out and cause replication to be stopped.&lt;/p&gt;

&lt;p&gt;I do not think it will work to just switch to notifyAll, since it is not guaranteed that a single write is sufficient to have space for all waiting threads to write their log records.  Instead, I suggest that notify can be called after every send, regardless of whether anyone may be waiting or not.  I am not sure the extra synchronization overhead will be big since the current solution involves access to a volatile variable anyway.&lt;/p&gt;
</comment>
                            <comment id="12584545" author="oysteing" created="Wed, 2 Apr 2008 13:37:58 +0100"  >&lt;p&gt;I discovered that my scenario with multiple waiting threads are not possible since calls to appendLog is protected by logFileSemaphore in LogAccessFile.  Hence, it is not strictly necessary to make forceFlush thread safe.  However, I think my suggestion simplifies the code, and I do not the extra overhead of calling notify on each send instead of checking a volatile field should be very large. Patch derby-3567-1b.diff removes the volatile variable.&lt;/p&gt;</comment>
                            <comment id="12584591" author="narayanan" created="Wed, 2 Apr 2008 15:36:16 +0100"  >&lt;p&gt;what happens if network goes down in flushBuffer? The problem reported in this JIRA seems to&lt;br/&gt;
exist in flushBuffer also. I think we need a thread in that method too.&lt;/p&gt;</comment>
                            <comment id="12584612" author="jorgenlo" created="Wed, 2 Apr 2008 15:54:11 +0100"  >&lt;p&gt;&amp;gt; I discovered that my scenario with multiple waiting threads are not possible since calls to appendLog is protected by logFileSemaphore in LogAccessFile.&lt;/p&gt;

&lt;p&gt;The patch was written under the assumption that only one thread will access appendLog because of this semaphore, but I forgot to document it.&lt;/p&gt;

&lt;p&gt;&amp;gt; what happens if network goes down in flushBuffer? The problem reported in this JIRA seems to&lt;br/&gt;
exist in flushBuffer also. I think we need a thread in that method too.&lt;/p&gt;

&lt;p&gt;I agree - this is a similar case.&lt;/p&gt;</comment>
                            <comment id="12585125" author="oysteing" created="Thu, 3 Apr 2008 15:35:47 +0100"  >&lt;p&gt;I think forceFlush also needs to consider the stopShipping flag. If the flag is set, the log shipper thread may exit its loop without notifying the waiting thread.  This will cause an unecessary delay of a waiting user thread.&lt;/p&gt;</comment>
                            <comment id="12585465" author="oysteing" created="Fri, 4 Apr 2008 10:35:09 +0100"  >&lt;p&gt;Uploading a new patch v3, where I have also made stopShipping volatile&lt;br/&gt;
in order to ensure that the LogShipper thread see any changes made by&lt;br/&gt;
other threads.  I will commit this patch soon.&lt;/p&gt;
</comment>
                            <comment id="12585562" author="oysteing" created="Fri, 4 Apr 2008 15:59:46 +0100"  >&lt;p&gt;Committed to trunk at revision 644716.&lt;br/&gt;
Committed to 10.4 branch at revision 644733.&lt;/p&gt;</comment>
                            <comment id="12874543" author="kristwaa" created="Wed, 2 Jun 2010 12:12:59 +0100"  >&lt;p&gt;Closing issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12378956" name="derby-3567-1a.diff" size="4128" author="jorgenlo" created="Mon, 31 Mar 2008 13:27:04 +0100"/>
                            <attachment id="12378957" name="derby-3567-1a.stat" size="182" author="jorgenlo" created="Mon, 31 Mar 2008 13:27:05 +0100"/>
                            <attachment id="12379129" name="derby-3567-1b.diff" size="3626" author="oysteing" created="Wed, 2 Apr 2008 13:37:58 +0100"/>
                            <attachment id="12379371" name="derby-3567-1c.diff" size="4432" author="oysteing" created="Fri, 4 Apr 2008 10:35:09 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 2 Apr 2008 10:16:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0q67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38058</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>