<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:51:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4274/DERBY-4274.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4274] SYSCS_UPDATE_STATISTICS takes unnecessary table lock</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4274</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I&apos;m using SYSCS_UTIL.SYSCS_UPDATE_STATISTICS in an application and see deadlocks similar to this one from time to time:&lt;/p&gt;

&lt;p&gt;Caused by: java.sql.SQLTransactionRollbackException: A lock could not be obtained due to a deadlock, cycle of locks and waiters is:&lt;br/&gt;
Lock : ROW, SYSSTATISTICS, (2,20)&lt;br/&gt;
  Waiting XID : &lt;/p&gt;
{20137, S}
&lt;p&gt; , APP, SELECT CS.REVISION, A.NAME, CS.TIME, CS.MESSAGE, F2.PATH FROM CHANGESETS CS, FILECHANGES FC, REPOSITORIES R, FILES F, AUTHORS A, FILECHANGES FC2, FILES F2 WHERE R.PATH = ? AND F.PATH LIKE ? ESCAPE &apos;#&apos; AND F.REPOSITORY = R.ID AND A.REPOSITORY = R.ID AND CS.ID = FC.CHANGESET AND R.ID = CS.REPOSITORY AND FC.FILE = F.ID AND A.ID = CS.AUTHOR AND CS.ID = FC2.CHANGESET AND FC2.FILE = F2.ID ORDER BY CS.ID DESC&lt;br/&gt;
  Granted XID : &lt;/p&gt;
{20134, X} &lt;br/&gt;
Lock : TABLE, CHANGESETS, Tablelock&lt;br/&gt;
  Waiting XID : {20134, X}
&lt;p&gt; , APP, alter table &quot;APP&quot;.&quot;CHANGESETS&quot; all update statistics &lt;br/&gt;
  Granted XID : &lt;/p&gt;
{20137, IS}
&lt;p&gt; &lt;br/&gt;
. The selected victim is XID : 20137.&lt;/p&gt;

&lt;p&gt;Here, a select statement is being re-prepared because update statistics has invalidated it, but it has to wait for update statistics to finish in order to read the new statistics from SYSSTATISTICS. Then update statistics attempts to obtain an exclusive lock on the table whose indexes are being updated, but it has to wait because the select statement is holding an intention lock on the table. Both transactions wait for each other, so we have a deadlock.&lt;/p&gt;

&lt;p&gt;Since SYSCS_UPDATE_STATISTICS does not update the table, only its entries in SYSSTATISTICS, there is no need to take an exclusive table lock. If it didn&apos;t lock the table exclusively, this deadlock situation would go away.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12427979">DERBY-4274</key>
            <summary>SYSCS_UPDATE_STATISTICS takes unnecessary table lock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jun 2009 09:48:10 +0100</created>
                <updated>Thu, 16 Jul 2009 22:24:21 +0100</updated>
                            <resolved>Wed, 17 Jun 2009 23:00:08 +0100</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.5.2.0</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12720003" author="knutanders" created="Tue, 16 Jun 2009 10:19:51 +0100"  >&lt;p&gt;The exclusive lock is obtained in AlterTableConstantAction.executeConstantAction():&lt;/p&gt;

&lt;p&gt;		// now do the real work&lt;/p&gt;

&lt;p&gt;		// get an exclusive lock of the heap, to avoid deadlock on rows of&lt;br/&gt;
		// SYSCOLUMNS etc datadictionary tables and phantom table&lt;br/&gt;
		// descriptor, in which case table shape could be changed by a&lt;br/&gt;
		// concurrent thread doing add/drop column.&lt;br/&gt;
.&lt;br/&gt;
.&lt;br/&gt;
.&lt;br/&gt;
		lockTableForDDL(tc, tableConglomerateId, true);&lt;/p&gt;

&lt;p&gt;When this code is called, the index cardinality statistics have already been updated, just not committed, so there&apos;s no need for the lock. It looks to me as if the update statistics work is done, and it goes on to doing &quot;normal&quot; alter table work, which is nothing in the case of update statistics. Looking at the code for in-place compress, it returns from executeConstantAction() before it gets to this point, and I believe that update statistics should do the same.&lt;/p&gt;

&lt;p&gt;The attached patch changes AlterTableConstantAction.executeConstantAction() so that it returns immediately when it has finished updating the statistics. It also adds a test case to UpdateStatisticsTest where SYSCS_UPDATE_STATISTICS is called on a table locked by another transaction in shared mode. It fails with a timeout without the fix and passes with the fix.&lt;/p&gt;

&lt;p&gt;Running the full regression test suite now.&lt;/p&gt;</comment>
                            <comment id="12720111" author="knutanders" created="Tue, 16 Jun 2009 14:10:47 +0100"  >&lt;p&gt;Regression tests passed.&lt;/p&gt;</comment>
                            <comment id="12720242" author="dagw" created="Tue, 16 Jun 2009 18:05:12 +0100"  >&lt;p&gt;Looks good to me! &lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12720637" author="knutanders" created="Wed, 17 Jun 2009 13:25:59 +0100"  >&lt;p&gt;Thanks Dag. Committed revision 785570. I will leave the issue open until it has been back-ported to 10.5.&lt;/p&gt;</comment>
                            <comment id="12720930" author="knutanders" created="Wed, 17 Jun 2009 23:00:07 +0100"  >&lt;p&gt;Merged to 10.5 and committed revision 785828.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12410771" name="d4274-1a.diff" size="2136" author="knutanders" created="Tue, 16 Jun 2009 10:19:51 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 16 Jun 2009 17:05:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24146</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0s4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38374</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>