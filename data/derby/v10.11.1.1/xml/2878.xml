<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2878/DERBY-2878.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2878] Scan protection handle could be cached in BasePage</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2878</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Each time a leaf node in a B-tree is visited in an index scan, a scan protection row is locked and unlocked. Both the lock operation and the unlock operation will allocate a new RecordId object representing the scan protection row (the unlock operation additionally allocates a PageKey object for the RecordId). Since the scan protection handle created will be identical (seen from equals()) each time it is created for a page, it would make sense to cache it in BasePage. Then we only need to allocate the protection handle for a page once for as long as it stays in the page cache. This would save three object allocations per single-record lookup via index.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12372508">DERBY-2878</key>
            <summary>Scan protection handle could be cached in BasePage</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jun 2007 15:04:43 +0100</created>
                <updated>Mon, 29 Jun 2009 15:09:01 +0100</updated>
                            <resolved>Thu, 19 Jul 2007 08:19:47 +0100</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12508859" author="knutanders" created="Thu, 28 Jun 2007 16:49:29 +0100"  >&lt;p&gt;Attached is the first step towards eliminating the allocation of protection handles. It adds a method to Page/BasePage called getProtectionRecordHandle(). This method creates a new record handle if it hasn&apos;t been called before and returns a cached value otherwise. B2IRowLocking3.lockScan() and lockScanForReclaimSpace() have been modified to use the new method.&lt;/p&gt;

&lt;p&gt;unlockScan() still allocates a protection handle since it cannot access the page object, but it should be fairly easy to make it reuse the handle too.&lt;/p&gt;

&lt;p&gt;suites.All and derbyall passed.&lt;/p&gt;</comment>
                            <comment id="12508886" author="mikem" created="Thu, 28 Jun 2007 19:13:04 +0100"  >&lt;p&gt;I reviewed this change and it looks good to me, and the approach also seems good. &lt;/p&gt;

&lt;p&gt;Not really part of this change, but did spend some time verifying that fillInIdenity was never called unless initialize() had been &lt;br/&gt;
called first.  It would be very bad if this got called but the old cached record handle got left around.  If it were me I would probably&lt;br/&gt;
add an extra assert there.   And maybe add asserts somewhere verifying that the record handle is the right recordhandle.  I think&lt;br/&gt;
the current code is right, the asserts are to catch future changes.  A bug in this area is going to really hard to track down as we just&lt;br/&gt;
will be locking the wrong object so no obvious exceptions, just a mysterious timing problems with concurrent scans in a busy &lt;br/&gt;
system.&lt;/p&gt;</comment>
                            <comment id="12509109" author="knutanders" created="Fri, 29 Jun 2007 14:44:30 +0100"  >&lt;p&gt;Thanks Mike, that&apos;s a great suggestion. I have attached a new patch which asserts that protectionHandle is null in fillInIdentity(), and that its page id is equal to the identity of the BasePage instance in getProtectionRecordHandle(). I have started the full regression test suite.&lt;/p&gt;</comment>
                            <comment id="12509137" author="knutanders" created="Fri, 29 Jun 2007 17:03:36 +0100"  >&lt;p&gt;Committed revision 551933.&lt;/p&gt;</comment>
                            <comment id="12509565" author="knutanders" created="Mon, 2 Jul 2007 14:13:25 +0100"  >&lt;p&gt;Attaching new patch (derby-2878-2.diff) which is a pure refactoring of BTreeScan. It adds a private method called unlockCurrentScan() to the class, and replaces all occurrences of&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pos.current_scan_pageno != 0)&lt;/li&gt;
	&lt;li&gt;{
-            this.getLockingPolicy().unlockScan(pos.current_scan_pageno);
-            pos.current_scan_pageno = 0;
-        }
&lt;p&gt;with a call to that method. This makes it simpler to reuse the protection handle for unlockScan() since there are fewer places that need modification.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Derbyall and suites.All passed.&lt;/p&gt;</comment>
                            <comment id="12509754" author="knutanders" created="Tue, 3 Jul 2007 07:06:32 +0100"  >&lt;p&gt;Committed revision 552677.&lt;/p&gt;</comment>
                            <comment id="12510636" author="knutanders" created="Fri, 6 Jul 2007 10:27:22 +0100"  >&lt;p&gt;Attaching a new patch which removes the allocation of a scan&lt;br/&gt;
protection handle when the scan is unlocked. This removes one RecordId&lt;br/&gt;
allocation and one PageKey allocation per visited leaf node in a&lt;br/&gt;
B-tree scan.&lt;/p&gt;

&lt;p&gt;What the patch does, is&lt;/p&gt;

&lt;p&gt;  1) Remove the current_scan_pageno field from BTreeRowPosition and&lt;br/&gt;
  replace it with current_scan_protectionHandle (a RecordHandle).&lt;/p&gt;

&lt;p&gt;  2) Change the signature of unlockScan() so that it takes a record&lt;br/&gt;
  handle instead of a page number.&lt;/p&gt;

&lt;p&gt;  3) Add a method isRowLockingPolicy() to the BTreeLockingPolicy&lt;br/&gt;
  interface. This method returns false for the B2INoLocking classes&lt;br/&gt;
  and true for the B2IRowLocking classes. The return value is used to&lt;br/&gt;
  determine whether a protection handle should be requested.&lt;/p&gt;

&lt;p&gt;  4) Where the B-tree scan previously set current_scan_pageno to the&lt;br/&gt;
  page number, now set current_scan_protectionHandle to the scan&lt;br/&gt;
  protection record handle if isRowLockingPolicy() returns true. This&lt;br/&gt;
  code has also been factored out into a separate method called&lt;br/&gt;
  BTreeScan.setCurrentScanProtectionHandle().&lt;/p&gt;

&lt;p&gt;  5) Remove OpenBTree.makeRecordHandle() which is no longer used.&lt;/p&gt;

&lt;p&gt;  6) Change all the asserts that used current_scan_pageno so that they&lt;br/&gt;
  use current_scan_protectionHandle.&lt;/p&gt;

&lt;p&gt;All the regression tests (derbyall and suites.All) passed.&lt;/p&gt;</comment>
                            <comment id="12513492" author="knutanders" created="Wed, 18 Jul 2007 10:05:25 +0100"  >&lt;p&gt;Attaching a new and simpler patch (3a) which replaces patch 3. The new patch only makes these changes:&lt;/p&gt;

&lt;p&gt;  1) replaces the field current_scan_pageno (a long) in BTreeRowPosition with current_scan_protectionHandle (a RecordHandle which is cached in BasePage)&lt;br/&gt;
  2) changes the signature of BTreeLockingPolicy.unlockScan() to take a RecordHandle&lt;br/&gt;
  3) removes unused method OpenBTree.makeRecordHandle()&lt;/p&gt;

&lt;p&gt;With this patch, a B-tree scan does not allocate any protection record handle if the leaf pages it visits are in the page cache and have been scanned before. Derbyall and suites.All passed with the new patch.&lt;/p&gt;</comment>
                            <comment id="12513835" author="knutanders" created="Thu, 19 Jul 2007 08:19:47 +0100"  >&lt;p&gt;Committed 3a with revision 557507.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12360746" name="derby-2878-1.diff" size="3753" author="knutanders" created="Thu, 28 Jun 2007 16:49:29 +0100"/>
                            <attachment id="12360747" name="derby-2878-1.stat" size="217" author="knutanders" created="Thu, 28 Jun 2007 16:49:29 +0100"/>
                            <attachment id="12360816" name="derby-2878-1b.diff" size="4202" author="knutanders" created="Fri, 29 Jun 2007 14:44:30 +0100"/>
                            <attachment id="12360937" name="derby-2878-2.diff" size="4022" author="knutanders" created="Mon, 2 Jul 2007 14:13:25 +0100"/>
                            <attachment id="12361279" name="derby-2878-3.diff" size="14712" author="knutanders" created="Fri, 6 Jul 2007 10:27:22 +0100"/>
                            <attachment id="12361280" name="derby-2878-3.stat" size="564" author="knutanders" created="Fri, 6 Jul 2007 10:27:22 +0100"/>
                            <attachment id="12362045" name="derby-2878-3a.diff" size="11945" author="knutanders" created="Wed, 18 Jul 2007 10:05:25 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 28 Jun 2007 18:13:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30639</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0wp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39115</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>