<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:17:06 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4988/DERBY-4988.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4988] ALTER TABLE DROP COLUMN should make use of information in SYSTRIGGERS to detect column used through REFERENCING clause to find trigger dependencies</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4988</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;At the time of ALTER TABLE DROP COLUMN, Derby checks if the column being dropped in a trigger column and if so, then it will not drop the column if it is being done in RESTRICT mode or it will drop the trigger while dropping the column in CASCADE mode. This does not implement SQL standard to it&apos;s entirety. &lt;/p&gt;

&lt;p&gt;**************************************&lt;br/&gt;
SQL standard says following about ALTER TABLE DROP COLUMN RESTRICT and trigger dependency in CREATE TRIGGER section &lt;/p&gt;

&lt;p&gt;If RESTRICT is specified, then C shall not be referenced in any of the following &lt;br/&gt;
d) Either an explicit trigger column list or a triggered action column set of any trigger descriptor. &lt;br/&gt;
(The triggered action column set included in the trigger descriptor is the set of all distinct, fully qualified names of columns contained in the &amp;lt;triggered action&amp;gt;.) &lt;br/&gt;
**************************************&lt;/p&gt;

&lt;p&gt;What is missing from Derby implementation from SQL standard point of view is detected triggered action column set.&lt;/p&gt;

&lt;p&gt;Starting 10.7(with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1482&quot; title=&quot;Update triggers on tables with blob columns stream blobs into memory even when the blobs are not referenced/accessed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1482&quot;&gt;&lt;del&gt;DERBY-1482&lt;/del&gt;&lt;/a&gt;), Derby started keeping track of trigger action columns which are referenced through REFERENCING clause. This information can be used to improve the behavior of ALTER TABLE DROP COLUMN in 10.7 and higher. This will not cover all the trigger action columns since columns referenced without the REFERENCING clause are not tracked anywhere at this point. More work will need to be done to implement SQL standard completely. But we can take a step forward by using the information available in 10.7 and higher to detect trigger action columns which are referenced through REFERENCING clause&lt;/p&gt;</description>
                <environment></environment>
        <key id="12497022">DERBY-4988</key>
            <summary>ALTER TABLE DROP COLUMN should make use of information in SYSTRIGGERS to detect column used through REFERENCING clause to find trigger dependencies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="mamtas">Mamta A. Satoor</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Jan 2011 07:26:31 +0000</created>
                <updated>Mon, 17 Jun 2013 10:19:15 +0100</updated>
                            <resolved>Thu, 17 Feb 2011 05:19:29 +0000</resolved>
                                    <version>10.7.1.1</version>
                                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.1.2</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12989502" author="dagw" created="Wed, 2 Feb 2011 03:16:27 +0000"  >&lt;p&gt;Thanks for the patch, Mamta! I am going to read through it as as soon as I find the time.&lt;br/&gt;
It&apos;s good that you have added so many comments throughout, that is a great help. Sometimes, I find them a bit dense to read, though: perhaps it would improve legibility to always add a space between the comment start &quot;//&quot; and the text. And throw in some blank lines where natural, too, maybe. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12989516" author="mamtas" created="Wed, 2 Feb 2011 05:06:29 +0000"  >&lt;p&gt;Committed the changes to trunk with following commit comments&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4988&quot; title=&quot;ALTER TABLE DROP COLUMN should make use of information in SYSTRIGGERS to detect column used through REFERENCING clause to find trigger dependencies&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4988&quot;&gt;&lt;del&gt;DERBY-4988&lt;/del&gt;&lt;/a&gt; ALTER TABLE DROP COLUMN should make use of information in SYSTRIGGERS to detect column used through REFERENCING clause to find trigger dependencies&lt;/p&gt;

&lt;p&gt;Derby at the time of ALTER TABLE DROP COLUMN looks for trigger dependencies by looking for column being dropped in trigger column list but that is not enough. SQL standard requires that column should not be part of explicit trigger column list or a triggered action column set. &lt;/p&gt;

&lt;p&gt;starting Derby 10.7, we have started keeping track of trigger action columns which are referenced through the REFERENCING clause. This commit will make use of that additional info to make a step forward towards meeting the SQL standards. It still does not recognize the trigger action columns that are not part of REFERENCING clause. That work can go separately.&lt;/p&gt;

&lt;p&gt;I have added upgrade test to make sure that the compatibility does not break between Derby releases prior to 10.7 and forward.&lt;/p&gt;
</comment>
                            <comment id="12989521" author="mamtas" created="Wed, 2 Feb 2011 05:37:04 +0000"  >&lt;p&gt;Thanks for taking the time to review the changes, Dag. I will keep your tip in mind about comments.&lt;/p&gt;</comment>
                            <comment id="12989522" author="mamtas" created="Wed, 2 Feb 2011 05:39:36 +0000"  >&lt;p&gt;I will look at backporting this jira to 10.7 once the tests have run successfully on IBM and Sun machines for few nights. They ran fine on my windows XP machine with IBM 16 jdk.&lt;/p&gt;

&lt;p&gt;Also, the changes for this jira should not be backported further back than 10.7. Prior to 10.7, we didn&apos;t keep track of trigger action column used through REFERENCING clause and the changes for this jira relies on that information,&lt;/p&gt;</comment>
                            <comment id="12989951" author="dagw" created="Thu, 3 Feb 2011 03:22:43 +0000"  >&lt;p&gt;Some comment to the patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;AlterTableConstantAction&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;// otherwsie there would be unexpected behaviors&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  Apart from the typo, is this not SQL requirement?&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The &quot;change&quot; variable can probably be eliminated, since this test is&lt;br/&gt;
  repeated over again at end of loop:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         referencedCols&lt;span class=&quot;error&quot;&gt;&amp;#91;j&amp;#93;&lt;/span&gt; &amp;gt; droppedColumnPosition&lt;/p&gt;

&lt;p&gt;  i.e. the first test inside the loop to set &quot;change&quot; could be&lt;br/&gt;
  omitted, too. Test test on &quot;j == refColLen&quot; is a bit opaque, as far&lt;br/&gt;
  as I can tell it means here that we did see the trigger does not&lt;br/&gt;
  depend on the column being dropped, but may need adjustment of one&lt;br/&gt;
  or more of its columns. May be worth a clarification. Could the&lt;br/&gt;
  column index adjustment be moved outside the loop, perhaps (we are&lt;br/&gt;
  logically done when j == refColLen).&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;changedColPositionInTriggerAction is set but not used anywhere?&lt;br/&gt;
  Shouldn&apos;t the positions in referencedColsInTriggerAction be adjusted&lt;br/&gt;
  above droppedColumnPosition, too?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;AlterTableTest&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In the last test case added:&lt;br/&gt;
  //Now try ALTER TABLE DROP COLUMN CASCADE where the column being&lt;br/&gt;
  //dropped is in trigger action of trigger defined on a different table&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  the test then goes on to say:&lt;br/&gt;
  // following is not the right behavior. we should have gotten an error&lt;br/&gt;
  // because column being dropped is getting used in a trigger action &lt;/p&gt;

&lt;p&gt;  I thought that the issue here would be that the trigger isn&apos;t&lt;br/&gt;
  dropped? (since we have cascade mode)&lt;/p&gt;</comment>
                            <comment id="12991639" author="mamtas" created="Mon, 7 Feb 2011 21:57:29 +0000"  >&lt;p&gt;Dag, thanks for taking the time to review the patch. You comments/questions were as follows&lt;br/&gt;
Comments on AlterTableConstantAction &lt;br/&gt;
1)You are right about following. This was a pre-existing comment. I will get rid of it because what we are doing follows the SQL standards.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;// otherwsie there would be unexpected behaviors&lt;br/&gt;
  Apart from the typo, is this not SQL requirement? &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2)&lt;br/&gt;
The &quot;change&quot; variable can probably be eliminated, since this test is repeated over again at end of loop: &lt;/p&gt;

&lt;p&gt;The code about the &quot;change&quot; variable is pre-existing too. Following is why I think it may have been coded this way.&lt;br/&gt;
Inside the &quot;if (j == refColLen &amp;amp;&amp;amp; changed)&quot; true code, we drop the trigger and then adjust the column positions of the affected trigger columns and then recreate the trigger with correct column positions. We drop the trigger because we know from changed being true, that the trigger column position(s) has been affected by the drop column.&lt;/p&gt;

&lt;p&gt;If we took out the information kept by&quot;changed&quot;, then we won&apos;t be sure if we should drop the trigger because we are not certain if any trigger column&apos;s position changed because of the drop column. We could change the &lt;br/&gt;
code inside the if to alway drop the trigger inside the if (j == refColLen) ie even if none of the column positions got impacted, then rearrange the column positions if needed and then recreate the trigger. ALTER TABLE DROP COLUMN should be a rare operation in production environment and hence it choosing to drop the unaffected trigger and recreating them should not be a big drawback. Or we can be more intelligent about dropping the trigger by doing so only if the trigger column positions have changed. &lt;/p&gt;

&lt;p&gt;So, we can either add some comments to the existing code to improve the readability of the if codition or we can get rid of the &quot;changed&quot; variable and simply drop the trigger, rearrange it&apos;s column positions if needed and recrete the trigger. Existing code avoids unnecessary drop and recreate of the trigger if the trigger columns are not affected. But your suggestion makes the code more readable. I am fine with either of the 2 choices.&lt;/p&gt;

&lt;p&gt;3)&lt;br/&gt;
changedColPositionInTriggerAction is set but not used anywhere? &lt;br/&gt;
  Shouldn&apos;t the positions in referencedColsInTriggerAction be adjusted &lt;br/&gt;
  above droppedColumnPosition, too? &lt;/p&gt;

&lt;p&gt;For trigger reference columns, we can&apos;t simply do what is being done for trigger columns because trigger action sql gets changed to look at the columns available through the REFERENCING clause to be accessed by their column positions. Hence, just changing the column positions of affected referenced columns in systrigges is not enough. We need to regenerate the trigger action too.I am looking at tackling the regeneration of the trigger action for such a case through the jira &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4984&quot; title=&quot;ALTER TABLE DROP COLUMN may leave triggers invalid even if they are not using the column getting dropped.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4984&quot;&gt;&lt;del&gt;DERBY-4984&lt;/del&gt;&lt;/a&gt; which I am working on currently.&lt;/p&gt;

&lt;p&gt;4)You are correct about my comment being incorrect in AlterTableTest. I will fix that why I do my checkin for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4984&quot; title=&quot;ALTER TABLE DROP COLUMN may leave triggers invalid even if they are not using the column getting dropped.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4984&quot;&gt;&lt;del&gt;DERBY-4984&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12991650" author="mamtas" created="Mon, 7 Feb 2011 22:06:29 +0000"  >&lt;p&gt;I have backported the changes to 10.7 codeline after having run the derbyall and junit suite run successfully after the merge. If Dag&apos;s comments require any further changes, then I will put them both into trunk and 10.7. &lt;/p&gt;</comment>
                            <comment id="12991715" author="dagw" created="Mon, 7 Feb 2011 23:35:34 +0000"  >&lt;p&gt;Thanks, Mamta!  As for the &quot;change&quot; variable, since this is old code, I&apos;m ok with keeping it, your call &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
&quot;Or we can be more intelligent about dropping the trigger by doing so only if the trigger column positions have changed. &quot; This was my thought, yes, since we do compare the positions over again.&lt;/p&gt;

&lt;p&gt;Thanks also for explaining the missing piece being handled as part for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4984&quot; title=&quot;ALTER TABLE DROP COLUMN may leave triggers invalid even if they are not using the column getting dropped.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4984&quot;&gt;&lt;del&gt;DERBY-4984&lt;/del&gt;&lt;/a&gt;, great that this is being fixed!&lt;/p&gt;</comment>
                            <comment id="13685178" author="knutanders" created="Mon, 17 Jun 2013 10:19:15 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12479221">DERBY-4887</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 2 Feb 2011 03:16:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24577</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0gsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36539</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>