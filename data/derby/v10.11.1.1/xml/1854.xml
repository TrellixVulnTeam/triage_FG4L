<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:42:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1854/DERBY-1854.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1854] SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1854</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Running the following short SQL script from ij will cause an error &quot;ERROR XSAI2: The conglomerate (817) requested does not exist.&quot;.  It appears that the SYSCS_COMPRESS_TABLE function corrupts tables that have a single column which is both a primary key and a foreign key.&lt;/p&gt;


&lt;p&gt;connect &apos;jdbc:derby:/testdb;create=true&apos;;&lt;/p&gt;

&lt;p&gt;CREATE TABLE users (&lt;br/&gt;
 user_id INT NOT NULL GENERATED BY DEFAULT AS IDENTITY,&lt;br/&gt;
 user_login VARCHAR(255) NOT NULL,&lt;br/&gt;
 PRIMARY KEY (user_id));&lt;/p&gt;

&lt;p&gt;CREATE TABLE admins (&lt;br/&gt;
 user_id INT NOT NULL,&lt;br/&gt;
 PRIMARY KEY (user_id),&lt;br/&gt;
 CONSTRAINT admin_uid_fk FOREIGN KEY (user_id) REFERENCES users (user_id));&lt;/p&gt;

&lt;p&gt;INSERT INTO users (user_login) VALUES(&apos;TEST1&apos;);&lt;br/&gt;
INSERT INTO admins VALUES (VALUES IDENTITY_VAL_LOCAL());&lt;/p&gt;

&lt;p&gt;CALL SYSCS_UTIL.SYSCS_COMPRESS_TABLE(&apos;APP&apos;, &apos;ADMINS&apos;, 0);&lt;/p&gt;

&lt;p&gt;SELECT * from admins;&lt;/p&gt;</description>
                <environment>Reproduced on Linux, Win2k, and WinXP running JDK 1.4.2.x</environment>
        <key id="12349986">DERBY-1854</key>
            <summary>SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tsuresh">Suresh Thalamati</assignee>
                                    <reporter username="chadloder">Chad Loder</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Sep 2006 01:04:48 +0100</created>
                <updated>Mon, 5 Jul 2010 18:32:41 +0100</updated>
                            <resolved>Fri, 22 Sep 2006 18:49:45 +0100</resolved>
                                    <version>10.1.3.1</version>
                                    <fixVersion>10.1.3.3</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12434856" author="chadloder" created="Fri, 15 Sep 2006 01:05:32 +0100"  >&lt;p&gt;This may be similar to &lt;a href=&quot;http://issues.apache.org/jira/browse/DERBY-1641&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/DERBY-1641&lt;/a&gt;, which is still open.&lt;/p&gt;</comment>
                            <comment id="12435118" author="chadloder" created="Fri, 15 Sep 2006 21:57:34 +0100"  >&lt;p&gt;Also reproducible in trunk (and thus 10.2)&lt;/p&gt;</comment>
                            <comment id="12435667" author="mikem" created="Tue, 19 Sep 2006 06:33:26 +0100"  >&lt;p&gt;This one seems pretty serious since it looks like you basically lose your table if you do it, making it a candidate for 10.2.  I don&apos;t think it is a regression.  I have not had time to look at it.  If I had to guess it has the feel of a problem&lt;br/&gt;
with 2 indexes defined on the same column where the catalogs fudge it and make it look like 2 different indexes but in reality there is only one.  And then when compress table does a &quot;bait and switch&quot; trying to replace all tables and indexes it gets confused.  My guess is that this is a  problem at the upper layer and not store.  &lt;/p&gt;</comment>
                            <comment id="12435795" author="rhillegas" created="Tue, 19 Sep 2006 15:22:57 +0100"  >&lt;p&gt;Assigning to 10.2.2.0&lt;/p&gt;</comment>
                            <comment id="12436020" author="fuzzylogic" created="Tue, 19 Sep 2006 22:37:22 +0100"  >&lt;p&gt;This looks like it may be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1641&quot; title=&quot;Conglomerate requested does not exist after syscs_import_table with FK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1641&quot;&gt;&lt;del&gt;DERBY-1641&lt;/del&gt;&lt;/a&gt;, the error seen with both issues is the same, with similar (but not identical) circumstances that lead up to the error.&lt;/p&gt;</comment>
                            <comment id="12436361" author="tsuresh" created="Wed, 20 Sep 2006 22:41:28 +0100"  >&lt;p&gt;debugged this bug  little bit ,  looks like the problem is  one  of the conglomerate descriptor  entries in the  sys.sysconglomerates are  not  getting updated with the new conglomerate number that  got created as part of the compress .   In the test case , it happens to be entry for the foreign key index. &lt;/p&gt;

&lt;p&gt;The current code that updates the conglomerate numbers indexes assumes ,there are  duplicate  entries in the sys.sysconglomerate with same conglomerid entries  , when multiple indexes are  referring to a conglomerate.   I think this  assumption is not true any more ,   fix   for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt;  ensures conglomerid  is unique in sys.sysconglomerates. &lt;/p&gt;

&lt;p&gt;This  bug is likely to  show up in all branches ,  where the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; is checked in. &lt;/p&gt;

&lt;p&gt;/suresh &lt;/p&gt;

</comment>
                            <comment id="12436406" author="fuzzylogic" created="Thu, 21 Sep 2006 01:12:21 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; has gone into all of the branches. I have verified that the problem does not occur before the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt;, and does occur after the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; in 10.0 and 10.1, so I am marking the regression flag.&lt;/p&gt;</comment>
                            <comment id="12436461" author="tsuresh" created="Thu, 21 Sep 2006 09:00:31 +0100"  >&lt;p&gt;Problem was all the conglomerate descriptor entries in sys.sysconglomerates&lt;br/&gt;
were not getting updated with new conglomerate number generated for an index &lt;br/&gt;
during compress/bulk-insert, when an index is shared. Update code was assuming conglomerate id is common when an index is shared, but that is not correct. ConglomerateID&apos;s in sys.sysconglomerates are unique. &lt;/p&gt;

&lt;p&gt;This patch modifies the update conglomerate descriptor code to update each&lt;br/&gt;
conglomerate descriptor separately using conglomerateID as the key, when&lt;br/&gt;
there are more than one conglomerate descriptor referring to the same &lt;br/&gt;
conglomerate(conglomerate number). &lt;/p&gt;

&lt;p&gt;It would be great, if some can review the attached patch. &lt;/p&gt;


&lt;p&gt;svn stat:&lt;br/&gt;
M      java\engine\org\apache\derby\impl\sql\catalog\DataDictionaryImpl.java&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\tests\lang\compressTable.sql&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\master\compressTable.out&lt;/p&gt;</comment>
                            <comment id="12436561" author="rhillegas" created="Thu, 21 Sep 2006 16:48:57 +0100"  >&lt;p&gt;Assigning this to 10.2.1 since it has been identified as a regression.&lt;/p&gt;</comment>
                            <comment id="12436564" author="fuzzylogic" created="Thu, 21 Sep 2006 16:53:12 +0100"  >&lt;p&gt;Altering Fix In for this issue, a fix should go in each branch where &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; was checked in, marking trunk and 10.2 for now, but this should eventually go into the 10.1 and 10.0 branches as well.&lt;/p&gt;

&lt;p&gt;Also, after applying the patch I am not able to reproduce &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1854&quot; title=&quot;SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1854&quot;&gt;&lt;del&gt;DERBY-1854&lt;/del&gt;&lt;/a&gt; OR &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1641&quot; title=&quot;Conglomerate requested does not exist after syscs_import_table with FK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1641&quot;&gt;&lt;del&gt;DERBY-1641&lt;/del&gt;&lt;/a&gt;, and the provided testcase, which mirrors the repro found in the summary, passes with the patch and fails without.&lt;/p&gt;

&lt;p&gt;+1 to commit to trunk and 10.2. There were some non-trivial errors to resolve applying the patch to 10.1 and 10.0.&lt;/p&gt;</comment>
                            <comment id="12436574" author="chadloder" created="Thu, 21 Sep 2006 17:24:30 +0100"  >&lt;p&gt;Andrew,&lt;/p&gt;

&lt;p&gt;What kind of problems did you have applying the patch to 10.1?&lt;/p&gt;</comment>
                            <comment id="12436586" author="fuzzylogic" created="Thu, 21 Sep 2006 18:26:59 +0100"  >&lt;p&gt;Attaching version of Suresh&apos;s patch which applies cleanly to 10.1, ran compressTable, it passes, haven&apos;t run other tests.&lt;/p&gt;</comment>
                            <comment id="12436636" author="mamtas" created="Thu, 21 Sep 2006 21:41:17 +0100"  >&lt;p&gt;I did a quick review of the patch and the changes look good to me. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; made changes such that duplicate indexes will have their own unique conglomerateIDs but  there were other places in the code which relied on duplicate conglomerateIDs for duplicate indexes. I give a +1 to this patch.&lt;/p&gt;</comment>
                            <comment id="12436702" author="tsuresh" created="Fri, 22 Sep 2006 01:32:13 +0100"  >&lt;p&gt;This  patch has same  fix as in deryby-1854.diff ,  Only  thing new in this patch is the  updates to the importExportThruIJ.sql  to test  import nto a table that has same column as a primary key and a foreign key (ADMINS table).. import internally uses bulk-insert when the table is empty ,   it also drops and recreates the indexes,  sys,sysconglomerates were not gettting updated correctly in this case also because , bul-insert  calls the same  update conglomerate descriptors method in the data dictionary. &lt;/p&gt;








</comment>
                            <comment id="12436704" author="tsuresh" created="Fri, 22 Sep 2006 01:58:33 +0100"  >&lt;p&gt;Committed to trunk on revision 448758.   Thanks  for taking time to review the patch , Andrew, Mamta. &lt;/p&gt;
</comment>
                            <comment id="12436739" author="chadloder" created="Fri, 22 Sep 2006 06:16:50 +0100"  >&lt;p&gt;We locally applied derby-1854-against the our 10.1 working copy and I have confirmed that it fixes the issue and also works fine with our large (&amp;gt;6 million rows) production databases in our full application environment. Thanks&lt;/p&gt;</comment>
                            <comment id="12436741" author="chadloder" created="Fri, 22 Sep 2006 06:21:54 +0100"  >&lt;p&gt;Hm, that last comment didn&apos;t format correctly.&lt;/p&gt;

&lt;p&gt;We locally applied &quot;derby-1854-andrew-10.1.diff&quot; against our 10.1 working copy and it worked OK. Cheers&lt;/p&gt;</comment>
                            <comment id="12436944" author="tsuresh" created="Fri, 22 Sep 2006 18:49:45 +0100"  >&lt;p&gt;committed to 10.2 as part of meg-merge , revision. 449013.   &lt;/p&gt;
</comment>
                            <comment id="12437593" author="mikem" created="Mon, 25 Sep 2006 17:03:43 +0100"  >&lt;p&gt;backported change from trunk to the 10.1 branch :&lt;br/&gt;
------------------------------------------------------------------------&lt;br/&gt;
r449058 | mikem | 2006-09-22 12:17:47 -0700 (Fri, 22 Sep 2006) | 23 lines&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1854&quot; title=&quot;SYSCS_COMPRESS_TABLE corrupts table with a single column which is both a primary key and a foreign key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1854&quot;&gt;&lt;del&gt;DERBY-1854&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
contributed by suresht&lt;br/&gt;
merging change from trunk to 10.1 codeline.&lt;/p&gt;</comment>
                            <comment id="12438278" author="fuzzylogic" created="Thu, 28 Sep 2006 05:30:39 +0100"  >&lt;p&gt;Should this also be ported to 10.0, since the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-655&quot; title=&quot;getImportedKeys returns duplicate rows in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-655&quot;&gt;&lt;del&gt;DERBY-655&lt;/del&gt;&lt;/a&gt; which caused this regression was also ported there?&lt;/p&gt;</comment>
                            <comment id="12438474" author="fuzzylogic" created="Thu, 28 Sep 2006 17:24:43 +0100"  >&lt;p&gt;Merged to 10.0, merged cleanly for the engine code, test needed to be edited slightly due to no identity columns in 10.0. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12347278">DERBY-1641</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12345616">DERBY-1489</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12347278">DERBY-1641</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12341315" name="derby-1854-andrew-10.1.diff" size="7206" author="fuzzylogic" created="Thu, 21 Sep 2006 18:26:58 +0100"/>
                            <attachment id="12341261" name="derby-1854.diff" size="7121" author="tsuresh" created="Thu, 21 Sep 2006 09:00:31 +0100"/>
                            <attachment id="12341343" name="derby-1854_v1.diff" size="11776" author="tsuresh" created="Fri, 22 Sep 2006 01:32:13 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 19 Sep 2006 05:33:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22752</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ppr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37984</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>