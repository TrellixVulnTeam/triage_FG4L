<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:15:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2992/DERBY-2992.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2992] getBinaryStream returns incorrect result (truncated value) if underlying blob is deleted</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2992</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If getBinaryStream is reading a value (READ_UNCOMMITTED) and the row is deleted by another connection, a truncated value will be returned without error. I believe instead either the whole value or an IOException should occur.&lt;/p&gt;

&lt;p&gt;With 10.2 and higher with the repro attahed we get:&lt;br/&gt;
&amp;gt; java TruncatedBlob&lt;br/&gt;
Embedded:&lt;br/&gt;
Read 32669 bytes&lt;br/&gt;
0 rows in BLOBCLOB&lt;/p&gt;

&lt;p&gt;With 10.1&lt;br/&gt;
Embedded:&lt;br/&gt;
Read 40000 bytes (OK)&lt;br/&gt;
0 rows in BLOBCLOB &lt;/p&gt;

&lt;p&gt;Note network server returns the full value for both 10.1 and 10.2 but gives a lock timeout for 10.2+.  I will file a separate issue for that.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12375304">DERBY-2992</key>
            <summary>getBinaryStream returns incorrect result (truncated value) if underlying blob is deleted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Aug 2007 15:48:22 +0100</created>
                <updated>Wed, 12 Jan 2011 22:24:20 +0000</updated>
                            <resolved>Wed, 7 Jul 2010 21:37:37 +0100</resolved>
                                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.4.1.3</version>
                    <version>10.5.3.0</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12727679" author="rhillegas" created="Mon, 6 Jul 2009 19:30:24 +0100"  >&lt;p&gt;Triaged for 10.5.2: Assigned normal urgency and noted that repro is available.&lt;/p&gt;</comment>
                            <comment id="12829758" author="kristwaa" created="Thu, 4 Feb 2010 20:21:07 +0000"  >&lt;p&gt;From a small experiment running the attached repro, where I made OverflowInputStream throw an exception if it detects that the specified overflow page cannot be found, the following lock dumps shows that an extra lock is set when using the client driver:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;Embedded:&lt;br/&gt;
/---- Lock dump 1&lt;br/&gt;
477 | TABLE | IS | BLOBTAB | Tablelock | GRANT | T | 1 | null | &lt;br/&gt;
      Lock dump 1 -----/&lt;br/&gt;
Caught IOException:EOF reached prematurely&lt;br/&gt;
0 rows in BLOBCLOB&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;Client:&lt;br/&gt;
/---- Lock dump 1&lt;br/&gt;
368 | TABLE | IS | BLOBTAB | Tablelock | GRANT | T | 2 | null | &lt;br/&gt;
368 | ROW | S | BLOBTAB | (2,6) | GRANT | T | 1 | null | &lt;br/&gt;
      Lock dump 1 -----/&lt;br/&gt;
// Results in lock timeout.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Haven&apos;t investigated further, but the repro code is identical except for the connection URL so there is definitely a difference between embedded and client/server.&lt;br/&gt;
Also, are there any valid situations where OverflowInputStream.fillByteHolder should fail to get the overflow page when an overflow page has been specified?&lt;br/&gt;
(the next overflow page is set by a callback, according to the comments)&lt;/p&gt;

&lt;p&gt;Finally, if the suggested fix is pursued, we might want to beef up the error message. Any suggestions?&lt;/p&gt;</comment>
                            <comment id="12831552" author="kristwaa" created="Tue, 9 Feb 2010 17:39:15 +0000"  >&lt;p&gt;Attached patch 1a, which fixes the problem as outlined in the comment above. I also incorporated the repro/test Kathey has written.&lt;br/&gt;
Should we try to say something about what went wrong in the error message, such that the user has a chance to understand what went wrong?&lt;/p&gt;

&lt;p&gt;Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12831709" author="kristwaa" created="Tue, 9 Feb 2010 22:26:23 +0000"  >&lt;p&gt;Regression tests passed.&lt;/p&gt;</comment>
                            <comment id="12831993" author="knutanders" created="Wed, 10 Feb 2010 14:05:28 +0000"  >&lt;p&gt;The approach in the patch looks fine to me. I think you&apos;re right that the error message is somewhat too developer-centric, and it may be difficult for users to understand what the problem is. What about this instead: &quot;Could not read further because another transaction has modified the value.&quot; ?&lt;/p&gt;</comment>
                            <comment id="12832003" author="kristwaa" created="Wed, 10 Feb 2010 14:24:12 +0000"  >&lt;p&gt;Thanks for looking at the patch, Knut Anders.&lt;/p&gt;

&lt;p&gt;Your proposed message sound better to me, and I think it doesn&apos;t lie &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; That is, I believe there aren&apos;t any other valid reasons causing that exception to be thrown. If you use a stricter isolation level I think locks will be put in place to avoid that a different transaction deletes the value you are currently accessing.&lt;br/&gt;
The only other reason I can think of, is if we have a bug in the store specifying the wrong overflow page id.&lt;/p&gt;

&lt;p&gt;I&apos;ll change the error message and commit  the patch shortly.&lt;/p&gt;</comment>
                            <comment id="12832069" author="kristwaa" created="Wed, 10 Feb 2010 17:01:53 +0000"  >&lt;p&gt;Attached patch 1b and committed it to trunk with revision 908586.&lt;/p&gt;</comment>
                            <comment id="12832078" author="kristwaa" created="Wed, 10 Feb 2010 17:15:35 +0000"  >&lt;p&gt;Back-porting this fix requires some manual work, due to conflicts.&lt;br/&gt;
Does anyone feel strong about back-porting the fix?&lt;/p&gt;</comment>
                            <comment id="12834712" author="kristwaa" created="Wed, 17 Feb 2010 09:59:40 +0000"  >&lt;p&gt;I haven&apos;t received any feedback on the back-porting issue.&lt;br/&gt;
Resolving issue, ready for verification.&lt;/p&gt;</comment>
                            <comment id="12885561" author="mikem" created="Tue, 6 Jul 2010 16:18:06 +0100"  >&lt;p&gt;I am looking at backporting this to the 10.5 branch.&lt;/p&gt;</comment>
                            <comment id="12885756" author="mikem" created="Wed, 7 Jul 2010 01:33:06 +0100"  >&lt;p&gt;backporting change #908586 from trunk to 10.5 branch.&lt;/p&gt;

&lt;p&gt;m105_jdk16:178&amp;gt;svn commit&lt;br/&gt;
Sending        .&lt;br/&gt;
Sending        java/engine/org/apache/derby/impl/store/raw/data/OverflowInputStream.java&lt;br/&gt;
Sending        java/engine/org/apache/derby/loc/messages.xml&lt;br/&gt;
Sending        java/shared/org/apache/derby/shared/common/reference/MessageId.java&lt;br/&gt;
Sending        java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/BLOBTest.java&lt;br/&gt;
Transmitting file data ....&lt;/p&gt;</comment>
                            <comment id="12886070" author="mikem" created="Wed, 7 Jul 2010 21:37:37 +0100"  >&lt;p&gt;backported to 10.5.  resolving as fixed and resetting original owner.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12354628">DERBY-2034</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12468384">DERBY-4728</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12363129" name="TruncatedBlob.java" size="1930" author="kmarsden" created="Fri, 3 Aug 2007 15:48:58 +0100"/>
                            <attachment id="12435316" name="derby-2992-1a-throw_exception_on_eof.diff" size="5970" author="kristwaa" created="Tue, 9 Feb 2010 17:39:15 +0000"/>
                            <attachment id="12435466" name="derby-2992-1b-throw_exception_on_eof.diff" size="5989" author="kristwaa" created="Wed, 10 Feb 2010 17:01:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 6 Jul 2009 18:30:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23365</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0o33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37720</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>