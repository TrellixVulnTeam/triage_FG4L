<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:50:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3571/DERBY-3571.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3571] LOB locators are not released if the LOB columns are not accessed by the client</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3571</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If the client creates a result set containing LOB locator columns and iterates through it without actually accessing the LOB columns, the locators are not released.&lt;br/&gt;
The amount of locators and their associated LOB objects causes the server to consume large amounts of memory and it eventually gets an OOME.&lt;/p&gt;

&lt;p&gt;There are a few workarounds for this bug:&lt;br/&gt;
 a) Access and/or properly close the LOBs (i.e. Blob.free).&lt;br/&gt;
    This is partly dependent on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2892&quot; title=&quot;Closing a resultset after retrieving a large &amp;gt; 32665 bytes value with Network Server does not release locks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2892&quot;&gt;&lt;del&gt;DERBY-2892&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
 b) Invoke Connection.commit (or rollback) periodically, which causes all locators on the connection to be released.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12392355">DERBY-3571</key>
            <summary>LOB locators are not released if the LOB columns are not accessed by the client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Mar 2008 16:02:55 +0000</created>
                <updated>Mon, 4 May 2009 19:22:56 +0100</updated>
                            <resolved>Mon, 7 Apr 2008 11:12:22 +0100</resolved>
                                    <version>10.3.2.1</version>
                    <version>10.4.1.3</version>
                    <version>10.5.1.1</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>JDBC</component>
                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12582335" author="kristwaa" created="Wed, 26 Mar 2008 16:26:26 +0000"  >&lt;p&gt;&apos;derby-3571-1a-client_track_lob_fix.diff&apos; is the first attempt at a fix where the client keeps track of LOBs and closes them as appropriate.&lt;br/&gt;
The basic approach is:&lt;br/&gt;
  a) When the result set position is changed, check the current row (if any) for LOB columns with open locators.&lt;br/&gt;
  b) When the result set is closed, check the current row (if any).&lt;br/&gt;
  c) If a Blob or Clob object is created, inform the state tracker that its locator shall not be released.&lt;br/&gt;
  d) On connection commit/rollback, discard all client side LOB state as all locators are released by the server.&lt;/p&gt;

&lt;p&gt;Currently there will be a callable procedure invocation (and thus a round trip) for each LOB column each time the result set position changes (i.e. rs.next or rs.relative). This is very ineffective, and for the current solution there are two optimizations that can be made:&lt;br/&gt;
  1) Implement a new stored procedure that takes a list of locators. All locators are freed in one round trip. The complication is to decide when the procedure should be invoked, i.e. there must typically be some kind of threshold (number of locators).&lt;br/&gt;
  2) Piggy-back locators on other requests to the server. Frees resources optimally at almost no extra cost. There are several variations, for instance doing it on the connection level or only on the resultset/cursor level (CNTQRY).&lt;/p&gt;

&lt;p&gt;Since we don&apos;t do prefetching of result set data containing LOBs, the difference between the optimizations is less pronounced, but (1) will most likely leave resources open for a longer period of time on the server.&lt;/p&gt;

&lt;p&gt;Another thing to consider is how important it is that this feature is very effective. Why query the database for data you don&apos;t need?&lt;/p&gt;


&lt;p&gt;Please review and comment.&lt;br/&gt;
I&apos;m running tests, and I have run the repro mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2892&quot; title=&quot;Closing a resultset after retrieving a large &amp;gt; 32665 bytes value with Network Server does not release locks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2892&quot;&gt;&lt;del&gt;DERBY-2892&lt;/del&gt;&lt;/a&gt; without failure.&lt;/p&gt;</comment>
                            <comment id="12582439" author="kristwaa" created="Wed, 26 Mar 2008 21:33:24 +0000"  >&lt;p&gt;Clearing patch available, as the patch 1a causes errors in the tests.&lt;br/&gt;
I still want comments on the approach taken, and I plan to fix the bug (NPE) as in patch 1b.&lt;br/&gt;
The problem is that the LOB state tracker is not always initialized at the time it is attempted accessed.&lt;/p&gt;</comment>
                            <comment id="12582649" author="knutanders" created="Thu, 27 Mar 2008 13:48:40 +0000"  >&lt;p&gt;Hi Kristian,&lt;/p&gt;

&lt;p&gt;I think the approach sounds good. Of course, having one of the&lt;br/&gt;
optimizations you mentioned would be good, preferably option 2. I&lt;br/&gt;
think there are valid and meaningful use cases where a user doesn&apos;t&lt;br/&gt;
look at all the LOBs fetched, so it would be worthwhile to optimize&lt;br/&gt;
it. For instance, you could have code structured like this&lt;/p&gt;

&lt;p&gt;  ResultSet rs = stmt.executeQuery(&quot;select int1, int2, string1, blob1 from t&quot;);&lt;br/&gt;
  while (rs.next()) {&lt;br/&gt;
    ...&lt;br/&gt;
    if (someConditionIsTrue) &lt;/p&gt;
{
        processBlob(rs.getBlob(4));
    }
&lt;p&gt;    ...&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;But optimization can come later. First step is to fix the leak.&lt;/p&gt;

&lt;p&gt;I have read through the patch. Please see my (minor) comments below.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;NetConnection:&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;typo: &quot;layber B&quot; -&amp;gt; &quot;layer B&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Cursor:&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;typo: getLocatorProedures -&amp;gt; getLocatorProcedures&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;NoOpLOBStateTracker:&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;class javadoc (and assert in noRelease()) indicates that the class&lt;br/&gt;
    is only used when the server doesn&apos;t support locators. Isn&apos;t it&lt;br/&gt;
    also used when the result doesn&apos;t contain LOBs?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;should we have a static instance of this class, so that we don&apos;t&lt;br/&gt;
    have to allocate a new one each time a statement without LOBs is&lt;br/&gt;
    executed? Since it doesn&apos;t do anything, there&apos;s no thread-safety&lt;br/&gt;
    issues preventing us from sharing the same instance between all&lt;br/&gt;
    the threads, I think.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;ResultSet:&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it would be good if keepLocatorColumnAlive() and&lt;br/&gt;
    createLOBColumnTracker() had javadoc comments&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+        if (this.lobState != null) {&lt;br/&gt;
+            if (SanityManager.DEBUG) &lt;/p&gt;
{
+                SanityManager.THROWASSERT(
+                        &quot;LOB state tracker already initialized.&quot;);
+            }
&lt;p&gt;+        }&lt;/p&gt;

&lt;p&gt;Perhaps the above code is clearer if it&apos;s written like this?&lt;br/&gt;
    if (SanityManager.DEBUG) &lt;/p&gt;
{
        SanityManager.ASSERT(this.lobState == null, &quot;...&quot;);
    }

&lt;p&gt;+                if (type == Types.BLOB) &lt;/p&gt;
{
+                    tmpIndexes[lobCount] = i +1; // Convert to 1-based index.
+                    tmpIsBlob[lobCount++] = true;
+                }
&lt;p&gt; else if (type == Types.CLOB) &lt;/p&gt;
{
+                    tmpIndexes[lobCount] = i +1; // Convert to 1-based index.
+                    tmpIsBlob[lobCount++] = false;
+                }

&lt;p&gt;Perhaps the above code could be more compact, like this?&lt;br/&gt;
    if (type == Types.BLOB || type == Types.CLOB) &lt;/p&gt;
{
        tmpIndexes[lobCount] = i + 1; // Convert to 1-based index.
        tmpIsBlob[lobCount++] = (type == Types.BLOB);
    }</comment>
                            <comment id="12582698" author="kristwaa" created="Thu, 27 Mar 2008 15:41:24 +0000"  >&lt;p&gt;Thanks for the comments Knut Anders.&lt;br/&gt;
This is work in progress, so the next patch will have some changes.&lt;/p&gt;

&lt;p&gt;I will fix the typos, and also add more comments/JavaDoc. I renamed the method keepLocatorColumnAlive to markLOBAsAccessed, in hope that it gives more meaning...&lt;br/&gt;
See below regarding the rest of your comments.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;NoOpLOBStateTracker&lt;br/&gt;
  Yes, that is a good idea. It is now a singleton.&lt;br/&gt;
  It is also correct that it will be used for result sets without LOBs.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Fixed assert.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Rewrote code block for compactness.&lt;br/&gt;
  On a side note, this code will only be in 10.3. For 10.4 and trunk I plan to make a few changes so it is no longer required to know if it is a Blob or a Clob. This requires two changes; a small refactoring (issue not yet created) and optimization 1 mentioned in my earlier comment.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;I will upload a replacement patch shortly, which addresses other problems in 1a.&lt;/p&gt;</comment>
                            <comment id="12582714" author="kristwaa" created="Thu, 27 Mar 2008 16:16:37 +0000"  >&lt;p&gt;&apos;derby-3571-1b-client_track_lob_fix.diff&apos; replaces version 1a.&lt;br/&gt;
It addresses the comments made by Knut Anders, and the following changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;LOB state object properly initialized&lt;/li&gt;
	&lt;li&gt;Check if positioned on insert row before checking current row (see the closeX-method).&lt;/li&gt;
	&lt;li&gt;Changed some state maintenance in LOBStateTracker.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I ran suites.All without failures (except the JMX failure), but I made some last minutes changes so I&apos;m rerunning.&lt;br/&gt;
I plan to get this code into 10.3, 10.4 and trunk. The optimization will be handled under a separate JIRA and will only go into 10.4 and trunk.&lt;/p&gt;</comment>
                            <comment id="12582717" author="kristwaa" created="Thu, 27 Mar 2008 16:17:25 +0000"  >&lt;p&gt;New revision of the patch ready for review.&lt;/p&gt;</comment>
                            <comment id="12582967" author="kristwaa" created="Fri, 28 Mar 2008 10:08:43 +0000"  >&lt;p&gt;&apos;derby-3571-1c-client_track_lob_fix.diff&apos; replaces an int array with a bool array in LOBStateTracker, as only two states are required.&lt;br/&gt;
Also contains some JavaDoc changes.&lt;/p&gt;

&lt;p&gt;Tests ran cleanly.&lt;br/&gt;
I&apos;m considering 1c for commit.&lt;/p&gt;</comment>
                            <comment id="12583635" author="kristwaa" created="Mon, 31 Mar 2008 12:03:50 +0100"  >&lt;p&gt;&apos;derby-3571-1d-client_track_lob_fix.diff&apos; introduces a LOBStateTracker interface and two implementations of it: SingleReleaseLOBTracker and NoOpLOBTracker. As a follow-up patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3575&quot; title=&quot;Optimize client side LOB release mechanism by reducing the number of round-trips&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3575&quot;&gt;&lt;del&gt;DERBY-3575&lt;/del&gt;&lt;/a&gt;, I plan to add MultipleReleaseLOBTracker.&lt;/p&gt;

&lt;p&gt;The trackers will use different mechanisms to release the locators. A final step, which I don&apos;t plan to implement for 10.4, is to piggy-back locators to release to the server on other requests. This approach is why I chose to add the locatorsForRelease method.&lt;/p&gt;

&lt;p&gt;To sum of the mechanism used by the trackers:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;NoOpLOBTracker: no release&lt;/li&gt;
	&lt;li&gt;SingleReleaseLOBTracker: a stored procedure call for each locator to release, invoked at every result set navigational methods and rs.close.&lt;/li&gt;
	&lt;li&gt;MultipleReleaseLOBTracker: a stored procedure call for a set of locators to release, invocation time not yet decided.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m running tests, and if they pass I plan to commit this patch later today.&lt;/p&gt;</comment>
                            <comment id="12583666" author="kristwaa" created="Mon, 31 Mar 2008 13:42:57 +0100"  >&lt;p&gt;The tests ran cleanly, but a commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2892&quot; title=&quot;Closing a resultset after retrieving a large &amp;gt; 32665 bytes value with Network Server does not release locks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2892&quot;&gt;&lt;del&gt;DERBY-2892&lt;/del&gt;&lt;/a&gt; caused a minor conflict.&lt;br/&gt;
I have updated the patch (revision 1e), and I&apos;m running a subset of the tests to see if the two patches fare well together.&lt;/p&gt;

&lt;p&gt;I still expect to commit the patch shortly.&lt;/p&gt;</comment>
                            <comment id="12583812" author="knutanders" created="Mon, 31 Mar 2008 20:57:53 +0100"  >&lt;p&gt;Just a quick control question:&lt;/p&gt;

&lt;p&gt;The plan is to have three different mechanisms for releasing LOBs in the client driver?&lt;/p&gt;

&lt;p&gt;  a) SingleReleaseLOBTracker if the server version is 10.3&lt;br/&gt;
  b) MultipleReleaseLOBTracker if the server version is 10.4&lt;br/&gt;
  c) some yet to be implemented piggybacking protocol if the server version is 10.5 or higher&lt;/p&gt;

&lt;p&gt;Won&apos;t this add up to a fair amount of code that, once newer versions are released, ends up being more or less dead and untested code? Or is there a way some of the mechanisms could be consolidated or perhaps phased out later?&lt;/p&gt;</comment>
                            <comment id="12583882" author="knutanders" created="Mon, 31 Mar 2008 22:28:34 +0100"  >&lt;p&gt;All elements of SingleReleaseLOBTracker.trackColumn[] are false until checkCurrentRow() is called (normally on ResultSet.next()). Doesn&apos;t this mean that the LOBs in the first row returned from the query won&apos;t be released until the transaction is completed?&lt;/p&gt;

&lt;p&gt;In SingleReleaseLOBTracker.checkCurrentRow(), should trackColumn&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; be set to true unconditionally rather than in the else block? Whether or not column i were accessed in row n shouldn&apos;t affect whether we release the locator in row n+1, should it?&lt;/p&gt;

&lt;p&gt;Nit: SingleReleaseLOBTracker.noRelease() doesn&apos;t need the sanity check variable (indexFound) if &quot;break&quot; is replaced with &quot;return&quot;, and &quot;ASSERT&quot; is replaced with &quot;THROWASSERT&quot;. Actually, since columns[] is a sorted int array (isn&apos;t it?), it should be possible to simplify this method further by using Arrays.binarySearch().&lt;/p&gt;

&lt;p&gt;Typo in ResultSet.createLOBColumnTracker(): &quot;simply&quot; -&amp;gt; &quot;simplify&quot;&lt;/p&gt;</comment>
                            <comment id="12583885" author="kmarsden" created="Mon, 31 Mar 2008 22:36:33 +0100"  >&lt;p&gt;In SingleReleaseLOBTracker,&lt;br/&gt;
I am sure I am missing something, but looking at the patch, I don&apos;t understand how the elements of the trackColumn array are ever set to true, so that the lobs get released.  Shouldn&apos;t they be initialized to true in the constructor and reset to true in discardState()?  Then they would get set to false by noRelease() when the lob is accessed.&lt;/p&gt;
</comment>
                            <comment id="12583889" author="knutanders" created="Mon, 31 Mar 2008 22:40:05 +0100"  >&lt;p&gt;Should we also add !connection_.autoCommit_ as a condition for invoking checkCurrentRow() in ResultSet.closeX()? As it is now, we&apos;ll send a release command to the server right before ResultSet.close() triggers a commit, but in that case the commit would have released the locator anyway.&lt;/p&gt;</comment>
                            <comment id="12583893" author="kmarsden" created="Mon, 31 Mar 2008 22:46:55 +0100"  >&lt;p&gt;You can ignore my comment. I didn&apos;t see Knut&apos;s before I posted.&lt;/p&gt;</comment>
                            <comment id="12584049" author="kristwaa" created="Tue, 1 Apr 2008 09:13:04 +0100"  >&lt;p&gt;Thanks for all the reviewing Knut and Kathey.&lt;/p&gt;

&lt;p&gt;This is still rather &quot;unstable&quot; code, and I have newer versions in the pipeline. Let me comment on the simple things first.&lt;/p&gt;

&lt;p&gt;a) No release of LOBs in the first row.&lt;br/&gt;
  This is a bug introduced when I made it a requirement that checkCurrentRow should only be called on a vaild row. I&apos;ll fix this.&lt;/p&gt;

&lt;p&gt;b) Setting trackColumn to true in checkCurrentRow.&lt;br/&gt;
  Won&apos;t it always be true with the current code? To enter the if-block it must be true, and we don&apos;t need to set it again. Otherwise we enter the else-block and set it to true. I do see the point of setting it to true unconditionally for readability though. In a newer patch (not published yet), I have renamed &quot;trackColumn&quot; to &quot;accessed&quot;.&lt;/p&gt;

&lt;p&gt;c) noRelease&lt;br/&gt;
  I&apos;ll rewrite it using Arrays and remove the check variable. Another question is whether an exception should be thrown in any case, as providing an invalid index seems like a programming error.&lt;br/&gt;
  Further, I was thinking about using noRelease to thrown an exception if the LOB column had already been accessed, but there might be other approaches one can use to make Derby fail if a LOB column is accessed twice.&lt;/p&gt;

&lt;p&gt;d) The comment with the typo will be removed, and the code in createLOBColumTracker partly rewritten.&lt;br/&gt;
   We now need a functioning tracker also when locators are unsupported.&lt;/p&gt;

&lt;p&gt;e) !connection_.autoCommit_ condition for calling checkCurrentRow&lt;br/&gt;
   A good further optimization. Thanks. I think we need to think about how to handle this for statements with multiple result sets though, as that might cause the autocommit to be skipped even though the connection has autocommit set.&lt;/p&gt;


&lt;p&gt;Regarding the control question above, yes there will be multiple release mechanisms. I have thought of these names:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;NoReleaseLOBTracker&lt;/li&gt;
	&lt;li&gt;SingleReleaseLOBTracker&lt;/li&gt;
	&lt;li&gt;BatchReleaseLOBTracker&lt;/li&gt;
	&lt;li&gt;A tracker using piggybacking.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Originally I introduced an interface and created different implementations for the tracker to avoid maintaining state I didn&apos;t need. Now that we plan to use the tracker to also track accesses to LOB columns, we need some common code in all of the implementations.&lt;br/&gt;
Would it perhaps be better to have only one tracker implementation and instead implement multiple &quot;releasers&quot;?&lt;br/&gt;
I think the tracker should be able to determine the proper release mechanism itself in the constructor.&lt;/p&gt;

&lt;p&gt;Any other ideas?&lt;br/&gt;
If not, I will implement a first version of the approach I have described and post a patch for review later today.&lt;/p&gt;</comment>
                            <comment id="12584086" author="knutanders" created="Tue, 1 Apr 2008 10:48:10 +0100"  >&lt;p&gt;b) You&apos;re of course right, I had missed that. No need to set it to true, except perhaps for readability. The rename sounds like a good idea.&lt;/p&gt;

&lt;p&gt;c) It&apos;s probably not necessary to throw the assert or an exception, since Arrays.binarySearch() returns a negative value if it cannot be found, and then we&apos;ll get an ArrayIndexOutOfBoundsException immediately when we update the array, so the error won&apos;t go unnoticed. By the way, is markAccessed a better name than noRelease for this method?&lt;/p&gt;

&lt;p&gt;e) Such an optimization could wait if it is too much work. Seems like the easiest way to get this information is to factor out some of the logic from Statement.resultSetCommitting().&lt;/p&gt;

&lt;p&gt;Using a single shared tracker implementation sounds good. My concern is that we add the BatchReleaseLOBTracker only for the 10.4 release, and get some code that we need to maintain forever for backward compatibility (like the stored procedure to release a range of LOBs) although it&apos;s only needed for a single minor release. Perhaps, if the plan is to implement the piggybacking for 10.5, it would be a better long-term solution to skip the BatchReleaseLOBTracker and let 10.4 use the less efficient SingleReleaseLOBTracker?&lt;/p&gt;</comment>
                            <comment id="12584283" author="kristwaa" created="Tue, 1 Apr 2008 21:21:20 +0100"  >&lt;p&gt;&apos;derby-3571-2a-simple_release.diff&apos; deprecates patch revision 1.&lt;/p&gt;

&lt;p&gt;The patch implements only the simple release mechanism (one locator at a time). Thanks to Knut Anders for commenting on the compatibility issues.&lt;br/&gt;
I have addressed comment (c), but chose to skip/postpone item (e), and added some simple tests. The tests are mainly for checking that the code works to some degree, it doesn&apos;t check that the code works optimally or entirely correct.&lt;/p&gt;

&lt;p&gt;I have also added a workaround in checkCurrentRow for something that is really a problem in ResultSet.&lt;br/&gt;
I am not easily able to determine if the current row has changed on all the navigational methods, and checkCurrentRow will fail if called twice on the same row (the locators are already released). I added lastSeenLocator, and upon release time the current locator is checked with the last one seen for the column. If they are equal, checkCurrentRow returns immediately.&lt;/p&gt;

&lt;p&gt;I looked at using information in ResultSet to avoid calling the method multiple times on the same row, but couldn&apos;t find a solution quickly. If you know about one, let me know &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
As an example of how to provoke the problem, consider calling rs.absolute(X) twice or rs.moveToCurrentRow() twice.&lt;/p&gt;

&lt;p&gt;I have run derbynet, jdbc4 and jdbcapi without errors. I&apos;m currently running suites.All and derbyall.&lt;/p&gt;

&lt;p&gt;It is my opinion that this patch may change the premises for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2892&quot; title=&quot;Closing a resultset after retrieving a large &amp;gt; 32665 bytes value with Network Server does not release locks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2892&quot;&gt;&lt;del&gt;DERBY-2892&lt;/del&gt;&lt;/a&gt; and possibly &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3583&quot; title=&quot;Derby should throw a better error message if a BLOB/CLOB column is accessed more than once&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3583&quot;&gt;&lt;del&gt;DERBY-3583&lt;/del&gt;&lt;/a&gt;. It would therefore be nice if we could get this patch in as soon as possible.&lt;/p&gt;

&lt;p&gt;Please review.&lt;/p&gt;</comment>
                            <comment id="12584476" author="knutanders" created="Wed, 2 Apr 2008 10:18:20 +0100"  >&lt;p&gt;I&apos;ve tried out the 2a patch and it seems to work as intended. My only nits are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOBStateTracker.checkCurrentRow(): couldn&apos;t Arrays.fill() be moved inside the if block?&lt;/li&gt;
	&lt;li&gt;should discardState() and markAccessed() check the release flag?&lt;/li&gt;
	&lt;li&gt;should ResultSet.createLOBColumnTracker() use LOBStateTracker.NO_OP_TRACKER instead of allocating a new when serverSupportsLocators() returns false?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12584485" author="kristwaa" created="Wed, 2 Apr 2008 10:44:04 +0100"  >&lt;p&gt;Committed patch 2a to trunk with revision 643819. I&apos;ll wait a little before I backport to 10.4.&lt;/p&gt;

&lt;p&gt;Thanks for the continued review Knut Anders.&lt;br/&gt;
The answer to your latest questions are either no or yes to all. It depends on whether the tracker shall be used to track LOB accesses to allow the client to throw an exception if a LOB column is accessed more than once.&lt;br/&gt;
If we don&apos;t want to track accesses, all your suggestions are valid.&lt;/p&gt;

&lt;p&gt;I don&apos;t think we have reached consensus on what to do. Related issues are &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3583&quot; title=&quot;Derby should throw a better error message if a BLOB/CLOB column is accessed more than once&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3583&quot;&gt;&lt;del&gt;DERBY-3583&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2892&quot; title=&quot;Closing a resultset after retrieving a large &amp;gt; 32665 bytes value with Network Server does not release locks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2892&quot;&gt;&lt;del&gt;DERBY-2892&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
People should comment on the former if they have opinions on whether or not to allow multiple calls to the various getter methods for LOB columns (except for those returning a stream).&lt;/p&gt;


&lt;p&gt;I&apos;m not resolving the issue, because I believe there might be some follow-up changes.&lt;br/&gt;
Also, can anyone confirm that the new test can be run on J2ME platforms?&lt;/p&gt;</comment>
                            <comment id="12584530" author="kristwaa" created="Wed, 2 Apr 2008 13:04:29 +0100"  >&lt;p&gt;I have seen derbyall/derbylang/subquery.diff fail a few times with the patch. It happens only on Java SE 6, and when it is run as part of derbyall. So far I haven&apos;t been able to reproduce running the test individually.&lt;br/&gt;
The first part of the diff looks like this:&lt;br/&gt;
&amp;lt; Hash Join ResultSet:&lt;br/&gt;
1431a1431&lt;br/&gt;
&amp;gt; Nested Loop Join ResultSet:&lt;br/&gt;
1544 del&lt;br/&gt;
&amp;lt; 	Hash Table ResultSet (13):&lt;br/&gt;
1544a1544&lt;br/&gt;
&amp;gt; 	Project-Restrict ResultSet (13):&lt;/p&gt;</comment>
                            <comment id="12584537" author="thomanie" created="Wed, 2 Apr 2008 13:20:48 +0100"  >&lt;p&gt;The diffs you see IMHO look like the optimizer is choosing different solutions for the subquery flattening?&lt;/p&gt;</comment>
                            <comment id="12584676" author="kmarsden" created="Wed, 2 Apr 2008 18:25:35 +0100"  >&lt;p&gt;It seems highly unlikely that this client only patch could have caused such a failure.  Did you perhaps recently change your jdk version and this is what is causing the issue.&lt;/p&gt;</comment>
                            <comment id="12586313" author="kristwaa" created="Mon, 7 Apr 2008 11:12:22 +0100"  >&lt;p&gt;Backported the fix (trunk revision 643819) to the 10.4 branch with revision 645438.&lt;br/&gt;
I will file another Jira for the comments Knut Anders posted, as they should be addressed if we decide not to throw exceptions for accessing a LOB column multiple times (in the non-stream cases).&lt;/p&gt;</comment>
                            <comment id="12586327" author="kristwaa" created="Mon, 7 Apr 2008 11:40:59 +0100"  >&lt;p&gt;Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3601&quot; title=&quot;Optimize LOBStateTracker for non-locator servers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3601&quot;&gt;&lt;del&gt;DERBY-3601&lt;/del&gt;&lt;/a&gt; for the clean up actions.&lt;br/&gt;
I will close this issue shortly after the test results are in. Problems / bugs with the implementation should be filed as separate issues.&lt;/p&gt;</comment>
                            <comment id="12592427" author="kristwaa" created="Fri, 25 Apr 2008 17:21:22 +0100"  >&lt;p&gt;Thanks Kathey for backporting the fix(es) to 10.3.&lt;br/&gt;
No problems with the changes have been identified, I&apos;m closing the issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12372921">DERBY-2892</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12392528">DERBY-3575</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12393294">DERBY-3601</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12378638" name="derby-3571-1a-client_track_lob_fix.diff" size="16666" author="kristwaa" created="Wed, 26 Mar 2008 16:26:26 +0000"/>
                            <attachment id="12378639" name="derby-3571-1a-client_track_lob_fix.stat" size="508" author="kristwaa" created="Wed, 26 Mar 2008 16:26:26 +0000"/>
                            <attachment id="12378731" name="derby-3571-1b-client_track_lob_fix.diff" size="19088" author="kristwaa" created="Thu, 27 Mar 2008 16:16:37 +0000"/>
                            <attachment id="12378780" name="derby-3571-1c-client_track_lob_fix.diff" size="19472" author="kristwaa" created="Fri, 28 Mar 2008 10:08:43 +0000"/>
                            <attachment id="12378945" name="derby-3571-1d-client_track_lob_fix.diff" size="23022" author="kristwaa" created="Mon, 31 Mar 2008 12:03:50 +0100"/>
                            <attachment id="12378958" name="derby-3571-1e-client_track_lob_fix.diff" size="23031" author="kristwaa" created="Mon, 31 Mar 2008 13:42:57 +0100"/>
                            <attachment id="12379062" name="derby-3571-2a-simple_release.diff" size="34534" author="kristwaa" created="Tue, 1 Apr 2008 21:21:19 +0100"/>
                            <attachment id="12379063" name="derby-3571-2a-simple_release.stat" size="622" author="kristwaa" created="Tue, 1 Apr 2008 21:21:20 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 27 Mar 2008 13:48:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23720</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0x8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39203</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>