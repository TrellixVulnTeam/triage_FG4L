<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:24:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3319/DERBY-3319.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3319] Logical connections do not check if a transaction is active on close</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3319</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;If you call close on a logical connection, for instance as obtained through a PooledConnection, it does not check if there is an active transaction.&lt;br/&gt;
The close of the logical connection is allowed, and even the close of the parent PooledConnection is allowed in the client driver. This can/will cause resources to be left on the server, and later operations might fail (typically with lock timeouts because the &quot;closed&quot; transaction is still holding locks).&lt;br/&gt;
I do not know if gc will solve this eventually, but I would say the current behavior of the client driver is wrong in any case.&lt;br/&gt;
There is difference in the behavior between the embedded and the client driver, and there also seems to be a bug in the embedded driver.&lt;/p&gt;

&lt;p&gt;The analysis above is a bit sketchy, so it might be required to look into the issue a bit more...&lt;br/&gt;
I will attach a repro (JDBC usage should be verified as well, is it legal / as intended?)&lt;/p&gt;</description>
                <environment>Embedded driver and client driver.</environment>
        <key id="12386268">DERBY-3319</key>
            <summary>Logical connections do not check if a transaction is active on close</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Jan 2008 14:44:20 +0000</created>
                <updated>Tue, 14 Jul 2009 18:52:04 +0100</updated>
                            <resolved>Mon, 27 Oct 2008 15:23:30 +0000</resolved>
                                    <version>10.3.2.1</version>
                    <version>10.4.1.3</version>
                    <version>10.5.1.1</version>
                                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>JDBC</component>
                    <component>Network Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12559073" author="kristwaa" created="Tue, 15 Jan 2008 14:46:02 +0000"  >&lt;p&gt;&apos;LogicalConnectionCloseActiveTransactionBug.java&apos; is a repro for this issue.&lt;br/&gt;
Note the system property for running with the embedded or the client driver. Read class comment for how to compile/run.&lt;/p&gt;</comment>
                            <comment id="12573733" author="kristwaa" created="Fri, 29 Feb 2008 13:26:59 +0000"  >&lt;p&gt;A test in jdbcapi.StatementPoolingTest has been disabled due to this bug:&lt;br/&gt;
        // This test fails, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3319&quot; title=&quot;Logical connections do not check if a transaction is active on close&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3319&quot;&gt;&lt;del&gt;DERBY-3319&lt;/del&gt;&lt;/a&gt; is probably the cause.&lt;br/&gt;
        //reqDataSuite.addTest(new StatementPoolingTest(&lt;br/&gt;
        //        &quot;resTestNoDataCommittedOnInvalidTransactionState&quot;));&lt;/p&gt;

&lt;p&gt;It should be enabled and verified when this bug has been fixed.&lt;/p&gt;</comment>
                            <comment id="12583724" author="knutanders" created="Mon, 31 Mar 2008 16:34:28 +0100"  >&lt;p&gt;Let&apos;s see if I understand this issue correctly. Based on experiments with the attached test case, I think this is how the drivers behave:&lt;/p&gt;

&lt;p&gt;1. close() on logical connections with active transactions does not fail and resources are not freed (both embedded and client)&lt;/p&gt;

&lt;p&gt;2. EmbedPooledConnection.getConnection() issues a rollback on the physical connection&lt;/p&gt;

&lt;p&gt;3. ClientPooledConnection.getConnection() does not issue a rollback on the physical connection if the previous logical connection has been closed&lt;/p&gt;

&lt;p&gt;4. ClientPooledConnection.getConnection() issues a rollback on the physical connection if the previous logical connection has not been closed&lt;/p&gt;

&lt;p&gt;Does that sound about right?&lt;/p&gt;</comment>
                            <comment id="12584874" author="kristwaa" created="Wed, 2 Apr 2008 23:48:31 +0100"  >&lt;p&gt;I would think points 1 is incorrect behavior. If that one is fixed, I think point 3 might be okay.&lt;/p&gt;

&lt;p&gt;Points 2 and 4 are good. I believe it is required to be able to support &quot;connection stealing&quot;, i.e. when a connection pool implementation executes a sequence like this:&lt;br/&gt;
PooledConnection pc = ...&lt;br/&gt;
Connection lc1 = pc.getConnection()&lt;br/&gt;
// Give lc1 to a user/client.&lt;br/&gt;
// Then wait, and determine that the user having lc1 has crashed / timed out / misbehaved.&lt;br/&gt;
// Take back control of the physical connection and give a new logical connection to another user.&lt;br/&gt;
Connection lc2 = pc.getConnection()&lt;br/&gt;
// lc1 will now be closed / invalidated and should not contain any reference to the pooled / physical connection.&lt;/p&gt;

&lt;p&gt;We should not throw an exception in this case. Also note that the reference to the PooledConnection will normally not be available to end-users.&lt;br/&gt;
I logged this issue to get point 1 fixed.&lt;/p&gt;</comment>
                            <comment id="12609618" author="knutanders" created="Tue, 1 Jul 2008 16:18:35 +0100"  >&lt;p&gt;Regarding the &quot;connection stealing&quot;, it seems like that&apos;s what ClientPooledConnection, ClientXAConnection and EmbedPooledConnection do. However, EmbedXAConnection only steals the connection if it is not part of a global connection. If it is part of a global XA connection, an exception is thrown. Here&apos;s the relevant code and comment in EmbedXAConnection.getConnection():&lt;/p&gt;

&lt;p&gt;			if (currentConnectionHandle != null) &lt;/p&gt;
{
				// this can only happen if someone called start(Xid),
				// getConnection, getConnection (and we are now the 2nd
				// getConnection call).
				// Cannot yank a global connection away like, I don&apos;t think... 
				throw Util.generateCsSQLException(
							   SQLState.CANNOT_CLOSE_ACTIVE_XA_CONNECTION);
			}

&lt;p&gt;I&apos;m not sure what the correct approach is in this case. For pooled connections, I see that it makes sense to allow stealing the connection and aborting the active transaction because of the reasons Kristian mentioned above, but it&apos;s not clear to me if the same would apply to global XA connections.&lt;/p&gt;

&lt;p&gt;One difference between pooled connections and XA connections in this respect is that PooledConnection.getConnection() is expected to return a fresh logical connection that executes in a different transaction than the previous logical connection, whereas the connection returned by XAConnection.getConnection() is expected to execute in the same global transaction as the previous logical connection did. At least, J2EEDataSourceTest is testing that they behave this way, so I assume that it is expected.&lt;/p&gt;</comment>
                            <comment id="12610917" author="knutanders" created="Mon, 7 Jul 2008 09:57:17 +0100"  >&lt;p&gt;Currently, plain connections (from DriverManager) throw an exception on close if they have uncommitted operations and they have auto-commit off. I think connections that come from data sources should behave the same way, but if the connection is associated with an XA transaction, I think it should not throw an exception because&lt;/p&gt;

&lt;p&gt;  a) the connection object doesn&apos;t control commit/rollback. Even if the connection is closed, the global transaction can still be committed or rolled back with the XAResource. I think the rationale for disallowing close on plain connections when the transaction is active, is that there&apos;s no way to end the transaction after the connection is closed. Since this is not the case for XA transactions, there&apos;s no need to throw the exception.&lt;/p&gt;

&lt;p&gt;  b) there are regression tests that depend on the ability to close a connection before ending the associated XA transaction (sequences like XAResource.start() ... XAConnection.getConnection() ... Connection.close() ... XAConnection.getConnection() ... Connection.close() ... XAResource.end()) so keeping the current behaviour for these connections sounds safer&lt;/p&gt;

&lt;p&gt;Unless there are objections to this approach, I&apos;ll post a patch which implements this new behaviour.&lt;/p&gt;</comment>
                            <comment id="12611570" author="knutanders" created="Tue, 8 Jul 2008 14:11:05 +0100"  >&lt;p&gt;Here&apos;s a patch that changes the behaviour as described in the previous&lt;br/&gt;
comment. The patch touches the following files:&lt;/p&gt;

&lt;p&gt;Embedded:&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;factored out code to check for active transaction in close() so&lt;br/&gt;
    that it can be used in EmbedPooledConnection too&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;M      java/engine/org/apache/derby/iapi/jdbc/BrokeredConnectionControl.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new interface method to check if it is allowed to close a brokered&lt;br/&gt;
    connection (checkClose())&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;M      java/engine/org/apache/derby/jdbc/EmbedPooledConnection.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;implementation of BrokeredConnectionControl.checkClose()&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in getConnection(), reset the physical connection before closing&lt;br/&gt;
    the existing logical connection, so that an exception isn&apos;t thrown&lt;br/&gt;
    if the logical connection is still active&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;M      java/engine/org/apache/derby/jdbc/EmbedXAConnection.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;factored out common code to check if the transaction is global&lt;br/&gt;
    into a helper method (isGlobal())&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;implementation of BrokeredConnectionControl.checkClose()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;M      java/engine/org/apache/derby/iapi/jdbc/BrokeredConnection.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;use BrokeredConnectionControl.checkClose() in close() to get the&lt;br/&gt;
    expected exception when the transaction is active&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Client:&lt;/p&gt;

&lt;p&gt;M      java/client/org/apache/derby/client/net/NetConnection.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixed existing method (allowCloseInUOW_()) for checking if the&lt;br/&gt;
    connection can be closed in unit of work (previously is always&lt;br/&gt;
    returned false)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;M      java/client/org/apache/derby/client/am/Connection.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;transactionInProgress(): check NetConnection.allowCloseInUOW_()&lt;br/&gt;
    instead of the autoCommit_ flag to find out if a transaction in&lt;br/&gt;
    progress prevents us from closing the connection. Without this&lt;br/&gt;
    change, XAConnection.getConnection() thinks that it needs to roll&lt;br/&gt;
    back active global XA transactions, which it is not allowed to do.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;checkForTransactionInProgress(): don&apos;t check allowCloseInUOW_()&lt;br/&gt;
    since it is now checked in transactionInProgress()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;M      java/client/org/apache/derby/client/am/LogicalConnection.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;call checkForTransactionInProgress() from close() to get the&lt;br/&gt;
    expected exception when the transaction is active&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Tests:&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/StatementPoolingTest.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enabled the test case that had been disabled because of this issue&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixed two occurrences of connections being closed with active&lt;br/&gt;
    transactions&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/J2EEDataSourceTest.java&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;test cases for close of active connections with all combinations of&lt;br/&gt;
    
{ auto-commit, no auto-commit }
&lt;p&gt; &#215;&lt;br/&gt;
    &lt;/p&gt;
{ DataSource, ConnectionPoolDS, local XADataSource, global XADataSource}
&lt;p&gt; &#215;&lt;/p&gt;
    { client, embedded }&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;All the regression tests passed, except for the wisconsin test, which&lt;br/&gt;
passed on rerun.&lt;/p&gt;</comment>
                            <comment id="12612809" author="knutanders" created="Fri, 11 Jul 2008 09:57:51 +0100"  >&lt;p&gt;Committed revision 675870.&lt;/p&gt;

&lt;p&gt;I think a release note is needed, since now we&apos;ll throw an exception where we previously didn&apos;t, so I&apos;m leaving the issue open for now.&lt;/p&gt;</comment>
                            <comment id="12642940" author="knutanders" created="Mon, 27 Oct 2008 15:21:24 +0000"  >&lt;p&gt;Attaching a release note for this issue.&lt;/p&gt;</comment>
                            <comment id="12644156" author="dagw" created="Thu, 30 Oct 2008 23:18:34 +0000"  >&lt;p&gt;Release note looks good to me.&lt;/p&gt;</comment>
                            <comment id="12644310" author="kristwaa" created="Fri, 31 Oct 2008 14:50:14 +0000"  >&lt;p&gt;Closing issue.&lt;/p&gt;

&lt;p&gt;I verified that the repro no longer failed with trunk, and that it did indeed fail with 10.4 (that is, it threw an exception in a different place - when closing the last physical PooledConnection).&lt;br/&gt;
The release notes also look good.&lt;/p&gt;</comment>
                            <comment id="12730470" author="kmarsden" created="Mon, 13 Jul 2009 20:17:04 +0100"  >&lt;p&gt;In addition to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4053&quot; title=&quot;Network Server&amp;#39;s failure to rollback local transactions on shutdown can cause  hang on startup with message java.net.BindException: Address already in use: NET_Bind in derby.log &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4053&quot;&gt;&lt;del&gt;DERBY-4053&lt;/del&gt;&lt;/a&gt;,  I think we had a user report of a hard to diagnose issue after this change. To facilitate diagnosis, should the error that the connection cannot be closed be logged to derby.log especially if derby.stream.error.logSeverityLevel=0?&lt;/p&gt;</comment>
                            <comment id="12730485" author="kmarsden" created="Mon, 13 Jul 2009 21:02:56 +0100"  >&lt;p&gt;Linking &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4053&quot; title=&quot;Network Server&amp;#39;s failure to rollback local transactions on shutdown can cause  hang on startup with message java.net.BindException: Address already in use: NET_Bind in derby.log &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4053&quot;&gt;&lt;del&gt;DERBY-4053&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
The new requirement that local transactions be rolled back before closing pooled connections was causing network server to fail to shutdown properly.&lt;/p&gt;</comment>
                            <comment id="12730801" author="knutanders" created="Tue, 14 Jul 2009 13:03:10 +0100"  >&lt;p&gt;Kathey, since the error has statement severity (20000) it is worth filing a bug if it&apos;s not automatically logged with logSeverityLevel=0.&lt;/p&gt;</comment>
                            <comment id="12730999" author="kmarsden" created="Tue, 14 Jul 2009 18:52:04 +0100"  >&lt;p&gt;I raised the priority of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1191&quot; title=&quot;Some SQLExceptions, for example those generated from BrokeredStatements,  do not print to derby.log even  when  derby.stream.error.logSeverityLevel=0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1191&quot;&gt;DERBY-1191&lt;/a&gt; for the general case and linked it to this issue.  I think this particular case is pretty urgent as it seems really hard to track these issues down as we found in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4053&quot; title=&quot;Network Server&amp;#39;s failure to rollback local transactions on shutdown can cause  hang on startup with message java.net.BindException: Address already in use: NET_Bind in derby.log &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4053&quot;&gt;&lt;del&gt;DERBY-4053&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4225&quot; title=&quot;EmbeddedConnectionPoolDataSource40 never calls the ConnectionEventListener calbacks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4225&quot;&gt;&lt;del&gt;DERBY-4225&lt;/del&gt;&lt;/a&gt; but I don&apos;t know if it is easier just to fix the general case.  If not a subtask of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1191&quot; title=&quot;Some SQLExceptions, for example those generated from BrokeredStatements,  do not print to derby.log even  when  derby.stream.error.logSeverityLevel=0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1191&quot;&gt;DERBY-1191&lt;/a&gt; can be filed to fix this one.&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12414620">DERBY-4053</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12331782">DERBY-1191</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12425194">DERBY-4225</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12373170" name="LogicalConnectionCloseActiveTransactionBug.java" size="2433" author="kristwaa" created="Tue, 15 Jan 2008 14:46:02 +0000"/>
                            <attachment id="12385498" name="d3319-1a.diff" size="18748" author="knutanders" created="Tue, 8 Jul 2008 14:11:04 +0100"/>
                            <attachment id="12385499" name="d3319-1a.stat" size="737" author="knutanders" created="Tue, 8 Jul 2008 14:11:05 +0100"/>
                            <attachment id="12392868" name="releaseNote.html" size="4679" author="knutanders" created="Mon, 27 Oct 2008 15:21:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 31 Mar 2008 15:34:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23570</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0s5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38380</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>