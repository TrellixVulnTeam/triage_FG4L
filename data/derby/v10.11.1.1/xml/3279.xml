<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:24:35 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3279/DERBY-3279.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3279] Derby 10.3.X ignores ORDER BY DESC when target column has an index and is used in an OR clause or an IN list.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3279</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Running the following produces the error seen in Derby 10.3.X but not in 10.2.X nor in 10.1.X.&lt;br/&gt;
Don&apos;t know if this related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3231&quot; title=&quot;Sorting on COUNT with OR and GROUP BY delivers wrong results.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3231&quot;&gt;&lt;del&gt;DERBY-3231&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;First query is incorrectly sorted whereas the second one is okay when there is an index on the table. &lt;br/&gt;
If the table is not indexed, the sort works correctly in DESC order.&lt;br/&gt;
------&lt;br/&gt;
create table CHEESE (&lt;br/&gt;
  CHEESE_CODE       VARCHAR(5),&lt;br/&gt;
  CHEESE_NAME       VARCHAR(20),&lt;br/&gt;
  CHEESE_COST       DECIMAL(7,4)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create index cheese_index on CHEESE (CHEESE_CODE DESC, CHEESE_NAME DESC, CHEESE_COST DESC);&lt;/p&gt;

&lt;p&gt;INSERT INTO CHEESE (&lt;br/&gt;
  CHEESE_CODE,&lt;br/&gt;
  CHEESE_NAME,&lt;br/&gt;
  CHEESE_COST)&lt;br/&gt;
VALUES (&apos;00000&apos;, &apos;GOUDA&apos;, 001.1234),&lt;br/&gt;
       (&apos;00000&apos;, &apos;EDAM&apos;, 002.1111),&lt;br/&gt;
       (&apos;54321&apos;, &apos;EDAM&apos;, 008.5646),&lt;br/&gt;
       (&apos;12345&apos;, &apos;GORGONZOLA&apos;, 888.2309),&lt;br/&gt;
       (&apos;AAAAA&apos;, &apos;EDAM&apos;, 999.8888),&lt;br/&gt;
       (&apos;54321&apos;, &apos;MUENSTER&apos;, 077.9545);&lt;/p&gt;

&lt;p&gt;SELECT * FROM CHEESE &lt;br/&gt;
WHERE (CHEESE_CODE=&apos;00000&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
ORDER BY CHEESE_CODE DESC, CHEESE_NAME DESC, CHEESE_COST DESC;&lt;/p&gt;

&lt;p&gt;SELECT * FROM CHEESE &lt;br/&gt;
WHERE (CHEESE_CODE=&apos;AAAAA&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
ORDER BY CHEESE_CODE DESC, CHEESE_NAME DESC, CHEESE_COST DESC;&lt;/p&gt;</description>
                <environment>Rational Application Developer 7.0.0.2 (Eclipse 3.2.2), J2RE 1.5.0 IBM J9 2.3 Windows XP</environment>
        <key id="12384686">DERBY-3279</key>
            <summary>Derby 10.3.X ignores ORDER BY DESC when target column has an index and is used in an OR clause or an IN list.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="abhala">Ajay Bhala</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Dec 2007 21:21:32 +0000</created>
                <updated>Fri, 21 Jan 2011 17:51:13 +0000</updated>
                            <resolved>Thu, 7 Feb 2008 19:03:15 +0000</resolved>
                                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12551947" author="djd" created="Fri, 14 Dec 2007 21:38:57 +0000"  >&lt;p&gt;Here&apos;s what I get for trunk, both of them look incorrect since the ORDEY BY has DESC?&lt;/p&gt;

&lt;p&gt;ij&amp;gt; SELECT * FROM CHEESE&lt;br/&gt;
WHERE (CHEESE_CODE=&apos;00000&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
&amp;gt; &amp;gt; ORDER BY CHEESE_CODE DESC, CHEESE_NAME DESC, CHEESE_COST DESC;&lt;br/&gt;
CHEE&amp;amp;|CHEESE_NAME         |CHEESE_C&amp;amp;&lt;br/&gt;
------------------------------------&lt;br/&gt;
00000|EDAM                |2.1111&lt;br/&gt;
54321|EDAM                |8.5646&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;br/&gt;
ij&amp;gt; SELECT * FROM CHEESE&lt;br/&gt;
WHERE (CHEESE_CODE=&apos;AAAAA&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
&amp;gt; &amp;gt; ORDER BY CHEESE_CODE DESC, CHEESE_NAME DESC, CHEESE_COST DESC;&lt;br/&gt;
CHEE&amp;amp;|CHEESE_NAME         |CHEESE_C&amp;amp;&lt;br/&gt;
------------------------------------&lt;br/&gt;
54321|EDAM                |8.5646&lt;br/&gt;
AAAAA|EDAM                |999.8888&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;/p&gt;</comment>
                            <comment id="12551948" author="mamtas" created="Fri, 14 Dec 2007 21:39:59 +0000"  >&lt;p&gt;Ajay, I am curious if the database in Derby 10.3 was created with territory based collation enabled? In other words, when the database was created, did you use a JDBC url property like collation=TERRITORY_BASED?&lt;/p&gt;</comment>
                            <comment id="12551958" author="kmarsden" created="Fri, 14 Dec 2007 22:10:53 +0000"  >&lt;p&gt;This is a regression caused by revision 516454 of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt;, but appears to be different than &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3231&quot; title=&quot;Sorting on COUNT with OR and GROUP BY delivers wrong results.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3231&quot;&gt;&lt;del&gt;DERBY-3231&lt;/del&gt;&lt;/a&gt; as it reproduces on the trunk as well after the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3231&quot; title=&quot;Sorting on COUNT with OR and GROUP BY delivers wrong results.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3231&quot;&gt;&lt;del&gt;DERBY-3231&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="12551961" author="kmarsden" created="Fri, 14 Dec 2007 22:14:40 +0000"  >&lt;p&gt;I tested with revision 516453 and the sort ordered properly, but not with revision 516454 (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="12551962" author="army" created="Fri, 14 Dec 2007 22:17:26 +0000"  >&lt;p&gt;Actually, though I hate to say it, I think it&apos;s a regression caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt;.  When I run with 516454 (i.e. after &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt; was committed I see the correct results:&lt;/p&gt;

&lt;p&gt;ij(CONNECTION1)&amp;gt; SELECT * FROM CHEESE&lt;br/&gt;
WHERE (CHEESE_CODE=&apos;00000&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
ORDER BY CHEESE_CODE DESC, CHEESE_NAME DESC, CHEESE_COST DESC;&lt;br/&gt;
CHEE&amp;amp;|CHEESE_NAME         |CHEESE_C&amp;amp;&lt;br/&gt;
------------------------------------&lt;br/&gt;
54321|EDAM                |8.5646&lt;br/&gt;
00000|EDAM                |2.1111&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;br/&gt;
ij(CONNECTION1)&amp;gt; SELECT * FROM CHEESE&lt;br/&gt;
WHERE (CHEESE_CODE=&apos;AAAAA&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
ORDER BY CHEESE_CODE DESC, CHEESE_NAME DESC, CHEESE_COST DESC;&lt;br/&gt;
CHEE&amp;amp;|CHEESE_NAME         |CHEESE_C&amp;amp;&lt;br/&gt;
------------------------------------&lt;br/&gt;
AAAAA|EDAM                |999.8888&lt;br/&gt;
54321|EDAM                |8.5646&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;br/&gt;
ij(CONNECTION1)&amp;gt; SELECT * FROM CHEESE&lt;br/&gt;
WHERE (CHEESE_CODE=&apos;00000&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
ORDER BY CHEESE_CODE ASC, CHEESE_NAME DESC, CHEESE_COST ASC;&lt;br/&gt;
CHEE&amp;amp;|CHEESE_NAME         |CHEESE_C&amp;amp;&lt;br/&gt;
------------------------------------&lt;br/&gt;
00000|EDAM                |2.1111&lt;br/&gt;
54321|EDAM                |8.5646&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;br/&gt;
ij(CONNECTION1)&amp;gt; SELECT * FROM CHEESE&lt;br/&gt;
WHERE (CHEESE_CODE=&apos;AAAAA&apos; OR CHEESE_CODE=&apos;54321&apos;) AND CHEESE_NAME=&apos;EDAM&apos;&lt;br/&gt;
ORDER BY CHEESE_CODE ASC, CHEESE_NAME DESC, CHEESE_COST ASC;&lt;br/&gt;
CHEE&amp;amp;|CHEESE_NAME         |CHEESE_C&amp;amp;&lt;br/&gt;
------------------------------------&lt;br/&gt;
54321|EDAM                |8.5646&lt;br/&gt;
AAAAA|EDAM                |999.8888&lt;/p&gt;

&lt;p&gt;2 rows selected&lt;/p&gt;

&lt;p&gt;But I run after the final commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt;, the results are the same regardless of whether we sort ASC ro DESC on CHEESE_CODE (i.e. sort is ignored).&lt;/p&gt;</comment>
                            <comment id="12551968" author="kmarsden" created="Fri, 14 Dec 2007 22:37:39 +0000"  >&lt;p&gt;Yes, my bad. I come back from getting my coffee and there  it is on the screen in the correct order. Sorry for the noise.  Without the coffee I am quite sure it sorted the other way #&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Guess I need both coffee and vacation.&lt;/p&gt;</comment>
                            <comment id="12552306" author="army" created="Mon, 17 Dec 2007 00:52:57 +0000"  >&lt;p&gt;In the absence of IN list &quot;multi-probing&quot;, the way Derby implements an IN list is:&lt;/p&gt;

&lt;p&gt;  while (more rows in the underlying result set)&lt;/p&gt;
  {
      get next row from the result set
      search IN list values to see if target column of row exists in the IN list
      if target column of the row exists in the IN list, return the row
  }

&lt;p&gt;Since the loop is based on scanning the underlying result set for rows, any rows which we return will be returned in the order they are received from the underlying result set.  So if, for example, the underlying result is an index scan, and if the index is defined as DESCENDING, the rows will come back in descending order.&lt;/p&gt;

&lt;p&gt;With multi-probing enabled, which only happens after &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-47&quot; title=&quot;Some possible improvements to IN optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-47&quot;&gt;&lt;del&gt;DERBY-47&lt;/del&gt;&lt;/a&gt; and only happens for index scans (which is why the ordering is correct if the index is removed, per Ajay&apos;s description), the processing is (loosely):&lt;/p&gt;

&lt;p&gt;  while (more values in the IN list)&lt;/p&gt;
  {
      get next IN list value
      probe underlying index for a row whose target column matches the current IN list value
      if index probe returned a row, return that row
  }

&lt;p&gt;Notice how, here, the loop is driven by the order of the values in the &lt;b&gt;IN list&lt;/b&gt;, instead of by the order of the rows as they are returned from the index scan.  So even if the index is defined as &quot;DESC&quot;, the final ordering of the rows will match the ordering of the IN values.&lt;/p&gt;

&lt;p&gt;That said, in order to ensure proper handling of duplicate IN list values, the current multi-probe logic in Derby always sorts IN list values in ASCENDING order.  So unless an explicit SortResultSet is generated for execution time, the rows for an IN-list multi-probe will always be in ASCENDING order.&lt;/p&gt;

&lt;p&gt;The final relevant piece of information is that the optimizer is smart enough to remove unnecessary sorts when a) there is an ORDER BY on some index column IC, b) the final access plan uses that index, and c) the ASC/DESC option of the ORDER BY matches the ASC/DESC option of the index column IC.  For the example queries, we have &quot;ORDER BY CHEESE_CODE DESC&quot;, and we have an index definition which includes &quot;CHEESE_CODE DESC&quot;.  So the optimizer thinks the sort is unnecessary and removes it.  Hence this Jira.&lt;/p&gt;

&lt;p&gt;There are two fixes that come to mind right away:&lt;/p&gt;

&lt;p&gt;  1. Make the optimizer recognize that the sort cannot be removed if we&apos;re multi-probing, or&lt;br/&gt;
  2. Make MultiProbeTableScanResultSet sort the IN list values in ascending OR descending order depending on the ORDER BY clause (instead of always sorting in ASCENDING).&lt;/p&gt;

&lt;p&gt;I think option #2 is the best option here.  I have a fix in progress and will post when it is postable...&lt;/p&gt;</comment>
                            <comment id="12553493" author="abhala" created="Wed, 19 Dec 2007 21:03:51 +0000"  >&lt;p&gt;AB, thank you for that explanation.  I look forward to the fix.&lt;/p&gt;

&lt;p&gt;Ajay&lt;/p&gt;</comment>
                            <comment id="12561729" author="abhala" created="Wed, 23 Jan 2008 16:18:21 +0000"  >&lt;p&gt;AB, just wondering if you can provide me with an update on the fix you have available.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ajay&lt;/p&gt;</comment>
                            <comment id="12561732" author="army" created="Wed, 23 Jan 2008 16:39:24 +0000"  >&lt;p&gt;Hi Ajay,&lt;/p&gt;

&lt;p&gt;Sorry for the delay, I&apos;ve had other things on my plate.  But as it turns out, I was working with this yesterday and just a few minutes ago I kicked off the nightly regression tests with what I &lt;em&gt;think&lt;/em&gt; is an acceptable patch for this issue.  I still need to clean up the changes/comments a bit, but if the tests all pass I hope to post something by the end of the day today (PST).&lt;/p&gt;</comment>
                            <comment id="12561832" author="army" created="Wed, 23 Jan 2008 22:05:12 +0000"  >&lt;p&gt;Attaching a first attempt at resolving this issue.&lt;/p&gt;

&lt;p&gt;The problem as described above only occurs in situations where preprocessing/optimization eliminates a sort.  There is already a method called &quot;adjustForSortElimination()&quot; defined in ResultSetNode, so this patch creates an alternate signature that takes an OrderByList as an argument.  Then, in the case where sort elimination occurs, we will search a table&apos;s predicates to see if any of them is a multi-probing predicate.  If so, we check to see if the ORDER BY that was eliminated required a DESCENDING sort on the multi-probe column, and we adjust for that (if needed) by sorting the IN list values into descending order at execution time.  See code comments for details.&lt;/p&gt;

&lt;p&gt;I ran derbyall and suites.All with this patch applied and saw no failures.  Review comments are appreciated.&lt;/p&gt;</comment>
                            <comment id="12561833" author="army" created="Wed, 23 Jan 2008 22:07:06 +0000"  >&lt;p&gt;Changing summary to more closely describe  the problem.&lt;/p&gt;</comment>
                            <comment id="12561935" author="bryanpendleton" created="Thu, 24 Jan 2008 04:30:46 +0000"  >&lt;p&gt;Hopefully this isn&apos;t possible, but I thought I&apos;d ask:&lt;/p&gt;

&lt;p&gt;What if there was a multi-column index, for example,&lt;br/&gt;
CREATE INDEX NAME_IDX ON EMPLOYEE(LAST_NAME,FIRST_NAME),&lt;br/&gt;
and I had a query that was something like:&lt;/p&gt;

&lt;p&gt;  SELECT LAST_NAME,FIRST_NAME FROM EMPLOYEE&lt;br/&gt;
  WHERE LAST_NAME IN (&apos;REAGAN&apos;, &apos;CLINTON&apos;, &apos;BUSH&apos;)&lt;br/&gt;
  AND FIRST_NAME IN (&apos;RONALD&apos;, &apos;WILLIAM&apos;, &apos;GEORGE&apos;)&lt;br/&gt;
  ORDER BY LAST_NAME ASC, FIRST_NAME DESC&lt;/p&gt;

&lt;p&gt;In such a case, if we decided to do in-list multi-probing&lt;br/&gt;
against the NAME_IDX, would we have an ambiguity about&lt;br/&gt;
whether we wanted to sort the (LAST_NAME,FIRST_NAME)&lt;br/&gt;
values in ASC or DESC order?&lt;/p&gt;</comment>
                            <comment id="12562125" author="army" created="Thu, 24 Jan 2008 16:47:13 +0000"  >&lt;p&gt;&amp;gt; What if there was a multi-column index &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; if we decided to do in-list multi-probing&lt;br/&gt;
&amp;gt; against the NAME_IDX, would we have an ambiguity about whether we wanted to&lt;br/&gt;
&amp;gt; sort the (LAST_NAME,FIRST_NAME) values in ASC or DESC order?&lt;/p&gt;

&lt;p&gt;Great question, Bryan.  Thanks for bringing it up!&lt;/p&gt;

&lt;p&gt;I think the answer is, in fact, that &quot;this isn&apos;t possible&quot;.  A given multi-probing result set only ever works with a single column--even if that column is part of a multi-column index.  See the following comments from TableScanResultSet:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Note that it &lt;b&gt;is&lt;/b&gt; possible for a start/stop key to contain more&lt;/li&gt;
	&lt;li&gt;than one column (ex. if we&apos;re scanning a multi-column index). In&lt;/li&gt;
	&lt;li&gt;that case we plug probeValue into the first column of the start&lt;/li&gt;
	&lt;li&gt;and/or stop key and leave the rest of the key as it is.  As an&lt;/li&gt;
	&lt;li&gt;example, assume we have the following predicates:&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;... where d in (1, 20000) and b &amp;gt; 200 and b &amp;lt;= 500&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;And assume further that we have an index defined on (d, b).&lt;/li&gt;
	&lt;li&gt;In this case it&apos;s possible that we have TWO start predicates&lt;/li&gt;
	&lt;li&gt;and TWO stop predicates: the IN list will give us &quot;d = probeVal&quot;,&lt;/li&gt;
	&lt;li&gt;which is a start predicate and a stop predicate; then &quot;b &amp;gt; 200&quot;&lt;/li&gt;
	&lt;li&gt;may give us a second start predicate, while &quot;b &amp;lt;= 500&quot; may give&lt;/li&gt;
	&lt;li&gt;us a second stop predicate.  So in this situation we want our&lt;/li&gt;
	&lt;li&gt;start key to be:&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;(probeValue, 200)&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;and our stop key to be:&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;(probeValue, 500).&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;This will effectively limit the scan so that it only returns&lt;/li&gt;
	&lt;li&gt;rows whose &quot;D&quot; column equals probeValue and whose &quot;B&quot; column&lt;/li&gt;
	&lt;li&gt;falls in the range of 200 thru 500.&lt;br/&gt;
         *&lt;/li&gt;
	&lt;li&gt;Note: Derby currently only allows a single start/stop predicate&lt;/li&gt;
	&lt;li&gt;per column. See PredicateList.orderUsefulPredicates().&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It&apos;s also worth noting that Derby will only do multi-probing IF the column in question is the FIRST column in the index.  This comes from the comments in PredicateList.orderUsefulPredicates():&lt;/p&gt;

&lt;p&gt;               else if (pred.isInListProbePredicate()&lt;br/&gt;
                        &amp;amp;&amp;amp; (indexPosition &amp;gt; 0))&lt;/p&gt;
                {
                    /* If the predicate is an IN-list probe predicate
                     * then we only consider it to be useful if the
                     * referenced column is the *first* one in the
                     * index (i.e. if (indexPosition == 0)).  Otherwise
                     * the predicate would be treated as a qualifier
                     * for store, which could lead to incorrect
                     * results.
                     */
                    indexCol = null;
                }

&lt;p&gt;So in the example you gave above, we would (should) never do multi-probing for FIRST_NAME.  We would either do multi-probing based on LAST_NAME, in which case the sort would have to be ASC, or we would do no multi-probing at all.  The FIRST_NAME IN list would be treated as a &quot;normal&quot; (non-probing) IN list operator.&lt;/p&gt;

&lt;p&gt;At least, that&apos;s the theory.  If you&apos;d like me to add a test case for that, just to be sure, let me know and I can certainly do so.&lt;/p&gt;

&lt;p&gt;If this still isnt&apos; clear, please feel free to ask again. And thanks, as always, for your great comments!&lt;/p&gt;</comment>
                            <comment id="12562334" author="bryanpendleton" created="Fri, 25 Jan 2008 01:46:24 +0000"  >&lt;p&gt;Very good. I anticipated that answer, but it was quite helpful &lt;br/&gt;
to read your clear and detailed answer. Thanks!&lt;/p&gt;

&lt;p&gt;I read through the patch and didn&apos;t notice any other issues that &lt;br/&gt;
concerned me. I think you should move ahead with this approach.&lt;/p&gt;</comment>
                            <comment id="12563358" author="army" created="Tue, 29 Jan 2008 01:02:51 +0000"  >&lt;p&gt;Thank you, as always, for your review Bryan.  I committed the _v1 patch with svn # 616126:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=616126&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=616126&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unchecking the patch available flag and marking Fix In as 10.4.  As per usual, if the tinderbox results run cleanly over the next few days, I&apos;ll look at porting this back to 10.3.&lt;/p&gt;</comment>
                            <comment id="12563676" author="abhala" created="Tue, 29 Jan 2008 21:22:46 +0000"  >&lt;p&gt;AB, thank you for the patch file.  I patched the source from 10.3.2.1 with the file and re-ran my queries above.&lt;br/&gt;
All seems well.  However when I ran the queries in the attached file, I saw some incorrect sorting.  The queries are similar to the original posting save for the fact that CHEESE_COST is neither in the index nor in the ORDER BY clause.&lt;/p&gt;</comment>
                            <comment id="12563678" author="abhala" created="Tue, 29 Jan 2008 21:24:13 +0000"  >&lt;p&gt;cheese2.sql has test queries for patch d3279_v1.patch&lt;/p&gt;</comment>
                            <comment id="12563692" author="army" created="Tue, 29 Jan 2008 22:15:10 +0000"  >&lt;p&gt;Thanks for running the tests, Ajay.&lt;/p&gt;

&lt;p&gt;The removal of CHEESE_COST from the index means that the index now has a subset of the columns from the base table.  That in turn means that we have to generate an IndexToBaseRowNode above the base table (which we won&apos;t do if the index and the base table have the same columns).  In my first patch I overlooked this fact and thus did not propagate the call to &quot;adjustForSortElimination()&quot; down to the base table beneath IndexToBaseRowNode.&lt;/p&gt;

&lt;p&gt;To fix this I just had to add an appropriate call to IndexToBaseRowNode:&lt;/p&gt;

&lt;p&gt;+       /**&lt;br/&gt;
+        * @see ResultSetNode#adjustForSortElimination&lt;br/&gt;
+        */&lt;br/&gt;
+       void adjustForSortElimination(RequiredRowOrdering rowOrdering)&lt;br/&gt;
+               throws StandardException&lt;br/&gt;
+       &lt;/p&gt;
{
+               source.adjustForSortElimination(rowOrdering);
+       }

&lt;p&gt;and the queries in cheese2.sql now sort correctly.  I want to look a bit more to see if there are any other cases where intermediary nodes are added above FromBaseTable and thus need a similar change, and then I will post a follow-up patch with the corresponding changes.&lt;/p&gt;

&lt;p&gt;Thanks again for running more tests and reporting back!&lt;/p&gt;</comment>
                            <comment id="12564180" author="army" created="Wed, 30 Jan 2008 21:38:20 +0000"  >&lt;p&gt;Attaching a follow-up patch, d3279_ix2brnode_v1.patch, that fixes the case for IndexToBaseRowNodes which appear above the base table.  I didn&apos;t see any other cases where similar changes were necessary (or rather, all other cases were handled by the _v1 patch).&lt;/p&gt;

&lt;p&gt;This patch also adds some more test cases to InListMultiProbeTest, esp. to 1) test the case where the index has fewer columns than the base table, and 2) test queries that have multiple IN lists in them.  I decided to add the latter set of tests since Bryan asked about a similar query in an earlier comment, and since cheese2.sql also includes a couple of queries with multiple IN lists in the where clause (indirectly).&lt;/p&gt;

&lt;p&gt;I ran derbyall and suites.All with ibm142 and saw no failures.&lt;/p&gt;</comment>
                            <comment id="12564818" author="army" created="Fri, 1 Feb 2008 16:30:14 +0000"  >&lt;p&gt;Committed d3279_ix2brnode_v1.patch to trunk with svn # 617548:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=617548&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=617548&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ajay, if you can do more testing of your queries with this change applied, that would be helpful--and thanks for your patience in the meantime.  Otherwise, assuming all goes well with tinderbox runs for the next few days, I&apos;ll plan to port the changes to 10.3 sometime late next week...&lt;/p&gt;</comment>
                            <comment id="12565400" author="abhala" created="Mon, 4 Feb 2008 15:44:42 +0000"  >&lt;p&gt;AB, I will try to perform more testing this week and let you know how things work out.&lt;/p&gt;

&lt;p&gt;Thanks again.&lt;/p&gt;

&lt;p&gt;Ajay&lt;/p&gt;</comment>
                            <comment id="12565968" author="army" created="Wed, 6 Feb 2008 00:09:14 +0000"  >&lt;p&gt;I ran the following &quot;svn merge&quot; commands to port this change back to 10.3:&lt;/p&gt;

&lt;p&gt; svn merge -r 616125:616126 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;br/&gt;
 svn merge -r 617547:617548 &lt;a href=&quot;https://svn.apache.org/repos/asf/db/derby/code/trunk&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/db/derby/code/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The second command saw a conflict due to svn # 614745, which went into trunk but not into 10.3.  So I had to do a manual resolution of the conflict--which simply amounted to adjusting for 2 lines in junit/JDBC.java.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching d3279_10_3_merge.patch, which encapsulates the &quot;svn merge&quot; commands plus the conflict resolution.  I ran the 10.3 &quot;derbyall&quot; and &quot;suites.All&quot; regression tests and saw no failures.&lt;/p&gt;

&lt;p&gt;I&apos;ll wait a day or two to see if Ajay&apos;s testing illuminates any other problems; if not, then I&apos;ll go ahead and commit the merge patch to the 10.3 branch.&lt;/p&gt;</comment>
                            <comment id="12566724" author="abhala" created="Thu, 7 Feb 2008 18:23:12 +0000"  >&lt;p&gt;AB, I&apos;ve not had the opportunity to test the v2 patch but my colleague has.  His testing has not revealed further issues.  I would say that we can put this bug to bed.&lt;/p&gt;

&lt;p&gt;Thanks for your help,&lt;/p&gt;

&lt;p&gt;Ajay&lt;/p&gt;</comment>
                            <comment id="12566744" author="army" created="Thu, 7 Feb 2008 19:03:14 +0000"  >&lt;p&gt;Thanks for the feedback, Ajay.  I committed the changes to 10.3 with svn # 619568:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=619568&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=619568&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; I would say that we can put this bug to bed.&lt;/p&gt;

&lt;p&gt;Since it&apos;s in 10.3 now, I&apos;m marking the issue as resolved.  If all is okay, can you go ahead and close it when you have the chance?  Thanks again for your patience on this one...&lt;/p&gt;</comment>
                            <comment id="12584393" author="army" created="Wed, 2 Apr 2008 04:37:47 +0100"  >&lt;p&gt;I don&apos;t know if fixes for wrong results &lt;b&gt;regressions&lt;/b&gt; really need a release note or not-&lt;del&gt;esp. if it &apos;s just an ordering issue&lt;/del&gt;-but I&apos;m attaching one here anyway.  I am &lt;b&gt;not&lt;/b&gt; checking the &quot;Existing Application Impact&quot; box as I don&apos;t know what the rules are for regressions.  If it is agreed that release notes are good for regression fixes, as well, then someone can check the appropriate box to have the release note picked up by the generator tool.  Note: the html file will have to be &quot;scrubbed&quot; in order to play nicely with the release note tool.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="27899">DERBY-47</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12374294" name="cheese2.sql" size="1871" author="abhala" created="Tue, 29 Jan 2008 21:24:13 +0000"/>
                            <attachment id="12374833" name="d3279_10_3_merge.patch" size="44647" author="army" created="Wed, 6 Feb 2008 00:09:14 +0000"/>
                            <attachment id="12374415" name="d3279_ix2brnode_v1.patch" size="18874" author="army" created="Wed, 30 Jan 2008 21:38:20 +0000"/>
                            <attachment id="12373874" name="d3279_v1.patch" size="29996" author="army" created="Wed, 23 Jan 2008 22:05:12 +0000"/>
                            <attachment id="12379095" name="releaseNote.html" size="7330" author="army" created="Wed, 2 Apr 2008 04:37:47 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 14 Dec 2007 21:38:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23543</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0luf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37357</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>