<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:43:01 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2910/DERBY-2910.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2910] SimpleStringOperatorNode in it&apos;s bindExpression method generates a character string CAST if required but does not set the correct collation.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2910</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Following query should run into error if run in a territory based database &lt;br/&gt;
SELECT TABLENAME FROM SYS.SYSTABLES WHERE UPPER(CURRENT_DATE) = TABLENAME;&lt;/p&gt;

&lt;p&gt;When a CAST node is generated on top of CURRENT_DATE to create a character string type, we do not set the collation of that character string type and hence it always ends up getting the default which is collation derivation IMPLICIT and collation type UCS_BASIC. That does not sound right. &lt;/p&gt;

&lt;p&gt;There might be other places where we generate CAST node to create a character string type. We should check if the collation is set correctly for them.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12373151">DERBY-2910</key>
            <summary>SimpleStringOperatorNode in it&apos;s bindExpression method generates a character string CAST if required but does not set the correct collation.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="mamtas">Mamta A. Satoor</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Jul 2007 10:10:29 +0100</created>
                <updated>Fri, 21 Jan 2011 17:50:33 +0000</updated>
                            <resolved>Tue, 28 Aug 2007 21:26:53 +0100</resolved>
                                    <version>10.3.1.4</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12510797" author="djd" created="Fri, 6 Jul 2007 22:25:46 +0100"  >&lt;p&gt;It&apos;s a little unclear on this what problem is or  the resolution might be. &lt;/p&gt;

&lt;p&gt;Is the bug that collation is setup incorrectly such that this statement fails when it shouldn&apos;t?&lt;br/&gt;
SELECT TABLENAME FROM SYS.SYSTABLES WHERE UPPER(CURRENT_DATE) = TABLENAME&lt;/p&gt;

&lt;p&gt;or is that the statement should fail and it isn&apos;t?&lt;/p&gt;

&lt;p&gt;If it&apos;s the latter, why should that statement fail?&lt;/p&gt;</comment>
                            <comment id="12511170" author="mamtas" created="Mon, 9 Jul 2007 17:39:15 +0100"  >&lt;p&gt;I guess what I would like to discuss is what should be the collation of the resultant character string of UPPER when it&apos;s operand is not of type character string. Derby internally generate a CAST to generate the character string (following our rules for type conversions) for a case like UPPER(CURRENT_DATE) because UPPER works on character string type operand.&lt;/p&gt;

&lt;p&gt;For instance in UPPER(CURRENT_USER), the operand CURRENT_USER is character string type with collation of UCS_BASIC and hence the result of UPPER has collation type of UCS_BASIC. But in UPPER(CURRENT_DATE), CURRENT_DATE is of date type and hence we internally generate a CAST node on date to generate character string type and that internal CAST always generates a character string of type UCS_BASIC collation. My question is is that the right thing to do? Should we have such internal CASTs (from non-character string type to character string types) pick up the collation of the current compilation schema?&lt;/p&gt;</comment>
                            <comment id="12523099" author="kmarsden" created="Mon, 27 Aug 2007 21:46:39 +0100"  >&lt;p&gt;Mamta asked&lt;br/&gt;
&amp;gt;My question is is that the right thing to do? Should we have such internal CASTs (from non-character string type to &amp;gt;character string types) pick up the collation of the current compilation schema?&lt;/p&gt;

&lt;p&gt;I think it should pick up the collation of the current compilation schema for implicit casts as it does for explicit casts.&lt;br/&gt;
Here is an exaple of a statement that I think should execute but currently does not because of the UCS_BASIC default.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; create table a (vc varchar(30));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into a values(CURRENT_DATE);&lt;br/&gt;
1 row inserted/updated/deleted&lt;/p&gt;

&lt;p&gt;ij&amp;gt; select vc from a where vc = UPPER(CURRENT_DATE);&lt;br/&gt;
ERROR 42818: Comparisons between &apos;VARCHAR (TERRITORY_BASED)&apos; and &apos;VARCHAR (UCS_BASIC)&apos; are not supported. Types must be&lt;br/&gt;
comparable. String types must also have matching collation. If collation does not match, a possible solution is to cast&lt;br/&gt;
operands to force them to the default collation (e.g. select tablename from sys.systables where CAST(tablename as VARCHAR(128))&lt;/p&gt;


&lt;p&gt;This implicit cast is ok:&lt;br/&gt;
ij&amp;gt; select vc from a where vc = CURRENT_DATE;&lt;br/&gt;
VC&lt;br/&gt;
------------------------------&lt;br/&gt;
2007-08-27&lt;/p&gt;

</comment>
                            <comment id="12523125" author="kmarsden" created="Tue, 28 Aug 2007 00:10:17 +0100"  >&lt;p&gt;Attached is a patch for this issue. I am currently running tests but am interested to know if I am on the right track since this is my first collation bug fix.  This change changes implicit casts in&lt;br/&gt;
SimpleStringOperatorNode, ConcatenationOperatorNode, and TernaryOperatorNode to use the current schema collation when doing an implicit cast.&lt;/p&gt;

&lt;p&gt;I could not come up with a test case for TernaryOperatorNode as substr will not accept a date argument.  I changed the code anyway.  It may be that it is unreachable.&lt;/p&gt;


</comment>
                            <comment id="12523135" author="djd" created="Tue, 28 Aug 2007 00:38:24 +0100"  >&lt;p&gt;FYI - on the test changes, instead of:&lt;/p&gt;

&lt;p&gt;assertEquals(1,JDBC.assertDrainResults(rs));&lt;/p&gt;

&lt;p&gt;you can use the rowCount version of assertDrainResults, i.e.&lt;/p&gt;

&lt;p&gt;JDBC.assertDrainResults(rs, 1);&lt;/p&gt;</comment>
                            <comment id="12523136" author="djd" created="Tue, 28 Aug 2007 01:05:49 +0100"  >&lt;p&gt;Comments in the code indicating why that collation was picked would be useful for future coders ...&lt;/p&gt;</comment>
                            <comment id="12523167" author="mamtas" created="Tue, 28 Aug 2007 07:35:04 +0100"  >&lt;p&gt;Kathey, thanks for picking up this bug. Your approach seems logical, ie have internal CASTs pick up the current compilation schema&apos;s collation just as we do for explicit CASTs. I wonder if the SQL spec says anything at all for such implicit CASTs and their collation type. But from a user point of view, your approach surely makes sense to me.&lt;/p&gt;</comment>
                            <comment id="12523258" author="kmarsden" created="Tue, 28 Aug 2007 16:25:10 +0100"  >&lt;p&gt;I am having trouble finding any explicit reference to the collation of implicit casts.  The SQL Spec in section 6.1.2 says of explicit casts:&lt;/p&gt;

&lt;p&gt;&quot;10) If TD is a fixed-length, variable-length, or large object character string, then TD shall not specify &amp;lt;collate&lt;br/&gt;
clause&amp;gt;. The declared type collation of the &amp;lt;cast specification&amp;gt; is the character set collation of the character&lt;br/&gt;
set of TD and its collation derivation is implicit.&quot;&lt;/p&gt;


&lt;p&gt;I think that given no explicit rules for implicit casts, that they should follow the same rules as explicit casts. Does that sound reasonable?&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;

</comment>
                            <comment id="12523268" author="mamtas" created="Tue, 28 Aug 2007 16:56:27 +0100"  >&lt;p&gt;Kathey, that sounds reasonable to me.&lt;/p&gt;</comment>
                            <comment id="12523272" author="kmarsden" created="Tue, 28 Aug 2007 17:22:41 +0100"  >&lt;p&gt;Here is an updated patch with comments and test changes suggested by Dan.  I will commit this afternoon if I hear no objections.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12345445">DERBY-1478</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12364694" name="derby-2910_diff.txt" size="7500" author="kmarsden" created="Tue, 28 Aug 2007 17:22:41 +0100"/>
                            <attachment id="12364650" name="derby-2910_diff.txt" size="6974" author="kmarsden" created="Tue, 28 Aug 2007 00:10:16 +0100"/>
                            <attachment id="12364695" name="derby-2910_stat.txt" size="419" author="kmarsden" created="Tue, 28 Aug 2007 17:22:41 +0100"/>
                            <attachment id="12364651" name="derby-2910_stat.txt" size="419" author="kmarsden" created="Tue, 28 Aug 2007 00:10:17 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 6 Jul 2007 21:25:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23317</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0m6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37412</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>