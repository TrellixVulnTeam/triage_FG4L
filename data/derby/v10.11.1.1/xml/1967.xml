<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:45:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1967/DERBY-1967.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1967] UNION (ALL) contraint violation problem</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1967</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The following simple test case gives an error:&lt;/p&gt;

&lt;p&gt;create table a (f1 varchar(10));&lt;br/&gt;
create table b (f2 varchar(10));&lt;br/&gt;
insert into b values(&apos;test&apos;);&lt;br/&gt;
select  nullif(&apos;x&apos;,&apos;x&apos;) as f0, f1 from a&lt;br/&gt;
   union all&lt;br/&gt;
   select  nullif(&apos;x&apos;,&apos;x&apos;) as f0,  nullif(&apos;x&apos;,&apos;x&apos;) as f1 from b;&lt;/p&gt;

&lt;p&gt;ERROR 23502: Column &apos;F0&apos;  cannot accept a NULL value.&lt;br/&gt;
SQLState(23502) vendor code(30000)&lt;/p&gt;

&lt;p&gt;However the following works ok:&lt;br/&gt;
drop table a;&lt;br/&gt;
drop table b;&lt;br/&gt;
create table a (f1 int);&lt;br/&gt;
create table b (f2 int);&lt;br/&gt;
insert into b values(1);&lt;br/&gt;
select  nullif(&apos;x&apos;,&apos;x&apos;) as f0, f1 from a&lt;br/&gt;
   union all&lt;br/&gt;
   select  nullif(&apos;x&apos;,&apos;x&apos;) as f0, nullif(1,1) as f1 from b;&lt;/p&gt;

&lt;p&gt;The test case is a simplification of a query generated by Hibernate&lt;br/&gt;
with the table per class inheritance strategy. Both queries work ok on&lt;br/&gt;
MSSQL and PostgreSQL. On Derby only the second query works, the first&lt;br/&gt;
one giving a contraint violation.&lt;/p&gt;</description>
                <environment>derby v10.1.3.1 and v10.2.1.6 on linux (FC5), jdk  1.5.0_06-b05&lt;br/&gt;
and jdk  1.6.0-rc-b99.</environment>
        <key id="12353388">DERBY-1967</key>
            <summary>UNION (ALL) contraint violation problem</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yipng">Yip Ng</assignee>
                                    <reporter username="rradutiu">Radu Radutiu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Oct 2006 12:02:40 +0100</created>
                <updated>Tue, 30 Jun 2009 16:55:53 +0100</updated>
                            <resolved>Wed, 18 Oct 2006 15:21:41 +0100</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12442940" author="army" created="Tue, 17 Oct 2006 16:31:43 +0100"  >&lt;p&gt;I did some investigating around this and it appears that this query works in 10.1.2.1 but fails in 10.1.3 and later.  I was eventually able to track it down to the changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-7&quot; title=&quot;Bug in NULLIF Function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-7&quot;&gt;&lt;del&gt;DERBY-7&lt;/del&gt;&lt;/a&gt;.   Before those changes were committed the query ran without error; after that commit this query now fails.  For what that&apos;s worth...&lt;/p&gt;</comment>
                            <comment id="12442949" author="yipng" created="Tue, 17 Oct 2006 16:58:00 +0100"  >&lt;p&gt;Thanks Army, I just found the problem and running my patch against derbyall currently.  Some explanation of the problem:&lt;/p&gt;

&lt;p&gt;In the bind phase of ConditionalNode (NULLIF), the CAST node is generated on top of the untyped NULL and it gets the data type descriptor(DTD) of the left operand.  However, the CAST node should have DTD where its value can be nullable.  &lt;/p&gt;

&lt;p&gt;BinaryComparisonOperatorNode bcon = (BinaryComparisonOperatorNode)testCondition;&lt;/p&gt;

&lt;p&gt;QueryTreeNode cast = getNodeFactory().getNode(&lt;br/&gt;
						C_NodeTypes.CAST_NODE,&lt;br/&gt;
						thenElseList.elementAt(0), &lt;br/&gt;
						bcon.getLeftOperand().getTypeServices(),  &amp;lt;=== not nullable!&lt;br/&gt;
						getContextManager());&lt;/p&gt;

&lt;p&gt;The second query:&lt;/p&gt;

&lt;p&gt;select nullif(&apos;x&apos;,&apos;x&apos;) as f0, f1 from a&lt;br/&gt;
   union all&lt;br/&gt;
   select nullif(&apos;x&apos;,&apos;x&apos;) as f0, nullif(1,1) as f1 from b; &lt;/p&gt;

&lt;p&gt;works because it didn&apos;t generate a NormalizedResultSet on top of the PRN on the right hand side of the union since the datatype and length matches.  So it didn&apos;t hit the path where it does additional checking at execution time.&lt;/p&gt;

&lt;p&gt;For the first query:  &lt;/p&gt;

&lt;p&gt;select nullif(&apos;x&apos;,&apos;x&apos;) as f0, f1 from a&lt;br/&gt;
   union all&lt;br/&gt;
   select nullif(&apos;x&apos;,&apos;x&apos;) as f0, nullif(&apos;x&apos;,&apos;x&apos;) as f1 from b; &lt;/p&gt;

&lt;p&gt;The union result column&apos;s length does not match with the right hand side result column, so it generated a NormalizedResultSet on top of the RHS of the union.  When the system retrieves the row from NormalizedResultSet at execution time, the normalize method is called on the DTD and checks if the source is NULL and whether its DTD is not nullable.  In this case, the SQLSTATE 23502 is thrown.&lt;/p&gt;</comment>
                            <comment id="12442966" author="yipng" created="Tue, 17 Oct 2006 17:24:40 +0100"  >&lt;p&gt;Attaching patch derby1967-trunk-diff01.txt for review.  derbyall still running.  Will post result when it completes.&lt;/p&gt;</comment>
                            <comment id="12443044" author="yipng" created="Tue, 17 Oct 2006 20:26:52 +0100"  >&lt;p&gt;derbyall passes.  &lt;/p&gt;

&lt;p&gt;From what Army described in previous comment, this looks like a regression.&lt;/p&gt;</comment>
                            <comment id="12443116" author="army" created="Wed, 18 Oct 2006 00:35:08 +0100"  >&lt;p&gt;Thanks for the quick turn-around on this, Yip.&lt;/p&gt;

&lt;p&gt;Your description of the problem sounds correct to me and the changes themselves match what you say.  They also line up with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-7&quot; title=&quot;Bug in NULLIF Function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-7&quot;&gt;&lt;del&gt;DERBY-7&lt;/del&gt;&lt;/a&gt; as the code in question was added as part of that issue.&lt;/p&gt;

&lt;p&gt;I confirmed that the patch applies cleanly to trunk and that the new test case fails without your changes and passes with it.  The code comments also indicate why the change was necessary, which is great.&lt;/p&gt;

&lt;p&gt;It&apos;s a pretty small change, it makes sense to me, and derbayll passed.  So I vote +1 to commit...&lt;/p&gt;</comment>
                            <comment id="12443138" author="bryanpendleton" created="Wed, 18 Oct 2006 02:45:17 +0100"  >&lt;p&gt;Thanks Yip for the patch and thanks Army for the review. The patch looks good to me, too, and&lt;br/&gt;
my build and tests were successful, so I committed it to the trunk as subversion&lt;br/&gt;
revision 465122.&lt;/p&gt;

&lt;p&gt;Should this patch be merged back to previous branch(es)?&lt;/p&gt;

&lt;p&gt;I cleared patch available since the patch is now committed to the trunk, but didn&apos;t resolve&lt;br/&gt;
the issue in case we want to merge it to a release branch first.&lt;/p&gt;</comment>
                            <comment id="12443195" author="yipng" created="Wed, 18 Oct 2006 08:31:20 +0100"  >&lt;p&gt;Thanks Army and Bryan for reviewing the patch.  I also have backported this to 10.2 line and ran derbyall without any problems.&lt;/p&gt;</comment>
                            <comment id="12443197" author="yipng" created="Wed, 18 Oct 2006 08:32:14 +0100"  >&lt;p&gt;Attaching derby1967-10.2-diff01.txt for 10.2 codeline.  derbyall pass.&lt;/p&gt;</comment>
                            <comment id="12443277" author="bryanpendleton" created="Wed, 18 Oct 2006 15:21:41 +0100"  >&lt;p&gt;Thanks Yip!  I committed the merged fix to the 10.2 branch as revision 465256.&lt;/p&gt;</comment>
                            <comment id="12551431" author="fuzzylogic" created="Thu, 13 Dec 2007 09:05:16 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="27486">DERBY-7</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12343146" name="derby1967-10.2-diff01.txt" size="3575" author="yipng" created="Wed, 18 Oct 2006 08:32:14 +0100"/>
                            <attachment id="12343145" name="derby1967-10.2-stat01.txt" size="327" author="yipng" created="Wed, 18 Oct 2006 08:32:14 +0100"/>
                            <attachment id="12343088" name="derby1967-trunk-diff01.txt" size="3575" author="yipng" created="Tue, 17 Oct 2006 17:24:40 +0100"/>
                            <attachment id="12343087" name="derby1967-trunk-stat01.txt" size="327" author="yipng" created="Tue, 17 Oct 2006 17:24:40 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 17 Oct 2006 15:31:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22819</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0urj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38802</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>