<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:15:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5603/DERBY-5603.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5603] EmbedConnection.clearLOBMapping() incorrectly clears lobFiles causing a ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5603</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;In EmbedConnection.clearLOBMapping()  the code which iterates over lobFiles has a finally block which clears the Set.  This causes a ConcurrentModificationException to be thrown and even using a concurrent data structure would still result in only one LOBFile being correctly closed.&lt;/p&gt;

&lt;p&gt;This will occur anytime the lobFiles Set contains more than 1 LOBFile.&lt;/p&gt;

&lt;p&gt;Stack Trace:&lt;br/&gt;
java.sql.SQLException: Java exception: &apos;: java.util.ConcurrentModificationException&apos;. &lt;br/&gt;
 at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.Util.javaException(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.EmbedConnection.commit(Unknown Source) &lt;br/&gt;
&amp;lt;lines removed&amp;gt;&lt;br/&gt;
Caused by: java.sql.SQLException: Java exception: &apos;: java.util.ConcurrentModificationException&apos;. &lt;br/&gt;
 at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source) &lt;br/&gt;
 ... 16 more &lt;br/&gt;
Caused by: java.util.ConcurrentModificationException &lt;br/&gt;
 at java.util.HashMap$HashIterator.nextEntry(Unknown Source) &lt;br/&gt;
 at java.util.HashMap$KeyIterator.next(Unknown Source) &lt;br/&gt;
 at org.apache.derby.impl.jdbc.EmbedConnection.clearLOBMapping(Unknown Source) &lt;br/&gt;
 ... 10 more&lt;/p&gt;</description>
                <environment>Win 7 64 bit&lt;br/&gt;
JDK 1.6.0_24</environment>
        <key id="12541205">DERBY-5603</key>
            <summary>EmbedConnection.clearLOBMapping() incorrectly clears lobFiles causing a ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="jonsteinich">Jon Steinich</reporter>
                        <labels>
                            <label>derby_triage10_9</label>
                    </labels>
                <created>Sat, 4 Feb 2012 18:26:51 +0000</created>
                <updated>Fri, 15 Nov 2013 08:15:12 +0000</updated>
                            <resolved>Fri, 9 Mar 2012 08:44:45 +0000</resolved>
                                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.3.0</version>
                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                    <version>10.8.2.2</version>
                                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13201225" author="kristwaa" created="Mon, 6 Feb 2012 11:15:48 +0000"  >&lt;p&gt;Attaching patch 1a, which addresses the problem reported.&lt;br/&gt;
The simplest fix is to just move the finally-block to an outer try-block. I changed a little more:&lt;br/&gt;
 o don&apos;t call clear in a finally block (consistent with clearing other maps, not sure if this is the best choice)&lt;br/&gt;
 o try to close all file handles, even if an IOException is encountered (the first exception is saved and thrown later, subsequent exceptions are discarded)&lt;br/&gt;
 o made getLobHMObj private&lt;br/&gt;
 o adjusted comment, I can&apos;t see that the code resets the locator value nor nulifies the map reference.&lt;/p&gt;

&lt;p&gt;I&apos;m having trouble writing a test for this issue. In my attempts the cleanup has been proper, so there is nothing left to do when the code reaches the point where the lobFiles-map is cleared. I don&apos;t see the point in trying to write a test where the VM is pushed close to its limits to force the WeakHashMap-entry to be removed and the finalization to be delayed, if that&apos;s what it takes to trigger this bug.&lt;/p&gt;

&lt;p&gt;Jon, do you have a simple repro for this issue?&lt;/p&gt;

&lt;p&gt;I&apos;m running the full regression suite now.&lt;/p&gt;

&lt;p&gt;Note: The patch is generated with git, use -p1 when applying with patch.&lt;/p&gt;</comment>
                            <comment id="13201263" author="jonsteinich" created="Mon, 6 Feb 2012 13:13:11 +0000"  >&lt;p&gt;I haven&apos;t verified a simple reproduce case, but pre-patch it should have failed whenever there was more than one entry in the lobFIles Set, so I believe creating 2 blobs in a single transaction would cause it.&lt;/p&gt;</comment>
                            <comment id="13201271" author="kristwaa" created="Mon, 6 Feb 2012 13:29:45 +0000"  >&lt;p&gt;The &quot;problem&quot; is that the entries are removed before Derby reaches the code that fails. I can easily provoke the error if I modify the source code.&lt;br/&gt;
Tthere&apos;s a WeakHashMap and a finalizer involved, which makes things a bit tricky - at least on my system.&lt;/p&gt;

&lt;p&gt;Are you seeing the issue during high load, or do you know if memory is scarce in the VM when this happens?&lt;br/&gt;
Are you simply creating new LOBs, or are you both growing and shrinking them in the same transaction? There may be a specific access pattern that triggers the bug.&lt;/p&gt;

&lt;p&gt;I see you mention Blob again. I tried to reproduce with Clob. Although this code is shared between the two, there may a bug in the Blob-implementation that triggers the issue. I&apos;ll try again with a Blob-repro.&lt;/p&gt;</comment>
                            <comment id="13201341" author="jonsteinich" created="Mon, 6 Feb 2012 15:16:07 +0000"  >&lt;p&gt;Ah, I didn&apos;t realize they were generally removed prior to that point.  Now something that seemed irrelevant before is likely the key...&lt;br/&gt;
We have 2 connections open to the database; one for reading and one for writing.  The read connection is probably reading in a blob (creating one) while the commit is clearing on the write connection.&lt;/p&gt;

&lt;p&gt;It wasn&apos;t under high load or low memory when the error occurred.  We always call createBlob() and then write to its output stream.&lt;/p&gt;</comment>
                            <comment id="13201377" author="kristwaa" created="Mon, 6 Feb 2012 16:29:23 +0000"  >&lt;p&gt;Thank you for the feedback.&lt;/p&gt;

&lt;p&gt;It&apos;s hard to say exactly what&apos;s going on without a repro, but:&lt;br/&gt;
  o the maps are private to each connection&lt;br/&gt;
  o the code you pointed at is obviously broken, and will fail if a map with more than one entry is cleared&lt;br/&gt;
  o access to the map is synchronized on the connection object&lt;/p&gt;

&lt;p&gt;Currently I can only think of the situation where the entries haven&apos;t been cleared the &quot;normal&quot; way for whatever reason, and then the clearing fails due to the broken code.&lt;br/&gt;
I&apos;ll wait for more input from the community, and then commit a patch along the lines of the current suggestion/patch if nothing substantial comes up.&lt;/p&gt;

&lt;p&gt;Finally, how often do you see this bug?&lt;br/&gt;
Are you running with isolation level read-uncommitted? (may not be relevant, but there are some issues with LOBs and locking at that level)&lt;br/&gt;
Are you in a situation where you could test a build off the head of the 10.8 branch?&lt;br/&gt;
That is, 10.8.2.2 + all fixes that have been backported since the release. Building the jars with 10.8.2.2 + this fix only is also possible of course. None of these have been tested thoroughly by the community.&lt;/p&gt;</comment>
                            <comment id="13201514" author="jonsteinich" created="Mon, 6 Feb 2012 19:51:46 +0000"  >&lt;p&gt;It isn&apos;t that common. I&apos;d say maybe once every 500 transactions (a bit over an hour).  We are still doing testing at the moment so we haven&apos;t put a consistent load on it.&lt;/p&gt;

&lt;p&gt;The write connection is using TRANSACTION_READ_COMMITTED and the read connection is using TRANSACTION_READ_UNCOMMITTED.&lt;/p&gt;

&lt;p&gt;I should be able to test a build from head.  I haven&apos;t built from source before, but it looked to be fairly straight forward.&lt;/p&gt;</comment>
                            <comment id="13203988" author="jonsteinich" created="Wed, 8 Feb 2012 21:11:55 +0000"  >&lt;p&gt;I have started using the head build + this fix.  I will report back later with any findings.&lt;/p&gt;</comment>
                            <comment id="13204005" author="kristwaa" created="Wed, 8 Feb 2012 21:22:17 +0000"  >&lt;p&gt;Great, thanks for testing the fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13215560" author="kristwaa" created="Fri, 24 Feb 2012 11:51:48 +0000"  >&lt;p&gt;Jon, any updates on the fix?&lt;br/&gt;
I plan to commit it shortly.&lt;/p&gt;</comment>
                            <comment id="13215750" author="jonsteinich" created="Fri, 24 Feb 2012 17:17:28 +0000"  >&lt;p&gt;We haven&apos;t had any issues since switching to that build.&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                            <comment id="13217988" author="kristwaa" created="Tue, 28 Feb 2012 08:02:45 +0000"  >&lt;p&gt;Commited patch 1a to trunk with revision 1294512. I plan to backport this fix.&lt;/p&gt;</comment>
                            <comment id="13217989" author="kristwaa" created="Tue, 28 Feb 2012 08:04:03 +0000"  >&lt;p&gt;Thank you for testing the fix and reporting back, Jon &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13224218" author="kristwaa" created="Wed, 7 Mar 2012 11:52:54 +0000"  >&lt;p&gt;I plan to backport this all the way back. I have run suites.All on 10.3, 10.6, 10.7 and 10.8.&lt;/p&gt;</comment>
                            <comment id="13225939" author="kristwaa" created="Fri, 9 Mar 2012 08:44:46 +0000"  >&lt;p&gt;Backported fix from trunk with the following revisions:&lt;br/&gt;
 o 10.8: 1298735&lt;br/&gt;
 o 10.7: 1298740&lt;br/&gt;
 o 10.6: 1298743&lt;br/&gt;
 o 10.5: 1298750&lt;br/&gt;
 o 10.4: 1298751&lt;br/&gt;
 o 10.3: 1298752&lt;/p&gt;

&lt;p&gt;Resolving issue.&lt;/p&gt;</comment>
                            <comment id="13823421" author="knutanders" created="Fri, 15 Nov 2013 08:15:12 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update: close all resolved issues that haven&amp;#39;t had any activity the last year&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12395101">DERBY-3655</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12513423" name="derby-5603-1a-avoid_concurrentmodification.diff" size="2075" author="kristwaa" created="Mon, 6 Feb 2012 11:15:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 6 Feb 2012 11:15:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226557</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0cqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35883</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>