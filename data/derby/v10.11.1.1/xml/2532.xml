<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:20:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2532/DERBY-2532.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2532] Client does not return SQLException on XAConnection.getXAResource() on a closed connection, Embedded does</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2532</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;In the following scenario from converted test DataSourceTest:&lt;br/&gt;
(non-tested code based on the test code)&lt;br/&gt;
----------------&lt;br/&gt;
        ClientXADataSource dsx = new ClientXADataSource();&lt;br/&gt;
        dsx.setDatabaseName(&quot;tstdb&quot;);&lt;br/&gt;
        XAConnection xac = dsx.getXAConnection();&lt;br/&gt;
        XAConnection xac2 = dsx.getXAConnection();&lt;br/&gt;
        XAResource xar2 = xac2.getXAResource();&lt;br/&gt;
        xac2.close();&lt;/p&gt;

&lt;p&gt;        // allow close on already closed XAConnection&lt;br/&gt;
        xac2.close();&lt;br/&gt;
        try &lt;/p&gt;
{
            xac2.getXAResource();
            // Network Server does not think this is worth an exception.
        }
&lt;p&gt; catch (SQLException sqle) &lt;/p&gt;
{
            System.out.println(&quot;expect a 08003 as with Embedded&quot;);
        }
&lt;p&gt;------------------&lt;br/&gt;
With DerbyNetClient, the xac2.getXAResource() does not return an SQLException.&lt;/p&gt;

&lt;p&gt;This ought to be documented if expected, or fixed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12366794">DERBY-2532</key>
            <summary>Client does not return SQLException on XAConnection.getXAResource() on a closed connection, Embedded does</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swordfish333">Sabari S Kumar</assignee>
                                    <reporter username="myrna">Myrna van Lunteren</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Apr 2007 06:52:57 +0100</created>
                <updated>Thu, 13 Jan 2011 21:48:17 +0000</updated>
                            <resolved>Fri, 4 Jun 2010 10:56:14 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.5.3.1</fixVersion>
                    <fixVersion>10.6.2.1</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>Network Client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12534906" author="kmarsden" created="Mon, 15 Oct 2007 18:30:56 +0100"  >&lt;p&gt;Duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1018&quot; title=&quot;Client xa Statement.getConnection and DatabaseMetadata.getConnection returns underlying NetXAConnection instead of  Logical connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1018&quot;&gt;&lt;del&gt;DERBY-1018&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12534907" author="kmarsden" created="Mon, 15 Oct 2007 18:31:26 +0100"  >&lt;p&gt;accidentally closed wrong issue&lt;/p&gt;</comment>
                            <comment id="12650906" author="swordfish333" created="Wed, 26 Nov 2008 09:45:05 +0000"  >&lt;p&gt;do you think allowing a close on an already closed connection is also an issue?&lt;/p&gt;</comment>
                            <comment id="12650924" author="kristwaa" created="Wed, 26 Nov 2008 10:15:49 +0000"  >&lt;p&gt;Calling close on a connection that has already been closed is not a problem for java.sql.Connection, according to the Java SE 6 API JavaDoc:&lt;br/&gt;
&quot;Calling the method close on a Connection object that is already closed is a no-op.&quot;&lt;/p&gt;

&lt;p&gt;I couldn&apos;t find any other information in the JavaDoc for XAConnection or PooledConnection. I know XAConnection doesn&apos;t implement java.sql.Connection, but maybe it can be used as a guideline?&lt;/p&gt;</comment>
                            <comment id="12650927" author="swordfish333" created="Wed, 26 Nov 2008 10:18:53 +0000"  >&lt;p&gt;as per the sourcecode of ClientXAConnection,&lt;br/&gt;
a close() call will call its super.close().&lt;br/&gt;
ie,the close() of ClientPooledConnection class.&lt;br/&gt;
now in CPC&apos;s close(),we check if the connection is&lt;br/&gt;
already closed in the log and only if the&lt;br/&gt;
connection is not closed already,it attempts to&lt;br/&gt;
close the connection.Else it simply returns.&lt;/p&gt;

&lt;p&gt;So there is no scope of an SQL exception as &lt;br/&gt;
stated in 2532.&lt;/p&gt;

&lt;p&gt;Now if its required that there shud be an SQLEx&lt;br/&gt;
raised,we can simply do that by forcing an SQLEx &lt;br/&gt;
using the &apos;throw&apos; keyword, instead of returning normally.&lt;/p&gt;

&lt;p&gt;The current implementation of close function is&lt;br/&gt;
as follows:&lt;/p&gt;



&lt;p&gt;public synchronized void close() throws SQLException JavaDoc {&lt;br/&gt;
150         try&lt;br/&gt;
151         {&lt;br/&gt;
152             if (logWriter_ != null) &lt;/p&gt;
{
153                 logWriter_.traceEntry(this, &quot;close&quot;);
154             }&lt;br/&gt;
155&lt;br/&gt;
156             if (logicalConnection_ != null) {
157                 logicalConnection_.nullPhysicalConnection();
158                 logicalConnection_ = null;
159             }&lt;br/&gt;
160&lt;br/&gt;
161             if (physicalConnection_ == null) {
162                 return;
163             }&lt;br/&gt;
164&lt;br/&gt;
165             // Even if the physcial connection is marked closed (in the pool),&lt;br/&gt;
166 // this will close its underlying resources.&lt;br/&gt;
167 physicalConnection_.closeResources();&lt;br/&gt;
168         }&lt;br/&gt;
169         finally&lt;br/&gt;
170         {
171             physicalConnection_ = null;
172         }&lt;br/&gt;
173     }&lt;br/&gt;
174&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
So a possible fix is:&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
add a snippet:&lt;br/&gt;
if(logicalConnection_ == null)
{
	throw new SQLException(&quot;Connection already closed&quot;);
	}&lt;br/&gt;
&lt;br/&gt;
as shown:&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
public synchronized void close() throws SQLException JavaDoc {&lt;br/&gt;
150         try&lt;br/&gt;
151         {&lt;br/&gt;
152             if (logWriter_ != null) {
153                 logWriter_.traceEntry(this, &quot;close&quot;);
154             }

&lt;p&gt;		if(logicalConnection_ == null)&lt;/p&gt;
		{
			throw new SQLException(&quot;Connection already closed&quot;);
		}
&lt;p&gt;155&lt;br/&gt;
156             if (logicalConnection_ != null) &lt;/p&gt;
{
157                 logicalConnection_.nullPhysicalConnection();
158                 logicalConnection_ = null;
159             }
&lt;p&gt;160&lt;br/&gt;
161             if (physicalConnection_ == null) &lt;/p&gt;
{
162                 return;
163             }
&lt;p&gt;164&lt;br/&gt;
165             // Even if the physcial connection is marked closed (in the pool),&lt;br/&gt;
166 // this will close its underlying resources.&lt;br/&gt;
167 physicalConnection_.closeResources();&lt;br/&gt;
168         }&lt;br/&gt;
169         finally&lt;br/&gt;
170         &lt;/p&gt;
{
171             physicalConnection_ = null;
172         }
&lt;p&gt;173     }&lt;br/&gt;
174&lt;/p&gt;</comment>
                            <comment id="12650928" author="swordfish333" created="Wed, 26 Nov 2008 10:19:25 +0000"  >&lt;p&gt;And if u are interested i will attach the full source code...&lt;/p&gt;</comment>
                            <comment id="12650932" author="kristwaa" created="Wed, 26 Nov 2008 10:31:17 +0000"  >&lt;p&gt;I&apos;m confused.&lt;/p&gt;

&lt;p&gt;I thought the problem is that XAConnection.getXAResource() doesn&apos;t thrown an exception if the XAConnection is closed?&lt;br/&gt;
As far as I understand, it should be allowed to call XAConnection.close() several times, and doing this should not result in an exception.&lt;/p&gt;

&lt;p&gt;So maybe adding a check to see if the connection has been closed in getXAResource would be a fix? This would match the behavior of the embedded driver.&lt;/p&gt;</comment>
                            <comment id="12650948" author="swordfish333" created="Wed, 26 Nov 2008 10:50:04 +0000"  >&lt;p&gt;Exactly..i just wanted to confirm that this connection closing is not an issue..i was confused with that comment in the problem statement ( // allow close on already closed XAConnection)...&lt;/p&gt;

&lt;p&gt;And now about the &quot;XAConnection.getXAResource() doesn&apos;t thrown an exception if the XAConnection is closed&quot; issue:&lt;/p&gt;

&lt;p&gt;        ClientXADataSource dsx = new ClientXADataSource();&lt;br/&gt;
        XAConnection xac = dsx.getXAConnection();&lt;/p&gt;

&lt;p&gt;Here getXAConnection returns a ClientXAConnection.The getXAResource() method is implemented as:&lt;/p&gt;

&lt;p&gt;public XAResource JavaDoc getXAResource() throws SQLException JavaDoc {&lt;br/&gt;
90         if (logWriter_ != null) &lt;/p&gt;
{
91             logWriter_.traceExit(this, &quot;getXAResource&quot;, xares_);
92         }
&lt;p&gt;93&lt;br/&gt;
94         return xares_;&lt;br/&gt;
95     }&lt;/p&gt;

&lt;p&gt;So will it be fine if we check whether the logical connection is still alive(can be done the very same way as we did in the previous case,ie the repeated connection closing issue),and if not alive we can force an SQLE .&lt;/p&gt;
</comment>
                            <comment id="12659041" author="swordfish333" created="Wed, 24 Dec 2008 04:59:39 +0000"  >&lt;p&gt;Please test this patch&lt;span class=&quot;error&quot;&gt;&amp;#91;ClientXAConnection.diff&amp;#93;&lt;/span&gt;.It seems to resolve the issue.The change has to be made on ClientXAConnection.java&lt;br/&gt;
I have also uploaded a java file to test the issue&lt;/p&gt;</comment>
                            <comment id="12659042" author="swordfish333" created="Wed, 24 Dec 2008 05:00:28 +0000"  >&lt;p&gt;This file&lt;span class=&quot;error&quot;&gt;&amp;#91;Simple.java&amp;#93;&lt;/span&gt; helps to test the issue&lt;/p&gt;</comment>
                            <comment id="12659149" author="myrna" created="Wed, 24 Dec 2008 19:44:52 +0000"  >&lt;p&gt;checking the &apos;patch available&apos; property so committers will get reminders about this patch available for review/commit.&lt;/p&gt;</comment>
                            <comment id="12659574" author="kristwaa" created="Mon, 29 Dec 2008 16:11:28 +0000"  >&lt;p&gt;Thanks for the patch and the repro, Sabari.&lt;/p&gt;

&lt;p&gt;I had a look at the patch and have the following comments;&lt;br/&gt;
 a) There is no SQLState associated with the exception being thrown. It would be wise to use the existing framework to throw an exception with the SQLState specified by SQLState.NO_CURRENT_CONNECTION (08003). This would also match the embedded driver. You should find examples of this in the client code, otherwise just ask.&lt;/p&gt;

&lt;p&gt; b) Can you regenerate the patch using &apos;svn diff&apos;? To make it easier for everyone to apply the patch, this should be done from the root directory of the source tree (i.e. /my/home/trunk).&lt;/p&gt;

&lt;p&gt; c) The community has agreed to use spaces (4) instead of tabs for indentation.&lt;/p&gt;

&lt;p&gt; d) (Tiny nit) If you want to use the full name for physicalConnection, it makes more sense to me to use &apos;super&apos; instead of &apos;this&apos;. What do you think?&lt;/p&gt;

&lt;p&gt;Have you run the regression tests? BTW, they do take some hours to run.&lt;br/&gt;
I think the patch will be ready for commit when the mentioned issues have been addressed.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;</comment>
                            <comment id="12659739" author="swordfish333" created="Tue, 30 Dec 2008 03:24:46 +0000"  >
&lt;p&gt;Sure, I will do that.&lt;br/&gt;
Thanks a lot for the comment.&lt;/p&gt;</comment>
                            <comment id="12660725" author="kristwaa" created="Mon, 5 Jan 2009 11:27:54 +0000"  >&lt;p&gt;Reset the patch available flag, a new patch is expected.&lt;/p&gt;</comment>
                            <comment id="12660786" author="swordfish333" created="Mon, 5 Jan 2009 15:24:46 +0000"  >
&lt;p&gt;Will submit the new patch in a few days.&lt;/p&gt;</comment>
                            <comment id="12874568" author="kristwaa" created="Wed, 2 Jun 2010 13:47:29 +0100"  >&lt;p&gt;Wrapped up Sabari&apos;s work in &apos;derby-2532-1a-getxares_on_closed_conn.diff&apos;.&lt;br/&gt;
suites.All passed.&lt;/p&gt;

&lt;p&gt;Patch ready for review, will commit shortly.&lt;/p&gt;</comment>
                            <comment id="12875547" author="kristwaa" created="Fri, 4 Jun 2010 10:56:14 +0100"  >&lt;p&gt;Committed patch 1a to trunk with revision 951346.&lt;/p&gt;

&lt;p&gt;If I don&apos;t get any pushback, I&apos;ll backport this simple fix.&lt;/p&gt;</comment>
                            <comment id="12878551" author="kristwaa" created="Mon, 14 Jun 2010 13:27:58 +0100"  >&lt;p&gt;Backported to 10.5 with revision 954426 and to 10.6 with revision 954425.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="32841">DERBY-310</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12365918">DERBY-2492</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12396718" name="ClientXAConnection.diff" size="200" author="swordfish333" created="Wed, 24 Dec 2008 04:59:39 +0000"/>
                            <attachment id="12396719" name="Simple.java" size="1513" author="swordfish333" created="Wed, 24 Dec 2008 05:00:28 +0000"/>
                            <attachment id="12446141" name="derby-2532-1a-getxares_on_closed_conn.diff" size="2270" author="kristwaa" created="Wed, 2 Jun 2010 13:47:29 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10363"><![CDATA[Embedded/Client difference]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 15 Oct 2007 17:30:56 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23088</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0ni7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37626</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>