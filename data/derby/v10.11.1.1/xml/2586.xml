<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:38:12 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2586/DERBY-2586.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2586] BlobClob4BlobTest.tesPositionAgressive takes very long time</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2586</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Dan reports that BlobClob4BlobTest.tesPositionAgressive takes very long to run:&lt;br/&gt;
&amp;gt; In a test run (junit-all) of 5,816 fixtures that took 4124 seconds (~68mins) &lt;b&gt;three&lt;/b&gt; fixtures took 53% of the total time.&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; testPositionAgressive                1564.684 seconds&lt;br/&gt;
&amp;gt; testNetworkServerSecurityMechanism    497.280 seconds&lt;br/&gt;
&amp;gt; testTypesInActionStatement            128.928 seconds &lt;/p&gt;

&lt;p&gt;Knut Anders reports that this behavior is fairly new:&lt;br/&gt;
&amp;gt; It seems like it started taking a lot more time at revision 530085. I had&lt;br/&gt;
&amp;gt; run the tests at an earlier revision.&lt;/p&gt;

&lt;p&gt;This was a check-in for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2346&quot; title=&quot;Provide set methods for clob for embedded driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2346&quot;&gt;&lt;del&gt;DERBY-2346&lt;/del&gt;&lt;/a&gt;.  Since Anurag is currently on vacation, I will try to look into this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12367928">DERBY-2586</key>
            <summary>BlobClob4BlobTest.tesPositionAgressive takes very long time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anurag">Anurag Shekhar</assignee>
                                    <reporter username="oysteing">&#216;ystein Gr&#248;vlen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Apr 2007 13:54:52 +0100</created>
                <updated>Tue, 30 Jun 2009 16:55:49 +0100</updated>
                            <resolved>Wed, 2 May 2007 08:00:47 +0100</resolved>
                                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12491280" author="oysteing" created="Tue, 24 Apr 2007 14:08:36 +0100"  >&lt;p&gt;It seems like the new behavior is that characters are read one at a time when seeking for a position.&lt;br/&gt;
I guess that the reason may be that the new streams that are used do not do buffering.  They rely on the caller to use the byte[] version of read if many characters are to be read.&lt;/p&gt;

&lt;p&gt;However, UTF8Reader.fillBuffer reads one byte at a time. My first attempt at fixing this will be to change UTF8Reader to fill its buffer with the byte[] version of  read.  I think that is better than making the new streams do buffering since it seems unecessary to do buffering at several levels.&lt;/p&gt;</comment>
                            <comment id="12491384" author="anurag" created="Tue, 24 Apr 2007 19:10:29 +0100"  >&lt;p&gt;Easiest way of providing buffering over normal stream is to wrap it under BufferedInputStream I am trying out that change to see if it improves significant performance improvement.&lt;/p&gt;

&lt;p&gt;I suspect the problem is with 4k buffer size in LOBStreamControl before it moves the data to file. I think i need to make this larger. While debugging I noticed even very large clob are kept in memory so all the test case of BlobClob4BlobTest.testPositionAgressive used to operate on in memory string. Now moving it onto stream has made is slow (this also explains why &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2450&quot; title=&quot;Clob.Position returning wrong value when operating on Reader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2450&quot;&gt;&lt;del&gt;DERBY-2450&lt;/del&gt;&lt;/a&gt; remained unexposed). &lt;/p&gt;</comment>
                            <comment id="12491403" author="anurag" created="Tue, 24 Apr 2007 19:59:06 +0100"  >&lt;p&gt;Modified UTF8Reader to wrap input stream (received via constructor) in BufferedInputStream&lt;/p&gt;

&lt;p&gt;I haven&apos;t run the complete suite but org.apache.derbyTesting.functionTests.tests.jdbcapi._Suite runs with out any failure (in 1,111.169 sec)&lt;/p&gt;

&lt;p&gt;org.apache.derbyTesting.functionTests.tests.jdbcapi.BlobClob4BlobTest  now takes 151.561 sec.&lt;/p&gt;</comment>
                            <comment id="12491469" author="oysteing" created="Tue, 24 Apr 2007 22:55:58 +0100"  >&lt;p&gt;Thanks Anurag for looking at this while on vacation.  Your patch looks good and I recommend it to be committed so that the runtime of the junit test suite gets back to normal.&lt;/p&gt;

&lt;p&gt;As a side note, I do not understand why UTF8Reader buffers the converted characters. Would it not have been better to buffer the incoming bytes and rather convert characters on demand?&lt;/p&gt;</comment>
                            <comment id="12491480" author="djd" created="Wed, 25 Apr 2007 00:01:04 +0100"  >&lt;p&gt;Patch Committed revision 532127 - Thanks Anurag.&lt;/p&gt;</comment>
                            <comment id="12491506" author="skambha" created="Wed, 25 Apr 2007 03:38:56 +0100"  >&lt;p&gt;fwiw,  I also looked at the change and it looks good.  I ran the BlobClob4BlobTest  on my linux box and before the change - it took 3197s, with this change it took 211s.&lt;/p&gt;

&lt;p&gt;Anurag&amp;gt;&quot;I suspect the problem is with 4k buffer size in LOBStreamControl before it moves the data to file.&quot;&lt;br/&gt;
do you plan to make some changes related to this in some other jira issue , if so can you point me to that jira issue.&lt;/p&gt;

&lt;p&gt;Thanks. &lt;/p&gt;</comment>
                            <comment id="12491692" author="djd" created="Wed, 25 Apr 2007 17:38:09 +0100"  >&lt;p&gt;My test runs dropped from the 68mins to 39mins. Thanks Anurag and &#216;ystein for the quick response.&lt;/p&gt;</comment>
                            <comment id="12492953" author="myrna" created="Tue, 1 May 2007 22:28:53 +0100"  >&lt;p&gt;This looks like it is fixed, can it be closed?&lt;/p&gt;</comment>
                            <comment id="12493021" author="oysteing" created="Wed, 2 May 2007 08:00:47 +0100"  >&lt;p&gt;With the fix applied, the run time is back to normal.&lt;/p&gt;</comment>
                            <comment id="12497371" author="anurag" created="Mon, 21 May 2007 08:34:16 +0100"  >&lt;p&gt;sorry for the late response.&lt;br/&gt;
In Blob/clob before making the changes the data was held in memory &lt;br/&gt;
depending on the free space in the page. So some times even huge &lt;br/&gt;
clob/blob can be used as String. In case of testPositionAggressive all &lt;br/&gt;
the tests were running in this mode and String.indexOf was giving result &lt;br/&gt;
very fast.&lt;/p&gt;

&lt;p&gt;Once I changed the blob/clob to hold only 4k in memory and if it exceeds &lt;br/&gt;
use a file it started taking very long because of the file i/o over &lt;br/&gt;
heads. If we change the max buffer size (higher than 4k) we will be &lt;br/&gt;
getting better performance for clob/blob of length smaller than the new &lt;br/&gt;
value. But there may be risk of getting out of memory exception if we &lt;br/&gt;
keep the value large and there are too many active blob and clob.I think &lt;br/&gt;
we need not make the buffer size too large,  as right now after making &lt;br/&gt;
the stream buffered we are able to get performance comparable to the &lt;br/&gt;
older implementation.&lt;/p&gt;

</comment>
                            <comment id="12498209" author="oysteing" created="Wed, 23 May 2007 12:52:32 +0100"  >&lt;p&gt;&amp;gt; Once I changed the blob/clob to hold only 4k in memory and if it exceeds&lt;br/&gt;
&amp;gt; use a file it started taking very long because of the file i/o over&lt;br/&gt;
&amp;gt; heads. If we change the max buffer size (higher than 4k) we will be&lt;br/&gt;
&amp;gt; getting better performance for clob/blob of length smaller than the new&lt;br/&gt;
&amp;gt; value. But there may be risk of getting out of memory exception if we&lt;br/&gt;
&amp;gt; keep the value large and there are too many active blob and clob.I think&lt;br/&gt;
&amp;gt; we need not make the buffer size too large, as right now after making&lt;br/&gt;
&amp;gt; the stream buffered we are able to get performance comparable to the&lt;br/&gt;
&amp;gt; older implementation.&lt;/p&gt;

&lt;p&gt;I think it is important that temporary storage is only used when the LOB is updated.  Hence, when reading a LOB, one should make sure that the LOB is not written to temporary storage, regardless of size.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12356171" name="derby-2586.diff" size="958" author="anurag" created="Tue, 24 Apr 2007 19:59:06 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 24 Apr 2007 18:10:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23112</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0utj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38811</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>