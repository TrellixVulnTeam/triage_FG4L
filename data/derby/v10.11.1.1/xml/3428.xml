<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:42:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3428/DERBY-3428.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3428] Doing a replication failover should shutdown the database and the connection should no longer be available</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3428</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Oystein says (as part of comments in Derby-3205)&lt;/p&gt;

&lt;p&gt;After executing a failover, I am told that the database is shut down, but I still able to use the connection to access the database:&lt;/p&gt;

&lt;p&gt;ij version 10.4&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass&apos;;&lt;br/&gt;
ij&amp;gt; call syscs_util.syscs_freeze_database();&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass;startMaster=true;slaveHost=localhost&apos;;&lt;br/&gt;
ij(CONNECTION1)&amp;gt; call syscs_util.syscs_unfreeze_database();&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij(CONNECTION1)&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass;failover=true&apos;;&lt;br/&gt;
ERROR XRE20: Failover performed successfully for database &apos;null&apos;, the database has been shutdown.&lt;br/&gt;
ij(CONNECTION1)&amp;gt; select * from t;&lt;br/&gt;
I&lt;br/&gt;
-----------&lt;br/&gt;
1&lt;br/&gt;
2&lt;br/&gt;
3&lt;br/&gt;
4&lt;br/&gt;
5&lt;br/&gt;
6&lt;br/&gt;
7&lt;br/&gt;
8&lt;br/&gt;
9&lt;br/&gt;
10&lt;br/&gt;
10&lt;/p&gt;

&lt;p&gt;11 rows selected&lt;br/&gt;
ij(CONNECTION1)&amp;gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12388899">DERBY-3428</key>
            <summary>Doing a replication failover should shutdown the database and the connection should no longer be available</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="narayanan">V.Narayanan</assignee>
                                    <reporter username="narayanan">V.Narayanan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Feb 2008 06:40:59 +0000</created>
                <updated>Thu, 6 Mar 2008 23:15:00 +0000</updated>
                            <resolved>Thu, 6 Mar 2008 23:14:45 +0000</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12570935" author="narayanan" created="Thu, 21 Feb 2008 04:17:37 +0000"  >&lt;p&gt;Thank you for the suggestions Jorgen on the reply to the email requesting more information on the&lt;br/&gt;
handleException method in EmbedConnection. Following the suggested steps I found that throwing an exception with a Database severity does shutdown the database, but, only if it is not frozen :-/.&lt;/p&gt;

&lt;p&gt;During failover, before flushing the log records from the master to the slave, we freeze the&lt;br/&gt;
database in question to prevent any more transactions from committing, since, these would never&lt;br/&gt;
be conveyed to the slave. Allowing them to proceed would result in inconsistency. We do not&lt;br/&gt;
unfreeze before throwing a database severity exception to cause a shutdown in case of a &lt;br/&gt;
successful failover. This causes a hang when we try to shutdown.&lt;/p&gt;

&lt;p&gt;The obvious workaround was to unfreeze and then throw the exception. But this exposes a window,&lt;br/&gt;
between unfreezing and throwing the exception when I suspect there is the danger of transactions&lt;br/&gt;
commmiting. But the exception that is thrown upon failover should alert the clients that the&lt;br/&gt;
danger of the previous transaction being lost exists.&lt;/p&gt;

&lt;p&gt;I am submitting a patch using the workaround above and hoping that the community can advice me&lt;br/&gt;
more here.&lt;/p&gt;

&lt;p&gt;During the course of developing this patch I observed that we should have a tearDown method on&lt;br/&gt;
the transmitter that the log shipper could call when it does a stopShipment. This would basically&lt;br/&gt;
bring down the socket and the associated streams. I am &lt;b&gt;not&lt;/b&gt; submitting this as part of this patch. &lt;/p&gt;

&lt;p&gt;Also the socket needs a timeout for reads on the InputStream obtained from it but I guess there is a &lt;br/&gt;
JIRA for that already.&lt;/p&gt;</comment>
                            <comment id="12570964" author="narayanan" created="Thu, 21 Feb 2008 07:11:54 +0000"  >&lt;p&gt;The repro says this with the attached patch.&lt;/p&gt;

&lt;p&gt;ij version 10.4&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass&apos;;&lt;br/&gt;
ij&amp;gt; call syscs_util.syscs_freeze_database();&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass;startMaster=true;slaveHost=localhost&apos;; &lt;br/&gt;
ij(CONNECTION1)&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass;failover=true&apos;; &lt;br/&gt;
ERROR XRE20: Failover performed successfully for database &apos;masterDB&apos;, the database has been shutdown.&lt;br/&gt;
ij(CONNECTION1)&amp;gt; select * from t;&lt;br/&gt;
ERROR 08003: No current connection.&lt;br/&gt;
ij(CONNECTION1)&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12571404" author="jorgenlo" created="Fri, 22 Feb 2008 13:37:16 +0000"  >&lt;p&gt;Hi Narayanan,&lt;/p&gt;

&lt;p&gt;The patch basically looks good. A few minor comments:&lt;/p&gt;

&lt;p&gt;1. MasterController: &quot;to shutdown the database&quot; written twice.&lt;br/&gt;
2. Database: @throws tag referst to SQLException while a StandardException is thrown&lt;br/&gt;
3. I am a little concerned that StandardException has to be introduced to the o.a.d.database.Database interface. I read the comments in that file a couple of times, and it seems that this interface is for methods that are external, like system procedures. I think o.a.d.iapi.db.Database would be more fitting since failover can only be called intarnally (hence i(nternal)api). This does not only apply to the failover method, but to all the replication methods.&lt;/p&gt;

&lt;p&gt;It&apos;s OK with me to solve 3. in a follow-up patch since it involves code that was not touched by this patch. You mention that stream.close is not handled in this patch, so I guess a follow-up patch (or patch in another jira) is needed anyway.&lt;/p&gt;</comment>
                            <comment id="12571702" author="narayanan" created="Sat, 23 Feb 2008 04:52:06 +0000"  >&lt;p&gt;&amp;gt;It&apos;s OK with me to solve 3. in a follow-up patch since it involves code&lt;br/&gt;
&amp;gt;that was not touched by this patch. You mention that stream.close &lt;br/&gt;
&amp;gt;is not handled in this patch, so I guess a follow-up patch (or patch&lt;br/&gt;
&amp;gt;in another jira) is needed anyway.&lt;/p&gt;

&lt;p&gt;I am NOT OK with resolving this issue in a follow-up patch attached to this issue either.&lt;br/&gt;
This is a generic issue that has been raised in question to all the methods of the replication&lt;br/&gt;
implementation, why should it be resolved in a issue that is related to a specific problem&lt;br/&gt;
of the failover implementation.&lt;/p&gt;

&lt;p&gt;I believe a separate JIRA needs to be raised indicating the problem and the fix needs&lt;br/&gt;
to go there. If this JIRA is going to act as a stopper to committing this issue I would be&lt;br/&gt;
OK with that.&lt;/p&gt;</comment>
                            <comment id="12571704" author="narayanan" created="Sat, 23 Feb 2008 05:19:32 +0000"  >&lt;p&gt;Narayanan says&lt;/p&gt;

&lt;p&gt;&amp;gt;During the course of developing this patch I observed that we should have a tearDown method on&lt;br/&gt;
&amp;gt;the transmitter that the log shipper could call when it does a stopShipment. This would basically&lt;br/&gt;
&amp;gt;bring down the socket and the associated streams. I am &lt;b&gt;not&lt;/b&gt; submitting this as part of this patch.&lt;/p&gt;

&lt;p&gt;Jorgen says&lt;/p&gt;

&lt;p&gt;&amp;gt;You mention that stream.close is not handled in this patch, so I guess a follow-up patch (or patch in&lt;br/&gt;
&amp;gt;another jira) is needed anyway.&lt;/p&gt;

&lt;p&gt;I submitted a patch for resolving this issue in Derby-3364. Derby-3364 was basically due to&lt;br/&gt;
unsatisfactory cleanup upon replication failover attempts (A failover attempt can basically&lt;br/&gt;
succeed or fail, cleanup needs to be done either way.)&lt;/p&gt;</comment>
                            <comment id="12571881" author="narayanan" created="Sun, 24 Feb 2008 08:58:49 +0000"  >&lt;p&gt;Derby-3455 issue moves replication methods from org.apache.derby.database.Database to org.apache.derby.iapi.db.Database. &lt;/p&gt;

&lt;p&gt;In this issue we need to change the failover method in BasicDatabase to throw a &lt;br/&gt;
StandardException, which is then handled by the handleException method in &lt;br/&gt;
EmbedConnection.&lt;/p&gt;</comment>
                            <comment id="12571887" author="narayanan" created="Sun, 24 Feb 2008 10:06:23 +0000"  >&lt;ul&gt;
	&lt;li&gt;This patch is not for a commit *&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I tried integrating the Derby-3455 and the Derby-3428 patches&lt;br/&gt;
and tried running the repro. It runs fine.&lt;/p&gt;

&lt;p&gt;During the course of the run I observed that if a slave is started&lt;br/&gt;
on a port that is being already used I get the following exception&lt;/p&gt;

&lt;p&gt;ERROR XJ040: Failed to start database &apos;masterDB&apos;, see the next exception for details.&lt;br/&gt;
ERROR XRE04: Could not establish a connection to the peer of the replicated database &apos;masterDB&apos; on address &apos;localhost:8001&apos;.&lt;/p&gt;

&lt;p&gt;I am not sure this is the right message in this situation. I think port in use will be&lt;br/&gt;
a better exception here.I will wait till tomorrow and raise a JIRA.&lt;/p&gt;

&lt;p&gt;I also observed that startmaster on a port other than the port at which&lt;br/&gt;
the slave is listening does not allow subsequent attempts at the right port.&lt;br/&gt;
I guess there is a JIRA for this already.&lt;/p&gt;</comment>
                            <comment id="12572625" author="jorgenlo" created="Tue, 26 Feb 2008 19:44:03 +0000"  >&lt;p&gt;Hi Narayanan,&lt;/p&gt;

&lt;p&gt;I tried the latest patch. In embedded, the patch works as expected:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby:test;startMaster=true;slaveHost=localhost&apos;;&lt;br/&gt;
ij(CONNECTION1)&amp;gt; connect &apos;jdbc:derby:test;failover=true&apos;;&lt;br/&gt;
ERROR XRE20: Failover performed successfully for database &apos;test&apos;, the database has been shutdown.&lt;br/&gt;
ij(CONNECTION1)&amp;gt; show tables;&lt;br/&gt;
ERROR 08003: No current connection.&lt;/p&gt;


&lt;p&gt;but in client/server I get:&lt;/p&gt;

&lt;p&gt;ij&amp;gt; connect &apos;jdbc:derby://localhost:1527/test;startMaster=true;slaveHost=localhost&apos;;&lt;br/&gt;
ij(CONNECTION1)&amp;gt; connect &apos;jdbc:derby://localhost:1527/test;failover=true&apos;;&lt;br/&gt;
ERROR XRE20: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE20, SQLERRMC: Failover performed successfully for database &apos;test&apos;, the database has been shutdown.&lt;br/&gt;
ij(CONNECTION1)&amp;gt; show tables;&lt;br/&gt;
ERROR 08006: A network protocol error was encountered and the connection has been terminated: the requested command encountered an unarchitected and implementation-specific condition for which there was no architected message&lt;/p&gt;

&lt;p&gt;Derby.log does not contain more info than the failover successful stack trace.&lt;/p&gt;

&lt;p&gt;Do we need a new jira for this?&lt;/p&gt;</comment>
                            <comment id="12572788" author="narayanan" created="Wed, 27 Feb 2008 04:55:50 +0000"  >&lt;p&gt;Some more observations&lt;br/&gt;
---------------------------&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Attempts to access the connection after this message&lt;br/&gt;
   results in a appropriate ERROR 08003. &lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The message also correctly says that the connection has been terminated.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The connection terminates as expected but the initial message needs to&lt;br/&gt;
   be investigated.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Conclusions&lt;br/&gt;
-----------&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I do not think we need to investigate this issue at the present stage.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I don&apos;t see any danger in the patch retaining its present behaviour&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;But post-commit a JIRA needs to be raised for this.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12572852" author="jorgenlo" created="Wed, 27 Feb 2008 10:06:13 +0000"  >&lt;p&gt;I tried the following:&lt;/p&gt;

&lt;p&gt;--&lt;del&gt;8&amp;lt;&lt;/del&gt;---&lt;br/&gt;
term1: start NS&lt;br/&gt;
term2: boot database &apos;//localhost/test&apos;&lt;br/&gt;
term3: shutdown &apos;//localhost/test&apos;&lt;br/&gt;
term2: show tables&lt;/p&gt;

&lt;p&gt;ERROR 08006: A network protocol error was encountered and the connection has been terminated: the requested command encountered an unarchitected and implementation-specific condition for which there was no architected message&lt;br/&gt;
--&lt;del&gt;&amp;gt;8&lt;/del&gt;-----&lt;/p&gt;

&lt;p&gt;Hence, this is the message you get when you try to do something with a connection to a database that has been closed. It is not replication-specific. I&apos;ll open a new jira for this.&lt;/p&gt;</comment>
                            <comment id="12573149" author="narayanan" created="Thu, 28 Feb 2008 04:36:20 +0000"  >&lt;p&gt;The attached patch removes the dependency on 3455 &lt;/p&gt;

&lt;p&gt;Pls find the repro run below&lt;/p&gt;

&lt;p&gt;vn@vn-laptop:~/work/workspaces/Derby3428_v1/master$ java org.apache.derby.tools.ij&lt;br/&gt;
ij version 10.4&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass;create=true&apos;;&lt;br/&gt;
ij&amp;gt; call syscs_util.syscs_freeze_database();&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass;startMaster=true;slaveHost=localhost;slavePort=8002&apos;;&lt;br/&gt;
ij(CONNECTION1)&amp;gt; connect &apos;jdbc:derby:masterDB;user=oystein;password=pass;failover=true&apos;; &lt;br/&gt;
ERROR XRE20: Failover performed successfully for database &apos;masterDB&apos;, the database has been shutdown.&lt;br/&gt;
ij(CONNECTION1)&amp;gt; select * from sys.systables;&lt;br/&gt;
ERROR 08003: No current connection.&lt;br/&gt;
ij(CONNECTION1)&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12573819" author="oysteing" created="Fri, 29 Feb 2008 16:34:39 +0000"  >&lt;p&gt;Patch v2 committed as revision 632369.&lt;br/&gt;
I have verified that the reported problem has been fixed.&lt;/p&gt;</comment>
                            <comment id="12573823" author="narayanan" created="Fri, 29 Feb 2008 16:41:48 +0000"  >&lt;p&gt;Thank you for the commit Oystein&lt;/p&gt;</comment>
                            <comment id="12575947" author="narayanan" created="Thu, 6 Mar 2008 23:14:45 +0000"  >&lt;p&gt;All relevant patches have been committed. Resolving issue!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12389382">DERBY-3455</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12387967">DERBY-3394</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12376084" name="Derby3428.diff" size="4142" author="narayanan" created="Thu, 21 Feb 2008 04:17:37 +0000"/>
                            <attachment id="12376085" name="Derby3428.stat" size="280" author="narayanan" created="Thu, 21 Feb 2008 04:17:37 +0000"/>
                            <attachment id="12376344" name="Derby3428_v1.diff" size="8101" author="narayanan" created="Sun, 24 Feb 2008 10:06:23 +0000"/>
                            <attachment id="12376345" name="Derby3428_v1.stat" size="338" author="narayanan" created="Sun, 24 Feb 2008 10:06:23 +0000"/>
                            <attachment id="12376690" name="Derby3428_v2.diff" size="7256" author="narayanan" created="Thu, 28 Feb 2008 04:36:20 +0000"/>
                            <attachment id="12376691" name="Derby3428_v2.stat" size="342" author="narayanan" created="Thu, 28 Feb 2008 04:36:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 22 Feb 2008 13:37:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23639</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0z6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39519</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>