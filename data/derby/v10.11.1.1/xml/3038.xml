<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:15:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3038/DERBY-3038.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3038] SYSCS_IMPORT_TABLE FAILS  with No current connection after shutdown/reconnect to encrypted database : 10.3.1.4 regression </title>
                <link>https://issues.apache.org/jira/browse/DERBY-3038</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I used to import data with CALL SYSCS_UTIL.SYSCS_IMPORT_TABLE procedure with &lt;br/&gt;
success in JAVA and DERBY 10.2.2.0.&lt;/p&gt;

&lt;p&gt;Since 10.3.1.4, the import procedure fails.&lt;/p&gt;

&lt;p&gt;The error message is : &lt;br/&gt;
The exception &apos;java.sql.SQLException: No current connection.&apos; was thrown while &lt;br/&gt;
evaluating an expression.&lt;/p&gt;

&lt;p&gt;I&apos;m sure there is a connection, the same which created the statement : &lt;br/&gt;
***************************************************************************************************&lt;br/&gt;
    protected boolean importTableDataCOUNTRIES() {&lt;br/&gt;
        try &lt;/p&gt;
{
            java.sql.Statement st = 
conn.createStatement(java.sql.ResultSet.TYPE_SCROLL_INSENSITIVE, 
java.sql.ResultSet.CONCUR_UPDATABLE);
            String sql = &quot;&quot;;

            sql = &quot;CALL 
SYSCS_UTIL.SYSCS_IMPORT_TABLE(&apos;NMSET&apos;, &apos;PAYS&apos;, &apos;/tmp/lst_pays.csv&apos;, 
null, null, null, 1)&quot;;
            st.executeUpdate(sql);
            
            return true;
        }
&lt;p&gt; catch (SQLException ex) &lt;/p&gt;
{
            debug(ex.getMessage());
        }
&lt;p&gt;        return false;&lt;br/&gt;
    }&lt;br/&gt;
***************************************************************************************************&lt;br/&gt;
The database is not being accessed by another application. The table does &lt;br/&gt;
exist. The CSV file is comma separated and strings are enclosed by &quot;.&lt;/p&gt;

&lt;p&gt;Thank you for considering this issue.&lt;/p&gt;</description>
                <environment>Linux 2.6.21.1 #2 Tue Jun 26 23:24:34 CEST 2007 i686 AMD Athlon(tm) XP 2800+ GNU/Linux (Mandriva 2007 Spring)&lt;br/&gt;
java version &amp;quot;1.6.0&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0-b105)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.6.0-b105, mixed mode, sharing)</environment>
        <key id="12377317">DERBY-3038</key>
            <summary>SYSCS_IMPORT_TABLE FAILS  with No current connection after shutdown/reconnect to encrypted database : 10.3.1.4 regression </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="nmset">EDAH-TALLY</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 Sep 2007 09:06:04 +0100</created>
                <updated>Tue, 30 Jun 2009 16:55:54 +0100</updated>
                            <resolved>Wed, 12 Sep 2007 13:36:56 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.2.1</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12524326" author="knutanders" created="Sun, 2 Sep 2007 09:39:25 +0100"  >&lt;p&gt;Could you also post the complete stack trace? Thanks.&lt;/p&gt;</comment>
                            <comment id="12524327" author="nmset" created="Sun, 2 Sep 2007 10:01:32 +0100"  >&lt;p&gt;Posted.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12524739" author="kmarsden" created="Tue, 4 Sep 2007 15:22:28 +0100"  >&lt;p&gt;I&apos;d like to try to get this issue in the form of a reproducible case.  Can you please post the schema for the table and a sample data file, so we can reproduce and verify it as a regression?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12524836" author="nmset" created="Tue, 4 Sep 2007 20:30:46 +0100"  >&lt;p&gt;Here they are.&lt;/p&gt;</comment>
                            <comment id="12524862" author="kmarsden" created="Tue, 4 Sep 2007 21:27:01 +0100"  >&lt;p&gt;I combined the table creation and import into a small java program and cannot reproduce with 10.3.1.4.  Can you modify this program to reproduce the error?&lt;/p&gt;</comment>
                            <comment id="12524865" author="kmarsden" created="Tue, 4 Sep 2007 21:30:14 +0100"  >&lt;p&gt;The result I get with Test3038.java with the .csv file in the working directory is:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;C:/kmarsden/repro/derby-3038&amp;#93;&lt;/span&gt; java Test3038&lt;br/&gt;
243 rows imported&lt;/p&gt;

&lt;p&gt;The error message &quot;No current connection.&apos;  no current connection seems to indicate that perhaps some prior action has caused loss of connection.  Perhaps the issue is not the import but whatever came just before it.&lt;/p&gt;

</comment>
                            <comment id="12524879" author="nmset" created="Tue, 4 Sep 2007 22:32:46 +0100"  >&lt;p&gt;You&apos;re right, the import procedure went fine in Test3038 !!!&lt;br/&gt;
I tried with an disk encrypted Db also and Test3038 did it.&lt;/p&gt;

&lt;p&gt;I can&apos;t see what can close the connection between two lines in the SAME &lt;br/&gt;
procedure. and there is no other action going on. If there were no &lt;br/&gt;
connection , the statement wouldn&apos;t have been created.&lt;/p&gt;

&lt;p&gt;I&apos;ll try to workaround this.&lt;/p&gt;

&lt;p&gt;Thank you for your help.&lt;/p&gt;</comment>
                            <comment id="12524896" author="kmarsden" created="Tue, 4 Sep 2007 23:05:54 +0100"  >&lt;p&gt;Please let us know if you make any further progress toward getting a reproducible case for this issue.  Since your code works for you with 10.2, I fear there is still something amiss.  One thing to check is the derby.log to see if there is an exception that explains the loss of connection.&lt;/p&gt;
</comment>
                            <comment id="12525840" author="kmarsden" created="Fri, 7 Sep 2007 22:19:21 +0100"  >&lt;p&gt;Closing this issue Cannot Reproduce.  Please reopen if you get a reproduction for this problem.  &lt;/p&gt;</comment>
                            <comment id="12525919" author="nmset" created="Sat, 8 Sep 2007 15:36:54 +0100"  >&lt;p&gt;The exception can now be reproduced as per the archive Reproduce3038.zip, which represents more closely my app design.&lt;/p&gt;

&lt;p&gt;Thank you for considering.&lt;/p&gt;</comment>
                            <comment id="12525999" author="kmarsden" created="Sun, 9 Sep 2007 16:26:21 +0100"  >&lt;p&gt;I was able to reproduce with Reproduce3038.java on the trunk and verified that the program passed on 10.2.  Thanks for reporting this issue! I was curious why you  shutdown the database every time you close a connection.  Normally one shutdown of the database before the application exits is sufficient.  If I take out the database shutdown on connection close it runs fine.  Also taking out the database shutdown with every connection close will probably improve the performance of the application if connections are closed frequently and will prevent the shutdown of one connection from affecting other connections open on the database.&lt;/p&gt;

&lt;p&gt;One other note: the Class.forName(&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;) for each connection is not necessary before each connect.  You only need one Class.forName(&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;) .newInstance() before connecting the first time.&lt;/p&gt;



</comment>
                            <comment id="12526022" author="nmset" created="Sun, 9 Sep 2007 21:28:49 +0100"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;In fact, in a real application, I do not shutdown the DB at all except when &lt;br/&gt;
ending the application.&lt;/p&gt;

&lt;p&gt;I wrote Reproduce3038 this way because during development, I usually create &lt;br/&gt;
the DB and the table, checks that the objects are here from OpenOffice Base, &lt;br/&gt;
then in a distinct run(which may be on some other day) I would import the &lt;br/&gt;
data. That&apos;s why I closed the DB between each step in Reproduce3038, to mimic &lt;br/&gt;
real time development steps. Any way, in production, a user would import a &lt;br/&gt;
file on existing objects.&lt;/p&gt;

&lt;p&gt;As I commented in Main.java, if the data is imported in a distinct run on &lt;br/&gt;
existing objects, it fails. If in one same run, the DB and the table are &lt;br/&gt;
created AND the data is imported, then import succeeds.&lt;/p&gt;

&lt;p&gt;I also removed the shutdown database instruction and failure persists in the same circumstances.&lt;/p&gt;

&lt;p&gt;Thank you for the &apos;Class.forName&apos; comment.&lt;/p&gt;

&lt;p&gt;One more note, I get the same result with 10.2.&lt;/p&gt;

&lt;p&gt;Thank you.&lt;/p&gt;</comment>
                            <comment id="12526248" author="kmarsden" created="Mon, 10 Sep 2007 21:01:52 +0100"  >&lt;p&gt;This regression was caused by revision 518214, checked in as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12526321" author="dagw" created="Tue, 11 Sep 2007 02:03:48 +0100"  >&lt;p&gt;Uploading a patch for this (a one liner). &lt;/p&gt;

&lt;p&gt;In the repro, Derby thinks it is doing encryption reboot, since&lt;br/&gt;
&quot;dataEncryption=true&quot; is supplied when reconnecting.  This&lt;br/&gt;
leads Derby to do a two-phase boot for authentication purposes before&lt;br/&gt;
doing encryption (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;).  (The attribute is redundant here,&lt;br/&gt;
though, since encryption is done at creation time, but that is not relevant.)&lt;/p&gt;

&lt;p&gt;The issue is that the second boot of the two-phase boot lacked proper&lt;br/&gt;
setup of the EmbedConnectionContext in the second boot, leading to&lt;br/&gt;
failure when establishing a nested connection in&lt;br/&gt;
SystemProcedures.getDefaultConn. This would also impact other&lt;br/&gt;
uses of nested connections, I presume.  &lt;span class=&quot;error&quot;&gt;&amp;#91;Update: It does&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Running regression tests now.&lt;/p&gt;</comment>
                            <comment id="12526457" author="kmarsden" created="Tue, 11 Sep 2007 14:57:18 +0100"  >&lt;p&gt;Thanks Dag for looking at this issue.  Could you add a regression test for it so we don&apos;t reregress?&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12526512" author="dagw" created="Tue, 11 Sep 2007 17:17:49 +0100"  >&lt;p&gt;Sure, Kathey! Uploading a new version &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3038&quot; title=&quot;SYSCS_IMPORT_TABLE FAILS  with No current connection after shutdown/reconnect to encrypted database : 10.3.1.4 regression &quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3038&quot;&gt;&lt;del&gt;DERBY-3038&lt;/del&gt;&lt;/a&gt;-2.*, which replaces&lt;br/&gt;
the previous patch. This includes a a new regression test which&lt;br/&gt;
exposes the error prior to the fix contained in this patch.&lt;/p&gt;</comment>
                            <comment id="12526525" author="kmarsden" created="Tue, 11 Sep 2007 18:06:02 +0100"  >&lt;p&gt;I didn&apos;t try it but on visual inspection the patch looks good.&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12526644" author="dagw" created="Wed, 12 Sep 2007 01:09:56 +0100"  >&lt;p&gt;Thanks for checking it, Kathey! Ran regression tests over again&lt;br/&gt;
and committed as svn 574733. Will backport to 10.3&lt;br/&gt;
before I resolve.&lt;/p&gt;</comment>
                            <comment id="12526767" author="dagw" created="Wed, 12 Sep 2007 13:36:56 +0100"  >&lt;p&gt;Merged patch to 10.3 branch, ran all regression tests&lt;br/&gt;
with no errors. Committed as svn 574917, resolving now.&lt;/p&gt;</comment>
                            <comment id="12526769" author="dagw" created="Wed, 12 Sep 2007 13:39:49 +0100"  >&lt;p&gt;Thanks to EDAH-TALLY for and Kathey for uncovering this and pinning it down!&lt;/p&gt;</comment>
                            <comment id="12526856" author="nmset" created="Wed, 12 Sep 2007 18:12:35 +0100"  >&lt;p&gt;I understand that the fix would be available as from 10.3.1.5 or in SVN. 10.1.3.4 has only been released so I think there&apos;s a delay of a few months before .5 would be available.&lt;/p&gt;

&lt;p&gt;Thanks and congratulations for the community&apos;s reactivity.&lt;/p&gt;</comment>
                            <comment id="12539790" author="nmset" created="Sat, 3 Nov 2007 05:41:59 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;There are no exceptions in derby.log.&lt;/p&gt;

&lt;p&gt;One thing amazing, when connecting to Derby, it constantly starts an instance, &lt;br/&gt;
closes it and starts a new one. Even if one just connects without doing any &lt;br/&gt;
task. Has it something to do with the reported failure ?&lt;/p&gt;

&lt;p&gt;The only way I could import the CSV file was to do everything in one single &lt;br/&gt;
run : create DB, create tables and import data. If these steps are done &lt;br/&gt;
distinctly in different runs, then import fails. This is so in my app, and &lt;br/&gt;
not in Test3038.&lt;/p&gt;

&lt;p&gt;I have checked and cross-checked my code, I don&apos;t have any explanation of &lt;br/&gt;
this.&lt;/p&gt;

&lt;p&gt;I can still workaround, but what if this happens in a distributed app !&lt;/p&gt;

&lt;p&gt;When I said before that I didn&apos;t have any problems with 10.2, it was with &lt;br/&gt;
another app (Goggle/SourceForge search OpenCIM10 if the source code is &lt;br/&gt;
required)(Sorry if don&apos;t have the right to mention any project here). When I &lt;br/&gt;
run the current failed import with 10.2, the failure persists.&lt;/p&gt;

&lt;p&gt;I agree that the first thing to think of is an error in my code. With best &lt;br/&gt;
honesty, I can&apos;t find any.&lt;/p&gt;

&lt;p&gt;I don&apos;t have the means and time to dig in the Derby source code.&lt;/p&gt;

&lt;p&gt;I&apos;ll close this issue in a few days as UNRESOLVED.&lt;/p&gt;

&lt;p&gt;Thank you very much.&lt;/p&gt;
</comment>
                            <comment id="12539792" author="nmset" created="Sat, 3 Nov 2007 05:42:01 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;In fact, in a real application, I do not shutdown the DB at all except when &lt;br/&gt;
ending the application.&lt;/p&gt;

&lt;p&gt;I wrote Reproduce3038 this way because during development, I usually create &lt;br/&gt;
the DB and the table, checks that the objects are here from OpenOffice Base, &lt;br/&gt;
then in a distinct run(which may be on some other day) I would import the &lt;br/&gt;
data. That&apos;s why I closed the DB between each step in Reproduce3038, to mimic &lt;br/&gt;
real time development steps. Any way, in production, a user would import a &lt;br/&gt;
file on existing objects.&lt;/p&gt;

&lt;p&gt;As I commented in Main.java, if the data is imported in a distinct run on &lt;br/&gt;
existing objects, it fails. If in one same run, the DB and the table are &lt;br/&gt;
created AND the data is imported, then import succeeds.&lt;/p&gt;

&lt;p&gt;Thank you for the &apos;Class.forName&apos; comment.&lt;/p&gt;

&lt;p&gt;One more note, I get the same result with 10.2.&lt;/p&gt;

&lt;p&gt;Thank you.&lt;/p&gt;






</comment>
                            <comment id="12539888" author="nmset" created="Sat, 3 Nov 2007 07:08:15 +0000"  >&lt;p&gt;Sorry,&lt;/p&gt;

&lt;p&gt;Don&apos;t know where theis mail comes from. Didn&apos;t post it today.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12361033">DERBY-2264</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12365104" name="ASF.LICENSE.NOT.GRANTED--create_table.txt" size="802" author="nmset" created="Tue, 4 Sep 2007 20:30:47 +0100"/>
                            <attachment id="12368910" name="ASF.LICENSE.NOT.GRANTED--derby.log" size="821" author="nmset" created="Sat, 3 Nov 2007 05:41:59 +0000"/>
                            <attachment id="12365105" name="ASF.LICENSE.NOT.GRANTED--lst_pays.csv" size="5123" author="nmset" created="Tue, 4 Sep 2007 20:30:47 +0100"/>
                            <attachment id="12365575" name="DERBY-3038-2.diff" size="2842" author="dagw" created="Tue, 11 Sep 2007 17:17:49 +0100"/>
                            <attachment id="12365576" name="DERBY-3038-2.stat" size="158" author="dagw" created="Tue, 11 Sep 2007 17:17:49 +0100"/>
                            <attachment id="12365523" name="DERBY-3038.diff" size="518" author="dagw" created="Tue, 11 Sep 2007 02:03:47 +0100"/>
                            <attachment id="12365524" name="DERBY-3038.stat" size="67" author="dagw" created="Tue, 11 Sep 2007 02:03:48 +0100"/>
                            <attachment id="12365400" name="Reproduce3038.zip" size="1847" author="nmset" created="Sat, 8 Sep 2007 15:37:40 +0100"/>
                            <attachment id="12365114" name="Test3038.java" size="1782" author="kmarsden" created="Tue, 4 Sep 2007 21:27:01 +0100"/>
                            <attachment id="12364962" name="stacktrace.txt" size="2805" author="nmset" created="Sun, 2 Sep 2007 09:59:01 +0100"/>
                            <attachment id="12364960" name="sysinfo.txt" size="2289" author="nmset" created="Sun, 2 Sep 2007 09:30:00 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 2 Sep 2007 08:39:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23390</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0uqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38797</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>