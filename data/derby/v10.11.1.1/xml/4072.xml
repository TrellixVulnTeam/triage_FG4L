<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:45:06 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4072/DERBY-4072.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4072] shutdown with incorrect permission on log files shows java.lang.NullPointerException  at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3964).  Should give bettter message.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4072</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I recently saw  case where a user was seeing the following error in the derby.log when trying to shutdown their database.&lt;br/&gt;
New exception raised during cleanup null&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3964)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:1781)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.flush(BaseDataFileFa&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.CachedPage.writePage(CachedPage.java:761&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.CachedPage.clean(CachedPage.java:610)&lt;br/&gt;
        at org.apache.derby.impl.services.cache.ConcurrentCache.cleanAndUnkeepEntry(Conc&lt;br/&gt;
        at org.apache.derby.impl.services.cache.ConcurrentCache.cleanCache(ConcurrentCac&lt;br/&gt;
        at org.apache.derby.impl.services.cache.ConcurrentCache.cleanAll(ConcurrentCache&lt;br/&gt;
        at org.apache.derby.impl.services.cache.ConcurrentCache.shutdown(ConcurrentCache&lt;br/&gt;
        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop(BaseDataFileFac&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.TopService.stop(TopService.java:405)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.TopService.shutdown(TopService.java:34&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.shutdown(BaseMonitor.java:&lt;br/&gt;
        at org.apache.derby.impl.db.DatabaseContextImpl.cleanupOnError(DatabaseContextIm&lt;br/&gt;
        at org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextM&lt;br/&gt;
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.cleanupOnError(Transaction&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedConnection.&amp;lt;init&amp;gt;(EmbedConnection.java:584)&lt;br/&gt;
        at org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:68)&lt;br/&gt;
        at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:238)&lt;br/&gt;
        at org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)&lt;br/&gt;
        at java.sql.DriverManager.getConnection(DriverManager.java:316)&lt;br/&gt;
        at java.sql.DriverManager.getConnection(DriverManager.java:273)&lt;/p&gt;

&lt;p&gt;It ended up that some of the log files did not have proper write permissions because some operation on the database had been performed by root.   They had subsequently deleted their db.lck file so the database did not boot READ ONLY as it would if the root owned db.lck file still existed and the symptom was that they got this error on shutdown.&lt;/p&gt;

&lt;p&gt;Clearly this was user error, but it would have been good if we gave a better error message.  To reproduce on Linux:&lt;br/&gt;
As a user with umask 0022, run the program &lt;br/&gt;
java MakeDB&lt;br/&gt;
this will make the databases wombat and create a table.&lt;br/&gt;
su root&lt;br/&gt;
with umask 0022, run the program to insert data and remove the db.lck file:&lt;br/&gt;
java InsertALot&lt;br/&gt;
rm wombat/db.lck&lt;br/&gt;
go back to the original user&lt;br/&gt;
run the program:&lt;br/&gt;
java ConnectAndShutdown&lt;/p&gt;

&lt;p&gt;The application gets the normal shutdown exception but if you look in derby.log you will see the exception.&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3964)&lt;br/&gt;
        ...&lt;br/&gt;
I will attach the files.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12415621">DERBY-4072</key>
            <summary>shutdown with incorrect permission on log files shows java.lang.NullPointerException  at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3964).  Should give bettter message.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Feb 2009 22:52:29 +0000</created>
                <updated>Mon, 4 May 2009 19:22:43 +0100</updated>
                            <resolved>Fri, 6 Mar 2009 17:34:09 +0000</resolved>
                                    <version>10.1.3.1</version>
                    <version>10.2.2.0</version>
                    <version>10.3.3.0</version>
                    <version>10.4.2.0</version>
                    <version>10.5.1.1</version>
                                    <fixVersion>10.1.3.3</fixVersion>
                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12676805" author="kmarsden" created="Wed, 25 Feb 2009 22:53:39 +0000"  >&lt;p&gt;Attaching files for reproduction. See description for reproduction information.&lt;/p&gt;</comment>
                            <comment id="12677439" author="kmarsden" created="Fri, 27 Feb 2009 18:04:02 +0000"  >&lt;p&gt;So the exception we are not  reporting is:&lt;br/&gt;
java.io.FileNotFoundException: /home/kmarsden/repro/10602/wombat/log/log28.dat (Permission denied)&lt;br/&gt;
	at java.io.RandomAccessFile.&amp;lt;init&amp;gt;(RandomAccessFile.java:218)&lt;br/&gt;
	at org.apache.derby.impl.io.DirRandomAccessFile.&amp;lt;init&amp;gt;(DirRandomAccessFile.java:57)&lt;br/&gt;
	at org.apache.derby.impl.io.DirFile4.getRandomAccessFile(DirFile4.java:250)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.run(LogToFile.java:5689)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(AccessController.java:251)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.privRandomAccessFile(LogToFile.java:5579)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.checkJvmSyncError(LogToFile.java:5522)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.openLogFileInWriteMode(LogToFile.java:5471)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.log.LogToFile.recover(LogToFile.java:1074)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.RawStore.boot(RawStore.java:339)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:2019)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.startModule(BaseMonitor.java:573)&lt;br/&gt;
	at org.apache.derby.iapi.services.monitor.Monitor.bootServiceModule(Monitor.java:427)&lt;br/&gt;
	at org.apache.derby.impl.store.access.RAMAccessManager.boot(RAMAccessManager.java:1019)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:2019)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.startModule(BaseMonitor.java:573)&lt;br/&gt;
	at org.apache.derby.iapi.services.monitor.Monitor.bootServiceModule(Monitor.java:427)&lt;br/&gt;
	at org.apache.derby.impl.db.BasicDatabase.bootStore(BasicDatabase.java:780)&lt;br/&gt;
	at org.apache.derby.impl.db.BasicDatabase.boot(BasicDatabase.java:196)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:2019)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.bootService(BaseMonitor.java:1856)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.startProviderService(BaseMonitor.java:1722)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.findProviderAndStartService(BaseMonitor.java:1602)&lt;br/&gt;
	at org.apache.derby.impl.services.monitor.BaseMonitor.startPersistentService(BaseMonitor.java:1021)&lt;br/&gt;
	at org.apache.derby.iapi.services.monitor.Monitor.startPersistentService(Monitor.java:550)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:2581)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.&amp;lt;init&amp;gt;(EmbedConnection.java:374)&lt;br/&gt;
	at org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:68)&lt;br/&gt;
	at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:238)&lt;br/&gt;
	at org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)&lt;br/&gt;
	at java.sql.DriverManager.getConnection(DriverManager.java:316)&lt;br/&gt;
	at java.sql.DriverManager.getConnection(DriverManager.java:273)&lt;br/&gt;
	at ConnectAndShutdown.main(ConnectAndShutdown.java:9)java.io.FileNotFoundException: &lt;/p&gt;

&lt;p&gt;and the correspoinding code in LogToFile is ~1067&lt;br/&gt;
					if (!ReadOnlyDB)&lt;br/&gt;
					{&lt;br/&gt;
						// if datafactory doesn&apos;t think it is readonly, we can&lt;br/&gt;
						// do some futher test of our own&lt;br/&gt;
						try&lt;/p&gt;
						{
							if(isWriteSynced)
								theLog = openLogFileInWriteMode(logFile);
							else
								theLog = privRandomAccessFile(logFile, &quot;rw&quot;);
						}
&lt;p&gt;						catch (IOException ioe)&lt;/p&gt;
						{
							theLog = null;
						}
&lt;p&gt;                        if (theLog == null || !privCanWrite(logFile))&lt;/p&gt;
						{
							if (theLog != null)
								theLog.close();
							theLog = null;

							ReadOnlyDB = true;
						}
&lt;p&gt;					}&lt;br/&gt;
We catch the exception and silently change the database to ReadOnly.&lt;br/&gt;
Later ~~`1172 we fail to initialize logOut because theLog is null&lt;br/&gt;
		if (theLog != null)&lt;br/&gt;
					logOut = new LogAccessFile(this, theLog, logBufferSize);&lt;/p&gt;

&lt;p&gt;There is another area of similar code ~986&lt;/p&gt;

&lt;p&gt;finally during flush logOut is null so we get the NPE.&lt;/p&gt;

&lt;p&gt;I was thinking we should &lt;br/&gt;
1) Log the IOExceptions.&lt;br/&gt;
2) Log whenever we change a database to ReadOnly.&lt;br/&gt;
3) In flush() if the database is ReadOnly print a warning to the log that we cannot flush the log to a ReadOnlyDB and return.&lt;/p&gt;

&lt;p&gt;but I don&apos;t know if this is overly verbose.  Are there normal instances of the IOException we might want to   silently ignore?&lt;/p&gt;
</comment>
                            <comment id="12677455" author="mikem" created="Fri, 27 Feb 2009 18:40:53 +0000"  >&lt;p&gt;I am not sure best way to do the following, but thought I would at least first comment on what the goal should be.  The whole &quot;readonly&quot; code I think is weak.  It was mostly put in to allow a derby db to be put on and run directly from something like a cd, and to be zero-admin, ie. not force people to somehow createdb a readonly db.  We expect to determine a readonly db when we get the lock on the database lock file which requires writing to the file.  it never really was &lt;br/&gt;
designed for these &quot;half-readonly&quot; cases.&lt;/p&gt;

&lt;p&gt;The problem as this case shows is that catching exceptions and interpreting them may lead to the wrong conclusions.  &lt;/p&gt;

&lt;p&gt;So for instance I would say that we should not boot if we think the db is readonly but we find work to do during restart recovery.  This is effectively what the code does but delays the error to sometime in the future and a NPE.  The possible problems with allowing boot to continue are:&lt;br/&gt;
o if redo recovery has anything to do then it will fill up the cache with dirty pages, and on shutdown&lt;br/&gt;
   or earlier we may try to write those pages out and if the db is read only get errors.&lt;br/&gt;
o if redo recovery has anything to abort then it will have to write extra stuff to the log file and if &lt;br/&gt;
   existing log file is not writable or new logfiles are not writeable then we may get wierd errors&lt;br/&gt;
   during boot.&lt;br/&gt;
Both the above may be existing problems in the code with a readonly cd version, I don&apos;t know.&lt;br/&gt;
I think in both these cases we should fail the boot and make sure somehow errors get printed saying exactly why we thought the db was readonly and that recovery code not run as it found&lt;br/&gt;
necessary writable work to do.&lt;/p&gt;

&lt;p&gt;Unfortunately I think we still want to support finding some log files in a readonly db as a very normal situation would be for a customer to load up a db, then do a clean shutdown and then copy the full db to the cd.  This will still leave some log files, but no work to do.&lt;/p&gt;
</comment>
                            <comment id="12677465" author="mikem" created="Fri, 27 Feb 2009 18:50:49 +0000"  >&lt;p&gt;so, if nothing else is done I think it would be worthwhile to always log why we are booting a db as readonly, especially if it is not the standard place where we expect in getting the db lock.  It would be nicer if this was just part of the boot message rather than an additional message but not sure that fits in the code flow.&lt;/p&gt;

&lt;p&gt;I would be concerned about the last part suggested where we just ignore the flush error.&lt;/p&gt;

&lt;p&gt;It would be good to know if the problems with this wierd installation are also problems with the expected read only medium.  To me the following are bugs:&lt;br/&gt;
o any attempt to add a writable page to the cache for a non-temp table should just get an early&lt;br/&gt;
    error, rather than fail later at flush.&lt;br/&gt;
o any writable log action to a readonly db would be nice to get a reasonable error, rather npe.&lt;br/&gt;
   this just makes support easier.&lt;/p&gt;</comment>
                            <comment id="12677486" author="kmarsden" created="Fri, 27 Feb 2009 19:13:29 +0000"  >
&lt;p&gt;I think for starters I will just log the places and the reason where we change to ReadOnly in LogToFile where we weren&apos;t ReadOnly before and leave the NPE. If we add the ReadOnly change logging that will come first in the log and will give sufficient information as to what the problem is.&lt;/p&gt;

&lt;p&gt;I think this will not affect existing read only users because their database will have been set ReadOnly earlier when we were accessing the lock. I will test a full read only database just to make sure.&lt;/p&gt;</comment>
                            <comment id="12677539" author="kmarsden" created="Fri, 27 Feb 2009 21:27:37 +0000"  >&lt;p&gt;Attached is a proposed path to improve the error logging when an error gaining write access to the log files causes the database status to change to read only (derby-4072_diff.txt)&lt;/p&gt;

&lt;p&gt;Attached also is a sample derby.log showing the new warning.&lt;/p&gt;

&lt;p&gt;I confirmed that for a totally read only database we just get  the READ ONLY boot message and these warnings don&apos;t show up.&lt;/p&gt;

&lt;p&gt;I am running test now.&lt;/p&gt;

&lt;p&gt;Sorry for originally accidentally attaching this to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4077&quot; title=&quot;Intermittent failure java.lang.NullPointerException: name can&amp;#39;t be null with IBM 1.6 and encryptionECB/encryptDatabase test&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4077&quot;&gt;&lt;del&gt;DERBY-4077&lt;/del&gt;&lt;/a&gt;. Can&apos;t seem to keep my Jira issues straight today.&lt;/p&gt;</comment>
                            <comment id="12677616" author="kmarsden" created="Sat, 28 Feb 2009 01:28:33 +0000"  >&lt;p&gt;Tests passed except for known failure &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3993&quot; title=&quot;With IBM 1.6 T_RawStoreFactory fails with There should be 0 observers, but we still have 1 observers on Win 2K&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3993&quot;&gt;&lt;del&gt;DERBY-3993&lt;/del&gt;&lt;/a&gt;.  Please review.&lt;/p&gt;
</comment>
                            <comment id="12678053" author="myrna" created="Mon, 2 Mar 2009 18:37:38 +0000"  >&lt;p&gt;I looked at the code and it seems reasonable to me.&lt;/p&gt;</comment>
                            <comment id="12678056" author="mikem" created="Mon, 2 Mar 2009 18:45:56 +0000"  >&lt;p&gt;I reviewed the proposed changes, they look good to me.  It will be nice to get more info to debug this on remote user sites.&lt;/p&gt;</comment>
                            <comment id="12678062" author="kmarsden" created="Mon, 2 Mar 2009 19:02:17 +0000"  >&lt;p&gt;Thanks Myrna and Mike for looking at the patch.  I submitted to trunk and will backport to 10.4,10.3,10.2, and 10.1 before closing this issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12400972" name="ConnectAndShutdown.java" size="636" author="kmarsden" created="Wed, 25 Feb 2009 22:53:39 +0000"/>
                            <attachment id="12400971" name="InsertALot.java" size="1049" author="kmarsden" created="Wed, 25 Feb 2009 22:53:39 +0000"/>
                            <attachment id="12400970" name="MakeDB.java" size="669" author="kmarsden" created="Wed, 25 Feb 2009 22:53:39 +0000"/>
                            <attachment id="12401138" name="derby-4072_diff.txt" size="3388" author="kmarsden" created="Fri, 27 Feb 2009 21:27:37 +0000"/>
                            <attachment id="12401137" name="sample.derby.log" size="5736" author="kmarsden" created="Fri, 27 Feb 2009 21:27:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 27 Feb 2009 18:40:53 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24008</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0xfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39234</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>