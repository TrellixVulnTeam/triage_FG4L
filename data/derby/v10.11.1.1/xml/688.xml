<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:40 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-688/DERBY-688.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-688] Enhancements to XML functionality to move toward XPath/XQuery support...</title>
                <link>https://issues.apache.org/jira/browse/DERBY-688</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;As of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-334&quot; title=&quot;Add initial SQL support for XML datatype/functions in Derby,  based on SQL/XML specs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-334&quot;&gt;&lt;del&gt;DERBY-334&lt;/del&gt;&lt;/a&gt;, Derby has some very basic support for XML that consists of an XML datatype and three operators (XMLPARSE, XMLSERIALIZE, and XMLEXISTS).  I would like to enhance this existing functionality and, by doing so, help to move Derby incrementally toward a more usable and more complete XPath/XQuery solution (with emphasis on &quot;incrementally&quot;).&lt;/p&gt;

&lt;p&gt;I have attached to this issue a document describing the particular changes that I am looking to make.  At a high level, they consist of:&lt;/p&gt;

&lt;p&gt;1) Making it easier to use the XML operators and datatype from within JDBC (ex. by implicit parsing/serialization of XML values).&lt;/p&gt;

&lt;p&gt;2) Adding a new operator, XMLQUERY, to allow a user to retrieve the results of an XPath expression (instead of just determining whether or not the expression evaluates to an empty sequence, which is what XMLEXISTS does).&lt;/p&gt;

&lt;p&gt;3) Making changes to the existing operators to line them up with the SQL/XML 2005 specification, and also to take steps toward my eventual hope of having support for XQuery (as opposed to just XPath) in Derby.&lt;/p&gt;

&lt;p&gt;If anyone has time and interest enough to look at the document and provide feedback, that&apos;d be great...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12325435">DERBY-688</key>
            <summary>Enhancements to XML functionality to move toward XPath/XQuery support...</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Nov 2005 10:36:27 +0000</created>
                <updated>Thu, 19 Oct 2006 17:23:06 +0100</updated>
                            <resolved>Thu, 7 Sep 2006 22:39:26 +0100</resolved>
                                                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12357097" author="rhillegas" created="Wed, 9 Nov 2005 09:26:50 +0000"  >&lt;p&gt;Good spec. I have some initial comments on the Usability section:&lt;/p&gt;

&lt;p&gt;The spec needs to be enriched by familiarity with JDBC 4.0, which is where the JDBC support for XML appears. To download draft 2 of the spec, see the following webpage: &lt;a href=&quot;http://www.jcp.org/en/jsr/detail?id=221&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.jcp.org/en/jsr/detail?id=221&lt;/a&gt;. For the accompanying javadoc, see &lt;a href=&quot;http://download.java.net/jdk6/doc/api/index.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://download.java.net/jdk6/doc/api/index.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In a nutshell, JDBC 4.0 is the client api which ships with jdk1.6. We are building support for JDBC 4.0 into the 10.2 release of Derby. Key features of the JDBC 4.0 XML support include:&lt;/p&gt;

&lt;p&gt;o the java.sql.Types.SQLXML type code&lt;br/&gt;
o the corresponding vendor-supplied implementation of the java.sql.SQLXML interface&lt;br/&gt;
o stream readers and writers for this datatype: javax.xml.stream.XMLStreamReader and javax.xml.stream.XMLStreamWriter&lt;br/&gt;
o PreparedStatement.setSQLXML() and ResultSet.getSQLXML()&lt;/p&gt;

&lt;p&gt;Given this JDBC support, I think that we can improve on the Usability of the XML datatype. I agree that we should be able to select and insert directly from/into columns of this type. However, the compiler should not implicitly wrap these column references with XMLSERIALIZE and XMLPARSE. Instead, the following implementation makes sense to me:&lt;/p&gt;

&lt;p&gt;The 10.2 server should allow clients to do the following:&lt;/p&gt;

&lt;p&gt;o Create columns of type XML (as is done today)&lt;br/&gt;
o Select these columns without any wrapping&lt;br/&gt;
o Insert into these columns without any wrapping&lt;/p&gt;

&lt;p&gt;The 10.2 Derby client running on jdk1.6 will support JDBC 4.0. In particular, it will provide PreparedStatement and ResultSet support for selecting and inserting java.sql.SQLXML values.&lt;/p&gt;

&lt;p&gt;The other client/server combinations can play out as follows. In the following discussion, I use the term OldClient to mean:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The DB2JCC client&lt;/li&gt;
	&lt;li&gt;The 10.1 client&lt;/li&gt;
	&lt;li&gt;A 10.2 client running on jdk1.3 (JDBC 2), jdk1.4 (JDBC 3), or jdk1.5 (JDBC 3)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;o If any client attempts to directly insert/select an XML column in a 10.1 server, the server will simply raise an exception. That&apos;s what it does today.&lt;/p&gt;

&lt;p&gt;o If an OldClient attempts to directly insert/select an XML column from a 10.2 server, the server will raise an error in the network layer because the XML datavalue cannot be transported to those less capable clients.&lt;/p&gt;

&lt;p&gt;o However, any client can issue ResultSet.getString() and PreparedStatement.setString() on XML columns in a 10.2 server. This will result in the server coercing the XML datavalue to/from a string using XMLPARSE and XMLSERIALIZE.&lt;/p&gt;</comment>
                            <comment id="12421987" author="army" created="Tue, 18 Jul 2006 23:28:25 +0100"  >&lt;p&gt;Attaching a &quot;phase 1&quot; patch, d688_phase1_v1.patch, for this issue that does the following:&lt;/p&gt;

&lt;p&gt;  1. Reorganizes XML-specific code as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Moves all code that relies on JAXP and Xalan classes&lt;br/&gt;
      out of XML.java and into a new class, SqlXmlUtil.java.&lt;br/&gt;
      See comments at the beginning of SqlXmlUtil for an&lt;br/&gt;
      explanation of why this was done.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Creates a new class, SqlXmlExecutor, in the impl.sql.execute&lt;br/&gt;
      package that serves as the class on which all XML operator&lt;br/&gt;
      calls are generated.  Ex. for XMLEXISTS, instead of&lt;br/&gt;
      generating:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         &amp;lt;xmlOperand&amp;gt;.XMLExists(&amp;lt;query-expr&amp;gt;, xmlOperand)&lt;/p&gt;

&lt;p&gt;      we now generate:&lt;/p&gt;

&lt;p&gt;         &amp;lt;SqlXmlExecutor&amp;gt;.XMLSerialize(&amp;lt;query-expr&amp;gt;, xmlOperand)&lt;/p&gt;

&lt;p&gt;      Along with making the code cleaner by allowing all&lt;br/&gt;
      XML operator calls to be defined in the same class,&lt;br/&gt;
      this new class has other benefits, as well--see&lt;br/&gt;
      comments at the beginning of SqlXmlExecutor for&lt;br/&gt;
      more of an explanation.&lt;/p&gt;

&lt;p&gt;  2. Changes implementation of XPath from XSLT processing to&lt;br/&gt;
     the low-level Xalan API, which is faster, more flexible,&lt;br/&gt;
     and better for implementation of the XMLQUERY operator&lt;br/&gt;
     (the XMLQUERY operator will be coming in subsequent&lt;br/&gt;
     phases).  Note that as part of this change I&apos;ve removed&lt;br/&gt;
     the dependency on an explicit declaration of Xerces&lt;br/&gt;
     as the parser; Derby will now pick up the parser from&lt;br/&gt;
     the JVM (i.e. this patch resolves &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-567&quot; title=&quot;Improve Derby XML support to use XML parser found in JVM instead of using a hard-coded parser name (Xerces).&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-567&quot;&gt;&lt;del&gt;DERBY-567&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;  3. Makes a small change to the XMLEXISTS operator to bring&lt;br/&gt;
     it more in line with SQL/XML spec.  More specifically, &lt;br/&gt;
     the query expression that is specified must now be a string&lt;br/&gt;
     literal; parameters and other expressions are not allowed.&lt;/p&gt;

&lt;p&gt;  4. Updates the XML test and master files (lang/xml_general.sql&lt;br/&gt;
     and lang/xmlBinding.java) to bring them in sync with the latest&lt;br/&gt;
     Derby codeline.  Since the XML tests are not (yet) run&lt;br/&gt;
     as part of derbyall, the master files need to be updated&lt;br/&gt;
     to reflect some client/server changes that have gone into&lt;br/&gt;
     the codeline for 10.2 (for example, server pre-fetching&lt;br/&gt;
     behavior).&lt;/p&gt;

&lt;p&gt;Of these changes the only one that is a functional change is #3; the rest are internal changes that should have no external effect on the way the XML operators work.  They are important, though, because they lay the groundwork for subsequent work as described in the HTML document for this issue.&lt;/p&gt;

&lt;p&gt;I did try to break the patch up into the different pieces outlined above, but after two days of trying to undo my work for the sake of elegant, smaller patches, I decided the patch is acceptable as it is (believe it or not, I did actually take a lot out of it already).   I&apos;ll shoot for incremental development and smaller patches as I work on the subquent changes for this issue...&lt;/p&gt;

&lt;p&gt;I ran derbyall with an earlier version of this patch and there were no new failures.  The latest version (which is the d688_phase1_v1.patch that I&apos;m posting here) has some updates, though, so I need to run derbyall again.&lt;/p&gt;

&lt;p&gt;In the meantime, reviews/comments/feedback would be appreciated.&lt;/p&gt;</comment>
                            <comment id="12422163" author="army" created="Wed, 19 Jul 2006 16:05:43 +0100"  >&lt;p&gt;While derbyall runs cleanly against my classes directory with these changes, it turns out that there are errors when I run the tests against the jar files.  I think this problem is related to what Andrew pointed out in the following thread:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/14459&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/14459&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I will look into this more and make the appropriate changes.  Anyone reviewing should still feel free to make comments on the _v1 patch since the code that&apos;s there won&apos;t change--but that patch should not be committed until I resolve the jar issue.  Thanks.&lt;/p&gt;</comment>
                            <comment id="12422438" author="army" created="Thu, 20 Jul 2006 16:17:01 +0100"  >&lt;p&gt;Attaching a second patch, d688_phase1_v2.patch, that makes the appropriate changes to ensure that the new classes (esp. SqlXmlExecutor) are included in the jar builds.  For the thread indicating what changes to make, see:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/24135&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/24135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The patch is the same as phase1_v1 except that it has the following additional diffs:&lt;/p&gt;

&lt;p&gt;Index: tools/jar/extraDBMSclasses.properties&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; tools/jar/extraDBMSclasses.properties	(revision 423655)&lt;br/&gt;
+++ tools/jar/extraDBMSclasses.properties	(working copy)&lt;br/&gt;
@@ -84,4 +84,4 @@&lt;br/&gt;
 derby.module.store.urlf=org.apache.derby.impl.io.URLFile&lt;br/&gt;
 derby.module.store.cpf=org.apache.derby.impl.io.CPFile&lt;/p&gt;

&lt;p&gt;-derby.module.xml.typec=org.apache.derby.impl.sql.compile.XMLTypeCompiler&lt;br/&gt;
+derby.module.xml.sqlxmle=org.apache.derby.impl.sql.execute.SqlXmlExecutor&lt;br/&gt;
Index: tools/jar/extraDBMStypes.properties&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; tools/jar/extraDBMStypes.properties	(revision 423655)&lt;br/&gt;
+++ tools/jar/extraDBMStypes.properties	(working copy)&lt;br/&gt;
@@ -13,3 +13,4 @@&lt;br/&gt;
 derby.module.type.m=org.apache.derby.impl.sql.compile.RefTypeCompiler&lt;br/&gt;
 derby.module.type.n=org.apache.derby.impl.sql.compile.TimeTypeCompiler&lt;br/&gt;
 derby.module.type.o=org.apache.derby.impl.sql.compile.TimestampTypeCompiler&lt;br/&gt;
+derby.module.type.p=org.apache.derby.impl.sql.compile.XMLTypeCompiler&lt;/p&gt;

&lt;p&gt;I ran the XML test suite (xmlSuite) with classes and with jars using IBM 1.4.2 and they passed in both cases.&lt;/p&gt;

&lt;p&gt;Reviews/feedback are appreciated.&lt;/p&gt;</comment>
                            <comment id="12422707" author="army" created="Fri, 21 Jul 2006 17:39:58 +0100"  >&lt;p&gt;Attaching an updated patch synced with the latest codeline.  The only difference between _v2 and _v3 is that the client master file for lang/xml_general.sql has been updated to reflect the latest checkin for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1029&quot; title=&quot;Backout boolean work from the 10.2 branch immediately after the branch is created&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1029&quot;&gt;&lt;del&gt;DERBY-1029&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12423491" author="army" created="Wed, 26 Jul 2006 01:06:36 +0100"  >&lt;p&gt;Attaching a &quot;phase 2&quot; patch that does the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Adds syntax and binding logic for XMLQUERY operator&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Updates syntax for XMLEXISTS to match XMLQUERY and does some refactoring so that the two can share code.  The most user-visible change in this area is the change from BY VALUE to BY REF syntax, which required test updates and corresponding master file updates.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also as part of these changes I&apos;ve rewritten some of the parse logic to make it more easily extendible to a broader XMLQUERY syntax (as defined in SQL/XML&lt;span class=&quot;error&quot;&gt;&amp;#91;2006&amp;#93;&lt;/span&gt;) when/if Derby supports the broader syntax (esp. optional context items and variable bindings) in the future.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;These phase 2 patches do &lt;b&gt;not&lt;/b&gt; actually implement the XMLQUERY operator yet; they just allow parsing and binding of the operator.  Execution-time logic will come in a subsequent patch.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the sake of review I&apos;ve separated the Phase 2 patches into two different parts:&lt;/p&gt;

&lt;p&gt;  d688_phase2_v1_code.patch: The code changes.&lt;br/&gt;
  d688_phase2_v1_tests.patch: The test/master changes.&lt;/p&gt;

&lt;p&gt;When committed, though, &lt;b&gt;both&lt;/b&gt; patches should be committed together in order to avoid test diffs.&lt;/p&gt;

&lt;p&gt;NOTE: The phase 2 changes rely on the Phase 1 changes, which have not yet been committed.  The phase 2 diffs are created w.r.t the phase 1 diffs and thus the phase 2 patches will not apply unless the phase 1 patch has been applied first.&lt;/p&gt;

&lt;p&gt;I&apos;m still looking for someone to review/commit the phase 1patch (d688_phase1_v3.patch).&lt;/p&gt;

&lt;p&gt;I ran derbyall on Windows 2000 with ibm142 after applying the phase 1 patch AND both phase 2 patches; there were no new failures.  I also ran xmlSuite and all XML-specific tests passed.&lt;/p&gt;

&lt;p&gt;If anyone has time to review the phase 1 and/or phase 2 patches, I&apos;d be grateful.&lt;/p&gt;</comment>
                            <comment id="12424590" author="army" created="Mon, 31 Jul 2006 18:56:27 +0100"  >&lt;p&gt;Attaching a new version of the &quot;phase2_tests&quot; patch since the first version doesn&apos;t appear to apply cleanly.  In particular, the DerbyNetClient/xml_general.out master file looks to have conflicts.  The new patch is &quot;d688_phase2_v2_tests.patch&quot;.&lt;/p&gt;</comment>
                            <comment id="12424604" author="army" created="Mon, 31 Jul 2006 19:44:13 +0100"  >&lt;p&gt;Oops, I was wrong about the &quot;phase 2&quot; test patch--that was user error.  I have too many uncommitted patches for this issue on my machine so I mixed them up.  Attaching another version, d688_phase2_v3_tests.patch, that corrects my mix up.  Sorry for the confusion.&lt;/p&gt;</comment>
                            <comment id="12424605" author="army" created="Mon, 31 Jul 2006 19:46:04 +0100"  >&lt;p&gt;Attaching a &quot;phase 3&quot; patch that implements the XMLQUERY operator.  The patch is in two parts:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;d688_phase3_v1_code.patch&lt;/li&gt;
	&lt;li&gt;d688_phase3_v1_tests.patch&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When committed, though, &lt;b&gt;both&lt;/b&gt; patches should be committed together in order to avoid test diffs.&lt;/p&gt;

&lt;p&gt;The SQL parsing/compile time logic was added as part of the phase 2 patch; this patch handles the execution-time logic by making the necessary Xalan calls to evaluate an expression and to retrieve the results.&lt;/p&gt;

&lt;p&gt;The phase 3 patch also adds logic to distinguish between two &quot;types&quot; of XML: XML(DOCUMENT(ANY)) and XML(SEQUENCE), as defined in the SQL/XML&lt;span class=&quot;error&quot;&gt;&amp;#91;2006&amp;#93;&lt;/span&gt; specification.  The reason we need to distinguish between the two is that the result of evaluating an XML query expression against an XML document can be an arbitrary list of items including atomic values, attributes, etc.--i.e. a sequence of items that is &lt;b&gt;not&lt;/b&gt; required to form a valid DOCUMENT node.  For now, though, we only allow valid DOCUMENTs to be inserted into XML columns, so we have to be able to look at the results of the XMLQUERY operator to determine whether or not it&apos;s a valid DOCUMENT, and if not we disallow insertion of that result into an XML column.   We can, however, keep the result transiently and pass it into other operations that accept an XML value (namely, XMLSERIALIZE, which a user can then use to retrieve the results in serialized form).&lt;/p&gt;

&lt;p&gt;NOTE: The phase 3 changes rely on the Phase 1 AND Phase 2 changes, which have not yet been committed.  The phase 3 diffs are created w.r.t the phase 1 and phase 2 diffs and thus the phase 3 patches will not apply unless the other have been applied first.&lt;/p&gt;

&lt;p&gt;I ran derbyall on Red Hat Linux with ibm142 after applying all patches and there were no new failures.  I also ran xmlSuite on Windows 2000 with ibm142 and all tests passed there, as well.&lt;/p&gt;

&lt;p&gt;I&apos;m still looking for someone to review/commit any/all of these patches.  Just to clarify, the following patches are up for review/commit and must be applied/committed in the order shown:&lt;/p&gt;

&lt;p&gt;1. d688_phase1_v3.patch&lt;br/&gt;
2. d688_phase2_v1_code.patch&lt;br/&gt;
3. d688_phase2_v3_tests.patch&lt;br/&gt;
4. d688_phase3_v1_code.patch&lt;br/&gt;
5. d688_phase3_v1_tests.patch&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12425965" author="bryanpendleton" created="Sat, 5 Aug 2006 16:16:58 +0100"  >&lt;p&gt;Note to reviewers (and to Army): the &quot;phase2&quot; and &quot;phase3&quot; patches appear to have been generated with full &lt;br/&gt;
absolute file names rather than with relative file names, which means that the simple technique of &lt;br/&gt;
&quot;cd trunk; patch -p0 &amp;lt; PATCH&quot; fails to locate the files. For review purposes, this is straightforward to work around: &lt;br/&gt;
once you have downloaded each patch, edit the patch and change the file names to strip out the leading portion &lt;br/&gt;
of the absoluate file names, so that, for example:&lt;/p&gt;

&lt;p&gt;&amp;#8212; c:/p4clients/main_codeline/opensource/java/testing/org/apache/derbyTesting/functionTests/tests/lang/xml_general.sql Mon Jul 31 11:37:21 2006&lt;br/&gt;
+++ c:/private/derby_src/java/testing/org/apache/derbyTesting/functionTests/tests/lang/xml_general.sql  Mon Jul 31 09:03:47 2006&lt;/p&gt;

&lt;p&gt;becomes&lt;/p&gt;

&lt;p&gt;&amp;#8212; java/testing/org/apache/derbyTesting/functionTests/tests/lang/xml_general.sql Mon Jul 31 11:37:21 2006&lt;br/&gt;
+++ java/testing/org/apache/derbyTesting/functionTests/tests/lang/xml_general.sql  Mon Jul 31 09:03:47 2006&lt;/p&gt;

&lt;p&gt;In vim, for example, just do:&lt;/p&gt;

&lt;p&gt;:1,$s#c:/p4clients/main_codeline/opensource/##&lt;br/&gt;
:1,$s#c:/private/derby_src/##&lt;/p&gt;

&lt;p&gt;on each of the phase2 and phase3 patches.&lt;/p&gt;

&lt;p&gt;I don&apos;t think there&apos;s any need to repost all the patches just to fix this, but if we end up reposting them later,&lt;br/&gt;
this would be a nice thing to clean up.&lt;/p&gt;
</comment>
                            <comment id="12425979" author="army" created="Sat, 5 Aug 2006 18:00:18 +0100"  >&lt;p&gt;&amp;gt; Note to reviewers (and to Army): the &quot;phase2&quot; and &quot;phase3&quot; patches &lt;br/&gt;
&amp;gt; appear to have been generated with full absolute file names rather than &lt;br/&gt;
&amp;gt; with relative file names,&lt;/p&gt;

&lt;p&gt;Sorry, this was because I had to write some scripts/helper programs to generate the sequential patches with respect to each other (since none of them have been committed yet, a simple &apos;svn diff&apos; wouldn&apos;t work) and the scripts use the full path names.&lt;/p&gt;

&lt;p&gt;&amp;gt; I don&apos;t think there&apos;s any need to repost all the patches just to fix this,&lt;br/&gt;
&amp;gt; but if we end up reposting them later, this would be a nice thing to&lt;br/&gt;
&amp;gt; clean up. &lt;/p&gt;

&lt;p&gt;Thanks Bryan.  For any reposts that are necessary I will indeed make the required changes before posting the patch.&lt;/p&gt;</comment>
                            <comment id="12426616" author="bryanpendleton" created="Tue, 8 Aug 2006 16:52:00 +0100"  >&lt;p&gt;d688_phase1_v3.patch committed to subversion as revision 429698.&lt;/p&gt;</comment>
                            <comment id="12426673" author="bryanpendleton" created="Tue, 8 Aug 2006 19:38:33 +0100"  >&lt;p&gt;Committed d688_phase2_v1_code.patch and d688_phase2_v3_tests.patch&lt;br/&gt;
to subversion as revision 429764.&lt;/p&gt;

&lt;p&gt;I committed both patches as a single revision according to Army&apos;s suggestion above:&lt;/p&gt;

&lt;p&gt;&amp;gt;  When committed, though, &lt;b&gt;both&lt;/b&gt; patches should be committed together in order to avoid test diffs. &lt;/p&gt;</comment>
                            <comment id="12426746" author="bryanpendleton" created="Tue, 8 Aug 2006 23:05:39 +0100"  >&lt;p&gt;Committed d688_phase3_v1_code.patch and d688_phase3_v1_tests.patch&lt;br/&gt;
to subversion as revision 429847. Committed the two patches together per&lt;br/&gt;
Army&apos;s recommendation to commit these patches as a unit to avoid test diffs.&lt;/p&gt;

&lt;p&gt;Clearing the patch available flag because all the pending patches have now been committed.&lt;/p&gt;

&lt;p&gt;Thanks for all the hard work on this, Army!&lt;/p&gt;</comment>
                            <comment id="12426762" author="army" created="Tue, 8 Aug 2006 23:43:20 +0100"  >&lt;p&gt;Thanks a ton for reviewing and committing this set of the patches, Bryan.  I ran the XML tests with the latest codeline and verified that things are as they should be.&lt;/p&gt;

&lt;p&gt;Many thanks to Yip for taking the time to review, as well!&lt;/p&gt;

&lt;p&gt;For ease of  reference, review comments/replies can be found in the following threads:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/25793&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/25793&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/25824&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/25824&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Remaining XML patches are forthcoming, as is documentation for the new functionality.&lt;/p&gt;

&lt;p&gt;Thanks again Bryan and Yip (and David VC for recruiting help!).&lt;/p&gt;</comment>
                            <comment id="12427045" author="army" created="Wed, 9 Aug 2006 23:37:19 +0100"  >&lt;p&gt;Attaching two patches, one for &quot;Phase 4&quot; and one for &quot;Phase 5&quot;.&lt;/p&gt;

&lt;p&gt;Phase 4:&lt;br/&gt;
-------------&lt;/p&gt;

&lt;p&gt;The phase 4 patch, d688_phase4_v1.patch, adds some additional restrictions to the ways in which XML values can be used.  In particular:&lt;/p&gt;

&lt;p&gt;  1. XML types cannot be used in CREATE PROCEDURE or CREATE FUNCTION statements.&lt;/p&gt;

&lt;p&gt;  2. XML types cannot be used in import/export functions.&lt;/p&gt;

&lt;p&gt;  3. XML types cannot be declared as columns in a global temp table.&lt;/p&gt;

&lt;p&gt;I admit that I&apos;m a bit fuzzy as to &lt;b&gt;why&lt;/b&gt; these restrictions need to be in place, but these are the restrictions that apply to the other &quot;long&quot; datatypes in Derby (LOBs, LONG VARCHAR) so I&apos;m enforcing them for XML, as well, to be safe.  It&apos;ll be easier to remove these restrictions in the future than it will be to block them after users have potentially been relying on them.&lt;/p&gt;

&lt;p&gt;One final restriction added by this patch is as follows: if a parameter is used for the operand to an XMLPARSE operation, the parameter must have an explicit cast to a character string type.  I&apos;ve put this restriction in place because, based on my reading of the spec, this is required for SQL/XML&lt;span class=&quot;error&quot;&gt;&amp;#91;2006&amp;#93;&lt;/span&gt; conformance.  Further explanation can be found in comments for the relevant code.&lt;/p&gt;

&lt;p&gt;d688_phase4_v1.patch also adds some simple test cases for each of these restrictions to the lang/xml_general.sql test, with the corresponding master updates.&lt;/p&gt;

&lt;p&gt;And finally, the phase 4 patch includes two new error messages: one for the XMLPARSE restriction, and one for missing XML classes, which is actually for phase 5 but I included it in the phase 4 patch so that the two patches can be applied sequentially (phase 4 then phase 5) without conflict.&lt;/p&gt;

&lt;p&gt;Phase 5:&lt;br/&gt;
-------------&lt;/p&gt;

&lt;p&gt;The phase 5 patch, d688_phase5_v1.patch, adds code to determine whether or not the user&apos;s classpath has the required XML classes and, if not, to throw a user-friendly(-ier) error message whenver the user attempts to use any of the XML operators.&lt;/p&gt;

&lt;p&gt;I inquired as to the best way to do this in the following thread:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://thread.gmane.org/gmane.comp.apache.db.derby.devel/25307/focus=25315&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://thread.gmane.org/gmane.comp.apache.db.derby.devel/25307/focus=25315&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Dan suggested a) looking at the Derby code that loads modules, and b) adding a new utility method to the ClassInspector class.&lt;/p&gt;

&lt;p&gt;I looked at the module-loading code and it ultimately just makes a call to Class.forName() and ignores a module if that call throws a LinkageError or a ClassNotFoundException; see the getImplementations() method in BaseMonitor.java.  So based on that I added a utility method to ClassInspector that does the same thing, except that it just returns &quot;true&quot; if the call to Class.forName() succeeds and &quot;false&quot; otherwise.  I made the new method static because it doesn&apos;t rely on any state specific to ClassInspector and because it would have taken a good deal of searching for me to figure out how to instantiate an instance of ClassInspector correctly from within the XML datatype class.&lt;/p&gt;

&lt;p&gt;I ran quite a few tests manually with this change to verify that things are working, but I haven&apos;t figured out a good way to add corresponding tests to derbyall.  So there are no such tests yet.  If anyone has any suggestions that&apos;d be great; otherwise I&apos;m thinking it&apos;d probably be best to figure that out as a follow-up task to this issue.&lt;/p&gt;

&lt;p&gt;After applying both patches, I ran xmlSuite on Windows 2000 with ibm142 and there were no failures (I still have to look into a diff in xmlBinding.java that occurs on Linux, but that was already reported by Bryan Pendleton and is not related to these specific patches).&lt;/p&gt;

&lt;p&gt;I&apos;ll run derbyall tonight as a sanity check, but in the meantime I&apos;d appreciate any reviews/feedback.&lt;/p&gt;

&lt;p&gt;As mentioned above, the patches are intended to be applied in sequential order, phase 4 followed by phase 5, but that does not mean that they both have to be committed at the same time. So long as phase 4 is committed first, there shouldn&apos;t be any issues.&lt;/p&gt;</comment>
                            <comment id="12427085" author="bryanpendleton" created="Thu, 10 Aug 2006 03:52:47 +0100"  >&lt;p&gt;I looked at the Phase 4 patch. It applies and builds cleanly for me. &lt;br/&gt;
However, when I run lang/xml_general.sql, I get the following diff,&lt;br/&gt;
which appears to come from the tests of SYSCS_EXPORT_QUERY.&lt;/p&gt;

&lt;p&gt;-bash-2.05b$ java org.apache.derbyTesting.functionTests.harness.RunTest lang/xml_general.sql&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Start: xml_general jdk1.4.2_11 2006-08-09 19:51:14 ***&lt;br/&gt;
137 del&lt;br/&gt;
&amp;lt; 0 rows inserted/updated/deleted&lt;br/&gt;
137a137,138&lt;br/&gt;
&amp;gt; ERROR XJ001: Java exception: &apos;java.security.AccessControlException: access denied (java.io.FilePermission xmlexport.del write)&apos;.&lt;br/&gt;
&amp;gt; ERROR XJ001: Java exception: &apos;access denied (java.io.FilePermission xmlexport.del write): java.security.AccessControlException&apos;.&lt;br/&gt;
141 del&lt;br/&gt;
&amp;lt; 0 rows inserted/updated/deleted&lt;br/&gt;
141a142,143&lt;br/&gt;
&amp;gt; ERROR XJ001: Java exception: &apos;java.security.AccessControlException: access denied (java.io.FilePermission xmlexport.del write)&apos;.&lt;br/&gt;
&amp;gt; ERROR XJ001: Java exception: &apos;access denied (java.io.FilePermission xmlexport.del write): java.security.AccessControlException&apos;.&lt;br/&gt;
Test Failed.&lt;/li&gt;
			&lt;li&gt;End:   xml_general jdk1.4.2_11 2006-08-09 19:51:22 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12427102" author="bryanpendleton" created="Thu, 10 Aug 2006 06:07:49 +0100"  >&lt;p&gt;I read through patch 5 also. It looks good to me. It seems like a simple &quot;negative&quot; test of your&lt;br/&gt;
new ClassInspector method would be to try to load a non-existent class and verify that it&lt;br/&gt;
returns false, and a simple &quot;positive&quot; test would be to try to load a well-known Derby class&lt;br/&gt;
and verify that it returns true. Probably could also try a few obvious classes like the ones in&lt;br/&gt;
rt.jar. I think these would tend to be junit-type tests, since they are low-level unit tests, not&lt;br/&gt;
higher level tests like we usually have. But I think they would still be useful tests.&lt;/p&gt;

&lt;p&gt;Patch 5 applied cleanly and built cleanly for me atop patch 4, and I get the same results&lt;br/&gt;
for xml_general.sql and xmlBinding.java after patch 5 as I get after patch 4.&lt;/p&gt;</comment>
                            <comment id="12427249" author="army" created="Thu, 10 Aug 2006 16:08:13 +0100"  >&lt;p&gt;Thanks for continuing to review the patches, Bryan.  The whole security thing with the &quot;xmlexport.del&quot; file did occur to me, but when I ran the tests it passed so I thought it was fine.  But that was because I was running against the classes directory; I keep forgetting to avoid doing that.&lt;/p&gt;

&lt;p&gt;The fact that test results are the same between phase 4 and phase 5 patches is expected since the phase 5 patch hasn&apos;t added any new tests.  I&apos;m thinking I&apos;ll add the appropriate phase 5 tests as another &quot;phase&quot; (along with the other test-related changes that I have to do, like fix xmlBinding diff).&lt;/p&gt;

&lt;p&gt;In the meantime, I&apos;ll look at the export test and see how to get around the security exception.  Thank you for your feedback!&lt;/p&gt;</comment>
                            <comment id="12427266" author="army" created="Thu, 10 Aug 2006 17:46:37 +0100"  >&lt;p&gt;Attaching a second version of the phase 4 patch that corrects the test failure reported by Bryan.  The real reason I had the EXPORT commands in the test to begin with was because I assumed that the IMPORT command would check for the target file before checking the validity of the columns, and so I used a (successful) EXPORT command to create the file. Luckily, that assumption was wrong: the import command first checks the types of the columns and &lt;b&gt;then&lt;/b&gt; looks for the file, and since the new test cases should fail due to the XML type, the actual file specified is never accessed, and thus it doesn&apos;t even have to exist.&lt;/p&gt;

&lt;p&gt;So I&apos;ve updated the phase 4 test case to give bogus file names for the IMPORT commands since they don&apos;t matter.  And I also removed the successful EXPORT command that created the file which was throwing the SecurityException.&lt;/p&gt;

&lt;p&gt;No other changes exist between d688_phase4_v1 and d688_phase4_v2.&lt;/p&gt;

&lt;p&gt;Also, my derbyall run with these XML changes ran with no new errors last night.  I ran on SuSE Linux with ibm142 against insane jars.&lt;/p&gt;

&lt;p&gt;I think the phase 4 and phase 5 patches are now ready for commit (in that order), unless further review comments are made.&lt;/p&gt;

&lt;p&gt;This wraps up the &lt;b&gt;functional&lt;/b&gt; changes for XML that I&apos;d like to get into 10.2  There are still, however, some other tasks to complete:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fix-up new error messages.  All of the error messages for the&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-688&quot; title=&quot;Enhancements to XML functionality to move toward XPath/XQuery support...&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-688&quot;&gt;&lt;del&gt;DERBY-688&lt;/del&gt;&lt;/a&gt; changes thus far have been added as &quot;X0X...&quot;, but&lt;br/&gt;
    it recently occured to me that are those reserved for&lt;br/&gt;
    &quot;execution time&quot; errors.  Many of the new XML messages are&lt;br/&gt;
    actually compile-time errors and thus they probably should&lt;br/&gt;
    have different SQLSTATEs.  So I&apos;ll have to look at that.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Complete the documentation of the new operators (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1655&quot; title=&quot;Document XML functionality for 10.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1655&quot;&gt;&lt;del&gt;DERBY-1655&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fix xmlBinding test to address diff reported by Bryan and&lt;br/&gt;
    which I also see when running on Linux.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add new tests to verify Derby behavior when XML classes are&lt;br/&gt;
    not present.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Enable tests to run as part of derbyall (for those jvms&lt;br/&gt;
    that have the required classes).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add more descriptive comments of the diff between BY REF&lt;br/&gt;
    and BY VALUE, probably in sqlgrammar.jj&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;For completeness, I need to update the spec attached to this issue&lt;br/&gt;
    to reflect the behavior that&apos;s actually been implemented (which is a&lt;br/&gt;
    subset of the functionality described in the spec (ex. no JDBC support).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The first two items are the only ones that are visible to the user, so those need to be completed first.&lt;/p&gt;</comment>
                            <comment id="12427391" author="bryanpendleton" created="Fri, 11 Aug 2006 03:23:08 +0100"  >&lt;p&gt;Committed d688_patch4_v2.patch to subversion as revision 430626&lt;/p&gt;</comment>
                            <comment id="12427415" author="bryanpendleton" created="Fri, 11 Aug 2006 06:04:27 +0100"  >&lt;p&gt;patch d688_patch_v5.txt committed to subversion as revision 430670.&lt;/p&gt;

&lt;p&gt;Clearing patch_available as all pending patches have been committed.&lt;/p&gt;</comment>
                            <comment id="12427430" author="army" created="Fri, 11 Aug 2006 06:37:31 +0100"  >&lt;p&gt;&amp;gt; Committed d688_patch4_v2.patch to subversion as revision 430626&lt;br/&gt;
&amp;gt; patch d688_patch_v5.txt committed to subversion as revision 430670. &lt;/p&gt;

&lt;p&gt;I sync&apos;d, rebuilt and ran some tests (xmlSuite on Windows 2000) and everything looks good.  Thanks a ton for the reviews and for the commits, Bryan.  I appreciate it!&lt;/p&gt;</comment>
                            <comment id="12428837" author="army" created="Fri, 18 Aug 2006 01:05:24 +0100"  >&lt;p&gt;As I was writing up the documentation for the XML operators, I was also double-checking the features to make sure they were all in-line with the SQL/XML&lt;span class=&quot;error&quot;&gt;&amp;#91;2006&amp;#93;&lt;/span&gt; specification.  After some searching around I&apos;ve realized that there are two ways in which the current XML operators are not in line with the spec:&lt;/p&gt;

&lt;p&gt;  1. Currently one can use XMLQUERY to retrieve a single element&lt;br/&gt;
     node from an XML value and then insert that element directly&lt;br/&gt;
     into another Derby XML column.  However, SQL/XML spec says&lt;br/&gt;
     that a column of type XML(DOCUMENT)--which is what Derby&apos;s&lt;br/&gt;
     columns are--can only store actual DOCUMENT nodes; element&lt;br/&gt;
     nodes cannot be implicitly &quot;morphed&quot; into document nodes.&lt;br/&gt;
     Instead, one must use the XMLDOCUMENT() operator, which is&lt;br/&gt;
     not yet implemented in Derby.  So basically, I have to make&lt;br/&gt;
     changes to disallow this kind of insertion.&lt;/p&gt;

&lt;p&gt;  2. When serializing the results of an XMLQUERY operator, the&lt;br/&gt;
     current code doesn&apos;t strictly follow the SQL/XML specification,&lt;br/&gt;
     which dictates that the sequence must be &quot;normalized&quot; before&lt;br/&gt;
     it is serialized.  The rules for normalization can be found&lt;br/&gt;
     here:&lt;/p&gt;

&lt;p&gt;     &lt;a href=&quot;http://www.w3.org/TR/xslt-xquery-serialization/#serdm&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.w3.org/TR/xslt-xquery-serialization/#serdm&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;     So changes have to be made in SqlXmlUtil.serializeToString()&lt;br/&gt;
     to implement these rules.&lt;/p&gt;

&lt;p&gt;Thus, there are still two outstanding code-related tasks for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-688&quot; title=&quot;Enhancements to XML functionality to move toward XPath/XQuery support...&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-688&quot;&gt;&lt;del&gt;DERBY-688&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;  A. Fix SQLSTATEs: I have a patch ready, just haven&apos;t posted it yet.&lt;br/&gt;
     Will try to do it soon.&lt;/p&gt;

&lt;p&gt;  B. Resolve two situations listed above w.r.t to following SQL/XML&lt;br/&gt;
     specifications.&lt;/p&gt;

&lt;p&gt;I think both of these things need to be completed for the 10.2 release in order to 1) make sure Derby is a standards-based database, per the charter, and 2) minimize likelihood for &quot;Existing Application Impact&quot; issues in subsequent releases (caused by having to change behavior or sqlstates).&lt;/p&gt;</comment>
                            <comment id="12429528" author="army" created="Mon, 21 Aug 2006 21:49:56 +0100"  >&lt;p&gt;Attaching a phase 6 patch, d688_phase6_v1.patch, that changes the SQLSTATEs for XML errors to match the SQL/XML specification where possible, and that moves the Derby-specific XML sql states to a compile-time range (42Z70 - 42Z7Z) instead of an execution-time range (X0Xxx).&lt;/p&gt;

&lt;p&gt;I applied the patch, did an ant clobber followed by an ant all, then ran xmlSuite with ibm142 and all tests passed (Windows).&lt;/p&gt;

&lt;p&gt;So this patch, d688_phase6_v1.patch, is ready for commit.&lt;/p&gt;</comment>
                            <comment id="12429578" author="bryanpendleton" created="Tue, 22 Aug 2006 02:20:57 +0100"  >&lt;p&gt;I reviewed d688_phase6_v1.patch and it looks good to me. The build was fine, and derbyall ran cleanly. xml_general.sql and xmlBinding.java ran as expected with Xalan 2.7. Committed this patch to subversion as revision 433450, and cleared the PatchAvailable flag.&lt;/p&gt;</comment>
                            <comment id="12429588" author="bryanpendleton" created="Tue, 22 Aug 2006 03:25:43 +0100"  >&lt;p&gt;Does the phase6 patch need to be applied to the 10.2 branch?&lt;/p&gt;</comment>
                            <comment id="12429739" author="army" created="Tue, 22 Aug 2006 16:14:46 +0100"  >&lt;p&gt;&amp;gt;  Does the phase6 patch need to be applied to the 10.2 branch?&lt;/p&gt;

&lt;p&gt;Yes, that&apos;d be great.  Thanks for bringing this up--I&apos;d forgotten about the need for this...&lt;/p&gt;</comment>
                            <comment id="12429876" author="bryanpendleton" created="Wed, 23 Aug 2006 04:01:52 +0100"  >&lt;p&gt;Merged d688_phase6_v1.patch to 10.2. Merge was clean and build and test runs were uneventful.&lt;br/&gt;
Committed to subversion as revision 433854.&lt;/p&gt;</comment>
                            <comment id="12430243" author="army" created="Thu, 24 Aug 2006 15:08:40 +0100"  >&lt;p&gt;Attaching a &quot;phase 7&quot; patch, d1688_v1.patch, that does the following:&lt;/p&gt;

&lt;p&gt;  1 - Makes changes to catch all &quot;Throwable&quot; errors that might be&lt;br/&gt;
      thrown by Xalan or JAXP, instead of just catching the exceptions&lt;br/&gt;
      declared by the APIs.  This is per the email thread here:&lt;/p&gt;

&lt;p&gt;      &lt;a href=&quot;http://www.nabble.com/xalan-assertion-when-execution-a-xml-query...-tf2149830.html#a5953476&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/xalan-assertion-when-execution-a-xml-query...-tf2149830.html#a5953476&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;      This allows Derby to continue working as normal if/when an&lt;br/&gt;
      unexpected Xalan/JAXP error (such NPE or assertion failure)&lt;br/&gt;
      occurs.  In that case the statement itself will fail and the&lt;br/&gt;
      error will be printed, but Derby will continue to work as&lt;br/&gt;
      expected after the failure.&lt;/p&gt;

&lt;p&gt;  2 - Slight change so that, in the event of an unexpected Xalan&lt;br/&gt;
      compilation error, the name of the operator that encountered&lt;br/&gt;
      the error will be printed as part of Derby&apos;s message.  Currently&lt;br/&gt;
      the operator name isn&apos;t passed in and thus &quot;&lt;/p&gt;
{0}
&lt;p&gt;&quot; shows up&lt;br/&gt;
      in the error message, which is incorrect.&lt;/p&gt;

&lt;p&gt;  3 - Fixes a small bug in XML query execution code that was leading&lt;br/&gt;
      to NPEs in Xalan.  Namely, the current code passes a null argument&lt;br/&gt;
      into Xalan where a non-null is expected (and required) for namespace&lt;br/&gt;
      prefix resolution.&lt;/p&gt;

&lt;p&gt;  4 - Makes the first of two changes required to ensure Derby SQL/XML&lt;br/&gt;
      support agrees with the specification.  The two changes are&lt;br/&gt;
      mentioned in my previous comments; this phase 7 patch addresses&lt;br/&gt;
      the first one (insertion of a non-Document node into a Derby XML&lt;br/&gt;
      column should not be allowed).&lt;/p&gt;

&lt;p&gt;While that may look like a lot of changes, the changes for each of these is quite small and I believe the changes to be easily reviewable and commitable as a single patch.  If anyone disagrees, though, please let me know and I can break the changes up into separate patches.&lt;/p&gt;

&lt;p&gt;Note that most of d688_phase7_v1.patch is made up of test changes for items #3 and #4.&lt;/p&gt;

&lt;p&gt;I applied d688_phase7_v1.patch and ran xmlSuite against sane jars with ibm142 (Windows) and saw no failures.  So this patch is ready for review/commit.&lt;/p&gt;</comment>
                            <comment id="12430271" author="army" created="Thu, 24 Aug 2006 16:31:19 +0100"  >&lt;p&gt;I&apos;ve created two new Jira issue, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1758&quot; title=&quot;Enable xmlSuite to run as part of derbyall in environments that have the required external jars.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1758&quot;&gt;&lt;del&gt;DERBY-1758&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1759&quot; title=&quot;XMLSERIALIZE operator doesn&amp;#39;t follow SQL/XML spec in some areas when serializing a sequence.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1759&quot;&gt;&lt;del&gt;DERBY-1759&lt;/del&gt;&lt;/a&gt;, for the remaining XML work described in the comments for this issue.  I think that those remaining tasks could require a non-trivial effort and thus they merit they own Jira issues.&lt;/p&gt;

&lt;p&gt;Thus, if/when the phase 7 patch is reviewed/committed, I think we can close this issue (finally) and then work on the other issues separately.  Note that the new issues (esp. the testing one, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1758&quot; title=&quot;Enable xmlSuite to run as part of derbyall in environments that have the required external jars.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1758&quot;&gt;&lt;del&gt;DERBY-1758&lt;/del&gt;&lt;/a&gt;) may not make it into the 10.2 release, but should still be addressed sooner rather than later.  If &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1759&quot; title=&quot;XMLSERIALIZE operator doesn&amp;#39;t follow SQL/XML spec in some areas when serializing a sequence.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1759&quot;&gt;&lt;del&gt;DERBY-1759&lt;/del&gt;&lt;/a&gt; does not make it, then at the very least a release note will be needed to call out the fact that Derby 10.2 doesn&apos;t follow SQL/XML serialization rules in some cases.&lt;/p&gt;</comment>
                            <comment id="12430356" author="bryanpendleton" created="Thu, 24 Aug 2006 23:58:45 +0100"  >&lt;p&gt;The phase 7 patch looks good to me. It reads clearly and matche the description. I built the code and ran derbyall without complaint, and the xml test suite ran as expected using Xalan 2.7. Committed the phase 7 patch to the trunk as revision 434556.&lt;/p&gt;

&lt;p&gt;I intend to merge this revision back to the 10.2 branch as well.&lt;/p&gt;</comment>
                            <comment id="12430376" author="bryanpendleton" created="Fri, 25 Aug 2006 01:53:51 +0100"  >&lt;p&gt;Merged the phase7 patch to the 10.2 branch as revision 434583.&lt;/p&gt;

&lt;p&gt;Cleared Patch Available. Is it time to mark this issue resolved?&lt;/p&gt;</comment>
                            <comment id="12430532" author="army" created="Fri, 25 Aug 2006 17:08:36 +0100"  >&lt;p&gt;&amp;gt; Merged the phase7 patch to the 10.2 branch as revision 434583.&lt;/p&gt;

&lt;p&gt;Thank you, Bryan, for continuing to review and commit the patches for this issue the whole way through.  I appreciate your time and thoroughness!&lt;/p&gt;

&lt;p&gt;&amp;gt; Cleared Patch Available. Is it time to mark this issue resolved?&lt;/p&gt;

&lt;p&gt;I think that the work commited for this issue puts Derby XML support into an acceptable state for exposing &quot;first step&quot; XML support  that is in line with the relevant standards (namely, SQL/XML 2006).   The remaining work has been separated out into two new Jira issues that can be addressed independently, one of which (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1759&quot; title=&quot;XMLSERIALIZE operator doesn&amp;#39;t follow SQL/XML spec in some areas when serializing a sequence.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1759&quot;&gt;&lt;del&gt;DERBY-1759&lt;/del&gt;&lt;/a&gt;) is important for standards compliance and thus is next on my list for 10.2 (hopefully).&lt;/p&gt;

&lt;p&gt;While those two remaining tasks do need to be completed, I think that Derby XML support as of the &quot;phase 7&quot; commit is in a form that is &quot;complete enough&quot; for the 10.2 release (with the potential need for a release note if &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1759&quot; title=&quot;XMLSERIALIZE operator doesn&amp;#39;t follow SQL/XML spec in some areas when serializing a sequence.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1759&quot;&gt;&lt;del&gt;DERBY-1759&lt;/del&gt;&lt;/a&gt; isn&apos;t resolved by then).&lt;/p&gt;

&lt;p&gt;Thus I believe this issue can be resolved and closed.  If I don&apos;t hear any objections by the end of today (PST on 08/25), that&apos;s what I&apos;ll do.  Any other bugs/tasks that come up can then be filed as separate Jira issues.&lt;/p&gt;

&lt;p&gt;Thanks again to Bryan for his continued reviews/commits, Yip for his review of the initial patches, and to David Van Couvering for an initial review of the doc patches (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1655&quot; title=&quot;Document XML functionality for 10.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1655&quot;&gt;&lt;del&gt;DERBY-1655&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="12433246" author="army" created="Thu, 7 Sep 2006 22:39:26 +0100"  >&lt;p&gt;All patches committed to trunk and 10.2 for a while now, and follow-up work is being tracked in separate Jira issues, as mentioned in previous comment.  So resolving this issue.&lt;/p&gt;</comment>
                            <comment id="12434513" author="army" created="Wed, 13 Sep 2006 19:53:13 +0100"  >&lt;p&gt;Adding a release note to call out Derby&apos;s dependency on a JAXP parser and Apache Xalan when executing XML operators.  First attempt at the release note is as follows:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-688&quot; title=&quot;Enhancements to XML functionality to move toward XPath/XQuery support...&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-688&quot;&gt;&lt;del&gt;DERBY-688&lt;/del&gt;&lt;/a&gt;: XML datatype and corresponding SQL/XML operators.&lt;/p&gt;

&lt;p&gt;As of the 10.2 release, Derby supports a new XML data type and a set of operators that work with the XML data type. The XML data type and operators are based on a small subset of the SQL/XML specification.&lt;/p&gt;

&lt;p&gt;PROBLEM&lt;/p&gt;

&lt;p&gt;For the XML operators to work properly, Derby requires that a JAXP parser, such as Apache Xerces, and Apache Xalan are included in the Java classpath. If either the parser or Xalan are missing from the classpath, Derby disallows any XML-related operations.&lt;/p&gt;

&lt;p&gt;SYMPTOM&lt;/p&gt;

&lt;p&gt;If a user attempts to use any of the of XML operators but does not have a JAXP parser AND Apache Xalan in his/her classpath, the result will be an error similar to the following:&lt;/p&gt;

&lt;p&gt;  Failed to locate &apos;&amp;lt;JAXP/Xalan&amp;gt;&apos; API or implementation classes.  XML operations are not permitted unless these classes are in your classpath. &lt;/p&gt;

&lt;p&gt;CAUSE&lt;/p&gt;

&lt;p&gt;Derby does all XML parsing by making calls to JAXP methods as defined in the JDK 1.4 API.  Similarly, Derby does all evaluation of XPath queries, manipulation of XPath results, and serialization of XML values by making calls to Xalan-specific methods defined in Xalan classes.  Thus if either JAXP or Xalan is missing from the classpath, the Derby XML operators would not function correctly, leading to ClassNotFound and similar exceptions at various points during code execution.  In order to avoid this, Derby checks to see if JAXP and Xalan are in the classpath, and if either is missing, Derby will not even attempt to perform XML operations.  Instead, it will just issue the error mentioned above.&lt;/p&gt;

&lt;p&gt;SOLUTION&lt;/p&gt;

&lt;p&gt;If you intend to use any of the Derby XML operators, make sure that you have 1) a JAXP parser and 2) Apache Xalan in your classpath.  If you are running in client/server mode, the JAXP and Xalan classes must be in the classpath for the Derby server, since that is where XML-related processing actually occurs.&lt;/p&gt;

&lt;p&gt;Apache Derby version 10.2 has been tested with Xalan 2.7.0.  If you have a version of Xalan that is earlier than 2.7, the Derby XML operators may still work.  However, it is possible that you will experience unexpected errors when using the Derby XML operators.  For example, there is a bug in Xalan versions earlier than 2.5 that can lead to failures with Derby XML operators when Derby is running with a security manager.  The exact error can vary depending on the situation, but generally includes a line similar to the following:&lt;/p&gt;

&lt;p&gt;  org.apache.xml.utils.WrappedRuntimeException: The resource [ &lt;a href=&quot;file:////org/apache/xalan/serialize/XMLEntities.res&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file:////org/apache/xalan/serialize/XMLEntities.res&lt;/a&gt; ] could not load: java.security.AccessControlException: access denied&lt;/p&gt;

&lt;p&gt;This problem has been fixed as of Xalan 2.5, so you can avoid the problem by using a more recent version of Xalan.&lt;/p&gt;

&lt;p&gt;Note: Most Java virtual machines (JVMs) that are version 1.4 or later have a JAXP parser embedded in the JVM. If you are using one of these JVMs, you do not need to add any other JAXP classes to your classpath. Additionally, if the JVM that you are using includes an embedded version of Xalan, you should confirm that the version of Xalan satisfies the minimum requirements for Derby. For example, if your JVM is Sun JDK 1.4.2, you must override the version of Xalan in the JVM with a newer version. Use Java&apos;s Endorsed Standards Override Mechanisms described at &lt;a href=&quot;http://java.sun.com/j2se/1.4.2/docs/guide/standards/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/j2se/1.4.2/docs/guide/standards/&lt;/a&gt; to override the version of Xalan.&lt;/p&gt;

&lt;p&gt;If the JVM that you are using does not have a JAXP parser or a version of Xalan, you can add external versions of those classes in your classpath and Derby will pick up those classes.&lt;/p&gt;

&lt;p&gt;WORKAROUND&lt;/p&gt;

&lt;p&gt;There is no way to use the Derby XML operators without first including a JAXP parser and Apache Xalan in your classpath.  Attempts to do so will result in an error.&lt;/p&gt;</comment>
                            <comment id="12443567" author="army" created="Thu, 19 Oct 2006 17:23:06 +0100"  >&lt;p&gt;All changes committed (thanks again, Bryan!) and no complaints about the release note text, so marking this issue as closed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12348560">DERBY-1759</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12347612">DERBY-1655</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12348557">DERBY-1758</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12337128" name="d688_phase1_v1.patch" size="89060" author="army" created="Tue, 18 Jul 2006 23:28:25 +0100"/>
                            <attachment id="12337129" name="d688_phase1_v1.stat" size="1256" author="army" created="Tue, 18 Jul 2006 23:28:25 +0100"/>
                            <attachment id="12337252" name="d688_phase1_v2.patch" size="90116" author="army" created="Thu, 20 Jul 2006 16:17:00 +0100"/>
                            <attachment id="12337312" name="d688_phase1_v3.patch" size="85606" author="army" created="Fri, 21 Jul 2006 17:39:58 +0100"/>
                            <attachment id="12337516" name="d688_phase2_v1_code.patch" size="29408" author="army" created="Wed, 26 Jul 2006 01:06:36 +0100"/>
                            <attachment id="12337517" name="d688_phase2_v1_tests.patch" size="40705" author="army" created="Wed, 26 Jul 2006 01:06:36 +0100"/>
                            <attachment id="12337822" name="d688_phase2_v2_tests.patch" size="39653" author="army" created="Mon, 31 Jul 2006 18:56:27 +0100"/>
                            <attachment id="12337829" name="d688_phase2_v3_tests.patch" size="40705" author="army" created="Mon, 31 Jul 2006 19:44:13 +0100"/>
                            <attachment id="12337830" name="d688_phase3_v1_code.patch" size="26174" author="army" created="Mon, 31 Jul 2006 19:46:04 +0100"/>
                            <attachment id="12337831" name="d688_phase3_v1_tests.patch" size="101193" author="army" created="Mon, 31 Jul 2006 19:46:04 +0100"/>
                            <attachment id="12338528" name="d688_phase4_v1.patch" size="29815" author="army" created="Wed, 9 Aug 2006 23:37:19 +0100"/>
                            <attachment id="12338608" name="d688_phase4_v2.patch" size="28252" author="army" created="Thu, 10 Aug 2006 17:46:37 +0100"/>
                            <attachment id="12338529" name="d688_phase5_v1.patch" size="9418" author="army" created="Wed, 9 Aug 2006 23:37:19 +0100"/>
                            <attachment id="12339265" name="d688_phase6_v1.patch" size="61901" author="army" created="Mon, 21 Aug 2006 21:49:56 +0100"/>
                            <attachment id="12339492" name="d688_phase7_v1.patch" size="42297" author="army" created="Thu, 24 Aug 2006 15:08:40 +0100"/>
                            <attachment id="12320528" name="derbyXMLSpec.html" size="24946" author="army" created="Tue, 8 Nov 2005 10:36:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 9 Nov 2005 09:26:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>29657</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy1453:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40321</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>