<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:37:01 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3944/DERBY-3944.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3944] CHECK constraints involving user-coded functions may return different results depending on who performs the triggering INSERT/UPDATE</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3944</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When compiling a CHECK constraint on behalf of an INSERT/UPDATE statement, Derby uses the current schema in order to resolve unqualified function names which appear in the CHECK constraint. This means that the CHECK constraint may evaluate true for some users, false for others, and for others the CHECK constraint may raise an error saying that Derby can&apos;t resolve the function reference. This behavior violates the &quot;retrospective determinacy&quot; of CHECK constraints as specified by part 2 of the ANSI/ISO standard:&lt;/p&gt;

&lt;p&gt;1) section 11.9 (&amp;lt;check constraint definition&amp;gt;), syntax rule 5&lt;br/&gt;
2) same section, general rule 1&lt;br/&gt;
3) section 11.6 (&amp;lt;table constraint definition&amp;gt;), general rule 3&lt;br/&gt;
4) section 4.16 (Determinism)&lt;/p&gt;

&lt;p&gt;For more discussion, please see this email thread: &lt;a href=&quot;http://www.nabble.com/Problem-with-CHECK-constraints-td20445344.html#a20445344&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Problem-with-CHECK-constraints-td20445344.html#a20445344&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The following script demonstrates this problem:&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:derbyauth;create=true;user=test_dbo;password=test_dbopassword&apos; as test_dbo_conn;&lt;/p&gt;

&lt;p&gt;drop table t_bp_2;&lt;br/&gt;
drop function f_fp_minus;&lt;/p&gt;

&lt;p&gt;create function f_fp_minus&lt;br/&gt;
(&lt;br/&gt;
    a int&lt;br/&gt;
)&lt;br/&gt;
returns int&lt;br/&gt;
language java&lt;br/&gt;
deterministic&lt;br/&gt;
parameter style java&lt;br/&gt;
no sql&lt;br/&gt;
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.GeneratedColumnsTest.minus&apos;&lt;br/&gt;
;&lt;/p&gt;

&lt;p&gt;create table t_bp_2( a int, constraint t_bp_2_check check ( f_fp_minus( a ) &amp;lt; 0 ) );&lt;/p&gt;

&lt;p&gt;grant insert on t_bp_2 to public;&lt;/p&gt;

&lt;p&gt;insert into test_dbo.t_bp_2( a ) values ( 100 );&lt;/p&gt;

&lt;p&gt;connect &apos;jdbc:derby:derbyauth;create=true;user=janet;password=janetpassword&apos; as janet_conn;&lt;/p&gt;

&lt;p&gt;insert into test_dbo.t_bp_2( a ) values ( 100 );&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12408289">DERBY-3944</key>
            <summary>CHECK constraints involving user-coded functions may return different results depending on who performs the triggering INSERT/UPDATE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Nov 2008 20:38:47 +0000</created>
                <updated>Wed, 2 Oct 2013 10:28:16 +0100</updated>
                            <resolved>Tue, 8 Feb 2011 20:49:22 +0000</resolved>
                                    <version>10.5.1.1</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.4</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12646661" author="rhillegas" created="Tue, 11 Nov 2008 20:45:45 +0000"  >&lt;p&gt;Hopefully, the same patch will fix this issue and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3945&quot; title=&quot;Generation clauses which mention user-coded functions may produce different resuls depending on who performs the triggering INSERT/UPDATE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3945&quot;&gt;&lt;del&gt;DERBY-3945&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12646683" author="fuzzylogic" created="Tue, 11 Nov 2008 21:57:12 +0000"  >&lt;p&gt;Did a quick check as I happened to have several different DBs handy. DB2 v9 only allows user defined functions that can be expressed in SQL, and IDS 11, Oracle 9, and MS SQL Server 2005 all disallow user-defined functions in check constraints.&lt;/p&gt;</comment>
                            <comment id="12646685" author="rhillegas" created="Tue, 11 Nov 2008 22:05:07 +0000"  >&lt;p&gt;Thanks, Andrew. When you&apos;ve got a moment, can you let us know what schema DB2 assigns to the function references if they aren&apos;t qualified with an explicit schema name?&lt;/p&gt;</comment>
                            <comment id="12646728" author="fuzzylogic" created="Tue, 11 Nov 2008 23:26:27 +0000"  >&lt;p&gt;DB2 assigns it to the current schema. In the default case, this is the schema corresponding to the user id.&lt;/p&gt;

&lt;p&gt;FWIW, the copy of the SQL standard I have says in sec. 5.4, 4a that the unqualified identifiers should resolve to the current schema for the SQL session and the definition of routine invocation has no language to contradict that and simply says that it&apos;s a qualified identifier. While it seems logical to me that an unqualified function name in a check constraint would resolve to the schema containing the table with the constraint, it could be useful to have the function resolve to different functions in each schema, e.g. allowing different users to insert data into a table with different constraints.&lt;/p&gt;</comment>
                            <comment id="12646906" author="rhillegas" created="Wed, 12 Nov 2008 14:18:24 +0000"  >&lt;p&gt;Thanks, Andrew. I agree that there are applications which might want CHECK constraints to behave as you describe. That behavior, however, violates my understanding of  &quot;retrospective determinacy&quot;. It may be that the standard did a poor job of integrating user-defined functions with CHECK constraints. I will ask around for more guidance.&lt;/p&gt;</comment>
                            <comment id="12647041" author="fuzzylogic" created="Wed, 12 Nov 2008 20:24:58 +0000"  >&lt;p&gt;I checked yesterday and contrary to the way the docs read, DB2 doesn&apos;t actually allow user defined functions in SQL  in check constraints either. I suspect this may simply be an overlooked corner in the SQL spec, since none of the major vendors support user-defined functions in check constraints and built-in functions never need a schema qualifier.&lt;/p&gt;</comment>
                            <comment id="12647374" author="rhillegas" created="Thu, 13 Nov 2008 20:01:11 +0000"  >&lt;p&gt;Thanks for the extra information, Andrew. In the meantime, discussion has continued on the email thread mentioned above. Dag&apos;s eagle eyes spotted the following chapter and verse, which appears to settle the spec issues:&lt;/p&gt;

&lt;p&gt;section 4.27.2 Characteristics of SQL-invoked routines:&lt;/p&gt;

&lt;p&gt;&amp;gt; &amp;gt; If a &amp;lt;routine invocation&amp;gt; is contained in a &amp;lt;query expression&amp;gt; of a&lt;br/&gt;
&amp;gt; &amp;gt; view, a check constraint, or an assertion, the &amp;lt;triggered action&amp;gt; of a&lt;br/&gt;
        ****************&lt;br/&gt;
&amp;gt; &amp;gt; trigger, or in an &amp;lt;SQL-invoked routine&amp;gt;, then the subject routine for&lt;br/&gt;
&amp;gt; &amp;gt; that invocation is determined at the time the view is created, the&lt;br/&gt;
&amp;gt; &amp;gt; check constraint is defined, the assertion is created, the trigger is&lt;br/&gt;
&amp;gt; &amp;gt; created, or the SQL-invoked routine is created.&lt;/p&gt;</comment>
                            <comment id="12726930" author="kristwaa" created="Fri, 3 Jul 2009 13:04:05 +0100"  >&lt;p&gt;Triaged July 3, 2009: Assigned normal urgency, marked Known fix and Repro attached.&lt;/p&gt;</comment>
                            <comment id="12888474" author="rhillegas" created="Wed, 14 Jul 2010 19:24:31 +0100"  >&lt;p&gt;Attaching derby-3944-01-aa-useOriginalSchema.diff. This causes CHECK constraints compile in the schema of the target table rather than in the current schema of the INSERT/UPDATE statement. I will run tests.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-----------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/sql/compile/DMLModStatementNode.java&lt;/p&gt;

&lt;p&gt;Changes the current schema while compiling check constraints.&lt;/p&gt;

&lt;p&gt;-----------&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/GeneratedColumnsPermsTest.java&lt;/p&gt;

&lt;p&gt;Adds a test for this behavior.&lt;/p&gt;</comment>
                            <comment id="12888507" author="rhillegas" created="Wed, 14 Jul 2010 20:46:43 +0100"  >&lt;p&gt;Attaching second rev of the patch, derby-3944-01-ab-useOriginalSchema.diff. This rev adds a test case to verify that &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3953&quot; title=&quot;VIEWS which invoke user-coded functions may return different results depending on who SELECTs from them&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3953&quot;&gt;&lt;del&gt;DERBY-3953&lt;/del&gt;&lt;/a&gt; has also been fixed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3953&quot; title=&quot;VIEWS which invoke user-coded functions may return different results depending on who SELECTs from them&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3953&quot;&gt;&lt;del&gt;DERBY-3953&lt;/del&gt;&lt;/a&gt; appears to have been fixed by some other patch. This additional test case merely tracks that fact. I will close &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3953&quot; title=&quot;VIEWS which invoke user-coded functions may return different results depending on who SELECTs from them&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3953&quot;&gt;&lt;del&gt;DERBY-3953&lt;/del&gt;&lt;/a&gt; when I commit this patch.&lt;/p&gt;</comment>
                            <comment id="12888813" author="rhillegas" created="Thu, 15 Jul 2010 15:40:38 +0100"  >&lt;p&gt;Tests passed cleanly for me except for the known regression having to do with port numbers. Committed at subversion revision 964402.&lt;/p&gt;</comment>
                            <comment id="12989879" author="kmarsden" created="Wed, 2 Feb 2011 23:38:44 +0000"  >&lt;p&gt;Reopen for backport&lt;/p&gt;</comment>
                            <comment id="12992171" author="mikem" created="Tue, 8 Feb 2011 20:49:22 +0000"  >&lt;p&gt;backported to 10.6 and 10.5 branches.  Resolving and resetting original owner back.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12408779">DERBY-3954</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12408290">DERBY-3945</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12408774">DERBY-3953</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12671742">DERBY-6362</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12497378">DERBY-4994</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12449472" name="derby-3944-01-aa-useOriginalSchema.diff" size="4279" author="rhillegas" created="Wed, 14 Jul 2010 19:24:31 +0100"/>
                            <attachment id="12449481" name="derby-3944-01-ab-useOriginalSchema.diff" size="6601" author="rhillegas" created="Wed, 14 Jul 2010 20:46:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 11 Nov 2008 21:57:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23929</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10426"><![CDATA[Known fix]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0j6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36925</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>