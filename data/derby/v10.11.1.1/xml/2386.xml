<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:30:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2386/DERBY-2386.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2386] timestampdiff function fails when using SQL_TSI_FRAC_SECOND for datepart parameter, except for very small intervals</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2386</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Using the timestampdiff function produces and integer overflow except for very small intervals. Error message is:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Error Code: -1, SQL State: 22003&amp;#93;&lt;/span&gt;  The resulting value is outside the range for the data type INTEGER.&lt;/p&gt;

&lt;p&gt;I inserted the following row into my test table:&lt;/p&gt;

&lt;p&gt;insert into datetest (ID, &lt;br/&gt;
startdate, &lt;br/&gt;
enddate) values (&lt;br/&gt;
5, &lt;br/&gt;
&apos;2006-11-20 04:20:00.0&apos;, &lt;br/&gt;
&apos;2006-11-20 04:20:00.2&apos;);&lt;/p&gt;

&lt;p&gt;This test row works:&lt;/p&gt;

&lt;p&gt;select &lt;/p&gt;
{fn timestampdiff(SQL_TSI_FRAC_SECOND, startdate, enddate)}
&lt;p&gt; as diff from datetest where id = 5&lt;/p&gt;

&lt;p&gt;DIFF&lt;br/&gt;
200000000&lt;/p&gt;

&lt;p&gt;The value also looks too large, which could be exacerbating the problem.&lt;/p&gt;</description>
                <environment>SUSE Linux Enterprise Desktop 10</environment>
        <key id="12363902">DERBY-2386</key>
            <summary>timestampdiff function fails when using SQL_TSI_FRAC_SECOND for datepart parameter, except for very small intervals</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mayureshnirhali">Mayuresh Nirhali</assignee>
                                    <reporter username="dhsmith">Don Smith</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Mar 2007 17:21:21 +0000</created>
                <updated>Fri, 21 Jan 2011 17:49:51 +0000</updated>
                            <resolved>Sat, 7 Jul 2007 04:29:16 +0100</resolved>
                                    <version>10.2.2.0</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12477050" author="dhsmith" created="Thu, 1 Mar 2007 18:56:06 +0000"  >&lt;p&gt;Stack trace:&lt;/p&gt;

&lt;p&gt;Caused by: java.sql.SQLException: The resulting value is outside the range for the data type INTEGER.&lt;br/&gt;
	at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeQuery(Unknown Source)&lt;br/&gt;
	at org.hibernate.jdbc.AbstractBatcher.getResultSet(AbstractBatcher.java:186)&lt;br/&gt;
	at org.hibernate.loader.Loader.getResultSet(Loader.java:1775)&lt;br/&gt;
	at org.hibernate.loader.Loader.doQuery(Loader.java:662)&lt;br/&gt;
	at org.hibernate.loader.Loader.doQueryAndInitializeNonLazyCollections(Loader.java:224)&lt;br/&gt;
	at org.hibernate.loader.Loader.doList(Loader.java:2208)&lt;br/&gt;
	... 38 more&lt;br/&gt;
Caused by: org.apache.derby.client.am.SqlException: The resulting value is outside the range for the data type INTEGER.&lt;br/&gt;
	at org.apache.derby.client.am.Statement.completeSqlca(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.Statement.completeOpenQuery(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatementReply.parseOpenQueryFailure(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatementReply.parseOPNQRYreply(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatementReply.readOpenQuery(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.StatementReply.readOpenQuery(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.net.NetStatement.readOpenQuery_(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.Statement.readOpenQuery(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.flowExecute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.PreparedStatement.executeQueryX(Unknown Source)&lt;br/&gt;
	... 44 more&lt;/p&gt;</comment>
                            <comment id="12478275" author="mayureshnirhali" created="Tue, 6 Mar 2007 06:24:27 +0000"  >&lt;p&gt;The SQL_TSI_FRAC_SECOND type is used for fractional timestamp differences. IF the expected difference is in seconds then SQL_TSI_SECOND should be used. This is a solution to the error that is being reported in the description. So, I think this is not a bug.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200511.mbox/%3Cc25576af0511281539te6c1eefw48a9dcc993ad709c@mail.gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-dev/200511.mbox/%3Cc25576af0511281539te6c1eefw48a9dcc993ad709c@mail.gmail.com%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The discussion above on the derby-dev list on the same topic and that talks about returning BIGINT instead of INT. I am inclined towards NOT doing that because there is no gap between the values covered by TSI_FRAC_SECOND and TSI_SECOND. I tried a small experiment as below,&lt;/p&gt;

&lt;p&gt;&amp;lt;snip&amp;gt;&lt;br/&gt;
ij&amp;gt; select * from t2;&lt;br/&gt;
ID         |STARTDATE                 |ENDDATE&lt;br/&gt;
-----------------------------------------------------------------&lt;br/&gt;
5          |2006-11-20 04:20:00.0     |2006-11-20 04:20:00.2&lt;br/&gt;
6          |2006-11-20 04:20:00.0     |2006-11-20 04:20:30.0&lt;br/&gt;
7          |2006-11-20 04:20:00.0     |2006-11-20 04:20:00.3&lt;br/&gt;
8          |2006-11-20 04:20:00.0     |2006-11-20 04:20:00.9999&lt;/p&gt;

&lt;p&gt;4 rows selected&lt;br/&gt;
ij&amp;gt; select &lt;/p&gt;
{fn timestampdiff(SQL_TSI_FRAC_SECOND, startdate, enddate)}
&lt;p&gt; as diff from t2 where id =8;&lt;br/&gt;
DIFF&lt;br/&gt;
-----------&lt;br/&gt;
999900000&lt;/p&gt;

&lt;p&gt;1 row selected&lt;br/&gt;
&amp;lt;/snip&amp;gt;&lt;/p&gt;

&lt;p&gt;So, for all values less than 1 second the function will not fail if FRAC_SECOND is used and for values in seconds TSI_SECOND should be used. &lt;/p&gt;

&lt;p&gt;The only downside of this existing approach is that for difference in seconds (when TSI_SECOND is used) the fractional difference cannot be identified.&lt;/p&gt;

&lt;p&gt;please share your thoughts.&lt;/p&gt;</comment>
                            <comment id="12478442" author="dhsmith" created="Tue, 6 Mar 2007 15:23:40 +0000"  >&lt;p&gt;It seems counter-intuitive to require foreknowledge of the interval magnitude in order to select the correct datepart parameter. If seconds returned the fractional portion, then it would be sufficient to always use seconds, and multiply within application code as needed. But the nature of data-driven programs is that we don&apos;t know whether the interval will be less than a second, less than a minute, or even less than a day.&lt;/p&gt;

&lt;p&gt;By limiting the function return value to integer, the usefulness of this function is severly limited. Many applications require fractional-second accuracy to time certain events, events which could possibly take &amp;gt; 1 second.&lt;/p&gt;

&lt;p&gt;Calculating an interval in Java uses milliseconds, i.e. date1.getTimeInMillis() - date2.getTimeInMillis(). It seems like a Java-based dbms should be able to mimic this Java concept.&lt;/p&gt;

&lt;p&gt;I urge you to expand the return type to BIGINT (Java long).&lt;/p&gt;</comment>
                            <comment id="12479339" author="mayureshnirhali" created="Thu, 8 Mar 2007 15:44:17 +0000"  >&lt;p&gt;I concur. I think it will help if return value is BigInt.&lt;/p&gt;

&lt;p&gt;I have created a patch with this change. Please note that Max/Min value check with changed type has been made only for FRAC_SECOND, MONTH and YEAR difference will be compared with Int max/min values only.&lt;/p&gt;

&lt;p&gt;I have run derbyall and junit tests and no new failures have been found.&lt;/p&gt;

&lt;p&gt;I think this patch is ready for commit.&lt;/p&gt;
</comment>
                            <comment id="12479347" author="djd" created="Thu, 8 Mar 2007 16:17:49 +0000"  >&lt;p&gt;I think the change to BIGINT is more involved than the patch. Doesn&apos;t some compile time code have to change to indicate at bind time that this is returning a BIGINT?&lt;/p&gt;

&lt;p&gt;This test can never be true:&lt;/p&gt;

&lt;p&gt;if (ldiff &amp;gt; Long.MAX_VALUE || ldiff &amp;lt; Long.MIN_VALUE)&lt;/p&gt;

&lt;p&gt;since ldiff was already a long it cannot be outside its own range.&lt;/p&gt;

&lt;p&gt;FYI - the old check &amp;amp; code that was there:&lt;/p&gt;

&lt;p&gt;		if (ldiff &amp;gt; Integer.MAX_VALUE || ldiff &amp;lt; Integer.MIN_VALUE)&lt;br/&gt;
			throw StandardException.newException(SQLState.LANG_OUTSIDE_RANGE_FOR_DATATYPE, &quot;INTEGER&quot;);&lt;br/&gt;
        resultHolder.setValue( (int) ldiff);&lt;/p&gt;

&lt;p&gt;is not required, it could be simply&lt;/p&gt;

&lt;p&gt;          resultHolder.setValue(ldiff);&lt;/p&gt;</comment>
                            <comment id="12480401" author="djd" created="Tue, 13 Mar 2007 14:08:54 +0000"  >&lt;p&gt;The comment about bind time is related to what return type this method states it is. I assume at the moment it is an INTEGER, just changing the holder used to manage the return value will not change its declared type. For example try looking at the ResultSetMetaData for the example statement.&lt;/p&gt;

&lt;p&gt;select &lt;/p&gt;
{fn timestampdiff(SQL_TSI_FRAC_SECOND, startdate, enddate)}
&lt;p&gt; as diff from t2 where id =8; &lt;/p&gt;

&lt;p&gt;What is the type of the column according to RSMD with and without your patch?&lt;/p&gt;</comment>
                            <comment id="12481092" author="mayureshnirhali" created="Thu, 15 Mar 2007 09:44:24 +0000"  >&lt;p&gt;Thanks Dan for the clarification.&lt;/p&gt;

&lt;p&gt;I have created a new patch with additional changes to ensure that BIGINT is returned at the bind time as well.&lt;/p&gt;

&lt;p&gt;I have also run derbyall and junit tests and no new issues were found.&lt;br/&gt;
The patch is ready for further review.&lt;/p&gt;</comment>
                            <comment id="12486684" author="djd" created="Wed, 4 Apr 2007 17:14:54 +0100"  >&lt;p&gt;Committed revision 525549 patch derby2386-v2.diff to trunk.&lt;/p&gt;</comment>
                            <comment id="12486685" author="djd" created="Wed, 4 Apr 2007 17:16:59 +0100"  >&lt;p&gt;Existing application impact in that the return type of this function changed to BIGINT from INTEGER.&lt;br/&gt;
Can cause existing applications to fail, e.g. an existing application that passed this as an argument to a SQL function will not resolve since the previous resolution would be to a function with an INTEGER parameter.&lt;/p&gt;</comment>
                            <comment id="12488362" author="mayureshnirhali" created="Thu, 12 Apr 2007 13:39:49 +0100"  >&lt;p&gt;No issues found on the fix.&lt;/p&gt;</comment>
                            <comment id="12499343" author="myrna" created="Sat, 26 May 2007 19:54:46 +0100"  >&lt;p&gt;I tried to craft a release note based on the comments...Interested parties, please review...&lt;/p&gt;</comment>
                            <comment id="12499352" author="myrna" created="Sat, 26 May 2007 21:38:26 +0100"  >&lt;p&gt;the summary had the fix incorrect; attaching new releaseNote.html.&lt;/p&gt;</comment>
                            <comment id="12499499" author="mayureshnirhali" created="Mon, 28 May 2007 09:22:26 +0100"  >&lt;p&gt;ReleaseNote looks good.&lt;/p&gt;

&lt;p&gt;Thanks myrna for taking care of this!&lt;/p&gt;</comment>
                            <comment id="12510845" author="myrna" created="Sat, 7 Jul 2007 04:30:45 +0100"  >&lt;p&gt;attaching a newer release note that hopefully addresses the concern voiced in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2847&quot; title=&quot;More clarification issues for the release notes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2847&quot;&gt;&lt;del&gt;DERBY-2847&lt;/del&gt;&lt;/a&gt; on this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12353361" name="derby2386-v2.diff" size="2111" author="mayureshnirhali" created="Thu, 15 Mar 2007 09:44:24 +0000"/>
                            <attachment id="12352927" name="derby2386.diff" size="1807" author="mayureshnirhali" created="Thu, 8 Mar 2007 15:44:17 +0000"/>
                            <attachment id="12361339" name="releaseNote.html" size="3874" author="myrna" created="Sat, 7 Jul 2007 04:30:45 +0100"/>
                            <attachment id="12358313" name="releaseNote.html" size="3862" author="myrna" created="Sat, 26 May 2007 21:38:26 +0100"/>
                            <attachment id="12358311" name="releaseNote.html" size="3866" author="myrna" created="Sat, 26 May 2007 19:54:46 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 Mar 2007 06:24:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23032</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0mlj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37479</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>