<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6577/DERBY-6577.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6577] Quantified comparison returns wrong result in CASE, COALESCE, IN and BETWEEN</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6577</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I&apos;m seeing this on head of trunk:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; select c, c = all (values &apos;Y&apos;), case when c = all (values &apos;Y&apos;) then true else false end from (values &apos;Y&apos;, &apos;N&apos;) v(c);
C|2    |3    
-------------
Y|true |false
N|false|true 

2 rows selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Column 2 and column 3 should have the same value, but something seems to go wrong when the quantified comparison is used in a CASE expression.&lt;/p&gt;

&lt;p&gt;I&apos;m seeing the expected result on 10.10.2.0, though:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; select c, c = all (values &apos;Y&apos;), case when c = all (values &apos;Y&apos;) then true else false end from (values &apos;Y&apos;, &apos;N&apos;) v(c);
C|2    |3    
-------------
Y|true |true 
N|false|false

2 rows selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12714167">DERBY-6577</key>
            <summary>Quantified comparison returns wrong result in CASE, COALESCE, IN and BETWEEN</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 May 2014 14:40:03 +0100</created>
                <updated>Thu, 13 Nov 2014 17:48:23 +0000</updated>
                            <resolved>Thu, 13 Nov 2014 17:48:23 +0000</resolved>
                                    <version>10.10.2.0</version>
                    <version>10.11.1.1</version>
                                    <fixVersion>10.10.2.1</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13997570" author="knutanders" created="Wed, 14 May 2014 15:09:17 +0100"  >&lt;p&gt;Looks like this got introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6566&quot; title=&quot;Simplify handling of untyped nulls in CASE and NULLIF expressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6566&quot;&gt;&lt;del&gt;DERBY-6566&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13997580" author="knutanders" created="Wed, 14 May 2014 15:23:58 +0100"  >&lt;p&gt;This problem was new in CASE expressions after &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6566&quot; title=&quot;Simplify handling of untyped nulls in CASE and NULLIF expressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6566&quot;&gt;&lt;del&gt;DERBY-6566&lt;/del&gt;&lt;/a&gt;, but a similar problem can be seen with COALESCE even with 10.10.2.0:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; select c, coalesce((c = all (values &apos;Y&apos;)), false) from (values &apos;Y&apos;, &apos;N&apos;) v(c);
C|2    
-------
Y|false
N|true 

2 rows selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe the result should be the other way around. It should be (Y, true), (N, false).&lt;/p&gt;

&lt;p&gt;The underlying bug may be similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6408&quot; title=&quot;EXISTS returns NULL instead of FALSE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6408&quot;&gt;&lt;del&gt;DERBY-6408&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6409&quot; title=&quot;Wrong result from quantified comparison&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6409&quot;&gt;&lt;del&gt;DERBY-6409&lt;/del&gt;&lt;/a&gt;. There, part of the problem was that SubqueryList.preprocess() didn&apos;t update the list if the recursive calls to preprocess() rewrote one of the elements in the list. COALESCE, and (after &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6566&quot; title=&quot;Simplify handling of untyped nulls in CASE and NULLIF expressions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6566&quot;&gt;&lt;del&gt;DERBY-6566&lt;/del&gt;&lt;/a&gt;) CASE, use ValueNodeList.preprocess(), which seems to have the same problem that SubqueryList.preprocess() had.&lt;/p&gt;</comment>
                            <comment id="13997585" author="knutanders" created="Wed, 14 May 2014 15:27:28 +0100"  >&lt;p&gt;Updated affects version to include 10.10.2.0, since the problem can also be seen there in some queries. Keeping the regression flag, since the problem is seen in more queries on trunk.&lt;/p&gt;</comment>
                            <comment id="13997591" author="knutanders" created="Wed, 14 May 2014 15:34:01 +0100"  >&lt;p&gt;Also affects the IN and BETWEEN operators on 10.10.2.0:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; select c, true in ((c = all (values &apos;Y&apos;))) from (values &apos;Y&apos;, &apos;N&apos;) v(c);
C|2    
-------
Y|NULL 
N|true 

2 rows selected
ij&amp;gt; select c, true between false and (c = all (values &apos;Y&apos;)) from (values &apos;Y&apos;, &apos;N&apos;) v(c);
C|2    
-------
Y|NULL 
N|true 

2 rows selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both of these queries should have returned (Y, true), (N, false).&lt;/p&gt;</comment>
                            <comment id="13997620" author="knutanders" created="Wed, 14 May 2014 16:00:01 +0100"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12644832/12644832_d6577-1a.diff&quot; title=&quot;d6577-1a.diff attached to DERBY-6577&quot;&gt;d6577-1a.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; fixes ValueNodeList.preprocess() and adds test cases to verify that the correct results are returned from the queries mentioned in this bug report.&lt;/p&gt;

&lt;p&gt;I&apos;ve started the full regression test suite on the patch.&lt;/p&gt;</comment>
                            <comment id="13998579" author="jira-bot" created="Thu, 15 May 2014 09:34:51 +0100"  >&lt;p&gt;Commit 1594816 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1594816&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1594816&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6577&quot; title=&quot;Quantified comparison returns wrong result in CASE, COALESCE, IN and BETWEEN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6577&quot;&gt;&lt;del&gt;DERBY-6577&lt;/del&gt;&lt;/a&gt;: Quantified comparison returns wrong result in CASE, COALESCE, IN and BETWEEN&lt;/p&gt;

&lt;p&gt;ValueNodeList.preprocess() should update the list with the rewritten expressions.&lt;/p&gt;</comment>
                            <comment id="13998590" author="knutanders" created="Thu, 15 May 2014 09:47:39 +0100"  >&lt;p&gt;All tests passed, so I committed the 1a patch. I did notice that there were some other callers of preprocess() that also discarded the return value. I haven&apos;t been able to create a test case that breaks because of it, but it might be a good idea to fix them just in case. I&apos;ll post a new patch.&lt;/p&gt;</comment>
                            <comment id="13998634" author="knutanders" created="Thu, 15 May 2014 10:47:52 +0100"  >&lt;p&gt;Attaching &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12644985/12644985_d6577-2a.diff&quot; title=&quot;d6577-2a.diff attached to DERBY-6577&quot;&gt;d6577-2a.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which changes the three occurrences I found, where the return value of ValueNode.preprocess() is discarded instead of being used to update the preprocessed field.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this fixes any bugs currently. In SelectNode.whereClause and JoinNode.joinClause have been normalized before preprocess() is called, so they are always AndNodes. Since AndNode.preprocess() currently always returns itself, updating the fields to the returned values won&apos;t actually change them.&lt;/p&gt;

&lt;p&gt;Similarly, for SQLToJavaValueNode.value, it seems to be a CastNode in my experiments (don&apos;t know if it always is, though). And CastNode.preprocess() also always returns itself, so it doesn&apos;t make any difference whether or not the field is updated.&lt;/p&gt;

&lt;p&gt;I still think the fields should be updated for completeness, and to prevent bugs if the logic ever changes so that preprocess() in these cases could return a different node than the node it is called on.&lt;/p&gt;

&lt;p&gt;All regression tests ran cleanly with the patch.&lt;/p&gt;</comment>
                            <comment id="13999532" author="dagw" created="Fri, 16 May 2014 03:14:10 +0100"  >&lt;p&gt;+1 to the bug fix and also to making the proactive assignments in the second patch.&lt;/p&gt;</comment>
                            <comment id="13999641" author="jira-bot" created="Fri, 16 May 2014 07:38:56 +0100"  >&lt;p&gt;Commit 1595121 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1595121&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1595121&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6577&quot; title=&quot;Quantified comparison returns wrong result in CASE, COALESCE, IN and BETWEEN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6577&quot;&gt;&lt;del&gt;DERBY-6577&lt;/del&gt;&lt;/a&gt;: Preserve return value from recursive calls to preprocess()&lt;/p&gt;</comment>
                            <comment id="13999642" author="knutanders" created="Fri, 16 May 2014 07:39:59 +0100"  >&lt;p&gt;Thanks for looking at the patches, Dag. The fixes have been committed to trunk. Marking the issue as resolved.&lt;/p&gt;</comment>
                            <comment id="14009992" author="mikem" created="Tue, 27 May 2014 18:57:50 +0100"  >&lt;p&gt;Is this a reasonable candidate for backport to 10.10?&lt;/p&gt;</comment>
                            <comment id="14010986" author="knutanders" created="Wed, 28 May 2014 11:02:47 +0100"  >&lt;p&gt;I think this could be backported to 10.10.&lt;/p&gt;

&lt;p&gt;On 10.10, the bug affects COALESCE, IN and BETWEEN, but not CASE.&lt;/p&gt;</comment>
                            <comment id="14169023" author="mamtas" created="Mon, 13 Oct 2014 08:03:17 +0100"  >&lt;p&gt;Reopening for backport to 10.10&lt;/p&gt;</comment>
                            <comment id="14210050" author="jira-bot" created="Thu, 13 Nov 2014 17:26:09 +0000"  >&lt;p&gt;Commit 1639402 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mamtas&quot; class=&quot;user-hover&quot; rel=&quot;mamtas&quot;&gt;Mamta A. Satoor&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1639402&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1639402&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6577&quot; title=&quot;Quantified comparison returns wrong result in CASE, COALESCE, IN and BETWEEN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6577&quot;&gt;&lt;del&gt;DERBY-6577&lt;/del&gt;&lt;/a&gt;(Quantified comparison returns wrong result in CASE, COALESCE, IN and BETWEEN)&lt;/p&gt;

&lt;p&gt;Back porting to 10.10&lt;/p&gt;</comment>
                            <comment id="14210075" author="mamtas" created="Thu, 13 Nov 2014 17:48:23 +0000"  >&lt;p&gt;Finished backporting to 10.10&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12678185">DERBY-6408</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12678189">DERBY-6409</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12746192">DERBY-6759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12713029">DERBY-6566</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12644832" name="d6577-1a.diff" size="4732" author="knutanders" created="Wed, 14 May 2014 16:00:01 +0100"/>
                            <attachment id="12644985" name="d6577-2a.diff" size="2166" author="knutanders" created="Thu, 15 May 2014 10:47:52 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 15 May 2014 08:34:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>392480</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzpg1b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>392665</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>