<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5530/DERBY-5530.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5530] SQLChar.getCollationKey NPE in index-stat-thread</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5530</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;With this JDBC connection url is : jdbc:derby:directory:db_name;territory=fr_FR;collation=TERRITORY_BASED:PRIMARY;create=true&lt;br/&gt;
I get a NullPointerException in index-stat-thread&lt;/p&gt;

&lt;p&gt;Sun Dec 11 19:33:11 CET 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-3-thread-1,5,main&amp;#93;&lt;/span&gt; &lt;/p&gt;
{istat} &quot;PROXIFLEX&quot;.&quot;IDAXX_RES&quot;: update scheduled, reason=&lt;span class=&quot;error&quot;&gt;&amp;#91;no stats, row-estimate=375&amp;#93;&lt;/span&gt; (queueSize=1)&lt;br/&gt;
Sun Dec 11 19:33:11 CET 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;index-stat-thread,5,main&amp;#93;&lt;/span&gt; {istat,trace@26130360} worker thread started (xid=12049) &lt;span class=&quot;error&quot;&gt;&amp;#91;q/p/s=1/0/1,err:k/u/c=0/0/0,rej:f/d/o=0/0/0&amp;#93;&lt;/span&gt;&lt;br/&gt;
Sun Dec 11 19:33:11 CET 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;index-stat-thread,5,main&amp;#93;&lt;/span&gt; {istat,trace@26130360}     processing &quot;PROXIFLEX&quot;.&quot;IDAXX_RES&quot; &lt;br/&gt;
Sun Dec 11 19:33:11 CET 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;index-stat-thread,5,main&amp;#93;&lt;/span&gt; {istat}
&lt;p&gt; runtime exception during normal operation&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.getCollationKey(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.WorkHorseForCollatorDatatypes.stringCompare(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.CollatorSQLVarchar.stringCompare(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLChar.compare(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl$KeyComparator.compareWithPrevKey(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.processingLoop(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(Unknown Source)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
Sun Dec 11 19:33:11 CET 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;index-stat-thread,5,main&amp;#93;&lt;/span&gt; &lt;/p&gt;
{istat,trace@26130360}
&lt;p&gt; worker thread exit &lt;span class=&quot;error&quot;&gt;&amp;#91;q/p/s=0/0/1,err:k/u/c=0/0/0,rej:f/d/o=0/0/0&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;If I remove territory and collation parameters I don&apos;t have the exception.&lt;/p&gt;

&lt;p&gt;In case you want to disable automatic statistics, set derby property : derby.storage.indexStats.auto to false.&lt;/p&gt;</description>
                <environment>Windows 7 - NetBeans 6.9.1</environment>
        <key id="12534687">DERBY-5530</key>
            <summary>SQLChar.getCollationKey NPE in index-stat-thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="jylaxx">Jean-Yves LINET</reporter>
                        <labels>
                    </labels>
                <created>Sun, 11 Dec 2011 21:41:19 +0000</created>
                <updated>Fri, 15 Nov 2013 08:15:10 +0000</updated>
                            <resolved>Thu, 23 Feb 2012 07:23:29 +0000</resolved>
                                    <version>10.7.1.1</version>
                    <version>10.8.2.2</version>
                    <version>10.9.1.0</version>
                                    <fixVersion>10.7.1.4</fixVersion>
                    <fixVersion>10.8.3.0</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13198679" author="kristwaa" created="Thu, 2 Feb 2012 10:47:03 +0000"  >&lt;p&gt;I&apos;m unable to reproduce this (modified the istat test to run with a collated database).&lt;br/&gt;
Can you confirm that this is still a problem for you, and/or provide some more detail?&lt;br/&gt;
For instance:&lt;br/&gt;
 o JVM vendor/version&lt;br/&gt;
 o relevant part of the database schema, i.e. column types and indexes/constraints&lt;br/&gt;
 o istat lines from derby.log with derby.storage.indexStats.log=true and derby.storage.indexStats.debug.trace=true (grep for &quot;&lt;/p&gt;
{istat}
&lt;p&gt;&quot;)&lt;br/&gt;
    Note: If the lines you included in the report are the only ones, ignore this.&lt;/p&gt;

&lt;p&gt;I tried to reproduce on Solaris 11 with 1.6.0_26-b03 and 1.7.0_02-b13.&lt;/p&gt;</comment>
                            <comment id="13203657" author="jylaxx" created="Wed, 8 Feb 2012 15:11:42 +0000"  >&lt;p&gt;Well I spent several more hours on this problem trying to isolate the bug context. It was not obvious must I finally found how to reproduce it.&lt;br/&gt;
In fact the bug is quite easy to reproduce and it comes from the use of the TRUNCATE TABLE statement.&lt;br/&gt;
1- Create a table with a single column,&lt;br/&gt;
2- Add an index on this column,&lt;br/&gt;
3- Execute TRUNCATE statement on this table, &lt;br/&gt;
4- Add at least two rows,&lt;br/&gt;
5- Execute the SYSCS_UPDATE_STATISTICS procedure.&lt;br/&gt;
If you have created the database with collation you have the NullPointerException, with no collation it is working fine.&lt;/p&gt;

&lt;p&gt;One more information. If you call the SYSCS_COMPRESS_TABLE before the statistics you don&apos;t have the NPE with collation database.&lt;/p&gt;

&lt;p&gt;I hope this information will be helpful to fix the bug.&lt;br/&gt;
If you need more information just ask.&lt;/p&gt;

&lt;p&gt;Forgot to say that the derby.storage.indexStats.auto is disabled (false).&lt;/p&gt;</comment>
                            <comment id="13204967" author="dagw" created="Thu, 9 Feb 2012 22:30:28 +0000"  >&lt;p&gt;Hi Jean-Yves,&lt;br/&gt;
I tried to reproduce this using the attached script. It did not give NPE for me. Have a look and see if you can modify it to show the error.&lt;/p&gt;</comment>
                            <comment id="13205034" author="jylaxx" created="Thu, 9 Feb 2012 23:26:20 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
Well you have to use a VARCHAR column as collation are used with string values, not int !&lt;/p&gt;</comment>
                            <comment id="13205212" author="dagw" created="Fri, 10 Feb 2012 04:13:38 +0000"  >&lt;p&gt;Thanks for your help, Jean-Yves, I now have a working repro, uploaded: repro.sh (creates repro.sql) and resulting repro.log.&lt;br/&gt;
(run with 10.8).&lt;/p&gt;

&lt;p&gt;I also enclose a run with a debug version of trunk which shows ASSERTION errors in debug mode. (repro-debug)&lt;/p&gt;
</comment>
                            <comment id="13205218" author="dagw" created="Fri, 10 Feb 2012 04:24:49 +0000"  >&lt;p&gt;Not that with the debug version from trunk, the error arises in the INSERT; and ASSERT error.&lt;br/&gt;
In the 10.8 non-debug run, I see the NPE in the call to SYSCS_COMPRESS_TABLE as you see.&lt;/p&gt;</comment>
                            <comment id="13206809" author="kristwaa" created="Mon, 13 Feb 2012 11:18:22 +0000"  >&lt;p&gt;Some comments on this issue:&lt;br/&gt;
 o the bug is in the truncate table code&lt;br/&gt;
 o the istat deamon and the update statistics code are not causing this bug&lt;br/&gt;
 o workaround: drop and recreate the index(es) (preferably just after the truncate command has finished)&lt;/p&gt;</comment>
                            <comment id="13206815" author="kristwaa" created="Mon, 13 Feb 2012 11:29:46 +0000"  >&lt;p&gt;Another thing: TRUNCATE TABLE wasn&apos;t enabled before 10.7. Was the code used internally for something before that? If not I have to update the affected versions, since even though the code with the bug went into 10.3, there would be no way to run it (in producation/insane builds) until 10.7.&lt;/p&gt;</comment>
                            <comment id="13206819" author="jylaxx" created="Mon, 13 Feb 2012 11:36:17 +0000"  >&lt;p&gt;Dropping and recreating index need to have the DDL of the indexes when truncate is called. So the truncate call can&apos;t be generic.&lt;br/&gt;
I found that calling SYSCS_COMPRESS_TABLE just after the truncate was also a workaround.&lt;br/&gt;
What could be the side effects of this solution compare with dropping and recreating index.&lt;/p&gt;</comment>
                            <comment id="13206821" author="kristwaa" created="Mon, 13 Feb 2012 11:47:04 +0000"  >&lt;p&gt;SYSCS_COMPRESS_TABLE drops and recreates the table/indexes for you, so that&apos;s a perfectly valid workaround.&lt;br/&gt;
Note that SYSCS_INPLACE_COMPRESS_TABLE probably won&apos;t work.&lt;/p&gt;

&lt;p&gt;I have a patch for this bug, I&apos;m running tests on it now.&lt;/p&gt;</comment>
                            <comment id="13206920" author="kristwaa" created="Mon, 13 Feb 2012 15:15:08 +0000"  >&lt;p&gt;Attaching patch 1a, which fixes the bug in truncate table.&lt;/p&gt;

&lt;p&gt;The bug was simply that the collation information wasn&apos;t propagated to the indexes.&lt;br/&gt;
I&apos;ve added two tests to CollationTest2.&lt;/p&gt;

&lt;p&gt;suites.All passed without errors.&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="13206942" author="knutanders" created="Mon, 13 Feb 2012 15:45:08 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Looks like a simple fix that makes truncateTable() pass collation information the same way as the other parts of AlterTableConstantAction.&lt;/p&gt;

&lt;p&gt;Nit: You probably meant to make the two new methods in CollationTest2 private?&lt;/p&gt;</comment>
                            <comment id="13207635" author="kristwaa" created="Tue, 14 Feb 2012 11:14:38 +0000"  >&lt;p&gt;Thanks to Jean-Yves and Dag for helping with the repro.&lt;br/&gt;
Thanks to Knut Anders for reviewing the patch.&lt;/p&gt;

&lt;p&gt;Regarding public vs private - yes they should be private. I changed this before committing.&lt;br/&gt;
The reason they were public was that I assumed the JUnit pattern was followed in CollationTest2, but it does things a little differently (it lumps many tests together into one bigger test method).&lt;/p&gt;

&lt;p&gt;Committed patch 1a to trunk with revision 1243878.&lt;br/&gt;
I&apos;ll leave this issue open for backporting.&lt;/p&gt;</comment>
                            <comment id="13214413" author="kristwaa" created="Thu, 23 Feb 2012 07:23:29 +0000"  >&lt;p&gt;Merged fix to 10.8 with revision 1292681, and to the 10.7 branch with revision 1292682.&lt;br/&gt;
Resolving as fixed.&lt;/p&gt;</comment>
                            <comment id="13823406" author="knutanders" created="Fri, 15 Nov 2013 08:15:10 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update: close all resolved issues that haven&amp;#39;t had any activity the last year&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12514362" name="derby-5530-1a-propagate_collation_info.diff" size="4250" author="kristwaa" created="Mon, 13 Feb 2012 15:15:07 +0000"/>
                            <attachment id="12514073" name="repro-debug.log" size="6163" author="dagw" created="Fri, 10 Feb 2012 04:18:37 +0000"/>
                            <attachment id="12514072" name="repro.log" size="9483" author="dagw" created="Fri, 10 Feb 2012 04:14:29 +0000"/>
                            <attachment id="12514071" name="repro.sh" size="405" author="dagw" created="Fri, 10 Feb 2012 04:14:29 +0000"/>
                            <attachment id="12514022" name="script.sh" size="358" author="dagw" created="Thu, 9 Feb 2012 22:31:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 2 Feb 2012 10:47:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220408</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    <customfieldvalue key="10427"><![CDATA[Workaround attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0d13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35929</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>