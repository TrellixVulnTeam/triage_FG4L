<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:44:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-649/DERBY-649.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-649] Useful indexes not used in UNION ALL</title>
                <link>https://issues.apache.org/jira/browse/DERBY-649</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Frederic Moreau reports (&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/200510.mbox/browser):&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/200510.mbox/browser):&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;The optimizer does not take my indexes into account when I do a select on &lt;br/&gt;
a &apos;UNION ALL&apos; type of view ; therefore, table scans are done and &lt;br/&gt;
performances are bad.&lt;/p&gt;

&lt;p&gt;Note : my indexes are taken into account if I try equivalent selects on &lt;br/&gt;
tables (instead of views).&lt;/p&gt;

&lt;p&gt;Please find below a sample illustrating the problem using the &lt;br/&gt;
RUNTIMESTATISTICS calls.&lt;/p&gt;

&lt;p&gt;Could anynone help me on this subject ?&lt;br/&gt;
Thank you.&lt;/p&gt;


&lt;p&gt;My cloudscape version is the 10.0.2.1 one.&lt;br/&gt;
I also tried it on the 10.1.1.0 version (same result).&lt;/p&gt;

&lt;p&gt;  c:\&amp;gt;java -classpath &lt;br/&gt;
&quot;%CLOUDSCAPE_INSTALL%\lib\derbyclient.jar;%CLOUDSCAPE_INSTALL%\lib\derbytools.jar&quot; &lt;br/&gt;
-Dij.driver=org.apache.derby.jdbc.ClientDriver &lt;br/&gt;
-Dij.protocol=jdbc:derby://localhost:1527/ -Dij.user=APP -Dij.password=APP &lt;br/&gt;
-Dij.maximumDisplayWidth=32768 org.apache.derby.tools.ij  ij&amp;gt; connect &lt;br/&gt;
&apos;testdb&apos; ;&lt;/p&gt;

&lt;p&gt;  ij&amp;gt; ;&lt;br/&gt;
  ij&amp;gt; create table test.table1(a integer, b integer, c integer);&lt;br/&gt;
  ij&amp;gt; create index test.table1idx on test.table1(b);&lt;br/&gt;
  ij&amp;gt; ;&lt;br/&gt;
  ij&amp;gt; create table test.table2(a integer, b integer, c integer);&lt;br/&gt;
  ij&amp;gt; create index test.table2idx on test.table2(b);&lt;br/&gt;
  ij&amp;gt; ;&lt;br/&gt;
  ij&amp;gt; create view test.view0 as select all a,b from test.table1 union all &lt;br/&gt;
select a,b from test.table2;&lt;br/&gt;
  ij&amp;gt; ;&lt;br/&gt;
  ij&amp;gt; CALL SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS(1);&lt;br/&gt;
  ij&amp;gt; select a from test.table1 where b=25;&lt;br/&gt;
  ij&amp;gt; VALUES SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS();&lt;br/&gt;
        ...&lt;br/&gt;
        Index Scan ResultSet for TABLE1 using index TABLE1IDX at read &lt;br/&gt;
committed isolation level using instantaneous share row locking chosen by &lt;br/&gt;
the optimizer&lt;br/&gt;
        ...&lt;br/&gt;
  ij&amp;gt; select a from test.table2 where b=25;&lt;br/&gt;
  ij&amp;gt; VALUES SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS();&lt;br/&gt;
        ...&lt;br/&gt;
        Index Scan ResultSet for TABLE2 using index TABLE2IDX at read &lt;br/&gt;
committed isolation level using instantaneous share row locking chosen by &lt;br/&gt;
the optimizer&lt;br/&gt;
        ...&lt;br/&gt;
  ij&amp;gt; select a from test.view0 where b=25;&lt;br/&gt;
  ij&amp;gt; VALUES SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS();&lt;br/&gt;
        ...&lt;br/&gt;
        Table Scan ResultSet for TABLE1 at read committed isolation level &lt;br/&gt;
using share row locking chosen by the optimizer&lt;br/&gt;
        ...&lt;br/&gt;
        Table Scan ResultSet for TABLE2 at read committed isolation level &lt;br/&gt;
using share row locking chosen by the optimizer&lt;br/&gt;
        ...&lt;br/&gt;
  ij&amp;gt; ;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12325048">DERBY-649</key>
            <summary>Useful indexes not used in UNION ALL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Oct 2005 23:48:14 +0100</created>
                <updated>Sat, 1 Jul 2006 09:26:38 +0100</updated>
                            <resolved>Tue, 25 Apr 2006 04:46:08 +0100</resolved>
                                                    <fixVersion>10.1.3.1</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="12356000" author="jeff_lichtman" created="Thu, 27 Oct 2005 04:16:18 +0100"  >&lt;p&gt;The problem is probably that the qualification is not being pushed down into the union. In the example script, the select from the view is expanded to:&lt;/p&gt;

&lt;p&gt;select a from (select all a,b from test.table1 union all&lt;br/&gt;
select a,b from test.table2) tab where b = 25&lt;/p&gt;

&lt;p&gt;After this expansion, the compilation phase should push the qualification down into the union:&lt;/p&gt;

&lt;p&gt;select a from (select all a,b from test.table1 where b = 25 union all&lt;br/&gt;
select a,b from test.table2 where b = 25) tab&lt;/p&gt;

&lt;p&gt;This should probably happen in the preprocessing phase.&lt;/p&gt;</comment>
                            <comment id="12358885" author="bandaram" created="Wed, 30 Nov 2005 17:08:26 +0000"  >&lt;p&gt;I am trying to address this problem by trying to push predicates into UNION. For now, I am not handling the cases where the select list may have expressions and handling only simple column references. I am attempting to push predicates into both left and right ResultSets, much like PredicateList.pushExpressionsIntoSelect handles the case of single SelectNodes. Does this sound like a reasonable approach?&lt;/p&gt;

&lt;p&gt;My initial attempts don&apos;t seem to make the query use the index... I suspect I am not correctly remapping column references once pushed inside the selects. &lt;/p&gt;</comment>
                            <comment id="12360485" author="bandaram" created="Thu, 15 Dec 2005 15:17:09 +0000"  >&lt;p&gt;I have a patch for this bug. While I am still testing it, I would appreciate any comments about my approach. I have a customer who is hurting a lot because of this bug. Once complete, I would like to put this fix into both 10.1.x and trunk versions.&lt;/p&gt;

&lt;p&gt;I have implemented a simpler solution to address this optimization for some cases where predicates are of the form &amp;lt;ColumnReference&amp;gt; &amp;lt;RELOP&amp;gt; &amp;lt;constant&amp;gt;. These causes really benifit the most by pushing predicates down these into inner selects of union, since that would enable optimizer to use applicable indexes on them.&lt;/p&gt;

&lt;p&gt;I will also enhance this patch to make it more generic for trunk later.&lt;/p&gt;</comment>
                            <comment id="12360486" author="bandaram" created="Thu, 15 Dec 2005 15:18:23 +0000"  >&lt;p&gt;First version of the patch. I am still testing and enhancing the patch. Appreciate any comments.&lt;/p&gt;</comment>
                            <comment id="12360982" author="djd" created="Wed, 21 Dec 2005 06:16:48 +0000"  >&lt;p&gt;-1 on the patch, causes a regression. Will also vote -1 on the subsequent patch for 772 as it is dependent on this patch.&lt;/p&gt;

&lt;p&gt;Run this simple script, at svn revision 357054 the output is expected including the&lt;br/&gt;
two argument IN clause on the select from the view returning two rows.&lt;br/&gt;
Once this patch is applied, svn revision 357105, that select returns no rows.&lt;/p&gt;

&lt;p&gt;DROP VIEW V1;&lt;br/&gt;
DROP TABLE D1;&lt;br/&gt;
CREATE TABLE D1 (A INT, B VARCHAR(4) FOR BIT DATA);&lt;/p&gt;

&lt;p&gt;INSERT INTO D1 VALUES (1, x&apos;600Eaaef&apos;) ; &lt;br/&gt;
INSERT INTO D1 VALUES (2, x&apos;83452213&apos;) ; &lt;/p&gt;

&lt;p&gt;select * from D1 where B IN (x&apos;600Eaaef&apos;,x&apos;83452213&apos;) ;  &lt;br/&gt;
select * from D1 where B IN (x&apos;83452213&apos;) ; &lt;br/&gt;
select * from D1 where B  IN (x&apos;600Eaaef&apos;) ; &lt;/p&gt;

&lt;p&gt;CREATE VIEW V1 AS SELECT A,B FROM D1 UNION SELECT A,B FROM D1;&lt;/p&gt;

&lt;p&gt;SELECT * FROM V1;&lt;/p&gt;

&lt;p&gt;&amp;#8211; this fails! returns no rows&lt;br/&gt;
select * from V1 where B IN (x&apos;600Eaaef&apos;,x&apos;83452213&apos;) ;  &lt;br/&gt;
select * from V1 where B IN (x&apos;83452213&apos;) ; &lt;br/&gt;
select * from V1 where B  IN (x&apos;600Eaaef&apos;) ; &lt;/p&gt;</comment>
                            <comment id="12360997" author="djd" created="Wed, 21 Dec 2005 08:50:01 +0000"  >&lt;p&gt;I think I&apos;ve found the bug in the patch. I&apos;d appreciate any optimizer experts looking at this.&lt;/p&gt;

&lt;p&gt;In PredicateList.pushExpressionsIntoSelect when the predicate is copied, any type of binary relational node can be copied, but the new relational node create is always an quality node, it is not based upon the type being pushed.&lt;/p&gt;

&lt;p&gt;I&apos;m replacing this code, difference is first argument to getNode() :&lt;br/&gt;
around line 1438 - changes would also be made to te variable name, to correctly represent its use.&lt;/p&gt;

&lt;p&gt;				BinaryRelationalOperatorNode newEquals = (BinaryRelationalOperatorNode)&lt;br/&gt;
							getNodeFactory().getNode(&lt;br/&gt;
										C_NodeTypes.BINARY_EQUALS_OPERATOR_NODE,&lt;br/&gt;
										newCRNode,&lt;br/&gt;
										opNode.getRightOperand(),&lt;br/&gt;
										getContextManager());&lt;/p&gt;

&lt;p&gt;with&lt;/p&gt;

&lt;p&gt;				BinaryRelationalOperatorNode newEquals = (BinaryRelationalOperatorNode)&lt;br/&gt;
							getNodeFactory().getNode(&lt;br/&gt;
									    opNode.getNodeType(),&lt;br/&gt;
										newCRNode,&lt;br/&gt;
										opNode.getRightOperand(),&lt;br/&gt;
										getContextManager());&lt;/p&gt;

&lt;p&gt;I&apos;d incorrectly assumed in the review that the (incorrect) new equality node was related to the boolean constant TRUE being created. So sort of &apos;(pushed expression) = TRUE&apos; was being pushed and required for some reason. I knew there was a good reason I&apos;d asked for comments on this code section:&lt;/p&gt;

&lt;p&gt;&amp;gt; Dec 15th 08:19&lt;br/&gt;
&amp;gt; For example, why do we need a new nodes that&lt;br/&gt;
&amp;gt; represent &apos;= TRUE&apos;, I&apos;m sure it&apos;s required but to a reader of the code&lt;br/&gt;
it&apos;s not obvious why.&lt;/p&gt;</comment>
                            <comment id="12361005" author="rhillegas" created="Wed, 21 Dec 2005 09:52:38 +0000"  >&lt;p&gt;Hi Dan, your fix looks good. I would be tempted to sand it down a bit: Since the new relational operator could be something other than &quot;==&quot;, you might want to call it &quot;newRelop&quot; rather than &quot;newEquals&quot;.&lt;/p&gt;</comment>
                            <comment id="12361063" author="djd" created="Thu, 22 Dec 2005 04:27:01 +0000"  >&lt;p&gt;Submiited a modified version of the patch thus removing my veto for this and the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-772&quot; title=&quot;Handle pushing IN predicates into UNIONs. This would allow use of index if present improving performance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-772&quot;&gt;&lt;del&gt;DERBY-772&lt;/del&gt;&lt;/a&gt; patch.&lt;/p&gt;</comment>
                            <comment id="12363153" author="bandaram" created="Thu, 19 Jan 2006 05:23:44 +0000"  >&lt;p&gt;Fix ported from 10.1 branch to trunk.&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\sql\compile\PredicateList.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\ProjectRestrictNode.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\SelectNode.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\sql\compile\UnionNode.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\predicatesIntoViews.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\predicatesIntoViews.sql&lt;br/&gt;
Transmitting file data ......&lt;br/&gt;
Committed revision 370247.&lt;/p&gt;</comment>
                            <comment id="12363169" author="bandaram" created="Thu, 19 Jan 2006 06:41:20 +0000"  >&lt;p&gt;Fix checked into both 10.1 and trunk.&lt;/p&gt;</comment>
                            <comment id="12363170" author="bandaram" created="Thu, 19 Jan 2006 06:41:50 +0000"  >&lt;p&gt;Fix has been verified against customer database and query on 10.2 and 10.1.&lt;/p&gt;</comment>
                            <comment id="12376099" author="fuzzylogic" created="Tue, 25 Apr 2006 04:35:36 +0100"  >&lt;p&gt;Reopening to set Fix In to 10.1.3 also.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12321341" name="DERBY-649.patch" size="32190" author="bandaram" created="Thu, 15 Dec 2005 15:18:23 +0000"/>
                            <attachment id="12321340" name="DERBY-649.stat" size="475" author="bandaram" created="Thu, 15 Dec 2005 15:18:23 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12326846">DERBY-772</subtask>
                            <subtask id="12327025">DERBY-784</subtask>
                            <subtask id="12327441">DERBY-805</subtask>
                            <subtask id="12329735">DERBY-1073</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 27 Oct 2005 03:16:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22070</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy15xz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40613</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>