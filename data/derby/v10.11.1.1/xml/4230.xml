<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:36:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4230/DERBY-4230.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4230] DatabaseMetaData.getColumns() returns extra column from view with group by and  expression in SELECT list</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4230</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;DatabaseMetaData.getColumns() returns an extra column for a view with a group by and an expression in the select list.  I will attach the reproduction. Run the script create.sql and then the program ViewTest.&lt;/p&gt;

&lt;p&gt;This is a regression in version 10.3, It ran ok on latest on the 10.1 and 10.2 branches.&lt;/p&gt;

&lt;p&gt;The ResultSetMetaData appears to return the correct number of columns  when you select from the view, but it would be nice to add a regression test for that too.&lt;/p&gt;

&lt;p&gt;See discussion on derby-dev.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/extra-column-in-DatabaseMetaData.getColumns()-with-group-by-in-view-td23545576.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/extra-column-in-DatabaseMetaData.getColumns()-with-group-by-in-view-td23545576.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12425514">DERBY-4230</key>
            <summary>DatabaseMetaData.getColumns() returns extra column from view with group by and  expression in SELECT list</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kmarsden">Kathey Marsden</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 May 2009 21:16:01 +0100</created>
                <updated>Thu, 16 Jul 2009 22:24:27 +0100</updated>
                            <resolved>Sat, 30 May 2009 15:01:54 +0100</resolved>
                                    <version>10.3.2.1</version>
                                    <fixVersion>10.3.3.1</fixVersion>
                    <fixVersion>10.4.2.1</fixVersion>
                    <fixVersion>10.5.2.0</fixVersion>
                    <fixVersion>10.6.1.0</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12709611" author="kmarsden" created="Thu, 14 May 2009 23:21:14 +0100"  >&lt;p&gt;One thing to note that the problem seems to occur on view creation, so  SYS.SYSCOLUMS is incorrect.  This means &lt;br/&gt;
1) If the view  was originally created with version 10.2 or lower, the bug won&apos;t manifest itself after soft or hard upgrade to 10.3 or higher.&lt;br/&gt;
2) I think when we fix this issue, users who created their views with 10.3 or higher will have to drop and recreate the view to see the fix.&lt;/p&gt;</comment>
                            <comment id="12710548" author="kmarsden" created="Tue, 19 May 2009 01:06:56 +0100"  >&lt;p&gt;This problem was introduced with the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt; (svn revision 516454)&lt;/p&gt;</comment>
                            <comment id="12710859" author="kmarsden" created="Tue, 19 May 2009 21:17:11 +0100"  >&lt;p&gt;Here is my initial attempt at a fix for this issue. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4230&quot; title=&quot;DatabaseMetaData.getColumns() returns extra column from view with group by and  expression in SELECT list&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4230&quot;&gt;&lt;del&gt;DERBY-4230&lt;/del&gt;&lt;/a&gt;_preview_diff.txt.  This is &lt;b&gt;not&lt;/b&gt; for commit as I still need to add a regression test and run tests.  I just thought I would put it out there to make sure I am on the right track.&lt;/p&gt;

&lt;p&gt;The code that defines the columns for insert in to SYS.SYSCOLUMNS was including the generated columns. I changed it so that it no longer includes the generated columns and the test case passes.  Are the SYS.SYSCOLUMN entries for views only used for DatabaseMetaData.getColumns()  or is there some other use that might need the generated columns to be there?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;</comment>
                            <comment id="12710968" author="kmarsden" created="Wed, 20 May 2009 02:53:25 +0100"  >&lt;p&gt;Attached is a patch for this issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4230&quot; title=&quot;DatabaseMetaData.getColumns() returns extra column from view with group by and  expression in SELECT list&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4230&quot;&gt;&lt;del&gt;DERBY-4230&lt;/del&gt;&lt;/a&gt;_diff.txt) It is the same as the preview patch, but also has a test added.  I ran suites.All and derbyall which passed except for known intermittent issues.&lt;/p&gt;

&lt;p&gt;Please review!&lt;/p&gt;
</comment>
                            <comment id="12710969" author="kmarsden" created="Wed, 20 May 2009 02:54:47 +0100"  >&lt;p&gt;Marking patch available and release note needed since users will have to drop and recreate their  impacted view if it was created with a version of Derby with the bug.  I will attach a release note soon.&lt;/p&gt;</comment>
                            <comment id="12711071" author="knutanders" created="Wed, 20 May 2009 10:07:16 +0100"  >&lt;p&gt;The changes look reasonable to me. I know other regressions caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-681&quot; title=&quot;Eliminate the parser&amp;#39;s rewriting of the abstract syntax tree for queries with GROUP BY and/or HAVING clauses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-681&quot;&gt;&lt;del&gt;DERBY-681&lt;/del&gt;&lt;/a&gt; have been fixed in a similar way (size() -&amp;gt; visibleSize()).&lt;/p&gt;

&lt;p&gt;I wonder if it would be better in genColumnInfos() to use rcl.visibleSize() (or perhaps colInfos.length) as stop condition for the loop and skip the rc.isGenerated test. It&apos;s simpler and then this code should automatically work if we later allow ORDER BY in CREATE VIEW.&lt;/p&gt;</comment>
                            <comment id="12711117" author="kmarsden" created="Wed, 20 May 2009 13:26:10 +0100"  >&lt;p&gt;Thanks Knut for the review. You said:&lt;br/&gt;
&amp;gt;I wonder if it would be better in genColumnInfos() to use rcl.visibleSize() (or &amp;gt;perhaps colInfos.length) as stop condition for the loop and skip the &amp;gt;rc.isGenerated test.&lt;/p&gt;

&lt;p&gt;Are the generated columns always guaranteed to come at the end?  If so I will make this change and post a new patch.&lt;/p&gt;
</comment>
                            <comment id="12711138" author="knutanders" created="Wed, 20 May 2009 14:33:38 +0100"  >&lt;p&gt;Hmm... I thought all visible columns were guaranteed to come before the non-visible ones, but looking at the comments in the code I can only find this explicitly stated for order by columns and not for group by columns. A quick usage search for visibleSize() indicates that some of the callers have this as an assumption, though.&lt;/p&gt;</comment>
                            <comment id="12711242" author="kmarsden" created="Wed, 20 May 2009 18:20:59 +0100"  >&lt;p&gt;Anyone else have opinions on this?  I am inclined to leave the change as is if we are not sure.&lt;/p&gt;</comment>
                            <comment id="12711596" author="kmarsden" created="Thu, 21 May 2009 13:26:56 +0100"  >&lt;p&gt;I spoke to Army and he wasn&apos;t sure whether the generated columns always come at the end. I think I will commit the original proposed fix, (iterating over all the columns and eliminating the generated ones) to be on the safe side.   I will do this later today if I hear no objections.&lt;/p&gt;</comment>
                            <comment id="12712038" author="knutanders" created="Fri, 22 May 2009 12:36:45 +0100"  >&lt;p&gt;Sounds fine. The problem with ORDER BY columns can be addressed when/if we allow ORDER BY in CREATE VIEW.&lt;/p&gt;</comment>
                            <comment id="12712069" author="kmarsden" created="Fri, 22 May 2009 13:52:23 +0100"  >&lt;p&gt;Thanks Knut. Committed revision 777500.  Is there an issue for CREATE VIEW with ORDER BY?   I couldn&apos;t find it with a quick Jira search.  I would like to add a comment referencing your comments in this issue regarding ORDER BY.&lt;/p&gt;

&lt;p&gt;I will leave this issue open while I backport to 10.5,10.4, and 10.3.&lt;/p&gt;</comment>
                            <comment id="12712109" author="knutanders" created="Fri, 22 May 2009 15:33:58 +0100"  >&lt;p&gt;I don&apos;t think there is an issue for it. Now that SQL:2008 allows ORDER BY in subqueries, it&apos;s more likely that we&apos;ll allow it for CREATE VIEW too (there&apos;s no issue for ORDER BY in subqueries either, I think).&lt;/p&gt;

&lt;p&gt;By the way, even without changing size() to visibleSize(), isn&apos;t the patch already assuming that the generated columns are at the end? If one of the generated columns appear at an index &amp;lt; visibleSize(), the corresponding colInfos&lt;span class=&quot;error&quot;&gt;&amp;#91;index&amp;#93;&lt;/span&gt; entry will be left blank, and when we come to a generated column with index &amp;gt;= visibleSize(), colInfos&lt;span class=&quot;error&quot;&gt;&amp;#91;index&amp;#93;&lt;/span&gt; will throw ArrayIndexOutOfBoundsException.&lt;/p&gt;</comment>
                            <comment id="12712131" author="kmarsden" created="Fri, 22 May 2009 16:09:26 +0100"  >&lt;p&gt;Ah, good point.  I guess I should have kept a separate counter for the colInfos index.  Should I do that or go with your to original suggestion to keep the assumption and use  colInfos.length?&lt;/p&gt;

&lt;p&gt;I want to get this right before I backport but there is some urgency for the user who encountered this issue, so I would like to get this resolved today if possible.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;


</comment>
                            <comment id="12712310" author="kmarsden" created="Sat, 23 May 2009 00:40:24 +0100"  >&lt;p&gt;Here is a follow up patch for this issue .  derby-4230_diff2.txt. It uses colInfos.length for the loop  as Knut orignally suggested, making the assumption that the generated columns come at the end.  Added a comment and an assertion if we are wrong in this assumption and hit a generated column in the expected visible range.&lt;/p&gt;

&lt;p&gt;I ran lang.ViewsTest but haven&apos;t run the full regression suite yet.&lt;/p&gt;</comment>
                            <comment id="12712393" author="knutanders" created="Sat, 23 May 2009 10:19:41 +0100"  >&lt;p&gt;Thanks Kathey. Adding an assert and a comment to make the assumption explicit is a good change. If we want an assert that&apos;s more likely to expose that generated grouping columns are in the visible range, RCL.numGeneratedColumns() is probably executed for a larger set of queries than CreateViewNode.&lt;/p&gt;

&lt;p&gt;(nit: trailing whitespace was added on the rcl=getResultColumns() line)&lt;/p&gt;</comment>
                            <comment id="12713160" author="kmarsden" created="Tue, 26 May 2009 18:53:47 +0100"  >&lt;p&gt;Thanks Knut for the comment. I put the assertion in numGeneratedColumns() to verify that the generated columns come at the end of the list. I will run tests and see if it finds anything and I think just keep that assertion in there too with my checkin.&lt;/p&gt;</comment>
                            <comment id="12713759" author="kmarsden" created="Wed, 27 May 2009 22:39:45 +0100"  >&lt;p&gt;Committed to trunk  revision 779319.  I will leave open while I backport to 10.5,10.4, and 10.3.&lt;/p&gt;
</comment>
                            <comment id="12714723" author="kmarsden" created="Sat, 30 May 2009 15:00:59 +0100"  >&lt;p&gt;Attaching release note.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12325311">DERBY-681</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12408545" name="DERBY-4230_diff.txt" size="4125" author="kmarsden" created="Wed, 20 May 2009 02:53:25 +0100"/>
                            <attachment id="12408508" name="DERBY-4230_preview_diff.txt" size="979" author="kmarsden" created="Tue, 19 May 2009 21:17:11 +0100"/>
                            <attachment id="12408178" name="ViewTest.java" size="1420" author="kmarsden" created="Thu, 14 May 2009 21:17:09 +0100"/>
                            <attachment id="12408179" name="create.sql" size="277" author="kmarsden" created="Thu, 14 May 2009 21:17:09 +0100"/>
                            <attachment id="12408855" name="derby-4230_diff2.txt" size="1399" author="kmarsden" created="Sat, 23 May 2009 00:40:23 +0100"/>
                            <attachment id="12409466" name="releaseNote.html" size="4119" author="kmarsden" created="Sat, 30 May 2009 15:00:59 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 20 May 2009 09:07:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24117</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0s2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38366</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>