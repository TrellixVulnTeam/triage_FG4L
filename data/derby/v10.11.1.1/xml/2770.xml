<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:46:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2770/DERBY-2770.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2770] testBlobAfterCommit(....jdbcapi.BlobClob4BlobTest) fails with &apos;Unexpected SQL state. expected:&lt;XJ[073]&gt; but was:&lt;XJ[215]&gt;&apos;</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2770</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;testBlobAfterCommit(org.apache.derbyTesting.functionTests.tests.jdbcapi.BlobClob4BlobTest)junit.framework.ComparisonFailure: Unexpected SQL state. expected:&amp;lt;XJ&lt;span class=&quot;error&quot;&gt;&amp;#91;073&amp;#93;&lt;/span&gt;&amp;gt; but was:&amp;lt;XJ&lt;span class=&quot;error&quot;&gt;&amp;#91;215&amp;#93;&lt;/span&gt;&amp;gt;&lt;br/&gt;
after &lt;br/&gt;
r544777 / &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2729&quot; title=&quot;temporary lob file should be cleaned when the transaction or connection is no longer valid.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2729&quot;&gt;&lt;del&gt;DERBY-2729&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/544778-org.apache.derbyTesting.functionTests.suites.All_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/544778-org.apache.derbyTesting.functionTests.suites.All_diff.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment>OS: Solaris 10 6/06 s10x_u2wos_09a X86 64bits - SunOS 5.10 Generic_118855-14&lt;br/&gt;
JVM: Sun Microsystems Inc. 1.6.0_01-b06</environment>
        <key id="12371037">DERBY-2770</key>
            <summary>testBlobAfterCommit(....jdbcapi.BlobClob4BlobTest) fails with &apos;Unexpected SQL state. expected:&lt;XJ[073]&gt; but was:&lt;XJ[215]&gt;&apos;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="oysteing">&#216;ystein Gr&#248;vlen</assignee>
                                    <reporter username="olesolberg">Ole Solberg</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Jun 2007 14:36:08 +0100</created>
                <updated>Tue, 30 Jun 2009 16:55:43 +0100</updated>
                            <resolved>Wed, 13 Jun 2007 15:21:25 +0100</resolved>
                                    <version>10.3.1.4</version>
                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12501941" author="kristwaa" created="Wed, 6 Jun 2007 15:43:36 +0100"  >&lt;p&gt;&apos;derby-2770-1a.diff&apos; changes the BlobClob4Blob test to not fail. The test failed because the SQL state was changed, possibly the location where the error checking is done changed.&lt;/p&gt;

&lt;p&gt;As part of looking into this issue I discovered that the client reports another SQLState when accessing Blobs after commit, see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2771&quot; title=&quot;Unhelpful error message provided when accesing Blob after commit in the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2771&quot;&gt;&lt;del&gt;DERBY-2771&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I request a review from someone familiar with Blob and locators in the client for this patch.&lt;br/&gt;
After applying the patch, BlobClob4Blob runs without failures.&lt;/p&gt;

&lt;p&gt;As the changes is in the test only and basically localized to one test method, I&apos;m committing the preliminary patch now to stop the tests from failing. It can easily be reverted, and I believe the test has to change anyway if/when &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2771&quot; title=&quot;Unhelpful error message provided when accesing Blob after commit in the client driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2771&quot;&gt;&lt;del&gt;DERBY-2771&lt;/del&gt;&lt;/a&gt; is addressed.&lt;/p&gt;</comment>
                            <comment id="12501943" author="kristwaa" created="Wed, 6 Jun 2007 15:46:58 +0100"  >&lt;p&gt;Committed 1a to trunk with revision 544856.&lt;/p&gt;</comment>
                            <comment id="12502234" author="narayanan" created="Thu, 7 Jun 2007 07:32:29 +0100"  >&lt;p&gt;Thank you for looking into this and fixing the tests&lt;/p&gt;

&lt;p&gt;I am a little worried about this, more so probably because I get&lt;br/&gt;
contrasting results with a small test program I wrote&lt;/p&gt;

&lt;p&gt;Should&apos;nt the following series of tests produce the same result of this test?&lt;/p&gt;

&lt;p&gt;1) Get a connection to the network server (con)&lt;br/&gt;
2) Get a empty Clob or Blob (con.createClob() or con.createBlob())&lt;br/&gt;
3) do a con.commit()&lt;br/&gt;
4) call length on the Clob or Blob(clob.length() or blob.length())&lt;/p&gt;

&lt;p&gt;I get the same SQLState for the exception in both&lt;br/&gt;
the cases  with an SQLState of XJ073. Maybe I missed something&lt;br/&gt;
while writing the program because I wrote the program in a hurry.&lt;/p&gt;

&lt;p&gt;Why is testClobAfterCommit() not failing? Locators have been enabled&lt;br/&gt;
for Clob too why hasn&apos;t it failed.&lt;/p&gt;

&lt;p&gt;I am surely missing something really simple I think.&lt;/p&gt;

&lt;p&gt;I will attach the test program also, so that in case I have made some&lt;br/&gt;
mistake there you can point it out.&lt;/p&gt;</comment>
                            <comment id="12502236" author="narayanan" created="Thu, 7 Jun 2007 07:36:53 +0100"  >&lt;p&gt;I used the above test program. I wrote it in a hurry.&lt;br/&gt;
Pls forgive any silly mistakes you see.&lt;/p&gt;</comment>
                            <comment id="12502278" author="knutanders" created="Thu, 7 Jun 2007 10:21:11 +0100"  >&lt;p&gt;Just guessing here, but I noticed this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;both BLOBCREATELOCATOR and CLOBCREATELOCATOR call addLOBMapping&lt;/li&gt;
	&lt;li&gt;EmbedBlob&apos;s constructors call addLOBMapping, but EmbedClob&apos;s constructors don&apos;t&lt;/li&gt;
	&lt;li&gt;Narayanan&apos;s test uses createBlob()/createClob(), hence addLOBMapping is always called&lt;/li&gt;
	&lt;li&gt;testBlobAfterCommit() and testClobAfterCommit() get the lobs from ResultSet.get&lt;span class=&quot;error&quot;&gt;&amp;#91;BC&amp;#93;&lt;/span&gt;lob(), hence addLOBMapping is only called for the BLOB test&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12502281" author="oysteing" created="Thu, 7 Jun 2007 10:29:46 +0100"  >&lt;p&gt;This problem is caused by the check-in of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2729&quot; title=&quot;temporary lob file should be cleaned when the transaction or connection is no longer valid.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2729&quot;&gt;&lt;del&gt;DERBY-2729&lt;/del&gt;&lt;/a&gt;, and Anurag says in that report that it only changes things for Blob, and that a Clob patch will come later.  I think that answer&apos;s Narayanan question about why the error only happens for Blob.&lt;/p&gt;

</comment>
                            <comment id="12502283" author="kristwaa" created="Thu, 7 Jun 2007 10:32:31 +0100"  >&lt;p&gt;I modified Narayanans test program to fetch the Blob from a resultset. It still works correctly and provokes the XJ073 error.&lt;br/&gt;
However, the BlobClob4Blob test do still run without failures when expecting XJ217.&lt;/p&gt;

&lt;p&gt;Maybe we could have a look at the stack traces for the two cases?&lt;br/&gt;
Is the test doing something in a special manner?&lt;/p&gt;

&lt;p&gt;I would also use this opportunity to suggest that in near future the BlobClob4Blob test should be rewritten or split into several test classes. It is ~3200 lines long... That said, I think it has lots of good tests!&lt;/p&gt;</comment>
                            <comment id="12502284" author="narayanan" created="Thu, 7 Jun 2007 10:40:27 +0100"  >&lt;p&gt;Yes, I tried this too, I agree I saw similar behaviour. Does this have &lt;br/&gt;
anything to do with the size of the Blob fetched or&lt;br/&gt;
whether it is materialized or not ?&lt;/p&gt;


</comment>
                            <comment id="12502301" author="anurag" created="Thu, 7 Jun 2007 11:56:46 +0100"  >&lt;p&gt;assertException checks for SQLState in nested exception. One of the exception received using getNextException has sql state set to XJ217.&lt;/p&gt;


&lt;p&gt;I added following code to catch block of Narayanan&apos;s code&lt;br/&gt;
            while (sqle != null) &lt;/p&gt;
{
                System.out.println(&quot;THE EXCEPTION SQLSTATE IS =&quot; + sqle.getSQLState());
                sqle = sqle.getNextException();
            }

&lt;p&gt;It outputs &lt;/p&gt;

&lt;p&gt;THE EXCEPTION SQLSTATE IS =XJ073&lt;br/&gt;
THE EXCEPTION SQLSTATE IS =38000&lt;br/&gt;
THE EXCEPTION SQLSTATE IS =XJ217&lt;/p&gt;</comment>
                            <comment id="12502304" author="oysteing" created="Thu, 7 Jun 2007 12:19:49 +0100"  >&lt;p&gt;Thanks, Anurag, that explains it.&lt;br/&gt;
So the correct fix is not to assert on XJ217, but on XJ073.&lt;br/&gt;
Or better, change XJ073 to match the error code used for embedded.&lt;/p&gt;</comment>
                            <comment id="12502310" author="oysteing" created="Thu, 7 Jun 2007 12:48:26 +0100"  >&lt;p&gt;Maybe not, I think I am still confused.  The test used to test for XJ073, but that evidently did not work.&lt;br/&gt;
As far as I can see assertException will be satisfied as long as at least one of the states in the exception chain matches.&lt;/p&gt;</comment>
                            <comment id="12502313" author="knutanders" created="Thu, 7 Jun 2007 13:05:59 +0100"  >&lt;p&gt;assertSQLState() succeeds if the main SQLException or its next exception matches. It doesn&apos;t traverse the entire chain.&lt;/p&gt;</comment>
                            <comment id="12502315" author="oysteing" created="Thu, 7 Jun 2007 13:08:39 +0100"  >&lt;p&gt;If you look at the original problem reported by Ole, it was just tests of embedded that failed.&lt;br/&gt;
The changes to the test for client/server does not seem to be necessary.  It happens that the exception chaing (as pointed out by Anurag) contains both XJ073 and XJ217 so testing for any of them would work.&lt;/p&gt;</comment>
                            <comment id="12502316" author="knutanders" created="Thu, 7 Jun 2007 13:10:28 +0100"  >&lt;p&gt;Sorry, my last comment was wrong. assertSQLState() &lt;b&gt;does&lt;/b&gt; traverse the entire chain.&lt;/p&gt;</comment>
                            <comment id="12502342" author="narayanan" created="Thu, 7 Jun 2007 14:41:14 +0100"  >&lt;p&gt;I changed the test to check for BLOB_ACCESSED_AFTER_COMMIT.&lt;br/&gt;
It seems to work fine.&lt;/p&gt;

&lt;p&gt;I think this explains that the SQLState returned by client remains&lt;br/&gt;
unaffected&lt;/p&gt;</comment>
                            <comment id="12502386" author="oysteing" created="Thu, 7 Jun 2007 16:28:54 +0100"  >&lt;p&gt;Attached file, derby-2770-2b.diff, changes the client to used the same&lt;br/&gt;
SQL state as embedded for Blobs accessed after transaction has&lt;br/&gt;
committed.  Since Clob has yet to get the new behavior, there will now&lt;br/&gt;
be a difference between client and embedded for Clobs.  However, I&lt;br/&gt;
expect that to be fixed by Anurag when it posts his corresponding&lt;br/&gt;
patch for Blob.&lt;/p&gt;

&lt;p&gt;The following files are changed by this patch:&lt;br/&gt;
M      java/engine/org/apache/derby/loc/messages.xml&lt;br/&gt;
   Changed error message to reflect that XJ215 is used both after&lt;br/&gt;
   free() has been called on a Lob and after the lob&apos;s transaction has&lt;br/&gt;
   been committed.&lt;/p&gt;

&lt;p&gt;M      java/client/org/apache/derby/client/am/CallableLocatorProcedures.java&lt;br/&gt;
   Change SQL state to use when locators are invalid from XJ073 to&lt;br/&gt;
   XJ215.  Also, Knut Anders has since this method was created, made&lt;br/&gt;
   nested exceptions with SQL state available on the client.  Hence,&lt;br/&gt;
   we can now check for SQL state directly instead resorting to text&lt;br/&gt;
   search of error messages.&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/BlobClob4BlobTest.java&lt;br/&gt;
   Change tests to except the changed SQL state for access after&lt;br/&gt;
   commit.&lt;/p&gt;</comment>
                            <comment id="12502707" author="oysteing" created="Fri, 8 Jun 2007 08:45:34 +0100"  >&lt;p&gt;Junit All suite and derbyall ran without errors (except the upgrade test which I have not set up correctly).&lt;/p&gt;</comment>
                            <comment id="12503190" author="knutanders" created="Sun, 10 Jun 2007 18:25:29 +0100"  >&lt;p&gt;Committed derby-2770-2b.diff with revision 545910.&lt;/p&gt;

&lt;p&gt;I noticed that there are many comments in BlobClob4BlobTest that say&lt;/p&gt;

&lt;p&gt;             //The same SQLState String BLOB_ACCESSED_AFTER_COMMIT&lt;br/&gt;
             //is used for LOB&apos;s(Both Clob and Blob). Ensure that&lt;br/&gt;
             //we get the expected exception by comparing the SQLState.&lt;/p&gt;

&lt;p&gt;These comments should be updated to reflect the changed SQL state.&lt;/p&gt;

&lt;p&gt;The new error message uses the term &quot;the Blob/Clob&apos;s transaction&quot;. Would it be clearer to say &quot;the transaction in which the Blob/Clob was created&quot;?&lt;/p&gt;</comment>
                            <comment id="12503410" author="oysteing" created="Mon, 11 Jun 2007 15:10:12 +0100"  >&lt;p&gt;I will address the inconsistent comments when &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2787&quot; title=&quot;make entry for clob in connection so that temporary file is removed when a connection is closed or transaction is commited/rolledback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2787&quot;&gt;&lt;del&gt;DERBY-2787&lt;/del&gt;&lt;/a&gt; has been committed since that check-in will change things for Clob.&lt;/p&gt;

&lt;p&gt;With respect to the error message, I just copied the phrase  from the error message previously used.  If most people think, Knut Anders&apos; suggestion is better, I will change it.&lt;/p&gt;</comment>
                            <comment id="12504253" author="oysteing" created="Wed, 13 Jun 2007 15:21:25 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2787&quot; title=&quot;make entry for clob in connection so that temporary file is removed when a connection is closed or transaction is commited/rolledback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2787&quot;&gt;&lt;del&gt;DERBY-2787&lt;/del&gt;&lt;/a&gt; cleans up the inconsistent comments that Knut Anders reported.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12371042">DERBY-2771</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12359140" name="ExceptionTest.java" size="809" author="narayanan" created="Thu, 7 Jun 2007 07:36:53 +0100"/>
                            <attachment id="12359083" name="derby-2770-1a.diff" size="3801" author="kristwaa" created="Wed, 6 Jun 2007 15:43:36 +0100"/>
                            <attachment id="12359177" name="derby-2770-2a.diff" size="2368" author="narayanan" created="Thu, 7 Jun 2007 14:41:13 +0100"/>
                            <attachment id="12359178" name="derby-2770-2a.stat" size="122" author="narayanan" created="Thu, 7 Jun 2007 14:41:14 +0100"/>
                            <attachment id="12359191" name="derby-2770-2b.diff" size="9590" author="oysteing" created="Thu, 7 Jun 2007 16:28:54 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 Jun 2007 14:43:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23233</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0uxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38829</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>