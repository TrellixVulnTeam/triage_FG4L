<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:12:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5444/DERBY-5444.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5444] SpawnedProcess.complete may fail to destroy the process when a timeout is specified</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5444</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The logic in SpawnedProcess has a weakness that may result in the wrapped process not being destroyed if the destroy variable is false and a timeout is specified.&lt;br/&gt;
The problem is that the while condition will shortcut the if condition in the catch clause (where destroy is set to true if the timeout is exceeded).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12525656">DERBY-5444</key>
            <summary>SpawnedProcess.complete may fail to destroy the process when a timeout is specified</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kristwaa">Kristian Waagan</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Oct 2011 13:28:06 +0100</created>
                <updated>Mon, 10 Oct 2011 09:04:34 +0100</updated>
                            <resolved>Thu, 6 Oct 2011 10:26:30 +0100</resolved>
                                    <version>10.9.1.0</version>
                                    <fixVersion>10.8.2.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13121049" author="kristwaa" created="Wed, 5 Oct 2011 16:28:54 +0100"  >&lt;p&gt;Attaching patch 1a, which includes the following changes:&lt;br/&gt;
 o don&apos;t throw InterruptedException when sleeping.&lt;br/&gt;
    This cluttered the calling code, and instead I restored the interrupted status of the thread and continued work.&lt;br/&gt;
 o rewrote loop/login in complete to make sure we always destroy the process if a timeout is specified and we indeed time out.&lt;br/&gt;
 o print a warning if we are interrupted while waiting for the output from the process to be gathered.&lt;/p&gt;

&lt;p&gt;Regression tests passed on Solaris11.&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="13121109" author="dagw" created="Wed, 5 Oct 2011 17:31:50 +0100"  >&lt;p&gt;Changes look good, just wondering, what is the test use case for the way interrupts are handled here? Is this code liable to be used in a context where&lt;br/&gt;
the current thread is being interrupted? (since you turn them back on consistently - not that it should hurt)&lt;/p&gt;</comment>
                            <comment id="13121419" author="kristwaa" created="Wed, 5 Oct 2011 21:06:23 +0100"  >&lt;p&gt;I don&apos;t know of any use cases for the interrupt handling introduced by the patch currently. Restoring the interrupted status seemed more reasonable than swallowing them, as it gives the caller  a chance to detect that the thread has been interrupted (i.e. Thread.interrupted or Thread.isInterrupted).&lt;/p&gt;

&lt;p&gt;The patch raises an exception if the thread is interrupted while waiting for the spawned process to die. I&apos;ll do another pass and improve the error handling.&lt;br/&gt;
Off the top of my head, maybe the following:&lt;br/&gt;
 o method sleep: ignore interrupt, allow premature wakeup, leave interrupted status cleared&lt;br/&gt;
 o javaProcess.waitFor: throw exception, leave interrupted status cleared&lt;br/&gt;
 o xSaver.join: not sure about this one. Would it be best to retry, or simply continue (as with current patch)?&lt;/p&gt;

&lt;p&gt;As you say, I don&apos;t think the test framework will interrupt the thread in the normal case. The reason for not restoring the interrupted flag in the cases were we don&apos;t handle it must be that it can cause other code to fall over, i.e. IO calls in another unrelated test. The caller probably can&apos;t do anything to recover from the interrupts, so it would maybe be better to swallow them after all (except for in the javaProcess.waitFor case).&lt;/p&gt;</comment>
                            <comment id="13121426" author="kristwaa" created="Wed, 5 Oct 2011 21:13:18 +0100"  >&lt;p&gt;Patch 1b changes how InterruptedExceptions are handled; they are now either ignored (because it doesn&apos;t matter for SpawnedProcess), or an exception is raised.&lt;/p&gt;

&lt;p&gt;Running regressions now.&lt;br/&gt;
Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="13121622" author="dagw" created="Thu, 6 Oct 2011 01:05:31 +0100"  >&lt;p&gt;Thanks, Kristian. I think, if we don&apos;t expect any interrupts to happen that it&apos;s good to just fail the test, since probably it would be assign that something else is wrong - better to fail early. I see now you ignore it in two cases: sleep (where it doesn&apos;t really matter as you say) and while waiting for the two streamsavers to terminate. You throw in the case where we get interrupted before we are able to see the spawned process terminate and get its error code. I guess that protects the main functionality, but I think I&apos;d prefer throwing in the other two cases as well (from the fail early principle). Unless you can see a reason it would be good to continue here? But that is just my preference, your call.&lt;br/&gt;
+1 in any case.&lt;/p&gt;</comment>
                            <comment id="13121810" author="kristwaa" created="Thu, 6 Oct 2011 10:23:29 +0100"  >&lt;p&gt;Attaching patch 1c, which only fixes the loop logic.&lt;/p&gt;

&lt;p&gt;I went a bit back and forth on the handling of InterruptedException, and decided to change nothing. SpawnedProcess is mostly used in setUp and tearDown methods anyway, and they are usually defined to throw Exception.&lt;/p&gt;

&lt;p&gt;As far as I understand, only Object.wait is subject to spurious wakeups, so in the other cases another thread must have explicitly interrupted the sleeping/working thread.&lt;/p&gt;

&lt;p&gt;Committed 1c to trunk with revision 1179546.&lt;/p&gt;</comment>
                            <comment id="13121812" author="kristwaa" created="Thu, 6 Oct 2011 10:26:30 +0100"  >&lt;p&gt;Thanks for the reviews, Dag.&lt;/p&gt;

&lt;p&gt;Resolving issue.&lt;br/&gt;
I don&apos;t expect to do more work here.&lt;/p&gt;</comment>
                            <comment id="13121936" author="myrna" created="Thu, 6 Oct 2011 14:26:12 +0100"  >&lt;p&gt;Would this be suitable for back port to the 10.8 branch?&lt;/p&gt;</comment>
                            <comment id="13123942" author="kristwaa" created="Mon, 10 Oct 2011 09:04:22 +0100"  >&lt;p&gt;Myrna, I backported the fix to the 10.8 branch with revision 1180817.&lt;/p&gt;</comment>
                            <comment id="13123943" author="kristwaa" created="Mon, 10 Oct 2011 09:04:34 +0100"  >&lt;p&gt;Closing issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12497797" name="derby-5444-1a-destroy_on_timeout.diff" size="4440" author="kristwaa" created="Wed, 5 Oct 2011 16:28:54 +0100"/>
                            <attachment id="12497881" name="derby-5444-1b-destroy_on_timeout.diff" size="4215" author="kristwaa" created="Wed, 5 Oct 2011 21:13:18 +0100"/>
                            <attachment id="12497965" name="derby-5444-1c-destroy_on_timeout.diff" size="1791" author="kristwaa" created="Thu, 6 Oct 2011 10:23:29 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 Oct 2011 16:31:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>44285</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0f7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36282</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>