<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:08:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2264/DERBY-2264.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2264] Restrict shutdown, upgrade, and encryption powers to the database owner</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2264</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This JIRA separates out the database-owner powers from the system privileges in the master security JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2109&quot; title=&quot;System privileges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2109&quot;&gt;DERBY-2109&lt;/a&gt;. Restrict the following powers to the database owner for the moment: shutdown, upgrade, and encryption.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12361033">DERBY-2264</key>
            <summary>Restrict shutdown, upgrade, and encryption powers to the database owner</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dagw">Dag H. Wanvik</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 Jan 2007 21:53:38 +0000</created>
                <updated>Wed, 1 Jul 2009 01:34:40 +0100</updated>
                            <resolved>Fri, 8 Jun 2007 03:30:27 +0100</resolved>
                                                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12466580" author="rhillegas" created="Mon, 22 Jan 2007 21:55:34 +0000"  >&lt;p&gt;Mark this feature as being related to the system privileges jira &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2109&quot; title=&quot;System privileges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2109&quot;&gt;DERBY-2109&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12466741" author="rhillegas" created="Tue, 23 Jan 2007 14:06:50 +0000"  >&lt;p&gt;Attaching functional spec for this feature. There is nothing new in this spec. I simply carved this independent chunk of work out of the master spec for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2109&quot; title=&quot;System privileges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2109&quot;&gt;DERBY-2109&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="12467605" author="fuzzylogic" created="Thu, 25 Jan 2007 20:38:26 +0000"  >&lt;p&gt;Unsetting Fix Version on unassigned issues.&lt;/p&gt;</comment>
                            <comment id="12469520" author="rhillegas" created="Thu, 1 Feb 2007 17:44:13 +0000"  >&lt;p&gt;Attaching rev 2 of the functional spec. This incorporates Dan&apos;s suggestion (in a January 26, 2007 comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2206&quot; title=&quot;Provide complete security model for Java routines&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2206&quot;&gt;DERBY-2206&lt;/a&gt;): only enforce these changes if authentication is turned on.&lt;/p&gt;</comment>
                            <comment id="12470227" author="dagw" created="Mon, 5 Feb 2007 14:25:41 +0000"  >&lt;p&gt;Does it really make sense to enforce this restriction unless&lt;br/&gt;
sqlAuthorization is turned on as well (as authentication)?  &lt;/p&gt;

&lt;p&gt;I made a trial patch for enforcing this check for shutdown and it&lt;br/&gt;
broke existing tests in derbyall.  So it can break existing&lt;br/&gt;
applications without much benefit; without authorization on, full&lt;br/&gt;
access users are fully trusted to change any data in any case.&lt;/p&gt;</comment>
                            <comment id="12470266" author="rhillegas" created="Mon, 5 Feb 2007 16:31:03 +0000"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;Here&apos;s a long preamble about our security model and then a brief discussion of your specific question. We seem to have 3 independent toggles for controlling Derby security:&lt;/p&gt;

&lt;p&gt;A) Whether Java Security is on.&lt;/p&gt;

&lt;p&gt;B) Whether user authentication is on.&lt;/p&gt;

&lt;p&gt;C) Whether SQL authorization is on.&lt;/p&gt;

&lt;p&gt;That gives rise to 8 security states, not all of which makes sense to me. Here they are, expressed in terms of (A, B, C):&lt;/p&gt;

&lt;p&gt;1) (off, off, off). This is the maximally unsecure configuration. It seems like a sensible out-of-the-box default for embedded apps.&lt;/p&gt;

&lt;p&gt;2) (off, off, on). Turning authorization on but turning authentication off doesn&apos;t make sense to me. We raise a warning when the customer does this, but we let them do it, nonetheless.&lt;/p&gt;

&lt;p&gt;3) (off, on, off). I think this is supported because we added GRANT/REVOKE long after we added user authentication. I see limited use for this configuration.&lt;/p&gt;

&lt;p&gt;4) (off, on, on). This case may be useful for customers who want GRANT/REVOKE protections but don&apos;t want the performance drag imposed by Java security. I don&apos;t know how significant that drag is on a Derby engine which has reached steady-state. That&apos;s an interesting experiment to run.&lt;/p&gt;

&lt;p&gt;5) (on, off, off). This might be useful for Derby-powered apps which are downloaded into a browser.&lt;/p&gt;

&lt;p&gt;6) (on, off, on). Like (2), this doesn&apos;t make much sense to me.&lt;/p&gt;

&lt;p&gt;7) (on, on, off). Like (3), this doesn&apos;t make much sense to me either. However, I think we are proposing this as our secure-by-default server configuration. I think we&apos;ve ended up with this as a default for the same reason that we support configuration (3): this eases the upgrade problem for legacy applications.&lt;/p&gt;

&lt;p&gt;8) (on, on, on) This is the maximally secure configuration. It makes more sense to me as the out-of-the-box default for the network server.&lt;/p&gt;

&lt;p&gt;I can imagine this is a bit perplexing to customers. For my money, (1) and (8) look like two distinguished states whose semantics are very clear. Everything in-between is a little muddy&lt;/p&gt;

&lt;p&gt;Now on to your specific question. In terms of enforcing the database-shutdown power, the only settings which make sense to me are (7) and (8).  That is because it seems odd to me to let an authenticated user shutdown the whole engine but not a single database.&lt;/p&gt;</comment>
                            <comment id="12470418" author="dagw" created="Tue, 6 Feb 2007 01:48:49 +0000"  >&lt;p&gt;Thanks for your analysis! I basically agree.&lt;/p&gt;

&lt;p&gt;Stretching it, I can see a use for 2) in a development situation, while experimenting with privileges as different users etc. In deployment, no, I agree, it does not make much sense. A ported app which uses GRANT/REVOKE for which you don&apos;t care less about authentication, perhaps. Number 6) seems even less useful.&lt;/p&gt;

&lt;p&gt;3) and 7) might make sense for a set of cooperating users; using GRANT/REVOKE is more rigid, after all. But as you point out, we must expect (*,on,off) is in use by legacy applications. &lt;/p&gt;

&lt;p&gt;What I argue in my previous post is that it does not make sense to forbid shutting down the database if you already can delete all its data, which is the case for 7 for fullAccess users. IIt can also break existing apps, which makes it even less palatable. So even if we make 7 the default for  our secure-by-default server, I propose we only enforce the checks called for by this JIRA in case 4) and 8), not for 3) or 7). We could even drop the checking for 4), since the user can shut down the system, anyway, but I am not proposing that now, to keep things simple.&lt;/p&gt;</comment>
                            <comment id="12470445" author="djd" created="Tue, 6 Feb 2007 04:28:51 +0000"  >&lt;p&gt;Dag&amp;gt; &quot;What I argue in my previous post is that it does not make sense to forbid shutting down the database if you already can delete all its data, which is the case for 7 for fullAccess users.&quot;&lt;/p&gt;

&lt;p&gt;Without any checks in 3),7) then read-only users would also be able to shut the system down (as they can today) even though they do not have the ability to delete all the data.&lt;/p&gt;

&lt;p&gt;I think it&apos;s somewhat dangerous in security analysis to equate permissions which are really independent of each other. For example one can have the permission to delete rows from a table but not to drop it, they are treated as separate even though they could be seen to have a similar effect.&lt;/p&gt;

&lt;p&gt;I think you also cannot assume that a user authenticated by a database is a valid user in the system authentication. Thus I don&apos;t think you can drop the checking for 4) since the user may not be able to shut the system down.&lt;/p&gt;</comment>
                            <comment id="12471037" author="dagw" created="Wed, 7 Feb 2007 17:31:56 +0000"  >&lt;p&gt;Thanks for good points, Dan! I am still a little unsure of what would&lt;br/&gt;
be the best approach here, though. As far as I understand it, we need&lt;br/&gt;
to strike the right balance between a) plugging security holes, b)&lt;br/&gt;
avoiding undue complexity and c) reducing upgrade pains as much as&lt;br/&gt;
possible.&lt;/p&gt;

&lt;p&gt;3) and 7): Good point about readOnly users; I agree restricting DBA&lt;br/&gt;
powers here plugs a sizable hole. For fullAccess users, your argument&lt;br/&gt;
that the permission to e.g. shut down the database is a different&lt;br/&gt;
permission from full data access is obviously true. My concern,&lt;br/&gt;
however, is how to weigh the benefit of restricting this permission&lt;br/&gt;
against the risk of breaking existing applications.  I think this risk&lt;br/&gt;
is real; I did some experiments and found that under the current&lt;br/&gt;
regime for 3) and 7), the developer does not really need to worry&lt;br/&gt;
about who is the database owner. It is easy to create a database whose&lt;br/&gt;
owner is APP, which can not be authenticated either at the system or&lt;br/&gt;
database level, and the developer would not presently notice, since no&lt;br/&gt;
enforcement is in place. This is compounded by the docs not being very&lt;br/&gt;
explicit about how the database owner is created.  The workaround for&lt;br/&gt;
an application broken by the new enforcement in such a case, would be&lt;br/&gt;
to a) create a database user called APP to match the system schema&lt;br/&gt;
user name effectively creating the &quot;owner&quot;, and b) always close down&lt;br/&gt;
the database connecting as APP.&lt;/p&gt;

&lt;p&gt;One possible way to balance the concerns is to enforce only for&lt;br/&gt;
readOnly access users, thus effectively allowing fullAccess users&lt;br/&gt;
database owner powers for 3) and 7). My theory is that this would&lt;br/&gt;
reduce upgrade pains at slight cost. If this security is not good&lt;br/&gt;
enough for new application, the user can move to sqlAuthorization.&lt;br/&gt;
Downside is more slightly more complexity. What do you think?&lt;/p&gt;

&lt;p&gt;If we decide to go with enforcement also for fullAccess users in 3)&lt;br/&gt;
and 7), we need make a good release note, at least, and clarify docs.&lt;/p&gt;

&lt;p&gt;Dan&amp;gt; I think you also cannot assume that a user authenticated by a&lt;br/&gt;
Dan&amp;gt; database is a valid user in the system authentication. Thus I&lt;br/&gt;
Dan&amp;gt; don&apos;t think you can drop the checking for 4) since the user may&lt;br/&gt;
Dan&amp;gt; not be able to shut the system down.&lt;/p&gt;

&lt;p&gt;I agree. I assume there would be fewer upgrade issues to consider&lt;br/&gt;
here, since sqlAuthorization is new in 10.2. I also don&apos;t think we&lt;br/&gt;
want to base enforcement of a database level action on whether&lt;br/&gt;
authentication is db local or system wide?&lt;/p&gt;

&lt;p&gt;Seems there are more than Rick&apos;s three toggle dimensions in this space&lt;br/&gt;
that matter: system vs db level authentication, and readOnly vs&lt;br/&gt;
fullAccess connection authorization &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="12472771" author="rhillegas" created="Tue, 13 Feb 2007 17:19:24 +0000"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;I just want to punch up the upgrade implications of what we&apos;re proposing:&lt;/p&gt;

&lt;p&gt;By now there must be scores of legacy applications which use Derby authentication. For many of these applications, the DBA owner is APP. When these applications upgrade to 10.3, no-one will be able to shut them down. That is because APP is probably not a real user with a real password. The affected applications have this shape:&lt;/p&gt;

&lt;p&gt;1) Created with authentication turned off. This is what makes APP the DBA.&lt;/p&gt;

&lt;p&gt;2) Authentication turned on later after users and passwords were defined.&lt;/p&gt;

&lt;p&gt;The workaround for these applications will be this:&lt;/p&gt;

&lt;p&gt;A) Create an account for APP.&lt;/p&gt;

&lt;p&gt;B) Change the application so that, when it shuts down, it re-connects to the database as APP, not as the current user.&lt;/p&gt;

&lt;p&gt;What are the imp;lications of not shutting down the database gracefully when the application exits? A long time ago this used to mean that the log file would just keep growing indefinitely. Has this behavior changed? If it&apos;s ok to shutdown gracelessly, then another workaround may be this:&lt;/p&gt;

&lt;p&gt;C) Re-code the application to swallow the concluding exception which says that shutdown failed.&lt;/p&gt;

&lt;p&gt;We seem to have some misgivings that many legacy applications will fit this profile. There seem to be two proposals for how to limit this exposure:&lt;/p&gt;

&lt;p&gt;i) Limit the exposure to a subset of applications created since 10.2, viz., applications which have enabled SQL authorization.&lt;/p&gt;

&lt;p&gt;ii) Limit the exposure to read-only applications.&lt;/p&gt;

&lt;p&gt;At this point, I&apos;m not too keen on either of these techniques. To me they muddy the model laid out in the attached functional spec. I&apos;m not happy about the affect on legacy applications. However, I think that a good Release Note might be our best approach.&lt;/p&gt;
</comment>
                            <comment id="12474538" author="dagw" created="Tue, 20 Feb 2007 20:09:44 +0000"  >&lt;p&gt;Right, it seems both Dan and Rick are less concerned than me about the &lt;br/&gt;
compatibility here issue, so I rest my case.&lt;/p&gt;

&lt;p&gt;This patch, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-1.&lt;/p&gt;
{stat,diff}
&lt;p&gt; implements a first part of this&lt;br/&gt;
JIRA, the checking of shutdown power as specified in the functional&lt;br/&gt;
specification. That is, if derby.connection.requireAuthentication&lt;br/&gt;
true, only the database owner ia allowed to shut down a database, see&lt;br/&gt;
EmbedConnection#checkIsDBOwner.&lt;/p&gt;

&lt;p&gt;A new test jdbcapi/DboPowersTest.java is added which checks the&lt;br/&gt;
enforcement. It runs in both embedded and client/Server frameworks,&lt;br/&gt;
and should be runnable in JSR169, too, although I have no tried&lt;br/&gt;
this. The idea is to add more tests to DboPowersTest.java as the work&lt;br/&gt;
on this issue proceeds, but it works now for shutdown, so I added it&lt;br/&gt;
to _Suite.java.&lt;/p&gt;

&lt;p&gt;After some head-scratching (how to stack decorators, mainly, and how&lt;br/&gt;
they interact) I was able to use the current JUnit decorators to run&lt;br/&gt;
the tests, but found two issues, one of which I corrected:&lt;/p&gt;

&lt;p&gt;a) When using DatabasePropertyTestSetup.builtinAuthentication, the&lt;br/&gt;
enforcement implemented in this patch causes problems for the&lt;br/&gt;
decorator&apos;s shutdown database action, unless I prepend &quot;APP&quot; to the&lt;br/&gt;
list of users. I had to do this for NistScripts.java as well. The&lt;br/&gt;
problem occurs because the wombat database was created using APP as&lt;br/&gt;
owner. We might want to either document this in the decorator, add an&lt;br/&gt;
&quot;APP&quot; user silently, or do something else.&lt;/p&gt;

&lt;p&gt;b) The second issue I found was that in wrapping&lt;br/&gt;
TestConfiguration.clientServerDecorator around a test which is already&lt;br/&gt;
decorated with sqlAuthorizationDecorator, an initial empty password&lt;br/&gt;
used by sqlAuthorizationDecorator when constructing&lt;br/&gt;
DatabaseChangeSetup does not work with the client (DRDA limitation I&lt;br/&gt;
believe), so I changed this to a dummy password with no ill effects.&lt;/p&gt;

&lt;p&gt;In addition to the aforementioned NistScripts, I had to also modify&lt;br/&gt;
jdbcapi/users.sql, jdbcapi/users2.sql and jdbcapi/secureUsers.sql.&lt;br/&gt;
These three had to be modifed to make sure the database owner&lt;br/&gt;
performed the shutdowns.&lt;/p&gt;

&lt;p&gt;I suspect that secureUsers.sql had probably never really worked as&lt;br/&gt;
intended in that the database derbySchemeDB was never rebooted as the&lt;br/&gt;
comment says it should be, due to an authentication issue. When I&lt;br/&gt;
fixed this, the test failed, because authentication was turned off,&lt;br/&gt;
since this property was no longer valid as inherited from the system&lt;br/&gt;
properties, when derby.database.propertiesOnly took effect after the&lt;br/&gt;
reboot. Not sure what the author intended here; I made it work with&lt;br/&gt;
the reboot.&lt;/p&gt;

&lt;p&gt;I have run derbyall on Sun&apos;s JDK6 on Solaris 10 x86, with only one&lt;br/&gt;
error in a compress test, which seems to be an intermittent failure.&lt;/p&gt;

&lt;p&gt;I ran the JUnit suites.all on Sun&apos;s JDK6 Solaris 11 x86 with no&lt;br/&gt;
errors (6814 tests).&lt;/p&gt;</comment>
                            <comment id="12474751" author="dagw" created="Wed, 21 Feb 2007 16:31:18 +0000"  >&lt;p&gt;Looking at (re)encryption, I see that the functional specification&lt;br/&gt;
says, when describing current behavior: &quot;anyone who can connect can&lt;br/&gt;
(re)encrypt the database&quot;. It is actually worse than that, currently&lt;br/&gt;
anyone (sic) can, even when authentication is on:&lt;/p&gt;

&lt;p&gt;1a) boot a database, even if authentication fails&lt;/p&gt;

&lt;p&gt;1b) boot an encrypted database just by knowing the boot password, even&lt;br/&gt;
    if authentication fails &lt;/p&gt;

&lt;p&gt;2) encrypt a database, even if authentication fails&lt;/p&gt;

&lt;p&gt;3) re-encrypt a database only by knowing bootPassword/encryption key,&lt;br/&gt;
   even if authentication fails&lt;/p&gt;

&lt;p&gt;These side-effects of otherwise botched connection attempts can be a&lt;br/&gt;
little surprising &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;(Re)encryption happens at boot time, and no authentication is&lt;br/&gt;
performed until after the database is booted (user credentials may be&lt;br/&gt;
database local). Scenario 2) above is especially bad, since it allows&lt;br/&gt;
a rogue user to effectively make the database unavailable to all&lt;br/&gt;
legitimate users once it has been shut down. I was not aware of this,&lt;br/&gt;
is it pointed out in the current documentation? I uploaded repro&lt;br/&gt;
scripts for the above cases 1b, 2 and 3 for illustration.&lt;/p&gt;

&lt;p&gt;As I see it now, we can attempt enforcement of 2) and 3) by first&lt;br/&gt;
booting the database, then authenticate. If authentication succeeds&lt;br/&gt;
and user is database owner, we will shutdown the database and boot it&lt;br/&gt;
over again with the (re)encryption now taking place. &lt;/p&gt;

&lt;p&gt;Whether or not 1), the booting, should be limited by privileges is&lt;br/&gt;
outside the scope of this JIRA issue, I think.&lt;/p&gt;</comment>
                            <comment id="12474774" author="rhillegas" created="Wed, 21 Feb 2007 17:51:08 +0000"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;I agree with your analysis. (1) seems like a separate itch which someone else may or may not want to scratch.&lt;/p&gt;

&lt;p&gt;Your approach to (2) and (3) sounds good to me too. In the case that the (re-)encrypting user fails to authenticate, we will just be left with a special case of (1).&lt;/p&gt;</comment>
                            <comment id="12474813" author="rhillegas" created="Wed, 21 Feb 2007 20:03:04 +0000"  >&lt;p&gt;Thanks for the patch, Dag. Committed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-1.diff at subversion revision 510173. The patch looks solid to me and derbyall passes cleanly.&lt;/p&gt;

&lt;p&gt;Two small points, which you may or may not want to address in a future patch:&lt;/p&gt;

&lt;p&gt;1) Grammar: I think that the new error message would read better if you put another &quot;the&quot; in the second sentence. So: &quot;Only the database owner can perform this operation.&quot;&lt;/p&gt;

&lt;p&gt;2) Style: In DboPowersTest.dboSuite(), the magic array size 3 could be replaced with a constant.&lt;/p&gt;</comment>
                            <comment id="12474814" author="rhillegas" created="Wed, 21 Feb 2007 20:04:39 +0000"  >&lt;p&gt;Turned off &quot;Patch Available&quot; flag.&lt;/p&gt;</comment>
                            <comment id="12475074" author="dagw" created="Thu, 22 Feb 2007 16:23:53 +0000"  >&lt;p&gt;Thanks for the quick review and and commit of my patch, Rick!&lt;/p&gt;

&lt;p&gt;This follow-on patch, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-2.&lt;/p&gt;
{diff,stat}
&lt;p&gt; addresses the two minor&lt;br/&gt;
issues you mentioned, fixes a couple of Javadoc omissions and corrects&lt;br/&gt;
some whitespace inconsistency, which I don&apos;t understand how got in&lt;br/&gt;
there: the uploaded patch looks correct, but after commit some&lt;br/&gt;
indentations in in DboPowersTest.java lack one space here and&lt;br/&gt;
there.. Any clue?&lt;/p&gt;

&lt;p&gt;A small note: the grammar issue, where I used the wording &quot;only&lt;br/&gt;
database owner can...&quot; was based on &quot;prior art&quot;, cf. state 2850E&apos;s:&lt;br/&gt;
&quot;Only database owner could issue this statement&quot;. I did not correct&lt;br/&gt;
this wording, though, for compatibility concerns.&lt;/p&gt;

&lt;p&gt;I ran suites.All and the jdbcapi suites in embedded and Derby client&lt;br/&gt;
harnesses to verify (JDK1.6, Solaris 10). No errors.&lt;/p&gt;</comment>
                            <comment id="12475083" author="rhillegas" created="Thu, 22 Feb 2007 16:59:39 +0000"  >&lt;p&gt;Thanks for the quick re-patch, Dag. I have committed it at subversion revision 510586. The white space cruft was my bad. This was my first attempt to use the patch tool on my new laptop. It has the following interesting behavior: new files added by the patch don&apos;t automatically appear in my client and, instead, provoke a quarrel with the patch tool. Next time around, I&apos;ll have to handle this more gracefully than I did with your patch: I simply moused the new file out of the patch, slapped it onto disk, then pruned out the spurious &quot;+&quot; signs. That clumsy workaround introduced the white-space cruft.&lt;/p&gt;</comment>
                            <comment id="12477837" author="dagw" created="Sun, 4 Mar 2007 18:52:36 +0000"  >&lt;p&gt;The new error message for an unauthorized shutdown attempt is garbled for the clients, since  SYSIBM.SQLCAMESSAGE is never called (the connection is closed) to format the message, I missed this the first time around.The new JUnit  test, DboPowersTest, never discovered this, looking only at the SQL State, but it can be seen in output of users2.sql for the clients.&lt;br/&gt;
Only the message parameters appear; the message text itself is missing. I will address this in a new patch.&lt;/p&gt;</comment>
                            <comment id="12478093" author="dagw" created="Mon, 5 Mar 2007 16:46:06 +0000"  >&lt;p&gt;Attached a patch, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-3.&lt;/p&gt;
{diff,stat}
&lt;p&gt;, for the issue with the&lt;br/&gt;
error message mentioned; the fix gives it session severity (the&lt;br/&gt;
formatting was thus a symptom of wrong severity). With session&lt;br/&gt;
severity, the message will be preformatted on the server, using the&lt;br/&gt;
locale of the server, cf. DRDAConnThread#buildSqlerrmc logic.&lt;/p&gt;

&lt;p&gt;Ran user2.sql again in DerbyNet and DerbyNetClient frameworks to&lt;br/&gt;
verify.&lt;/p&gt;</comment>
                            <comment id="12478137" author="rhillegas" created="Mon, 5 Mar 2007 19:58:47 +0000"  >&lt;p&gt;Looks good. Tests pass. Committed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-3.diff at subversion revision 514836.&lt;/p&gt;</comment>
                            <comment id="12478646" author="dagw" created="Wed, 7 Mar 2007 00:06:03 +0000"  >&lt;p&gt;This patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-4.&lt;/p&gt;
{diff,stat}
&lt;p&gt;) adds policing of powers for&lt;br/&gt;
(re)encryption and adds tests for this.&lt;/p&gt;

&lt;p&gt;I also extended the JUnit framework with some new methods.&lt;/p&gt;

&lt;p&gt;I ran derbyall on Solaris 10, x86, Sun Java 1.6, with two errors,&lt;br/&gt;
which I think are unrelated:&lt;/p&gt;

&lt;p&gt;derbyall/derbynetmats/derbynetmats.fail:jdbcapi/setTransactionIsolation.java&lt;br/&gt;
derbyall/storeall/storeall.fail:store/readlocks.sql&lt;/p&gt;

&lt;p&gt;The JUnit suites.All ran to completion, no failures.&lt;/p&gt;


&lt;ul&gt;
	&lt;li&gt;A note on atomicity of encrypting:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Currently, the boot and the simultaneous (re)encryption is atomic, as&lt;br/&gt;
far as I understand, so another thread (#2) will either a) boot first,&lt;br/&gt;
making the encrypting boot (thread #1) silently fail &lt;b&gt;or&lt;/b&gt; b) be&lt;br/&gt;
blocked by the encrypting boot and get a connection after the&lt;br/&gt;
encryption is done (i.e. we have atomicity).&lt;/p&gt;

&lt;p&gt;The new thing introduced by this patch is that thread #11 (the&lt;br/&gt;
encrypting connection thread) does three atomic steps ( &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; boot, &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;br/&gt;
shutdown, &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; boot/encrypt) in stead of previously one (boot/encrypt).&lt;br/&gt;
We may need/want to make those three into one atomic operation&lt;br/&gt;
somehow, to avoid a race condition.&lt;/p&gt;

&lt;p&gt;Currently, there is no synchronization between connections before one&lt;br/&gt;
hits the booting level as far as I can see &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  In the constructor of&lt;br/&gt;
EmbedConnection, which is where the new enforcement boot/shutdown/boot&lt;br/&gt;
logic is located, there is no synchronization across connections&lt;br/&gt;
currently. We may have to introduce something to make the three&lt;br/&gt;
operations atomic; I would appreciate others&apos; opinion on this, I will&lt;br/&gt;
make a follow-up patch if synchronization is deemed necessary.&lt;/p&gt;

&lt;p&gt;Race scenarios:&lt;/p&gt;

&lt;p&gt;If thread #2 sneaks in between &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; it will lose its&lt;br/&gt;
connection, which thread #1 shuts down the database in step &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;If thread #2 sneaks in between &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;, the (re)encryption of&lt;br/&gt;
thread #1 in step &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; will silently (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2409&quot; title=&quot;Connecting to an already booted database with (re)encryption attributes gives no error or warning&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2409&quot;&gt;&lt;del&gt;DERBY-2409&lt;/del&gt;&lt;/a&gt;) fail.&lt;/p&gt;

&lt;p&gt;The first scenario is new and could be seen by applications. I am not&lt;br/&gt;
sure it is really necessary to synchronize this further, though, since&lt;br/&gt;
essentially, to (re)encrypt a DBA needs to shut down the database and&lt;br/&gt;
make sure other connections don&apos;t re-boot the database in the&lt;br/&gt;
meantime, in any case. In summary, I think it&apos;s an edge case.&lt;/p&gt;
</comment>
                            <comment id="12478651" author="dagw" created="Wed, 7 Mar 2007 00:26:30 +0000"  >&lt;p&gt;Btw, committers, feel free to defer committing this patch&lt;br/&gt;
until the community has a chance to weigh in in the&lt;br/&gt;
synchronization issue I raised.&lt;/p&gt;</comment>
                            <comment id="12480398" author="rhillegas" created="Tue, 13 Mar 2007 13:57:38 +0000"  >&lt;p&gt;Thanks for the patch, Dag. This looks like solid incremental improvement. As your comments indicate, this patch introduces a new race condition: We will kill another user&apos;s connection if it sneaks in between the authenticating boot and the encrypting boot. I think this is a small edge case. It can be addressed later on if we decide that it&apos;s a problem. I believe that there are other, existing  boot-time edge cases having to do with encryption and upgrade. Before patching this isolated, new case, I think we should analyze the other edge cases and see if we can come up with a model that makes sense.&lt;/p&gt;

&lt;p&gt;A couple comments on the patch to EmbedConnection itself:&lt;/p&gt;

&lt;p&gt;1) A variable called &quot;didWait&quot; is initialized but I can&apos;t see where it&apos;s used later on.&lt;/p&gt;

&lt;p&gt;2) I think that the error messages are not internationalized. It looks as though English strings are being hardcoded and will end up being inserted in text that is localized to other languages--the resulting composite text will be an odd pidgin. I can suggest 2 possible solutions to this problem:&lt;/p&gt;

&lt;p&gt;  a) Create separate error messages for the separate error states.&lt;/p&gt;

&lt;p&gt;  b) Continue to have one error message but expand its text so that it describes all of the error states and gives the user enough information to figure out which one applies.&lt;/p&gt;

&lt;p&gt;Thanks, again.&lt;/p&gt;</comment>
                            <comment id="12480789" author="dagw" created="Wed, 14 Mar 2007 14:35:50 +0000"  >&lt;p&gt;Thanks for review, Rick! &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-5.&lt;/p&gt;
{diff,stat}
&lt;p&gt; supercedes patch #4&lt;br/&gt;
and addresses your comments, fixed some white space details and&lt;br/&gt;
renamed a variable.  I chose separate error messages; I think that is&lt;br/&gt;
cleaner.&lt;/p&gt;

&lt;p&gt;Ran suites.All with no errors.  derbyall has a one-line diff in the&lt;br/&gt;
dblook_test.java which I believe is unrelated.&lt;/p&gt;</comment>
                            <comment id="12480835" author="rhillegas" created="Wed, 14 Mar 2007 16:50:54 +0000"  >&lt;p&gt;Thanks, Dag. I like your solution to the internationalization issue. Committed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;.5.diff at subversion revision 518214.&lt;/p&gt;</comment>
                            <comment id="12481378" author="army" created="Thu, 15 Mar 2007 23:44:00 +0000"  >&lt;p&gt;Hi Dag,&lt;/p&gt;

&lt;p&gt;I noticed that the DboPowersTest is failing on weme6.1 with error &quot;Failed to start database &apos;singleUse/oneuse4&apos; in many cases:&lt;/p&gt;

&lt;p&gt;  Tests run: 15,  Failures: 3,  Errors: 5&lt;/p&gt;

&lt;p&gt;Both the &quot;Failures&quot; and the &quot;Errors&quot; are caused by an inability  to start the database.  The &quot;Failures&quot; all occur in &quot;testEncrypt&quot;, the &quot;Errors&quot; all occur in &quot;testReEncrypt&quot;.&lt;/p&gt;

&lt;p&gt;I looked at the derby.log file generated from the test but there was nothing helpful.   I&apos;m not sure what the best way is to unwrap the exception, but before I look into that I thought I should ask:&lt;/p&gt;

&lt;p&gt;Is there something about the encryption test that makes them not runnable with weme6.1? (please excuse my ignorance here)?  If so then can these two fixtures just be disabled with weme6.1?  Otherwise...any ideas what might be going on?&lt;/p&gt;</comment>
                            <comment id="12481474" author="dagw" created="Fri, 16 Mar 2007 04:46:16 +0000"  >&lt;p&gt;Hi Army,&lt;/p&gt;

&lt;p&gt;Looking at Dan&apos;s specification for Derby support for JSR169 support in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-97&quot; title=&quot;Support J2ME/CDC/Foundation with JSR169 JDBC subset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-97&quot;&gt;&lt;del&gt;DERBY-97&lt;/del&gt;&lt;/a&gt;, I see:&lt;/p&gt;

&lt;p&gt;&amp;gt; These features will not be modified to work on Foundation:&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;   * Derby Network server (could be a separate project)&lt;br/&gt;
&amp;gt;   * Encrypted Databases (no support for JCE classes in Foundation)&lt;/p&gt;

&lt;p&gt;So I guess the encryption fixtures should disabled, and perhaps the &lt;br/&gt;
ClientServerDecorator wrapping of the dboShutdownSuite as well&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;


</comment>
                            <comment id="12481791" author="dagw" created="Fri, 16 Mar 2007 23:53:24 +0000"  >&lt;p&gt;This patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-6.*) adds a check that the encryption fixtures&lt;br/&gt;
are not run for JSR169. I have run the test again with JDK1.6, but &lt;b&gt;not&lt;/b&gt;&lt;br/&gt;
with weme6.1. Thanks, Myrna, for pointing out that the test need not&lt;br/&gt;
exclude clientServerDecorator (which tests for JSR169 itself).&lt;/p&gt;</comment>
                            <comment id="12482823" author="army" created="Wed, 21 Mar 2007 16:25:47 +0000"  >&lt;p&gt;FYI, the *.-6.diff patch does not compile in my environment:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; symbol  : variable JDBC&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; location: class org.apache.derbyTesting.functionTests.tests.jdbcapi.DboPowersTest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt;         if (!JDBC.vmSupportsJSR169()) {&lt;/p&gt;

&lt;p&gt;Looks like it&apos;s just missing the JDBC import.  Also, might be nice to add a comment explaining &lt;b&gt;why&lt;/b&gt; the encryption tests are not running with JSR169 (so that people who are wondering later on can figure it out without having to search Jira and/or svn commit messages...). &lt;/p&gt;

&lt;p&gt;I added the missing import locally and ran the test with weme6.1:&lt;/p&gt;

&lt;p&gt;Time: 11.867&lt;/p&gt;

&lt;p&gt;OK (5 tests)&lt;/p&gt;

&lt;p&gt;If this looks right then could you post another patch with the &quot;import&quot; and associated comment(s)?  Then I can either commit the patch, or you can use your new committer privileges to do it yourself &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thank you for taking the time to address this follow-up issue.&lt;/p&gt;</comment>
                            <comment id="12482982" author="dagw" created="Thu, 22 Mar 2007 01:26:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2462&quot; title=&quot;org.apache.derby.impl.store.access.BackingStoreHashTableFromScan does not honor ResultSet holdability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2462&quot;&gt;&lt;del&gt;DERBY-2462&lt;/del&gt;&lt;/a&gt;-6b fixes the import issue and adds comments&lt;br/&gt;
as suggested, thanks Army! &lt;/p&gt;</comment>
                            <comment id="12483266" author="army" created="Thu, 22 Mar 2007 18:42:28 +0000"  >&lt;p&gt;Thank you, Dag.  I committed the *-6b.diff patch with svn # 521401.&lt;/p&gt;</comment>
                            <comment id="12486439" author="dagw" created="Tue, 3 Apr 2007 18:52:30 +0100"  >&lt;p&gt;This patch, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-7.*, adds checking database owner checking for&lt;br/&gt;
the hard upgrade operation as specified in&lt;br/&gt;
the attached dbaPowers.html.&lt;/p&gt;

&lt;p&gt;With this patch, the hard upgrade operation now also uses the two&lt;br/&gt;
phased boot procedure introduced for the encryption case of this&lt;br/&gt;
issue: First a plain boot is performed to check the credentials, is&lt;br/&gt;
this succeeds, the database is shut down and rebooted with the&lt;br/&gt;
upgrade=true attribute.&lt;/p&gt;

&lt;p&gt;A new fixture has been added to DbaPowersTest.java to test the&lt;br/&gt;
credentials checking. Note that while this exercises the checking&lt;br/&gt;
code, a hard upgrade is never actually performed, since store ignores&lt;br/&gt;
the upgrade flag when the underlying database is already of the same&lt;br/&gt;
version as the codebase (AFAIK there is no straight forward way right&lt;br/&gt;
now to get a database produced by another version of Derby in the&lt;br/&gt;
existing junit framework). &lt;/p&gt;

&lt;p&gt;I did verify the upgrade checking behavior manually using 10.2/10.3&lt;br/&gt;
databases.&lt;/p&gt;

&lt;p&gt;If others think this is required or a good idea, I may try to extend&lt;br/&gt;
the upgradeTests/_Suite.java test with positive and negative test case&lt;br/&gt;
fixtures to really verify hard upgrade when credentials are&lt;br/&gt;
accepted/rejected.&lt;/p&gt;

&lt;p&gt;derbyall and suites.All ran without incident on Solaris 10/x86, Sun&lt;br/&gt;
JDK 1.6 with the patch applied on svn revision 524545 running from&lt;br/&gt;
classes, sane build.&lt;/p&gt;</comment>
                            <comment id="12486469" author="rhillegas" created="Tue, 3 Apr 2007 20:17:04 +0100"  >&lt;p&gt;The patch looks good to me, Dag. Thanks.&lt;/p&gt;</comment>
                            <comment id="12488525" author="dagw" created="Fri, 13 Apr 2007 00:00:32 +0100"  >&lt;p&gt;Committed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-7.diff at svn 528274.&lt;br/&gt;
In addition to derbyall and suites.All, I also ran upgradeTests._Suite with&lt;br/&gt;
all 10.1 and 10.2 releases.&lt;/p&gt;</comment>
                            <comment id="12499806" author="dagw" created="Tue, 29 May 2007 14:55:50 +0100"  >&lt;p&gt;Added release note; comments welcome.&lt;/p&gt;</comment>
                            <comment id="12500238" author="dagw" created="Wed, 30 May 2007 22:13:09 +0100"  >&lt;p&gt;Uploading a patch which removes the enforcement of dbo powers &lt;br/&gt;
in the case where authentication is enabled, but sqlAuthorization is&lt;br/&gt;
not enabled. This is done as a result of recent discussions on &lt;br/&gt;
derby-dev which reveal concern that such enforcement may break too &lt;br/&gt;
many existing applications.&lt;/p&gt;

&lt;p&gt;This patch is not ready for commit, I am running regression tests on it now, &lt;br/&gt;
but I upload it now in case somebody wants to play with it.&lt;/p&gt;

&lt;p&gt;If we decide this is the way to go, I will commit it when all tests have &lt;br/&gt;
been run. Attachment releaseNotes.html will need modification as well.&lt;/p&gt;

&lt;p&gt;Patch details:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;modifies EmbedConnection.java to also require sqlAuthorization in&lt;br/&gt;
  addition to authentication for dbo powers enforcement&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;modifies DboPowersTest.java correspondingly (before the change to the&lt;br/&gt;
  test, it correctly flagged the modified behavior)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12500420" author="dagw" created="Thu, 31 May 2007 18:31:49 +0100"  >&lt;p&gt;Uploading a new version of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-8, which also fixes&lt;br/&gt;
AuthenticationTest.java. That test had incorporated the dbo&lt;br/&gt;
enforcement for authentication, so I had to change it back to allow&lt;br/&gt;
database shutdown for any authenticated user.&lt;/p&gt;

&lt;p&gt;The current version of the patch ran the regression tests&lt;br/&gt;
successfully (Solaris 10/x86, Sun JDK 1.5, sane jars).&lt;/p&gt;</comment>
                            <comment id="12502363" author="dagw" created="Thu, 7 Jun 2007 15:36:56 +0100"  >&lt;p&gt;Uploading &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-9.* which replaces &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-8.*&lt;/p&gt;

&lt;p&gt;In addition to the changes in #8 which it replaces, it adds code to&lt;br/&gt;
address the upgrade snag discussed in the email thread:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/Can%27t-upgrade-from-10.1-to-10.3-tf3855260.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Can%27t-upgrade-from-10.1-to-10.3-tf3855260.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Details:&lt;/p&gt;

&lt;p&gt;When doing temporary soft upgrade boot used to authenticate (first&lt;br/&gt;
phase of two phased hard upgrade boot introduced with this issus),&lt;br/&gt;
make sure not to check for/activate any new feature in&lt;br/&gt;
DataDictionaryImpl#boot / DataDictionaryImpl#checkVersion.&lt;/p&gt;

&lt;p&gt;This ensures that the temporary soft upgrade boot will succeed so&lt;br/&gt;
authentication and hard upgrade boot can proceed.&lt;/p&gt;

&lt;p&gt;I bypass the feature check/activation in DataDictionaryImpl#boot() by&lt;br/&gt;
passing in an internal attribute &apos;softUpgradeNoFeatureCheck&apos; (from&lt;br/&gt;
EmbedConnection) when required.&lt;/p&gt;

&lt;p&gt;As a consequence, when upgrading from 10.1 or earlier to 10.3 or&lt;br/&gt;
later, there will be no check for &lt;b&gt;database owner&lt;/b&gt; (OK, since&lt;br/&gt;
database owner is not yet in created in its post 10.1 form), but&lt;br/&gt;
an ordinary credentials check will happen before the hard upgrade&lt;br/&gt;
takes place (nice) - so only an authenticated user can upgrade and&lt;br/&gt;
become database owner (always assuming authentication is enabled&lt;br/&gt;
of course), allowing us to still avoid&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2766&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-2766&lt;/a&gt;&lt;br/&gt;
&quot;Non-authenticated user gets to upgrade from pre-10.2 version&lt;br/&gt;
databases and become database owner&quot;.&lt;/p&gt;

&lt;p&gt;If upgrading from 10.2 or newer we will be activate SQLAutorization&lt;br/&gt;
(if set) during the temporary soft upgrade boot so we can authenticate&lt;br/&gt;
database owner.&lt;/p&gt;

&lt;p&gt;The second phase will then do the hard upgrade and, if it is from&lt;br/&gt;
a pre-10.2 database, create the (new) database owner - as before&lt;br/&gt;
with upgrade to 10.2.&lt;/p&gt;

&lt;p&gt;Question: Is passing an internal attribute down from&lt;br/&gt;
EmbedConnection to DataDictionaryImpl#boot an acceptable way to&lt;br/&gt;
implement this solution?  (I do make sure to remove any such&lt;br/&gt;
attribute for other cases, in case somebody tries to be clever and&lt;br/&gt;
pass it in from the URL..)&lt;/p&gt;

&lt;p&gt;I tested this approach and it works as expected for the upgrade&lt;br/&gt;
scenarios I have been able to imagine and throw at it, plus derbyall&lt;br/&gt;
and suites.All regression tests.&lt;/p&gt;

</comment>
                            <comment id="12502447" author="rhillegas" created="Thu, 7 Jun 2007 18:54:50 +0100"  >&lt;p&gt;Thanks for the patch, Dag. I have taken a quick look at the version 9 patch. It looks good to me although I must admit it&apos;s all a bit tricky. I think that&apos;s unavoidable here at the intersection of booting and upgrade, and, fortunately, you have amply commented this solution.&lt;/p&gt;</comment>
                            <comment id="12502612" author="dagw" created="Fri, 8 Jun 2007 03:25:44 +0100"  >&lt;p&gt;Thanks for reviewing, Rick. I agree this &quot;time travel&quot; is a bit tricky, I would love to have &lt;br/&gt;
more of these test scenarios covered by the upgrade tests as Mike suggested&lt;br/&gt;
on the thread mentioned above. I did look briefly at it earlier and it seems a bit of work&lt;br/&gt;
to get the decorator scaffolding up for these needs.. Meanwhile, I have&lt;br/&gt;
run ij based test scenarios; I plan to systematize these and upload them here ASAP,&lt;br/&gt;
as well as list outcomes. These could be input for new&lt;br/&gt;
JUnit based tests later.&lt;/p&gt;

&lt;p&gt;Committed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-9 at svn 545370. I also upload a slightly modified&lt;br/&gt;
version of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-9.diff because I improved some comments for clarity.&lt;br/&gt;
(I like the uploaded versions of the patches to reflect exactly what goes in.)&lt;/p&gt;</comment>
                            <comment id="12502613" author="dagw" created="Fri, 8 Jun 2007 03:30:27 +0100"  >&lt;p&gt;Setting as resolved, although I plan to run and upload more ad hoc upgrade tests.&lt;br/&gt;
Associated doc (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2520&quot; title=&quot;Document new restrictions of database shutdown, encryption and hard upgrade powers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2520&quot;&gt;&lt;del&gt;DERBY-2520&lt;/del&gt;&lt;/a&gt;) has been committed now, I will make a small &lt;br/&gt;
upgrade to the releaseNotes.html also.&lt;/p&gt;</comment>
                            <comment id="12502928" author="stan" created="Fri, 8 Jun 2007 21:53:05 +0100"  >&lt;p&gt;Thanks Dag !!&lt;/p&gt;

&lt;p&gt;I applied &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-9.diff to my sandbox and preformed some rudimentary upgrage tests to 10.1 and the issues I originally reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2728&quot; title=&quot;Make DBO restrictions from Derby-2264 optional for upgrades&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2728&quot;&gt;&lt;del&gt;DERBY-2728&lt;/del&gt;&lt;/a&gt; are resolved.  And it appears the patch is now committed to the codeline so all is good in my book.&lt;/p&gt;</comment>
                            <comment id="12502987" author="dagw" created="Sat, 9 Jun 2007 03:19:16 +0100"  >&lt;p&gt;Updated releaseNote.html to reflect changes.&lt;/p&gt;</comment>
                            <comment id="12503535" author="dagw" created="Mon, 11 Jun 2007 19:31:34 +0100"  >&lt;p&gt;Uploading a bundle with extra manual (ij based) tests I ran to verify&lt;br/&gt;
changes made as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2264&quot; title=&quot;Restrict shutdown, upgrade, and encryption powers to the database owner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2264&quot;&gt;&lt;del&gt;DERBY-2264&lt;/del&gt;&lt;/a&gt;-9.*&lt;/p&gt;

&lt;p&gt;They should be converted to JUnit.&lt;/p&gt;

</comment>
                            <comment id="12505487" author="rhillegas" created="Sat, 16 Jun 2007 17:40:05 +0100"  >&lt;p&gt;Scrubbing release note so that it survives the release note generator. Corrected some unbalanced &amp;lt;li&amp;gt; tags.&lt;/p&gt;</comment>
                            <comment id="12509130" author="rhillegas" created="Fri, 29 Jun 2007 16:33:58 +0100"  >&lt;p&gt;Attach version 3.0 of the functional spec reflecting the fact that these restrictions are only enforced in GRANT/REVOKE-protected databases.&lt;/p&gt;</comment>
                            <comment id="12510839" author="myrna" created="Sat, 7 Jul 2007 03:09:04 +0100"  >&lt;p&gt;attaching updated release note to remove one of doubled &apos;be be&apos;. Exact same otherwise. See also &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2847&quot; title=&quot;More clarification issues for the release notes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2847&quot;&gt;&lt;del&gt;DERBY-2847&lt;/del&gt;&lt;/a&gt; for the report of the &apos;be be&apos;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12366496">DERBY-2520</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12365355">DERBY-2470</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12377317">DERBY-3038</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12370498">DERBY-2728</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12364929">DERBY-2451</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12356374">DERBY-2109</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12351625" name="DERBY-2264-1.diff" size="72479" author="dagw" created="Tue, 20 Feb 2007 20:09:44 +0000"/>
                            <attachment id="12351624" name="DERBY-2264-1.stat" size="2344" author="dagw" created="Tue, 20 Feb 2007 20:09:44 +0000"/>
                            <attachment id="12351821" name="DERBY-2264-2.diff" size="9764" author="dagw" created="Thu, 22 Feb 2007 16:23:52 +0000"/>
                            <attachment id="12351822" name="DERBY-2264-2.stat" size="376" author="dagw" created="Thu, 22 Feb 2007 16:23:53 +0000"/>
                            <attachment id="12352641" name="DERBY-2264-3.diff" size="4406" author="dagw" created="Mon, 5 Mar 2007 16:47:53 +0000"/>
                            <attachment id="12352642" name="DERBY-2264-3.stat" size="369" author="dagw" created="Mon, 5 Mar 2007 16:47:53 +0000"/>
                            <attachment id="12352798" name="DERBY-2264-4.diff" size="37961" author="dagw" created="Wed, 7 Mar 2007 00:06:03 +0000"/>
                            <attachment id="12352799" name="DERBY-2264-4.stat" size="504" author="dagw" created="Wed, 7 Mar 2007 00:06:03 +0000"/>
                            <attachment id="12353288" name="DERBY-2264-5.diff" size="38869" author="dagw" created="Wed, 14 Mar 2007 14:35:50 +0000"/>
                            <attachment id="12353289" name="DERBY-2264-5.stat" size="578" author="dagw" created="Wed, 14 Mar 2007 14:35:50 +0000"/>
                            <attachment id="12353554" name="DERBY-2264-6.diff" size="1105" author="dagw" created="Fri, 16 Mar 2007 23:53:23 +0000"/>
                            <attachment id="12353555" name="DERBY-2264-6.stat" size="157" author="dagw" created="Fri, 16 Mar 2007 23:53:24 +0000"/>
                            <attachment id="12353917" name="DERBY-2264-6b.diff" size="1925" author="dagw" created="Thu, 22 Mar 2007 01:26:25 +0000"/>
                            <attachment id="12353918" name="DERBY-2264-6b.stat" size="157" author="dagw" created="Thu, 22 Mar 2007 01:26:25 +0000"/>
                            <attachment id="12354869" name="DERBY-2264-7.diff" size="17200" author="dagw" created="Tue, 3 Apr 2007 18:52:30 +0100"/>
                            <attachment id="12354870" name="DERBY-2264-7.stat" size="351" author="dagw" created="Tue, 3 Apr 2007 18:52:30 +0100"/>
                            <attachment id="12358639" name="DERBY-2264-8.diff" size="8789" author="dagw" created="Thu, 31 May 2007 18:31:49 +0100"/>
                            <attachment id="12358576" name="DERBY-2264-8.diff" size="4010" author="dagw" created="Wed, 30 May 2007 22:13:09 +0100"/>
                            <attachment id="12358640" name="DERBY-2264-8.stat" size="254" author="dagw" created="Thu, 31 May 2007 18:31:49 +0100"/>
                            <attachment id="12358577" name="DERBY-2264-8.stat" size="158" author="dagw" created="Wed, 30 May 2007 22:13:09 +0100"/>
                            <attachment id="12359236" name="DERBY-2264-9.diff" size="13847" author="dagw" created="Fri, 8 Jun 2007 03:25:44 +0100"/>
                            <attachment id="12359188" name="DERBY-2264-9.diff" size="13636" author="dagw" created="Thu, 7 Jun 2007 15:36:56 +0100"/>
                            <attachment id="12359189" name="DERBY-2264-9.stat" size="397" author="dagw" created="Thu, 7 Jun 2007 15:36:56 +0100"/>
                            <attachment id="12360820" name="dbaPowers.html" size="12000" author="rhillegas" created="Fri, 29 Jun 2007 16:33:58 +0100"/>
                            <attachment id="12350161" name="dbaPowers.html" size="11232" author="rhillegas" created="Thu, 1 Feb 2007 17:44:13 +0000"/>
                            <attachment id="12349451" name="dbaPowers.html" size="10395" author="rhillegas" created="Tue, 23 Jan 2007 14:06:50 +0000"/>
                            <attachment id="12351702" name="encrypt-1b.sql" size="1070" author="dagw" created="Wed, 21 Feb 2007 16:31:18 +0000"/>
                            <attachment id="12351703" name="encrypt-2.sql" size="1001" author="dagw" created="Wed, 21 Feb 2007 16:31:18 +0000"/>
                            <attachment id="12351704" name="encrypt-3.sql" size="1101" author="dagw" created="Wed, 21 Feb 2007 16:31:18 +0000"/>
                            <attachment id="12359439" name="extra-tests.tar.gz" size="3515" author="dagw" created="Mon, 11 Jun 2007 19:31:34 +0100"/>
                            <attachment id="12361337" name="releaseNote.html" size="5814" author="myrna" created="Sat, 7 Jul 2007 03:09:03 +0100"/>
                            <attachment id="12359932" name="releaseNote.html" size="5641" author="rhillegas" created="Sat, 16 Jun 2007 17:40:05 +0100"/>
                            <attachment id="12359305" name="releaseNote.html" size="5601" author="dagw" created="Sat, 9 Jun 2007 03:19:16 +0100"/>
                            <attachment id="12358427" name="releaseNote.html" size="4154" author="dagw" created="Tue, 29 May 2007 14:55:50 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 25 Jan 2007 20:38:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0stb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38486</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>