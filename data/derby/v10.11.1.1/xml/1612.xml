<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:11:45 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1612/DERBY-1612.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1612] A constraint should be dropped when a privilege required by the constraint is revoked.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1612</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;A constraint tracks its privileges requirements using Derby&apos;s Dependency Manager. If any one of those required privileges are revoked, the constraint should be dropped automatically. &lt;/p&gt;

&lt;p&gt;I am just creating a new jira entry here so it is easier to track sub items of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1330&quot; title=&quot;Provide runtime privilege checking for grant/revoke functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1330&quot;&gt;&lt;del&gt;DERBY-1330&lt;/del&gt;&lt;/a&gt;. Will link this Jira entry to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1330&quot; title=&quot;Provide runtime privilege checking for grant/revoke functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1330&quot;&gt;&lt;del&gt;DERBY-1330&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;See the functional spec attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1330&quot; title=&quot;Provide runtime privilege checking for grant/revoke functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1330&quot;&gt;&lt;del&gt;DERBY-1330&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12346923">DERBY-1612</key>
            <summary>A constraint should be dropped when a privilege required by the constraint is revoked.</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="mamtas">Mamta A. Satoor</reporter>
                        <labels>
                    </labels>
                <created>Mon, 31 Jul 2006 04:01:15 +0100</created>
                <updated>Wed, 1 Jul 2009 01:34:49 +0100</updated>
                            <resolved>Wed, 30 Aug 2006 07:22:10 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12425638" author="mamtas" created="Fri, 4 Aug 2006 00:52:22 +0100"  >&lt;p&gt;This is a patch which will provide partial support for revoke functionality for constraints. If revoke statement finds a constraint dependent on the table/column on which privilege is being revoked, the constraint will be dropped automatically. This functionality is similar to what is supported for triggers and views. And just like triggers and views, more work is required so that constraint will get dropped only if it depends on the particular privilege TYPE or particular column that is being revoked. &lt;/p&gt;

&lt;p&gt;This patch is similar to what has been recently submitted for view (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1611&quot; title=&quot;A  view should be dropped when a privilege required by the view is revoked.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1611&quot;&gt;&lt;del&gt;DERBY-1611&lt;/del&gt;&lt;/a&gt;), triggers (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1539&quot; title=&quot;A  trigger should be dropped when a privilege required by the trigger is revoked.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1539&quot;&gt;&lt;del&gt;DERBY-1539&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Engine code changes&lt;br/&gt;
1)DropConstraintConstantAction&lt;br/&gt;
Made this class and it&apos;s method dropConstraintAndIndex public. In addition, change that method to take a LanguageConnectionContext rather than an activation. The activation was used merely to get LanguageConnectionContext and hence it is ok to remove activation and simply send LanguageConnectionContext. This also makes it possible for ConstraintDescriptor to be able to call the DropConstraintConstantAction.dropConstraintAndIndex method.&lt;/p&gt;

&lt;p&gt;2)The change to pass LanguageConnectionContext rather than the activation to DropConstraintConstantAction.dropConstraintAndIndex required changes in the calling classes. Those classes are&lt;br/&gt;
  a)DropTableConstantAction.java&lt;br/&gt;
  b)DropIndexConstantAction.java&lt;br/&gt;
  c)AlterTableConstantAction.java&lt;br/&gt;
3)Have ConstraintDescriptor call DropConstraintConstantAction.dropConstraintAndIndex when a revoke invalidation comes in for the constraint. With that call, the ConstraintDescriptor is dropping itself because of the revoke invalidation action.&lt;/p&gt;

&lt;p&gt;Added following tests to grantRevokeDDL.sql&lt;br/&gt;
1)Constraint Test - Test1&lt;br/&gt;
Give a constraint privilege at table level to a user. Let user define a foreign key constraint based on that privilege.&lt;br/&gt;
Later revoke that references privilege and make sure that foreign key constraint gets dropped&lt;/p&gt;

&lt;p&gt;2)Constraint Test - Test2&lt;br/&gt;
Have user mamta1 give a references privilege to mamta3.&lt;br/&gt;
Have user mamta2 give a references privilege to mamta3.&lt;br/&gt;
Have mamta3 create a table with 2 foreign key constraints relying on both these granted privileges.&lt;br/&gt;
Revoke one of those privileges and make sure that the foreign key constraint defined based on that privilege gets dropped.&lt;br/&gt;
Now revoke the 2nd references privilege and make sure that remaining foreign key constraint gets dropped&lt;/p&gt;

&lt;p&gt;3)Constraint Test - Test3&lt;br/&gt;
Have mamta1 grant REFERENCES privilege on one of it&apos;s tables to mamta2&lt;br/&gt;
Have mamta2 create a table with primary which references mamta1&apos;s granted REFERENCES privilege&lt;br/&gt;
Have mamta2 grant REFERENCES privilege on that table to user mamta3&lt;br/&gt;
Have mamta3 create a table which references mamta2&apos;s granted REFERENCES privilege&lt;br/&gt;
So, the tables look as follows&lt;br/&gt;
a)mamta1.t11ConstraintTest (primary key)&lt;br/&gt;
b)mamta2.t21ConstraintTest (primary key references t11ConstraintTest)&lt;br/&gt;
c)mamta3.t31ConstraintTest (primary key references t21ConstraintTest)&lt;br/&gt;
Now revoke of granted REFERENCES privilege by mamta1 should drop the foreign key reference   by mamta2&apos;s table t21ConstraintTest. It should not impact the foreign key reference by mamta3&apos;s table t31ConstraintTest.&lt;/p&gt;

&lt;p&gt;4)Constraint Test - Test4&lt;br/&gt;
Grant a REFERENCES permission at public level, create constraint, grant same permission at user level &lt;br/&gt;
   and take away the public level permission. It ends up dropping the constraint. &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1632&quot; title=&quot;During revoke privilege, Derby does not look for replacement privilege for the dependent objects and simply drops the dependent objects. This is not SQL compliant and should be fixed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1632&quot;&gt;DERBY-1632&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5)Constraint Test - Test5&lt;br/&gt;
Grant refrences privilege and select privilege on a table. Have a constraint depend on the references privilege. Later, a revoke of select privilege will end up dropping the constraint which shouldn&apos;t happen. This will be addressed in a subsequent patch&lt;/p&gt;

&lt;p&gt;6)Constraint Test - Test6&lt;br/&gt;
Have a primary key and a unique key on a table and grant reference on both. Have another table rely on unique key references privilege to create a foreign key constraint. Later, the revoke of primary key reference will end up&lt;br/&gt;
dropping the foreign key constraint. This will be fixed in a subsequent patch (same as test5)&lt;/p&gt;

&lt;p&gt;7)Miscellaneous test - test1 (this test is not directly related to constraint work but is a general grant revoke test)&lt;br/&gt;
Have mutliple objects depend on the same privilege and make sure they all get dropped when the privilege is later revoked.&lt;/p&gt;
</comment>
                            <comment id="12425663" author="djd" created="Fri, 4 Aug 2006 04:47:22 +0100"  >&lt;p&gt;By calling the dropConstraintAndIndex() method directly it seems that no invalidation events are sent due to the constraint being dropped.&lt;br/&gt;
DropConstraintConstantAction performs the invalidation before calling the dropConstraintAndIndex().&lt;/p&gt;</comment>
                            <comment id="12425664" author="mamtas" created="Fri, 4 Aug 2006 05:21:39 +0100"  >&lt;p&gt;Actually, initially, I had started out by factoring the code from DropConstraintConstantAction.executeConstantAction so that invalidation messages will be sent out. But after debugging, I found that invalidation actions are only sent out for ReferencedKeyConstraintDescriptor (A ReferencedConstraintDeescriptor is a primary key or a unique key that is referenced by a foreign key). Since in Derby, at this point, only foreign key constraints can have a privilege requirement, only a foreign key constraint will receive a revoke invalidation action. Objects like ReferencedConstraintDeescriptor can&apos;t reference any other table or routine and hence can&apos;t have any privilege requirements and hence they will never receive a revoke invalidation action. And that is why I didn&apos;t include the code for sending DROP_CONSTRAINT action for revoke privilege code path. &lt;/p&gt;

&lt;p&gt;Here is the existing invalidation code from the DropConstraintConstantAction.executeConstantAction to help understand what is happening&lt;br/&gt;
boolean cascadeOnRefKey = (cascade &amp;amp;&amp;amp; conDesc instanceof ReferencedKeyConstraintDescriptor);&lt;br/&gt;
if (!cascadeOnRefKey)&lt;/p&gt;
{
      dm.invalidateFor(conDesc, DependencyManager.DROP_CONSTRAINT, lcc);
}
&lt;p&gt;As one can see from the code above, DROP_CONSTRAINT invalidation is sent only if the ConstraintDescriptor is an instanceof ReferencedKeyConstraintDescriptor. In case of revoke invalidations, the ConstraintDescriptor will never be instanceof ReferencedKeyConstraintDescriptor, instead, they will always be an instanceof ForeignKeyConstraintDescriptor and hence even if I include the code for invalidation in the revoke privilege code path, the invalidation will never get sent.&lt;/p&gt;</comment>
                            <comment id="12425665" author="djd" created="Fri, 4 Aug 2006 05:41:18 +0100"  >&lt;p&gt;Ok - thanks for the additional info, looking further I see the DROP_INDEX invalidation will be sent and so compiled plans that are dependent on that index will be re-compiled, that&apos;s what I was concerned about. The information you gathered is useful to add somewhere as a comment, maybe for the constant DROP_CONSTRAINT, as by its name alone I would assume it is sent out for all drop constraints. I&apos;ll commit the patch.&lt;/p&gt;</comment>
                            <comment id="12425671" author="djd" created="Fri, 4 Aug 2006 05:56:10 +0100"  >&lt;p&gt;What tests were run for this patch?&lt;/p&gt;</comment>
                            <comment id="12425673" author="mamtas" created="Fri, 4 Aug 2006 06:08:27 +0100"  >&lt;p&gt;Sorry, forgot to mention. I did run derbyall and there were no new failures because of this patch&lt;/p&gt;</comment>
                            <comment id="12425739" author="djd" created="Fri, 4 Aug 2006 14:04:13 +0100"  >&lt;p&gt;With this patch grantRevokeDDL fails for me. diff to the master file is attached as grddl_fail.txt&lt;/p&gt;</comment>
                            <comment id="12425770" author="mamtas" created="Fri, 4 Aug 2006 16:14:35 +0100"  >&lt;p&gt;My fault. I thought I had updated the master in the patch. Dan, the diff you see are correct and the output from the test result should be used as the final master file. I am submitting a new patch with the updated master. Please commit it when you get a chance&lt;/p&gt;</comment>
                            <comment id="12425801" author="djd" created="Fri, 4 Aug 2006 18:56:36 +0100"  >&lt;p&gt;Patch DERBY1612_V2_diff_DropConstraintOnRevoke.txt  committed - revision 428801 - Thanks Mamta&lt;/p&gt;</comment>
                            <comment id="12426956" author="djd" created="Wed, 9 Aug 2006 17:16:59 +0100"  >&lt;p&gt;Cleaning the summary&lt;/p&gt;</comment>
                            <comment id="12431485" author="mamtas" created="Wed, 30 Aug 2006 07:22:10 +0100"  >&lt;p&gt;Closing this issue since I am finished with the work targeted for 10.2 release. The remaining work for this issue is getting tracked in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1782&quot; title=&quot;When a privilege is revoked at table level, Derby should only drop objects that require that particular privilege and not all the objects that require some form of privilege on that table.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1782&quot;&gt;DERBY-1782&lt;/a&gt;. I will link the 2 issues so we can keep track of the correlation between the 2 jira entries.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12343197">DERBY-1330</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12348900">DERBY-1782</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12338109" name="DERBY1612_V1_diff_DropConstraintOnRevoke.txt" size="37757" author="mamtas" created="Fri, 4 Aug 2006 00:52:22 +0100"/>
                            <attachment id="12338108" name="DERBY1612_V1_stat_DropConstraintOnRevoke.txt" size="663" author="mamtas" created="Fri, 4 Aug 2006 00:52:22 +0100"/>
                            <attachment id="12338158" name="DERBY1612_V2_diff_DropConstraintOnRevoke.txt" size="40653" author="mamtas" created="Fri, 4 Aug 2006 16:14:35 +0100"/>
                            <attachment id="12338147" name="grddl_fail.txt" size="2517" author="djd" created="Fri, 4 Aug 2006 14:04:13 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 4 Aug 2006 03:47:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30075</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0sin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38438</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>