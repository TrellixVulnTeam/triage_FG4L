<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:12:14 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1149/DERBY-1149.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1149] &apos;jdbc40/StatementTest.junit&apos; fails under DerbyNetClient</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1149</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;One of the tests in jdbc40/StatementTest.junit fails with the following message:&lt;/p&gt;

&lt;p&gt;&quot;Attempt to shutdown framework: DerbyNetClient&lt;br/&gt;
0 add&lt;br/&gt;
&amp;gt; ....F.&lt;br/&gt;
&amp;gt; There was 1 failure:&lt;br/&gt;
&amp;gt; 1) testIsClosedWhenClosingConnectionInInvalidState(org.apache.derbyTesting.functionTests.tests.jdbc4.StatementTest)junit.framework.ComparisonFailure: Unexpected exception thrown: Cannot close a connection while a global transaction is still active. expected:&amp;lt;java.sql.Connection.close() requested while a transaction is in progress on the connection.The transaction remains active, and the connection cannot be closed...&amp;gt; but was:&amp;lt;Cannot close a connection while a global transaction is still active...&amp;gt;&lt;br/&gt;
&amp;gt; FAILURES!!!&lt;br/&gt;
&amp;gt; Tests run: 5,  Failures: 1,  Errors: 0&lt;br/&gt;
Test Failed.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;End:   StatementTest jdk1.6.0-beta2 DerbyNetClient 2006-03-24 12:53:22 ***&quot;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The reason is that the exception message text has been changed. This comparison is only done when running DerbyNetClient, because SQLState was not implemented there.&lt;br/&gt;
The checkin that caused the error:&lt;br/&gt;
&quot;Author: davidvc&lt;br/&gt;
Date: Thu Mar 23 16:55:44 2006&lt;br/&gt;
New Revision: 388309&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewcvs?rev=388309&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewcvs?rev=388309&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-839&quot; title=&quot;Internationalize messages CallableStatement40 to Cursor.java in org.apache.derby.client.am&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-839&quot;&gt;&lt;del&gt;DERBY-839&lt;/del&gt;&lt;/a&gt; (Partial).  Internationalize Connection.java.  Also upgraded&lt;br/&gt;
the &quot;i18n lint&quot; test to be a little more intelligent, and to not exit&lt;br/&gt;
on the first failure.&lt;/p&gt;

&lt;p&gt;Passes derbynetclientmats.  All changes are client-specific so derbyall&lt;br/&gt;
was not run.&quot;&lt;/p&gt;

&lt;p&gt;A&lt;/p&gt;</description>
                <environment>JDK 1.6 (b76 used, believed to apply to all)</environment>
        <key id="12330654">DERBY-1149</key>
            <summary>&apos;jdbc40/StatementTest.junit&apos; fails under DerbyNetClient</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davidvc">David Van Couvering</assignee>
                                    <reporter username="kristwaa">Kristian Waagan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Mar 2006 20:09:01 +0000</created>
                <updated>Fri, 21 Jan 2011 18:08:58 +0000</updated>
                            <resolved>Fri, 31 Mar 2006 03:11:09 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12371720" author="kristwaa" created="Fri, 24 Mar 2006 20:16:34 +0000"  >&lt;p&gt;I will look into this, and fix the test by either adjusting the expected exception message, or compare SQLStates if it has been implemented.&lt;/p&gt;</comment>
                            <comment id="12371754" author="kristwaa" created="Sat, 25 Mar 2006 00:37:58 +0000"  >&lt;p&gt;I need a little help on my issue. The following diff is from r388309:&lt;/p&gt;

&lt;p&gt;&amp;#8212; /db/derby/code/trunk/java/client/org/apache/derby/client/am/Connection.java	2006/03/24 00:54:27	388308&lt;br/&gt;
+++ db/derby/code/trunk/java/client/org/apache/derby/client/am/Connection.java	2006/03/24 00:55:44	388309&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;snip&amp;#93;&lt;/span&gt;&lt;br/&gt;
         // The following precondition matches CLI semantics, see SQLDisconnect()&lt;br/&gt;
         if (!autoCommit_ &amp;amp;&amp;amp; inUnitOfWork_ &amp;amp;&amp;amp; !allowCloseInUOW_()) &lt;/p&gt;
{
             throw new SqlException(agent_.logWriter_,
-                    &quot;java.sql.Connection.close() requested while a transaction is in progress on the connection.&quot; +
-                    &quot;The transaction remains active, and the connection cannot be closed.&quot;);
+                    new MessageId (SQLState.CANNOT_CLOSE_ACTIVE_XA_CONNECTION));                   
         }
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;snip&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Is this change correct?&lt;br/&gt;
In my test, the SQLState used on the embedded side is&lt;br/&gt;
LANG_INVALID_TRANSACTION_STATE (25000):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Transaction states, matches DB2&lt;br/&gt;
25000=Invalid transaction state.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The way I see it, without much knowledge about this, there are multiple&lt;br/&gt;
possible outcomes:&lt;br/&gt;
1) The change is invalid, and we start using&lt;br/&gt;
SQLSTATE.LANG_INVALID_TRANSACTION_STATE on the client as well.&lt;br/&gt;
2) The change is correct, and I change the test to reflect this.&lt;br/&gt;
3) The change is invalid, and we make SQLSTATE.LANG_INVALID_TRANSACTION_STATE&lt;br/&gt;
more verbose (aka the old message on the client) and start using it on the&lt;br/&gt;
client and update the message text for embedded.&lt;/p&gt;

&lt;p&gt;What do you say?&lt;/p&gt;</comment>
                            <comment id="12372168" author="davidvc" created="Wed, 29 Mar 2006 09:52:20 +0100"  >&lt;p&gt;I am attaching the patch if anyone wants to look at it.  Running derbyall right now&lt;/p&gt;</comment>
                            <comment id="12372240" author="kristwaa" created="Wed, 29 Mar 2006 22:42:43 +0100"  >&lt;p&gt;This patch will (and does) fail, due to the way SQLStates are compared. I will brush up the patch, only changing things in StatementTest, were this testing was not good enough (all tests, not only the one that failed here).&lt;/p&gt;

&lt;p&gt;David, can you explain why you have set the SQLState to &quot;25000.S.1&quot;, and not to &quot;25001&quot;?&lt;br/&gt;
Is the former an SQLState encoding exception category, as described in the class comments for SQLState.java?&lt;/p&gt;

&lt;p&gt;Do we want to use the invalid trasaction state also for XA connections? I see it has been added in EmbedXAConnection. Is the CANNOT_CLOSE_ACTIVE_XA_CONNECTION wrong/deprecated for XA connections?&lt;/p&gt;

&lt;p&gt;Besides from these questions, I think the patch is good to go, but I would appreciate if it was held back until the questions above were answered and I had the time to add some fixes to StatementTest.&lt;/p&gt;
</comment>
                            <comment id="12372243" author="kristwaa" created="Wed, 29 Mar 2006 22:54:03 +0100"  >&lt;p&gt;Uploaded &apos;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1149&quot; title=&quot;&amp;#39;jdbc40/StatementTest.junit&amp;#39; fails under DerbyNetClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1149&quot;&gt;&lt;del&gt;DERBY-1149&lt;/del&gt;&lt;/a&gt;-2a-StatementTestFailure.diff&apos; with two changes in StatementTest.java only. Now using assertSQLState instead of assertEquals for comparing SQLStates. The former takes care of SQLStates that are longer than 5 characters.&lt;/p&gt;</comment>
                            <comment id="12372307" author="kristwaa" created="Thu, 30 Mar 2006 06:11:25 +0100"  >&lt;p&gt;&apos;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1149&quot; title=&quot;&amp;#39;jdbc40/StatementTest.junit&amp;#39; fails under DerbyNetClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1149&quot;&gt;&lt;del&gt;DERBY-1149&lt;/del&gt;&lt;/a&gt;-3a-StatementTestFailure.diff&apos; changes the identifier &quot;25000.S.1&quot; to &quot;25001&quot;, and removes references to SQLState in StatementTest.java. The rest of this patch is David&apos;s, and nothing of it is changed. StatementTest passes under both embedded and DerbyNetClient.&lt;/p&gt;</comment>
                            <comment id="12372336" author="davidvc" created="Thu, 30 Mar 2006 09:09:45 +0100"  >&lt;p&gt;This is the patch I hope to commit.  It passes all jdbc40 tests, including StatementTest, for both embedded and network drivers.&lt;/p&gt;

&lt;p&gt;Changes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Reverted engine code to use old SQL States, as discussions have shown this is likely a break in compatibility requirements.  Logged bugs &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1168&quot; title=&quot;Incorrect SQLState used in EmbedConnection.java.close() when there is an active transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1168&quot;&gt;&lt;del&gt;DERBY-1168&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1169&quot; title=&quot;EmbedXAConnection.getConnection uses wrong SQL State when trying to close a connection with an active transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1169&quot;&gt;DERBY-1169&lt;/a&gt; to note the incorrect SQL states being used in the engine&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added a new SQL State constants file which was a cut-and-paste exercise from the SQL2003 spec.  Using these constants in StatementTest.java&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I modified the assertSQLState method in BaseJDBCTestCase to not truncate the SQL State string and to ensure that the length of the expected and received SQL States were both 5 characters long.  But I didn&apos;t actually end up using it in the test case because I wanted to throw the actual exception encountered so that the stack trace was printed out.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m running derbyall again so hoping to check in tomorrow morning unless there are issues with the patch&lt;/p&gt;</comment>
                            <comment id="12372394" author="kristwaa" created="Thu, 30 Mar 2006 18:54:12 +0100"  >&lt;p&gt;The following part of the patch does not make sense to me:&lt;br/&gt;
+            if ( ! expectedState.equals(sqle.getSQLState()) )&lt;br/&gt;
+            {&lt;br/&gt;
+                fail(&quot;Unexpected SQL State encountered; got &quot; &lt;br/&gt;
+                    + sqle.getSQLState() + &quot;, expected &quot; + expectedState +&lt;br/&gt;
+                    &quot;. Unexpected exception message is &quot; + sqle.getMessage());&lt;br/&gt;
+                &lt;br/&gt;
+                throw sqle;&lt;/p&gt;

&lt;p&gt;What fail() does, is that it throws an AssertionFailedException.&lt;br/&gt;
I think you must either just throw the exception, or use the fail-method.&lt;/p&gt;

&lt;p&gt;Also, any specific reason why you don&apos;t tick off the button for granting a license to ASF?&lt;/p&gt;</comment>
                            <comment id="12372464" author="davidvc" created="Fri, 31 Mar 2006 02:14:53 +0100"  >&lt;p&gt;Thanks, Kristian, I&apos;ll fix this.  &lt;/p&gt;

&lt;p&gt;I don&apos;t tick off the ASF grant because I don&apos;t intend this code to be committed and don&apos;t want anyone else to commit it.  It&apos;s just for review, and what will be committed is what I have in my sandbox.&lt;/p&gt;</comment>
                            <comment id="12372474" author="davidvc" created="Fri, 31 Mar 2006 03:11:09 +0100"  >&lt;p&gt;Checked in the fix&lt;/p&gt;</comment>
                            <comment id="12376899" author="kristwaa" created="Fri, 28 Apr 2006 17:08:12 +0100"  >&lt;p&gt;Problem fixed, isse closed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12324716" name="DERBY-1149-2a-StatementTestFailure.diff" size="7389" author="kristwaa" created="Wed, 29 Mar 2006 22:54:00 +0100"/>
                            <attachment id="12324733" name="DERBY-1149-3a-StatementTestFailure.diff" size="7157" author="kristwaa" created="Thu, 30 Mar 2006 06:11:24 +0100"/>
                            <attachment id="12324739" name="DERBY-1149-4a-StatementTestFailure.diff" size="23508" author="davidvc" created="Thu, 30 Mar 2006 09:09:42 +0100"/>
                            <attachment id="12324693" name="DERBY-1149-StatementTestFaiure.diff" size="6737" author="davidvc" created="Wed, 29 Mar 2006 09:52:20 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Mar 2006 08:52:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22337</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0klr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37156</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>