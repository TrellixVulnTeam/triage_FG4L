<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:37:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6672/DERBY-6672.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6672] Allow Derby to rename tables referenced by foreign keys</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6672</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Hi, I&apos;m on the Apache Roller team and we use database migration scripts to update databases between Roller releases.  (We have a common template (&lt;a href=&quot;http://svn.apache.org/viewvc/roller/trunk/app/src/main/resources/sql/500-to-510-migration.vm?view=co&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/roller/trunk/app/src/main/resources/sql/500-to-510-migration.vm?view=co&lt;/a&gt;)  that is run through Velocity to create specific scripts for the several databases that we support.)  One handicap with Derby that we&apos;re not seeing with other databases is its inability to rename tables that have FK&apos;s on them.  Renaming one of our tables returns this error from Derby:&lt;/p&gt;

&lt;p&gt;rename table website to weblog;&lt;/p&gt;

&lt;p&gt;Error: Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos; because CONSTRAINT &apos;WP_WEBSITEID_FK&apos; is dependent on that object.&lt;br/&gt;
SQLState:  X0Y25&lt;br/&gt;
ErrorCode: 30000&lt;br/&gt;
Error: Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos; because CONSTRAINT &apos;WE_WEBSITEID_FK&apos; is dependent on that object.&lt;br/&gt;
SQLState:  X0Y25&lt;br/&gt;
ErrorCode: 99999&lt;br/&gt;
Error: Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos; because CONSTRAINT &apos;WC_WEBSITEID_FK&apos; is dependent on that object.&lt;br/&gt;
SQLState:  X0Y25&lt;br/&gt;
ErrorCode: 99999&lt;br/&gt;
Error: Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos; because CONSTRAINT &apos;FO_WEBSITEID_FK&apos; is dependent on that object.&lt;br/&gt;
SQLState:  X0Y25&lt;br/&gt;
ErrorCode: 99999&lt;br/&gt;
Error: Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos; because CONSTRAINT &apos;MF_WEBSITEID_FK&apos; is dependent on that object.&lt;br/&gt;
SQLState:  X0Y25&lt;br/&gt;
ErrorCode: 99999&lt;br/&gt;
Error: Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos; because CONSTRAINT &apos;NF_WEBSITEID_FK&apos; is dependent on that object.&lt;br/&gt;
SQLState:  X0Y25&lt;br/&gt;
ErrorCode: 99999&lt;br/&gt;
Error: Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos; because CONSTRAINT &apos;AP_WEBSITEID_FK&apos; is dependent on that object.&lt;br/&gt;
SQLState:  X0Y25&lt;br/&gt;
ErrorCode: 99999&lt;/p&gt;

&lt;p&gt;This results in the migration scripts needing to be messy, first dropping all constraints before recreating them, for the one RDBMS that requires it.  It would be great if a future release of Derby could be coded to support table renames regardless of the constraints defined on it.  Thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12728432">DERBY-6672</key>
            <summary>Allow Derby to rename tables referenced by foreign keys</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="gmazza">Glen Mazza</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Jul 2014 14:19:06 +0100</created>
                <updated>Wed, 30 Jul 2014 19:54:56 +0100</updated>
                            <resolved>Wed, 30 Jul 2014 19:40:53 +0100</resolved>
                                    <version>10.10.2.0</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                            <comments>
                            <comment id="14068495" author="rhillegas" created="Mon, 21 Jul 2014 14:22:04 +0100"  >&lt;p&gt;I have verified that you can&apos;t rename a table if a foreign key points at it. The following script shows this problem:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;connect &apos;jdbc:derby:memory:db;create=true&apos;;

create table primary1( a int primary key );

create table foreign1( a int references primary1( a ) );

-- cannot rename the primary key table
rename table primary1 to primary2;

-- renaming the foreign key table is ok
rename table foreign1 to foreign2;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14068604" author="rhillegas" created="Mon, 21 Jul 2014 16:12:13 +0100"  >&lt;p&gt;Note that this limitation is described by the Reference Guide section on RENAME TABLE, so implementing this improvement will require a change to the user documentation.&lt;/p&gt;</comment>
                            <comment id="14068622" author="rhillegas" created="Mon, 21 Jul 2014 16:23:51 +0100"  >&lt;p&gt;Attaching derby-6672-01-aa-allowRenameWithConstraints.diff. This patch makes it possible to rename a referenced table.&lt;/p&gt;

&lt;p&gt;With this patch, you can rename the primary and foreign tables and you can rename the columns in the primary and foreign key constraints. After renaming the tables and columns, both constraints are still enforced. I have verified that the DDL produced by dblook looks correct too.&lt;/p&gt;

&lt;p&gt;The patch does not address the limitation on CHECK constraints. There seem to be two cases:&lt;/p&gt;

&lt;p&gt;1) Renaming a column mentioned by a CHECK constraint fails because Derby doesn&apos;t know how to re-write the CHECK constraint. I think we could treat that as a separate, lower-value issue.&lt;/p&gt;

&lt;p&gt;2) Renaming the table fails if the table has a CHECK constraint. It ought to be possible to lift this limitation too.&lt;/p&gt;

&lt;p&gt;I have only hand-tested this patch. I haven&apos;t tried running the full battery of tests. And I haven&apos;t added any new test cases to the regression tests.&lt;/p&gt;


&lt;p&gt;Touches the following file:&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/dictionary/ConstraintDescriptor.java&lt;/p&gt;</comment>
                            <comment id="14068638" author="gmazza" created="Mon, 21 Jul 2014 16:34:45 +0100"  >&lt;p&gt;Doc patch that retains the sentence that tables can&apos;t be renamed if they have check constraints, but removes the sentence requiring the table have no FK relationships.&lt;/p&gt;</comment>
                            <comment id="14068836" author="gmazza" created="Mon, 21 Jul 2014 18:25:18 +0100"  >&lt;p&gt;I wouldn&apos;t want to make the &quot;perfect the enemy of the good&quot; here &amp;#8211; anywhere you can reduce the limitations, such as allowing renaming of tables with FK&apos;s, that would be good (and all I presently need).  Unless it would prove more efficient to get all done at once, I wouldn&apos;t want any improvement to be held up because the coding for reducing other limitations hasn&apos;t yet been done, especially if that future coding is difficult to do or less demanded and hence unlikely to be prioritized to get done.&lt;/p&gt;</comment>
                            <comment id="14068917" author="chaase3" created="Mon, 21 Jul 2014 19:01:24 +0100"  >&lt;p&gt;The documentation patch looks good &amp;#8211; thank you, Glen.&lt;/p&gt;

&lt;p&gt;I assume the fix applies to views as well as foreign keys?&lt;/p&gt;</comment>
                            <comment id="14068951" author="rhillegas" created="Mon, 21 Jul 2014 19:12:54 +0100"  >&lt;p&gt;Hi Kim,&lt;/p&gt;

&lt;p&gt;The attached patch does not lift the limitations involving views and triggers. Thanks.&lt;/p&gt;</comment>
                            <comment id="14069435" author="chaase3" created="Mon, 21 Jul 2014 23:27:53 +0100"  >&lt;p&gt;Oh, thanks. Then the only change to the topic would be changing &quot;If there is a view or foreign key that references the table&quot; to &quot;If there is a view that references the table&quot;. &lt;/p&gt;</comment>
                            <comment id="14073135" author="rhillegas" created="Thu, 24 Jul 2014 13:04:59 +0100"  >&lt;p&gt;Given recent bugs in this area, we should test that deferrable foreign keys still work after the referenced table is renamed.&lt;/p&gt;</comment>
                            <comment id="14073145" author="gmazza" created="Thu, 24 Jul 2014 13:13:15 +0100"  >&lt;p&gt;An encouraging hint I see in the error message is &quot;Operation &apos;RENAME&apos; cannot be performed on object &apos;SQL140718163851800&apos;&quot; as opposed to &quot;Operation &apos;RENAME&apos; cannot be performed on table &quot;WEBSITE&quot;.  That implies that keys, views, whatever are tied, or can be tied, to the table&apos;s presumably never-changing internal identifier (SQL140718163851800) and not the human-readable name of the object, so changes of the latter shouldn&apos;t effect defined relationships.&lt;/p&gt;</comment>
                            <comment id="14074345" author="rhillegas" created="Fri, 25 Jul 2014 13:30:50 +0100"  >&lt;p&gt;Removing CHECK constraints from this issue. Let&apos;s go back to just focussing on foreign keys. A 2014-02-24 comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-532&quot; title=&quot;Support deferrable constraints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-532&quot;&gt;&lt;del&gt;DERBY-532&lt;/del&gt;&lt;/a&gt; (the one describing the attachment of patch derby-532-check-constraints-1) indicates that the implementation of deferred CHECK constraints was simplified by taking advantage of the fact that Derby doesn&apos;t currently support the renaming of tables with CHECK constraints.&lt;/p&gt;</comment>
                            <comment id="14077717" author="rhillegas" created="Tue, 29 Jul 2014 14:50:06 +0100"  >&lt;p&gt;Attaching derby-6672-01-ab-addTests.diff. This patch adds some tests.&lt;/p&gt;

&lt;p&gt;I would now like to understand why this functionality was disabled in the first place.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/dictionary/ConstraintDescriptor.java&lt;/p&gt;

&lt;p&gt;Enable this functionality.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/AlterTableTest.java&lt;/p&gt;

&lt;p&gt;Remove test case which explicitly verifies that you can&apos;t rename a referenced table.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/RenameTableTest.java&lt;/p&gt;

&lt;p&gt;Add some tests for the new functionality, including tests for deferred foreign keys.&lt;/p&gt;</comment>
                            <comment id="14077743" author="rhillegas" created="Tue, 29 Jul 2014 15:14:34 +0100"  >&lt;p&gt;Code to verify that you can&apos;t rename a referenced column was added to the altertable.sql test at subversion revision 472708. This was done by Bryan as part of the work on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1490&quot; title=&quot;Provide ALTER TABLE RENAME COLUMN functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1490&quot;&gt;&lt;del&gt;DERBY-1490&lt;/del&gt;&lt;/a&gt;. I can&apos;t find any explanation for this restriction in the comments on that issue or in altertable.sql. Later on, altertable.sql was converted into AlterTableTest.java.&lt;/p&gt;</comment>
                            <comment id="14077755" author="rhillegas" created="Tue, 29 Jul 2014 15:25:41 +0100"  >&lt;p&gt;Code to verify that you can&apos;t rename a referenced table goes back to the open-sourcing of Derby. It is in the original version of renameTable.sql (later converted to RenameTableTest.java). So the motivation for this restriction is not documented in Derby&apos;s code archaeology. Maybe someone from IBM can look up the motivation for this restriction? Thanks.&lt;/p&gt;</comment>
                            <comment id="14077759" author="rhillegas" created="Tue, 29 Jul 2014 15:31:44 +0100"  >&lt;p&gt;I have documentation for Cloudscape 3.5 and 5.1. The RENAME TABLE command does not appear in 3.5, but it does appear in 5.1. The 5.1 Reference guide states that referenced tables can&apos;t be renamed. So it appears that the limitation goes back to the initial implementation.&lt;/p&gt;</comment>
                            <comment id="14077771" author="rhillegas" created="Tue, 29 Jul 2014 15:45:17 +0100"  >&lt;p&gt;The limitation can be found in DB2: &lt;a href=&quot;http://www-01.ibm.com/support/knowledgecenter/?lang=en#!/SSEPGG_8.2.0/com.ibm.db2.udb.doc/admin/r0000980.htm&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www-01.ibm.com/support/knowledgecenter/?lang=en#!/SSEPGG_8.2.0/com.ibm.db2.udb.doc/admin/r0000980.htm&lt;/a&gt;. However, the DB2 limitations are more extensive. According to that DB2 documentation, if a foreign key links two tables, then you can&apos;t rename either of them. If the Derby limitation were just a case of making Derby behave like DB2, then I&apos;d expect to see all of the DB2 limitations enforced.&lt;/p&gt;</comment>
                            <comment id="14079250" author="rhillegas" created="Wed, 30 Jul 2014 13:43:58 +0100"  >&lt;p&gt;Note that tests ran cleanly for me on derby-6672-01-ab-addTests.diff.&lt;/p&gt;</comment>
                            <comment id="14079365" author="jira-bot" created="Wed, 30 Jul 2014 16:17:53 +0100"  >&lt;p&gt;Commit 1614681 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1614681&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1614681&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6672&quot; title=&quot;Allow Derby to rename tables referenced by foreign keys&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6672&quot;&gt;&lt;del&gt;DERBY-6672&lt;/del&gt;&lt;/a&gt;: Allow the renaming of referenced tables; commit derby-6672-01-ab-addTests.diff.&lt;/p&gt;</comment>
                            <comment id="14079738" author="rhillegas" created="Wed, 30 Jul 2014 19:40:53 +0100"  >&lt;p&gt;Resolving. The patch lifts the limitation for referenced tables. The related limitation imposed by CHECK constraints can be addressed by a separate issue.&lt;/p&gt;</comment>
                            <comment id="14079758" author="gmazza" created="Wed, 30 Jul 2014 19:50:37 +0100"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12313704">DERBY-532</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12729793">DERBY-6677</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12656876" name="derby-6672-01-aa-allowRenameWithConstraints.diff" size="1135" author="rhillegas" created="Mon, 21 Jul 2014 16:23:51 +0100"/>
                            <attachment id="12658408" name="derby-6672-01-ab-addTests.diff" size="10016" author="rhillegas" created="Tue, 29 Jul 2014 14:50:06 +0100"/>
                            <attachment id="12656878" name="docpatch2.patch" size="1181" author="gmazza" created="Mon, 21 Jul 2014 16:34:45 +0100"/>
                    </attachments>
                <subtasks>
                            <subtask id="12729793">DERBY-6677</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 21 Jul 2014 13:22:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>406508</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzrt6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>406528</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>