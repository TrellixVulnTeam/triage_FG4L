<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:19:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6434/DERBY-6434.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6434] Incorrect privileges may be required for INSERT and DELETE statements.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6434</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This issue is a place to address problems with INSERT and DELETE statements similar to the problems affecting UPDATE statements recorded on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6429&quot; title=&quot;Privilege checks for UPDATE statements are wrong.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6429&quot;&gt;&lt;del&gt;DERBY-6429&lt;/del&gt;&lt;/a&gt;. In particular, &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6432&quot; title=&quot;INSERT/UPDATE incorrectly require user to have privilege to execute CHECK constraints on the target table.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6432&quot;&gt;&lt;del&gt;DERBY-6432&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6433&quot; title=&quot;INSERT/UPDATE incorrectly require user to have privilege to run generation expressions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6433&quot;&gt;&lt;del&gt;DERBY-6433&lt;/del&gt;&lt;/a&gt; list some of the problems with INSERT statements.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12684343">DERBY-6434</key>
            <summary>Incorrect privileges may be required for INSERT and DELETE statements.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                            <label>derby_backport_reject_10_10</label>
                    </labels>
                <created>Thu, 12 Dec 2013 20:25:59 +0000</created>
                <updated>Wed, 21 Jan 2015 00:23:36 +0000</updated>
                            <resolved>Fri, 30 May 2014 15:54:42 +0100</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13860254" author="rhillegas" created="Thu, 2 Jan 2014 15:14:16 +0000"  >&lt;p&gt;The discussion on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6429&quot; title=&quot;Privilege checks for UPDATE statements are wrong.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6429&quot;&gt;&lt;del&gt;DERBY-6429&lt;/del&gt;&lt;/a&gt; concluded that constraints, generated columns, and triggers do not impose any privilege burdens on INSERT/UPDATE/DELETE/MERGE statements. The privilege burdens related to constraints, generated columns, and triggers are satisfied at DDL time.&lt;/p&gt;

&lt;p&gt;As a result, I would state the privilege requirements for INSERT statements as follows. Let P be the union of the privileges granted to the current user and the privileges granted to the current role.&lt;/p&gt;

&lt;p&gt;1) P must contain INSERT privilege for the target table.&lt;/p&gt;

&lt;p&gt;2) P must contain all privileges needed to evaluate the query expression in the INSERT statement. These privileges include:&lt;/p&gt;

&lt;p&gt;a) SELECT privilege on all columns mentioned in the query expression.&lt;/p&gt;

&lt;p&gt;b) EXECUTE privilege on all functions mentioned in the query expression.&lt;/p&gt;

&lt;p&gt;c) USAGE privilege on all types, sequences, and aggregates mentioned in the query expression.&lt;/p&gt;</comment>
                            <comment id="13860649" author="rhillegas" created="Thu, 2 Jan 2014 19:38:16 +0000"  >&lt;p&gt;Attaching derby-6434-01-aa-correctInsertPrivs.diff. This patch corrects privilege checking for INSERT statements. I will run the full tests to shake out additional problems.&lt;/p&gt;

&lt;p&gt;The patch introduces a new VisitableFilter, which essentially short-circuits the addition of more permissions checks. The filter is applied after the INSERT&apos;s query source has been bound but before constraints, triggers, and generation expressions are attached.&lt;/p&gt;



&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-----------------&lt;/p&gt;

&lt;p&gt;A       java/engine/org/apache/derby/iapi/sql/compile/IgnoreFilter.java&lt;/p&gt;

&lt;p&gt;The new, short-circuiting filter.&lt;/p&gt;

&lt;p&gt;-----------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/InsertNode.java&lt;/p&gt;

&lt;p&gt;Use the short-circuiting filter after binding the query expression.&lt;/p&gt;

&lt;p&gt;-----------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java&lt;/p&gt;

&lt;p&gt;New tests.&lt;/p&gt;</comment>
                            <comment id="13860855" author="dagw" created="Thu, 2 Jan 2014 22:09:09 +0000"  >&lt;p&gt;I guess P should include privileges granted to PUBLIC as well. Can the functions mentioned in the query contain SQL? If so, the set of privileges P should include any privileges required by any nested connections &lt;b&gt;if&lt;/b&gt; the functions are declared to run by invoker&apos;s rights.&lt;/p&gt;</comment>
                            <comment id="13861479" author="rhillegas" created="Fri, 3 Jan 2014 12:53:39 +0000"  >&lt;p&gt;Thanks for those clarifications, Dag.&lt;/p&gt;</comment>
                            <comment id="13865477" author="rhillegas" created="Wed, 8 Jan 2014 14:30:25 +0000"  >&lt;p&gt;Attaching derby-6434-01-ac-correctInsertPrivs.diff. This rev corrects some additional problems which surfaced when I ran the full regression tests on the previous rev of the patch. I will re-run the regression tests now.&lt;/p&gt;

&lt;p&gt;This rev corrects two problems:&lt;/p&gt;

&lt;p&gt;1) A canonized wrong result in GeneratedColumnsPermsTest. There was a comment left over from work on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6429&quot; title=&quot;Privilege checks for UPDATE statements are wrong.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6429&quot;&gt;&lt;del&gt;DERBY-6429&lt;/del&gt;&lt;/a&gt;, noting that this wrong result would need to be addressed when INSERT privileges were corrected.&lt;/p&gt;

&lt;p&gt;2) A test case in RolesConferredPrivilegesTest broke because the previous rev altered the dependency checking for CHECK constraints which rely on role-based privileges.&lt;/p&gt;

&lt;p&gt;The fix for 2 is simple but it was tricky to find. I had expected that all dependencies would be identified at bind() time. So I was surprised to find that some in-memory dependencies are added by the execute() phase of statement evaluation. This looks wrong to me. In a private discussion with Dag, we theorized that the execute() time additions are a holdover from how the code behaved before we added support for definer&apos;s rights.&lt;/p&gt;

&lt;p&gt;The fix for 2 is to make ConstraintDescriptor.makeInvalid() call DependencyManager.invalidateFor() on the table descriptor after the CHECK constraint is implicitly dropped as a consequence of revoking a privilege. This forces Derby to take the same code path pursued when the CHECK constraint is explicitly dropped.&lt;/p&gt;

&lt;p&gt;I am highly suspicious of the many calls to DependencyManager.addDependency() which we see in the execute() time ConstantActions. Analyzing these suspicious calls is outside the scope of this JIRA. I will file a follow-on issue for this investigation.&lt;/p&gt;


&lt;p&gt;Touches the following additional files:&lt;/p&gt;

&lt;p&gt;------------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/dictionary/ConstraintDescriptor.java&lt;/p&gt;

&lt;p&gt;The fix for item 2.&lt;/p&gt;

&lt;p&gt;------------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GeneratedColumnsPermsTest.java&lt;/p&gt;

&lt;p&gt;The fix for item 1.&lt;/p&gt;</comment>
                            <comment id="13865602" author="jira-bot" created="Wed, 8 Jan 2014 16:35:29 +0000"  >&lt;p&gt;Commit 1556571 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1556571&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1556571&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6434&quot; title=&quot;Incorrect privileges may be required for INSERT and DELETE statements.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6434&quot;&gt;&lt;del&gt;DERBY-6434&lt;/del&gt;&lt;/a&gt;: Correct privileges required for INSERT statements; tests passed cleanly on derby-6434-01-ac-correctInsertPrivs.diff.&lt;/p&gt;</comment>
                            <comment id="13870861" author="rhillegas" created="Tue, 14 Jan 2014 16:25:35 +0000"  >&lt;p&gt;Attaching derby-6434-02-ac-correctDeletePrivs.diff. This patch corrects privilege checking for DELETE statements. I will run regression tests. It&apos;s likely that the tests will disclose some problems.&lt;/p&gt;

&lt;p&gt;The approach here is to add privilege checks only when compiling the WHERE clause of the DELETE statement. To accomplish this, the patch introduces two new concepts:&lt;/p&gt;

&lt;p&gt;1) Scope tracking - The compiler is given the capability to track what kind of clause it is processing. Currently, the compiler can analyze what&apos;s going on inside nodes BELOW the current node. This patch adds the capability to track what&apos;s going on ABOVE the current node. The patch gives the compiler the ability to record when it enters and leaves a particular scope. The patch adds the following new methods to CompilerContext:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    /**
     * Record that the compiler is entering a named scope. Increment the
     * depth counter for that scope.
     */
    public  void    beginScope( String scopeName );
    
    /**
     * Record that the compiler is exiting a named scope. Decrement the
     * depth counter for that scope.
     */
    public  void    endScope( String scopeName );

    /**
     * Get the current depth for the named scope. For instance, if
     * we are processing a WHERE clause inside a subquery which is
     * invoked inside an outer WHERE clause, the depth of the whereScope
     * would be 2. Returns 0 if the compiler isn&apos;t inside any such scope.
     */
    public  int     scopeDepth( String scopeName );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2) Scope filtering - A new VisitableFilter is added: ScopeFilter. This filter passes nodes only if the compiler is operating within a named scope.&lt;/p&gt;

&lt;p&gt;I think that we may be able to use this general scope tracking to eliminate the more limited scope tracking implemented by the following CompilerContext methods...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    int getReliability();
    void setReliability(int reliability);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...but that improvement falls outside the boundaries of this JIRA.&lt;/p&gt;

&lt;p&gt;In addition, I think that scope tracking can be used by other AST Visitors which need to be aware of how nodes nest. In particular, scope tracking may be useful for the work described in this derby-user email thread: &lt;a href=&quot;http://apache-database.10148.n7.nabble.com/Using-ASTParser-and-TreeWalker-for-parsing-SQL-query-td131219.html#a131629&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://apache-database.10148.n7.nabble.com/Using-ASTParser-and-TreeWalker-for-parsing-SQL-query-td131219.html#a131629&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;------------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/compile/CompilerContext.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/CompilerContextImpl.java&lt;/p&gt;

&lt;p&gt;Introduces scope tracking.&lt;/p&gt;

&lt;p&gt;------------------&lt;/p&gt;

&lt;p&gt;A       java/engine/org/apache/derby/iapi/sql/compile/ScopeFilter.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/SelectNode.java&lt;/p&gt;

&lt;p&gt;Introduces scope filtering and uses it to mark the boundaries of WHERE clauses.&lt;/p&gt;

&lt;p&gt;------------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/DeleteNode.java&lt;/p&gt;

&lt;p&gt;Uses scopes to restrict privilege checks to WHERE clauses.&lt;/p&gt;

&lt;p&gt;------------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java&lt;/p&gt;

&lt;p&gt;Regression tests for DELETE privileges.&lt;/p&gt;</comment>
                            <comment id="13871367" author="rhillegas" created="Tue, 14 Jan 2014 23:30:07 +0000"  >&lt;p&gt;Tests passed cleanly for me on derby-6434-02-ac-correctDeletePrivs.diff.&lt;/p&gt;</comment>
                            <comment id="13872091" author="jira-bot" created="Wed, 15 Jan 2014 14:03:51 +0000"  >&lt;p&gt;Commit 1558387 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1558387&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1558387&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6434&quot; title=&quot;Incorrect privileges may be required for INSERT and DELETE statements.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6434&quot;&gt;&lt;del&gt;DERBY-6434&lt;/del&gt;&lt;/a&gt;: Correct privilege checks for DELETE statements; commit derby-6434-02-ac-correctDeletePrivs.diff.&lt;/p&gt;</comment>
                            <comment id="13872133" author="rhillegas" created="Wed, 15 Jan 2014 14:41:12 +0000"  >&lt;p&gt;Attaching derby-6434-03-ac-testCaseForDerby-6432.diff, a test case verifying that &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6432&quot; title=&quot;INSERT/UPDATE incorrectly require user to have privilege to execute CHECK constraints on the target table.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6432&quot;&gt;&lt;del&gt;DERBY-6432&lt;/del&gt;&lt;/a&gt; has been fixed.&lt;/p&gt;

&lt;p&gt;Touches the following file:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java&lt;/p&gt;</comment>
                            <comment id="13872134" author="jira-bot" created="Wed, 15 Jan 2014 14:42:16 +0000"  >&lt;p&gt;Commit 1558398 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1558398&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1558398&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6434&quot; title=&quot;Incorrect privileges may be required for INSERT and DELETE statements.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6434&quot;&gt;&lt;del&gt;DERBY-6434&lt;/del&gt;&lt;/a&gt;: Test case verifying that &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6432&quot; title=&quot;INSERT/UPDATE incorrectly require user to have privilege to execute CHECK constraints on the target table.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6432&quot;&gt;&lt;del&gt;DERBY-6432&lt;/del&gt;&lt;/a&gt; has been fixed; commit derby-6434-03-ac-testCaseForDerby-6432.diff.&lt;/p&gt;</comment>
                            <comment id="13872389" author="rhillegas" created="Wed, 15 Jan 2014 18:31:52 +0000"  >&lt;p&gt;Attaching derby-6434-04-aa-dontNeedPrivOnGeneratedColumnTypeForInsert.diff. This corrects INSERT privileges so that you no longer need USAGE privilege on the types of generated columns. I will run regression tests.&lt;/p&gt;

&lt;p&gt;This fixes the remaining problem described by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6433&quot; title=&quot;INSERT/UPDATE incorrectly require user to have privilege to run generation expressions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6433&quot;&gt;&lt;del&gt;DERBY-6433&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/InsertNode.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java&lt;/p&gt;</comment>
                            <comment id="13872553" author="jira-bot" created="Wed, 15 Jan 2014 20:26:06 +0000"  >&lt;p&gt;Commit 1558559 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1558559&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1558559&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6434&quot; title=&quot;Incorrect privileges may be required for INSERT and DELETE statements.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6434&quot;&gt;&lt;del&gt;DERBY-6434&lt;/del&gt;&lt;/a&gt;: Don&apos;t make INSERT statements require USAGE privilege on the datatypes of generated columns; fix remaining problem described by &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6433&quot; title=&quot;INSERT/UPDATE incorrectly require user to have privilege to run generation expressions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6433&quot;&gt;&lt;del&gt;DERBY-6433&lt;/del&gt;&lt;/a&gt;; commit derby-6434-04-aa-dontNeedPrivOnGeneratedColumnTypeForInsert.diff.&lt;/p&gt;</comment>
                            <comment id="13873534" author="rhillegas" created="Thu, 16 Jan 2014 16:05:24 +0000"  >&lt;p&gt;Attaching a first draft of the release note for this issue.&lt;/p&gt;</comment>
                            <comment id="13873543" author="rhillegas" created="Thu, 16 Jan 2014 16:09:40 +0000"  >&lt;p&gt;I believe that I am done with work on this issue.&lt;/p&gt;</comment>
                            <comment id="13913278" author="mikem" created="Wed, 26 Feb 2014 18:30:42 +0000"  >&lt;p&gt;consider for 10.10 backport&lt;/p&gt;</comment>
                            <comment id="13918130" author="rhillegas" created="Mon, 3 Mar 2014 15:09:19 +0000"  >&lt;p&gt;The work on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6491&quot; title=&quot;SELECT statements incorrectly require USAGE privilege on column types&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6491&quot;&gt;DERBY-6491&lt;/a&gt; has uncovered another case where INSERTs are requiring overbroad privileges. USAGE privilege is incorrectly required on the user-defined type of a target table column. The following script shows this problem:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;connect &apos;jdbc:derby:memory:db;user=test_dbo;create=true&apos;;

call syscs_util.syscs_create_user( &apos;TEST_DBO&apos;, &apos;test_dbopassword&apos; );
call syscs_util.syscs_create_user( &apos;RUTH&apos;, &apos;ruthpassword&apos; );

connect &apos;jdbc:derby:memory:db;shutdown=true&apos;;

connect &apos;jdbc:derby:memory:db;user=test_dbo;password=test_dbopassword&apos; as dbo;

create type SourceValueType_045 external name &apos;java.util.HashMap&apos; language java;
create type TargetValueType_045 external name &apos;java.util.HashMap&apos; language java;

create function sourceValueExtractor_045( hashMap SourceValueType_045, hashKey varchar( 32672 ) ) returns int
language java parameter style java deterministic no sql
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.UDTTest.getIntValue&apos;;

create function sourceValueMaker_045( hashKey varchar( 32672 ), hashValue int ) returns SourceValueType_045
language java parameter style java deterministic no sql
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.UDTTest.makeHashMap&apos;;

create function targetValueMaker_045( hashKey varchar( 32672 ), hashValue int ) returns TargetValueType_045
language java parameter style java deterministic no sql
external name &apos;org.apache.derbyTesting.functionTests.tests.lang.UDTTest.makeHashMap&apos;;

create table targetTable_045( a TargetValueType_045 );
create table sourceTable_045( b SourceValueType_045 );

grant insert on targetTable_045 to ruth;
grant execute on function sourceValueExtractor_045 to ruth;
grant execute on function sourceValueMaker_045 to ruth;
grant execute on function targetValueMaker_045 to ruth;
grant select on sourceTable_045 to ruth;


connect &apos;jdbc:derby:memory:db;user=ruth;password=ruthpassword&apos; as ruth;

-- by themselves, the select and function calls don&apos;t require any type privileges
select test_dbo.targetValueMaker_045( &apos;bar&apos;, test_dbo.sourceValueExtractor_045( b, &apos;foo&apos; ) )
from test_dbo.sourceTable_045;

-- but this insert incorrectly fails because ruth doesn&apos;t have USAGE privilege on TargetValueType_045;
insert into test_dbo.targetTable_045
  select test_dbo.targetValueMaker_045( &apos;bar&apos;, test_dbo.sourceValueExtractor_045( b, &apos;foo&apos; ) )
  from test_dbo.sourceTable_045;


set connection dbo;

grant usage on type TargetValueType_045 to ruth;

set connection ruth;

-- now the insert works
insert into test_dbo.targetTable_045
  select test_dbo.targetValueMaker_045( &apos;bar&apos;, test_dbo.sourceValueExtractor_045( b, &apos;foo&apos; ) )
  from test_dbo.sourceTable_045;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13918244" author="rhillegas" created="Mon, 3 Mar 2014 16:46:52 +0000"  >&lt;p&gt;Attaching derby-6434-05-aa-selectDrivenInserts.diff. This patch removes privilege checks for user-defined types encountered while binding SELECTs. A special exception is made for explicit CASTs to user-defined types. Those CASTs should require that the user enjoy USAGE privilege on the target types. I am running tests now.&lt;/p&gt;


&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;---------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/SelectNode.java&lt;/p&gt;

&lt;p&gt;Disable UDT privilege checks when binding SELECTs.&lt;/p&gt;

&lt;p&gt;---------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/sql/compile/CastNode.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java&lt;/p&gt;

&lt;p&gt;But retain UDT privilege checks for explicit CASTs.&lt;/p&gt;

&lt;p&gt;---------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java&lt;/p&gt;

&lt;p&gt;Tests for this behavior change.&lt;/p&gt;</comment>
                            <comment id="13918470" author="jira-bot" created="Mon, 3 Mar 2014 19:26:13 +0000"  >&lt;p&gt;Commit 1573686 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;Rick Hillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1573686&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1573686&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6434&quot; title=&quot;Incorrect privileges may be required for INSERT and DELETE statements.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6434&quot;&gt;&lt;del&gt;DERBY-6434&lt;/del&gt;&lt;/a&gt;: Don&apos;t require privileges implicitly added by SELECT-driven INSERTS; tests passed cleanly on derby-6434-05-aa-selectDrivenInserts.diff.&lt;/p&gt;</comment>
                            <comment id="14013722" author="rhillegas" created="Fri, 30 May 2014 15:54:42 +0100"  >&lt;p&gt;I am done working on this issue. If there are further problems in this area, new issues can be logged.&lt;/p&gt;</comment>
                            <comment id="14284828" author="myrna" created="Wed, 21 Jan 2015 00:23:36 +0000"  >&lt;p&gt;bulk change to close all issues resolved but not closed and not changed since June 1, 2014.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12684313">DERBY-6431</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12683643">DERBY-6429</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12684332">DERBY-6432</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12684337">DERBY-6433</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12687869">DERBY-6449</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12695601">DERBY-6481</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12621134" name="derby-6434-01-aa-correctInsertPrivs.diff" size="15312" author="rhillegas" created="Thu, 2 Jan 2014 19:38:16 +0000"/>
                            <attachment id="12621980" name="derby-6434-01-ac-correctInsertPrivs.diff" size="17846" author="rhillegas" created="Wed, 8 Jan 2014 14:30:25 +0000"/>
                            <attachment id="12622877" name="derby-6434-02-ac-correctDeletePrivs.diff" size="20476" author="rhillegas" created="Tue, 14 Jan 2014 16:25:35 +0000"/>
                            <attachment id="12623149" name="derby-6434-03-ac-testCaseForDerby-6432.diff" size="4516" author="rhillegas" created="Wed, 15 Jan 2014 14:41:12 +0000"/>
                            <attachment id="12623184" name="derby-6434-04-aa-dontNeedPrivOnGeneratedColumnTypeForInsert.diff" size="5643" author="rhillegas" created="Wed, 15 Jan 2014 18:31:52 +0000"/>
                            <attachment id="12632297" name="derby-6434-05-aa-selectDrivenInserts.diff" size="8148" author="rhillegas" created="Mon, 3 Mar 2014 16:46:52 +0000"/>
                            <attachment id="12623408" name="releaseNote.html" size="1903" author="rhillegas" created="Thu, 16 Jan 2014 16:05:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 2 Jan 2014 22:09:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363415</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzkhl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363721</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>