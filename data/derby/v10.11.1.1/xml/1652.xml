<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:47:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1652/DERBY-1652.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1652] Update trigger updating the same rows as the original update does not  throw an exception ERROR 54038: &quot;Maximum depth of nested triggers was exceeded&quot; as it should</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1652</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Execution  of  an update trigger that updates the same row  as the original update will  recurse forever and exceed the maximum nesting level of 16 so should throw the exception:&lt;br/&gt;
ERROR 54038: &quot;Maximum depth of nested triggers was exceeded&quot;&lt;/p&gt;

&lt;p&gt;However, it  does not always throw the exception.   For example:&lt;/p&gt;


&lt;p&gt;CREATE TABLE &quot;TEST&quot; (                                           &lt;/p&gt;

&lt;p&gt; &quot;TESTID&quot; INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START &lt;br/&gt;
 WITH 1,&lt;br/&gt;
 INCREMENT BY 1),                                                &lt;/p&gt;

&lt;p&gt; &quot;INFO&quot; INTEGER NOT NULL,                                        &lt;/p&gt;

&lt;p&gt; &quot;TIMESTAMP&quot; TIMESTAMP NOT NULL DEFAULT &lt;br/&gt;
 &apos;1980-01-01-00.00.00.000000&apos;  &lt;br/&gt;
 );                                                              &lt;/p&gt;

&lt;p&gt; CREATE TRIGGER UPDATE_TEST                            &lt;br/&gt;
  AFTER UPDATE ON TEST                                 &lt;br/&gt;
  REFERENCING OLD AS OLD                               &lt;br/&gt;
  FOR EACH ROW MODE DB2SQL                             &lt;br/&gt;
  UPDATE TEST SET TIMESTAMP = CURRENT_TIMESTAMP WHERE  &lt;br/&gt;
  TESTID = OLD.TESTID;                                 &lt;br/&gt;
 INSERT INTO TEST (INFO) VALUES  &lt;br/&gt;
 (1),                            &lt;br/&gt;
 (2),                            &lt;br/&gt;
 (3); &lt;/p&gt;

&lt;p&gt; UPDATE TEST SET INFO = 1 WHERE TESTID = 2; &lt;/p&gt;

&lt;p&gt;Does not throw an exception:&lt;/p&gt;

&lt;p&gt;However, If the derby jars are updated to a new version, the correct exception is thrown.&lt;/p&gt;

&lt;p&gt; Replace derby jars with  new version&lt;br/&gt;
 Execute the following in ij:&lt;br/&gt;
 UPDATE TEST SET INFO = 1 WHERE TESTID = 2; &lt;br/&gt;
 ERROR 54038: Maximum depth of nested triggers was exceeded.&lt;/p&gt;


&lt;p&gt;Note: This issue stemmed from the Invalid issue,  &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1603&quot; title=&quot;ERROR 54038: &amp;quot;Maximum depth of nested triggers was exceeded&amp;quot; occurs when trigger fires after upating 10.1.2.5 jars to 10.1.3.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1603&quot;&gt;&lt;del&gt;DERBY-1603&lt;/del&gt;&lt;/a&gt;, because a user hit the exception after upgrade and thought the exception after upgrade, not the lack of exception before upgrade was the problem. This may be a common user error, so  we need a release note to help mitigate the issue.    I will add one shortly after confirming the correct trigger syntax. &lt;/p&gt;



</description>
                <environment></environment>
        <key id="12347431">DERBY-1652</key>
            <summary>Update trigger updating the same rows as the original update does not  throw an exception ERROR 54038: &quot;Maximum depth of nested triggers was exceeded&quot; as it should</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yipng">Yip Ng</assignee>
                                    <reporter username="kmarsden">Kathey Marsden</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Aug 2006 14:58:21 +0100</created>
                <updated>Tue, 30 Jun 2009 17:12:53 +0100</updated>
                            <resolved>Fri, 18 Aug 2006 00:15:28 +0100</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                                    <fixVersion>10.1.3.2</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12426232" author="djd" created="Mon, 7 Aug 2006 15:30:45 +0100"  >&lt;p&gt;Does the comment &quot;However, If the derby jars are updated to a new version&quot; mean that the bug is fixed in the new version and so thiis bug is already fixed.&lt;br/&gt;
Ie. it is just a problem with some older versions and upgrading to the latest 10.1 will mean the exception is always thrown, no matter how the trigger was created?&lt;/p&gt;</comment>
                            <comment id="12426240" author="kmarsden" created="Mon, 7 Aug 2006 15:45:31 +0100"  >&lt;p&gt;Dan asked:&lt;br/&gt;
&amp;gt;Does the comment &quot;However, If the derby jars are &amp;gt;updated to a new version&quot; mean that the bug is fixed in &amp;gt;the new version and so thiis bug is already fixed. &lt;/p&gt;

&lt;p&gt;No if you create this trigger in the latest 10.2 you will see that when it fires it does not give an exception.&lt;/p&gt;

&lt;p&gt;It is changing versions that  triggers the trigger to start giving the  exception.  So for instance if you create the trigger in 10.1.3.1,   it would fire without error until you moved to  10.1.3.2.  Then you would start seeing the exception when the trigger fires.  This is why I am concerned about user impact with this issue.   The incorrect  trigger will operate as the user might think it would until they upgrade and then  boom, their application works no more.&lt;/p&gt;



</comment>
                            <comment id="12426518" author="yipng" created="Tue, 8 Aug 2006 10:35:08 +0100"  >&lt;p&gt;Attaching patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1652&quot; title=&quot;Update trigger updating the same rows as the original update does not  throw an exception ERROR 54038: &amp;quot;Maximum depth of nested triggers was exceeded&amp;quot; as it should&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1652&quot;&gt;&lt;del&gt;DERBY-1652&lt;/del&gt;&lt;/a&gt;.  The patch is for the 10.1 codebase.  A similar patch is needed for 10.2, which I&apos;ll post as soon as derbyall completes.  &lt;/p&gt;

&lt;p&gt;The cause of the problem is that the trigger descriptor is created after the stored prepared statement(SPS) has been compiled, so the compiled form of the SPS is not aware of that its trigger action can fire on the trigger table itself.  Hence, the constant action was not generated correctly.  &lt;/p&gt;

&lt;p&gt;During upgrade, the SPSs are invalidated at database boot time.  The SPS will be recompile when it is being invoked and the recompilation at this point will of course detect the relevent trigger and generate the correct constant action for the SPS and produce the expected behavior when the SPS is executed - throwing an error when it exceeds the trigger&apos;s maximum depth in the above case.&lt;/p&gt;

&lt;p&gt;The simplest solution without introducing another revalidation of the SPS is to create the trigger descriptor first before compiling the SPS.  I ran derbyall and had to go over the testcases which have the wrong master outputs and I have corrected them on this patch.  Appreciate if someone can review this.&lt;/p&gt;

&lt;p&gt;On a side note, I ran derbyall on a &lt;b&gt;clean&lt;/b&gt; 10.1 codeline and I see the following&lt;br/&gt;
failures:&lt;/p&gt;

&lt;p&gt;derbyall/derbyall.fail:unit/T_Diagnosticable.unit&lt;br/&gt;
derbyall/derbyall.fail:i18n/urlLocale.sql&lt;br/&gt;
derbyall/derbyall.fail:i18n/messageLocale.sql&lt;br/&gt;
derbyall/derbyall.fail:i18n/iepnegativetests_ES.sql&lt;br/&gt;
derbyall/derbynetclientmats/derbynetmats.fail:derbynet/sysinfo.java&lt;br/&gt;
derbyall/derbynetmats/derbynetmats.fail:derbynet/sysinfo.java&lt;/p&gt;

&lt;p&gt;Is this a known problem?&lt;/p&gt;</comment>
                            <comment id="12426745" author="yipng" created="Tue, 8 Aug 2006 23:05:09 +0100"  >&lt;p&gt;Attaching patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1652&quot; title=&quot;Update trigger updating the same rows as the original update does not  throw an exception ERROR 54038: &amp;quot;Maximum depth of nested triggers was exceeded&amp;quot; as it should&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1652&quot;&gt;&lt;del&gt;DERBY-1652&lt;/del&gt;&lt;/a&gt;.  This patch applies to the trunk codeline.  Derbyall still running, will confirm if it passes successfully in subsequent comment.  Nevertheless, the patch is ready for review. &lt;/p&gt;</comment>
                            <comment id="12426861" author="yipng" created="Wed, 9 Aug 2006 08:15:07 +0100"  >&lt;p&gt;derbyall passes with derby1652-trunk-diff01.txt.&lt;/p&gt;</comment>
                            <comment id="12427091" author="yipng" created="Thu, 10 Aug 2006 04:47:36 +0100"  >&lt;p&gt;This patch appears to add a duplicate entry to the dependency table.  Need to investigate...&lt;/p&gt;</comment>
                            <comment id="12427297" author="yipng" created="Thu, 10 Aug 2006 19:07:41 +0100"  >&lt;p&gt;False alarm.  Renabling patch available. &lt;/p&gt;</comment>
                            <comment id="12427542" author="dagw" created="Fri, 11 Aug 2006 16:20:37 +0100"  >&lt;p&gt;The patch look good. &lt;/p&gt;

&lt;p&gt;When the trunk patch is applied I get the desired error on the repro,&lt;br/&gt;
without it, I do not.  I also checked with soft and hard upgrade (from&lt;br/&gt;
10.1 trunk) and its still works in those cases. I did not try out the&lt;br/&gt;
10.1 version of the patch.&lt;/p&gt;

&lt;p&gt;The diagnosis seems correct from looking locally at the code, although&lt;br/&gt;
I have not traced the logic fully to where the dependency actually&lt;br/&gt;
gets picked up.&lt;/p&gt;

&lt;p&gt;Minor nit on the code: The variable tmpTriggerId may be done away&lt;br/&gt;
with, or at least its comment text updated; it is no longer so&lt;br/&gt;
meaningful now that the sps creation is moved out, but if you prefer,&lt;br/&gt;
I am ok with leaving that to the committer&apos;s discretion.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12427573" author="yipng" created="Fri, 11 Aug 2006 19:04:28 +0100"  >&lt;p&gt;Thanks for the taking the time to review this patch, Dag.  The local variable tmpTriggerId is kept because it is still needed later by the createSPS method.  As for when the dependency will get picked up, it is at the trigger action&apos;s bind phase.&lt;/p&gt;</comment>
                            <comment id="12427903" author="dagw" created="Mon, 14 Aug 2006 15:33:17 +0100"  >&lt;p&gt;Yes, I know it&apos;s used by the createSPS methods; my point was that you&lt;br/&gt;
could do away with it by using TriggerDecriptor#getUUID instead once&lt;br/&gt;
triggerd is created. In the old code, a variable was necessary, since&lt;br/&gt;
the trigger was referenced before creation. Just a detail, I agree.&lt;/p&gt;</comment>
                            <comment id="12428023" author="kmarsden" created="Tue, 15 Aug 2006 04:16:25 +0100"  >&lt;p&gt;I don&apos;t know much about this code area but I looked at this patch as I am very keen to see this in to 10.2 and would also like to get it into 10.1 as soon as possible. The approach looks reasonable to me but I have to admit I don&apos;t understand the full impact of moving the trigger descriptor creation before  compiling the SPS, so I don&apos;t have too much to offer in terms of code review.&lt;/p&gt;

&lt;p&gt;On the tests, I have some questions about the the test updates&lt;br/&gt;
In updateableResultSet.java  we have this diff.&lt;/p&gt;

&lt;p&gt;                        rs.next();&lt;br/&gt;
                        System.out.println(&quot;column 1 on this row is &quot; + rs.getInt(1));&lt;br/&gt;
                        System.out.println(&quot;this update row will fire the update trigger which will update all the rows in the table to have c1=1 and hence no more rows will qualify for the resultset&quot;&lt;br/&gt;
);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;rs.updateLong(1,123);&lt;br/&gt;
+                       rs.updateLong(2,2);&lt;br/&gt;
                        rs.updateRow();&lt;br/&gt;
                        rs.next();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;By changing a different value are we still performing the action described?&lt;/p&gt;

&lt;p&gt;Similarly in triggerGeneral master update we had  previously  positive test cases that now throw an error.  Might we be able to use the workaround you gave me, to specify on which columns the trigger will fire to retain the original semantics of these tests?&lt;/p&gt;
</comment>
                            <comment id="12428060" author="yipng" created="Tue, 15 Aug 2006 09:00:54 +0100"  >&lt;p&gt;For the updatableResultSet.java, yes, it will still perform the action described because the triggers are also modified to preserve the original intention of the test.  &lt;/p&gt;

&lt;p&gt;The master output for triggerGeneral.sql were incorrect for those testcases, so I just replaced them with the expected results (I thought they were &quot;negative&quot; tests with wrong results).  I tried to preserve the original testcase intent whenever I can but the column list specification won&apos;t work on those testcases since they are using an &quot;after insert&quot; trigger.   And that test file already have tests to insert to another table from the trigger action, so now those tests really become &quot;negative&quot;...&lt;/p&gt;</comment>
                            <comment id="12428161" author="mikem" created="Tue, 15 Aug 2006 17:21:39 +0100"  >&lt;p&gt;I am looking at committing the trunk submitted diff, assuming there is no objection.  It seems like Dag&apos;s comment can be handled as a separate item.  To this end I ran all the tests on XP, sun jdk1.4.2 and got&lt;br/&gt;
3 diffs:&lt;br/&gt;
derbyall/derbynetmats/DerbyNet/jdbcapi/blobclob4BLOB.diff (known issue showing up in the tinderbox tests)&lt;br/&gt;
derbyall/upgrade/Upgrade_10_1_10_2.diff (known issue showing up in the tinderbox tests)&lt;br/&gt;
and the following I need to investigate:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Start: _Suite jdk1.4.2_07 DerbyNetClient derbynetmats:jdbcapi 2006-08-14 19:&lt;br/&gt;
57:40 ***&lt;br/&gt;
0 add&lt;br/&gt;
&amp;gt; ..................................E...E.&lt;br/&gt;
&amp;gt; There were 2 errors:&lt;br/&gt;
&amp;gt; 1) testUpdateUpdatedTupleScrollUpdateRow(org.apache.derbyTesting.functionTests&lt;br/&gt;
.tests.jdbcapi.URCoveringIndexTest)java.lang.OutOfMemoryError&lt;br/&gt;
&amp;gt; 2) testNextOnLastRowForwardOnly(org.apache.derbyTesting.functionTests.tests.jd&lt;br/&gt;
bcapi.ScrollResultSetTest)java.lang.OutOfMemoryError&lt;br/&gt;
&amp;gt; FAILURES!!!&lt;br/&gt;
&amp;gt; Tests run: 817,  Failures: 0,  Errors: 2&lt;br/&gt;
Test Failed.&lt;/li&gt;
			&lt;li&gt;End:   _Suite jdk1.4.2_07 DerbyNetClient derbynetmats:jdbcapi 2006-08-14 20:&lt;br/&gt;
01:56 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12428199" author="kmarsden" created="Tue, 15 Aug 2006 20:33:49 +0100"  >&lt;p&gt;Yip said&lt;br/&gt;
&amp;gt;I thought they were &quot;negative&quot; tests with wrong results&lt;br/&gt;
Thanks Yip,  I think I got confused because of the comments: &quot;--after&quot; and the trigger name: &quot;tgood&quot;  don&apos;t lend themselves to a negative test.  If more work is done on the patch it might be good to change them for clarity moving forward.&lt;/p&gt;

&lt;p&gt;ij&amp;gt; &amp;#8211; after&lt;br/&gt;
create trigger tgood after insert on x for each statement mode db2sql insert into x values 666;&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into x values 1;&lt;br/&gt;
ERROR 54038: Maximum depth of nested triggers was exceeded.&lt;/p&gt;</comment>
                            <comment id="12428223" author="mikem" created="Tue, 15 Aug 2006 21:57:09 +0100"  >&lt;p&gt;I reproduced the out of memory on my machine in a clean codeline so do not believe it is caused by this&lt;br/&gt;
patch.  I also have reported &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1701&quot; title=&quot;out of memory failures with the jdbcapi junit suite when run under derbynetclientsmats suite&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1701&quot;&gt;&lt;del&gt;DERBY-1701&lt;/del&gt;&lt;/a&gt; for those out of memory errors which have been showing up in the public regression test runs on a number of platforms. &lt;/p&gt;

&lt;p&gt;I committed this patch as is, feeling the comments above were not worth holding up the patch.  They seem like good things to do, but not necessary to hold up the fix.&lt;/p&gt;

&lt;p&gt;m1_142:97&amp;gt;svn commit&lt;/p&gt;

&lt;p&gt;Sending        java\engine\org\apache\derby\impl\sql\execute\CreateTriggerConstantAction.java&lt;br/&gt;
Sending        java\engine\org\apache\derby\impl\store\raw\data\OverflowInputStream.java&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\master\triggerGeneral.out&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\triggerGeneral.sql&lt;br/&gt;
Sending        java\testing\org\apache\derbyTesting\functionTests\tests\lang\updatableResultSet.java&lt;br/&gt;
Transmitting file data .....&lt;br/&gt;
Committed revision 431698.&lt;/p&gt;</comment>
                            <comment id="12428582" author="yipng" created="Thu, 17 Aug 2006 07:03:35 +0100"  >&lt;p&gt;I think this issue should be considered as resolved once the changes have also been updated to 10.1 codeline.&lt;/p&gt;</comment>
                            <comment id="12428584" author="kmarsden" created="Thu, 17 Aug 2006 07:45:01 +0100"  >&lt;p&gt;Thanks Yip. Committed to 10.1&lt;/p&gt;

&lt;p&gt;Date: Wed Aug 16 23:32:27 2006&lt;br/&gt;
New Revision: 432165&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=432165&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=432165&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
We still need the release note as users may hit the error unexpectedly on upgrade and may  need to change their triggers to specify which column in the trigger that will invoke the trigger action per  Yip&apos;s suggestion at:&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/Re%3A--jira--Commented%3A-%28DERBY-1603%29-ERROR-54038%3A-%22Maximum-depth-of-nested-triggers-was-exceeded%22-occurs-when-trigger-fires-after-upating-10.1.2.5-jars-to-10.1.3.1-p5689247.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/Re%3A--jira--Commented%3A-%28DERBY-1603%29-ERROR-54038%3A-%22Maximum-depth-of-nested-triggers-was-exceeded%22-occurs-when-trigger-fires-after-upating-10.1.2.5-jars-to-10.1.3.1-p5689247.html&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I&apos;m afraid I can&apos;t get to that right away after all. It will have to wait a while if I do it.&lt;/p&gt;

&lt;p&gt;Thanks &lt;/p&gt;

&lt;p&gt;Kathey&lt;/p&gt;
</comment>
                            <comment id="12430906" author="yipng" created="Mon, 28 Aug 2006 01:29:55 +0100"  >&lt;p&gt;Here is the release note for this jira:&lt;/p&gt;


&lt;p&gt;Release Note for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1652&quot; title=&quot;Update trigger updating the same rows as the original update does not  throw an exception ERROR 54038: &amp;quot;Maximum depth of nested triggers was exceeded&amp;quot; as it should&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1652&quot;&gt;&lt;del&gt;DERBY-1652&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
-------------------------------------------&lt;/p&gt;

&lt;p&gt;PROBLEM&lt;/p&gt;

&lt;p&gt;   In some cases, an after update trigger does not get fired upon itself when its trigger action contains &lt;br/&gt;
an update statement on the trigger&apos;s subject table.&lt;/p&gt;


&lt;p&gt;SYMPTOMS&lt;/p&gt;

&lt;p&gt;   (1)  When defining a trigger for the first time for a table, e.g.:&lt;/p&gt;


&lt;p&gt;        CREATE TABLE &quot;TEST&quot; (&quot;TESTID&quot; INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),&lt;br/&gt;
                             &quot;INFO&quot; INTEGER NOT NULL,&lt;br/&gt;
                             &quot;TIMESTAMP&quot; TIMESTAMP NOT NULL DEFAULT &apos;1980-01-01-00.00.00.000000&apos;);&lt;/p&gt;

&lt;p&gt;        CREATE TRIGGER UPDATE_TEST&lt;br/&gt;
        AFTER UPDATE ON TEST&lt;br/&gt;
        REFERENCING OLD AS OLD&lt;br/&gt;
        FOR EACH ROW MODE DB2SQL&lt;br/&gt;
            UPDATE TEST SET TIMESTAMP = CURRENT_TIMESTAMP WHERE TESTID = OLD.TESTID;&lt;/p&gt;

&lt;p&gt;        INSERT INTO TEST (INFO) VALUES (1), (2), (3);&lt;/p&gt;

&lt;p&gt;        UPDATE TEST SET INFO = 1 WHERE TESTID = 2;   &lt;/p&gt;


&lt;p&gt;        The above update statement executes successfully which it is incorrect.  The system should have issued &lt;br/&gt;
        SQLSTATE 54038 since it self-triggers to its maximum depth of 16.&lt;/p&gt;


&lt;p&gt;   (2)  With the above example, when an user upgrades to a higher version and issues the same update statement:&lt;/p&gt;

&lt;p&gt;        UPDATE TEST SET INFO = 1 WHERE TESTID = 2;  &lt;br/&gt;
        ERROR 54038: Maximum depth of nested triggers was exceeded. &lt;/p&gt;

&lt;p&gt;	The SQLSTATE 54038 is issued in this case because after database upgrade, the trigger action will be &lt;br/&gt;
        invalidated by the system and will force a recompilation of the trigger when it is fired.  The system&lt;br/&gt;
        generates the correct execution plan this time and since the trigger behavior have changed, this might &lt;br/&gt;
        cause applications to break unexpectedly.&lt;/p&gt;


&lt;p&gt;CAUSE&lt;/p&gt;

&lt;p&gt;   Derby&apos;s did not generate the correct execution plan for self-trigger invocation when such a trigger is declared&lt;br/&gt;
   for the first time on the subject table; hence, resulting in the stated problem above.  The affected version is &lt;br/&gt;
   Derby 10.0 and 10.1.&lt;/p&gt;


&lt;p&gt;SOLUTION&lt;/p&gt;

&lt;p&gt;   A fix to resolve the above Derby symptom is available in 10.1 and 10.2.&lt;/p&gt;


&lt;p&gt;WORKAROUND&lt;/p&gt;

&lt;p&gt;   If self-trigger invocation was not intended by the application, the application can select which column(s) on the&lt;br/&gt;
   update statement can cause the trigger to fire in the cREATE TRIGGER statement.  i.e.:&lt;/p&gt;

&lt;p&gt;   CREATE TRIGGER update_test&lt;br/&gt;
   AFTER UPDATE OF INFO ON test&lt;br/&gt;
   REFERENCING OLD AS old&lt;br/&gt;
   FOR EACH ROW MODE DB2SQL&lt;br/&gt;
       UPDATE test SET timestamp=current_timestamp WHERE testid=old.testid;&lt;/p&gt;

&lt;p&gt;   In the above statement, the trigger will only fire when an update is made to the &quot;info&quot; column instead of any column(s).&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12346807">DERBY-1603</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12332783">DERBY-1261</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12338363" name="derby1652-10.1.3-diff.txt" size="7394" author="yipng" created="Tue, 8 Aug 2006 10:35:08 +0100"/>
                            <attachment id="12338362" name="derby1652-10.1.3-stat.txt" size="355" author="yipng" created="Tue, 8 Aug 2006 10:35:08 +0100"/>
                            <attachment id="12338422" name="derby1652-trunk-diff01.txt" size="8715" author="yipng" created="Tue, 8 Aug 2006 23:05:09 +0100"/>
                            <attachment id="12338421" name="derby1652-trunk-stat01.txt" size="451" author="yipng" created="Tue, 8 Aug 2006 23:05:09 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 7 Aug 2006 14:30:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22623</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0uev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38745</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>