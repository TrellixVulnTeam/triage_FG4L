<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:08 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3538/DERBY-3538.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3538] NullPointerException during execution for query with LEFT OUTER JOIN whose inner table selects all constants.</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3538</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;For a query having a LEFT OUTER JOIN such that the right, or &quot;inner&quot;, table is a SELECT subquery whose result column list consists entirely of constants, Derby may throw an execution-time NPE while trying to apply the join predicate.  I say &quot;may&quot; because it depends on which join strategy the optimizer chooses.&lt;/p&gt;

&lt;p&gt;Using optimizer overrides I was able to reproduce this problem against trunk with the following (admittedly nonsense) query:&lt;/p&gt;

&lt;p&gt;  create table t1 (i int, j int);&lt;br/&gt;
  insert into t1 values (-1, -2), (-2, -4), (-3, -9);&lt;/p&gt;

&lt;p&gt;  select * from&lt;br/&gt;
    t1 left outer join&lt;br/&gt;
    (select -1 a, 1 b from t1) x0 --DERBY-PROPERTIES joinStrategy=NESTEDLOOP&lt;br/&gt;
   on x0.a = t1.i;&lt;/p&gt;

&lt;p&gt;I          |J          |A          |B&lt;br/&gt;
-----------------------------------------------&lt;br/&gt;
-1         |-2         |-1         |1&lt;br/&gt;
-1         |-2         |-1         |1&lt;br/&gt;
-1         |-2         |-1         |1&lt;br/&gt;
ERROR 38000: The exception &apos;java.lang.NullPointerException&apos; was thrown while evaluating an expression.&lt;br/&gt;
ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;/p&gt;

&lt;p&gt;Running the same query also failed with the same NPE on 10.0.2.1, even though optimizer overrides don&apos;t exist there.  So I&apos;m marking all known releases to be affected by this issue.&lt;/p&gt;

&lt;p&gt;Note: while this particular query may not make much sense, I have seen a user with a very large, auto-generated query that, when executed, fails due to this problem.  So it is worth investigating...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12391406">DERBY-3538</key>
            <summary>NullPointerException during execution for query with LEFT OUTER JOIN whose inner table selects all constants.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="army">A B</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Mar 2008 05:26:07 +0000</created>
                <updated>Fri, 21 Jan 2011 17:51:44 +0000</updated>
                            <resolved>Thu, 20 Mar 2008 15:31:36 +0000</resolved>
                                    <version>10.0.2.0</version>
                    <version>10.0.2.1</version>
                    <version>10.1.1.0</version>
                    <version>10.1.2.1</version>
                    <version>10.1.3.1</version>
                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                                    <fixVersion>10.1.3.2</fixVersion>
                    <fixVersion>10.2.2.1</fixVersion>
                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                    <fixVersion>10.5.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12578621" author="army" created="Fri, 14 Mar 2008 05:37:16 +0000"  >&lt;p&gt;I did some tracing and it &lt;b&gt;appears&lt;/b&gt; that the problem is in the &quot;doProjection()&quot; method of ProjectRestrictResultSet.  During code generation we recognize that the SELECT has all constants and thus that its result set is &quot;reusable&quot;; see ProjectRestrictNode.generateMinion(), esp. the call to:&lt;/p&gt;

&lt;p&gt;  mb.push(resultColumns.reusableResult());&lt;/p&gt;

&lt;p&gt;At execution, ProjectResrictResultSet sees that it can reuse the result set so it &quot;caches&quot; the execution row in doProjection() and then just returns that on subsequent calls.  However, when returning the cached row, the method does &lt;b&gt;not&lt;/b&gt; call &quot;setCurrentRow()&quot; with the cached row.  In some cases (esp. left outer join) that can mean that the &quot;current execution row&quot; corresponding to the ProjectRestrictResultSet remains null when it should be set to the cached row.  Thus when it comes time to evaluate the ON predicate, which references the ProjectRestrictResultSet&apos;s execution row, the predicate fails with an NPE because the &quot;current execution row&quot; is not set for that PRRS.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a quick change that resolves the reported NPE.  I have &lt;b&gt;not&lt;/b&gt; run any tests on this, so it&apos;s not for commit (yet).  I don&apos;t think I&apos;ll have much time to follow-up with this anytime soon, so if anyone out there can pick it up and take it to completion, that&apos;d be great...&lt;/p&gt;</comment>
                            <comment id="12578635" author="thomanie" created="Fri, 14 Mar 2008 07:57:40 +0000"  >&lt;p&gt;Patch, comments and explaination is very good.&lt;/p&gt;

&lt;p&gt;Running some tests on it now.&lt;/p&gt;</comment>
                            <comment id="12579519" author="kmarsden" created="Mon, 17 Mar 2008 17:21:33 +0000"  >&lt;p&gt;Here is the patch with a test added.  I ran suites.All and derbyall with Army&apos;s patch and all passed.  Thomas if you have not seen any issues with the patch I would like to commit and start backporting  back to 10.4,3,2 &amp;amp;1.&lt;/p&gt;</comment>
                            <comment id="12580792" author="kmarsden" created="Thu, 20 Mar 2008 15:31:36 +0000"  >&lt;p&gt;Committed fix and ported to 10.4,10.3,10.2, and 10.1&lt;/p&gt;</comment>
                            <comment id="12581842" author="thomanie" created="Tue, 25 Mar 2008 09:17:59 +0000"  >&lt;p&gt;Sorry for the very late reply. Just for the record I saw no problems with the patch applied.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12377873" name="d3538_notTested.diff" size="934" author="army" created="Fri, 14 Mar 2008 05:37:16 +0000"/>
                            <attachment id="12378047" name="derby-3538_diff.txt" size="3467" author="kmarsden" created="Mon, 17 Mar 2008 17:21:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 14 Mar 2008 07:57:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23698</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0lk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37311</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>