<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:51:48 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3189/DERBY-3189.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3189] Replication: Add connection url command options for starting and stopping master</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3189</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Add commands to start and stop the replication master using properties or connection url. Example:&lt;/p&gt;

&lt;p&gt;&apos;jdbc:derby:&amp;lt;host&amp;gt;&amp;lt;masterdb&amp;gt;;startMaster=true&apos;;&lt;br/&gt;
&apos;jdbc:derby:&amp;lt;host&amp;gt;&amp;lt;masterdb&amp;gt;;stopMaster=true&apos;;&lt;/p&gt;

&lt;p&gt;Connection url options that must be recognized:&lt;br/&gt;
startMaster=true&lt;br/&gt;
stopMaster=true&lt;br/&gt;
slaveHost=&amp;lt;host&amp;gt; (required)&lt;br/&gt;
slavePort=&amp;lt;port&amp;gt; (optional, defaults to 8001)&lt;/p&gt;

&lt;p&gt;See functional specification on Derby-2872 for further details.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12382092">DERBY-3189</key>
            <summary>Replication: Add connection url command options for starting and stopping master</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12372418">DERBY-2872</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="narayanan">V.Narayanan</assignee>
                                    <reporter username="jorgenlo">J&#248;rgen L&#248;land</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Nov 2007 12:39:13 +0000</created>
                <updated>Thu, 2 May 2013 03:29:10 +0100</updated>
                            <resolved>Thu, 6 Mar 2008 23:21:12 +0000</resolved>
                                    <version>10.4.1.3</version>
                                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12542468" author="jorgenlo" created="Wed, 14 Nov 2007 14:20:41 +0000"  >&lt;p&gt;Attaching patch v1a, handling startMaster and startSlave url commands in EmbedConnection. Waiting for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2954&quot; title=&quot;Add commands to NetworkServerControl for interacting with the replication functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2954&quot;&gt;&lt;del&gt;DERBY-2954&lt;/del&gt;&lt;/a&gt; before stopMaster can be activated (a single code line has been commented out).&lt;/p&gt;

&lt;p&gt;Waiting for review on this patch before writing tests. All tests pass.&lt;/p&gt;</comment>
                            <comment id="12542782" author="knutanders" created="Thu, 15 Nov 2007 14:00:33 +0000"  >&lt;p&gt;1a looks like a fine first increment to me. I will commit the patch when I have run the regression tests, unless there are objections.&lt;/p&gt;

&lt;p&gt;If I read the code correctly, getConnection(&quot;...startMaster=true&quot;) and getConnection(&quot;...stopMaster=true&quot;) will return a connection object. I have no strong feelings, but I just wondered if it would be more consistent to throw an exception like shutdown=true does, at least for stopMaster. Not that I&apos;m a big fan of messages like &quot;ERROR: Replication successfully started/stopped&quot;... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;And a tiny nit:&lt;/p&gt;

&lt;p&gt;+                                                org.apache.derby.iapi.&lt;br/&gt;
+                                                services.replication.&lt;br/&gt;
+                                                master.MasterFactory.&lt;/p&gt;

&lt;p&gt;Perhaps an import would be better than breaking the package name over three lines? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12542998" author="knutanders" created="Fri, 16 Nov 2007 08:42:50 +0000"  >&lt;p&gt;Committed revision 595591.&lt;/p&gt;</comment>
                            <comment id="12543010" author="jorgenlo" created="Fri, 16 Nov 2007 09:21:22 +0000"  >&lt;p&gt;Thanks for the review and commit, Knut. &lt;/p&gt;

&lt;p&gt;I see your point in the exception/connection argument, although wrapping a ReplicationSuccessfullyStartedException in a LOGIN_FAILED SQLException sounds pretty strange. I&apos;ll leave it as is for now. Changing this to throw an exception instead of returning a connection at a later stage should be very easy.&lt;/p&gt;

&lt;p&gt;I&apos;m leaving this issue open until junit tests have been added.&lt;/p&gt;</comment>
                            <comment id="12554185" author="narayanan" created="Sun, 23 Dec 2007 15:25:56 +0000"  >&lt;p&gt;The attached patch activates the stopmaster. I request for this patch to&lt;br/&gt;
be considered for reviews and comments and if everything is OK a commit&lt;br/&gt;
too.&lt;/p&gt;</comment>
                            <comment id="12556849" author="jorgenlo" created="Tue, 8 Jan 2008 09:13:27 +0000"  >&lt;p&gt;Hi Narayanan, &lt;/p&gt;

&lt;p&gt;I had a look at the stopMaster patch. The patch generally looks good, but I have a comment:&lt;/p&gt;

&lt;p&gt;In RawStore#stopReplicationMaster, you have &lt;/p&gt;

&lt;p&gt;MasterFactory masterFactory = (MasterFactory)&lt;br/&gt;
            Monitor.bootServiceModule(true, this, getMasterFactoryModule(),&lt;br/&gt;
                                      null);&lt;br/&gt;
        masterFactory.stopMaster();&lt;/p&gt;

&lt;p&gt;This does not work because in calls to bootServiceModule, the properties object (fourth parameter) can not be null (it results in NPE). However, instead of calling bootServiceModule, you should use findServiceModule - if a MasterFactory cannot be found, master replication mode cannot be running right? Also, findServiceModule does not take a properties object, thus solving the above NPE &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I would also have added a try-catch around the Monitor.find... code, and throw an exception like &quot;Cannot stop master. The database is not in replication master mode&quot;&lt;/p&gt;

&lt;p&gt;Nit: I would add a newline below the new code in all classes so that there is an empty line between each method.&lt;/p&gt;</comment>
                            <comment id="12557524" author="narayanan" created="Thu, 10 Jan 2008 02:41:00 +0000"  >&lt;p&gt;Thank you for the comments. I have addressed the issues pointed out in this patch.&lt;/p&gt;</comment>
                            <comment id="12557526" author="narayanan" created="Thu, 10 Jan 2008 02:42:28 +0000"  >&lt;p&gt;re-attaching with license grant&lt;/p&gt;</comment>
                            <comment id="12557938" author="jorgenlo" created="Fri, 11 Jan 2008 09:18:29 +0000"  >&lt;p&gt;Narayanan,&lt;/p&gt;

&lt;p&gt;v2 of the patch looks good, but you may consider providing some more information in the exception thrown from RawStore. Something along the lines of &quot;could not stop replication because the database is not in replication slave mode.&quot; &lt;/p&gt;

&lt;p&gt;I did not run the tests, but +1 to commit if the tests pass.&lt;/p&gt;</comment>
                            <comment id="12557943" author="narayanan" created="Fri, 11 Jan 2008 09:24:38 +0000"  >&lt;p&gt;Thank you for the review Jorgen, I will go by your suggestion for the exception information, I have not run tests on this one, I will run tests and post the results.&lt;/p&gt;</comment>
                            <comment id="12558598" author="oysteing" created="Mon, 14 Jan 2008 13:42:01 +0000"  >&lt;p&gt;It seems like some clean-up is missing if startMaster fails.  This&lt;br/&gt;
happened when I tried to connect to a non-existing slave:&lt;br/&gt;
(Please, tell me if I should rather report such bugs in new JIRAs)&lt;/p&gt;

&lt;p&gt;&amp;gt; java org.apache.derby.tools.ij&lt;br/&gt;
ij version 10.4&lt;br/&gt;
ij&amp;gt;  connect &apos;jdbc:derby:test;create=true&apos;;&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:test;startMaster=true;slaveHost=localhost&apos;;&lt;br/&gt;
ERROR XRE04: Could not establish a connection to the peer of the replicated database &apos;null&apos;.&lt;br/&gt;
ij&amp;gt; quit;&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.NullPointerException&lt;br/&gt;
        at org.apache.derby.impl.services.replication.master.MasterController.flushedTo(MasterController.java:278)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3953)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:1762)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.log.LogToFile.checkpointWithTran(LogToFile.java:1653)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.log.LogToFile.checkpoint(LogToFile.java:1469)&lt;br/&gt;
        at org.apache.derby.impl.store.raw.RawStore.stop(RawStore.java:363)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.TopService.stop(TopService.java:405)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.TopService.shutdown(TopService.java:349)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.shutdown(BaseMonitor.java:235)&lt;br/&gt;
        at org.apache.derby.impl.services.monitor.BaseMonitor.shutdown(BaseMonitor.java:201)&lt;br/&gt;
        at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:205)        at org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)&lt;br/&gt;
        at java.sql.DriverManager.getConnection(DriverManager.java:582)&lt;br/&gt;
        at java.sql.DriverManager.getConnection(DriverManager.java:207)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.cleanupGo(utilMain.java:416)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:249)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.go(Main.java:215)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:181)&lt;br/&gt;
        at org.apache.derby.impl.tools.ij.Main.main(Main.java:73)&lt;br/&gt;
        at org.apache.derby.tools.ij.main(ij.java:59)&lt;/p&gt;

</comment>
                            <comment id="12558610" author="jorgenlo" created="Mon, 14 Jan 2008 14:12:45 +0000"  >&lt;p&gt;I think you should report this as a new jira. The startmaster code is &lt;br/&gt;
relatively old&lt;/p&gt;



&lt;p&gt;&amp;#8211; &lt;br/&gt;
J&#248;rgen L&#248;land&lt;/p&gt;</comment>
                            <comment id="12558627" author="oysteing" created="Mon, 14 Jan 2008 15:05:24 +0000"  >&lt;p&gt;Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3318&quot; title=&quot;Missing clean-up after failed startMaster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3318&quot;&gt;&lt;del&gt;DERBY-3318&lt;/del&gt;&lt;/a&gt; for the problem after a failed startMaster.&lt;/p&gt;</comment>
                            <comment id="12558630" author="oysteing" created="Mon, 14 Jan 2008 15:09:58 +0000"  >&lt;p&gt;I tried a connnection with stopMaster=true in ij and it seemed to work well.  However, when I tried to exit ij, nothing happened.  A QUIT signal to the java process, showed that the  LogShipper thread is still around:&lt;/p&gt;

&lt;p&gt;Full thread dump Java HotSpot(TM) Server VM (1.6.0_01-b06 mixed mode):&lt;/p&gt;

&lt;p&gt;&quot;DestroyJavaVM&quot; prio=10 tid=0x08070c00 nid=0x2 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00000000..0xfe56bbb0&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;/p&gt;

&lt;p&gt;&quot;Thread-1&quot; prio=10 tid=0x08412400 nid=0x10 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0xb64cd000..0xb64cd970&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (on object monitor)&lt;br/&gt;
       at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0xf408f0e0&amp;gt; (a org.apache.derby.impl.services.replication.master.AsynchronousLogShipper)&lt;br/&gt;
  at org.apache.derby.impl.services.replication.master.AsynchronousLogShipper.run(AsynchronousLogShipper.java:133)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0xf408f0e0&amp;gt; (a org.apache.derby.impl.services.replication.master.AsynchronousLogShipper)&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12558684" author="narayanan" created="Mon, 14 Jan 2008 17:32:23 +0000"  >&lt;p&gt;I have given more information on the exception information as suggested by jorgen&lt;/p&gt;

&lt;p&gt;I ran tests on this patch, but saw some unrelated AccessControlExceptions which I saw when I ran on a freshworkspace also. Hence i concluded that these were not related to my patch.&lt;/p&gt;

&lt;p&gt;The old suite of tests ran without errors.&lt;/p&gt;</comment>
                            <comment id="12558720" author="narayanan" created="Mon, 14 Jan 2008 18:44:59 +0000"  >&lt;p&gt;Thank you for looking at the patch and commenting on it Oystein. The problem pointed out&lt;br/&gt;
I feel should be addressed as part of the stop implementation, hence I will move the issue &lt;br/&gt;
pointed out to Derby-3235. I have re-opened the issue and shall paste the latest issues pointed&lt;br/&gt;
out there also.&lt;/p&gt;</comment>
                            <comment id="12559024" author="oysteing" created="Tue, 15 Jan 2008 11:14:10 +0000"  >&lt;p&gt;Committed patch, StopMaster_impl_3189_v3.diff, as revision 612081.&lt;br/&gt;
(Changed the error message to say &quot;replication master mode&quot;, &lt;br/&gt;
instead of &quot;replication slave mode&quot;.&lt;/p&gt;</comment>
                            <comment id="12559026" author="narayanan" created="Tue, 15 Jan 2008 11:23:05 +0000"  >&lt;p&gt;Thanks a ton for the commit Oystein&lt;/p&gt;</comment>
                            <comment id="12559032" author="knutanders" created="Tue, 15 Jan 2008 12:12:38 +0000"  >&lt;p&gt;A tiny comment to the change in RawStore.java:&lt;/p&gt;

&lt;p&gt;+        catch (StandardException se) &lt;/p&gt;
{
+            throw StandardException.newException(
+                      SQLState.REPLICATION_UNABLE_TO_STOP_MASTER);
+        }

&lt;p&gt;I think it would be better to link se to the new exception (with StandardException.newException(String,Throwable)) so that we see why we were unable to stop the master.&lt;/p&gt;</comment>
                            <comment id="12560784" author="narayanan" created="Sun, 20 Jan 2008 08:50:24 +0000"  >&lt;p&gt;RawStore#MASTER_DB needs to be initialized in RawStore#startReplicationMaster. MasterController uses this property to set dbname.&lt;/p&gt;</comment>
                            <comment id="12561616" author="narayanan" created="Wed, 23 Jan 2008 09:21:58 +0000"  >&lt;p&gt;This patch propagates the master database name from&lt;br/&gt;
EmbedConnection to RawStore where the MASTER_DB property&lt;br/&gt;
is initialized before the master controller service is booted.&lt;/p&gt;</comment>
                            <comment id="12561971" author="jorgenlo" created="Thu, 24 Jan 2008 08:29:30 +0000"  >&lt;p&gt;Add to todo list: I noticed that the MasterController uses MasterFactory property names for slavehost and slaveport. Instead, MC should use the property names from Attributes like the SlaveController does. &lt;/p&gt;</comment>
                            <comment id="12565668" author="oysteing" created="Tue, 5 Feb 2008 09:23:02 +0000"  >&lt;p&gt;Committed patch StopMaster_Impl_v4.diff as revision 618584.&lt;/p&gt;</comment>
                            <comment id="12575951" author="narayanan" created="Thu, 6 Mar 2008 23:21:12 +0000"  >&lt;p&gt;All relevant patches have been committed! Resolving issue!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12382570">DERBY-3205</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12374145">DERBY-2954</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12373813" name="StopMaster_Impl_v4.diff" size="7649" author="narayanan" created="Wed, 23 Jan 2008 09:21:58 +0000"/>
                            <attachment id="12373814" name="StopMaster_Impl_v4.stat" size="475" author="narayanan" created="Wed, 23 Jan 2008 09:21:58 +0000"/>
                            <attachment id="12372142" name="StopMaster_impl_3189_v1.diff" size="5699" author="narayanan" created="Sun, 23 Dec 2007 15:25:56 +0000"/>
                            <attachment id="12372143" name="StopMaster_impl_3189_v1.stat" size="475" author="narayanan" created="Sun, 23 Dec 2007 15:25:56 +0000"/>
                            <attachment id="12372870" name="StopMaster_impl_3189_v2.diff" size="7201" author="narayanan" created="Thu, 10 Jan 2008 02:42:28 +0000"/>
                            <attachment id="12372868" name="StopMaster_impl_3189_v2.diff" size="7201" author="narayanan" created="Thu, 10 Jan 2008 02:41:00 +0000"/>
                            <attachment id="12372871" name="StopMaster_impl_3189_v2.stat" size="602" author="narayanan" created="Thu, 10 Jan 2008 02:42:28 +0000"/>
                            <attachment id="12372869" name="StopMaster_impl_3189_v2.stat" size="602" author="narayanan" created="Thu, 10 Jan 2008 02:41:00 +0000"/>
                            <attachment id="12373106" name="StopMaster_impl_3189_v3.diff" size="7263" author="narayanan" created="Mon, 14 Jan 2008 17:32:23 +0000"/>
                            <attachment id="12373107" name="StopMaster_impl_3189_v3.stat" size="602" author="narayanan" created="Mon, 14 Jan 2008 17:32:23 +0000"/>
                            <attachment id="12369514" name="derby-3189-1a.diff" size="10402" author="jorgenlo" created="Wed, 14 Nov 2007 14:20:41 +0000"/>
                            <attachment id="12369513" name="derby-3189-1a.stat" size="423" author="jorgenlo" created="Wed, 14 Nov 2007 14:20:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 15 Nov 2007 14:00:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30758</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0z6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39517</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>