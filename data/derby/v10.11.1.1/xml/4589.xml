<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:31:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4589/DERBY-4589.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4589] Corrupted database prevents startup and should be automatically repaired perhaps</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4589</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I have found a database in my application that prevents startup due to it being corrupted. &lt;br/&gt;
The driver reports that the database does not exist, even though it does. Then when my app tries to create the database using ;create=true; on the URL it fails.&lt;/p&gt;

&lt;p&gt;I think this happened due to the app being killed in Task Manager while it was creating the database.&lt;/p&gt;

&lt;p&gt;I have the database saved so that you can reproduce the problem. (I&apos;m not sure if I can attach it yet)&lt;/p&gt;
</description>
                <environment>Windows 2000, SP4. J2SE 1.6</environment>
        <key id="12459486">DERBY-4589</key>
            <summary>Corrupted database prevents startup and should be automatically repaired perhaps</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Rick Hillegas</assignee>
                                    <reporter username="swagman">Jeff Mckenzie</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Mar 2010 07:15:02 +0000</created>
                <updated>Mon, 17 Jun 2013 10:19:06 +0100</updated>
                            <resolved>Wed, 13 Apr 2011 14:36:54 +0100</resolved>
                                    <version>10.5.3.0</version>
                                    <fixVersion>10.8.1.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12846777" author="swagman" created="Thu, 18 Mar 2010 07:19:12 +0000"  >&lt;p&gt;This is a database that is empty, but is corrupted somehow. &lt;/p&gt;

&lt;p&gt;Derby tries to create a new database because it doesn&apos;t see this database, but fails to create a new database, thus preventing the app from ever using it.&lt;/p&gt;
</comment>
                            <comment id="12849258" author="rhillegas" created="Wed, 24 Mar 2010 16:17:49 +0000"  >&lt;p&gt;Other people have been confused by this behavior it seems.&lt;/p&gt;

&lt;p&gt;Various tasks have to be performed before the database exists. For instance, service.properties must be written and the system tables must be created. What should happen if you try to connect to a partially created database?&lt;/p&gt;

&lt;p&gt;1) Should you get a message saying that the database is unusable rather than a message saying that the database does not exist?&lt;/p&gt;

&lt;p&gt;2) Should Derby raise an error saying that it is deleting or renaming the half-created database so that you can retry database creation?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12849361" author="swagman" created="Wed, 24 Mar 2010 19:06:30 +0000"  >&lt;p&gt;If it is possible to determine that the database is half-created, then&lt;br/&gt;
either option 1 or 2 would be good. Otherwise, your app must make a guess.&lt;br/&gt;
At the moment my app renames the database to DB_NAME_corrupted, and carries&lt;br/&gt;
on making a new database (but it has no way of knowing whether there was any&lt;br/&gt;
data in the corrupted database, and no way of recovering it).&lt;/p&gt;

&lt;p&gt;The main issue is that Derby should tell you whether there is any data in&lt;br/&gt;
the database, or that it is just a half-created database. I suppose writing&lt;br/&gt;
a creation completed flag to the database somewhere would be helpful.&lt;br/&gt;
Database creation should be atomic like a transaction - all or nothing. If&lt;br/&gt;
that creation completed flag is missing on next startup, then Derby could&lt;br/&gt;
safely assume that the creation was not completed and finish it off or&lt;br/&gt;
rebuild the DB from scratch. I&apos;d favour option 1, because it gives the app&lt;br/&gt;
the chance to cancel the operation.&lt;/p&gt;

&lt;p&gt;I&apos;ve only encountered one other corrupt database, but that one had 20 MB of&lt;br/&gt;
data in it. All other problems I&apos;ve seen were related to this DB creation&lt;br/&gt;
issue.&lt;/p&gt;

&lt;p&gt;Thanks for your comments.&lt;/p&gt;

</comment>
                            <comment id="12850197" author="rhillegas" created="Fri, 26 Mar 2010 16:16:50 +0000"  >&lt;p&gt;May be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4098&quot; title=&quot;ERROR XBM0J: Directory /var/db/sw-abc already exists.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4098&quot;&gt;DERBY-4098&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13018879" author="rhillegas" created="Tue, 12 Apr 2011 16:50:52 +0100"  >&lt;p&gt;Attaching Test_4589.java, a repro for this problem. The program creates a database, shuts it down, deletes the service.properties in the database, then tries to re-create the database. This raises:&lt;/p&gt;

&lt;p&gt;ERROR XBM0J: Directory .../db_4589 already exists.&lt;/p&gt;</comment>
                            <comment id="13018889" author="rhillegas" created="Tue, 12 Apr 2011 17:16:24 +0100"  >&lt;p&gt;Attaching revamped version of the repro which deletes the database at startup in order to have a clean slate.&lt;/p&gt;</comment>
                            <comment id="13019004" author="rhillegas" created="Tue, 12 Apr 2011 20:37:41 +0100"  >&lt;p&gt;Attaching derby-4589-01-ab-missingServiceProperties.diff. This patch adds an error message for the case when the database directory exists but it is missing service.properties. I am running regression tests now.&lt;/p&gt;

&lt;p&gt;I agree with Mike&apos;s analysis on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4733&quot; title=&quot;Get error &amp;quot;Failed to create database - directory already exists&amp;quot; when attempting to connect to a database that failed during creation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4733&quot;&gt;&lt;del&gt;DERBY-4733&lt;/del&gt;&lt;/a&gt;. We should not delete a directory just because it is missing the files which signify an intact database. The best we can do is raise an error suggesting that the problem might be that Derby crashed during database creation. It should remain the user&apos;s responsibility to throw away the half-created database and try again.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/impl/services/monitor/StorageFactoryService.java&lt;/p&gt;

&lt;p&gt;Raise a special error if the database directory exists but it is missing service.properties.&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;M      java/engine/org/apache/derby/loc/messages.xml&lt;br/&gt;
M      java/shared/org/apache/derby/shared/common/reference/SQLState.java&lt;/p&gt;

&lt;p&gt;Special error message suggesting that Derby may have crashed during database creation.&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;A      java/testing/org/apache/derbyTesting/functionTests/tests/lang/HalfCreatedDatabaseTest.java&lt;br/&gt;
M      java/testing/org/apache/derbyTesting/functionTests/tests/lang/_Suite.java&lt;/p&gt;

&lt;p&gt;Test for this error condition.&lt;/p&gt;</comment>
                            <comment id="13019020" author="dagw" created="Tue, 12 Apr 2011 21:28:43 +0100"  >&lt;p&gt;Change looks good to me. Using ij, I verified manually that when deleting &quot;service.properties&quot;, I got the expected error.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13019314" author="rhillegas" created="Wed, 13 Apr 2011 14:28:01 +0100"  >&lt;p&gt;Thanks, Dag. The tests showed one problem: ErrorCodeTest needed the new error message. Attaching derby-4589-01-ac-missingServiceProperties.diff, which fixes ErrorCodeTest. Committed at subversion revision 1091772.&lt;/p&gt;</comment>
                            <comment id="13019317" author="rhillegas" created="Wed, 13 Apr 2011 14:34:30 +0100"  >&lt;p&gt;Ported revision 1091772 from trunk to 10.8 branch at subversion revision 1091774.&lt;/p&gt;</comment>
                            <comment id="13019319" author="rhillegas" created="Wed, 13 Apr 2011 14:36:54 +0100"  >&lt;p&gt;Further work could be done in the vetService() method if we want to catch other symptoms of failed database creation. However, I think that the check for the missing service.properties file covers much of the problem. Resolving the issue.&lt;/p&gt;</comment>
                            <comment id="13165600" author="kmarsden" created="Thu, 8 Dec 2011 21:51:07 +0000"  >&lt;p&gt;The SQState change on the error on database creation if a database exists at a minimum needs a release note, but I started a conversation about why it was changed in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5526&quot; title=&quot;on upgrade from 10.5 to 10.8.2 , getting  ERROR XBM0A: The database directory &amp;#39;C:\cygwin\home\debugfat\clientdb&amp;#39; exists. However, it does not contain the expected &amp;#39;service.properties&amp;#39; file.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5526&quot;&gt;&lt;del&gt;DERBY-5526&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5526?focusedCommentId=13165598&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13165598&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-5526?focusedCommentId=13165598&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13165598&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13165723" author="swagman" created="Fri, 9 Dec 2011 01:04:39 +0000"  >&lt;p&gt;If the database is completely empty and has no tables, why not just recreate the whole thing from scratch?&lt;/p&gt;

&lt;p&gt;You would only need a little flag somewhere for this. It gets written to once the database is fully created and opens normally. If it is in the wrong state, delete and recreate the database.&lt;/p&gt;

&lt;p&gt;OTOH, if you have definitely identified the problem, carry on...&lt;/p&gt;

</comment>
                            <comment id="13165742" author="kmarsden" created="Fri, 9 Dec 2011 01:40:51 +0000"  >&lt;p&gt;I don&apos;t think it would be good to change the behavior which has always existed which is that Derby will not attempt to create a database in a directory that already exists.  Also I think we never should delete user files on database creation. The corruption might be something other than a failed create attempt.  I actually have seen user cases come in where someone had deleted the service.properties file and we were able to recover their data by reconstructing the file. If Derby had simply blown it away, such recovery would not have been possible.&lt;/p&gt;


&lt;p&gt;But yes, it looks like for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5526&quot; title=&quot;on upgrade from 10.5 to 10.8.2 , getting  ERROR XBM0A: The database directory &amp;#39;C:\cygwin\home\debugfat\clientdb&amp;#39; exists. However, it does not contain the expected &amp;#39;service.properties&amp;#39; file.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5526&quot;&gt;&lt;del&gt;DERBY-5526&lt;/del&gt;&lt;/a&gt;,  the problem is the new error message has been thrown where it shouldn&apos;t be, so fixing  that should resolve the issue for the user expecting the old error in that case.&lt;/p&gt;

</comment>
                            <comment id="13685123" author="knutanders" created="Mon, 17 Jun 2013 10:19:06 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12468642">DERBY-4733</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12417026">DERBY-4098</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12534377">DERBY-5526</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12439128" name="2010-03.zip" size="12691" author="swagman" created="Thu, 18 Mar 2010 07:19:12 +0000"/>
                            <attachment id="12476132" name="Test_4589.java" size="2541" author="rhillegas" created="Tue, 12 Apr 2011 17:16:24 +0100"/>
                            <attachment id="12476129" name="Test_4589.java" size="2157" author="rhillegas" created="Tue, 12 Apr 2011 16:50:52 +0100"/>
                            <attachment id="12476154" name="derby-4589-01-ab-missingServiceProperties.diff" size="9955" author="rhillegas" created="Tue, 12 Apr 2011 20:37:41 +0100"/>
                            <attachment id="12476235" name="derby-4589-01-ac-missingServiceProperties.diff" size="11232" author="rhillegas" created="Wed, 13 Apr 2011 14:28:01 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 24 Mar 2010 16:17:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31289</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0eev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36153</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>