<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:17:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5282/DERBY-5282.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5282] Convert store/RowLockBasic.sql to junit</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5282</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description></description>
                <environment></environment>
        <key id="12510572">DERBY-5282</key>
            <summary>Convert store/RowLockBasic.sql to junit</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12502097">DERBY-5147</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="houxzhang">Houx Zhang</assignee>
                                    <reporter username="houxzhang">Houx Zhang</reporter>
                        <labels>
                            <label>gsoc2011</label>
                    </labels>
                <created>Thu, 16 Jun 2011 15:06:17 +0100</created>
                <updated>Fri, 1 Jul 2011 13:43:03 +0100</updated>
                            <resolved>Thu, 30 Jun 2011 03:44:18 +0100</resolved>
                                                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13056536" author="houxzhang" created="Tue, 28 Jun 2011 15:34:01 +0100"  >&lt;p&gt;Ask for help. There is one test can not pass. It&apos;s testFullCoveredIndexScan(). &lt;/p&gt;

&lt;p&gt;It says:&lt;br/&gt;
junit.framework.AssertionFailedError: Unexpected row count: expected:&amp;lt;1&amp;gt; but was:&amp;lt;5&amp;gt;&lt;/p&gt;

&lt;p&gt;But when I changed the data from 1 to 5, It syas:&lt;br/&gt;
junit.framework.AssertionFailedError: Unexpected row count: expected:&amp;lt;5&amp;gt; but was:&amp;lt;1&amp;gt;&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13056548" author="houxzhang" created="Tue, 28 Jun 2011 15:53:25 +0100"  >&lt;p&gt;Just for rename the patches.&lt;/p&gt;</comment>
                            <comment id="13056950" author="bryanpendleton" created="Wed, 29 Jun 2011 02:57:19 +0100"  >&lt;p&gt;The reason you are seeing 5 rows instead of the expected 1 row is because that particular&lt;br/&gt;
test is deciding to do row-level locking instead of table-level locking, and the select from lock_table&lt;br/&gt;
is returning 1 Table-level IS lock and 4 Row-level S locks.&lt;/p&gt;

&lt;p&gt;I ran the test with -Dderby.language.logQueryPlan=true and the choice of row-level locking&lt;br/&gt;
is also confirmed by the trace output:&lt;/p&gt;

&lt;p&gt;Tue Jun 28 18:25:12 PDT 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 242), (SESSIONID = 3), select a from a ******* Index Scan ResultSet for A using index A_IDX at repeatable read isolation level using share row locking chosen by the optimizer&lt;br/&gt;
Number of opens = 1&lt;br/&gt;
Rows seen = 4&lt;br/&gt;
Rows filtered = 0&lt;/p&gt;

&lt;p&gt;scan information:&lt;br/&gt;
        Bit set of columns fetched=&lt;/p&gt;
{0}
&lt;p&gt;        Number of columns fetched=1&lt;br/&gt;
        Number of deleted rows visited=0&lt;br/&gt;
        Number of pages visited=1&lt;br/&gt;
        Number of rows qualified=4&lt;br/&gt;
        Number of rows visited=4&lt;/p&gt;


&lt;p&gt;I extracted the relevant bit of SQL into a small separate file and ran it&lt;br/&gt;
under IJ, and sure enough when I do that Derby chooses table-level locking.&lt;/p&gt;

&lt;p&gt;Tue Jun 28 18:45:21 PDT 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 245), (SESSIONID = 1), --------------------------------------------------------------------------------&lt;br/&gt;
&amp;#8211; Do full covered index scan.&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
select a from a ******* Index Scan ResultSet for A using index A_IDX at serializable isolation level using share table locking chosen by the optimizer&lt;br/&gt;
Number of opens = 1&lt;br/&gt;
Rows seen = 4&lt;/p&gt;


&lt;p&gt;Then I noticed that in the row-level locking result, Derby is using &quot;repeatable&lt;br/&gt;
read&quot; isolation, while in the table-level locking result, Derby is using &quot;serializable&quot;&lt;br/&gt;
isolation.&lt;/p&gt;

&lt;p&gt;So I tried changing your test code so that instead of setting the isolation&lt;br/&gt;
level to TRANSACTION_REPEATABLE_READ in the setUp() method, it&lt;br/&gt;
sets TRANSACTION_SERIALIZABLE instead.&lt;/p&gt;

&lt;p&gt;And then the test passes &amp;#8211; Derby uses table level locking and all is well.&lt;/p&gt;

&lt;p&gt;What is curious is that clearly the original test looks like it is trying to use&lt;br/&gt;
REPEATABLE_READ isolation, as it contains:&lt;/p&gt;

&lt;p&gt;set isolation to RR;&lt;/p&gt;

&lt;p&gt;at the very start of the test.&lt;/p&gt;

&lt;p&gt;Perhaps this line in the test isn&apos;t actually working, though, and the test&lt;br/&gt;
is still using SERIALIZABLE, not REPEATABLE_READ isolation?&lt;/p&gt;

&lt;p&gt;Can you try changing the test in your environment to use SERIALIZABLE&lt;br/&gt;
isolation and verify whether or not the test then passes for you?&lt;/p&gt;</comment>
                            <comment id="13057111" author="knutanders" created="Wed, 29 Jun 2011 10:17:59 +0100"  >&lt;p&gt;The SET ISOLATION statement follows the DB2 naming of the isolation levels, which doesn&apos;t match the names used in SQL and JDBC. And just to make things extra confusing, they both have an isolation level called &quot;repeatable read&quot;, but not the same one, so &quot;set isolation to RR&quot; actually sets the isolation level to Connection.TRANSACTION_SERIALIZABLE. The mapping between DB2 isolation levels and JDBC isolation levels can be found here: &lt;a href=&quot;http://db.apache.org/derby/docs/dev/devguide/cdevconcepts15366.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://db.apache.org/derby/docs/dev/devguide/cdevconcepts15366.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13057197" author="houxzhang" created="Wed, 29 Jun 2011 13:28:23 +0100"  >&lt;p&gt;Thanks, Bryan and Knut. &lt;/p&gt;

&lt;p&gt;It does work with the new isolation.&lt;/p&gt;</comment>
                            <comment id="13057233" author="bryanpendleton" created="Wed, 29 Jun 2011 14:49:44 +0100"  >&lt;p&gt;Excellent! And interesting to learn about the differing names for the isolation levels. I knew that once, long ago... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m intending to commit this patch.&lt;/p&gt;</comment>
                            <comment id="13057588" author="bryanpendleton" created="Thu, 30 Jun 2011 03:44:18 +0100"  >&lt;p&gt;Committed the new test to the trunk as revision 1141368.&lt;/p&gt;

&lt;p&gt;Thank you for your contribution to Derby!&lt;/p&gt;</comment>
                            <comment id="13057643" author="knutanders" created="Thu, 30 Jun 2011 07:30:57 +0100"  >&lt;p&gt;A couple post-commit review comments:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The new test should have a license header.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We should probably remove the try/catch in the setUp() method. If something fails in setUp(), it would be better if the test case failed. Failures that are just printed to the console are less likely to be noticed.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The tearDown() method should call super.tearDown() before it returns so that BaseJDBCTestCase&apos;s cleanup also runs.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Saving the original isolation level in setUp() and restoring it in tearDown() shouldn&apos;t be necessary since the connection isn&apos;t used again after tearDown().&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13057846" author="houxzhang" created="Thu, 30 Jun 2011 15:29:17 +0100"  >&lt;p&gt;Thanks for your advice, Knut. I have adopted them in the new patch and added a class comment. Please check it, thanks.&lt;/p&gt;</comment>
                            <comment id="13057850" author="bryanpendleton" created="Thu, 30 Jun 2011 15:36:43 +0100"  >&lt;p&gt;The new patch looks great. I&apos;ll see about committing it later today, when I get back to my main computer.&lt;/p&gt;</comment>
                            <comment id="13057890" author="knutanders" created="Thu, 30 Jun 2011 16:45:00 +0100"  >&lt;p&gt;Thanks for making the changes, Houx. Just two small nits: The class name in the license header is incorrect, and the patch adds some trailing blanks after the dropTable() call in setUp(). Otherwise, the patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="13058156" author="bryanpendleton" created="Fri, 1 Jul 2011 01:49:06 +0100"  >&lt;p&gt;I corrected the class name in the header comment and cleaned up the trailing blanks, verified that the&lt;br/&gt;
test continues to run properly, and submitted the follow-on patch as revision 1141769.&lt;/p&gt;</comment>
                            <comment id="13058173" author="myrna" created="Fri, 1 Jul 2011 02:25:59 +0100"  >&lt;p&gt;Dag commented (6/30/2011) on the commit of revision 1141368 - apparently replies on the commit messages don&apos;t make it back into JIRA, so just for the record, here is that comment:&lt;br/&gt;
&quot;I didn&apos;t follow this one, but I notice setUp and teardown do not call&lt;br/&gt;
super.setUp, super.tearDown respectively as per the idiom. Is there a&lt;br/&gt;
reason for this here?  Notably BaseJDBCTestCase#tearDown does some&lt;br/&gt;
cleaning up. It may not be required here, but it&apos;s generally good to&lt;br/&gt;
stick to the idiom.&quot;&lt;/p&gt;

&lt;p&gt;Houx Zhang replied: &quot;Yes, Dag. I agree with you, and will adopt it.&quot;&lt;/p&gt;

&lt;p&gt;Looks like Bryan already added super.teardown with revision 1141769.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12484454" name="derby-5282-1.patch" size="53209" author="houxzhang" created="Tue, 28 Jun 2011 15:53:25 +0100"/>
                            <attachment id="12484455" name="derby-5282-1.state" size="535" author="houxzhang" created="Tue, 28 Jun 2011 15:53:25 +0100"/>
                            <attachment id="12484631" name="derby-5282-2.patch" size="53647" author="houxzhang" created="Wed, 29 Jun 2011 13:28:23 +0100"/>
                            <attachment id="12484632" name="derby-5282-2.state" size="535" author="houxzhang" created="Wed, 29 Jun 2011 13:28:23 +0100"/>
                            <attachment id="12484776" name="derby-5282-3.patch" size="3548" author="houxzhang" created="Thu, 30 Jun 2011 15:29:54 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Jun 2011 01:57:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31578</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36369</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>