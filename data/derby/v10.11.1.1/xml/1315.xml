<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:36:39 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1315/DERBY-1315.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1315] Statement optimization/compilation fails with OutOfMemoryException in largeCodeGen test  with embedded and framework DerbyNetClient</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1315</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The test case lang/largeCodeGen.java was run as is without giving any -Djvmflags=&quot;-mx512M -ms512M&quot; and gave the following error:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Start: largeCodeGen jdk1.4.2 largeDataTests:largeDataTests 2006-04-29 08:30:04 ***&lt;br/&gt;
27a28&lt;br/&gt;
&amp;gt; JVMST109: Insufficient space in Javaheap to satisfy allocation request&lt;br/&gt;
Test Failed.&lt;/li&gt;
			&lt;li&gt;End:   largeCodeGen jdk1.4.2 largeDataTests:largeDataTests 2006-04-29 08:32:01 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then the test case lang/largeCodeGen.java was run with -Djvmflags=&quot;-mx512M -ms512M&quot;, and it gave the following error:&lt;br/&gt;
&amp;lt; PASS: IN clause with 97000 parameters&lt;br/&gt;
20 del&lt;br/&gt;
&amp;lt; PASS: PREPARE: IN clause with 98000 parameters&lt;br/&gt;
21 del&lt;br/&gt;
&amp;lt; PASS: IN clause with 98000 parameters&lt;br/&gt;
22 del&lt;br/&gt;
&amp;lt; FAILED QUERY: IN clause with 99000 parameters. &lt;br/&gt;
22a19&lt;br/&gt;
&amp;gt; FAILED QUERY: IN clause with 97000 parameters.&lt;br/&gt;
Test Failed.&lt;/p&gt;

&lt;p&gt;Then I modified test case lang/largeCodeGen.java to set PRINT_FAILURE_EXCEPTION  to true and ran the test again. This time I got the following error and stack trace:&lt;/p&gt;

&lt;p&gt;MasterFileName = master/largeCodeGen.out&lt;br/&gt;
15a16,18&lt;br/&gt;
&amp;gt; java.sql.SQLException: Statement too complex. Try rewriting the query to remove &lt;br/&gt;
complexity. Eliminating many duplicate expressions or breaking up the query and &lt;br/&gt;
storing interim results in a temporary table can often help resolve this error&lt;br/&gt;
. SQLSTATE: XBCM4: Java class file format limit(s) exceeded: method:e1 code_leng&lt;br/&gt;
th (65577 &amp;gt; 65535) in generated class org.apache.derby.exe.ac46a08075x010bx203ax &lt;br/&gt;
d010x000050a9065e9.&lt;/p&gt;

&lt;p&gt;&amp;gt; Caused by: org.apache.derby.client.am.SqlException: Statement too complex. Try&lt;br/&gt;
 rewriting the query to remove complexity. Eliminating many duplicate expression&lt;br/&gt;
s or breaking up the query and storing interim results in a temporary table can &lt;br/&gt;
often help resolve this error. SQLSTATE: XBCM4: Java class file format limit(s)&lt;/p&gt;

&lt;p&gt;exceeded: method:e1 code_length (65577 &amp;gt; 65535) in generated class &lt;br/&gt;
org.apache.derby.exe.ac46a08075x010bx203axd010x000050a9065e9 .&lt;br/&gt;
&amp;gt;       ... 4 more&lt;br/&gt;
19 del&lt;br/&gt;
&amp;lt; PASS: IN clause with 97000 parameters&lt;br/&gt;
20 del&lt;br/&gt;
&amp;lt; PASS: PREPARE: IN clause with 98000 parameters&lt;br/&gt;
21 del&lt;br/&gt;
&amp;lt; PASS: IN clause with 98000 parameters&lt;br/&gt;
22 del&lt;/p&gt;

&lt;p&gt;&amp;lt; FAILED QUERY: IN clause with 99000 parameters. &lt;br/&gt;
22a22,29&lt;br/&gt;
&amp;gt; FAILED QUERY: IN clause with 97000 parameters.&lt;br/&gt;
&amp;gt; java.sql.SQLException: The parameter position &apos;31,465&apos; is out of range.  The &lt;br/&gt;
number of parameters for this prepared  statement is &apos;31,464&apos;.&lt;br/&gt;
&amp;gt;       at org.apache.derby.client.am.PreparedStatement.setInt(PreparedStatement&lt;br/&gt;
.java(Compiled Code))&lt;br/&gt;
&amp;gt; Caused by: org.apache.derby.client.am.SqlException: The parameter position &apos;31&lt;br/&gt;
,465&apos; is out of range.  The number of parameters for this prepared  statement is &lt;br/&gt;
 &apos;31,464&apos;.&lt;br/&gt;
&amp;gt;       at org.apache.derby.client.am.PreparedStatement.checkForValidParameterIn&lt;br/&gt;
dex(PreparedStatement.java(Compiled Code))&lt;br/&gt;
&amp;gt;       at org.apache.derby.client.am.PreparedStatement.checkSetterPreconditions &lt;br/&gt;
(PreparedStatement.java(Inlined Compiled Code))&lt;br/&gt;
&amp;gt;       at org.apache.derby.client.am.PreparedStatement.setIntX(PreparedStatemen&lt;br/&gt;
t.java(Inlined Compiled Code))&lt;br/&gt;
&amp;gt;       ... 5 more&lt;/p&gt;

&lt;p&gt;27a35,37&lt;br/&gt;
&amp;gt; java.sql.SQLException : Statement too complex. Try rewriting the query to remove &lt;br/&gt;
complexity. Eliminating many duplicate expressions or breaking up the query and &lt;br/&gt;
storing interim results in a temporary table can often help resolve this error &lt;br/&gt;
. SQLSTATE: XBCM4: Java class file format limit(s) exceeded: method:fillResultSe&lt;br/&gt;
t code_length (69127 &amp;gt; 65535) in generated class &lt;br/&gt;
org.apache.derby.exe.ac46a08075x010bx203axd010x000050a9065e11.&lt;br/&gt;
&amp;gt; Caused by: org.apache.derby.client.am.SqlException: Statement too complex. Try&lt;br/&gt;
 rewriting the query to remove complexity. Eliminating many duplicate expression&lt;br/&gt;
s or breaking up the query and storing interim results in a temporary table can &lt;br/&gt;
often help resolve this error. SQLSTATE: XBCM4: Java class file format limit(s)&lt;br/&gt;
exceeded: method:fillResultSet code_length (69127 &amp;gt; 65535) in generated class &lt;br/&gt;
org.apache.derby.exe.ac46a08075x010bx203axd010x000050a9065e11 .&lt;br/&gt;
&amp;gt;       ... 3 more&lt;br/&gt;
28 add&lt;br/&gt;
&amp;gt; java.sql.SQLException: Java exception: &apos;: java.lang.OutOfMemoryError&apos;.&lt;br/&gt;
&amp;gt; Caused by: org.apache.derby.client.am.SqlException: Java exception: &apos;: &lt;br/&gt;
java.lang.OutOfMemoryError &apos;.&lt;br/&gt;
&amp;gt;       ... 3 more&lt;br/&gt;
Test Failed.&lt;/p&gt;


</description>
                <environment>Linux - Suse 2.6.5-7.252</environment>
        <key id="12333512">DERBY-1315</key>
            <summary>Statement optimization/compilation fails with OutOfMemoryException in largeCodeGen test  with embedded and framework DerbyNetClient</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="ramank">Ramandeep Kaur</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 May 2006 06:33:33 +0100</created>
                <updated>Wed, 1 Jul 2009 13:59:20 +0100</updated>
                            <resolved>Fri, 22 Sep 2006 16:57:59 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.1.3.2</fixVersion>
                    <fixVersion>10.2.1.6</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12379099" author="kmarsden" created="Fri, 12 May 2006 00:41:41 +0100"  >&lt;p&gt;Raman told  us that client fails with this error:&lt;/p&gt;

&lt;p&gt;&amp;gt;&lt;br/&gt;
&amp;gt; MasterFileName = master/largeCodeGen.out&lt;br/&gt;
&amp;gt; 15a16,18&lt;br/&gt;
&amp;gt; &amp;gt; java.sql.SQLException: Statement too complex. Try rewriting the query to remove&lt;br/&gt;
&amp;gt; complexity. Eliminating many duplicate expressions or breaking up the query and&lt;br/&gt;
&amp;gt; storing interim results in a temporary table can often help resolve this error&lt;br/&gt;
&amp;gt; . SQLSTATE: XBCM4: Java class file format limit(s) exceeded: method:e1 code_leng&lt;br/&gt;
&amp;gt; th (65577 &amp;gt; 65535) in generated class org.apache.derby.exe.ac46a08075x010bx203ax&lt;/p&gt;


&lt;p&gt; This tells us that we are still dealing with the expected error.  The question is what is the difference between the embedded limits and the client limits. If you do a visual diff you can see more clearly.  Perhaps the starting value of the loop in the largeCodeGenTest will  have to be adjusted to see.&lt;/p&gt;
</comment>
                            <comment id="12379100" author="kmarsden" created="Fri, 12 May 2006 00:42:48 +0100"  >&lt;p&gt;Changing priority to Minor. There is no indication right now that this is a major functionalitiy impact for client.&lt;/p&gt;

</comment>
                            <comment id="12425806" author="skambha" created="Fri, 4 Aug 2006 19:12:24 +0100"  >&lt;p&gt;This test also fails in embedded mode. As far as I can tell, this test has not passed on this test machine for a long time now. I dont have the entire history to verify&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;
			&lt;ul&gt;
				&lt;li&gt;
				&lt;ul&gt;
					&lt;li&gt;
					&lt;ul&gt;
						&lt;li&gt;
						&lt;ul&gt;
							&lt;li&gt;
							&lt;ul&gt;
								&lt;li&gt;
								&lt;ul&gt;
									&lt;li&gt;Diff file largeDataTests/largeDataTests/largeCodeGen.diff&lt;/li&gt;
								&lt;/ul&gt;
								&lt;/li&gt;
							&lt;/ul&gt;
							&lt;/li&gt;
						&lt;/ul&gt;
						&lt;/li&gt;
					&lt;/ul&gt;
					&lt;/li&gt;
				&lt;/ul&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;Start: largeCodeGen jdk1.4.2 largeDataTests:largeDataTests 2006-07-29 05:54:45 ***&lt;br/&gt;
23 del&lt;br/&gt;
&amp;lt; PASS: PREPARE: SELECT with 800 unions&lt;br/&gt;
24 del&lt;br/&gt;
&amp;lt; PASS: EXECUTE SELECT with 800 unions Row data check ok&lt;br/&gt;
25 del&lt;br/&gt;
&amp;lt; PASS: PREPARE: SELECT with 900 unions&lt;br/&gt;
26 del&lt;br/&gt;
&amp;lt; PASS: EXECUTE SELECT with 900 unions Row data check ok&lt;br/&gt;
27 del&lt;br/&gt;
&amp;lt; FAILED QUERY: SELECT with 1000 unions.&lt;br/&gt;
27a23,24&lt;br/&gt;
&amp;gt; FAILED QUERY: SELECT with 800 unions.&lt;br/&gt;
&amp;gt; JVMST109: Insufficient space in Javaheap to satisfy allocation request&lt;br/&gt;
Test Failed.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12425810" author="djd" created="Fri, 4 Aug 2006 19:19:31 +0100"  >&lt;p&gt;When running this I saw the out of memory exception was during optimization.&lt;/p&gt;</comment>
                            <comment id="12425861" author="kartha" created="Fri, 4 Aug 2006 22:17:38 +0100"  >&lt;p&gt;Here is 4 line sql script to recreate the issue, hope this will help in debugging and fixing the OOM error. I also plan&lt;br/&gt;
to bump this issue from being a Minor to atleast a Major or higher.&lt;/p&gt;</comment>
                            <comment id="12426689" author="kartha" created="Tue, 8 Aug 2006 20:45:55 +0100"  >&lt;p&gt;I ran the largeCodeGen test as a stand alone application in Embedded mode against:&lt;br/&gt;
10.0.2.2.349072  	&lt;br/&gt;
10.1.2.4.384995  	&lt;br/&gt;
10.1.3.2.424154  	&lt;br/&gt;
10.2.0.5 alpha.424456&lt;/p&gt;

&lt;p&gt;While 10.2 now works in more number of complex cases (Logical operators with 800 parameters, IN clause with 98000 parameters) in comparision to 10.0 and 10.1, there has been a regression.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The scenario with SELECT with 800 and 900 unions used to PASS in 10.0 and 10.1 now FAILs in 10.2&lt;/li&gt;
	&lt;li&gt;The scenario  with SELECT with 10000 unions used to fail after compilation in 10.0 and 10.1.2. But with 10.1.3 and 10.2&lt;br/&gt;
  the statement fails during compile with OutOfMemory error.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In addition, under default settings, I noticed that in Derby 10.0, 10.1 if the exception (SQLSTATE= XBCM1, SQL Exception: Java linkage error thrown during load of generated class ) occurs during execution of the generated class, the generated  file is left behind on the file system. &lt;/p&gt;

&lt;p&gt;For example:&lt;br/&gt;
-rwxrwxrwa   1 Administrators  None             172052 Aug  8 10:53 ace5214067x010cxeeebx20c8x00001f6fcec04.class&lt;br/&gt;
-rwxrwxrwa   1 Administrators  None            5082617 Aug  8 10:53 ace5214067x010cxeeebx20c8x00001f6fcec05.class&lt;/p&gt;

&lt;p&gt;Whereas with 10.2, no files are left behind, which I think should be the right behaviour.&lt;/p&gt;

&lt;p&gt;Attaching the html file of my findings and the largeCodeGen.java&lt;/p&gt;



</comment>
                            <comment id="12426692" author="kartha" created="Tue, 8 Aug 2006 20:53:28 +0100"  >&lt;p&gt;Regression: Select scenarios started failing in 10.2 that used to pass in 10.1.x, hence raising its priority to Critical. &lt;/p&gt;</comment>
                            <comment id="12426693" author="rhillegas" created="Tue, 8 Aug 2006 20:54:04 +0100"  >&lt;p&gt;This is a potential regression, which we should examine. Bumping the urgency of this issue.&lt;/p&gt;</comment>
                            <comment id="12426695" author="kartha" created="Tue, 8 Aug 2006 20:57:57 +0100"  >&lt;p&gt;Forgot to add:&lt;br/&gt;
The test was run using -Xms512M -Xmx512M settings for Sun jdk1.5&lt;/p&gt;

&lt;p&gt;java  -Xms512M -Xmx512M largeCodeGen&lt;/p&gt;</comment>
                            <comment id="12426696" author="djd" created="Tue, 8 Aug 2006 20:58:41 +0100"  >&lt;p&gt;This is not a test issue, it&apos;s a bug in the SQL system.&lt;/p&gt;</comment>
                            <comment id="12426705" author="army" created="Tue, 8 Aug 2006 21:36:16 +0100"  >&lt;p&gt;&amp;gt; - The scenario with SELECT with 10000 unions used to fail after compilation in 10.0 &lt;br/&gt;
&amp;gt;    and 10.1.2. But with 10.1.3 and 10.2 the statement fails during compile with OutOfMemory error.&lt;/p&gt;

&lt;p&gt;I hate to say it, but it looks like this regression is caused by the changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt;.   Before the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt; changes Derby was generating plans for subqueries that did not agree with the optimizer&apos;s choices.  Phase 1 of the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt; patches made it so that Derby generates the plans chosen by the optimizer, as one might expect.  In order to do that, I added extra state to the optimizable nodes to keep track of which query plan went with which level of query.&lt;/p&gt;

&lt;p&gt;My guess is that this extra state is causing the optimizer to increase its memory usage-&lt;del&gt;and thus for very large queries, we end up running out of memory  This is backed by two things: 1) the changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt; apply specifically to UNIONs, and the query that&apos;s failing has 10,000 unions in it; 2) the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt; changes were checked into the 10.1.2.4 snapshot and thus are part of 10.1.3&lt;/del&gt;-which explains the behavior quoted above from Rajesh.&lt;/p&gt;

&lt;p&gt;I ran the repro with 512M against a version of the 10.1 jars that immediately precedes any &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt; check-ins and it &quot;passes&quot; (i.e. fails with linkage error); I then ran it against another version that was created shortly after all of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt; was ported to 10.1; it fails with OOM.&lt;/p&gt;

&lt;p&gt;So there&apos;s the regression.&lt;/p&gt;

&lt;p&gt;That said, it&apos;ll be virtually impossible for me to try to address this issue for the 10th--I&apos;m already booked with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1633&quot; title=&quot;Regression: The fields of views are not being calculated properly since 10.1.2.4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1633&quot;&gt;&lt;del&gt;DERBY-1633&lt;/del&gt;&lt;/a&gt; (the other regression...&lt;b&gt;sigh&lt;/b&gt;).&lt;/p&gt;

&lt;p&gt;Not sure where that leaves us.  Sorry.&lt;/p&gt;</comment>
                            <comment id="12426708" author="djd" created="Tue, 8 Aug 2006 21:49:48 +0100"  >&lt;p&gt;Hard to test if the code generation is better if the query fails in optimization. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12426775" author="kmarsden" created="Wed, 9 Aug 2006 00:21:46 +0100"  >&lt;p&gt;From what  I understand from the comments, this  should be marked as &lt;br/&gt;
1) A regression&lt;br/&gt;
2) Existing application impact.&lt;br/&gt;
3) At least major, maybe critical priority&lt;br/&gt;
4) Urgent Urgency for 10.2&lt;/p&gt;

&lt;p&gt;Any objections to these adjustments?&lt;/p&gt;</comment>
                            <comment id="12426780" author="kartha" created="Wed, 9 Aug 2006 00:52:58 +0100"  >&lt;p&gt;I agree this can be marked  a Medium (I had marked it as Critical in the morning) . It is already marked as Regression.&lt;/p&gt;</comment>
                            <comment id="12426783" author="djd" created="Wed, 9 Aug 2006 01:12:46 +0100"  >&lt;p&gt;Army wrote on derby-dev:&lt;/p&gt;

&lt;p&gt;&amp;gt;&lt;br/&gt;
&amp;gt; Any pointers to the type of extra state kept around. Is it query tree&lt;br/&gt;
&amp;gt; nodes, collections, something else?&lt;/p&gt;


&lt;p&gt;With Phase 1 of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-805&quot; title=&quot;Push join predicates into union and other set operations. DERBY-649 implemented scalar (single table) predicate pushdown. Adding join predicate push down could improve performance significantly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-805&quot;&gt;&lt;del&gt;DERBY-805&lt;/del&gt;&lt;/a&gt;, a HashMap was added to each query tree node.  The map holds an Object-&amp;gt;AccessPathImpl mapping for each OptimizerImpl that occurs above the node in the query tree.  The &quot;Object&quot; in this mapping is an object that already existed; the AccessPathImpl is a new object.&lt;/p&gt;

&lt;p&gt;See FromTable.addOrLoadBestPlanMapping()&lt;/p&gt;

&lt;p&gt;With Phase 4, additional entries to the HashMap are added for every UnionNode, PRN, or JoinNode that occurs above the node...and also for every occurrence of a node that doesn&apos;t implement &quot;optimizeIt()&quot;.  &lt;b&gt;Ouch&lt;/b&gt;.  After writing that, I find myself feeling rather ill.&lt;/p&gt;

&lt;p&gt;The comments around these additional calls explain why they are there:&lt;/p&gt;

&lt;p&gt;// It&apos;s possible that a call to optimize the [ node ] will cause&lt;br/&gt;
// a new &quot;truly the best&quot; plan to be stored in the underlying base&lt;br/&gt;
// tables.  If that happens and then we decide to skip that plan&lt;br/&gt;
// (which we might do if the call to &quot;considerCost()&quot; below decides&lt;br/&gt;
// the current path is infeasible or not the best) we need to be&lt;br/&gt;
// able to revert back to the &quot;truly the best&quot; plans that we had&lt;br/&gt;
// saved before we got here.  So with this next call we save the&lt;br/&gt;
// current plans using &quot;this&quot; node as the key.  If needed, we&apos;ll&lt;br/&gt;
// then make the call to revert the plans in OptimizerImpl&apos;s&lt;br/&gt;
// getNextDecoratedPermutation() method. &lt;/p&gt;</comment>
                            <comment id="12429317" author="djd" created="Mon, 21 Aug 2006 02:32:00 +0100"  >&lt;p&gt;To see this problem with largeCodeGen one must increase the number of union clauses created in the testUnions method of largeCodeGen (now a JUnit test run as part of derbyall)&lt;/p&gt;</comment>
                            <comment id="12431943" author="army" created="Thu, 31 Aug 2006 19:50:02 +0100"  >&lt;p&gt;Attaching a patch, d1315_v1.patch, to address this issue.  This patch adds a small amount of logic to remove entries from an Optimizable&apos;s &quot;best plan&quot; HashMap when they are no longer needed.  For more on when this is possible, see the discussion here:&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://article.gmane.org/gmane.comp.apache.db.derby.devel/26051&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://article.gmane.org/gmane.comp.apache.db.derby.devel/26051&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I built a set of insane jars with this patch applied and then ran some of the tests related to this issue:&lt;/p&gt;

&lt;p&gt;  1. largeCodeGen.sql (with Xmx512M):&lt;/p&gt;

&lt;p&gt;    This test now passes with the patch applied.  Or rather, the&lt;br/&gt;
    OutOfMemory error no longer occurs; instead, the query results&lt;br/&gt;
    in a java linkage error with message:&lt;/p&gt;

&lt;p&gt;      &apos;constant_pool(70288 &amp;gt; 65535): java.io.IOException&apos;&lt;/p&gt;

&lt;p&gt;    This is the same behavior that occurs with 10.1, and thus&lt;br/&gt;
    is no longer a regression.&lt;/p&gt;

&lt;p&gt;  2. largeCodeGen.java (as attached to this issue, with Xmx512M):&lt;/p&gt;

&lt;p&gt;    When run as-is with Sun jdk15, the logical operator tests fail&lt;br/&gt;
    with error 42ZA0 for 900 params; the IN tests fail with error&lt;br/&gt;
    42ZA0 with 99000 params; and the union tests fail with an OOM&lt;br/&gt;
    error for the 4700 union test case.  HOWEVER, this OOM appears&lt;br/&gt;
    to be caused by something other than the optimizer changes for&lt;br/&gt;
    Derby-805.  There are several reasons why I think (hope) this:&lt;/p&gt;

&lt;p&gt;    a. Sun jdk15 throws an error &quot;OOMError: PermGen space&quot; (or&lt;br/&gt;
       something like that); when I did a Google for that, all of&lt;br/&gt;
       the pages I (very quickly) browsed indicated that this is&lt;br/&gt;
       frequently the result of missed opportunities for garbage&lt;br/&gt;
       collection.&lt;/p&gt;

&lt;p&gt;    b. If I change largeCodeGen to start counting from 4500 unions&lt;br/&gt;
       (instead of 800), then the case of 4700, 4800, 4900, and&lt;br/&gt;
       5000 unions all pass.  I killed the test after that so I&lt;br/&gt;
       don&apos;t know how far it would have gone.&lt;/p&gt;

&lt;p&gt;    c. If I run with ibm142 instead of Sun jdk15, the test succeeds&lt;br/&gt;
       for as many as 6200 unions without problem (though memory&lt;br/&gt;
       usage does creep up for every iteration, suggesting that it&lt;br/&gt;
       would have run out of memory at some point).  I killed the&lt;br/&gt;
       test after that so I don&apos;t know how far it would have gone.&lt;/p&gt;

&lt;p&gt;    d. If I ONLY run the largeCodeGen test with 10000 unions (no&lt;br/&gt;
       other tests before it), then the query will fail with error&lt;br/&gt;
       42ZA0 instead of with an OOM.  I.e. this is the expected&lt;br/&gt;
       behavior (...isn&apos;t it?)&lt;/p&gt;

&lt;p&gt;    One other interesting thing to note with this test: if I change&lt;br/&gt;
    it so that it ONLY runs with 7500 unions (no other tests before&lt;br/&gt;
    it), the query compiles successfully for both ibm142 and jdk15.&lt;br/&gt;
    Then, for ibm142, it fails AT EXECUTION TIME with an OOM error,&lt;br/&gt;
    while for Sun jdk15 it executes without error.  Again, this&lt;br/&gt;
    suggests a difference between JVMs more than a problem with Derby.&lt;br/&gt;
    In either case the fact that compilation succeeds shows that the&lt;br/&gt;
    regression reported for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1315&quot; title=&quot;Statement optimization/compilation fails with OutOfMemoryException in largeCodeGen test  with embedded and framework DerbyNetClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1315&quot;&gt;&lt;del&gt;DERBY-1315&lt;/del&gt;&lt;/a&gt; is fixed with d1315_v1.patch&lt;br/&gt;
    (at least for insane builds).  The OOM error for ibm142 is an&lt;br/&gt;
    error that we never would have  reached with 10.1 because 10.1&lt;br/&gt;
    fails during compilation (or more specifically, during code&lt;br/&gt;
    generation) and thus never makes it to execution.  So this is&lt;br/&gt;
    a case where functionality that didn&apos;t work in 10.1 still doesn&apos;t&lt;br/&gt;
    work in 10.2-&lt;del&gt;at least not with ibm142&lt;/del&gt;-and thus this wouldn&apos;t be&lt;br/&gt;
    a regression.&lt;/p&gt;

&lt;p&gt;    This fact is further backed by the observation that a test of&lt;br/&gt;
    10000 unions will fail with error 42ZA0 on ibm142 during&lt;br/&gt;
    compilation--which means we never get to execution and thus&lt;br/&gt;
    no OOM error occurs in that case.&lt;/p&gt;

&lt;p&gt;  3. lang/largeCodeGen.java as a standalone JUnit test:&lt;/p&gt;

&lt;p&gt;    I uncommented the lines in lang/largeCodeGen that test 10000&lt;br/&gt;
    unions and then ran the test as a standalone JUnit with the&lt;br/&gt;
    following command (against an INSANE build):&lt;/p&gt;

&lt;p&gt;    java -Xmx512M junit.textui.TestRunner&lt;br/&gt;
      org.apache.derbyTesting.functionTests.test.lang.largeCodeGen&lt;/p&gt;

&lt;p&gt;    The result was:&lt;/p&gt;

&lt;p&gt;    ....&lt;br/&gt;
    Time: 593.543&lt;/p&gt;

&lt;p&gt;    OK (4 tests) &lt;/p&gt;

&lt;p&gt;    In other words, it took a good chunk of time (10 minutes), but the&lt;br/&gt;
    test &lt;b&gt;did&lt;/b&gt; pass with a max heap size of 512M.  Note that, of the&lt;br/&gt;
    10 minutes spent running the test, it looks like less than 20% of&lt;br/&gt;
    that time is spent in optimization; the rest of the time is&lt;br/&gt;
    (apparently?) used for generating code.&lt;/p&gt;

&lt;p&gt;    NOTE: If I try to run the same test with a SANE build, it fails&lt;br/&gt;
    with an OOM error.  So this perhaps requires more investigation.&lt;br/&gt;
    But d1315_v1.patch at least makes things better.&lt;/p&gt;

&lt;p&gt;I ran derbyall against sane jars with this patch on Red Hat Linux using ibm142 and there were no failures.  So I think the patch itself can be committed (pending review).  There is still more work, though, to figure out how to run largeCodeGen as part of derbyall: the test requires up to 512M of memory and maxes out my CPU for 10 minutes before completing--is it reasonable to add such a test derbyall?  Also, more investigation is required in order to figure out why the test passes with insane jars but fails (due to OOM) with sane jars.  At the very least, some kind of logic would be necessary to only run the test for insane builds, and I have no idea how (or if) that logic would work in JUnit.&lt;/p&gt;

&lt;p&gt;Comments/feedback would be appreciated....&lt;/p&gt;</comment>
                            <comment id="12432000" author="djd" created="Fri, 1 Sep 2006 00:04:47 +0100"  >&lt;p&gt; d1315_v1.patch applied to trunk Committed revision 439083. - Thanks Army&lt;/p&gt;</comment>
                            <comment id="12432222" author="mikem" created="Fri, 1 Sep 2006 20:56:45 +0100"  >&lt;p&gt;Fix merged to 10.2 branch as part of &quot;mega-merge&quot;:&lt;br/&gt;
r439377 | rhillegas | 2006-09-01 10:05:02 -0700 (Fri, 01 Sep 2006) | 1 line&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1725&quot; title=&quot;Placeholder for 10.2 merges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1725&quot;&gt;&lt;del&gt;DERBY-1725&lt;/del&gt;&lt;/a&gt;: Merge the following patches from the trunk to the 10.2 branch: No JI&lt;br/&gt;
RA (439048), &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1702&quot; title=&quot;j9 canon update needed for SQLException string (outparams, parameterMapping, iepnegativetests_ES)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1702&quot;&gt;&lt;del&gt;DERBY-1702&lt;/del&gt;&lt;/a&gt; (439209), &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1783&quot; title=&quot;Logical error in code for determining mode for opening of log files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1783&quot;&gt;&lt;del&gt;DERBY-1783&lt;/del&gt;&lt;/a&gt; (439128), &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1315&quot; title=&quot;Statement optimization/compilation fails with OutOfMemoryException in largeCodeGen test  with embedded and framework DerbyNetClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1315&quot;&gt;&lt;del&gt;DERBY-1315&lt;/del&gt;&lt;/a&gt; (439098, 43908&lt;br/&gt;
3), &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1566&quot; title=&quot;Document SQLStates in 10.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1566&quot;&gt;&lt;del&gt;DERBY-1566&lt;/del&gt;&lt;/a&gt; (439093).&lt;/p&gt;</comment>
                            <comment id="12432974" author="army" created="Wed, 6 Sep 2006 22:42:24 +0100"  >&lt;p&gt;A fix for this issue has been checked into 10.3 and ported to 10.2 (thanks Dan and Rick).  The remaining work is to update largeCodeGen to run with 10,000 unions and to investigate related issues.  I&apos;&apos;ve filed &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1818&quot; title=&quot;Renable largeCodeGen test to run with 10,000 UNIONs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1818&quot;&gt;DERBY-1818&lt;/a&gt; for tracking of that test work and am thus resolving this issue.&lt;/p&gt;</comment>
                            <comment id="12433248" author="army" created="Thu, 7 Sep 2006 22:43:13 +0100"  >&lt;p&gt;Haven&apos;t heard any futher comments/reactions to the fix, so closing the issue.  If any further issues arise, please file a new Jira.&lt;/p&gt;</comment>
                            <comment id="12436288" author="army" created="Wed, 20 Sep 2006 18:37:18 +0100"  >&lt;p&gt;Reopening this issue as I would like to see the fix ported to 10.1.&lt;/p&gt;</comment>
                            <comment id="12436291" author="army" created="Wed, 20 Sep 2006 18:47:47 +0100"  >&lt;p&gt;Attaching a patch for merging this change to 10.1.  There was a small conflict when I tried the &quot;svn merge&quot; command so I had to create the patch manually.  I confirmed that the patch works as expected by running the &quot;go.sql&quot; and &quot;largeCodeGen.java&quot; repros (as attached to this issue) against insane jars.  Without the patch I see OOM errors in both cases; with the applied, the OOM errors go away and are replaced with the expected 10.1 errors:&lt;/p&gt;

&lt;p&gt;go.sql:&lt;/p&gt;

&lt;p&gt;ERROR XJ001: Java exception: &apos;constant_pool(70285 &amp;gt; 65535): java.io.IOException&apos;.&lt;/p&gt;

&lt;p&gt;largeCodeGen:&lt;/p&gt;

&lt;p&gt; SQL Exception: Java linkage error thrown during load of generated class ...&lt;/p&gt;

&lt;p&gt;I&apos;m running derbyall now and will post the results when it finishes.&lt;/p&gt;</comment>
                            <comment id="12436331" author="army" created="Wed, 20 Sep 2006 21:18:38 +0100"  >&lt;p&gt;&amp;gt; I&apos;m running derbyall now and will post the results when it finishes.&lt;/p&gt;

&lt;p&gt;derbyall on Red Hat Linux with ibm142 ran with no new failuers against sane 10.1 jars built with d1315_10_1_merge.patch applied.  So that patch is ready for port to 10.1.&lt;/p&gt;</comment>
                            <comment id="12436897" author="army" created="Fri, 22 Sep 2006 16:57:59 +0100"  >&lt;p&gt;Thanks for commtting the merge patch to 10.1, Mike.  The fix is now in all three codelines so I&apos;ve updated the Fix-in and am closing the issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12349344">DERBY-1818</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12327441">DERBY-805</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12338407" name="1315-comparison.html" size="9472" author="kartha" created="Tue, 8 Aug 2006 20:45:55 +0100"/>
                            <attachment id="12341228" name="d1315_10_1_merge.patch" size="19023" author="army" created="Wed, 20 Sep 2006 18:47:47 +0100"/>
                            <attachment id="12339978" name="d1315_v1.patch" size="18698" author="army" created="Thu, 31 Aug 2006 19:50:01 +0100"/>
                            <attachment id="12338408" name="largeCodeGen.java" size="8841" author="kartha" created="Tue, 8 Aug 2006 20:45:55 +0100"/>
                            <attachment id="12326541" name="largeCodeGen.out" size="3933" author="ramank" created="Thu, 11 May 2006 06:35:26 +0100"/>
                            <attachment id="12338187" name="largeCodeGen.sql" size="6203" author="kartha" created="Fri, 4 Aug 2006 22:17:38 +0100"/>
                            <attachment id="12326543" name="largeCodeGen.tmp" size="9622" author="ramank" created="Thu, 11 May 2006 06:35:26 +0100"/>
                            <attachment id="12326542" name="largeCodeGen.tmpmstr" size="1325" author="ramank" created="Thu, 11 May 2006 06:35:26 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 11 May 2006 23:41:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22430</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10101"><![CDATA[Release Note Needed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0sfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38426</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>