<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:25:09 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-4711/DERBY-4711.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-4711] Hung thread after another thread is interrupted</title>
                <link>https://issues.apache.org/jira/browse/DERBY-4711</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;We&apos;ve seen a problem today where we have several threads querying our database and when one gets interrupted the others are stuck waiting for a lock. Here is the stack trace for the stuck thread(s):&lt;/p&gt;

&lt;p&gt;daemon prio=4&lt;br/&gt;
&quot;DefaultExecutorService-pool-1-thread-47&quot; Id=98 WAITING on org.apache.derby.impl.services.locks.ActiveLock@6e6f45a1&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on org.apache.derby.impl.services.locks.ActiveLock@6e6f45a1&lt;br/&gt;
	at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
	at org.apache.derby.impl.services.locks.ActiveLock.waitForGrant(ActiveLock.java:115)&lt;br/&gt;
	at org.apache.derby.impl.services.locks.ConcurrentLockSet.lockObject(ConcurrentLockSet.java:463)&lt;br/&gt;
	at org.apache.derby.impl.services.locks.ConcurrentLockSet.zeroDurationLockObject(ConcurrentLockSet.java:855)&lt;br/&gt;
	at org.apache.derby.impl.services.locks.AbstractPool.zeroDurationlockObject(AbstractPool.java:297)&lt;br/&gt;
	at org.apache.derby.impl.services.locks.ConcurrentPool.zeroDurationlockObject(ConcurrentPool.java:28)&lt;br/&gt;
	at org.apache.derby.impl.store.raw.xact.RowLocking2nohold.lockRecordForRead(RowLocking2nohold.java:89)&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.HeapController.lockRow(HeapController.java:520)&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.HeapController.lockRow(HeapController.java:638)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.index.B2IRowLocking3.lockRowOnPage(B2IRowLocking3.java:309)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.index.B2IRowLocking3._lockScanRow(B2IRowLocking3.java:599)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.index.B2IRowLockingRR.lockScanRow(B2IRowLockingRR.java:105)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:305)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1585)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.reloadArray(BulkTableScanResultSet.java:327)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.getNextRowCore(BulkTableScanResultSet.java:282)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:460)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:427)&lt;/li&gt;
	&lt;li&gt;locked org.apache.derby.impl.jdbc.EmbedConnection40@445d374b&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedResultSet.next(EmbedResultSet.java:371)&lt;br/&gt;
        ...&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment>Windows server 2008</environment>
        <key id="12467758">DERBY-4711</key>
            <summary>Hung thread after another thread is interrupted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="luke-nuix">Luke Quinane</assignee>
                                    <reporter username="luke-nuix">Luke Quinane</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Jun 2010 00:36:34 +0100</created>
                <updated>Mon, 17 Jun 2013 10:19:31 +0100</updated>
                            <resolved>Thu, 17 Feb 2011 21:34:04 +0000</resolved>
                                    <version>10.5.3.0</version>
                                    <fixVersion>10.5.3.2</fixVersion>
                    <fixVersion>10.6.2.2</fixVersion>
                    <fixVersion>10.7.1.1</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12881958" author="luke-nuix" created="Thu, 24 Jun 2010 00:37:19 +0100"  >&lt;p&gt;My original patch.&lt;/p&gt;</comment>
                            <comment id="12881959" author="luke-nuix" created="Thu, 24 Jun 2010 00:38:36 +0100"  >&lt;p&gt;Kristian&apos;s updated version of the patch.&lt;/p&gt;</comment>
                            <comment id="12882154" author="knutanders" created="Thu, 24 Jun 2010 14:47:19 +0100"  >&lt;p&gt;Thanks, Luke! The fix looks correct to me. I&apos;ll run the regression test suites with the patch and I intend to commit the patch if the tests pass. I also have a half-finished JUnit test that exposes this bug in my sandbox. I&apos;ll finish it and attach it here.&lt;/p&gt;</comment>
                            <comment id="12882156" author="knutanders" created="Thu, 24 Jun 2010 14:50:55 +0100"  >&lt;p&gt;Luke, I&apos;ve added you to the derby-developers group in JIRA so that you can assign issues to yourself. I assigned this issue to you.&lt;/p&gt;</comment>
                            <comment id="12882540" author="knutanders" created="Fri, 25 Jun 2010 12:54:32 +0100"  >&lt;p&gt;Committed Luke&apos;s patch to trunk with revision 957902.&lt;/p&gt;</comment>
                            <comment id="12882579" author="knutanders" created="Fri, 25 Jun 2010 14:49:41 +0100"  >&lt;p&gt;Here&apos;s a regression test case for the bug. Without the fix, the test completes in about 35 seconds and fails with this error:&lt;/p&gt;

&lt;p&gt;AssertionFailedError: Second thread needed 30008 ms to complete. Probably stuck waiting for a lock.&lt;/p&gt;

&lt;p&gt;With the fix, the test completes with no errors in about 5 seconds.&lt;/p&gt;</comment>
                            <comment id="12882608" author="mikem" created="Fri, 25 Jun 2010 16:22:44 +0100"  >&lt;p&gt;any chance to get comments in the code or in this issue about the cause of the problem and why this change fixes it? &lt;/p&gt;</comment>
                            <comment id="12882872" author="knutanders" created="Sat, 26 Jun 2010 19:05:08 +0100"  >&lt;p&gt;Hi Mike,&lt;/p&gt;

&lt;p&gt;I&apos;ve added this comment along with the fix in LockSet and ConcurrentLockSet:&lt;/p&gt;

&lt;p&gt;+                        // &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4711&quot; title=&quot;Hung thread after another thread is interrupted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4711&quot;&gt;&lt;del&gt;DERBY-4711&lt;/del&gt;&lt;/a&gt;: If waitForGrant() fails, we need to&lt;br/&gt;
+                        // remove ourselves from the queue so that those&lt;br/&gt;
+                        // behind us in the queue don&apos;t get stuck waiting for&lt;br/&gt;
+                        // us.&lt;/p&gt;

&lt;p&gt;The problem is that (Concurrent)LockSet.lockObject() only removes the waiter from the queue if the lock is obtained or if a timeout/deadlock exception is generated (using similar code further down in said method). When waitForGrant() fails (in this case with a StandardException wrapping an InterruptedException), it is not removed from the queue, and other threads are blocked by a lock request that&apos;s no longer alive. The fix removes the failed waiter from the queue, and allows the other threads to proceed.&lt;/p&gt;

&lt;p&gt;Hope this made things clearer.&lt;/p&gt;</comment>
                            <comment id="12882873" author="knutanders" created="Sat, 26 Jun 2010 19:09:57 +0100"  >&lt;p&gt;I&apos;ve committed the JUnit test case to trunk with revision 958264.&lt;/p&gt;</comment>
                            <comment id="12883074" author="knutanders" created="Mon, 28 Jun 2010 09:57:55 +0100"  >&lt;p&gt;A problem with the new test was reported on derby-dev: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-dev/201006.mbox/%3C4C27C93C.2020403@gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-dev/201006.mbox/%3C4C27C93C.2020403@gmail.com%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem appears to be that the commit in the main thread may allow the waiting thread to continue before it has received the interrupt, and thus it doesn&apos;t fail as it is supposed to. Adding a sleep between t1.interrupt() and commit() gives the interrupt time to propagate to the waiter before the main thread commits and releases its locks. See the attached patch junit-timing-fix.diff.&lt;/p&gt;

&lt;p&gt;The test failed on almost every run in my environment when using insane jars. After patching the test, I&apos;ve run it 200 times without seeing the failure.&lt;/p&gt;</comment>
                            <comment id="12883076" author="knutanders" created="Mon, 28 Jun 2010 10:00:06 +0100"  >&lt;p&gt;Committed junit-timing-fix.diff to trunk with revision 958508.&lt;/p&gt;</comment>
                            <comment id="12965238" author="kristwaa" created="Tue, 30 Nov 2010 14:45:58 +0000"  >&lt;p&gt;Reopening for backport to 10.6. One of the changes in the test harness is needed for another backport, and this fix seems nice to have in older branches too.&lt;/p&gt;</comment>
                            <comment id="12965246" author="kristwaa" created="Tue, 30 Nov 2010 14:55:25 +0000"  >&lt;p&gt;Backported to 10.6 with revision 1040551.&lt;/p&gt;</comment>
                            <comment id="12989875" author="kmarsden" created="Wed, 2 Feb 2011 23:36:46 +0000"  >&lt;p&gt;Reopen for backport&lt;/p&gt;</comment>
                            <comment id="12995085" author="mikem" created="Wed, 16 Feb 2011 00:18:57 +0000"  >&lt;p&gt;temp assigning to myself while backporting to 10.5&lt;/p&gt;</comment>
                            <comment id="12996096" author="mikem" created="Thu, 17 Feb 2011 21:34:04 +0000"  >&lt;p&gt;backported to 10.5.  resolving and resetting original owner.&lt;/p&gt;</comment>
                            <comment id="13685270" author="knutanders" created="Mon, 17 Jun 2013 10:19:31 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12497378">DERBY-4994</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12447907" name="interrupted-exception-fix.diff" size="2156" author="luke-nuix" created="Thu, 24 Jun 2010 00:38:36 +0100"/>
                            <attachment id="12447906" name="interrupted-exception-fix.patch" size="2448" author="luke-nuix" created="Thu, 24 Jun 2010 00:37:19 +0100"/>
                            <attachment id="12448189" name="junit-timing-fix.diff" size="786" author="knutanders" created="Mon, 28 Jun 2010 09:57:55 +0100"/>
                            <attachment id="12448056" name="junit.diff" size="7947" author="knutanders" created="Fri, 25 Jun 2010 14:49:41 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 24 Jun 2010 13:47:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24422</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0hxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36725</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>