<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:14:28 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-6227/DERBY-6227.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-6227] Distinct aggregates don&apos;t work well with territory-based collation</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6227</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt; When working on &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5840&quot; title=&quot;Clean up compiler warnings introduced by using Java 5 language features&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5840&quot;&gt;&lt;del&gt;DERBY-5840&lt;/del&gt;&lt;/a&gt;, I noticed that GroupedAggregateResultSet would do duplicate elimination by comparing the java.lang.String representation of the values. With territory-based collation, it is possible that two values that have different java.lang.String representation should be considered duplicates, and this logic will produce incorrect results.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;ij version 10.10&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:memory:db;territory=en_US;collation=TERRITORY_BASED:PRIMARY;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create table t(i int, s varchar(10));&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into t values (1, &apos;a&apos;), (1, &apos;a&apos;), (2, &apos;b&apos;), (2, &apos;B&apos;), (3, &apos;a&apos;), (3, &apos;A&apos;), (3, &apos;b&apos;), (3, &apos;B&apos;), (3, &apos;c&apos;);&lt;br/&gt;
9 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select distinct s from t;&lt;br/&gt;
S         &lt;br/&gt;
----------&lt;br/&gt;
b         &lt;br/&gt;
a         &lt;br/&gt;
c         &lt;/p&gt;

&lt;p&gt;3 rows selected&lt;br/&gt;
ij&amp;gt; select i, count(distinct s) from t group by i;&lt;br/&gt;
I          |2          &lt;br/&gt;
-----------------------&lt;br/&gt;
1          |1          &lt;br/&gt;
2          |2          &lt;br/&gt;
3          |5          &lt;/p&gt;

&lt;p&gt;3 rows selected&lt;/p&gt;

&lt;p&gt;I would have expected the last query to return&lt;/p&gt;

&lt;p&gt;(1, 1)&lt;br/&gt;
(2, 1)&lt;br/&gt;
(3, 3)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12649304">DERBY-6227</key>
            <summary>Distinct aggregates don&apos;t work well with territory-based collation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                            <label>derby_triage10_11</label>
                    </labels>
                <created>Fri, 24 May 2013 12:26:12 +0100</created>
                <updated>Tue, 14 Oct 2014 03:07:44 +0100</updated>
                            <resolved>Tue, 14 Oct 2014 03:07:44 +0100</resolved>
                                    <version>10.6.1.0</version>
                    <version>10.6.2.1</version>
                    <version>10.7.1.1</version>
                    <version>10.8.1.2</version>
                    <version>10.8.2.2</version>
                    <version>10.8.3.0</version>
                    <version>10.9.1.0</version>
                    <version>10.10.1.1</version>
                                    <fixVersion>10.10.2.1</fixVersion>
                    <fixVersion>10.11.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13687700" author="dagw" created="Wed, 19 Jun 2013 08:14:06 +0100"  >&lt;p&gt;Triaged for 10.11. Marking urgent as this could lead to data corruption.&lt;/p&gt;</comment>
                            <comment id="13687722" author="dagw" created="Wed, 19 Jun 2013 08:28:20 +0100"  >&lt;p&gt;Triaged for 10.11.&lt;/p&gt;</comment>
                            <comment id="14035690" author="knutanders" created="Wed, 18 Jun 2014 14:41:38 +0100"  >&lt;p&gt;I think the fix for this bug is to make the list of distinct values hold DataValueDescriptors instead of java.lang.String objects, since the DataValueDescriptor classes implement equals() in a way that takes the database collation into consideration.&lt;/p&gt;

&lt;p&gt;The attached patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12651122/12651122_d6227-1a.diff&quot; title=&quot;d6227-1a.diff attached to DERBY-6227&quot;&gt;d6227-1a.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; changes GroupedAggregateResultSet so that it does that. All regression tests ran cleanly with that patch, including a new test case for this bug.&lt;/p&gt;

&lt;p&gt;I wasn&apos;t quite sure if it was safe to store the DVDs directly in the list of distinct values, or if they would need to be cloned first (because some result sets reuse old DVDs when reading new rows, and we don&apos;t want the values in the list to change). I concluded that it was safe to store them directly, because distinct aggregates always take their rows from a sorter and not directly from the result set, and the sorter returns clones of the original DVDs. I added an assert that verifies that the row is read from the sorter, and a comment that says we should check ResultSet.needsToClone() if we ever start reading directly from the result set when processing distinct aggregates.&lt;/p&gt;</comment>
                            <comment id="14036075" author="dagw" created="Wed, 18 Jun 2014 19:17:40 +0100"  >&lt;p&gt;Looks like a good patch to me. Makes me wonder whether we have other places in the execution machinery that uses plain Strings instead of DVDs.. Thanks for adding that comment caveat. +1&lt;/p&gt;</comment>
                            <comment id="14037180" author="jira-bot" created="Thu, 19 Jun 2014 10:44:17 +0100"  >&lt;p&gt;Commit 1603793 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603793&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1603793&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6227&quot; title=&quot;Distinct aggregates don&amp;#39;t work well with territory-based collation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6227&quot;&gt;&lt;del&gt;DERBY-6227&lt;/del&gt;&lt;/a&gt;: Distinct aggregates don&apos;t work well with territory-based collation&lt;/p&gt;

&lt;p&gt;Make the duplicate elimination use the DataValueDescriptors directly instead&lt;br/&gt;
of converting the values to String objects first. This ensures that the&lt;br/&gt;
collation rules of the database are used to compare the values, and those&lt;br/&gt;
rules may be different from those used by String.equals().&lt;/p&gt;</comment>
                            <comment id="14037220" author="knutanders" created="Thu, 19 Jun 2014 11:43:02 +0100"  >&lt;p&gt;Thanks, Dag. That is a good question. I just happened to stumble across this problem. I&apos;m not sure if there&apos;s any systematic way of finding other instances of it. There are not many callers of DVD.getString() left in the impl.sql.execute package now, so hopefully this was just a one-off.&lt;/p&gt;</comment>
                            <comment id="14167236" author="mamtas" created="Fri, 10 Oct 2014 19:12:41 +0100"  >&lt;p&gt;I will work on backporting this to 10.10&lt;/p&gt;</comment>
                            <comment id="14170372" author="jira-bot" created="Tue, 14 Oct 2014 03:04:08 +0100"  >&lt;p&gt;Commit 1631604 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mamtas&quot; class=&quot;user-hover&quot; rel=&quot;mamtas&quot;&gt;Mamta A. Satoor&lt;/a&gt; in branch &apos;code/branches/10.10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631604&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1631604&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6227&quot; title=&quot;Distinct aggregates don&amp;#39;t work well with territory-based collation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6227&quot;&gt;&lt;del&gt;DERBY-6227&lt;/del&gt;&lt;/a&gt;(Distinct aggregates don&apos;t work well with territory-based collation)&lt;/p&gt;

&lt;p&gt;Backporting to 10.10&lt;/p&gt;

&lt;p&gt;Had to hand tweek the changes in GroupedAggregateResultSet.java but there weren&apos;t too many changes. derbyall and junit suite ran fine.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12746192">DERBY-6759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12651122" name="d6227-1a.diff" size="7587" author="knutanders" created="Wed, 18 Jun 2014 14:41:38 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Jun 2013 07:14:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>329631</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzepo7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>329966</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>