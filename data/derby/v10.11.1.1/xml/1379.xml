<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:10:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1379/DERBY-1379.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1379] NIST tests fail on jdk16 after introduction of JDBC4 driver autoloading</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1379</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;When running derbyall on jdk16 the Nist tests fails with the following exception:&lt;/p&gt;

&lt;p&gt;  java.security.AccessControlException: access denied&lt;br/&gt;
  (java.util.PropertyPermission user.dir read)&lt;/p&gt;

&lt;p&gt;The tests started to fail after autoloading of JDBC drivers was added to the embedded driver (see &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-930&quot; title=&quot;Add support for autoloading of Derby client drivers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-930&quot;&gt;&lt;del&gt;DERBY-930&lt;/del&gt;&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;To reproduce the problem you need (a) to run from jar files (not class files) and (b) have the DB2 driver in the class path.&lt;/p&gt;
</description>
                <environment>Sun JDK 1.6</environment>
        <key id="12343990">DERBY-1379</key>
            <summary>NIST tests fail on jdk16 after introduction of JDBC4 driver autoloading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="olav">Olav Sandstaa</assignee>
                                    <reporter username="olav">Olav Sandstaa</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Jun 2006 19:32:18 +0100</created>
                <updated>Tue, 13 Jun 2006 19:30:46 +0100</updated>
                            <resolved>Tue, 13 Jun 2006 19:29:40 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12414951" author="olav" created="Tue, 6 Jun 2006 20:30:31 +0100"  >
&lt;p&gt;Updating this jira with the main findings from the email discussions&lt;br/&gt;
covering this issue. The complete discussion can be found here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/jdk16-and-suite-derbyall---128-failures-t1596754.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/jdk16-and-suite-derbyall---128-failures-t1596754.html&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;The call stack for security exception that causes the Nist tests to fail:&lt;/p&gt;

&lt;p&gt;java.security.AccessControlException: access denied (java.util.PropertyPermission user.dir read)&lt;br/&gt;
   at java.security.AccessControlContext.checkPermission(AccessControlContext.java:323)&lt;br/&gt;
   at java.security.AccessController.checkPermission(AccessController.java:546)&lt;br/&gt;
   at java.lang.SecurityManager.checkPermission(SecurityManager.java:532)&lt;br/&gt;
   at java.lang.SecurityManager.checkPropertyAccess(SecurityManager.java:1285)&lt;br/&gt;
   at java.lang.System.getProperty(System.java:652)&lt;br/&gt;
   at java.io.UnixFileSystem.resolve(UnixFileSystem.java:118)&lt;br/&gt;
   at java.io.File.getCanonicalPath(File.java:559)&lt;br/&gt;
   at org.apache.derby.impl.io.DirStorageFactory.doInit(DirStorageFactory.java:190)&lt;br/&gt;
   at org.apache.derby.impl.io.BaseStorageFactory.init(BaseStorageFactory.java:87)&lt;br/&gt;
   at org.apache.derby.impl.services.monitor.StorageFactoryService.privGetStorageFactoryInstance(StorageFactoryService.java:201)&lt;br/&gt;
   at org.apache.derby.impl.services.monitor.StorageFactoryService.access$400(StorageFactoryService.java:64)&lt;br/&gt;
   at org.apache.derby.impl.services.monitor.StorageFactoryService$11.run(StorageFactoryService.java:774)&lt;br/&gt;
   at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
   at org.apache.derby.impl.services.monitor.StorageFactoryService.getCanonicalServiceName(StorageFactoryService.java:768)&lt;br/&gt;
   at org.apache.derby.impl.services.monitor.BaseMonitor.findProviderAndStartService(BaseMonitor.java:1537)&lt;br/&gt;
   at org.apache.derby.impl.services.monitor.BaseMonitor.startPersistentService(BaseMonitor.java:990)&lt;br/&gt;
   at org.apache.derby.iapi.services.monitor.Monitor.startPersistentService(Monitor.java:541)&lt;br/&gt;
   at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:1591)&lt;br/&gt;
   at org.apache.derby.impl.jdbc.EmbedConnection.&amp;lt;init&amp;gt;(EmbedConnection.java:216)&lt;br/&gt;
   at org.apache.derby.impl.jdbc.EmbedConnection30.&amp;lt;init&amp;gt;(EmbedConnection30.java:72)&lt;br/&gt;
   at org.apache.derby.impl.jdbc.EmbedConnection40.&amp;lt;init&amp;gt;(EmbedConnection40.java:47)&lt;br/&gt;
   at org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:64)&lt;br/&gt;
   at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:200)&lt;br/&gt;
   at java.sql.DriverManager.getConnection(DriverManager.java:548)&lt;br/&gt;
   at java.sql.DriverManager.getConnection(DriverManager.java:148)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.util.startJBMS(util.java:516)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.util.startJBMS(util.java:616)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.ConnectionEnv.init(ConnectionEnv.java:64)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.utilMain.&amp;lt;init&amp;gt;(utilMain.java:176)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.utilMain14.&amp;lt;init&amp;gt;(utilMain14.java:51)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.Main14.getutilMain(Main14.java:102)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.Main.&amp;lt;init&amp;gt;(Main.java:265)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.Main14.&amp;lt;init&amp;gt;(Main14.java:68)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.Main14.getMain(Main14.java:91)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:189)&lt;br/&gt;
   at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)&lt;br/&gt;
   at org.apache.derby.tools.ij.main(ij.java:60)&lt;br/&gt;
   at org.apache.derbyTesting.functionTests.harness.RunIJ.run(Unknown Source)&lt;br/&gt;
   at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;


&lt;p&gt;The cause for the Nist test to fail when running with jdk16 is the&lt;br/&gt;
introduction of autoloading of the embedded driver combined with the&lt;br/&gt;
value that derby.system.home has at the time the embedded driver is&lt;br/&gt;
loaded. &lt;/p&gt;

&lt;p&gt;When the Nist tests succeeds, derby.system.home contains the name of&lt;br/&gt;
the directory where the test should be run&lt;br/&gt;
(e.g. /export/home/tmp/derbysuite/nist in my case). derby.system.home&lt;br/&gt;
is set by the test harness when it starts each individual test suite.&lt;/p&gt;

&lt;p&gt;When the Nist tests fails the embedded driver and the Derby engine is&lt;br/&gt;
loaded as part of startup of derbyall. This happens as part of loading&lt;br/&gt;
the DB2 driver in the following code in RunList.shouldSkipTest:&lt;/p&gt;

&lt;p&gt;    if (framework.equals(&quot;DerbyNet&quot;))&lt;br/&gt;
    {&lt;br/&gt;
       // skip if the derbynet.jar is not in the Classpath&lt;br/&gt;
       try &lt;/p&gt;
{
           Class.forName(&quot;org.apache.derby.drda.NetworkServerControl&quot;);
       }
&lt;p&gt; catch (ClassNotFoundException cnfe) &lt;/p&gt;
{
           driverNotFound = true;
           result = true;
       }&lt;br/&gt;
&lt;br/&gt;
       // skip if the IBM Universal JDBC Driver is not in the Classpath&lt;br/&gt;
       // note that that driver loads some javax.naming.* classes which may not&lt;br/&gt;
       // be present at runtime, and thus we need to catch a possible error too&lt;br/&gt;
       try {
           Class.forName(&quot;com.ibm.db2.jcc.DB2Driver&quot;);
       } catch (ClassNotFoundException cnfe) {
           driverNotFound = true;
           result = true;
       }
&lt;p&gt; catch (NoClassDefFoundError err) &lt;/p&gt;
{
           driverNotFound = true;
           result = true;
       }
&lt;p&gt;       }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;When the Class.forName(&quot;com.ibm.db2.jcc.DB2Driver&quot;) is executed (and&lt;br/&gt;
the DB2 driver is actually in the class path) it seems to call some&lt;br/&gt;
methods that happens to be defined by any JDBC driver (see also the&lt;br/&gt;
comment in the code). The class loader seems to touch derby.jar to try&lt;br/&gt;
to find these methods, and this makes the embedded driver to&lt;br/&gt;
&quot;automagically&quot; be loaded. And loading the embedded driver also boots&lt;br/&gt;
the Derby engine. Unfortunately, at this time the derby.system.home&lt;br/&gt;
property is not set. This leads to the following happening&lt;br/&gt;
during autoloading of the embedded Driver:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The FileMonitor&apos;s home variable gets the value null based on reading derby.system.home.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When the Nist tests start an hour later and request to a database to&lt;br/&gt;
be created, the initialization of the StorageFactory fails with the&lt;br/&gt;
security exception since it uses the FileMonitor&apos;s home variable&lt;br/&gt;
(which is null) as the directory of where to create the&lt;br/&gt;
database. Without the security manager this would have succeeded, but&lt;br/&gt;
with the security manager, a security exception is raised when trying&lt;br/&gt;
to get the canonical path from the file system when only having the&lt;br/&gt;
name of the database directory (i.e. just having &quot;wombat&quot; instead of&lt;br/&gt;
&quot;/export/....../wombat&quot;).&lt;/p&gt;

&lt;p&gt;So basically the Nist tests fail due to the embedded driver is loaded&lt;br/&gt;
before derby.system.home is set to the value that it should have for&lt;br/&gt;
the tests, which again leads to the security exception when the VM&lt;br/&gt;
trying to get the canonical path name for the current directory.&lt;/p&gt;</comment>
                            <comment id="12414952" author="olav" created="Tue, 6 Jun 2006 20:31:36 +0100"  >&lt;p&gt;An overview of some of the suggestions that has been proposed for&lt;br/&gt;
fixing this issue:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Remove the support for autoloading of the embedded driver (Yes, Rick&lt;br/&gt;
  and the JDBC4 expert group have already said no to this, but I still&lt;br/&gt;
  think there are situations where automagic loading of the drivers is&lt;br/&gt;
  a bad idea)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Change the test harness so that derby.system.home is set to a value&lt;br/&gt;
  that is OK for all tests suites (running with useprocess=false)&lt;br/&gt;
  early during initialization (before touching any JDBC driver code)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Change the RunSuite&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; code so that it unloads the embedded driver&lt;br/&gt;
  and the engine as part of the start up (to get rid of the autoloaded&lt;br/&gt;
  embedded driver)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Change the &quot;security manager&quot; properties for the Nist tests to avoid&lt;br/&gt;
  the security exception when the VM tries to get the canonical path&lt;br/&gt;
  for the working directory.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Split the loading of the embedded driver and booting the engine.&lt;br/&gt;
  When the driver is (auto)-loaded only the driver is loaded. The&lt;br/&gt;
  Derby engine is booted when the first connection is created.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12415291" author="olav" created="Thu, 8 Jun 2006 16:01:37 +0100"  >&lt;p&gt;This patch solves the problem with running the Nist tests under jdk&lt;br/&gt;
1.6 by unloading the embedded driver before the nist suite is started. &lt;/p&gt;

&lt;p&gt;This is implemented in the RunList.runSuites method in the test&lt;br/&gt;
harness. Before a new test suite is started and the suite&lt;br/&gt;
is defined to run as part of the same JVM (useprocess=false) the&lt;br/&gt;
embedded driver and Derby engine is unloaded. The purpose of this is&lt;br/&gt;
that when the suite start running it will (re-)load an embedded driver&lt;br/&gt;
that will use the properties defined by the suite (in the case of the&lt;br/&gt;
Nist test the problem was that defined derby.system.home was not&lt;br/&gt;
used). &lt;/p&gt;

&lt;p&gt;The patch is ready for review and commit. I would like to get feedback&lt;br/&gt;
on:&lt;/p&gt;

&lt;p&gt; 1. The selected approach for solving this problem (by explicitly&lt;br/&gt;
    unload the embedded driver).&lt;/p&gt;

&lt;p&gt; 2. If the code for unload the driver is included in the test harness&lt;br/&gt;
    on the most appropriate place.&lt;/p&gt;

&lt;p&gt;svn status reports:&lt;/p&gt;

&lt;p&gt;M      java/testing/org/apache/derbyTesting/functionTests/harness/RunList.java&lt;/p&gt;

&lt;p&gt;Derbyall has been run with jdk1.5 and jdk1.6 on Solaris 10. The&lt;br/&gt;
unloading and reloading of the driver does not seem to make any other&lt;br/&gt;
test fail.&lt;/p&gt;

&lt;p&gt;If there are no objections to the selected approach for solving this&lt;br/&gt;
problem, the patch is ready for being committed.&lt;/p&gt;
</comment>
                            <comment id="12415428" author="rhillegas" created="Fri, 9 Jun 2006 05:08:06 +0100"  >&lt;p&gt;An elegant solution. I have confirmed that the nist tests now pass under the problem scenario. Committed at subversion revision 412859.&lt;/p&gt;</comment>
                            <comment id="12415993" author="olav" created="Tue, 13 Jun 2006 19:29:39 +0100"  >&lt;p&gt;Fix checked on trunk by Rick Hillegas (svn version 412859).&lt;/p&gt;</comment>
                            <comment id="12415994" author="olav" created="Tue, 13 Jun 2006 19:30:46 +0100"  >&lt;p&gt;Verified that the NIST suite runs successfully as part of derbyall with jdk 1.6.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12335185" name="autoload.diff" size="2124" author="olav" created="Thu, 8 Jun 2006 16:01:37 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 9 Jun 2006 04:08:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22470</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy1653:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40645</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>