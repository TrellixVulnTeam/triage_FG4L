<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:35:12 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3288/DERBY-3288.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3288] wrong query result in presence of a unique index</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3288</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The DDL to reproduce the bug is:&lt;/p&gt;

&lt;p&gt;CREATE TABLE tab_a (PId BIGINT NOT NULL);&lt;/p&gt;

&lt;p&gt;CREATE TABLE tab_c (Id BIGINT NOT NULL PRIMARY KEY, PAId BIGINT NOT NULL, PBId BIGINT NOT NULL);&lt;/p&gt;

&lt;p&gt;INSERT INTO tab_c VALUES (91, 81, 82);&lt;br/&gt;
INSERT INTO tab_c VALUES (92, 81, 84);&lt;br/&gt;
INSERT INTO tab_c VALUES (93, 81, 88);&lt;br/&gt;
INSERT INTO tab_c VALUES (96, 81, 83);&lt;/p&gt;

&lt;p&gt;CREATE TABLE tab_v (OId BIGINT NOT NULL , UGId BIGINT NOT NULL, val CHAR(1) NOT NULL);&lt;br/&gt;
CREATE UNIQUE INDEX tab_v_i1 ON tab_v (OId, UGId, val);&lt;br/&gt;
CREATE INDEX tab_v_i2 ON tab_v (UGId, val, OId);&lt;/p&gt;

&lt;p&gt;INSERT INTO tab_v VALUES (81, 31, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (82, 31, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (83, 31, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (84, 31, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (85, 31, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (86, 31, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (87, 31, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (81, 32, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (82, 32, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (83, 32, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (84, 32, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (85, 32, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (86, 32, &apos;A&apos;); &lt;br/&gt;
INSERT INTO tab_v VALUES (87, 32, &apos;A&apos;);&lt;/p&gt;

&lt;p&gt;CREATE TABLE tab_b (Id BIGINT NOT NULL PRIMARY KEY, OId BIGINT NOT NULL);&lt;/p&gt;

&lt;p&gt;INSERT INTO tab_b VALUES (141, 81);&lt;br/&gt;
INSERT INTO tab_b VALUES (142, 82);&lt;br/&gt;
INSERT INTO tab_b VALUES (143, 84);&lt;br/&gt;
INSERT INTO tab_b VALUES (144, 88);&lt;br/&gt;
INSERT INTO tab_b VALUES (151, 81);&lt;br/&gt;
INSERT INTO tab_b VALUES (152, 83);&lt;/p&gt;

&lt;p&gt;CREATE TABLE tab_d (Id BIGINT NOT NULL PRIMARY KEY, PAId BIGINT NOT NULL, PBId BIGINT NOT NULL);&lt;/p&gt;

&lt;p&gt;INSERT INTO tab_d VALUES (181, 141, 142);&lt;br/&gt;
INSERT INTO tab_d VALUES (182, 141, 143);&lt;br/&gt;
INSERT INTO tab_d VALUES (186, 151, 152);&lt;/p&gt;


&lt;p&gt;The query returning the wrong result is:&lt;/p&gt;

&lt;p&gt;SELECT tab_b.Id&lt;br/&gt;
FROM tab_b JOIN tab_c ON (tab_b.OId = tab_c.PAId OR tab_b.OId = tab_c.PBId) &lt;br/&gt;
LEFT OUTER JOIN tab_a ON tab_b.OId = PId &lt;br/&gt;
WHERE EXISTS (SELECT &apos;X&apos; FROM tab_d WHERE (PAId = 141 AND PBId = tab_b.Id) OR (PBId = 141 AND PAId = tab_b.Id)) &lt;br/&gt;
  AND EXISTS (SELECT &apos;X&apos; FROM tab_v WHERE OId = tab_b.OId AND UGId = 31 AND val = &apos;A&apos;)&lt;/p&gt;

&lt;p&gt;The result should consist of two rows (142),(143), but it returns only one row (142).&lt;/p&gt;

&lt;p&gt;The correct result would be returned if the index tab_v_i1 had been created as non-unique.&lt;/p&gt;

&lt;p&gt;The correct result would also be returned if the condition ...AND val=&apos;A&apos; had been replaced by ...AND val=&apos;A&apos;  || &apos;&apos;.&lt;/p&gt;




</description>
                <environment></environment>
        <key id="12384857">DERBY-3288</key>
            <summary>wrong query result in presence of a unique index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="army">A B</assignee>
                                    <reporter username="gekhin">Gerald Khin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Dec 2007 11:27:12 +0000</created>
                <updated>Fri, 21 Jan 2011 17:51:14 +0000</updated>
                            <resolved>Fri, 8 Feb 2008 16:37:51 +0000</resolved>
                                    <version>10.2.1.6</version>
                    <version>10.2.2.0</version>
                    <version>10.3.1.4</version>
                    <version>10.3.2.1</version>
                    <version>10.4.1.3</version>
                                    <fixVersion>10.3.3.0</fixVersion>
                    <fixVersion>10.4.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12552730" author="knutanders" created="Tue, 18 Dec 2007 12:26:11 +0000"  >&lt;p&gt;Marking the issue as a regression, since it works correctly on Derby 10.1.3.1 and earlier releases.&lt;/p&gt;</comment>
                            <comment id="12555792" author="army" created="Fri, 4 Jan 2008 04:38:35 +0000"  >&lt;p&gt;Regression occurs as of svn # 423754, for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1357&quot; title=&quot;Short-circuit logic in optimizer appears to be incorrect...&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1357&quot;&gt;&lt;del&gt;DERBY-1357&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Attaching &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3288&quot; title=&quot;wrong query result in presence of a unique index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3288&quot;&gt;&lt;del&gt;DERBY-3288&lt;/del&gt;&lt;/a&gt;.html with some background information and a description of the problem, along with a possible solution.&lt;/p&gt;

&lt;p&gt;Also attaching a quick patch to implement the solution mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3288&quot; title=&quot;wrong query result in presence of a unique index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3288&quot;&gt;&lt;del&gt;DERBY-3288&lt;/del&gt;&lt;/a&gt;.html.  The patch is called d3288_incomplete_v1.patch. It is incomplete for two reasons:&lt;/p&gt;

&lt;p&gt;  1) I have not yet added an appropriate test case to the regression suites.&lt;br/&gt;
  2) There was one failure in derbyall when I ran with this change&lt;br/&gt;
     (SpaceTable.sql). I still need to investigate the failure to see what&lt;br/&gt;
     might be going wrong.  suites.All ran cleanly.&lt;/p&gt;

&lt;p&gt;Not sure when I&apos;ll have time to follow-up, but I will post when I know more...&lt;/p&gt;</comment>
                            <comment id="12556774" author="bryanpendleton" created="Mon, 7 Jan 2008 23:56:51 +0000"  >&lt;p&gt;Hi Army, thanks for looking at this issue (I marked it as assigned to you).&lt;/p&gt;

&lt;p&gt;Your assessment makes complete sense to me; thanks for writing&lt;br/&gt;
the issues up so clearly and completely!&lt;/p&gt;

&lt;p&gt;Two questions occurred to me as I read your writeup:&lt;/p&gt;

&lt;p&gt;1) Why is it that TAB_D is dependent on HOJ but TAB_V is not?&lt;br/&gt;
Both of the exists subqueries look very similar to me; they each&lt;br/&gt;
seem to be correlated to TAB_B in the HOJ, and isn&apos;t that where&lt;br/&gt;
the dependency arises? It isn&apos;t really directly relevant to the bug,&lt;br/&gt;
I was just hoping you could educate me on why the one subquery&lt;br/&gt;
was dependent on the B-C-A join but the other wasn&apos;t.&lt;/p&gt;

&lt;p&gt;2) The way I read your patch, you basically caused steps (3) and (4)&lt;br/&gt;
to be done as part of step (1b), which makes complete sense to&lt;br/&gt;
me. But it surprised me a bit that you didn&apos;t seem to &lt;b&gt;move&lt;/b&gt; that&lt;br/&gt;
code; rather you inserted &lt;b&gt;new&lt;/b&gt; code into step (1b). That is, it now&lt;br/&gt;
seems like there are multiple places in OptimizerImpl.getNextPermutation()&lt;br/&gt;
which all seem to be doing the same thing:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;your new code to be inserted at line 589 or so&lt;/li&gt;
	&lt;li&gt;The hunk of code at line 809 or so, starting with the comment&lt;br/&gt;
    &quot;We are going to try an optimizable at the current join order position&quot;&lt;/li&gt;
	&lt;li&gt;The hunk of code at line 1093 or so, starting with the comment&lt;br/&gt;
    &quot;Clear the assigned table map&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m afraid I don&apos;t really have a very clear comment to make here; I&apos;m&lt;br/&gt;
just observing that getNextPermutation() appears to compute the&lt;br/&gt;
&quot;pullMe&quot; optimizable twice, and in one case it clears the assignedTableMap&lt;br/&gt;
bits but in the other it doesn&apos;t, and your patch adds a 3rd place where&lt;br/&gt;
we compute the pullMe optimizable (and clear the assignedTableMap bits).&lt;/p&gt;

&lt;p&gt;Perhaps this question puts my finger most closely on my confusion:&lt;/p&gt;

&lt;p&gt;  Why don&apos;t we need to clear the assigned table map bits at line 809?&lt;/p&gt;</comment>
                            <comment id="12556789" author="army" created="Tue, 8 Jan 2008 00:58:50 +0000"  >&lt;p&gt;Thanks for the great questions, Bryan.&lt;/p&gt;

&lt;p&gt;&amp;gt; 1) Why is it that TAB_D is dependent on HOJ but TAB_V is not? &lt;/p&gt;

&lt;p&gt;I admit I don&apos;t know.  The process of flattening EXISTS subqueries into specialized FromBaseTables that are called &quot;existsBaseTables&quot; is one I have not investigated.  I know it happens, and I know that an &quot;exist base table&quot; is one of the primary reasons that dependencies exist, at least according to the comment in FromBaseTable.legalJoinOrder():&lt;/p&gt;

&lt;p&gt;    public boolean legalJoinOrder(JBitSet assignedTableMap)&lt;br/&gt;
    {&lt;br/&gt;
        // Only an issue for EXISTS FBTs&lt;br/&gt;
        if (existsBaseTable)&lt;/p&gt;
        {
            /* Have all of our dependencies been satisfied? */
            return assignedTableMap.contains(dependencyMap);
        }
&lt;p&gt;        return true;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;As you say, it seems like the two EXISTS subqueries are pretty similar, but I do not know what is it that causes a dependency on TAB_D only.  I haven&apos;t spent time in that particular piece of the code...&lt;/p&gt;

&lt;p&gt;&amp;gt; 2) &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; It surprised me a bit that you didn&apos;t seem to &lt;b&gt;move&lt;/b&gt; that&lt;br/&gt;
&amp;gt; code; rather you inserted &lt;b&gt;new&lt;/b&gt; code into step (1b). &lt;/p&gt;

&lt;p&gt;I agree with you on this.  I was originally thinking to reorg the code a bit, but then I just wanted to see if I was on track by making the &quot;quick fix&quot; and checking the results.  It solved the reported problem so I posted it; but yes, the patch is incomplete and a more formal reorganization of the relevant methods would be a good idea.  I don&apos;t know how much time I&apos;ll have to look at this over the next many days, so I just did a quick &quot;drop&quot; posting of what I found--which is one of the reasons I hadn&apos;t officially assigned myself to the issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  But you bring up a good point.&lt;/p&gt;

&lt;p&gt;&amp;gt; Why don&apos;t we need to clear the assigned table map bits at line 809?&lt;/p&gt;

&lt;p&gt;I don&apos;t think this is necessary because the other pullMe code (line 1093) will eventually (in a round-a-bout way) clean up after the missing &quot;clear assigned table map&quot; from 809--at least in most cases.  But adding the appropriate code to line 809 may fix this bug and render the other use unnecessary, as well.  If that&apos;s true then that would probably be the best final approach.&lt;/p&gt;

&lt;p&gt;And of course, there&apos;s still the SpaceTable.sql issue to investigate...&lt;/p&gt;</comment>
                            <comment id="12563325" author="army" created="Mon, 28 Jan 2008 22:41:31 +0000"  >&lt;p&gt;Attaching d3288_v2.patch, which is a first attempt a complete solution for this issue.  The patch does the following:&lt;/p&gt;

&lt;p&gt;  1. Move all of the existing &quot;pull optimizable&quot; processing out&lt;br/&gt;
     of the getNextPermutation() method and into its own method,&lt;br/&gt;
     pullOptimizableFromJoinOrder(), for the sake of clarity.&lt;/p&gt;

&lt;p&gt;  2. Add a call to pullOptimizableFromJoinOrder() that updates&lt;br/&gt;
     assignedTableMap to correctly reflect the pulling of the&lt;br/&gt;
     optimizable in question.&lt;/p&gt;

&lt;p&gt;  3. Make the getNextPermutation() metod call the new method&lt;br/&gt;
     (pullOptimizableFromJoinOrder()) *&lt;b&gt;BEFORE&lt;/b&gt;* trying to&lt;br/&gt;
     determine what the next legal optimizable for the join&lt;br/&gt;
     order can be.&lt;/p&gt;

&lt;p&gt;Changes 1 thru 3 above fix the query as reported in this Jira.&lt;/p&gt;

&lt;p&gt;But with those changes, store/SpaceTable.sql was failing with an ASSERT failure just as it did for d3288_incomplete_v1.patch.  I looked into this and eventually tracked it down to the fact that the FromVTI class misuses the &quot;referencedTableMap&quot; field that it inherits from ResultSetNode.java.  More specifically, that field is intended to hold table numbers for all FromTables which appear at or &lt;em&gt;beneath&lt;/em&gt; a given FromTable in the query tree.  But for FromVTI, the referencedTableMap was holding table numbers for all FromTables which were referenced by the &lt;em&gt;arguments&lt;/em&gt; to the FromVTI.  As an example, take the following query (which is pulled from store/SpaceTable.sql):&lt;/p&gt;

&lt;p&gt;  select conglomeratename, isindex,&lt;br/&gt;
    numallocatedpages, numfreepages, pagesize, estimspacesaving&lt;br/&gt;
  from SYS.SYSSCHEMAS s, SYS.SYSTABLES t,&lt;br/&gt;
     new org.apache.derby.diag.SpaceTable(SCHEMANAME,TABLENAME) v&lt;br/&gt;
  where s.SCHEMAID = t.SCHEMAID&lt;br/&gt;
  and s.SCHEMANAME = &apos;APP&apos;&lt;br/&gt;
  order by conglomeratename;&lt;/p&gt;

&lt;p&gt;In this query SpaceTable will be parsed as a FromVTI and will get its own table number; SYSSCHEMAS and SYSTABLES will each get its own table number, as well.&lt;/p&gt;

&lt;p&gt;That said, the referencedTableMap for the FromVTI should only contain the table number of the FromVTI itself--because there are no other FromTables beneath the FromVTI in the query tree (esp. FromVTI doesn&apos;t have any children nodes that are instances of FromTable).  But with the current codeline, the arguments for SpaceTable will be processed and their table numbers will be added to FromVTI&apos;s referencedTableMap, so that FromVTI&apos;s referenced table map will contain:&lt;/p&gt;

  { SYSSCHEMAS, SYSTABLES, SpaceTable }&lt;br/&gt;
&lt;br/&gt;
instead of&lt;br/&gt;
&lt;br/&gt;
  { SpaceTable }&lt;br/&gt;
&lt;br/&gt;
This confuses the optimizer&apos;s dependency checking, which assumes that a FromTable&apos;s referenced map only contains table numbers for itself and any FromTable children. The result of this confusion is a join order that puts SpaceTable &lt;em&gt;before&lt;/em&gt; SYSSCHEMAS and SYSTABLES, which means that attempts to generate the FromVTI wll fail because the tables that it references have not yet been generated.&lt;br/&gt;
&lt;br/&gt;
Note that FromVTI &lt;em&gt;does&lt;/em&gt; have a dependency on SYSSCHEMAS and SYSTABLES as a result of its arguments--that part is correct.  And the current code &lt;em&gt;does&lt;/em&gt; try to enforce that dependency.  But the misuse of referencedTableMap causes the current code to do the wrong thing.  This is because the assignedTableMap used by the Optimizer sets/unsets bits based on the referenced table map.  So we end up in a situation like this:&lt;br/&gt;
&lt;br/&gt;
  Join order:       { SYSTABLES, SYSSCHEMAS, SpaceTable }&lt;br/&gt;
  assignedTableMap: { SYSTABLES, SYSSCHEMAS, SpaceTable }&lt;br/&gt;
&lt;br/&gt;
  &amp;#8211; Pull SpaceTable from the join order.  We do an XOR between&lt;br/&gt;
     assignedTableMap and SpaceTable&apos;s referenced table map. Since&lt;br/&gt;
	 SpaceTable&apos;s referenced table (incorrectly) includes bits&lt;br/&gt;
	 for SYSSCHEMAS and SYSTABLES, the XOR yields:&lt;br/&gt;
&lt;br/&gt;
       Join order:       { SYSTABLES, SYSSCHEMAS, -- }&lt;br/&gt;
       assignedTableMap: { }  // this is WRONG!&lt;br/&gt;
&lt;br/&gt;
     Note how the assignedTableMap is now empty.  This is wrong--&lt;br/&gt;
     after the pull there are still two tables in the join order,&lt;br/&gt;
     so assignedTablemap should reflect those tables.  But due&lt;br/&gt;
     to the FromVTI&apos;s incorrect referenced map, assignedTableMap&lt;br/&gt;
     no longer matches the join order.&lt;br/&gt;
&lt;br/&gt;
  &amp;#8211; Pull SYSSCHEMAS from the join order.  We do an XOR between&lt;br/&gt;
	 assignedTableMap and SYSSCHEMA&apos;s referenced table map,&lt;br/&gt;
     yielding:&lt;br/&gt;
&lt;br/&gt;
       Join order:       { SYSTABLES, --, -- }&lt;br/&gt;
       assignedTableMap: { SYSSCHEMAS }&lt;br/&gt;
&lt;br/&gt;
	 Note how assignedTableMap is STILL wrong here.  Since we&lt;br/&gt;
     (incorrectly) cleared assignedTableMap above, the XOR with&lt;br/&gt;
     SYSSCHEMAS actually &lt;em&gt;added&lt;/em&gt; SYSSCHEMAS to the assigned&lt;br/&gt;
     table map, which is the opposite of what were supposed&lt;br/&gt;
	 to do.  Since SYSSCHEMAS is no longer in the join order,&lt;br/&gt;
	 it should not show up in assignedTableMap.&lt;br/&gt;
&lt;br/&gt;
  &amp;#8211; Attempt to place SpaceTable in the join order. Since it&lt;br/&gt;
     depends on { SYSSCHEMAS, SYSTABLES } and assignedTableMap&lt;br/&gt;
     does not include both of those, we can&apos;t place it.  So&lt;br/&gt;
     we&apos;ll pull again...&lt;br/&gt;
&lt;br/&gt;
  &amp;#8211; Pull SYSTABLES from the join order.  We do an XOR between&lt;br/&gt;
	 assignedTableMap and SYSTABLES&apos;s referenced table map,&lt;br/&gt;
     yielding:&lt;br/&gt;
&lt;br/&gt;
       Join order:       { --, --, -- }&lt;br/&gt;
       assignedTableMap: { SYSSCHEMAS, SYSTABLES }&lt;br/&gt;
&lt;br/&gt;
	 So our assignedTableMap is completely wrong at this point.&lt;br/&gt;
	 Since we (incorrectly) cleared assignedTableMap when we&lt;br/&gt;
	 pulled SpaceTable, our assigned table map now indicates that&lt;br/&gt;
	 SYSSCHEMAS and SYSTABLES are both already in the join order,&lt;br/&gt;
     when in truth the join order is EMPTY at this point.&lt;br/&gt;
&lt;br/&gt;
  &amp;#8211; Attempt to place SpaceTable in the join order.  Since it&lt;br/&gt;
     depends on { SYSSCHEMAS, SYSTABLES } and since assignedTableMap&lt;br/&gt;
     incorrectly includes both of those, the optimizer will place&lt;br/&gt;
     SpaceTable into the first position in the join order.  We&lt;br/&gt;
     end up with:&lt;br/&gt;
&lt;br/&gt;
       Join order:       { SpaceTable, --, -- }&lt;br/&gt;
       assignedTableMap: { SYSSCHEMAS, SYSTABLES, SpaceTable }

&lt;p&gt;This becomes the &quot;cheapest&quot; join order that the optimizer finds, so this is what Derby will try to generate.  But since SpaceTable depends on SYSSCHEMAS and SYSTABLES, which will only be generated &lt;em&gt;after&lt;/em&gt; SpaceTable (because FromTables are generated in the order in which they appear in the join order), the generation code for SpaceTable will fail.&lt;/p&gt;

&lt;p&gt;All of that to say that FromVTI should not include table numbers for its arguments in its referencedTableMap.  So with that in mind, the d3288_v2.patch also does the following:&lt;/p&gt;

&lt;p&gt;  4. Fix FromVTI to correctly set up its referencedTableMap and&lt;br/&gt;
     dependency map, without mixing the two together.&lt;/p&gt;

&lt;p&gt;  5. Remove some assignedTableMap &quot;clear&quot; (XOR) logic that appears&lt;br/&gt;
     to only have been necessary due to the bug in FromVTI--at least&lt;br/&gt;
     as far as I can tell.  Removing this logic makes it so that&lt;br/&gt;
     there is now a &lt;em&gt;single&lt;/em&gt; place in the code where we &quot;add to&quot; the&lt;br/&gt;
     assigned table map (namely, when placing an optimizable), and&lt;br/&gt;
     there is a &lt;em&gt;single&lt;/em&gt; place where we &quot;remove from&quot; the assigned&lt;br/&gt;
     table map (namely, when pulling an optimizable).&lt;/p&gt;

&lt;p&gt;  6. Add the repro for this issue to the existing lang/subqueryFlattening.sql&lt;br/&gt;
     tests, since that&apos;s where EXISTS flattening is currently tested.&lt;/p&gt;

&lt;p&gt;I ran derbyall and suites.All with an earlier version of this patch and everything ran cleanly.  Since then I have added a few ASSERT statements to sanity check the contents of assignedTableMap at certain points during the join order processing.  I have not yet run the regression suites with these ASSERTs in place, but plan to do so shortly.&lt;/p&gt;

&lt;p&gt;In the meantime, if anyone has any comments on the patch as posted, I&apos;d be glad to hear them.&lt;/p&gt;

&lt;p&gt;Note to reviewers: The patch itself is 929 lines, but the vast majority of that comes from the relocation of &quot;pull optimizable&quot; processing into its own method.&lt;/p&gt;</comment>
                            <comment id="12563870" author="kristwaa" created="Wed, 30 Jan 2008 07:21:09 +0000"  >&lt;p&gt;I ran the regression tests (derbyall and suites.All) with Sun JVM 1.6.0_04 on Solaris x86 and saw no failures. I have not reviewed the code.&lt;/p&gt;</comment>
                            <comment id="12565421" author="army" created="Mon, 4 Feb 2008 16:55:33 +0000"  >&lt;p&gt;Thanks for running the regression tests, Kristian.&lt;/p&gt;

&lt;p&gt;If there are no other comments on this patch, I plan to commit it sometime tomorrow (Tuesday, 02/05 PST), and will  look at porting it to 10.3 by the end of the week...&lt;/p&gt;</comment>
                            <comment id="12565976" author="army" created="Wed, 6 Feb 2008 00:47:38 +0000"  >&lt;p&gt;Committed d3288_v2.patch to trunk with svn # 618841:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=618841&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=618841&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Setting Fix In to 10.4 and unchecking the &quot;Patch Available&quot; flag.&lt;/p&gt;</comment>
                            <comment id="12567084" author="army" created="Fri, 8 Feb 2008 16:34:53 +0000"  >&lt;p&gt;I ran the &quot;svn merge&quot; command to port this change back to 10.3, but the command failed due to a conflict in FromVTI.java caused by changes in were made in 10.4 (as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-716&quot; title=&quot;Re-enable VTIs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-716&quot;&gt;&lt;del&gt;DERBY-716&lt;/del&gt;&lt;/a&gt;) but which were not ported back to 10.3.&lt;/p&gt;

&lt;p&gt;I manually resolved the conflict and created &quot;d3288_10_3_merge.patch&quot; for the port to 10.3.  With this patch applied I ran derbyall and suites.All on Linux with ibm142 and saw no failures.&lt;/p&gt;</comment>
                            <comment id="12567087" author="army" created="Fri, 8 Feb 2008 16:37:51 +0000"  >&lt;p&gt;Committed d3288_10_3_merge.patch to 10.3 with svn # 619932:&lt;/p&gt;

&lt;p&gt;  URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=619932&amp;amp;view=rev&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?rev=619932&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Gerald, if you have time to try out the fix, can you do so and report back?&lt;/p&gt;</comment>
                            <comment id="12567660" author="gekhin" created="Mon, 11 Feb 2008 15:13:08 +0000"  >&lt;p&gt;Army, I tried out the fix you provided: Works fine. Great job!&lt;/p&gt;</comment>
                            <comment id="12584392" author="army" created="Wed, 2 Apr 2008 04:35:06 +0100"  >&lt;p&gt;I don&apos;t know if fixes for wrong results &lt;b&gt;regressions&lt;/b&gt; really need a release note or not, but I&apos;m attaching one here anyway.  I am &lt;b&gt;not&lt;/b&gt; checking the &quot;Existing Application Impact&quot; box as I don&apos;t know what the rules are for regressions.  If it is agreed that release notes are good for regression fixes, as well, then someone can check the appropriate box to have the release note picked up by the generator tool.  Note: the html file will have to be &quot;scrubbed&quot; in order to play nicely with the release note tool.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12354628">DERBY-2034</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12343690">DERBY-1357</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12372481" name="DERBY-3288.htm" size="39425" author="army" created="Fri, 4 Jan 2008 04:38:35 +0000"/>
                            <attachment id="12375086" name="d3288_10_3_merge.patch" size="33899" author="army" created="Fri, 8 Feb 2008 16:34:53 +0000"/>
                            <attachment id="12372482" name="d3288_incomplete_v1.patch" size="1768" author="army" created="Fri, 4 Jan 2008 04:38:35 +0000"/>
                            <attachment id="12374226" name="d3288_v2.patch" size="33883" author="army" created="Mon, 28 Jan 2008 22:41:30 +0000"/>
                            <attachment id="12379094" name="releaseNote.html" size="5967" author="army" created="Wed, 2 Apr 2008 04:35:06 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10420"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 18 Dec 2007 12:26:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23548</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0lu7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37356</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>