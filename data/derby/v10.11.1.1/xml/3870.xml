<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:22:43 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-3870/DERBY-3870.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-3870] Concurrent Inserts of rows with XML data results in an exception</title>
                <link>https://issues.apache.org/jira/browse/DERBY-3870</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>
&lt;p&gt;We insert rows into a table using the following prepared statement (through JDBC):&lt;/p&gt;

&lt;p&gt;INSERT INTO USER1.PSTORE values(?,?, XMLPARSE(document CAST (? AS CLOB) preserve whitespace))&lt;/p&gt;

&lt;p&gt;where each of the ?&apos;s are replaced with a string.&lt;/p&gt;

&lt;p&gt;One thread runs fine. Two or more result in the following exception: &lt;/p&gt;

&lt;p&gt;org.apache.derby.client.am.SqlException: Java exception: &apos;FWK005 parse may not be called while parsing.: org.xml.sax.SAXException&apos;.&lt;br/&gt;
	at org.apache.derby.client.am.SqlException.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
	at org.apache.derby.client.am.SqlException.&amp;lt;init&amp;gt;(Unknown Source)&lt;/p&gt;

&lt;p&gt;We believe that this comes from the dBuilder.parse(InputSource) method.&lt;/p&gt;
</description>
                <environment>System: MS windows server 2003 standard edition service pack 2. Derby is run as a server on port 1527.</environment>
        <key id="12404018">DERBY-3870</key>
            <summary>Concurrent Inserts of rows with XML data results in an exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="ronenr@cs.technion.ac.il">Royi Ronen</reporter>
                        <labels>
                            <label>derby_backport_reject_10_7</label>
                    </labels>
                <created>Tue, 9 Sep 2008 20:34:41 +0100</created>
                <updated>Wed, 25 Jun 2014 08:58:08 +0100</updated>
                            <resolved>Fri, 16 Mar 2012 16:30:26 +0000</resolved>
                                    <version>10.4.1.3</version>
                    <version>10.4.2.1</version>
                    <version>10.5.2.0</version>
                    <version>10.6.1.0</version>
                                    <fixVersion>10.8.2.2</fixVersion>
                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12629685" author="bryanpendleton" created="Wed, 10 Sep 2008 03:45:19 +0100"  >&lt;p&gt;What sort of errors are in your derby.log file? Can you attach it?&lt;/p&gt;

&lt;p&gt;Also, can you try extracting as much information as possible from&lt;br/&gt;
the client-side exception by using the techniques described at&lt;br/&gt;
&lt;a href=&quot;http://wiki.apache.org/db-derby/UnwindExceptionChain&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/UnwindExceptionChain&lt;/a&gt;&lt;br/&gt;
then posting that information?&lt;/p&gt;

&lt;p&gt;What JDK and XML parser are you using?&lt;/p&gt;</comment>
                            <comment id="12630674" author="aslom" created="Fri, 12 Sep 2008 21:29:37 +0100"  >&lt;p&gt;hi,&lt;/p&gt;

&lt;p&gt;i was able to fix the problem &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; i am attaching ZIP file that contains the fix and simple test that can be built with ant after lib directory is created and populated with derby / xerces/ xalan / serializer jars (see README.txt has details).&lt;/p&gt;

&lt;p&gt;&amp;gt; What JDK and XML parser are you using? &lt;/p&gt;

&lt;p&gt;mostly JDK 1.5 and relatively new xerces/xalan version - i could not find exactly which one by looking into jar file of xerces but xalan from MANIFEST.MF is 2.7.1&lt;/p&gt;

&lt;p&gt;i tested with db-derby-10.4.1.3-bin and db-derby-10.4.2.0-bin and also built from SVN db-derby-snapshot-10.5.0.0-694562 - for all the the same error happens&lt;/p&gt;

&lt;p&gt;&amp;gt; What sort of errors are in your derby.log file? Can you attach it? &lt;/p&gt;

&lt;p&gt;this is typical exception - i am attaching derby log file&lt;/p&gt;

&lt;p&gt;2008-09-11 21:25:55.453 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;DRDAConnThread_7,5,main&amp;#93;&lt;/span&gt; (XID = 82480), (SESSIONID = 1), (DATABASE = sample), (DRDAID = NF000001.GD9D-449232841661851773&lt;/p&gt;
{2}
&lt;p&gt;), Failed Statement is: INSERT INTO USER1.PSTORE values(?,?, XMLPARSE(document CAST (? AS CLOB) preserve whitespace)) with 3 parameters begin parameter #1: 1_0 :end parameter begin parameter #2: 1abcde0 :end parameter begin parameter #3: CLOB(826) :end parameter &lt;br/&gt;
ERROR 2200M: Invalid XML DOCUMENT: FWK005 parse may not be called while parsing.&lt;br/&gt;
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.XML.XMLParse(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.SqlXmlExecutor.XMLParse(Unknown Source)&lt;br/&gt;
	at org.apache.derby.exe.acc851401ax011cx534ex27f7x00003f5c9d400.e0(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.reflect.DirectCall.invoke(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.RowResultSet.getNextRowCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NormalizeResultSet.getNextRowCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;br/&gt;
Caused by: org.xml.sax.SAXException: FWK005 parse may not be called while parsing.&lt;br/&gt;
	at org.apache.xerces.parsers.DOMParser.parse(Unknown Source)&lt;br/&gt;
	at org.apache.xerces.jaxp.DocumentBuilderImpl.parse(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SqlXmlUtil$1.run(Unknown Source)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(AccessController.java:246)&lt;br/&gt;
	at org.apache.derby.iapi.types.SqlXmlUtil.serializeToString(Unknown Source)&lt;br/&gt;
	... 17 more&lt;br/&gt;
============= begin nested exception, level (1) ===========&lt;br/&gt;
org.xml.sax.SAXException: FWK005 parse may not be called while parsing.&lt;br/&gt;
	at org.apache.xerces.parsers.DOMParser.parse(Unknown Source)&lt;br/&gt;
	at org.apache.xerces.jaxp.DocumentBuilderImpl.parse(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.SqlXmlUtil$1.run(Unknown Source)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(AccessController.java:246)&lt;br/&gt;
	at org.apache.derby.iapi.types.SqlXmlUtil.serializeToString(Unknown Source)&lt;br/&gt;
	at org.apache.derby.iapi.types.XML.XMLParse(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.SqlXmlExecutor.XMLParse(Unknown Source)&lt;br/&gt;
	at org.apache.derby.exe.acc851401ax011cx534ex27f7x00003f5c9d400.e0(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.services.reflect.DirectCall.invoke(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.RowResultSet.getNextRowCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NormalizeResultSet.getNextRowCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAStatement.execute(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;/p&gt;


&lt;p&gt;&amp;gt; Also, can you try extracting as much information as possible from &lt;br/&gt;
&amp;gt; the client-side exception by using the techniques described at &lt;br/&gt;
&amp;gt; &lt;a href=&quot;http://wiki.apache.org/db-derby/UnwindExceptionChain&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/db-derby/UnwindExceptionChain&lt;/a&gt; &lt;br/&gt;
&amp;gt; then posting that information? &lt;/p&gt;

&lt;p&gt;here it is:&lt;/p&gt;


&lt;p&gt;server:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; preparing tables&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; conn being returned is:org.apache.derby.client.net.NetConnection@b96&lt;br/&gt;
0b96&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; tables preparation ended&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; preparing XML to String&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; preparing workers&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; conn being returned is:org.apache.derby.client.net.NetConnection@668&lt;br/&gt;
06680&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; conn being returned is:org.apache.derby.client.net.NetConnection@46c&lt;br/&gt;
046c&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; starting 2 threads&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; all insert threads started&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; ----- SQLException -----&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   SQLState:   2200M&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   Error Code: -1&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   Message:    Invalid XML DOCUMENT: FWK005 parse may not be called w&lt;br/&gt;
hile parsing.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; ----- SQLException -----&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   SQLState:   XJ001&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   Error Code: 99999&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   Message:    Java exception: &apos;FWK005 parse may not be called while&lt;br/&gt;
parsing.: org.xml.sax.SAXException&apos;.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; Exception in thread &quot;Thread-1&quot; java.lang.RuntimeException: inserting&lt;br/&gt;
 0 failed:null rawXML=&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; &amp;lt;fn:filenetEvent pstore:class=&quot;custom&quot; pstore:id=&quot;61&quot;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     xmlns:fn=&quot;http://foo.var&quot;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     xmlns:pstore=&quot;http://bar.var&quot; &amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;pstore:appID&amp;gt;1abcde0&amp;lt;/pstore:appID&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:documentID&amp;gt;5EE285D7-AF83-4B62-A2B5-BBB91FE2ADD4&amp;lt;/fn:documentID&lt;br/&gt;
&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;pstore:displayName&amp;gt;Email&amp;lt;/pstore:displayName&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:to&amp;gt;lisa@maricopa.watson.ibm.com&amp;lt;/fn:to&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:action&amp;gt;Creation&amp;lt;/fn:action&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:timeStamp&amp;gt;Wed, 30 Jul 2008 18:33:00&amp;lt;/fn:timeStamp&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:title&amp;gt;Loan application 101 customer response&amp;lt;/fn:title&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:systemTimeStamp&amp;gt;1abcde00&amp;lt;/fn:systemTimeStamp&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:from&amp;gt;chuck@maricopa.watson.ibm.com&amp;lt;/fn:from&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:documentType&amp;gt;email&amp;lt;/fn:documentType&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:subject&amp;gt;RE: WeFinance Loan Application 101&amp;lt;/fn:subject&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:loanID&amp;gt;101&amp;lt;/fn:loanID&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;   &amp;lt;fn:actor&amp;gt;lisa&amp;lt;/fn:actor&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; &amp;lt;/fn:filenetEvent&amp;gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at ThreadInsert.insertSome(Unknown Source)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at ThreadInsert.run(Unknown Source)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.lang.Thread.run(Thread.java:810)&lt;/p&gt;



</comment>
                            <comment id="12630675" author="aslom" created="Fri, 12 Sep 2008 21:30:31 +0100"  >&lt;p&gt;regression test and fix for the issues&lt;/p&gt;</comment>
                            <comment id="12630676" author="aslom" created="Fri, 12 Sep 2008 21:31:46 +0100"  >&lt;p&gt;derby log showing error happening server side&lt;/p&gt;</comment>
                            <comment id="12630679" author="aslom" created="Fri, 12 Sep 2008 21:45:44 +0100"  >&lt;p&gt;BTW: the problem seems to stem from the fact that Xerces DocumentBuilder &lt;br/&gt;
isn&apos;t thread safe as mentioned in &lt;br/&gt;
&lt;a href=&quot;http://www.oxygenxml.com/archives/xml-dev/200405/msg00149.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.oxygenxml.com/archives/xml-dev/200405/msg00149.html&lt;/a&gt;&lt;br/&gt;
and the same seems to be true about Serializer.&lt;br/&gt;
DocumentBuilderFactory and SerializerFactory seems to be OK &lt;br/&gt;
when used/shared by multiple threads.&lt;/p&gt;

&lt;p&gt;If SqlXmlUtil was not shared between threads for exmaple&lt;br/&gt;
made thread private (and possibly recycled after connection is closed) &lt;br/&gt;
then using one DocumentBuilder instance should be fine.&lt;/p&gt;

&lt;p&gt;However i was not able to understand life cycle of SqlXmlUtil &lt;br/&gt;
(sho is calling SqlXmlExecutor.getSqlXmlUtil()) and what is &lt;br/&gt;
elation between activations, connections  and threads ...&lt;/p&gt;

&lt;p&gt;So proper fix may be to make sure that SqlXmlUtil is safely reused &lt;br/&gt;
or not shared between threads ...&lt;/p&gt;
</comment>
                            <comment id="12726895" author="kristwaa" created="Fri, 3 Jul 2009 12:16:55 +0100"  >&lt;p&gt;Triaged July 3, 2009: Downgraded to Major, ticked Repro attached and Known fix. Updated Affects versions.&lt;br/&gt;
User has analyzed the issue and proposed how to fix it.&lt;/p&gt;</comment>
                            <comment id="13031652" author="knutanders" created="Wed, 11 May 2011 12:39:01 +0100"  >&lt;p&gt;Attached is a JUnit test case that exposes the bug. It runs queries that use all the XML operators in four threads concurrently. The actual failure varies. Sometimes it&apos;s a SAXException (FWK005 parse may not be called while parsing), other times it&apos;s a NullPointerException.&lt;/p&gt;

&lt;p&gt;I agree that it&apos;s wrong to store the SqlXmlUtil instance in the compiled plan. Every activation of the plan should have its own copy. The comments in the code indicate that the caching was there to prevent recompilation of XPath queries for each row when using the XMLQUERY or XMLEXISTS operators. Having one instance per activation would still provide that optimization.&lt;/p&gt;</comment>
                            <comment id="13031654" author="knutanders" created="Wed, 11 May 2011 12:45:44 +0100"  >&lt;p&gt;I checked in the new test case (XMLConcurrencyTest), but disabled it first in XMLSuite so it doesn&apos;t get run as part of the regression tests until the bug is fixed.&lt;/p&gt;

&lt;p&gt;Committed revision 1101839.&lt;/p&gt;</comment>
                            <comment id="13036154" author="knutanders" created="Thu, 19 May 2011 13:36:31 +0100"  >&lt;p&gt;The attached patch (1a) seems to fix the bug and allow XML operators to be executed concurrently.&lt;/p&gt;

&lt;p&gt;The patch makes the following changes:&lt;/p&gt;

&lt;p&gt;1) The SqlXmlUtil instance isn&apos;t stored in the compiled plan. Instead, byte code is generated so that a new instance is created the first time the operator is used in an activation (and reused subsequently in the same activation only).&lt;/p&gt;

&lt;p&gt;2) Since the SqlXmlUtil instance is no longer persisted, it no longer implements Formatable, which allowed for removal of a number of methods in the class, as well as entries for the class in RegisteredFormatIds and StoredFormatIds.&lt;/p&gt;

&lt;p&gt;3) Created a new  abstract super-class of UnaryOperatorNode, BinaryOperatorNode and TernaryOperatorNode, in which code that generates byte-code for the different XML operators could be shared. Currently, their only common super-class is ValueNode, which sounds too general for code that&apos;s only used by operator nodes.&lt;/p&gt;

&lt;p&gt;4) Enables XMLConcurrencyTest in the regression test suite.&lt;/p&gt;

&lt;p&gt;I&apos;ve verified that we still don&apos;t create/compile the SqlXmlUtil instance for each row with the patch. We do create an instance and compile the XML query on the first row that uses the operator per activation. This also means that if you re-execute a previously executed PreparedStatement, the cached value will be used.&lt;/p&gt;

&lt;p&gt;In addition to the per-activation compilation of the XML query, we still compile the XML query when creating the SQL query execution plan. This isn&apos;t strictly necessary anymore, since the compiled XML query will now be thrown away instead of being stored in the plan. I left the code in there so that syntax errors in the XML query would still generate a compile-time error instead of being delayed to execution-time. I&apos;m open to changing this, but wanted to prevent any behaviour changes in the first iteration.&lt;/p&gt;

&lt;p&gt;Other potential improvements:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;More common code can probably be pulled from the *naryOperatorNode classes up to their new parent class. But that&apos;s outside the scope of this issue.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;As far as I can see, there&apos;s no reason to create a new SqlXmlExecutor instance for every row, as we currently do. The instances are (effectively) immutable, and contain the same values for all rows, so it may make sense to cache the SqlXmlExecutor instances instead of the SqlXmlUtil instances (which can be retrieved from the executors anyway).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The SqlXmlExecutor class contains a comment indicating that it belongs in the types package, but it was placed in the execute package because it accessed the Activation class, and the types layer shouldn&apos;t depend on the SQL layer. SqlXmlExecutor no longer accesses the Activation class, so it may be possible to move it to the types package now.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve run all the regression tests on an earlier version of the patch without seeing any failures. Rerunning the tests now just to be safe, since I&apos;ve made some small changes to the patch later.&lt;/p&gt;</comment>
                            <comment id="13036211" author="knutanders" created="Thu, 19 May 2011 15:20:54 +0100"  >&lt;p&gt;All the regression tests ran cleanly with the patch.&lt;/p&gt;</comment>
                            <comment id="13036223" author="bryanpendleton" created="Thu, 19 May 2011 15:31:01 +0100"  >&lt;p&gt;Your approach seems fine to me. When I was working on the XPLAIN tables I remember thinking&lt;br/&gt;
it would be nice if the operator nodes had a closer base class than ValueNode, so that seems&lt;br/&gt;
like a good idea to me.  Isn&apos;t it true that the compile classes and the execution classes have a&lt;br/&gt;
common class hierarchy? Is there a parallel re-factoring of a common base class to be done in&lt;br/&gt;
the other tree? I think that if we move the SqlXmlExecutor from the execute package to the&lt;br/&gt;
types package, it might be nice to change its name (to remove &quot;Executor&quot;). Thanks for cleaning&lt;br/&gt;
up this code, it will be nice to have this feature be more reliable.&lt;/p&gt;</comment>
                            <comment id="13036379" author="knutanders" created="Thu, 19 May 2011 20:11:40 +0100"  >&lt;p&gt;Thanks, Bryan.&lt;/p&gt;

&lt;p&gt;I think the execution hierarchy only partially mirrors the compile hierarchy. At least I cannot find any execution classes that correspond to the various operator node classes. The operator nodes seem to be transformed into methods at code-generation time, so there&apos;s no class or instance representing them anymore.&lt;/p&gt;

&lt;p&gt;I agree that the &quot;executor&quot; name is problematic if we move SqlXmlExecutor to the types package. I&apos;m actually considering a somewhat more drastic approach and remove the class altogether, merging its methods into SqlXmlUtil (which is already in the types package). SqlXmlExecutor is just a thin wrapper around SqlXmlUtil, so I think that would work. Currently, SqlXmlUtil is instantiated once per activation, and SqlXmlExecutor once per row accessed, so they are not a perfect match right now. But as I mentioned in my previous comment, I don&apos;t really see any reason why SqlXmlExecutor needs to be instantiated per row, so I&apos;m pretty sure the SqlXmlExecutor class can go away now.&lt;/p&gt;</comment>
                            <comment id="13036608" author="bryanpendleton" created="Fri, 20 May 2011 01:40:17 +0100"  >&lt;p&gt;+1 to deleting unnecessary code and classes!&lt;/p&gt;</comment>
                            <comment id="13036652" author="lilywei" created="Fri, 20 May 2011 04:43:05 +0100"  >&lt;p&gt;+1 for making SqlXmlUtil and SqlXmlExecutor more intuitive match with per activation or per row access&lt;/p&gt;</comment>
                            <comment id="13036753" author="knutanders" created="Fri, 20 May 2011 10:59:55 +0100"  >&lt;p&gt;Committed revision 1125305.&lt;/p&gt;</comment>
                            <comment id="13036785" author="knutanders" created="Fri, 20 May 2011 12:30:44 +0100"  >&lt;p&gt;Attaching a followup patch, d3870-2a.diff, which implements the following optimization:&lt;/p&gt;

&lt;p&gt;Instead of doing lazy initialization of the field that holds the SqlXmlUtil instance, when the first row is accessed, the field is now initialized in the activation&apos;s constructor. The code generated for the operator can therefore be simplified, as it doesn&apos;t need to check if the field is initialized.&lt;/p&gt;

&lt;p&gt;This change also allows us to remove the redundant compilation of the XML query when the execution plan is created. That redundant compilation was left in the code only to ensure that syntax errors in the XML query were reported at compile-time. Since the activation is created when the statement is prepared, exceptions raised in the activation&apos;s constructor will be reported at compile-time (whereas the previous behaviour with lazy initialization would have delayed the error until execution-time).&lt;/p&gt;

&lt;p&gt;As a consequence, the XML query will now be compiled exactly once per activation. Before this patch, it would be compiled once when creating the plan, and then again once for each activation. Probably not much of an optimization, but it&apos;s simpler and feels cleaner that way.&lt;/p&gt;

&lt;p&gt;All the XML tests passed with the patch. I&apos;ll run the full regression test suite too, just in case.&lt;/p&gt;</comment>
                            <comment id="13036825" author="knutanders" created="Fri, 20 May 2011 14:33:29 +0100"  >&lt;p&gt;All tests passed with the 2a patch.&lt;/p&gt;</comment>
                            <comment id="13037772" author="knutanders" created="Mon, 23 May 2011 08:44:29 +0100"  >&lt;p&gt;Committed revision 1126358.&lt;/p&gt;</comment>
                            <comment id="13038042" author="dagw" created="Mon, 23 May 2011 17:54:12 +0100"  >&lt;p&gt;2a looks like a clear improvement to me. +1&lt;/p&gt;</comment>
                            <comment id="13039050" author="knutanders" created="Wed, 25 May 2011 10:33:14 +0100"  >&lt;p&gt;I&apos;m attaching a new followup patch (3a) which removes the SqlXmlExecutor class. By doing this, we avoid the allocation of one SqlXmlExecutor instance per row seen by an XML operator, and we reduce the amount of code. We still cache the SqlXmlUtil instance in the activation so that the XML queries only have to be compiled once per activation.&lt;/p&gt;

&lt;p&gt;Since SqlXmlExecutor is just a thin wrapper around SqlXmlUtil and XMLDataType, the byte-code generation for the XML operator could be changed to invoke the methods directly on the XMLDataValue objects, passing the cached SqlXmlUtil instance as an argument. Apart from that, only small changes were needed (changing the order and type of arguments in some method signatures where SqlXmlExecutor and XMLDataValue differed, and adding some null handling previously performed by SqlXmlExecutor to the XMLPARSE implementation).&lt;/p&gt;

&lt;p&gt;All the regression tests passed with the patch.&lt;/p&gt;</comment>
                            <comment id="13039667" author="knutanders" created="Thu, 26 May 2011 13:19:09 +0100"  >&lt;p&gt;Committed revision 1127883.&lt;/p&gt;

&lt;p&gt;Marking the issue as resolved.&lt;/p&gt;</comment>
                            <comment id="13043305" author="knutanders" created="Fri, 3 Jun 2011 12:15:16 +0100"  >&lt;p&gt;Backported the fix to the 10.8 branch (revision 1130983).&lt;/p&gt;

&lt;p&gt;I think we also need to bump the last digit in the version number on the branch in case someone following the updates on the branch has triggers that use XML operators. This is needed because the format of the compiled execution plans has changed, so the triggers need to be recompiled. Bumping the last digit in the version number will make the triggers recompile automatically.&lt;/p&gt;</comment>
                            <comment id="13043315" author="knutanders" created="Fri, 3 Jun 2011 12:49:37 +0100"  >&lt;p&gt;Uh-oh! Bumping the last digit wasn&apos;t enough to get the triggers to recompile cleanly. They fail to read the old plan, which they&apos;re just supposed to throw away anyway, because of some serialization error. Possibly because the SqlXmlExecutor class was removed while it&apos;s still needed to read the old plans. Seems like the same problem exists when upgrading from 10.8.1.2 to trunk as well, so I&apos;m reopening to fix the upgrade issues.&lt;/p&gt;

&lt;p&gt;I&apos;ve backed out the fix from the branch until the upgrade issue has been resolved (revision 1131002).&lt;/p&gt;</comment>
                            <comment id="13043376" author="knutanders" created="Fri, 3 Jun 2011 15:45:37 +0100"  >&lt;p&gt;It looks like the problems are caused by the code that drops JDBC metadata queries and invalidates stored prepared statement on upgrade. This code scans through SYS.SYSSTATEMENTS and reads every column in every row of the table. When it comes across a statement that uses one of the XML operators, it fails to deserialize the old plan because it contains SqlXmlUtil instances in the savedObject field, and the SqlXmlUtil class doesn&apos;t implement Formatable anymore.&lt;/p&gt;

&lt;p&gt;I think the fix is simple. See the attached patch upgrade.diff, which simply makes the upgrade code skip the column that contains the compiled plan. Then the upgrade code is able to fetch the stored statements from the system table and flag them as invalid.&lt;/p&gt;

&lt;p&gt;I would like to add a test case for this in the upgrade tests, but it&apos;s a bit tricky since the XML operators aren&apos;t always available, and the requirements vary between different versions of Derby, so it&apos;s hard to determine whether or not the test case is expected to pass on the platform. I&apos;ll give it a try, though.&lt;/p&gt;</comment>
                            <comment id="13044416" author="bryanpendleton" created="Sun, 5 Jun 2011 00:46:31 +0100"  >&lt;p&gt;Thanks for tracking this down! I&apos;m not sure I&apos;d use the word &quot;simple&quot; here, but your description&lt;br/&gt;
is quite clear, and your upgrade.diff patch looks good to me. I understand your frustration about&lt;br/&gt;
the delicacy of constructing a test to demonstrate this problem, given the platform dependent&lt;br/&gt;
XML behavior. Even if you can&apos;t easily construct the test, I think that the technique of avoiding&lt;br/&gt;
the problematic compiled-plan column is a reasonable solution, so +1 from me.&lt;/p&gt;</comment>
                            <comment id="13044601" author="knutanders" created="Sun, 5 Jun 2011 19:38:59 +0100"  >&lt;p&gt;Thanks for taking a look at the patch, Bryan. I&apos;m uploading a new patch which adds a test case for the upgrade scenario. The test creates a trigger using the old version and verifies that the trigger works after upgrading. Without the fix in the data dictionary, the test fails to boot the database with the new version.&lt;/p&gt;

&lt;p&gt;I think the test handles all combinations of XML ops being supported/not-supported with the old/new Derby version in the running environment. The different cases are handled like this:&lt;/p&gt;

&lt;p&gt;1) If XML ops aren&apos;t supported with the new version, the test case is disabled in the test setup (we have helper methods to detect this).&lt;/p&gt;

&lt;p&gt;2) If XML ops are supported with the new version, but not with the old version, the test case runs, but it will detect that CREATE TRIGGER fails with an exception saying XML requirements aren&apos;t satisfied. It will immediately return without reporting a failure.&lt;/p&gt;

&lt;p&gt;3) If the situation described in (2) happens, the test case will run in all phases (create, soft-upgrade, post-soft-upgrade, hard-upgrade), but there is no trigger to test. The test case queries the system tables to see if the trigger has been created, and returns immediately if the trigger doesn&apos;t exist.&lt;/p&gt;

&lt;p&gt;4) Since XML operators aren&apos;t supported at all before version 10.2, and creating the trigger will fail with a different exception than the one we detect as XML requirements not satisfied, the test case is made a no-op if the tested combination uses a too old version. (Actually, it only tests upgrade from 10.3 and newer now. That&apos;s because the CREATE TRIGGER statement fails on 10.2 because it lacks the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1770&quot; title=&quot;Make &amp;quot;mode db2sql&amp;quot; an optional phrase in the &amp;quot;create trigger&amp;quot; statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1770&quot;&gt;&lt;del&gt;DERBY-1770&lt;/del&gt;&lt;/a&gt;.)&lt;/p&gt;

&lt;p&gt;All regression tests passed in my environment.&lt;/p&gt;</comment>
                            <comment id="13044755" author="knutanders" created="Mon, 6 Jun 2011 10:24:03 +0100"  >&lt;p&gt;Committed revision 1132546.&lt;/p&gt;</comment>
                            <comment id="13044837" author="knutanders" created="Mon, 6 Jun 2011 14:24:31 +0100"  >&lt;p&gt;I&apos;ve now backported the fixes, including the upgrade fix, to the 10.8 branch. I also bumped the version on the branch to 10.8.1.4 in order to make upgrade work for those who follow the branch.&lt;/p&gt;

&lt;p&gt;Committed revision 1132626.&lt;/p&gt;</comment>
                            <comment id="13229381" author="kmarsden" created="Wed, 14 Mar 2012 17:19:47 +0000"  >&lt;p&gt;Reopen for 10.5 backport consideration. If working on the backport for this issue. Temporarily assign yourself and add a comment that you are working on it. When finished, reresolve with the new fix versions or label backport_reject_10_x as appropriate.&lt;/p&gt;</comment>
                            <comment id="13231348" author="kmarsden" created="Fri, 16 Mar 2012 16:30:27 +0000"  >&lt;p&gt;Re-resolving this issue without any further backport.&lt;br/&gt;
The portion of this issue suitable for backport was backported all the way to 10.1 with &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5289&quot; title=&quot;Unable to boot 10.5.1.1 database - fails during soft/hard upgrade process for a new version number while trying to drop jdbc metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5289&quot;&gt;&lt;del&gt;DERBY-5289&lt;/del&gt;&lt;/a&gt;. The rest looks too involved for a simple backport.  It was actually backported to 10.8 from trunk with a forth digit version bump, so maybe if someone really needed it, they could look at it again.  Marking derby_backport_reject_10_7 for now.&lt;/p&gt;

</comment>
                            <comment id="13685230" author="knutanders" created="Mon, 17 Jun 2013 10:19:24 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                            <comment id="14043158" author="jira-bot" created="Wed, 25 Jun 2014 08:58:08 +0100"  >&lt;p&gt;Commit 1605285 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;Knut Anders Hatlen&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1605285&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1605285&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6634&quot; title=&quot;Improve test coverage of SqlXmlUtil.java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6634&quot;&gt;&lt;del&gt;DERBY-6634&lt;/del&gt;&lt;/a&gt;: Improve test coverage of SqlXmlUtil.java&lt;/p&gt;

&lt;p&gt;Remove dead code from the time when SqlXmlUtil implemented the&lt;br/&gt;
Formatable interface (before &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3870&quot; title=&quot;Concurrent Inserts of rows with XML data results in an exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3870&quot;&gt;&lt;del&gt;DERBY-3870&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12509398">DERBY-5263</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12390033" name="Copy of derby.log" size="10628" author="aslom" created="Fri, 12 Sep 2008 21:31:46 +0100"/>
                            <attachment id="12390032" name="DerbyMultiInsertXmlException.zip" size="16939" author="aslom" created="Fri, 12 Sep 2008 21:30:31 +0100"/>
                            <attachment id="12479763" name="d3870-1a.diff" size="26661" author="knutanders" created="Thu, 19 May 2011 13:36:31 +0100"/>
                            <attachment id="12479764" name="d3870-1a.stat" size="678" author="knutanders" created="Thu, 19 May 2011 13:36:31 +0100"/>
                            <attachment id="12479896" name="d3870-2a.diff" size="4362" author="knutanders" created="Fri, 20 May 2011 12:30:44 +0100"/>
                            <attachment id="12480392" name="d3870-3a.diff" size="27917" author="knutanders" created="Wed, 25 May 2011 10:33:14 +0100"/>
                            <attachment id="12480393" name="d3870-3a.stat" size="462" author="knutanders" created="Wed, 25 May 2011 10:33:14 +0100"/>
                            <attachment id="12478807" name="d3870-junit.diff" size="8511" author="knutanders" created="Wed, 11 May 2011 12:39:01 +0100"/>
                            <attachment id="12481515" name="upgrade-with-test.diff" size="7102" author="knutanders" created="Sun, 5 Jun 2011 19:38:59 +0100"/>
                            <attachment id="12481351" name="upgrade.diff" size="3344" author="knutanders" created="Fri, 3 Jun 2011 15:45:36 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 10 Sep 2008 02:45:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23889</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10426"><![CDATA[Known fix]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0cnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35869</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>