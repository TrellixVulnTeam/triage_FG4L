<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:43:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1087/DERBY-1087.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1087] Updatable result sets behave different depending on the type of query used to generate the result set</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1087</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Running the following code with different queries in the first statement produces different results.&lt;br/&gt;
Where t1 has two columns: &quot;a&quot; of type int is the primary key, and &quot;b&quot; of type varchar(50); and contains 10 rows of data.&lt;/p&gt;


&lt;p&gt;            Statement st1 = conn.createStatement(ResultSet.TYPE_FORWARD_ONLY, &lt;br/&gt;
                    ResultSet.CONCUR_UPDATABLE);&lt;br/&gt;
            Statement st2 = conn.createStatement();&lt;/p&gt;

&lt;p&gt;            ResultSet rs = st1.executeQuery(&quot;SELECT a, b FROM t1&quot;);&lt;br/&gt;
            rs.next();&lt;br/&gt;
            rs.next();&lt;br/&gt;
            st2.executeUpdate(&quot;UPDATE t1 SET a = a + 20 WHERE a = &quot; + &lt;br/&gt;
                    rs.getInt(1));&lt;br/&gt;
            try &lt;/p&gt;
{
                rs.updateInt(1, rs.getInt(1) + 30);
                rs.updateRow();
            }
&lt;p&gt; catch (SQLException se) &lt;/p&gt;
{
                System.out.println(se.getMessage());
            }
&lt;p&gt;            rs.close();&lt;/p&gt;

&lt;p&gt;            rs = st2.executeQuery(&quot;SELECT a FROM t1&quot;);&lt;br/&gt;
            while(rs.next()) &lt;/p&gt;
{
                System.out.println(&quot;A = &quot; + rs.getInt(1));
            }
&lt;p&gt;            rs.close();&lt;/p&gt;

&lt;p&gt;            st2.close();&lt;br/&gt;
            st1.close();&lt;/p&gt;

&lt;p&gt;If the first query is &quot;select a, b from t1&quot;, the output will be:&lt;br/&gt;
A = 1&lt;br/&gt;
A = 3&lt;br/&gt;
A = 4&lt;br/&gt;
A = 5&lt;br/&gt;
A = 6&lt;br/&gt;
A = 7&lt;br/&gt;
A = 8&lt;br/&gt;
A = 9&lt;br/&gt;
A = 10&lt;br/&gt;
A = 32&lt;/p&gt;

&lt;p&gt;If the first query is &quot;SELECT a, b FROM t1 WHERE a &amp;lt;= 5&quot;, the output will be:&lt;br/&gt;
Cursor &apos;SQLCUR0&apos; is not on a row.&lt;br/&gt;
A = 1&lt;br/&gt;
A = 3&lt;br/&gt;
A = 4&lt;br/&gt;
A = 5&lt;br/&gt;
A = 6&lt;br/&gt;
A = 7&lt;br/&gt;
A = 8&lt;br/&gt;
A = 9&lt;br/&gt;
A = 10&lt;br/&gt;
A = 22&lt;/p&gt;

&lt;p&gt;If the first query is &quot;SELECT a FROM t1&quot;, the output will be:&lt;br/&gt;
Cursor &apos;SQLCUR0&apos; is not on a row.&lt;br/&gt;
A = 1&lt;br/&gt;
A = 3&lt;br/&gt;
A = 4&lt;br/&gt;
A = 5&lt;br/&gt;
A = 6&lt;br/&gt;
A = 7&lt;br/&gt;
A = 8&lt;br/&gt;
A = 9&lt;br/&gt;
A = 10&lt;br/&gt;
A = 22&lt;/p&gt;</description>
                <environment></environment>
        <key id="12329964">DERBY-1087</key>
            <summary>Updatable result sets behave different depending on the type of query used to generate the result set</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fernanda">Fernanda Pizzorno</assignee>
                                    <reporter username="fernanda">Fernanda Pizzorno</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Mar 2006 19:25:43 +0000</created>
                <updated>Tue, 16 May 2006 15:24:26 +0100</updated>
                            <resolved>Tue, 16 May 2006 01:10:24 +0100</resolved>
                                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>JDBC</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12369435" author="andreask" created="Wed, 8 Mar 2006 20:48:10 +0000"  >&lt;p&gt;&amp;gt; If the first query is &quot;SELECT a, b FROM t1 WHERE a &amp;lt;= 5&quot;, the output will be:&lt;br/&gt;
&amp;gt; Cursor &apos;SQLCUR0&apos; is not on a row.&lt;br/&gt;
&amp;gt; A = 1&lt;br/&gt;
&amp;gt; A = 3&lt;br/&gt;
&amp;gt; A = 4&lt;br/&gt;
&amp;gt; A = 5&lt;br/&gt;
&amp;gt; A = 6&lt;br/&gt;
&amp;gt; A = 7&lt;br/&gt;
&amp;gt; A = 8&lt;br/&gt;
&amp;gt; A = 9&lt;br/&gt;
&amp;gt; A = 10&lt;br/&gt;
&amp;gt; A = 22&lt;/p&gt;

&lt;p&gt;The fact that you get &quot;Cursor &apos;SQLCUR0&apos; is not on a row.&quot; when using indexes seems like a bug.&lt;br/&gt;
Can you confirm that if the query is &quot;SELECT a, b FROM t1 WHERE a &amp;lt;= 5&quot;, and there is no index on the table (no primary key), you do not get this error ?&lt;/p&gt;
</comment>
                            <comment id="12369446" author="fernanda" created="Wed, 8 Mar 2006 21:44:28 +0000"  >&lt;p&gt;I have tried without the index and it actually fails too when the query is &quot;SELECT a, b FROM t1 WHERE a &amp;lt;= 5&quot;. So actually there are two different problems:&lt;/p&gt;

&lt;p&gt;1. when you use &quot;SELECT a, b FROM t1 WHERE a &amp;lt;= 5&quot;, the statement that updates the row will change the value of a so that it no longer qualifies (a is not &amp;lt;= 5) and that why you get the error that the cursor is not on a row.&lt;/p&gt;

&lt;p&gt;2. when you use &quot;SELECT a FROM t1&quot;, since all of the projected columns are covered by the index, the results are not fetched from the heap, the index is used instead. When the update statement changes the value of a, the entry for a is no longer in the same position in the b-tree, causing the error.&lt;/p&gt;

&lt;p&gt;I will make the title of the JIRA issue less specific so that it covers both cases.&lt;/p&gt;
</comment>
                            <comment id="12373119" author="fernanda" created="Wed, 5 Apr 2006 00:30:58 +0100"  >&lt;p&gt;Proposed resolution to the two issues presented in my last comment:&lt;/p&gt;

&lt;p&gt;1. Is actually the expected behavior in derby for forward-only updatable result sets in derby, so it is not a bug. I plan not to change this behavior.&lt;/p&gt;

&lt;p&gt;2. I am considering to remove the optimization for covering indexes (that makes the results to be fetched directly from the index instead of the heap) in the case where the query produces an updatable result set, since the same problem will happen for both forward-only and scrollable updatable result sets. Does anybody see a problem with this?&lt;/p&gt;


&lt;p&gt;Fernanda wrote:&lt;br/&gt;
____________________________________&lt;br/&gt;
I have tried without the index and it actually fails too when the query is &quot;SELECT a, b FROM t1 WHERE a &amp;lt;= 5&quot;. So actually there are two different problems:&lt;/p&gt;

&lt;p&gt;1. when you use &quot;SELECT a, b FROM t1 WHERE a &amp;lt;= 5&quot;, the statement that updates the row will change the value of a so that it no longer qualifies (a is not &amp;lt;= 5) and that why you get the error that the cursor is not on a row.&lt;/p&gt;

&lt;p&gt;2. when you use &quot;SELECT a FROM t1&quot;, since all of the projected columns are covered by the index, the results are not fetched from the heap, the index is used instead. When the update statement changes the value of a, the entry for a is no longer in the same position in the b-tree, causing the error.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
____________________________________&lt;/p&gt;</comment>
                            <comment id="12377408" author="fernanda" created="Tue, 2 May 2006 23:14:34 +0100"  >&lt;p&gt;Since I have not seen any objections to the resolution I proposed on the 4th of April, I am attaching a patch that removes the optimization for covering indexes (that makes the results to be fetched directly from the index instead of the heap) in the case where the query produces an updatable result set, since the same problem will happen for both forward-only and scrollable updatable result sets. This patch also includes a new test for both forward-only and scrollable insensitive updatable result sets with covering indexes.&lt;/p&gt;

&lt;p&gt;This removes an optimization and is not an ideal solution. Someone later might be interested in looking updatable result sets work with the optimization (fetching data only from the index and not using the heap).&lt;/p&gt;

&lt;p&gt;Fernanda wrote:&lt;br/&gt;
_______________________________&lt;br/&gt;
Proposed resolution to the two issues presented in my last comment:&lt;/p&gt;

&lt;p&gt;1. Is actually the expected behavior in derby for forward-only updatable result sets in derby, so it is not a bug. I plan not to change this behavior.&lt;/p&gt;

&lt;p&gt;2. I am considering to remove the optimization for covering indexes (that makes the results to be fetched directly from the index instead of the heap) in the case where the query produces an updatable result set, since the same problem will happen for both forward-only and scrollable updatable result sets. Does anybody see a problem with this?&lt;br/&gt;
_______________________________ &lt;/p&gt;</comment>
                            <comment id="12377409" author="fernanda" created="Tue, 2 May 2006 23:15:31 +0100"  >&lt;p&gt;Can someone please review this patch?&lt;/p&gt;

&lt;p&gt;Thank you in advance!&lt;/p&gt;</comment>
                            <comment id="12378595" author="andreask" created="Tue, 9 May 2006 17:55:10 +0100"  >&lt;p&gt;I have downloaded the patch, and first only applied the test, to see that it failed before taking in the changes in the engine. It seems like the test now fails with a ClassCastException in TableScanResultSet:&lt;br/&gt;
There was 1 error:&lt;br/&gt;
1) testUpdateUpdatedTuple(org.apache.derbyTesting.functionTests.tests.jdbcapi.URCoveringIndexTest)java.lang.ClassCastException&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.TableScanResultSet.getRowLocation(TableScanResultSet.java:907)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getRowLocation(ProjectRestrictResultSet.java:408)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.ScrollInsensitiveResultSet.getRowLocation(ScrollInsensitiveResultSet.java:942)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.CurrentOfResultSet.getNextRowCore(CurrentOfResultSet.java:120)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(ProjectRestrictResultSet.java:258)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(DMLWriteResultSet.java:123)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.UpdateResultSet.collectAffectedRows(UpdateResultSet.java:450)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSet.java:272)&lt;br/&gt;
        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:361)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1181)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:584)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(EmbedStatement.java:176)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.jdbcapi.URCoveringIndexTest.testUpdateUpdatedTupleWithCoveringIndex(URCoveringIndexTest.java:96)&lt;br/&gt;
        at org.apache.derbyTesting.functionTests.tests.jdbcapi.URCoveringIndexTest.testUpdateUpdatedTuple(URCoveringIndexTest.java:119)&lt;/p&gt;

&lt;p&gt;I have been able to reproduce this in a debugger. TableScanResultSet does a cast to RowLocation in line 907, however the DataValueColumn is at the time of the failure a SQLInteger, not a RowLocation.&lt;/p&gt;

&lt;p&gt;After applying the patch, I did not get any failures.&lt;/p&gt;</comment>
                            <comment id="12378596" author="andreask" created="Tue, 9 May 2006 17:57:50 +0100"  >&lt;p&gt;Review:&lt;/p&gt;

&lt;p&gt;The patch looks good, here are some minor comments:&lt;/p&gt;

&lt;p&gt;1. In java/engine/org/apache/derby/impl/sql/compile/FromBaseTable.java, consider using a call to forUpdate() method instead of using the  cursorTargetTable attribute directly.&lt;/p&gt;

&lt;p&gt;2. Testing: I do not think the testcase should be added to derbynetclientmats, since it is already added to jdbcapi (it is not really a network client change)&lt;/p&gt;

&lt;p&gt;3. Testing: Consider making 4 test methods instead of testing all variants in the same testmethod. Now, the test fails at the first case, and I do not get to see the results of the other variants. Also please add javadoc to all testcase methods.&lt;/p&gt;</comment>
                            <comment id="12378903" author="fernanda" created="Wed, 10 May 2006 20:34:25 +0100"  >&lt;p&gt;Patch derby-1087v2.diff addresses the review comments.&lt;/p&gt;

&lt;p&gt;1. I changed java/engine/org/apache/derby/impl/sql/compile/FromBaseTable.java to use a call to cursorTargetTable() method instead of using the cursorTargetTable attribute directly. I chose not to use forUpdate() as suggested because it is too generic.&lt;/p&gt;

&lt;p&gt;2. Removed the test from derbynetclientmats.&lt;/p&gt;

&lt;p&gt;3. Made 4 tests methods and added javadoc to the 4 of them.&lt;/p&gt;

&lt;p&gt;_______________________&lt;br/&gt;
Andreas wrote:&lt;br/&gt;
Review:&lt;/p&gt;

&lt;p&gt;The patch looks good, here are some minor comments:&lt;/p&gt;

&lt;p&gt;1. In java/engine/org/apache/derby/impl/sql/compile/FromBaseTable.java, consider using a call to forUpdate() method instead of using the cursorTargetTable attribute directly.&lt;/p&gt;

&lt;p&gt;2. Testing: I do not think the testcase should be added to derbynetclientmats, since it is already added to jdbcapi (it is not really a network client change)&lt;/p&gt;

&lt;p&gt;3. Testing: Consider making 4 test methods instead of testing all variants in the same testmethod. Now, the test fails at the first case, and I do not get to see the results of the other variants. Also please add javadoc to all testcase methods. &lt;br/&gt;
_______________________&lt;/p&gt;</comment>
                            <comment id="12379028" author="andreask" created="Thu, 11 May 2006 15:30:18 +0100"  >&lt;p&gt;Thanks for addressing all the changes. I do recommend that this patch get committed.&lt;/p&gt;</comment>
                            <comment id="12379061" author="andreask" created="Thu, 11 May 2006 19:16:49 +0100"  >&lt;p&gt;I failed to notice that the test had been removed from jdbcapi, instead of derbynetclientmats&lt;/p&gt;</comment>
                            <comment id="12379083" author="fernanda" created="Thu, 11 May 2006 23:05:11 +0100"  >&lt;p&gt;Attached patch derby-1087v3.diff which removes the test from derbynetclientmats and added it back to jdbcapi. Thank you for reviewing the patch Andreas.&lt;/p&gt;</comment>
                            <comment id="12379084" author="andreask" created="Thu, 11 May 2006 23:17:17 +0100"  >&lt;p&gt;Great, then I do not have any issues w.r.t this patch, and (again) recommend it being committed.&lt;/p&gt;</comment>
                            <comment id="12402355" author="bernt" created="Tue, 16 May 2006 01:10:24 +0100"  >&lt;p&gt;Committed revision 406683.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12326152" name="derby-1087.diff" size="14248" author="fernanda" created="Tue, 2 May 2006 23:14:34 +0100"/>
                            <attachment id="12326153" name="derby-1087.stat" size="766" author="fernanda" created="Tue, 2 May 2006 23:14:34 +0100"/>
                            <attachment id="12326515" name="derby-1087v2.diff" size="14602" author="fernanda" created="Wed, 10 May 2006 20:34:25 +0100"/>
                            <attachment id="12326516" name="derby-1087v2.stat" size="686" author="fernanda" created="Wed, 10 May 2006 20:34:25 +0100"/>
                            <attachment id="12326562" name="derby-1087v3.diff" size="14570" author="fernanda" created="Thu, 11 May 2006 23:05:11 +0100"/>
                            <attachment id="12326563" name="derby-1087v3.stat" size="675" author="fernanda" created="Thu, 11 May 2006 23:05:11 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 8 Mar 2006 20:48:10 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22299</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10102"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy16fb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40691</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>