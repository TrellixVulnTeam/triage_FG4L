<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:10:55 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-2457/DERBY-2457.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-2457] Use of column aliases in group by / having clauses can cause queries to fail</title>
                <link>https://issues.apache.org/jira/browse/DERBY-2457</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Some use of column aliases in group by / having clauses can cause queries to fail with error 42X04. The queries can sometimes be made to work by also aliasing the table or rewriting the query to use a subselect. Attached is a simple sql script which reproduces the issue, originally found as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1624&quot; title=&quot;use of direct column name rather than alias make aggregation fail (Hibernate depends on that)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1624&quot;&gt;&lt;del&gt;DERBY-1624&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12365064">DERBY-2457</key>
            <summary>Use of column aliases in group by / having clauses can cause queries to fail</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="fuzzylogic">Andrew McIntyre</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Mar 2007 22:58:21 +0000</created>
                <updated>Fri, 21 Jan 2011 17:49:57 +0000</updated>
                            <resolved>Tue, 13 May 2008 23:34:46 +0100</resolved>
                                    <version>10.3.1.4</version>
                                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12481364" author="fuzzylogic" created="Thu, 15 Mar 2007 22:58:44 +0000"  >&lt;p&gt;Attaching sql script from &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1624&quot; title=&quot;use of direct column name rather than alias make aggregation fail (Hibernate depends on that)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1624&quot;&gt;&lt;del&gt;DERBY-1624&lt;/del&gt;&lt;/a&gt; which demonstrates the issue.&lt;/p&gt;</comment>
                            <comment id="12548931" author="mkhettry" created="Thu, 6 Dec 2007 06:27:07 +0000"  >&lt;p&gt;Don&apos;t have the time to look into this right now.&lt;/p&gt;</comment>
                            <comment id="12592579" author="bryanpendleton" created="Sat, 26 Apr 2008 17:02:20 +0100"  >&lt;p&gt;This seems fairly similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2351&quot; title=&quot;ORDER BY with expression with distinct in the select list returns incorrect result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2351&quot;&gt;&lt;del&gt;DERBY-2351&lt;/del&gt;&lt;/a&gt;, in which we established a set of rules&lt;br/&gt;
for how to resolve column references in ORDER BY clauses. The resolution&lt;br/&gt;
rules use a search path and thus can handle both the use of aliases as well&lt;br/&gt;
as the use of underlying column names, and distinguish ambiguous cases&lt;br/&gt;
depending on whether the column reference was qualified or unqualified.&lt;/p&gt;

&lt;p&gt;It seems like something similar could work effectively for column references&lt;br/&gt;
in GROUP BY and HAVING clauses.&lt;/p&gt;

&lt;p&gt;I&apos;ll have a look at the work we did in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2351&quot; title=&quot;ORDER BY with expression with distinct in the select list returns incorrect result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2351&quot;&gt;&lt;del&gt;DERBY-2351&lt;/del&gt;&lt;/a&gt;, and the queries in 1624_repro.sql,&lt;br/&gt;
and see if the same, or similar, techniques could be used here.&lt;/p&gt;</comment>
                            <comment id="12595094" author="bryanpendleton" created="Thu, 8 May 2008 00:50:49 +0100"  >&lt;p&gt;It appears that, while ORDER BY items are bound to the select&apos;s&lt;br/&gt;
result column list, GROUP BY and HAVING items are bound to&lt;br/&gt;
the select&apos;s &quot;from list&quot;. &lt;/p&gt;

&lt;p&gt;So one approach might be to change GroupByColumn.bindExpression&lt;br/&gt;
and similar places to be more like OrderByColumn.bindOrderByColumn;&lt;br/&gt;
that is, to bind against the select RCL, rather than against the from list.&lt;/p&gt;</comment>
                            <comment id="12595109" author="fuzzylogic" created="Thu, 8 May 2008 04:12:41 +0100"  >&lt;p&gt;See also the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-84&quot; title=&quot;Column aliasing could simplify queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-84&quot;&gt;&lt;del&gt;DERBY-84&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-127&quot; title=&quot;Aliased Columns not recognized after &amp;quot;group by... order by&amp;quot; combination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-127&quot;&gt;&lt;del&gt;DERBY-127&lt;/del&gt;&lt;/a&gt;. This bug could be potentially be considered a dup of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-84&quot; title=&quot;Column aliasing could simplify queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-84&quot;&gt;&lt;del&gt;DERBY-84&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12595246" author="dagw" created="Thu, 8 May 2008 15:06:51 +0100"  >&lt;p&gt;&amp;gt; It appears that, while ORDER BY items are bound to the select&apos;s&lt;br/&gt;
&amp;gt; result column list, GROUP BY and HAVING items are bound to&lt;br/&gt;
&amp;gt; the select&apos;s &quot;from list&quot;. &lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; So one approach might be to change GroupByColumn.bindExpression&lt;br/&gt;
&amp;gt; and similar places to be more like OrderByColumn.bindOrderByColumn;&lt;br/&gt;
&amp;gt; that is, to bind against the select RCL, rather than against the from list.&lt;/p&gt;

&lt;p&gt;This seems to be intentional, cf. this comment:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://issues.apache.org/jira/browse/DERBY-84?focusedCommentId=66872#action_66872&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/DERBY-84?focusedCommentId=66872#action_66872&lt;/a&gt;&lt;br/&gt;
(Klebanoff 02/Jun/05 05:23 PM):&lt;br/&gt;
&quot;My reading of the SQL2003 spec indicates that the Derby behavior&lt;br/&gt;
follows the SQL standard. See the standard&apos;s discussion of identifier&lt;br/&gt;
chains. The spec differentiates between identifiers used in ORDER BY&lt;br/&gt;
clauses and identifiers used elsewhere. The spec says that (column)&lt;br/&gt;
identifiers in a ORDER BY clause should be bound to the column names&lt;br/&gt;
defined in the select list, but that other (column) identifiers should&lt;br/&gt;
be bound to columns in tables in the FROM list.&quot;&lt;/p&gt;

&lt;p&gt;I did not check the standard yet.&lt;/p&gt;</comment>
                            <comment id="12595416" author="bryanpendleton" created="Thu, 8 May 2008 23:58:42 +0100"  >&lt;p&gt;I see the portion of the standard that Jack refers to, and I agree that&lt;br/&gt;
it specifies that only identifiers used in ORDER BY clauses should&lt;br/&gt;
be allowed to refer to derived columns. Section 6.6, syntax rule 8.a.i&lt;br/&gt;
appears to be the text that that Jack observed.&lt;/p&gt;

&lt;p&gt;So perhaps we should resolve this issue as invalid?&lt;/p&gt;</comment>
                            <comment id="12595609" author="dagw" created="Fri, 9 May 2008 15:24:41 +0100"  >&lt;p&gt;I &lt;b&gt;think&lt;/b&gt; this issue is invalid, but I am not really familiar with the&lt;br/&gt;
standard semantics in these areas, which is pretty hard to unravel &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
However I also found this:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Legal column reference occuring inside a GROUP BY is specified in&lt;br/&gt;
  section 7.9, SR 1: &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  &quot;Each &amp;lt;grouping column reference&amp;gt; shall unambiguously reference a&lt;br/&gt;
   column of the table resulting from the &amp;lt;from clause&amp;gt;.&quot;&lt;/p&gt;

&lt;p&gt;The &amp;lt;select list&amp;gt; is on the same syntactic level as the &amp;lt;from clause&amp;gt;&lt;br/&gt;
and is thus not involved in defining the table resulting from the&lt;br/&gt;
&amp;lt;from clause&amp;gt;, see. &amp;lt;query specification&amp;gt; in section 7.12.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Legal column references inside &amp;lt;search condition&amp;gt; in HAVING &amp;lt;search&lt;br/&gt;
  condition&amp;gt; is defined in section 7.10, SR 1-3:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   &quot;1) Let HC be the &amp;lt;having clause&amp;gt;. Let TE be the &amp;lt;table expression&amp;gt;&lt;br/&gt;
   that immediately contains HC. If TE does not immediately contain a&lt;br/&gt;
   &amp;lt;group by clause&amp;gt;, then &quot;GROUP BY ()&quot; is implicit. Let T be the&lt;br/&gt;
   descriptor of the table defined by the &amp;lt;group by clause&amp;gt; GBC&lt;br/&gt;
   immediately contained in TE and let R be the result of GBC.  &lt;/p&gt;

&lt;p&gt;   2) Let G be the set consisting of every column referenced by a &amp;lt;column&lt;br/&gt;
   reference&amp;gt; contained in GBC.  &lt;/p&gt;

&lt;p&gt;   3) Each column reference directly contained in the &amp;lt;search condition&amp;gt;&lt;br/&gt;
   shall be one of the following: a) An unambiguous reference to a column&lt;br/&gt;
   that is functionally dependent on G.  b) An outer reference.  NOTE 148&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;See also the Syntax Rules of Subclause 6.7, &amp;lt;column reference&amp;gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the HAVING case, I &lt;b&gt;think&lt;/b&gt; that the definition of &quot;outer&lt;br/&gt;
reference&quot; excludes the AS &amp;lt;column&amp;gt; alias: It seems to boil down to&lt;br/&gt;
whether the &amp;lt;select-list&amp;gt; constitutes a scope that contains the table&lt;br/&gt;
expression or not, cf. definition of &quot;outer reference&quot;. As I read it&lt;br/&gt;
now, that is not the case, but I could not establish this decisively.&lt;/p&gt;

&lt;p&gt;If that is the correct reading, it seems that any AS alias in the&lt;br/&gt;
&amp;lt;select-list&amp;gt; are not legal in these context, only in the ORDER BY&lt;br/&gt;
context (that clause is defined syntactically not as part of the &amp;lt;from&lt;br/&gt;
clause&amp;gt;, but at the level of &amp;lt;cursor specification&amp;gt;, section 14.1).&lt;/p&gt;

&lt;p&gt;By the same reasoning, I also think the change called for in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-84&quot; title=&quot;Column aliasing could simplify queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-84&quot;&gt;&lt;del&gt;DERBY-84&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
is not legal SQL. Of course, there may other other considerations that standards&lt;br/&gt;
compliance &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12595773" author="bryanpendleton" created="Sat, 10 May 2008 02:48:22 +0100"  >&lt;p&gt;Attached is &apos;additionalTests.diff&apos;, which is a straightforward&lt;br/&gt;
conversion of &apos;1624_repro.sql&apos; into a patch to GroupByTest.java.&lt;/p&gt;

&lt;p&gt;I think it&apos;s valuable having these tests, even if we decide that&lt;br/&gt;
the current behavior is current and that we don&apos;t want to change it.&lt;br/&gt;
In that case, the tests will serve to verify the desired behavior.&lt;/p&gt;

&lt;p&gt;Also, if someone should experiment with changing the behavior&lt;br/&gt;
in the future, having these tests in the system will draw people&apos;s&lt;br/&gt;
attention to this JIRA entry, and thus to the discussion and comments&lt;br/&gt;
in the issue.&lt;/p&gt;

&lt;p&gt;So, I propose to commit the test-only patch, and resolve the issue as invalid.&lt;/p&gt;
</comment>
                            <comment id="12596443" author="bryanpendleton" created="Tue, 13 May 2008 17:55:30 +0100"  >&lt;p&gt;I committed the additional test cases to the trunk as revision 655947.&lt;/p&gt;

&lt;p&gt;Since we believe that the current behavior of Derby is correct&lt;br/&gt;
according to the SQL Standard, I&apos;m resolving the issue as invalid.&lt;br/&gt;
(Would &quot;won&apos;t fix&quot; be more appropriate?)&lt;/p&gt;</comment>
                            <comment id="12596451" author="fuzzylogic" created="Tue, 13 May 2008 18:07:38 +0100"  >&lt;p&gt;Should we also then resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-84&quot; title=&quot;Column aliasing could simplify queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-84&quot;&gt;&lt;del&gt;DERBY-84&lt;/del&gt;&lt;/a&gt; as invalid (or won&apos;t fix)? It&apos;s essentially the same issue.&lt;/p&gt;</comment>
                            <comment id="12596538" author="dagw" created="Tue, 13 May 2008 22:24:02 +0100"  >&lt;p&gt;Extra tests are good, thanks Bryan!&lt;/p&gt;

&lt;p&gt;WHERE clauses cannot reference the select list column aliases either, AFAICT, so it might be good &lt;br/&gt;
to add tests for that, too, if it is not already done somewhere.&lt;/p&gt;

&lt;p&gt;Bryan&amp;gt; Would &quot;won&apos;t fix&quot; be more appropriate?&lt;/p&gt;

&lt;p&gt;I tend to agree; since this issue is not a misunderstanding, to some this&lt;br/&gt;
would be an &quot;improvement&quot; (it is not marked as a bug); &lt;br/&gt;
we are merely deciding that we don&apos;t want to do it,&lt;br/&gt;
in this case because it is not standard compliant as far as we can tell.&lt;/p&gt;

&lt;p&gt;Andrew&amp;gt; Should we also then resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-84&quot; title=&quot;Column aliasing could simplify queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-84&quot;&gt;&lt;del&gt;DERBY-84&lt;/del&gt;&lt;/a&gt; as invalid (or won&apos;t fix)? It&apos;s essentially the same issue.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12596551" author="bryanpendleton" created="Tue, 13 May 2008 23:34:37 +0100"  >&lt;p&gt;Re-opening to re-resolve as &quot;won&apos;t fix&quot;, since that seems more appropriate.&lt;/p&gt;

&lt;p&gt;I&apos;ll look into adding the WHERE clause tests mentioned by Dag as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-84&quot; title=&quot;Column aliasing could simplify queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-84&quot;&gt;&lt;del&gt;DERBY-84&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12379465">DERBY-3094</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12347089">DERBY-1624</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="28620">DERBY-84</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12353449" name="1624_repro.sql" size="2465" author="fuzzylogic" created="Thu, 15 Mar 2007 22:58:43 +0000"/>
                            <attachment id="12381812" name="additionalTests.diff" size="6620" author="bryanpendleton" created="Sat, 10 May 2008 02:48:22 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 Dec 2007 06:27:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30454</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0mjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37471</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>