<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:43:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1089/DERBY-1089.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1089] Derby fails inserting a join into a table with a generated column</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1089</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;I&apos;ve been having a problem inserting the result of a join into a table with a generated column. If I rephrase the join clause into a where clause, the problem goes away. And it only seems to happen if the target table has a generated column. Unfortunately, the join that I want to do in my application is pretty complex so I don&apos;t think I can rephrase it. But here&apos;s a very simplified example of what I&apos;m talking about:&lt;/p&gt;

&lt;p&gt;ij version 10.1&lt;br/&gt;
ij&amp;gt; connect &apos;jdbc:derby:test;create=true&apos;;&lt;br/&gt;
ij&amp;gt; create table source (&lt;br/&gt;
source_id int not null primary key&lt;br/&gt;
);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; insert into source values (0);&lt;br/&gt;
insert into source values (1);&lt;br/&gt;
insert into source values (2);&lt;br/&gt;
insert into source values (3);&lt;br/&gt;
insert into source values (4);&lt;br/&gt;
insert into source values (5);&lt;br/&gt;
insert into source values (6);&lt;br/&gt;
insert into source values (7);&lt;br/&gt;
insert into source values (8);&lt;br/&gt;
insert into source values (9);&lt;br/&gt;
1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; 1 row inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; create table dest (&lt;br/&gt;
dest_id int not null primary key&lt;br/&gt;
   generated always as identity,&lt;br/&gt;
source_id_1 int not null,&lt;br/&gt;
source_id_2 int not null&lt;br/&gt;
);&lt;br/&gt;
0 rows inserted/updated/deleted&lt;br/&gt;
ij&amp;gt; select s1.source_id, s2.source_id&lt;br/&gt;
from source as s1&lt;br/&gt;
join source as s2&lt;br/&gt;
on 1 = 1;&lt;br/&gt;
SOURCE_ID  |SOURCE_ID&lt;br/&gt;
-----------------------&lt;br/&gt;
0          |0&lt;br/&gt;
0          |1&lt;br/&gt;
0          |2&lt;br/&gt;
0          |3&lt;br/&gt;
0          |4&lt;br/&gt;
0          |5&lt;br/&gt;
0          |6&lt;br/&gt;
0          |7&lt;br/&gt;
0          |8&lt;br/&gt;
0          |9&lt;br/&gt;
1          |0&lt;br/&gt;
1          |1&lt;br/&gt;
1          |2&lt;br/&gt;
1          |3&lt;br/&gt;
1          |4&lt;br/&gt;
1          |5&lt;br/&gt;
1          |6&lt;br/&gt;
1          |7&lt;br/&gt;
1          |8&lt;br/&gt;
1          |9&lt;br/&gt;
2          |0&lt;br/&gt;
2          |1&lt;br/&gt;
2          |2&lt;br/&gt;
2          |3&lt;br/&gt;
2          |4&lt;br/&gt;
2          |5&lt;br/&gt;
2          |6&lt;br/&gt;
2          |7&lt;br/&gt;
2          |8&lt;br/&gt;
2          |9&lt;br/&gt;
3          |0&lt;br/&gt;
3          |1&lt;br/&gt;
3          |2&lt;br/&gt;
3          |3&lt;br/&gt;
3          |4&lt;br/&gt;
3          |5&lt;br/&gt;
3          |6&lt;br/&gt;
3          |7&lt;br/&gt;
3          |8&lt;br/&gt;
3          |9&lt;br/&gt;
4          |0&lt;br/&gt;
4          |1&lt;br/&gt;
4          |2&lt;br/&gt;
4          |3&lt;br/&gt;
4          |4&lt;br/&gt;
4          |5&lt;br/&gt;
4          |6&lt;br/&gt;
4          |7&lt;br/&gt;
4          |8&lt;br/&gt;
4          |9&lt;br/&gt;
5          |0&lt;br/&gt;
5          |1&lt;br/&gt;
5          |2&lt;br/&gt;
5          |3&lt;br/&gt;
5          |4&lt;br/&gt;
5          |5&lt;br/&gt;
5          |6&lt;br/&gt;
5          |7&lt;br/&gt;
5          |8&lt;br/&gt;
5          |9&lt;br/&gt;
6          |0&lt;br/&gt;
6          |1&lt;br/&gt;
6          |2&lt;br/&gt;
6          |3&lt;br/&gt;
6          |4&lt;br/&gt;
6          |5&lt;br/&gt;
6          |6&lt;br/&gt;
6          |7&lt;br/&gt;
6          |8&lt;br/&gt;
6          |9&lt;br/&gt;
7          |0&lt;br/&gt;
7          |1&lt;br/&gt;
7          |2&lt;br/&gt;
7          |3&lt;br/&gt;
7          |4&lt;br/&gt;
7          |5&lt;br/&gt;
7          |6&lt;br/&gt;
7          |7&lt;br/&gt;
7          |8&lt;br/&gt;
7          |9&lt;br/&gt;
8          |0&lt;br/&gt;
8          |1&lt;br/&gt;
8          |2&lt;br/&gt;
8          |3&lt;br/&gt;
8          |4&lt;br/&gt;
8          |5&lt;br/&gt;
8          |6&lt;br/&gt;
8          |7&lt;br/&gt;
8          |8&lt;br/&gt;
8          |9&lt;br/&gt;
9          |0&lt;br/&gt;
9          |1&lt;br/&gt;
9          |2&lt;br/&gt;
9          |3&lt;br/&gt;
9          |4&lt;br/&gt;
9          |5&lt;br/&gt;
9          |6&lt;br/&gt;
9          |7&lt;br/&gt;
9          |8&lt;br/&gt;
9          |9&lt;/p&gt;

&lt;p&gt;100 rows selected&lt;br/&gt;
ij&amp;gt; insert into dest (source_id_1, source_id_2)&lt;br/&gt;
select s1.source_id, s2.source_id&lt;br/&gt;
from source as s1&lt;br/&gt;
join source as s2&lt;br/&gt;
on 1 = 1;&lt;/p&gt;

&lt;p&gt;ERROR XJ001: Java exception: &apos;: java.lang.NullPointerException&apos;.&lt;br/&gt;
ij&amp;gt;&lt;/p&gt;



&lt;p&gt;derby.log:&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
2006-03-07 20:01:12.152 GMT:&lt;br/&gt;
Booting Derby version The Apache Software Foundation - Apache Derby - 10.1.2.1 - (330608): instance c013800d-0109-d64c-5067-000000172958&lt;br/&gt;
on database directory D:\Documents and Settings&amp;#42;**\My Documents\test&lt;/p&gt;

&lt;p&gt;Database Class Loader started - derby.database.classpath=&apos;&apos;&lt;br/&gt;
2006-03-07 20:01:52.671 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 124), (SESSIONID = 0), (DATABASE = test), (DRDAID = null), Cleanup action starting&lt;br/&gt;
2006-03-07 20:01:52.671 GMT Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 124), (SESSIONID = 0), (DATABASE = test), (DRDAID = null), Failed Statement is: insert into dest (source_id_1, source_id_2)&lt;br/&gt;
select s1.source_id, s2.source_id&lt;br/&gt;
from source as s1&lt;br/&gt;
join source as s2&lt;br/&gt;
on 1 = 1&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
at org.apache.derby.impl.sql.compile.ResultColumnList.remapColumnReferencesToExpressions(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.compile.JoinNode.flatten(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.compile.FromList.flattenFromTables(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.compile.SelectNode.preprocess(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.compile.SingleChildResultSetNode.preprocess(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.compile.DMLStatementNode.optimize(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.compile.DMLModStatementNode.optimize(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.GenericStatement.prepMinion(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.GenericStatement.prepare(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.tools.ij.ij.executeImmediate(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.tools.ij.utilMain.doCatch(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.tools.ij.utilMain.go(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.tools.ij.Main.go(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.tools.ij.Main.mainCore(Unknown Source)&lt;br/&gt;
at org.apache.derby.impl.tools.ij.Main14.main(Unknown Source)&lt;br/&gt;
at org.apache.derby.tools.ij.main(Unknown Source)&lt;br/&gt;
Cleanup action completed&lt;/p&gt;

&lt;p&gt;2006-03-07 20:43:03.759 GMT:&lt;br/&gt;
Shutting down instance c013800d-0109-d64c-5067-000000172958&lt;br/&gt;
----------------------------------------------------------------&lt;/p&gt;</description>
                <environment>WinXP</environment>
        <key id="12329992">DERBY-1089</key>
            <summary>Derby fails inserting a join into a table with a generated column</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="heartburn">Mark Boylan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Mar 2006 02:39:54 +0000</created>
                <updated>Thu, 13 Dec 2007 09:04:50 +0000</updated>
                            <resolved>Thu, 23 Nov 2006 20:45:13 +0000</resolved>
                                    <version>10.1.2.1</version>
                                    <fixVersion>10.2.2.0</fixVersion>
                    <fixVersion>10.3.1.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12369957" author="crimson" created="Sat, 11 Mar 2006 11:47:45 +0000"  >&lt;p&gt;I think I ran into the same issue today, and when I searched and found this entry, your explanation of the problem helped me come up with a work-around, at least for my situation.&lt;/p&gt;

&lt;p&gt;If you can split your insert into two stages, first writing the joined data to a temporary table (which doesn&apos;t have a generated column), and then copying it out to the destination, that may work. Not an ideal solution by any means, but at least it gets past the roadblock.&lt;/p&gt;

&lt;p&gt;Thanks, Mark, for isolating the conditions so well! I hope that will allow someone to track down the problem.&lt;/p&gt;</comment>
                            <comment id="12378029" author="thod" created="Fri, 5 May 2006 21:33:46 +0100"  >&lt;p&gt;I also came across this problem today. A related but slightly easier way to get round it, certainly for my case, was to go for something like:&lt;/p&gt;

&lt;p&gt;insert into table (a, b, c)&lt;br/&gt;
select * from (&lt;br/&gt;
select d, e, calced_f from somewhere&lt;br/&gt;
) X&lt;/p&gt;

&lt;p&gt;ie to wrap the SQL generating the data with &quot;select * from (...) x&quot;. This seems to avoid the bug and also avoids having to create and then drop another table. &lt;/p&gt;

&lt;p&gt;Thank you both for helping me identify and get round this!&lt;/p&gt;</comment>
                            <comment id="12449216" author="bryanpendleton" created="Mon, 13 Nov 2006 01:05:04 +0000"  >&lt;p&gt;Attached is remapSkipNullExpressions_v1.diff, a proposed patch&lt;br/&gt;
for this problem. When an INSERT ... SELECT statement inserts&lt;br/&gt;
a GENERATED ALWAYS identity column, the identity column&apos;s&lt;br/&gt;
column reference is NULL, since that column does not have a&lt;br/&gt;
corresponding column in the SELECT list. This NULL expression needs&lt;br/&gt;
to be skipped over when remapping column references from the&lt;br/&gt;
SELECT column list to the INSERT column list.&lt;/p&gt;

&lt;p&gt;The patch includes a test. derbyall and suites.All were successful.&lt;/p&gt;

&lt;p&gt;Please have a look and give me any feedback. Thanks!&lt;/p&gt;</comment>
                            <comment id="12449568" author="bryanpendleton" created="Tue, 14 Nov 2006 05:21:34 +0000"  >&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2015&quot; title=&quot;NullPointerException in INSERT ... SELECT with self-joined table and IDENTITY column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2015&quot;&gt;&lt;del&gt;DERBY-2015&lt;/del&gt;&lt;/a&gt; is a duplicate of this issue.&lt;/p&gt;</comment>
                            <comment id="12450033" author="kristwaa" created="Wed, 15 Nov 2006 14:02:26 +0000"  >&lt;p&gt;I tried this patch on 10.1, 10.2 and 10.3. With the exception of offsets in the 10.1 branch, everything applied cleanly and I was able to build Derby.&lt;/p&gt;

&lt;p&gt;Test results (all with Java SE 5):&lt;br/&gt;
 10.3 (475016M): No failures.&lt;br/&gt;
 10.2: derbyall OK, many failures due to permissions for suites.All.&lt;br/&gt;
 10.1:  derbynet/dataSourcePermissions_net.java, derbynet/testSecMec.java and unit/T_Diagnosticable.unit failed (probably unrelated, have not investigated).&lt;/p&gt;

&lt;p&gt;Patch looks good, but my knowledge of the area of the code is very limited. Another opinion would be good.&lt;/p&gt;

&lt;p&gt;A little nit: There&apos;s a mix of tabs and spaces on two of the lines added by the patch (after the if).&lt;/p&gt;

&lt;p&gt;Taken that this patch is a small change to the code, should we merge it to the earlier branches?&lt;/p&gt;</comment>
                            <comment id="12450075" author="bryanpendleton" created="Wed, 15 Nov 2006 15:45:28 +0000"  >&lt;p&gt;Thanks Kristian for the review and the testing, it is very helpful. I will fix the tab/space issue prior to committing the change.&lt;/p&gt;

&lt;p&gt;Your suggestion about merging the fix to prior branches is good; I&apos;ll at least merge it to 10.2 for sure.&lt;/p&gt;

&lt;p&gt;I&apos;ll wait a bit longer to see if there are other comments on the patch. If not, I&apos;ll submit it later this week.&lt;/p&gt;</comment>
                            <comment id="12450452" author="chdh@inventec.ch" created="Thu, 16 Nov 2006 16:40:03 +0000"  >&lt;p&gt;Bryan, there are more places in ResultColumnList.java where&lt;br/&gt;
  x.getExpression().y()&lt;br/&gt;
is called without testing whether x.getExpression() is null.&lt;/p&gt;

&lt;p&gt;These places are at the following lines in ResultColumnList.java:&lt;br/&gt;
 1616  sourceRC.getExpression().setType(resultColumn.getTypeServices());&lt;br/&gt;
 1875: resultColumn.getExpression().getClass().getName());&lt;br/&gt;
 1879  ((VirtualColumnNode) resultColumn.getExpression()).columnId += adjust;&lt;br/&gt;
 2848  if (! rc.getExpression().isCloneable())&lt;br/&gt;
 2871  rc.setExpression(rc.getExpression().remapColumnReferencesToExpressions());&lt;br/&gt;
     (this is fixed by your patch)&lt;/p&gt;

&lt;p&gt;Maybe it would be reasonable to fix these too?&lt;/p&gt;</comment>
                            <comment id="12450570" author="bryanpendleton" created="Thu, 16 Nov 2006 23:23:57 +0000"  >&lt;p&gt;Thanks Christian! I will investigate these usages.&lt;/p&gt;</comment>
                            <comment id="12451805" author="bryanpendleton" created="Tue, 21 Nov 2006 22:56:45 +0000"  >&lt;p&gt;Hi Christian,&lt;/p&gt;

&lt;p&gt;I spent some time studying the code that you identified, and I set up various experiments to learn how those various lines of code get executed. In all the cases that I could construct, there was no way that I could see to arrive at these lines with a column which is GENERATED ALWAYS. &lt;/p&gt;

&lt;p&gt;I agree with you that the unguarded reference to rc.getExpression() is a concern since we know that in some cases (namely GENERATED ALWAYS columns) it can be null.&lt;/p&gt;

&lt;p&gt;However, without a way to actually cause the execution path to reach one of these lines of code with a NULL ResultColumn.expression, I am reluctant to change them.&lt;/p&gt;

&lt;p&gt;My preference for now is to leave those lines as they are.&lt;/p&gt;</comment>
                            <comment id="12452293" author="bryanpendleton" created="Thu, 23 Nov 2006 17:30:42 +0000"  >&lt;p&gt;Committed remapSkipNullExpressions_v1.diff to the trunk as revision 478622.&lt;/p&gt;

&lt;p&gt;I intend to merge this change to 10.2 and commit it there as well.&lt;/p&gt;

&lt;p&gt;I also intend to mark &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2015&quot; title=&quot;NullPointerException in INSERT ... SELECT with self-joined table and IDENTITY column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2015&quot;&gt;&lt;del&gt;DERBY-2015&lt;/del&gt;&lt;/a&gt; as a duplicate of this issue.&lt;/p&gt;</comment>
                            <comment id="12452325" author="bryanpendleton" created="Thu, 23 Nov 2006 20:45:13 +0000"  >&lt;p&gt;Merged the trunk patch to the 10.2 branch as revision 478658.&lt;/p&gt;

&lt;p&gt;Marked the issue resolved and cleared Patch Available.&lt;/p&gt;</comment>
                            <comment id="12551322" author="fuzzylogic" created="Thu, 13 Dec 2007 09:04:50 +0000"  >&lt;p&gt;This issue has been resolved for over a year with no further movement. Closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12354214">DERBY-2015</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12344842" name="remapSkipNullExpressions_v1.diff" size="3884" author="bryanpendleton" created="Mon, 13 Nov 2006 01:05:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 11 Mar 2006 11:47:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22300</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy10cf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39706</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>