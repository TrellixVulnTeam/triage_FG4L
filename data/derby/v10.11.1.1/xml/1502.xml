<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:09:09 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-1502/DERBY-1502.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-1502] Non-deterministic behavior of lang/grantRevokeDDL.sql</title>
                <link>https://issues.apache.org/jira/browse/DERBY-1502</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Sometimes I see the following failure in lang/grantRevokeDDL.sql. I have seen this on linux under jdk 1.4 and 1.5.&lt;/p&gt;

&lt;p&gt;560 del&lt;br/&gt;
&amp;lt; ERROR 28508: User &apos;MAMTA3&apos; does not have select permission on column &apos;C111&apos; of table &apos;MAMTA2&apos;.&apos;V22&apos;.&lt;br/&gt;
560a560&lt;br/&gt;
&amp;gt; ERROR 28508: User &apos;MAMTA3&apos; does not have select permission on column &apos;C111&apos; of table &apos;MAMTA2&apos;.&apos;V21&apos;.&lt;br/&gt;
Test Failed.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;End:   grantRevokeDDL jdk1.4.2_08 2006-07-11 13:38:51 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It would appear that when two permissions are inadequate, it&apos;s not clear which one will fail the statement.&lt;/p&gt;</description>
                <environment>linux, jdk1.4 and jdk 1.5</environment>
        <key id="12345805">DERBY-1502</key>
            <summary>Non-deterministic behavior of lang/grantRevokeDDL.sql</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mamtas">Mamta A. Satoor</assignee>
                                    <reporter username="rhillegas">Rick Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Jul 2006 04:51:01 +0100</created>
                <updated>Mon, 29 Jun 2009 23:57:53 +0100</updated>
                            <resolved>Wed, 12 Jul 2006 15:42:41 +0100</resolved>
                                    <version>10.2.1.6</version>
                                    <fixVersion>10.2.1.6</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12420437" author="mamtas" created="Wed, 12 Jul 2006 05:06:21 +0100"  >&lt;p&gt;There was some discussion on this diff in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1330&quot; title=&quot;Provide runtime privilege checking for grant/revoke functionality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1330&quot;&gt;&lt;del&gt;DERBY-1330&lt;/del&gt;&lt;/a&gt; and on the derby list. I am copying them in chronological order here to track the discussion&lt;/p&gt;

&lt;p&gt;&amp;lt;start comment from Knut Anders Hatlen&amp;gt;&lt;br/&gt;
I have seen this regression test failure a couple of times lately. Could it be related to this issue? &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;
			&lt;ul&gt;
				&lt;li&gt;
				&lt;ul&gt;
					&lt;li&gt;
					&lt;ul&gt;
						&lt;li&gt;
						&lt;ul&gt;
							&lt;li&gt;
							&lt;ul&gt;
								&lt;li&gt;
								&lt;ul&gt;
									&lt;li&gt;Diff file derbyall/derbylang/grantRevokeDDL.diff&lt;/li&gt;
								&lt;/ul&gt;
								&lt;/li&gt;
							&lt;/ul&gt;
							&lt;/li&gt;
						&lt;/ul&gt;
						&lt;/li&gt;
					&lt;/ul&gt;
					&lt;/li&gt;
				&lt;/ul&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;Start: grantRevokeDDL jdk1.5.0_04 derbyall:derbylang 2006-07-10 09:56:26 ***&lt;br/&gt;
560 del &lt;br/&gt;
&amp;lt; ERROR 28508: User &apos;MAMTA3&apos; does not have select permission on column &apos;C111&apos; of table &apos;MAMTA2&apos;.&apos;V22&apos;. &lt;br/&gt;
560a560 &lt;br/&gt;
&amp;gt; ERROR 28508: User &apos;MAMTA3&apos; does not have select permission on column &apos;C111&apos; of table &apos;MAMTA2&apos;.&apos;V21&apos;. &lt;br/&gt;
Test Failed. &lt;/li&gt;
			&lt;li&gt;End: grantRevokeDDL jdk1.5.0_04 derbyall:derbylang 2006-07-10 09:56:37 ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It seems to happen on both Solaris and Linux, JVM 1.4 and 1.5: &lt;br/&gt;
&lt;a href=&quot;http://www.multinet.no/~solberg/public/Apache/Derby/testlog/Linux-2.6.9-34.ELsmp_x86_64-x86_64/420328-derbylang_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.multinet.no/~solberg/public/Apache/Derby/testlog/Linux-2.6.9-34.ELsmp_x86_64-x86_64/420328-derbylang_diff.txt&lt;/a&gt; &lt;br/&gt;
&lt;a href=&quot;http://www.multinet.no/~solberg/public/Apache/Derby/testlog/SunOS-5.10_i86pc-i386/420328-derbylang_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.multinet.no/~solberg/public/Apache/Derby/testlog/SunOS-5.10_i86pc-i386/420328-derbylang_diff.txt&lt;/a&gt; &lt;br/&gt;
&lt;a href=&quot;http://www.multinet.no/~solberg/public/Apache/DerbyJvm1.4/testlog/Linux-2.6.9-34.ELsmp_x86_64-x86_64/420328-derbyall_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.multinet.no/~solberg/public/Apache/DerbyJvm1.4/testlog/Linux-2.6.9-34.ELsmp_x86_64-x86_64/420328-derbyall_diff.txt&lt;/a&gt; &lt;br/&gt;
&lt;a href=&quot;http://www.multinet.no/~solberg/public/Apache/DerbyJvm1.4/testlog/SunOS-5.10_i86pc-i386/420328-derbyall_diff.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.multinet.no/~solberg/public/Apache/DerbyJvm1.4/testlog/SunOS-5.10_i86pc-i386/420328-derbyall_diff.txt&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;It does not happen on the tinderbox, though. &lt;br/&gt;
&amp;lt;end comment from Knut Anders Hatlen&amp;gt;&lt;/p&gt;



&lt;p&gt;&amp;lt;start comment from Mamta Satoor&amp;gt;&lt;br/&gt;
Knut, the diffs you are noticing is in one of the new tests that I added to grantRevokeDDL.sql &lt;/p&gt;

&lt;p&gt;The diff is for following sql which is executed by mamta3(Note that mamta3 does not have SELECT privilege on mamta2.v22.c111 and on mamta2.v21.c111 but does have SELECT privilege on mamta1.t11) &lt;/p&gt;

&lt;p&gt;create view v33 as select v22.c111 as a, t11.c111 as b from mamta2.v22 v22, mamta1.t11 t11, mamta2.v21; &lt;/p&gt;

&lt;p&gt;When this create view is compiled by Derby, it collects the privileges required by the create view. Derby collects following privilege requirements for the create view sql above &lt;br/&gt;
1)SELECT on mamta2.v22 &lt;br/&gt;
2)SELECT on mamta1.t11 &lt;br/&gt;
3)SELECT on mamta2.v21 &lt;br/&gt;
4)ownership of the schema in which create view is being issued &lt;/p&gt;

&lt;p&gt;Later on, at create view execution time, Derby grows through the required privileges list and checks if mamta3 has the required privileges or not. And since mamta3 does not have the required privileges on mamta2.v22 and mamta2.v21, the create view fails. &lt;/p&gt;

&lt;p&gt;In the diff that you posted above, both the error messages are correct. It seems like &lt;br/&gt;
1)either the order in which the privilege requirements get added to the list in compile phase is not always the same &lt;br/&gt;
2)or the order in which privileges get retrieved in the execution phase is not always the same &lt;br/&gt;
and hence different error messages &lt;/p&gt;

&lt;p&gt;CompilerContextimpl.addRequiredTablePriv() has following &lt;br/&gt;
requiredTablePrivileges.put(key, key); &lt;br/&gt;
and requiredTablePrivileges is defined as follows in CompilerContextimpl &lt;br/&gt;
private HashMap requiredTablePrivileges; &lt;/p&gt;

&lt;p&gt;Is this a Java behavior that you can count on the order in which items will be added and retrieved from HashMap? &lt;/p&gt;

&lt;p&gt;At this point, I am not sure, how to make sure that items get added and retrieved in the same order from the HashMap so that we will have consistent error message return from the create view sql above. Any insight from the list will be appreciated. &lt;br/&gt;
&amp;lt;end comment from Mamta Satoor&amp;gt;&lt;/p&gt;




&lt;p&gt;&amp;lt;start comment from Mamta Satoor&amp;gt;&lt;br/&gt;
Mike responded following on the mailing list &lt;br/&gt;
&amp;lt;quote&amp;gt; &lt;br/&gt;
I do not believe you can count on the order of a HashMap, different &lt;br/&gt;
JVM&apos;s may use different hash algo&apos;s which may result in different orders &lt;br/&gt;
when you ask for the full list. I have seen this behavior in queries &lt;br/&gt;
which use hash nodes in derby (I believe we first noticed a difference &lt;br/&gt;
between j9 and other jvm&apos;s). In that case we added order by&apos;s as &lt;br/&gt;
necessary to the tests, as either order of results was correct from &lt;br/&gt;
SQL point of view. &lt;/p&gt;

&lt;p&gt;In your case is the order a code problem, or just a testing issue? &lt;br/&gt;
&amp;lt;/quote&amp;gt; &lt;/p&gt;

&lt;p&gt;First of all, thanks Mike for your response. &lt;/p&gt;

&lt;p&gt;As to your question, the order is not a testing issue because test is simply trying a scenario where a user is trying to create a object based on more than one object on which the user doesn&apos;t have access to. And depending on how items got into HashMap, the test fails with privilege error on one object vs the other. So, in this case, the order is a code problem. &lt;br/&gt;
&amp;lt;end comment from Mamta Satoor&amp;gt;&lt;/p&gt;



&lt;p&gt;&amp;lt;start comment from Mike Matrigali&amp;gt;&lt;br/&gt;
If the order of the error is not documented, then I am not sure it is a&lt;br/&gt;
code error.  Sort of similar to the fact that on different jvm&apos;s derby&lt;br/&gt;
will return rows in different orders for the same db, same query (unless&lt;br/&gt;
a specific order by is used).&lt;br/&gt;
I would define it as a test problem, as the test assumes a specific&lt;br/&gt;
error where either of 2 errors is valid.&lt;/p&gt;

&lt;p&gt;The code could use some sorting mechanism to guarantee an ordering, but&lt;br/&gt;
it would have to be careful about the key (object id&apos;s could also vary&lt;br/&gt;
from machine to machine, or time to time).  Doing so would likely mean&lt;br/&gt;
more memory and more code, doesn&apos;t seem worth it to me for this case -&lt;br/&gt;
anyone think so?&lt;br/&gt;
&amp;lt;end comment from Mike Matrigali&amp;gt;&lt;/p&gt;


&lt;p&gt;&amp;lt;start comment from Knut Anders Hatlen&amp;gt;&lt;br/&gt;
I agree. Since the SQL state is equal in the two cases, I think a sed&lt;br/&gt;
script that strips everything but the message would be OK. Something&lt;br/&gt;
like this in grantRevokeDDL_sed.properties:&lt;/p&gt;

&lt;p&gt;substitute=^ERROR (&lt;span class=&quot;error&quot;&gt;&amp;#91;^:&amp;#93;&lt;/span&gt;&lt;b&gt;):.&lt;/b&gt;$;ERROR: Failed with SQLSTATE $1&lt;/p&gt;


&lt;p&gt;&amp;gt; The code could use some sorting mechanism to guarantee an ordering, but&lt;br/&gt;
&amp;gt; it would have to be careful about the key (object id&apos;s could also vary&lt;br/&gt;
&amp;gt; from machine to machine, or time to time).  Doing so would likely mean&lt;br/&gt;
&amp;gt; more memory and more code, doesn&apos;t seem worth it to me for this case -&lt;br/&gt;
&amp;gt; anyone think so?&lt;/p&gt;


&lt;p&gt;Perhaps a LinkedHashMap would do the trick, but I agree, I don&apos;t think&lt;br/&gt;
it&apos;s worth it.&lt;br/&gt;
&amp;lt;end comment from Knut Anders Hatlen&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="12420442" author="mamtas" created="Wed, 12 Jul 2006 05:23:05 +0100"  >&lt;p&gt;Based on Knut&apos;s suggestion, I have created a sed file to remove the error messages from the test. This will mask the privilege ordering in the HashMap object. If the attached patch looks good, can someone please commit it?&lt;/p&gt;

&lt;p&gt;svn stat -q&lt;br/&gt;
A      java\testing\org\apache\derbyTesting\functionTests\tests\lang\grantRevokeDDL_sed.properties&lt;br/&gt;
M      java\testing\org\apache\derbyTesting\functionTests\master\grantRevokeDDL.out&lt;/p&gt;</comment>
                            <comment id="12420536" author="knutanders" created="Wed, 12 Jul 2006 15:42:41 +0100"  >&lt;p&gt;Thanks Mamta! Committed revision 421179.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12336688" name="Derby1330TestErrorMessageSedDiff.txt" size="30045" author="mamtas" created="Wed, 12 Jul 2006 05:23:05 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10369"><![CDATA[Regression Test Failure]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 12 Jul 2006 04:06:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>22543</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0vsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38969</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>