<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 03:27:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/DERBY-5010/DERBY-5010.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[DERBY-5010] [patch] bad equivalence check</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5010</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;code attempts to compare two BaseColumnNodes but doesn&apos;t compare the tableName correctly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12497948">DERBY-5010</key>
            <summary>[patch] bad equivalence check</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dbrosius@apache.org">Dave Brosius</assignee>
                                    <reporter username="dbrosius@apache.org">Dave Brosius</reporter>
                        <labels>
                            <label>derby_backport_reject_10_8</label>
                    </labels>
                <created>Tue, 8 Feb 2011 05:06:53 +0000</created>
                <updated>Mon, 17 Jun 2013 10:19:30 +0100</updated>
                            <resolved>Tue, 5 Jul 2011 12:57:34 +0100</resolved>
                                    <version>10.7.1.1</version>
                                    <fixVersion>10.9.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="12991950" author="knutanders" created="Tue, 8 Feb 2011 12:17:27 +0000"  >&lt;p&gt;The current code looks wrong and the suggested fix looks right.&lt;/p&gt;

&lt;p&gt;None of our regression tests seem to exercise this code path, though. It would be good if someone could come up with a statement that caused this code to be executed so that we can verify that it behaves as expected after the proposed changes.&lt;/p&gt;</comment>
                            <comment id="13021634" author="kmarsden" created="Tue, 19 Apr 2011 17:07:16 +0100"  >&lt;p&gt;There was some discussion on the list about tracking down the statement that goes through BaseColumnNode.isEquivalient() , by adding a thread dump in the method.  I wanted to suggest an alternate method that might make things easier to track down.  I may be missing the mark as I have not been folllowing the thread on the list carefully.&lt;/p&gt;

&lt;p&gt;I think if you set the system property derby.language.logStatementText=true with -Dderby.language.logStatementText=true and then in the method call org.apache.derby.iapi.services.monitor.Monitor.getMonitor().logThrowable(new Exception(&quot;Trace in isEquivalent&quot;)&lt;br/&gt;
you should get the stack trace right after the statement that goes there in derby.log&lt;/p&gt;

</comment>
                            <comment id="13021931" author="rsjay1976" created="Wed, 20 Apr 2011 04:09:01 +0100"  >&lt;p&gt;The getmonitor() method returns a modulefactory interface which doesnt have a logThrowable method in it.. &lt;/p&gt;</comment>
                            <comment id="13047891" author="rsjay1976" created="Sat, 11 Jun 2011 13:14:17 +0100"  >&lt;p&gt;Modified the BasecolumnNode class&apos;s IsEquivalent method to add the monitor method... But still when executing test.lang.__Suite, the log doesn&apos;t show any trace of the newly  added trace , i am attaching the patch and the __Suite  output&lt;/p&gt;</comment>
                            <comment id="13047913" author="bryanpendleton" created="Sat, 11 Jun 2011 15:36:09 +0100"  >&lt;p&gt;Perhaps the code is simply never run, or perhaps the traces are getting swallowed&lt;br/&gt;
up. The tests sometimes redirect the output, so it can be hard to figure out where the&lt;br/&gt;
traces might go.&lt;/p&gt;

&lt;p&gt;Change the method to perform System.exit(1);&lt;/p&gt;

&lt;p&gt;Then see if any of the tests in the test suite fail.&lt;/p&gt;</comment>
                            <comment id="13049591" author="rsjay1976" created="Wed, 15 Jun 2011 04:29:57 +0100"  >&lt;p&gt;After adding the system.exit(1) to the BaseColumnNode.IsEquivalent method  and the running  java -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.lang._Suite &amp;gt; runoutputJune14.out 2&amp;gt;&amp;amp;1&lt;br/&gt;
is causing the log  output to stop at the &quot;aggregate&quot; test. &lt;br/&gt;
Attaching the output log and the diff for reference.&lt;/p&gt;</comment>
                            <comment id="13049601" author="bryanpendleton" created="Wed, 15 Jun 2011 05:17:10 +0100"  >&lt;p&gt;If it&apos;s definitely the &apos;aggregate&apos; test which is touching the code, then you should be able&lt;br/&gt;
to confirm this by doing something like:&lt;/p&gt;

&lt;p&gt;  java org.apache.derbyTesting.functionTests.harness.RunTest lang/aggregate.sql&lt;/p&gt;

&lt;p&gt;with and without your &quot;System.exit(1)&quot;, and see the test pass without your change, and&lt;br/&gt;
exit early with your change.&lt;/p&gt;</comment>
                            <comment id="13049712" author="knutanders" created="Wed, 15 Jun 2011 11:54:54 +0100"  >&lt;p&gt;Alternatively, since the test will probably fail with some spurious diffs when run in the old test harness now even when it&apos;s unmodified, aggregate.sql can be run as a standalone JUnit test by invoking this command:&lt;/p&gt;

&lt;p&gt;  java org.apache.derbyTesting.functionTests.tests.lang.LangScripts aggregate&lt;/p&gt;

&lt;p&gt;Thanks for continuing the digging, Jayaram!&lt;/p&gt;</comment>
                            <comment id="13050205" author="rsjay1976" created="Thu, 16 Jun 2011 04:50:52 +0100"  >&lt;p&gt;Modified the the basecolumnNode class isequivalent method to do a Thread.dumpStack(); and then ran the aggregate test alone by doing &lt;br/&gt;
$  java org.apache.derbyTesting.functionTests.tests.lang.LangScripts aggregate&lt;br/&gt;
&amp;gt;june15.out 2&amp;gt;&amp;amp;1&lt;/p&gt;

&lt;p&gt;Verified that executing aggregate resulted in the dump getting  produced . But the dump didnt indicate the sql statement which resulted in calling the isquivalent method.. Attaching the june15.out file for reference&lt;/p&gt;</comment>
                            <comment id="13050437" author="bryanpendleton" created="Thu, 16 Jun 2011 15:13:41 +0100"  >&lt;p&gt;Now that you know that the aggregate test exercises this code, can you try Kathey&apos;s suggestion from&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5010?focusedCommentId=13021634&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13021634&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-5010?focusedCommentId=13021634&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13021634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;to see if you can further isolate the particular statement that is being executed?&lt;/p&gt;</comment>
                            <comment id="13051723" author="rsjay1976" created="Sun, 19 Jun 2011 20:35:31 +0100"  >&lt;p&gt;As mentioned added the Monitor.getMonitor().logThrowable(new Exception(&quot;Trace in isEquivalent&quot;)  and then executed  java org.apache.derbyTesting.functionTests.tests.lang.LangScripts aggregate &amp;gt;&amp;gt; June19.out .. &lt;/p&gt;


&lt;p&gt;in the derby log file got &lt;br/&gt;
Sun Jun 19 14:08:06 CDT 2011 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 624), (SESSIONID = 3), (DATABASE = wombat), (DRDAID = null), Failed Statement is: null&lt;/p&gt;

&lt;p&gt;the failed statement is coming as null..   Attaching the log file for reference...  The log file shows the &quot;isequivalent&quot; method being invoked but the statement could not be traced out..&lt;/p&gt;</comment>
                            <comment id="13052072" author="kmarsden" created="Mon, 20 Jun 2011 18:05:49 +0100"  >&lt;p&gt;Looking at the derby.log, it seems to me that the derby.language.logStatementText=true property is not getting picked up.&lt;br/&gt;
If you look at the top of the log, there is no statement listed before the first instance of the stack trace printing, &lt;/p&gt;

&lt;p&gt;Database Class Loader started - derby.database.classpath=&apos;&apos;&lt;br/&gt;
java.lang.Exception: Trace in isEquivalent&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.BaseColumnNode.isEquivalent(BaseColumnNode.java:183)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.SubstituteExpressionVisitor.visit(SubstituteExpressionVisitor.java:62)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.QueryTreeNode.accept(QueryTreeNode.java:718)&lt;br/&gt;
	at org.apache.derby.impl.sql.compile.ResultColumn.acceptChildren(ResultColumn.java:1550)&lt;/p&gt;

&lt;p&gt;In your previous comment, you mentioned you ran it as:&lt;br/&gt;
java org.apache.derbyTesting.functionTests.tests.lang.LangScripts aggregate&lt;/p&gt;

&lt;p&gt;try &lt;br/&gt;
java -Dderby.language.logStatementText=true  org.apache.derbyTesting.functionTests.tests.lang.LangScripts aggregate&lt;/p&gt;


&lt;p&gt;If that still doesn&apos;t show the statement before the exception prints, try running the java/testing/org/apache/derbyTesting/functionTests/tests/lang/aggregate.sql ust with ij, outside of the harness, making sure you start ij with the property&lt;/p&gt;

&lt;p&gt;java -Dderby.language.logStatementText=true org.apache.derby.tools.ij&lt;/p&gt;


</comment>
                            <comment id="13053290" author="rsjay1976" created="Wed, 22 Jun 2011 15:49:59 +0100"  >&lt;p&gt;As suggested ran the aggregate test with logstatementtext=true option and was able to get the sql statement causing the isequivalent method to be called&lt;/p&gt;

&lt;p&gt;select c1 from t1&lt;br/&gt;
group by c1&lt;br/&gt;
having (max(c2) in (select c1 from t2)) OR&lt;br/&gt;
		(max(c1) in (select c2-999 from t2)) OR&lt;br/&gt;
		(count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &amp;gt; 0)&lt;/p&gt;
</comment>
                            <comment id="13053503" author="kmarsden" created="Wed, 22 Jun 2011 23:25:30 +0100"  >&lt;p&gt;Thank you Jayaram for tracking this down!&lt;br/&gt;
Can you post the full stack trace from isEquivalent when this statement is executed?&lt;/p&gt;

&lt;p&gt;Now that we know how to get into isEquivalent(), the next step will be to try to find a variation of this statement that fails without Dave&apos;s patch and passes with it.  First, to get yourself setup to debug the situation, I would suggest you break out an SQL script with just the first part of aggregate.sql to setup these two tables call it create.sql or some such. Then you can use that to create a database with ij and then you can just connect with ij to the database and run this one sql statement and variations to understand what is happening in isEquivalent, either by printing the values for tableName and other.tableName or using the debugger.&lt;/p&gt;




</comment>
                            <comment id="13054811" author="rsjay1976" created="Sat, 25 Jun 2011 04:19:17 +0100"  >&lt;p&gt;adding the full stack trace of isequivalent when the statement got executed&lt;/p&gt;</comment>
                            <comment id="13054812" author="rsjay1976" created="Sat, 25 Jun 2011 04:58:00 +0100"  >&lt;p&gt;When executing the sql statement  select c1 from t1 group by c1 having (max(c2) in (select c1 from t2)) OR (max(c1) in (select c2-999 from t2)) OR (count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &amp;gt; 0); in ij observed the following&lt;/p&gt;

&lt;p&gt;1) the control goes to isequivalent method but if (isSameNodeType(o)) is returning false making the flow not to go in to the modified section of code&lt;br/&gt;
2) the reason why if (isSameNodeType(o)) is returning false is &lt;br/&gt;
      2.1) in valuenode class nodetype has a value 62&lt;br/&gt;
      2.2) in querytreenode class nodetype has a value 94&lt;/p&gt;

&lt;p&gt;I am not able to infer what these values mean or how they got assigned... but if we are able to get to make them equal then  control would go to the modified section of code...&lt;/p&gt;</comment>
                            <comment id="13055592" author="knutanders" created="Mon, 27 Jun 2011 16:04:48 +0100"  >&lt;p&gt;Hi Jayaram,&lt;/p&gt;

&lt;p&gt;I think these constants come from C_NodeTypes:&lt;/p&gt;

&lt;p&gt;&amp;gt;    static final int COLUMN_REFERENCE = 62;&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;&amp;gt;    static final int BASE_COLUMN_NODE = 94;&lt;/p&gt;

&lt;p&gt;So it looks like we&apos;re calling isEquivalent() to check whether a ColumnReference instance is equivalent to a BaseColumnNode in this query.&lt;/p&gt;

&lt;p&gt;I think the ColumnReference here is the reference to C1 in the GROUP BY clause, and to exercise the code using a variant of this query, we&apos;d have to get the GROUP BY clause to contain a BaseColumnNode somehow. I&apos;m afraid I don&apos;t have any good ideas on how to do that (I&apos;m not even sure if it&apos;s possible).&lt;/p&gt;</comment>
                            <comment id="13059667" author="rsjay1976" created="Tue, 5 Jul 2011 04:07:11 +0100"  >&lt;p&gt;Hi Knut,&lt;br/&gt;
I tried all the following variations but nothing seem to break the basecolumn to columnreference comparison.. So shall i jump on to the next task&lt;br/&gt;
select c1 from t1 group by c1 having (max(c2) in (select c1 from t2)) OR (max(c1) in (select c2-999 from t2)) OR (count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &amp;gt; 0);&lt;br/&gt;
select c1 from t1 group by c1 having (max(c1) in (select c1 from t2)) OR (max(c1) in (select c2-999 from t2)) OR (count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &amp;gt; 0);&lt;br/&gt;
select c1 from t1 group by c1 having (max(c1) in (select c1 from t2)) OR (max(c1) in (select c1-999 from t2)) OR (count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &amp;gt; 0);&lt;br/&gt;
select c1,count(c1) from t1 group by c1 having (max(c1) in (select c1 from t2)) OR (max(c1) in (select c1-999 from t2)) OR (count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &amp;gt; 0);&lt;/p&gt;</comment>
                            <comment id="13059849" author="knutanders" created="Tue, 5 Jul 2011 12:57:34 +0100"  >&lt;p&gt;Thanks for the continued investigation, Jayaram.&lt;/p&gt;

&lt;p&gt;The more I look at this code, the more convinced I get that the broken code cannot currently be exercised, and your experiments seem to support that.&lt;/p&gt;

&lt;p&gt;In any case, the patch looks correct, so I&apos;ve committed it to trunk (revision 1143002). Thanks, Dave, for the fix.&lt;/p&gt;</comment>
                            <comment id="13094760" author="kmarsden" created="Wed, 31 Aug 2011 19:31:34 +0100"  >&lt;p&gt;It seems the code may not be reachable so no need to backport.&lt;/p&gt;</comment>
                            <comment id="13685261" author="knutanders" created="Mon, 17 Jun 2013 10:19:30 +0100"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bulk update&amp;#93;&lt;/span&gt; Close all resolved issues that haven&apos;t been updated for more than one year.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12482144" name="IsEquivalent_DoNotCommit_June11.txt" size="969" author="rsjay1976" created="Sat, 11 Jun 2011 13:16:37 +0100"/>
                            <attachment id="12482636" name="IsEquivalent_Donotcommit_june14.txt" size="990" author="rsjay1976" created="Wed, 15 Jun 2011 04:26:41 +0100"/>
                            <attachment id="12470551" name="bad_equivalence_check.diff" size="578" author="dbrosius@apache.org" created="Tue, 8 Feb 2011 05:52:43 +0000"/>
                            <attachment id="12483804" name="derby.log" size="284211" author="rsjay1976" created="Sat, 25 Jun 2011 04:19:53 +0100"/>
                            <attachment id="12483100" name="derby.log" size="79592" author="rsjay1976" created="Sun, 19 Jun 2011 20:36:11 +0100"/>
                            <attachment id="12482747" name="june15.out" size="42106" author="rsjay1976" created="Thu, 16 Jun 2011 04:45:12 +0100"/>
                            <attachment id="12482635" name="runoutputJune14.out" size="11338" author="rsjay1976" created="Wed, 15 Jun 2011 04:26:41 +0100"/>
                            <attachment id="12482145" name="runoutputJune2.out" size="98635" author="rsjay1976" created="Sat, 11 Jun 2011 13:16:37 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 Feb 2011 12:17:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24592</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy0fdz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>36311</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>