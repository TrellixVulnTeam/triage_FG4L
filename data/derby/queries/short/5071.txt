[patch] use string buffers when building strings in loops