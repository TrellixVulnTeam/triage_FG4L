<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-700/BOOKKEEPER-700.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-700] GarbageCollectorThread exsiting with ArrayIndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-700</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;After completing compaction, GarbageCollectorThread will do flush any outstanding offsets. When there is no offset present, its throwing following exception and exiting.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-10-30 11:37:20,944 - ERROR - [GarbageCollectorThread:NIOServerCnxnFactory$1@49] - &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[GarbageCollectorThread,5,main] died
java.lang.ArrayIndexOutOfBoundsException: -1
	at java.util.ArrayList.get(ArrayList.java:324)
	at org.apache.bookkeeper.bookie.GarbageCollectorThread$CompactionScannerFactory.waitEntrylogFlushed(GarbageCollectorThread.java:151)
	at org.apache.bookkeeper.bookie.GarbageCollectorThread$CompactionScannerFactory.flush(GarbageCollectorThread.java:175)
	at org.apache.bookkeeper.bookie.GarbageCollectorThread.doCompactEntryLogs(GarbageCollectorThread.java:400)
	at org.apache.bookkeeper.bookie.GarbageCollectorThread.run(GarbageCollectorThread.java:309)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12676579">BOOKKEEPER-700</key>
            <summary>GarbageCollectorThread exsiting with ArrayIndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh R</assignee>
                                    <reporter username="rakeshr">Rakesh R</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Oct 2013 09:17:16 +0000</created>
                <updated>Fri, 1 Nov 2013 07:06:11 +0000</updated>
                            <resolved>Wed, 30 Oct 2013 15:28:32 +0000</resolved>
                                                    <fixVersion>4.3.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13808901" author="rakeshr" created="Wed, 30 Oct 2013 09:49:28 +0000"  >&lt;p&gt;Here to fix this, I just made simple size check. Could you please review the changes. Thanks.&lt;/p&gt;

&lt;p&gt;While seeing this issue, I just noticed one case. If a thread is a critical thread(for ex: GarbageCollectorThread) and assume any unexpected exceptions occured, it may exit without any logs and makes debugging difficult.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposal:&lt;/b&gt;&lt;br/&gt;
If we have ThreadGroup exception handler to all the threads and will define setUncaughtExceptionHandler to caught all exceptions thrown by Thread run methods.&lt;br/&gt;
IMHO, one way to address this would be to create a common &apos;BookieThread&apos; that all the threads must extend and every thread can define following properties:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;threadName,&lt;/li&gt;
	&lt;li&gt;isUnhandledExceptionFatal - if yes log as fatal error and call System.exit(errcode), otw just log with priority level error and continue running server.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Shall I raise a separate JIRA for this thought and work for the same. Whats your opinion?&lt;/p&gt;</comment>
                            <comment id="13808903" author="hadoopqa" created="Wed, 30 Oct 2013 09:50:09 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-700&quot; title=&quot;GarbageCollectorThread exsiting with ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-700&quot;&gt;&lt;del&gt;BOOKKEEPER-700&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12611014/0001-BOOKKEEPER-700.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-700.patch&lt;/a&gt; downloaded at Wed Oct 30 09:22:00 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch does not add/modify any testcase&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 882&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/521/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/521/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13808984" author="ikelly" created="Wed, 30 Oct 2013 11:26:53 +0000"  >&lt;p&gt;Hmm, I guess this happens when nothing has been deleted. Good catch. Could you add a test for this also. I checked 4.2.0 and this doesn&apos;t exist there.&lt;/p&gt;</comment>
                            <comment id="13809157" author="rakeshr" created="Wed, 30 Oct 2013 14:38:06 +0000"  >&lt;p&gt;Thanks Ivan for the reviews. Attached latest patch with tests, please have a look at it.&lt;/p&gt;</comment>
                            <comment id="13809168" author="ikelly" created="Wed, 30 Oct 2013 14:50:02 +0000"  >&lt;p&gt;new patch looks good. running tests now.&lt;/p&gt;</comment>
                            <comment id="13809196" author="hadoopqa" created="Wed, 30 Oct 2013 15:09:32 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-700&quot; title=&quot;GarbageCollectorThread exsiting with ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-700&quot;&gt;&lt;del&gt;BOOKKEEPER-700&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12611073/0002-BOOKKEEPER-700.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0002-BOOKKEEPER-700.patch&lt;/a&gt; downloaded at Wed Oct 30 14:40:59 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 883&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/525/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/525/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13809219" author="ikelly" created="Wed, 30 Oct 2013 15:28:32 +0000"  >&lt;p&gt;Committed r1537130. Good work Rakesh.&lt;/p&gt;</comment>
                            <comment id="13809263" author="hudson" created="Wed, 30 Oct 2013 16:00:20 +0000"  >&lt;p&gt;SUCCESS: Integrated in bookkeeper-trunk #424 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/424/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/424/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-700&quot; title=&quot;GarbageCollectorThread exsiting with ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-700&quot;&gt;&lt;del&gt;BOOKKEEPER-700&lt;/del&gt;&lt;/a&gt;: GarbageCollectorThread exsiting with ArrayIndexOutOfBoundsException (rakeshr via ivank) (ivank: rev 1537130)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/GarbageCollectorThread.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CompactionTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13809399" author="hustlmsp" created="Wed, 30 Oct 2013 17:47:19 +0000"  >&lt;blockquote&gt;
&lt;p&gt;IMHO, one way to address this would be to create a common &apos;BookieThread&apos; that all the threads must extend and every thread can define following properties:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;there is already a BookieThread doing this. you don&apos;t need to create a new class. But I don&apos;t think GarbageCollectorThread is critical enough to do this, as the garbage collector thread quits doesn&apos;t affect anything.&lt;/p&gt;</comment>
                            <comment id="13809904" author="rakeshr" created="Thu, 31 Oct 2013 04:30:39 +0000"  >&lt;p&gt;yeah class exists. Does it a good idea to make all the threads by extending this BookieThread and behave like:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;if its critical log as fatal and exit&lt;/li&gt;
	&lt;li&gt;otherwise simply log warn and continue running. Here we will get the advantage of seeing the failure cause.&lt;br/&gt;
I could see one disadvantage: by making this, we are restricting the extensibility of threads which are Runnable.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Will modify the BookieThread constructor as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; BookieThread (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; exitOnUnhandledException)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13809962" author="hustlmsp" created="Thu, 31 Oct 2013 05:57:27 +0000"  >&lt;p&gt;no. I don&apos;t think we need to do that as exitOnUnhandledException make things a bit dirty. Only critical threads like JournalThread needs to use BookieThread and they already there.&lt;/p&gt;</comment>
                            <comment id="13810328" author="ikelly" created="Thu, 31 Oct 2013 15:19:28 +0000"  >&lt;p&gt;maybe a setCritical() call could be added to BookieThread to give the same effect, which could be set only by the threads which need to Journal, flush threads, etc.&lt;/p&gt;

&lt;p&gt;GC isn&apos;t really critical though. We should log a loud error when it dies though.&lt;/p&gt;</comment>
                            <comment id="13811098" author="rakeshr" created="Fri, 1 Nov 2013 07:06:11 +0000"  >&lt;p&gt;Thanks Sijie, Ivan for the reply. I&apos;ve raised an improvement JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-701&quot; title=&quot;Improve exception handling of Bookkeeper threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-701&quot;&gt;&lt;del&gt;BOOKKEEPER-701&lt;/del&gt;&lt;/a&gt;, to revisit all our threads and discuss more on this topic.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12611014" name="0001-BOOKKEEPER-700.patch" size="890" author="rakeshr" created="Wed, 30 Oct 2013 09:21:03 +0000"/>
                            <attachment id="12611073" name="0002-BOOKKEEPER-700.patch" size="9086" author="rakeshr" created="Wed, 30 Oct 2013 14:32:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 30 Oct 2013 09:50:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356011</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzj7w7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356299</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>