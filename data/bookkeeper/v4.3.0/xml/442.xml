<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:26:19 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-442/BOOKKEEPER-442.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-442] Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-442</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;The problems encountered when failed to updateSubscriptionState but deleted consumed ledgers. &lt;/p&gt;

&lt;p&gt;The issue is described as below:&lt;/p&gt;

&lt;p&gt;1) A subscriber setLastConsumeSeqId to move consume ptr. If the consume ptr is moved over consume interval, an update subscription state operation is issued to update to ZooKeeper.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

AbstractSubscriptionManager:

            
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (subState.setLastConsumeSeqId(consumeSeqId, cfg.getConsumeInterval())) {                updateSubscriptionState(topic, subscriberId, subState, cb, ctx);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2) when move consume ptr, it also changed in-memory subscription state before the subscription state is persisted to ZooKeeper.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; setLastConsumeSeqId(MessageSeqId lastConsumeSeqId, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; consumeInterval) {
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; interval = lastConsumeSeqId.getLocalComponent() - subscriptionState.getMsgId().          getLocalComponent();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (interval &amp;lt;= 0) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;code-comment&quot;&gt;// set consume seq id when it is larger
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lastConsumeSeqId = lastConsumeSeqId;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (interval &amp;lt; consumeInterval) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;code-comment&quot;&gt;// subscription state will be updated, marked it as clean
&lt;/span&gt;        subscriptionState = SubscriptionState.newBuilder(subscriptionState).                          setMsgId(lastConsumeSeqId).build();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3) MessageConsumedTask runs periodically to delete consumed ledgers. it would use in-memory subscription state to perform such deletion. so if ledger is deleted first and failed to update subscription state. it would cause inconsistent state, when hub restarts and subscriber reconnects, it would use old seq id to start delivering but the ledger has messages with old seq id has been deleted.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InMemorySubscriptionState curSubscription : topicSubscriptions.values()) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (curSubscription.getSubscriptionState().getMsgId().getLocalComponent() &amp;lt;       minConsumedMessage)
                        minConsumedMessage = curSubscription.getSubscriptionState().getMsgId().       getLocalComponent();
                    hasBound = hasBound &amp;amp;&amp;amp; curSubscription.getSubscriptionPreferences().              hasMessageBound();
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;The fix would be let message consume task only use persistence state to performance deletions only. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12613433">BOOKKEEPER-442</key>
            <summary>Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jiannan">Jiannan Wang</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Oct 2012 06:10:57 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:42 +0000</updated>
                            <resolved>Mon, 3 Dec 2012 15:28:33 +0000</resolved>
                                    <version>4.1.0</version>
                    <version>4.2.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                                    <component>hedwig-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13486778" author="jiannan" created="Tue, 30 Oct 2012 10:18:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/7775&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/7775&lt;/a&gt;&lt;br/&gt;
Diff revision 1&lt;/p&gt;</comment>
                            <comment id="13489371" author="ikelly" created="Fri, 2 Nov 2012 11:49:19 +0000"  >&lt;p&gt;Patch looks good. I have one question about the point where you throw a runtime exception, but otherwise this is ready to go.&lt;/p&gt;</comment>
                            <comment id="13490182" author="jiannan" created="Sun, 4 Nov 2012 12:51:17 +0000"  >&lt;p&gt;Thanks Ivan for review, I&apos;ll update the patch.&lt;/p&gt;

&lt;p&gt;Sorry for delay reply, I&apos;m make a moving and cannot access internet these days.&lt;/p&gt;</comment>
                            <comment id="13490556" author="jiannan" created="Mon, 5 Nov 2012 10:38:58 +0000"  >&lt;p&gt;Change follows Ivan&apos;s comment: logging the error instead of throw a runtime exception&lt;/p&gt;</comment>
                            <comment id="13504605" author="hadoopqa" created="Tue, 27 Nov 2012 13:19:52 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-442&quot; title=&quot;Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-442&quot;&gt;&lt;del&gt;BOOKKEEPER-442&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;WARNING: Running test-patch on a dirty local svn workspace&lt;/p&gt;

&lt;p&gt;Patch &amp;lt;a href=&quot;/jira/secure/attachment/12552085/&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-442&quot; title=&quot;Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-442&quot;&gt;&lt;del&gt;BOOKKEEPER-442&lt;/del&gt;&lt;/a&gt;.diff&quot;&amp;gt;/jira/secure/attachment/12552085/&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-442&quot; title=&quot;Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-442&quot;&gt;&lt;del&gt;BOOKKEEPER-442&lt;/del&gt;&lt;/a&gt;.diff&amp;lt;/a&amp;gt; downloaded at Tue Nov 27 13:17:20 UTC 2012&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; Patch failed to apply to head of branch&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;</comment>
                            <comment id="13504707" author="ikelly" created="Tue, 27 Nov 2012 16:02:24 +0000"  >&lt;p&gt;I added a new comment to the review board. Basically, it&apos;s not enough to just log either, as that will hang the client request. You need to complete the callback also.&lt;/p&gt;</comment>
                            <comment id="13508687" author="jiannan" created="Mon, 3 Dec 2012 12:25:41 +0000"  >&lt;p&gt;Update patch by Ivan&apos;s suggestion, also update it in review board.&lt;/p&gt;</comment>
                            <comment id="13508799" author="ikelly" created="Mon, 3 Dec 2012 15:28:33 +0000"  >&lt;p&gt;Committed as r1416560. Great work Jiannan!&lt;/p&gt;</comment>
                            <comment id="13509604" author="hudson" created="Tue, 4 Dec 2012 09:05:25 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #837 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/837/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/837/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-442&quot; title=&quot;Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-442&quot;&gt;&lt;del&gt;BOOKKEEPER-442&lt;/del&gt;&lt;/a&gt;: Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges. (jiannan via ivank) (Revision 1416560)&lt;/p&gt;

&lt;p&gt;     Result = UNSTABLE&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/persistence/BookkeeperPersistenceManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/AbstractSubscriptionManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/InMemorySubscriptionState.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/persistence/TestBookKeeperPersistenceManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12612647">BOOKKEEPER-439</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12555748" name="BOOKKEEPER-442.diff" size="19870" author="jiannan" created="Mon, 3 Dec 2012 12:25:41 +0000"/>
                            <attachment id="12552085" name="BOOKKEEPER-442.diff" size="19452" author="jiannan" created="Mon, 5 Nov 2012 10:38:58 +0000"/>
                            <attachment id="12551331" name="BOOKKEEPER-442.diff" size="19384" author="jiannan" created="Tue, 30 Oct 2012 10:18:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 30 Oct 2012 10:18:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250938</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4x5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62533</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>