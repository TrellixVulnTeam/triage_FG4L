<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:30:32 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-387/BOOKKEEPER-387.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-387] BookKeeper Upgrade is not working.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-387</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;I am trying to upgrade BK from 4.1.0 to 4.2.0, but it will log as &quot;Directory is current, no need to upgrade&#8221; even then it will continue and fail.&lt;br/&gt;
and throwing following exception.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-09-03 17:25:12,468 - ERROR - [main:FileSystemUpgrade@229] - Error moving upgraded directories into place /home/BK4.1/bookkeeper1/ledger/upgradeTmp.2433718456734190 -&amp;gt; /home/BK4.1/bookkeeper1/ledger/current
org.apache.commons.io.FileExistsException: Destination &apos;/home/BK4.1/bookkeeper1/ledger/current&apos; already exists
        at org.apache.commons.io.FileUtils.moveDirectory(FileUtils.java:2304)
        at org.apache.bookkeeper.bookie.FileSystemUpgrade.upgrade(FileSystemUpgrade.java:225)
        at org.apache.bookkeeper.bookie.FileSystemUpgrade.main(FileSystemUpgrade.java:367)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12606047">BOOKKEEPER-387</key>
            <summary>BookKeeper Upgrade is not working.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="surendrasingh">surendra singh lilhore</assignee>
                                    <reporter username="surendrasingh">surendra singh lilhore</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Sep 2012 10:27:35 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:56 +0000</updated>
                            <resolved>Fri, 7 Sep 2012 06:27:48 +0100</resolved>
                                    <version>4.1.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13447626" author="hustlmsp" created="Tue, 4 Sep 2012 12:29:26 +0100"  >&lt;p&gt;@surendra, Upgrade just needed to be run when upgrading from 4.0.0 to 4.1.0, since there is directories layout changes. from 4.1.0 to 4.2.0, there is no directory layout changes as far now, so you don&apos;t need to run upgrade tool. &lt;/p&gt;</comment>
                            <comment id="13447642" author="surendrasingh" created="Tue, 4 Sep 2012 12:56:43 +0100"  >&lt;p&gt;@sijie&lt;br/&gt;
Thanks for looking this issue.&lt;br/&gt;
But I have one question.&lt;/p&gt;

&lt;p&gt;If in 4.1 and 4.2 directory layout same then after logging this log upgrade process should stop but it will continue and fail when UpgradeTemp Dir move to Current Dir.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (version == Cookie.CURRENT_COOKIE_LAYOUT_VERSION){
                    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Directory is current, no need to upgrade&quot;&lt;/span&gt;);
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13447667" author="vinayrpet" created="Tue, 4 Sep 2012 14:04:06 +0100"  >&lt;p&gt;Hi Surendra,&lt;br/&gt;
You are correct. Upgrade should not continue when upgrade not at all required. It can return from there.. &lt;/p&gt;</comment>
                            <comment id="13447669" author="hustlmsp" created="Tue, 4 Sep 2012 14:07:24 +0100"  >&lt;p&gt;@surendra,&lt;/p&gt;

&lt;p&gt;yes, ur right. could you help generating a patch for it?&lt;/p&gt;</comment>
                            <comment id="13447692" author="surendrasingh" created="Tue, 4 Sep 2012 14:49:31 +0100"  >&lt;p&gt;Attached patch for issue&lt;/p&gt;</comment>
                            <comment id="13448626" author="hustlmsp" created="Wed, 5 Sep 2012 11:53:06 +0100"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (version == Cookie.CURRENT_COOKIE_LAYOUT_VERSION) {
                    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Directory is current, no need to upgrade&quot;&lt;/span&gt;);
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Actually, the version checking is per directory. so you just could skip the directory has been upgraded, it would be better to use &apos;continue&apos; instead of &apos;return&apos;.&lt;/p&gt;

&lt;p&gt;besides that, if there is no directory to upgrade. I think we don&apos;t need to write the new cookie to ZooKeeper.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deferredMoves.isEmpty()) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                c.writeToZooKeeper(zk, conf);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException ke) {
                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error writing cookie to zookeeper&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BookieException.UpgradeException(ke);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13448660" author="surendrasingh" created="Wed, 5 Sep 2012 13:18:45 +0100"  >&lt;p&gt;@sijie&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;yes, you are rite.&lt;/p&gt;

&lt;p&gt;i will generate new path and attach here.&lt;/p&gt;</comment>
                            <comment id="13448741" author="surendrasingh" created="Wed, 5 Sep 2012 14:55:17 +0100"  >&lt;p&gt;I have attached updated patch.&lt;/p&gt;</comment>
                            <comment id="13450290" author="hustlmsp" created="Fri, 7 Sep 2012 04:15:10 +0100"  >&lt;p&gt;+1 for the patch.&lt;/p&gt;</comment>
                            <comment id="13450294" author="hustlmsp" created="Fri, 7 Sep 2012 04:28:46 +0100"  >&lt;p&gt;@surendra, I forgot that we had a test case for upgrade tool. so it would be better to add a test case for it. I wrote a test case based on your patch. (w/o your changes, the test case would fail which reproduces the issue your report).&lt;/p&gt;

&lt;p&gt;could you help taking a look at the test case?&lt;/p&gt;</comment>
                            <comment id="13450348" author="surendrasingh" created="Fri, 7 Sep 2012 06:11:15 +0100"  >&lt;p&gt;@Sijie&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;+1, it&#8217;s good.&lt;/p&gt;

&lt;p&gt;This test case is able reproduce issue w/o my changes.&lt;/p&gt;</comment>
                            <comment id="13450363" author="hustlmsp" created="Fri, 7 Sep 2012 06:27:48 +0100"  >&lt;p&gt;committed as r1381879 in trunk. thanks surendra.&lt;/p&gt;</comment>
                            <comment id="13450366" author="hustlmsp" created="Fri, 7 Sep 2012 06:31:13 +0100"  >&lt;p&gt;committed as r1381882 in branch 4.1.&lt;/p&gt;</comment>
                            <comment id="13450388" author="hudson" created="Fri, 7 Sep 2012 07:00:57 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #696 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/696/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/696/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-387&quot; title=&quot;BookKeeper Upgrade is not working.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-387&quot;&gt;&lt;del&gt;BOOKKEEPER-387&lt;/del&gt;&lt;/a&gt;: BookKeeper Upgrade is not working. (surendra via sijie) (Revision 1381879)&lt;/p&gt;

&lt;p&gt;     Result = UNSTABLE&lt;br/&gt;
sijie : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12544156" name="BOOKKEEPER-387.diff" size="2445" author="hustlmsp" created="Fri, 7 Sep 2012 04:28:46 +0100"/>
                            <attachment id="12543671" name="BOOKKEEPER-387.patch" size="734" author="surendrasingh" created="Tue, 4 Sep 2012 14:49:31 +0100"/>
                            <attachment id="12543855" name="BOOKKEEPER-387_1.patch" size="1060" author="surendrasingh" created="Wed, 5 Sep 2012 14:54:07 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 4 Sep 2012 11:29:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250332</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4rq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61648</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>