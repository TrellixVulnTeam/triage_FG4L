<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:31:28 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-163/BOOKKEEPER-163.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-163] Prevent incorrect NoSuchLedgerException for readLastConfirmed.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-163</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;bookkeeper client treats NoSuchLedgerException as valid response when reading last confirmed. If NoSuchLedgerException is caused due to an empty directory in following cases, it is an incorrect response. &lt;/p&gt;

&lt;p&gt;1) A disk is replaced or ledger index is removed by a sloppy admin.&lt;br/&gt;
2) A disk is not mounted when a bookie machine is restarted.&lt;/p&gt;

&lt;p&gt;We need a mechanism to prevent such incorrect responses.&lt;/p&gt;

&lt;p&gt;Ivan suggested to generate a instance key for each bookie and write it into the ledger directories. If a directory doesn&apos;t have the key, and other directories do, then it shouldn&apos;t start. This would also resolve the issue that someone starting a new bookie with the same IP as a bookie which has previously died.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12541601">BOOKKEEPER-163</key>
            <summary>Prevent incorrect NoSuchLedgerException for readLastConfirmed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Feb 2012 11:51:28 +0000</created>
                <updated>Thu, 2 May 2013 03:29:49 +0100</updated>
                            <resolved>Tue, 13 Mar 2012 06:35:01 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>bookkeeper-client</component>
                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13209472" author="ikelly" created="Thu, 16 Feb 2012 16:16:17 +0000"  >&lt;p&gt;Patch applies on top of &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-172&quot; title=&quot;Upgrade framework for filesystem layouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-172&quot;&gt;&lt;del&gt;BOOKKEEPER-172&lt;/del&gt;&lt;/a&gt; patch&lt;/p&gt;</comment>
                            <comment id="13209473" author="jiraposter@reviews.apache.org" created="Thu, 16 Feb 2012 16:16:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3926/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;bookkeeper client treats NoSuchLedgerException as valid response when reading last confirmed. If NoSuchLedgerException is caused due to an empty directory in following cases, it is an incorrect response.&lt;/p&gt;

&lt;p&gt;1) A disk is replaced or ledger index is removed by a sloppy admin.&lt;br/&gt;
2) A disk is not mounted when a bookie machine is restarted.&lt;/p&gt;

&lt;p&gt;We need a mechanism to prevent such incorrect responses.&lt;/p&gt;

&lt;p&gt;Ivan suggested to generate a instance key for each bookie and write it into the ledger directories. If a directory doesn&apos;t have the key, and other directories do, then it shouldn&apos;t start. This would also resolve the issue that someone starting a new bookie with the same IP as a bookie which has previously died.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-163&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/pom.xml 601104f &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 2fb7c6c &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieException.java 1a5b313 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java aca66e6 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 3e96d46 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java 2df0ed0 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java 10f9538 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java f661e90 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 99258ac &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java 015e4e4 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java dada67a &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieFailureTest.java ea51118 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieZKExpireTest.java 5ed7061 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3926/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13225885" author="jiraposter@reviews.apache.org" created="Fri, 9 Mar 2012 06:39:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3926/#review5766&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/#review5766&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;most of the patch is good beside some small issues. I commented them inline.&lt;/p&gt;


&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/#comment12563&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/#comment12563&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    if more than two bookie server try to create COOKIE_PATH at the same time, it would fail. it would be better to catch NodeExists Exception.&lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/#comment12565&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/#comment12565&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    it seems that you missed that file &apos;lastId&apos; and &apos;lastMark&apos;&lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/#comment12564&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/#comment12564&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    it would be better to copy data to a temp directory, such as upgrading, then rename the upgrading directory to current.&lt;/p&gt;

&lt;p&gt;    otherwise, if the upgrading is broken after created current directory, but user restarts bookie server with this upgrade-failed directory, bookie server would treat it as a new environment. &lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/#comment12566&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/#comment12566&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    for a new disk (new directory) added case, it would not cause data missing. &lt;/p&gt;

&lt;p&gt;    could we provide a tool to upgrade a bookie&apos;s cookie when adding a new directory?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sijie&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-02-16 16:15:58, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3926/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-16 16:15:58)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper client treats NoSuchLedgerException as valid response when reading last confirmed. If NoSuchLedgerException is caused due to an empty directory in following cases, it is an incorrect response.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1) A disk is replaced or ledger index is removed by a sloppy admin.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2) A disk is not mounted when a bookie machine is restarted.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We need a mechanism to prevent such incorrect responses.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan suggested to generate a instance key for each bookie and write it into the ledger directories. If a directory doesn&apos;t have the key, and other directories do, then it shouldn&apos;t start. This would also resolve the issue that someone starting a new bookie with the same IP as a bookie which has previously died.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-163&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/pom.xml 601104f &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 2fb7c6c &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieException.java 1a5b313 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java aca66e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 3e96d46 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java 2df0ed0 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java 10f9538 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java f661e90 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 99258ac &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java 015e4e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java dada67a &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieFailureTest.java ea51118 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieZKExpireTest.java 5ed7061 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3926/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13225974" author="ikelly" created="Fri, 9 Mar 2012 09:59:43 +0000"  >&lt;p&gt;There&apos;s a few conflicts with trunk, which im sorting out now. I&apos;ll upload a new patch when im done.&lt;/p&gt;</comment>
                            <comment id="13225975" author="jiraposter@reviews.apache.org" created="Fri, 9 Mar 2012 09:59:59 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-03-09 06:38:44, Sijie Guo wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java, line 151&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/diff/1/?file=75432#file75432line151&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff/1/?file=75432#file75432line151&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     for a new disk (new directory) added case, it would not cause data missing. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     could we provide a tool to upgrade a bookie&apos;s cookie when adding a new directory?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did have this in the back of my mind when writing this, but it seems an extra feature to me and would bloat the scope a bit much. Could we put this in an new JIRA?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-03-09 06:38:44, Sijie Guo wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java, line 173&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/diff/1/?file=75428#file75428line173&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff/1/?file=75428#file75428line173&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     it would be better to copy data to a temp directory, such as upgrading, then rename the upgrading directory to current.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     otherwise, if the upgrading is broken after created current directory, but user restarts bookie server with this upgrade-failed directory, bookie server would treat it as a new environment.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Very good point, will do this.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-03-09 06:38:44, Sijie Guo wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java, line 63&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/diff/1/?file=75428#file75428line63&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff/1/?file=75428#file75428line63&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     it seems that you missed that file &apos;lastId&apos; and &apos;lastMark&apos;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, well spotted, will add them.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-03-09 06:38:44, Sijie Guo wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java, line 135&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3926/diff/1/?file=75426#file75426line135&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff/1/?file=75426#file75426line135&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     if more than two bookie server try to create COOKIE_PATH at the same time, it would fail. it would be better to catch NodeExists Exception.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ivan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3926/#review5766&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/#review5766&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-02-16 16:15:58, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3926/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-16 16:15:58)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper client treats NoSuchLedgerException as valid response when reading last confirmed. If NoSuchLedgerException is caused due to an empty directory in following cases, it is an incorrect response.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1) A disk is replaced or ledger index is removed by a sloppy admin.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2) A disk is not mounted when a bookie machine is restarted.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We need a mechanism to prevent such incorrect responses.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan suggested to generate a instance key for each bookie and write it into the ledger directories. If a directory doesn&apos;t have the key, and other directories do, then it shouldn&apos;t start. This would also resolve the issue that someone starting a new bookie with the same IP as a bookie which has previously died.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-163&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/pom.xml 601104f &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 2fb7c6c &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieException.java 1a5b313 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java aca66e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 3e96d46 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java 2df0ed0 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java 10f9538 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java f661e90 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 99258ac &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java 015e4e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java dada67a &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieFailureTest.java ea51118 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieZKExpireTest.java 5ed7061 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3926/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13225991" author="hustlmsp" created="Fri, 9 Mar 2012 10:35:27 +0000"  >&lt;p&gt;&amp;gt; I did have this in the back of my mind when writing this, but it seems an extra feature to me and would bloat the scope a bit much. Could we put this in an new JIRA?&lt;/p&gt;

&lt;p&gt;yeah, it is an extra feature. let&apos;s add it in a new jira.&lt;/p&gt;</comment>
                            <comment id="13226020" author="ikelly" created="Fri, 9 Mar 2012 11:23:04 +0000"  >&lt;p&gt;new patch addresses Sijie&apos;s comments&lt;/p&gt;</comment>
                            <comment id="13226022" author="jiraposter@reviews.apache.org" created="Fri, 9 Mar 2012 11:24:56 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3926/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-03-09 11:23:54.722810)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;bookkeeper client treats NoSuchLedgerException as valid response when reading last confirmed. If NoSuchLedgerException is caused due to an empty directory in following cases, it is an incorrect response.&lt;/p&gt;

&lt;p&gt;1) A disk is replaced or ledger index is removed by a sloppy admin.&lt;br/&gt;
2) A disk is not mounted when a bookie machine is restarted.&lt;/p&gt;

&lt;p&gt;We need a mechanism to prevent such incorrect responses.&lt;/p&gt;

&lt;p&gt;Ivan suggested to generate a instance key for each bookie and write it into the ledger directories. If a directory doesn&apos;t have the key, and other directories do, then it shouldn&apos;t start. This would also resolve the issue that someone starting a new bookie with the same IP as a bookie which has previously died.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-163&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieZKExpireTest.java 5ed7061 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieFailureTest.java ea51118 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java dada67a &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 99258ac &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java 015e4e4 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java 281f729 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java eb08479 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CompactionTest.java 016289d &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java 10f9538 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 19295bb &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java bc7a703 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java 82f01e8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java d1427b7 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieException.java 1a5b313 &lt;br/&gt;
  bookkeeper-server/pom.xml 601104f &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 0d66b41 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3926/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13227332" author="hustlmsp" created="Mon, 12 Mar 2012 06:22:41 +0000"  >&lt;p&gt;new patch is well done. but a new issue came to me when I reviewed this patch. I am not sure that copying files is good enough for upgrading, since it would take long time to copy data and exhaust disk space (if we don&apos;t have enough space to copy data, the upgrading would be failed). do you consider creating hardlink instead of copying data for upgrading?&lt;/p&gt;</comment>
                            <comment id="13227390" author="ikelly" created="Mon, 12 Mar 2012 09:34:32 +0000"  >&lt;p&gt;Hmm, this is true. The problem here is that hardlinking isn&apos;t built into java yet (it exists in jdk7, but thats not in general usage). I guess I can do a check for /usr/bin/ln and if it doesn&apos;t exist, do a copy. &lt;/p&gt;</comment>
                            <comment id="13227411" author="hustlmsp" created="Mon, 12 Mar 2012 10:28:20 +0000"  >&lt;p&gt;yes. I remembered hadoop used &apos;ln&apos; command to do upgrading too. And it also batched hardlinking to make upgrading fast. I think we can refer its experience.&lt;/p&gt;</comment>
                            <comment id="13227448" author="ikelly" created="Mon, 12 Mar 2012 12:11:28 +0000"  >&lt;p&gt;New patch uses hardlinking rather than copying.&lt;/p&gt;</comment>
                            <comment id="13227452" author="jiraposter@reviews.apache.org" created="Mon, 12 Mar 2012 12:13:37 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3926/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-03-12 12:12:03.757647)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;bookkeeper client treats NoSuchLedgerException as valid response when reading last confirmed. If NoSuchLedgerException is caused due to an empty directory in following cases, it is an incorrect response.&lt;/p&gt;

&lt;p&gt;1) A disk is replaced or ledger index is removed by a sloppy admin.&lt;br/&gt;
2) A disk is not mounted when a bookie machine is restarted.&lt;/p&gt;

&lt;p&gt;We need a mechanism to prevent such incorrect responses.&lt;/p&gt;

&lt;p&gt;Ivan suggested to generate a instance key for each bookie and write it into the ledger directories. If a directory doesn&apos;t have the key, and other directories do, then it shouldn&apos;t start. This would also resolve the issue that someone starting a new bookie with the same IP as a bookie which has previously died.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-163&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 19295bb &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java bc7a703 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java 10f9538 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java 82f01e8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java d1427b7 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieException.java 1a5b313 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/pom.xml 601104f &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 0d66b41 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CompactionTest.java 016289d &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java 281f729 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java eb08479 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 99258ac &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java 015e4e4 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java dada67a &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieFailureTest.java ea51118 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieZKExpireTest.java 5ed7061 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3926/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13227512" author="hustlmsp" created="Mon, 12 Mar 2012 13:27:23 +0000"  >&lt;p&gt;I am OK for the new patch, +1. Although it seems that hadoop-common jar introduces lot of dependencies, which are not be used actually, it seems that we don&apos;t have a better library to support hardlink than hadoop common jar. I would like to hear other one&apos;s opinion.&lt;/p&gt;</comment>
                            <comment id="13227516" author="hustlmsp" created="Mon, 12 Mar 2012 13:33:05 +0000"  >&lt;p&gt;BTW, hadoop-common jar introduces protobuf-2.4.0, which is higher than 2.3.0.&lt;/p&gt;</comment>
                            <comment id="13227561" author="ikelly" created="Mon, 12 Mar 2012 14:20:43 +0000"  >&lt;p&gt;Irritatingly, Hardlink doesn&apos;t use any 3rd party deps at all. New patch excludes all of hadoop-common&apos;s transactive deps. It&apos;s ugly, but i think it&apos;s the only option we have until jdk7 is commonplace.&lt;/p&gt;</comment>
                            <comment id="13227563" author="jiraposter@reviews.apache.org" created="Mon, 12 Mar 2012 14:22:36 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3926/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-03-12 14:21:17.503815)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;bookkeeper client treats NoSuchLedgerException as valid response when reading last confirmed. If NoSuchLedgerException is caused due to an empty directory in following cases, it is an incorrect response.&lt;/p&gt;

&lt;p&gt;1) A disk is replaced or ledger index is removed by a sloppy admin.&lt;br/&gt;
2) A disk is not mounted when a bookie machine is restarted.&lt;/p&gt;

&lt;p&gt;We need a mechanism to prevent such incorrect responses.&lt;/p&gt;

&lt;p&gt;Ivan suggested to generate a instance key for each bookie and write it into the ledger directories. If a directory doesn&apos;t have the key, and other directories do, then it shouldn&apos;t start. This would also resolve the issue that someone starting a new bookie with the same IP as a bookie which has previously died.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-163&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/pom.xml 601104f &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 0d66b41 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieException.java 1a5b313 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java 82f01e8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java d1427b7 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 19295bb &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java bc7a703 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java 10f9538 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CompactionTest.java 016289d &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java 281f729 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java eb08479 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 99258ac &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java 015e4e4 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java dada67a &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieFailureTest.java ea51118 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieZKExpireTest.java 5ed7061 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3926/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3926/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13228228" author="hustlmsp" created="Tue, 13 Mar 2012 05:37:54 +0000"  >&lt;p&gt;+1 for new patch.&lt;/p&gt;</comment>
                            <comment id="13228247" author="hustlmsp" created="Tue, 13 Mar 2012 06:33:35 +0000"  >&lt;p&gt;committed as r1299984. Great work, Thanks Ivan.&lt;/p&gt;</comment>
                            <comment id="13228252" author="hudson" created="Tue, 13 Mar 2012 07:03:17 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #402 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/402/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/402/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;: Prevent incorrect NoSuchLedgerException for readLastConfirmed. (ivank via sijie) (Revision 1299984)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
sijie : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/pom.xml&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieException.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CompactionTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CookieTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieFailureTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieZKExpireTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12542576">BOOKKEEPER-170</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12542682">BOOKKEEPER-172</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12518027" name="BOOKKEEPER-163.diff" size="96402" author="ikelly" created="Mon, 12 Mar 2012 14:20:43 +0000"/>
                            <attachment id="12518012" name="BOOKKEEPER-163.diff" size="91749" author="ikelly" created="Mon, 12 Mar 2012 12:11:28 +0000"/>
                            <attachment id="12517707" name="BOOKKEEPER-163.diff" size="90564" author="ikelly" created="Fri, 9 Mar 2012 11:23:01 +0000"/>
                            <attachment id="12514812" name="BOOKKEEPER-163.diff" size="86502" author="ikelly" created="Thu, 16 Feb 2012 16:14:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 16 Feb 2012 16:16:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226888</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4san:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>