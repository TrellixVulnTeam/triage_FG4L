<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:31:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-169/BOOKKEEPER-169.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-169] bookie hangs on reading header when encountering partial header index file</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-169</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;bookie server hangs on reading header part when reading partial header index file (whose header part is less than 1k). This kind of index file existed because bookie server shuts down when writing header of index file.&lt;/p&gt;

&lt;p&gt;bookie server should check file size when reading header. in pre-v3 journal, we don&apos;t have master key stored in journal, so if master key is missing, we have no chance to repair it just throw an IOException when reading header. in post-v3 journal, we store master key as an meta entry in journal, so we can rewrite the header part.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12542560">BOOKKEEPER-169</key>
            <summary>bookie hangs on reading header when encountering partial header index file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Feb 2012 16:08:30 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:13 +0100</updated>
                            <resolved>Fri, 17 Feb 2012 10:22:14 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13208163" author="hustlmsp" created="Wed, 15 Feb 2012 00:54:01 +0000"  >&lt;p&gt;attach a patch to fix it.&lt;/p&gt;</comment>
                            <comment id="13209560" author="ikelly" created="Thu, 16 Feb 2012 18:09:32 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+            &lt;span class=&quot;code-comment&quot;&gt;// repair partial index
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != fc &amp;amp;&amp;amp; fc.size() &amp;lt; 1024) {
+                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (success) {
+                    writeHeader(); 
+                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != masterKey) {
+                    writeHeader();
+                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != error) {
+                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Reading header error: &quot;&lt;/span&gt;, error);
+                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Reading header error.&quot;&lt;/span&gt;);
+                    }
+                }
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If success, then there&apos;s no need to rewrite the header, the first write will skip past first 1024 bytes anyhow. Instead of the success flag, I&apos;d just do the following.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    readHeader();
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (BufferUnderflowException buf) {
    LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception when reading header of {} : {}&quot;&lt;/span&gt;, lf, buf);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != masterKey) {
        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Attempting to write header again&quot;&lt;/span&gt;);
        writeHeader();
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error reading header &quot;&lt;/span&gt; + lf);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the header was incomplete, readHeader should have thrown BufferUnderflowException, otherwise everything is normal.&lt;/p&gt;

&lt;p&gt;Also, where 1024 is used as a literal, you should use START_OF_DATA. &lt;/p&gt;

&lt;p&gt;I think we should move all the test Journal write methods to the same class to keep them all together.&lt;/p&gt;</comment>
                            <comment id="13210018" author="hustlmsp" created="Fri, 17 Feb 2012 03:12:19 +0000"  >&lt;p&gt;attach a new patch addresses Ivan&apos;s comment.&lt;/p&gt;</comment>
                            <comment id="13210169" author="ikelly" created="Fri, 17 Feb 2012 10:22:14 +0000"  >&lt;p&gt;Committed as r1245369, thanks Sijie.&lt;/p&gt;</comment>
                            <comment id="13210177" author="hudson" created="Fri, 17 Feb 2012 10:44:04 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #364 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/364/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/364/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-169&quot; title=&quot;bookie hangs on reading header when encountering partial header index file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-169&quot;&gt;&lt;del&gt;BOOKKEEPER-169&lt;/del&gt;&lt;/a&gt;: bookie hangs on reading header when encountering partial header index file (sijie via ivank) (Revision 1245369)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12514582" name="BK-169.diff" size="12312" author="hustlmsp" created="Wed, 15 Feb 2012 00:53:31 +0000"/>
                            <attachment id="12514938" name="BK-169.diff_v2" size="10404" author="hustlmsp" created="Fri, 17 Feb 2012 03:12:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 16 Feb 2012 18:09:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>227846</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4sbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61746</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>