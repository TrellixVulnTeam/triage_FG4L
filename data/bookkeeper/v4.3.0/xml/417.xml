<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:30:07 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-417/BOOKKEEPER-417.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-417] Hierarchical zk underreplication manager should clean up its hierarchy when done to allow for fast acquisition of underreplicated entries</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-417</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;As we traverse the hierarchy to find a underreplicated fragment, leaving the hierarchy will cause the traversal to search in many empty znodes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12610361">BOOKKEEPER-417</key>
            <summary>Hierarchical zk underreplication manager should clean up its hierarchy when done to allow for fast acquisition of underreplicated entries</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12553925">BOOKKEEPER-237</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Oct 2012 18:25:55 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:31 +0000</updated>
                            <resolved>Tue, 16 Oct 2012 16:02:37 +0100</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                    <component>bookkeeper-auto-recovery</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13469570" author="umamaheswararao" created="Thu, 4 Oct 2012 19:13:43 +0100"  >&lt;p&gt;Yeah, I have seen this while debugging. Thanks for filing the JIRA. I think, functionally no harm, but we have to fix this to avoid unnecessary traversals.&lt;/p&gt;</comment>
                            <comment id="13470183" author="ikelly" created="Fri, 5 Oct 2012 10:09:32 +0100"  >&lt;p&gt;Yes, when I was running some benchmarks, this really slowed down recovery time if the number of ledgers being recovered was large (10,000+).&lt;/p&gt;</comment>
                            <comment id="13470184" author="ikelly" created="Fri, 5 Oct 2012 10:10:00 +0100"  >&lt;p&gt;Also, I already have this implemented, I just need to break out the patch.&lt;/p&gt;</comment>
                            <comment id="13471737" author="rakeshr" created="Mon, 8 Oct 2012 19:31:28 +0100"  >&lt;p&gt;Thanks Ivan for introducing guava. &lt;br/&gt;
Patch looks nice and just one thought, its safe and good to configure timeout parameter for testHierarchyCleanupInterference as it has many loops and join.&lt;/p&gt;</comment>
                            <comment id="13472210" author="rakeshr" created="Tue, 9 Oct 2012 09:09:29 +0100"  >&lt;p&gt;I mean like following in tests and timeout could be an ideal value, so will not hang at all.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test(timeout = 50000)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testHierarchyCleanupInterference ()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13472221" author="umamaheswararao" created="Tue, 9 Oct 2012 09:47:17 +0100"  >&lt;p&gt;Hi Ivan. Patch looks great. I have one comment adding to rakesh comment.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  zkc.delete(getUrLedgerZnode(ledgerId), l.getLedgerZNodeVersion());
+                &lt;span class=&quot;code-comment&quot;&gt;// clean up the hierarchy
&lt;/span&gt;+                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; parts[] = getUrLedgerZnode(ledgerId).split(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;);
+                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt;= 4; i++) {
+                    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; p[] = Arrays.copyOf(parts, parts.length - i);
+                    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = Joiner.on(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;).join(p);
+                    Stat s = zkc.exists(path, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
+                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (s != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                        zkc.delete(path, s.getVersion());
+                    }
+                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Currently NotEmptyException handle for even leaf node. &lt;br/&gt;
Actually we should handle only for &apos;clean up the hierarchy&apos; delete call.&lt;br/&gt;
When we delete leaf node, expectation is that, that will be free. But for any reason/due to some bug, if leaf node has some child node introduced, then we will silently ignore here. Actually that is not expected. It should loudly throw exception out.&lt;br/&gt;
So, better to handle NotEmptyException only for hierarchy cleanup delete call. What do you say?&lt;/p&gt;</comment>
                            <comment id="13473132" author="ikelly" created="Wed, 10 Oct 2012 10:53:38 +0100"  >&lt;p&gt;New patch addresses comments&lt;/p&gt;</comment>
                            <comment id="13473361" author="umamaheswararao" created="Wed, 10 Oct 2012 17:55:56 +0100"  >&lt;p&gt;+1 patch looks good to me. Thanks Ivan.&lt;/p&gt;</comment>
                            <comment id="13473785" author="rakeshr" created="Thu, 11 Oct 2012 03:19:30 +0100"  >&lt;p&gt;+1 New patch looks good. Thanks Ivan.&lt;/p&gt;</comment>
                            <comment id="13474115" author="ikelly" created="Thu, 11 Oct 2012 14:01:44 +0100"  >&lt;p&gt;Last patch had a race in TestReplicationWorker. Fixed in latest.&lt;/p&gt;</comment>
                            <comment id="13474165" author="umamaheswararao" created="Thu, 11 Oct 2012 14:57:30 +0100"  >&lt;p&gt;Yeah, +1 for TestReplicationWorker changes. Thanks&lt;/p&gt;</comment>
                            <comment id="13477067" author="ikelly" created="Tue, 16 Oct 2012 16:02:28 +0100"  >&lt;p&gt;Committed as r1398834. Thanks guys.&lt;/p&gt;</comment>
                            <comment id="13477186" author="hudson" created="Tue, 16 Oct 2012 18:27:23 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #755 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/755/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/755/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-417&quot; title=&quot;Hierarchical zk underreplication manager should clean up its hierarchy when done to allow for fast acquisition of underreplicated entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-417&quot;&gt;&lt;del&gt;BOOKKEEPER-417&lt;/del&gt;&lt;/a&gt;: Hierarchical zk underreplication manager should clean up its hierarchy when done to allow for fast acquisition of underreplicated entries (ivank) (Revision 1398834)&lt;/p&gt;

&lt;p&gt;     Result = UNSTABLE&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/pom.xml&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/ZkLedgerUnderreplicationManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/replication/TestLedgerUnderreplicationManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/replication/TestReplicationWorker.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548737" name="BOOKKEEPER-417.diff" size="11609" author="ikelly" created="Thu, 11 Oct 2012 14:01:44 +0100"/>
                            <attachment id="12548544" name="BOOKKEEPER-417.diff" size="9879" author="ikelly" created="Wed, 10 Oct 2012 10:53:38 +0100"/>
                            <attachment id="12548240" name="BOOKKEEPER-417.diff" size="8894" author="ikelly" created="Mon, 8 Oct 2012 15:23:17 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 4 Oct 2012 18:13:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240543</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxuxrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4295</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>