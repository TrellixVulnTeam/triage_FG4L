<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-378/BOOKKEEPER-378.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-378] ReplicationWorker may not get ZK watcher notification on UnderReplication ledger lock deletion.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-378</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;This issue found with BK-248. see &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-248?focusedCommentId=13439426&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13439426&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;comment&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Issue is: &lt;br/&gt;
1) Two Workers started and trying to get the lock for same ledger.&lt;br/&gt;
2) Both worker found that lock file does not exist.&lt;br/&gt;
3) both gone ahead for creating the lock node.&lt;br/&gt;
4) One worker failed with NodeExists exception&lt;/p&gt;

&lt;p&gt;Then it is just removing the children from the list and go for latch wait for the watch notification.&lt;/p&gt;

&lt;p&gt;But here unfortunately we added the watch on lockPath with exists check call. But that time lockPatch really did not exists. SO, the lock may be invalid. Then it will never get the notification when lock has been cleaned by other worker.&lt;br/&gt;
Here other worker partly replicated and now the current worker should take lock. But it can not get that notification as it added that watch when node does not exist.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12604589">BOOKKEEPER-378</key>
            <summary>ReplicationWorker may not get ZK watcher notification on UnderReplication ledger lock deletion.</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12553925">BOOKKEEPER-237</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="umamaheswararao">Uma Maheswara Rao G</assignee>
                                    <reporter username="umamaheswararao">Uma Maheswara Rao G</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Aug 2012 11:33:49 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:53 +0000</updated>
                            <resolved>Fri, 24 Aug 2012 21:00:22 +0100</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                    <component>bookkeeper-auto-recovery</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13440224" author="umamaheswararao" created="Thu, 23 Aug 2012 12:41:53 +0100"  >&lt;p&gt;Attached a patch with simple fix&lt;br/&gt;
Fix is straight forward, just need to add exists watcher again on NodeExistsException.&lt;/p&gt;

&lt;p&gt;Test wise, BK-248 multiple worker test will block most of the times with this issue. So, let&apos;s push this change before BK-248 commits.&lt;/p&gt;</comment>
                            <comment id="13441093" author="umamaheswararao" created="Fri, 24 Aug 2012 13:05:54 +0100"  >&lt;p&gt;Added separate test for this situation here.&lt;br/&gt;
Also removed some unused imports and minor cleanups in TestZkLedgerUnerreplicationManager file.&lt;/p&gt;

&lt;p&gt;Handled one more case, where just before add exists watcher on NodeExists exception, we may not get watcher again. So, we should have a check of exists and if it exists then only we should remove child from children.&lt;br/&gt;
This test may get that reproduce easily as it will do quickly lock and release.&lt;/p&gt;

&lt;p&gt;@Ivan, could you please take a look on it?&lt;/p&gt;</comment>
                            <comment id="13441338" author="ikelly" created="Fri, 24 Aug 2012 18:54:22 +0100"  >&lt;p&gt;I had a look. We should never delete another person&apos;s lock in zookeeper. They&apos;ve locked it for a reason. If they stop responding, the zookeeper will clean up the node.&lt;/p&gt;

&lt;p&gt;The simple &quot;add another exists call&quot; solution didn&apos;t work because of how our watcher works. If you have a watch on a node, it will only be triggered once, so it was being triggered with a NodeCreated event in the test case most of the time, because of how the threads overlap. If we add NodeCreated as an event on which we count down the latch, everything works as it should. We don&apos;t need to add another watch, because we already add a watch when we check if the lock exists the first time.&lt;/p&gt;</comment>
                            <comment id="13441415" author="umamaheswararao" created="Fri, 24 Aug 2012 20:17:06 +0100"  >&lt;p&gt;Thanks a lot, Ivan for the reviews and update.&lt;/p&gt;

&lt;p&gt;Yep, This solution also I thought,but as we already had the similar conditional watch ( if exists then remove child.). But did not try.&lt;br/&gt;
With alternative fix, since I did not remove child if node does not exist, it will go and try again. That way it should work I feel.&lt;/p&gt;

&lt;p&gt;+1 for this as well&lt;/p&gt;

&lt;p&gt;I think we can push this in, so that RW patch can be checked next.&lt;/p&gt;
</comment>
                            <comment id="13441419" author="umamaheswararao" created="Fri, 24 Aug 2012 20:20:58 +0100"  >&lt;p&gt;I just ran RW tests, they passed with this patch too. thx&lt;/p&gt;</comment>
                            <comment id="13441442" author="ikelly" created="Fri, 24 Aug 2012 21:00:22 +0100"  >&lt;p&gt;Committed r1377075. Thanks Uma&lt;/p&gt;</comment>
                            <comment id="13441466" author="hudson" created="Fri, 24 Aug 2012 21:31:12 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #665 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/665/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/665/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-378&quot; title=&quot;ReplicationWorker may not get ZK watcher notification on UnderReplication ledger lock deletion.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-378&quot;&gt;&lt;del&gt;BOOKKEEPER-378&lt;/del&gt;&lt;/a&gt;: ReplicationWorker may not get ZK watcher notification on UnderReplication ledger lock deletion. (umamaheswararao &amp;amp; ivank via ivank) (Revision 1377075)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/ZkLedgerUnderreplicationManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/replication/TestLedgerUnderreplicationManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12554514">BOOKKEEPER-248</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12542306" name="BOOKKEEPER-378.diff" size="6769" author="ikelly" created="Fri, 24 Aug 2012 18:50:47 +0100"/>
                            <attachment id="12542262" name="BOOKKEEPER-378.patch" size="6987" author="umamaheswararao" created="Fri, 24 Aug 2012 13:01:49 +0100"/>
                            <attachment id="12542107" name="BOOKKEEPER-378.patch" size="1353" author="umamaheswararao" created="Thu, 23 Aug 2012 12:41:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 24 Aug 2012 17:54:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293550</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyn6in:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169243</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>