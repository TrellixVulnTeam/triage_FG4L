<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:39 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-513/BOOKKEEPER-513.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-513] TestMessageFilter fails periodically</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-513</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Running org.apache.hedwig.server.filter.TestMessageFilter&lt;br/&gt;
Tests run: 9, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 6.779 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;/p&gt;

&lt;p&gt;Results :&lt;/p&gt;

&lt;p&gt;Tests in error: &lt;br/&gt;
  testChangeSubscriptionPreferences(org.apache.hedwig.server.filter.TestMessageFilter): Server responded with a status code of: TOPIC_BUSY&lt;br/&gt;
  testChangeSubscriptionPreferencesForClientFilter(org.apache.hedwig.server.filter.TestMessageFilter): Server responded with a status code of: TOPIC_BUSY&lt;/p&gt;</description>
                <environment></environment>
        <key id="12624011">BOOKKEEPER-513</key>
            <summary>TestMessageFilter fails periodically</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Dec 2012 16:56:23 +0000</created>
                <updated>Wed, 13 Feb 2013 15:46:46 +0000</updated>
                            <resolved>Mon, 14 Jan 2013 12:46:41 +0000</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13532474" author="ikelly" created="Fri, 14 Dec 2012 17:25:33 +0000"  >&lt;p&gt;I get a similar error on MessageBoundedPersistenceTest&lt;/p&gt;</comment>
                            <comment id="13537077" author="ikelly" created="Thu, 20 Dec 2012 15:27:41 +0000"  >&lt;p&gt;The following sequence triggers this.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;subscribe&lt;/li&gt;
	&lt;li&gt;closeSubscription&lt;/li&gt;
	&lt;li&gt;subscribe(attach)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;AFAICS, this only happens with the simple client. Basically, closing just closes the channel, but the subscribe can get to the server before the channelDisconnected behaviour can happen, so the channel for the initial subscribe is still in the map. The solution is to send a closeSubscription message for the simple channel manager as well as with the multiplex client. Is there any reason we don&apos;t do this already &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hustlmsp&quot; class=&quot;user-hover&quot; rel=&quot;hustlmsp&quot;&gt;Sijie Guo&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13537251" author="hustlmsp" created="Thu, 20 Dec 2012 18:46:37 +0000"  >&lt;p&gt;no reason. just keep the behavior same as before for simple client. for simple client, sending the closeSubscription to hub server, the client has to wait until the closeSubscription respond. close subscription channel might be simple and straightforward.&lt;/p&gt;

&lt;p&gt;if we want to guarantee subscribe succeed if closeSubscription succeed, we might need to adapt to same solution to kick off a closeSubscription request. if we could relax the guarantee, how about we change the test case to use force attach? both are fine for me.&lt;/p&gt;</comment>
                            <comment id="13537321" author="ikelly" created="Thu, 20 Dec 2012 19:57:10 +0000"  >&lt;p&gt;I&apos;d prefer the sending a close subscription request. My only concern is it may cause BC issues. In any case, I won&apos;t get around to implementing until the end of next week probably.&lt;/p&gt;</comment>
                            <comment id="13540982" author="hustlmsp" created="Sat, 29 Dec 2012 19:40:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ikelly&quot; class=&quot;user-hover&quot; rel=&quot;ikelly&quot;&gt;Ivan Kelly&lt;/a&gt; did you start working on this jira? if not, I could take it.&lt;/p&gt;</comment>
                            <comment id="13542355" author="ikelly" created="Wed, 2 Jan 2013 19:55:45 +0000"  >&lt;p&gt;I haven&apos;t started on this yet. Will do it tomorrow if you haven&apos;t already started.&lt;/p&gt;</comment>
                            <comment id="13542366" author="hustlmsp" created="Wed, 2 Jan 2013 20:07:05 +0000"  >&lt;p&gt;please go ahead, Ivan. I haven&apos;t started yet.&lt;/p&gt;</comment>
                            <comment id="13543145" author="ikelly" created="Thu, 3 Jan 2013 18:13:57 +0000"  >&lt;p&gt;I&apos;m attaching a preliminary patch, but I think we&apos;ll need to go with another approach. &lt;/p&gt;

&lt;p&gt;There&apos;s a couple of problems with it. Firstly, it&apos;ll break when closing a subscription on a 4.1 server, as OperationType is an enum, and a 4.1 will only recognise the values it had in the OperationType enum, so no CLOSESUBSCRIPTION.&lt;/p&gt;

&lt;p&gt;A way to resolve this would be to detect the server protocol version, and only send close if it&apos;s greater than what we have in 4.2. However, this doesn&apos;t work either. ProtocolVersion is also an enum, so adding another value there will break protobuf compatibility with 4.1.&lt;/p&gt;

&lt;p&gt;The attached patch fails TestBackwardCompat (as 2 others also, but BackwardCompat is the most serious). &lt;/p&gt;</comment>
                            <comment id="13543225" author="fpj" created="Thu, 3 Jan 2013 19:44:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;a 4.1 will only recognise the values it had in the OperationType enum, so no CLOSESUBSCRIPTION.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If CLOSESUBSCRIPTION is the last value of the enum, then a 4.1 server won&apos;t recognise. We just need to make sure that the 4.1 branch will do the right thing if a server receives an unknown operation type.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A way to resolve this would be to detect the server protocol version, and only send close if it&apos;s greater than what we have in 4.2. However, this doesn&apos;t work either. ProtocolVersion is also an enum, so adding another value there will break protobuf compatibility with 4.1.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was wondering if it would be ok to have a patch for 4.1 to make sure that we don&apos;t break compatibility. It is not exactly as bug fix for 4.1, but it is not supposed to be a major change either, no?&lt;/p&gt;</comment>
                            <comment id="13543618" author="hustlmsp" created="Fri, 4 Jan 2013 05:35:46 +0000"  >&lt;p&gt;If it introduced compatibility issue, how about we moved it to next release. for this release, it seems that we could avoid it from test case side. anyway, this issue doesn&apos;t seem critical for me so far. I am fine with any solution on it.&lt;/p&gt;</comment>
                            <comment id="13544021" author="ikelly" created="Fri, 4 Jan 2013 16:54:44 +0000"  >&lt;p&gt;I&apos;ve modified SimpleHChannelManager to retry subscriptions up to 5 times if it gets a TOPIC_BUSY. This seems to resolve the issue, and the fix is entirely confined to the SimpleHChannel implementation. For TestBackwardsCompat, I&apos;ve added delays, as we cannot make any modifications to 4.1.0 &amp;amp; 4.0.0&lt;/p&gt;</comment>
                            <comment id="13544028" author="ikelly" created="Fri, 4 Jan 2013 17:00:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt; Protobufs assert if they find a value for a enum which isn&apos;t in the version they have. We can&apos;t modify 4.1.0 or 4.0.0 as they&apos;ve been released, so the OperationType enum in those releases will never have CLOSESUBSCRIPTION. If we could go back in time, the solution would be to change type from being an enum to an int and do the same for protocolVersion. As it is, protocolVersion is absolutely useless as we can&apos;t ever add a new version.&lt;/p&gt;</comment>
                            <comment id="13544043" author="fpj" created="Fri, 4 Jan 2013 17:25:37 +0000"  >&lt;p&gt;From your response, it sounds like my comment was not clear. We can always have a new release for a branch, and I was wondering if there was any change we could make to the 4.1 branch that could fix the compatibility issue. If there is any such a change, then we could have it in 4.1.1. &lt;/p&gt;

&lt;p&gt;I don&apos;t have any great ideas at this point, so it was just a high-level thought.&lt;/p&gt;</comment>
                            <comment id="13544080" author="hadoopqa" created="Fri, 4 Jan 2013 18:01:26 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-513&quot; title=&quot;TestMessageFilter fails periodically&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-513&quot;&gt;&lt;del&gt;BOOKKEEPER-513&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12563319/0001-BOOKKEEPER-513-TestMessageFilter-fails-periodically.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-513-TestMessageFilter-fails-periodically.patch&lt;/a&gt; downloaded at Fri Jan  4 17:01:13 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 2 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 TESTS&lt;/font&gt; - patch does not compile, cannot run testcases&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/199/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/199/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13544087" author="ikelly" created="Fri, 4 Jan 2013 18:10:34 +0000"  >&lt;p&gt;The problem is that it would be incompatible with 4.1.0. Any new 4.1 release is irrelevant. The problem would occur when users are upgrading their cluster to 4.2.0 from 4.1.0. If the client is 4.2.0 and the server is 4.1.0, a close subscriber will crash the server.&lt;/p&gt;</comment>
                            <comment id="13544089" author="ikelly" created="Fri, 4 Jan 2013 18:12:53 +0000"  >&lt;p&gt;The failure is with a test crashing. Will look into it.&lt;/p&gt;</comment>
                            <comment id="13544100" author="ikelly" created="Fri, 4 Jan 2013 18:27:32 +0000"  >&lt;p&gt;new patch is to try and trigger on jenkins with extra logging. It won&apos;t repro locally. &lt;/p&gt;</comment>
                            <comment id="13544233" author="hadoopqa" created="Fri, 4 Jan 2013 20:39:20 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-513&quot; title=&quot;TestMessageFilter fails periodically&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-513&quot;&gt;&lt;del&gt;BOOKKEEPER-513&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12563336/BOOKKEEPER-513.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-513.diff&lt;/a&gt; downloaded at Fri Jan  4 20:03:19 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 3 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 TESTS&lt;/font&gt; - patch does not compile, cannot run testcases&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/203/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/203/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13544748" author="hadoopqa" created="Sat, 5 Jan 2013 16:31:58 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-513&quot; title=&quot;TestMessageFilter fails periodically&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-513&quot;&gt;&lt;del&gt;BOOKKEEPER-513&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12563336/BOOKKEEPER-513.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-513.diff&lt;/a&gt; downloaded at Sat Jan  5 16:29:23 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 3 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 3&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-debug/23/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-debug/23/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13548690" author="ikelly" created="Wed, 9 Jan 2013 17:18:42 +0000"  >&lt;p&gt;Patch rebased onto latest trunk.&lt;/p&gt;</comment>
                            <comment id="13548742" author="hadoopqa" created="Wed, 9 Jan 2013 17:52:25 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-513&quot; title=&quot;TestMessageFilter fails periodically&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-513&quot;&gt;&lt;del&gt;BOOKKEEPER-513&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12563962/0001-BOOKKEEPER-513-TestMessageFilter-fails-periodically.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-513-TestMessageFilter-fails-periodically.patch&lt;/a&gt; downloaded at Wed Jan  9 17:21:24 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 2 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 785&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/230/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/230/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13549484" author="hustlmsp" created="Thu, 10 Jan 2013 09:45:57 +0000"  >&lt;p&gt;lgtm. +1. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt; could you take a look at the latest patch? since you are involved in this thread.&lt;/p&gt;</comment>
                            <comment id="13549898" author="fpj" created="Thu, 10 Jan 2013 18:45:40 +0000"  >&lt;p&gt;I applied only the changes to TestSubAfterCloseSub.java and it didn&apos;t fail. It was supposed to, right? I had a look at the test, and in my understanding it should have thrown an exception and failed because of the exception. For some reason it didn&apos;t. Also, if this is the case, why don&apos;t we catch the exception and fail the test?&lt;/p&gt;</comment>
                            <comment id="13549908" author="ikelly" created="Thu, 10 Jan 2013 18:51:26 +0000"  >&lt;p&gt;Which exception?&lt;/p&gt;

&lt;p&gt;The test should fail with a ServiceDownException, but it&apos;s a race condition, and probably machine sensitive, so there&apos;s no guarantee. I can get it to hit very reliably on a dev machine here. &lt;/p&gt;</comment>
                            <comment id="13549958" author="fpj" created="Thu, 10 Jan 2013 19:22:03 +0000"  >&lt;p&gt;Yeah, it does not fail for me with a ServiceDownException. That was one comment. The second comment was that perhaps we should catch the exception to make it clear that if it happens, it is wrong. The second point is minor, the first one worries me more. If it fails for everyone but me, then my vote is a 0+ for this patch.&lt;/p&gt;</comment>
                            <comment id="13551041" author="ikelly" created="Fri, 11 Jan 2013 10:48:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;it does not fail for me with a ServiceDownException&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This implies it fails with something? what does it fail with? It should be something to do with TOPIC_BUSY. What kind of machine are you using? Num cores? OS? How many times did you run it?&lt;/p&gt;

&lt;p&gt;I&apos;ve just run this on another different quad core linux machine, and it hits about 50% of the time. On my dual core macbook, about 50% of the time also. As I said, it&apos;s a race, and it&apos;s a race thats very dependent on what the networking stack and scheduler are doing. It&apos;s not possible to get a deterministic test for this. The best we can do is have something that creates the conditions in which the test can trigger, and if people start to see intermittent failures it means we have something to fix.&lt;/p&gt;</comment>
                            <comment id="13551045" author="fpj" created="Fri, 11 Jan 2013 10:57:19 +0000"  >&lt;p&gt;I&apos;m also running on a dual core macbook. I have even increased the number of iterations of the test to 100 and run multiple times... nothing. I checked to make sure that the new test was there. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The best we can do is have something that creates the conditions in which the test can trigger, and if people start to see intermittent failures it means we have something to fix.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have mixed feelings about tests that fail intermittently because passing doesn&apos;t really mean anything. But at this point, I don&apos;t think it makes sense to hold the release because of it. One option is to create a jira and think some more about it after the release. &lt;/p&gt;</comment>
                            <comment id="13551048" author="ikelly" created="Fri, 11 Jan 2013 11:17:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m also running on a dual core macbook. I have even increased the number of iterations of the test to 100 and run multiple times... nothing. I checked to make sure that the new test was there. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Have you ensured that the version of the hedwig-client jar installed is the one without the fix? Do a mvn install -DskipTests from a clean branch just to be sure.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&lt;br/&gt;
I have mixed feelings about tests that fail intermittently because passing doesn&apos;t really mean anything. But at this point, I don&apos;t think it makes sense to hold the release because of it. One option is to create a jira and think some more about it after the release. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The other option is to not test it at all. It&apos;s impossible to have a deterministic test for this, as it depends on the timing of the kernel notifying netty of the disconnection on the server side and then depends on the timing of netty running the disconnection handler. We can&apos;t control these components and therefore can&apos;t control their timings.&lt;/p&gt;</comment>
                            <comment id="13551051" author="fpj" created="Fri, 11 Jan 2013 11:23:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Have you ensured that the version of the hedwig-client jar installed is the one without the fix? Do a mvn install -DskipTests from a clean branch just to be sure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok, I&apos;ll do it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The other option is to not test it at all.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, it is an option. Flaky tests make the process somewhat unreliable, though. I think I&apos;d rather have a smaller set of solid, reliable tests rather than a larger set of somewhat unreliable tests. Note that I also don&apos;t have a good suggestion to fix this test.&lt;/p&gt;</comment>
                            <comment id="13551053" author="ikelly" created="Fri, 11 Jan 2013 11:31:05 +0000"  >&lt;p&gt;The point of having this test in is to not to say &quot;the test passes, so the bug doesn&apos;t exist&quot;, but rather to say &quot;the test fails, therefore the bug exists&quot;. It&apos;s a canary.&lt;/p&gt;</comment>
                            <comment id="13551077" author="fpj" created="Fri, 11 Jan 2013 12:23:06 +0000"  >&lt;p&gt;Ok, after 40 minutes running, it did hit it. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The point of having this test in is to not to say &quot;the test passes, so the bug doesn&apos;t exist&quot;, but rather to say &quot;the test fails, therefore the bug exists&quot;. It&apos;s a canary.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I understand, and I also understand that these issues are difficult to test. However, tests that fail intermittently tend to cause confusion because there could be a long gap between reintroducing the bug and spotting it in a failed test. Again, I&apos;m not entirely convinced that it is a good thing to have tests like this, but if you feel we should, it is fine with me. &lt;/p&gt;

&lt;p&gt;One point I&apos;d like to make is that it would be good to differentiate errors and failures. If a test is written to capture a given bug, it should add to the number of failures, not the number of errors. Adding to the number of errors should happen only in the case of unexpected events, say the disk is full or a network port is already used. &lt;/p&gt;</comment>
                            <comment id="13551839" author="hustlmsp" created="Sat, 12 Jan 2013 07:07:23 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Again, I&apos;m not entirely convinced that it is a good thing to have tests like this, but if you feel we should, it is fine with me.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As my previous comments, introducing closeSubscription request for simple client would break backward compatibility. At the end of a release, I think it would be better to not break the backward compatibility. Ivan&apos;s patch seems to be a suitable solution for current situation.&lt;/p&gt;</comment>
                            <comment id="13552521" author="fpj" created="Mon, 14 Jan 2013 09:09:52 +0000"  >&lt;p&gt;I&apos;m not sure if my comment is what is preventing it from being committed. I&apos;m not against the solution, it seems good to me. All points I&apos;ve been trying to make are about the test case, not the fix itself.&lt;/p&gt;</comment>
                            <comment id="13552531" author="ikelly" created="Mon, 14 Jan 2013 09:42:56 +0000"  >&lt;p&gt;I&apos;m going to commit this as is, as there&apos;s one +1 and no -1.&lt;/p&gt;</comment>
                            <comment id="13552622" author="ikelly" created="Mon, 14 Jan 2013 12:46:41 +0000"  >&lt;p&gt;Committed as r1432902. Thanks for reviewing guys.&lt;/p&gt;</comment>
                            <comment id="13552646" author="hudson" created="Mon, 14 Jan 2013 13:14:29 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk2 #59 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk2/59/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk2/59/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-513&quot; title=&quot;TestMessageFilter fails periodically&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-513&quot;&gt;&lt;del&gt;BOOKKEEPER-513&lt;/del&gt;&lt;/a&gt;: TestMessageFilter fails periodically (ivank) (Revision 1432902)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/data/PubSubData.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/netty/impl/AbstractSubscribeResponseHandler.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/netty/impl/simple/SimpleHChannelManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-protocol/src/main/java/org/apache/hedwig/exceptions/PubSubException.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/client/TestSubAfterCloseSub.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/TestBackwardCompat.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12626175">BOOKKEEPER-533</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12563962" name="0001-BOOKKEEPER-513-TestMessageFilter-fails-periodically.patch" size="12397" author="ikelly" created="Wed, 9 Jan 2013 17:18:42 +0000"/>
                            <attachment id="12563319" name="0001-BOOKKEEPER-513-TestMessageFilter-fails-periodically.patch" size="12397" author="ikelly" created="Fri, 4 Jan 2013 16:54:44 +0000"/>
                            <attachment id="12563116" name="0001-BOOKKEEPER-513-TestMessageFilter-fails-periodically.patch" size="12489" author="ikelly" created="Thu, 3 Jan 2013 18:13:57 +0000"/>
                            <attachment id="12563336" name="BOOKKEEPER-513.diff" size="12701" author="ikelly" created="Fri, 4 Jan 2013 18:27:32 +0000"/>
                            <attachment id="12560995" name="TEST-org.apache.hedwig.server.filter.TestMessageFilter.xml" size="74620" author="ikelly" created="Fri, 14 Dec 2012 16:57:03 +0000"/>
                            <attachment id="12560999" name="TEST-org.apache.hedwig.server.persistence.MessageBoundedPersistenceTest.xml" size="40915" author="ikelly" created="Fri, 14 Dec 2012 17:25:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 20 Dec 2012 18:46:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>297912</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyyqsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>236683</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>