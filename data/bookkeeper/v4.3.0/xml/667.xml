<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:29:43 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-667/BOOKKEEPER-667.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-667] Client write will fail with BadMetadataVersion in case of multiple Bookie failures with AutoRecovery enabled</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-667</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Scenario:&lt;br/&gt;
------------&lt;br/&gt;
1. Start cluster of enough bookies, say 4, with autorecovery&lt;br/&gt;
2. Create ledger and write some entries.&lt;br/&gt;
3. Restart one of the bookies&lt;br/&gt;
4. again, write some more entries&lt;br/&gt;
5. wait for some time.. till autorecovery completes replication of first segment&lt;br/&gt;
6. Now restart one of the bookie of latest ensemble&lt;br/&gt;
7. continue to write.&lt;/p&gt;

&lt;p&gt;Here second ensemble change will fail, throwing BadMetadataVersion&lt;/p&gt;</description>
                <environment></environment>
        <key id="12662046">BOOKKEEPER-667</key>
            <summary>Client write will fail with BadMetadataVersion in case of multiple Bookie failures with AutoRecovery enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="vinayrpet">Vinayakumar B</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Aug 2013 07:29:24 +0100</created>
                <updated>Tue, 13 Aug 2013 14:11:50 +0100</updated>
                            <resolved>Tue, 13 Aug 2013 14:02:24 +0100</resolved>
                                    <version>4.2.1</version>
                                    <fixVersion>4.2.2</fixVersion>
                    <fixVersion>4.3.0</fixVersion>
                                    <component>bookkeeper-auto-recovery</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13730434" author="vinayrpet" created="Tue, 6 Aug 2013 07:34:58 +0100"  >&lt;p&gt;Adding a test to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="13730997" author="hustlmsp" created="Tue, 6 Aug 2013 18:33:40 +0100"  >&lt;p&gt;looks like you were attaching a testcase.&lt;/p&gt;</comment>
                            <comment id="13731613" author="vinayrpet" created="Wed, 7 Aug 2013 04:55:09 +0100"  >&lt;p&gt;OOPS..Sorry..  Here is the test case&lt;/p&gt;</comment>
                            <comment id="13731650" author="hustlmsp" created="Wed, 7 Aug 2013 06:15:04 +0100"  >&lt;p&gt;this issue is same as &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-112&quot; title=&quot;Bookie Recovery on an open ledger will cause LedgerHandle#close on that ledger to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-112&quot;&gt;&lt;del&gt;BOOKKEEPER-112&lt;/del&gt;&lt;/a&gt;. but after several changes, the fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-112&quot; title=&quot;Bookie Recovery on an open ledger will cause LedgerHandle#close on that ledger to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-112&quot;&gt;&lt;del&gt;BOOKKEEPER-112&lt;/del&gt;&lt;/a&gt; (removing newEnsemble before resolving new metadata) was removed and also things have changed a bit.&lt;/p&gt;

&lt;p&gt;but I think the fix would be easy but need more test cases to cover it. it should be easy to reproduce with manually recover not replying on auto-replication.&lt;/p&gt;</comment>
                            <comment id="13731672" author="vinayrpet" created="Wed, 7 Aug 2013 06:39:22 +0100"  >&lt;p&gt;Attaching patch, with updated test.&lt;/p&gt;</comment>
                            <comment id="13731691" author="hustlmsp" created="Wed, 7 Aug 2013 07:22:27 +0100"  >&lt;p&gt;your patch doesn&apos;t fix correctly, you just hide the metadata version exceptions. and as I commented previously, a test case using manual recover should reproduce this issue which not reply on automatic recovery.&lt;/p&gt;</comment>
                            <comment id="13731693" author="hustlmsp" created="Wed, 7 Aug 2013 07:26:24 +0100"  >&lt;p&gt;attach a test to fix this issue: when new metadata has one less ensemble that current metadata (the case the recovery tool modified ledger metadata at the same time that ensemble change kicks in). and we should use the ensembles in new metadata when resolving conflicts since it contains recovered bookie info.&lt;/p&gt;

&lt;p&gt;the patch is just a draft to show how to fix this issue correctly. I would improve it with more test cases (not just the test case that Vinay attached) later.&lt;/p&gt;</comment>
                            <comment id="13731826" author="hadoopqa" created="Wed, 7 Aug 2013 10:42:14 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-667&quot; title=&quot;Client write will fail with BadMetadataVersion in case of multiple Bookie failures with AutoRecovery enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-667&quot;&gt;&lt;del&gt;BOOKKEEPER-667&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12596516/BOOKKEEPER-667.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-667.diff&lt;/a&gt; downloaded at Wed Aug  7 09:15:23 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch does not add/modify any testcase&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch seems to introduce 2 new Findbugs warning(s) in module(s) &lt;span class=&quot;error&quot;&gt;&amp;#91;bookkeeper-server&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 863&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/453/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/453/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13736484" author="hustlmsp" created="Mon, 12 Aug 2013 02:52:50 +0100"  >&lt;p&gt;new patch with test case. this test case reproduce the issue with manually bookie recovery, and verify whether the ledger is fully replicated after ensemble changed.&lt;/p&gt;</comment>
                            <comment id="13736995" author="ikelly" created="Mon, 12 Aug 2013 17:18:14 +0100"  >&lt;p&gt;There&apos;s a possibility of a NoSuchElementException is #isConflictWith(), where the ensembles are different sizes (when calling keyIter.next()).&lt;/p&gt;

&lt;p&gt;I&apos;m wondering if it would be worth creating a EnsembleChange object, which is basically a tuple of &lt;span class=&quot;error&quot;&gt;&amp;#91;EntryId, IndexOfBookieToReplace, NewBookie&amp;#93;&lt;/span&gt;. Then when we get a MetadataConflict, we could reread the metadata, replace the current metadata with the newly read metadata (after all, what&apos;s in zk is the true configuration), and then reapply the EnsembleChange. I think this would be cleaner and safer than the current set of heuristics we use in resolveMetadata. &lt;/p&gt;

&lt;p&gt;Alternatively, we could leave out the NewBookie from the tuple, and choose a new bookie each time it reruns (would avoid putting the same bookie in the ensemble twice.&lt;/p&gt;</comment>
                            <comment id="13737087" author="hustlmsp" created="Mon, 12 Aug 2013 18:31:42 +0100"  >&lt;blockquote&gt;
&lt;p&gt;There&apos;s a possibility of a NoSuchElementException is #isConflictWith(), where the ensembles are different sizes (when calling keyIter.next()).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How this would happen? size is checked before iterating if you read the code.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;m wondering if it would be worth creating a EnsembleChange object, which is basically a tuple of &lt;span class=&quot;error&quot;&gt;&amp;#91;EntryId, IndexOfBookieToReplace, NewBookie&amp;#93;&lt;/span&gt;. Then when we get a MetadataConflict, we could reread the metadata, replace the current metadata with the newly read metadata (after all, what&apos;s in zk is the true configuration), and then reapply the EnsembleChange. I think this would be cleaner and safer than the current set of heuristics we use in resolveMetadata.&lt;/p&gt;

&lt;p&gt;Alternatively, we could leave out the NewBookie from the tuple, and choose a new bookie each time it reruns (would avoid putting the same bookie in the ensemble twice.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I didn&apos;t think carefully about your proposal. but in general, as this bug is marked for both 4.2.2 and 4.3.0, I would expect a simple bug fixing than refactoring. if you want to refactor this part, then do it in a separated jira only for 4.3.0.&lt;/p&gt;
</comment>
                            <comment id="13738088" author="ikelly" created="Tue, 13 Aug 2013 11:57:31 +0100"  >&lt;blockquote&gt;
&lt;p&gt;How this would happen? size is checked before iterating if you read the code.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I did the calculation backwards in my head. Looking again, it seems safe.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I didn&apos;t think carefully about your proposal. but in general, as this bug is marked for both 4.2.2 and 4.3.0, I would expect a simple bug fixing than refactoring. if you want to refactor this part, then do it in a separated jira only for 4.3.0.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;ll create a jira for this for 4.3.0. In general this patch is ok. I worry about the fact that so many special cases have been added to ledgermetadata resolution though. There seems to be something fundamentally dodgy with it. For 4.3.0 we should try to resolve this.&lt;/p&gt;</comment>
                            <comment id="13738140" author="ikelly" created="Tue, 13 Aug 2013 13:33:17 +0100"  >&lt;p&gt;Committed r1513459 in trunk.&lt;/p&gt;</comment>
                            <comment id="13738166" author="ikelly" created="Tue, 13 Aug 2013 14:02:24 +0100"  >&lt;p&gt;Committed revision 1513467 in branch-4.2&lt;/p&gt;</comment>
                            <comment id="13738172" author="hudson" created="Tue, 13 Aug 2013 14:11:50 +0100"  >&lt;p&gt;SUCCESS: Integrated in bookkeeper-trunk #322 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/322/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/322/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-667&quot; title=&quot;Client write will fail with BadMetadataVersion in case of multiple Bookie failures with AutoRecovery enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-667&quot;&gt;&lt;del&gt;BOOKKEEPER-667&lt;/del&gt;&lt;/a&gt;: Client write will fail with BadMetadataVersion in case of multiple Bookie failures with AutoRecovery enabled (sijie via ivank) (ivank: rev 1513459)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerMetadata.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12531510">BOOKKEEPER-112</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12597393" name="BOOKKEEPER-667.diff" size="10392" author="hustlmsp" created="Mon, 12 Aug 2013 02:52:50 +0100"/>
                            <attachment id="12596516" name="BOOKKEEPER-667.diff" size="6863" author="hustlmsp" created="Wed, 7 Aug 2013 07:26:24 +0100"/>
                            <attachment id="12596507" name="BOOKKEEPER-667.patch" size="6617" author="vinayrpet" created="Wed, 7 Aug 2013 06:39:22 +0100"/>
                            <attachment id="12596500" name="MetatadaConflictTest.patch" size="1823" author="vinayrpet" created="Wed, 7 Aug 2013 04:55:09 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 Aug 2013 17:33:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342050</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzgu13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342355</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>