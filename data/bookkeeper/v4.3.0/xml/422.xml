<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:32:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-422/BOOKKEEPER-422.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-422] Simplify AbstractSubscriptionManager</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-422</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;It&apos;s difficult to maintain a duplicated/cached count of local subscribers, and we&apos;ve experienced a few issues due to it getting out of sync with the actual set of subscribers. Since a count of local subscribers can be calculated from the top2sub2seq map, let&apos;s do that instead.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12610738">BOOKKEEPER-422</key>
            <summary>Simplify AbstractSubscriptionManager</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stuhood">Stu Hood</assignee>
                                    <reporter username="stuhood">Stu Hood</reporter>
                        <labels>
                    </labels>
                <created>Sun, 7 Oct 2012 04:08:52 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:52 +0000</updated>
                            <resolved>Wed, 17 Oct 2012 10:21:04 +0100</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                    <component>hedwig-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13472537" author="fpj" created="Tue, 9 Oct 2012 18:01:54 +0100"  >&lt;p&gt;It mostly looks good to me. The only comment I have is that this patch removes this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    Callback&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; noopCallback = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoopCallback&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;();
-
-    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; class NoopCallback&amp;lt;T&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Callback&amp;lt;T&amp;gt; {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and similar patterns are used in ConsumerHandler and ChannelTracker. Should we consider making similar changes there too and perhaps in a separate jira just so that we don&apos;t mix the issues?&lt;/p&gt;</comment>
                            <comment id="13472822" author="stuhood" created="Tue, 9 Oct 2012 23:46:50 +0100"  >&lt;p&gt;Updated patch to remove the static NoopCallback... it&apos;s not a big deal in this context, and probably not worth creating a ticket about.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13473039" author="hustlmsp" created="Wed, 10 Oct 2012 08:03:31 +0100"  >&lt;p&gt;I am not sure this change does better, since each time #hasLocalSubscriptions needs to go thru all the subscriptions. if sub/unsub isn&apos;t frequent, it might be OK. If not, we need to take care that whether it would be a problem or not.&lt;/p&gt;</comment>
                            <comment id="13473063" author="stuhood" created="Wed, 10 Oct 2012 08:44:36 +0100"  >&lt;blockquote&gt;&lt;p&gt;I am not sure this change does better, since each time #hasLocalSubscriptions needs to go thru all the subscriptions.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The javadoc on that method explains that it exits as soon as it finds a non-local subscription, which should be very, very quickly (unless cross-region subscribers vastly outnumber local subscribers.)&lt;/p&gt;</comment>
                            <comment id="13473122" author="hustlmsp" created="Wed, 10 Oct 2012 10:27:21 +0100"  >&lt;p&gt;thanks Stu for clarify. lgtm. could you generate a new patch with 4-spaces indent? I saw some places are two spaces indent.&lt;/p&gt;</comment>
                            <comment id="13473232" author="fpj" created="Wed, 10 Oct 2012 14:57:12 +0100"  >&lt;p&gt;I don&apos;t mean to complicate this patch, but I was wondering if it makes sense to split the subscription state into local and non-local. This way #hasLocalSubscriptions can be implemented efficiently and it would be independent of assumptions about the distribution of subscriptions. One way would be to split top2sub2seq into two data structures, one for local and one for non-local. &lt;/p&gt;

&lt;p&gt;Even though Stu&apos;s argument makes sense, we may end up hitting corner cases and if we can avoid them altogether, better for us.&lt;/p&gt;

&lt;p&gt;Let me know if you guys think it makes sense.&lt;/p&gt;</comment>
                            <comment id="13473538" author="stuhood" created="Wed, 10 Oct 2012 21:39:51 +0100"  >&lt;blockquote&gt;&lt;p&gt;One way would be to split top2sub2seq into two data structures, one for local and one for non-local.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Unless the number of regions begins to get into the thousands this will not be necessary for performance reasons.&lt;/p&gt;

&lt;p&gt;And in terms of clarity, I&apos;m thinking that the long term direction will be that we have a subscriber-specific data structure of some kind which would make the string parsing unnecessary, and further clarify the &apos;hasLocalSubscriptions&apos; call. So, IMO: splitting the map before we really need to would be premature.&lt;/p&gt;</comment>
                            <comment id="13473539" author="stuhood" created="Wed, 10 Oct 2012 21:40:21 +0100"  >&lt;p&gt;Patch updated with whitespace fixes.&lt;/p&gt;</comment>
                            <comment id="13473618" author="fpj" created="Wed, 10 Oct 2012 23:19:21 +0100"  >&lt;p&gt;sounds good, +1.&lt;/p&gt;</comment>
                            <comment id="13474008" author="hustlmsp" created="Thu, 11 Oct 2012 11:05:36 +0100"  >&lt;p&gt;if a hub server owns millions of topics, each topic has one local subscribers and 3 non-local subscribers, each time #hasLocalSubscriptions needs go thru 4 subscribers to lookup one. but it might be a problem although. I was thinking if it is possibile to change HashMap (used to store subscribers) to SortedMap, so we could cluster non-local subscribers together since they are started with underscore. it might help improving at some case.&lt;/p&gt;

&lt;p&gt;Besides this jira, I just found that it seems we don&apos;t validate the subscriber id. If a local subscriber provides a subscriber id prefixed with underscore, it might be treated as a non-local subscriber. it might be a problem. If it is a problem, we need a separated jira for it.&lt;/p&gt;</comment>
                            <comment id="13475068" author="fpj" created="Fri, 12 Oct 2012 16:26:11 +0100"  >&lt;p&gt;It sounds like a good idea to me to use a SortedMap, Sijie. Do you see a problem with doing it, Stu?&lt;/p&gt;

&lt;p&gt;It also sounds like a good idea to validate the subscriber id as you point out, Sijie. It should be a separate jira as you suggest.&lt;/p&gt;</comment>
                            <comment id="13476078" author="stuhood" created="Mon, 15 Oct 2012 11:44:11 +0100"  >&lt;p&gt;I think that the SortedMap would be premature... as mentioned above, I think we&apos;d be better off distinguishing between subscriber types via fields on some new Subscriber object, which could additionally allow for the namespacing needed for &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-433&quot; title=&quot;Validate subscriber id for subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-433&quot;&gt;BOOKKEEPER-433&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13476082" author="fpj" created="Mon, 15 Oct 2012 12:12:19 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think that the SortedMap would be premature&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How do you feel about committing this patch and changing to a SortedMap later if it becomes a bottleneck, Sijie? Is it going to affect your applications if we have this in?&lt;/p&gt;</comment>
                            <comment id="13476097" author="hustlmsp" created="Mon, 15 Oct 2012 13:12:35 +0100"  >&lt;p&gt;I am OK with this patch. +1.&lt;/p&gt;</comment>
                            <comment id="13477724" author="fpj" created="Wed, 17 Oct 2012 10:21:04 +0100"  >&lt;p&gt;Thanks, Stu. Committed revision 1399159.&lt;/p&gt;</comment>
                            <comment id="13477790" author="hudson" created="Wed, 17 Oct 2012 12:33:21 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #757 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/757/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/757/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-422&quot; title=&quot;Simplify AbstractSubscriptionManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-422&quot;&gt;&lt;del&gt;BOOKKEEPER-422&lt;/del&gt;&lt;/a&gt;: Simplify AbstractSubscriptionManager (stu via fpj) (Revision 1399159)&lt;/p&gt;

&lt;p&gt;     Result = UNSTABLE&lt;br/&gt;
fpj : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/AbstractSubscriptionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548627" name="bk-422.diff" size="9680" author="stuhood" created="Wed, 10 Oct 2012 21:40:21 +0100"/>
                            <attachment id="12548486" name="bk-422.diff" size="9680" author="stuhood" created="Tue, 9 Oct 2012 23:46:50 +0100"/>
                            <attachment id="12548144" name="bk-422.diff" size="10416" author="stuhood" created="Sun, 7 Oct 2012 04:09:39 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 9 Oct 2012 17:01:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244906</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzpsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32162</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>