<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-177/BOOKKEEPER-177.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-177] Index file is lost or some index pages aren&apos;t flushed.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-177</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;we found that some index files are lost ore some index pages aren&apos;t flushed after applying &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt; patch.&lt;/p&gt;

&lt;p&gt;this issue can be reproduced by following sequence.&lt;/p&gt;

&lt;p&gt;index file missing:&lt;/p&gt;

&lt;p&gt;1) create ledger 1 without writing any entries&lt;br/&gt;
2) open ledger 1 which causes a recoveryRead entry(0) sent to bookie server. then an empty page is put in pageTable by mistake as below. (we should call updatePage first to check whether bookie server has this ledger)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                 &lt;span class=&quot;code-comment&quot;&gt;// in ledgerCache#getEntryOffset
&lt;/span&gt;                 lep = grabCleanPage(ledger, pageEntry);
                 &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
                     putIntoTable(pages, lep);
                 }
                 updatePage(lep);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3) open ledger 2 to write serval entries. a meta entry and several data entries would be put in journal.&lt;br/&gt;
4) SyncThread executes to flush ledger. it first flush ledger 1, although ledger 1 has an empty page which is clean, but the code still need to call #getFileInfo, which will cause an NoLedgerException fail the flush. unfortunately, the SyncThread caught this exception and just output an error message then rollLog. the result is ledger 2 is not flushed, and its journal entries would not be replayed after restarted.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                 lastLogMark.markLog();
 
                 &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                     ledgerCache.flushLedger(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                 } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                     LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception flushing Ledger&quot;&lt;/span&gt;, e);
                 }
                 &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                     entryLogger.flush();
                 } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                     LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception flushing entry logger&quot;&lt;/span&gt;, e);
                 }
 
                 lastLogMark.rollLog();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;similar case for some index pages are not flushed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12543835">BOOKKEEPER-177</key>
            <summary>Index file is lost or some index pages aren&apos;t flushed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Feb 2012 13:11:53 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:17 +0100</updated>
                            <resolved>Fri, 24 Feb 2012 18:09:41 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13214618" author="hustlmsp" created="Thu, 23 Feb 2012 13:16:22 +0000"  >&lt;p&gt;add two test cases to reproduce the issues, one is index file lost, the other one is some index pages are not flushed.&lt;/p&gt;</comment>
                            <comment id="13214626" author="jiraposter@reviews.apache.org" created="Thu, 23 Feb 2012 13:23:47 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/4016/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4016/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;we found that some index files are lost ore some index pages aren&apos;t flushed after applying &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt; patch.&lt;/p&gt;

&lt;p&gt;this issue can be reproduced by following sequence.&lt;/p&gt;

&lt;p&gt;index file missing:&lt;/p&gt;

&lt;p&gt;1) create ledger 1 without writing any entries&lt;br/&gt;
2) open ledger 1 which causes a recoveryRead entry(0) sent to bookie server. then an empty page is put in pageTable by mistake as below. (we should call updatePage first to check whether bookie server has this ledger)&lt;/p&gt;

&lt;p&gt;// in ledgerCache#getEntryOffset&lt;br/&gt;
                 lep = grabCleanPage(ledger, pageEntry);&lt;br/&gt;
                 synchronized(this) &lt;/p&gt;
{
                     putIntoTable(pages, lep);
                 }
&lt;p&gt;                 updatePage(lep);&lt;br/&gt;
3) open ledger 2 to write serval entries. a meta entry and several data entries would be put in journal.&lt;br/&gt;
4) SyncThread executes to flush ledger. it first flush ledger 1, although ledger 1 has an empty page which is clean, but the code still need to call #getFileInfo, which will cause an NoLedgerException fail the flush. unfortunately, the SyncThread caught this exception and just output an error message then rollLog. the result is ledger 2 is not flushed, and its journal entries would not be replayed after restarted.&lt;/p&gt;

&lt;p&gt;lastLogMark.markLog();&lt;/p&gt;

&lt;p&gt;                 try &lt;/p&gt;
{
                     ledgerCache.flushLedger(true);
                 }
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
                     LOG.error(&quot;Exception flushing Ledger&quot;, e);
                 }
&lt;p&gt;                 try &lt;/p&gt;
{
                     entryLogger.flush();
                 }
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
                     LOG.error(&quot;Exception flushing entry logger&quot;, e);
                 }

&lt;p&gt;                 lastLogMark.rollLog();&lt;br/&gt;
similar case for some index pages are not flushed.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-177&quot; title=&quot;Index file is lost or some index pages aren&amp;#39;t flushed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-177&quot;&gt;&lt;del&gt;BOOKKEEPER-177&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-177&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-177&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java d4ece94 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 3e96d46 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 9da4aec &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java 6bbe943 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/IndexCorruptionTest.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/4016/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4016/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Sijie&lt;/p&gt;
</comment>
                            <comment id="13214628" author="hustlmsp" created="Thu, 23 Feb 2012 13:24:50 +0000"  >&lt;p&gt;attach a patch to fix this issue. also move flush single ledger logic into a function which makes flush logic more readable. &lt;/p&gt;</comment>
                            <comment id="13215782" author="ikelly" created="Fri, 24 Feb 2012 18:09:41 +0000"  >&lt;p&gt;Committed as r1293369. Great work Sijie!&lt;/p&gt;</comment>
                            <comment id="13215805" author="hudson" created="Fri, 24 Feb 2012 18:46:01 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #375 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/375/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/375/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-177&quot; title=&quot;Index file is lost or some index pages aren&amp;#39;t flushed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-177&quot;&gt;&lt;del&gt;BOOKKEEPER-177&lt;/del&gt;&lt;/a&gt;: Index file is lost or some index pages aren&apos;t flushed. (sijie via ivank) (Revision 1293369)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/IndexCorruptionTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12515749" name="BK-177.patch" size="19941" author="hustlmsp" created="Thu, 23 Feb 2012 13:24:50 +0000"/>
                            <attachment id="12515748" name="IndexCorruptionTest.java" size="5199" author="hustlmsp" created="Thu, 23 Feb 2012 13:16:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 23 Feb 2012 13:23:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>229074</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4ryn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61686</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>