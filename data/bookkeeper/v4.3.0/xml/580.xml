<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-580/BOOKKEEPER-580.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-580] improve close logic</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-580</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;currently, bookkeeper client still write ledger metadata to metadata storage even the metadata is already closed or undergoing closing. which would cause lots of bad version metadata update encountering unrecoverable errors in ledger handle. e.g. NotEnoughtBookiesException.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12634361">BOOKKEEPER-580</key>
            <summary>improve close logic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Feb 2013 05:59:21 +0000</created>
                <updated>Fri, 23 Aug 2013 18:26:36 +0100</updated>
                            <resolved>Fri, 23 Aug 2013 18:20:28 +0100</resolved>
                                                    <fixVersion>4.2.2</fixVersion>
                    <fixVersion>4.3.0</fixVersion>
                                    <component>bookkeeper-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13588098" author="hustlmsp" created="Wed, 27 Feb 2013 08:05:28 +0000"  >&lt;p&gt;attach a patch for it&lt;/p&gt;</comment>
                            <comment id="13588124" author="hadoopqa" created="Wed, 27 Feb 2013 08:40:57 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-580&quot; title=&quot;improve close logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-580&quot;&gt;&lt;del&gt;BOOKKEEPER-580&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12571159/BOOKKEEPER-580.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-580.diff&lt;/a&gt; downloaded at Wed Feb 27 08:10:46 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 4 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 817&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/282/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/282/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13593672" author="rakeshr" created="Tue, 5 Mar 2013 17:57:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;bookkeeper client still write ledger metadata to metadata storage even the metadata is already closed or undergoing closing. which would cause lots of bad version metadata update encountering unrecoverable errors in ledger handle. e.g. NotEnoughtBookiesException&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hustlmsp&quot; class=&quot;user-hover&quot; rel=&quot;hustlmsp&quot;&gt;Sijie Guo&lt;/a&gt; If you could attach the log details, it would be helpful. I&apos;m interested to know how NotEnoughtBookiesException occuring due to close/closing. Our existing #close() call is idempotent in nature, isn&apos;t it.&lt;br/&gt;
Am I missing anything?&lt;/p&gt;</comment>
                            <comment id="13593704" author="hustlmsp" created="Tue, 5 Mar 2013 18:19:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt; I said bad version updates after encountering NotEnoughBookies, not NotEnoughBookies during closing.&lt;/p&gt;

&lt;p&gt;please read the logic: Lost of PendingAdds failed at same time =&amp;gt; Lots of LedgerHandle#handleUnrecoverableErrors (in parallel) =&amp;gt; Lots of LedgerHandle#closeInternal (in parallel) =&amp;gt; Lots of metadata updates (in parallel) =&amp;gt; metadata version conflictions.&lt;/p&gt;</comment>
                            <comment id="13593831" author="rakeshr" created="Tue, 5 Mar 2013 19:51:46 +0000"  >&lt;p&gt;Yeah &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hustlmsp&quot; class=&quot;user-hover&quot; rel=&quot;hustlmsp&quot;&gt;Sijie Guo&lt;/a&gt;. got it.&lt;/p&gt;

&lt;p&gt;Thanks for the patch, just few thoughts:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Could you please remove following java comments from #asyncCloseInternal() api, as now introducing meta.isClosed() check.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Close operation is idempotent, so no need to check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// already closed&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There is an unncessary import in LedgerHandle.java. Anyway we are touching the file, it would be good to remove the unnecessary import also&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
      import org.apache.bookkeeper.client.BKException.BKNotEnoughBookiesException;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In the patch, I&apos;ve seen #isClosed() checks in two places: first before submitting, also another one inside the SafeRunnable thread. I agree, there is no functional issue. Do we need double check?, I feel we can have only one which is inside the SafeRunnable.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (metadata.isClosed()) {
+                cb.closeComplete(BKException.Code.LedgerClosedException, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, ctx);
+                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
+            }
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13593915" author="hustlmsp" created="Tue, 5 Mar 2013 21:08:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;&amp;gt; There is an unncessary import in LedgerHandle.java.&lt;/p&gt;

&lt;p&gt;I could not be noticed since I used vim rather than an IDE. I think we should integrate checkstyle rather than ask someone to remove unnecessary imports by comments.&lt;/p&gt;

&lt;p&gt;&amp;gt; Do we need double check?, I feel we can have only one which is inside the SafeRunnable. &lt;/p&gt;

&lt;p&gt;I don&apos;t want to let lots of runnables propagated during failures, it might cause memory issue during a high throughput case. &lt;/p&gt;</comment>
                            <comment id="13593923" author="hustlmsp" created="Tue, 5 Mar 2013 21:17:07 +0000"  >&lt;p&gt;remove mismatch comments in #asyncCloseInternal, remove unnecessary imports. &lt;/p&gt;</comment>
                            <comment id="13593967" author="hadoopqa" created="Tue, 5 Mar 2013 21:59:35 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-580&quot; title=&quot;improve close logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-580&quot;&gt;&lt;del&gt;BOOKKEEPER-580&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12572167/BOOKKEEPER-580.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-580.diff&lt;/a&gt; downloaded at Tue Mar  5 21:29:29 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 4 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 817&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/284/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/284/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13594066" author="fpj" created="Tue, 5 Mar 2013 23:06:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we should integrate checkstyle &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, sounds like a good idea to use checkstyle.&lt;/p&gt;</comment>
                            <comment id="13594351" author="rakeshr" created="Wed, 6 Mar 2013 04:33:01 +0000"  >&lt;p&gt;Its nice to bring checkstyle.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t want to let lots of runnables propagated during failures, it might cause memory issue during a high throughput case.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Fine, make sense to me.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hustlmsp&quot; class=&quot;user-hover&quot; rel=&quot;hustlmsp&quot;&gt;Sijie Guo&lt;/a&gt; for the fix. +1 for the latest patch.&lt;/p&gt;</comment>
                            <comment id="13598664" author="fpj" created="Mon, 11 Mar 2013 09:20:26 +0000"  >&lt;p&gt;Hi Sijie, I agree with the goal of not executing close operations unnecessarily, but I wonder why not return OK rather than LedgerClosedException. &lt;/p&gt;

&lt;p&gt;I&apos;m not sure why you have removed the call to close in BookieRecoveryTest.&lt;/p&gt;

&lt;p&gt;About changing the exception caught in the following: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-        } catch (BKException.BKMetadataVersionException e) {
+        } catch (BKException.BKLedgerClosedException e) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;We can still get metadata version exceptions in the case of concurrent attempts to close a ledger with different clients (distinct ledger handlers). In fact, I thought this was the case with TestFencing, so I&apos;m wondering why it is correct to replace the exception like that.&lt;/p&gt;

&lt;p&gt;One other suggestion is to add comments describing why we need to check if the ledger is closed in those two places. These checks are there mostly for performance reasons, and for correctness I believe we don&apos;t need them, so it would be good to have some reminders there for us.&lt;/p&gt;
</comment>
                            <comment id="13599716" author="hustlmsp" created="Tue, 12 Mar 2013 05:22:23 +0000"  >&lt;p&gt;&amp;gt; but I wonder why not return OK rather than LedgerClosedException. &lt;/p&gt;

&lt;p&gt;I just want to make the return code clearly to tell what happened.&lt;/p&gt;

&lt;p&gt;&amp;gt; I&apos;m not sure why you have removed the call to close in BookieRecoveryTest.&lt;/p&gt;

&lt;p&gt;since the ledger handle is already closed. we don&apos;t need to close it again.&lt;/p&gt;

&lt;p&gt;&amp;gt; In fact, I thought this was the case with TestFencing, so I&apos;m wondering why it is correct to replace the exception like that.&lt;/p&gt;

&lt;p&gt;since closeLedgers is closed before recovering, so the ledger handles are already closed. closing them again is supposed to return LedgerClosedException. we don&apos;t get metadata version exception anymore. It is based on the new behavior to change that exception.&lt;/p&gt;

&lt;p&gt;&amp;gt; One other suggestion is to add comments describing why we need to check if the ledger is closed in those two places.&lt;/p&gt;

&lt;p&gt;I could do it if the above comments make sense for you.&lt;/p&gt;</comment>
                            <comment id="13619861" author="ikelly" created="Tue, 2 Apr 2013 15:41:01 +0100"  >&lt;p&gt;Why are we throwing an exception if a ledger is closed already? Closing a ledger should be an idempotent operation, so closing an already closed ledger shouldn&apos;t violate any of the assumptions the client has about the ledger handle.&lt;/p&gt;</comment>
                            <comment id="13699001" author="ikelly" created="Wed, 3 Jul 2013 15:14:14 +0100"  >&lt;p&gt;Rebased to trunk (just had to fiddle with some import changes). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hustlmsp&quot; class=&quot;user-hover&quot; rel=&quot;hustlmsp&quot;&gt;Sijie Guo&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt; Could we agree on what we do for a double invocation of close()? My opinion is that if we try to close an already closed handle, it should proceed with ok, as it doesn&apos;t change any assumptions on the state of the ledger.&lt;/p&gt;

&lt;p&gt;I&apos;d like to get this into 4.2.2 &lt;/p&gt;</comment>
                            <comment id="13699183" author="hustlmsp" created="Wed, 3 Jul 2013 18:06:11 +0100"  >&lt;p&gt;I would make a change to not let sync version not throw exception on LedgerClosedException, but still expose the LedgerClosedException to callback version, so the user who want to identify the reason, it knows what happened. Is it OK for you guys?&lt;/p&gt;</comment>
                            <comment id="13700144" author="ikelly" created="Thu, 4 Jul 2013 16:29:17 +0100"  >&lt;p&gt;We should only inform the user of the exception if the user can take useful action as a result, (i.e. do something different with regard to that ledger).&lt;/p&gt;

&lt;p&gt;The user should only do something different it&apos;s view of the ledger is different after the close call, to what it was before the close call, specifically that the LAC is different. I &lt;em&gt;think&lt;/em&gt; that fencing prevents this, but I need to think about it some more. If I can find a case that this is not true, then definitely we should have an exception (or maybe a read to check the last add confirmed of the closed metadata matches what the local handle has).&lt;/p&gt;

&lt;p&gt;I think the async and sync behaviour should be consistent though. Feels wrong to have the same api return a different result depending on how you call it.&lt;/p&gt;</comment>
                            <comment id="13700174" author="ikelly" created="Thu, 4 Jul 2013 17:07:36 +0100"  >&lt;p&gt;I had another look at the patch. The check is only protecting against 2 local calls of close(), fencing doesn&apos;t even come into it. The fencing case is handled in LedgerMetadata#resolveConflict(). The only justification for changing this for 2+ local calls would be to flag an error to the user. I don&apos;t think this is strong enough of a justification for a compatibility break though.&lt;/p&gt;</comment>
                            <comment id="13746489" author="ikelly" created="Wed, 21 Aug 2013 16:43:45 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hustlmsp&quot; class=&quot;user-hover&quot; rel=&quot;hustlmsp&quot;&gt;Sijie Guo&lt;/a&gt;, could we get a conclusion on this? This is the last JIRA without a clear solution for 4.2.2&lt;/p&gt;</comment>
                            <comment id="13746584" author="hustlmsp" created="Wed, 21 Aug 2013 18:15:21 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ikelly&quot; class=&quot;user-hover&quot; rel=&quot;ikelly&quot;&gt;Ivan Kelly&lt;/a&gt; it would be better to have a place to tell the client what happened to a ledger handle. the only thing I could image is through the rc code in call back. for sync version, we keep it not throw exception when a ledger is already closed. &lt;/p&gt;

&lt;p&gt;but I don&apos;t feel strong about this part. if you think we don&apos;t need to tell the client about ledger already closed, I am OK with that.&lt;/p&gt;</comment>
                            <comment id="13747418" author="ikelly" created="Thu, 22 Aug 2013 11:41:32 +0100"  >&lt;p&gt;I&apos;ve changed the patch to complete with OK if the metadata is already closed. Its better to be backwards compatible in this case, and consistent between the async and sync versions. I did have to update one test, TestFencing, to not expect an exception any more, when another client has closed the ledger. This is fine though, as the LAC will be the same in the opening client and the closing client. No assumption has changed for the user. They will be notified of the fencing by the failure of the #addEntry call. If there is an incompatibility in the metadata (client has a lower LAC to what was closed with), LedgerMetadata#isConflictWith will catch it on the reread.&lt;/p&gt;</comment>
                            <comment id="13747432" author="hadoopqa" created="Thu, 22 Aug 2013 12:08:32 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-580&quot; title=&quot;improve close logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-580&quot;&gt;&lt;del&gt;BOOKKEEPER-580&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12599409/0001-BOOKKEEPER-580-improve-close-logic.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-580-improve-close-logic.patch&lt;/a&gt; downloaded at Thu Aug 22 10:41:17 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 885&lt;br/&gt;
.    Tests failed: 7&lt;br/&gt;
.    Tests errors: 9&lt;/p&gt;

&lt;p&gt;.    The patch failed the following testcases:&lt;/p&gt;

&lt;p&gt;.      testSyncUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncHubSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncHubSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncHubUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncHubUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testPublishWithBookKeeperError&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/470/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/470/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13747465" author="ikelly" created="Thu, 22 Aug 2013 13:10:53 +0100"  >&lt;p&gt;Rekicking build, as the failures seem to be something unrelated. Hedwig losing connection to ZK. Could be an tcp port conflict.&lt;/p&gt;</comment>
                            <comment id="13747476" author="hadoopqa" created="Thu, 22 Aug 2013 13:37:08 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-580&quot; title=&quot;improve close logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-580&quot;&gt;&lt;del&gt;BOOKKEEPER-580&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12599409/0001-BOOKKEEPER-580-improve-close-logic.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-580-improve-close-logic.patch&lt;/a&gt; downloaded at Thu Aug 22 12:10:06 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 877&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/471/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/471/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13748269" author="hustlmsp" created="Fri, 23 Aug 2013 05:17:40 +0100"  >&lt;p&gt;+1 for the patch. thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ikelly&quot; class=&quot;user-hover&quot; rel=&quot;ikelly&quot;&gt;Ivan Kelly&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13748699" author="ikelly" created="Fri, 23 Aug 2013 17:49:27 +0100"  >&lt;p&gt;Committed r1516929 to trunk.&lt;/p&gt;</comment>
                            <comment id="13748734" author="ikelly" created="Fri, 23 Aug 2013 18:20:28 +0100"  >&lt;p&gt;Committed revision 1516938 to branch-4.2&lt;/p&gt;</comment>
                            <comment id="13748744" author="hudson" created="Fri, 23 Aug 2013 18:26:36 +0100"  >&lt;p&gt;SUCCESS: Integrated in bookkeeper-trunk #337 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/337/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/337/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-580&quot; title=&quot;improve close logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-580&quot;&gt;&lt;del&gt;BOOKKEEPER-580&lt;/del&gt;&lt;/a&gt;: improve close logic (sijie &amp;amp; ivank via ivank) (ivank: rev 1516929)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestFencing.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12599409" name="0001-BOOKKEEPER-580-improve-close-logic.patch" size="3014" author="ikelly" created="Thu, 22 Aug 2013 11:34:55 +0100"/>
                            <attachment id="12590634" name="0001-BOOKKEEPER-580-improve-close-logic.patch" size="9333" author="ikelly" created="Wed, 3 Jul 2013 15:14:14 +0100"/>
                            <attachment id="12572167" name="BOOKKEEPER-580.diff" size="9434" author="hustlmsp" created="Tue, 5 Mar 2013 21:17:07 +0000"/>
                            <attachment id="12571159" name="BOOKKEEPER-580.diff" size="8144" author="hustlmsp" created="Wed, 27 Feb 2013 08:05:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Feb 2013 08:40:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314854</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzc6kv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315198</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>