<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:37 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-242/BOOKKEEPER-242.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-242] Bookkeeper not able to connect other zookeeper when shutdown the zookeeper server where the BK has connected.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-242</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Scenario : &lt;br/&gt;
1. Start three zookeeper cluster.&lt;br/&gt;
2. start three bookKeeper.&lt;br/&gt;
3. shutdown zookeeper server where bookkeeper has connected.&lt;/p&gt;

&lt;p&gt;Expected Result:&lt;br/&gt;
bookkeeper should be able to connect other zookeeper&lt;/p&gt;

&lt;p&gt;Actual Result :&lt;br/&gt;
All three bookkeepers retry to connect zookeeper node which has been shutdown.&lt;/p&gt;



&lt;p&gt;BookKeeper log for Retry :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
2012-04-25 13:35:15,319 - WARN  [main-EventThread:Bookie$2@456] - ZK client has been disconnected to the ZK server!
2012-04-25 13:35:17,194 - INFO  [main-SendThread(HOST-10-18-40-91:2181):ClientCnxn$SendThread@933] - Opening socket connection to server HOST-10-18-40-91/10.18.40.91:2181
2012-04-25 13:35:17,196 - WARN  [main-SendThread(HOST-10-18-40-91:2181):ClientCnxn$SendThread@1063] - Session 0x136e87b50ce0002 for server null, unexpected error, closing socket connection and attempting reconnect
java.net.ConnectException: Connection refused
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:567)
	at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:264)
	at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1041)
2012-04-25 13:35:19,125 - INFO  [main-SendThread(HOST-10-18-40-91:2181):ClientCnxn$SendThread@933] - Opening socket connection to server HOST-10-18-40-91/10.18.40.91:2181
2012-04-25 13:35:19,126 - WARN  [main-SendThread(HOST-10-18-40-91:2181):ClientCnxn$SendThread@1063] - Session 0x136e87b50ce0002 for server null, unexpected error, closing socket connection and attempting reconnect
java.net.ConnectException: Connection refused
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:567)
	at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:264)
	at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1041)
2012-04-25 13:35:20,276 - INFO  [main-SendThread(HOST-10-18-40-91:2181):ClientCnxn$SendThread@933] - Opening socket connection to server HOST-10-18-40-91/10.18.40.91:2181
2012-04-25 13:35:20,277 - WARN  [main-SendThread(HOST-10-18-40-91:2181):ClientCnxn$SendThread@1063] - Session 0x136e87b50ce0002 for server null, unexpected error, closing socket connection and attempting reconnect
java.net.ConnectException: Connection refused
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:567)
	at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:264)
	at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1041)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </description>
                <environment></environment>
        <key id="12554300">BOOKKEEPER-242</key>
            <summary>Bookkeeper not able to connect other zookeeper when shutdown the zookeeper server where the BK has connected.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="surendrasingh">surendra singh lilhore</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 May 2012 10:50:28 +0100</created>
                <updated>Mon, 22 Oct 2012 15:50:15 +0100</updated>
                            <resolved>Wed, 9 May 2012 09:18:43 +0100</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13270344" author="rakeshr" created="Tue, 8 May 2012 11:01:32 +0100"  >&lt;p&gt;ServerConfiguration is a type of &apos;org.apache.commons.configuration.CompositeConfiguration&apos; and for parsing the list of comma separated values, we need to use config.getStringArray() or config.getList(). &lt;/p&gt;

&lt;p&gt;But it is using getString() and I think that is the reason not retrying to the cluster when the connected ZK is down. From the logs, its trying only HOST-10-18-40-91/10.18.40.91:2181&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public String getZkServers() {
        return getString(ZK_SERVERS, null);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;-Rakesh&lt;/p&gt;</comment>
                            <comment id="13270353" author="hustlmsp" created="Tue, 8 May 2012 11:28:34 +0100"  >&lt;p&gt;@Rakesh&lt;/p&gt;

&lt;p&gt;I don&apos;t think we need to parse the list of comma separated values. because, ZooKeeper client would handle it when constructing a ZooKeeper object. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://zookeeper.apache.org/doc/r3.4.3/api/org/apache/zookeeper/ZooKeeper.html#ZooKeeper(java.lang.String&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://zookeeper.apache.org/doc/r3.4.3/api/org/apache/zookeeper/ZooKeeper.html#ZooKeeper(java.lang.String&lt;/a&gt;, int, org.apache.zookeeper.Watcher) &lt;/p&gt;

&lt;p&gt;@surendra&lt;/p&gt;

&lt;p&gt;could you tell more about your configuration about ZK_SERVERS ?&lt;/p&gt;
</comment>
                            <comment id="13270361" author="rakeshr" created="Tue, 8 May 2012 12:00:43 +0100"  >&lt;p&gt;@Sijie&lt;br/&gt;
&lt;b&gt;getString(ZK_SERVERS, null); is returning only the first server ip:port and ignoring values after the comma&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Say, configured as zkServers=zk1:2181,zk2:2181,zk3:2181&lt;br/&gt;
In ServerConfiguration, it is using getString(ZK_SERVERS, null) and returning only the first zk1:2181 and the same is passing to the ZK client. Here it is missing the other two &apos;zk2:2181,zk3:2181&apos; values.&lt;/p&gt;</comment>
                            <comment id="13270376" author="surendrasingh" created="Tue, 8 May 2012 12:35:45 +0100"  >&lt;p&gt;Thanks for looking into this.&lt;/p&gt;

&lt;p&gt;@Sijie&lt;br/&gt;
I have 3 ZK servers and configured like:&lt;br/&gt;
zkServers=10.18.40.155:2181,10.18.40.155:2182,10.18.40.155:2183&lt;/p&gt;

&lt;p&gt;-Surendra&lt;/p&gt;</comment>
                            <comment id="13270490" author="hustlmsp" created="Tue, 8 May 2012 15:35:57 +0100"  >&lt;p&gt;@Rakesh&lt;/p&gt;

&lt;p&gt;Got it. Thanks for pointing out this issue.&lt;/p&gt;</comment>
                            <comment id="13270507" author="hustlmsp" created="Tue, 8 May 2012 15:57:55 +0100"  >&lt;p&gt;attach a patch to fix getZkServers issue. thanks Rakesh for help.&lt;/p&gt;</comment>
                            <comment id="13270520" author="rakeshr" created="Tue, 8 May 2012 16:08:14 +0100"  >&lt;p&gt;Hi Sijie, I have few suggestions:&lt;/p&gt;


&lt;p&gt;&lt;b&gt;comment-1)&lt;/b&gt; getStringArray() internally using getList() and preparing array of string. Instead can we directly use getList()?&lt;/p&gt;


&lt;p&gt;&lt;b&gt;comment-2)&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+            sb.append(servers[i]);
+            if (i &amp;lt; servers.length - 1) {
+                sb.append(&quot;,&quot;);
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;instead of this can we use like, &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  if( sb.length() &amp;gt; 0 ){
     sb.append(&quot;,&quot;);
  }
  sb.append(servers[i]);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;-Rakesh&lt;/p&gt;</comment>
                            <comment id="13270558" author="ikelly" created="Tue, 8 May 2012 16:42:15 +0100"  >&lt;p&gt;This is very similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-171&quot; title=&quot;ServerConfiguration can&amp;#39;t use more than one directory for ledgers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-171&quot;&gt;&lt;del&gt;BOOKKEEPER-171&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;I suggest we use the first Rakesh is suggesting, but instead of manually doing the string stuff, use StringUtils#join &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. Internally the client configuration should store the list as a String[]&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/bookkeeper/commit/3defe9e5110472da995789b5ae14c286f58f1293&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/bookkeeper/commit/3defe9e5110472da995789b5ae14c286f58f1293&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://commons.apache.org/lang/api-2.5/org/apache/commons/lang/StringUtils.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://commons.apache.org/lang/api-2.5/org/apache/commons/lang/StringUtils.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13270559" author="ikelly" created="Tue, 8 May 2012 16:42:49 +0100"  >&lt;p&gt;Making this a blocker as it seriously affects availability.&lt;/p&gt;</comment>
                            <comment id="13270561" author="ikelly" created="Tue, 8 May 2012 16:44:50 +0100"  >&lt;p&gt;Ah, i hadn&apos;t spotted there was already a patch. Could you change it to use StringUtils#join. I&apos;ll push it in then.&lt;/p&gt;</comment>
                            <comment id="13271089" author="rakeshr" created="Wed, 9 May 2012 05:44:42 +0100"  >&lt;p&gt;Yeah Ivan, StringUtils.join(servers, &apos;,&apos;) would do the stuff and pretty simple.&lt;/p&gt;

&lt;p&gt;Also, its good practise(improve readability) to provide message in test assertions like, assertEquals( message, expected, actual)&lt;/p&gt;</comment>
                            <comment id="13271112" author="hustlmsp" created="Wed, 9 May 2012 06:30:43 +0100"  >&lt;p&gt;attach a new patch addressed Ivan and Rakesh&apos;s suggestion. thanks all.&lt;/p&gt;</comment>
                            <comment id="13271204" author="ikelly" created="Wed, 9 May 2012 09:18:44 +0100"  >&lt;p&gt;Committed as r1335973. Thanks Rakesh &amp;amp; Sijie.&lt;/p&gt;</comment>
                            <comment id="13271217" author="hudson" created="Wed, 9 May 2012 09:39:43 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #497 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/497/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/497/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-242&quot; title=&quot;Bookkeeper not able to connect other zookeeper when shutdown the zookeeper server where the BK has connected.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-242&quot;&gt;&lt;del&gt;BOOKKEEPER-242&lt;/del&gt;&lt;/a&gt;: Bookkeeper not able to connect other zookeeper when shutdown the zookeeper server where the BK has connected. (sijie &amp;amp; rakeshr via ivank) (Revision 1335973)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ClientConfiguration.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ConfigurationTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525998" name="BK-242.diff" size="3242" author="hustlmsp" created="Tue, 8 May 2012 15:57:55 +0100"/>
                            <attachment id="12526104" name="BK-242.diff_v2" size="3443" author="hustlmsp" created="Wed, 9 May 2012 06:30:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 May 2012 10:01:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>238530</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4s87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61729</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>