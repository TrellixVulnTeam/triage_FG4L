<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:32:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-424/BOOKKEEPER-424.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-424] Bookie start is failing intermittently when zkclient connection delays</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-424</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;I&apos;m seeing the following intermittent failure, when there is a delay in establishing zkclient connection with zkserver. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.bookkeeper.bookie.BookieException$InvalidCookieException: org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /ledgers/INSTANCEID
	at org.apache.bookkeeper.bookie.Bookie.checkEnvironment(Bookie.java:329)
	at org.apache.bookkeeper.bookie.Bookie.&amp;lt;init&amp;gt;(Bookie.java:378)
	at org.apache.bookkeeper.bookie.BookieInitializationTest.testStartBookieWithoutZKServer(BookieInitializationTest.java:253)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)
	at java.lang.reflect.Method.invoke(Unknown Source)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.FailOnTimeout$1.run(FailOnTimeout.java:28)
Caused by: org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /ledgers/INSTANCEID
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:99)
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
	at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1131)
	at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1160)
	at org.apache.bookkeeper.bookie.Bookie.getInstanceId(Bookie.java:346)
	at org.apache.bookkeeper.bookie.Bookie.checkEnvironment(Bookie.java:280)
	... 11 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12610747">BOOKKEEPER-424</key>
            <summary>Bookie start is failing intermittently when zkclient connection delays</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh R</assignee>
                                    <reporter username="rakeshr">Rakesh R</reporter>
                        <labels>
                    </labels>
                <created>Sun, 7 Oct 2012 09:46:52 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:52 +0000</updated>
                            <resolved>Thu, 25 Oct 2012 14:36:44 +0100</resolved>
                                    <version>4.0.0</version>
                    <version>4.1.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13471368" author="rakeshr" created="Mon, 8 Oct 2012 02:55:23 +0100"  >&lt;p&gt;Attached latest patch which have the following changes. Please review.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;zkutil.createConnectedZookeeperClient&lt;/li&gt;
	&lt;li&gt;also removed unused var &apos;isZkExpired&apos; from Bookie&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thanks,&lt;br/&gt;
Rakesh&lt;/p&gt;</comment>
                            <comment id="13471423" author="umamaheswararao" created="Mon, 8 Oct 2012 08:01:37 +0100"  >&lt;p&gt;@Rakesh, thanks for the patch.&lt;br/&gt;
 I have a comment on the patch.&lt;/p&gt;
 &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// register watcher &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; receiving expired event
&lt;/span&gt;+        newZk.register(watcher);
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newZk;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;There will be a small race here, which may resulted to miss the events.&lt;br/&gt;
Race is between event and reregistration. Original newConnectedZK method events from ZKutil will not handle any expire events. So, just before reregistering if it gets expired event, we may miss that event handling.&lt;br/&gt;
later operations may thow conn loss exception and may miss proper cleanup.&lt;br/&gt;
So, how about having isConnected check after reregistration of watcher?&lt;br/&gt;
if ZK is in non connected state and ZK state has expired event then shutdown as watcher event does the same. This way we will not miss any events right? ( assuming reresistration will not reset any event states at ZK obj)&lt;/p&gt;</comment>
                            <comment id="13475868" author="rakeshr" created="Sun, 14 Oct 2012 18:56:44 +0100"  >&lt;p&gt;Thanks Uma for your time and reviews. Could you please give your opinion on the following.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There will be a small race here, which may resulted to miss the events.&lt;br/&gt;
Race is between event and reregistration. Original newConnectedZK method events from ZKutil will not handle any expire events. So, just before reregistering if it gets expired event, we may miss that event handling.&lt;br/&gt;
 later operations may thow conn loss exception and may miss proper cleanup.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Actually the window gap between Syncconnected event and Expired event is the sessiontimeout configured for the client. I couldn&apos;t see any race between Syncconnected event and expiry event. I agree there could be a high chance of sending Disconnected event to the previous watcher in ZKUtil, but Bookie doesn&apos;t have any event handling other than just logging.&lt;/p&gt;

&lt;p&gt;Consider in corner case where the client is very busy(in GCing or other cases) and got expired before registering new watcher. In this case anyway down the layer, after instantiation, bookie is using zkclient for checking env(as shown below code) here it would get ZKConnectionLossException and consequently would get shutdown.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zk = instantiateZookeeperClient(conf);
        checkEnvironment(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zk);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So IMHO, we can continue without having anymore extra checks. Whats your opinion?&lt;/p&gt;</comment>
                            <comment id="13475874" author="umamaheswararao" created="Sun, 14 Oct 2012 19:31:07 +0100"  >&lt;blockquote&gt;
&lt;p&gt;Consider in corner case where the client is very busy(in GCing or other cases) and got expired before registering new watcher. In this case anyway down the layer, after instantiation, bookie is using zkclient for checking env(as shown below code) here it would get ZKConnectionLossException and consequently would get shutdown.&lt;br/&gt;
this.zk = instantiateZookeeperClient(conf);&lt;br/&gt;
        checkEnvironment(this.zk);&lt;br/&gt;
So IMHO, we can continue without having anymore extra checks. Whats your opinion?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt; Here by luck, we have ZK access due to getting Cookie instance, otherwise, we may end up in non-grace full shutdown. i.e, we would have not executed any of the clean up activities which are performed in shutdown. &lt;br/&gt;
Also, semantically checkEnvironment check is not for ZK validation, it was for fileSystem structure consistency. So, I don&apos;t feel it is correct to depending on that check. If tomorrow we change the check env conditions, no one will came back to this position and care about this zk connection race right. Also it is right to me that checkEnvironment  is for other purpose and not for zk handle validation.&lt;/p&gt;</comment>
                            <comment id="13475875" author="rakeshr" created="Sun, 14 Oct 2012 19:31:29 +0100"  >&lt;p&gt;Plase have a look at the latest patch.&lt;br/&gt;
I had missed zkstate change logs previously.  Also have done simple correction in the exception block of readjournal() invocation by returning in case of any exception. &lt;/p&gt;</comment>
                            <comment id="13475882" author="umamaheswararao" created="Sun, 14 Oct 2012 20:00:27 +0100"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (event.getState().equals(
                        Watcher.Event.KeeperState.Expired)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Expired can be with None Event as well right? Seems to me that we are having check here only for non None events right per the latest patch?&lt;/p&gt;</comment>
                            <comment id="13475936" author="rakeshr" created="Mon, 15 Oct 2012 03:21:09 +0100"  >&lt;p&gt;Attached latest patch addressing Uma&apos;s comment.&lt;/p&gt;</comment>
                            <comment id="13477105" author="ikelly" created="Tue, 16 Oct 2012 16:56:28 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt; Perhaps you could break out the ZooKeeperWatcher stuff from &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-390&quot; title=&quot;Provide support for ZooKeeper authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-390&quot;&gt;BOOKKEEPER-390&lt;/a&gt; and put it in this patch. It would solve this problem also and make the &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-390&quot; title=&quot;Provide support for ZooKeeper authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-390&quot;&gt;BOOKKEEPER-390&lt;/a&gt; more focussed on the ACL stuff. I&apos;ve also made some comments on &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-390&quot; title=&quot;Provide support for ZooKeeper authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-390&quot;&gt;BOOKKEEPER-390&lt;/a&gt; about those changes.&lt;/p&gt;</comment>
                            <comment id="13478206" author="rakeshr" created="Wed, 17 Oct 2012 19:37:44 +0100"  >&lt;p&gt;Thanks Ivan. Attached reworked patch, which includes ZooKeeperWatcherBase and please have a look at it.&lt;/p&gt;</comment>
                            <comment id="13481029" author="rakeshr" created="Sun, 21 Oct 2012 20:23:51 +0100"  >&lt;p&gt;Attached reworked patch, done small correction on re-checking zookeeper connection status.&lt;/p&gt;</comment>
                            <comment id="13484113" author="ikelly" created="Thu, 25 Oct 2012 14:36:44 +0100"  >&lt;p&gt;Committed r1402146. Thanks Rakesh&lt;/p&gt;</comment>
                            <comment id="13484121" author="hudson" created="Thu, 25 Oct 2012 14:47:11 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #771 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/771/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/771/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-424&quot; title=&quot;Bookie start is failing intermittently when zkclient connection delays&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-424&quot;&gt;&lt;del&gt;BOOKKEEPER-424&lt;/del&gt;&lt;/a&gt;: Bookie start is failing intermittently when zkclient connection delays (rakeshr via ivank) (Revision 1402146)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeper.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/replication/AutoRecoveryMain.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/ZkUtils.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieInitializationTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/replication/TestLedgerUnderreplicationManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/replication/TestReplicationWorker.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ZooKeeperUtil.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13484156" author="ikelly" created="Thu, 25 Oct 2012 15:19:40 +0100"  >&lt;p&gt;Added missing file in r1402159&lt;/p&gt;</comment>
                            <comment id="13484209" author="hudson" created="Thu, 25 Oct 2012 16:53:59 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #772 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/772/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/772/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-424&quot; title=&quot;Bookie start is failing intermittently when zkclient connection delays&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-424&quot;&gt;&lt;del&gt;BOOKKEEPER-424&lt;/del&gt;&lt;/a&gt;: Bookie start is failing intermittently when zkclient connection delays (rakeshr via ivank) &lt;span class=&quot;error&quot;&gt;&amp;#91;missing files&amp;#93;&lt;/span&gt; (Revision 1402159)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/zookeeper&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/zookeeper/ZooKeeperWatcherBase.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548186" name="BOOKKEEPER-424-1.patch" size="5832" author="rakeshr" created="Mon, 8 Oct 2012 02:49:52 +0100"/>
                            <attachment id="12549080" name="BOOKKEEPER-424-2.patch" size="7108" author="rakeshr" created="Sun, 14 Oct 2012 19:15:47 +0100"/>
                            <attachment id="12549081" name="BOOKKEEPER-424-3.patch" size="7034" author="rakeshr" created="Sun, 14 Oct 2012 19:26:25 +0100"/>
                            <attachment id="12549101" name="BOOKKEEPER-424-4.patch" size="6929" author="rakeshr" created="Mon, 15 Oct 2012 03:21:09 +0100"/>
                            <attachment id="12549543" name="BOOKKEEPER-424-5.patch" size="23772" author="rakeshr" created="Wed, 17 Oct 2012 19:32:06 +0100"/>
                            <attachment id="12550199" name="BOOKKEEPER-424-6.patch" size="23792" author="rakeshr" created="Sun, 21 Oct 2012 20:20:31 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 8 Oct 2012 07:01:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244946</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxzrbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32410</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>