<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:13 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-392/BOOKKEEPER-392.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-392] Racey ConcurrentMap usage in java hedwig-client</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-392</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;The java hedwig-client misuses ConcurrentMap in various ways.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12606138">BOOKKEEPER-392</key>
            <summary>Racey ConcurrentMap usage in java hedwig-client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stuhood">Stu Hood</assignee>
                                    <reporter username="stuhood">Stu Hood</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Sep 2012 20:25:36 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:51 +0000</updated>
                            <resolved>Thu, 13 Sep 2012 14:53:19 +0100</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                    <component>hedwig-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13447993" author="stuhood" created="Tue, 4 Sep 2012 20:43:26 +0100"  >&lt;p&gt;Merges containsKey+get or get+remove calls into gets/removes, respectively. Uses putIfAbsent or precise remove where appropriate. Also replaces the LinkedList in HedwigClientImpl.host2topic with a threadsafe linked list (CLQ).&lt;/p&gt;</comment>
                            <comment id="13447994" author="stuhood" created="Tue, 4 Sep 2012 20:43:47 +0100"  >&lt;p&gt;Applies to trunk.&lt;/p&gt;</comment>
                            <comment id="13448270" author="hustlmsp" created="Wed, 5 Sep 2012 01:33:16 +0100"  >&lt;p&gt;@Stu, the changes looks good.&lt;/p&gt;

&lt;p&gt;But I had a question about storeTopic2HostMapping&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (topic2Host.putIfAbsent(pubSubData.topic, host) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (logger.isDebugEnabled())
+                logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stored info &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; topic: &quot;&lt;/span&gt; + pubSubData.topic.toStringUtf8() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, old host: &quot;&lt;/span&gt;
+                            + existingHost + &lt;span class=&quot;code-quote&quot;&gt;&quot;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; host: &quot;&lt;/span&gt; + host);
+        }
+        ConcurrentLinkedQueue&amp;lt;ByteString&amp;gt; topicsForHost = host2Topics.get(host);
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (topicsForHost == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+            ConcurrentLinkedQueue&amp;lt;ByteString&amp;gt; newTopicsList = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentLinkedQueue&amp;lt;ByteString&amp;gt;();
+            topicsForHost = host2Topics.putIfAbsent(host, newTopicsList);
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (topicsForHost == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+              topicsForHost = newTopicsList;
+            }
         }
+        topicsForHost.add(pubSubData.topic);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;if we failed to put host into topic2Host, I don&apos;t think we need to put it into host2Topics. And seems that you had assumption that there is not entry for the given host in topic2Host, which is a bit strict.&lt;/p&gt;

&lt;p&gt;I had a different change when working for &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-70&quot; title=&quot;reduce or multiplex subscription connections to a hub server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-70&quot;&gt;&lt;del&gt;BOOKKEEPER-70&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
&lt;a href=&quot;https://github.com/sijie/bookkeeper/commit/5ac124f2013f4f1d39559c908320dd91184f806c#L6R452&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/sijie/bookkeeper/commit/5ac124f2013f4f1d39559c908320dd91184f806c#L6R452&lt;/a&gt;&lt;br/&gt;
(my changes for clearAllTopicsForHost has a bit problem. It should use conditional remove #remove(key, oldvalue) to remove from concurrent map in my changes)&lt;/p&gt;

&lt;p&gt;Could you take a look at it? How is your opinion?&lt;/p&gt;
</comment>
                            <comment id="13452451" author="stuhood" created="Mon, 10 Sep 2012 22:13:10 +0100"  >&lt;p&gt;Good point Sijie: updated.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/sijie/bookkeeper/commit/5ac124f2013f4f1d39559c908320dd91184f806c&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/sijie/bookkeeper/commit/5ac124f2013f4f1d39559c908320dd91184f806c&lt;/a&gt; looks like a solid improvement: nice work! It also addresses many of the races I encountered here. What is your timeframe for committing that component of &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-70&quot; title=&quot;reduce or multiplex subscription connections to a hub server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-70&quot;&gt;&lt;del&gt;BOOKKEEPER-70&lt;/del&gt;&lt;/a&gt;? If you think that that linked review will be landing sometime soon (which ticket is it associated with?) I&apos;d be fine with waiting for it to land rather than committing this.&lt;/p&gt;</comment>
                            <comment id="13452721" author="hustlmsp" created="Tue, 11 Sep 2012 06:08:41 +0100"  >&lt;p&gt;@Stu, thanks for updating the patch.&lt;/p&gt;

&lt;p&gt;the changes are for the subtask &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-364&quot; title=&quot;re-factor hedwig java client to support both one-subscription-per-channel and multiplex-subscriptions-per-channel.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-364&quot;&gt;&lt;del&gt;BOOKKEEPER-364&lt;/del&gt;&lt;/a&gt; of &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-70&quot; title=&quot;reduce or multiplex subscription connections to a hub server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-70&quot;&gt;&lt;del&gt;BOOKKEEPER-70&lt;/del&gt;&lt;/a&gt;. We had finished the works for &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-70&quot; title=&quot;reduce or multiplex subscription connections to a hub server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-70&quot;&gt;&lt;del&gt;BOOKKEEPER-70&lt;/del&gt;&lt;/a&gt; and began to generate the patches for review and commit. But I think it might take a period. since you had a patch for the race condition and the patch looks pretty good, which is almost ready to be in. I would prefer to commit your patch first.&lt;/p&gt;

&lt;p&gt;+1 for the new patch.&lt;/p&gt;</comment>
                            <comment id="13454897" author="hustlmsp" created="Thu, 13 Sep 2012 14:53:19 +0100"  >&lt;p&gt;committed as r1384336. thanks Stu.&lt;/p&gt;</comment>
                            <comment id="13455095" author="hudson" created="Thu, 13 Sep 2012 19:13:39 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #708 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/708/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/708/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-392&quot; title=&quot;Racey ConcurrentMap usage in java hedwig-client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-392&quot;&gt;&lt;del&gt;BOOKKEEPER-392&lt;/del&gt;&lt;/a&gt;: Racey ConcurrentMap usage in java hedwig-client (Stu Hood via sijie) (Revision 1384336)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
sijie : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/handlers/SubscribeResponseHandler.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/netty/HedwigClientImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/netty/HedwigPublisher.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/netty/HedwigSubscriber.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-client/src/main/java/org/apache/hedwig/client/netty/ResponseHandler.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/common/ByteStringInterner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12544530" name="392.diff" size="22642" author="stuhood" created="Mon, 10 Sep 2012 22:13:10 +0100"/>
                            <attachment id="12543732" name="392.diff" size="22925" author="stuhood" created="Tue, 4 Sep 2012 20:43:26 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 Sep 2012 00:33:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyn6nz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169267</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>