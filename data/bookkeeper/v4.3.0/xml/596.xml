<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:26:01 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-596/BOOKKEEPER-596.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-596] Ledgers are gc&apos;ed by mistake in MSLedgerManagerFactory.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-596</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;details: &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-590?focusedCommentId=13616397&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13616397&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-590?focusedCommentId=13616397&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13616397&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639659">BOOKKEEPER-596</key>
            <summary>Ledgers are gc&apos;ed by mistake in MSLedgerManagerFactory.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Mar 2013 18:59:04 +0000</created>
                <updated>Fri, 26 Jul 2013 20:36:10 +0100</updated>
                            <resolved>Fri, 26 Jul 2013 20:36:10 +0100</resolved>
                                    <version>4.2.0</version>
                    <version>4.2.1</version>
                                    <fixVersion>4.2.2</fixVersion>
                    <fixVersion>4.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13616655" author="hustlmsp" created="Thu, 28 Mar 2013 21:07:25 +0000"  >&lt;p&gt;attach a patch to address this problem.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixed LedgerRangeIterator issue in MSLedgerManagerFactory&lt;/li&gt;
	&lt;li&gt;fix concurrent modification issue in InMemoryStore&lt;/li&gt;
	&lt;li&gt;enable MSLedgerManagerFactory for LedgerManagerTestCase&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13616832" author="hadoopqa" created="Thu, 28 Mar 2013 23:43:14 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-596&quot; title=&quot;Ledgers are gc&amp;#39;ed by mistake in MSLedgerManagerFactory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-596&quot;&gt;&lt;del&gt;BOOKKEEPER-596&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12575950/BOOKKEEPER-596.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-596.patch&lt;/a&gt; downloaded at Thu Mar 28 23:12:17 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch contains 2 line(s) with trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 829&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/306/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/306/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13617099" author="jiannan" created="Fri, 29 Mar 2013 05:46:13 +0000"  >&lt;p&gt;Thanks sijie for providing a fix. The patch looks good to me, but it fails when I run test in my dev env. I&apos;m digging the problem.&lt;/p&gt;</comment>
                            <comment id="13617118" author="jiannan" created="Fri, 29 Mar 2013 06:05:23 +0000"  >&lt;p&gt;An fail example: 100 ledgers with ledger id 0~99 are created, if 99 are deleted, it has no chance to been gc&apos;ed in the &quot;while(ledgerRangeIterator.hasNext()) &lt;/p&gt;
{...}
&lt;p&gt;&quot; loop.&lt;/p&gt;</comment>
                            <comment id="13617222" author="vinayrpet" created="Fri, 29 Mar 2013 10:30:42 +0000"  >&lt;p&gt;Yes, You are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiannan&quot; class=&quot;user-hover&quot; rel=&quot;jiannan&quot;&gt;Jiannan Wang&lt;/a&gt;, If the &lt;tt&gt;bkActiveLedgersSnapshot&lt;/tt&gt; contains ledgers which are &amp;gt; &lt;tt&gt;lRange.end()&lt;/tt&gt;, then there is no chance of being gc&apos;ed in the current gc call.&lt;/p&gt;

&lt;p&gt;But if one more ledger is created, then on next gc call, all ledgers deleted ( which are having lesser ledgerId than latest created) will be gc&apos;ed.&lt;/p&gt;

&lt;p&gt;This may not be a problem. &lt;/p&gt;</comment>
                            <comment id="13617666" author="hustlmsp" created="Fri, 29 Mar 2013 19:59:34 +0000"  >&lt;p&gt;a new patch addressed &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiannan&quot; class=&quot;user-hover&quot; rel=&quot;jiannan&quot;&gt;Jiannan Wang&lt;/a&gt;&apos;s comment. and also removed the trailing spaces.&lt;/p&gt;</comment>
                            <comment id="13617694" author="hadoopqa" created="Fri, 29 Mar 2013 20:32:04 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-596&quot; title=&quot;Ledgers are gc&amp;#39;ed by mistake in MSLedgerManagerFactory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-596&quot;&gt;&lt;del&gt;BOOKKEEPER-596&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12576148/BOOKKEEPER-596.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-596.patch&lt;/a&gt; downloaded at Fri Mar 29 20:01:01 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 848&lt;br/&gt;
.    Tests failed: 18&lt;br/&gt;
.    Tests errors: 20&lt;/p&gt;

&lt;p&gt;.    The patch failed the following testcases:&lt;/p&gt;

&lt;p&gt;.      testSyncUnsubscribeWithoutSubscription&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncUnsubscribeWithoutSubscription&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testCloseSubscription&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testStartDeliveryTwice&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testStopDelivery&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testConsumedMessagesInOrder&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testCreateSubscriptionFailure&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testCreateSubscriptionSuccess&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAttachToSubscriptionFailure&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncHubSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncHubSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncHubUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncHubUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testPublishWithBookKeeperError&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/308/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/308/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13617949" author="hustlmsp" created="Sat, 30 Mar 2013 01:37:11 +0000"  >&lt;p&gt;looks like the failure is irrelative, re-submit the patch.&lt;/p&gt;</comment>
                            <comment id="13618005" author="jiannan" created="Sat, 30 Mar 2013 06:51:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinay&quot; class=&quot;user-hover&quot; rel=&quot;vinay&quot;&gt;vinay chandrasekharan&lt;/a&gt; Yes, defer gc is not a big problem, but it result in gc test case failed, so we had better fix it.&lt;/p&gt;

&lt;p&gt;The new patch looks good to me, and it pass the GcLedgersTest test case now, thanks Sijie.&lt;/p&gt;

&lt;p&gt;TestHedwigHubRegular also failed in my dev box when I run it many times, if it&apos;s irrelative we can create new JIRA to track it.&lt;/p&gt;</comment>
                            <comment id="13619991" author="ikelly" created="Tue, 2 Apr 2013 17:54:54 +0100"  >&lt;p&gt;regarding the change to the ScanAndCompareGC, it feels like this addition is a bit of a hack. Really, a ledger range iterator should return a range set like&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;(NOLIMIT, 10), (11, 20), (21, 30), (31, NOLIMIT)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This would remove the necessity for special handling, and it would also cover the case where ledgers exist on the bookie which are lower than the lower bound of the ledger ranges. This patch only handles those which are above the upper bound.&lt;/p&gt;

&lt;p&gt;Further to this, I think NOLIMIT should be replaced with MIN_LEDGER_ID and MAX_LEDGER_ID to make things clearer.&lt;/p&gt;</comment>
                            <comment id="13620655" author="lvfangmin" created="Wed, 3 Apr 2013 07:10:40 +0100"  >&lt;p&gt;I agree with Ivan&apos;s comment, how about this patch?&lt;/p&gt;</comment>
                            <comment id="13620674" author="hadoopqa" created="Wed, 3 Apr 2013 07:42:56 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-596&quot; title=&quot;Ledgers are gc&amp;#39;ed by mistake in MSLedgerManagerFactory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-596&quot;&gt;&lt;del&gt;BOOKKEEPER-596&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12576727/BOOKKEEPER-596.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-596.patch&lt;/a&gt; downloaded at Wed Apr  3 06:11:57 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 830&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/310/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/310/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13620704" author="jiannan" created="Wed, 3 Apr 2013 08:47:31 +0100"  >&lt;p&gt;Thanks fangmin&apos;s new patch, here are two comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I would suggest add more documentation about the LedgerRange constructor.&lt;/li&gt;
	&lt;li&gt;The &quot;throw new NoSuchElementException()&quot; in next() method seems unnecessary since there will be a hasNext() call before invoking next() in general case. If you really want to consider this corner situation then the condition check &quot;if (!hasMoreElement) {&quot; should be &quot;if (!hasNext()) {&quot; since we need to wait for the openCursor callback or the cursor is null which causes a NPE.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Personally, I would prefer Sijie&apos;s change which removes the LedgerRange constructor implementation dependency.&lt;/p&gt;</comment>
                            <comment id="13620827" author="ikelly" created="Wed, 3 Apr 2013 11:39:11 +0100"  >&lt;p&gt;Actually, by accident the current implementation handles those below the lower bound also. I agree with Jiannan&apos;s comment about removing the dependency on LedgerRange construction. During LedgerRange construction, the entity creating the LedgerRange shouldn&apos;t have to know how it will be used. The NOLIMIT constant indicates that they do. It would be cleaner if LedgerRange only took the list of ledgers and it worked out the first and last from that. Then the gc should decide how to use the ranges by itself.&lt;/p&gt;</comment>
                            <comment id="13620828" author="lvfangmin" created="Wed, 3 Apr 2013 11:46:59 +0100"  >&lt;p&gt;@Jiannan @Ivan, Thanks for your comments.&lt;/p&gt;

&lt;p&gt;Yes, that make sense, we should removing the dependency on LedgerRange construction, also I prefer jiannan&apos;s new implementation of Scan and compare gc algorithm which removed the &apos;ordered scan&apos; limit.&lt;/p&gt;</comment>
                            <comment id="13620834" author="ikelly" created="Wed, 3 Apr 2013 11:58:51 +0100"  >&lt;p&gt;Im working on a patch now to remove the LedgerRange constructor dependence. I should have something in an hour or two.&lt;/p&gt;</comment>
                            <comment id="13620959" author="ikelly" created="Wed, 3 Apr 2013 15:40:44 +0100"  >&lt;p&gt;New patch builds on Sijie&apos;s patch, but also cleans up how ranges are constructed. Now the start and end of the range is derived from the set of ledgers passed to the range. NOLIMIT has been removed. An iterator is an ordered set of non-overlapping ranges. There can be no empty ranges in the iterator. ScanAndCompareGC takes all this into accounts. And covers the entire possible ledger id range when doing gc.&lt;/p&gt;</comment>
                            <comment id="13621004" author="jiannan" created="Wed, 3 Apr 2013 16:45:10 +0100"  >&lt;p&gt;Thanks Ivan for providing a new patch and add corresponding test case. Things need to be taken very very careful for this fix. The patch looks good to me and passes test in my dev box.&lt;/p&gt;

&lt;p&gt;However, I find another legacy potential problem when review code: if there is any error happen during gc we should throw exception to avoid incorrect gc, but MSLedgerManagerFactory#MSLedgerRangeIterator#hasNext() eats a InterruptedException and just return false.&lt;/p&gt;

&lt;p&gt;Ivan, could you help to resolve the legacy problem?&lt;/p&gt;</comment>
                            <comment id="13621244" author="hadoopqa" created="Wed, 3 Apr 2013 20:33:27 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-596&quot; title=&quot;Ledgers are gc&amp;#39;ed by mistake in MSLedgerManagerFactory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-596&quot;&gt;&lt;del&gt;BOOKKEEPER-596&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12576792/0001-BOOKKEEPER-596-Ledgers-are-gc-ed-by-mistake-in-MSLed.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-596-Ledgers-are-gc-ed-by-mistake-in-MSLed.patch&lt;/a&gt; downloaded at Wed Apr  3 19:02:43 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 2 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 846&lt;br/&gt;
.    Tests failed: 12&lt;br/&gt;
.    Tests errors: 14&lt;/p&gt;

&lt;p&gt;.    The patch failed the following testcases:&lt;/p&gt;

&lt;p&gt;.      testCreateSubscriptionFailure&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testCreateSubscriptionSuccess&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAttachToSubscriptionFailure&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncHubSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncHubSubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testSyncHubUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testAsyncHubUnsubscribeWithInvalidSubscriberId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;br/&gt;
.      testPublishWithBookKeeperError&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;(org.apache.hedwig.server.integration.TestHedwigHubRegular)&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/311/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/311/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13621332" author="ikelly" created="Wed, 3 Apr 2013 22:14:21 +0100"  >&lt;p&gt;new patch addresses those legacy issues also.&lt;/p&gt;</comment>
                            <comment id="13621443" author="hadoopqa" created="Wed, 3 Apr 2013 23:38:12 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-596&quot; title=&quot;Ledgers are gc&amp;#39;ed by mistake in MSLedgerManagerFactory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-596&quot;&gt;&lt;del&gt;BOOKKEEPER-596&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12576851/0001-BOOKKEEPER-596-Ledgers-are-gc-ed-by-mistake-in-MSLed.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-596-Ledgers-are-gc-ed-by-mistake-in-MSLed.patch&lt;/a&gt; downloaded at Wed Apr  3 22:07:04 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 2 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 833&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/312/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/312/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13621810" author="hustlmsp" created="Thu, 4 Apr 2013 06:11:41 +0100"  >&lt;p&gt;+1 for the new patch, thanks Ivan, Fangmin, Jiannan.&lt;/p&gt;</comment>
                            <comment id="13621830" author="jiannan" created="Thu, 4 Apr 2013 06:57:29 +0100"  >&lt;p&gt;+1 for the new patch&lt;/p&gt;</comment>
                            <comment id="13621962" author="ikelly" created="Thu, 4 Apr 2013 10:21:57 +0100"  >&lt;p&gt;Committed r1464385. Thanks Sijie &amp;amp; Jiannan&lt;/p&gt;</comment>
                            <comment id="13621987" author="hudson" created="Thu, 4 Apr 2013 11:00:35 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #164 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/164/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/164/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-596&quot; title=&quot;Ledgers are gc&amp;#39;ed by mistake in MSLedgerManagerFactory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-596&quot;&gt;&lt;del&gt;BOOKKEEPER-596&lt;/del&gt;&lt;/a&gt;: Ledgers are gc&apos;ed by mistake in MSLedgerManagerFactory. (sijie &amp;amp; ivank) (Revision 1464385)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/ScanAndCompareGarbageCollector.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/AbstractZkLedgerManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/FlatLedgerManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/HierarchicalLedgerManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/LedgerManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/MSLedgerManagerFactory.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/metastore/InMemoryMetastoreCursor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/meta/GcLedgersTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/meta/LedgerManagerTestCase.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13678141" author="ikelly" created="Fri, 7 Jun 2013 17:47:22 +0100"  >&lt;p&gt;Committed revision 1490718 on branch-4.2&lt;/p&gt;</comment>
                            <comment id="13719860" author="mmerli" created="Thu, 25 Jul 2013 19:10:56 +0100"  >&lt;p&gt;It seems like the issue is not completely fixed by this patch, it looks probably worse. &lt;/p&gt;

&lt;p&gt;I&apos;ve verified that after a garbage collection cleaning, some ledgers (whose metadata is untouched in ZK) were delete from the bookies. This eventually triggers error when either adding entries to these ledgers (infinite loop in the client.. ) or when reading (entries not found).&lt;/p&gt;

&lt;p&gt;This was using the HiearchicalLedgerManager (not sure the issue applies to all ledgers managers).&lt;/p&gt;

&lt;p&gt;I&apos;m trying to isolate a simple way to reproduce the issue, for now I think it&apos;s more likely to happen when a big number of ledgers are deleted in a short time and hence collected in the same gc cycle.&lt;/p&gt;</comment>
                            <comment id="13720342" author="hustlmsp" created="Fri, 26 Jul 2013 02:31:58 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=merlimat&quot; class=&quot;user-hover&quot; rel=&quot;merlimat&quot;&gt;Matteo Merli&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I guessed I found the root cause. it is a bug introduce in this patch, where Ivan refactored the LedgerRange.&lt;/p&gt;

&lt;p&gt;int HierarchicalLedgerManager, the subSet is misused, which exclude the last ledger id. &lt;br/&gt;
&lt;a href=&quot;http://docs.oracle.com/javase/6/docs/api/java/util/SortedSet.html#subSet(E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://docs.oracle.com/javase/6/docs/api/java/util/SortedSet.html#subSet(E&lt;/a&gt;, E)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LedgerRange(zkActiveLedgers.subSet(getStartLedgerIdByLevel(level1, level2),
                                                          getEndLedgerIdByLevel(level1, level2)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so the last ledger in each level would be gc&apos;ed. it is easy to reproduce this issue and fix it.&lt;/p&gt;</comment>
                            <comment id="13720874" author="ikelly" created="Fri, 26 Jul 2013 16:19:17 +0100"  >&lt;p&gt;Yikes. This is a big problem. Sorry guys &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. At least it was caught before a release.&lt;/p&gt;

&lt;p&gt;We should really look at getting rid of LedgerRange in future. It adds too many edge cases (each range has 2 edges by definition).&lt;/p&gt;</comment>
                            <comment id="13720875" author="ikelly" created="Fri, 26 Jul 2013 16:19:38 +0100"  >&lt;p&gt;@Sijie, are you working on a fix?&lt;/p&gt;</comment>
                            <comment id="13720920" author="mmerli" created="Fri, 26 Jul 2013 17:19:07 +0100"  >&lt;p&gt;Looks like it&apos;s more than the set inclusive of the last ledger in the range. I think some range might me missing when doing the scan: &lt;/p&gt;

&lt;p&gt;I create 10001 ledgers (to span over 2 ranges : 00/0000 and 00/0001)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LedgerRangeIterator iterator = getLedgerManager().getLedgerRanges();
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iterator.hasNext()) {
     LedgerRange ledgerRange = iterator.next();
     LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Found range: {}&quot;&lt;/span&gt;, ledgerRange.getLedgers());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but the iterator just gets the ledgers in the 00/0001 range&lt;/p&gt;</comment>
                            <comment id="13720942" author="mmerli" created="Fri, 26 Jul 2013 17:41:27 +0100"  >&lt;p&gt;One issue is the list of l2 nodes is not sorted, and also the ledger ranges iterator is missing the last ledger range &lt;/p&gt;</comment>
                            <comment id="13720949" author="ikelly" created="Fri, 26 Jul 2013 17:53:12 +0100"  >&lt;p&gt;Added this test in GcLedgersTest.java &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testManyLedgers() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SortedSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; createdLedgers = Collections.synchronizedSortedSet(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;());
        createLedgers(30001, createdLedgers);

        LedgerManager.LedgerRangeIterator iterator = getLedgerManager().getLedgerRanges();
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iterator.hasNext()) {
            LedgerManager.LedgerRange ledgerRange = iterator.next();
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Found range: {}&quot;&lt;/span&gt;, ledgerRange.getLedgers());
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This should give 4 ranges. it only gives one.&lt;/p&gt;</comment>
                            <comment id="13720951" author="ikelly" created="Fri, 26 Jul 2013 17:54:48 +0100"  >&lt;p&gt;disable everything but hierarchical in LedgerManagerTestCase for cleaner output.&lt;/p&gt;</comment>
                            <comment id="13720958" author="mmerli" created="Fri, 26 Jul 2013 18:04:06 +0100"  >&lt;p&gt;Fixing the ledger ranges iterations&lt;/p&gt;</comment>
                            <comment id="13720972" author="ikelly" created="Fri, 26 Jul 2013 18:31:07 +0100"  >&lt;p&gt;Patch looks like it solves it. I think it should go into a new JIRA though. &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-596&quot; title=&quot;Ledgers are gc&amp;#39;ed by mistake in MSLedgerManagerFactory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-596&quot;&gt;&lt;del&gt;BOOKKEEPER-596&lt;/del&gt;&lt;/a&gt; already has a patch, albeit a faulty one. It&apos;s much to late to roll it back, so we need a new patch (mark for 4.3.0 and 4.2.2).&lt;/p&gt;

&lt;p&gt;In the patch, Collections2 is unused. Also, it would be better for the test to cross 2 ranges at least, so set numLedgers to 30001 or so.&lt;/p&gt;</comment>
                            <comment id="13721122" author="mmerli" created="Fri, 26 Jul 2013 20:36:10 +0100"  >&lt;p&gt;Moving the last patch to &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-663&quot; title=&quot;HierarchicalLedgerManager iterator is missing some ranges and the last ledger in the range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-663&quot;&gt;&lt;del&gt;BOOKKEEPER-663&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12576851" name="0001-BOOKKEEPER-596-Ledgers-are-gc-ed-by-mistake-in-MSLed.patch" size="22377" author="ikelly" created="Wed, 3 Apr 2013 22:14:21 +0100"/>
                            <attachment id="12576792" name="0001-BOOKKEEPER-596-Ledgers-are-gc-ed-by-mistake-in-MSLed.patch" size="21488" author="ikelly" created="Wed, 3 Apr 2013 15:37:08 +0100"/>
                            <attachment id="12594422" name="BOOKKEEPER-596.diff" size="9376" author="mmerli" created="Fri, 26 Jul 2013 18:04:06 +0100"/>
                            <attachment id="12576727" name="BOOKKEEPER-596.patch" size="6073" author="lvfangmin" created="Wed, 3 Apr 2013 07:10:40 +0100"/>
                            <attachment id="12576148" name="BOOKKEEPER-596.patch" size="6377" author="hustlmsp" created="Fri, 29 Mar 2013 19:59:34 +0000"/>
                            <attachment id="12575950" name="BOOKKEEPER-596.patch" size="5070" author="hustlmsp" created="Thu, 28 Mar 2013 21:07:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 28 Mar 2013 23:43:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320128</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzd33r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320469</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>