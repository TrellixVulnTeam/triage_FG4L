<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:33:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-474/BOOKKEEPER-474.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-474] BookieReadWriteTest#testShutdown doesn&apos;t make sense</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-474</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;This test was created to catch the &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-5&quot; title=&quot;Issue with Netty in BookKeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-5&quot;&gt;&lt;del&gt;BOOKKEEPER-5&lt;/del&gt;&lt;/a&gt;, which is where we hang due to orphaned netty connections. Netty connections are made when we first send an add entry to the bookie. &lt;/p&gt;

&lt;p&gt;The creates 10000 ledgers, and writes 200 entries to across these (note, this is not 200 each, but 200 across all ledgers). Therefore, a maximum 200 connections could be created. So the test isn&apos;t doing what it think it is doing.&lt;/p&gt;

&lt;p&gt;The test takes between 4 &amp;amp; 7 minutes (most of this time creating unused ledgers) on jenkins. It is then run 4 times as BookieReadWriteTest is a Parameterized test.&lt;/p&gt;

&lt;p&gt;This adds up to 28 minutes to a build on jenkins. This test should take no longer than 30 seconds.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12617080">BOOKKEEPER-474</key>
            <summary>BookieReadWriteTest#testShutdown doesn&apos;t make sense</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Nov 2012 10:17:40 +0000</created>
                <updated>Thu, 2 May 2013 03:29:58 +0100</updated>
                            <resolved>Sat, 8 Dec 2012 15:15:22 +0000</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13504549" author="fpj" created="Tue, 27 Nov 2012 11:35:31 +0000"  >&lt;p&gt;Hi Ivan, I understand what you trying to do with a rewrite of the test, but I&apos;m not being able to understand exactly what it is supposed to do.&lt;/p&gt;

&lt;p&gt;I assume that the bug should occur when closing the ledger handles. If so, when we close the ledger, there must be some path that leads to closing bookie channels so that we can exercise the bug, no? I checked the code of asyncCloseInternal() and I couldn&apos;t find it.&lt;/p&gt;</comment>
                            <comment id="13504550" author="fpj" created="Tue, 27 Nov 2012 11:36:11 +0000"  >&lt;p&gt;Also, how do we even determine the necessary number of ledgers and timeout value? There is a bit of guess work here I guess.&lt;/p&gt;</comment>
                            <comment id="13504553" author="hadoopqa" created="Tue, 27 Nov 2012 11:49:28 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;WARNING: Running test-patch on a dirty local svn workspace&lt;/p&gt;

&lt;p&gt;Patch &amp;lt;a href=&quot;/jira/secure/attachment/12554486/0001-Moved-testShutdown-out-of-BookieReadWriteTest-and-ma.patch&quot;&amp;gt;/jira/secure/attachment/12554486/0001-Moved-testShutdown-out-of-BookieReadWriteTest-and-ma.patch&amp;lt;/a&amp;gt; downloaded at Tue Nov 27 11:29:54 UTC 2012&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 2 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;WARNING&lt;/font&gt;: the current HEAD has 8 Javadoc warning(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;WARNING&lt;/font&gt;: the current HEAD has 9 javac warning(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;WARNING: the current HEAD has  Findbugs warning(s), they should be addressed ASAP&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 386&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;.   There is at least one warning, please check&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/28/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/28/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13506434" author="ikelly" created="Thu, 29 Nov 2012 12:27:25 +0000"  >&lt;p&gt;Closing the ledgers isn&apos;t even necessary here, what the original testShutdown does, is that it tries to trigger a race in PerChannelBookieClient but having many LedgerHandles attempt addEntry simultaneously, which would cause more than one PerChannelBookieClient to be created in BookieClient for a single address, both would have connect() called on them but all but one would be orphaned after BookieClient tried to putIfAbsent into its channel map. Its a very blunt brute force way of triggering it. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/bookkeeper/commit/00f25f5622e69f063202f7bd46f09ad1d708983d&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/bookkeeper/commit/00f25f5622e69f063202f7bd46f09ad1d708983d&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-5&quot; title=&quot;Issue with Netty in BookKeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-5&quot;&gt;&lt;del&gt;BOOKKEEPER-5&lt;/del&gt;&lt;/a&gt; didn&apos;t fix it fully. Races could still occur between connect calls, but &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-59&quot; title=&quot;Race condition in netty code allocates and orphans resources (BK-5 revisited)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-59&quot;&gt;&lt;del&gt;BOOKKEEPER-59&lt;/del&gt;&lt;/a&gt; fixed that.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a new patch which focuses on the race directly, and removes testShutdown() completely. It depends on &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-485&quot; title=&quot;TestFencing hung&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-485&quot;&gt;&lt;del&gt;BOOKKEEPER-485&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13506435" author="hadoopqa" created="Thu, 29 Nov 2012 12:33:47 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;WARNING: Running test-patch on a dirty local svn workspace&lt;/p&gt;

&lt;p&gt;Patch &amp;lt;a href=&quot;/jira/secure/attachment/12555346/0002-&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;&lt;del&gt;Remove-testShutdown-replace-with-more.patch&quot;&amp;gt;/jira/secure/attachment/12555346/0002&lt;/del&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;-Remove-testShutdown-replace-with-more.patch&amp;lt;/a&amp;gt; downloaded at Thu Nov 29 12:31:17 UTC 2012&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; Patch failed to apply to head of branch&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;</comment>
                            <comment id="13507433" author="fpj" created="Fri, 30 Nov 2012 16:40:20 +0000"  >&lt;p&gt;I&apos;m not sure why the patch didn&apos;t apply, but it looks good to me. My only comment is that I think the test of &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-485&quot; title=&quot;TestFencing hung&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-485&quot;&gt;&lt;del&gt;BOOKKEEPER-485&lt;/del&gt;&lt;/a&gt; and the test in this patch should be perhaps in the class for organization purposes. They are related.&lt;/p&gt;</comment>
                            <comment id="13507434" author="fpj" created="Fri, 30 Nov 2012 16:40:44 +0000"  >&lt;p&gt;Cancelling so that we can upload a patch that applies.&lt;/p&gt;</comment>
                            <comment id="13507544" author="ikelly" created="Fri, 30 Nov 2012 18:53:28 +0000"  >&lt;p&gt;The patch doesn&apos;t apply because it relies on &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-485&quot; title=&quot;TestFencing hung&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-485&quot;&gt;&lt;del&gt;BOOKKEEPER-485&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13507562" author="ikelly" created="Fri, 30 Nov 2012 19:11:12 +0000"  >&lt;p&gt;new patch has full URL for issue.&lt;/p&gt;</comment>
                            <comment id="13507592" author="hadoopqa" created="Fri, 30 Nov 2012 19:37:51 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;WARNING: Running test-patch on a dirty local svn workspace&lt;/p&gt;

&lt;p&gt;Patch &amp;lt;a href=&quot;/jira/secure/attachment/12555549/0002-&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;&lt;del&gt;Remove-testShutdown-replace-with-more.patch&quot;&amp;gt;/jira/secure/attachment/12555549/0002&lt;/del&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;-Remove-testShutdown-replace-with-more.patch&amp;lt;/a&amp;gt; downloaded at Fri Nov 30 19:35:16 UTC 2012&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; Patch failed to apply to head of branch&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;</comment>
                            <comment id="13507973" author="fpj" created="Sat, 1 Dec 2012 14:06:40 +0000"  >&lt;p&gt;Resubmitting now that &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-485&quot; title=&quot;TestFencing hung&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-485&quot;&gt;&lt;del&gt;BOOKKEEPER-485&lt;/del&gt;&lt;/a&gt; is in.&lt;/p&gt;</comment>
                            <comment id="13527162" author="fpj" created="Sat, 8 Dec 2012 15:15:22 +0000"  >&lt;p&gt;+1, thanks, Ivan. Committed revision 1418685.&lt;/p&gt;</comment>
                            <comment id="13527359" author="hudson" created="Sun, 9 Dec 2012 07:12:57 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #845 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/845/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/845/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-474&quot; title=&quot;BookieReadWriteTest#testShutdown doesn&amp;#39;t make sense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-474&quot;&gt;&lt;del&gt;BOOKKEEPER-474&lt;/del&gt;&lt;/a&gt;:  BookieReadWriteTest#testShutdown doesn&apos;t make sense (ivank via fpj) (Revision 1418685)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
fpj : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/proto/TestPerChannelBookieClient.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieReadWriteTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12617805">BOOKKEEPER-485</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12554486" name="0001-Moved-testShutdown-out-of-BookieReadWriteTest-and-ma.patch" size="7098" author="ikelly" created="Wed, 21 Nov 2012 11:09:12 +0000"/>
                            <attachment id="12555549" name="0002-BOOKKEEPER-474-Remove-testShutdown-replace-with-more.patch" size="5134" author="ikelly" created="Fri, 30 Nov 2012 19:11:12 +0000"/>
                            <attachment id="12555346" name="0002-BOOKKEEPER-474-Remove-testShutdown-replace-with-more.patch" size="5088" author="ikelly" created="Thu, 29 Nov 2012 12:27:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 27 Nov 2012 11:35:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>259014</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyf36n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>122045</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>