<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:18 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-82/BOOKKEEPER-82.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-82] support journal rolling</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-82</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;now bookkeeper is writing a single journal file, so the journal file has no chance to be garbage collected and the disk space keeps growing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12527166">BOOKKEEPER-82</key>
            <summary>support journal rolling</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Oct 2011 10:27:18 +0100</created>
                <updated>Thu, 2 May 2013 03:29:45 +0100</updated>
                            <resolved>Fri, 11 Nov 2011 10:25:06 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13127442" author="hustlmsp" created="Fri, 14 Oct 2011 12:18:13 +0100"  >&lt;p&gt;attach a patch to support rolling journals&lt;/p&gt;

&lt;p&gt;1) LogMark should use marked lastMark to safely ensure the entries before lastMark are all persisted.&lt;/p&gt;

&lt;p&gt;2) relaying journal can start from last marked log, which can speed up bookie startup&lt;/p&gt;

&lt;p&gt;3) bookie.getHandle needs to check whether the ledger existed in current node, not just checking the memory.&lt;/p&gt;</comment>
                            <comment id="13129292" author="fpj" created="Mon, 17 Oct 2011 23:41:30 +0100"  >&lt;p&gt;Sijie, I&apos;ll review more carefully and give you comments. In the meanwhile, would you mind putting your patch on the review board and perhaps writing a test for this feature?&lt;/p&gt;</comment>
                            <comment id="13130385" author="hustlmsp" created="Wed, 19 Oct 2011 07:14:56 +0100"  >&lt;p&gt;Thanks, Flavio. It is ok to put it on the review board. And I will try to add test cases for this.&lt;/p&gt;</comment>
                            <comment id="13145636" author="hustlmsp" created="Mon, 7 Nov 2011 17:38:03 +0000"  >&lt;p&gt;attach new patch to support journal rolling&lt;/p&gt;</comment>
                            <comment id="13145641" author="jiraposter@reviews.apache.org" created="Mon, 7 Nov 2011 17:46:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2745/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;implement journal rolling&lt;/p&gt;

&lt;p&gt;1) remove journals whose id are less than marked journal id. since they journals&apos; data and index has been persisted to disk.&lt;br/&gt;
2) replay entires started from marked position in marked journal to speed up bookie start up.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/BOOKKEEPER-82&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt; 1198776 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/a&gt; 1198776 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&lt;/a&gt; PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2745/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Sijie&lt;/p&gt;
</comment>
                            <comment id="13147187" author="jiraposter@reviews.apache.org" created="Wed, 9 Nov 2011 17:49:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2745/#review3130&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/#review3130&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Good job, Sijie. I only have a few minor comments. One important general comment I have is that we need documentation for this feature. Ideally we commit a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt; that includes doc changes. Otherwise, I&apos;d like to have a blocker jira to make sure that we don&apos;t have a release without the doc changes.&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt;&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2745/#comment6943&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/#comment6943&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I think we can remove this todo, right?&lt;/p&gt;



&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt;&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2745/#comment6941&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/#comment6941&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Typo on journal.&lt;/p&gt;



&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/a&gt;&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2745/#comment6942&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/#comment6942&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    If there are corrupted entries, it is true that we can fetch copies from other bookies, but I don&apos;t think we have a mechanism for doing it yet, so it sounds safer to keep throwing an exception here for now, no?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fpj&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-11-07 17:46:11, Sijie Guo wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2745/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-07 17:46:11)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;implement journal rolling&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1) remove journals whose id are less than marked journal id. since they journals&apos; data and index has been persisted to disk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2) replay entires started from marked position in marked journal to speed up bookie start up.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/BOOKKEEPER-82&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt; 1198776 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/a&gt; 1198776 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&lt;/a&gt; PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2745/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Sijie&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13147553" author="jiraposter@reviews.apache.org" created="Thu, 10 Nov 2011 08:36:51 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-11-09 17:48:34, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Good job, Sijie. I only have a few minor comments. One important general comment I have is that we need documentation for this feature. Ideally we commit a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt; that includes doc changes. Otherwise, I&apos;d like to have a blocker jira to make sure that we don&apos;t have a release without the doc changes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would add doc for this feature.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-11-09 17:48:34, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt;, line 592&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2745/diff/1/?file=56625#file56625line592&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff/1/?file=56625#file56625line592&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think we can remove this todo, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-11-09 17:48:34, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt;, line 598&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2745/diff/1/?file=56625#file56625line598&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff/1/?file=56625#file56625line598&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Typo on journal.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will fix it.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-11-09 17:48:34, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/a&gt;, line 460&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2745/diff/1/?file=56626#file56626line460&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff/1/?file=56626#file56626line460&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     If there are corrupted entries, it is true that we can fetch copies from other bookies, but I don&apos;t think we have a mechanism for doing it yet, so it sounds safer to keep throwing an exception here for now, no?&lt;/p&gt;&lt;/blockquote&gt;


&lt;p&gt;I changed throwing an exception to skipping it, because I found bookie servers can&apos;t be started due to entry logger corruption after restartBookieServers in test cases.&lt;br/&gt;
This corruption is because that entry logger uses a BufferedChannel but it doesn&apos;t do flush when shutting down. So we read partial entry after those servers are restarted.&lt;/p&gt;

&lt;p&gt;I will add code in EntryLogger#shutdown to ensure buffered data persisted to disk, so it can pass unit tests.&lt;/p&gt;

&lt;p&gt;Since corruption is a complex issue, I agreed keeping throwing an exception here for now.&lt;/p&gt;

&lt;p&gt;I created a jira &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-62&quot; title=&quot;Bookie can not start when encountering corrupted records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-62&quot;&gt;&lt;del&gt;BOOKKEEPER-62&lt;/del&gt;&lt;/a&gt; before. Maybe we can handle data corruption in that jira.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sijie&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2745/#review3130&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/#review3130&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-11-07 17:46:11, Sijie Guo wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2745/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-07 17:46:11)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;implement journal rolling&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1) remove journals whose id are less than marked journal id. since they journals&apos; data and index has been persisted to disk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2) replay entires started from marked position in marked journal to speed up bookie start up.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/BOOKKEEPER-82&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt; 1198776 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/a&gt; 1198776 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&lt;/a&gt; PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2745/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Sijie&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13147555" author="jiraposter@reviews.apache.org" created="Thu, 10 Nov 2011 08:40:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2745/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-11-10 08:39:27.750726)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;add document for this feature.&lt;br/&gt;
fix typos.&lt;br/&gt;
ensure entry logger flush its buffered data during EntryLogger#shutdown.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;implement journal rolling&lt;/p&gt;

&lt;p&gt;1) remove journals whose id are less than marked journal id. since they journals&apos; data and index has been persisted to disk.&lt;br/&gt;
2) replay entires started from marked position in marked journal to speed up bookie start up.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/BOOKKEEPER-82&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt; 1200193 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/a&gt; 1200193 &lt;br/&gt;
  &lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&lt;/a&gt; PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2745/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Sijie&lt;/p&gt;
</comment>
                            <comment id="13147615" author="jiraposter@reviews.apache.org" created="Thu, 10 Nov 2011 11:32:51 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-11-09 17:48:34, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Good job, Sijie. I only have a few minor comments. One important general comment I have is that we need documentation for this feature. Ideally we commit a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt; that includes doc changes. Otherwise, I&apos;d like to have a blocker jira to make sure that we don&apos;t have a release without the doc changes.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Sijie Guo wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I would add doc for this feature.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sijie, java docs are good, but I meant to say textile documentation. Check the &quot;doc&quot; folder.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fpj&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2745/#review3130&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/#review3130&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-11-10 08:39:27, Sijie Guo wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2745/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-10 08:39:27)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;implement journal rolling&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1) remove journals whose id are less than marked journal id. since they journals&apos; data and index has been persisted to disk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2) replay entires started from marked position in marked journal to speed up bookie start up.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/BOOKKEEPER-82&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/a&gt; 1200193 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/a&gt; 1200193 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&lt;/a&gt; PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2745/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2745/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Sijie&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13147643" author="hustlmsp" created="Thu, 10 Nov 2011 12:52:07 +0000"  >&lt;p&gt;add textile doc in new patch.&lt;/p&gt;</comment>
                            <comment id="13147671" author="fpj" created="Thu, 10 Nov 2011 13:26:25 +0000"  >&lt;p&gt;I haven&apos;t been able to determine if it is due to this patch, but I got the following error when running LedgerDeleteTest:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-------------------------------------------------------------------------------
Test set: org.apache.bookkeeper.test.LedgerDeleteTest
-------------------------------------------------------------------------------
Tests run: 4, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 24.779 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
testLedgerDeleteWithExistingEntryLogs[1](org.apache.bookkeeper.test.LedgerDeleteTest)  Time elapsed: 3.296 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: Short read for entryLog 1@85400(384!=1064)
	at org.apache.bookkeeper.bookie.EntryLogger.extractLedgersFromEntryLogs(EntryLogger.java:461)
	at org.apache.bookkeeper.bookie.EntryLogger.createLogId(EntryLogger.java:258)
	at org.apache.bookkeeper.bookie.EntryLogger.&amp;lt;init&amp;gt;(EntryLogger.java:112)
	at org.apache.bookkeeper.bookie.Bookie.&amp;lt;init&amp;gt;(Bookie.java:199)
	at org.apache.bookkeeper.proto.BookieServer.&amp;lt;init&amp;gt;(BookieServer.java:49)
	at org.apache.bookkeeper.test.LedgerDeleteTest.testLedgerDeleteWithExistingEntryLogs(LedgerDeleteTest.java:136)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:76)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:236)
	at org.junit.runners.Suite.runChild(Suite.java:128)
	at org.junit.runners.Suite.runChild(Suite.java:24)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:236)
	at org.apache.maven.surefire.junit4.JUnit4TestSet.execute(JUnit4TestSet.java:53)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:123)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:104)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:164)
	at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:110)
	at org.apache.maven.surefire.booter.SurefireStarter.invokeProvider(SurefireStarter.java:172)
	at org.apache.maven.surefire.booter.SurefireStarter.runSuitesInProcessWhenForked(SurefireStarter.java:78)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:70)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13147692" author="hustlmsp" created="Thu, 10 Nov 2011 14:09:17 +0000"  >&lt;p&gt;the exception indicates that entry logger file is corrupted. &lt;/p&gt;

&lt;p&gt;I have added code in EntryLogger#shutdown to ensure buffered data is flushed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;EntryLogger.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    /**
     * Shutdown method to gracefully stop all threads spawned in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; class and exit.
     *
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there is an exception stopping threads.
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shutdown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        gcThread.running = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        gcThread.interrupt();
        gcThread.join();
        &lt;span class=&quot;code-comment&quot;&gt;// since logChannel is buffered channel, &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; flush when shutting down
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            flush();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ie) {
            &lt;span class=&quot;code-comment&quot;&gt;// we have no idea how to avoid io exception during shutting down, so just ignore it
&lt;/span&gt;            LOG.fatal(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error flush entry log during shutting down, which may cause entry log corrupted.&quot;&lt;/span&gt;, ie);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the entry logger file should not be corrupted, otherwise it was interrupted before flush or io exception occurred during flush.&lt;/p&gt;

&lt;p&gt;Could you turn test debug level on to INFO or WARN level, and rerun the test to grap more information? since I can&apos;t reproduce this issue either running LedgerDeleteTest alone or running all test cases . &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="13147809" author="fpj" created="Thu, 10 Nov 2011 16:37:21 +0000"  >&lt;p&gt;Adding logs for a run that failed. Notice the log entries at:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;2011-11-10 17:10:01,059&lt;/li&gt;
	&lt;li&gt;2011-11-10 17:10:01,060&lt;/li&gt;
&lt;/ol&gt;

</comment>
                            <comment id="13148239" author="hustlmsp" created="Fri, 11 Nov 2011 03:12:20 +0000"  >&lt;p&gt;ah, this failure is introduced in my code.&lt;/p&gt;

&lt;p&gt;I added SyncThread#interrupt during bookie shutdown to interrupt SyncThread#wait(flush_interval).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Bookie.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void shutdown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!running) { &lt;span class=&quot;code-comment&quot;&gt;// avoid shutdown twice
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    &lt;span class=&quot;code-comment&quot;&gt;// Shutdown the ZK client
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(zk != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) zk.close();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.interrupt();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.join();
    syncThread.running = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    &lt;span class=&quot;code-comment&quot;&gt;// sync thread may in wait status
&lt;/span&gt;    syncThread.interrupt();
    syncThread.join();
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(LedgerDescriptor d: ledgers.values()) {
        d.close();
    }
    &lt;span class=&quot;code-comment&quot;&gt;// Shutdown the EntryLogger which has the GarbageCollector &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; running
&lt;/span&gt;    entryLogger.shutdown();
    &lt;span class=&quot;code-comment&quot;&gt;// setting running to &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; here, so watch thread in bookie server know it only after bookie shut down
&lt;/span&gt;    running = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If a thread is blocked in an I/O operation upon an interruptible channel then the channel will be closed, the thread&apos;s interrupt status will be set, and it will receive a ClosedByInterruptException.&lt;/p&gt;

&lt;p&gt;So if SyncThread is running flushing ledger index / entry loggers, it will cause ClosedByInterruptException. &lt;/p&gt;

&lt;p&gt;Since sync thread may be blocked in #wait or I/O operations, I suggested that interrupts SyncThread when it doesn&apos;t do flushing as below: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;SyncThread&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

        &lt;span class=&quot;code-comment&quot;&gt;// flag to ensure sync thread will not be interrupted during flush
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicBoolean flushing = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicBoolean(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(running) {
                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        wait(flushInterval);
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!entryLogger.testAndClearSomethingWritten()) {
                            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                        }
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
                        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                    }
                }

                &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to mark flushing flag to make sure it would not be interrupted
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// by shutdown during flushing. otherwise it will receive
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// ClosedByInterruptException which may cause index file &amp;amp; entry logger
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// closed and corrupted.
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!flushing.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
                    &lt;span class=&quot;code-comment&quot;&gt;// set flushing flag failed, means flushing is &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; now
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// indicates another thread wants to interrupt sync thread to exit
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                }

                &lt;span class=&quot;code-comment&quot;&gt;// ... doing flush ...
&lt;/span&gt;            }
        }

        void shutdown() {
            running = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (flushing.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
                &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; setting flushing flag succeed, means syncThread is not flushing now
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// it is safe to interrupt itself now 
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.interrupt();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.join();
        }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13148241" author="hustlmsp" created="Fri, 11 Nov 2011 03:21:01 +0000"  >&lt;p&gt;add code as commented to avoid interrupting sync thread during flushing.&lt;/p&gt;</comment>
                            <comment id="13148402" author="fpj" created="Fri, 11 Nov 2011 10:25:07 +0000"  >&lt;p&gt;+1, thanks a lot, sijie! Committed revision 1200806.&lt;/p&gt;</comment>
                            <comment id="13148420" author="hudson" created="Fri, 11 Nov 2011 11:01:34 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #211 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/211/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/211/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-82&quot; title=&quot;support journal rolling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-82&quot;&gt;&lt;del&gt;BOOKKEEPER-82&lt;/del&gt;&lt;/a&gt;: support journal rolling (Sijie Guo via fpj)&lt;/p&gt;

&lt;p&gt;fpj : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieJournalRollingTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/doc/bookkeeperConfig.textile&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12531112">BOOKKEEPER-109</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12519276">BOOKKEEPER-50</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12503181" name="BOOKKEEPER-82.patch_v3" size="27827" author="hustlmsp" created="Thu, 10 Nov 2011 08:39:57 +0000"/>
                            <attachment id="12503199" name="BOOKKEEPER-82.patch_v4" size="30159" author="hustlmsp" created="Thu, 10 Nov 2011 12:52:07 +0000"/>
                            <attachment id="12503333" name="BOOKKEEPER-82.patch_v5" size="31728" author="hustlmsp" created="Fri, 11 Nov 2011 03:21:01 +0000"/>
                            <attachment id="12499019" name="bookkeeper-82.patch" size="15123" author="hustlmsp" created="Fri, 14 Oct 2011 12:18:12 +0100"/>
                            <attachment id="12502776" name="bookkeeper-82.patch_v2" size="26184" author="hustlmsp" created="Mon, 7 Nov 2011 17:38:03 +0000"/>
                            <attachment id="12503248" name="bookkeeper-server.log" size="97014" author="fpj" created="Thu, 10 Nov 2011 16:37:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 17 Oct 2011 22:41:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>85547</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hynzev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>173924</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>