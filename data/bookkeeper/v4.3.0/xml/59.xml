<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:31:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-59/BOOKKEEPER-59.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-59] Race condition in netty code allocates and orphans resources (BK-5 revisited)</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-59</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;We thought BK-5 fixed this, but it still hits if you run for long enough.&lt;/p&gt;

&lt;p&gt;To repro,&lt;/p&gt;

&lt;p&gt;true; while [ $? = 0 ]; do mvn test -Dtest=BookieReadWriteTest; done&lt;/p&gt;

&lt;p&gt;Leave this running for 5-6 hours, and the bug should hit. From looking at the code it could be that connect is unsynchronized, so resources could be allocated and lost by concurrent executions of connect(). &lt;/p&gt;</description>
                <environment></environment>
        <key id="12520701">BOOKKEEPER-59</key>
            <summary>Race condition in netty code allocates and orphans resources (BK-5 revisited)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Aug 2011 08:46:22 +0100</created>
                <updated>Wed, 7 Dec 2011 15:56:05 +0000</updated>
                            <resolved>Fri, 16 Sep 2011 15:56:48 +0100</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13097949" author="fpj" created="Tue, 6 Sep 2011 13:14:45 +0100"  >&lt;p&gt;One question: why can&apos;t we simply remove the else block in BookieClient.lookup()? If we do it, then we should have PerChannelBookieClient.connect() always called under a lock, through PerChannelBookieClient.connectIfNeededAndDoOp(), which is invoked by addEntry() and readEntry().&lt;/p&gt;</comment>
                            <comment id="13097985" author="ikelly" created="Tue, 6 Sep 2011 14:20:57 +0100"  >&lt;p&gt;I looked at removing that call to connect in &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-5&quot; title=&quot;Issue with Netty in BookKeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-5&quot;&gt;&lt;del&gt;BOOKKEEPER-5&lt;/del&gt;&lt;/a&gt; but didn&apos;t in the end because I concluded it was no harm i think. In any case, the synchronization in #connectIfNeededAndDoOp isn&apos;t enough, because the connect is asynchronous. Its the callback that sets the connected flag. So multiple threads can still end up kicking off #connect() before one succeeds and sets connected to true. &lt;/p&gt;

&lt;p&gt;Actually, we should roll connected and connectionAttemptInProgress into one flag really. I&apos;ll do that now and upload a new patch.&lt;/p&gt;</comment>
                            <comment id="13098004" author="ikelly" created="Tue, 6 Sep 2011 14:42:17 +0100"  >&lt;p&gt;Rolled boolean flags into an enum.&lt;/p&gt;</comment>
                            <comment id="13098019" author="fpj" created="Tue, 6 Sep 2011 15:09:35 +0100"  >&lt;p&gt;Suppose we remove the else block as I suggested. In this case, #connect is only called through #connectIfNeededAndDoOp. In #connectIfNeededAndDoOp, only one thread can call #connect at a time because of the synchronized block. If a thread ends up executing #connectIfNeededAndDoOp concurrently with another thread (connect hasn&apos;t completed for the latter thread), then #connect won&apos;t be called because connectionAttemptInProgress == true. &lt;/p&gt;

&lt;p&gt;Note that connectionAttemptInProgress is also set inside a synchronized block in the callback of connect, so it doesn&apos;t sound like the race you&apos;re saying can occur under the assumptions I stated.&lt;/p&gt;

&lt;p&gt;What do you think? Am I missing anything?&lt;/p&gt;</comment>
                            <comment id="13098034" author="ikelly" created="Tue, 6 Sep 2011 15:30:31 +0100"  >&lt;p&gt;Hmmm, this is correct, so it should be safe to just remove the call to connect. I&apos;ll upload a new patch which makes it more explicit though.&lt;/p&gt;

&lt;p&gt;PerChannelBookieClient#connect is now private and synchronized. The synchronization won&apos;t hit performance because the only call to #connect is already in a synchronized block. However if someone makes the call from somewhere else in the future, it&apos;ll still be safe.&lt;/p&gt;

&lt;p&gt;PerChannelBookieClient#connected and PerChannelBookieClient#connectionAttemptInProgress have been rolled into one enum, as these are mutually exclusive states. &lt;/p&gt;

&lt;p&gt;I&apos;ve moved the check of PerChannelBookieClient#connectionAttempt into #connect() as this seems like a better place for it.&lt;/p&gt;</comment>
                            <comment id="13106497" author="fpj" created="Fri, 16 Sep 2011 15:56:48 +0100"  >&lt;p&gt;+1, thanks, Ivan. Committed revision 1171607.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12493154" name="BOOKKEEPER-59.diff" size="5733" author="ikelly" created="Tue, 6 Sep 2011 15:31:32 +0100"/>
                            <attachment id="12493149" name="BOOKKEEPER-59.diff" size="5162" author="ikelly" created="Tue, 6 Sep 2011 14:42:17 +0100"/>
                            <attachment id="12492211" name="BOOKKEEPER-59.diff" size="1748" author="ikelly" created="Tue, 30 Aug 2011 08:49:45 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 Sep 2011 12:14:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60395</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyo09r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>174063</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>