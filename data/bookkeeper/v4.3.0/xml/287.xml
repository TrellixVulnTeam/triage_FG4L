<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:31:49 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-287/BOOKKEEPER-287.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-287] NoSuchElementException in LedgerCacheImpl</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-287</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;2012-06-05 16:24:29,596 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOServerFactory-3181:NIOServerFactory@128&amp;#93;&lt;/span&gt; - Exception in server socket loop: /0.0.0.0&lt;br/&gt;
java.util.NoSuchElementException&lt;br/&gt;
        at java.util.LinkedList.getFirst(LinkedList.java:109)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.LedgerCacheImpl.grabCleanPage(LedgerCacheImpl.java:478)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.LedgerCacheImpl.grabLedgerEntryPage(LedgerCacheImpl.java:169)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.LedgerCacheImpl.putEntryOffset(LedgerCacheImpl.java:199)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.InterleavedLedgerStorage.addEntry(InterleavedLedgerStorage.java:109)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.LedgerDescriptorImpl.addEntry(LedgerDescriptorImpl.java:81)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.Bookie.addEntryInternal(Bookie.java:656)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.Bookie.addEntry(Bookie.java:691)&lt;br/&gt;
        at org.apache.bookkeeper.proto.BookieServer.processPacket(BookieServer.java:368)&lt;br/&gt;
        at org.apache.bookkeeper.proto.NIOServerFactory$Cnxn.readRequest(NIOServerFactory.java:310)&lt;br/&gt;
        at org.apache.bookkeeper.proto.NIOServerFactory$Cnxn.doIO(NIOServerFactory.java:208)&lt;br/&gt;
        at org.apache.bookkeeper.proto.NIOServerFactory.run(NIOServerFactory.java:123)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12559455">BOOKKEEPER-287</key>
            <summary>NoSuchElementException in LedgerCacheImpl</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Jun 2012 23:09:49 +0100</created>
                <updated>Mon, 14 Jan 2013 16:14:57 +0000</updated>
                            <resolved>Wed, 6 Jun 2012 17:38:33 +0100</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13289794" author="fpj" created="Tue, 5 Jun 2012 23:25:58 +0100"  >&lt;p&gt;Sounds like a blocker to me, is it right?&lt;/p&gt;

&lt;p&gt;My findings so far. It seems to happen in the case that in LedgerCacheImpl.grabCleanPage we have that:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;pageCount &amp;gt;= pageLimit&lt;/li&gt;
	&lt;li&gt;cleanLedger is empty&lt;/li&gt;
	&lt;li&gt;pages is empty&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It doesn&apos;t sound like a race on cleanLedgers because it is only manipulated in grabCleanPages and deleteLedger, both accesses synchronized. Consequently, it sounds like an issue with pages. If pages were not empty, then the for loop in the &quot;if (cleanLedgers.isEmpty())&quot; would have added elements to cleanLedgers. My conclusion is that pages is empty. We remove elements from pages in deleteLedger, so I&apos;m wondering if all ledgers have been deleted between the first &quot;synchronized(this)&quot; block and outerLoop. If this is the case, the only solution I see is to make the whole method synchronized.&lt;/p&gt;

&lt;p&gt;I don&apos;t know how to reproduce this.&lt;/p&gt;
</comment>
                            <comment id="13289913" author="hustlmsp" created="Wed, 6 Jun 2012 03:46:16 +0100"  >&lt;p&gt;@Flavio:&lt;/p&gt;

&lt;p&gt;yes, ur right. this is a blocker.&lt;/p&gt;

&lt;p&gt;synchronized whole method doesn&apos;t resolve the issue. the worst thing of this issue is that deleteLedger remove LedgerPages from LedgerCache without decrementing pageCount, which would exhaust ledger cache. it is similar as &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-198&quot; title=&quot;replaying entries of deleted ledgers would exhaust ledger cache.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-198&quot;&gt;&lt;del&gt;BOOKKEEPER-198&lt;/del&gt;&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="13289919" author="hustlmsp" created="Wed, 6 Jun 2012 04:02:29 +0100"  >&lt;p&gt;Attach a test case to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="13289927" author="hustlmsp" created="Wed, 6 Jun 2012 04:36:02 +0100"  >&lt;p&gt;Attach a patch to fix the issue by decrementing pageCount when deleteLedger. &lt;/p&gt;</comment>
                            <comment id="13289997" author="fpj" created="Wed, 6 Jun 2012 08:30:58 +0100"  >&lt;p&gt;Great catch, Sijie! I have two comments on the patch:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;In grabCleanPage, there is only a small block that is not synchronized under &quot;this&quot;. I think that if we synchronize the method, we would be able to get rid of that outerLoop jump and I&apos;m thinking that it shouldn&apos;t make much of a difference with respect to concurrency because most of the code is synchronized under &quot;this&quot; anyway. How do you feel about this?&lt;/li&gt;
	&lt;li&gt;I think that the log message inside &quot;if (pageCount &amp;lt; 0) {&quot; this block should be at least an error.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;There are a bunch of typos in comments (not in your patch, but there is one in our patch too) across LedgerCacheImpl. It would be good to fix those. They shouldn&apos;t be in the diff file, since they would mix up with the real fix, but it would be good if the committer who commits it could fix the typos.   &lt;/p&gt;</comment>
                            <comment id="13290032" author="hustlmsp" created="Wed, 6 Jun 2012 09:59:56 +0100"  >&lt;blockquote&gt;
&lt;p&gt;I think that if we synchronize the method, we would be able to get rid of that outerLoop jump and I&apos;m thinking that it shouldn&apos;t make much of a difference with respect to concurrency because most of the code is synchronized under &quot;this&quot; anyway. How do you feel about this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think so. Actually flushLedger is an expensive operation, if we synchronized the whole method, all grabCleanPage would be blocked on a flush. it effects the performance in following situation.&lt;/p&gt;

&lt;p&gt;request1 =&amp;gt; grabCleanPage =&amp;gt; flushLedger&lt;br/&gt;
gc thread =&amp;gt; deleteLedgers (some pages are returned to ledger cache)&lt;br/&gt;
request2 =&amp;gt; grabCleanPage&lt;/p&gt;

&lt;p&gt;if we synchronized whole method, request2 could only grab page after request1 finished.&lt;/p&gt;

&lt;p&gt;if we don&apos;t synchronize whole method, during request1 flushing some pages. gc thread could delete ledgers to return pages back to ledger cache. so request2 could get the pages quickly.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I think that the log message inside &quot;if (pageCount &amp;lt; 0) {&quot; this block should be at least an error.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;would improve it to error level.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There are a bunch of typos in comments (not in your patch, but there is one in our patch too) across LedgerCacheImpl. It would be good to fix those. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;could you point the typos, so that I could find them quickly? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13290041" author="fpj" created="Wed, 6 Jun 2012 10:08:38 +0100"  >&lt;blockquote&gt;&lt;p&gt;Actually flushLedger is an expensive operation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a good point, I agree.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;could you point the typos&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Search for: exhuasting, Yeild., incorret&lt;br/&gt;
In your patch: Weired! (sorry for being boring, but I would simply remove the &quot;Weird!&quot; interjection)&lt;/p&gt;</comment>
                            <comment id="13290047" author="ikelly" created="Wed, 6 Jun 2012 10:25:01 +0100"  >&lt;blockquote&gt;
&lt;p&gt;1. In grabCleanPage, there is only a small block that is not synchronized under &quot;this&quot;. I think that if we synchronize the method, we would be able to get rid of that outerLoop jump and I&apos;m thinking that it shouldn&apos;t make much of a difference with respect to concurrency because most of the code is synchronized under &quot;this&quot; anyway. How do you feel about this?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;A small section in code, but a long running section. It calls flushLedgers() which does I/O to disk. synchronizing on this would prevent pages from other ledgers being accessed.&lt;/p&gt;</comment>
                            <comment id="13290053" author="ikelly" created="Wed, 6 Jun 2012 10:31:05 +0100"  >&lt;p&gt;Ah, i hadn&apos;t refreshed the page before i commented. Ignore.&lt;/p&gt;</comment>
                            <comment id="13290055" author="fpj" created="Wed, 6 Jun 2012 10:33:35 +0100"  >&lt;p&gt;reinforcement is good &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13290057" author="hustlmsp" created="Wed, 6 Jun 2012 10:41:34 +0100"  >&lt;p&gt;attach a new patch addressing Flavio&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="13290067" author="fpj" created="Wed, 6 Jun 2012 11:11:32 +0100"  >&lt;p&gt;+1, it works for me.&lt;/p&gt;</comment>
                            <comment id="13290137" author="ikelly" created="Wed, 6 Jun 2012 14:17:13 +0100"  >&lt;p&gt;lgtm +1&lt;/p&gt;</comment>
                            <comment id="13290214" author="hustlmsp" created="Wed, 6 Jun 2012 16:42:29 +0100"  >&lt;p&gt;thanks Flavio &amp;amp; Ivan for reviewing it. we had two +1 on it. I would commit it.&lt;/p&gt;</comment>
                            <comment id="13290251" author="hustlmsp" created="Wed, 6 Jun 2012 17:38:33 +0100"  >&lt;p&gt;committed as r1346966 on trunk, as r1346976 on branch 4.1.&lt;/p&gt;</comment>
                            <comment id="13290281" author="hudson" created="Wed, 6 Jun 2012 18:26:08 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #549 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/549/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/549/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-287&quot; title=&quot;NoSuchElementException in LedgerCacheImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-287&quot;&gt;&lt;del&gt;BOOKKEEPER-287&lt;/del&gt;&lt;/a&gt;: NoSuchElementException in LedgerCacheImpl (sijie) (Revision 1346966)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
sijie : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/LedgerCacheTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12531057" name="BK-287-test-case.diff" size="1919" author="hustlmsp" created="Wed, 6 Jun 2012 04:02:29 +0100"/>
                            <attachment id="12531087" name="BOOKKEEPER-287.diff" size="6238" author="hustlmsp" created="Wed, 6 Jun 2012 10:41:34 +0100"/>
                            <attachment id="12531059" name="BOOKKEEPER-287.diff" size="5305" author="hustlmsp" created="Wed, 6 Jun 2012 04:36:02 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 Jun 2012 02:46:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250340</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4rs7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61657</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>