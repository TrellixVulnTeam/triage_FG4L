<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:25:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-299/BOOKKEEPER-299.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-299] Provide LedgerFragmentReplicator which should replicate the fragments found from LedgerChecker</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-299</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Replication worker requires LedgerFragmentReplicator for replicating the actula fragments found from Ledger checker.&lt;/p&gt;

&lt;p&gt;Most of the fragment replication code available in BookKeeperAdmin. We can refactor it to LedgerFragmentReplicator and use it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12594942">BOOKKEEPER-299</key>
            <summary>Provide LedgerFragmentReplicator which should replicate the fragments found from LedgerChecker</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12553925">BOOKKEEPER-237</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="umamaheswararao">Uma Maheswara Rao G</assignee>
                                    <reporter username="umamaheswararao">Uma Maheswara Rao G</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jun 2012 15:08:08 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:46 +0000</updated>
                            <resolved>Sun, 19 Aug 2012 10:40:37 +0100</resolved>
                                    <version>4.2.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                                    <component>bookkeeper-auto-recovery</component>
                    <component>bookkeeper-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13396030" author="umamaheswararao" created="Mon, 18 Jun 2012 17:59:17 +0100"  >&lt;p&gt;Updated intial work for this issue reflecting to &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-247&quot; title=&quot;Detection of under replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-247&quot;&gt;&lt;del&gt;BOOKKEEPER-247&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;ALso did a basic integration test with Rakesh&apos;s Auditor patch and replication worker thread.&lt;/p&gt;

&lt;p&gt;There are some gaps found in this patch related to ensemble identification with firstStoredLedgerEntryID. Will fix that in next version of the patch. This patch will be for direction/approach review. &lt;/p&gt;</comment>
                            <comment id="13398281" author="ikelly" created="Thu, 21 Jun 2012 09:21:39 +0100"  >&lt;p&gt;I would prefer to keep the actual rereplication logic in the client package as it does reach into internals which we would have to make public otherwise. Moving it out of BookKeeperAdmin isn&apos;t a bad idea though, but the API should say on BookKeeperAdmin and call whatever the new class is. Pretty much take LedgerFragmentReplicator, and move it into client package.&lt;/p&gt;

&lt;p&gt;Another thing which would be nice to change here, is that currently the recovery code will try to recover all entries in parallel. I don&apos;t like this. I think it would be better to do it in series, so that we don&apos;t overload the server with a lot of read requests at once.&lt;/p&gt;</comment>
                            <comment id="13399120" author="umamaheswararao" created="Fri, 22 Jun 2012 06:10:35 +0100"  >&lt;p&gt;Thanks a lot Ivan, for your time.&lt;/p&gt;

&lt;p&gt;Make sense to me for moving the code to client package.&lt;/p&gt;

&lt;p&gt;One clarification: are you suggesting like LedgerFragmentReplicator will have BookKeeperAdmin and call the required APIs? Why can&apos;t LedgerFragmentReplicator is an helper class for BookKeeperAdmin for providing fragment replication API&apos;s? one way we can reduce BookKeeperAdmin code also because we may add some more code in future about other admin commands. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Another thing which would be nice to change here, is that currently the recovery code will try to recover all entries in parallel. I don&apos;t like this. I think it would be better to do it in series, so that we don&apos;t overload the server with a lot of read requests at once.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Will do this. But this change will apply for BKadmin also as i am using common peice of code for both ReplicationWorker and BKAdmin, is that fine?&lt;/p&gt;</comment>
                            <comment id="13399238" author="ikelly" created="Fri, 22 Jun 2012 10:33:19 +0100"  >&lt;p&gt;LedgerFragmentReplicator should be as it is, but all methods on it should be package private (or private). Then BookKeeperAdmin can call into LedgerFragmentReplicator to do the actual rereplication, so yes, LedgerFragmentReplicator is effectively a helper class. I&apos;d like to move as much code as possible out of BookKeeperAdmin.&lt;/p&gt;</comment>
                            <comment id="13400393" author="umamaheswararao" created="Mon, 25 Jun 2012 11:13:59 +0100"  >&lt;blockquote&gt;
&lt;p&gt;Another thing which would be nice to change here, is that currently the recovery code will try to recover all entries in parallel. I don&apos;t like this. I think it would be better to do it in series, so that we don&apos;t overload the server with a lot of read requests at once.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I have worked for some time on this part. &lt;br/&gt;
Currently BookKeeperAdmin is opening the ledger first. On the call back of openLedger only, it is chainnig the call backs till it replicates the entries.&lt;/p&gt;

&lt;p&gt;To make the entries sequential, we have to wait, till the first entry complete, to go for next entry to read/write.&lt;br/&gt;
Here the problem I see is, openledger itself holds the executor thread because, callback not completely released as ledgerRecovery initiated on callback to openledger.&lt;br/&gt;
So, for the first entry, even though we recive the Message from BookieServer to PerChannelBookieClient#messageReceived, it is not able to start the submitted thread for handling the reponse for first entry.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
executor.chooseThread(ledgerId).submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SafeRunnable() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void safeRun() {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We may have to make the open ledger call independant and start the ledger recovery once we get the LedgerHandle. &lt;/p&gt;

&lt;p&gt;I think this work can be done in separate JIRA as we may have to refactor more at this lines to make it sequential.&lt;/p&gt;

&lt;p&gt;As part of this JIRA, I will just move some part of the code to LedgerFragmentReplicator from admin and provide the Replicate Fragment API for Replication worker to use. Does this sound fine to you Ivan?&lt;/p&gt;
</comment>
                            <comment id="13400397" author="ikelly" created="Mon, 25 Jun 2012 11:22:07 +0100"  >&lt;p&gt;This sounds fine. If parallel to sequential was straightforward, we could have done it here, but as it is not, we should have another JIRA to look at it.&lt;/p&gt;</comment>
                            <comment id="13400471" author="umamaheswararao" created="Mon, 25 Jun 2012 14:35:55 +0100"  >&lt;p&gt;Moved the ReplicationFragmentReplicator to clinet package.&lt;/p&gt;

&lt;p&gt;Raised the separate JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-315&quot; title=&quot;Ledger entries should be replicated sequentially instead of parallel.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-315&quot;&gt;&lt;del&gt;BOOKKEEPER-315&lt;/del&gt;&lt;/a&gt; for working on sequential entry writes.&lt;/p&gt;</comment>
                            <comment id="13435552" author="umamaheswararao" created="Wed, 15 Aug 2012 22:40:24 +0100"  >&lt;p&gt;Attached new patch and test code in this patch requires BK-247. Please take a look for initial review.&lt;/p&gt;</comment>
                            <comment id="13436867" author="ikelly" created="Fri, 17 Aug 2012 18:00:00 +0100"  >&lt;p&gt;I haven&apos;t looked very deep into this yet, but one suggestion I have, is to make LedgerFragmentReplicator#replicate take a LedgerFragment (Added in BK-247) and a newBookie rather than the long parameter list it has now.&lt;/p&gt;</comment>
                            <comment id="13436895" author="umamaheswararao" created="Fri, 17 Aug 2012 18:33:11 +0100"  >&lt;p&gt;Infact, some of my previous patch has the similar implementation. Again I felt like, don&apos;t want to put new code imports in BKAdmin.&lt;br/&gt;
Anyway that is committed now, I will do that in next patch.&lt;/p&gt;</comment>
                            <comment id="13437013" author="umamaheswararao" created="Fri, 17 Aug 2012 20:45:31 +0100"  >&lt;p&gt;Attached a patch with your comment addressed and ran the recovery tests and they all are passing.&lt;/p&gt;

&lt;p&gt;Please take a look on this.&lt;/p&gt;</comment>
                            <comment id="13437490" author="ikelly" created="Sun, 19 Aug 2012 10:40:37 +0100"  >&lt;p&gt;Committed as r1374719. Thanks Uma&lt;/p&gt;</comment>
                            <comment id="13437494" author="hudson" created="Sun, 19 Aug 2012 11:24:45 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #657 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/657/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/657/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-299&quot; title=&quot;Provide LedgerFragmentReplicator which should replicate the fragments found from LedgerChecker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-299&quot;&gt;&lt;del&gt;BOOKKEEPER-299&lt;/del&gt;&lt;/a&gt;: Provide LedgerFragmentReplicator which should replicate the fragments found from LedgerChecker (umamahesh via ivank) (Revision 1374719)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerFragmentReplicator.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/TestLedgerFragmentReplication.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12554513">BOOKKEEPER-247</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12541470" name="BOOKKEEPER-299.patch" size="39657" author="umamaheswararao" created="Sat, 18 Aug 2012 06:01:08 +0100"/>
                            <attachment id="12541134" name="BOOKKEEPER-299.patch" size="39793" author="umamaheswararao" created="Wed, 15 Aug 2012 22:10:46 +0100"/>
                            <attachment id="12533311" name="BOOKKEEPER-299.patch" size="40616" author="umamaheswararao" created="Mon, 25 Jun 2012 14:35:55 +0100"/>
                            <attachment id="12532426" name="BOOKKEEPER-299.patch" size="42254" author="umamaheswararao" created="Mon, 18 Jun 2012 17:53:36 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 21 Jun 2012 08:21:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293548</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyn6hj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169238</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>