<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:26:30 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-106/BOOKKEEPER-106.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-106] recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-106</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;As the summary says, if you don&apos;t specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn&apos;t take care to select a bookie which is not is the ledgers ensemble.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12530339">BOOKKEEPER-106</key>
            <summary>recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Nov 2011 16:19:55 +0000</created>
                <updated>Wed, 7 Dec 2011 15:56:11 +0000</updated>
                            <resolved>Tue, 15 Nov 2011 18:45:41 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13148550" author="ikelly" created="Fri, 11 Nov 2011 16:04:21 +0000"  >&lt;p&gt;Attached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I&apos;ve tries to unnest a little. &lt;/p&gt;

&lt;p&gt;Ledger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.&lt;/p&gt;

&lt;p&gt;I&apos;ve also added a couple of tests and some test framework stuff to verify that entries are all replicated.&lt;/p&gt;</comment>
                            <comment id="13148551" author="jiraposter@reviews.apache.org" created="Fri, 11 Nov 2011 16:06:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2806/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;As the summary says, if you don&apos;t specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn&apos;t take care to select a bookie which is not is the ledgers ensemble.&lt;/p&gt;

&lt;p&gt;Attached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I&apos;ve tries to unnest a little.&lt;/p&gt;

&lt;p&gt;Ledger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.&lt;/p&gt;

&lt;p&gt;I&apos;ve also added a couple of tests and some test framework stuff to verify that entries are all replicated.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; title=&quot;recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-106&quot;&gt;&lt;del&gt;BOOKKEEPER-106&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-106&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2806/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13150495" author="jiraposter@reviews.apache.org" created="Tue, 15 Nov 2011 13:53:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2806/#review3253&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/#review3253&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Ivan, It is not very easy to review this patch because there is reformatting mixed with the fix itself. My understanding is that the fix itself is essentially the implementation of getNewBookie and the changes to call it. Could you please describe the changes in slightly more detail so that it helps the review?&lt;/p&gt;


&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2806/#comment7284&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/#comment7284&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Is the formatting of this block correct? It doesn&apos;t look like on review board but I need to check on a text editor.&lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2806/#comment7283&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/#comment7283&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Is this todo to the lh.close that is commented out?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fpj&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-11-11 16:05:38, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2806/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-11 16:05:38)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;As the summary says, if you don&apos;t specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn&apos;t take care to select a bookie which is not is the ledgers ensemble.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Attached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I&apos;ve tries to unnest a little.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ledger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;ve also added a couple of tests and some test framework stuff to verify that entries are all replicated.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; title=&quot;recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-106&quot;&gt;&lt;del&gt;BOOKKEEPER-106&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-106&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2806/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13150526" author="jiraposter@reviews.apache.org" created="Tue, 15 Nov 2011 14:41:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2806/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-11-15 14:40:58.957071)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary (updated)&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;As the summary says, if you don&apos;t specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn&apos;t take care to select a bookie which is not is the ledgers ensemble.&lt;/p&gt;

&lt;p&gt;A new bookie is now selected for each bookie &amp;amp; ledger metadata is now updated once each fragment has been replicated. There is a new algorithm for selecting the new bookie, which takes into account the current bookies.&lt;/p&gt;

&lt;p&gt;The structure of the callbacks needed to be changed to allow an update for each individual fragment. Now when you recover a bookie, the recovery callback is wrapped a multi callback (MCB-LEDGERS) is created with a count equal to the number of ledgers which will be recovered. MCB-LEDGERS is passed to call to #recoverLedger for each ledger. #recoverLedger creates a multi callback (MCB-FRAGMENTS), with the number of fragments to be recovered as the count. Then a loop kicks off recovery for each fragment, passing a new SingleFragmentCallback to each. SingleFragmentCallback takes MCB-FRAGMENTS as a parameter, and triggers it each time a fragment recovery completes.&lt;/p&gt;

&lt;p&gt;SingleFragmentCallback and the fragment count multi callback, replace ledgerFragmentMcb, which wrapped LedgerMultiCallbackWrapper, which in turn wrapped MCB-LEDGERS. LedgerMultiCallbackWrapper updated the ledger metadata once during the recovery process, when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. The new approach, writes once per fragment. The callback restructuring was necessary to allow this.&lt;/p&gt;

&lt;p&gt;I&apos;ve also added a couple of tests and some test framework stuff to verify that entries are all replicated.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; title=&quot;recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-106&quot;&gt;&lt;del&gt;BOOKKEEPER-106&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-106&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2806/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13150527" author="jiraposter@reviews.apache.org" created="Tue, 15 Nov 2011 14:41:52 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-11-15 13:53:03, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Ivan, It is not very easy to review this patch because there is reformatting mixed with the fix itself. My understanding is that the fix itself is essentially the implementation of getNewBookie and the changes to call it. Could you please describe the changes in slightly more detail so that it helps the review?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The refactoring in BookKeeperAdmin is part of the fix. The sequence of callbacks and the exact detail of what they do had to be restructured. I updated the description of the review to explain the change. Its quite complex. For BookieRecoveryTest.java, everything below line 430 is new. I had to move the test from org.apache.bookkeeper.test to org.apache.bookkeeper.client to allow it to access the metadata from the ledger handle.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-11-15 13:53:03, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java, line 600&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2806/diff/1/?file=57480#file57480line600&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/diff/1/?file=57480#file57480line600&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Is the formatting of this block correct? It doesn&apos;t look like on review board but I need to check on a text editor.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What looks wrong with it? availableBookies is lined up with the start of the argument list which is in line with Sun conventions (&lt;a href=&quot;http://www.oracle.com/technetwork/java/codeconventions-136091.html#248&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.oracle.com/technetwork/java/codeconventions-136091.html#248&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;There&apos;s a few superfluous spaces (rb marks red), which i need to remove. &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-11-15 13:53:03, fpj wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java, line 605&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2806/diff/1/?file=57482#file57482line605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/diff/1/?file=57482#file57482line605&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Is this todo to the lh.close that is commented out?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is something I need to open another JIRA for. Basically, if you recover a bookie, all ledgers recovered will have their zookeeper metadata changed. If another process is currently writing to the ledger, when they try to close the handle, they will get a KeeperException.BadVersion because the version of the ledger znode has changed. It&apos;s not a correctness issue, but more of something that could be annoying for users. &lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ivan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2806/#review3253&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/#review3253&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-11-11 16:05:38, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2806/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-11 16:05:38)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;As the summary says, if you don&apos;t specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn&apos;t take care to select a bookie which is not is the ledgers ensemble.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Attached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I&apos;ve tries to unnest a little.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ledger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;ve also added a couple of tests and some test framework stuff to verify that entries are all replicated.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; title=&quot;recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-106&quot;&gt;&lt;del&gt;BOOKKEEPER-106&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-106&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2806/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2806/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13150669" author="fpj" created="Tue, 15 Nov 2011 18:45:41 +0000"  >&lt;p&gt;+1, thanks Ivan! Committed revision 1202370 and 1202372. (I forgot to edit CHANGES.txt in the first commit.)&lt;/p&gt;</comment>
                            <comment id="13150688" author="hudson" created="Tue, 15 Nov 2011 19:15:59 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #217 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/217/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/217/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; title=&quot;recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-106&quot;&gt;&lt;del&gt;BOOKKEEPER-106&lt;/del&gt;&lt;/a&gt;:	recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble (forgot to edit CHANGES.txt)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-106&quot; title=&quot;recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-106&quot;&gt;&lt;del&gt;BOOKKEEPER-106&lt;/del&gt;&lt;/a&gt;: recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble&lt;/p&gt;

&lt;p&gt;fpj : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;fpj : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12503380" name="BOOKKEEPER-106.diff" size="59000" author="ikelly" created="Fri, 11 Nov 2011 16:04:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 11 Nov 2011 16:06:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216077</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hynz47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>173876</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>