<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:28:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-175/BOOKKEEPER-175.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-175] Bookie code is very coupled</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-175</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Bookie owns EntryLogger, LedgerCache, LedgerDescriptors which all depend on each other in strange ways. Sometimes we access the ledgerCache directly, sometimes through LedgerDescriptors. etc, etc. It&apos;s messy and there&apos;s no hierarchy.&lt;/p&gt;

&lt;p&gt;I propose that we refactor Bookie to only contain the EntryLogger and journalling code (this should be factored at some stage also). The EntryLogger can then own the ledgerCache and the LedgerDescriptors, and then we would how have to have the entanglement as observed on &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-160&quot; title=&quot;bookie server needs to do compaction over entry log files to reclaim disk space&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-160&quot;&gt;&lt;del&gt;BOOKKEEPER-160&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12543034">BOOKKEEPER-175</key>
            <summary>Bookie code is very coupled</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Feb 2012 10:01:04 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:17 +0100</updated>
                            <resolved>Tue, 20 Mar 2012 13:09:42 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="13228338" author="fpj" created="Tue, 13 Mar 2012 11:52:49 +0000"  >&lt;p&gt;Moving it to 4.2.0.&lt;/p&gt;</comment>
                            <comment id="13232570" author="ikelly" created="Mon, 19 Mar 2012 11:42:20 +0000"  >&lt;p&gt;Patch moves handle creation out of bookie. There are now two types of handle, LedgerDescriptorImpl and LedgerDescriptorReadOnlyImpl. Any attempt to use the read only version for writing will throw an exception. This should make implementing &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; (check passwd on fencing) trivial.&lt;/p&gt;</comment>
                            <comment id="13232571" author="jiraposter@reviews.apache.org" created="Mon, 19 Mar 2012 11:45:37 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/4405/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4405/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Patch creates LedgerCache interface, and LedgerCacheImpl, which implements the interface. LedgerCacheImpl&apos;s contains what LedgerCache did before the change. LedgerDescriptor uses LedgerCacheImpl directly now, which is ugly, but its only temporary as &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-175&quot; title=&quot;Bookie code is very coupled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-175&quot;&gt;&lt;del&gt;BOOKKEEPER-175&lt;/del&gt;&lt;/a&gt; will fix LedgerDescriptors.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-175&quot; title=&quot;Bookie code is very coupled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-175&quot;&gt;&lt;del&gt;BOOKKEEPER-175&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-175&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-175&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 6e47c08 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/HandleFactory.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/HandleFactoryImpl.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 87a1e66 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptorImpl.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptorReadOnlyImpl.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/4405/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4405/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13233267" author="jiraposter@reviews.apache.org" created="Tue, 20 Mar 2012 07:01:38 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/4405/#review6113&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4405/#review6113&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/4405/#comment13142&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4405/#comment13142&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    do you consider moving masterKeyCache into ledgerCache? it seems that would be more clear.&lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/4405/#comment13143&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4405/#comment13143&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    it seems that there is a reference counting in ledger handle before. but after refactoring, you remove it. so is it OK?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sijie&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-03-19 11:43:51, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/4405/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4405/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-03-19 11:43:51)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Patch creates LedgerCache interface, and LedgerCacheImpl, which implements the interface. LedgerCacheImpl&apos;s contains what LedgerCache did before the change. LedgerDescriptor uses LedgerCacheImpl directly now, which is ugly, but its only temporary as &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-175&quot; title=&quot;Bookie code is very coupled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-175&quot;&gt;&lt;del&gt;BOOKKEEPER-175&lt;/del&gt;&lt;/a&gt; will fix LedgerDescriptors.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-175&quot; title=&quot;Bookie code is very coupled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-175&quot;&gt;&lt;del&gt;BOOKKEEPER-175&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-175&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-175&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 6e47c08 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/HandleFactory.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/HandleFactoryImpl.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 87a1e66 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptorImpl.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptorReadOnlyImpl.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/4405/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/4405/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13233314" author="ikelly" created="Tue, 20 Mar 2012 09:04:55 +0000"  >&lt;blockquote&gt;
&lt;p&gt;do you consider moving masterKeyCache into ledgerCache? it seems that would be more clear.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The masterKeyCache belongs with the journal, because the masterKeyCache is an optimisation for the journal. We only need it because we don&apos;t want to store the password with every journal entry. I have been thinking about moving the journal code out of Bookie. If/When I do that, ill move masterKeyCache with it.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;it seems that there is a reference counting in ledger handle before. but after refactoring, you remove it. so is it OK?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It was never used. Removing it makes the code quite a bit cleaner.&lt;/p&gt;</comment>
                            <comment id="13233316" author="ikelly" created="Tue, 20 Mar 2012 09:05:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;It was never used.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;By which i mean, it was incremented and decremented but the resulting value was never used.&lt;/p&gt;</comment>
                            <comment id="13233347" author="hustlmsp" created="Tue, 20 Mar 2012 10:56:55 +0000"  >&lt;p&gt;thanks for Ivan&apos;s replies. the patch is good to me. +1.&lt;/p&gt;</comment>
                            <comment id="13233392" author="ikelly" created="Tue, 20 Mar 2012 13:09:43 +0000"  >&lt;p&gt;Committed as r1302870, thanks for reviewing Sijie&lt;/p&gt;</comment>
                            <comment id="13233873" author="hudson" created="Tue, 20 Mar 2012 22:18:27 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #419 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/419/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/419/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-175&quot; title=&quot;Bookie code is very coupled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-175&quot;&gt;&lt;del&gt;BOOKKEEPER-175&lt;/del&gt;&lt;/a&gt;: Bookie code is very coupled (ivank) (Revision 1302870)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/HandleFactory.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/HandleFactoryImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptorImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptorReadOnlyImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12518893" name="BOOKKEEPER-175.diff" size="26214" author="ikelly" created="Mon, 19 Mar 2012 11:42:19 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12547006">BOOKKEEPER-187</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Mar 2012 11:52:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>228320</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4rz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61688</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>