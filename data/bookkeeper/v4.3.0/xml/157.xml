<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:33:01 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-157/BOOKKEEPER-157.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-157] For small packets, increasing number of bookies actually degrades performance.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-157</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;When benchmarking with packets smaller than 1k, performance will degrade when the ensemble contains more than 3 bookies. See attached diagram.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12540356">BOOKKEEPER-157</key>
            <summary>For small packets, increasing number of bookies actually degrades performance.</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Jan 2012 12:17:37 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:14 +0100</updated>
                            <resolved>Wed, 1 Feb 2012 15:20:32 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13196186" author="ikelly" created="Mon, 30 Jan 2012 15:50:54 +0000"  >&lt;p&gt;The issue is in the client, though I&apos;m still not sure what the exact cause is. What we do know is that as you add bookies to the ensemble, the latency per request increases. The solution I found was to increase the number of threads actually being used to send data. This brought throughput up to what would be expected when you add bookies.&lt;/p&gt;</comment>
                            <comment id="13196190" author="jiraposter@reviews.apache.org" created="Mon, 30 Jan 2012 15:54:09 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3696/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;When benchmarking with packets smaller than 1k, performance will degrade when the ensemble contains more than 3 bookies. See attached diagram.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-157&quot; title=&quot;For small packets, increasing number of bookies actually degrades performance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-157&quot;&gt;&lt;del&gt;BOOKKEEPER-157&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-157&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-157&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/CRC32DigestManager.java fb7c8bc &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java 547e240 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/MacDigestManager.java a3ed9f3 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3696/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13196204" author="ikelly" created="Mon, 30 Jan 2012 16:23:19 +0000"  >&lt;p&gt;I think I&apos;ve figured it out. Netty is doing some buffering. (see &lt;a href=&quot;http://grepcode.com/file/repo1.maven.org/maven2/org.jboss.netty/netty/3.2.4.Final/org/jboss/netty/channel/socket/nio/NioSocketChannel.java#158&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;NioSocketChannel&lt;/a&gt;) . If the thread writing to the channel cannot saturate it, due to a lot of time being spent calculating the digests, then buffering will happen. With more bookies, you have more NioSocketChannels, and more buffers which you&apos;re not able to saturate. By increasing the threads calculating the digests we can saturate the buffers, and allow more bookies to improve throughput.&lt;/p&gt;</comment>
                            <comment id="13196898" author="hustlmsp" created="Tue, 31 Jan 2012 13:17:54 +0000"  >&lt;p&gt;Ivan, do you have the new performance number applying this patch?&lt;/p&gt;</comment>
                            <comment id="13196938" author="ikelly" created="Tue, 31 Jan 2012 14:14:17 +0000"  >&lt;p&gt;Attached. I meant to put it up yesterday, but it slipped my mind.&lt;/p&gt;</comment>
                            <comment id="13197290" author="fpj" created="Tue, 31 Jan 2012 21:31:07 +0000"  >&lt;p&gt;Just so that I make sure I understand, the discussion about netty is to justify the solution of the patch, right?&lt;/p&gt;</comment>
                            <comment id="13197312" author="jiraposter@reviews.apache.org" created="Tue, 31 Jan 2012 22:11:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3696/#review4711&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/#review4711&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;This patch seems to enables us to increase the number of threads, but it doesn&apos;t actually increase it or allow an application to increase it through configuration. Is this intentional?&lt;/p&gt;


&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3696/#comment10436&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/#comment10436&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Why do we need this synchronized block? Could you add a comment, please?&lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3696/#comment10434&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/#comment10434&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Why do we need this synchronized block? Could you add a comment, please?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fpj&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-01-30 15:53:51, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3696/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-01-30 15:53:51)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;When benchmarking with packets smaller than 1k, performance will degrade when the ensemble contains more than 3 bookies. See attached diagram.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-157&quot; title=&quot;For small packets, increasing number of bookies actually degrades performance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-157&quot;&gt;&lt;del&gt;BOOKKEEPER-157&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-157&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-157&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/CRC32DigestManager.java fb7c8bc &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java 547e240 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/client/MacDigestManager.java a3ed9f3 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3696/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13197716" author="ikelly" created="Wed, 1 Feb 2012 09:41:28 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Just so that I make sure I understand, the discussion about netty is to justify the solution of the patch, right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, it&apos;s purely informational.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This patch seems to enables us to increase the number of threads, but it doesn&apos;t actually increase it or allow an application to increase it through configuration. Is this intentional?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I didn&apos;t touch the number of threads which are actually created, I just removed the bottleneck which occurs when writing to a single ledger, that only one of the worker threads is used.&lt;/p&gt;

&lt;p&gt;I&apos;ll add a comment to the synchronisation now.&lt;/p&gt;</comment>
                            <comment id="13197726" author="ikelly" created="Wed, 1 Feb 2012 10:04:56 +0000"  >&lt;p&gt;Added comments to synchronization and actually fixed it for asyncClose (was syncing on the SafeRunnable rather than the LedgerHandle).&lt;/p&gt;</comment>
                            <comment id="13197728" author="jiraposter@reviews.apache.org" created="Wed, 1 Feb 2012 10:06:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3696/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-01 10:05:33.642183)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;When benchmarking with packets smaller than 1k, performance will degrade when the ensemble contains more than 3 bookies. See attached diagram.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-157&quot; title=&quot;For small packets, increasing number of bookies actually degrades performance.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-157&quot;&gt;&lt;del&gt;BOOKKEEPER-157&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-157&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-157&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/CRC32DigestManager.java fb7c8bc &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java 547e240 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/MacDigestManager.java a3ed9f3 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3696/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3696/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13197903" author="fpj" created="Wed, 1 Feb 2012 15:20:32 +0000"  >&lt;p&gt;+1, thanks Ivan. Committed revision 1239167.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12512739" name="BOOKKEEPER-157.diff" size="7377" author="ikelly" created="Wed, 1 Feb 2012 10:04:56 +0000"/>
                            <attachment id="12512424" name="BOOKKEEPER-157.diff" size="7022" author="ikelly" created="Mon, 30 Jan 2012 15:52:36 +0000"/>
                            <attachment id="12512407" name="run1.pdf" size="6156" author="ikelly" created="Mon, 30 Jan 2012 12:18:40 +0000"/>
                            <attachment id="12512567" name="varySize.pdf" size="6287" author="ikelly" created="Tue, 31 Jan 2012 14:14:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 30 Jan 2012 15:54:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>225769</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4s9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61736</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>