<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:31:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-678/BOOKKEEPER-678.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-678] BookieServer shutdown hangs indefinitely at NioServerSocketChannelFactory.releaseExternalResources</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-678</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;BookieFailureTest testcase hangs randomly in my environment(Windows 7), when I checked the threaddump, its waiting at NIO&apos;s releaseExternalResources. Please have a look at the following threaddump.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-6&quot;&lt;/span&gt; prio=6 tid=0x0000000007676800 nid=0x19ac waiting on condition [0x000000000b1ae000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000000c3278068&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2025)
	at java.util.concurrent.ThreadPoolExecutor.awaitTermination(ThreadPoolExecutor.java:1261)
	at org.jboss.netty.util.internal.ExecutorUtil.terminate(ExecutorUtil.java:107)
	at org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory.releaseExternalResources(NioServerSocketChannelFactory.java:146)
	at org.apache.bookkeeper.proto.BookieNettyServer.shutdown(BookieNettyServer.java:149)
	at org.apache.bookkeeper.proto.BookieServer.shutdown(BookieServer.java:138)
	- locked &amp;lt;0x00000000c3277ca8&amp;gt; (a org.apache.bookkeeper.proto.BookieServer)
	at org.apache.bookkeeper.test.BookieFailureTest.auxTestReadWriteAsyncSingleClient(BookieFailureTest.java:177)
	at org.apache.bookkeeper.test.BookieFailureTest.testAsyncBK3(BookieFailureTest.java:114)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, full threaddump is attached to this JIRA.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12666486">BOOKKEEPER-678</key>
            <summary>BookieServer shutdown hangs indefinitely at NioServerSocketChannelFactory.releaseExternalResources</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh R</assignee>
                                    <reporter username="rakeshr">Rakesh R</reporter>
                        <labels>
                    </labels>
                <created>Sun, 1 Sep 2013 10:18:58 +0100</created>
                <updated>Fri, 22 Nov 2013 09:58:24 +0000</updated>
                            <resolved>Fri, 22 Nov 2013 09:41:21 +0000</resolved>
                                                    <fixVersion>4.3.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13755692" author="rakeshr" created="Sun, 1 Sep 2013 11:09:51 +0100"  >&lt;p&gt;From the netty documentation, releaseExternalResources would hang when there&apos;s an open channel which is managed by the channel factory. But I couldn&apos;t see any channel leaking from our BookieNettyServer logic and seen allChannels are properly adding it to the ChannelGroup and closing it before calling releaseExternalResources.&lt;/p&gt;


&lt;p&gt;Considering possible bug fixes in the netty project, I had tried by upgrading netty to &apos;3.2.9.Final&apos; version and now bkserver is not hanging. Any thoughts?&lt;/p&gt;</comment>
                            <comment id="13755699" author="hadoopqa" created="Sun, 1 Sep 2013 11:59:39 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-678&quot; title=&quot;BookieServer shutdown hangs indefinitely at NioServerSocketChannelFactory.releaseExternalResources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-678&quot;&gt;&lt;del&gt;BOOKKEEPER-678&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12600975/0001-BOOKKEEPER-678-upgraded-netty-version.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-678-upgraded-netty-version.patch&lt;/a&gt; downloaded at Sun Sep  1 10:32:11 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch does not add/modify any testcase&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 877&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/479/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/479/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13764009" author="hustlmsp" created="Wed, 11 Sep 2013 06:44:51 +0100"  >&lt;p&gt;is it easy to reproduce this case? it is easy to bump the version, but how could you ensure this issue doesn&apos;t exist after bumping the version. I would like to know the root cause before bumping the version.&lt;/p&gt;</comment>
                            <comment id="13764040" author="rakeshr" created="Wed, 11 Sep 2013 07:17:51 +0100"  >&lt;p&gt;When I ran BookieFailureTest.testAsyncBK3, randomly this test case is hanging. I couldn&apos;t find the cause, when I took threadump it shows the bk#shutdown is indefinitely waiting.&lt;br/&gt;
Anyway I&apos;ll try reading NIO documentation about the possible causes and will see our logic once.&lt;/p&gt;</comment>
                            <comment id="13818224" author="hustlmsp" created="Sat, 9 Nov 2013 18:13:18 +0000"  >&lt;p&gt;cancelled until we find the root cause.&lt;/p&gt;</comment>
                            <comment id="13825336" author="rakeshr" created="Mon, 18 Nov 2013 14:14:52 +0000"  >&lt;p&gt;In my laptop(Windows-7, 64bit machine) BookieFailureTest.testAsyncBK3 test case is failing. From netty, releaseExternalResources would hang when there&apos;s an open channel exist. I could see bug fix &lt;a href=&quot;https://issues.jboss.org/browse/NETTY-417&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.jboss.org/browse/NETTY-417&lt;/a&gt; which talks about the possibilities of open channels after closure. Also, when seen netty release notes there are other potential bug fixes happened after 3.2.4 (I didn&apos;t gone through much on their internals about these fixes).&lt;/p&gt;</comment>
                            <comment id="13825513" author="ikelly" created="Mon, 18 Nov 2013 17:35:51 +0000"  >&lt;p&gt;How reliably does it repro without the fix?&lt;/p&gt;</comment>
                            <comment id="13825550" author="rakeshr" created="Mon, 18 Nov 2013 18:09:02 +0000"  >&lt;p&gt;I&apos;ve observed few times, the test is failing(hanging) randomly and threaddump shows indefinite waiting.&lt;/p&gt;</comment>
                            <comment id="13826620" author="ikelly" created="Tue, 19 Nov 2013 15:50:12 +0000"  >&lt;p&gt;Have you tried running the test in a loop on your machine? Not sure how to do this in windows, but it should be possible.&lt;/p&gt;</comment>
                            <comment id="13827733" author="rakeshr" created="Wed, 20 Nov 2013 15:03:26 +0000"  >&lt;p&gt;Thanks for the hint. I&apos;ve attached test case, where I&apos;m restarting bookie 100 times and is always hanging with netty3.2.4-Final. When I test with 3.2.9-Final, its working fine. Please have a look at the testcase.&lt;/p&gt;</comment>
                            <comment id="13829833" author="ikelly" created="Fri, 22 Nov 2013 09:41:21 +0000"  >&lt;p&gt;Committed r1544452. Thanks Rakesh.&lt;/p&gt;

&lt;p&gt;I couldn&apos;t get it to repro, but I don&apos;t have a windows machine to hand, and that specific fix seems to be for windows.&lt;/p&gt;</comment>
                            <comment id="13829843" author="hudson" created="Fri, 22 Nov 2013 09:58:24 +0000"  >&lt;p&gt;FAILURE: Integrated in bookkeeper-trunk #447 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/447/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/447/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-678&quot; title=&quot;BookieServer shutdown hangs indefinitely at NioServerSocketChannelFactory.releaseExternalResources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-678&quot;&gt;&lt;del&gt;BOOKKEEPER-678&lt;/del&gt;&lt;/a&gt;: BookieServer shutdown hangs indefinitely at NioServerSocketChannelFactory.releaseExternalResources (rakeshr via ivank) (ivank: rev 1544452)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/pom.xml&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieShutdownTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12600972" name="0001-BOOKKEEPER-678-ThreadDump-bkServer-hangs-at-release-external-resources.th" size="69112" author="rakeshr" created="Sun, 1 Sep 2013 10:21:50 +0100"/>
                            <attachment id="12600975" name="0001-BOOKKEEPER-678-upgraded-netty-version.patch" size="454" author="rakeshr" created="Sun, 1 Sep 2013 11:10:22 +0100"/>
                            <attachment id="12614898" name="0002-BOOKKEEPER-678.patch" size="4156" author="rakeshr" created="Wed, 20 Nov 2013 14:57:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 1 Sep 2013 10:59:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346425</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzhky7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346726</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>