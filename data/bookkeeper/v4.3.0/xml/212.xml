<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:31:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-212/BOOKKEEPER-212.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-212] Bookie stops responding when creating and deleting many ledgers</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-212</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;I have written down a short app to try to reproduce one problematic case reported on the user list. The app does the following:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;It creates initially a number of ledgers, say 2000;&lt;/li&gt;
	&lt;li&gt;Once it reaches 2000, for each new ledger it creates, it deletes the one at the head of the list;&lt;/li&gt;
	&lt;li&gt;Before closing the ledger, it adds 5 entries of 1k, just to generate some traffic for any given ledger.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;What I tried to achieve is to have thousands of active ledgers and delete new ledgers as I create new ones. I&apos;ll post a link to my test code later. &lt;/p&gt;

&lt;p&gt;At some point, one bookie stops responding. The bookie seems to be up, but it is not responsive. Looking at the logs, this is what I see:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-04-06 12:22:05,765 - INFO  [SyncThread:LedgerCacheImpl@682] - Ledger 1726 is evicted from file info cache.
2012-04-06 12:22:05,769 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1727 is evicted from file info cache.
2012-04-06 12:22:05,772 - INFO  [SyncThread:LedgerCacheImpl@682] - Ledger 1728 is evicted from file info cache.
2012-04-06 12:22:05,780 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1729 is evicted from file info cache.
2012-04-06 12:22:05,787 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1730 is evicted from file info cache.
2012-04-06 12:22:05,794 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1731 is evicted from file info cache.
2012-04-06 12:22:05,801 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1732 is evicted from file info cache.
2012-04-06 12:22:05,807 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1733 is evicted from file info cache.
2012-04-06 12:22:05,822 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1734 is evicted from file info cache.
2012-04-06 12:22:05,828 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1735 is evicted from file info cache.
2012-04-06 12:22:05,842 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1736 is evicted from file info cache.
2012-04-06 12:22:05,851 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1737 is evicted from file info cache.
2012-04-06 12:22:05,856 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1738 is evicted from file info cache.
2012-04-06 12:22:05,864 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1739 is evicted from file info cache.
2012-04-06 12:22:05,874 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1740 is evicted from file info cache.
2012-04-06 12:22:05,885 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1741 is evicted from file info cache.
2012-04-06 12:22:05,894 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1742 is evicted from file info cache.
2012-04-06 12:22:05,902 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1743 is evicted from file info cache.
2012-04-06 12:22:05,987 - INFO  [GarbageCollectorThread:LedgerCacheImpl@682] - Ledger 1744 is evicted from file info cache.
2012-04-06 12:22:05,987 - ERROR [GarbageCollectorThread:GarbageCollectorThread$1@244] - Exception when deleting the ledger index file on the Bookie: 
java.io.IOException: /home/fpj/bk/current/1/b/10b.idx not found
        at org.apache.bookkeeper.bookie.FileInfo.checkOpen(FileInfo.java:118)
        at org.apache.bookkeeper.bookie.FileInfo.close(FileInfo.java:194) 
        at org.apache.bookkeeper.bookie.LedgerCacheImpl.deleteLedger(LedgerCacheImpl.java:619) 
        at org.apache.bookkeeper.bookie.GarbageCollectorThread$1.gc(GarbageCollectorThread.java:242)
        at org.apache.bookkeeper.meta.AbstractZkLedgerManager.doGc(AbstractZkLedgerManager.java:274)
        at org.apache.bookkeeper.meta.FlatLedgerManager.garbageCollectLedgers(FlatLedgerManager.java:168)
        at org.apache.bookkeeper.bookie.GarbageCollectorThread.doGcLedgers(GarbageCollectorThread.java:237)
        at org.apache.bookkeeper.bookie.GarbageCollectorThread.run(GarbageCollectorThread.java:206) 
2012-04-06 12:22:05,987 - INFO  [GarbageCollectorThread:LedgerCacheImpl@682] - Ledger 1745 is evicted from file info cache.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are lots of exceptions like that, but otherwise I don&apos;t see anything that could make the bookie unresponsive. I&apos;ll upload the logs as well.   &lt;/p&gt;</description>
                <environment></environment>
        <key id="12549872">BOOKKEEPER-212</key>
            <summary>Bookie stops responding when creating and deleting many ledgers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="fpj">Flavio Junqueira</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Apr 2012 13:40:22 +0100</created>
                <updated>Mon, 22 Oct 2012 15:50:14 +0100</updated>
                            <resolved>Mon, 9 Apr 2012 10:44:34 +0100</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13248288" author="fpj" created="Fri, 6 Apr 2012 13:51:00 +0100"  >&lt;p&gt;Here is the git repository for the test code: &lt;a href=&quot;https://github.com/fpj/bk-ledger-load&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/fpj/bk-ledger-load&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13248327" author="fpj" created="Fri, 6 Apr 2012 14:04:56 +0100"  >&lt;p&gt;I&apos;m attaching the log file of the bookie that became unresponsive. In this run, the app stopped with these error messages:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-04-06 12:22:07,565 - ERROR - [pool-3-thread-1:PerChannelBookieClient@550] - Add for ledger: 2382, entry: 0 failed on bookie: /IP2:3181 with code: 101
2012-04-06 12:22:07,566 - WARN  - [pool-3-thread-1:PendingAddOp@146] - Write did not succeed: 2382, 0
2012-04-06 12:22:07,572 - ERROR - [pool-3-thread-1:LedgerHandle@659] - Could not get additional bookie to remake ensemble, closing ledger: 2382
org.apache.bookkeeper.client.BKException$BKNotEnoughBookiesException
	at org.apache.bookkeeper.client.BKException.create(BKException.java:58)
	at org.apache.bookkeeper.client.LedgerHandle.addEntry(LedgerHandle.java:410)
	at org.apache.bookkeeper.client.LedgerHandle.addEntry(LedgerHandle.java:387)
	at org.apache.bookkeeper.loader.LedgerLoader.main(LedgerLoader.java:38)
2012-04-06 12:22:12,588 - INFO  - [Hashed wheel timer #1:PerChannelBookieClient@447] - Disconnected from bookie: /IP2:3181
2012-04-06 12:22:12,600 - INFO  - [Hashed wheel timer #2:PerChannelBookieClient@447] - Disconnected from bookie: /IP1:3181
2012-04-06 12:22:12,627 - INFO  - [Hashed wheel timer #3:PerChannelBookieClient@447] - Disconnected from bookie: /IP3:3181
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13249291" author="fpj" created="Sat, 7 Apr 2012 17:02:28 +0100"  >&lt;p&gt;I investigated a little further and it looks like the culprit of this exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
2012-04-07 15:25:47,325 - ERROR [GarbageCollectorThread:FileInfo@76] - MasterKey is null
2012-04-07 15:25:47,328 - INFO  [NIOServerFactory-3181:LedgerCacheImpl@682] - Ledger 1131 is evicted from file info cache. 2012-04-07 15:25:47,329 - ERROR [GarbageCollectorThread:GarbageCollectorThread$1@244] - Exception when deleting the ledger index file on the Bookie: 
java.io.IOException: *path*/current/0/3/3.idx not found
        at org.apache.bookkeeper.bookie.FileInfo.checkOpen(FileInfo.java:120)
        at org.apache.bookkeeper.bookie.FileInfo.close(FileInfo.java:196)
        at org.apache.bookkeeper.bookie.LedgerCacheImpl.deleteLedger(LedgerCacheImpl.java:619)
        at org.apache.bookkeeper.bookie.GarbageCollectorThread$1.gc(GarbageCollectorThread.java:242)
        at org.apache.bookkeeper.meta.AbstractZkLedgerManager.doGc(AbstractZkLedgerManager.java:274)
        at org.apache.bookkeeper.meta.FlatLedgerManager.garbageCollectLedgers(FlatLedgerManager.java:168)
        at org.apache.bookkeeper.bookie.GarbageCollectorThread.doGcLedgers(GarbageCollectorThread.java:237)
        at org.apache.bookkeeper.bookie.GarbageCollectorThread.run(GarbageCollectorThread.java:206)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;is this call in LedgerCacheImpl.deleteLedger(): &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;fi = getFileInfo(ledgerId, null);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because the masterKey is set to null, when the call path reaches checkOpen, it ends up throwing an IOException:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;         if (masterKey == null &amp;amp;&amp;amp; !exists) {
            throw new IOException(lf + &quot; not found&quot;);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are two things I don&apos;t understand here:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Why do we set the masterKey to null in the call to getFileInfo in deleteLedger?&lt;/li&gt;
	&lt;li&gt;Why do we check if masterKey is null in checkOpen and throw an exception if it is (along with the file not existing)?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13249680" author="hustlmsp" created="Mon, 9 Apr 2012 06:32:28 +0100"  >&lt;p&gt;@Flavio&lt;/p&gt;

&lt;p&gt;checkOpen is introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;. The case that masterKey is null and the index file is not existed, which means we don&apos;t have the master key to create index file, so we have to throw an exception. &lt;/p&gt;

&lt;p&gt;the exception you found is a weird case, may be introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-190&quot; title=&quot;Add entries would fail when number of open ledgers reaches more than openFileLimit.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-190&quot;&gt;&lt;del&gt;BOOKKEEPER-190&lt;/del&gt;&lt;/a&gt;, where we forced the index creation when a ledger is evicted from ledger cache.&lt;/p&gt;

&lt;p&gt;from the exception stack, it seems that the exception is thrown when deleting ledger 3. but ledger 3 was evicted from ledger cache before, and its ledger index file should be forced to create when the eviction happened. it is so strange why the index file didn&apos;t exist. &lt;/p&gt;</comment>
                            <comment id="13249732" author="hustlmsp" created="Mon, 9 Apr 2012 09:15:20 +0100"  >&lt;p&gt;did some investigation on this issue, I found that it is caused due to ledger cache deletes index file first then closes it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        FileInfo fi = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            fi = getFileInfo(ledgerId, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            fi.delete();
            fi.close(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// should release use count
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// otherwise the file channel would not be closed.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != fi) {
                fi.release();
            }   
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in common case, the above code is OK. since we use &lt;b&gt;useCount&lt;/b&gt;, we can ensure file existed if the useCount is not zero. but if the file info is evicted from ledger cache before, when ledger cache wants to delete such file info, it tries to get file info again but doesn&apos;t open the file channel, so fi#delete() will delete index file immediately. when we tried to close it again, it would fail due to FileNotFound exception.&lt;/p&gt;

&lt;p&gt;fail to removed deleted ledger file info will exhaust openFileLimit, so following creating ledgers would fail because we don&apos;t have buffer to open new ledger file info.&lt;/p&gt;

&lt;p&gt;the fix is quite simply, just need to change the order of fi#delete and fi#close. I would attach a test case and a patch later.&lt;/p&gt;</comment>
                            <comment id="13249736" author="hustlmsp" created="Mon, 9 Apr 2012 09:27:53 +0100"  >&lt;p&gt;attach a patch to fix this issue, including a test case.&lt;/p&gt;</comment>
                            <comment id="13249759" author="fpj" created="Mon, 9 Apr 2012 10:44:02 +0100"  >&lt;p&gt;+1, it looks good to me. I have also run a version with this patch against my simple test case and I don&apos;t see the issue any more. Good job, Sijie!&lt;/p&gt;

&lt;p&gt;Committed revision 1311177.&lt;/p&gt;</comment>
                            <comment id="13249762" author="hudson" created="Mon, 9 Apr 2012 10:53:21 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #449 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/449/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/449/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-212&quot; title=&quot;Bookie stops responding when creating and deleting many ledgers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-212&quot;&gt;&lt;del&gt;BOOKKEEPER-212&lt;/del&gt;&lt;/a&gt;: Bookie stops responding when creating and deleting many ledgers (sijie via fpj) (Revision 1311177)&lt;/p&gt;

&lt;p&gt;     Result = UNSTABLE&lt;br/&gt;
fpj : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/LedgerCreateDeleteTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12521920" name="BK-212.diff" size="3490" author="hustlmsp" created="Mon, 9 Apr 2012 09:27:53 +0100"/>
                            <attachment id="12521672" name="bookkeeper-server.log" size="609867" author="fpj" created="Fri, 6 Apr 2012 14:04:55 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 9 Apr 2012 05:32:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>234863</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4sbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61745</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>