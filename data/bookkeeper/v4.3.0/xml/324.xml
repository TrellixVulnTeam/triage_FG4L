<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:29:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-324/BOOKKEEPER-324.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-324] Flakeyness in LedgerCreateDeleteTest</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-324</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Fails when running in a loop for about 40 minutes. Failure is a ConcurrentModificationException&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &amp;lt;testcase time=&lt;span class=&quot;code-quote&quot;&gt;&quot;3.018&quot;&lt;/span&gt; classname=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.bookkeeper.test.LedgerCreateDeleteTest&quot;&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;testCreateDeleteLedgers&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;error type=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.util.ConcurrentModificationException&quot;&lt;/span&gt;&amp;gt;java.util.ConcurrentModificationException
	at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)
	at java.util.HashMap$EntryIterator.next(HashMap.java:834)
	at java.util.HashMap$EntryIterator.next(HashMap.java:832)
	at org.apache.bookkeeper.bookie.LedgerCacheImpl.close(LedgerCacheImpl.java:781)
	at org.apache.bookkeeper.bookie.InterleavedLedgerStorage.shutdown(InterleavedLedgerStorage.java:73)
	at org.apache.bookkeeper.bookie.Bookie.shutdown(Bookie.java:644)
	at org.apache.bookkeeper.bookie.Bookie.shutdown(Bookie.java:630)
	at org.apache.bookkeeper.proto.BookieServer.shutdown(BookieServer.java:110)
	at org.apache.bookkeeper.test.BookKeeperClusterTestCase.stopBKCluster(BookKeeperClusterTestCase.java:146)
	at org.apache.bookkeeper.test.BookKeeperClusterTestCase.tearDown(BookKeeperClusterTestCase.java:94)
	at junit.framework.TestCase.runBare(TestCase.java:140)
	at junit.framework.TestResult$1.protect(TestResult.java:110)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12597132">BOOKKEEPER-324</key>
            <summary>Flakeyness in LedgerCreateDeleteTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jul 2012 11:35:14 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:45 +0000</updated>
                            <resolved>Wed, 4 Jul 2012 15:18:07 +0100</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13405793" author="ikelly" created="Tue, 3 Jul 2012 11:38:18 +0100"  >&lt;p&gt;the exception is on access to fileInfoCache.&lt;/p&gt;
</comment>
                            <comment id="13405831" author="umamaheswararao" created="Tue, 3 Jul 2012 13:08:01 +0100"  >&lt;p&gt;I think we should synchronize on  fileInfoCache in  LedgerCacheImpl#close method.&lt;/p&gt;

&lt;p&gt;Because, if some threads are putting the element in fileInfoCache and at the same time of shutdown called, close is iterating them. SO, at this time this exception can come. I just reproduce it with LedgerCacheImpl.&lt;/p&gt;

&lt;p&gt;Added two threads to test with debug mode, one for getFileInfo and other for close. then I blocked fileInfo before putting the lelement and allowed close to do one iteration. After the I released getFileInfo thread.&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-07-03 17:32:06,984 - INFO  - [main:LedgerCacheImpl@71] - openFileLimit is 900, pageSize is 8192, pageLimit is 2712
Exception in thread &quot;Thread-1&quot; java.util.ConcurrentModificationException
	at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)
	at java.util.HashMap$EntryIterator.next(HashMap.java:834)
	at java.util.HashMap$EntryIterator.next(HashMap.java:832)
	at org.apache.bookkeeper.bookie.LedgerCacheImpl.close(LedgerCacheImpl.java:840)
	at org.apache.bookkeeper.bookie.LedgerCacheImpl$5.run(LedgerCacheImpl.java:953)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13405907" author="ikelly" created="Tue, 3 Jul 2012 14:19:00 +0100"  >&lt;p&gt;Yup, the fix is quite straight forward. I wanted to check what was causing it though, because by the time close is called, there should be nothing accessing the ledger cache. I tracked it down to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;: SyncThread state RUNNABLE
 +java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
 +org.apache.bookkeeper.bookie.LedgerCacheImpl.flushLedger(LedgerCacheImpl.java:323)
 +org.apache.bookkeeper.bookie.InterleavedLedgerStorage.flush(InterleavedLedgerStorage.java:147)
 +org.apache.bookkeeper.bookie.Bookie$SyncThread.run(Bookie.java:205)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13405938" author="ikelly" created="Tue, 3 Jul 2012 14:57:23 +0100"  >&lt;p&gt;Fix is simple, but i&apos;ve made a few extra safety changes. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the close now synchronizes on the file info cache before doing anything.&lt;/li&gt;
	&lt;li&gt;close clears the file info cache, so that if anything calls anything on the LedgerCacheImpl after close, nothing will happen.&lt;/li&gt;
	&lt;li&gt;Order of creation of the sync thread and entrylogger were the wrong way around. sync thread uses entrylogger, so should only be used after entrylogger is initialized. Viceversa for cleanup.&lt;/li&gt;
	&lt;li&gt;evictFileInfoIfNecessary didn&apos;t necessarily need to sync on fileInfoCache as it is only ever called from within a block which is sync. I made it sync explicitly so that in future it can&apos;t become a problem&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem here had nothing specific to LedgerCreateDeleteTest. It could have happened on any test which shuts down a bookie.&lt;/p&gt;</comment>
                            <comment id="13406417" author="hustlmsp" created="Wed, 4 Jul 2012 11:14:07 +0100"  >&lt;p&gt;lgtm +1. &lt;/p&gt;</comment>
                            <comment id="13406453" author="umamaheswararao" created="Wed, 4 Jul 2012 12:30:02 +0100"  >&lt;blockquote&gt;
&lt;p&gt;Yup, the fix is quite straight forward. I wanted to check what was causing it though, because by the time close is called, there should be nothing accessing the ledger cache. I tracked it down to:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok. Thanks Ivan.&lt;/p&gt;

&lt;p&gt;Looks good +1 from me as well.&lt;/p&gt;</comment>
                            <comment id="13406546" author="ikelly" created="Wed, 4 Jul 2012 15:18:07 +0100"  >&lt;p&gt;Committed r1357277. Thanks for reviewing guys.&lt;/p&gt;</comment>
                            <comment id="13406718" author="hudson" created="Wed, 4 Jul 2012 21:39:48 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #588 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/588/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/588/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-324&quot; title=&quot;Flakeyness in LedgerCreateDeleteTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-324&quot;&gt;&lt;del&gt;BOOKKEEPER-324&lt;/del&gt;&lt;/a&gt;: Flakeyness in LedgerCreateDeleteTest (ivank) (Revision 1357277)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12534871" name="BOOKKEEPER-324.diff" size="3555" author="ikelly" created="Tue, 3 Jul 2012 14:57:22 +0100"/>
                            <attachment id="12534760" name="TEST-org.apache.bookkeeper.test.LedgerCreateDeleteTest.xml" size="7915" author="ikelly" created="Tue, 3 Jul 2012 11:36:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 3 Jul 2012 12:08:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293527</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyn5yf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169152</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>