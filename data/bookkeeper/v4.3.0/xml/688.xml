<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:27:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-688/BOOKKEEPER-688.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-688] NPE exception in PerChannelBookieClient</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-688</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;NPE exception in PerChannelBookieClient:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-10-04 11:56:34,526 - INFO  - [NIOServerFactory-15099:NIOServerFactory$Cnxn@246] - Peer closed connection. rc=-1 java.nio.channels.SocketChannel[connected local=/10.18.170.130:15099 remote=/10.18.170.130:53945]
2013-10-04 11:56:34,526 - INFO  - [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-93:PerChannelBookieClient@493] - Disconnected from bookie channel [id: 0x006287d3, /10.18.170.130:53945 :&amp;gt; /10.18.170.130:15099]
2013-10-04 11:56:34,526 - INFO  - [New I/O client worker #90-3:PerChannelBookieClient$1@137] - Successfully connected to bookie: [id: 0x01964fe8, /10.18.170.130:53951 =&amp;gt; /10.18.170.130:15100]
2013-10-04 11:56:34,542 - INFO  - [NIOServerFactory-15100:NIOServerFactory$Cnxn@246] - Peer closed connection. rc=-1 java.nio.channels.SocketChannel[connected local=/10.18.170.130:15100 remote=/10.18.170.130:53951]
2013-10-04 11:56:34,542 - INFO  - [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-93:PerChannelBookieClient@493] - Disconnected from bookie channel [id: 0x01964fe8, /10.18.170.130:53951 :&amp;gt; /10.18.170.130:15100]
2013-10-04 11:56:34,542 - WARN  - [New I/O client worker #90-3:PerChannelBookieClient@274] - Add entry operation failed
java.lang.NullPointerException
	at org.apache.bookkeeper.proto.PerChannelBookieClient.addEntry(PerChannelBookieClient.java:258)
	at org.apache.bookkeeper.proto.BookieClient$2.operationComplete(BookieClient.java:138)
	at org.apache.bookkeeper.proto.BookieClient$2.operationComplete(BookieClient.java:1)
	at org.apache.bookkeeper.proto.PerChannelBookieClient$1.operationComplete(PerChannelBookieClient.java:173)
	at org.jboss.netty.channel.DefaultChannelFuture.notifyListener(DefaultChannelFuture.java:381)
	at org.jboss.netty.channel.DefaultChannelFuture.notifyListeners(DefaultChannelFuture.java:372)
	at org.jboss.netty.channel.DefaultChannelFuture.setSuccess(DefaultChannelFuture.java:316)
	at org.jboss.netty.channel.socket.nio.NioWorker$RegisterTask.run(NioWorker.java:767)
	at org.jboss.netty.channel.socket.nio.NioWorker.processRegisterTaskQueue(NioWorker.java:256)
	at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:198)
	at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)
	at org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:44)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
4 Oct, 2013 11:56:34 AM org.jboss.netty.channel.DefaultChannelFuture
WARNING: An exception was thrown by ChannelFutureListener.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here the operation which is performed is&lt;br/&gt;
step-1 addEntry asynchronously&lt;br/&gt;
step-2 Immediately after adding the entry, close the bookie client&lt;/p&gt;</description>
                <environment></environment>
        <key id="12672296">BOOKKEEPER-688</key>
            <summary>NPE exception in PerChannelBookieClient</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="rakeshr">Rakesh R</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Oct 2013 08:09:29 +0100</created>
                <updated>Tue, 4 Mar 2014 08:21:34 +0000</updated>
                            <resolved>Tue, 4 Mar 2014 08:21:00 +0000</resolved>
                                    <version>4.2.0</version>
                                    <fixVersion>4.3.0</fixVersion>
                    <fixVersion>4.2.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13786042" author="rakeshr" created="Fri, 4 Oct 2013 11:00:21 +0100"  >
&lt;p&gt;IMO, will try to avoid nullifying the channel. I feel it would be more readable if we could utilize ConnectionStates. As an initial step, I just tried to draw state transition diagram and  attaching the same, please feel free to correct.&lt;/p&gt;

&lt;p&gt;When seeing the code, I got one doubt - is there any case where channelfuture.isSuccess() and future.getChannel() is returning a null reference ?&lt;br/&gt;
Otw I feel &apos;state&apos; is sufficient to control the channel logic.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PerChannelBookieClient.java:

                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.isSuccess() &amp;amp;&amp;amp; state == ConnectionState.CONNECTING) {
                        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Successfully connected to bookie: {}&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.getChannel());
                        rc = BKException.Code.OK;
                        channel = &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.getChannel();
                        state = ConnectionState.CONNECTED;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, if any operations comes to the channel after its closure, it would throw &apos;java.nio.channels.ClosedChannelException&apos;. I think this is fine.&lt;/p&gt;</comment>
                            <comment id="13786054" author="rakeshr" created="Fri, 4 Oct 2013 11:44:07 +0100"  >&lt;p&gt;Attached patch which tries to use ConnectionState.&lt;/p&gt;</comment>
                            <comment id="13786074" author="hadoopqa" created="Fri, 4 Oct 2013 12:19:54 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-688&quot; title=&quot;NPE exception in PerChannelBookieClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-688&quot;&gt;&lt;del&gt;BOOKKEEPER-688&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12606772/BOOKKEEPER-688_trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-688_trunk.patch&lt;/a&gt; downloaded at Fri Oct  4 10:52:01 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch does not add/modify any testcase&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 880&lt;br/&gt;
.    Tests failed: 1&lt;br/&gt;
.    Tests errors: 0&lt;/p&gt;

&lt;p&gt;.    The patch failed the following testcases:&lt;/p&gt;

&lt;p&gt;.      testDisconnectRace(org.apache.bookkeeper.proto.TestPerChannelBookieClient)&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/503/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/503/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13786368" author="ikelly" created="Fri, 4 Oct 2013 18:26:37 +0100"  >&lt;p&gt;The test fails because it&apos;s possible for state == DISCONNECTED, when the channel itself is not yet. See PerChannelBookieClient#closeInternal.&lt;/p&gt;

&lt;p&gt;I&apos;ve wrote a test for the NPE. The npe itself isn&apos;t dangerous. exceptionCaught catches it and errors the ops, which is expected behaviour. Of course, NPE is ugly. There&apos;s a simple fix though. I&apos;ll attach a patch.&lt;/p&gt;</comment>
                            <comment id="13786383" author="hustlmsp" created="Fri, 4 Oct 2013 18:37:35 +0100"  >&lt;p&gt;what is the issue here? NPE is already handled and the addEntry is error&apos;d out (as the channel is already closed). &lt;br/&gt;
And setting channel to null could avoid ending up setting state to DISCONNECTED in channelDisconnected event. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.channel == c
                &amp;amp;&amp;amp; state != ConnectionState.CLOSED) {
                state = ConnectionState.DISCONNECTED;
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13786390" author="hustlmsp" created="Fri, 4 Oct 2013 18:39:49 +0100"  >&lt;p&gt;BTW, as it is actually not an issue, we should not mark 4.2.2 as the fix version.&lt;/p&gt;</comment>
                            <comment id="13786404" author="ikelly" created="Fri, 4 Oct 2013 18:45:51 +0100"  >&lt;p&gt;Hmm, actually there&apos;s no way to test this, without ripping up PerChannelBookieClient. It already catches the exception. I&apos;ve attached a patch to reduce log noise. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hustlmsp&quot; class=&quot;user-hover&quot; rel=&quot;hustlmsp&quot;&gt;Sijie Guo&lt;/a&gt; I agree, not for 4.2.2 in any case.&lt;/p&gt;</comment>
                            <comment id="13786562" author="hadoopqa" created="Fri, 4 Oct 2013 21:07:10 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-688&quot; title=&quot;NPE exception in PerChannelBookieClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-688&quot;&gt;&lt;del&gt;BOOKKEEPER-688&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12606844/0001-BOOKKEEPER-688-NPE-exception-in-PerChannelBookieClie.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0001-BOOKKEEPER-688-NPE-exception-in-PerChannelBookieClie.patch&lt;/a&gt; downloaded at Fri Oct  4 19:39:41 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch does not add/modify any testcase&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 880&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/504/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/504/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13787299" author="rakeshr" created="Sat, 5 Oct 2013 19:57:56 +0100"  >&lt;p&gt;Adding null check is fine. Firstly I also had same fix in mind, while looking at the code I got interested in state transitions and just tried an idea&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. But with my approach, channel closure breaks the atomicity as its not setting to null. I&apos;ve seen the existing testcase is skipping the disconnected/closed channel since the channel is null.&lt;/p&gt;

&lt;p&gt;By looking at the log pattern, the test case failure with my patch is due to :&lt;br/&gt;
1) Successfully establish channel and now the state becomes CONNECTED&lt;br/&gt;
2) Say disconnects, here first sets state to DISCONNECTED and closing the channel outside synchronized block. Actually it may take few moments to close the channel.&lt;br/&gt;
3) At the same time CheckThread enters into the synchronized block and seen DISCONNECTED state and channel.isConnected() true.This causes the failure.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-10-04 11:04:40,408 - INFO  - [New I/O client worker #6-3:PerChannelBookieClient$1@128] - Successfully connected to bookie: [id: 0x00a19cc5, /67.195.138.28:55764 =&amp;gt; asf004.sp2.ygridcore.net/67.195.138.28:15003]
2013-10-04 11:04:40,409 - ERROR - [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-6:TestPerChannelBookieClient$6@200] - State(DISCONNECTED) and channel(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) inconsistent [id: 0x00a19cc5, /67.195.138.28:55764 =&amp;gt; asf004.sp2.ygridcore.net/67.195.138.28:15003]
2013-10-04 11:04:40,409 - INFO  - [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-5:PerChannelBookieClient@456] - Disconnected from bookie channel [id: 0x00a19cc5, /67.195.138.28:55764 :&amp;gt; asf004.sp2.ygridcore.net/67.195.138.28:15003]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13787301" author="rakeshr" created="Sat, 5 Oct 2013 20:04:36 +0100"  >&lt;p&gt;Attached one more patch(used null check). Includes following.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removed unused imports&lt;/li&gt;
	&lt;li&gt;modified channelDisconnected logic, here first sets state and then closing the channel. Whether need to raise separate JIRA for this small change?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13787313" author="hadoopqa" created="Sat, 5 Oct 2013 20:40:01 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-688&quot; title=&quot;NPE exception in PerChannelBookieClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-688&quot;&gt;&lt;del&gt;BOOKKEEPER-688&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12607011/0002-BOOKKEEPER-688-NPE-exception-in-PerChannelBookieClie.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;0002-BOOKKEEPER-688-NPE-exception-in-PerChannelBookieClie.patch&lt;/a&gt; downloaded at Sat Oct  5 19:12:01 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; the patch does not add/modify any testcase&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 880&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/505/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/505/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13787533" author="fpj" created="Sun, 6 Oct 2013 09:57:50 +0100"  >&lt;p&gt;It would be nice to have the connection state diagram as part of the documentation.&lt;/p&gt;</comment>
                            <comment id="13787716" author="hustlmsp" created="Sun, 6 Oct 2013 19:19:44 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;Rakesh R&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;what do you really want to fix in your new patch? please clarify. is it just the test case problem or is it a real issue in PerChannelBookieClient? If not a real issue in PerChannelBookieClient, why you want to change the implementation for a problematic test case? &lt;/p&gt;

&lt;p&gt;I don&apos;t see there is any issue in the steps in #channelDisconnected.&lt;/p&gt;

&lt;p&gt;1) closeChannel first, so the following requests sent to the closedChannel will be error out.&lt;br/&gt;
2) errorOutStandingEntries is to error out all those already outstanding entries sent to that close channel.&lt;br/&gt;
3) state set to DISCONNECTED, so following requests will do reconnect.&lt;/p&gt;

&lt;p&gt;putting 3) after 1) &amp;amp; 3) which will reduce the possibility of error out the entries that sent to new connected channel by mistake. if do the reverse as your patch, it increase the possibility of such mistake. &lt;/p&gt;</comment>
                            <comment id="13787889" author="rakeshr" created="Mon, 7 Oct 2013 04:24:17 +0100"  >&lt;blockquote&gt;&lt;p&gt;putting 3) after 1) &amp;amp; 3) which will reduce the possibility of error out the entries that sent to new connected channel by mistake. if do the reverse as your patch, it increase the possibility of such mistake. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah its true, I&apos;ll cancel the patch.&lt;/p&gt;</comment>
                            <comment id="13788926" author="hustlmsp" created="Tue, 8 Oct 2013 06:30:25 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;Flavio Junqueira&lt;/a&gt; Created &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-690&quot; title=&quot;Add state diagram in document&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-690&quot;&gt;&lt;del&gt;BOOKKEEPER-690&lt;/del&gt;&lt;/a&gt; for the work to add state diagram in document as you suggested.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ikelly&quot; class=&quot;user-hover&quot; rel=&quot;ikelly&quot;&gt;Ivan Kelly&lt;/a&gt; +1 for your patch.&lt;/p&gt;</comment>
                            <comment id="13801497" author="hustlmsp" created="Tue, 22 Oct 2013 06:36:12 +0100"  >&lt;p&gt;committed as r1534498. thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ikelly&quot; class=&quot;user-hover&quot; rel=&quot;ikelly&quot;&gt;Ivan Kelly&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13801528" author="hudson" created="Tue, 22 Oct 2013 07:13:39 +0100"  >&lt;p&gt;SUCCESS: Integrated in bookkeeper-trunk #409 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/409/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/409/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-688&quot; title=&quot;NPE exception in PerChannelBookieClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-688&quot;&gt;&lt;del&gt;BOOKKEEPER-688&lt;/del&gt;&lt;/a&gt;: NPE exception in PerChannelBookieClient (ivank via sijie) (sijie: rev 1534498)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13918384" author="rakeshr" created="Mon, 3 Mar 2014 18:35:19 +0000"  >&lt;p&gt;IMHO, it would be good to backport the changes to branch4.2 as well. Please feel free to close if anyone has different opinion. Thanks&lt;/p&gt;</comment>
                            <comment id="13919127" author="hustlmsp" created="Tue, 4 Mar 2014 08:21:00 +0000"  >&lt;p&gt;merged to branch 4.2 as r1573930.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12606844" name="0001-BOOKKEEPER-688-NPE-exception-in-PerChannelBookieClie.patch" size="4341" author="ikelly" created="Fri, 4 Oct 2013 18:44:51 +0100"/>
                            <attachment id="12632468" name="BOOKKEEPER-688_branch42.patch" size="3693" author="hustlmsp" created="Tue, 4 Mar 2014 08:21:34 +0000"/>
                            <attachment id="12606771" name="BOOKKEEPER-688_branch_4_2.patch" size="3790" author="rakeshr" created="Fri, 4 Oct 2013 11:40:10 +0100"/>
                            <attachment id="12606772" name="BOOKKEEPER-688_trunk.patch" size="4387" author="rakeshr" created="Fri, 4 Oct 2013 11:42:32 +0100"/>
                            <attachment id="12606769" name="PerChannelBookieClient-ConnectionState-diagram.png" size="14062" author="rakeshr" created="Fri, 4 Oct 2013 11:00:56 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 4 Oct 2013 11:19:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351922</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hziir3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352210</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>