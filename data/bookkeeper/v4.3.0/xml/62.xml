<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:32:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-62/BOOKKEEPER-62.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-62] Bookie can not start when encountering corrupted records</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-62</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;bookie tries to extract ledger ids from entry loggers during starting up. if some records corrupted, an IOException is thrown out.&lt;/p&gt;

&lt;p&gt;in extractLedgersFromEntryLogs function:&lt;/p&gt;

&lt;p&gt;line 459:&lt;br/&gt;
                int rc = bc.read(buff, pos);&lt;br/&gt;
                if (rc != data.length) &lt;/p&gt;
{
                    throw new IOException(&quot;Short read for entryLog &quot; + entryLogId + &quot;@&quot; + pos + &quot;(&quot; + rc + &quot;!=&quot;
                            + data.length + &quot;)&quot;);
                }</description>
                <environment></environment>
        <key id="12520716">BOOKKEEPER-62</key>
            <summary>Bookie can not start when encountering corrupted records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Aug 2011 11:36:47 +0100</created>
                <updated>Thu, 18 Dec 2014 06:17:36 +0000</updated>
                            <resolved>Wed, 30 Nov 2011 10:14:42 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13093638" author="hustlmsp" created="Tue, 30 Aug 2011 11:44:27 +0100"  >&lt;p&gt;It seems that it is better to skip the corrupted records.&lt;/p&gt;

&lt;p&gt;(1) if the corrupted record is added after last marked journal. we still have chance to recover it from journal.&lt;br/&gt;
(2) if the corrupted record is added before last marked journal, it seems that we have no chance to recover it from journal. But we have replicas for this record, bookkeeper client can retry to read other replicas when found the record is missing or data corrupted.&lt;/p&gt;
</comment>
                            <comment id="13153007" author="ikelly" created="Fri, 18 Nov 2011 18:04:01 +0000"  >&lt;p&gt;I&apos;ve marked this as a blocker and moved to 4.0.0. We only need to deal with (1), as (2) indicates a disk failure, and there&apos;s nothing we can do. The bookie should be scrapped and a new bookie should replace it and recovery should be run for the lost bookie.&lt;/p&gt;

&lt;p&gt;I think solving this could be quite simple. If we create the entrylogger file with a different name, such as &amp;lt;logid&amp;gt;.log-inprogress, and then rename it to &amp;lt;logid&amp;gt;.log when we&apos;re done, the journal would then be able to complete the recovery. EntryLogger.createLogId is what we&apos;d need to change. We&apos;d only need to add 2-3 lines of code. Testing could just be a matter of manually corrupting a log file and trying to start.&lt;/p&gt;</comment>
                            <comment id="13159069" author="breed" created="Tue, 29 Nov 2011 03:53:24 +0000"  >&lt;p&gt;this patch has a test that uses a truncated file to reproduce the problem. it has fixes the issue by effectively ignoring the exception and logging it at the debug level.&lt;/p&gt;</comment>
                            <comment id="13159162" author="ikelly" created="Tue, 29 Nov 2011 08:56:47 +0000"  >&lt;p&gt;Patch is good. I&apos;ve made a few small mods. &lt;br/&gt;
1. Test is now in bookie package, so EntryLogger methods do not need to be public.&lt;br/&gt;
2. Added logger to test, removed call to System.out.println&lt;br/&gt;
3. Changed log message on bad entry to a warn. &lt;/p&gt;</comment>
                            <comment id="13159168" author="breed" created="Tue, 29 Nov 2011 09:08:29 +0000"  >&lt;p&gt;good changes. thanx!&lt;br/&gt;
2) actually, i think that println should have been removed altogether. that was an oversight. i think we should remove the logging to avoid polluting the output.&lt;br/&gt;
3) i think the message should be debug since it really doesn&apos;t indicate any problem at all. a warn level indicates something bad might happen in the future, but this situation happens when a bookie crashes and successfully recovers.&lt;/p&gt;</comment>
                            <comment id="13159207" author="ikelly" created="Tue, 29 Nov 2011 12:01:04 +0000"  >&lt;p&gt;Added marking for entrylogger, without this it possible that the bookie will start without loading all entries.&lt;/p&gt;</comment>
                            <comment id="13159320" author="hustlmsp" created="Tue, 29 Nov 2011 15:50:59 +0000"  >&lt;p&gt;most is good for me.&lt;/p&gt;

&lt;p&gt;But seems that the patch changes the format of lastId.&lt;br/&gt;
if the code is running on old lastId files, it would failed due to IOException because the &lt;b&gt;position&lt;/b&gt; field is missing. Shall we set &lt;b&gt;position&lt;/b&gt; to 0 if missing &lt;b&gt;position&lt;/b&gt; field in lastId files?&lt;/p&gt;

&lt;p&gt;BTW, the patch includes other changes. could you check it again?&lt;/p&gt;</comment>
                            <comment id="13159389" author="ikelly" created="Tue, 29 Nov 2011 17:35:04 +0000"  >&lt;p&gt;I spoke to Ben about this just now. The problem of short reads possibly occurring due to corruption is another problem, which will need to be dealt with in another way. We threw around a few ideas, like putting a bookie internal txn id on each update each, which would allow us to detail gaps etc, but nothing concrete. It is something we should fix for 4.1. For the moment, the bookie system as a whole should detect if a bookie is missing entries and read from another replica. &lt;/p&gt;

&lt;p&gt;+1 for this patch for now. Opening another jira for the other issue.&lt;/p&gt;
</comment>
                            <comment id="13159390" author="ikelly" created="Tue, 29 Nov 2011 17:38:19 +0000"  >&lt;p&gt;new JIRA is &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-126&quot; title=&quot;EntryLogger doesn&amp;#39;t detect when one of it&amp;#39;s logfiles is corrupt&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-126&quot;&gt;&lt;del&gt;BOOKKEEPER-126&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13159396" author="ikelly" created="Tue, 29 Nov 2011 17:47:13 +0000"  >&lt;p&gt;Committed as r1207997&lt;/p&gt;</comment>
                            <comment id="13159413" author="hudson" created="Tue, 29 Nov 2011 18:07:27 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #248 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/248/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/248/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-62&quot; title=&quot;Bookie can not start when encountering corrupted records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-62&quot;&gt;&lt;del&gt;BOOKKEEPER-62&lt;/del&gt;&lt;/a&gt;: Bookie can not start when encountering corrupted records (breed via ivank)&lt;/p&gt;

&lt;p&gt;ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13159758" author="hustlmsp" created="Wed, 30 Nov 2011 02:36:23 +0000"  >&lt;p&gt;the committed patch doesn&apos;t fix short reads correctly.&lt;br/&gt;
If short read occurs on first log, the IOException is caught without clearing &lt;b&gt;sizeBuffer&lt;/b&gt;. so reads on following entry logs will failed even these logs are correct log files.&lt;/p&gt;</comment>
                            <comment id="13159759" author="hustlmsp" created="Wed, 30 Nov 2011 02:39:15 +0000"  >&lt;p&gt;Attach a patch including a test case reproduced the issue as previous comment, and the code to fix it.&lt;/p&gt;</comment>
                            <comment id="13159805" author="breed" created="Wed, 30 Nov 2011 03:59:15 +0000"  >&lt;p&gt;i don&apos;t think we want this. if there is an error with an entry, all subsequent entries should be considered erroneous. the journal will be used to recover the erroneous entry all all subsequent entries.&lt;/p&gt;</comment>
                            <comment id="13159846" author="hustlmsp" created="Wed, 30 Nov 2011 05:55:09 +0000"  >
&lt;p&gt;suppose bookie servers run in following case:&lt;/p&gt;

&lt;p&gt;1. bookie server running, writing 3 entries to 1.log.&lt;br/&gt;
2. bookie server crashed. 1.log was corrupted, entry 3 is partial. we still has 3 entries in journal file.&lt;br/&gt;
3. bookie server restarted, replay these 3 entries from journal file, writing to 2.log again. SyncThread did flush. 2.log be flushed, became a completed log file.&lt;br/&gt;
4. bookie server shuts down.&lt;br/&gt;
5. bookie server restarts. it tried to extract ledger id from entry logs. it failed on 1.log (would skip the partial entry), then 2.log will not be processed (we just have first 2 entries). Also, SyncThread did flush in step3, no journal replay took placed. Then we lose entry 3 (although we have it in 2.log).&lt;/p&gt;
</comment>
                            <comment id="13159937" author="ikelly" created="Wed, 30 Nov 2011 09:16:25 +0000"  >&lt;p&gt;Losing entries like this is ok, because all entries are replicated &lt;em&gt;quorum&lt;/em&gt; times across the system. What is bad here, is that we don&apos;t detect that the entry is missing until we read it, so it&apos;s underreplicated. &lt;/p&gt;</comment>
                            <comment id="13159954" author="hustlmsp" created="Wed, 30 Nov 2011 10:14:17 +0000"  >&lt;p&gt;entryLogs2LedgersMap is only used on GC. so I agreed on Ben and Ivan&apos;s comments.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12520715">BOOKKEEPER-61</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12505474" name="BOOKKEEPER-62.diff" size="33840" author="ikelly" created="Tue, 29 Nov 2011 12:01:04 +0000"/>
                            <attachment id="12505465" name="BOOKKEEPER-62.diff" size="7621" author="ikelly" created="Tue, 29 Nov 2011 08:56:47 +0000"/>
                            <attachment id="12505569" name="BOOKKEEPER-62.patch" size="3514" author="hustlmsp" created="Wed, 30 Nov 2011 02:39:15 +0000"/>
                            <attachment id="12505442" name="BOOKKEEPER-62.patch" size="8520" author="breed" created="Tue, 29 Nov 2011 03:53:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 18 Nov 2011 18:04:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63154</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hynz8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>173895</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>