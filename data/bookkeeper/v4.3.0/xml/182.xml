<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:29:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-182/BOOKKEEPER-182.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-182] Entry log file is overwritten when fail to read lastLogId.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-182</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;we found data corruption happened on entry log files.&lt;/p&gt;

&lt;p&gt;2012-03-06 07:26:14,947 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOServerFactory-3181:BookieServer@413&amp;#93;&lt;/span&gt; - Error reading 229@114724&lt;br/&gt;
java.io.IOException: problem found in 0@229 at position + 89030194 entry belongs to 6373236044838956613 not 114724&lt;br/&gt;
        at org.apache.bookkeeper.bookie.EntryLogger.readEntry(EntryLogger.java:347)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.LedgerDescriptor.readEntry(LedgerDescriptor.java:180)&lt;br/&gt;
        at org.apache.bookkeeper.bookie.Bookie.readEntry(Bookie.java:1081)&lt;br/&gt;
        at org.apache.bookkeeper.proto.BookieServer.processPacket(BookieServer.java:386)&lt;br/&gt;
        at org.apache.bookkeeper.proto.NIOServerFactory$Cnxn.readRequest(NIOServerFactory.java:315)&lt;br/&gt;
        at org.apache.bookkeeper.proto.NIOServerFactory$Cnxn.doIO(NIOServerFactory.java:213)&lt;br/&gt;
        at org.apache.bookkeeper.proto.NIOServerFactory.run(NIOServerFactory.java:124&lt;/p&gt;

&lt;p&gt;then we did some investigation on failed ledger:&lt;/p&gt;

&lt;p&gt;first looked into ledger 114724&apos;s index file.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
entry 75        :       (log:11, pos: 100526580)
entry 76        :       (log:11, pos: 101849530)
entry 77        :       (log:11, pos: 103176596)
entry 78        :       (log:11, pos: 104403977)
entry 79        :       (log:11, pos: 105756017)
entry 80        :       (log:11, pos: 106740803)
entry 81        :       (log:0, pos: 73365)
entry 82        :       (log:0, pos: 1366625)
entry 83        :       (log:0, pos: 2719276)
entry 84        :       (log:0, pos: 4065142)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;from entry 80, the data is written in 0 entry log which is less than 11. (means data is written to an older entry log file)&lt;/p&gt;

&lt;p&gt;then we looked into ledger directory as below&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2147483550 Mar  5 11:30 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/0.log
  94122988 Mar  5 11:33 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/1.log
1984247565 Mar  5 11:34 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/2.log
    288376 Mar  5 11:34 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/3.log
 747151813 Mar  6 03:17 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/4.log
 410381287 Mar  6 07:43 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/5.log
2147483363 Feb 27 19:59 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/7.log
2147483565 Feb 29 09:40 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/9.log
1691783168 Mar  1 03:22 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/a.log
 125556720 Mar  1 08:30 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/b.log
         0 Mar  1 08:33 /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/bookkeeper/ledger/c.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the 0-5 entry log files are overwritten.&lt;/p&gt;

&lt;p&gt;looked into the code, found that when bookie server failed to read lastLogId, it would set the lastLogId to -1. then start writing entry log files from 0. and also there is not checking about the existen of the entry log file.&lt;/p&gt;

&lt;p&gt;it would better to scan the directories to found the biggest log id and start from it. and check whether the file exists or not when creating a new entry log file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12545625">BOOKKEEPER-182</key>
            <summary>Entry log file is overwritten when fail to read lastLogId.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Mar 2012 07:36:07 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:17 +0100</updated>
                            <resolved>Fri, 16 Mar 2012 09:42:25 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13225230" author="hustlmsp" created="Thu, 8 Mar 2012 14:45:25 +0000"  >&lt;p&gt;attach a patch to fix this issue by scanning ledger directory to get the biggest log id when read lastLogId failed.&lt;/p&gt;</comment>
                            <comment id="13229118" author="ikelly" created="Wed, 14 Mar 2012 10:18:21 +0000"  >&lt;p&gt;Tests fail when applied on trunk. I think its something to do with the current directory stuff introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-163&quot; title=&quot;Prevent incorrect NoSuchLedgerException for readLastConfirmed.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-163&quot;&gt;&lt;del&gt;BOOKKEEPER-163&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13229168" author="hustlmsp" created="Wed, 14 Mar 2012 13:13:05 +0000"  >&lt;p&gt;yes. ur right, the directory is not right in the test. I will update the patch.&lt;/p&gt;</comment>
                            <comment id="13229169" author="hustlmsp" created="Wed, 14 Mar 2012 13:13:48 +0000"  >&lt;p&gt;new patch attached.&lt;/p&gt;</comment>
                            <comment id="13231000" author="ikelly" created="Fri, 16 Mar 2012 09:42:26 +0000"  >&lt;p&gt;Committed as r1301395. Thanks Sijie.&lt;/p&gt;</comment>
                            <comment id="13231044" author="hudson" created="Fri, 16 Mar 2012 10:42:12 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #412 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/412/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/412/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-182&quot; title=&quot;Entry log file is overwritten when fail to read lastLogId.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-182&quot;&gt;&lt;del&gt;BOOKKEEPER-182&lt;/del&gt;&lt;/a&gt;: Entry log file is overwritten when fail to read lastLogId. (sijie via ivank) (Revision 1301395)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517566" name="BK-182.diff" size="8628" author="hustlmsp" created="Thu, 8 Mar 2012 14:45:25 +0000"/>
                            <attachment id="12518316" name="BK-182.diff_v2" size="8738" author="hustlmsp" created="Wed, 14 Mar 2012 13:13:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 14 Mar 2012 10:18:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230808</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4ry7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61684</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>