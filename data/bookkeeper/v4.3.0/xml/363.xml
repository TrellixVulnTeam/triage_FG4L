<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:30:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-363/BOOKKEEPER-363.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-363] Re-distributing topics among newly added hubs.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-363</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;When a new hub is added to an already existing hedwig cluster, that hub should pick up some of the topics. Currently the mechanism hedwig provides is to configure the time for which a topic is retained. A better approach might be to run a re-balancer thread that periodically checks if topics are distributed evenly among hubs and if not, releases some topics to balance the load. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/6700/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/6700/&lt;/a&gt;&lt;br/&gt;
There is a race condition while updating load as mentioned in the comments and that is not handled in this review.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12603390">BOOKKEEPER-363</key>
            <summary>Re-distributing topics among newly added hubs.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="i0exception">Aniruddha</assignee>
                                    <reporter username="i0exception">Aniruddha</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Aug 2012 08:00:34 +0100</created>
                <updated>Fri, 7 Mar 2014 18:15:28 +0000</updated>
                            <resolved>Fri, 7 Mar 2014 17:42:30 +0000</resolved>
                                    <version>4.2.0</version>
                                    <fixVersion>4.3.0</fixVersion>
                                    <component>hedwig-server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13436606" author="i0exception" created="Fri, 17 Aug 2012 09:13:40 +0100"  >&lt;p&gt;Couple of issues I found while implementing this. &lt;br/&gt;
1) Hedwig hubs only update the load while claiming topics. We should also update the load while releasing topics. &lt;br/&gt;
2) HubLoad is not thread safe and faces race conditions while handling (1). Instead of providing a setNumTopics(), we should have incrementNumTopics() and decrementNumTopics() and update the load periodically (perhaps as a side effect of a successful rebalance) &lt;/p&gt;

&lt;p&gt;(1) also affects the case where a new hub joins a balanced cluster while new topic ownership requests are coming in parallel. Every hub will choose this new hub as the least loaded node and it will get ownership of a lot of topics and this would increase it&apos;s reported load to a large value and thus this node would never claim any more topics. Or perhaps I&apos;m missing something. &lt;/p&gt;

&lt;p&gt;To give a high level overview of the implementation, we introduce a rebalanceCluster() function in the HubServerManager interface. This takes in a tolerance percentage and the maximum load to shed per call (to make sure you don&apos;t suddenly release a lot of topics) We also add a new class called TopicBasedLoadShedder that sheds load by releasing topics. It calculates the average load on the cluster from the reported zookeeper load data, calculates if the topics the current hub owns is more than average + average*tolerance percentage/100 and if so, releases enough topics to reach average. Any feedback would be highly appreciated.&lt;/p&gt;</comment>
                            <comment id="13436740" author="hustlmsp" created="Fri, 17 Aug 2012 14:58:37 +0100"  >&lt;blockquote&gt;
&lt;p&gt;1) Hedwig hubs only update the load while claiming topics. We should also update the load while releasing topics. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ah, ur right. it would make the requests really unbalance if some hubs release topics periodically.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;we introduce a rebalanceCluster() function in the HubServerManager interface.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am guessing who does the balance work. Each hub server runs independently? Or a hub server would be elected as a leader to do it? &lt;/p&gt;

&lt;p&gt;I am doubting if each hub server runs independently, hub servers might make a wrong decision to releasing topics, which cause lots of topics to be released.&lt;/p&gt;
</comment>
                            <comment id="13436842" author="i0exception" created="Fri, 17 Aug 2012 17:34:44 +0100"  >&lt;p&gt;Well, if you configure a lenient tolerance level, most hubs won&apos;t release topics unless absolutely necessary. IMO, it&apos;s okay to run this separately on every hub and over time, topics should balance out well. The maximum load to shed configuration option will help in stopping a hub from suddenly releasing too many topics. Currently this is not a percentage, but a number. What do you think? &lt;/p&gt;</comment>
                            <comment id="13438347" author="i0exception" created="Tue, 21 Aug 2012 01:18:43 +0100"  >&lt;p&gt;I&apos;ve attached a patch for this. Please feel free to point out any changes that might be required.&lt;/p&gt;</comment>
                            <comment id="13463708" author="hustlmsp" created="Wed, 26 Sep 2012 12:06:04 +0100"  >&lt;p&gt;canceled the patch until fixing Ivan&apos;s comments in review board.&lt;/p&gt;</comment>
                            <comment id="13526303" author="ikelly" created="Fri, 7 Dec 2012 10:42:51 +0000"  >&lt;p&gt;Moving to 4.3.0, as this is a new feature and there hasn&apos;t been movement on it lately.&lt;/p&gt;</comment>
                            <comment id="13701414" author="hustlmsp" created="Sat, 6 Jul 2013 22:22:49 +0100"  >&lt;p&gt;rebased &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=i0exception&quot; class=&quot;user-hover&quot; rel=&quot;i0exception&quot;&gt;Aniruddha&lt;/a&gt;&apos;s patch to latest trunk.&lt;/p&gt;</comment>
                            <comment id="13701427" author="hadoopqa" created="Sat, 6 Jul 2013 23:03:43 +0100"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-363&quot; title=&quot;Re-distributing topics among newly added hubs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-363&quot;&gt;&lt;del&gt;BOOKKEEPER-363&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12591092/BOOKKEEPER-363.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BOOKKEEPER-363.diff&lt;/a&gt; downloaded at Sat Jul  6 21:37:28 UTC 2013&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 120&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 FINDBUGS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Findbugs warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 859&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;&lt;b&gt;+1 Overall result, good!, no -1s&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/410/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk-precommit-build/410/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13924099" author="ikelly" created="Fri, 7 Mar 2014 17:42:30 +0000"  >&lt;p&gt;Committed r1575338. Thanks Aniruddha.&lt;/p&gt;</comment>
                            <comment id="13924144" author="hudson" created="Fri, 7 Mar 2014 18:15:28 +0000"  >&lt;p&gt;SUCCESS: Integrated in bookkeeper-trunk #575 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/575/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/575/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-363&quot; title=&quot;Re-distributing topics among newly added hubs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-363&quot;&gt;&lt;del&gt;BOOKKEEPER-363&lt;/del&gt;&lt;/a&gt;: Re-distributing topics among newly added hubs. (aniruddha via ivank) (ivank: rev 1575338)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/common/ServerConfiguration.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/HubLoad.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/HubServerManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/MMTopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TopicBasedLoadShedder.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/ZkHubServerManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/ZkTopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/TestTopicBasedLoadShedder.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12541680" name="BK-363.patch" size="39646" author="i0exception" created="Tue, 21 Aug 2012 01:18:43 +0100"/>
                            <attachment id="12545447" name="BK-363.patch.v2" size="43628" author="i0exception" created="Mon, 17 Sep 2012 19:21:50 +0100"/>
                            <attachment id="12591092" name="BOOKKEEPER-363.diff" size="52716" author="hustlmsp" created="Sat, 6 Jul 2013 22:22:49 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 17 Aug 2012 13:58:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>295932</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyxxnb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231959</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>