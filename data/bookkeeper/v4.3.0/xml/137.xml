<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:30:10 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-137/BOOKKEEPER-137.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-137] Do not create Ledger index files until absolutely necessary.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-137</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12533637">BOOKKEEPER-137</key>
            <summary>Do not create Ledger index files until absolutely necessary.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="ikelly">Ivan Kelly</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Dec 2011 14:58:10 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:13 +0100</updated>
                            <resolved>Thu, 9 Feb 2012 17:15:25 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13161748" author="ikelly" created="Fri, 2 Dec 2011 17:53:35 +0000"  >&lt;p&gt;This patch is ready to go, but is blocked by &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13194785" author="ikelly" created="Fri, 27 Jan 2012 14:26:41 +0000"  >&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;</comment>
                            <comment id="13194789" author="jiraposter@reviews.apache.org" created="Fri, 27 Jan 2012 14:30:09 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;

&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java cb3bb26 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java d2f959b &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java beab5e8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 7403604 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13194815" author="jiraposter@reviews.apache.org" created="Fri, 27 Jan 2012 14:54:09 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-01-27 14:54:04.113114)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;There was one compile error fix I hadn&apos;t committed.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;

&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java cb3bb26 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java d2f959b &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java beab5e8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 7403604 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13200342" author="jiraposter@reviews.apache.org" created="Sat, 4 Feb 2012 06:17:54 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/#review4819&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/#review4819&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3661/#comment10582&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/#comment10582&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    suppose the code running in journalLayoutVersion=1 directory. the first time is OK, since there would be no meta entries. but the code would add meta entries then. the next time bookie restarts, journalLayoutVersion is still 1, it would throw IOException.&lt;/p&gt;

&lt;p&gt;    so do we need to upgrade the layout version when we run new code  in old data directories? &lt;/p&gt;



&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3661/#comment10583&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/#comment10583&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    if a ledger existed before, getHandle would checkAccess  of masterKey, which would call FileInfo#readHeader. Then isMasterKeyPersisted would call FileInfo#readHeader again, which is not necessary. &lt;/p&gt;

&lt;p&gt;    I think it would be easy to avoid readHeader twice.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sijie&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-01-27 14:54:04, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-01-27 14:54:04)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java cb3bb26 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java d2f959b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java beab5e8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 7403604 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13201173" author="ikelly" created="Mon, 6 Feb 2012 09:43:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;suppose the code running in journalLayoutVersion=1 directory. the first time is OK, since there would be no meta entries. but the code would add meta entries then. the next time bookie restarts, journalLayoutVersion is still 1, it would throw IOException.&lt;/p&gt;

&lt;p&gt;so do we need to upgrade the layout version when we run new code in old data directories? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is true, I need to add upgrade logic. I may separate this out into another JIRA.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;if a ledger existed before, getHandle would checkAccess of masterKey, which would call FileInfo#readHeader. Then isMasterKeyPersisted would call FileInfo#readHeader again, which is not necessary.&lt;/p&gt;

&lt;p&gt;I think it would be easy to avoid readHeader twice.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Im not clear on this point. checkAccess doesn&apos;t call #readHeader at all.&lt;/p&gt;
</comment>
                            <comment id="13201195" author="hustlmsp" created="Mon, 6 Feb 2012 10:20:10 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Im not clear on this point. checkAccess doesn&apos;t call #readHeader at all.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;#checkAccess =&amp;gt; #getMasterKey =&amp;gt; #readHeader&lt;/p&gt;</comment>
                            <comment id="13201223" author="ikelly" created="Mon, 6 Feb 2012 11:13:49 +0000"  >&lt;p&gt;Ah yes, you&apos;re right, it calls it through #checkOpen. This should be simple to resolve.&lt;/p&gt;</comment>
                            <comment id="13202587" author="ikelly" created="Tue, 7 Feb 2012 18:11:33 +0000"  >&lt;p&gt;New patch, addresses Sijie&apos;s comments, now only depends on &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-165&quot; title=&quot;Add versioning support for journal files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-165&quot;&gt;&lt;del&gt;BOOKKEEPER-165&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13202590" author="jiraposter@reviews.apache.org" created="Tue, 7 Feb 2012 18:14:59 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-07 18:13:15.812700)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;New diff, addresses Sijie&apos;s comments. Diffed against trunk with &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-165&quot; title=&quot;Add versioning support for journal files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-165&quot;&gt;&lt;del&gt;BOOKKEEPER-165&lt;/del&gt;&lt;/a&gt; applied.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;

&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 99b797f &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 0fc5206 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java PRE-CREATION &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java db1a763 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13203674" author="jiraposter@reviews.apache.org" created="Wed, 8 Feb 2012 15:39:59 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/#review4903&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/#review4903&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;most is good to me. thanks Ivan, except a BookieException is missing in BaseTestCase that I commented as below.&lt;/p&gt;

&lt;p&gt;and it seems that new patch doesn&apos;t fix the readHeader twice problem.&lt;/p&gt;


&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/3661/#comment10799&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/#comment10799&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    this patch applied to trunk would compile fail. due to in &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-156&quot; title=&quot;BookieJournalRollingTest failing &quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-156&quot;&gt;&lt;del&gt;BOOKKEEPER-156&lt;/del&gt;&lt;/a&gt;, start bookie action has been put in startBookie function. so it need to add BookieException also in startBookie.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sijie&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-02-07 18:13:15, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-07 18:13:15)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 99b797f &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 0fc5206 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java db1a763 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13203680" author="jiraposter@reviews.apache.org" created="Wed, 8 Feb 2012 15:49:58 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-02-08 15:39:47, Sijie Guo wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; most is good to me. thanks Ivan, except a BookieException is missing in BaseTestCase that I commented as below.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; and it seems that new patch doesn&apos;t fix the readHeader twice problem.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, will fix the BookieException thing and upload a new patch against trunk.&lt;/p&gt;

&lt;p&gt;The readHeader issue has been fixed. It can still be called twice, but if the file has already been opened, it returns immediately.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ivan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/#review4903&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/#review4903&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-02-07 18:13:15, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-07 18:13:15)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 99b797f &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 0fc5206 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java db1a763 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13203682" author="jiraposter@reviews.apache.org" created="Wed, 8 Feb 2012 15:53:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-08 15:53:28.318711)&lt;/p&gt;


&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Fixed compile error&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;

&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 8abe87a &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java 10ecac7 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 771c0ba &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 &lt;br/&gt;
  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java ae63710 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;br/&gt;
  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 9750158 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ivan&lt;/p&gt;
</comment>
                            <comment id="13204339" author="hustlmsp" created="Thu, 9 Feb 2012 07:57:26 +0000"  >&lt;p&gt;hmm, I can&apos;t find the code to avoid readHeader twice.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
909     LedgerDescriptor l = getHandle(ledgerId, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, masterKey);	
910	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!l.isMasterKeyPersisted()) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;suppose a ledger is existed before but not in cache. then readHeader still be called twice as below:&lt;/p&gt;

&lt;p&gt;getHandle =&amp;gt; createHandle =&amp;gt; lh#checkAccess(masterKey) =&amp;gt; the initial masterKey in lh is null, lh gets FileInfo#getMasterKey =&amp;gt; no master key in FileInfo =&amp;gt; FileInfo#checkOpen =&amp;gt; FileInfo#readHeader (yes, it read header).&lt;/p&gt;

&lt;p&gt;lh#isMasterKeyPersisted (the initial masterKeyPersisted is false) =&amp;gt; it will get FileInfo from LedgerCache =&amp;gt; call FileInfo#readHeader (then, it read header again)&lt;/p&gt;</comment>
                            <comment id="13204355" author="ikelly" created="Thu, 9 Feb 2012 08:30:02 +0000"  >&lt;p&gt;#readHeader will be called twice. However, the second call will do nothing, as it will see that fc != null, and return immediately.&lt;/p&gt;</comment>
                            <comment id="13204441" author="jiraposter@reviews.apache.org" created="Thu, 9 Feb 2012 10:52:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3661/#review4966&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/#review4966&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;thanks Ivan for explanation. the new patch is ok for me. +1 &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sijie&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-02-08 15:53:28, Ivan Kelly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3661/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-08 15:53:28)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch includes &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-136&quot; title=&quot;Journal rollback does not create new ledger indices correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-136&quot;&gt;&lt;del&gt;BOOKKEEPER-136&lt;/del&gt;&lt;/a&gt;, as they both deal in the same area, and I found it difficult to separate them.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-135&quot; title=&quot;Fencing does not check the ledger masterPasswd&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-135&quot;&gt;&lt;del&gt;BOOKKEEPER-135&lt;/del&gt;&lt;/a&gt; is not required for this patch, and will need modifications after this goes in.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-137&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 8abe87a &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java 10ecac7 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 771c0ba &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java ae63710 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 9750158 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3661/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3661/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Ivan&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13204661" author="ikelly" created="Thu, 9 Feb 2012 17:15:25 +0000"  >&lt;p&gt;Committed as r1242404. Thanks for reviewing Sijie.&lt;/p&gt;</comment>
                            <comment id="13204696" author="hudson" created="Thu, 9 Feb 2012 18:02:11 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #353 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/353/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/353/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;: Do not create Ledger index files until absolutely necessary. (ivank)&lt;/p&gt;

&lt;p&gt;ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12541649">BOOKKEEPER-165</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12513827" name="BOOKKEEPER-137.diff" size="34254" author="ikelly" created="Wed, 8 Feb 2012 15:53:48 +0000"/>
                            <attachment id="12513648" name="BOOKKEEPER-137.diff" size="33854" author="ikelly" created="Tue, 7 Feb 2012 18:11:32 +0000"/>
                            <attachment id="12512172" name="BOOKKEEPER-137.diff" size="33857" author="ikelly" created="Fri, 27 Jan 2012 14:53:22 +0000"/>
                            <attachment id="12512161" name="BOOKKEEPER-137.diff" size="33435" author="ikelly" created="Fri, 27 Jan 2012 14:26:40 +0000"/>
                            <attachment id="12505911" name="BOOKKEEPER-137.diff" size="19191" author="ikelly" created="Fri, 2 Dec 2011 17:53:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 27 Jan 2012 14:30:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>219364</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4scn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61749</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>