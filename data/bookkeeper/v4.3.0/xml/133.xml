<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:27:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-133/BOOKKEEPER-133.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-133] Hub server should update subscription state to zookeeper when losing topic or shutting down</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-133</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Currently hub server use counter-based mechanism to update subscription state lazily to zookeeper.&lt;br/&gt;
But in the following case, it didn&apos;t do it.&lt;br/&gt;
1) losing ownership of Topic&lt;br/&gt;
2) hub server shuts down&lt;br/&gt;
3) a subscription channel disconnected&lt;/p&gt;</description>
                <environment></environment>
        <key id="12533449">BOOKKEEPER-133</key>
            <summary>Hub server should update subscription state to zookeeper when losing topic or shutting down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Dec 2011 13:58:24 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:13 +0100</updated>
                            <resolved>Thu, 22 Dec 2011 17:36:34 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>hedwig-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13162819" author="hustlmsp" created="Mon, 5 Dec 2011 15:04:54 +0000"  >&lt;p&gt;Attach a patch to update subscription state in hub server when losing topic or server shuts down, and send consume message in client when closeSubscription.&lt;/p&gt;</comment>
                            <comment id="13170838" author="ikelly" created="Fri, 16 Dec 2011 08:57:05 +0000"  >&lt;p&gt;Could you put this in review board, as it&apos;s quite a large patch. A few comments from what I&apos;ve seen so far.&lt;/p&gt;

&lt;p&gt;a) PersistenceManager#stop seems to be a noop in all cases. Remove it for the moment. &lt;br/&gt;
b) ZkTopicManager#unregisterWithZookeeper shouldn&apos;t be needed. An EPHEMERAL znode is deleted when the session goes away (after zookeeper timeout). Is this too late for your requirement?&lt;/p&gt;

&lt;p&gt;How is the lazy cleanup causing problems?&lt;/p&gt;

&lt;p&gt;Also, I don&apos;t understand what the consume message is for? It is to clear the outstanding messages for the subscription?&lt;/p&gt;</comment>
                            <comment id="13172863" author="hustlmsp" created="Tue, 20 Dec 2011 02:24:39 +0000"  >&lt;p&gt;&amp;gt; b) ZkTopicManager#unregisterWithZookeeper shouldn&apos;t be needed&lt;/p&gt;

&lt;p&gt;my point is to stop following requests sending to a hub server while it is shutting down. so I add code to remove the znode first.&lt;/p&gt;

&lt;p&gt;&amp;gt;  I don&apos;t understand what the consume message is for?&lt;/p&gt;

&lt;p&gt;currently auto consume is counter-based. suppose consume interval is 5. client received and consumed 4 messages, but clients didn&apos;t tell hub server it consumed 4 messages while it closes subscription. sending a consume message while closing subscription is to reduce duplicated messages.&lt;/p&gt;</comment>
                            <comment id="13174193" author="ikelly" created="Wed, 21 Dec 2011 16:40:24 +0000"  >&lt;p&gt;I&apos;ve taken a closer look at this. In general it looks good. &lt;/p&gt;

&lt;p&gt;As I said before, PersistenceManager#stop should be removed, since it does nothing.&lt;/p&gt;

&lt;p&gt;SubscribeResponseHandler#messageConsumed shouldn&apos;t share a method with SubscribeResponseHandler#asyncConsumeBufferedMessages. The shared method spends half it&apos;s time checking if message is null, so you&apos;re not really extracting out common code at all.&lt;/p&gt;

&lt;p&gt;Also, when you upload these changes, could you put them in reviewboard.&lt;/p&gt;</comment>
                            <comment id="13174618" author="hustlmsp" created="Thu, 22 Dec 2011 05:17:44 +0000"  >&lt;p&gt;Yes. I will try upload a new patch.&lt;/p&gt;</comment>
                            <comment id="13174654" author="jiraposter@reviews.apache.org" created="Thu, 22 Dec 2011 06:45:30 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3293/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3293/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for bookkeeper.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Currently hub server use counter-based mechanism to update subscription state lazily to zookeeper.&lt;br/&gt;
But in the following case, it didn&apos;t do it.&lt;br/&gt;
1) losing ownership of Topic&lt;br/&gt;
2) hub server shuts down&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-133&quot; title=&quot;Hub server should update subscription state to zookeeper when losing topic or shutting down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-133&quot;&gt;&lt;del&gt;BOOKKEEPER-133&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-133&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BOOKKEEPER-133&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  hedwig-server/src/main/java/org/apache/hedwig/server/delivery/DeliveryManager.java f4db619 &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/netty/PubSubServer.java 8c2d77f &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/AbstractSubscriptionManager.java 78d1435 &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/InMemorySubscriptionState.java 8ee92e3 &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/SubscriptionManager.java d40a029 &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java 0c3c4df &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/topics/TopicManager.java 6e4b2c9 &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/topics/TrivialOwnAllTopicManager.java 1f6654f &lt;br/&gt;
  hedwig-server/src/main/java/org/apache/hedwig/server/topics/ZkTopicManager.java b1bd9a4 &lt;br/&gt;
  hedwig-server/src/test/java/org/apache/hedwig/server/HedwigHubTestBase.java 8f77a1b &lt;br/&gt;
  hedwig-server/src/test/java/org/apache/hedwig/server/delivery/StubDeliveryManager.java 3782e82 &lt;br/&gt;
  hedwig-server/src/test/java/org/apache/hedwig/server/persistence/StubPersistenceManager.java 84b866d &lt;br/&gt;
  hedwig-server/src/test/java/org/apache/hedwig/server/subscriptions/TestUpdateSubscriptionState.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3293/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3293/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Sijie&lt;/p&gt;
</comment>
                            <comment id="13174657" author="hustlmsp" created="Thu, 22 Dec 2011 06:50:03 +0000"  >&lt;p&gt;Attach a new patch.&lt;/p&gt;

&lt;p&gt;In the new patch, I just remove code sending consume request when closing subscription. since close subscription will be called when a channel is disconnected. so client can&apos;t send a consume request thru a unconnected channel. It would be better to let application handle how to consume.&lt;/p&gt;</comment>
                            <comment id="13174917" author="ikelly" created="Thu, 22 Dec 2011 17:36:34 +0000"  >&lt;p&gt;Committed as r1222365. Great work Sijie.&lt;/p&gt;</comment>
                            <comment id="13174939" author="hudson" created="Thu, 22 Dec 2011 18:11:37 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #291 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/291/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/291/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-133&quot; title=&quot;Hub server should update subscription state to zookeeper when losing topic or shutting down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-133&quot;&gt;&lt;del&gt;BOOKKEEPER-133&lt;/del&gt;&lt;/a&gt;: Hub server should update subscription state to zookeeper when losing topic or shutting down (Sijie Gou via ivank)&lt;/p&gt;

&lt;p&gt;ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/delivery/DeliveryManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/netty/PubSubServer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/AbstractSubscriptionManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/InMemorySubscriptionState.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/subscriptions/SubscriptionManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TrivialOwnAllTopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/ZkTopicManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/HedwigHubTestBase.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/delivery/StubDeliveryManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/subscriptions/TestUpdateSubscriptionState.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12506118" name="BOOKKEEPER-133.patch" size="47379" author="hustlmsp" created="Mon, 5 Dec 2011 15:04:54 +0000"/>
                            <attachment id="12508351" name="bookeeper-133.patch" size="29819" author="hustlmsp" created="Thu, 22 Dec 2011 06:50:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 16 Dec 2011 08:57:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>219177</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4sdr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61754</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>