<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:30:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-380/BOOKKEEPER-380.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-380] ZkLedgerUnderreplicationManager.markLedgerUnderreplicated() is adding duplicate missingReplicas while multiple bk failed for the same ledger</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-380</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;Scenario:-&lt;/p&gt;

&lt;p&gt;Say L0001 has ensemble bookies BK1, BK2, BK3.&lt;br/&gt;
Publishing BK1 failure: replicaMgr.markLedgerUnderreplicated(L0001, BK1);&lt;br/&gt;
Publishing BK2 failure: replicaMgr.markLedgerUnderreplicated(L0001, BK2);&lt;/p&gt;

&lt;p&gt;For the second invocation urLedger metadata is updating BK2 twice as follows:&lt;br/&gt;
1=replica: &quot;BK1&quot;, 1=replica: &quot;BK2&quot;, 1=replica: &quot;BK2&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12604843">BOOKKEEPER-380</key>
            <summary>ZkLedgerUnderreplicationManager.markLedgerUnderreplicated() is adding duplicate missingReplicas while multiple bk failed for the same ledger</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12553925">BOOKKEEPER-237</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh R</assignee>
                                    <reporter username="rakeshr">Rakesh R</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Aug 2012 14:55:43 +0100</created>
                <updated>Wed, 13 Feb 2013 15:46:30 +0000</updated>
                            <resolved>Mon, 27 Aug 2012 11:10:21 +0100</resolved>
                                    <version>4.2.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                                    <component>bookkeeper-auto-recovery</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13441161" author="rakeshr" created="Fri, 24 Aug 2012 15:03:20 +0100"  >&lt;p&gt;Hi Ivan,&lt;/p&gt;

&lt;p&gt;I&apos;m able to reproduce the scenario with the tests which I was trying to explain in BK-272 &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-272?focusedCommentId=13440194&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13440194&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;scenario&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Could you please look at the attached patch for more details.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Rakesh&lt;/p&gt;</comment>
                            <comment id="13441344" author="ikelly" created="Fri, 24 Aug 2012 19:05:34 +0100"  >&lt;p&gt;Your fix works, but delves directly into the serialized form, rather than going through protobufs, which could cause problems in the future, for example if we ever went from TextFormat to binary representation. Also it would fail if using an ensemble with servers named like 1.cluster.com, 2.cluster.com, ... 11.cluster.com, 12.cluster.com&lt;/p&gt;

&lt;p&gt;The fix I had suggested (swapping break for return) didn&apos;t work either, because we had to clear the Builder to undo the addReplica(missingReplica) which we do in the try{} block. Have a look at the patch I attached.&lt;/p&gt;</comment>
                            <comment id="13441808" author="rakeshr" created="Sat, 25 Aug 2012 09:03:05 +0100"  >&lt;p&gt;oops! I missed that scenario. Thanks for pointing it.The patch you have attached is nice and pretty simple fix&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I attached one more patch which contains the following changes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;modified debug log message by adding params also&lt;/li&gt;
	&lt;li&gt;instead of iterating over the list. Used data.getReplicaList().contains(missReplica)&lt;/li&gt;
	&lt;li&gt;added one more test case for the scenario which you have mentioned above.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Please have a look&lt;/p&gt;</comment>
                            <comment id="13442349" author="ikelly" created="Mon, 27 Aug 2012 11:10:21 +0100"  >&lt;p&gt;Committed r1377630. Thanks Rakesh.&lt;/p&gt;</comment>
                            <comment id="13442356" author="hudson" created="Mon, 27 Aug 2012 11:36:10 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #669 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/669/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/669/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-380&quot; title=&quot;ZkLedgerUnderreplicationManager.markLedgerUnderreplicated() is adding duplicate missingReplicas while multiple bk failed for the same ledger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-380&quot;&gt;&lt;del&gt;BOOKKEEPER-380&lt;/del&gt;&lt;/a&gt;: ZkLedgerUnderreplicationManager.markLedgerUnderreplicated() is adding duplicate missingReplicas while multiple bk failed for the same ledger (rakeshr via ivank) (Revision 1377630)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/ZkLedgerUnderreplicationManager.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/replication/TestLedgerUnderreplicationManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12542400" name="BOOKKEEPER-380.1.patch" size="8700" author="rakeshr" created="Sat, 25 Aug 2012 08:50:46 +0100"/>
                            <attachment id="12542309" name="BOOKKEEPER-380.diff" size="7351" author="ikelly" created="Fri, 24 Aug 2012 19:05:34 +0100"/>
                            <attachment id="12542274" name="BOOKKEEPER-380.patch" size="7352" author="rakeshr" created="Fri, 24 Aug 2012 14:57:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 24 Aug 2012 18:05:34 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>293551</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyn6jr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>169248</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>