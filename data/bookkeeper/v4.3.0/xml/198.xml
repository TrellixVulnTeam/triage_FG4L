<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:26:00 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-198/BOOKKEEPER-198.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-198] replaying entries of deleted ledgers would exhaust ledger cache.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-198</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;we found that replaying entries of deleted ledgers would exhaust ledger cache. then ledger cache would no clean page to grab, it would throw following exception.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.util.NoSuchElementException
        at java.util.LinkedList.getFirst(LinkedList.java:109)
        at org.apache.bookkeeper.bookie.LedgerCacheImpl.grabCleanPage(LedgerCacheImpl.java:454)
        at org.apache.bookkeeper.bookie.LedgerCacheImpl.putEntryOffset(LedgerCacheImpl.java:165)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;this issue is because bookie grabs a clean page but fail to updating page due to NoLedgerException, but bookie doesn&apos;t return this clean page back to ledger cache. so the ledger cache is exhausted, when new ledger want to grab a clean page, it failed to find available page.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12548798">BOOKKEEPER-198</key>
            <summary>replaying entries of deleted ledgers would exhaust ledger cache.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Mar 2012 08:57:34 +0100</created>
                <updated>Mon, 22 Oct 2012 15:50:16 +0100</updated>
                            <resolved>Sat, 31 Mar 2012 09:31:40 +0100</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13242151" author="hustlmsp" created="Fri, 30 Mar 2012 09:10:05 +0100"  >&lt;p&gt;quite simple a patch. it just returns the failed to be used clean page back to ledger cache.&lt;/p&gt;</comment>
                            <comment id="13242168" author="fpj" created="Fri, 30 Mar 2012 09:51:38 +0100"  >&lt;p&gt;It is mostly good, Sijie. I just think that pageCount has to be in a synchronized block when decremented here:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;catch (IOException ie) {
+            // if we grab a clean page, but failed to update the page
+            // we are exhuasting the count of ledger entry pages.
+            // since this page will be never used, so we need to decrement
+            // page count of ledger cache.
+            lep.releasePage();
+            --pageCount;
+            throw ie; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;no?&lt;/p&gt;</comment>
                            <comment id="13242178" author="hustlmsp" created="Fri, 30 Mar 2012 10:16:32 +0100"  >&lt;p&gt;ah, ur right. It should do synchronization when decrementing page count.&lt;/p&gt;

&lt;p&gt;attach a new patch to address this issue.&lt;/p&gt;</comment>
                            <comment id="13242192" author="fpj" created="Fri, 30 Mar 2012 10:34:34 +0100"  >&lt;p&gt;Thanks, Sijie. The patch looks good, but I&apos;m now confused by a different thing. I couldn&apos;t find code to decrement pageCount in trunk. Shouldn&apos;t we decrement pageCount as we flush pages? Consequently, there should a line somewhere decrementing it, no? &lt;/p&gt;

&lt;p&gt;I&apos;m mentioning this because it might be worth having a test, not necessarily for this jira, that confirms that our logic increments and decrements correctly. In particular, we should test that it grows and eventually becomes zero again, never going negative.&lt;/p&gt;</comment>
                            <comment id="13242202" author="hustlmsp" created="Fri, 30 Mar 2012 10:53:59 +0100"  >&lt;p&gt;actually, we don&apos;t need to decrement the page count in successful case. when we need to grab a clean page, we find the available page from existing pages in ledger cache, if there exists a clean page in pages pool (HashMap&amp;lt;Long, HashMap&amp;lt;Long,LedgerEntryPage&amp;gt;&amp;gt;), we remove it from pages pool, make it as a zero page and available for new request to use. so the ledger page is just changing the ownership, we don&apos;t need to decrement pageCount.&lt;/p&gt;

&lt;p&gt;only the case we need to decrement pageCount is after removing it from pages pool, but new request failed to use it. it is orphan page, we need to decrement it.&lt;/p&gt;

&lt;p&gt;from this side, the pageCount would not go negative, since the max number of decrements would not be more than number pages existed in pages pool, and the number of pages in pages pool is pageLimit.&lt;/p&gt;</comment>
                            <comment id="13242249" author="fpj" created="Fri, 30 Mar 2012 11:50:12 +0100"  >&lt;blockquote&gt;&lt;p&gt;only the case we need to decrement pageCount is after removing it from pages pool, but new request failed to use it. it is orphan page, we need to decrement it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why don&apos;t we return the page to the pool in the case of a failure? If the pool size is supposed to be constant, then why do we have a page count?&lt;/p&gt;</comment>
                            <comment id="13242255" author="hustlmsp" created="Fri, 30 Mar 2012 12:00:40 +0100"  >&lt;p&gt;&amp;gt; If the pool size is supposed to be constant, then why do we have a page count?&lt;/p&gt;

&lt;p&gt;actually, ledger cache doesn&apos;t preallocate the pages pool. it did that incrementally. so we need a page count.&lt;br/&gt;
when the size of pages reaches pageLimit, it becomes be constant.&lt;/p&gt;

&lt;p&gt;newly requests to grab a new page just acts as borrowing existing clean pages in the pages pool.&lt;/p&gt;

&lt;p&gt;&amp;gt; Why don&apos;t we return the page to the pool in the case of a failure?&lt;/p&gt;

&lt;p&gt;actually the pool is a mapping between ledger id and pages. the failure happened after we borrowed an existing clean page from other ledgers and before we put it again to table. the original info in that page has been cleaned after we grabbed it, so we don&apos;t know where to return it back. this page becomes orphan, the only way is to drop it and decrement the pageCount, so a new page would be allocated to replace the orphan in future requests.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;168         LedgerEntryPage lep = grabCleanPage(ledger, pageEntry);&lt;br/&gt;
169         try {&lt;br/&gt;
170             // should update page before we put it into table&lt;br/&gt;
171             // otherwise we would put an empty page in it&lt;br/&gt;
172             updatePage(lep);&lt;br/&gt;
173             synchronized(this) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {
174                 putIntoTable(pages, lep);
175             }&lt;/span&gt; &lt;/div&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13242260" author="fpj" created="Fri, 30 Mar 2012 12:11:49 +0100"  >&lt;p&gt;+1, thanks for the clarifications, Sijie.&lt;/p&gt;</comment>
                            <comment id="13243068" author="hustlmsp" created="Sat, 31 Mar 2012 08:32:21 +0100"  >&lt;p&gt;committed as r1307732. thanks Flavio for reviewing.&lt;/p&gt;</comment>
                            <comment id="13243075" author="hudson" created="Sat, 31 Mar 2012 08:57:27 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #437 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/437/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/437/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-198&quot; title=&quot;replaying entries of deleted ledgers would exhaust ledger cache.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-198&quot;&gt;&lt;del&gt;BOOKKEEPER-198&lt;/del&gt;&lt;/a&gt;: replaying entries of deleted ledgers would exhaust ledger cache. (sijie) (Revision 1307732)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
sijie : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/LedgerCacheTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12520579" name="BK-198.patch" size="5582" author="hustlmsp" created="Fri, 30 Mar 2012 09:10:00 +0100"/>
                            <attachment id="12520582" name="BK-198.patch_v2" size="5636" author="hustlmsp" created="Fri, 30 Mar 2012 10:16:29 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 30 Mar 2012 08:51:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233895</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4s1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61699</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>