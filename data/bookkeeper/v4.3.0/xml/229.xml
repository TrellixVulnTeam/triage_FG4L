<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:32:48 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-229/BOOKKEEPER-229.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-229] Deleted entry log files would be garbage collected again and again.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-229</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;after &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-188&quot; title=&quot;Garbage collection code is in the wrong place&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-188&quot;&gt;&lt;del&gt;BOOKKEEPER-188&lt;/del&gt;&lt;/a&gt; is applied, extractMetaFromEntryLogs is moved from EntryLogger to GarbageCollectorThread with some changed.&lt;/p&gt;

&lt;p&gt;Before &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-188&quot; title=&quot;Garbage collection code is in the wrong place&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-188&quot;&gt;&lt;del&gt;BOOKKEEPER-188&lt;/del&gt;&lt;/a&gt; is applied,  we just add the entryLogMeta to entryLogMetaMap only when we could extract the entry log file. If a log file is garbage collected, its entryLogMeta would not be put in the map.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, EntryLogMetadata&amp;gt; extractMetaFromEntryLogs(Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, EntryLogMetadata&amp;gt; entryLogMetaMap) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
-        &lt;span class=&quot;code-comment&quot;&gt;// Extract it &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; every entry log except &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the current one.
&lt;/span&gt;-        &lt;span class=&quot;code-comment&quot;&gt;// Entry Log ID&apos;s are just a &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value that starts at 0 and increments
&lt;/span&gt;-        &lt;span class=&quot;code-comment&quot;&gt;// by 1 when the log fills up and we roll to a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; one.
&lt;/span&gt;-        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; curLogId = logId;
-        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; entryLogId = 0; entryLogId &amp;lt; curLogId; entryLogId++) {
-            &lt;span class=&quot;code-comment&quot;&gt;// Comb the current entry log file &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it has not already been extracted.
&lt;/span&gt;-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entryLogMetaMap.containsKey(entryLogId)) {
-                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
-            }
-            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Extracting entry log meta from entryLogId: &quot;&lt;/span&gt; + entryLogId);
-            EntryLogMetadata entryLogMeta = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EntryLogMetadata(entryLogId);
-            ExtractionScanner scanner = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExtractionScanner(entryLogMeta);
-            &lt;span class=&quot;code-comment&quot;&gt;// Read through the entry log file and extract the entry log meta
&lt;/span&gt;-            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
-                scanEntryLog(entryLogId, scanner);
-                LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Retrieved entry log meta data entryLogId: &quot;&lt;/span&gt; + entryLogId + &lt;span class=&quot;code-quote&quot;&gt;&quot;, meta: &quot;&lt;/span&gt; + entryLogMeta);
-                entryLogMetaMap.put(entryLogId, entryLogMeta);
-            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(IOException e) {
-              LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Premature exception when processing &quot;&lt;/span&gt; + entryLogId +
-                       &lt;span class=&quot;code-quote&quot;&gt;&quot;recovery will take care of the problem&quot;&lt;/span&gt;, e);
-            }
-
-        }
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; entryLogMetaMap;
-    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But after &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-188&quot; title=&quot;Garbage collection code is in the wrong place&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-188&quot;&gt;&lt;del&gt;BOOKKEEPER-188&lt;/del&gt;&lt;/a&gt; is applied,  an empty entryLogMeta would be put into entryLogMetaMap for those deleted entry log files. So GarbageCollectorThread would gc those deleted entry log files again. Then there is lots of such kind of error messages, these are noise error message but doesn&apos;t affect the logic.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, EntryLogMetadata&amp;gt; extractMetaFromEntryLogs(Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, EntryLogMetadata&amp;gt; entryLogMetaMap)
+            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+        &lt;span class=&quot;code-comment&quot;&gt;// Extract it &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; every entry log except &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the current one.
&lt;/span&gt;+        &lt;span class=&quot;code-comment&quot;&gt;// Entry Log ID&apos;s are just a &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value that starts at 0 and increments
&lt;/span&gt;+        &lt;span class=&quot;code-comment&quot;&gt;// by 1 when the log fills up and we roll to a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; one.
&lt;/span&gt;+        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; curLogId = entryLogger.logId;
+        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; entryLogId = 0; entryLogId &amp;lt; curLogId; entryLogId++) {
+            &lt;span class=&quot;code-comment&quot;&gt;// Comb the current entry log file &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it has not already been extracted.
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entryLogMetaMap.containsKey(entryLogId)) {
+                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
+            }
+            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Extracting entry log meta from entryLogId: &quot;&lt;/span&gt; + entryLogId);
+
+            &lt;span class=&quot;code-comment&quot;&gt;// Read through the entry log file and extract the entry log meta
&lt;/span&gt;+            entryLogMetaMap.put(entryLogId,
+                                extractMetaFromEntryLog(entryLogger, entryLogId));
+        }
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; entryLogMetaMap;
+    }
+
+    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; EntryLogMetadata extractMetaFromEntryLog(EntryLogger entryLogger, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; entryLogId)
+            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+        EntryLogMetadata entryLogMeta = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EntryLogMetadata(entryLogId);
+        ExtractionScanner scanner = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExtractionScanner(entryLogMeta);
+        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+            &lt;span class=&quot;code-comment&quot;&gt;// Read through the entry log file and extract the entry log meta
&lt;/span&gt;+            entryLogger.scanEntryLog(entryLogId, scanner);
+            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Retrieved entry log meta data entryLogId: &quot;&lt;/span&gt;
+                     + entryLogId + &lt;span class=&quot;code-quote&quot;&gt;&quot;, meta: &quot;&lt;/span&gt; + entryLogMeta);
+        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(IOException e) {
+            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Premature exception when processing &quot;&lt;/span&gt; + entryLogId +
+                     &lt;span class=&quot;code-quote&quot;&gt;&quot;recovery will take care of the problem&quot;&lt;/span&gt;, e);
+        }
+
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; entryLogMeta;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12552804">BOOKKEEPER-229</key>
            <summary>Deleted entry log files would be garbage collected again and again.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hustlmsp">Sijie Guo</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Apr 2012 08:22:23 +0100</created>
                <updated>Mon, 22 Oct 2012 15:50:15 +0100</updated>
                            <resolved>Tue, 8 May 2012 08:36:53 +0100</resolved>
                                    <version>4.1.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13262460" author="hustlmsp" created="Thu, 26 Apr 2012 09:22:44 +0100"  >&lt;p&gt;attach a patch to fix this noise error messages.&lt;/p&gt;</comment>
                            <comment id="13262495" author="hustlmsp" created="Thu, 26 Apr 2012 10:42:07 +0100"  >&lt;p&gt;attach a new patch adding an assertion in EntryLogTest based on previous patch.&lt;/p&gt;</comment>
                            <comment id="13268468" author="fpj" created="Fri, 4 May 2012 16:48:38 +0100"  >&lt;p&gt;The patch looks good to me, but the test change does not fail when I only apply the test change, ignoring the change to GarbageCollectorThread. Cancelling the patch until we figure it out.&lt;/p&gt;</comment>
                            <comment id="13269384" author="hustlmsp" created="Mon, 7 May 2012 06:48:21 +0100"  >&lt;p&gt;the test change is not related to code change. because the patch changed extractMetaFromEntryLog to throw IOException, so EntryLogTest can&apos;t get EntryLogMeta. I just changed the method used in EntryLogTest not to break the test.&lt;/p&gt;</comment>
                            <comment id="13269433" author="fpj" created="Mon, 7 May 2012 08:44:43 +0100"  >&lt;p&gt;Got it, thanks. One small issue, I think that extractMetaFromEntryLogs does not need to throw an IOException any longer. If you remove it, I believe there is only one compilation error to fix.&lt;/p&gt;</comment>
                            <comment id="13269445" author="hustlmsp" created="Mon, 7 May 2012 09:10:44 +0100"  >&lt;p&gt;OK thanks for pointing out. will update it ASAP.&lt;/p&gt;</comment>
                            <comment id="13269597" author="hustlmsp" created="Mon, 7 May 2012 14:24:06 +0100"  >&lt;p&gt;attach a new patch addressing Flavio&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="13270291" author="fpj" created="Tue, 8 May 2012 08:36:38 +0100"  >&lt;p&gt;+1, thanks sijie.&lt;/p&gt;</comment>
                            <comment id="13270292" author="fpj" created="Tue, 8 May 2012 08:36:54 +0100"  >&lt;p&gt;Committed revision 1335367.&lt;/p&gt;</comment>
                            <comment id="13270314" author="hudson" created="Tue, 8 May 2012 09:24:26 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #493 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/493/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/493/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-229&quot; title=&quot;Deleted entry log files would be garbage collected again and again.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-229&quot;&gt;&lt;del&gt;BOOKKEEPER-229&lt;/del&gt;&lt;/a&gt;: Deleted entry log files would be garbage collected again and again. (sijie via fpj) (Revision 1335367)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
fpj : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/GarbageCollectorThread.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12524408" name="BK-229.diff" size="3658" author="hustlmsp" created="Thu, 26 Apr 2012 09:22:44 +0100"/>
                            <attachment id="12524417" name="BK-229.diff_v2" size="3703" author="hustlmsp" created="Thu, 26 Apr 2012 10:42:07 +0100"/>
                            <attachment id="12525843" name="BK-229.diff_v3" size="4971" author="hustlmsp" created="Mon, 7 May 2012 14:24:06 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 4 May 2012 15:48:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>236870</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4s4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61714</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>