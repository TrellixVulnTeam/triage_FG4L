<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:30:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-63/BOOKKEEPER-63.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-63] Hedwig PubSubServer must wait for its Zookeeper client to be connected upon startup</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-63</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;When a PubSubServer is instantiated in &lt;b&gt;non-standalone&lt;/b&gt; mode, it creates a ZkTopicManager which takes a Zookeeper client as an argument.&lt;br/&gt;
Unfortunately, this Zookeeper client may not be connected yet (not in CONNECTED state yet), and when this is the case, creation of ZkTopicManager fails, leading to failure of the PubSubServer startup.&lt;/p&gt;

&lt;p&gt;Typical error (adapted, line numbers take into account commented patching code):&lt;br/&gt;
jjava.io.IOException: org.apache.hedwig.exceptions.PubSubException$ServiceDownException: org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /hedwig/standalone/hosts/x.x.x.x:4080:9876&lt;br/&gt;
	at org.apache.hedwig.server.netty.PubSubServer.instantiateTopicManager(PubSubServer.java:170)&lt;br/&gt;
	at org.apache.hedwig.server.netty.PubSubServer$3.run(PubSubServer.java:294)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: org.apache.hedwig.exceptions.PubSubException$ServiceDownException: org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /hedwig/standalone/hosts/x.x.x.x:4080:9876&lt;br/&gt;
	at org.apache.hedwig.server.topics.ZkTopicManager$4.safeProcessResult(ZkTopicManager.java:146)&lt;br/&gt;
etc...&lt;/p&gt;

&lt;p&gt;This is particularly problematic for running tests that require to pass a config to the PubSubServer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12520909">BOOKKEEPER-63</key>
            <summary>Hedwig PubSubServer must wait for its Zookeeper client to be connected upon startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="mmorel">Matthieu Morel</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Aug 2011 12:29:45 +0100</created>
                <updated>Wed, 7 Dec 2011 15:56:09 +0000</updated>
                            <resolved>Mon, 5 Sep 2011 11:33:43 +0100</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                    <component>hedwig-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13094437" author="mmorel" created="Wed, 31 Aug 2011 12:31:02 +0100"  >&lt;p&gt;here is a test case that reproduces the issue&lt;/p&gt;</comment>
                            <comment id="13094442" author="mmorel" created="Wed, 31 Aug 2011 12:44:18 +0100"  >&lt;p&gt;solves the issue by waiting for the connected event callback, with a timeout of conf.getZkTimeout()*2&lt;/p&gt;</comment>
                            <comment id="13095205" author="mmorel" created="Thu, 1 Sep 2011 10:43:12 +0100"  >&lt;p&gt;fixed watcher event evaluation in previous patch&lt;/p&gt;</comment>
                            <comment id="13095374" author="ikelly" created="Thu, 1 Sep 2011 17:15:33 +0100"  >&lt;p&gt;Looks good, but you should also check the return value of CountdownLatch.await. If a timeout has occurred the code should LOG.fatal and throw an exception. Also, could you name the patch &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-63&quot; title=&quot;Hedwig PubSubServer must wait for its Zookeeper client to be connected upon startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-63&quot;&gt;&lt;del&gt;BOOKKEEPER-63&lt;/del&gt;&lt;/a&gt;.diff or .patch etc. The extension doesn&apos;t matter, but having them named makes it easier to see what I&apos;m working with in my source tree.&lt;/p&gt;</comment>
                            <comment id="13095375" author="ikelly" created="Thu, 1 Sep 2011 17:15:34 +0100"  >&lt;p&gt;Looks good, but you should also check the return value of CountdownLatch.await. If a timeout has occurred the code should LOG.fatal and throw an exception. Also, could you name the patch &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-63&quot; title=&quot;Hedwig PubSubServer must wait for its Zookeeper client to be connected upon startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-63&quot;&gt;&lt;del&gt;BOOKKEEPER-63&lt;/del&gt;&lt;/a&gt;.diff or .patch etc. The extension doesn&apos;t matter, but having them named makes it easier to see what I&apos;m working with in my source tree.&lt;/p&gt;</comment>
                            <comment id="13095964" author="mmorel" created="Fri, 2 Sep 2011 14:12:34 +0100"  >&lt;p&gt;patch with regression test&lt;/p&gt;</comment>
                            <comment id="13095980" author="ikelly" created="Fri, 2 Sep 2011 14:40:38 +0100"  >&lt;p&gt;This patch fails:&lt;/p&gt;

&lt;p&gt;Tests in error: &lt;br/&gt;
  testSyncPublish(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testAsyncPublish(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testMultipleAsyncPublish(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testSyncSubscribe(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testAsyncSubscribe(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testSubscribeAndConsume(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testAsyncSubscribeAndUnsubscribe(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testSyncUnsubscribeWithoutSubscription(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testAsyncSubscribeAndCloseSubscription(org.apache.hedwig.client.TestPubSubClient): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testSecondServer(org.apache.hedwig.server.netty.TestPubSubServer): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testUncaughtExceptionInNettyThread(org.apache.hedwig.server.netty.TestPubSubServer): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testUncaughtExceptionInZKThread(org.apache.hedwig.server.netty.TestPubSubServer): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testInvalidServerConfiguration(org.apache.hedwig.server.netty.TestPubSubServer): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testValidServerConfiguration(org.apache.hedwig.server.netty.TestPubSubServer): Could not establish connection with ZooKeeper after zk_timeout*2 = 4000 ms. (Default value for zk_timeout is 2000).&lt;br/&gt;
  testNonEmptyDirtyLedger(org.apache.hedwig.server.persistence.TestBookkeeperPersistenceManagerWhiteBox)&lt;/p&gt;
</comment>
                            <comment id="13097058" author="mmorel" created="Mon, 5 Sep 2011 09:43:35 +0100"  >&lt;p&gt;new patch taking into account tests with standalone server&lt;/p&gt;</comment>
                            <comment id="13097111" author="mmorel" created="Mon, 5 Sep 2011 11:23:25 +0100"  >&lt;p&gt;new patch with wait code moved to instantiateZookeeperClient method&lt;/p&gt;</comment>
                            <comment id="13097116" author="ikelly" created="Mon, 5 Sep 2011 11:33:43 +0100"  >&lt;p&gt;Committed in r1165231. Thanks Matthieu.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12493017" name="BOOKKEEPER-63.patch" size="7804" author="mmorel" created="Mon, 5 Sep 2011 11:23:25 +0100"/>
                            <attachment id="12493009" name="BOOKKEEPER-63.patch" size="8503" author="mmorel" created="Mon, 5 Sep 2011 09:43:35 +0100"/>
                            <attachment id="12492738" name="BOOKKEEPER-63.patch" size="8479" author="mmorel" created="Fri, 2 Sep 2011 14:12:33 +0100"/>
                            <attachment id="12492444" name="patch-testcase.txt" size="4075" author="mmorel" created="Wed, 31 Aug 2011 12:31:02 +0100"/>
                            <attachment id="12492587" name="patch-v2.txt" size="2875" author="mmorel" created="Thu, 1 Sep 2011 10:43:12 +0100"/>
                            <attachment id="12492445" name="patch.txt" size="2864" author="mmorel" created="Wed, 31 Aug 2011 12:44:18 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 1 Sep 2011 16:15:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62689</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyo0nr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>174126</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>