<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:26:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-190/BOOKKEEPER-190.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-190] Add entries would fail when number of open ledgers reaches more than openFileLimit.</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-190</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>
&lt;p&gt;when the number of open ledgers reaches more than openFileLimit, a file info will be closed and removed from opened ledgers list. And after &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-137&quot; title=&quot;Do not create Ledger index files until absolutely necessary.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-137&quot;&gt;&lt;del&gt;BOOKKEEPER-137&lt;/del&gt;&lt;/a&gt;, the ledger index file creation delayed until necessary.&lt;/p&gt;

&lt;p&gt;suppose ledger l is removed from opened ledger list, and its index file haven&apos;t been created.&lt;br/&gt;
new add entries operations of other ledgers came into bookie server, a new page need to be grab for them. so bookie server may need to flush the dirty pages of ledger l(when page cache is full). and the flush would fail due to NoLedgerException (no index file found).&lt;/p&gt;

&lt;p&gt;actually the ledger l isn&apos;t lost, it could be recovered if restarting bookie server, but the bookie server would not work well on adding entries. &lt;/p&gt;

&lt;p&gt;a proposal solution is that we need to force index creation when the ledger is evicted from open ledgers list.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-03-21 14:00:42,989 - DEBUG - [NIOServerFactory-5000:LedgerCache@235] - New ledger index file created &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ledgerId: 4
2012-03-21 14:00:42,990 - INFO  - [NIOServerFactory-5000:LedgerCache@241] - Ledger 2 is evicted from file info cache.
2012-03-21 14:00:42,990 - DEBUG - [New I/O client worker #1-1:PerChannelBookieClient$2@255] - Successfully wrote request &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; adding entry: 0 ledger-id: 4 bookie: /10.82.129.173:5000 entry length: 70
2012-03-21 14:00:42,990 - ERROR - [NIOServerFactory-5000:BookieServer@361] - Error writing 0@4
org.apache.bookkeeper.bookie.Bookie$NoLedgerException: Ledger 2 not found
        at org.apache.bookkeeper.bookie.LedgerCache.getFileInfo(LedgerCache.java:228)
        at org.apache.bookkeeper.bookie.LedgerCache.flushLedger(LedgerCache.java:359)
        at org.apache.bookkeeper.bookie.LedgerCache.flushLedger(LedgerCache.java:292)
        at org.apache.bookkeeper.bookie.LedgerCache.grabCleanPage(LedgerCache.java:447)
        at org.apache.bookkeeper.bookie.LedgerCache.putEntryOffset(LedgerCache.java:157)
        at org.apache.bookkeeper.bookie.LedgerDescriptor.addEntry(LedgerDescriptor.java:130)
        at org.apache.bookkeeper.bookie.Bookie.addEntryInternal(Bookie.java:1059)
        at org.apache.bookkeeper.bookie.Bookie.addEntry(Bookie.java:1099)
        at org.apache.bookkeeper.proto.BookieServer.processPacket(BookieServer.java:357)
        at org.apache.bookkeeper.proto.NIOServerFactory$Cnxn.readRequest(NIOServerFactory.java:315)
        at org.apache.bookkeeper.proto.NIOServerFactory$Cnxn.doIO(NIOServerFactory.java:213)
        at org.apache.bookkeeper.proto.NIOServerFactory.run(NIOServerFactory.java:124)
2012-03-21 14:00:42,991 - DEBUG - [pool-3-thread-1:PerChannelBookieClient@576] - Got response &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; add request from bookie: /10.82.129.173:5000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ledger: 4 entry: 0 rc: 101
2012-03-21 14:00:42,991 - ERROR - [pool-3-thread-1:PerChannelBookieClient@594] - Add &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ledger: 4, entry: 0 failed on bookie: /10.82.129.173:5000 with code: 101
2012-03-21 14:00:42,991 - WARN  - [pool-3-thread-1:PendingAddOp@142] - Write did not succeed: 4, 0

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12547344">BOOKKEEPER-190</key>
            <summary>Add entries would fail when number of open ledgers reaches more than openFileLimit.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Mar 2012 07:47:40 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:18 +0100</updated>
                            <resolved>Thu, 29 Mar 2012 13:08:03 +0100</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13234193" author="hustlmsp" created="Wed, 21 Mar 2012 07:52:55 +0000"  >&lt;p&gt;attach a patch to fix this issue.&lt;/p&gt;

&lt;p&gt;the patch is quite simple, just force index creation when the ledger is evicted from open ledgers list. &lt;/p&gt;

&lt;p&gt;also it fixed the reference counting issue on FileInfo, to release useCount after use it. otherwise, the index file is not closed actually, will cause &apos;Too many opened files&apos; problem.&lt;/p&gt;</comment>
                            <comment id="13234497" author="fpj" created="Wed, 21 Mar 2012 16:57:15 +0000"  >&lt;p&gt;hi sijie, it looks good, but let me propose a slightly different approach for the test. I think that it should be more focused and should be really just exercising the cache here instead of emulating a full run. We could start a single bookie, create ledgers through the bookie interface, and verify that we don&apos;t get an error when evicting the ledger. How does it sound to you? &lt;/p&gt;</comment>
                            <comment id="13235346" author="hustlmsp" created="Thu, 22 Mar 2012 04:48:58 +0000"  >&lt;p&gt;@Flavio.&lt;/p&gt;

&lt;p&gt;I agreed. since the test is related to cache eviction, so I moved the test case to LedgerCacheTest, and changed it as what you suggested. a new patch is attached.&lt;/p&gt;</comment>
                            <comment id="13235463" author="fpj" created="Thu, 22 Mar 2012 08:56:31 +0000"  >&lt;p&gt;+1, looks great, Sijie. Thanks for changing the test.&lt;/p&gt;</comment>
                            <comment id="13236674" author="ikelly" created="Fri, 23 Mar 2012 15:28:41 +0000"  >&lt;p&gt;I have a few small comments on the patch.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;In evictFileInfoIfNecessary() you should use {}, so that the string isn&apos;t constructed is info level is turned off. It&apos;s not an issue here really, but it&apos;s a good habit to get into.&lt;/li&gt;
	&lt;li&gt;Why construct a Bookie at all? The LedgerCache can be used as a standalone component now, so we should test it as such.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13236699" author="hustlmsp" created="Fri, 23 Mar 2012 15:54:32 +0000"  >&lt;p&gt;&amp;gt; 1. In evictFileInfoIfNecessary() you should use {}, so that the string isn&apos;t constructed is info level is turned off&lt;/p&gt;

&lt;p&gt;OK. I will did the change.&lt;/p&gt;

&lt;p&gt;&amp;gt; Why construct a Bookie at all? The LedgerCache can be used as a standalone component now, so we should test it as such.&lt;/p&gt;

&lt;p&gt;yeah. seems that testLedgerEviction could use LedgerCache#putEntryOffset to test.&lt;/p&gt;

&lt;p&gt;but I am not so clear that LedgerCacheTest#testAddEntryException tries to test what kind of case. seems that it tried to populate the ledger cache to force eviction, which is similar with testLedgerEviction. could any one explain it?&lt;/p&gt;</comment>
                            <comment id="13236940" author="fpj" created="Fri, 23 Mar 2012 18:57:42 +0000"  >&lt;p&gt;Hi Sijie, We introduced LedgerCacheTest (and LedgerCacheTest#testAddEntryException) in &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-22&quot; title=&quot;Exception in LedgerCache causes addEntry request to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-22&quot;&gt;&lt;del&gt;BOOKKEEPER-22&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13238186" author="hustlmsp" created="Mon, 26 Mar 2012 08:57:46 +0100"  >&lt;p&gt;thanks, Flavio.&lt;/p&gt;

&lt;p&gt;attach a new patch.&lt;/p&gt;

&lt;p&gt;in this patch, I modified the LedgerCacheTest according to Ivan&apos;s suggestions, which make the test focus on testing ledger cache itself.&lt;/p&gt;

&lt;p&gt;BTW, it remove/modify &apos;System.out&apos; code in LedgerCache, and also fix a simple bug LedgerCache#grabCleanPage (we don&apos;t remove a ledger from cleanLedger list if we found that there is no clean page in it. then clean ledger list would not be empty, so no flush will be trigger). &lt;/p&gt;</comment>
                            <comment id="13241168" author="ikelly" created="Thu, 29 Mar 2012 13:08:04 +0100"  >&lt;p&gt;Committed as r1306839. Thanks Sijie.&lt;/p&gt;</comment>
                            <comment id="13241282" author="hudson" created="Thu, 29 Mar 2012 15:48:57 +0100"  >&lt;p&gt;Integrated in bookkeeper-trunk #433 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/433/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/433/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-190&quot; title=&quot;Add entries would fail when number of open ledgers reaches more than openFileLimit.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-190&quot;&gt;&lt;del&gt;BOOKKEEPER-190&lt;/del&gt;&lt;/a&gt;: Add entries would fail when number of open ledgers reaches more than openFileLimit. (sijie via ivank) (Revision 1306839)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/LedgerCacheTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/LedgerCacheTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12519192" name="BOOKKEEPER-190.diff" size="11819" author="hustlmsp" created="Wed, 21 Mar 2012 07:52:55 +0000"/>
                            <attachment id="12519402" name="BOOKKEEPER-190.diff_v2" size="10814" author="hustlmsp" created="Thu, 22 Mar 2012 04:48:57 +0000"/>
                            <attachment id="12519921" name="BOOKKEEPER-190.diff_v3" size="20955" author="hustlmsp" created="Mon, 26 Mar 2012 08:57:45 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 21 Mar 2012 16:57:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>232502</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4rw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61675</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>