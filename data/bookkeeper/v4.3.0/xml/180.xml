<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat May 16 23:29:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/BOOKKEEPER-180/BOOKKEEPER-180.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[BOOKKEEPER-180] bookie server doesn&apos;t quit when running out of disk space</title>
                <link>https://issues.apache.org/jira/browse/BOOKKEEPER-180</link>
                <project id="12311293" key="BOOKKEEPER">Bookkeeper</project>
                    <description>&lt;p&gt;we found that the publish throughput drops down when one bookie server ran out of disk space (due to we don&apos;t do log rotation   which exhausts disk space). &lt;/p&gt;

&lt;p&gt;did some investigation, we found that bookie server doesn&apos;t quit when encountering no disk space issue. so hub server treat this bookie server as available. The adding requests would be sent to this bookie server, some adding requests are put in journal queue to flush, but the journal flush thread has quit due to no disk space. so these adding requests didn&apos;t respond to bookie client until it read timeout and chose other bookie servers.&lt;/p&gt;

&lt;p&gt;we did an experiment to shut down the ran-out-of-disk-space bookie, the publish throughput went up again quickly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12544728">BOOKKEEPER-180</key>
            <summary>bookie server doesn&apos;t quit when running out of disk space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ikelly">Ivan Kelly</assignee>
                                    <reporter username="hustlmsp">Sijie Guo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Mar 2012 05:11:56 +0000</created>
                <updated>Mon, 22 Oct 2012 15:50:14 +0100</updated>
                            <resolved>Thu, 8 Mar 2012 18:25:28 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>bookkeeper-server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13219813" author="hustlmsp" created="Thu, 1 Mar 2012 05:14:14 +0000"  >&lt;p&gt;attach a throughput graph. the throughput went down when a bookie ran out of disk space, while the throughput went up again after shutting down the ran-out-of-disk-space bookie server.&lt;/p&gt;</comment>
                            <comment id="13219925" author="hustlmsp" created="Thu, 1 Mar 2012 08:48:26 +0000"  >&lt;p&gt;attach a patch to shut down the bookie server if the bookie thread quits. &lt;/p&gt;

&lt;p&gt;and did some change to call System.exit in BookieServer when encountering issues (such as ZkExpire, bookie thread quit), since some monitoring tool would detect exit code to restart the bookie server process. if bookie server don&apos;t exit with non-zero code, it would be treated as a normal quit, monitor tool would not start it.&lt;/p&gt;</comment>
                            <comment id="13220099" author="ikelly" created="Thu, 1 Mar 2012 15:28:08 +0000"  >
&lt;p&gt;I have a couple of comments.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;all the error codes should be in the same place&lt;/li&gt;
	&lt;li&gt;errno should be called exitCode&lt;/li&gt;
	&lt;li&gt;I don&apos;t like this pattern of setting errno, then calling shutdown() and then calling System.exit() is interrupted. I don&apos;t think Bookie.java should ever call System.exit(). shutdown() should take the error code as a parameter and should not throw InterruptedException. It should catch it and log an error.&lt;/li&gt;
	&lt;li&gt;I dont understand the new code in Bookie#run. Shouldn&apos;t the Deathwatcher catch this problem?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13220826" author="hustlmsp" created="Fri, 2 Mar 2012 10:39:37 +0000"  >&lt;p&gt;&amp;gt; I dont understand the new code in Bookie#run. Shouldn&apos;t the Deathwatcher catch this problem?&lt;/p&gt;

&lt;p&gt;currently Deathwatcher watching on running flag to know whether bookie is alive or not. If Bookie thread encountered exceptions such as IOException (due to no disk space left), the bookie thread quits but other threads are still alive and the running flag is not set to false. so new code is added to shut down other threads.&lt;/p&gt;</comment>
                            <comment id="13221546" author="hustlmsp" created="Sat, 3 Mar 2012 09:15:21 +0000"  >&lt;p&gt;attach a new patch trying to address ivan&apos;s comment.&lt;/p&gt;</comment>
                            <comment id="13222273" author="ikelly" created="Mon, 5 Mar 2012 11:11:50 +0000"  >&lt;p&gt;Patch looks good. You need to run &quot;mvn clean install&quot; on toplevel directory though, there&apos;s a couple of compile errors due to InterruptedException no longer being thrown.&lt;/p&gt;</comment>
                            <comment id="13222285" author="hustlmsp" created="Mon, 5 Mar 2012 11:52:04 +0000"  >&lt;p&gt;thanks for Ivan&apos;s reminder. attach a new patch addressed InterruptedException issue.&lt;/p&gt;</comment>
                            <comment id="13225147" author="ikelly" created="Thu, 8 Mar 2012 11:27:22 +0000"  >&lt;p&gt;The new patch conflicts with &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-160&quot; title=&quot;bookie server needs to do compaction over entry log files to reclaim disk space&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-160&quot;&gt;&lt;del&gt;BOOKKEEPER-160&lt;/del&gt;&lt;/a&gt;. The merge looks simple, but I&apos;d prefer if you did it, as you know these changes better.&lt;/p&gt;</comment>
                            <comment id="13225219" author="hustlmsp" created="Thu, 8 Mar 2012 14:17:53 +0000"  >&lt;p&gt;new patch is attached.&lt;/p&gt;</comment>
                            <comment id="13225362" author="ikelly" created="Thu, 8 Mar 2012 18:25:28 +0000"  >&lt;p&gt;Committed as r1298492. Thanks Sijie&lt;/p&gt;</comment>
                            <comment id="13225382" author="hudson" created="Thu, 8 Mar 2012 18:47:20 +0000"  >&lt;p&gt;Integrated in bookkeeper-trunk #394 (See &lt;a href=&quot;https://builds.apache.org/job/bookkeeper-trunk/394/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/bookkeeper-trunk/394/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-180&quot; title=&quot;bookie server doesn&amp;#39;t quit when running out of disk space&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-180&quot;&gt;&lt;del&gt;BOOKKEEPER-180&lt;/del&gt;&lt;/a&gt;: bookie server doesn&apos;t quit when running out of disk space (sijie via ivank) (Revision 1298492)&lt;/p&gt;

&lt;p&gt;     Result = UNSTABLE&lt;br/&gt;
ivank : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/ExitCode.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/LedgerCacheTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ConcurrentLedgerTest.java&lt;/li&gt;
	&lt;li&gt;/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/persistence/BookKeeperTestBase.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13292704" author="vinayrpet" created="Mon, 11 Jun 2012 10:26:45 +0100"  >&lt;p&gt;hi,&lt;br/&gt;
Here One more scenario needs to be handled. &lt;br/&gt;
Adding new ledger and flushing is failed in SyncThread due to disk full. But Server did not shutdown here.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-06-11 140014,696 - ERROR [SyncThreadInterleavedLedgerStorage@156] - Exception flushing Ledger
java.io.IOException No space left on device
	at sun.nio.ch.FileDispatcher.write0(Native Method)
	at sun.nio.ch.FileDispatcher.write(FileDispatcher.java39)
	at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java69)
	at sun.nio.ch.IOUtil.write(IOUtil.java26)
	at sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java198)
	at org.apache.bookkeeper.bookie.BufferedChannel.flush(BufferedChannel.java109)
	at org.apache.bookkeeper.bookie.EntryLogger.flush(EntryLogger.java280)
	at org.apache.bookkeeper.bookie.InterleavedLedgerStorage.flush(InterleavedLedgerStorage.java154)
	at org.apache.bookkeeper.bookie.Bookie$SyncThread.run(Bookie.java200)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13292722" author="hustlmsp" created="Mon, 11 Jun 2012 11:03:13 +0100"  >&lt;p&gt;@Vinay&lt;/p&gt;

&lt;p&gt;Actually we are discussing turning server into r-o mode when encountering IOException flushing ledgers. You could refer &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-199&quot; title=&quot;Provide bookie readonly mode, when journal/ledgers flushing has failed with IOE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-199&quot;&gt;&lt;del&gt;BOOKKEEPER-199&lt;/del&gt;&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="13292739" author="umamaheswararao" created="Mon, 11 Jun 2012 11:38:52 +0100"  >&lt;p&gt;@Sijie, I remeber we were discussing about strategy at that time.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;So how about make it as a strategy, user could decide shutting down or turning to read-only when encountering a faulty bookie?&lt;/p&gt;

&lt;p&gt;Sounds good to me.&lt;br/&gt;
Just adding config parameter for this option also should be ok. if we enable it, Bookie will turn automatically to read-only mode. If we don&apos;t enable it, it will sutdown by default. Admins also can start the bookie in read-only mode explicitly.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think when user don&apos;t want read only mode to enable, then shutting down is the other option.&lt;br/&gt;
You mean we will handle this conditions as part of BK-199?&lt;/p&gt;</comment>
                            <comment id="13292745" author="hustlmsp" created="Mon, 11 Jun 2012 11:58:52 +0100"  >&lt;p&gt;@Uma&lt;/p&gt;

&lt;p&gt;yes. turning r-o mode or shutting down is decided by user as discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-199&quot; title=&quot;Provide bookie readonly mode, when journal/ledgers flushing has failed with IOE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-199&quot;&gt;&lt;del&gt;BOOKKEEPER-199&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;flushing ledger is not only running in SyncThread but also when evicting ledger index files. &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-199&quot; title=&quot;Provide bookie readonly mode, when journal/ledgers flushing has failed with IOE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-199&quot;&gt;&lt;del&gt;BOOKKEEPER-199&lt;/del&gt;&lt;/a&gt; is tried to cover all those IOException cases, so I prefer handling them in that jira.&lt;/p&gt;</comment>
                            <comment id="13292836" author="rakeshr" created="Mon, 11 Jun 2012 16:30:52 +0100"  >&lt;p&gt;Yeah Sijie. since it is IOE, I agree to add this scenario as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/BOOKKEEPER-199&quot; title=&quot;Provide bookie readonly mode, when journal/ledgers flushing has failed with IOE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BOOKKEEPER-199&quot;&gt;&lt;del&gt;BOOKKEEPER-199&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12516663" name="BK-180.diff" size="7084" author="hustlmsp" created="Thu, 1 Mar 2012 08:48:25 +0000"/>
                            <attachment id="12516933" name="BK-180.diff_v2" size="13189" author="hustlmsp" created="Sat, 3 Mar 2012 09:15:21 +0000"/>
                            <attachment id="12517073" name="BK-180.diff_v3" size="15560" author="hustlmsp" created="Mon, 5 Mar 2012 11:52:04 +0000"/>
                            <attachment id="12517564" name="BK-180.diff_v4" size="15919" author="hustlmsp" created="Thu, 8 Mar 2012 14:17:53 +0000"/>
                            <attachment id="12516647" name="conn3.png" size="6273" author="hustlmsp" created="Thu, 1 Mar 2012 05:14:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 1 Mar 2012 15:28:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>229914</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4saf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61739</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>