<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:52:18 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2433/PIG-2433.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2433] Jython import module not working if module path is in classpath</title>
                <link>https://issues.apache.org/jira/browse/PIG-2433</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;This is a hole of &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1824&quot; title=&quot;Support import modules in Jython UDF&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1824&quot;&gt;&lt;del&gt;PIG-1824&lt;/del&gt;&lt;/a&gt;. If the path of python module is in classpath, job die with the message could not instantiate &apos;org.apache.pig.scripting.jython.JythonFunction&apos;.&lt;/p&gt;

&lt;p&gt;Here is my observation:&lt;br/&gt;
If the path of python module is in classpath, fileEntry we got in JythonScriptEngine:236 is _&lt;em&gt;pyclasspath&lt;/em&gt;_/script$py.class instead of the script itself. Thus we cannot locate the script and skip the script in job.xml. &lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
register &apos;scriptB.py&apos; using org.apache.pig.scripting.jython.JythonScriptEngine as pig

A = LOAD &apos;table_testPythonNestedImport&apos; as (a0:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, a1:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;);
B = foreach A generate pig.square(a0);

dump B;

scriptB.py:

#!/usr/bin/python
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scriptA
@outputSchema(&lt;span class=&quot;code-quote&quot;&gt;&quot;x:{t:(num:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)}&quot;&lt;/span&gt;)
def sqrt(number):
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (number ** .5)
@outputSchema(&lt;span class=&quot;code-quote&quot;&gt;&quot;x:{t:(num:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;)}&quot;&lt;/span&gt;)
def square(number):
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;(scriptA.square(number))

scriptA.py:

#!/usr/bin/python
def square(number):
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (number * number)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When we register scriptB.py, we use jython library to figure out the dependent modules scriptB relies on, in this case, scriptA. However, if current directory is in classpath, instead of scriptA.py, we get _&lt;em&gt;pyclasspath&lt;/em&gt;&lt;em&gt;/scriptA.class. Then we try to put __pyclasspath&lt;/em&gt;&lt;em&gt;/script$py.class into job.jar, Pig complains __pyclasspath&lt;/em&gt;_/script$py.class does not exist. &lt;/p&gt;

&lt;p&gt;This is exactly TestScriptUDF.testPythonNestedImport is doing. In hadoop 20.x, the test still success because MiniCluster will take local classpath so it can still find scriptA.py even if it is not in job.jar. However, the script will fail in real cluster and MiniMRYarnCluster of hadoop 23.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535551">PIG-2433</key>
            <summary>Jython import module not working if module path is in classpath</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Sat, 17 Dec 2011 02:16:28 +0000</created>
                <updated>Mon, 14 Oct 2013 17:46:18 +0100</updated>
                            <resolved>Wed, 9 Jan 2013 01:26:58 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13482531" author="rohini" created="Tue, 23 Oct 2012 19:15:31 +0100"  >&lt;p&gt;Fixed the issue and added unit tests to import os and re. &lt;/p&gt;

&lt;p&gt;Note: If jython-standalone.jar is in pig classpath, found that in real cluster had to add -Dmapred.child.env=&quot;JYTHONPATH=job.jar/Lib&quot; to pick up the builtin modules as the jar gets extracted on the datanode and Lib is not in classpath. Might apply to using with oozie too. Could not simulate the error in unit test environment even after removing jython jar from mr-apps-classpath. If the extracted Lib directory is in classpath instead of standalone jar while launching pig the env setting is not required. &lt;/p&gt;</comment>
                            <comment id="13483397" author="rohini" created="Wed, 24 Oct 2012 18:01:53 +0100"  >&lt;p&gt;Seeing some errors with import unicodedata. Will update the patch after fixing that case too. &lt;/p&gt;</comment>
                            <comment id="13483714" author="rohini" created="Thu, 25 Oct 2012 00:13:56 +0100"  >&lt;p&gt;Changing status to Patch Available again. Issue was something that cannot be fixed in code and can be worked around. &lt;/p&gt;

&lt;p&gt;For anyone interested in the issue and the solution. &lt;br/&gt;
The issue had to do with unicodedata.py loading UnicodeData.txt and EastAsianWidth.txt files inside its code. There is no way to determine them like imports and ship them with the jar. Also note that this happens when Lib directory is in classpath and not with standalone jython jar file. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
loader = pkgutil.get_loader(&apos;unicodedata&apos;)
init_unicodedata(StringIO.StringIO(loader.get_data(os.path.join(my_path,&apos;UnicodeData.txt&apos;))))
init_east_asian_width(StringIO.StringIO(loader.get_data(os.path.join(my_path,&apos;EastAsianWidth.txt&apos;))))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The workaround for that is to ship those two files with hadoop&apos;s tmpfiles or mapred.cache.files option and set -Dmapred.child.env=&quot;JYTHONPATH=.&quot;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;pig -Dmapred.child.env=&quot;JYTHONPATH=.&quot;
-Dtmpfiles=&quot;file:///homes/rohinip/jython/UnicodeData.txt,file:///homes/rohinip/jython/EastAsianWidth.txt&quot;
norm_test.pig
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On a different note, found that progress is not reported in case of jython functions. Is this a known issue? Could not find any jiras.&lt;/p&gt;</comment>
                            <comment id="13542538" author="rohini" created="Wed, 2 Jan 2013 23:19:29 +0000"  >&lt;p&gt;bump. Review anyone?&lt;/p&gt;</comment>
                            <comment id="13543730" author="cheolsoo" created="Fri, 4 Jan 2013 09:23:53 +0000"  >&lt;p&gt;Hi Rohini,&lt;/p&gt;

&lt;p&gt;After applying the patch to trunk, I see the following error in TestScriptUDF.testPythonNestedImportClassPath:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Testcase: testPythonNestedImportClassPath took 0.182 sec
    Caused an ERROR
Python Error. Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/cheolsoo/workspace/pig-svn/scriptB.py&quot;&lt;/span&gt;, line 2, in &amp;lt;module&amp;gt;
    &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scriptA
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;__pyclasspath__/scriptA.py&quot;&lt;/span&gt;, line 3, in &amp;lt;module&amp;gt;
NameError: name &apos;outputSchema&apos; is not defined
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Does this test pass for you? &lt;/p&gt;</comment>
                            <comment id="13544383" author="rohini" created="Sat, 5 Jan 2013 00:39:46 +0000"  >&lt;p&gt;ant clean test -Dtestcase=TestScriptUDF passes for me. &lt;/p&gt;</comment>
                            <comment id="13544484" author="rohini" created="Sat, 5 Jan 2013 00:43:20 +0000"  >&lt;p&gt;One cause for this error could be that your python cache dir is not writable and so the pig jar was not processed. Try running with -Dpython.cachedir=/&amp;lt;dir with write perms&amp;gt; if that is the case. Or are you running from eclipse?&lt;/p&gt;</comment>
                            <comment id="13545489" author="cheolsoo" created="Sun, 6 Jan 2013 20:58:10 +0000"  >&lt;p&gt;Hi Rohini,&lt;/p&gt;

&lt;p&gt;I tried what you suggested, but I still get the same error.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant clean test -Dtestcase=TestScriptUDF -Dpython.cachedir=/home/cheolsoo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I see that the test fails on Mac, CentOS 6, and Ubuntu 12. It&apos;s not clear what&apos;s the root cause. I am attaching my test log.&lt;/p&gt;</comment>
                            <comment id="13545583" author="rohini" created="Mon, 7 Jan 2013 02:15:59 +0000"  >&lt;p&gt;   Suspecting that the following code execution is failing for you based on the stack trace. But the attached log does not have any error and the comment also says it will fail silently. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// attempt addition of schema decorator handler, fail silently
&lt;/span&gt;                interpreter.exec(&lt;span class=&quot;code-quote&quot;&gt;&quot;def outputSchema(schema_def):\n&quot;&lt;/span&gt;
                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;    def decorator(func):\n&quot;&lt;/span&gt;
                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;        func.outputSchema = schema_def\n&quot;&lt;/span&gt;
                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; func\n&quot;&lt;/span&gt;
                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; decorator\n\n&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test ran fine for me in Mac and RHEL 5. I will see if I can try and reproduce. Can you add org.python.core.Options.verbose = Py.DEBUG; in the static block of JythonScriptEngine and see if that gives any other additional error messages for you? &lt;/p&gt;</comment>
                            <comment id="13546189" author="cheolsoo" created="Mon, 7 Jan 2013 19:37:49 +0000"  >&lt;p&gt;Hi Rohini,&lt;/p&gt;

&lt;p&gt;I found that the order in which test cases run matters. I am attaching two log files: good.log and bad.log. If I forced using OrderedJUnit4Runner that testPythonNestedImportClassPath runs before &lt;br/&gt;
testPythonBuiltinModuleImport1, they all pass. But if testPythonBuiltinModuleImport1 runs before testPythonNestedImportClassPath, testPythonNestedImportClassPath fails:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;good.log&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Testcase: testPythonNestedImportClassPath took 38.565 sec
Testcase: testPythonBuiltinModuleImport1 took 35.904 sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;good.log&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Testcase: testPythonBuiltinModuleImport1 took 38.756 sec
Testcase: testPythonNestedImportClassPath took 0.124 sec
    Caused an ERROR
Python Error. Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/cheolsoo/workspace/pig/scriptB.py&quot;&lt;/span&gt;, line 2, in &amp;lt;module&amp;gt;
    &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scriptA
   File &lt;span class=&quot;code-quote&quot;&gt;&quot;__pyclasspath__/scriptA.py&quot;&lt;/span&gt;, line 3, in &amp;lt;module&amp;gt;
NameError: name &apos;outputSchema&apos; is not defined
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13546192" author="cheolsoo" created="Mon, 7 Jan 2013 19:39:05 +0000"  >&lt;p&gt;I also turned on DEBUG as per your request, so you can see extra debug messages in the log files.&lt;/p&gt;</comment>
                            <comment id="13546264" author="rohini" created="Mon, 7 Jan 2013 21:06:27 +0000"  >&lt;p&gt;Thanks Cheolsoo. I think this has something to do with PythonInterpreter being static in JythonScriptEngine. And you must be running with jdk7 so the test order was different. I was running with jdk6 and that&apos;s why did not see it. Will investigate and fix it. &lt;/p&gt;</comment>
                            <comment id="13546473" author="rohini" created="Tue, 8 Jan 2013 01:05:52 +0000"  >&lt;p&gt;Used different names for different modules. Tests pass when run with jdk7 now.&lt;/p&gt;</comment>
                            <comment id="13547050" author="cheolsoo" created="Tue, 8 Jan 2013 17:51:54 +0000"  >&lt;p&gt;+1.&lt;/p&gt;

&lt;p&gt;Thanks for the fix. The test passes for me too. I also ran e2e test and found no failure.&lt;/p&gt;

&lt;p&gt;Minor comment:&lt;br/&gt;
When you commit the patch, can you remove a tab char in the following line?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    	&amp;lt;!-- Remove jython jar from mrapp-generated-classpath --&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13547512" author="rohini" created="Wed, 9 Jan 2013 01:26:58 +0000"  >&lt;p&gt;Thanks for the review Cheolsoo. Removed the tab before committing. Committed to trunk.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12496758">PIG-1824</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12529984">PIG-2347</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12563658" name="PIG-2433-1.patch" size="13162" author="rohini" created="Tue, 8 Jan 2013 01:05:52 +0000"/>
                            <attachment id="12550504" name="PIG-2433.patch" size="11723" author="rohini" created="Tue, 23 Oct 2012 19:15:31 +0100"/>
                            <attachment id="12563502" name="TEST-org.apache.pig.test.TestScriptUDF.txt" size="339268" author="cheolsoo" created="Sun, 6 Jan 2013 20:58:10 +0000"/>
                            <attachment id="12563609" name="bad.log" size="158449" author="cheolsoo" created="Mon, 7 Jan 2013 19:37:49 +0000"/>
                            <attachment id="12563610" name="good.log" size="206699" author="cheolsoo" created="Mon, 7 Jan 2013 19:37:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 23 Oct 2012 18:15:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>221235</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy4u5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62047</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>