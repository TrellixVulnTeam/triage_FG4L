<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:07:38 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3153/PIG-3153.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3153] TestScriptUDF.testJavascriptExampleScript fails in trunk</title>
                <link>https://issues.apache.org/jira/browse/PIG-3153</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;To reproduce the failure, do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant clean test -Dtestcase=TestScriptUDF
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The test fails with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.apache.pig.impl.logicalLayer.FrontendException: ERROR 0: Given UDF returns an improper Schema. Schema should only contain one field of a Tuple, Bag, or a single type. Returns: {word: chararray,num: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;}
    at org.apache.pig.newplan.logical.expression.UserFuncExpression.getFieldSchema(UserFuncExpression.java:206)
    at org.apache.pig.newplan.logical.optimizer.FieldSchemaResetter.execute(SchemaResetter.java:264)
    at org.apache.pig.newplan.logical.expression.AllSameExpressionVisitor.visit(AllSameExpressionVisitor.java:143)
    at org.apache.pig.newplan.logical.expression.UserFuncExpression.accept(UserFuncExpression.java:88)
    at org.apache.pig.newplan.ReverseDependencyOrderWalker.walk(ReverseDependencyOrderWalker.java:70)
    at org.apache.pig.newplan.PlanVisitor.visit(PlanVisitor.java:52)
    at org.apache.pig.newplan.logical.optimizer.SchemaResetter.visitAll(SchemaResetter.java:67)
    at org.apache.pig.newplan.logical.optimizer.SchemaResetter.visit(SchemaResetter.java:122)
    at org.apache.pig.newplan.logical.relational.LOGenerate.accept(LOGenerate.java:240)
    at org.apache.pig.newplan.DependencyOrderWalker.walk(DependencyOrderWalker.java:75)
    at org.apache.pig.newplan.logical.optimizer.SchemaResetter.visit(SchemaResetter.java:114)
    at org.apache.pig.newplan.logical.relational.LOForEach.accept(LOForEach.java:76)
    at org.apache.pig.newplan.DependencyOrderWalker.walk(DependencyOrderWalker.java:75)
    at org.apache.pig.newplan.PlanVisitor.visit(PlanVisitor.java:52)
    at org.apache.pig.parser.LogicalPlanBuilder.expandAndResetVisitor(LogicalPlanBuilder.java:402)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12630430">PIG-3153</key>
            <summary>TestScriptUDF.testJavascriptExampleScript fails in trunk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Feb 2013 19:54:35 +0000</created>
                <updated>Mon, 14 Oct 2013 17:46:20 +0100</updated>
                            <resolved>Tue, 26 Feb 2013 07:02:09 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.12.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13578713" author="dreambird" created="Thu, 14 Feb 2013 21:44:01 +0000"  >&lt;p&gt;I fix the javascript to define a schema of result, and update the test a little bit. With this patch, the test pass for me.&lt;/p&gt;</comment>
                            <comment id="13578717" author="dreambird" created="Thu, 14 Feb 2013 21:52:01 +0000"  >&lt;p&gt;a minor fix (using original $0 instead of $a0) on top of previous patch&lt;/p&gt;</comment>
                            <comment id="13581653" author="dreambird" created="Tue, 19 Feb 2013 21:39:59 +0000"  >&lt;p&gt;please note in javascript, I use the x:&lt;/p&gt;
{t:(word:chararray,num:long)}
&lt;p&gt; to define the return schema, which uses a bag to wrapper a tuple. This is the same as test testPythonAbsolutePath() did.&lt;/p&gt;

&lt;p&gt;I tried to define the schema as t:(word:chararray,num:long), but didn&apos;t successfully to load the data into it correctly in 8 line of the javascript. I think this might be the case to all javascript. will look further.&lt;/p&gt;
</comment>
                            <comment id="13585680" author="cheolsoo" created="Mon, 25 Feb 2013 07:22:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dreambird&quot; class=&quot;user-hover&quot; rel=&quot;dreambird&quot;&gt;Johnny Zhang&lt;/a&gt;, I looked into this and am attaching a patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3153&quot; title=&quot;TestScriptUDF.testJavascriptExampleScript fails in trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3153&quot;&gt;&lt;del&gt;PIG-3153&lt;/del&gt;&lt;/a&gt;-2.patch.txt) that allows outputSchema to be a tuple. Here is my reasoning:&lt;/p&gt;

&lt;p&gt;1. The reason why defining outputSchema as &quot;t:(word:chararray,num:long)&quot; causes a NPE is because the JavaScript object doesn&apos;t have a field called &quot;t&quot;. If you read &quot;JsFunction.jsToPigTuple()&quot;, it recursively searches for every field of outputSchema in the JavaScript object.&lt;/p&gt;

&lt;p&gt;IMO, the right way to fix this is to wrap the JavaScript object with another object and name that wrapper object as &quot;t&quot;. &lt;/p&gt;

&lt;p&gt;2. Regarding my change to JsFunction, I removed &quot;outputSchema.size() == 1&quot; in addition to adding &quot;outputSchema.getField(0).type == DataType.TUPLE&quot; to the if condition.&lt;/p&gt;

&lt;p&gt;The former is redundant because the size of outputSchema is always equal to 1 now due to &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3082&quot; title=&quot;outputSchema of a UDF allows two usages when describing a Tuple schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3082&quot;&gt;&lt;del&gt;PIG-3082&lt;/del&gt;&lt;/a&gt;. The latter is added to wrap the JavaScript object into another object as explained above.&lt;/p&gt;

&lt;p&gt;With this patch, the test code doesn&apos;t have to be modified at all. Please let me know what you think. Thanks!&lt;/p&gt;</comment>
                            <comment id="13586204" author="dreambird" created="Mon, 25 Feb 2013 19:47:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;, thanks a lot for review my patch. &lt;/p&gt;

&lt;p&gt;This is interesting. your change of JsFunction &quot;outputSchema.getField(0).type == DataType.TUPLE&quot; makes it possible to adding &quot;()&quot; to define the return schema as tuple type. I should looks more in the those code when I fix the test failure. +1 for your patch.&lt;/p&gt;</comment>
                            <comment id="13586230" author="cheolsoo" created="Mon, 25 Feb 2013 20:04:56 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Your change of JsFunction &quot;outputSchema.getField(0).type == DataType.TUPLE&quot; makes it possible to adding &quot;()&quot; to define the return schema as tuple type.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, that&apos;s not what I do. The point of that condition is to wrap a JS object with another object if the outputSchema is a tuple. By wrapping outputSchema with a tuple, we add an extra layer in Pig. So we should add the same to the JavaScript object.&lt;/p&gt;</comment>
                            <comment id="13586484" author="sms" created="Mon, 25 Feb 2013 23:56:57 +0000"  >&lt;p&gt;+1 for the patch.&lt;/p&gt;</comment>
                            <comment id="13586879" author="cheolsoo" created="Tue, 26 Feb 2013 07:02:09 +0000"  >&lt;p&gt;Committed to trunk. Thank you Santhosh for the review!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12630177">PIG-3150</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12622733">PIG-3082</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12570741" name="PIG-3153-2.patch.txt" size="1690" author="cheolsoo" created="Mon, 25 Feb 2013 07:25:35 +0000"/>
                            <attachment id="12569398" name="PIG-3153.patch.txt" size="2079" author="dreambird" created="Thu, 14 Feb 2013 21:52:01 +0000"/>
                            <attachment id="12569396" name="PIG-3153.patch.txt" size="2581" author="dreambird" created="Thu, 14 Feb 2013 21:44:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 14 Feb 2013 21:44:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>310924</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzbibr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311269</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>