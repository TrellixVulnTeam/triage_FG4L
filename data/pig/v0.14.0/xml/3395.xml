<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:48:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3395/PIG-3395.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3395] Large filter expression makes Pig hang</title>
                <link>https://issues.apache.org/jira/browse/PIG-3395</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Currently, partition filter push down is quite costly. For example, if you have many nested or/and expressions, Pig hangs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
base = load &apos;&amp;lt;partitioned table&amp;gt;&apos; using MyStorage();
filt = filter base by
(dateint == 20130719 and batchid == &apos;merged_1&apos; and hour IN (19,20,21,22,23))
or
(dateint == 20130720 and batchid == &apos;merged_1&apos; and hour IN (0,1,2,3,4,5,6,7,8))
or
(dateint == 20130720 and batchid == &apos;merged_2&apos; and hour == 7)
or
(dateint == 20130720 and batchid == &apos;merged_1&apos; and hour IN (9,10,11,12,13,14,15,16,17,18,19,20,21,22,23))
or
(dateint == 20130721 and batchid == &apos;merged_1&apos; and hour IN (0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23))
or
(dateint == 20130722 and batchid == &apos;merged_1&apos; and hour IN (0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16));
dump filt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that IN operator is converted to nested OR&apos;s by Pig parser.&lt;/p&gt;

&lt;p&gt;Looking at the thread dump, I found it creates almost 60 stack frames and makes JVM suffer. (I will attach full stack trace.)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;repeated ...&amp;gt;
at org.apache.pig.newplan.PColFilterExtractor.visit(PColFilterExtractor.java:504)
at org.apache.pig.newplan.PColFilterExtractor.visit(PColFilterExtractor.java:237)
at org.apache.pig.newplan.PColFilterExtractor.visit(PColFilterExtractor.java:504)
at org.apache.pig.newplan.PColFilterExtractor.visit(PColFilterExtractor.java:214)
at org.apache.pig.newplan.PColFilterExtractor.visit(PColFilterExtractor.java:504)
at org.apache.pig.newplan.PColFilterExtractor.visit(PColFilterExtractor.java:211)
at org.apache.pig.newplan.PColFilterExtractor.visit(PColFilterExtractor.java:108)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Although the filter expression can be simplified, it seems possible to make PColFilterExtractor more efficient.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12659856">PIG-3395</key>
            <summary>Large filter expression makes Pig hang</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Jul 2013 18:56:17 +0100</created>
                <updated>Mon, 14 Oct 2013 17:46:07 +0100</updated>
                            <resolved>Thu, 1 Aug 2013 23:20:58 +0100</resolved>
                                                    <fixVersion>0.12.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13719842" author="cheolsoo" created="Thu, 25 Jul 2013 18:59:54 +0100"  >&lt;p&gt;Attaching the tread dump. I will shortly upload a patch that refactors PColFilterExtractor that makes it work.&lt;/p&gt;</comment>
                            <comment id="13720058" author="cheolsoo" created="Thu, 25 Jul 2013 22:03:25 +0100"  >&lt;p&gt;I am attaching a patch that refactors the logic of detecting the pattern of &quot;(pcond and cond) or (pcond and cond)&quot; that was added by &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3173&quot; title=&quot;Partition filter push down does not happen partition keys condition include a AND and OR construct&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3173&quot;&gt;&lt;del&gt;PIG-3173&lt;/del&gt;&lt;/a&gt; into a separate function.&lt;/p&gt;

&lt;p&gt;I also added a unit test case that demonstrates the issue. If you run it without the fix, it infinitely hangs. With the fix, it runs within seconds.&lt;/p&gt;

&lt;p&gt;In terms of testing,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;ant test-commit passes.&lt;/li&gt;
	&lt;li&gt;ant test -Dtestcase=TestPartitionFilterPushDown passes.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13720607" author="cheolsoo" created="Fri, 26 Jul 2013 11:10:38 +0100"  >&lt;p&gt;All unit tests pass.&lt;/p&gt;</comment>
                            <comment id="13722889" author="rohini" created="Mon, 29 Jul 2013 20:42:32 +0100"  >&lt;p&gt;Additional cases that visit(ProjectExpression project) checks like userfunc, cast, null, bincond will not be done right? It might lead to script failing if they are present. &lt;/p&gt;</comment>
                            <comment id="13722900" author="cheolsoo" created="Mon, 29 Jul 2013 20:54:06 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, thank you for the comment. Please correct me if I am wrong, but I am not removing all the recursive calls from visit() but taking out one particular check (i.e. (pcond and cond) or (pcond and cond)). So I think it still checks other cases that you mentioned, no?&lt;/p&gt;</comment>
                            <comment id="13722907" author="rohini" created="Mon, 29 Jul 2013 21:05:18 +0100"  >&lt;p&gt;Before the whole and/or tree will not be pushed down. The visit of lhs and rhs is still there, but I am not sure how the replace will behave because it does not have full context and something partial might get pushed. Can you just modify your testcase to include one of those conditions to test the behaviour if we have cast or null check? &lt;/p&gt;</comment>
                            <comment id="13722920" author="cheolsoo" created="Mon, 29 Jul 2013 21:13:25 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, I can certainly add more test cases to verify that. Let me do it.&lt;/p&gt;</comment>
                            <comment id="13724076" author="cheolsoo" created="Tue, 30 Jul 2013 18:09:17 +0100"  >&lt;p&gt;I have been testing my patch as per Rohini&apos;s suggestion, and it works correctly. Here are what I tested:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(cast) or (pcond and pcond) or (pcond and pcond)&lt;/li&gt;
	&lt;li&gt;(pcond and pcond) or (cast) or (pcond and pcond)&lt;/li&gt;
	&lt;li&gt;(pcond and pcond) or (pcond and pcond) or (cast)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In all these cases, the entire filter is rejected due to the cast expression, which is the same as before.&lt;/p&gt;

&lt;p&gt;Adding test cases is a bit more involving because the test helper function isn&apos;t written for such conditions. But I will add a few test cases.&lt;/p&gt;</comment>
                            <comment id="13726033" author="cheolsoo" created="Thu, 1 Aug 2013 05:15:59 +0100"  >&lt;p&gt;Added new test cases to confirm that the filter doesn&apos;t get pushed down if udf/cast/null expressions are mixed with or/and expressions.&lt;/p&gt;

&lt;p&gt;ReviewBoard:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/13186/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/13186/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13726935" author="rohini" created="Thu, 1 Aug 2013 22:42:13 +0100"  >&lt;p&gt;+1. There are few white spaces. Can you just remove them before the commit?&lt;/p&gt;</comment>
                            <comment id="13726982" author="cheolsoo" created="Thu, 1 Aug 2013 23:20:58 +0100"  >&lt;p&gt;Thank you Rohini for the review! Committed it to trunk.&lt;/p&gt;

&lt;p&gt;I fixed all the white space problems in PColFilterExtractor.java (trailing white spaces and tabs), so it should be easy on the eyes now.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12631473">PIG-3173</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12595340" name="PIG-3395-2.patch" size="12029" author="cheolsoo" created="Thu, 1 Aug 2013 05:15:59 +0100"/>
                            <attachment id="12594268" name="PIG-3395.patch" size="8451" author="cheolsoo" created="Thu, 25 Jul 2013 22:03:25 +0100"/>
                            <attachment id="12594214" name="thread_dump.txt" size="9768" author="cheolsoo" created="Thu, 25 Jul 2013 18:59:54 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 29 Jul 2013 19:42:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340048</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzghrj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340366</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>