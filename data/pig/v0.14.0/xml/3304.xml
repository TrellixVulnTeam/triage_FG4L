<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:54:33 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3304/PIG-3304.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3304] XMLLoader in piggybank does not work with inline closed tags</title>
                <link>https://issues.apache.org/jira/browse/PIG-3304</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The XMLLoader fails to return elements when tags are closed inline such as&lt;br/&gt;
&amp;lt;event id=&quot;342&quot;/&amp;gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12645562">PIG-3304</key>
            <summary>XMLLoader in piggybank does not work with inline closed tags</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aseldawy">Ahmed Eldawy</assignee>
                                    <reporter username="aseldawy">Ahmed Eldawy</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Wed, 1 May 2013 01:20:16 +0100</created>
                <updated>Mon, 14 Oct 2013 17:46:51 +0100</updated>
                            <resolved>Thu, 2 May 2013 01:33:04 +0100</resolved>
                                    <version>0.11.1</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>piggybank</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13646209" author="aseldawy" created="Wed, 1 May 2013 01:24:52 +0100"  >&lt;p&gt;diff --git java/src/main/java/org/apache/pig/piggybank/storage/XMLLoader.java java/src/main/java/org/apache/pig/piggybank/storage/XMLLoader.java&lt;br/&gt;
index 589a545..9daa1a4 100644&lt;br/&gt;
&amp;#8212; java/src/main/java/org/apache/pig/piggybank/storage/XMLLoader.java&lt;br/&gt;
+++ java/src/main/java/org/apache/pig/piggybank/storage/XMLLoader.java&lt;br/&gt;
@@ -212,10 +212,16 @@ class XMLLoaderBufferedPositionedInputStream extends BufferedPositionedInputStre&lt;br/&gt;
       //startTag&lt;span class=&quot;error&quot;&gt;&amp;#91;tmp.length+1&amp;#93;&lt;/span&gt; = (byte)&apos;&amp;gt;&apos;;&lt;/p&gt;


&lt;p&gt;+      // Used to detect tags that are closed inline&lt;br/&gt;
+      byte[] inlineCloseTag = &lt;/p&gt;
{&apos;/&apos;, &apos;&amp;gt;&apos;}
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;       ByteArrayOutputStream collectBuf = new ByteArrayOutputStream(1024);&lt;br/&gt;
       int idxTagChar = 0;&lt;br/&gt;
       int idxStartTagChar = 0;&lt;br/&gt;
+      int idxInlineCloseTagChar = 0;&lt;br/&gt;
+      // A flag to indicate that we are currently inside the tag to be matched&lt;br/&gt;
+      // Initially set to true as skipToTag has been called earlier&lt;br/&gt;
+      boolean insideMatchTag = true;&lt;br/&gt;
       boolean startTagMatched = false;&lt;br/&gt;
       /*&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Read till an end tag is found.It need not check for any condition since it&lt;br/&gt;
@@ -247,10 +253,18 @@ class XMLLoaderBufferedPositionedInputStream extends BufferedPositionedInputStre&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;           if (b == startTag&lt;span class=&quot;error&quot;&gt;&amp;#91;idxStartTagChar&amp;#93;&lt;/span&gt;)&lt;/p&gt;
{
              ++idxStartTagChar;
-             if(idxStartTagChar == startTag.length)
-                startTagMatched = true ; // Set the flag as true if start tag matches
-          }
&lt;p&gt;else&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;idxStartTagChar = 0;&lt;br/&gt;
+             if(idxStartTagChar == startTag.length) 
{
+               startTagMatched = true ; // Set the flag as true if start tag matches
+               // We are currently inside the tag to be matched
+               insideMatchTag = true;               
+             }
&lt;p&gt;+          } else &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            idxStartTagChar = 0;+            if (idxStartTagChar &amp;gt; 1) {
+              // Matched only a part of the start tag of some element
+              insideMatchTag = false;
+            }+          }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;@@ -268,6 +282,23 @@ class XMLLoaderBufferedPositionedInputStream extends BufferedPositionedInputStre&lt;br/&gt;
           } else &lt;br/&gt;
             idxTagChar = 0; &lt;/p&gt;

&lt;p&gt;+          if (b == inlineCloseTag&lt;span class=&quot;error&quot;&gt;&amp;#91;idxInlineCloseTagChar&amp;#93;&lt;/span&gt;) {&lt;br/&gt;
+            idxInlineCloseTagChar++;&lt;br/&gt;
+            if (idxInlineCloseTagChar == inlineCloseTag.length) {&lt;br/&gt;
+              idxInlineCloseTagChar = 0;&lt;br/&gt;
+              if (insideMatchTag) {&lt;br/&gt;
+                if(nestedTags==0) // Break the loop if there were no nested tags&lt;br/&gt;
+                  break;&lt;br/&gt;
+               else&lt;/p&gt;
{
+                  --nestedTags; // Else decrement the count
+                  idxInlineCloseTagChar = 0; // Reset the index
+               }
&lt;p&gt;+              }&lt;br/&gt;
+            }&lt;br/&gt;
+          } else &lt;/p&gt;
{
+            idxInlineCloseTagChar = 0;
+          }
&lt;p&gt;+          &lt;br/&gt;
         }&lt;br/&gt;
         catch (IOException e) {&lt;br/&gt;
           this.setReadable(false);&lt;br/&gt;
@@ -339,7 +370,7 @@ class XMLLoaderBufferedPositionedInputStream extends BufferedPositionedInputStre&lt;br/&gt;
               break;&lt;br/&gt;
             case S_MATCH_PREFIX:&lt;br/&gt;
               // tag match iff next character is whitespaces or close tag mark&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (b == &apos; &apos; || b == &apos;\t&apos; || b == &apos;&amp;gt;&apos;) {&lt;br/&gt;
+              if (Character.isWhitespace(b) || b == &apos;/&apos; || b == &apos;&amp;gt;&apos;) 
{
                 matchBuf.write((byte)(b));
                 state = S_MATCH_TAG;
               }
&lt;p&gt; else &lt;/p&gt;
{
@@ -355,7 +386,7 @@ class XMLLoaderBufferedPositionedInputStream extends BufferedPositionedInputStre
             default:
               throw new IllegalArgumentException(&quot;Invalid state: &quot; + state);
           }&lt;/li&gt;
	&lt;li&gt;if (state == S_MATCH_TAG &amp;amp;&amp;amp; b == &apos;&amp;gt;&apos;) {&lt;br/&gt;
+          if (state == S_MATCH_TAG &amp;amp;&amp;amp; (b == &apos;&amp;gt;&apos; || Character.isWhitespace(b))) 
{
             break;
           }
&lt;p&gt;           if (state != S_MATCH_TAG &amp;amp;&amp;amp; this.getPosition() &amp;gt; limit) {&lt;br/&gt;
@@ -406,6 +437,12 @@ class XMLLoaderBufferedPositionedInputStream extends BufferedPositionedInputStre&lt;br/&gt;
     byte[] collectTag(String tagName, long limit) throws IOException {&lt;br/&gt;
        ByteArrayOutputStream collectBuf = new ByteArrayOutputStream(1024);&lt;br/&gt;
        byte[] beginTag = skipToTag(tagName, limit);&lt;br/&gt;
+       &lt;br/&gt;
+       // Check if the tag is closed inline&lt;br/&gt;
+       if (beginTag.length &amp;gt; 2 &amp;amp;&amp;amp; beginTag&lt;span class=&quot;error&quot;&gt;&amp;#91;beginTag.length - 2&amp;#93;&lt;/span&gt; == &apos;/&apos; &amp;amp;&amp;amp;&lt;br/&gt;
+           beginTag&lt;span class=&quot;error&quot;&gt;&amp;#91;beginTag.length-1&amp;#93;&lt;/span&gt; == &apos;&amp;gt;&apos;) &lt;/p&gt;
{
+         return beginTag;
+       }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;        // No need to search for the end tag if the start tag is not found&lt;br/&gt;
        if(beginTag.length &amp;gt; 0 ){ &lt;br/&gt;
diff --git java/src/test/java/org/apache/pig/piggybank/test/storage/TestXMLLoader.java java/src/test/java/org/apache/pig/piggybank/test/storage/TestXMLLoader.java&lt;br/&gt;
index 4adc9cd..f83f0d9 100644&lt;br/&gt;
&amp;#8212; java/src/test/java/org/apache/pig/piggybank/test/storage/TestXMLLoader.java&lt;br/&gt;
+++ java/src/test/java/org/apache/pig/piggybank/test/storage/TestXMLLoader.java&lt;br/&gt;
@@ -75,6 +75,15 @@ public class TestXMLLoader extends TestCase {&lt;br/&gt;
      nestedTags.add(new String[] &lt;/p&gt;
{ &quot;&amp;lt;/events&amp;gt;&quot;});&lt;br/&gt;
   }&lt;br/&gt;
   &lt;br/&gt;
+  public static ArrayList&amp;lt;String[]&amp;gt; inlineClosedTags = new ArrayList&amp;lt;String[]&amp;gt;();&lt;br/&gt;
+  static {&lt;br/&gt;
+    inlineClosedTags.add(new String[] { &quot;&amp;lt;events&amp;gt;&quot;});&lt;br/&gt;
+    inlineClosedTags.add(new String[] { &quot;&amp;lt;event id=&apos;3423&apos;/&amp;gt;&quot;});&lt;br/&gt;
+    inlineClosedTags.add(new String[] { &quot;&amp;lt;event/&amp;gt;&quot;});&lt;br/&gt;
+    inlineClosedTags.add(new String[] { &quot;&amp;lt;event&amp;gt;&amp;lt;event/&amp;gt;&amp;lt;/event&amp;gt;&quot;});&lt;br/&gt;
+    inlineClosedTags.add(new String[] { &quot;&amp;lt;/events&amp;gt;&quot;}
&lt;p&gt;);&lt;br/&gt;
+  }&lt;br/&gt;
+  &lt;br/&gt;
   public void testShouldReturn0TupleCountIfSearchTagIsNotFound () throws Exception&lt;br/&gt;
   {&lt;br/&gt;
     String filename = TestHelper.createTempFile(data, &quot;&quot;);&lt;br/&gt;
@@ -333,5 +342,26 @@ public class TestXMLLoader extends TestCase &lt;/p&gt;
{
       assertEquals(3, tupleCount);  
    }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
+   public void testXMLLoaderShouldWorkWithInlineClosedTags() throws Exception {&lt;br/&gt;
+     String filename = TestHelper.createTempFile(inlineClosedTags, &quot;&quot;);&lt;br/&gt;
+     PigServer pig = new PigServer(LOCAL);&lt;br/&gt;
+     filename = filename.replace(&quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot;, &quot;\\\\&quot;);&lt;br/&gt;
+     patternString = patternString.replace(&quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot;, &quot;\\\\&quot;);&lt;br/&gt;
+     String query = &quot;A = LOAD &apos;file:&quot; + filename + &quot;&apos; USING org.apache.pig.piggybank.storage.XMLLoader(&apos;event&apos;) as (doc:chararray);&quot;;&lt;br/&gt;
+     pig.registerQuery(query);&lt;br/&gt;
+     Iterator&amp;lt;?&amp;gt; it = pig.openIterator(&quot;A&quot;);&lt;br/&gt;
+     int tupleCount = 0;&lt;br/&gt;
+     while (it.hasNext()) {&lt;br/&gt;
+       Tuple tuple = (Tuple) it.next();&lt;br/&gt;
+       if (tuple == null)&lt;br/&gt;
+         break;&lt;br/&gt;
+       else &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+         if (tuple.size() &amp;gt; 0) {
+             tupleCount++;
+         }+       }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+     }&lt;br/&gt;
+     assertEquals(3, tupleCount);  &lt;br/&gt;
+   }&lt;br/&gt;
 }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13646210" author="aseldawy" created="Wed, 1 May 2013 01:25:16 +0100"  >&lt;p&gt;A patch that solves the bug&lt;/p&gt;</comment>
                            <comment id="13646251" author="aseldawy" created="Wed, 1 May 2013 01:55:42 +0100"  >&lt;p&gt;Found a bug with nested entities that are closed inline&lt;/p&gt;</comment>
                            <comment id="13646298" author="aseldawy" created="Wed, 1 May 2013 02:59:05 +0100"  >&lt;p&gt;An updated path that handles nested elements with inline close tag&lt;/p&gt;</comment>
                            <comment id="13647133" author="daijy" created="Thu, 2 May 2013 01:33:04 +0100"  >&lt;p&gt;Piggybank tests pass. Patch commmitted to trunk. Thanks Ahmed!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12581290" name="xmlloader_inline_close_tag.patch" size="6405" author="aseldawy" created="Wed, 1 May 2013 01:25:16 +0100"/>
                            <attachment id="12581321" name="xmlloader_inline_close_tag_1.patch" size="9503" author="aseldawy" created="Wed, 1 May 2013 02:59:05 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 2 May 2013 00:33:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325923</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hze2v3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326268</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>xml</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>