<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:48:51 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1285/PIG-1285.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1285] Allow SingleTupleBag to be serialized</title>
                <link>https://issues.apache.org/jira/browse/PIG-1285</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Currently, Pig uses a SingleTupleBag for efficiency when a full-blown spillable bag implementation is not needed in the Combiner optimization.&lt;/p&gt;

&lt;p&gt;Unfortunately this can create problems. The below Initial.exec() code fails at run-time with the message that a SingleTupleBag cannot be serialized:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Tuple exec(Tuple in) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
      &lt;span class=&quot;code-comment&quot;&gt;// single record. just copy.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (in == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;   
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
         Tuple resTuple = tupleFactory_.newTuple(in.size());
         &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt; in.size(); i++) {
           resTuple.set(i, in.get(i));
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; resTuple;
       } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
         log.warn(e);
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      }
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The code below can fix the problem in the UDF, but it seems like something that should be handled transparently, not requiring UDF authors to know about SingleTupleBags.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Tuple exec(Tuple in) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
      &lt;span class=&quot;code-comment&quot;&gt;// single record. just copy.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (in == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;   
      
      /*
       * Unfortunately SingleTupleBags are not serializable. We cache whether a given index contains a bag
       * in the map below, and copy all bags into DefaultBags before returning to avoid serialization exceptions.
       */
      Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt; isBagAtIndex = Maps.newHashMap();
      
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        Tuple resTuple = tupleFactory_.newTuple(in.size());

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt; in.size(); i++) {
          &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj = in.get(i);
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isBagAtIndex.containsKey(i)) {
            isBagAtIndex.put(i, obj &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SingleTupleBag);
          }
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isBagAtIndex.get(i)) {
            DataBag newBag = bagFactory_.newDefaultBag();
            newBag.addAll((DataBag)obj);
            obj = newBag;
          }
          resTuple.set(i, obj);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; resTuple;
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        log.warn(e);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12458498">PIG-1285</key>
            <summary>Allow SingleTupleBag to be serialized</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dvryaboy">Dmitriy V. Ryaboy</assignee>
                                    <reporter username="dvryaboy">Dmitriy V. Ryaboy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Mar 2010 04:20:46 +0000</created>
                <updated>Fri, 14 May 2010 07:47:21 +0100</updated>
                            <resolved>Sun, 21 Mar 2010 19:23:13 +0000</resolved>
                                                    <fixVersion>0.7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12843527" author="hadoopqa" created="Wed, 10 Mar 2010 11:11:29 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12438254/PIG-1285.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12438254/PIG-1285.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 921185.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/231/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/231/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/231/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/231/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/231/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/231/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12845458" author="pkamath" created="Mon, 15 Mar 2010 19:00:46 +0000"  >&lt;p&gt;Couple of comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I think instead of the code below the implementation of write should be inlined into SingleTupleBag.write() (I guess DefaultDataBag.write() and SingleTupleBag.write() could call a common method to implement write()).
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        DataBag bag = bagFactory.newDefaultBag();
+        bag.addAll(this);
+        bag.write(out)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The reason is that bagFactory.newDefaultBag() registers the bag with the SpillableMemoryManager which inturn puts a weak reference to the bag on a Linked list - in the past we have seen this list grow in size and cause memory issue and was one of the main motivations for creating SingleTupleBag.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;There is an implementation for write() but not read() - reading through the code I guess this is because during deserialization SingleTupleBag.read() will not be called but DefaultDataBag.read() would be called. I am wondering if leaving the SingleTupleBag.read() as-is is confusing since it throws an exception with the message - &quot;SingleTupleBag should never be serialized or deserialized.&quot;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12845521" author="dvryaboy" created="Mon, 15 Mar 2010 20:54:53 +0000"  >&lt;p&gt;Thanks for the feedback.&lt;/p&gt;

&lt;p&gt;Looking at the code, writeFields() and readFields() are actually implemented in DefaultAbstractBag, and have no dependencies on the memory manager. Is there a good reason to not allow deserialization of SingleTupleBags?  Seems to me that we can simply change SingleTupleBag to extend DefaultAbstractBag and get rid of writeFields and readFields methods, allowing the defaults to take care of (de)serialization. Everything else would remain as-is, since currently SingleTupleBag implements the complete interface and therefore will override anything memory-related DefaultAbstractBag does.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="12845606" author="pkamath" created="Mon, 15 Mar 2010 23:58:00 +0000"  >&lt;p&gt;SingleTupleBag did not go the route of extending DefaultAbstractBag for a couple of reasons&lt;br/&gt;
1) The object would have few more members (like mMemSize* fields, mSize etc which are present in DefaultAbstractBag) - this would make the object bigger in memory and SingleTupleBag was designed to be used in map/combine phase with minimal memory overhead&lt;br/&gt;
2) The first point in my previous comment - we don&apos;t want this bag to register with SpillableMemoryManger which in turn puts a weak reference to the bag on a Linked list - in the past we have seen this list grow in size and itself cause memory issues&lt;/p&gt;</comment>
                            <comment id="12847481" author="olgan" created="Fri, 19 Mar 2010 18:04:58 +0000"  >&lt;p&gt;Dmitry, are you still planning to get this in before Monday or should we move it to Pig 0.8.0?&lt;/p&gt;</comment>
                            <comment id="12847507" author="dvryaboy" created="Fri, 19 Mar 2010 18:41:39 +0000"  >&lt;p&gt;Yeah I&apos;ll post it over the weekend.&lt;/p&gt;

&lt;p&gt;Just to make sure &amp;#8211; Pradeep, you would be ok then if I just copied the writeFields and readFields out of DefaultAbstractBag into SingleTupleBag?&lt;/p&gt;</comment>
                            <comment id="12847721" author="pkamath" created="Sat, 20 Mar 2010 06:15:50 +0000"  >&lt;p&gt;yes&lt;/p&gt;</comment>
                            <comment id="12847951" author="hadoopqa" created="Sun, 21 Mar 2010 17:43:33 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12439393/PIG-1285.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12439393/PIG-1285.2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 925513.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/260/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/260/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/260/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/260/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/260/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/260/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12847966" author="dvryaboy" created="Sun, 21 Mar 2010 19:23:13 +0000"  >&lt;p&gt;Patch committed. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12439393" name="PIG-1285.2.patch" size="3724" author="dvryaboy" created="Sun, 21 Mar 2010 03:35:36 +0000"/>
                            <attachment id="12438254" name="PIG-1285.patch" size="3051" author="dvryaboy" created="Tue, 9 Mar 2010 05:12:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 10 Mar 2010 11:11:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyaop3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96312</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>