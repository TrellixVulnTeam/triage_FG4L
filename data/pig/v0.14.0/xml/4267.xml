<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:07:53 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-4267/PIG-4267.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-4267] ToDate has incorrect timezone offsets</title>
                <link>https://issues.apache.org/jira/browse/PIG-4267</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;If you set the timezone to &apos;America/New_York&apos;&lt;br/&gt;
Pig will return &quot;2012-03-30 -05:00&quot; for ToDate(1333166400000) instead of the correct &quot;2012-03-31 -04:00&quot;&lt;/p&gt;</description>
                <environment>&lt;p&gt;java version 1.7.0_72&lt;/p&gt;</environment>
        <key id="12752765">PIG-4267</key>
            <summary>ToDate has incorrect timezone offsets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bridiver">Brian Johnson</assignee>
                                    <reporter username="bridiver">Brian Johnson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Nov 2014 16:55:55 +0000</created>
                <updated>Fri, 21 Nov 2014 05:58:27 +0000</updated>
                            <resolved>Sun, 9 Nov 2014 20:02:15 +0000</resolved>
                                    <version>0.12.0</version>
                    <version>0.13.1</version>
                                    <fixVersion>0.14.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14196359" author="bridiver" created="Tue, 4 Nov 2014 17:02:51 +0000"  >&lt;p&gt;ran the jre timezone update tool to get the latest data and it still returns an impossible date/offset combination&lt;/p&gt;</comment>
                            <comment id="14196387" author="bridiver" created="Tue, 4 Nov 2014 17:23:17 +0000"  >&lt;p&gt;it appears that pig is using the current offset rather than the offset for the time it&apos;s actually parsing&lt;/p&gt;


&lt;p&gt;    private static final DateTimeFormatter isoDateTimeFormatter = ISODateTimeFormat&lt;br/&gt;
            .dateOptionalTimeParser().withOffsetParsed();&lt;/p&gt;

</comment>
                            <comment id="14196403" author="bridiver" created="Tue, 4 Nov 2014 17:31:13 +0000"  >&lt;p&gt;It appears that basically all of Pig&apos;s timezone support is broken in the same way. Offsets are calculated based on current time/zone, not the time you are using&lt;/p&gt;</comment>
                            <comment id="14196550" author="bridiver" created="Tue, 4 Nov 2014 18:35:28 +0000"  >&lt;p&gt;Ok, I believe this is the source of the problem. The offset is set explicitly rather than using the zone itself.&lt;/p&gt;

&lt;p&gt;        String dtzStr = conf.get(&quot;pig.datetime.default.tz&quot;);&lt;br/&gt;
        if (dtzStr != null &amp;amp;&amp;amp; dtzStr.length() &amp;gt; 0) &lt;/p&gt;
{
            // ensure that the internal timezone is uniformly in UTC offset style
            DateTimeZone.setDefault(DateTimeZone.forOffsetMillis(DateTimeZone.forID(dtzStr).getOffset(null)));
        }</comment>
                            <comment id="14196573" author="bridiver" created="Tue, 4 Nov 2014 18:43:01 +0000"  >&lt;p&gt;I guess a test for this would have to check to see if it&apos;s current DST or not and set the test date based on that to put it in standard if it is or vice versa&lt;/p&gt;</comment>
                            <comment id="14196654" author="bridiver" created="Tue, 4 Nov 2014 19:28:47 +0000"  >&lt;p&gt;I submitted a patch but there is not test because there is no reliable way to run it. There is always an edge case if you run the test during the change over between daylight and standard time where it will break because the but is related to the current time.&lt;/p&gt;</comment>
                            <comment id="14196751" author="daijy" created="Tue, 4 Nov 2014 20:23:27 +0000"  >&lt;p&gt;Did you set &quot;pig.datetime.default.tz&quot; explicitly? If it is not set, dtzStr==null and &quot;DateTimeZone.setDefault&quot; will not kick in.&lt;/p&gt;</comment>
                            <comment id="14196787" author="bridiver" created="Tue, 4 Nov 2014 20:51:00 +0000"  >&lt;p&gt;Yes, I did and I tested the patch and it fixes the problem. It&apos;s obvious just from looking at the code that it will always use the offset from the current time/timezone combo rather than the time you are actually using in the script.&lt;/p&gt;</comment>
                            <comment id="14197353" author="rohini" created="Wed, 5 Nov 2014 02:00:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;It appears that pig is using the current offset rather than the offset for the time it&apos;s actually parsing&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;   Patch sounds good. Could you add testcases for EST,EDT and for the two dates in the year when the switch happens for daylight savings? For a given date and time, the offset (whether it is EST or EDT) should not change right?&lt;/p&gt;</comment>
                            <comment id="14197362" author="rohini" created="Wed, 5 Nov 2014 02:04:29 +0000"  >&lt;p&gt;  Timezones and dates are always tricky. Asking the original author of the code as to what was the intent of the original code to ensure we are not breaking something.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjshen&quot; class=&quot;user-hover&quot; rel=&quot;zjshen&quot;&gt;Zhijie Shen&lt;/a&gt;,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// ensure that the internal timezone is uniformly in UTC offset style
&lt;/span&gt;DateTimeZone.setDefault(DateTimeZone.forOffsetMillis(DateTimeZone.forID(dtzStr).getOffset(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can you tell us why this was done and and the impact of removing this? &lt;/p&gt;</comment>
                            <comment id="14197381" author="bridiver" created="Wed, 5 Nov 2014 02:18:22 +0000"  >&lt;p&gt;I can tell you the only impact I saw and we have a lot of timezone dependent code: the &quot;z&quot; parameter in the date format will not always return the offset. If you pass in an offset for the timezone it will return an offset, but if you pass in something like America/New_York it will return EDT. That&apos;s not a pig issue, that&apos;s a joda issue and I think it&apos;s way more important to actually handle dates correctly than be backwards compatible with a format output.&lt;/p&gt;

&lt;p&gt;As far as test cases go, I can&apos;t. The issue is that it depends on whether it&apos;s EDT or EST when you run the test. I could pick a date based on whether it was currently EDT or EST, but those dates have changed before and could change again which would break the test. There&apos;s also always an edge case if you run the test during the switch over.&lt;/p&gt;</comment>
                            <comment id="14197382" author="bridiver" created="Wed, 5 Nov 2014 02:20:14 +0000"  >&lt;p&gt;The issue is that for a given date, whether it is EST or EDT will change depending on what the current date is.&lt;/p&gt;</comment>
                            <comment id="14197391" author="bridiver" created="Wed, 5 Nov 2014 02:31:36 +0000"  >&lt;p&gt;I&apos;m going to try to add a little better explanation for posterity. With the current code when pig runs it reads in the timezone and calculates the offset which it then uses as the default timezone. The problem is that now it&apos;s going to use that same offset regardless of the date. So if it&apos;s currently EDT (computer clock time) and you instantiate a DateTime with a date that would normally be EST, it will have the EDT time offset instead of the EST time offset. &lt;/p&gt;</comment>
                            <comment id="14197426" author="rohini" created="Wed, 5 Nov 2014 03:08:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;As far as test cases go, I can&apos;t. The issue is that it depends on whether it&apos;s EDT or EST when you run the test.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;   If code behaves based on whether it is EDT or EST now then I believe it is wrong. It should look at the time in question and give the correct time zone offset for that time. &lt;a href=&quot;https://issues.apache.org/jira/browse/OOZIE-1573&quot; title=&quot;coord:tzOffset() gives incorrect offset for daylight saving timezones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OOZIE-1573&quot;&gt;&lt;del&gt;OOZIE-1573&lt;/del&gt;&lt;/a&gt; is a similar issue.  Given a UTC time/java millis, it should always return the offset on that time.&lt;/p&gt;

&lt;p&gt;For Eg:&lt;br/&gt;
  Given &lt;a href=&quot;http://www.timeanddate.com/time/change/usa/new-york&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.timeanddate.com/time/change/usa/new-york&lt;/a&gt;  &lt;/p&gt;

&lt;p&gt;Sunday, March 9, 2014, 2:00:00 AM clocks were turned forward 1 hour to &lt;br/&gt;
Sunday, March 9, 2014, 3:00:00 AM local daylight time instead&lt;/p&gt;

&lt;p&gt;Sunday, November 2, 2014, 2:00:00 AM clocks were turned backward 1 hour to &lt;br/&gt;
Sunday, November 2, 2014, 1:00:00 AM local standard time instead&lt;/p&gt;

&lt;p&gt;I would expect the following outputs irrespective of whether it is EDT or EST at the time of running it.&lt;br/&gt;
GMT -&amp;gt; America NewYork&lt;br/&gt;
March 9, 2014 5:00:00 AM -&amp;gt; March 9, 2014 00:00:00 AM EST	UTC-5 hours&lt;br/&gt;
March 9, 2014 6:00:00 AM -&amp;gt; March 9, 2014 01:00:00 AM EST	UTC-5 hours&lt;br/&gt;
March 9, 2014 7:00:00 AM -&amp;gt; March 9, 2014 03:00:00 AM EDT	UTC-4 hours&lt;br/&gt;
Nov   2, 2014 4:00:00 AM -&amp;gt; Nov   2, 2014 00:00:00 AM EDT	UTC-4 hours&lt;br/&gt;
Nov   2, 2014 5:00:00 AM -&amp;gt; Nov   2, 2014 01:00:00 AM EDT	UTC-4 hours&lt;br/&gt;
Nov   2, 2014 6:00:00 AM -&amp;gt; Nov   2, 2014 01:00:00 AM EST	UTC-5 hours&lt;br/&gt;
Nov   2, 2014 7:00:00 AM -&amp;gt; Nov   2, 2014 02:00:00 AM EDT	UTC-5 hours&lt;/p&gt;

&lt;p&gt;Used GMT instead of java time in millis (since 1970) in above example for easy reading. Used &lt;a href=&quot;http://www.timeanddate.com/worldclock/converted.html?iso=20141102T05&amp;amp;p1=136&amp;amp;p2=179&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.timeanddate.com/worldclock/converted.html?iso=20141102T05&amp;amp;p1=136&amp;amp;p2=179&lt;/a&gt; for getting the above values.&lt;/p&gt;</comment>
                            <comment id="14197623" author="bridiver" created="Wed, 5 Nov 2014 04:59:45 +0000"  >&lt;p&gt;Yea, I guess I was focused on DST start/stop dates changing, but for a given date in the past it&apos;s fixed. So if the test has one date in EST and one in EDT, regardless of when you run the test it will cover the case that fails now. I&apos;ll write it tomorrow.&lt;/p&gt;</comment>
                            <comment id="14198418" author="bridiver" created="Wed, 5 Nov 2014 14:25:20 +0000"  >&lt;p&gt;added test&lt;/p&gt;</comment>
                            <comment id="14198419" author="bridiver" created="Wed, 5 Nov 2014 14:26:16 +0000"  >&lt;p&gt;added a test to the patch. On another note, it seems silly that this code exists in 3 different places. I wonder if there&apos;s a good way to dry it up?&lt;/p&gt;</comment>
                            <comment id="14199877" author="daijy" created="Thu, 6 Nov 2014 06:22:13 +0000"  >&lt;p&gt;There are bunch of tests still using old style: TestOrderBy, TestConversions, TestStore, TestBuiltin and TestDefaultDateTimeZone.testTimeZone. You can do a grep for &quot;DateTimeZone.setDefault&quot;, or go to &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1314&quot; title=&quot;Add DateTime Support to Pig&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1314&quot;&gt;&lt;del&gt;PIG-1314&lt;/del&gt;&lt;/a&gt; which introduce this code to find them.&lt;/p&gt;</comment>
                            <comment id="14200184" author="bridiver" created="Thu, 6 Nov 2014 14:05:31 +0000"  >&lt;p&gt;But those aren&apos;t really relevant to the bug and all of them are setting UTC or a fixed offset so it&apos;s perfectly fine to use the offset as the default.&lt;/p&gt;</comment>
                            <comment id="14200480" author="bridiver" created="Thu, 6 Nov 2014 17:13:22 +0000"  >&lt;p&gt;Really all of this code needs to be refactored. It should never have been so tightly coupled to joda in the first place. There should be a wrapper method for setting the default time zone that can be used internally and for the tests. I&apos;m happy to make that change if you have a good suggestion for where that method should go. There are a lot of other issues I see as well looking through this code. For instance: CustomFormatToISO sets the default timezone to UTC. I haven&apos;t tried it, but I&apos;m guessing that using that function will obliterate your existing timezone settings since it never captures and returns to the existing timezone. There could also be some multithreading issues there even if it did return to it??&lt;/p&gt;</comment>
                            <comment id="14201003" author="bridiver" created="Thu, 6 Nov 2014 21:50:03 +0000"  >&lt;p&gt;I&apos;m going to fix the existing ISO functions that don&apos;t properly return to the original timezone and then call this one done. If we want to do any more refactoring it&apos;s probably better to open another ticket.&lt;/p&gt;</comment>
                            <comment id="14202170" author="bridiver" created="Fri, 7 Nov 2014 15:46:46 +0000"  >&lt;p&gt;ISOHelper has some more serious issues because the tests are at odds with the docs. For instance, it says that it should parse with the default timezone if one is set, but the test checks for UTC instead of the default timezone. Should I fix the test or keep the existing behavior?&lt;/p&gt;</comment>
                            <comment id="14202213" author="bridiver" created="Fri, 7 Nov 2014 16:24:05 +0000"  >&lt;p&gt;for that matter, why are all these piggybank ISO functions converting everything to UTC in the first place? It seems like what happened is that timezone support was added and that broke existing tests that all used UTC. The fix led to incorrect behavior by always using UTC as the default instead of the configured default timezone.&lt;/p&gt;</comment>
                            <comment id="14202552" author="bridiver" created="Fri, 7 Nov 2014 19:55:04 +0000"  >&lt;p&gt;fixes handling of timezones in piggybank date functions&lt;/p&gt;</comment>
                            <comment id="14202642" author="bridiver" created="Fri, 7 Nov 2014 20:49:07 +0000"  >&lt;p&gt;missing import&lt;/p&gt;</comment>
                            <comment id="14203643" author="daijy" created="Sat, 8 Nov 2014 22:28:00 +0000"  >&lt;p&gt;This bring a major change in DateTime internal representation. After patch, we use local time instead of UTC. This change looks good since the old approach does not deal with DTS and in most use cases people deal with local time. I also made several changes:&lt;br/&gt;
1. We shall also remove all occurrence of &lt;br/&gt;
&quot;DateTimeZone.setDefault(DateTimeZone.forOffsetMillis(DateTimeZone.UTC.getOffset(null)))&quot; in tests. Those apparently try to mimic the Pig behavior in tests, and those tests are not testing the right scenario now. Some tests fail because we use local time internally in DateTime now. I made changes to fix them&lt;br/&gt;
2. Change ConstantCalculator to set the TimeZone&lt;br/&gt;
3. Rebase with trunk.&lt;/p&gt;

&lt;p&gt;I will run tests and if all pass, I will commit the change.&lt;/p&gt;</comment>
                            <comment id="14204090" author="daijy" created="Sun, 9 Nov 2014 20:02:15 +0000"  >&lt;p&gt;Patch committed to both trunk and 0.14 branch. Thanks Brian!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12680434" name="PIG-4267-5.patch" size="37669" author="daijy" created="Sat, 8 Nov 2014 22:28:00 +0000"/>
                            <attachment id="12680259" name="patch" size="36475" author="bridiver" created="Fri, 7 Nov 2014 20:49:07 +0000"/>
                            <attachment id="12680245" name="patch" size="35666" author="bridiver" created="Fri, 7 Nov 2014 19:55:04 +0000"/>
                            <attachment id="12679534" name="patch" size="5973" author="bridiver" created="Wed, 5 Nov 2014 14:25:20 +0000"/>
                            <attachment id="12679287" name="patch" size="3720" author="bridiver" created="Tue, 4 Nov 2014 19:27:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 4 Nov 2014 20:23:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzvtif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>