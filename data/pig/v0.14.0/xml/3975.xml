<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:08:17 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3975/PIG-3975.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3975] Multiple Scalar reference calls leading to missing records</title>
                <link>https://issues.apache.org/jira/browse/PIG-3975</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;We noticed that multiple pig runs with same input were producing different outputs.&lt;/p&gt;

&lt;p&gt;Simplified script looked like this.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;A = load &apos;input1&apos; as (a1:int);
B = group A by a1 parallel 200;
C = load &apos;input2&apos; as (c1:int);
D = foreach C generate B.$0;
store D into &apos;/tmp/deletemeD&apos;;
E = load &apos;input3&apos; as (c1:int);
F = foreach E generate B.$0;
store F into &apos;/tmp/deletemeF&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12717656">PIG-3975</key>
            <summary>Multiple Scalar reference calls leading to missing records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 May 2014 22:29:01 +0100</created>
                <updated>Mon, 7 Jul 2014 19:08:06 +0100</updated>
                            <resolved>Fri, 20 Jun 2014 22:57:48 +0100</resolved>
                                    <version>0.8.1</version>
                    <version>0.9.2</version>
                    <version>0.10.1</version>
                    <version>0.11.1</version>
                    <version>0.12.2</version>
                                    <fixVersion>0.13.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="14014254" author="knoguchi" created="Fri, 30 May 2014 22:42:17 +0100"  >&lt;p&gt;With the script from the description, job DAG looked like below.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Job DAG:
job_1399356417814_189120        -&amp;gt;      job_1399356417814_189121,job_1399356417814_189122,
job_1399356417814_189121        -&amp;gt;      job_1399356417814_189123,
job_1399356417814_189123
job_1399356417814_189122
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the plan, I see that even though job_1399356417814_189122 and job_1399356417814_189123 read from output of job_1399356417814_189121, somehow job_1399356417814_189122 is missing that dependency.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;==============================================================
job_1399356417814_189120 
pig.inputs ================
hdfs:/aaa.bbb.ccc:8020/user/knoguchi/input1:org.apache.pig.builtin.PigStorage
pig.mapPlan=================
B: Local Rearrange[tuple]{int}(false) - scope-8
|   |
|   Project[int][0] - scope-9
|
|---A: New For Each(false)[bag] - scope-5
    |   |
    |   Cast[int] - scope-3
    |   |
    |   |---Project[bytearray][0] - scope-2
pig.reducePlan=================
Empty Plan!
pig.reduce.stores=================
[(Name: B: Store(hdfs://aaa.bbb.ccc:8020/tmp/temp-912971374/tmp-113052755:org.apache.pig.impl.io.TFileStorage) - scope-10

==============================================================
job_1399356417814_189121
pig.inputs ================
hdfs://aaa.bbb.ccc:8020/tmp/temp-912971374/tmp-113052755:org.apache.pig.impl.io.TFileStorage
pig.mapPlan=================
Empty Plan!
pig.map.stores=================
[(Name: Store(hdfs://aaa.bbb.ccc:8020/tmp/temp-912971374/tmp-690789368:org.apache.pig.impl.io.InterStorage) - scope-25 Operator Key: scope-25)]
pig.reducePlan=================
null
pig.reduce.stores=================
[]
==============================================================
job_1399356417814_189122
pig.inputs ================
hdfs://aaa.bbb.ccc:8020/user/knoguchi/input3:org.apache.pig.builtin.PigStorage
pig.mapPlan=================
F: New For Each(false)[bag] - scope-20
|   |
|   POUserFunc(org.apache.pig.impl.builtin.ReadScalars)[int] - scope-19
|   |
|   |---Constant(0) - scope-17
|   |
|   |---Constant(hdfs://aaa.bbb.ccc:8020/tmp/temp-912971374/tmp-690789368) - scope-18
pig.map.stores=================
[(Name: F: Store(/tmp/deletemeF:org.apache.pig.builtin.PigStorage) - scope-21 Operator Key: scope-21)]
pig.reducePlan=================
null
pig.reduce.stores=================
[]
==============================================================
job_1399356417814_189123
pig.inputs ================
hdfs://aaa.bbb.ccc:8020/user/knoguchi/input2.txt:org.apache.pig.builtin.PigStorage
pig.mapPlan=================
D: New For Each(false)[bag] - scope-14
|   |
|   POUserFunc(org.apache.pig.impl.builtin.ReadScalars)[int] - scope-13
|   |
|   |---Constant(0) - scope-11
|   |
|   |---Constant(hdfs://aaa.bbb.ccc:8020/tmp/temp-912971374/tmp-690789368) - scope-12
pig.map.stores=================
[(Name: D: Store(/tmp/deletemeD:org.apache.pig.builtin.PigStorage) - scope-15 Operator Key: scope-15)]
pig.reducePlan=================
null
pig.reduce.stores=================
[]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="14014264" author="knoguchi" created="Fri, 30 May 2014 22:52:20 +0100"  >&lt;p&gt;Due to the missing dependency, job_1399356417814_189122 may have some tasks receive empty  scalar value since file is not created yet.&lt;/p&gt;

&lt;p&gt;This issue became more observable after &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2629&quot; title=&quot;Wrong Usage of Scalar which is null causes high namenode operation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2629&quot;&gt;&lt;del&gt;PIG-2629&lt;/del&gt;&lt;/a&gt; where we added caching instead of retrying when previous value was null.  (Instead of missing scalar value for &lt;b&gt;some&lt;/b&gt; records, now scalar value is empty for the entire task.)&lt;/p&gt;
</comment>
                            <comment id="14014341" author="knoguchi" created="Sat, 31 May 2014 00:07:56 +0100"  >&lt;p&gt;Attaching a preliminary patch.&lt;br/&gt;
I believe what&apos;s happening is, &lt;br/&gt;
MRCompiler.connectSoftLink() from &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1605&quot; title=&quot;Adding soft link to plan to solve input file dependency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1605&quot;&gt;&lt;del&gt;PIG-1605&lt;/del&gt;&lt;/a&gt;  connects MRPlan based on PhysicalPlan&apos;s softlink.  But this is being called BEFORE MRCompiler.aggregateScalarsFiles() from &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1458&quot; title=&quot;aggregate files for replicated join&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1458&quot;&gt;&lt;del&gt;PIG-1458&lt;/del&gt;&lt;/a&gt; that creates an extra concatenate mapreduce job.&lt;/p&gt;

&lt;p&gt;As a result, only the first scalar reference is getting the MRPlan dependency updated and rest are untouched.&lt;/p&gt;

&lt;p&gt;I think there are two approaches for fixing this.&lt;br/&gt;
(1) Updating MRPlan dependency INSIDE MRCompiler.aggregateScalarsFiles().&lt;br/&gt;
OR&lt;br/&gt;
(2) Moving MRCompiler.connectSoftLink() to AFTER MRCompiler.aggregateScalarsFiles().&lt;/p&gt;

&lt;p&gt;I took the second approach since it has an added benefit of MRCompiler.hasTooManyInputFiles() no longer depending on the job with scalar outputs.  I&apos;m hoping this would also reduce the number of unnecessary concatenate jobs being created.&lt;/p&gt;</comment>
                            <comment id="14029857" author="knoguchi" created="Thu, 12 Jun 2014 22:30:07 +0100"  >&lt;p&gt;Attaching a patch with added testcases.&lt;br/&gt;
One for the missing dependency and another for unnecessary concat job creation.  I&apos;ll run through the unit and e2e shortly.&lt;/p&gt;</comment>
                            <comment id="14029883" author="knoguchi" created="Thu, 12 Jun 2014 22:47:40 +0100"  >&lt;p&gt;ReviewBoard: &lt;a href=&quot;https://reviews.apache.org/r/22535/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/22535/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14031491" author="daijy" created="Sat, 14 Jun 2014 07:58:21 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;Koji Noguchi&lt;/a&gt; Patch looks good to me. However this patch apply on 0.13 branch but not trunk, can you upload a patch for trunk?&lt;/p&gt;</comment>
                            <comment id="14031754" author="rohini" created="Sun, 15 Jun 2014 02:59:14 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;,&lt;br/&gt;
   We should put this into 0.13 as well. It is a very bad bug giving incorrect results.&lt;/p&gt;</comment>
                            <comment id="14031759" author="daijy" created="Sun, 15 Jun 2014 03:26:53 +0100"  >&lt;p&gt;That&apos;s fine for me. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aniket486&quot; class=&quot;user-hover&quot; rel=&quot;aniket486&quot;&gt;Aniket Mokashi&lt;/a&gt;, is it possible to get it to 0.13.0?&lt;/p&gt;</comment>
                            <comment id="14032546" author="knoguchi" created="Mon, 16 Jun 2014 16:23:07 +0100"  >&lt;blockquote&gt;&lt;p&gt;Koji Noguchi Patch looks good to me. However this patch apply on 0.13 branch but not trunk, can you upload a patch for trunk?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;!  I wasn&apos;t aware that my local branch was that behind...&lt;br/&gt;
Tested with trunk.  I see that &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3970&quot; title=&quot;Merge Tez branch into trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3970&quot;&gt;&lt;del&gt;PIG-3970&lt;/del&gt;&lt;/a&gt; made some space-only changes that caused my patch to break.  Instead of creating an identical patch with some space changes, can you apply the patch with &apos;patch -p0 --ignore-whitespace&apos; on trunk ?&lt;/p&gt;</comment>
                            <comment id="14032833" author="aniket486" created="Mon, 16 Jun 2014 20:39:15 +0100"  >&lt;p&gt;We are redoing the RC for pig 0.13 so we should be able to apply this patch before we make another release. Please feel free to commit on the pig 13 branch.&lt;/p&gt;</comment>
                            <comment id="14032965" author="daijy" created="Mon, 16 Jun 2014 22:23:30 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;Koji Noguchi&lt;/a&gt;, no problem. I see Rohini post another review comment. Once that resolved, I can commit the patch.&lt;/p&gt;</comment>
                            <comment id="14034550" author="rohini" created="Tue, 17 Jun 2014 23:59:20 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;Koji Noguchi&lt;/a&gt;,&lt;br/&gt;
   I ran the full unit test suite applying the patch and also adding  comp.aggregateScalarsFiles(); to Util.buildMRPlan. They passed. So can you just add that before check in?&lt;/p&gt;</comment>
                            <comment id="14034655" author="rohini" created="Wed, 18 Jun 2014 01:35:23 +0100"  >&lt;p&gt;Committed pig-3975-v03.patch which has the above suggested change to branch-0.13.  Saw one of the new tests fails in trunk after rebasing and applying the patch. Investigating that. &lt;/p&gt;</comment>
                            <comment id="14038124" author="rohini" created="Fri, 20 Jun 2014 00:54:13 +0100"  >&lt;p&gt;Just got back to this issue. seen.add(newSpec); is required after new FindStoreNameVisitor(pl, newSpec, oldSpec).visit();. Investigating why this issue did not manifest in 0.13 when it should have. Will wrap this one shortly. &lt;/p&gt;
</comment>
                            <comment id="14039310" author="rohini" created="Fri, 20 Jun 2014 21:29:18 +0100"  >&lt;p&gt;Problem was ScalarVisitor.java change of &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3757&quot; title=&quot;Make scalar work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3757&quot;&gt;&lt;del&gt;PIG-3757&lt;/del&gt;&lt;/a&gt; is not in branch 0.13. Without that scalar referenced by testSoftLinkDependencyWithMultipleScalarReferences() by F points to B: POPackage instead of B:POStore and gets skipped because it is not an instance of POStore. So it worked fine there. Will make it consistent with trunk patch by adding that to branch-0.13 with pig-3975-v03-additional-fix.patch. Also uploaded patch for trunk which includes &quot;seen.add(newSpec);&quot; change. Can someone review?&lt;/p&gt;</comment>
                            <comment id="14039348" author="knoguchi" created="Fri, 20 Jun 2014 21:55:39 +0100"  >&lt;p&gt;Had a loong chat with Rohini on learning what is happening.  This is my patch but Rohini knew much more on what actually is happening.  (as always)&lt;/p&gt;

&lt;p&gt;So as I understand,  my testcase in the patch caught another bug introduced after &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3757&quot; title=&quot;Make scalar work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3757&quot;&gt;&lt;del&gt;PIG-3757&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
On trunk, with my testcase but without my patch, testcase fails at &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit.framework.AssertionFailedError: Unexpected number of mapreduce job. Missing concat job? expected:&amp;lt;4&amp;gt; but was:&amp;lt;5&amp;gt;
  at org.apache.pig.test.TestFRJoin2.testSoftLinkDependencyWithMultipleScalarReferences(TestFRJoin2.java:125)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is even before my check on the missing dependency.  It&apos;s failing due to each scalar &lt;b&gt;reference&lt;/b&gt; creating a new concat jobs.  By having extra &quot; seen.add(newSpec);&quot;, it can avoid the repetitive concat creation attempt.&lt;/p&gt;

&lt;p&gt;+1 on both the patches. &lt;/p&gt;

</comment>
                            <comment id="14039404" author="daijy" created="Fri, 20 Jun 2014 22:40:06 +0100"  >&lt;p&gt;+1 for pig-3975-v03-additional-fix.patch.&lt;/p&gt;</comment>
                            <comment id="14039431" author="rohini" created="Fri, 20 Jun 2014 22:57:48 +0100"  >&lt;p&gt;Committed the additional patch to 0.13 and full patch to trunk. Thanks Koji for figuring out and fixing this tough issue. Thanks Daniel for the review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12647714" name="pig-3975-v01_withouttest.patch" size="5111" author="knoguchi" created="Sat, 31 May 2014 00:07:56 +0100"/>
                            <attachment id="12650148" name="pig-3975-v02_withtests.patch" size="10364" author="knoguchi" created="Thu, 12 Jun 2014 22:30:07 +0100"/>
                            <attachment id="12651719" name="pig-3975-v03-additional-fix.patch" size="1616" author="rohini" created="Fri, 20 Jun 2014 21:29:18 +0100"/>
                            <attachment id="12651720" name="pig-3975-v03-trunk.patch" size="10115" author="rohini" created="Fri, 20 Jun 2014 21:29:18 +0100"/>
                            <attachment id="12650931" name="pig-3975-v03.patch" size="10154" author="rohini" created="Wed, 18 Jun 2014 01:35:23 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 14 Jun 2014 06:58:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395860</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzq0c7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395977</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>