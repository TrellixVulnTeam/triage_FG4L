<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:10:39 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3507/PIG-3507.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3507] Pig fails to run in local mode on a Kerberos enabled Hadoop cluster</title>
                <link>https://issues.apache.org/jira/browse/PIG-3507</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;It fails to run pig in local mode on a Kerberos enabled Hadoop cluster&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Command&lt;/b&gt;&lt;br/&gt;
pig -x local &amp;lt;pig script&amp;gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Pig script&lt;/b&gt;&lt;br/&gt;
A = load &apos;/etc/passwd&apos;;&lt;br/&gt;
dump A;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Root cause&lt;/b&gt;&lt;br/&gt;
When running pig in local mode, jobConf in HExecutionEngine is initiated with core-default.xml (hadoop.security.authentication = simple), mapred-default.xml, and yarn-default.xml. However, the settings are not passed to UserGroupInformation. That&apos;s why obtainTokensForNamenodesInternal() is called from obtainTokensForNamenodes(), and causes the exception to happen.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public static void obtainTokensForNamenodes(Credentials credentials, Path[] ps, Configuration conf) throws IOException {
    if (!UserGroupInformation.isSecurityEnabled()) {
        return;
    }
    obtainTokensForNamenodesInternal(credentials, ps, conf);
}	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Error&lt;/b&gt;&lt;br/&gt;
Pig Stack Trace&lt;br/&gt;
---------------&lt;br/&gt;
ERROR 6000: Output Location Validation Failed for: &apos;file:/tmp/temp-308998488/tmp-2025176494 More info to follow:&lt;br/&gt;
Can&apos;t get JT Kerberos principal for use as renewer&lt;/p&gt;

&lt;p&gt;org.apache.pig.impl.logicalLayer.FrontendException: ERROR 1066: Unable to open iterator for alias A&lt;br/&gt;
	at org.apache.pig.PigServer.openIterator(PigServer.java:841)&lt;br/&gt;
	at org.apache.pig.tools.grunt.GruntParser.processDump(GruntParser.java:696)&lt;br/&gt;
	at org.apache.pig.tools.pigscript.parser.PigScriptParser.parse(PigScriptParser.java:320)&lt;br/&gt;
	at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:194)&lt;br/&gt;
	at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:170)&lt;br/&gt;
	at org.apache.pig.tools.grunt.Grunt.exec(Grunt.java:84)&lt;br/&gt;
	at org.apache.pig.Main.run(Main.java:604)&lt;br/&gt;
	at org.apache.pig.Main.main(Main.java:157)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.hadoop.util.RunJar.main(RunJar.java:208)&lt;br/&gt;
Caused by: org.apache.pig.PigException: ERROR 1002: Unable to store alias A&lt;br/&gt;
	at org.apache.pig.PigServer.storeEx(PigServer.java:940)&lt;br/&gt;
	at org.apache.pig.PigServer.store(PigServer.java:903)&lt;br/&gt;
	at org.apache.pig.PigServer.openIterator(PigServer.java:816)&lt;br/&gt;
	... 12 more&lt;br/&gt;
Caused by: org.apache.pig.impl.plan.VisitorException: ERROR 6000: Output Location Validation Failed for: &apos;file:/tmp/temp-308998488/tmp-2025176494 More info to follow:&lt;br/&gt;
Can&apos;t get JT Kerberos principal for use as renewer&lt;br/&gt;
	at org.apache.pig.newplan.logical.rules.InputOutputFileValidator$InputOutputFileVisitor.visit(InputOutputFileValidator.java:95)&lt;br/&gt;
	at org.apache.pig.newplan.logical.relational.LOStore.accept(LOStore.java:66)&lt;br/&gt;
	at org.apache.pig.newplan.DepthFirstWalker.depthFirst(DepthFirstWalker.java:64)&lt;br/&gt;
	at org.apache.pig.newplan.DepthFirstWalker.depthFirst(DepthFirstWalker.java:66)&lt;br/&gt;
	at org.apache.pig.newplan.DepthFirstWalker.walk(DepthFirstWalker.java:53)&lt;br/&gt;
	at org.apache.pig.newplan.PlanVisitor.visit(PlanVisitor.java:52)&lt;br/&gt;
	at org.apache.pig.newplan.logical.rules.InputOutputFileValidator.validate(InputOutputFileValidator.java:45)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.HExecutionEngine.compile(HExecutionEngine.java:288)&lt;br/&gt;
	at org.apache.pig.PigServer.compilePp(PigServer.java:1327)&lt;br/&gt;
	at org.apache.pig.PigServer.executeCompiledLogicalPlan(PigServer.java:1252)&lt;br/&gt;
	at org.apache.pig.PigServer.storeEx(PigServer.java:936)&lt;br/&gt;
	... 14 more&lt;br/&gt;
Caused by: java.io.IOException: Can&apos;t get JT Kerberos principal for use as renewer&lt;br/&gt;
	at org.apache.hadoop.mapreduce.security.TokenCache.obtainTokensForNamenodesInternal(TokenCache.java:129)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.security.TokenCache.obtainTokensForNamenodesInternal(TokenCache.java:111)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.security.TokenCache.obtainTokensForNamenodes(TokenCache.java:85)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.lib.output.FileOutputFormat.checkOutputSpecs(FileOutputFormat.java:127)&lt;br/&gt;
	at org.apache.pig.newplan.logical.rules.InputOutputFileValidator$InputOutputFileVisitor.visit(InputOutputFileValidator.java:80)&lt;br/&gt;
	... 24 more&lt;br/&gt;
================================================================================&lt;/p&gt;</description>
                <environment></environment>
        <key id="12672740">PIG-3507</key>
            <summary>Pig fails to run in local mode on a Kerberos enabled Hadoop cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kellyzly">liyunzhang_intel</assignee>
                                    <reporter username="chiyang">chiyang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Oct 2013 03:53:22 +0100</created>
                <updated>Fri, 21 Nov 2014 05:58:51 +0000</updated>
                            <resolved>Thu, 18 Sep 2014 15:43:21 +0100</resolved>
                                    <version>0.10.0</version>
                    <version>0.11</version>
                                    <fixVersion>0.14.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13812722" author="takeshi.miao" created="Mon, 4 Nov 2013 09:58:45 +0000"  >&lt;p&gt;This patch works for our env with kerberos enabled cluster as well. I think it is valuable if someone suffer the same issue, can anyone help to review this patch ?&lt;/p&gt;</comment>
                            <comment id="13818377" author="cheolsoo" created="Sun, 10 Nov 2013 06:47:09 +0000"  >&lt;p&gt;Sorry for the late review.&lt;/p&gt;

&lt;p&gt;Since I don&apos;t have kerberos set up, I can&apos;t really reproduce the issue. But the patch itself looks reasonable to me. If I don&apos;t hear any objections, I will commit the patch on Monday. Please chime in if anyone has concerns.&lt;/p&gt;</comment>
                            <comment id="13819732" author="cheolsoo" created="Tue, 12 Nov 2013 01:59:57 +0000"  >&lt;p&gt;Committed to trunk. Thank you Chiyang!&lt;/p&gt;</comment>
                            <comment id="13820395" author="rohini" created="Tue, 12 Nov 2013 20:04:51 +0000"  >&lt;p&gt;This patch needs to be reverted if we are still supporting hadoop 0.23 as it will break compatibility. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/hadoop/common/branches/branch-0.20/src/core/org/apache/hadoop/security/UserGroupInformation.java?view=markup&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/hadoop/common/branches/branch-0.20/src/core/org/apache/hadoop/security/UserGroupInformation.java?view=markup&lt;/a&gt; does not have setConfiguration method. &lt;/p&gt;

&lt;p&gt;Also I don&apos;t think the fix is correct. The problem that is happening is their core-site.xml contains hadoop.security.authentication = kerberos and that is getting picked up as it is loaded as a default resource in UserGroupInformation&apos;s configuration. We should fix the bin/pig script to not load HADOOP_CONF_DIR in local mode. &lt;/p&gt;</comment>
                            <comment id="13820406" author="cheolsoo" created="Tue, 12 Nov 2013 20:17:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, my bad. Feel free to revert it.&lt;/p&gt;</comment>
                            <comment id="13820410" author="rohini" created="Tue, 12 Nov 2013 20:22:56 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;. Reverting for now and reopening this jira till we find the actual root cause and decide on the appropriate fix. I am suspecting that the culprit in their case is that core-site.xml is being picked up in UserGroupInformation and that causes problem.&lt;/p&gt;</comment>
                            <comment id="14113672" author="kellyzly" created="Thu, 28 Aug 2014 12:23:55 +0100"  >&lt;p&gt;The problem that pig can not work in local mode with kerberos, only exists in hadoop2.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;As the root cause of the bug description said:
When running pig in local mode, jobConf in HExecutionEngine is initiated with core-default.xml (hadoop.security.authentication = simple), mapred-default.xml, and yarn-default.xml. However, the settings are not passed to UserGroupInformation. That&apos;s why obtainTokensForNamenodesInternal() is called from obtainTokensForNamenodes(), and causes the exception
to happen. 
 org.apache.hadoop.mapreduce.security.TokenCache#obtainTokensForNamenodes
 public static void obtainTokensForNamenodes(Credentials credentials, Path[] ps, Configuration conf) throws IOException {
    if (!UserGroupInformation.isSecurityEnabled()) {
        return;
    }
    obtainTokensForNamenodesInternal(credentials, ps, conf);
}	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in hadoop1.2.1:&lt;br/&gt;
In function &quot;obtainTokensForNamenodesInternal&quot;,if path is in local mode, the fsName will be null. In this case, checks about whether the kerberos credentials exist or not will not be executed.&lt;br/&gt;
&lt;tt&gt;org.apache.hadoop.mapreduce.security.TokenCache#obtainTokensForNamenodesInternal&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void obtainTokensForNamenodesInternal(Credentials credentials,
                                               Path [] ps, 
                                               Configuration conf
                                               ) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-comment&quot;&gt;// get jobtracker principal id (&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the renewer)
&lt;/span&gt;    KerberosName jtKrbName = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KerberosName(conf.get(JobTracker.JT_USER_NAME, &quot;&quot;));
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; delegTokenRenewer = jtKrbName.getShortName();
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; readFile = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(Path p: ps) {
      FileSystem fs = FileSystem.get(p.toUri(), conf);
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fsName = fs.getCanonicalServiceName();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fsName == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { 
        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (TokenCache.getDelegationToken(credentials, fsName) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;//TODO: Need to come up with a better place to put
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; block of code to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; with reading the file
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (readFile) {
          readFile = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; binaryTokenFilename =
            conf.get(MAPREDUCE_JOB_CREDENTIALS_BINARY);
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (binaryTokenFilename != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            Credentials binary;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
              binary = Credentials.readTokenStorageFile(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:&lt;span class=&quot;code-comment&quot;&gt;///&quot;&lt;/span&gt; +  
&lt;/span&gt;                  binaryTokenFilename), conf);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
              &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(e);
            }
            credentials.addAll(binary);
          }
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (TokenCache.getDelegationToken(credentials, fsName) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;DT &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; + fsName  + &lt;span class=&quot;code-quote&quot;&gt;&quot; is already present&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
          }
        }
        Token&amp;lt;?&amp;gt; token = fs.getDelegationToken(delegTokenRenewer);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (token != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          Text fsNameText = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Text(fsName);
          credentials.addToken(fsNameText, token);
          LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got dt &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; + p + &lt;span class=&quot;code-quote&quot;&gt;&quot;;uri=&quot;&lt;/span&gt;+ fsName + 
                   &lt;span class=&quot;code-quote&quot;&gt;&quot;;t.service=&quot;&lt;/span&gt;+token.getService());
        }
      }
    }
  }
  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;  in hadoop2.3:&lt;br/&gt;
 In function &quot;obtainTokensForNamenodesInternal&quot;, whether the path is in local mode or not, obtainTokensForNamenodesInternal always is executed. At that time, kerberos check fails in local mode.&lt;br/&gt;
&lt;tt&gt;org.apache.hadoop.mapreduce.security.TokenCache#obtainTokensForNamenodesInternal&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void obtainTokensForNamenodesInternal(Credentials credentials,
      Path[] ps, Configuration conf) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    Set&amp;lt;FileSystem&amp;gt; fsSet = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;FileSystem&amp;gt;();
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(Path p: ps) {
      fsSet.add(p.getFileSystem(conf)); 
    }
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (FileSystem fs : fsSet) {
      obtainTokensForNamenodesInternal(fs, credentials, conf);
    }
  }
  
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void obtainTokensForNamenodesInternal(FileSystem fs, 
      Credentials credentials, Configuration conf) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; delegTokenRenewer = Master.getMasterPrincipal(conf);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (delegTokenRenewer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || delegTokenRenewer.length() == 0) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(
          &lt;span class=&quot;code-quote&quot;&gt;&quot;Can&apos;t get Master Kerberos principal &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; use as renewer&quot;&lt;/span&gt;);
    }
    mergeBinaryTokens(credentials, conf);

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Token&amp;lt;?&amp;gt; tokens[] = fs.addDelegationTokens(delegTokenRenewer,
                                                     credentials);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tokens != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Token&amp;lt;?&amp;gt; token : tokens) {
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got dt &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; + fs.getUri() + &lt;span class=&quot;code-quote&quot;&gt;&quot;; &quot;&lt;/span&gt;+token);
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;  said:&lt;blockquote&gt;&lt;p&gt;  We should fix the bin/pig script to not load HADOOP_CONF_DIR in local mode.&lt;/p&gt;&lt;/blockquote&gt; What patch did is not load the configurations in  HADOOP_CONF_DIR in local mode.&lt;/p&gt;</comment>
                            <comment id="14135438" author="xuefuz" created="Tue, 16 Sep 2014 14:43:12 +0100"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;, I&apos;m wondering if you have any additional thoughts on patch _1? Could we move this forward? Thanks.&lt;/p&gt;</comment>
                            <comment id="14136760" author="rohini" created="Wed, 17 Sep 2014 05:28:34 +0100"  >&lt;p&gt; Does not sound right to me. UserGroupInformation.java uses new Configuration(true) to initialize configuration.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value = conf.get(HADOOP_SECURITY_AUTHENTICATION);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || &lt;span class=&quot;code-quote&quot;&gt;&quot;simple&quot;&lt;/span&gt;.equals(value)) {
      useKerberos = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So unless there is some other configuration setting it to kerberos you should not be seeing the issue. Can you find out where it is being set to kerberos? Most likely it is being picked up from *-site.xml.&lt;/p&gt;</comment>
                            <comment id="14136898" author="kellyzly" created="Wed, 17 Sep 2014 08:39:44 +0100"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;&lt;br/&gt;
Thanks for your comment.  Keberos security is widely used in hadoop. This bug was also found by other endusers(see &lt;a href=&quot;http://www.ghostar.org/2014/05/pig-local-mode-fails-kerberos-auth-enabled/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.ghostar.org/2014/05/pig-local-mode-fails-kerberos-auth-enabled/&lt;/a&gt;)&lt;br/&gt;
detail steps to reproduce the bug:&lt;br/&gt;
1. build kerbreos env&lt;br/&gt;
2. build hadoop1 env&lt;br/&gt;
    which hadoop&lt;br/&gt;
    /home/zly/prj/oss/hadoop-1.2.1/bin/hadoop&lt;/p&gt;

&lt;p&gt;    grep -C2 kerberos  /home/zly/prj/oss/hadoop-1.2.1/conf/core-site.xml&lt;br/&gt;
    &amp;lt;name&amp;gt;hadoop.security.authentication&amp;lt;/name&amp;gt;&lt;br/&gt;
    &amp;lt;value&amp;gt;kerberos&amp;lt;/value&amp;gt;&lt;br/&gt;
  &amp;lt;/property&amp;gt;&lt;/p&gt;

&lt;p&gt;3. build pig and run in local mode&lt;br/&gt;
   cd $PIG_HOME/bin&lt;br/&gt;
   ./pig -x local id.pig&lt;br/&gt;
   ps -ef|grep pig&lt;br/&gt;
root     12126 10072  0 14:42 pts/4    00:00:01 /usr/java/jdk1.7.0_51//bin/java -Dproc_jar -Xmx1000m -Xmx1000m -Dpig.log.dir=/home/zly/prj/oss/pig/logs -Dpig.log.file=pig.log -Dpig.home.dir=/home/zly/prj/oss/pig -Xmx1000m -Dpig.log.dir=/home/zly/prj/oss/pig/logs -Dpig.log.file=pig.log -Dpig.home.dir=/home/zly/prj/oss/pig -Dhadoop.log.dir=/home/zly/prj/oss/hadoop-1.2.1/libexec/../logs -Dhadoop.log.file=hadoop.log -Dhadoop.home.dir=/home/zly/prj/oss/hadoop-1.2.1/libexec/.. -Dhadoop.id.str= -Dhadoop.root.logger=INFO,console -Dhadoop.security.logger=INFO,NullAppender -Djava.library.path=/home/zly/prj/oss/hadoop-1.2.1/libexec/../lib/native/Linux-amd64-64 -Dhadoop.policy.file=hadoop-policy.xml -Xrunjdwp:transport=dt_socket,server=y,address=9999 -classpath /home/zly/prj/oss/hadoop-1.2.1/conf:/home/zly/prj/oss/pig/conf:/usr/java/jdk1.7.0_51/lib/tools.jar:/home/zly/prj/oss/pig/build/ivy/lib/Pig/*:/home/zly/prj/oss/hadoop-1.2.1/conf:/home/zly/prj/oss/hadoop-1.2.1/conf:/home/zly/prj/oss/pig/lib/ST4-4.0.4.jar:/home/zly/prj/oss/pig/lib/accumulo-core-1.5.0.jar:......&lt;br/&gt;
&lt;b&gt;/home/zly/prj/oss/hadoop-1.2.1/conf:/home/zly/prj/oss/hadoop-1.2.1/conf is in the classpath&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Why UserGroupInformation set &quot;hadoop.security.authentication&quot; as &quot;kerberos&quot;&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   UserGroupInformation#ensureInitialized
 &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void ensureInitialized() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isInitialized) {
      initialize(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration());
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
UserGroupInformation#initialize
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void initialize(Configuration conf) {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value = conf.get(HADOOP_SECURITY_AUTHENTICATION);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || &lt;span class=&quot;code-quote&quot;&gt;&quot;simple&quot;&lt;/span&gt;.equals(value)) {
      useKerberos = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;kerberos&quot;&lt;/span&gt;.equals(value)) {
      useKerberos = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid attribute value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; +
                                         HADOOP_SECURITY_AUTHENTICATION + 
                                         &lt;span class=&quot;code-quote&quot;&gt;&quot; of &quot;&lt;/span&gt; + value);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;   The value of conf.get(HADOOP_SECURITY_AUTHENTICATION)  decides &quot;simple&quot;  or &quot;kerberos&quot;.  &lt;/p&gt;

&lt;p&gt;  Referred &lt;a href=&quot;https://hadoop.apache.org/docs/r1.2.1/api/org/apache/hadoop/conf/Configuration.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hadoop.apache.org/docs/r1.2.1/api/org/apache/hadoop/conf/Configuration.html&lt;/a&gt;&lt;br/&gt;
   Configurations are specified by resources. A resource contains a set of name/value pairs as XML data. Each resource is named by either a String or by a Path. If named by a String, then the classpath is examined for a file with that name. If named by a Path, then the local filesystem is examined directly, without referring to the classpath.&lt;br/&gt;
Unless explicitly turned off, Hadoop by default specifies two resources, loaded in-order from the classpath:&lt;br/&gt;
core-default.xml : Read-only defaults for hadoop.&lt;br/&gt;
core-site.xml: Site-specific configuration for a given hadoop installation.&lt;br/&gt;
&lt;b&gt;core-default.xml in the jar and core-site.xml in the $HADOOP_HOME/conf/  are loaded.&lt;/b&gt; So the value of &quot;hadoop.security.authentication&quot; is &quot;kerberos&quot;.&lt;/p&gt;


&lt;p&gt;If you don&apos;t build hadoop env and only deploy kerberos.&lt;br/&gt;
1. build kerberos env&lt;br/&gt;
2. build pig and run in local mode:&lt;br/&gt;
    cd $PIG_HOME/bin; ./pig -x local id.pig&lt;br/&gt;
    Error messages are found:&lt;br/&gt;
    exec /usr/java/jdk1.7.0_51/bin/java -Xmx1000m -Dpig.log.dir=/home/zly/prj/oss/pig/bin/../logs -Dpig.log.file=pig.log -Dpig.home.dir=/home/zly/prj/oss/pig/bin/.. -Xrunjdwp:transport=dt_socket,server=y,address=9999 -classpath /home/zly/prj/oss/pig/bin/../conf:/usr/java/jdk1.7.0_51/lib/tools.jar:/home/zly/prj/oss/pig/bin/../lib/ST4-4.0.4.jar:/home/zly/prj/oss/pig/bin/../lib/accumulo-core-1.5.0.jar:/home/zly/prj/oss/pig/bin/../lib/accumulo-fate-1.5.0.jar:/home/zly/prj/oss/pig/bin/../lib/accumulo-server-1.5.0.jar:/home/zly/prj/oss/pig/bin/../lib/accumulo-start-1.5.0.jar:/home/zly/prj/oss/pig/bin/../lib/accumulo-trace-1.5.0.jar:/home/zly/prj/oss/pig/bin/../lib/antlr-runtime-3.4.jar:/home/zly/prj/oss/pig/bin/../lib/asm-4.0.jar:/home/zly/prj/oss/pig/bin/../lib/asm-commons-4.0.jar:/home/zly/prj/oss/pig/bin/../lib/asm-tree-4.0.jar:/home/zly/prj/oss/pig/bin/../lib/automaton-1.11-8.jar:/home/zly/prj/oss/pig/bin/../lib/avro-1.7.5.jar:/home/zly/prj/oss/pig/bin/../lib/avro-tools-1.7.5-nodeps.jar:/home/zly/prj/oss/pig/bin/../lib/groovy-all-1.8.6.jar:/home/zly/prj/oss/pig/bin/../lib/guava-14.0.1.jar:/home/zly/prj/oss/pig/bin/../lib/hive-common-0.14.0-SNAPSHOT.jar:/home/zly/prj/oss/pig/bin/../lib/hive-exec-0.14.0-SNAPSHOT-core.jar:/home/zly/prj/oss/pig/bin/../lib/hive-serde-0.14.0-SNAPSHOT.jar:/home/zly/prj/oss/pig/bin/../lib/hive-shims-common-0.14.0-SNAPSHOT.jar:/home/zly/prj/oss/pig/bin/../lib/hive-shims-common-secure-0.14.0-SNAPSHOT.jar:/home/zly/prj/oss/pig/bin/../lib/jackson-core-asl-1.8.8.jar:/home/zly/prj/oss/pig/bin/../lib/jackson-mapper-asl-1.8.8.jar:/home/zly/prj/oss/pig/bin/../lib/jansi-1.9.jar:/home/zly/prj/oss/pig/bin/../lib/jline-1.0.jar:/home/zly/prj/oss/pig/bin/../lib/joda-time-2.1.jar:/home/zly/prj/oss/pig/bin/../lib/jruby-complete-1.6.7.jar:/home/zly/prj/oss/pig/bin/../lib/js-1.7R2.jar:/home/zly/prj/oss/pig/bin/../lib/json-simple-1.1.jar:/home/zly/prj/oss/pig/bin/../lib/jython-standalone-2.5.3.jar:/home/zly/prj/oss/pig/bin/../lib/protobuf-java-2.4.1-shaded.jar:/home/zly/prj/oss/pig/bin/../lib/protobuf-java-2.4.1.jar:/home/zly/prj/oss/pig/bin/../lib/protobuf-java-2.5.0.jar:/home/zly/prj/oss/pig/bin/../lib/snappy-java-1.0.5.jar:/home/zly/prj/oss/pig/bin/../lib/trevni-avro-1.7.5.jar:/home/zly/prj/oss/pig/bin/../lib/trevni-core-1.7.5.jar:/home/zly/prj/oss/pig/bin/../lib/zookeeper-3.4.5.jar:/home/zly/prj/oss/pig/bin/../pig-0.14.0-SNAPSHOT-core-h1.jar:/home/zly/prj/oss/pig/bin/../lib/h1/avro-mapred-1.7.5.jar:/home/zly/prj/oss/pig/bin/../lib/h1/hbase-client-0.96.0-hadoop1.jar:/home/zly/prj/oss/pig/bin/../lib/h1/hbase-common-0.96.0-hadoop1.jar:/home/zly/prj/oss/pig/bin/../lib/h1/hbase-hadoop-compat-0.96.0-hadoop1.jar:/home/zly/prj/oss/pig/bin/../lib/h1/hbase-hadoop1-compat-0.96.0-hadoop1.jar:/home/zly/prj/oss/pig/bin/../lib/h1/hbase-protocol-0.96.0-hadoop1.jar:/home/zly/prj/oss/pig/bin/../lib/h1/hbase-server-0.96.0-hadoop1.jar:/home/zly/prj/oss/pig/bin/../lib/h1/hive-shims-0.20S-0.14.0-SNAPSHOT.jar org.apache.pig.Main -x local id.pig&lt;br/&gt;
Listening for transport dt_socket at address: 9999&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory&lt;br/&gt;
        at org.apache.pig.Main.&amp;lt;clinit&amp;gt;(Main.java:100)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory&lt;br/&gt;
        at java.net.URLClassLoader$1.run(URLClassLoader.java:366)&lt;br/&gt;
        at java.net.URLClassLoader$1.run(URLClassLoader.java:355)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
        at java.net.URLClassLoader.findClass(URLClassLoader.java:354)&lt;br/&gt;
        at java.lang.ClassLoader.loadClass(ClassLoader.java:425)&lt;br/&gt;
        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:308)&lt;br/&gt;
        at java.lang.ClassLoader.loadClass(ClassLoader.java:358)&lt;br/&gt;
        ... 1 more&lt;br/&gt;
Exception in thread &quot;Thread-0&quot; java.lang.NoClassDefFoundError: org/apache/hadoop/fs/LocalFileSystem&lt;br/&gt;
        at org.apache.pig.Main$1.run(Main.java:95)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.apache.hadoop.fs.LocalFileSystem&lt;br/&gt;
        at java.net.URLClassLoader$1.run(URLClassLoader.java:366)&lt;br/&gt;
        at java.net.URLClassLoader$1.run(URLClassLoader.java:355)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
        at java.net.URLClassLoader.findClass(URLClassLoader.java:354)&lt;br/&gt;
        at java.lang.ClassLoader.loadClass(ClassLoader.java:425)&lt;br/&gt;
        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:308)&lt;br/&gt;
        at java.lang.ClassLoader.loadClass(ClassLoader.java:358)&lt;br/&gt;
        ... 1 more&lt;/p&gt;</comment>
                            <comment id="14137877" author="rohini" created="Wed, 17 Sep 2014 21:05:33 +0100"  >&lt;p&gt;Sorry. My bad. Forgot that core-site.xml is also loaded as part of defaults. We use a perl script instead of the bash bin/pig and what we do there is not add HADOOP_CONF_DIR to classpath if it is local mode. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; [ &lt;span class=&quot;code-quote&quot;&gt;&quot;$HADOOP_CONF_DIR&quot;&lt;/span&gt; != &quot;&quot; ]; then
    CLASSPATH=${CLASSPATH}:${HADOOP_CONF_DIR}
fi
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should not be done if local mode. Either you can do that or even the current patch is ok.  But you can simplify the code as below as you don&apos;t have to initialize UserGroupInformation in case of non local mode.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (opts.getValStr().toLowerCase().contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;local&quot;&lt;/span&gt;) {
                        UserGroupInformation.setConfiguration(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
                   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Above check also ensures kerberos is not enabled for tez_local mode. With 0.14 we are dropping support for Hadoop 0.20 so using UserGroupInformation class directly is ok at last ...&lt;/p&gt;


</comment>
                            <comment id="14138424" author="kellyzly" created="Thu, 18 Sep 2014 03:55:09 +0100"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;:&lt;br/&gt;
  Thanks for your comment.  Patch has been updated and submitted. Can you help to review again?&lt;/p&gt;</comment>
                            <comment id="14139005" author="rohini" created="Thu, 18 Sep 2014 15:43:13 +0100"  >&lt;p&gt;+1. Committed to trunk (0.14).  Thanks Liyun Zhang for the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12669615" name="PIG-3507-2.patch" size="937" author="kellyzly" created="Thu, 18 Sep 2014 03:54:41 +0100"/>
                            <attachment id="12607306" name="PIG-3507.patch" size="1355" author="chiyang" created="Tue, 8 Oct 2013 05:13:04 +0100"/>
                            <attachment id="12664872" name="PIG_3507_1.patch" size="1046" author="kellyzly" created="Thu, 28 Aug 2014 12:30:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 4 Nov 2013 09:58:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352363</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzilgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352651</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>