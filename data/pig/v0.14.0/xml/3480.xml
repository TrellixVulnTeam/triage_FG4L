<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:57:26 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3480/PIG-3480.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3480] TFile-based tmpfile compression crashes in some cases</title>
                <link>https://issues.apache.org/jira/browse/PIG-3480</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;When pig tmpfile compression is on, some jobs fail inside core hadoop internals.&lt;br/&gt;
Suspect TFile is the problem, because an experiment in replacing TFile with SequenceFile succeeded.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12670332">PIG-3480</key>
            <summary>TFile-based tmpfile compression crashes in some cases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dvryaboy">Dmitriy V. Ryaboy</assignee>
                                    <reporter username="dvryaboy">Dmitriy V. Ryaboy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Sep 2013 19:32:41 +0100</created>
                <updated>Tue, 15 Apr 2014 21:45:02 +0100</updated>
                            <resolved>Mon, 14 Oct 2013 04:23:33 +0100</resolved>
                                                    <fixVersion>0.12.1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13776602" author="dvryaboy" created="Tue, 24 Sep 2013 19:35:28 +0100"  >&lt;p&gt;For most of the tasks that fail, no stack trace is available on Hadoop 1 (they just die with &quot;nonzero status 134&quot;).&lt;/p&gt;

&lt;p&gt;I did catch one task with a stack trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.io.IOException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; reading compressed data at
org.apache.hadoop.io.IOUtils.wrappedReadForCompressedData(IOUtils.java:205) at 
org.apache.hadoop.mapred.IFile$Reader.readData(IFile.java:342) at 
org.apache.hadoop.mapred.IFile$Reader.rejigData(IFile.java:373) at 
org.apache.hadoop.mapred.IFile$Reader.readNextBlock(IFile.java:357) at 
org.apache.hadoop.mapred.IFile$Reader.next(IFile.java:389) at 
org.apache.hadoop.mapred.Merger$Segment.next(Merger.java:220) at 
org.apache.hadoop.mapred.Merger$MergeQueue.merge(Merger.java:420) at 
org.apache.hadoop.mapred.Merger$MergeQueue.merge(Merger.java:381) at 
org.apache.hadoop.mapred.Merger.merge(Merger.java:77) at 
org.apache.hadoop.mapred.MapTask$MapOutputBuffer.mergeParts(MapTask.java:1548) at 
org.apache.hadoop.mapred.MapTask$MapOutputBuffer.flush(MapTask.java:1180) at 
org.apache.hadoop.mapred.MapTask$NewOutputCollector.close(MapTask.java:582) at 
org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:649) at org.apache.hadoop.mapred.MapTask.run(Map
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No idea if this is relevant.&lt;/p&gt;

&lt;p&gt;This problem does happen consistently &amp;#8211; 100% of the time on my script that shows this problem. Anecdotally, about 1/10 of our production scripts encounter this; I have not been able to establish a pattern yet.&lt;/p&gt;</comment>
                            <comment id="13776615" author="dvryaboy" created="Tue, 24 Sep 2013 19:46:18 +0100"  >&lt;p&gt;Attaching a rough patch which replaces use of TFile with SequenceFile.&lt;/p&gt;

&lt;p&gt;Next steps:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;evaluate effect on size of compressed data for TFile vs SeqFile when TFile does work&lt;/li&gt;
	&lt;li&gt;add tests, make TFile tests pass (in this file they fail, because of course TFile is not being used)&lt;/li&gt;
	&lt;li&gt;make SeqFile the default method, since it doesn&apos;t break&lt;/li&gt;
	&lt;li&gt;allow TFile use by a switch, since current users may want to keep it. I would prefer to not do that, but might if the first step shows significant differences.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thoughts?&lt;br/&gt;
Especially from folks using TFile-based compression in production (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;?)&lt;/p&gt;</comment>
                            <comment id="13776644" author="knoguchi" created="Tue, 24 Sep 2013 20:15:14 +0100"  >&lt;p&gt;Dmitriy, isn&apos;t your stacktrace failing at mapred.IFile and not TFile? &lt;/p&gt;

&lt;p&gt;&amp;gt; This problem does happen consistently &#8211; 100% of the time on my script that shows this problem. &lt;br/&gt;
&amp;gt;&lt;br/&gt;
And this problem goes away once tmpcompression is turned off? &lt;br/&gt;
(pig.tmpfilecompression=false)&lt;/p&gt;</comment>
                            <comment id="13776666" author="dvryaboy" created="Tue, 24 Sep 2013 20:42:26 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;Koji Noguchi&lt;/a&gt; yeah, I&apos;m not sure the stack trace is relevant &amp;#8211; it&apos;s the only part that&apos;s not consistent about this.&lt;/p&gt;

&lt;p&gt;The problem goes away when I set pig.tmpfilecompression to false, or when I replace TFile with SequenceFile.&lt;br/&gt;
I&apos;ve also seen stack traces that were inside TFile, and had to do with some LZO decoding issues.. the actual error is really hard to capture, other than the fact that mappers fail consistently.&lt;/p&gt;</comment>
                            <comment id="13776681" author="rohini" created="Tue, 24 Sep 2013 20:59:14 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dvryaboy&quot; class=&quot;user-hover&quot; rel=&quot;dvryaboy&quot;&gt;Dmitriy V. Ryaboy&lt;/a&gt;,&lt;br/&gt;
   We have been running it with pig.tmpfilecompression=true and pig.tmpfilecompression.codec=lzo as defaults from 2010 and have not encountered any issues so far. The problem might be elsewhere and TFile might not be the issue.&lt;/p&gt;</comment>
                            <comment id="13776728" author="dvryaboy" created="Tue, 24 Sep 2013 21:47:30 +0100"  >&lt;p&gt;Rohini I suspect this might be something about complex data types, which afaik are pretty rare at Y! and extremely common at Twitter.&lt;/p&gt;</comment>
                            <comment id="13776732" author="dvryaboy" created="Tue, 24 Sep 2013 21:48:57 +0100"  >&lt;p&gt;Rohini, do you guys use lzo or gz compression? Maybe it&apos;s just lzo that&apos;s breaking. I can test gz. That never actually occurred to me, I just assumed this is completely busted because I could never get it to work (since 2010..)&lt;/p&gt;</comment>
                            <comment id="13776745" author="olgan" created="Tue, 24 Sep 2013 22:06:44 +0100"  >&lt;p&gt;Could this be related to Hadoop version? &lt;/p&gt;</comment>
                            <comment id="13776769" author="rohini" created="Tue, 24 Sep 2013 22:24:17 +0100"  >&lt;p&gt;We do have complex types like bag of maps and bag of bags and one or two levels of nesting. But I assume you have way more nesting than we do. Does that matter though as what is written to TFile is just bytes for both key and value?&lt;/p&gt;

&lt;p&gt;We use lzo. It would be good to try gz and see if the problem is with lzo for you. &lt;/p&gt;

&lt;p&gt;2013-09-24 21:10:21,289 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; com.hadoop.compression.lzo.GPLNativeCodeLoader: Loaded native gpl library&lt;br/&gt;
2013-09-24 21:10:21,291 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; com.hadoop.compression.lzo.LzoCodec: Successfully loaded &amp;amp; initialized native-lzo library&lt;br/&gt;
2013-09-24 21:10:21,293 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; org.apache.hadoop.io.compress.CodecPool: Got brand-new compressor &lt;span class=&quot;error&quot;&gt;&amp;#91;.lzo_deflate&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t think hadoop version should matter as we had hadoop 1.x till mid 2012. &lt;/p&gt;</comment>
                            <comment id="13781238" author="aniket486" created="Sun, 29 Sep 2013 05:11:36 +0100"  >&lt;blockquote&gt;&lt;p&gt;evaluate effect on size of compressed data for TFile vs SeqFile when TFile does work&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-3315?focusedCommentId=12631905&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12631905&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HADOOP-3315?focusedCommentId=12631905&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12631905&lt;/a&gt; has some benchmark details for SequenceFile vs TFile.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;add tests, make TFile tests pass (in this file they fail, because of course TFile is not being used)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will submit a patch for this.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;make SeqFile the default method, since it doesn&apos;t break&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1 for this as the effect is not substantially worse.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;allow TFile use by a switch, since current users may want to keep it. I would prefer to not do that, but might if the first step shows significant differences.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, what are your thoughts on this?&lt;/p&gt;</comment>
                            <comment id="13781241" author="rohini" created="Sun, 29 Sep 2013 05:24:22 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aniket486&quot; class=&quot;user-hover&quot; rel=&quot;aniket486&quot;&gt;Aniket Mokashi&lt;/a&gt;, &lt;br/&gt;
   Would prefer having TFile as the default and Sequence file as an option. We have not had any issues with it for years and may be few others too it has been the default. Also the performance numbers are better for it by 10-40% with compression according to &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-3315&quot; title=&quot;New binary file format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-3315&quot;&gt;&lt;del&gt;HADOOP-3315&lt;/del&gt;&lt;/a&gt; that you have referred.&lt;/p&gt;

&lt;p&gt;  And it would also be good to have the actual cause of failure with TFile investigated if possible to see if something is not being done right in Pig as TFile just writes byte[] for keys and values.&lt;/p&gt;</comment>
                            <comment id="13781959" author="olgan" created="Mon, 30 Sep 2013 16:59:51 +0100"  >&lt;p&gt;Agree with Rohini. Changing default just because we found a bug does not seem like a sound approach,&lt;/p&gt;</comment>
                            <comment id="13782112" author="dvryaboy" created="Mon, 30 Sep 2013 20:09:25 +0100"  >&lt;p&gt;That is fine with me, lets make sequence file optional. It will let people avoid the bug I am encountering, an also do things like use snappy compression. &lt;/p&gt;</comment>
                            <comment id="13793045" author="aniket486" created="Fri, 11 Oct 2013 22:02:39 +0100"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/14552/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/14552/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13793896" author="aniket486" created="Mon, 14 Oct 2013 04:23:20 +0100"  >&lt;p&gt;Committed to trunk and 0.12 branch.&lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dvryaboy&quot; class=&quot;user-hover&quot; rel=&quot;dvryaboy&quot;&gt;Dmitriy V. Ryaboy&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=julienledem&quot; class=&quot;user-hover&quot; rel=&quot;julienledem&quot;&gt;Julien Le Dem&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12674869">PIG-3530</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12607474" name="PIG-3480-2.patch" size="34029" author="aniket486" created="Wed, 9 Oct 2013 01:09:22 +0100"/>
                            <attachment id="12607480" name="PIG-3480-3.patch" size="34760" author="aniket486" created="Wed, 9 Oct 2013 02:01:39 +0100"/>
                            <attachment id="12607489" name="PIG-3480-4.patch" size="35309" author="aniket486" created="Wed, 9 Oct 2013 02:33:28 +0100"/>
                            <attachment id="12608073" name="PIG-3480-5.patch" size="40094" author="aniket486" created="Fri, 11 Oct 2013 21:44:09 +0100"/>
                            <attachment id="12608120" name="PIG-3480-6.patch" size="41689" author="aniket486" created="Sat, 12 Oct 2013 01:45:10 +0100"/>
                            <attachment id="12608235" name="PIG-3480-7.patch" size="42155" author="aniket486" created="Mon, 14 Oct 2013 04:21:58 +0100"/>
                            <attachment id="12604855" name="PIG-3480.patch" size="10003" author="dvryaboy" created="Tue, 24 Sep 2013 19:46:18 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 24 Sep 2013 19:15:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350161</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzi7xr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350455</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>