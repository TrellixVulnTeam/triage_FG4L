<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:54:21 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3241/PIG-3241.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3241] ConcurrentModificationException in POPartialAgg</title>
                <link>https://issues.apache.org/jira/browse/PIG-3241</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;While running few PIG scripts against Hadoop 2.0, I see consistently see ConcurrentModificationException &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;at java.util.HashMap$HashIterator.remove(HashMap.java:811)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPartialAgg.aggregate(POPartialAgg.java:365)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPartialAgg.aggregateSecondLevel(POPartialAgg.java:379)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPartialAgg.getNext(POPartialAgg.java:203)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:308)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POLocalRearrange.getNext(POLocalRearrange.java:263)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapBase.runPipeline(PigGenericMapBase.java:283)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapBase.map(PigGenericMapBase.java:278)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapBase.map(PigGenericMapBase.java:64)
	at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:144)
	at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:729)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:334)
	at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:158)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:396)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1441)
	at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:153)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like there is rawInputMap is being modified while elements are removed from it. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12635859">PIG-3241</key>
            <summary>ConcurrentModificationException in POPartialAgg</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dvryaboy">Dmitriy V. Ryaboy</assignee>
                                    <reporter username="lohit">Lohit Vijayarenu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Mar 2013 18:35:11 +0000</created>
                <updated>Tue, 2 Apr 2013 16:54:33 +0100</updated>
                            <resolved>Wed, 13 Mar 2013 00:53:04 +0000</resolved>
                                    <version>0.11</version>
                                    <fixVersion>0.12.0</fixVersion>
                    <fixVersion>0.11.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13596300" author="dvryaboy" created="Thu, 7 Mar 2013 20:03:39 +0000"  >&lt;p&gt;Lohit, can you post the svn revision you compiled from?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt; did you guys get Pig running on Hadoop 2.0 in production? Seeing anything like this?&lt;/p&gt;</comment>
                            <comment id="13596440" author="lohit" created="Thu, 7 Mar 2013 21:58:19 +0000"  >&lt;p&gt;Compiled release 0.11 version against Hadoop 2.0.&lt;br/&gt;
I also see ConcurrentModificationExceptions with processedInputMap in same class&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)
	at java.util.HashMap$EntryIterator.next(HashMap.java:834)
	at java.util.HashMap$EntryIterator.next(HashMap.java:832)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPartialAgg.spillResult(POPartialAgg.java:339)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPartialAgg.getNext(POPartialAgg.java:156)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:308)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POLocalRearrange.getNext(POLocalRearrange.java:263)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapBase.runPipeline(PigGenericMapBase.java:283)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapBase.map(PigGenericMapBase.java:278)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapBase.map(PigGenericMapBase.java:64)
	at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:144)
	at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:729)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:334)
	at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:158)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:396)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1441)
	at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:153)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13598965" author="rohini" created="Mon, 11 Mar 2013 16:40:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dvryaboy&quot; class=&quot;user-hover&quot; rel=&quot;dvryaboy&quot;&gt;Dmitriy V. Ryaboy&lt;/a&gt;,&lt;br/&gt;
  No. We are currently running on Pig 0.10 only. Pig 0.11 testing is blocked due to lack of QE resources to certify new features. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, List&amp;lt;Tuple&amp;gt;&amp;gt; rawInputMap = Maps.newHashMap();
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, List&amp;lt;Tuple&amp;gt;&amp;gt; processedInputMap = Maps.newHashMap();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Don&apos;t think it has to do with Hadoop 2.0. A ConcurrentHashMap should have been used in the code. Exception not visible in unit tests as spill does not happen there.&lt;/p&gt;</comment>
                            <comment id="13599008" author="dvryaboy" created="Mon, 11 Mar 2013 17:15:13 +0000"  >&lt;p&gt;Thing is, we are running this in production on 1.0 and don&apos;t observe this error.. &lt;/p&gt;</comment>
                            <comment id="13599097" author="rohini" created="Mon, 11 Mar 2013 18:30:47 +0000"  >&lt;p&gt;I was wrong about iterator.remove() of HashMap throwing ConcurrentModificationException. Happens only while iterating directly over the entrySet()&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; entry : map.entrySet()) {
            map.remove(entry.getKey());
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;throws ConcurrentModificationException&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Iterator&amp;lt;Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; spillingIterator = map.entrySet().iterator();
Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; entry = spillingIterator.next();
spillingIterator.remove();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;does not throw ConcurrentModificationException&lt;/p&gt;

&lt;p&gt;  So theoretically it should be fine if the map was accessed within a single thread. Need to investigate if there is more than one thread accessing POPartialAgg. Possible that it could be a 2.0 issue. Simple fix would be to change that to ConcurrentHashMap, but need to find the underlying cause to assess further impact. I am blocked with few deadlines before going on vacation and don&apos;t have time to spare for the investigation. I am fine if anyone else can take a look at this. Cheolsoo?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lohit&quot; class=&quot;user-hover&quot; rel=&quot;lohit&quot;&gt;Lohit Vijayarenu&lt;/a&gt;,&lt;br/&gt;
   Can you change it to ConcurrentHashMap and compile and see that fixes the problem for you?&lt;/p&gt;
</comment>
                            <comment id="13600256" author="lohit" created="Tue, 12 Mar 2013 17:56:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt; I already tried by changing those maps to ConcurrentHashMap. But I still end up with similar errors. &lt;/p&gt;</comment>
                            <comment id="13600525" author="rohini" created="Tue, 12 Mar 2013 21:54:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lohit&quot; class=&quot;user-hover&quot; rel=&quot;lohit&quot;&gt;Lohit Vijayarenu&lt;/a&gt;,&lt;br/&gt;
    Can you give some script to reproduce this problem?&lt;/p&gt;</comment>
                            <comment id="13600547" author="cheolsoo" created="Tue, 12 Mar 2013 22:09:48 +0000"  >&lt;p&gt;I seem to be able to reproduce ConcurrentModificationException in my 3-node cluster (both MR1 and MR2). The only difference is that it happens a lot more frequently in MR2 than in MR1.&lt;/p&gt;

&lt;p&gt;Here is the script that I am using with 100M integers:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
a = LOAD &apos;1.txt&apos; AS (i:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
b = GROUP a ALL;
c = FOREACH b GENERATE TOP(1000, 0, a);
STORE c INTO &apos;out&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This doesn&apos;t give me exactly the same stack trace, but almost every mapper fails with ConcurrentModificationException constantly in MR2. I am setting mapPartAgg properties as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
pig.exec.mapPartAgg=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
pig.exec.mapPartAgg.minReduction=3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13600602" author="dvryaboy" created="Tue, 12 Mar 2013 23:18:03 +0000"  >&lt;p&gt;I think I have a clean fix, Lohit and I are testing.&lt;/p&gt;</comment>
                            <comment id="13600644" author="dvryaboy" created="Wed, 13 Mar 2013 00:03:53 +0000"  >&lt;p&gt;Attaching patch.&lt;/p&gt;

&lt;p&gt;Rather than synchronize all memory access, I decided to simply avoid concurrent access all together. spill(), called by Spillable Memory Manager, used to set up the iterator used for spilling - that involved looking at the primary and secondary maps, applying the combiner to them, doing all kinds of things &amp;#8211; all in the SMM thread.&lt;/p&gt;

&lt;p&gt;Instead, we now only set the doSpill flag in spill(), and do the work in the main thread, which now is the only thread that can modify iterators and hashmaps.&lt;/p&gt;

&lt;p&gt;Most of this patch is just whitespace changes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="13600661" author="cheolsoo" created="Wed, 13 Mar 2013 00:38:29 +0000"  >&lt;p&gt;+1.&lt;/p&gt;

&lt;p&gt;The fix looks good. I also verified that my test script runs fine with the patch.&lt;/p&gt;</comment>
                            <comment id="13600674" author="dvryaboy" created="Wed, 13 Mar 2013 00:53:04 +0000"  >&lt;p&gt;committed to 0.11 branch and trunk.&lt;/p&gt;

&lt;p&gt;thanks all.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12573444" name="PIG-3241.patch" size="9409" author="dvryaboy" created="Wed, 13 Mar 2013 00:03:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 7 Mar 2013 20:03:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316351</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzcft3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316694</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>