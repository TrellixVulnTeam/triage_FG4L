<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:48:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2265/PIG-2265.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2265] Test case TestSecondarySort failure</title>
                <link>https://issues.apache.org/jira/browse/PIG-2265</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Error message:&lt;br/&gt;
Testcase: testNestedSortEndToEnd3 took 53.076 sec&lt;br/&gt;
	Caused an ERROR&lt;br/&gt;
Unable to open iterator for alias E. Backend error : org.apache.pig.data.DataByteArray cannot be cast to org.apache.pig.data.Tuple&lt;br/&gt;
org.apache.pig.impl.logicalLayer.FrontendException: ERROR 1066: Unable to open iterator for alias E. Backend error : org.apache.pig.data.DataByteArray cannot be cast to org.apache.pig.data.Tuple&lt;br/&gt;
	at org.apache.pig.PigServer.openIterator(PigServer.java:742)&lt;br/&gt;
	at org.apache.pig.test.TestSecondarySort.testNestedSortEndToEnd3(TestSecondarySort.java:550)&lt;br/&gt;
Caused by: java.lang.ClassCastException: org.apache.pig.data.DataByteArray cannot be cast to org.apache.pig.data.Tuple&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.expressionOperators.POProject.getNext(POProject.java:392)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POLocalRearrange.getNext(POLocalRearrange.java:357)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigMapBase.runPipeline(PigMapBase.java:236)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigMapBase.map(PigMapBase.java:231)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigMapBase.map(PigMapBase.java:53)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:144)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:621)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:305)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12521461">PIG-2265</key>
            <summary>Test case TestSecondarySort failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="xinshengjun">Shengjun Xin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Sep 2011 15:42:27 +0100</created>
                <updated>Mon, 14 Oct 2013 17:46:11 +0100</updated>
                            <resolved>Mon, 8 Apr 2013 20:59:48 +0100</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.12.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13098173" author="daijy" created="Tue, 6 Sep 2011 18:12:45 +0100"  >&lt;p&gt;Are you using ant 1.8? We find some test failures with ant 1.8 and fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2172&quot; title=&quot;Fix test failure for ant 1.8.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2172&quot;&gt;&lt;del&gt;PIG-2172&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13098534" author="xinshengjun" created="Wed, 7 Sep 2011 02:47:52 +0100"  >&lt;p&gt;Yes, I&apos;m using ant 1.8, I&apos;ll try ant 1.7, thank you for your advice&lt;/p&gt;</comment>
                            <comment id="13098830" author="xinshengjun" created="Wed, 7 Sep 2011 11:17:05 +0100"  >&lt;p&gt;If I use ant 1.7 or apply the patch, the test case testNestedSortEndToEnd3 will not run. But if I let it run, it still fails and generates the same error message as before. Any idea?&lt;/p&gt;</comment>
                            <comment id="13614734" author="dreambird" created="Wed, 27 Mar 2013 00:35:58 +0000"  >&lt;p&gt;current the test is disabled in trunk.&lt;/p&gt;

&lt;p&gt;I enable it and can reproduce the issue. I think it is the same root cause as &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3049&quot; title=&quot;Cannot sort on a bag in nested foreach&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3049&quot;&gt;&lt;del&gt;PIG-3049&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt; help me debug this issue a while back, and explains to me idea.&lt;/p&gt;

&lt;p&gt;The reason seems when secondary sort is enabled, the code needs inform POProject.java to process secondary sort key properly to avoid cast from the content of the tuple to tuple by&lt;br/&gt;
POProject.java line 481&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
res.result = (Tuple)ret;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the fix should be something like&lt;br/&gt;
POProject.java line 422&lt;br/&gt;
change&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ret = inpValue.get(columns.get(0));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (secondarySort) {
    ret = inpValue;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    ret = inpValue.get(columns.get(0));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;it is not clear to me whether this is the right guess, and don&apos;t have idea how to get the boolean value secondarySort in POProject.java though.&lt;/p&gt;</comment>
                            <comment id="13623884" author="daijy" created="Fri, 5 Apr 2013 19:11:36 +0100"  >&lt;p&gt;There are two issues:&lt;br/&gt;
1. SecondaryKeyOptimizer does something wrong when foreach inner plan contains nested foreach. &lt;br/&gt;
2. Order by sampler does not deal with nested tuples.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2265&quot; title=&quot;Test case TestSecondarySort failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2265&quot;&gt;&lt;del&gt;PIG-2265&lt;/del&gt;&lt;/a&gt;-1.patch fixed TestSecondarySort.testNestedSortEndToEnd3() by&lt;br/&gt;
1. Change SecondaryKeyOptimizer not to optimize when foreach inner plan contains nested foreach. This alone fix &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3049&quot; title=&quot;Cannot sort on a bag in nested foreach&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3049&quot;&gt;&lt;del&gt;PIG-3049&lt;/del&gt;&lt;/a&gt;, but not testNestedSortEndToEnd3&lt;br/&gt;
2. Change MRCompiler not to flatten input tuple when doing sorting&lt;/p&gt;

&lt;p&gt;Yet to finish all tests.&lt;/p&gt;</comment>
                            <comment id="13624269" author="dreambird" created="Sat, 6 Apr 2013 02:49:13 +0100"  >&lt;p&gt;Thanks for doing this, Daniel! I think it is not a bad idea to disable secondary key optimization for nested foreach, if it is too complex to get it right, as you suggested. I am reading SecondaryKeyOptimizer.java. Looks like I was in different direction before &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13624363" author="daijy" created="Sat, 6 Apr 2013 07:34:34 +0100"  >&lt;p&gt;All unit tests pass.&lt;/p&gt;</comment>
                            <comment id="13625007" author="cheolsoo" created="Sun, 7 Apr 2013 20:48:45 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;, thank you very much for fixing this. I was curious about how to fix this.&lt;/p&gt;

&lt;p&gt;I have few minor comments on your patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Wouldn&apos;t it be better to remove the test cases that you&apos;re modifying in &lt;tt&gt;TestSecondarySort.java&lt;/tt&gt;? Since you&apos;re disabling the optimization, these test cases don&apos;t test anything any more. So why not delete them?&lt;/li&gt;
	&lt;li&gt;In addition, can you delete &lt;tt&gt;testDistinctOptimization1()&lt;/tt&gt;, which is currently commented out due to &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2009&quot; title=&quot;Better MergeForEach rule&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2009&quot;&gt;PIG-2009&lt;/a&gt;? Looking at &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2009&quot; title=&quot;Better MergeForEach rule&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2009&quot;&gt;PIG-2009&lt;/a&gt;, this test case will be no longer valid since you&apos;re disabling the optimization anyway.&lt;/li&gt;
	&lt;li&gt;Can you remove &lt;tt&gt;processForEach()&lt;/tt&gt; in &lt;tt&gt;SecondaryKeyOptimizer.java&lt;/tt&gt; instead of making it always return true? How about do the following instead?
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -481,10 +481,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class SecondaryKeyOptimizer &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; MROpPlanVisitor {
                     sawInvalidPhysicalOper = processSort((POSort)currentNode);
                 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentNode &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; POProject)
                     sawInvalidPhysicalOper = processProject((POProject)currentNode);
-                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentNode &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; POForEach)
-                    sawInvalidPhysicalOper = processForEach((POForEach)currentNode);
                 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentNode &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; POUserFunc ||
-                         currentNode &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; POUnion)
+                         currentNode &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; POUnion ||
+                         currentNode &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; POForEach)
                     &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13625707" author="daijy" created="Mon, 8 Apr 2013 20:30:42 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;, nice catch. &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2265&quot; title=&quot;Test case TestSecondarySort failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2265&quot;&gt;&lt;del&gt;PIG-2265&lt;/del&gt;&lt;/a&gt;-2.patch includes all your suggestions.&lt;/p&gt;</comment>
                            <comment id="13625724" author="cheolsoo" created="Mon, 8 Apr 2013 20:52:37 +0100"  >&lt;p&gt;+1. Looks good to me!&lt;/p&gt;</comment>
                            <comment id="13625732" author="daijy" created="Mon, 8 Apr 2013 20:59:48 +0100"  >&lt;p&gt;Patch committed to trunk. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12616098">PIG-3049</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12577248" name="PIG-2265-1.patch" size="5657" author="daijy" created="Fri, 5 Apr 2013 19:11:36 +0100"/>
                            <attachment id="12577597" name="PIG-2265-2.patch" size="10437" author="daijy" created="Mon, 8 Apr 2013 20:30:42 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 Sep 2011 17:12:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35745</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyawef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97560</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>