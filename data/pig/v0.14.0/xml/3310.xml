<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:56:31 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3310/PIG-3310.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3310] ImplicitSplitInserter does not generate new uids for nested schema fields, leading to miscomputations</title>
                <link>https://issues.apache.org/jira/browse/PIG-3310</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Consider the following example&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
inp = LOAD &apos;$INPUT&apos; AS (memberId:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, shopId:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, score:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);

tuplified = FOREACH inp GENERATE (memberId, shopId) AS tuplify, score;

D1 = FOREACH tuplified GENERATE tuplify.memberId as memberId, tuplify.shopId as shopId, score AS score;
D2 = FOREACH tuplified GENERATE tuplify.memberId as memberId, tuplify.shopId as shopId, score AS score;

J = JOIN D1 By shopId, D2 by shopId;
K = FOREACH J GENERATE D1::memberId AS member_id1, D2::memberId AS member_id2, D1::shopId as shop;

EXPLAIN K;
DUMP K;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is a bit weird written like that, but it provides a minimal reproduction case (in the real case, the &quot;tuplified&quot; phase came from a multi-key grouping).&lt;/p&gt;

&lt;p&gt;On input data:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1       1001    101
1       1002    103
1       1003    102
1       1004    102
2       1005    101
2       1003    101
2       1002    123
3       1042    101
3       1005    101
3       1002    133
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will give a wrongful output like ..&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(1,1001,1001)
(1,1002,1002)
(1,1002,1002)
(1,1002,1002)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The second column should be a member id so (1,2,3,4,5).&lt;/p&gt;

&lt;p&gt;In the initial case, there was a FILTER (member_id1 &amp;lt; member_id2) after K, and computation failed because of PushUpFilter optimization mistakenly moving the LOFilter operation before the join, at a place where it tried to work on a tuple and failed.&lt;/p&gt;

&lt;p&gt;My understanding of the issue is that when the ImplicitSplitInserter creates the LOSplitOutputs, it will correctly reset the schema, and the LOSplitOutput will regenerate uids for the fields of D1 and D2 ... but will not do that on the tuple members.&lt;/p&gt;

&lt;p&gt;The logical plan after the ImplicitSplitINserter will look like (simplified)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   |---D1: (Name: LOForEach Schema: memberId#124:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,shopId#125:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;)ColumnPrune:InputUids=[127]ColumnPrune:OutputUids=[125, 124]
        |---tuplified: (Name: LOSplitOutput Schema: tuplify#127:tuple(memberId#124:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,shopId#125:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;))ColumnPrune:InputUids=[123]ColumnPrune:OutputUids=[127]
           |---tuplified: (Name: LOSplit Schema: tuplify#123:tuple(memberId#124:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,shopId#125:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;))ColumnPrune:InputUids=[123]ColumnPrune:OutputUids=[123]
    |---D2: (Name: LOForEach Schema: memberId#124:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,shopId#125:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;)ColumnPrune:InputUids=[130]ColumnPrune:OutputUids=[125, 124]
        |---tuplified: (Name: LOSplitOutput Schema: tuplify#130:tuple(memberId#124:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,shopId#125:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;))ColumnPrune:InputUids=[123]ColumnPrune:OutputUids=[130]
           |---tuplified: (Name: LOSplit Schema: tuplify#123:tuple(memberId#124:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,shopId#125:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;))ColumnPrune:InputUids=[123]ColumnPrune:OutputUids=[123]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;tuplified correctly gets a new uid (127 and 130) but the members of the tuple don&apos;t. When they get reprojected, both branches have the same uid and the join looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
|---J: (Name: LOJoin(HASH) Schema: D1::memberId#124:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,D1::shopId#125:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,D2::memberId#139:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;,D2::shopId#132:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;)ColumnPrune:InputUids=[125, 124, 132]ColumnPrune:OutputUids=[125, 124, 132]
        |   |
        |   shopId:(Name: Project Type: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; Uid: 125 Input: 0 Column: 1)
        |   |
        |   shopId:(Name: Project Type: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; Uid: 125 Input: 1 Column: 1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If for example instead of reprojecting &quot;memberId&quot;, we project &quot;memberId+0&quot;, a new node is created, and ultimately the two branches of the join will correctly get separate uids.&lt;/p&gt;

&lt;p&gt;My understanding is that LOSplitOutput.getSchema() should recurse on nested schema fields. However, I only have a light understanding of all of the logical plan handling, so I may be completely wrong.&lt;/p&gt;

&lt;p&gt;Attached is a draft of patch and a test reproducing the issue. Unfortunately, I haven&apos;t been able to run all unit tests with the &quot;fix&quot; (I have some weird hangs)&lt;/p&gt;

&lt;p&gt;I&apos;d be happy if you could indicate if that looks like completely the wrong way to fix the issue.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Reproduced on 0.10.1, 0.11.1 and trunk&lt;/p&gt;</environment>
        <key id="12645931">PIG-3310</key>
            <summary>ImplicitSplitInserter does not generate new uids for nested schema fields, leading to miscomputations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cstenac">Cl&#233;ment Stenac</assignee>
                                    <reporter username="cstenac">Cl&#233;ment Stenac</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 May 2013 08:59:57 +0100</created>
                <updated>Mon, 14 Oct 2013 17:46:28 +0100</updated>
                            <resolved>Thu, 30 May 2013 19:57:12 +0100</resolved>
                                    <version>0.11.1</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13665415" author="knoguchi" created="Thu, 23 May 2013 18:53:04 +0100"  >&lt;p&gt;I also don&apos;t have a good understanding on these, but the change looks reasonable to me.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;, original uid reassignment was added in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1705&quot; title=&quot;New logical plan: self-join fail for some queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1705&quot;&gt;&lt;del&gt;PIG-1705&lt;/del&gt;&lt;/a&gt; for the self-join.  Can you take a look?&lt;/p&gt;</comment>
                            <comment id="13666661" author="daijy" created="Fri, 24 May 2013 21:55:38 +0100"  >&lt;p&gt;Looks good to me. Will commit once tests pass.&lt;/p&gt;</comment>
                            <comment id="13670601" author="daijy" created="Thu, 30 May 2013 19:57:12 +0100"  >&lt;p&gt;Patch committed to trunk. Thanks Cl&#233;ment, Koji!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12581672" name="generate-uid-for-nested-fields.patch" size="6594" author="cstenac" created="Fri, 3 May 2013 09:01:47 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 23 May 2013 17:53:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326290</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hze54n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326635</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>