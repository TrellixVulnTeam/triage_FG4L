<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:08:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3627/PIG-3627.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3627] Json storage : Doesn&apos;t work in cases , where other Store Functions (like PigStorage / AvroStorage) do work. </title>
                <link>https://issues.apache.org/jira/browse/PIG-3627</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The following query &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Bar.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        pigServer.registerQuery(
                &lt;span class=&quot;code-quote&quot;&gt;&quot;uniqcnt  = foreach transactionsG {&quot;&lt;/span&gt;+
                               &lt;span class=&quot;code-quote&quot;&gt;&quot;sym = transactions.product ;&quot;&lt;/span&gt;+
                               &lt;span class=&quot;code-quote&quot;&gt;&quot;dsym = distinct sym  ;&quot;&lt;/span&gt;+
                               &lt;span class=&quot;code-quote&quot;&gt;&quot;generate flatten(dsym.product) as product, COUNT(dsym) as count ;&quot;&lt;/span&gt; +
                               &lt;span class=&quot;code-quote&quot;&gt;&quot;};&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Results in the schema:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
   Schema : {product: NULL,count: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This schema, is storable using AvroStorage or PigStorage, but it fails if stored using JsonStorage: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Failed to parse: &amp;lt;line 1, column 8&amp;gt;  Syntax error, unexpected symbol at or near &apos;,&apos;
	at org.apache.pig.parser.QueryParserDriver.parseSchema(QueryParserDriver.java:94)
	at org.apache.pig.parser.QueryParserDriver.parseSchema(QueryParserDriver.java:108)
	at org.apache.pig.impl.util.Utils.parseSchema(Utils.java:208)
	at org.apache.pig.impl.util.Utils.getSchemaFromString(Utils.java:182)
	at org.apache.pig.builtin.JsonStorage.prepareToWrite(JsonStorage.java:140)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputFormat$PigRecordWriter.&amp;lt;init&amp;gt;(PigOutputFormat.java:125)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputFormat.getRecordWriter(PigOutputFormat.java:86)
	at org.apache.hadoop.mapred.ReduceTask.runNewReducer(ReduceTask.java:553)
	at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:408)
	at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:216)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It appears that JsonStorage is thus less robust than the other storage formats.  Can we confirm or deny if some types of data structures do/ do not work with JsonStorage? &lt;/p&gt;

&lt;p&gt;So,I suggest:&lt;/p&gt;

&lt;p&gt;1) Ideally, I would think JsonStorage should support the same data that other Storage functions support.   &lt;/p&gt;

&lt;p&gt;the next best thing: &lt;/p&gt;

&lt;p&gt;2) Maybe a wiki page of examples that can / cannot work with JsonStorage and/or a better error message would be sufficient to solve this &quot;bug&quot;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12684949">PIG-3627</key>
            <summary>Json storage : Doesn&apos;t work in cases , where other Store Functions (like PigStorage / AvroStorage) do work. </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ssvinarchukhorton">Sergey Svinarchuk</assignee>
                                    <reporter username="jayunit100">jay vyas</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Dec 2013 13:26:44 +0000</created>
                <updated>Mon, 7 Jul 2014 19:07:51 +0100</updated>
                            <resolved>Fri, 7 Feb 2014 17:37:26 +0000</resolved>
                                                    <fixVersion>0.13.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13849599" author="cheolsoo" created="Mon, 16 Dec 2013 19:06:30 +0000"  >&lt;p&gt;The problem is &apos;NULL&apos; in your schema. &apos;NULL&apos; is not recognized by the schema parser.&lt;/p&gt;

&lt;p&gt;Explicitly defining the type of &lt;tt&gt;product&lt;/tt&gt; in this line probably will fix your error-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
flatten(dsym.product) as product:chararray,
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, I think the better way is to define the type of every field  in your query from the beginning so that you won&apos;t end up with NULL type after flattening &lt;tt&gt;dsym.product&lt;/tt&gt; in the first place. Pig is type-sensitive, so I strongly recommend to define type for every field if possible.&lt;/p&gt;

&lt;p&gt;To answer your questions, I agree that JsonStorage is not robust. For this case, it passes around the schema info as string and parse it using Utils.parseSchema() function. This is not robust at all.&lt;/p&gt;

&lt;p&gt;Ideally, what JsonStorage should do is to cast any field with no type info to bytearray. Contribution is welcome. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13849808" author="jayunit100" created="Mon, 16 Dec 2013 22:36:39 +0000"  >&lt;p&gt;Well, so I tried many permutations of casting , and it didnt work.  &lt;/p&gt;

&lt;p&gt;In the end, I had to update my load function to pre package the originator of the product field with chararray type.&lt;/p&gt;

&lt;p&gt;Then, the flatten statements at the bottom of my script didnt error anymore. &lt;/p&gt;

&lt;p&gt;I guess the schema  types cant be casted in on the fly.&lt;/p&gt;</comment>
                            <comment id="13849817" author="cheolsoo" created="Mon, 16 Dec 2013 22:47:05 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jayunit100&quot; class=&quot;user-hover&quot; rel=&quot;jayunit100&quot;&gt;jay vyas&lt;/a&gt; for sharing it.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I guess the schema types cant be casted in on the fly.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, it usually can be by adding a cast expression. But in your case, it was probably not possible because the schema was NULL to begin with.&lt;/p&gt;

&lt;p&gt;What I don&apos;t understand is how you end up with NULL in the schema because if any schema is not specified in load, it should be loaded as bytearray.&lt;/p&gt;</comment>
                            <comment id="13849832" author="jayunit100" created="Mon, 16 Dec 2013 22:56:07 +0000"  >&lt;p&gt;here are some more details.  I&apos;ve written it up here&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://jayunit100.blogspot.com/2013/12/pig-if-using-jsonstorage-beware-of.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://jayunit100.blogspot.com/2013/12/pig-if-using-jsonstorage-beware-of.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;hope this helps with the JIRA or to other people with the same problem.&lt;/p&gt;






&lt;p&gt;&amp;#8211; &lt;br/&gt;
Jay Vyas&lt;br/&gt;
&lt;a href=&quot;http://jayunit100.blogspot.com&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://jayunit100.blogspot.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13889134" author="nezihyigitbasi" created="Mon, 3 Feb 2014 00:50:01 +0000"  >&lt;p&gt;Cheolsoo, I checked the link Jay posted in his previous comment and after some digging it seems like the NULL schemas come from the STRSPLIT function, not from the LOAD function. Jay uses FLATTEN(STRSPLIT(...)) in his script and STRSPLIT returns a tuple without any internal schema (the schema of the internal elements are NULL).&lt;/p&gt;</comment>
                            <comment id="13892386" author="ssvinarchukhorton" created="Wed, 5 Feb 2014 18:24:56 +0000"  >&lt;p&gt;I attached file which fix this problem. It change type to chararray if field schema include null.&lt;/p&gt;</comment>
                            <comment id="13893151" author="daijy" created="Thu, 6 Feb 2014 08:09:41 +0000"  >&lt;p&gt;Thanks Sergey. I am fine to check the schema for JsonStorage, but we need to treat Null schema as bytearray instead of chararray.&lt;/p&gt;

&lt;p&gt;And the real problem here is we shall not get NULL schema in the first place. I attach a patch to fix the schema generation.&lt;/p&gt;</comment>
                            <comment id="13893295" author="ssvinarchukhorton" created="Thu, 6 Feb 2014 11:57:22 +0000"  >&lt;p&gt;Thanks Daniel. Your patch works fine.&lt;/p&gt;</comment>
                            <comment id="13893567" author="daijy" created="Thu, 6 Feb 2014 17:37:28 +0000"  >&lt;p&gt;Sergey, would you like to update your JsonStorage patch for Null schema handling? That should also applicable.&lt;/p&gt;</comment>
                            <comment id="13893591" author="ssvinarchukhorton" created="Thu, 6 Feb 2014 17:57:00 +0000"  >&lt;p&gt;I updated my patch&lt;/p&gt;</comment>
                            <comment id="13893613" author="daijy" created="Thu, 6 Feb 2014 18:17:31 +0000"  >&lt;p&gt;Hi, Sergey, I think your previous patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3627&quot; title=&quot;Json storage : Doesn&amp;#39;t work in cases , where other Store Functions (like PigStorage / AvroStorage) do work. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3627&quot;&gt;&lt;del&gt;PIG-3627&lt;/del&gt;&lt;/a&gt;.patch) is good, just change the default type to bytearray, plus not use string search for null schema, instead, iterate the field schema to replace null type to bytearray type (verifySchema(s.toString()) -&amp;gt; fixSchema(s).toString()).&lt;/p&gt;</comment>
                            <comment id="13894374" author="ssvinarchukhorton" created="Fri, 7 Feb 2014 10:23:59 +0000"  >&lt;p&gt;Daniel, I updated patch with your recommendation.&lt;/p&gt;</comment>
                            <comment id="13894757" author="daijy" created="Fri, 7 Feb 2014 17:37:26 +0000"  >&lt;p&gt;Patch committed to trunk. Thanks Sergey!&lt;/p&gt;

&lt;p&gt;For the rest part (don&apos;t generate null schema in LOGenerate), I feel more proper to open a new ticket. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12627383" name="PIG-3627-2.patch" size="582" author="ssvinarchukhorton" created="Thu, 6 Feb 2014 17:56:28 +0000"/>
                            <attachment id="12627584" name="PIG-3627-3.patch" size="3334" author="ssvinarchukhorton" created="Fri, 7 Feb 2014 10:22:53 +0000"/>
                            <attachment id="12627313" name="PIG-3627-schemageneration.patch" size="1746" author="daijy" created="Thu, 6 Feb 2014 08:09:41 +0000"/>
                            <attachment id="12627173" name="PIG-3627.patch" size="3816" author="ssvinarchukhorton" created="Wed, 5 Feb 2014 18:24:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 16 Dec 2013 19:06:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>364026</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzklav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>364326</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>