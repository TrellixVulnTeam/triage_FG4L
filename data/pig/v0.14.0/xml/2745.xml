<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:03:29 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2745/PIG-2745.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2745] Pig e2e test RubyUDFs fails in MR mode when running from tarball</title>
                <link>https://issues.apache.org/jira/browse/PIG-2745</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;To reproduce the issue, please run the e2e test &quot;RubyUDFs_1&quot; in MR mode from the tarball (not from installed Pig - please see why below). Either pseudo-distributed-mode or full-mode Hadoop can be used.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant -Dhadoopversion=23 -Dharness.old.pig=`pwd` -Dharness.cluster.conf=/etc/hadoop/conf/ -Dharness.cluster.bin=/usr/lib/hadoop/bin/hadoop test-e2e -Dtests.to.run=&lt;span class=&quot;code-quote&quot;&gt;&quot;-t RubyUDFs_1&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The test fails with the following error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: Could not initialize interpreter (from file system or classpath) with /home/cheolsoo/pig-0.10/test/e2e/pig/testdist/libexec/ruby/scriptingudfs.rb
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the job jar generated by Pig, &quot;scriptingudfs.rb&quot; can be found as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[cheolsoo@c1405 pig-cheolsoo]$ jar tvf bad.jar | grep scriptingudfs.rb
  2491 Fri Jun 08 15:52:08 PDT 2012 /home/cheolsoo/pig-0.10/test/e2e/pig/testdist/libexec/ruby/scriptingudfs.rb
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at getScriptAsStream() method in ScriptEngine.java, &quot;scriptingudfs.rb&quot; is supposed to be read from the job jar, but it is not. The reason is because getResourceAsStream(&quot;/x&quot;) looks for &quot;x&quot; (without the leading &quot;/&quot;) not &quot;/x&quot;. Since &quot;scriptingudfs.rb&quot; is stored with it absolute path, it ends up being not found by getResourceAsStream(scriptPath).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
File file = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(scriptPath);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (file.exists()) {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        is = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(file);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (FileNotFoundException e) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;could not find existing file &quot;&lt;/span&gt;+scriptPath, e);
    }
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (file.isAbsolute()) {
        is = ScriptEngine.class.getResourceAsStream(scriptPath);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        is = ScriptEngine.class.getResourceAsStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt; + scriptPath);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In fact, the test passes if you run in local mode or from installed Pig. The reason is because &quot;scriptingudfs.rb&quot; is found in local file system (e.g /usr/share/pig/test/e2e/pig/udfs/ruby/scriptingudfs.rb).&lt;/p&gt;

&lt;p&gt;The fix seems straightforward. Attached is the patch that removes the leading &quot;/&quot; when registering UDF scripts so that they are stored without the leading &quot;/&quot; in the job jar as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[cheolsoo@c1405 pig-cheolsoo]$ jar tvf good.jar | grep scriptingudfs.rb
  2491 Fri Jun 08 15:52:08 PDT 2012 home/cheolsoo/pig-0.10/test/e2e/pig/testdist/libexec/ruby/scriptingudfs.rb
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12560059">PIG-2745</key>
            <summary>Pig e2e test RubyUDFs fails in MR mode when running from tarball</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Jun 2012 20:19:18 +0100</created>
                <updated>Sun, 6 Jan 2013 23:57:04 +0000</updated>
                            <resolved>Mon, 18 Jun 2012 02:54:01 +0100</resolved>
                                    <version>0.10.1</version>
                                    <fixVersion>0.11</fixVersion>
                    <fixVersion>0.10.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13292415" author="cheolsoo" created="Sat, 9 Jun 2012 20:25:12 +0100"  >&lt;p&gt;I also see the same issue with e2e Scripting tests where Jython UDF scripts are not found in classpath. Applying the change that I described let those test pass as well.&lt;/p&gt;</comment>
                            <comment id="13295862" author="cheolsoo" created="Fri, 15 Jun 2012 20:01:48 +0100"  >&lt;p&gt;I updated the patch to handle not only a leading &quot;/&quot; but also &quot;./&quot;.&lt;/p&gt;

&lt;p&gt;In fact, it is not necessary to worry about &quot;./&quot; since FileLocalizer.fetchFile() already converts relative paths to absolute paths; nevertheless, it seems like a good idea to make this method more robust anyway. &lt;/p&gt;

&lt;p&gt;In addition, I replaced substring(1) with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;replaceFirst(&lt;span class=&quot;code-quote&quot;&gt;&quot;^\\./|^/&quot;&lt;/span&gt;, &quot;&quot;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; because the latter seems more intuitive.&lt;/p&gt;</comment>
                            <comment id="13296047" author="rohini" created="Sat, 16 Jun 2012 01:39:22 +0100"  >&lt;p&gt;+1. Tested this patch with relative path and absolute path for 20.205 and 23. Works fine. &lt;/p&gt;

&lt;p&gt;Daniel,&lt;br/&gt;
   Can you include this in 0.10 also. Without this scripting udfs do not work in 23 for both relative and absolute path. e2e tests currently marked ignored for &lt;a href=&quot;https://issues.apache.org/jira/browse/MAPREDUCE-3700&quot; title=&quot;If a resource in job.jar start with ./, we cannot get it in the backend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAPREDUCE-3700&quot;&gt;MAPREDUCE-3700&lt;/a&gt; also will have to be enabled again. &lt;/p&gt;</comment>
                            <comment id="13393644" author="daijy" created="Mon, 18 Jun 2012 02:47:44 +0100"  >&lt;p&gt;Looks good. I also attach a java code to demonstrate the problem. The patch fix the issue in Ruby. The issue for Python relative path is still there.&lt;/p&gt;</comment>
                            <comment id="13393645" author="daijy" created="Mon, 18 Jun 2012 02:54:01 +0100"  >&lt;p&gt;Patch committed to 0.10/trunk. Thanks Cheolsoo!&lt;/p&gt;</comment>
                            <comment id="13393660" author="cheolsoo" created="Mon, 18 Jun 2012 05:26:56 +0100"  >&lt;p&gt;Hi Daniel, thanks for submitting my patch!&lt;/p&gt;

&lt;p&gt;I am wondering why you think that the issue with relative paths for Python still exists. In my YARN cluster, the Scripting_* tests (excluded due to &lt;a href=&quot;https://issues.apache.org/jira/browse/MAPREDUCE-3700&quot; title=&quot;If a resource in job.jar start with ./, we cannot get it in the backend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAPREDUCE-3700&quot;&gt;MAPREDUCE-3700&lt;/a&gt;) all pass. (Technically, I am using Hadoop-2.0.0, but that shouldn&apos;t make a difference.) I can also manually verify that it works in Grunt shell.&lt;/p&gt;

&lt;p&gt;My fix shouldn&apos;t be Ruby-specific since the problem is with PigServer stuffing any UDF scripts into the job jar.&lt;/p&gt;

&lt;p&gt;Looking at your test code, one thing that I haven&apos;t thought about is &quot;../&quot; although that shouldn&apos;t be an issue now as in the registerCode() method, relative paths are always converted to absolute paths by FileLocalizer.fetchFile(). Nevertheless, handling &quot;../&quot; as well might be a good idea to make that method more robust.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13396965" author="daijy" created="Tue, 19 Jun 2012 19:22:52 +0100"  >&lt;p&gt;Hi, Cheolsoo,&lt;br/&gt;
You are right. This issue is fixed as a byproduct of &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2623&quot; title=&quot;Support S3 paths for registering scripting UDFs. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2623&quot;&gt;&lt;del&gt;PIG-2623&lt;/del&gt;&lt;/a&gt;, which convert the relative path to absolute path. All the Scripting tests pass for hadoop 23 now. I will enable those tests for 23.&lt;/p&gt;

&lt;p&gt;However, there is one another hole left. If we import another python module, Pig cannot pack/refer the path of dependent python module correctly. Here is one example:&lt;/p&gt;

&lt;p&gt;udf.py:&lt;br/&gt;
from base import square&lt;/p&gt;

&lt;p&gt;@outputSchemaFunction(&quot;squaresquareSchema&quot;)&lt;br/&gt;
def squaresquare(num):&lt;br/&gt;
    if num == None:&lt;br/&gt;
        return None&lt;br/&gt;
    return (square(num)*square(num))&lt;/p&gt;

&lt;p&gt;@schemaFunction(&quot;squaresquareSchema&quot;)&lt;br/&gt;
def squaresquareSchema(input):&lt;br/&gt;
    return input&lt;/p&gt;

&lt;p&gt;base.py&lt;br/&gt;
def square(num):&lt;br/&gt;
    if num == None:&lt;br/&gt;
        return None&lt;br/&gt;
    return ((num)*(num))&lt;/p&gt;

&lt;p&gt;Pig script:&lt;br/&gt;
register &apos;udf.py&apos; using jython as myfuncs;&lt;/p&gt;

&lt;p&gt;a = load &apos;1.txt&apos; as (a0:int);&lt;br/&gt;
b = foreach a generate myfuncs.squaresquare(a0);&lt;br/&gt;
dump b;&lt;/p&gt;

&lt;p&gt;Pig incorrectly pack the base.py as /base.py in job.jar, and fail to refer it in backend. It happens in both 20 and 23.&lt;/p&gt;</comment>
                            <comment id="13397039" author="cheolsoo" created="Tue, 19 Jun 2012 21:21:53 +0100"  >&lt;p&gt;Thanks for your explanation, Daniel.&lt;/p&gt;

&lt;p&gt;I will open a new jira and look into that unless someone&apos;s already doing.&lt;/p&gt;

&lt;p&gt;Btw, there is another jira &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2760&quot; title=&quot;resources added with a relative path are added to the JobXXXX jar file under their absolute path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2760&quot;&gt;&lt;del&gt;PIG-2760&lt;/del&gt;&lt;/a&gt; related to the UDF script path. That seems a valid bug as well.&lt;/p&gt;</comment>
                            <comment id="13397052" author="rohini" created="Tue, 19 Jun 2012 21:39:56 +0100"  >&lt;p&gt;Cheolsoo,&lt;br/&gt;
   I am looking into the issue Daniel mentioned. Should have a fix soon. &lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12594935">PIG-2760</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12595165">PIG-2761</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12548752">PIG-2623</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12532228" name="PIG-2745-2.patch" size="669" author="cheolsoo" created="Fri, 15 Jun 2012 20:01:48 +0100"/>
                            <attachment id="12531620" name="PIG-2745.patch" size="668" author="cheolsoo" created="Sun, 10 Jun 2012 23:42:27 +0100"/>
                            <attachment id="12532358" name="Test001.java" size="1884" author="daijy" created="Mon, 18 Jun 2012 02:48:35 +0100"/>
                            <attachment id="12532590" name="enable_scripting_tests_23.patch" size="4880" author="daijy" created="Tue, 19 Jun 2012 19:25:19 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 16 Jun 2012 00:39:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwohz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14456</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>