<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:48:22 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3206/PIG-3206.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3206] HBaseStorage does not work with Oozie pig action and secure HBase</title>
                <link>https://issues.apache.org/jira/browse/PIG-3206</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;HBaseStorage always tries to fetch delegation token for a secure hbase cluster. But when pig is launched through Oozie, it will fail as TGT is not available in the map job. In that case, it should try and reuse the hbase delegation token in JobConf passed to pig through mapreduce.job.credentials.binary property.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12633508">PIG-3206</key>
            <summary>HBaseStorage does not work with Oozie pig action and secure HBase</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 Feb 2013 00:18:02 +0000</created>
                <updated>Mon, 11 Aug 2014 12:21:16 +0100</updated>
                            <resolved>Tue, 26 Feb 2013 14:32:27 +0000</resolved>
                                    <version>0.10.1</version>
                                    <fixVersion>0.12.0</fixVersion>
                    <fixVersion>0.11.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13585902" author="rohini" created="Mon, 25 Feb 2013 14:59:11 +0000"  >&lt;p&gt;Resorted to fetching delegation token only if kerberos credentials are there. Other approach is to to check if the JobConf has delegation token using TokenSelector for that particular hbase cluster and if not fetch the token. But that requires getting the cluster ID of hbase to match the service name and there is no clean API available in hbase to fetch the cluster id. &lt;/p&gt;</comment>
                            <comment id="13586050" author="dvryaboy" created="Mon, 25 Feb 2013 17:57:49 +0000"  >&lt;p&gt;Should we be catching the NoSuchMethodException for all those methods unavailable in 0.92 and 0.20.2? We&apos;ll definitely encounter is on m2.invoke in hadoop 0.20.2, according to the comment. &lt;/p&gt;

&lt;p&gt;Looks like now that the Class.forName line moved into an if block, the corresponding ClassNotFoundException should move in there as well.&lt;/p&gt;

&lt;p&gt;The description in this JIRA says &quot; it should try and reuse the hbase delegation token in JobConf &quot; if the kerberos token is not available. Where does this reuse happen? I am not sure how this patch solves the problem, but then I don&apos;t really know how the kerberos integration in HBaseStorage works in the first place &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;Maybe a test would be helpful?&lt;/p&gt;</comment>
                            <comment id="13586054" author="dvryaboy" created="Mon, 25 Feb 2013 17:59:32 +0000"  >&lt;p&gt;Cancelling patch to clear from review queue (feel free to set patch available if you have a new patch or if this one is sufficient and I am wrong &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;

&lt;p&gt;Should we make the fix apply on 0.11.1 as well?&lt;/p&gt;</comment>
                            <comment id="13586140" author="rohini" created="Mon, 25 Feb 2013 19:00:59 +0000"  >&lt;p&gt;Dmitriy,&lt;br/&gt;
   I had added a comment to clarify in the beginning of the first if block. If there is no security defined in hbase-site.xml, the whole block will not get executed. So we don&apos;t expect the block to be executed with hadoop 0.20.2 or hbase 0.90.x which do not have security. We are using reflection so that when HBaseStorage class compiled against hadoop 1.x but run against 0.20.2 or 0.90.x does not throw NoSuchMethodError for UserGroupInformation methods when executing the addHBaseDelegationToken method.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Looks like now that the Class.forName line moved into an if block, the corresponding ClassNotFoundException should move in there as well.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  ClassNotFoundException happens in the outer if block as well. So not using a separate try catch block for the inner if block. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The description in this JIRA says &quot; it should try and reuse the hbase delegation token in JobConf &quot; if the kerberos token is not available. Where does this reuse happen?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;   Pig in the front end (when run via command line) has access to the user TGT (either keytab or kinit from command line). It fetches the HBase delegation token by authenticating to HBase using KERBEROS and adds it to the JobConf. In the backend, HTable initiation picks up the delegation token from the JobConf and does further operations on HBase using DIGEST authentication. The getDelegationToken call is one call which cannot be done using DIGEST authentication(delegation token). The client always needs to authenticate with Kerberos to get the delegation token. &lt;/p&gt;

&lt;p&gt;   The case with Oozie is that the pig frontend run happens on a mapper and there is no access to user TGT. The JobConf passed to pig (using mapreduce.job.credentials.binary) already has the required delegation tokens to talk to all services - HDFS, JT and HBASE. In HBaseStorage, we were always trying to get the hbase delegation token. Since there was no TGT, it was failing in the pig launcher mapper. Now just added an extra check, so that we don&apos;t try to fetch the token if we don&apos;t have TGT.&lt;/p&gt;

&lt;p&gt;Yes. It would be good to apply this to 0.11.1 as well. I will do it. &lt;/p&gt;

&lt;p&gt;  I will mark it back as patch available if it clarifies your questions. If you need me to add any comments to make it clear, I can do it.&lt;/p&gt;</comment>
                            <comment id="13586306" author="rohini" created="Mon, 25 Feb 2013 21:28:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe a test would be helpful?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  Manually tested with command line and Oozie against secure hbase for now. &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-8078&quot; title=&quot;Add capability to turn on security in unit tests.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-8078&quot;&gt;&lt;del&gt;HADOOP-8078&lt;/del&gt;&lt;/a&gt; which makes security unit tests possible is only available in Hadoop 3.0. &lt;/p&gt;</comment>
                            <comment id="13586468" author="dvryaboy" created="Mon, 25 Feb 2013 23:39:31 +0000"  >&lt;p&gt;got it.&lt;br/&gt;
+1, go ahead and commit.&lt;/p&gt;

&lt;p&gt;D&lt;/p&gt;</comment>
                            <comment id="13587164" author="rohini" created="Tue, 26 Feb 2013 14:32:27 +0000"  >&lt;p&gt;Thanks Dmitriy. Checked into 0.11.1 and trunk. Added a new section in CHANGES.txt for Release 0.11.1.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12570798" name="PIG-3206-1.patch" size="2422" author="rohini" created="Mon, 25 Feb 2013 14:59:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 25 Feb 2013 17:57:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314003</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzc1bz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>