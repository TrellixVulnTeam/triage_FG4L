<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:00:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3844/PIG-3844.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3844] Make ScriptState InheritableThreadLocal for threads that need it</title>
                <link>https://issues.apache.org/jira/browse/PIG-3844</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;I have a PPNL that is forked off the main thread so that its operations does not block pig from continuing to run. This PPNL needs the ScriptState, but is not able to get it in pig13 because the ScriptState is ThreadLocal.&lt;/p&gt;

&lt;p&gt;In pig12, this worked because there was logic to start a new ScriptState on ScriptState.get() which was removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3525&quot; title=&quot;PigStats.get() and ScriptState.get() shouldn&amp;#39;t return MR-specific objects &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3525&quot;&gt;&lt;del&gt;PIG-3525&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://reviews.apache.org/r/15634&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/15634&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;My proposal is to change ScriptState to be InheritableThreadLocal, so that any new child threads that are spawned will have a copy of it. I have a pretty limited understanding of pig, but I do not see anything that this proposed change would break.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12704122">PIG-3844</key>
            <summary>Make ScriptState InheritableThreadLocal for threads that need it</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amatsukawa">Akihiro Matsukawa</assignee>
                                    <reporter username="amatsukawa">Akihiro Matsukawa</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Mar 2014 22:34:19 +0000</created>
                <updated>Mon, 7 Jul 2014 19:07:53 +0100</updated>
                            <resolved>Wed, 2 Apr 2014 00:32:30 +0100</resolved>
                                                    <fixVersion>0.13.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13950065" author="amatsukawa" created="Thu, 27 Mar 2014 22:51:52 +0000"  >&lt;p&gt;Attached patch is the proposed 1 line change.&lt;/p&gt;</comment>
                            <comment id="13950075" author="cheolsoo" created="Thu, 27 Mar 2014 22:59:36 +0000"  >&lt;p&gt;Hi Akihiro, thank you for the patch. &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3525&quot; title=&quot;PigStats.get() and ScriptState.get() shouldn&amp;#39;t return MR-specific objects &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3525&quot;&gt;&lt;del&gt;PIG-3525&lt;/del&gt;&lt;/a&gt; was my change, and sorry for any inconvenience.&lt;/p&gt;

&lt;p&gt;What you propose sounds good to me. Just to be safe, do you mind if I run full unit tests? I can run it overnight.&lt;/p&gt;</comment>
                            <comment id="13950082" author="amatsukawa" created="Thu, 27 Mar 2014 23:03:08 +0000"  >&lt;p&gt;Sure, no problem. I am also running &quot;ant test&quot; as we speak, I&apos;m not quite sure exactly what subtest of tests that runs.&lt;/p&gt;</comment>
                            <comment id="13950089" author="cheolsoo" created="Thu, 27 Mar 2014 23:05:46 +0000"  >&lt;p&gt;Nice. Out of curiosity, do you only need ScriptState to be InheritableThreadLocal? How about PigStats?&lt;/p&gt;</comment>
                            <comment id="13950091" author="cheolsoo" created="Thu, 27 Mar 2014 23:07:40 +0000"  >&lt;p&gt;Actually, answering my question, PigStats might cause problems for embedded mode. I am not sure.&lt;/p&gt;</comment>
                            <comment id="13950097" author="prkommireddi" created="Thu, 27 Mar 2014 23:11:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amatsukawa&quot; class=&quot;user-hover&quot; rel=&quot;amatsukawa&quot;&gt;Akihiro Matsukawa&lt;/a&gt; can you also please add a test case that simulates the custom PPNL behavior? This will ensure any future changes to not break this.&lt;/p&gt;</comment>
                            <comment id="13951104" author="cheolsoo" created="Fri, 28 Mar 2014 17:37:41 +0000"  >&lt;p&gt;I had one failure in my jenkins build, but it seems to be a unrelated and transient error. At rerun, it passed.&lt;/p&gt;

&lt;p&gt;Can you just add a comment explaining why we need InheritableThreadLocal and add a test case like Prashant suggest? Thanks!&lt;/p&gt;</comment>
                            <comment id="13951182" author="amatsukawa" created="Fri, 28 Mar 2014 18:25:42 +0000"  >&lt;p&gt;We have a PPNL that extracts information such as the alias and feature from the ScriptState that runs on a separate thread from the main pig thread, which requires that it inherits a copy of the ThreadLocal object when it is spun off. &lt;/p&gt;

&lt;p&gt;I will add a test and generate a new patch this weekend.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13951211" author="cheolsoo" created="Fri, 28 Mar 2014 18:44:26 +0000"  >&lt;p&gt;Oh I meant a comment in the code in a new patch. Sorry if I wasn&apos;t clear.&lt;/p&gt;</comment>
                            <comment id="13955934" author="amatsukawa" created="Tue, 1 Apr 2014 01:25:32 +0100"  >&lt;p&gt;Actually, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prkommireddi&quot; class=&quot;user-hover&quot; rel=&quot;prkommireddi&quot;&gt;Prashant Kommireddi&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt; I began to write the test to simulate our PPNL, but I realized all it does is call functions MRScriptState.get().getAlias and MRScriptState.getFeature, so the &quot;test&quot; would just be to spin off a new thread and make sure we can call those methods, but it seems like that&apos;s just testing that InheritableThreadLocal works. &lt;/p&gt;

&lt;p&gt;What are your thoughts?&lt;/p&gt;</comment>
                            <comment id="13957106" author="cheolsoo" created="Tue, 1 Apr 2014 23:43:30 +0100"  >&lt;p&gt;Sure. We can safely assume InheritableThreadLocal works. I think the reason why Parshant asked to write a test case was probably because it&apos;s possible for someone who doesn&apos;t know this jira to revert it accidentally. A test case will prevent that. However, if we explicitly add a comment in the code, we should be fine. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prkommireddi&quot; class=&quot;user-hover&quot; rel=&quot;prkommireddi&quot;&gt;Prashant Kommireddi&lt;/a&gt;, do you agree?&lt;/p&gt;</comment>
                            <comment id="13957130" author="prkommireddi" created="Wed, 2 Apr 2014 00:12:01 +0100"  >&lt;p&gt;Sure, works in this case.&lt;/p&gt;

&lt;p&gt;I just want us to make sure API changes have corresponding tests somewhere or backward-incompatibility might go unnoticed in future modifications.&lt;/p&gt;</comment>
                            <comment id="13957139" author="amatsukawa" created="Wed, 2 Apr 2014 00:24:21 +0100"  >&lt;p&gt;Thanks! New patch with comment and reference to JIRA attached.&lt;/p&gt;</comment>
                            <comment id="13957147" author="cheolsoo" created="Wed, 2 Apr 2014 00:32:30 +0100"  >&lt;p&gt;Committed to trunk. Thank you Akihiro!&lt;/p&gt;</comment>
                            <comment id="13957149" author="prkommireddi" created="Wed, 2 Apr 2014 00:35:27 +0100"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amatsukawa&quot; class=&quot;user-hover&quot; rel=&quot;amatsukawa&quot;&gt;Akihiro Matsukawa&lt;/a&gt; for the contribution!&lt;/p&gt;</comment>
                            <comment id="13983518" author="aniket486" created="Mon, 28 Apr 2014 21:47:20 +0100"  >&lt;p&gt;Wouldn&apos;t InheritableThreadLocal copy the reference too? So all the non-primitive reference variables will be shared across the threads, correct?&lt;/p&gt;

&lt;p&gt;In fact, do we need these (ScriptState, PigStats) data structures to be ThreadLocal? It seems these data structures are for saving a state which should be readable across threads. For example, PPNL can run in a separate thread trying to read JobStats from jobGraph, features, aliases for script state.&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12638152" name="PIG-3844.patch" size="883" author="amatsukawa" created="Wed, 2 Apr 2014 00:24:21 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 27 Mar 2014 22:59:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382456</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hznqtj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382725</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>