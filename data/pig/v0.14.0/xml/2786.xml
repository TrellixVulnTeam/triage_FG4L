<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:10:27 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2786/PIG-2786.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2786] enhance Pig launcher script wrt. HBase/HCat integration</title>
                <link>https://issues.apache.org/jira/browse/PIG-2786</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The current bin/pig script suffers from a couple of issues as far as integration with HBase is concerned:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;it only detects ZK/HBase jars under a PIG_HOME/share/.. layout&lt;/li&gt;
	&lt;li&gt;it doesn&apos;t detect HBase dependencies&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The proposal here would be to ask HBase itself for its classpath&lt;/p&gt;</description>
                <environment></environment>
        <key id="12597254">PIG-2786</key>
            <summary>enhance Pig launcher script wrt. HBase/HCat integration</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ndimiduk">Nick Dimiduk</assignee>
                                    <reporter username="rvs">Roman Shaposhnik</reporter>
                        <labels>
                            <label>hbase</label>
                    </labels>
                <created>Tue, 3 Jul 2012 19:33:11 +0100</created>
                <updated>Mon, 14 Oct 2013 17:46:47 +0100</updated>
                            <resolved>Sat, 20 Apr 2013 18:59:44 +0100</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>grunt</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13634247" author="ndimiduk" created="Wed, 17 Apr 2013 18:51:53 +0100"  >&lt;p&gt;This patch looks for &lt;tt&gt;$HBASE_HOME&lt;/tt&gt; and &lt;tt&gt;$HBASE_CONF_DIR&lt;/tt&gt;. If not available, it falls back to &lt;tt&gt;$PIG_HOME/share/hbase&lt;/tt&gt; as before.&lt;/p&gt;</comment>
                            <comment id="13634254" author="ndimiduk" created="Wed, 17 Apr 2013 18:58:47 +0100"  >&lt;p&gt;I decided against invoking &lt;tt&gt;hbase classpath&lt;/tt&gt; because HBase will do it&apos;s own thing to resolve Hadoop jars and dependencies. This way is less invasive; that logic is left to Pig.&lt;/p&gt;</comment>
                            <comment id="13635902" author="daijy" created="Fri, 19 Apr 2013 01:58:32 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;Nick Dimiduk&lt;/a&gt;, I tried your patch, frontend is ok, backend I get&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error: java.lang.ClassNotFoundException: com.google.protobuf.Message
	at java.net.URLClassLoader$1.run(URLClassLoader.java:202)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:190)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:306)
	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:247)
	at org.apache.hadoop.hbase.io.HbaseObjectWritable.&amp;lt;clinit&amp;gt;(HbaseObjectWritable.java:265)
	at org.apache.hadoop.hbase.ipc.Invocation.write(Invocation.java:139)
	at org.apache.hadoop.hbase.ipc.HBaseClient$Connection.sendParam(HBaseClient.java:612)
	at org.apache.hadoop.hbase.ipc.HBaseClient.call(HBaseClient.java:975)
	at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Invoker.invoke(WritableRpcEngine.java:86)
	at $Proxy7.getProtocolVersion(Unknown Source)
	at org.apache.hadoop.hbase.ipc.WritableRpcEngine.getProxy(WritableRpcEngine.java:138)
	at org.apache.hadoop.hbase.ipc.HBaseRPC.waitForProxy(HBaseRPC.java:208)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getHRegionConnection(HConnectionManager.java:1335)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getHRegionConnection(HConnectionManager.java:1294)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getHRegionConnection(HConnectionManager.java:1281)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegionInMeta(HConnectionManager.java:990)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:885)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegionInMeta(HConnectionManager.java:987)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:889)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:846)
	at org.apache.hadoop.hbase.client.HTable.finishSetup(HTable.java:234)
	at org.apache.hadoop.hbase.client.HTable.&amp;lt;init&amp;gt;(HTable.java:174)
	at org.apache.hadoop.hbase.client.HTable.&amp;lt;init&amp;gt;(HTable.java:133)
	at org.apache.hadoop.hbase.mapreduce.TableOutputFormat.setConf(TableOutputFormat.java:201)
	at org.apache.pig.backend.hadoop.hbase.HBaseStorage.getOutputFormat(HBaseStorage.java:843)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputCommitter.getCommitters(PigOutputCommitter.java:89)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputCommitter.&amp;lt;init&amp;gt;(PigOutputCommitter.java:67)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputFormat.getOutputCommitter(PigOutputFormat.java:279)
	at org.apache.hadoop.mapred.Task.initialize(Task.java:515)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:353)
	at org.apache.hadoop.mapred.Child$4.run(Child.java:255)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:396)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1121)
	at org.apache.hadoop.mapred.Child.main(Child.java:249)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue is we need to ship protobuf.jar and zookeeper to the backend. This is through &quot;-Dpig.additional.jars&quot;. &lt;/p&gt;

&lt;p&gt;But ship more jars every time seems adding overhead for non-Hbase Pig jobs unnecessarily. I would suggest either:&lt;br/&gt;
1. Use the flag &quot;-useHBase&quot;, which is similar to &quot;-useHCatalog&quot;&lt;br/&gt;
2. Enrich the LoadFunc/StoreFunc to ship jars automatically if needed&lt;/p&gt;

&lt;p&gt;Prefer #2 since that would solve all similar problems. May need some effort but would benefit in long term.&lt;/p&gt;</comment>
                            <comment id="13635904" author="ndimiduk" created="Fri, 19 Apr 2013 02:01:03 +0100"  >&lt;p&gt;Doesn&apos;t pig ship the jars in the classpath? Why don&apos;t I get this exception when I use the patch?&lt;/p&gt;</comment>
                            <comment id="13635913" author="daijy" created="Fri, 19 Apr 2013 02:13:19 +0100"  >&lt;p&gt;Pig does not automatically ship jars in classpath. Need to put in &quot;-Dpig.additional.jars&quot; or use &quot;register&quot;. Not sure why you didn&apos;t see the error, are you running hbase in distributed mode?&lt;/p&gt;</comment>
                            <comment id="13637010" author="ndimiduk" created="Sat, 20 Apr 2013 00:26:27 +0100"  >&lt;p&gt;I should clarify. This patch fixes the case of Pig interacting with HBase via &lt;tt&gt;org.apache.hcatalog.pig.HCatStorer&lt;/tt&gt; and &lt;tt&gt;org.apache.hcatalog.hbase.HBaseHCatStorageHandler&lt;/tt&gt;. Apparently it is insufficient for using &lt;tt&gt;org.apache.pig.backend.hadoop.hbase.HBaseStorage&lt;/tt&gt; alone. Will investigate further on a separate ticket.&lt;/p&gt;</comment>
                            <comment id="13637015" author="ndimiduk" created="Sat, 20 Apr 2013 00:33:31 +0100"  >&lt;p&gt;Sorry, I didn&apos;t realize I was working on the one-off. Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3285&quot; title=&quot;Jobs using HBaseStorage fail to ship dependency jars&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3285&quot;&gt;&lt;del&gt;PIG-3285&lt;/del&gt;&lt;/a&gt; to track the standard use-case.&lt;/p&gt;</comment>
                            <comment id="13637311" author="daijy" created="Sat, 20 Apr 2013 18:47:36 +0100"  >&lt;p&gt;Took a deeper look. We do ship jars to backend. The magic is in TableMapReduceUtil.addDependencyJars:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
TableMapReduceUtil.addDependencyJars(job.getConfiguration(),
            org.apache.hadoop.hbase.client.HTable.class,
            com.google.common.collect.Lists.class,
            org.apache.zookeeper.ZooKeeper.class)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, we didn&apos;t ship protobuf.jar and it is used in latest hbase. HBaseHCatStorageHandler works because it ship protobuf.jar.&lt;/p&gt;

&lt;p&gt;So with this patch, HBaseHCatStorageHandler works, plus we add right hbase jars in the CLASSPATH (if set HBASE_HOME correctly). For shipping protobuf.jar in HBaseStorage, we will track in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3285&quot; title=&quot;Jobs using HBaseStorage fail to ship dependency jars&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3285&quot;&gt;&lt;del&gt;PIG-3285&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13637316" author="daijy" created="Sat, 20 Apr 2013 18:59:44 +0100"  >&lt;p&gt;Patch committed to trunk. Thanks Nick!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12643728">PIG-3285</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12579164" name="0001-PIG-2786-launch-script-should-locate-HBase.patch" size="1975" author="ndimiduk" created="Wed, 17 Apr 2013 18:51:53 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 17 Apr 2013 17:51:53 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242065</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwcxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12584</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>