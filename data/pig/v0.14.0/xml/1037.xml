<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:56:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1037/PIG-1037.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1037] better memory layout and spill for sorted and distinct bags</title>
                <link>https://issues.apache.org/jira/browse/PIG-1037</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description></description>
                <environment></environment>
        <key id="12438758">PIG-1037</key>
            <summary>better memory layout and spill for sorted and distinct bags</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yinghe">Ying He</assignee>
                                    <reporter username="olgan">Olga Natkovich</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Oct 2009 22:41:38 +0100</created>
                <updated>Wed, 24 Mar 2010 22:15:57 +0000</updated>
                            <resolved>Wed, 28 Oct 2009 16:27:35 +0000</resolved>
                                                    <fixVersion>0.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12768511" author="yinghe" created="Thu, 22 Oct 2009 00:17:52 +0100"  >&lt;p&gt;first cut of patch for initial testing purpose. regression tests are not done yet. It may contain bugs.&lt;/p&gt;</comment>
                            <comment id="12769308" author="yinghe" created="Fri, 23 Oct 2009 18:17:00 +0100"  >&lt;p&gt;fix javac and findbugs warnings&lt;/p&gt;</comment>
                            <comment id="12770206" author="alangates" created="Mon, 26 Oct 2009 21:19:57 +0000"  >&lt;p&gt;Comments:&lt;/p&gt;

&lt;p&gt;In InternalSortedBag.add, you are calculating the average size every time you add a tuple for the first 100 tuples.  Rather than do the calculations every time, wouldn&apos;t it be better wait until you get to 100 tuples then calculate the average?  This would miss the case where you can store less than 100 tuples, but that seems unlikely.&lt;/p&gt;

&lt;p&gt;Some of the comments in InternalSortedBag that were copied over from the previous code, such as dealing with spills in the midst of reading, are no longer true.  They should be removed since they will cause confusion on how the code works.&lt;/p&gt;

&lt;p&gt;I think the synchronized blocks in InternalSortedBag can be removed.  They were there before because spills could be triggered by a separate thread.  Since that is no longer true we should be able to remove these.  This will remove a lock/unlock on every read of a record out of the bag and should provide some speed up.&lt;/p&gt;
</comment>
                            <comment id="12770246" author="yinghe" created="Mon, 26 Oct 2009 22:40:55 +0000"  >&lt;p&gt;Alan, thanks for the feedback.&lt;/p&gt;

&lt;p&gt;For the calculation of average size, I think the cost to calculate 100 times should be very minimal. It shouldn&apos;t be noticeable of any performance impact.  so I&apos;d like to keep it logically correct.  It might be possible of very big tuples, such as those with Map type of fields.  &lt;/p&gt;

&lt;p&gt;For the comments and synchronization, I am going to make the change.&lt;/p&gt;</comment>
                            <comment id="12770570" author="yinghe" created="Tue, 27 Oct 2009 17:02:23 +0000"  >&lt;p&gt;fix the comments and remove synchronization&lt;/p&gt;</comment>
                            <comment id="12770693" author="hadoopqa" created="Tue, 27 Oct 2009 23:08:15 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12423339/PIG-1037.patch3&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12423339/PIG-1037.patch3&lt;/a&gt;&lt;br/&gt;
  against trunk revision 830034.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/116/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/116/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/116/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/116/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/116/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h7.grid.sp2.yahoo.net/116/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12770979" author="alangates" created="Wed, 28 Oct 2009 16:27:34 +0000"  >&lt;p&gt;Patch checked in.  Thanks Ying.&lt;/p&gt;</comment>
                            <comment id="12772410" author="ashutoshc" created="Mon, 2 Nov 2009 03:00:44 +0000"  >&lt;p&gt;I am kinda late on this, but I would appreciate if someone can provide brief description of how this patch improves the memory layout and alleviates the spill problem. I took a quick look at the patch. &lt;br/&gt;
According to my understanding, previously when memory is about to get exhausted Pig will start writing to the disk one tuple at a time. With this new patch, once the memory limit is hit whole bag is spilled to disk, at that point in-memory bag contains no tuples. If in-memory bag fills again, all of its content are spilled to disk in entirety again and so on.. So this patch ensures that we are not spilling one tuple at a time, but a full bag a time. Is this correct or am I missing something ?&lt;/p&gt;</comment>
                            <comment id="12772772" author="alangates" created="Mon, 2 Nov 2009 23:59:02 +0000"  >&lt;p&gt;The difference is much more than switching from dumping one tuple at a time to multiple tuples.  It is about how spilling is activated.  In the past, spilling was passive; it was done when the JVM informed us that memory was getting low.  This did not work well as the JVM only checks memory usage when it garbage collects.  So by the time pig was notified of a low memory condition it was often too late.  We often ran out of memory while trying to spill.  Now instead, spilling is active.  Pig sets aside a buffer for a bag to put its tuples in.  For default bags, once this buffer is full any additional tuples are written to disk.  For sorted or distinct bags, once the buffer is full it is sorted and dumped to disk, and new records go into the buffer.&lt;/p&gt;

&lt;p&gt;This particular patch only adds the change for sorted and distinct bags.  &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-975&quot; title=&quot;Need a databag that does not register with SpillableMemoryManager and spill data pro-actively&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-975&quot;&gt;&lt;del&gt;PIG-975&lt;/del&gt;&lt;/a&gt; contains the original patch for default bags.&lt;/p&gt;</comment>
                            <comment id="12772890" author="ashutoshc" created="Tue, 3 Nov 2009 06:43:37 +0000"  >&lt;p&gt;Thanks for the explanation, Alan. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12422864" name="PIG-1037.patch" size="65605" author="yinghe" created="Thu, 22 Oct 2009 00:17:51 +0100"/>
                            <attachment id="12423033" name="PIG-1037.patch2" size="65923" author="yinghe" created="Fri, 23 Oct 2009 18:17:00 +0100"/>
                            <attachment id="12423339" name="PIG-1037.patch3" size="64069" author="yinghe" created="Tue, 27 Oct 2009 17:02:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 21 Oct 2009 23:17:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164565</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyalsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95841</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>