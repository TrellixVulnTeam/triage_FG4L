<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:48:24 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3204/PIG-3204.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3204] Change script parsing to parse entire script instead of line by line</title>
                <link>https://issues.apache.org/jira/browse/PIG-3204</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;  Currently there are a lot of NN calls made to determine if there is a schema file for a path in a LOAD statement. When there is a slow NN(caused by whole bunch of other issues), it takes a lot of time for this and we found the scripts spending anywhere from 5 mins to 40 mins depending upon the script. It seems to be a good place for optimization. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12633479">PIG-3204</key>
            <summary>Change script parsing to parse entire script instead of line by line</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Feb 2013 22:09:40 +0000</created>
                <updated>Wed, 6 Aug 2014 17:05:37 +0100</updated>
                            <resolved>Thu, 15 Aug 2013 01:44:01 +0100</resolved>
                                    <version>0.10.1</version>
                                    <fixVersion>0.12.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13583600" author="prkommireddi" created="Thu, 21 Feb 2013 22:14:51 +0000"  >&lt;p&gt;Interesting. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt; where exactly are these checks being made?&lt;/p&gt;</comment>
                            <comment id="13583602" author="rohini" created="Thu, 21 Feb 2013 22:15:50 +0000"  >&lt;p&gt;cat log4j.conf&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# ***** Set root logger level to DEBUG and its only appender to A.
log4j.rootLogger=debug, A

# ***** A is set to be a ConsoleAppender.
log4j.appender.A=org.apache.log4j.ConsoleAppender
# ***** A uses PatternLayout.
log4j.appender.A.layout=org.apache.log4j.PatternLayout
log4j.appender.A.layout.ConversionPattern=%d [%t] %-5p %c %x - %m%n
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cat simpleload.pig&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A = LOAD &apos;/tmp/data&apos;;
STORE A into &apos;/tmp/out&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;pig -log4jconf ~/pig/log4j.conf simpleload.pig&lt;/p&gt;

&lt;p&gt;Doing&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sed -n &apos;/Pig features used in the script/,/getDelegationToken/p&apos; /tmp/debug.log | grep getFileInfo | wc -l
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;gives 20 getFileInfo calls if /tmp/data is a directory and 35 calls if /tmp/data is a file. &lt;/p&gt;

&lt;p&gt;grep org.apache.pig.builtin.JsonMetadata /tmp/debug.log gives 10 statements of 2013-02-21 22:04:41,096 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; DEBUG org.apache.pig.builtin.JsonMetadata  - Could not find schema file for /tmp/data&lt;/p&gt;


&lt;p&gt;  Haven&apos;t stepped through the code, but based on the logs seems to be a good candidate for optimization to cut down on the number of FS calls. &lt;/p&gt;
</comment>
                            <comment id="13583639" author="prkommireddi" created="Thu, 21 Feb 2013 22:51:46 +0000"  >&lt;p&gt;Good info, thanks.&lt;/p&gt;</comment>
                            <comment id="13680836" author="rohini" created="Wed, 12 Jun 2013 01:01:23 +0100"  >&lt;p&gt; The problem was that when a script is parsed, there was a registerQuery done for each line by GruntParser which did a parse for that line and the previous lines from the script cache. So if there was a LOAD statement followed by 10 other statements, then the LOAD will be parsed 11 times in registerQuery (which made the calls to getSchema). Added an option to skip that parsing if it is in batch mode. executeBatch() will take care of the parsing. &lt;/p&gt;

&lt;p&gt; This will speedup pig script parsing a lot.&lt;/p&gt;</comment>
                            <comment id="13681416" author="cheolsoo" created="Wed, 12 Jun 2013 18:28:48 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, I find this logic a bit confusing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( batchMode ) {
    ...
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(validateEachStatement){
   validateQuery();
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (batchMode &amp;amp;&amp;amp; !skipParseForBatch) {
   parseQuery();
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( !batchMode ) { 
   parseQuery();
   ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Instead, how about returning early if batchMode &amp;amp;&amp;amp; skipParseForBatch? That is,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( batchMode ) {
    ...
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (skipParseForBatch) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(validateEachStatement){
   validateQuery();
}
parseQuery();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I am assuming that there is no need for validateQuery() when skipping parseQuery().&lt;/p&gt;

&lt;p&gt;Does this make sense?&lt;/p&gt;</comment>
                            <comment id="13681556" author="rohini" created="Wed, 12 Jun 2013 20:40:38 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;&lt;br/&gt;
You are right. validateQuery is not required. Attaching &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3204&quot; title=&quot;Change script parsing to parse entire script instead of line by line&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3204&quot;&gt;&lt;del&gt;PIG-3204&lt;/del&gt;&lt;/a&gt;-2.patch with suggested changes.&lt;/p&gt;</comment>
                            <comment id="13681691" author="cheolsoo" created="Wed, 12 Jun 2013 23:16:40 +0100"  >&lt;p&gt;I have one very minor question. In BoundScript.java, you&apos;re not setting skipParseForBatch in &lt;tt&gt;registerQuery()&lt;/tt&gt; while you&apos;re in &lt;tt&gt;call()&lt;/tt&gt; and &lt;tt&gt;exec()&lt;/tt&gt;. Is this because this particular method is only called by describe/explain/illustrate, and thus, they don&apos;t need this optimization? Or is there another reason why we shouldn&apos;t?&lt;/p&gt;

&lt;p&gt;I found it inconsistent and wanted to clarify. Other than that, looks good to me.&lt;/p&gt;</comment>
                            <comment id="13681728" author="rohini" created="Thu, 13 Jun 2013 00:01:54 +0100"  >&lt;p&gt;Yes. Did not because it was only describe/explain/illustrate. Will check and if there are no problems will add it there too. Actually I have not handled running via PigRunner/Main which is most important. Canceling the patch till I fix that.&lt;/p&gt;</comment>
                            <comment id="13738295" author="rohini" created="Tue, 13 Aug 2013 15:35:01 +0100"  >&lt;p&gt;Patch with whitespace changes. &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3204&quot; title=&quot;Change script parsing to parse entire script instead of line by line&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3204&quot;&gt;&lt;del&gt;PIG-3204&lt;/del&gt;&lt;/a&gt;-3.patch does not have whitespace changes. &lt;/p&gt;</comment>
                            <comment id="13738297" author="rohini" created="Tue, 13 Aug 2013 15:35:20 +0100"  >&lt;p&gt;Review board link - &lt;a href=&quot;https://reviews.apache.org/r/13535/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/13535/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13739902" author="rohini" created="Wed, 14 Aug 2013 18:27:12 +0100"  >&lt;p&gt;Patch with minor comments in review board addressed&lt;/p&gt;</comment>
                            <comment id="13740502" author="rohini" created="Thu, 15 Aug 2013 01:43:52 +0100"  >&lt;p&gt;Got a +1 from Cheolsoo in review board. Committed to trunk (0.12). Thanks Cheolsoo.&lt;/p&gt;</comment>
                            <comment id="14078971" author="guoshiwei" created="Wed, 30 Jul 2014 07:17:50 +0100"  >&lt;p&gt;Is the executeBatch() call in &apos;processDescribe&apos; introduced by this patch necessary&#65311;&lt;br/&gt;
Can it be replaced by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mPigServer.isBatchOn()) {
            mPigServer.parseAndBuild();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;?&lt;/p&gt;

&lt;p&gt;We have a usage case, which may be quite normal, like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
describe aliaseA;
store aliaseA;

describe aliaseB;
store aliaseB;

describe aliaseC;
store aliaseC;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &apos;executeBatch&apos; call in describe make pig have no chance to execute the store operations in parallel and do more optimize.&lt;/p&gt;</comment>
                            <comment id="14087830" author="cheolsoo" created="Wed, 6 Aug 2014 17:05:37 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoshiwei&quot; class=&quot;user-hover&quot; rel=&quot;guoshiwei&quot;&gt;Shiwei Guo&lt;/a&gt;, thank you for reporting the issue. I ran into the same problem myself.&lt;/p&gt;

&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4106&quot; title=&quot;Describe shouldn&amp;#39;t trigger execution in batch mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4106&quot;&gt;&lt;del&gt;PIG-4106&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12732322">PIG-4106</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12587349" name="PIG-3204-1.patch" size="7959" author="rohini" created="Wed, 12 Jun 2013 01:01:23 +0100"/>
                            <attachment id="12587490" name="PIG-3204-2.patch" size="7793" author="rohini" created="Wed, 12 Jun 2013 20:40:38 +0100"/>
                            <attachment id="12597727" name="PIG-3204-3.patch" size="17424" author="rohini" created="Tue, 13 Aug 2013 15:28:23 +0100"/>
                            <attachment id="12597728" name="PIG-3204-4.patch" size="74977" author="rohini" created="Tue, 13 Aug 2013 15:35:01 +0100"/>
                            <attachment id="12597998" name="PIG-3204-5.patch" size="75035" author="rohini" created="Wed, 14 Aug 2013 18:27:12 +0100"/>
                            <attachment id="12598083" name="PIG-3204-6.patch" size="75020" author="rohini" created="Thu, 15 Aug 2013 00:11:32 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 21 Feb 2013 22:14:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313974</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzc15j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314319</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>