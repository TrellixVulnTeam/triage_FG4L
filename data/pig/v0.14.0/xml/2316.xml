<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:47:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2316/PIG-2316.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2316] Incorrect results for FILTER *** BY ( *** OR ***) with FilterLogicExpressionSimplifier optimizer turned on</title>
                <link>https://issues.apache.org/jira/browse/PIG-2316</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;An example for this bug: &lt;/p&gt;

&lt;p&gt;cat weird.txt&lt;br/&gt;
1,a&lt;br/&gt;
2,b&lt;br/&gt;
3,c&lt;/p&gt;

&lt;p&gt;When running pig with the following statements:&lt;/p&gt;

&lt;p&gt;A = LOAD &apos;weird.txt&apos; using PigStorage(&apos;,&apos;) AS (col1:int,col2);&lt;br/&gt;
B = FILTER A BY ((col1==1) OR (col1 != 1));&lt;br/&gt;
DUMP B;&lt;/p&gt;

&lt;p&gt;I expect to get the result of all three rows back, but I receive only two rows.&lt;/p&gt;

&lt;p&gt;(2,b)&lt;br/&gt;
(3,c)&lt;/p&gt;

&lt;p&gt;When we start pig with optimizer turning off.&lt;/p&gt;

&lt;p&gt;pig -optimizer_off All&lt;/p&gt;

&lt;p&gt;With optimizer turning off, we get the expected results and I get three rows for the same statements.&lt;/p&gt;

&lt;p&gt;(1,a)&lt;br/&gt;
(2,b)&lt;br/&gt;
(3,c)&lt;/p&gt;

&lt;p&gt;--------------------------------------------------------&lt;/p&gt;

&lt;p&gt;This bug was test on: &lt;/p&gt;

&lt;p&gt;pig-0.9.1, &lt;br/&gt;
pig-0.9.0, &lt;br/&gt;
pig-0.8.1, &lt;br/&gt;
pig-0.8.0&lt;/p&gt;

&lt;p&gt;All produced same incorrect results.&lt;/p&gt;

&lt;p&gt;--------------------------------------------------------&lt;/p&gt;

&lt;p&gt;When looked at the logical plan for this example, we found FilterlogicExpressionSimplifier optimizer produced incorrect logical plan. So we guess the bug is caused by FilterlogicExpressionSimplifier optimizer. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12526297">PIG-2316</key>
            <summary>Incorrect results for FILTER *** BY ( *** OR ***) with FilterLogicExpressionSimplifier optimizer turned on</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="wenfengbx">Huanyu Zhao</reporter>
                        <labels>
                    </labels>
                <created>Sat, 8 Oct 2011 01:58:54 +0100</created>
                <updated>Wed, 18 Sep 2013 05:10:42 +0100</updated>
                            <resolved>Wed, 12 Oct 2011 00:28:01 +0100</resolved>
                                    <version>0.8.0</version>
                    <version>0.8.1</version>
                    <version>0.9.0</version>
                    <version>0.9.1</version>
                                    <fixVersion>0.9.2</fixVersion>
                    <fixVersion>0.10.0</fixVersion>
                    <fixVersion>0.8.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13123351" author="knoguchi" created="Sat, 8 Oct 2011 03:29:24 +0100"  >&lt;p&gt;Huanyu later discovered that result is only incorrect when both the left variables and the right values are the same.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;((col1==1) OR (col1 != 1));&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Since this is not a common query, lowering priority.&lt;/p&gt;</comment>
                            <comment id="13123639" author="knoguchi" created="Sun, 9 Oct 2011 08:37:01 +0100"  >&lt;p&gt;Our user gave us a more realistic testcase.  &lt;br/&gt;
Looks serious.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
-bash-3.2$ cat weird.txt 
1,a
1,c
2,b
3,c
-bash-3.2$ cat test2.pig 
A = LOAD &apos;weird.txt&apos; using PigStorage(&apos;,&apos;) AS (col1:int,col2);
B = FILTER A BY ((col1==1 AND col2==&apos;c&apos;) OR (col1 != 1));
DUMP B;

-bash-3.2$ pig -x local  test2.pig  
(2,b)
(3,c)
-bash-3.2$
-bash-3.2$ pig -x local  -optimizer_off ALL test2.pig 
(1,c)
(2,b)
(3,c)
-bash-3.2$ 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13123642" author="knoguchi" created="Sun, 9 Oct 2011 08:52:37 +0100"  >&lt;p&gt;It seems like &apos;equals&apos; part is failing inside handleComparison method in LogicalExpressionSimplifier.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;else if (isEqual1 &amp;amp;&amp;amp; isNotEqual2) {
    if (val1.equals(val2)) return Exclusive;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since val1,val2 are ConstantExpression, should it be calling &lt;br/&gt;
  val1.isEqual(val2) &lt;br/&gt;
or&lt;br/&gt;
  val1.getValue().equals(val2.getValue()) ?&lt;/p&gt;

&lt;p&gt;This patch does the latter.  &lt;br/&gt;
(My understanding of pig is very limited so this could be way off.)&lt;/p&gt;
</comment>
                            <comment id="13124470" author="thejas" created="Mon, 10 Oct 2011 22:01:47 +0100"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Applying pig-2316-trunk-v1.txt triggers another bug. For the following filter clause, note that filter plan in MR plan is incomplete.
 

B = FILTER A BY ((col1==1) OR (col1 != 2));

Filter in MR plan - 

B: Store(fakefile:org.apache.pig.builtin.PigStorage) - scope-11
|
|---B: Filter[bag] - scope-7
    |   |
    |   Not Equal To[&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;] - scope-10
    |   |
    |   |---Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-8
    |   |
    |   |---Constant(2) - scope-9
    |
    |---A: New For Each(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)[bag] - scope-6

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;pig-2316-trunk-v2.txt has the fix for this issue.&lt;/p&gt;</comment>
                            <comment id="13124484" author="thejas" created="Mon, 10 Oct 2011 22:25:57 +0100"  >&lt;p&gt;Koji pointed out that the logical transformation in above case is actually correct. Deleting the v2 patch I submitted. &lt;/p&gt;</comment>
                            <comment id="13124488" author="knoguchi" created="Mon, 10 Oct 2011 22:27:23 +0100"  >&lt;p&gt;Resubmitting the original patch since I forgot to grant license on the original one.&lt;/p&gt;</comment>
                            <comment id="13124489" author="thejas" created="Mon, 10 Oct 2011 22:27:24 +0100"  >&lt;p&gt;The LogicalExpressionSimplifier rules are complex and it has a large number of them. This is the fourth bug originating from this optimization rule that causes correctness issues, and that is related to the complexity of this rule. It is hard to understand and maintain this code. I don&apos;t expect these rules to show enough performance gains to justify these costs (complexity, maintainability, chances of bugs).&lt;/p&gt;

&lt;p&gt;I think this rule should be disabled by default in 0.9.next and 0.10. In next versions of pig, we can extract simpler rules from this one and have more exhaustive test coverage before turning it on by default.&lt;/p&gt;</comment>
                            <comment id="13124503" author="viraj" created="Mon, 10 Oct 2011 22:43:05 +0100"  >&lt;p&gt;Thejas, I agree with your comments. I also agree that we should disable this optimization, for the next releases of Pig, since we are getting wrong results without any warnings? At the same time, what is the speedup in script runtime due to this rule? &lt;/p&gt;</comment>
                            <comment id="13124539" author="thejas" created="Mon, 10 Oct 2011 23:35:58 +0100"  >&lt;blockquote&gt;&lt;p&gt;what is the speedup in script runtime due to this rule?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think most queries would not benefit from this optimization rule. Among the one that do, I doubt if there is going to be a noticeable improvement in runtime. I am also not aware of any performance benchmarks that have been done for this rule.&lt;/p&gt;
</comment>
                            <comment id="13124615" author="thejas" created="Tue, 11 Oct 2011 01:47:34 +0100"  >&lt;p&gt;pig-2316-trunk-v3.txt - patch for trunk to have FilterLogicExpressionSimplifier disabled by default. Incorporates Koji&apos;s changes in v1.txt .&lt;/p&gt;</comment>
                            <comment id="13124616" author="thejas" created="Tue, 11 Oct 2011 01:48:10 +0100"  >&lt;p&gt;pig-2316-09-v3.txt - v3 version for 0.9 branch&lt;/p&gt;</comment>
                            <comment id="13124629" author="olgan" created="Tue, 11 Oct 2011 02:00:56 +0100"  >&lt;p&gt;Thejas, we also need a patch for 0.8, thanks&lt;/p&gt;</comment>
                            <comment id="13125221" author="thejas" created="Tue, 11 Oct 2011 18:44:51 +0100"  >&lt;p&gt;pig-2316-08-v3.txt - patch for 0.8 branch&lt;/p&gt;</comment>
                            <comment id="13125389" author="olgan" created="Tue, 11 Oct 2011 22:04:20 +0100"  >&lt;p&gt;+1 on the pateches.&lt;/p&gt;

&lt;p&gt;The name that we are using to specify exclusion rules (optimizerRules) is confusing but we do not need to fix it in this patch&lt;/p&gt;</comment>
                            <comment id="13125401" author="thejas" created="Tue, 11 Oct 2011 22:27:22 +0100"  >&lt;p&gt;unit tests passed for 0.9 branch. patch committed to 0.9 branch. Running tests for 0.8 branch and trunk.&lt;/p&gt;</comment>
                            <comment id="13125478" author="thejas" created="Wed, 12 Oct 2011 00:28:01 +0100"  >&lt;p&gt;tests passed. patch committed to 0.8 branch and trunk as well.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12669181">PIG-3465</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12498630" name="pig-2316-08-v3.txt" size="9251" author="thejas" created="Tue, 11 Oct 2011 18:44:51 +0100"/>
                            <attachment id="12498497" name="pig-2316-09-v3.txt" size="8016" author="thejas" created="Tue, 11 Oct 2011 01:48:10 +0100"/>
                            <attachment id="12498473" name="pig-2316-trunk-v1.txt" size="4351" author="knoguchi" created="Mon, 10 Oct 2011 22:27:23 +0100"/>
                            <attachment id="12498496" name="pig-2316-trunk-v3.txt" size="7991" author="thejas" created="Tue, 11 Oct 2011 01:47:34 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 8 Oct 2011 02:29:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>50555</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyawn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97599</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>FilterLogicExpressionSimplifier optimization rule is disabled by default. To enable the optimization rule, set the property pig.exec.filterLogicExpressionSimplifier to true.&lt;br/&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>