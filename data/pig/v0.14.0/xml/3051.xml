<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:01:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3051/PIG-3051.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3051] java.lang.IndexOutOfBoundsException  failure with LimitOptimizer + ColumnPruning</title>
                <link>https://issues.apache.org/jira/browse/PIG-3051</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Had a user hitting &lt;br/&gt;
&quot;Caused by: java.lang.IndexOutOfBoundsException: Index: 1, Size: 1&quot; error when he had multiple stores and limit in his code.&lt;/p&gt;

&lt;p&gt;I couldn&apos;t reproduce this with short pig code (due to ColumnPruning somehow not happening when shortened), but here&apos;s a snippet. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
G3 = FOREACH G2 GENERATE sortCol, FLATTEN(group) as label, (long)COUNT(G1) as cnt;
G4 = ORDER G3 BY cnt DESC PARALLEL 25;
ONEROW = LIMIT G4 1;
U1 = FOREACH ONEROW GENERATE 3 as sortcol, &apos;somelabel&apos; as label, cnt;
store U1 into &apos;u1&apos; using PigStorage();
store G4 into &apos;g4&apos; using PigStorage();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With &apos;-t ColumnMapKeyPrune&apos;, job didn&apos;t hit the error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12616267">PIG-3051</key>
            <summary>java.lang.IndexOutOfBoundsException  failure with LimitOptimizer + ColumnPruning</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Nov 2012 17:21:31 +0000</created>
                <updated>Fri, 22 Feb 2013 04:53:48 +0000</updated>
                            <resolved>Thu, 27 Dec 2012 22:12:46 +0000</resolved>
                                    <version>0.10.0</version>
                    <version>0.11</version>
                                    <fixVersion>0.11</fixVersion>
                    <fixVersion>0.12.0</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13498150" author="knoguchi" created="Thu, 15 Nov 2012 17:23:20 +0000"  >&lt;p&gt;Stack dump from task failure using trunk&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-11-09 22:45:09,484 WARN [main] org.apache.hadoop.mapred.YarnChild:
Exception running child : org.apache.pig.backend.executionengine.ExecException:
ERROR 0: Error while executing ForEach at []
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POForEach.getNext(POForEach.java:306)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:308)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POLimit.getNext(POLimit.java:117)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:308)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POLocalRearrange.getNext(POLocalRearrange.java:263)
    at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.processOnePackageOutput(PigCombiner.java:185)
    at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.reduce(PigCombiner.java:163)
    at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.reduce(PigCombiner.java:51)
    at org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:170) at org.apache.hadoop.mapred.Task$NewCombinerRunner.combine(Task.java:1615)
    at org.apache.hadoop.mapred.MapTask$MapOutputBuffer.sortAndSpill(MapTask.java:1567)
    at org.apache.hadoop.mapred.MapTask$MapOutputBuffer.flush(MapTask.java:1416)
    at org.apache.hadoop.mapred.MapTask$NewOutputCollector.close(MapTask.java:663)
    at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:730)
    at org.apache.hadoop.mapred.MapTask.run(MapTask.java:332)
    at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:157)
    at java.security.AccessController.doPrivileged(Native Method)
    at javax.security.auth.Subject.doAs(Subject.java:396)
    at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1212)
    at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:152)
Caused by: java.lang.IndexOutOfBoundsException: Index: 1, Size: 1
    at java.util.ArrayList.RangeCheck(ArrayList.java:547)
    at java.util.ArrayList.get(ArrayList.java:322)
    at org.apache.pig.data.DefaultTuple.get(DefaultTuple.java:116)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPackage.getValueTuple(POPackage.java:345)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPackageLite.getValueTuple(POPackageLite.java:198)
    at org.apache.pig.data.ReadOnceBag$ReadOnceBagIterator.next(ReadOnceBag.java:241)
    at org.apache.pig.data.ReadOnceBag$ReadOnceBagIterator.next(ReadOnceBag.java:222)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POForEach.processPlan(POForEach.java:440)
    at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POForEach.getNext(POForEach.java:298)
    ... 19 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13498157" author="billgraham" created="Thu, 15 Nov 2012 17:28:27 +0000"  >&lt;p&gt;We&apos;ve seen similar exceptions when loading data that contains text with the column delimiter in it, which produces shorter than expected tuples. Could that be the case here?&lt;/p&gt;</comment>
                            <comment id="13498165" author="knoguchi" created="Thu, 15 Nov 2012 17:48:28 +0000"  >&lt;p&gt;Tracking the LogicalPlan change.&lt;/p&gt;

&lt;p&gt;Original.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;U1: (Name: LOStore Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
|
|---U1: (Name: LOForEach Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
    |   |
    |   (Name: LOGenerate[false,false,false] Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
    |   |   |
    |   |   (Name: Constant Type: int Uid: 1871)
    |   |   |
    |   |   (Name: Constant Type: chararray Uid: 1872)
    |   |   |
    |   |   cnt:(Name: Project Type: long Uid: 1870 Input: 0 Column: (*))
    |   |
    |   |---(Name: LOInnerLoad[2] Schema: cnt#1870:long)
    |   *****HERE*****
    |---ONEROW: (Name: LOLimit Schema: sortCol#1868:int,label#1869:chararray,cnt#1870:long)
        |
        |---G4: (Name: LOSplitOutput Schema: sortCol#1868:int,label#1869:chararray,cnt#1870:long)
            |   |
            |   (Name: Constant Type: boolean Uid: 1867)
            |
            |---G4: (Name: LOSplit Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
                |
                |---G4: (Name: LOSort Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
                    |   |
                    |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: 2)
                    |
                    |---G3: (Name: LOForEach Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
                        |   |
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After org.apache.pig.newplan.logical.rules.LimitOptimizer&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;U1: (Name: LOStore Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
|
|---U1: (Name: LOForEach Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
    |   |
    |   (Name: LOGenerate[false,false,false] Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
    |   |   |
    |   |   (Name: Constant Type: int Uid: 1871)
    |   |   |
    |   |   (Name: Constant Type: chararray Uid: 1872)
    |   |   |
    |   |   cnt:(Name: Project Type: long Uid: 1870 Input: 0 Column: (*))
    |   |
    |   |---(Name: LOInnerLoad[2] Schema: cnt#1870:long)
    |
    |---(Name: LOSort Schema: sortCol#1868:int,label#1869:chararray,cnt#1870:long)
        |   | *****HERE*****
        |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: 2)
        |
        |---G4: (Name: LOSplitOutput Schema: sortCol#1868:int,label#1869:chararray,cnt#1870:long)
            |   |
            |   (Name: Constant Type: boolean Uid: 1867)
            |
            |---G4: (Name: LOSplit Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
                |
                |---G4: (Name: LOSort Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
                    |   |
                    |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: 2)
                    |
                    |---G3: (Name: LOForEach Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After org.apache.pig.newplan.logical.rules.ColumnMapKeyPrune,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;U1: (Name: LOStore Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
|
|---U1: (Name: LOForEach Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
    |   |
    |   (Name: LOGenerate[false,false,false] Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)
    |   |   |
    |   |   (Name: Constant Type: int Uid: 1871)
    |   |   |
    |   |   (Name: Constant Type: chararray Uid: 1872)
    |   |   |
    |   |   cnt:(Name: Project Type: long Uid: 1870 Input: 0 Column: (*))
    |   |
    |   |---(Name: LOInnerLoad[2] Schema: cnt#1870:long)
    |
    |---(Name: LOSort Schema: sortCol#1868:int,label#1869:chararray,cnt#1870:long)
        |   | 
        |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: 2)
        |
        |---G4: (Name: LOSplitOutput Schema: sortCol#1868:int,label#1869:chararray,cnt#1870:long)
            |   |
            |   (Name: Constant Type: boolean Uid: 1867)
            |
            |---G4: (Name: LOSplit Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
                |
                |---G4: (Name: LOSort Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
                    |   |
                    |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: 2)
                    |
                    |---G3: (Name: LOForEach Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13498166" author="knoguchi" created="Thu, 15 Nov 2012 17:51:50 +0000"  >&lt;p&gt;Sorry, After ColumnMapKeyPrune, I pasted the wrong one. Here&apos;s the one after Pruning.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;U1: (Name: LOStore Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)ColumnPrune:InputUids=[1870, 1871, 1872]ColumnPrune:OutputUids=[1870, 1871, 1872]
|
|---U1: (Name: LOForEach Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)ColumnPrune:InputUids=[1870]ColumnPrune:OutputUids=[1870, 1871, 1872]
    |   |
    |   (Name: LOGenerate[false,false,false] Schema: sortCol#1871:int,label#1872:chararray,cnt#1870:long)ColumnPrune:InputUids=[1870]ColumnPrune:OutputUids=[1870, 1871, 1872]
    |   |   |
    |   |   (Name: Constant Type: int Uid: 1871)
    |   |   |
    |   |   (Name: Constant Type: chararray Uid: 1872)
    |   |   |
    |   |   cnt:(Name: Project Type: long Uid: 1870 Input: 0 Column: (*))
    |   |
    |   |---(Name: LOInnerLoad[0] Schema: cnt#1870:long)
    |
    |---(Name: LOSort Schema: cnt#1870:long)ColumnPrune:InputUids=[1865, 1870]ColumnPrune:OutputUids=[1870]
        |   |  *****HERE*****
        |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: ***2***)
        |
        |---G4: (Name: LOSplitOutput Schema: cnt#1870:long)ColumnPrune:InputUids=[1865]ColumnPrune:OutputUids=[1870]
            |   |
            |   (Name: Constant Type: boolean Uid: 1867)
            |
            |---(Name: LOForEach Schema: cnt#1865:long)
                |   |
                |   (Name: LOGenerate[false] Schema: cnt#1865:long)
                |   |   |
                |   |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: (*))
                |   |
                |   |---(Name: LOInnerLoad[2] Schema: cnt#1865:long)
                |
                |---G4: (Name: LOSplit Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)ColumnPrune:InputUids=[1864, 1865, 1857]ColumnPrune:OutputUids=[1864, 1865, 1857]
                    |
                    |---G4: (Name: LOSort Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)ColumnPrune:InputUids=[1864, 1865, 1857]ColumnPrune:OutputUids=[1864, 1865, 1857]
                        |   |
                        |   cnt:(Name: Project Type: long Uid: 1865 Input: 0 Column: 2)
                        |
                        |---G3: (Name: LOForEach Schema: sortCol#1864:int,label#1857:chararray,cnt#1865:long)ColumnPrune:InputUids=[1857, 1862]ColumnPrune:OutputUids=[1864, 1865, 1857]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I believe the new LOSort introduced by the LimitOptimizer has the projection pointing to the previous LOSOrt which breaks when columns are pruned and column index is not being updated.&lt;/p&gt;</comment>
                            <comment id="13498185" author="knoguchi" created="Thu, 15 Nov 2012 18:10:27 +0000"  >&lt;p&gt;There must be a better way/method than this but I hope the patch shows what I&apos;m thinking.&lt;/p&gt;

&lt;p&gt;I&apos;m trying to redirect all the ProjectExpression inside the newSort to point to the newSort instead of the original Sort.&lt;/p&gt;

&lt;p&gt;After the patch, ColumnPruning successfully updates the column to &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    |---(Name: LOSort Schema: cnt#1870:long)ColumnPrune:InputUids=[1870]ColumnPrune:OutputUids=[1870]
        |   |
        |   cnt:(Name: Project Type: long Uid: 1870 Input: 0 Column: 0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13498190" author="knoguchi" created="Thu, 15 Nov 2012 18:14:42 +0000"  >&lt;p&gt;Sorry, I missed Bill&apos;s comment.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We&apos;ve seen similar exceptions when loading data that contains text with the column delimiter in it, which produces shorter than expected tuples. Could that be the case here?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think that&apos;s the case here.  However, I&apos;ve made many silly mistakes&amp;amp;misunderstandings in pig before.  Let me double check.&lt;/p&gt;</comment>
                            <comment id="13499345" author="knoguchi" created="Sat, 17 Nov 2012 04:20:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;I couldn&apos;t reproduce this with short pig code (due to ColumnPruning somehow not happening when shortened), &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Learned that columnprune does not kick in unless there is column-or-map to prune inside load. (even though columnprune does more than just pruning at the load part.)&lt;/p&gt;

&lt;p&gt;By adding one extra line to force columnpruning, i was able to reproduce this issue.  First example hitting IndexOutOfBoundsException and second one producing incorrect result.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;% cat test/pig-3051-1.pig 
A = load &apos;a.txt&apos; using PigStorage() as (a1:chararray, a2:chararray, a3:chararray, a4:chararray);
B = foreach A generate a2,a3,a4;  --to force columnprune algo to cover
G = order B by a4;
U1 = limit G 3;
U2 = foreach U1 generate a4;
store G into &apos;g&apos; using PigStorage();
store U2 into &apos;u2&apos; using PigStorage(); 
% cat a.txt
1       2       3       4
2       3       4       1
3       4       1       2
4       1       2       3
% pig -x local test/pig-3051-1.pig 
...
fails with Caused by: java.lang.IndexOutOfBoundsException: Index: 1, Size: 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now adding extra 2 columns, job finishes but result incorrect.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;% cat test/pig-3051-2.pig 
A = load &apos;b.txt&apos; using PigStorage() as (a1:chararray, a2:chararray, a3:chararray, a4:chararray, a5:chararray, a6:chararray);
B = foreach A generate a2,a3,a4,a5,a6;  --to force columnprune algo to cover
G = order B by a4;
U1 = limit G 4;
U2 = foreach U1 generate a4,a5,a6;
store G into &apos;g&apos; using PigStorage();
store U2 into &apos;u2&apos; using PigStorage(); 
% cat b.txt 
1       2       3       4       5       6
2       3       4       5       6       1
3       4       5       6       1       2
4       5       6       1       2       3
5       6       1       2       3       4
6       1       2       3       4       5
% pig -x local test/pig-3051-2.pig 
...
success
% cat u2/part-r-00000 
5       6       1
6       1       2
1       2       3
2       3       4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And last, taking out store G (to take out LOSplit).  This produces a correct output.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;% cat test/pig-3051-3.pig A = load &apos;b.txt&apos; using PigStorage() as (a1:chararray, a2:chararray, a3:chararray, a4:chararray, a5:chararray, a6:chararray);
B = foreach A generate a2,a3,a4,a5,a6;  --to force columnprune algo to cover
G = order B by a4;
U1 = limit G 4;
U2 = foreach U1 generate a4,a5,a6;
--store G into &apos;g&apos; using PigStorage();
store U2 into &apos;u2&apos; using PigStorage(); 

% pig -x local test/pig-3051-3.pig 
... Success.

% cat u2/part-r-00000 
1       2       3
2       3       4
3       4       5
4       5       6
% 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also tested the patch(pig-3051-v1-withouttest.txt) and it does fix the incorrect result case.&lt;/p&gt;</comment>
                            <comment id="13504206" author="knoguchi" created="Mon, 26 Nov 2012 22:50:04 +0000"  >&lt;p&gt;Added an e2e test since I needed columnprune + limitoptimizer.  Let me know if unit test is better for this.&lt;/p&gt;

&lt;p&gt;Also, appreciate if someone can take a look at my fix since this issue can lead to incorrect output.&lt;/p&gt;</comment>
                            <comment id="13504211" author="knoguchi" created="Mon, 26 Nov 2012 22:55:16 +0000"  >&lt;p&gt;Requesting for 0.11 if possible. (it&apos;s not a regression in 0.10&amp;amp;0.11 but result can get incorrect due to this.)&lt;/p&gt;</comment>
                            <comment id="13534028" author="rohini" created="Mon, 17 Dec 2012 16:11:22 +0000"  >&lt;p&gt;  Resetting the attached LOSort operator of the ProjectExpression to the newSort is good. But found an issue with the copy not setting the label, type and Uid.  &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testPIG3051() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] input = {
                &lt;span class=&quot;code-quote&quot;&gt;&quot;1,2,3,4&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;2,3,4,1&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;3,4,1,2&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;4,1,2,3&quot;&lt;/span&gt;
        };

        Util.createLocalInputFile( &lt;span class=&quot;code-quote&quot;&gt;&quot;a.txt&quot;&lt;/span&gt;, input);
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; query = &lt;span class=&quot;code-quote&quot;&gt;&quot;A =load &apos;a.txt&apos; using PigStorage(&apos;,&apos;) as (a1:chararray, a2:chararray, a3:chararray, a4:chararray);&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;B = foreach A generate a2,a3,a4;&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;G = order B by a4;&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;U1 = limit G 3;&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;U2 = foreach U1 generate a4;&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;store G into &apos;g&apos; using PigStorage();&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;store U2 into &apos;u2&apos; using PigStorage(); &quot;&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            PigServer pigServer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PigServer(ExecType.LOCAL);
            pigServer.registerQuery(query);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            e.printStackTrace();
        }
        
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;sort.mSortColPlans - a4:(Name: Project Type: chararray Uid: 4 Input: 0 Column: 2)&lt;br/&gt;
newSort.mSortColPlans - (Name: Project Type: null Uid: null Input: 0 Column: 2)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13537177" author="knoguchi" created="Thu, 20 Dec 2012 17:27:49 +0000"  >&lt;p&gt;Thanks Rohini for the review. &lt;/p&gt;

&lt;p&gt;bq .But found an issue with the copy not setting the label, type and Uid.&lt;/p&gt;

&lt;p&gt;I wasn&apos;t sure why my test worked even when the above fields were not set. Turns out that they are filled by the SchemaPatcher.&lt;/p&gt;

&lt;p&gt;LimitOptimizer.reportChanges() simply returns currentPlan, so SchemaPatcher goes through the entire currentPlan including the newSort.mSortColPlans mentioned and update them accordingly.&lt;/p&gt;

&lt;p&gt;BTW, reading back my patch, I felt that logic of making a new copy of LOSort should be kept inside LOSort.java.  Uploading a new version.  Logic is same from the previous patch.&lt;/p&gt;</comment>
                            <comment id="13540187" author="rohini" created="Thu, 27 Dec 2012 22:12:46 +0000"  >&lt;p&gt;+1. Ran the unit tests, new e2e test and committed to branch 0.11 and trunk. Thanks Koji. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12553667" name="pig-3051-v1-withouttest.txt" size="3261" author="knoguchi" created="Thu, 15 Nov 2012 18:10:27 +0000"/>
                            <attachment id="12554929" name="pig-3051-v1.1-withe2etest.txt" size="5261" author="knoguchi" created="Mon, 26 Nov 2012 22:50:04 +0000"/>
                            <attachment id="12561941" name="pig-3051-v2.1-withe2etest.txt" size="5511" author="knoguchi" created="Thu, 20 Dec 2012 17:27:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 15 Nov 2012 17:28:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>258025</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyegmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>118390</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>