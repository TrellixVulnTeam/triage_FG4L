<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:59:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3295/PIG-3295.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3295] Casting from bytearray failing after Union (even when each field is from a single Loader)</title>
                <link>https://issues.apache.org/jira/browse/PIG-3295</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;One example&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;A = load &apos;data1.txt&apos; as line:bytearray;
B = load &apos;c1.txt&apos; using TextLoader() as cookie1;
C = load &apos;c2.txt&apos; using TextLoader() as cookie2;
B2 = join A by line, B by cookie1;
C2 = join A by line, C by cookie2;
D = union onschema B2,C2; -- D: {A::line: bytearray,B::cookie1: bytearray,C::cookie2: bytearray}
E = foreach D generate (chararray) line, (chararray) cookie1, (chararray) cookie2;
dump E;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This script fails at runtime with &lt;br/&gt;
&quot;Caused by: org.apache.pig.backend.executionengine.ExecException: ERROR 1075: Received a bytearray from the UDF. Cannot determine how to convert the bytearray to string.&quot;&lt;/p&gt;

&lt;p&gt;This is different from &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3293&quot; title=&quot;Casting fails after Union from two data sources&amp;amp;loaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3293&quot;&gt;&lt;del&gt;PIG-3293&lt;/del&gt;&lt;/a&gt; such that each field in &apos;D&apos; belongs to a single loader whereas on &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3293&quot; title=&quot;Casting fails after Union from two data sources&amp;amp;loaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3293&quot;&gt;&lt;del&gt;PIG-3293&lt;/del&gt;&lt;/a&gt;, it came from multiple loader.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12644449">PIG-3295</key>
            <summary>Casting from bytearray failing after Union (even when each field is from a single Loader)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Apr 2013 22:30:06 +0100</created>
                <updated>Mon, 7 Jul 2014 19:07:53 +0100</updated>
                            <resolved>Wed, 30 Oct 2013 15:28:34 +0000</resolved>
                                                    <fixVersion>0.13.0</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13642166" author="knoguchi" created="Thu, 25 Apr 2013 21:20:50 +0100"  >&lt;p&gt;Attaching an initial patch.&lt;br/&gt;
Instead of having one FuncSpec per LOUnion (&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2493&quot; title=&quot;UNION causes casting issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2493&quot;&gt;&lt;del&gt;PIG-2493&lt;/del&gt;&lt;/a&gt;), checking each field and setting different FuncSpec when possible.&lt;/p&gt;</comment>
                            <comment id="13642170" author="knoguchi" created="Thu, 25 Apr 2013 21:22:25 +0100"  >&lt;p&gt;Forgot to mention, I didn&apos;t fix &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3293&quot; title=&quot;Casting fails after Union from two data sources&amp;amp;loaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3293&quot;&gt;&lt;del&gt;PIG-3293&lt;/del&gt;&lt;/a&gt; case but updated the error message to indicate it could be from Union with multiple loaders.  &lt;/p&gt;</comment>
                            <comment id="13756774" author="knoguchi" created="Tue, 3 Sep 2013 17:51:26 +0100"  >&lt;p&gt;Just noticed my previous patch wasn&apos;t created with &apos;--no-prefix&apos; option. Reattaching.&lt;/p&gt;</comment>
                            <comment id="13758291" author="daijy" created="Wed, 4 Sep 2013 21:24:18 +0100"  >&lt;p&gt;How about doing more aggressively by checking LoadCaster?&lt;/p&gt;</comment>
                            <comment id="13759189" author="knoguchi" created="Thu, 5 Sep 2013 17:08:42 +0100"  >&lt;blockquote&gt;&lt;p&gt;How about doing more aggressively by checking LoadCaster?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That was my first approach, but as I also wrote in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3293&quot; title=&quot;Casting fails after Union from two data sources&amp;amp;loaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3293&quot;&gt;&lt;del&gt;PIG-3293&lt;/del&gt;&lt;/a&gt;, &lt;br/&gt;
&quot;Figuring out if the loaders were same was easy with calling &apos;equals&apos; for the FuncSpec. I don&apos;t know how to achieve this easily for comparing casters.&quot;&lt;/p&gt;</comment>
                            <comment id="13759222" author="daijy" created="Thu, 5 Sep 2013 17:55:09 +0100"  >&lt;p&gt;Oh, sorry not notice that. Can we instantiate the LoadFunc (with parameters) and then compare?&lt;/p&gt;</comment>
                            <comment id="13759228" author="knoguchi" created="Thu, 5 Sep 2013 18:06:50 +0100"  >&lt;blockquote&gt;&lt;p&gt;Can we instantiate the LoadFunc (with parameters) and then compare?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Possible, but I can only compare the classnames?  For the funcspec comparisons, we&apos;re comparing the classname as well as the parameters passed to the constructors.&lt;/p&gt;</comment>
                            <comment id="13759247" author="daijy" created="Thu, 5 Sep 2013 18:31:02 +0100"  >&lt;p&gt;Your concern is valid, comparing classname is not sufficient in theory. But I really want to make Utf8StorageConverter compatible, which might solve most problem. How about we make one exception in the case LoadCaster has only default construct?&lt;/p&gt;</comment>
                            <comment id="13760297" author="knoguchi" created="Fri, 6 Sep 2013 17:00:57 +0100"  >&lt;blockquote&gt;&lt;p&gt;How about we make one exception in the case LoadCaster has only default construct?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you mean, make an exception only for Utf8StorageConverter, that makes sense since we have full control over the class and we know that classname check is sufficient for equality.  Let me try coming up with a new patch.&lt;/p&gt;</comment>
                            <comment id="13760506" author="daijy" created="Fri, 6 Sep 2013 19:43:32 +0100"  >&lt;p&gt;To make it clearer, I mean if the class name for LoadCaster are the same, and LoadCaster only has default construct, then two LoadCasters are equal. This covers Utf8StorageConverter.&lt;/p&gt;</comment>
                            <comment id="13763623" author="knoguchi" created="Tue, 10 Sep 2013 23:24:43 +0100"  >&lt;p&gt;Attaching a patch which includes Daniel&apos;s suggestion on comparing the LoadCaster (and limiting to ones with default constructors only).&lt;/p&gt;

&lt;p&gt;Haven&apos;t run full test yet.&lt;/p&gt;</comment>
                            <comment id="13764819" author="daijy" created="Wed, 11 Sep 2013 22:40:59 +0100"  >&lt;p&gt;+1. Will commit if tests pass.&lt;/p&gt;</comment>
                            <comment id="13767035" author="knoguchi" created="Fri, 13 Sep 2013 23:05:02 +0100"  >&lt;p&gt;Thanks Daniel.  &lt;/p&gt;

&lt;p&gt;I just bumped into &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2699&quot; title=&quot;Reduce the number of instances of Load and Store Funcs down to 2+1. It should be 1 in the front-end and 1 in the backend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2699&quot;&gt;&lt;del&gt;PIG-2699&lt;/del&gt;&lt;/a&gt; where &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=julienledem&quot; class=&quot;user-hover&quot; rel=&quot;julienledem&quot;&gt;Julien Le Dem&lt;/a&gt; reduced the number of Loader&amp;amp;Storer instantiations.  I&apos;m afraid he won&apos;t be happy with my current patch.  Let me see if I can reuse the Loader instance from somewhere.&lt;/p&gt;</comment>
                            <comment id="13768076" author="daijy" created="Mon, 16 Sep 2013 06:35:26 +0100"  >&lt;p&gt;Or unless a tie, we don&apos;t instantiate a LoadFunc. I also see several NPE in LineageFindRelVisitor.java:115 in the unit tests.&lt;/p&gt;</comment>
                            <comment id="13768720" author="knoguchi" created="Mon, 16 Sep 2013 21:32:38 +0100"  >&lt;blockquote&gt;&lt;p&gt;Or unless a tie, we don&apos;t instantiate a LoadFunc. I also see several NPE in LineageFindRelVisitor.java:115 in the unit tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Uploading a patch that delays the instantiation of LoadFunc.  Also added extra check to avoid NPE.  Running unit tests.&lt;/p&gt;</comment>
                            <comment id="13768723" author="knoguchi" created="Mon, 16 Sep 2013 21:33:46 +0100"  >&lt;p&gt;Waiting for my unit tests to pass on the new patch.&lt;/p&gt;</comment>
                            <comment id="13774677" author="knoguchi" created="Mon, 23 Sep 2013 17:12:36 +0100"  >&lt;p&gt;Testcase in my last patch (v04) wasn&apos;t able to find the inner test class. Resolving that and also added a check to make sure Loader is not instantiated more than necessary.&lt;/p&gt;</comment>
                            <comment id="13774776" author="knoguchi" created="Mon, 23 Sep 2013 18:49:16 +0100"  >&lt;p&gt;On my environment, somehow seeing Unittest failures even before my patch.  I&apos;ll look at them later but now I do see that my last patch added many failures in  TestTypeCheckingValidatorNewLP.  Since we relaxed the Lineage condition,  loader info can propagate further.&lt;/p&gt;

&lt;p&gt;Just to clarify, before &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Loader classname and parameter had to match&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With the patch, it&apos;ll be &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Loader classname and parameter match&lt;br/&gt;
OR &lt;/li&gt;
	&lt;li&gt;classname of the caster instantiated from the loader matches and it has only a default constructor.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13775741" author="knoguchi" created="Mon, 23 Sep 2013 23:46:15 +0100"  >&lt;blockquote&gt;&lt;p&gt;but now I do see that my last patch added many failures in TestTypeCheckingValidatorNewLP. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Looking at the test, I see that it&apos;s checking how the Loader info propagate or won&apos;t propagate.  It&apos;s using &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;PigStorage(&apos;a&apos;)&lt;br/&gt;
and&lt;/li&gt;
	&lt;li&gt;PigStorage(&apos;b&apos;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;to represent two different Loader.  However, with my patch, these are now considered equal since they both use the Utf8StorageConverter.&lt;/p&gt;

&lt;p&gt;In most of the testcases, I replaced PigStorage(&apos;b&apos;) to org.apache.pig.test.PigStorageWithDifferentCaster(&apos;b&apos;) so that testcase would have two distinct loadcasters.&lt;/p&gt;

&lt;p&gt;For testcase testCogroupStarLineageFail and testCogroupStarLineageNoSchemaFail, I kept the PigStorage since the exception is thrown even with a single loader.&lt;/p&gt;

&lt;p&gt;For testCogroupStreamingLineageNoSchema, I changed the expectedResult since now PigStorage and PigStreaming both uses the same loadcaster, Utf8StorageConverter.&lt;/p&gt;
</comment>
                            <comment id="13777011" author="daijy" created="Wed, 25 Sep 2013 01:53:29 +0100"  >&lt;p&gt;+1.&lt;/p&gt;</comment>
                            <comment id="13808227" author="knoguchi" created="Tue, 29 Oct 2013 17:49:02 +0000"  >&lt;p&gt;Finally got most of the e2e running on my environment.  My last patch introduced one failure in LineageErrors where it was grepping for the error message.  Updated the expected error message.&lt;/p&gt;

&lt;p&gt;Since rest of the patch is reviewed with +1,  I&apos;ll commit this patch to trunk tomorrow.&lt;/p&gt;</comment>
                            <comment id="13809220" author="knoguchi" created="Wed, 30 Oct 2013 15:28:34 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt; for your helpful feedback!&lt;br/&gt;
Committed to trunk. &lt;/p&gt;</comment>
                            <comment id="13810355" author="knoguchi" created="Thu, 31 Oct 2013 15:46:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;Committed to trunk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;FYI, my initial commit was missing 2 files I added as part of the patch.  This resulted in about 30 failing unit tests in TestTypeCheckingValidatorNewLP.  Added them now.  Sorry for the trouble.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12644379">PIG-3293</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12580573" name="pig-3295-v01.patch" size="20041" author="knoguchi" created="Thu, 25 Apr 2013 21:20:50 +0100"/>
                            <attachment id="12601186" name="pig-3295-v02.patch" size="20009" author="knoguchi" created="Tue, 3 Sep 2013 17:51:26 +0100"/>
                            <attachment id="12602441" name="pig-3295-v03.patch" size="36149" author="knoguchi" created="Tue, 10 Sep 2013 23:24:43 +0100"/>
                            <attachment id="12603421" name="pig-3295-v04.patch" size="35232" author="knoguchi" created="Mon, 16 Sep 2013 21:32:38 +0100"/>
                            <attachment id="12604616" name="pig-3295-v05.patch" size="34661" author="knoguchi" created="Mon, 23 Sep 2013 17:12:36 +0100"/>
                            <attachment id="12604686" name="pig-3295-v06.patch" size="63669" author="knoguchi" created="Mon, 23 Sep 2013 23:46:15 +0100"/>
                            <attachment id="12610878" name="pig-3295-v07.patch" size="64396" author="knoguchi" created="Tue, 29 Oct 2013 17:49:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 4 Sep 2013 20:24:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>324816</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzdw1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325162</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Before, LoadCaster after Union was only available when two union-ed relations were from the same Loader with same parameters.  Now, LoadCaster would work for cases when Loaders return the same LoadCaster that only have a default constructor.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>