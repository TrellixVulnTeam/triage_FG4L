<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:01:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2973/PIG-2973.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2973] TestStreaming test times out</title>
                <link>https://issues.apache.org/jira/browse/PIG-2973</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description></description>
                <environment></environment>
        <key id="12611888">PIG-2973</key>
            <summary>TestStreaming test times out</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12611880">PIG-2972</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Oct 2012 20:52:14 +0100</created>
                <updated>Fri, 22 Feb 2013 04:53:34 +0000</updated>
                            <resolved>Wed, 31 Oct 2012 18:00:01 +0000</resolved>
                                    <version>0.11</version>
                                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13480305" author="cheolsoo" created="Fri, 19 Oct 2012 20:43:35 +0100"  >&lt;p&gt;This is a regression from &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2900&quot; title=&quot;Streaming should provide conf settings in the environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2900&quot;&gt;&lt;del&gt;PIG-2900&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What&apos;s happening is that the sub-process spawned by ExecutableManager crashes with a NullPointerException at the following line in addJobConfToEnvironment() because conf is null:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; propsToSend = conf.get(PIG_STREAMING_ENVIRONMENT);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The reason why conf is null is because UDFContext returns null for jobConf on the front-end.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Get the JobConf.  This should only be called on
 * the backend.  It will &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; on the frontend.
 * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; JobConf &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; job.  This is a copy of the
 * JobConf.  Nothing written here will be kept by the system.
 * getUDFConf should be used &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; recording UDF specific
 * information.
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Configuration getJobConf() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (jconf != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration(jconf);
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In fact, I am surprised that the exec() of ExecutableManager is called on the front-end. But I am able to confirm that it&apos;s on the front-end by printing out the output of UDFContext#isFrontend().&lt;/p&gt;

&lt;p&gt;Attached is a patch that checks whether conf is null or not inside addJobConfToEnvironment() and returns if it&apos;s on the front-end. After applying the patch, TestStreaming now passes.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13480349" author="cheolsoo" created="Fri, 19 Oct 2012 21:17:06 +0100"  >&lt;p&gt;To reproduce the issue munually, please download the tarball (test.tar.gz) that I am attaching. It include 3 files: script.pl, test.pig, and data. Now run in trunk the following command:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
pig -x local test.pig
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will fail with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
===== Task Information Header =====
Command: script.pl foo (foo-PigStreaming/stdout-PigStreaming)
Start time: Fri Oct 19 13:09:38 PDT 2012
Input-split file: file:/home/cheolsoo/workspace/pig-trunk/data
Input-split start-offset: 0
Input-split length: 40
=====          * * *          =====
===== Task Information Footer =====
End time: Fri Oct 19 13:09:38 PDT 2012
Exit code: -127
Input records: 6
Input bytes: 960 bytes (foo using PigStreaming)
Output records: 0
Output bytes: 0 bytes (stdout using PigStreaming)
=====          * * *          =====
2012-10-19 13:09:38,123 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-12] ERROR org.apache.pig.impl.streaming.ExecutableManager - java.lang.NullPointerException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Actually, my description in the previous comment wasn&apos;t correct since it&apos;s not the sub-process but the ExecutableManager thread that crashes.&lt;/p&gt;

&lt;p&gt;With the attached patch, this will succeed.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13480859" author="daijy" created="Sun, 21 Oct 2012 01:10:57 +0100"  >&lt;p&gt;Looks good. Rohini, did you apply the patch and test it works?&lt;/p&gt;</comment>
                            <comment id="13481026" author="rohini" created="Sun, 21 Oct 2012 20:14:46 +0100"  >&lt;p&gt;Daniel,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Rohini, did you apply the patch and test it works?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Tests pass. But wondering if we are missing a bigger problem because on debugging found that UDFContext.getJobConf() is returning null in backend and not frontend. &lt;/p&gt;

&lt;p&gt;Cheolsoo,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In fact, I am surprised that the exec() of ExecutableManager is called on the front-end. But I am able to confirm that it&apos;s on the front-end by printing out the output of UDFContext#isFrontend().&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  I put a breakpoint there and it never got executed in the frontend. It is actually happening in the backend and the NPE is actually in syslog (under build/test/logs/userlogs) of the job. The stack trace after adding the logging statement is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.Throwable
        at org.apache.pig.impl.streaming.ExecutableManager.addJobConfToEnvironment(ExecutableManager.java:242)
        at org.apache.pig.impl.streaming.ExecutableManager.setupEnvironment(ExecutableManager.java:216)
        at org.apache.pig.impl.streaming.ExecutableManager.exec(ExecutableManager.java:310)
        at org.apache.pig.backend.hadoop.streaming.HadoopExecutableManager.exec(HadoopExecutableManager.java:124)
        at org.apache.pig.impl.streaming.ExecutableManager.close(ExecutableManager.java:135)
        at org.apache.pig.backend.hadoop.streaming.HadoopExecutableManager.close(HadoopExecutableManager.java:129)
        at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:407)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;  I am not that familiar with streaming. But from a cursory look, I am guessing that the second command in the pipeline (which is launched from a separate thread at the close of first one) might not be getting the env set correctly as the conf is null (UDFContext is threadlocal and UDFContext.addJobConf() not called for this thread).  I think we need to investigate this more and understand the effect of conf being null. &lt;/p&gt;</comment>
                            <comment id="13481070" author="cheolsoo" created="Sun, 21 Oct 2012 22:04:49 +0100"  >&lt;p&gt;Hi Rohini,&lt;/p&gt;

&lt;p&gt;Thanks a lot for investigating it further. I was simply believing the comment of getJobConf(), and it sounds like it&apos;s not true! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; In fact, I was silly because isFroneend() will return true as long as conf is null, so it doesn&apos;t really tell us anything.&lt;/p&gt;

&lt;p&gt;I totally agree with you that we should understand better.&lt;/p&gt;
</comment>
                            <comment id="13481095" author="cheolsoo" created="Mon, 22 Oct 2012 00:43:37 +0100"  >&lt;p&gt;Now I have a better explanation.&lt;/p&gt;

&lt;p&gt;If input to the streaming binary is from a file, a new thread (ProcessInputThread) is spawned, and exec() is called in that child thread. The problem is that the UDFContext of the parent thread is not copied to the child thread, so jobConf is null in that child thread.&lt;/p&gt;

&lt;p&gt;I can verify this by comparing the following two test cases:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;input from a file.&lt;/li&gt;
	&lt;li&gt;input from stdin.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I only see the failure in case 1.&lt;/p&gt;

&lt;p&gt;I am going to update my patch as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Copy the UDFContext to the ProcessInputThread when input type is asynchronous (i.e. input is from a file).&lt;/li&gt;
	&lt;li&gt;Add a test case to verify environment variables are set correctly even when input type is asynchronous.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13481212" author="cheolsoo" created="Mon, 22 Oct 2012 07:46:59 +0100"  >&lt;p&gt;Updating the patch. Now UdfContext is copied from the ExecutableManager thread to the FileInputThread when input is asynchronous, so JobConf is no longer null when the exec() is called by the FileInputThread.&lt;/p&gt;

&lt;p&gt;In addition, I added a new unit test case that verifies that JobConf is added to environment even when input is asynchronous. TestStreaming including the new test case passes with hadoop 20/23.&lt;/p&gt;

&lt;p&gt;I also removed tabs and tailing white spaces, so it&apos;s probably easier to review it in the RB: &lt;a href=&quot;https://reviews.apache.org/r/7695/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/7695/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13483854" author="cheolsoo" created="Thu, 25 Oct 2012 04:21:51 +0100"  >&lt;p&gt;Updating the patch with no whitespace changes.&lt;/p&gt;</comment>
                            <comment id="13487229" author="jcoveney" created="Tue, 30 Oct 2012 20:56:50 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Good job, Cheolsoo. Also, in the test you added, in RB, I noticed one instance of trailing whitespace &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13487284" author="cheolsoo" created="Tue, 30 Oct 2012 21:56:11 +0000"  >&lt;p&gt;Removing a trailing white space. Thanks Jon for catching that. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13488021" author="cheolsoo" created="Wed, 31 Oct 2012 18:00:01 +0000"  >&lt;p&gt;Thanks Jon for reviewing the patch! Committed to 0.11/trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12611890">PIG-2974</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12550251" name="PIG-2973-2.patch" size="54935" author="cheolsoo" created="Mon, 22 Oct 2012 07:46:59 +0100"/>
                            <attachment id="12550739" name="PIG-2973-3.patch" size="7303" author="cheolsoo" created="Thu, 25 Oct 2012 04:21:51 +0100"/>
                            <attachment id="12551422" name="PIG-2973-4.patch" size="7310" author="cheolsoo" created="Tue, 30 Oct 2012 21:56:11 +0000"/>
                            <attachment id="12550063" name="PIG-2973.patch" size="704" author="cheolsoo" created="Fri, 19 Oct 2012 20:43:35 +0100"/>
                            <attachment id="12550067" name="test.tar.gz" size="515" author="cheolsoo" created="Fri, 19 Oct 2012 21:17:06 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 19 Oct 2012 19:43:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248800</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy3ulj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56281</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>