<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:11:25 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-4241/PIG-4241.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-4241] Auto local mode mistakenly converts large jobs to local mode when using with Hive tables</title>
                <link>https://issues.apache.org/jira/browse/PIG-4241</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The current implementation of auto local mode has two severe problems-&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;It assumes file-based inputs, and it always converts jobs with non-file-based inputs into local mode unless the &lt;tt&gt;LoadMetadata.getStatistics().getSizeInBytes()&lt;/tt&gt; returns &amp;gt;100M. This is particularly problematic when using Pig with Hive tables with custom LoadFuncs that did not implement LoadMetadata interface.&lt;/li&gt;
	&lt;li&gt;It lists all the files to compute the total size. The algorithm is like this. First, compute the total size. Second, compare it against the configured max bytes. This is very time-consuming when Pig job loads a large number of files. It will list all the files only to compute the total size. Instead, we should stop computing the sum of input sizes as soon as it becomes the max bytes-
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;JobControlCompiler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; totalInputFileSize = InputSizeReducerEstimator.getTotalInputFileSize(conf, lds, job); &lt;span class=&quot;code-comment&quot;&gt;// THIS IS BAD!
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; inputByteMax = conf.getLong(PigConfiguration.PIG_AUTO_LOCAL_INPUT_MAXBYTES, 100*1000*1000l);
log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Size of input: &quot;&lt;/span&gt; + totalInputFileSize +&lt;span class=&quot;code-quote&quot;&gt;&quot; bytes. Small job threshold: &quot;&lt;/span&gt; + inputByteMax );
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (totalInputFileSize &amp;lt; 0 || totalInputFileSize &amp;gt; inputByteMax) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12748777">PIG-4241</key>
            <summary>Auto local mode mistakenly converts large jobs to local mode when using with Hive tables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Oct 2014 01:49:11 +0100</created>
                <updated>Fri, 21 Nov 2014 05:59:20 +0000</updated>
                            <resolved>Mon, 27 Oct 2014 17:13:15 +0000</resolved>
                                                    <fixVersion>0.14.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14175475" author="cheolsoo" created="Fri, 17 Oct 2014 21:03:49 +0100"  >&lt;p&gt;Attached patch includes the following changes-&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When Hive table name is interpreted as a hdfs file, &lt;tt&gt;globStatus()&lt;/tt&gt; returns null. In this case, &lt;tt&gt;InputSizeReducerEstimator.getTotalInputFileSize()&lt;/tt&gt; returns -1 now. Therefore, big jobs with Hive table input do not get converted to local mode.&lt;/li&gt;
	&lt;li&gt;Max parameter is add to &lt;tt&gt;InputSizeReducerEstimator.getTotalInputFileSize()&lt;/tt&gt;. Now when it computes the total input size recursively, it exits as soon as it reaches the max. This helps avoid listing all the files to determine whether the job can be converted to local mode or not.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14181884" author="cheolsoo" created="Thu, 23 Oct 2014 21:18:28 +0100"  >&lt;p&gt;Fixed &lt;tt&gt;TestInputSizeReducerEstimator&lt;/tt&gt; in a new patch.&lt;/p&gt;</comment>
                            <comment id="14183432" author="daijy" created="Fri, 24 Oct 2014 21:38:27 +0100"  >&lt;p&gt;Does all non-file-based job convert to auto local mode? If so, let&apos;s put the fix also in 0.14. Can you add a comment to explain the method parameter max in getPathLength and getTotalInputFileSize?&lt;/p&gt;</comment>
                            <comment id="14184664" author="cheolsoo" created="Sun, 26 Oct 2014 21:04:39 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Does all non-file-based job convert to auto local mode?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not all but many. The issue is that not all LoadFuncs implement &lt;tt&gt;getSizeInBytes()&lt;/tt&gt;, and even if they do, this method works on a best effort basis. When it is not implemented or returns null, &lt;tt&gt;getTotalInputFileSize()&lt;/tt&gt; returns 0 for Hive tables because they&apos;re mis-interpreted as HDFS file paths. Then, auto local mode thinks the size of the input path is 0 bytes, and thus, it is runnable in local mode. As a result, big jobs run in local mode filling up local disk on gateways (Genie nodes).&lt;/p&gt;

&lt;p&gt;I updated the patch adding comments about the &lt;tt&gt;max&lt;/tt&gt; parameter.&lt;/p&gt;</comment>
                            <comment id="14185399" author="daijy" created="Mon, 27 Oct 2014 17:01:42 +0000"  >&lt;p&gt;+1. And let&apos;s put the patch to 0.14 branch as well.&lt;/p&gt;</comment>
                            <comment id="14185427" author="cheolsoo" created="Mon, 27 Oct 2014 17:13:15 +0000"  >&lt;p&gt;Thank you Daniel for reviewing. Committed to 0.14 and trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12675564" name="PIG-4241-1.patch" size="6351" author="cheolsoo" created="Fri, 17 Oct 2014 21:03:49 +0100"/>
                            <attachment id="12676703" name="PIG-4241-2.patch" size="5462" author="cheolsoo" created="Thu, 23 Oct 2014 21:18:28 +0100"/>
                            <attachment id="12677205" name="PIG-4241-3.patch" size="6795" author="cheolsoo" created="Sun, 26 Oct 2014 21:04:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 24 Oct 2014 20:38:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzv56v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>