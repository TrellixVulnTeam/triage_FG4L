<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:07:18 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2014/PIG-2014.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2014] SAMPLE shouldn&apos;t be pushed up</title>
                <link>https://issues.apache.org/jira/browse/PIG-2014</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Consider the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
tfidf_all = LOAD &apos;$TFIDF&apos; AS (doc_id:chararray, token:chararray, weight:double);
grouped   = GROUP tfidf_all BY doc_id;
vectors   = FOREACH grouped GENERATE group AS doc_id, tfidf_all.(token, weight) AS vector;
DUMP vectors;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This, of course, runs just fine. In a real example, tfidf_all contains 1,428,280 records. The reduce output records should be exactly the number of documents, which turn out to be 18,863 in this case. All well and good.&lt;/p&gt;

&lt;p&gt;The strangeness comes when you add a SAMPLE command:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
sampled = SAMPLE vectors 0.0012;
DUMP sampled;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running this results in 1,513 reduce output records. The reduce output records be much much closer to 22 or 23 records (eg. 0.0012*18863).&lt;/p&gt;

&lt;p&gt;Evidently, Pig rewrites SAMPLE into filter, and then pushes that filter in front of the group. It shouldn&apos;t push that filter  &lt;br/&gt;
since the UDF is non-deterministic.  &lt;/p&gt;

&lt;p&gt;Quick fix: If you add &quot;-t PushUpFilter&quot; to your command line when invoking pig this won&apos;t happen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12505198">PIG-2014</key>
            <summary>SAMPLE shouldn&apos;t be pushed up</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dvryaboy">Dmitriy V. Ryaboy</assignee>
                                    <reporter username="thedatachef">Jacob Perkins</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Apr 2011 15:35:38 +0100</created>
                <updated>Thu, 4 Aug 2011 01:34:56 +0100</updated>
                            <resolved>Thu, 12 May 2011 11:01:28 +0100</resolved>
                                    <version>0.9.0</version>
                    <version>0.10.0</version>
                                    <fixVersion>0.9.0</fixVersion>
                    <fixVersion>0.10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13025345" author="dvryaboy" created="Tue, 26 Apr 2011 18:55:49 +0100"  >&lt;p&gt;Proposal for a general-case fix:&lt;/p&gt;

&lt;p&gt;add a @Nondeterministic annotation for UDFs, have the PushUpFilter check whether the udf is deterministic or not when considering whether pushing up is ok.  Annotate the filter UDF that sample is rewritten to, accordingly.&lt;/p&gt;</comment>
                            <comment id="13031045" author="dvryaboy" created="Tue, 10 May 2011 07:24:28 +0100"  >&lt;p&gt;Implemented suggested approach to fixing this. Please review.&lt;/p&gt;</comment>
                            <comment id="13031047" author="dvryaboy" created="Tue, 10 May 2011 07:26:57 +0100"  >&lt;p&gt;Since this is a bug it should go into 0.9.&lt;/p&gt;

&lt;p&gt;Then again since it&apos;s sort of a new feature maybe not and we should just check for RANDOM specifically in 0.9? &lt;/p&gt;

&lt;p&gt;For my part I don&apos;t see the harm in the annotation and would prefer that it goes into 0.9.&lt;/p&gt;</comment>
                            <comment id="13031422" author="daijy" created="Tue, 10 May 2011 23:26:19 +0100"  >&lt;p&gt;I think this is more a bug fix, should go into 0.9. &lt;/p&gt;

&lt;p&gt;However, the script will trigger rule FilterAboveForeach not PushUpFilter. So the patch does not fix the problem. The fix should go to all these rules: PushUpFilter, PushDownForEachFlatten, FilterAboveForeach.&lt;/p&gt;</comment>
                            <comment id="13031439" author="dvryaboy" created="Tue, 10 May 2011 23:40:22 +0100"  >&lt;p&gt;I&apos;ll add to the other rules &amp;#8211; but for the record, I looked at the plan and saw the sample not being pushed up after my patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="13031447" author="daijy" created="Tue, 10 May 2011 23:54:03 +0100"  >&lt;p&gt;I think it is because in TestNewPlanFilterAboveForeach, we only invoke some of the rules. If you do an explain, you will see filter still pushed up.&lt;/p&gt;</comment>
                            <comment id="13031730" author="dvryaboy" created="Wed, 11 May 2011 15:26:49 +0100"  >&lt;p&gt;Daniel,&lt;br/&gt;
So this is interesting. I took my fix out, left the test in, and the test still passed &amp;#8211; because, as you correctly pointed out, TestNewPlanFilterAboveForeach only invokes a few of the rules. If I add PushUpFilter to MyPlanOptimizer within that test, my new test starts failing if the fix is not present, and passes if the fix is present. So the PushUpFilter is definitely at least part of what&apos;s causing the movement of Filter in this case.&lt;/p&gt;

&lt;p&gt;So I need to fix up PushDownForEachFlatten and FilterAboveForeach, &lt;b&gt;and&lt;/b&gt; I need to fix my test &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="13031783" author="dvryaboy" created="Wed, 11 May 2011 16:31:39 +0100"  >&lt;p&gt;This addresses PushUpFilter and FilterAboveForeach, and fixes the SAMPLE issue.&lt;/p&gt;

&lt;p&gt;I didn&apos;t tackle PushDownForeachFlatten &amp;#8211; there&apos;s a lot going on there and I&apos;m not sure I understand it all. We should open a separate ticket for making sure that optimization does not break on nondeterministic operations.&lt;/p&gt;</comment>
                            <comment id="13032287" author="daijy" created="Thu, 12 May 2011 08:23:25 +0100"  >&lt;p&gt;+1 for &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2014&quot; title=&quot;SAMPLE shouldn&amp;#39;t be pushed up&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2014&quot;&gt;&lt;del&gt;PIG-2014&lt;/del&gt;&lt;/a&gt;.2.patch.&lt;/p&gt;

&lt;p&gt;I will submit another patch for PushDownForeachFlatten.&lt;/p&gt;</comment>
                            <comment id="13032290" author="daijy" created="Thu, 12 May 2011 08:40:46 +0100"  >&lt;p&gt;Also change filterHasNonDeterministicUdf to planHasNonDeterministicUdf. I can reuse it in PushDownForeachFlatten.&lt;/p&gt;</comment>
                            <comment id="13032299" author="daijy" created="Thu, 12 May 2011 08:58:54 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2014&quot; title=&quot;SAMPLE shouldn&amp;#39;t be pushed up&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2014&quot;&gt;&lt;del&gt;PIG-2014&lt;/del&gt;&lt;/a&gt;.3.patch address PushDownFlattenForEach&lt;/p&gt;</comment>
                            <comment id="13032329" author="dvryaboy" created="Thu, 12 May 2011 10:47:40 +0100"  >&lt;p&gt;Attaching combined final version, complete with the renamed method.&lt;/p&gt;</comment>
                            <comment id="13032331" author="dvryaboy" created="Thu, 12 May 2011 10:51:54 +0100"  >&lt;p&gt;An unrelated change snuck into the previously attached file; this is what I am actually committing.&lt;/p&gt;</comment>
                            <comment id="13032336" author="dvryaboy" created="Thu, 12 May 2011 11:01:28 +0100"  >&lt;p&gt;committed to 0.9 and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12511192">PIG-2137</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12478831" name="PIG-2014.2.patch" size="11022" author="dvryaboy" created="Wed, 11 May 2011 16:31:39 +0100"/>
                            <attachment id="12478939" name="PIG-2014.3.patch" size="2322" author="daijy" created="Thu, 12 May 2011 08:58:54 +0100"/>
                            <attachment id="12478947" name="PIG-2014.4.patch" size="38688" author="dvryaboy" created="Thu, 12 May 2011 10:47:40 +0100"/>
                            <attachment id="12478948" name="PIG-2014.5.patch" size="32302" author="dvryaboy" created="Thu, 12 May 2011 10:51:54 +0100"/>
                            <attachment id="12478672" name="PIG-2014.patch" size="6855" author="dvryaboy" created="Tue, 10 May 2011 07:24:28 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 26 Apr 2011 17:55:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41697</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyav2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97346</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>A new annotation, @Nondeterministic, is introduced to allow UDF authors to mark their UDFs as such. &lt;br/&gt;
&lt;br/&gt;
A non-deterministic UDF is one that can produce different results when invoked on the same input. Examples of non-deterministic behavior might be, for example, getCurrentTime() or RANDOM.&lt;br/&gt;
&lt;br/&gt;
Certain Pig optimizations depend on UDFs being deterministic. It is therefore very important for correctness that non-deterministic UDFs be annotated as such. &lt;br/&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>