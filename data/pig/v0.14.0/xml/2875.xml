<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:50:09 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2875/PIG-2875.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2875] Add recursive record support to AvroStorage</title>
                <link>https://issues.apache.org/jira/browse/PIG-2875</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Currently, AvroStorage does not allow recursive records in Avro schema because it is not possible to define Pig schema for recursive records. (i.e. records that have self-referencing fields cause an infinite loop, so they are not supported.)&lt;/p&gt;

&lt;p&gt;Even though there is no natural way of handling recursive records in Pig schema, I&apos;d like to propose the following workaround: mapping recursive records to bytearray.&lt;/p&gt;

&lt;p&gt;Take for example the following Avro schema:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;record&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;RECURSIVE_RECORD&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;fields&quot;&lt;/span&gt; : [ {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt; ]
  }, {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;RECURSIVE_RECORD&quot;&lt;/span&gt; ]
  } ]
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the following data:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;RECURSIVE_RECORD&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;:2,&lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;RECURSIVE_RECORD&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;:3,&lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}}}}} 
{&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;:2,&lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;RECURSIVE_RECORD&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;:3,&lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}}} 
{&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;:3,&lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, we can define Pig schema as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{value: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,next: bytearray}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Even though Pig thinks that the &quot;next&quot; fields are bytearray, they&apos;re actually loaded as tuples since AvroStorage uses Avro schema when loading files.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
grunt&amp;gt; in = LOAD &apos;test_recursive_schema.avro&apos; USING org.apache.pig.piggybank.storage.avro.AvroStorage ();
grunt&amp;gt; dump in;
(1,(2,(3,)))
(2,(3,))
(3,)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point, we have discrepancy between Avro schema and Pig schema; nevertheless, we can still refer to each field of tuples as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
grunt&amp;gt; first = FOREACH in GENERATE $0;
grunt&amp;gt; dump first;
(1)
(2)
(3)

or

grunt&amp;gt; second = FOREACH in GENERATE $1.$0;
grunt&amp;gt; dump second;
(2)
(3)
()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Lastly, we can store these tuples as Avro files by specifying schema. Since we can no longer construct Avro schema from Pig schema, it is required for the user to provide Avro schema via the &apos;schema&apos; parameter in STORE function.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
grunt&amp;gt; STORE first INTO &apos;output&apos; USING org.apache.pig.piggybank.storage.avro.AvroStorage ( &apos;schema&apos;, &apos;[ &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt; ]&apos; );

or

grunt&amp;gt; STORE in INTO &apos;output&apos; USING org.apache.pig.piggybank.storage.avro.AvroStorage ( &apos;schema&apos;, &apos;
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;record&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;recursive_schema&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;fields&quot;&lt;/span&gt; : [ { 
    &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt; ]
  }, {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;next&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;recursive_schema&quot;&lt;/span&gt; ]
  } ] 
}
&apos; );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To implement this workaround, the following work is required:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Update the current generic union check so that it can handle recursive records. Currently, AvroStorage checks if the Avro schema contains 1) recursive records and 2) generic unions, and fails if so. But since I am going to remove the 1st check, the 2nd check should be able to handle recursive records without stack overflow.&lt;/li&gt;
	&lt;li&gt;Update AvroSchema2Pig so that recursive records can be detected and mapped to bytearrays in Pig schema.&lt;/li&gt;
	&lt;li&gt;Add the &apos;no_schema_check&apos; parameter to STORE function so that results can be stored even though there exists discrepancy between Avro schema and Pig schema. Since Avro schema for STORE function cannot be constructed from Pig schema, it has to be specified by the user via the &apos;schema&apos; parameter, and schema check has to be disabled by &apos;no_schema_check&apos;.&lt;/li&gt;
	&lt;li&gt;Update AvroStorage wiki.&lt;/li&gt;
	&lt;li&gt;Add unit tests.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I do not think that any incompatibility issues will be introduced by this.&lt;/p&gt;

&lt;p&gt;P.S. The reason why I chose to map recursive records to bytearray instead of empty tuple is because I cannot refer to any field if I use empty tuple. For example, if Pig schema is defined as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{value: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,next: ()}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I get an exception when I attempt to refer to any field in loaded tuples since their schema is not defined (i.e. empty tuple).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 1127: Index 0 out of range in schema
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is all what I found by trials and errors, so there might be something that I am missing here. If so, please let me know.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12603430">PIG-2875</key>
            <summary>Add recursive record support to AvroStorage</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Aug 2012 11:21:39 +0100</created>
                <updated>Fri, 22 Feb 2013 04:54:17 +0000</updated>
                            <resolved>Mon, 20 Aug 2012 08:16:44 +0100</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.11</fixVersion>
                                    <component>piggybank</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13434041" author="cheolsoo" created="Tue, 14 Aug 2012 11:24:40 +0100"  >&lt;p&gt;Review board:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/6536/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/6536/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13434043" author="cheolsoo" created="Tue, 14 Aug 2012 11:26:18 +0100"  >&lt;p&gt;This was originally PIG-2869 and re-created due to &lt;a href=&quot;https://issues.apache.org/jira/browse/INFRA-5131&quot; title=&quot;IOE when creating a JIRA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;INFRA-5131&quot;&gt;&lt;del&gt;INFRA-5131&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13437669" author="sms" created="Mon, 20 Aug 2012 07:08:01 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt; I see one test failure when I run the following commands&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

$ ant clean compile-test jar-withouthadoop -Dhadoopversion=20
$ cd contrib/piggybank/java/
$ ant clean test -Dhadoopversion=20
...
    [junit] Tests run: 33, Failures: 1, Errors: 0, Time elapsed: 107.203 sec
    [junit] Test org.apache.pig.piggybank.test.storage.avro.TestAvroStorage FAILED
...


Testcase: testRecursiveRecordReference1 took 3.621 sec
        FAILED
Expected output does not exists!
junit.framework.AssertionFailedError: Expected output does not exists!
        at org.apache.pig.piggybank.test.storage.avro.TestAvroStorage.getExpected(TestAvroStorage.java:933)
        at org.apache.pig.piggybank.test.storage.avro.TestAvroStorage.verifyResults(TestAvroStorage.java:891)
        at org.apache.pig.piggybank.test.storage.avro.TestAvroStorage.verifyResults(TestAvroStorage.java:880)
        at org.apache.pig.piggybank.test.storage.avro.TestAvroStorage.testRecursiveRecordReference1(TestAvroStorage.java:292)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13437677" author="cheolsoo" created="Mon, 20 Aug 2012 07:35:37 +0100"  >&lt;p&gt;There was a typo in the code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; expected = basedir + &lt;span class=&quot;code-quote&quot;&gt;&quot;expected_testRecursiveRecordReference1&quot;&lt;/span&gt;;
+ &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; expected = basedir + &lt;span class=&quot;code-quote&quot;&gt;&quot;expected_testRecursiveRecordReference1.avro&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uploaded a new patch with the fix. I verified that all the tests pass in both 20 and 23.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;
</comment>
                            <comment id="13437681" author="cheolsoo" created="Mon, 20 Aug 2012 07:41:00 +0100"  >&lt;p&gt;Fixed a typo.&lt;/p&gt;</comment>
                            <comment id="13437696" author="sms" created="Mon, 20 Aug 2012 08:16:09 +0100"  >&lt;p&gt;All unit test cases in piggybank passed. Patch has been committed. Thanks Cheolsoo.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12540868" name="PIG-2869.patch" size="35034" author="cheolsoo" created="Tue, 14 Aug 2012 11:24:40 +0100"/>
                            <attachment id="12541559" name="PIG-2875-2.patch" size="60397" author="cheolsoo" created="Mon, 20 Aug 2012 05:51:07 +0100"/>
                            <attachment id="12541561" name="PIG-2875-3.patch" size="60450" author="cheolsoo" created="Mon, 20 Aug 2012 07:35:37 +0100"/>
                            <attachment id="12541562" name="PIG-2875-4.patch" size="60402" author="cheolsoo" created="Mon, 20 Aug 2012 07:41:00 +0100"/>
                            <attachment id="12541296" name="PIG-2875.patch" size="35876" author="cheolsoo" created="Thu, 16 Aug 2012 23:46:38 +0100"/>
                            <attachment id="12540869" name="avro_test_files.tar.gz" size="1139" author="cheolsoo" created="Tue, 14 Aug 2012 11:24:40 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 20 Aug 2012 06:08:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242337</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwoe7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14439</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>