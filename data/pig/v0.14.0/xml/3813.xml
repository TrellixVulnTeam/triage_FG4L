<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:52:01 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3813/PIG-3813.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3813] Rank column is assigned different uids everytime when schema is reset</title>
                <link>https://issues.apache.org/jira/browse/PIG-3813</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;When the following script is run, pig goes into an infinite loop. This was reproduced on pig trunk as of March 12, 2014 on apache hadoop 1.2. test_data.txt has been attached. &lt;/p&gt;

&lt;p&gt;test.pig&lt;br/&gt;
tWeek = LOAD &apos;/tmp/test_data.txt&apos; USING PigStorage (&apos;|&apos;) AS (WEEK:int, DESCRIPTION:chararray, END_DATE:chararray, PERIOD:int);&lt;/p&gt;

&lt;p&gt;gTWeek = FOREACH tWeek GENERATE WEEK AS WEEK, PERIOD AS PERIOD;&lt;/p&gt;

&lt;p&gt;pWeek = FILTER gTWeek BY PERIOD == 201312;&lt;/p&gt;

&lt;p&gt;pWeekRanked = RANK pWeek BY WEEK ASC DENSE;&lt;/p&gt;

&lt;p&gt;gpWeekRanked = FOREACH pWeekRanked GENERATE $0;&lt;br/&gt;
store gpWeekRanked into &apos;gpWeekRanked&apos;;&lt;br/&gt;
describe gpWeekRanked;&lt;br/&gt;
---------------------------------------------------&lt;/p&gt;

&lt;p&gt;The res object of class Result, gets its value from leaf.getNextTuple()&lt;br/&gt;
This gets an empty tuple &lt;br/&gt;
() &lt;br/&gt;
with STATUS_OK.&lt;/p&gt;

&lt;p&gt;SO the while(true) condition never gets an End of Processing (EOP) and so does not exit. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12701409">PIG-3813</key>
            <summary>Rank column is assigned different uids everytime when schema is reset</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="ssatish">Suhas Satish</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Mar 2014 04:17:23 +0000</created>
                <updated>Tue, 15 Apr 2014 21:45:00 +0100</updated>
                            <resolved>Tue, 18 Mar 2014 23:17:53 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.12.1</fixVersion>
                    <fixVersion>0.13.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13937409" author="cheolsoo" created="Mon, 17 Mar 2014 01:57:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ssatish&quot; class=&quot;user-hover&quot; rel=&quot;ssatish&quot;&gt;Suhas Satish&lt;/a&gt; helped me to reproduce the issue at the meet-up. Thanks!&lt;/p&gt;

&lt;p&gt;This seems like a column pruner bug. The query runs fine if I add &lt;tt&gt;SET pig.optimizer.rules.disabled ColumnMapKeyPrune&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Assigning to me.&lt;/p&gt;


</comment>
                            <comment id="13938504" author="cheolsoo" created="Mon, 17 Mar 2014 22:44:08 +0000"  >&lt;p&gt;Attaching a patch. Here is what I found-&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;PushUpFilter moves up the filter by (pWeek) to above the foreach (gTWeek).&lt;/li&gt;
	&lt;li&gt;Since pWeek is a direct predecessor of the rank (pWeekRanked), the PushUpFilter changes the output schema of pWeekRanked from rank_pWeek (uid:18) to rank_gTWeek (uid:24).&lt;/li&gt;
	&lt;li&gt;After this, ColumnPruneVistor visits the 2nd foreach (gpWeekRanked). It checks whether the column $0 exists in the input schema of gpWeekRanked, which is equivalent to the output schema of pWeekRanked as follows-
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputUids.contains(project.getFieldSchema().uid))
    innerLoadsToRemove.add(innerLoad);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem is that rank_pWeek (uid:18) is no longer in the input schema of gpWeekRanked, but rank_gTWeek (uid:24) is. So ColumnPruneVistor removes the column $0 from gpWeekRanked.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Now gpWeekRanked generates empty tuples.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The attached patch changes the condition in ColumnPruneVistor as follows-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LogicalSchema.LogicalFieldSchema fs = project.findReferent().getSchema().getField(project.getColNum());
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputUids.contains(fs.uid)) {
    innerLoadsToRemove.add(innerLoad);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Basically, it uses the schema of the referent instead of that of the field itself in LOGenerate. This way, any changes in its predecessor are reflected correctly.&lt;/p&gt;

&lt;p&gt;I have never worked on this area of code. Please let me know if this fix is not proper.&lt;/p&gt;</comment>
                            <comment id="13939622" author="daijy" created="Tue, 18 Mar 2014 18:40:43 +0000"  >&lt;p&gt;Seems LORank is generating the wrong uid. One thing missing in LORank is to keep generated uid across session, so a schema reset will not erase the old uid. We can refer to LOCogroup.groupKeyUidOnlySchema to fix LORank.&lt;/p&gt;</comment>
                            <comment id="13939661" author="cheolsoo" created="Tue, 18 Mar 2014 19:06:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;, thank you for the comment. Let me try your suggestion.&lt;/p&gt;</comment>
                            <comment id="13939755" author="cheolsoo" created="Tue, 18 Mar 2014 20:44:42 +0000"  >&lt;p&gt;Here is the 2nd patch that keeps track of the uid of the rank column.&lt;/p&gt;</comment>
                            <comment id="13939761" author="cheolsoo" created="Tue, 18 Mar 2014 20:46:09 +0000"  >&lt;p&gt;Updating the title to describe the root cause.&lt;/p&gt;</comment>
                            <comment id="13939928" author="daijy" created="Tue, 18 Mar 2014 22:55:40 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13939947" author="cheolsoo" created="Tue, 18 Mar 2014 23:17:53 +0000"  >&lt;p&gt;Committed to trunk.&lt;br/&gt;
Thank you Daniel for reviewing the patch!&lt;br/&gt;
Thank you Suhas for reporting the issue!&lt;/p&gt;</comment>
                            <comment id="13939968" author="ssatish" created="Tue, 18 Mar 2014 23:42:25 +0000"  >&lt;p&gt;Thanks for the quick turn around Cheolsoo&lt;/p&gt;</comment>
                            <comment id="13949568" author="cheolsoo" created="Thu, 27 Mar 2014 16:52:40 +0000"  >&lt;p&gt;I&apos;d like to backport this into branch-0.12. Please let me know if you object, or I&apos;ll commit it in 0.12 tomorrow. Thanks!&lt;/p&gt;</comment>
                            <comment id="13949651" author="rohini" created="Thu, 27 Mar 2014 17:28:39 +0000"  >&lt;p&gt;We should certainly backport this to 0.12.1 as it is a major bug for Rank operator.&lt;/p&gt;</comment>
                            <comment id="13949666" author="prkommireddi" created="Thu, 27 Mar 2014 17:32:48 +0000"  >&lt;p&gt;+1 to backport&lt;/p&gt;</comment>
                            <comment id="13949735" author="suhassatish" created="Thu, 27 Mar 2014 18:16:21 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13950966" author="cheolsoo" created="Fri, 28 Mar 2014 16:21:55 +0000"  >&lt;p&gt;Committed to 0.12 branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12635181" name="PIG-3813-1.patch" size="1441" author="cheolsoo" created="Mon, 17 Mar 2014 22:44:08 +0000"/>
                            <attachment id="12635395" name="PIG-3813-2.patch" size="1753" author="cheolsoo" created="Tue, 18 Mar 2014 20:44:42 +0000"/>
                            <attachment id="12634638" name="test_data.txt" size="11648" author="ssatish" created="Fri, 14 Mar 2014 04:20:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 17 Mar 2014 01:57:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379755</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hznaav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380040</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>