<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:09:50 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-4018/PIG-4018.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-4018] Schema validation fails with UNION ONSCHEMA</title>
                <link>https://issues.apache.org/jira/browse/PIG-4018</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;When relations with differing schemas are unioned (using UNION ONSCHEMA), schema validation can fail with this exception:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.apache.pig.impl.plan.PlanValidationException: Logical plan invalid state: invalid uid -1 in schema&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;This worked before the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3492&quot; title=&quot;ColumnPrune dropping used column due to LogicalRelationalOperator.fixDuplicateUids changes not propagating&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3492&quot;&gt;&lt;del&gt;PIG-3492&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The merged schema (from &lt;tt&gt;LOUnion.getSchema()&lt;/tt&gt;) does not contain uids for columns not in the schema of the first input (uids are set to -1). This is because only the first input&apos;s schema is used for looking up &quot;cached&quot; uids.&lt;/p&gt;

&lt;p&gt;Normally, this isn&apos;t a problem because &lt;tt&gt;UnionOnSchemaSetter&lt;/tt&gt; comes along and fixes the missing fields.&lt;/p&gt;

&lt;p&gt;However, when &lt;tt&gt;ImplicitSplitInsertVisitor&lt;/tt&gt; is active, it is called before &lt;tt&gt;UnionOnSchemaSetter&lt;/tt&gt;. &lt;tt&gt;ImplicitSplitInsertVisitor&lt;/tt&gt; calls &lt;tt&gt;schemaResetter.visit()&lt;/tt&gt;, which throws the validation exception because &lt;tt&gt;UnionOnSchemaSetter&lt;/tt&gt; has not had a chance to create the missing fields (and thus uids are still -1 for these fields).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12722262">PIG-4018</key>
            <summary>Schema validation fails with UNION ONSCHEMA</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tmwoodruff">Travis Woodruff</assignee>
                                    <reporter username="tmwoodruff">Travis Woodruff</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Jun 2014 17:44:13 +0100</created>
                <updated>Fri, 21 Nov 2014 05:58:19 +0000</updated>
                            <resolved>Sun, 22 Jun 2014 04:11:50 +0100</resolved>
                                    <version>0.13.0</version>
                                    <fixVersion>0.14.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14035944" author="tmwoodruff" created="Wed, 18 Jun 2014 18:00:36 +0100"  >&lt;p&gt;This is an attempt at a patch. It moves UnionOnSchemaSetter above ImplicitSplitInsertVisitor in LogicalPlan.validate().&lt;/p&gt;

&lt;p&gt;It also contains a small test that demonstrates the problem (apply the test but not the LogicalPlan patch to see it fail).&lt;/p&gt;

&lt;p&gt;This seems to work in my testing, but I&apos;m not super familiar with the logical plan generation process, so I&apos;m not 100% sure about the effects here. The operations between the old location and the new are &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;ImplicitSplitInsertVisitor&lt;/tt&gt; &amp;#8211; expected&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;DuplicateForEachColumnRewriteVisitor&lt;/tt&gt; &amp;#8211; UnionOnSchemaSetter adds a few more FOREACHes for this to check, but doesn&apos;t seem like this should have a noticeable impact&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;TypeCheckingRelVisitor&lt;/tt&gt; &amp;#8211; Again, a couple more FOREACHes to check, but there should be no functional impact.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14038138" author="cheolsoo" created="Fri, 20 Jun 2014 01:04:38 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tmwoodruff&quot; class=&quot;user-hover&quot; rel=&quot;tmwoodruff&quot;&gt;Travis Woodruff&lt;/a&gt;, I ran the unit tests and found the following failures-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;&amp;gt;&amp;gt; org.apache.pig.test.TestUnionOnSchema.testUnionOnSchemaUdfTypeEvolution2
&amp;gt;&amp;gt;&amp;gt; org.apache.pig.test.TestUnionOnSchema.testUnionOnSchemaUdfTypeEvolution
&amp;gt;&amp;gt;&amp;gt; org.apache.pig.test.TestUnionOnSchema.testUnionOnSchemaIncompatibleTypes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Can you take a look at them?&lt;/p&gt;</comment>
                            <comment id="14039238" author="tmwoodruff" created="Fri, 20 Jun 2014 20:35:18 +0100"  >&lt;p&gt;Sorry about that. I completely overlooked that test somehow. New patch forthcoming.&lt;/p&gt;</comment>
                            <comment id="14039247" author="tmwoodruff" created="Fri, 20 Jun 2014 20:41:05 +0100"  >&lt;p&gt;Looks like TypeCheckingRelVisitor adds type conversion, so my previous patch is no good. Need a more complicated patch, unfortunately.&lt;/p&gt;

&lt;p&gt;This patch updates LOUnion.getSchema() to ensure that all output schema fields have a uid set. It also makes some small changes to minimize calls to getSchema() on inputs, since several additional iterations over inputs have been added, and getScema() calls can be quite costly (for example, PigStorage reloads from HDFS every time getSchema() is called).&lt;/p&gt;

&lt;p&gt;Also moved the test for this issue into TestUnionOnSchema.&lt;/p&gt;</comment>
                            <comment id="14039690" author="daijy" created="Sat, 21 Jun 2014 05:47:12 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4018&quot; title=&quot;Schema validation fails with UNION ONSCHEMA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4018&quot;&gt;&lt;del&gt;PIG-4018&lt;/del&gt;&lt;/a&gt;-2.patch looks pretty good. I will +1 once tests pass.&lt;/p&gt;</comment>
                            <comment id="14040019" author="daijy" created="Sun, 22 Jun 2014 04:11:50 +0100"  >&lt;p&gt;All unit tests pass.&lt;/p&gt;

&lt;p&gt;Patch committed to trunk. Thanks Travis!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12651710" name="PIG-4018-2.patch" size="9618" author="tmwoodruff" created="Fri, 20 Jun 2014 20:41:05 +0100"/>
                            <attachment id="12651186" name="PIG-4018.patch" size="4166" author="tmwoodruff" created="Wed, 18 Jun 2014 18:00:36 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 20 Jun 2014 00:04:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>400453</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzqshb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>400552</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>