<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:49:19 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-4036/PIG-4036.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-4036] Fix e2e failures - JobManagement_3, CmdErrors_3 and BigData_4</title>
                <link>https://issues.apache.org/jira/browse/PIG-4036</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description></description>
                <environment></environment>
        <key id="12723064">PIG-4036</key>
            <summary>Fix e2e failures - JobManagement_3, CmdErrors_3 and BigData_4</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 Jun 2014 05:48:49 +0100</created>
                <updated>Mon, 7 Jul 2014 19:08:09 +0100</updated>
                            <resolved>Fri, 27 Jun 2014 06:12:00 +0100</resolved>
                                                    <fixVersion>0.13.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14040418" author="rohini" created="Mon, 23 Jun 2014 05:55:04 +0100"  >&lt;p&gt;JobManagement_3, CmdErrors_3 fail with  java.lang.NoClassDefFoundError: org/apache/zookeeper/Shell . StreamingCommand.java - import org.apache.zookeeper.Shell should be import org.apache.hadoop.util.Shell;&lt;/p&gt;</comment>
                            <comment id="14040450" author="rohini" created="Mon, 23 Jun 2014 06:46:08 +0100"  >&lt;p&gt; BigData_4 stacktrace is below. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-06-23 04:54:16,640 FATAL [main] org.apache.hadoop.mapred.YarnChild: Error running child : java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOf(Arrays.java:2219)
	at java.util.ArrayList.grow(ArrayList.java:213)
	at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:187)
	at java.util.ArrayList.add(ArrayList.java:411)
	at org.apache.pig.data.InternalCachedBag.add(InternalCachedBag.java:82)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.CombinerPackager.getNext(CombinerPackager.java:128)
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POPackage.getNextTuple(POPackage.java:271)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.processOnePackageOutput(PigCombiner.java:177)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.reduce(PigCombiner.java:168)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.reduce(PigCombiner.java:51)
	at org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:170)
	at org.apache.hadoop.mapred.Task$NewCombinerRunner.combine(Task.java:1631)
	at org.apache.hadoop.mapred.MapTask$MapOutputBuffer.sortAndSpill(MapTask.java:1568)
	at org.apache.hadoop.mapred.MapTask$MapOutputBuffer.flush(MapTask.java:1417)
	at org.apache.hadoop.mapred.MapTask$NewOutputCollector.close(MapTask.java:664)
	at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:731)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:333)
	at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:158)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:415)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1300)
	at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:153)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Problem is with protected DataBag[] bags; in Packager.java. While POCombinerPackage in older version iterated through the tuple, current code in POPackage iterates through the tuple and puts in a bag (in BigData_4 that becomes 600+MB) and passes the bag to POCombinerPackage which causes OOM when trying to add to the bag there as memory is already occupied by the other bag. We need to do some rework on POPackage and Packager.  &lt;/p&gt;</comment>
                            <comment id="14041361" author="daijy" created="Mon, 23 Jun 2014 22:41:35 +0100"  >&lt;p&gt;I saw we materialized the bag in Packager if readOnce flag is set (which is the case for most script). Not sure what does readOnce do and why we need to materialize the bag. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mwagner&quot; class=&quot;user-hover&quot; rel=&quot;mwagner&quot;&gt;Mark Wagner&lt;/a&gt;, can you give me some hint?&lt;/p&gt;</comment>
                            <comment id="14041402" author="mwagner" created="Mon, 23 Jun 2014 23:13:24 +0100"  >&lt;p&gt;The readOnce flag is the method by which POPackage communicates which bags the Packager can assume are already persisted in memory and which are ephemeral and must be copied into memory. This enables the streaming optimization on the last bag in classic-MR and all inputs for Tez. The Packager base class requires all bags to actually be persisted, so it copies into memory. The CombinerPackager can have it&apos;s one and only input streamed so it should overwrite attachInput() to reflect that (which it doesn&apos;t right now).&lt;/p&gt;

&lt;p&gt;I&apos;ll work on verifying that fix.&lt;/p&gt;</comment>
                            <comment id="14041406" author="rohini" created="Mon, 23 Jun 2014 23:18:55 +0100"  >&lt;p&gt;Even in other cases like join, persisting to memory instead of iterating and processing immediately does not sound good to me. Will hit OOM issues and the extra copy will cause performance regression. &lt;/p&gt;</comment>
                            <comment id="14041423" author="mwagner" created="Mon, 23 Jun 2014 23:33:38 +0100"  >&lt;p&gt;That&apos;s the goal of using readOnce. The idea was that the POPackage could be optimistic/lazy about what bags actually need to be in memory (assume that they don&apos;t need to be), and the classes extending Packager can bring into memory what it needs. The JoinPackager does not hold the bag in memory and just iterates over it.&lt;/p&gt;

&lt;p&gt;Looking through the other code, it looks like this may be a bug in LitePackager as well.&lt;/p&gt;</comment>
                            <comment id="14041581" author="daijy" created="Tue, 24 Jun 2014 02:38:42 +0100"  >&lt;p&gt;Looks like the ReadOnce bag optimization is not currently be used. It anyway will be materialized first. The JoinPackager will use NonSpillableDataBag not ReadOnce bag. Can we change it back to InternalCachedBag?&lt;/p&gt;</comment>
                            <comment id="14041801" author="daijy" created="Tue, 24 Jun 2014 08:14:12 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, POCombinerPackage also materialize the bag. Now in Packager, we do materialize from PeekedBag to InternalCachedBag, PeekedBag doing streaming, though I cannot see the value for doing that, this should not use more memory. I believe the problem is we pass the wrong bagCount to InternalCachedBag, so InternalCachedBag is using unlimited memory. I attach a draft patch, can you give a try.&lt;/p&gt;</comment>
                            <comment id="14042043" author="rohini" created="Tue, 24 Jun 2014 13:36:36 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;,&lt;br/&gt;
   I can try the patch and might work with this test, but I still have my doubts that it will fail with some other script with more memory requirements that passed with older releases as there are two copies of the bag even though the tuples are referenced and not copied. Also it will not solve the problem of performance degradation due to overhead of putting the tuples in two InternalCachedBags.&lt;/p&gt;</comment>
                            <comment id="14042051" author="rohini" created="Tue, 24 Jun 2014 13:43:52 +0100"  >&lt;p&gt;Was bag count being set to 0 before in this case?&lt;/p&gt;</comment>
                            <comment id="14042374" author="daijy" created="Tue, 24 Jun 2014 18:06:09 +0100"  >&lt;p&gt;Yes, bag count set to 0 in BigData_4.&lt;/p&gt;</comment>
                            <comment id="14042386" author="rohini" created="Tue, 24 Jun 2014 18:11:49 +0100"  >&lt;p&gt;Wouldn&apos;t that have caused divide by zero error in MemoryLimits.java when doing maxMemUsage = (long) ((maxMem * percent) / bagCount);&lt;/p&gt;</comment>
                            <comment id="14042456" author="daijy" created="Tue, 24 Jun 2014 19:05:15 +0100"  >&lt;p&gt;It doesn&apos;t in the float context, and we end up with a Long.MAX_VALUE.&lt;/p&gt;</comment>
                            <comment id="14042947" author="daijy" created="Wed, 25 Jun 2014 02:47:14 +0100"  >&lt;p&gt;Rohini also find MultiQueryPackager still using InternalCachedBag, and materialized into another InternalCachedBag. I fix that in the new patch.&lt;/p&gt;</comment>
                            <comment id="14043761" author="daijy" created="Wed, 25 Jun 2014 18:11:53 +0100"  >&lt;p&gt;There are some test failures. I will work on another patch.&lt;/p&gt;</comment>
                            <comment id="14044931" author="daijy" created="Thu, 26 Jun 2014 18:42:48 +0100"  >&lt;p&gt;All e2e and unit tests pass for me.&lt;/p&gt;</comment>
                            <comment id="14045321" author="daijy" created="Fri, 27 Jun 2014 00:31:02 +0100"  >&lt;p&gt;Forget to attach updated patch.&lt;/p&gt;</comment>
                            <comment id="14045406" author="rohini" created="Fri, 27 Jun 2014 02:11:57 +0100"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14045534" author="daijy" created="Fri, 27 Jun 2014 06:12:00 +0100"  >&lt;p&gt;Patch committed to 0.13 branch and trunk. Thanks Rohini for review!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12652152" name="PIG-4036-0.patch" size="792" author="daijy" created="Tue, 24 Jun 2014 08:14:47 +0100"/>
                            <attachment id="12652327" name="PIG-4036-1.patch" size="2231" author="daijy" created="Wed, 25 Jun 2014 02:46:52 +0100"/>
                            <attachment id="12652708" name="PIG-4036-2.patch" size="2898" author="daijy" created="Fri, 27 Jun 2014 00:31:02 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 23 Jun 2014 21:41:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401251</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzqx9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>