<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:53:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2532/PIG-2532.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2532] Registered classes fail deserialization in frontend</title>
                <link>https://issues.apache.org/jira/browse/PIG-2532</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;This issue came up while integrating HCatalog with our environment. HCatalog jars are added to the pig command-line with &lt;tt&gt;-Dpig.additional.jars&lt;/tt&gt; but fails (exception below). When added to the pig classpath the error goes away.&lt;/p&gt;

&lt;p&gt;We identified the issue as deserialization using the root class loader, not the context class loader set when the thread is created. This causes HCatSchema which is serialized into the context to fail deserialization in the thread.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-02-14 21:55:53,936 [main] ERROR org.apache.pig.tools.grunt.Grunt - ERROR 6017: java.io.IOException: Deserialization error: org.apache.hcatalog.data.schema.HCatSchema
	at org.apache.pig.impl.util.ObjectSerializer.deserialize(ObjectSerializer.java:55)
	at org.apache.pig.impl.util.UDFContext.deserialize(UDFContext.java:181)
	at org.apache.pig.backend.hadoop.executionengine.util.MapRedUtil.setupUDFContext(MapRedUtil.java:159)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputFormat.setupUdfEnvAndStores(PigOutputFormat.java:229)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputFormat.checkOutputSpecs(PigOutputFormat.java:186)
	at org.apache.hadoop.mapred.JobClient.submitJobInternal(JobClient.java:811)
	at org.apache.hadoop.mapred.JobClient.submitJob(JobClient.java:771)
	at org.apache.hadoop.mapred.jobcontrol.Job.submit(Job.java:378)
	at org.apache.hadoop.mapred.jobcontrol.JobControl.startReadyJobs(JobControl.java:247)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigJobControl.mainLoopAction(PigJobControl.java:144)
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigJobControl.run(PigJobControl.java:121)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
Caused by: java.lang.ClassNotFoundException: org.apache.hcatalog.data.schema.HCatSchema
	at java.net.URLClassLoader$1.run(URLClassLoader.java:202)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:190)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:307)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:248)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:247)
	at java.io.ObjectInputStream.resolveClass(ObjectInputStream.java:603)
	at java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1574)
	at java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1495)
	at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1731)
	at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1328)
	at java.io.ObjectInputStream.readObject(ObjectInputStream.java:350)
	at java.util.Hashtable.readObject(Hashtable.java:859)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:974)
	at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1848)
	at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1752)
	at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1328)
	at java.io.ObjectInputStream.readObject(ObjectInputStream.java:350)
	at java.util.HashMap.readObject(HashMap.java:1030)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:974)
	at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1848)
	at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1752)
	at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1328)
	at java.io.ObjectInputStream.readObject(ObjectInputStream.java:350)
	at org.apache.pig.impl.util.ObjectSerializer.deserialize(ObjectSerializer.java:53)
	... 15 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12542626">PIG-2532</key>
            <summary>Registered classes fail deserialization in frontend</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="traviscrawford">Travis Crawford</assignee>
                                    <reporter username="traviscrawford">Travis Crawford</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Feb 2012 01:17:41 +0000</created>
                <updated>Sat, 9 Jun 2012 03:06:21 +0100</updated>
                            <resolved>Wed, 7 Mar 2012 23:45:19 +0000</resolved>
                                                    <fixVersion>0.10.0</fixVersion>
                    <fixVersion>0.9.3</fixVersion>
                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13208212" author="dvryaboy" created="Wed, 15 Feb 2012 04:03:46 +0000"  >&lt;p&gt;Nice find, guys.&lt;br/&gt;
We probably need an e2e test for this. Looks like they already create a separate udfs jar, so it should be possible to reproduce the scenario of not having the jar on the classpath, but only registering it.&lt;/p&gt;</comment>
                            <comment id="13209982" author="traviscrawford" created="Fri, 17 Feb 2012 02:04:03 +0000"  >&lt;p&gt;Status update:&lt;/p&gt;

&lt;p&gt;I reproduced the issue in a unit test, and verified the patch fixes the issue. The issue presents itself when a jar is registered at runtime, and a class in that registered jar is stored in the UDFContext. Without the patch deserilization fails.&lt;/p&gt;

&lt;p&gt;To setup the test I store two java files as resources, and compile+jar them at runtime (using javax classes). I took this approach to keep the test setup isolated.&lt;/p&gt;

&lt;p&gt;However, since it uses javax classes this approach may not be ideal. I&apos;m preparing another version that performs these setup steps in ant (generate the test-specific jar, runs the test with an appropriate classpath. That version will likely be the better choice to commit.&lt;/p&gt;</comment>
                            <comment id="13209985" author="traviscrawford" created="Fri, 17 Feb 2012 02:08:06 +0000"  >&lt;p&gt;Uploading zip file of version that compiles+jars at runtime, mainly so it exists somewhere other than my laptop &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13210574" author="traviscrawford" created="Fri, 17 Feb 2012 21:11:10 +0000"  >&lt;p&gt;Internally we discussed and think this approach is best because it keeps the test relatively self-contained (instead of majorly leaking into the build file). Additionally, we checked OpenJDK and confirmed these classes are present.&lt;/p&gt;</comment>
                            <comment id="13212705" author="julienledem" created="Tue, 21 Feb 2012 16:24:55 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13213138" author="daijy" created="Wed, 22 Feb 2012 00:17:12 +0000"  >&lt;p&gt;+1. Nice catch Travis! This does bother us for a long time.&lt;/p&gt;</comment>
                            <comment id="13213964" author="julienledem" created="Wed, 22 Feb 2012 20:18:07 +0000"  >&lt;p&gt;I rebased the patch (v3)&lt;br/&gt;
will commit&lt;/p&gt;</comment>
                            <comment id="13216217" author="julienledem" created="Sat, 25 Feb 2012 01:26:24 +0000"  >&lt;p&gt;I rebased the patch again and did a small change so that the test can be run from eclipse&lt;/p&gt;</comment>
                            <comment id="13216232" author="ashutoshc" created="Sat, 25 Feb 2012 01:40:22 +0000"  >&lt;p&gt;Awesome. Thanks, Travis for this. Can I request this to be back-ported to 0.8 ?&lt;/p&gt;</comment>
                            <comment id="13216233" author="ashutoshc" created="Sat, 25 Feb 2012 01:44:21 +0000"  >&lt;p&gt;Sorry, I meant 0.9 branch.&lt;/p&gt;</comment>
                            <comment id="13216235" author="daijy" created="Sat, 25 Feb 2012 01:49:53 +0000"  >&lt;p&gt;+1 for backport. Some resync is needed though.&lt;/p&gt;</comment>
                            <comment id="13216962" author="julienledem" created="Sun, 26 Feb 2012 23:51:16 +0000"  >&lt;p&gt;I checked-in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2532&quot; title=&quot;Registered classes fail deserialization in frontend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2532&quot;&gt;&lt;del&gt;PIG-2532&lt;/del&gt;&lt;/a&gt;-v4.patch in TRUNK.&lt;br/&gt;
I will look into back porting to 0.9&lt;/p&gt;</comment>
                            <comment id="13216979" author="julienledem" created="Mon, 27 Feb 2012 01:28:31 +0000"  >&lt;p&gt;Adding &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2532&quot; title=&quot;Registered classes fail deserialization in frontend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2532&quot;&gt;&lt;del&gt;PIG-2532&lt;/del&gt;&lt;/a&gt;-v4-branch-0.9.patch&lt;br/&gt;
The only difference is regarding the eclipse-files generation.&lt;br/&gt;
Otherwise the patch applies cleanly&lt;/p&gt;</comment>
                            <comment id="13216981" author="julienledem" created="Mon, 27 Feb 2012 01:32:58 +0000"  >&lt;p&gt;checked in in branch-0.9&lt;/p&gt;</comment>
                            <comment id="13219635" author="thw" created="Wed, 29 Feb 2012 23:01:38 +0000"  >&lt;p&gt;After this change, following test fails on 0.23:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant -Dhadoopversion=23 clean test -Dtestcase=TestRegisteredJarVisibility


    [junit] Tests run: 2, Failures: 0, Errors: 2, Time elapsed: 113.172 sec
    [junit] Test org.apache.pig.test.TestRegisteredJarVisibility FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Will this go into 0.10 also?&lt;/p&gt;</comment>
                            <comment id="13219749" author="traviscrawford" created="Thu, 1 Mar 2012 02:41:38 +0000"  >&lt;p&gt;Thomas, thanks for the report. I will take a look at this test failure.&lt;/p&gt;</comment>
                            <comment id="13220566" author="julienledem" created="Fri, 2 Mar 2012 01:09:24 +0000"  >&lt;p&gt;I&apos;ve been looking at this problem and does not seem related to the patch. Thomas, could you send the content of the related junit log file? I see a bunch of Guice related exceptions.&lt;/p&gt;</comment>
                            <comment id="13220620" author="thw" created="Fri, 2 Mar 2012 02:28:19 +0000"  >&lt;p&gt;Attaching test log.&lt;/p&gt;</comment>
                            <comment id="13224843" author="daijy" created="Wed, 7 Mar 2012 23:45:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2532&quot; title=&quot;Registered classes fail deserialization in frontend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2532&quot;&gt;&lt;del&gt;PIG-2532&lt;/del&gt;&lt;/a&gt;-h23.patch fix h23 test failure. Also I find the patch is not committed to 0.10 branch, I committed it to 0.10 branch as well.&lt;/p&gt;</comment>
                            <comment id="13292169" author="aniket486" created="Sat, 9 Jun 2012 03:06:21 +0100"  >&lt;p&gt;I tested on trunk, its not fully fixed. If we register the jar from s3, it fails with the same error. I will open another jira for the same.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12545796">PIG-2576</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12517484" name="PIG-2532-h23.patch" size="2077" author="daijy" created="Wed, 7 Mar 2012 23:45:03 +0000"/>
                            <attachment id="12516779" name="PIG-2532-log.zip" size="28800" author="thw" created="Fri, 2 Mar 2012 02:28:19 +0000"/>
                            <attachment id="12515026" name="PIG-2532-v2.patch" size="14154" author="traviscrawford" created="Fri, 17 Feb 2012 21:11:10 +0000"/>
                            <attachment id="12515643" name="PIG-2532-v3.patch" size="14664" author="julienledem" created="Wed, 22 Feb 2012 20:18:07 +0000"/>
                            <attachment id="12516128" name="PIG-2532-v4-branch-0.9.patch" size="13498" author="julienledem" created="Mon, 27 Feb 2012 01:28:31 +0000"/>
                            <attachment id="12516013" name="PIG-2532-v4.patch" size="13303" author="julienledem" created="Sat, 25 Feb 2012 01:26:24 +0000"/>
                            <attachment id="12514588" name="PIG-2532.patch" size="1846" author="traviscrawford" created="Wed, 15 Feb 2012 01:39:09 +0000"/>
                            <attachment id="12514929" name="PIG-253_javax.zip" size="17675" author="traviscrawford" created="Fri, 17 Feb 2012 02:08:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 15 Feb 2012 04:03:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>227912</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyaxnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97765</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>