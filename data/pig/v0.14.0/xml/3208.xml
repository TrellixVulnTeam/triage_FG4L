<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:48:28 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3208/PIG-3208.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3208] [zebra] TFile should not set io.compression.codec.lzo.buffersize</title>
                <link>https://issues.apache.org/jira/browse/PIG-3208</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;In contrib/zebra/src/java/org/apache/hadoop/zebra/tfile/Compression.java, the following occurs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
conf.setInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;io.compression.codec.lzo.buffersize&quot;&lt;/span&gt;, 64 * 1024);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This can cause the LZO decompressor, if called within the context of reading TFiles, to return with an error code when trying to uncompress LZO-compressed data, if the data&apos;s compressed size is too large to fit in 64 * 1024 bytes.&lt;/p&gt;

&lt;p&gt;For example, the Hadoop-LZO code uses a different default value (256 * 1024):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/twitter/hadoop-lzo/blob/master/src/java/com/hadoop/compression/lzo/LzoCodec.java#L185&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/twitter/hadoop-lzo/blob/master/src/java/com/hadoop/compression/lzo/LzoCodec.java#L185&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This can lead to a case where, if data is compressed with a cluster where the default &lt;tt&gt;io.compression.codec.lzo.buffersize&lt;/tt&gt; = 256*1024 is used, then code that tries to read this data by using Pig&apos;s zebra, the Mapper will exit with code 134 because the LZO compressor returns a -4 (which encodes the LZO C library error LZO_E_INPUT_OVERRUN) when trying to uncompress the data. The stack trace of such a case is shown below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-02-17 14:47:50,709 INFO com.hadoop.compression.lzo.LzoCodec: Creating stream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; compressor: com.hadoop.compression.lzo.LzoCompressor@6818c458 with bufferSize: 262144
2013-02-17 14:47:50,849 INFO org.apache.hadoop.io.compress.CodecPool: Paying back codec: com.hadoop.compression.lzo.LzoCompressor@6818c458
2013-02-17 14:47:50,849 INFO org.apache.hadoop.mapred.MapTask: Finished spill 3
2013-02-17 14:47:50,857 INFO org.apache.hadoop.io.compress.CodecPool: Borrowing codec: com.hadoop.compression.lzo.LzoCompressor@6818c458
2013-02-17 14:47:50,866 INFO com.hadoop.compression.lzo.LzoCodec: Creating stream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; compressor: com.hadoop.compression.lzo.LzoCompressor@6818c458 with bufferSize: 262144
2013-02-17 14:47:50,879 INFO org.apache.hadoop.io.compress.CodecPool: Paying back codec: com.hadoop.compression.lzo.LzoCompressor@6818c458
2013-02-17 14:47:50,879 INFO org.apache.hadoop.mapred.MapTask: Finished spill 4
2013-02-17 14:47:50,887 INFO org.apache.hadoop.mapred.Merger: Merging 5 sorted segments
2013-02-17 14:47:50,890 INFO org.apache.hadoop.io.compress.CodecPool: Borrowing codec: com.hadoop.compression.lzo.LzoDecompressor@66a23610
2013-02-17 14:47:50,891 INFO com.hadoop.compression.lzo.LzoDecompressor: calling decompressBytesDirect with buffer with: position: 0 and limit: 262144
2013-02-17 14:47:50,891 INFO com.hadoop.compression.lzo.LzoDecompressor: read: 245688 bytes from decompressor.
2013-02-17 14:47:50,891 INFO org.apache.hadoop.io.compress.CodecPool: Borrowing codec: com.hadoop.compression.lzo.LzoDecompressor@43684706
2013-02-17 14:47:50,892 INFO com.hadoop.compression.lzo.LzoDecompressor: calling decompressBytesDirect with buffer with: position: 0 and limit: 65536
2013-02-17 14:47:50,895 INFO org.apache.hadoop.mapred.TaskLogsTruncater: Initializing logs&apos; truncater with mapRetainSize=-1 and reduceRetainSize=-1
2013-02-17 14:47:50,897 FATAL org.apache.hadoop.mapred.Child: Error running child : java.lang.InternalError: lzo1x_decompress returned: -4
        at com.hadoop.compression.lzo.LzoDecompressor.decompressBytesDirect(Native Method)
        at com.hadoop.compression.lzo.LzoDecompressor.decompress(LzoDecompressor.java:307)
        at org.apache.hadoop.io.compress.BlockDecompressorStream.decompress(BlockDecompressorStream.java:82)
        at org.apache.hadoop.io.compress.DecompressorStream.read(DecompressorStream.java:75)
        at org.apache.hadoop.mapred.IFile$Reader.readData(IFile.java:341)
        at org.apache.hadoop.mapred.IFile$Reader.rejigData(IFile.java:371)
        at org.apache.hadoop.mapred.IFile$Reader.readNextBlock(IFile.java:355)
        at org.apache.hadoop.mapred.IFile$Reader.next(IFile.java:387)
        at org.apache.hadoop.mapred.Merger$Segment.next(Merger.java:220)
        at org.apache.hadoop.mapred.Merger$MergeQueue.merge(Merger.java:420)
        at org.apache.hadoop.mapred.Merger$MergeQueue.merge(Merger.java:381)
        at org.apache.hadoop.mapred.Merger.merge(Merger.java:77)
        at org.apache.hadoop.mapred.MapTask$MapOutputBuffer.mergeParts(MapTask.java:1548)
        at org.apache.hadoop.mapred.MapTask$MapOutputBuffer.flush(MapTask.java:1180)
        at org.apache.hadoop.mapred.MapTask$NewOutputCollector.close(MapTask.java:582)
        at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:649)
        at org.apache.hadoop.mapred.MapTask.run(MapTask.java:323)
        at org.apache.hadoop.mapred.Child$4.run(Child.java:270)
        at java.security.AccessController.doPrivileged(Native Method)
        at javax.security.auth.Subject.doAs(Subject.java:396)
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1213)
        at org.apache.hadoop.mapred.Child.main(Child.java:264)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(Some additional LOG.info statements were added to produce the above output which are not in this patch).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12633535">PIG-3208</key>
            <summary>[zebra] TFile should not set io.compression.codec.lzo.buffersize</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ekoontz">Eugene Koontz</assignee>
                                    <reporter username="ekoontz">Eugene Koontz</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 Feb 2013 02:30:35 +0000</created>
                <updated>Mon, 14 Oct 2013 17:46:30 +0100</updated>
                            <resolved>Tue, 19 Mar 2013 23:34:44 +0000</resolved>
                                                    <fixVersion>0.12.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13583839" author="ekoontz" created="Fri, 22 Feb 2013 02:31:57 +0000"  >&lt;p&gt;Removes the two cases where &lt;tt&gt;io.compression.codec.lzo.buffersize&lt;/tt&gt; is set to 64*1024.&lt;/p&gt;</comment>
                            <comment id="13605754" author="daijy" created="Mon, 18 Mar 2013 22:34:21 +0000"  >&lt;p&gt;Hi, Eugene, Zebra is no longer supported except for compilation errors. You can continue to use it but we will not commit patches/fix bugs. &lt;/p&gt;</comment>
                            <comment id="13605765" author="dvryaboy" created="Mon, 18 Mar 2013 22:46:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt; why wouldn&apos;t we commit fixes provided by community? &lt;/p&gt;</comment>
                            <comment id="13605835" author="daijy" created="Tue, 19 Mar 2013 00:05:13 +0000"  >&lt;p&gt;Ok, I am not objecting to that. My concern is if a fix introduces other issues unintentionally, nobody would look at it. But I am fine if that happens, we simply revert the patch.&lt;/p&gt;</comment>
                            <comment id="13606016" author="xuefuz" created="Tue, 19 Mar 2013 03:46:48 +0000"  >&lt;p&gt;I guess Daniel meant to say that Zebra isn&apos;t in active development, which is true. I think if people uses it problem will be discovered. As long as any fix contributed meets the quality requirement, the whole community benefits from it. &lt;/p&gt;</comment>
                            <comment id="13606023" author="xuefuz" created="Tue, 19 Mar 2013 03:55:49 +0000"  >&lt;p&gt;Eugene,&lt;/p&gt;

&lt;p&gt;If we remove the two lines, will Zebra take whatever the default is from the cluster settings? What happens if it&apos;s not set in the cluster?&lt;/p&gt;

&lt;p&gt;Also, for your changes, we&apos;ll need to run the tests to watch for regressions.&lt;/p&gt;</comment>
                            <comment id="13606028" author="daijy" created="Tue, 19 Mar 2013 04:05:58 +0000"  >&lt;p&gt;Thanks Xuefu chime in. I am happy to check in any Zebra patches you are Ok with.&lt;/p&gt;</comment>
                            <comment id="13606756" author="ekoontz" created="Tue, 19 Mar 2013 20:35:47 +0000"  >&lt;p&gt;Hi Xuefu, Daniel and Dmitriy,&lt;/p&gt;

&lt;p&gt;Thanks for considering this patch!&lt;/p&gt;

&lt;p&gt;Xuefu, yes, Zebra will take its default from the cluster. If you don&apos;t set it, then it will be set by the version of hadoop-lzo that you use. For example, if you use trunk, it will be 256*1024; please see:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/twitter/hadoop-lzo/blob/master/src/java/com/hadoop/compression/lzo/LzoCodec.java#L51&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/twitter/hadoop-lzo/blob/master/src/java/com/hadoop/compression/lzo/LzoCodec.java#L51&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;See also discussion between @kevinweil and @tlipcon here: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/twitter/hadoop-lzo/commit/3afba3037be4152fcc088ddb13f2ec12e659ed9c&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/twitter/hadoop-lzo/commit/3afba3037be4152fcc088ddb13f2ec12e659ed9c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;-Eugene&lt;/p&gt;</comment>
                            <comment id="13606773" author="ekoontz" created="Tue, 19 Mar 2013 20:45:13 +0000"  >&lt;p&gt;Correction, it will take its &lt;b&gt;setting&lt;/b&gt; from the cluster - the &lt;b&gt;default&lt;/b&gt; is what is supplied by the LZO code in the mentioned link: &lt;a href=&quot;https://github.com/twitter/hadoop-lzo/blob/master/src/java/com/hadoop/compression/lzo/LzoCodec.java#L51&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/twitter/hadoop-lzo/blob/master/src/java/com/hadoop/compression/lzo/LzoCodec.java#L51&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13606780" author="xuefuz" created="Tue, 19 Mar 2013 20:50:50 +0000"  >&lt;p&gt;Got it. &lt;/p&gt;

&lt;p&gt;+1 to the patch. &lt;/p&gt;

&lt;p&gt;However, I forgot the regression testing process. Otherwise, the patch seems fine.&lt;/p&gt;</comment>
                            <comment id="13607029" author="daijy" created="Tue, 19 Mar 2013 23:33:03 +0000"  >&lt;p&gt;The zebra unit tests on trunk is already broken:&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.hadoop.zebra.io.TestCheckin&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 107, Failures: 0, Errors: 8, Time elapsed: 15.197 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.hadoop.zebra.types.TestCheckin&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 62, Failures: 0, Errors: 32, Time elapsed: 0.222 sec&lt;br/&gt;
This patch does not make things worse. I am going to checkin.&lt;/p&gt;</comment>
                            <comment id="13607033" author="daijy" created="Tue, 19 Mar 2013 23:34:44 +0000"  >&lt;p&gt;Patch committed to trunk. Thanks Eugene, Xuefu!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12570406" name="PIG-3208.patch" size="994" author="ekoontz" created="Fri, 22 Feb 2013 02:31:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 18 Mar 2013 22:34:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314030</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzc1hz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314375</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>