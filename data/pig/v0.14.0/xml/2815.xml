<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:10:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2815/PIG-2815.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2815] class loader management in PigContext</title>
                <link>https://issues.apache.org/jira/browse/PIG-2815</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The way &lt;tt&gt;PigContext.classloader&lt;/tt&gt; and resolveClassName() are managed can lead to strange class loading issues, especially when not all &lt;tt&gt;register&lt;/tt&gt; statements are at the top (example in the first comment).&lt;/p&gt;

&lt;p&gt;Two factors contribute to this: sometimes only one of them and sometimes together:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;a new classloader (CL) is created after registering each jar.
	&lt;ul&gt;
		&lt;li&gt;but the new jar&apos;s parent is the root CL rather than previous CL, effectively throwing previous CL away.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;resolveClassName() caches classes based on just the name
	&lt;ul&gt;
		&lt;li&gt;A class is not defined by name alone. Classes loaded by two different unrelated CLs are different objects even if both extract the class from same physical jar file.&lt;/li&gt;
		&lt;li&gt;because of (1), the cached class is not necessarily same as the class that would be loaded based on &apos;current&apos; CL&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;having different class objects for same class have many subtle side effects. e.g. there would be two instances of static variables. &lt;/p&gt;

&lt;p&gt;I think both should be fixed.. thought fixing one of them might be good enough in many cases. I will add a patch.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12598667">PIG-2815</key>
            <summary>class loader management in PigContext</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rangadi">Raghu Angadi</assignee>
                                    <reporter username="rangadi">Raghu Angadi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Jul 2012 07:41:44 +0100</created>
                <updated>Fri, 22 Feb 2013 04:53:35 +0000</updated>
                            <resolved>Thu, 6 Dec 2012 23:31:05 +0000</resolved>
                                    <version>0.9.0</version>
                                    <fixVersion>0.11</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13413532" author="rangadi" created="Fri, 13 Jul 2012 08:08:09 +0100"  >
&lt;p&gt;An example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;register elephant-bird.jar; -- for working with Thrift objects.
-- (1)

register T_One.jar;
-- (2)

-- ThriftPigLoader takes name of a Thrift class that corresponds to input.
a = load &apos;/logs/T_One&apos; using ThriftPigLoader(&apos;thrift.gen.T_One&apos;);
-- (3)

register second.jar; 
-- (4)

b = load &apos;/logs/T_two&apos; using ThriftPigLoader(&apos;thrift.gen.T_two&apos;);

-- (5)
-- FAIL!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;(1): new classlaoder cl_A is created with root classloader as the parent.&lt;/li&gt;
	&lt;li&gt;(2): cl_B is created with root as the parent.&lt;/li&gt;
	&lt;li&gt;(3): &lt;tt&gt;ThirftPigLoader.class&lt;/tt&gt; is instantiated with cl_B and cached.&lt;/li&gt;
	&lt;li&gt;(4): cl_C is created with root as the parent.&lt;/li&gt;
	&lt;li&gt;(5): &lt;tt&gt;thrift.gen.T_two.class&lt;/tt&gt; is instantiated with cl_C, but &apos;&lt;tt&gt;ThriftPigLoader.class&lt;/tt&gt;&apos; from cl_B is reused by Pig. So all the Thrift classes seen by ThriftPigLoader are entirely different from all the Thrift classes seen by &lt;tt&gt;thrift.gen.T_two&lt;/tt&gt; since cl_B is not a parent of cl_C. That can lead to a number of issues and it does.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13413538" author="rangadi" created="Fri, 13 Jul 2012 08:18:40 +0100"  >&lt;p&gt;changes in the patch :&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;remove &apos;classCache&apos;:&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
	&lt;li&gt;may be resolveClassName() could cache the &apos;prefix&apos; that successfully loaded a class to avoid checking other prefixes. Reloading an existing class is not costly since JVM has a cache anyway.&lt;/li&gt;
	&lt;li&gt;I don&apos;t think this is a perf issue either way.&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;use a classloader that supports adding jars.&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
	&lt;li&gt;not sure if it is common practice to add resources.. or if there are any side effects.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13414029" author="jcoveney" created="Fri, 13 Jul 2012 21:40:14 +0100"  >&lt;p&gt;Raghu,&lt;/p&gt;

&lt;p&gt;This is awesome. Is there any hope that you could add a test that fails in the current setup? I think that would be important as far as conveying a concrete use case when this fails (which your example does, but if we have a test that fails it&apos;ll be super super concrete.&lt;/p&gt;

&lt;p&gt;Thanks for doing this. Awesome.&lt;/p&gt;

&lt;p&gt;Jon&lt;/p&gt;</comment>
                            <comment id="13414901" author="rangadi" created="Mon, 16 Jul 2012 08:37:17 +0100"  >&lt;p&gt;unit test : update &lt;tt&gt;TestRegisteredJarVisibility&lt;/tt&gt; to test for classloader &apos;consistency&apos;.&lt;/p&gt;</comment>
                            <comment id="13414933" author="ashutoshc" created="Mon, 16 Jul 2012 09:51:46 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rangadi&quot; class=&quot;user-hover&quot; rel=&quot;rangadi&quot;&gt;Raghu Angadi&lt;/a&gt; Thanks for digging into it. Till now atleast in some cases if I registered the jar and then if I want to use it in Pig client frontend, I also necessarily need to add it in &lt;tt&gt;PIG_CLASSPATH&lt;/tt&gt;. Does this patch removes that restriction? Put another way, will registering the jar will automatically add the jar in pig&apos;s classpath?&lt;/p&gt;</comment>
                            <comment id="13415430" author="rangadi" created="Mon, 16 Jul 2012 18:37:22 +0100"  >
&lt;p&gt;Ashutosh, that issue is fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2532&quot; title=&quot;Registered classes fail deserialization in frontend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2532&quot;&gt;&lt;del&gt;PIG-2532&lt;/del&gt;&lt;/a&gt;. Let us know otherwise.&lt;/p&gt;

&lt;p&gt;Still there are some corner cases: e.g. if you use &lt;tt&gt;ObjectSerializer&lt;/tt&gt; on frontend, that class should be in CLASSPATH (the fix is to extend ObjectSerializer to take a classloader or it should use current threads classloader).&lt;/p&gt;
</comment>
                            <comment id="13415467" author="jcoveney" created="Mon, 16 Jul 2012 19:11:06 +0100"  >&lt;p&gt;+1, will commit once test-commit passes&lt;/p&gt;</comment>
                            <comment id="13415514" author="ashutoshc" created="Mon, 16 Jul 2012 19:53:31 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rangadi&quot; class=&quot;user-hover&quot; rel=&quot;rangadi&quot;&gt;Raghu Angadi&lt;/a&gt; I think I have hit on corner cases. Will file jira for it. Do you happen to know any other places where it will manifest ?&lt;/p&gt;</comment>
                            <comment id="13415522" author="jcoveney" created="Mon, 16 Jul 2012 19:57:22 +0100"  >&lt;p&gt;Committed. Thanks Raghu! Also: want to make a ticket for that ObjectSerializer CLASSPATH issue you mentioned?&lt;/p&gt;</comment>
                            <comment id="13415762" author="rangadi" created="Tue, 17 Jul 2012 00:00:35 +0100"  >&lt;p&gt;Thanks for the quick review Jon. filed &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2819&quot; title=&quot;ObjectSerializer should support classloader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2819&quot;&gt;&lt;del&gt;PIG-2819&lt;/del&gt;&lt;/a&gt; for ObjectSerializer.&lt;/p&gt;

&lt;p&gt;Ashutosh, new jira will be useful. not sure of specific corner cases, but I am sure they are there &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="13416622" author="rangadi" created="Tue, 17 Jul 2012 22:27:01 +0100"  >&lt;p&gt;patch for 0.9.&lt;/p&gt;</comment>
                            <comment id="13416656" author="jcoveney" created="Tue, 17 Jul 2012 23:09:28 +0100"  >&lt;p&gt;Raghu,&lt;/p&gt;

&lt;p&gt;Thanks for this. Note: in your patch for pig-0.9, you removed a default PigContext constructor. Not sure if you meant to do that on purpose.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; PigContext() {
   &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;(ExecType.MAPREDUCE, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Properties());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13417308" author="rangadi" created="Wed, 18 Jul 2012 18:48:03 +0100"  >&lt;p&gt;Thanks Jon.&lt;/p&gt;

&lt;p&gt;updated the patch. There was another small spurious change.&lt;/p&gt;</comment>
                            <comment id="13500567" author="julienledem" created="Mon, 19 Nov 2012 19:46:16 +0000"  >&lt;p&gt;It sounds like this has been committed. Can you resolve it?&lt;/p&gt;</comment>
                            <comment id="13508451" author="cheolsoo" created="Mon, 3 Dec 2012 04:02:51 +0000"  >&lt;p&gt;It seems that the patch is committed to 0.11/trunk but not to 0.9/0.10.&lt;/p&gt;

&lt;p&gt;Please let me know if anyone wants this to be committed to 0.9/0.10. Or I will close the jira.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13525809" author="julienledem" created="Thu, 6 Dec 2012 22:09:37 +0000"  >&lt;p&gt;0.11/trunk sounds good to me&lt;/p&gt;</comment>
                            <comment id="13526000" author="cheolsoo" created="Thu, 6 Dec 2012 23:31:05 +0000"  >&lt;p&gt;Closed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12537029" name="PIG-2815-branch-0.9.patch" size="6680" author="rangadi" created="Wed, 18 Jul 2012 18:48:03 +0100"/>
                            <attachment id="12536893" name="PIG-2815-branch-0.9.patch" size="6933" author="rangadi" created="Tue, 17 Jul 2012 22:27:01 +0100"/>
                            <attachment id="12536600" name="PIG-2815.patch" size="6594" author="rangadi" created="Mon, 16 Jul 2012 08:37:16 +0100"/>
                            <attachment id="12536343" name="PIG-2815.patch" size="2995" author="rangadi" created="Fri, 13 Jul 2012 08:18:40 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 13 Jul 2012 20:40:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256431</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyb067:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98171</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>