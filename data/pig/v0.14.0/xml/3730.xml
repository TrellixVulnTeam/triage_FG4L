<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:05:03 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3730/PIG-3730.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3730] Performance issue in SelfSpillBag</title>
                <link>https://issues.apache.org/jira/browse/PIG-3730</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;We have bunch of joins in our pig scripts (joining 5 to 15 datasets together).  Pig creates a bunch of REPLICATED, HASH_JOINs and we observed heavy performance degradation in one of the launched M/R job.  This was specifically on the reducer side.  Taking multiple threaddumps revealed the following&lt;/p&gt;

&lt;p&gt;&quot;main&quot; prio=10 tid=0x00007fbaa801c000 nid=0x1464 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007fbaaee76000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
	at org.apache.hadoop.conf.Configuration.getProps(Configuration.java:1781)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00000000b5316370&amp;gt; (a org.apache.hadoop.mapred.JobConf)&lt;br/&gt;
	at org.apache.hadoop.conf.Configuration.get(Configuration.java:712)&lt;br/&gt;
	at org.apache.pig.data.SelfSpillBag$MemoryLimits.init(SelfSpillBag.java:73)&lt;br/&gt;
	at org.apache.pig.data.SelfSpillBag$MemoryLimits.&amp;lt;init&amp;gt;(SelfSpillBag.java:65)&lt;br/&gt;
	at org.apache.pig.data.SelfSpillBag.&amp;lt;init&amp;gt;(SelfSpillBag.java:39)&lt;br/&gt;
	at org.apache.pig.data.InternalCachedBag.&amp;lt;init&amp;gt;(InternalCachedBag.java:63)&lt;br/&gt;
	at org.apache.pig.data.InternalCachedBag.&amp;lt;init&amp;gt;(InternalCachedBag.java:59)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POJoinPackage.getNext(POJoinPackage.java:146)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapReduce$Reduce.processOnePackageOutput(PigGenericMapReduce.java:422)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapReduce$Reduce.reduce(PigGenericMapReduce.java:405)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapReduce$Reduce.reduce(PigGenericMapReduce.java:257)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:164)&lt;br/&gt;
	at org.apache.hadoop.mapred.ReduceTask.runNewReducer(ReduceTask.java:610)&lt;br/&gt;
	at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:444)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child$4.run(Child.java:268)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at javax.security.auth.Subject.doAs(Subject.java:415)&lt;br/&gt;
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1408)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child.main(Child.java:262)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;at org.apache.hadoop.conf.Configuration.getProps(Configuration.java:1781)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00000000b5316388&amp;gt; (a org.apache.hadoop.mapred.JobConf)&lt;br/&gt;
	at org.apache.hadoop.conf.Configuration.get(Configuration.java:712)&lt;br/&gt;
	at org.apache.pig.data.SelfSpillBag$MemoryLimits.init(SelfSpillBag.java:73)&lt;br/&gt;
	at org.apache.pig.data.SelfSpillBag$MemoryLimits.&amp;lt;init&amp;gt;(SelfSpillBag.java:65)&lt;br/&gt;
	at org.apache.pig.data.SelfSpillBag.&amp;lt;init&amp;gt;(SelfSpillBag.java:39)&lt;br/&gt;
	at org.apache.pig.data.InternalCachedBag.&amp;lt;init&amp;gt;(InternalCachedBag.java:63)&lt;br/&gt;
	at org.apache.pig.data.InternalCachedBag.&amp;lt;init&amp;gt;(InternalCachedBag.java:59)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POJoinPackage.getNext(POJoinPackage.java:146)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapReduce$Reduce.processOnePackageOutput(PigGenericMapReduce.java:422)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapReduce$Reduce.reduce(PigGenericMapReduce.java:405)&lt;br/&gt;
	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapReduce$Reduce.reduce(PigGenericMapReduce.java:257)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:164)&lt;br/&gt;
	at org.apache.hadoop.mapred.ReduceTask.runNewReducer(ReduceTask.java:610)&lt;br/&gt;
	at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:444)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child$4.run(Child.java:268)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at javax.security.auth.Subject.doAs(Subject.java:415)&lt;br/&gt;
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1408)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child.main(Child.java:262)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In certain corner cases (where pig.cachedbag.type is not &quot;default&quot;), InternalCachedBag is initialized in POJoinPackage.  &lt;/p&gt;

&lt;p&gt;InternalCachedBag internally calls SelfSpillBag--&amp;gt; MemoryLimits --&amp;gt; PigMapReduce.sJobConfInternal.get().get(&lt;br/&gt;
                        PigConfiguration.PROP_CACHEDBAG_MEMUSAGE);&lt;/p&gt;

&lt;p&gt;Since this is happening very frequently, the cost of Configuration.get()  itself is increasing causing the degradation.  Here is the counters snippet from one of the reducer.&lt;/p&gt;

&lt;p&gt;E.g : counter snippet from a reducer&lt;br/&gt;
        FILE: Number of bytes read 	57,762,717&lt;br/&gt;
	FILE: Number of bytes written 	25,256,417&lt;br/&gt;
        HDFS: Number of bytes read 	0&lt;br/&gt;
	HDFS: Number of bytes written 	2,521,311&lt;br/&gt;
	HDFS: Number of read operations 	0&lt;br/&gt;
	HDFS: Number of large read operations 	0&lt;br/&gt;
	HDFS: Number of write operations 	1&lt;/p&gt;

&lt;p&gt; 	Reduce input groups 	4,282,722&lt;br/&gt;
	Reduce shuffle bytes 	26,858,192&lt;br/&gt;
	Reduce input records 	4,912,881&lt;br/&gt;
	Reduce output records 	630,159&lt;br/&gt;
	Spilled Records 	4,912,881&lt;/p&gt;</description>
                <environment>&lt;p&gt;Pig 0.11 with MR-V1&lt;/p&gt;</environment>
        <key id="12692067">PIG-3730</key>
            <summary>Performance issue in SelfSpillBag</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajesh.balamohan">Rajesh Balamohan</assignee>
                                    <reporter username="rajesh.balamohan">Rajesh Balamohan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Jan 2014 16:06:33 +0000</created>
                <updated>Mon, 7 Jul 2014 19:08:05 +0100</updated>
                            <resolved>Thu, 30 Jan 2014 16:39:14 +0000</resolved>
                                    <version>0.11</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13885467" author="rajesh.balamohan" created="Wed, 29 Jan 2014 16:12:08 +0000"  >&lt;p&gt;v1 patch for trunk&lt;/p&gt;</comment>
                            <comment id="13885569" author="rohini" created="Wed, 29 Jan 2014 17:33:22 +0000"  >&lt;p&gt;Even long max = Runtime.getRuntime().maxMemory(); can be moved to the static block.&lt;/p&gt;</comment>
                            <comment id="13885914" author="rajesh.balamohan" created="Wed, 29 Jan 2014 22:26:49 +0000"  >&lt;p&gt;Thanks Rohini.  Uploading v2 patch for trunk.&lt;/p&gt;</comment>
                            <comment id="13885988" author="rohini" created="Wed, 29 Jan 2014 23:25:46 +0000"  >&lt;p&gt;+1. Will commit after running tests. Also reminded me that I haven&apos;t put up the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3456&quot; title=&quot;Reduce threadlocal conf access in backend for each record&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3456&quot;&gt;&lt;del&gt;PIG-3456&lt;/del&gt;&lt;/a&gt;, where I fixed same kind of Threadlocal configuration access in lot of other places.&lt;/p&gt;</comment>
                            <comment id="13886058" author="rajesh.balamohan" created="Thu, 30 Jan 2014 00:13:01 +0000"  >&lt;p&gt;Thanks a lot Rohini.&lt;/p&gt;</comment>
                            <comment id="13886757" author="rohini" created="Thu, 30 Jan 2014 16:39:14 +0000"  >&lt;p&gt;Committed to trunk. Thanks Rajesh.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12667819">PIG-3456</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12625890" name="PIG-3730-trunk-v1.patch" size="1597" author="rajesh.balamohan" created="Wed, 29 Jan 2014 16:12:08 +0000"/>
                            <attachment id="12625994" name="PIG-3730-trunk-v2.patch" size="1951" author="rajesh.balamohan" created="Wed, 29 Jan 2014 22:26:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Jan 2014 17:33:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370657</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzlqf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370967</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>