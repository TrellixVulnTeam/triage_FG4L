<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:00:57 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2578/PIG-2578.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2578] Multiple Store-commands mess up mapred.output.dir.</title>
                <link>https://issues.apache.org/jira/browse/PIG-2578</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;When one runs a pig-script with multiple storers, one sees the following:&lt;br/&gt;
1. When run as a script, Pig launches a single job.&lt;br/&gt;
2. PigOutputCommitter::setupJob() calls the underlyingOutputCommitter::setupJob(), once for each storer. But the mapred.output.dir is the same for both calls, even though the storers write to different locations. &lt;/p&gt;

&lt;p&gt;This was originally seen in &lt;a href=&quot;https://issues.apache.org/jira/browse/HCATALOG-276&quot; title=&quot;After merging in HCATALOG-237 related changes Pig scripts with more than one store fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HCATALOG-276&quot;&gt;&lt;del&gt;HCATALOG-276&lt;/del&gt;&lt;/a&gt;, when HCatalog&apos;s end-to-end tests are run against Pig.&lt;br/&gt;
(&lt;a href=&quot;https://issues.apache.org/jira/browse/HCATALOG-276&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HCATALOG-276&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Sample pig-script (near identical to HCatalog&apos;s Pig_Checkin_4 test):&lt;/p&gt;

&lt;p&gt;a = load &apos;keyvals&apos; using org.apache.hcatalog.pig.HCatLoader();&lt;br/&gt;
split a into b if key&amp;lt;200, c if key &amp;gt;=200;&lt;br/&gt;
store b into &apos;keyvals_lt200&apos; using org.apache.hcatalog.pig.HCatStorer();&lt;br/&gt;
store c into &apos;keyvals_ge200&apos; using org.apache.hcatalog.pig.HCatStorer();&lt;/p&gt;

&lt;p&gt;I&apos;ve suggested a workaround in HCat for the time being, but I think this might be something that needs fixing in Pig.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12545939">PIG-2578</key>
            <summary>Multiple Store-commands mess up mapred.output.dir.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="mithun">Mithun Radhakrishnan</reporter>
                        <labels>
                    </labels>
                <created>Sat, 10 Mar 2012 02:23:30 +0000</created>
                <updated>Fri, 24 Aug 2012 04:41:55 +0100</updated>
                            <resolved>Sat, 14 Apr 2012 09:03:38 +0100</resolved>
                                    <version>0.8.1</version>
                    <version>0.9.2</version>
                                    <fixVersion>0.10.0</fixVersion>
                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13228506" author="ashutoshc" created="Tue, 13 Mar 2012 16:40:32 +0000"  >&lt;p&gt;I am finding this a bit surprising. If this were to be true, multi-query cannot work effectively, since then both stores using FileOutputFormat will effectively write in same directory, messing up the outputs of each other. I suspect problem may exist in HCatalog. A test-case independent of HCatalog demonstrating Pig bug will be highly appreciated. &lt;/p&gt;</comment>
                            <comment id="13253654" author="daijy" created="Fri, 13 Apr 2012 20:06:25 +0100"  >&lt;p&gt;There two folds of this issue:&lt;br/&gt;
1. I found one bug in Pig which we didn&apos;t make a copy of hadoop configuration before invoking various StoreFunc hooks. This is more obvious under hadoop 23 for HCat when hadoop need &quot;mapred.output.dir&quot; in OutputCommitter to move promote output.&lt;br/&gt;
2. There is also a fix on HCat side. setStoreLocation suppose to set up the right &quot;mapred.output.dir&quot;&lt;/p&gt;</comment>
                            <comment id="13253656" author="daijy" created="Fri, 13 Apr 2012 20:07:43 +0100"  >&lt;p&gt;Attach the patch in Pig side.&lt;/p&gt;</comment>
                            <comment id="13253661" author="daijy" created="Fri, 13 Apr 2012 20:18:18 +0100"  >&lt;p&gt;HCat side fix is part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HCATALOG-375&quot; title=&quot;Make HCat work for Hadoop 0.23&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HCATALOG-375&quot;&gt;&lt;del&gt;HCATALOG-375&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13253662" author="thejas" created="Fri, 13 Apr 2012 20:19:04 +0100"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13254056" author="daijy" created="Sat, 14 Apr 2012 09:03:42 +0100"  >&lt;p&gt;Patch committed to 0.10/trunk.&lt;/p&gt;</comment>
                            <comment id="13432880" author="billgraham" created="Mon, 13 Aug 2012 02:41:52 +0100"  >&lt;p&gt;This patch has caused some issues, see &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2870&quot; title=&quot;pigServer.openIterator fails for jobs with no input splits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2870&quot;&gt;&lt;del&gt;PIG-2870&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13433481" author="rohini" created="Mon, 13 Aug 2012 21:09:52 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2821&quot; title=&quot;HBaseStorage should work with secure hbase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2821&quot;&gt;&lt;del&gt;PIG-2821&lt;/del&gt;&lt;/a&gt; is another issue which has problems because of this patch. &lt;/p&gt;

&lt;p&gt;We should revert this patch.&lt;/p&gt;

&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2578&quot; title=&quot;Multiple Store-commands mess up mapred.output.dir.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2578&quot;&gt;&lt;del&gt;PIG-2578&lt;/del&gt;&lt;/a&gt;, setting config or credentials in job is not actually being passed to the actual job launched. The testcase in MultiQueryLocal is not valid as the condition (job.getConfiguration().get(key)==null) is always true. It was always using the suffix initialized in the constructor and never from the job. If a StoreFunc adds config to Job then it should be its responsibility to handle multiple instances of it. &lt;a href=&quot;https://issues.apache.org/jira/browse/HCATALOG-314&quot; title=&quot;HCatOutputFormat.setOutput is called more than once by HCatStorer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HCATALOG-314&quot;&gt;&lt;del&gt;HCATALOG-314&lt;/del&gt;&lt;/a&gt; handles it for hcatalog and fixes the original issue reported. We should not remove the ability for a StoreFunc to set a config on the job.&lt;/p&gt;</comment>
                            <comment id="13433772" author="rohini" created="Tue, 14 Aug 2012 01:21:44 +0100"  >&lt;p&gt;Spoke with Daniel. He said it was intentional to make the JobConf read-only so that each store does not override another. But the problem with that is it does not allow addition of Credentials and setting of JT specific config like Distributed cache configuration on the Job. We need a more cleaner solution to solve it and prevent StoreFunc implementations to not put something in JobConf that will not work correctly with multiple stores. We got rid of the multiple stores messing up problem in hcat by putting the properties in UDFContext instead of Job. But cannot expect all StoreFunc implementations to do that unless forced to which was the intention of this JIRA. &lt;/p&gt;</comment>
                            <comment id="13433810" author="dvryaboy" created="Tue, 14 Aug 2012 02:06:28 +0100"  >&lt;p&gt;I am aware of many StoreFunc implementations that rely on being able to mess with the JobConf. This is an undocumented and backwards incompatible change.. I can see why we need it, but the proper way to do this would be to document it, provide explicit instructions on using UDFContext (and how/where/when to get it), and migrate piggybank and builtin storefuncs that rely on mutable jobconfs. Further, to make the contract clear, rather than passing in a dummy new jobConf that gets GC&apos;d immediately, we should pass in a wrapper job conf which throws exceptions on any set() call, to prevent surprises.&lt;/p&gt;</comment>
                            <comment id="13433834" author="billgraham" created="Tue, 14 Aug 2012 03:08:57 +0100"  >&lt;p&gt;Regarding the wrapper job conf, in some cases I&apos;m sure it&apos;s justified to set a conf. What if we throw an exception if a value set attempt occurs where a different value already exists? We could include messaging about how UDFContext if probably what they want. This approach would be backward compatible with jobs that use conf properly with a single-store job, for example.&lt;/p&gt;</comment>
                            <comment id="13434548" author="rohini" created="Tue, 14 Aug 2012 22:45:34 +0100"  >&lt;p&gt;Did some debugging with and without &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2578&quot; title=&quot;Multiple Store-commands mess up mapred.output.dir.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2578&quot;&gt;&lt;del&gt;PIG-2578&lt;/del&gt;&lt;/a&gt;. Multiple storage using PigStorage worked fine in both cases. This is because before every getOutputFormat call, there is a setLocation with a copy of JobContext or TaskAttemptContext and that copy was passed to getOutputCommitter(), getRecordWriter() or checkOutputSpecs() calls. So the output format actually runs with the correct configuration. So multiple store commands don&apos;t always get messed up. The corner case problem I see is that, if one instance of the store set a configuration to a specific value and another instance of the store does not set any value at all for that config it will still get the config with the value set from the copy of the job put by the first instance(without &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2578&quot; title=&quot;Multiple Store-commands mess up mapred.output.dir.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2578&quot;&gt;&lt;del&gt;PIG-2578&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;The actual problem was with the hcat code when this jira was filed. It set the mapred.output.dir and lot of other properties in front end but not in the backened during setStoreLocation. &lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc/incubator/hcatalog/branches/branch-0.4/src/java/org/apache/hcatalog/pig/HCatStorer.java?revision=1325867&amp;amp;view=markup&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/incubator/hcatalog/branches/branch-0.4/src/java/org/apache/hcatalog/pig/HCatStorer.java?revision=1325867&amp;amp;view=markup&lt;/a&gt;&lt;br/&gt;
If it had set the mapred.output.dir in the backend also, it would have worked fine. It was later fixed to do so.&lt;/p&gt;</comment>
                            <comment id="13438929" author="rangadi" created="Tue, 21 Aug 2012 19:31:57 +0100"  >&lt;p&gt;Thanks for the analysis Rohini. +1 for reverting this patch. &lt;/p&gt;

&lt;p&gt;For the larger issue, I think Pig should clearly define the contract for job/conf passed setLocation() and setStoreLocation() so the user&apos;s StoreFunc can be implemented properly. I would suggest resisting the temptation to say &quot;this method might be called any number of times&quot; (a variant of this appears multiple places in Pig interface). While this made UDF implementors think twice about what they are doing, it allowed Pig to implement work arounds rather than proper fixes (i.e. why is &quot;setStoreLocation()&quot; called so many places?).&lt;/p&gt;</comment>
                            <comment id="13438959" author="billgraham" created="Tue, 21 Aug 2012 20:13:51 +0100"  >&lt;p&gt;I think the problem is not that as much that setStoreLocation can get called multiple times, but that from the Javadocs it&apos;s not clear what the effects (or side-effects) will occur when setStoreLocation sets values in the Config.&lt;/p&gt;

&lt;p&gt;+1 on reverting this patch and adding better javadocs for starters since the build is currently broken for a number of common use cases. We can then add examples and safeguards to illustrate proper usage in a multi-store environment.&lt;/p&gt;</comment>
                            <comment id="13439103" author="daijy" created="Tue, 21 Aug 2012 23:20:02 +0100"  >&lt;p&gt;I am fine with reverting the patch. The underlying problem is setStoreLocation is the only hook for StoreFunc for multiple purpose. In the javadoc, we shall make it clear:&lt;br/&gt;
1. Need to distinguish frontend/backend (using UDFContext.isFrontend()), user can setup global configuration in the frontend, but can only setup store only configuration in the backend&lt;br/&gt;
2. When setting up global configuration, need to bear in mind there could be multiple store, so config entries can overwrite each other.&lt;/p&gt;</comment>
                            <comment id="13440912" author="dvryaboy" created="Fri, 24 Aug 2012 04:41:55 +0100"  >&lt;p&gt;Reverted in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2890&quot; title=&quot;Revert  PIG-2578&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2890&quot;&gt;&lt;del&gt;PIG-2890&lt;/del&gt;&lt;/a&gt;. I don&apos;t see a way to reopen this jira and change it to won&apos;t fix..&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12544146">HCATALOG-276</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12603158">PIG-2870</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12522606" name="PIG-2578-1.patch" size="7078" author="daijy" created="Fri, 13 Apr 2012 20:07:43 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Mar 2012 16:40:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231120</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy3t07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56023</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>