<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:10:46 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2923/PIG-2923.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2923] Lazily register bags with SpillableMemoryManager</title>
                <link>https://issues.apache.org/jira/browse/PIG-2923</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Currently, all Spillable DataBags get registered by the BagFactory at the moment of creation. In practice, a lot of these bags will not get large enough to be worth spilling; we can avoid a lot of memory overhead and cheapen the process of finding a bag to spill when we do need it, by allowing Bags themselves to register when they grow to some respectable threshold.&lt;/p&gt;

&lt;p&gt;Related JIRAs: &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2917&quot; title=&quot;SpillableMemoryManager memory leak for WeakReference&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2917&quot;&gt;&lt;del&gt;PIG-2917&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2918&quot; title=&quot;Avoid Spillable bag overhead where possible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2918&quot;&gt;&lt;del&gt;PIG-2918&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12607847">PIG-2923</key>
            <summary>Lazily register bags with SpillableMemoryManager</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dvryaboy">Dmitriy V. Ryaboy</assignee>
                                    <reporter username="dvryaboy">Dmitriy V. Ryaboy</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Sep 2012 03:58:55 +0100</created>
                <updated>Fri, 22 Feb 2013 04:53:38 +0000</updated>
                            <resolved>Fri, 28 Sep 2012 19:31:05 +0100</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13456749" author="dvryaboy" created="Mon, 17 Sep 2012 05:17:27 +0100"  >&lt;p&gt;This patch introduces the following changes:&lt;/p&gt;

&lt;p&gt;1) Make SpillableMemoryManager a real singleton (before, it was assumed to be a singleton, but the assumption was not enforced)&lt;/p&gt;

&lt;p&gt;2) deprecates BagFactory&apos;s registerBag() method, as it is no longer a Factory&apos;s job to do this. Also removes calls to this method from the default implementation.&lt;/p&gt;

&lt;p&gt;3) gets rid of some redundant code for addAll() methods in various databag implementations&lt;/p&gt;

&lt;p&gt;4) introduces a markSpillableIfNecessary method in AbstractDataBag, which will register with the SMM if necessary (upon reaching a memory threshold of 100K).&lt;/p&gt;

&lt;p&gt;5) adds markSpillableIfNecessary calls to all spillable DataBags&apos; add() methods.&lt;/p&gt;

&lt;p&gt;TestDataBag passes, test-commit passes, TestDataBagAccess passes.&lt;/p&gt;

&lt;p&gt;While testing this, I discovered the fun fact that calling &lt;em&gt;size() on a DistinctDataBag causes it to stop being distinct&lt;/em&gt;. But that&apos;s for a different jira...&lt;/p&gt;</comment>
                            <comment id="13459751" author="alangates" created="Thu, 20 Sep 2012 18:11:33 +0100"  >&lt;p&gt;In DefaultAbstractBag it would be good to have a comment on the definition of SPILL_REGISTER_THRESHOLD to say what the unit is (K I think).&lt;/p&gt;

&lt;p&gt;DefaultAbstractBag.markSpillableIfNecessary in the line:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!spillableRegistered &amp;amp;&amp;amp; size() == SPILL_REGISTER_THRESHOLD)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Shouldn&apos;t that be &amp;gt;= instead of == ?  You may have already passed the size the first time you check.&lt;/p&gt;

&lt;p&gt;In TestDataBag, why control the seed?  Is this for repeatability of the test?&lt;/p&gt;</comment>
                            <comment id="13461226" author="dvryaboy" created="Sat, 22 Sep 2012 18:58:44 +0100"  >&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t that be &amp;gt;= instead of == ? You may have already passed the size the first time you check&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah that&apos;s a leftover from when I was trying to avoid having a &quot;spillableRegistered&quot; boolean added to bag overhead. I&apos;ll fix the conditional.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In TestDataBag, why control the seed? Is this for repeatability of the test?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep.&lt;/p&gt;</comment>
                            <comment id="13461228" author="dvryaboy" created="Sat, 22 Sep 2012 19:04:38 +0100"  >&lt;p&gt;Oh wow the patch I attached was the old version that breaks DistinctDataBag (due to the fact that size() on DDB makes it non-distinct.. ). The version I have sitting on my laptop uses getMemorySize() and does document what &quot;spill_register_threshold&quot; is (between patches it changes from 100 elements to 100 KB in ram).&lt;/p&gt;</comment>
                            <comment id="13461230" author="dvryaboy" created="Sat, 22 Sep 2012 19:07:09 +0100"  >&lt;p&gt;New patch attached, please review.&lt;/p&gt;</comment>
                            <comment id="13465275" author="dvryaboy" created="Fri, 28 Sep 2012 02:34:48 +0100"  >&lt;p&gt;review bump &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13465793" author="alangates" created="Fri, 28 Sep 2012 19:04:34 +0100"  >&lt;p&gt;+1.&lt;/p&gt;</comment>
                            <comment id="13465805" author="dvryaboy" created="Fri, 28 Sep 2012 19:31:05 +0100"  >&lt;p&gt;Committed to trunk.&lt;/p&gt;</comment>
                            <comment id="13565705" author="knoguchi" created="Tue, 29 Jan 2013 19:41:48 +0000"  >&lt;p&gt;Hi Dmitriy, I&apos;m seeing a weird error when pig 0.11 tries to spill. Can this change be related?  Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3147&quot; title=&quot;Spill failing with &amp;quot;java.lang.RuntimeException: InternalCachedBag.spill() should not be called&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3147&quot;&gt;&lt;del&gt;PIG-3147&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12611188">PIG-2963</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12546172" name="bagspill_delay.patch" size="23000" author="dvryaboy" created="Sat, 22 Sep 2012 19:06:25 +0100"/>
                            <attachment id="12545358" name="bagspill_delayed_register.patch" size="22088" author="dvryaboy" created="Mon, 17 Sep 2012 05:17:27 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 20 Sep 2012 17:11:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242077</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwd1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12602</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>