<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:02:54 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2563/PIG-2563.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2563] IndexOutOfBoundsException: while projecting fields from a bag</title>
                <link>https://issues.apache.org/jira/browse/PIG-2563</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The below script fails with Pig 0.9 / Pig 0.10 but works fine for Pig 0.8.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A = load &apos;i1&apos; as (a,b,c:chararray);
B = load &apos;i2&apos; as (d,e,f:chararray);
C = cogroup A by a, B by d;
D = foreach C { 
  tmp = B.d;
  tmp_dis = distinct tmp;
  generate A,B,tmp_dis ; } ;
E = foreach D generate B.(d,e) as v;
dump E;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The script fails with the below exception. Looks like DereferenceExpression is using wrong schema to build inner schema.&lt;/p&gt;

&lt;p&gt;java.lang.IndexOutOfBoundsException: Index: 1, Size: 1&lt;br/&gt;
	at java.util.ArrayList.RangeCheck(ArrayList.java:547)&lt;br/&gt;
	at java.util.ArrayList.get(ArrayList.java:322)&lt;br/&gt;
	at org.apache.pig.newplan.logical.relational.LogicalSchema.getField(LogicalSchema.java:653)&lt;br/&gt;
	at org.apache.pig.newplan.logical.expression.DereferenceExpression.getFieldSchema(DereferenceExpression.java:167)&lt;br/&gt;
	at org.apache.pig.newplan.logical.relational.LOGenerate.getSchema(LOGenerate.java:88)&lt;br/&gt;
	at org.apache.pig.newplan.logical.visitor.TypeCheckingRelVisitor.visit(TypeCheckingRelVisitor.java:160)&lt;br/&gt;
	at org.apache.pig.newplan.logical.relational.LOGenerate.accept(LOGenerate.java:242)&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12544636">PIG-2563</key>
            <summary>IndexOutOfBoundsException: while projecting fields from a bag</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="vivekp">Vivek Padmanabhan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Feb 2012 15:57:44 +0000</created>
                <updated>Thu, 26 Apr 2012 21:32:39 +0100</updated>
                            <resolved>Sun, 18 Mar 2012 08:24:30 +0000</resolved>
                                    <version>0.9.1</version>
                    <version>0.10.0</version>
                                    <fixVersion>0.10.0</fixVersion>
                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13220179" author="jcoveney" created="Thu, 1 Mar 2012 17:43:50 +0000"  >&lt;p&gt;Good catch! I&apos;ve seen similar errors before, but was never able to isolate it. I actually isolated it with an even smaller snippet below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A = load &apos;i1&apos; as (a,b,c:chararray);
B = GROUP A BY a;
C = foreach B { 
  tmp = A.a;
  generate A, tmp; } ;
D = foreach C generate A.(a,b) as v;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Perhaps related is the following, which has a weird parse error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A = load &apos;i1&apos; as (a,b,c:chararray);
B = GROUP A BY a;
C = foreach B { 
  tmp = A.a;
  generate A; } ;
D = foreach C generate A.(a,b) as v;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13221474" author="daijy" created="Sat, 3 Mar 2012 02:21:23 +0000"  >&lt;p&gt;Logical plan for the foreach nested plan is wrong. Using Jonathan&apos;s first test case as example:&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;---C: (Name: LOForEach Schema: A#21:bag
{#22:tuple(a#18:bytearray,b#19:bytearray,c#20:chararray)}
&lt;p&gt;,tmp#21:bag&lt;/p&gt;
{#22:tuple(a#18:bytearray)}
&lt;p&gt;)&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   (Name: LOGenerate&lt;span class=&quot;error&quot;&gt;&amp;#91;false,false&amp;#93;&lt;/span&gt; Schema: A#21:bag
{#22:tuple(a#18:bytearray,b#19:bytearray,c#20:chararray)}
&lt;p&gt;,tmp#21:bag&lt;/p&gt;
{#22:tuple(a#18:bytearray)}
&lt;p&gt;)&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   A:(Name: Project Type: bag Uid: 21 Input: 0 Column: &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   tmp:(Name: Project Type: bag Uid: 21 Input: 1 Column: &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;---A: (Name: LOInnerLoad&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; Schema: a#18:bytearray,b#19:bytearray,c#20:chararray)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Here we only generate one LOInnerLoad. We should generate two LOInnerLoad instead.&lt;/p&gt;</comment>
                            <comment id="13221475" author="daijy" created="Sat, 3 Mar 2012 02:22:14 +0000"  >&lt;p&gt;The plan is misformatted:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    |---C: (Name: LOForEach Schema: A#21:bag{#22:tuple(a#18:bytearray,b#19:bytearray,c#20:chararray)},tmp#21:bag{#22:tuple(a#18:bytearray)})
        |   |
        |   (Name: LOGenerate[&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;] Schema: A#21:bag{#22:tuple(a#18:bytearray,b#19:bytearray,c#20:chararray)},tmp#21:bag{#22:tuple(a#18:bytearray)})
        |   |   |
        |   |   A:(Name: Project Type: bag Uid: 21 Input: 0 Column: (*))
        |   |   |
        |   |   tmp:(Name: Project Type: bag Uid: 21 Input: 1 Column: (*))
        |   |
        |   |---A: (Name: LOInnerLoad[1] Schema: a#18:bytearray,b#19:bytearray,c#20:chararray)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13222660" author="daijy" created="Mon, 5 Mar 2012 22:12:10 +0000"  >&lt;p&gt;The real cause is the uid conflict in nested project. &lt;/p&gt;</comment>
                            <comment id="13222678" author="dvryaboy" created="Mon, 5 Mar 2012 22:25:13 +0000"  >&lt;p&gt;Cheap code style comments:&lt;/p&gt;

&lt;p&gt;The if/else blocks should either be bracketed by {}s, or converted to &lt;br/&gt;
fieldSchema.uid = needNewUid? LogicalExpression.getNextUid() : innerLoads.get(0).getProjection().getFieldSchema().uid;&lt;/p&gt;

&lt;p&gt;(Otherwise we get oddness when people try to edit the code and get confused about what is and isn&apos;t inside the if/else blocks).&lt;/p&gt;

&lt;p&gt;More expensive code content comments:&lt;/p&gt;

&lt;p&gt;Feels wrong to rely on checking for the parent, determining if it&apos;s a foreach, and returning a boolean to enforce id uniqueness. It&apos;s entirely possible that someone touches one of these operators without going through findReachableInnerLoad.... and still needs a unique id.&lt;/p&gt;

&lt;p&gt;Can we ensure the id is unique to begin with, when the tree is constructed? &lt;/p&gt;</comment>
                            <comment id="13224076" author="daijy" created="Wed, 7 Mar 2012 07:41:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;Cheap code style comments&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;sure will change&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;More expensive code content comments&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not sure if I completely understand your point, let me explain the design of foreach nested plan and why I make the change. Let me know if you need further explanation. Uid and schema inference process is very core to logical plan. If one changes anywhere in the process, he needs to make sure the existing functionality is not broken. In the patch, I change the way project infer its uid, because earlier, it does not generate new uid for the new bag after nested foreach. Here is how uid for foreach inner plan works:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;every foreach statement starts with LOInnerLoad, ends with LOGenerate&lt;/li&gt;
	&lt;li&gt;simple foreach should keep uid, eg: foreach a generate $1, $2, we shall keep the uid for $1, $2, even if it is a bag column, there are couple of places make this assumption&lt;/li&gt;
	&lt;li&gt;if input column is a bag, LOInnerLoad take the schema of its inner schema, eg, if $1 is bag#2
{t#3(x#4, y#5)}, LOInnerLoad will have the schema (x#4, y#5), it can be followed with nested operator&lt;br/&gt;
# LOGenerate regenerates the bag after the inner operator pipeline, in this case, bag#2{t#3(x#4, y#5)}
&lt;p&gt;, we need to keep uid&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;currently all nested operator does not change uid, except ForEach, that is the approach I took in the patch: unless see a ForEach, reuse uid&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Here are complete examples:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
b = foreach a generate a1, a2; (a0:xxxx, a1:chararray#1, a2:bag#2{t#3(x#4, y#5)})

LOInnerLoad(a1:chararray)     LOInnerLoad(x#4, y#5)
                    \            /
                    LOGenerate(a1:chararray#1, a2:bag#2{t#3(x#4, y#5)})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
b = foreach a { c = filter a2 by x==1;generate a1, c; }; (a0:xxxx, a1:chararray#1, a2:bag#2{t#3(x#4, y#5)})

LOInnerLoad(a1:chararray)     LOInnerLoad(x#4, y#5)
                    \            /
                     \        LOFilter(x#4, y#5)
                      \        /
                    LOGenerate(a1:chararray#1, c:bag#2{t#3(x#4, y#5)})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
b = foreach a { c = a2.x;generate a1, c; }; (a0:xxxx, a1:chararray#1, a2:bag#2{t#3(x#4, y#5)})

LOInnerLoad(a1:chararray)     LOInnerLoad(x#4, y#5)
                    \            /
                     \        LOForEach(x#4)
                      \        /
                    LOGenerate(a1:chararray#1, c:bag#7{t#6(x#4)})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13225076" author="dvryaboy" created="Thu, 8 Mar 2012 07:49:35 +0000"  >&lt;p&gt;Daniel, I think I understand. But the method looks a bit off to me, codestyle-wise, as it moves logic that properly belongs elsewhere into itself and conflates what it&apos;s supposed to do (find a reachable inner load) with what you want to do with the thing it found (change the uid).&lt;/p&gt;</comment>
                            <comment id="13229761" author="daijy" created="Wed, 14 Mar 2012 23:34:52 +0000"  >&lt;p&gt;Hi, Dmitriy, yes I also check LOForEach along the way finding innerload. Otherwise I need to traverse the plan two times. Maybe I can change the name of the function to reveal this?&lt;/p&gt;</comment>
                            <comment id="13231514" author="daijy" created="Fri, 16 Mar 2012 18:56:01 +0000"  >&lt;p&gt;Address Dmitriy&apos;s comment, put a comment to findReacheableInnerLoadFromBoundaryProject to describe the nature of the function.&lt;/p&gt;</comment>
                            <comment id="13231791" author="thejas" created="Sat, 17 Mar 2012 01:41:19 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13232216" author="daijy" created="Sun, 18 Mar 2012 08:24:31 +0000"  >&lt;p&gt;test-patch:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; -1 overall.  &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 @author.  The patch does not contain any @author tags.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 tests included.  The patch appears to include 3 new or modified tests.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;javadoc warning is unrelated.&lt;/p&gt;

&lt;p&gt;Patch committed to 0.10/trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517135" name="PIG-2563-1.patch" size="7666" author="daijy" created="Mon, 5 Mar 2012 22:12:10 +0000"/>
                            <attachment id="12518719" name="PIG-2563-2.patch" size="7873" author="daijy" created="Fri, 16 Mar 2012 18:56:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 1 Mar 2012 17:43:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>229822</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy3t6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56052</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>