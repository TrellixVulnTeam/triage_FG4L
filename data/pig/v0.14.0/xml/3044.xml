<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:03:58 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3044/PIG-3044.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3044] Trigger POPartialAgg compaction under GC pressure</title>
                <link>https://issues.apache.org/jira/browse/PIG-3044</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;If partial aggregation is turned on in pig 10 and 11, 20% (by default) of the available heap can be consumed by the POPartialAgg operator. This can cause memory issues for jobs that use all, or nearly all, of the heap already.&lt;/p&gt;

&lt;p&gt;If we make POPartialAgg &quot;spillable&quot; (trigger compaction when memory reduction is required), we would be much nicer to high-memory jobs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12615556">PIG-3044</key>
            <summary>Trigger POPartialAgg compaction under GC pressure</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dvryaboy">Dmitriy V. Ryaboy</assignee>
                                    <reporter username="dvryaboy">Dmitriy V. Ryaboy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Nov 2012 22:39:12 +0000</created>
                <updated>Fri, 22 Feb 2013 04:53:35 +0000</updated>
                            <resolved>Mon, 10 Dec 2012 21:26:52 +0000</resolved>
                                    <version>0.10.0</version>
                    <version>0.11</version>
                    <version>0.10.1</version>
                                    <fixVersion>0.11</fixVersion>
                    <fixVersion>0.12.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13494382" author="dvryaboy" created="Fri, 9 Nov 2012 22:40:53 +0000"  >&lt;p&gt;Since this is preventing some jobs from migrating from Pig 9 to Pig 11 in our environment, I would like to add it to 11, but an argument can be made that this is not a critical bug and should therefore not be applied to the 0.11 branch. Committers, please weigh in if you have an opinion on this.&lt;/p&gt;</comment>
                            <comment id="13505200" author="dvryaboy" created="Wed, 28 Nov 2012 03:14:58 +0000"  >&lt;p&gt;Attaching an initial pass at this.&lt;/p&gt;

&lt;p&gt;Also, mixed into this diff, is a change to drastically reduce the number of times we need to iterate over a large databag to estimate memory. I had to do that to reduce contention and required synchronization on the bag contents.&lt;/p&gt;</comment>
                            <comment id="13506647" author="julienledem" created="Thu, 29 Nov 2012 18:28:59 +0000"  >&lt;p&gt;in DefaultAbstractBag.getMemorySize():&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;You use avgTupleSize first to sum the aggregated tuple size and then you divide it to get the average. Could you use different names for clarity?&lt;br/&gt;
something like:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;for (j = 0; i.hasNext() &amp;amp;&amp;amp; j &amp;lt; 100; j++) {
   totalTupleSize += i.next().getMemorySize()
}
averageTupleSize = totalTupleSize / j;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Here we take the floor() of the average estimate. Do you want to make it a ceil() by adding + 1 ?&lt;br/&gt;
That way we would slightly overestimate instead of slightly underestimate.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;otherwise it looks all good to me.&lt;br/&gt;
I would even say we remove the % memory budget as the Spillable mechanism is more reliable and much simpler.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13526001" author="dvryaboy" created="Thu, 6 Dec 2012 23:32:30 +0000"  >&lt;p&gt;attached a version with Julien&apos;s comments incorporated. Will commit to 0.11 and trunk.&lt;/p&gt;</comment>
                            <comment id="13526600" author="thejas" created="Fri, 7 Dec 2012 18:22:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would even say we remove the % memory budget as the Spillable mechanism is more reliable and much simpler.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The reason why % memory budget was introduced for SelfSpillBag, was because the spillable mechanism didn&apos;t always work well. The cleanup often was getting triggered too late. So I think it is better use the Spillable mechanism here to spill earlier if necessary, as the patch is doing.&lt;/p&gt;</comment>
                            <comment id="13527739" author="cheolsoo" created="Mon, 10 Dec 2012 06:38:21 +0000"  >&lt;p&gt;Hi Dmitriy,&lt;/p&gt;

&lt;p&gt;This patch broke trunk and branch-0.11. Several test cases are failing, for example, TestDataBag, TestExampleGenerator, TestLogicalPlanBuilder, etc:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Testcase: testDataBagIterIdempotent took 0.011 sec 
    Caused an ERROR
/ by zero
java.lang.ArithmeticException: / by zero
    at org.apache.pig.data.DefaultAbstractBag.getMemorySize(DefaultAbstractBag.java:160)
    at org.apache.pig.data.DefaultAbstractBag.markSpillableIfNecessary(DefaultAbstractBag.java:100)
    at org.apache.pig.data.InternalCachedBag.addDone(InternalCachedBag.java:131)
    at org.apache.pig.data.InternalCachedBag.iterator(InternalCachedBag.java:159)
    at org.apache.pig.test.TestDataBag.processDataBag(TestDataBag.java:1193)
    at org.apache.pig.test.TestDataBag.testDataBagIterIdempotent(TestDataBag.java:1145)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It looks like &lt;tt&gt;&quot;/ by zero&quot;&lt;/tt&gt; is happening when j == 0 in the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (j = 0; i.hasNext() &amp;amp;&amp;amp; j &amp;lt; 100; j++) { 
    avgTupleSize += i.next().getMemorySize();
}
avgTupleSize /= j;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13528270" author="jcoveney" created="Mon, 10 Dec 2012 20:49:18 +0000"  >&lt;p&gt;I&apos;ve attached what should fix this. Should be quick to review. Please let me know what you think. test-commit passes.&lt;/p&gt;</comment>
                            <comment id="13528296" author="cheolsoo" created="Mon, 10 Dec 2012 21:13:05 +0000"  >&lt;p&gt;+1 for the hotfix patch. I also verified test-commit passes. Thanks Jonathan!&lt;/p&gt;</comment>
                            <comment id="13528310" author="jcoveney" created="Mon, 10 Dec 2012 21:26:36 +0000"  >&lt;p&gt;Thanks for the review. Committed to trunk and to 0.11&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12560268" name="PIG-3044-hotfix.patch" size="9156" author="jcoveney" created="Mon, 10 Dec 2012 20:49:18 +0000"/>
                            <attachment id="12559765" name="PIG-3044.2.diff" size="6917" author="dvryaboy" created="Thu, 6 Dec 2012 23:32:30 +0000"/>
                            <attachment id="12555110" name="PIG-3404.diff" size="6919" author="dvryaboy" created="Wed, 28 Nov 2012 03:14:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 29 Nov 2012 18:28:59 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256847</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hycsp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>108624</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>When pig.exec.mapPartAgg, previously the memory reserved for in-memory aggregation was roughly 1/3 the value of pig.cachedbag.memusage per POPartialAgg operator. Reserving that much RAM could cause problems for jobs that required a lot of memory. POPartialAgg is now spillable, and regardless of the setting of pig.cachedbag.memusage, will happily shrink when memory is needed.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>