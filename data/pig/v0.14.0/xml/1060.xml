<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:05:42 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1060/PIG-1060.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1060] MultiQuery optimization throws error for multi-level splits</title>
                <link>https://issues.apache.org/jira/browse/PIG-1060</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Consider the following scenario :-&lt;br/&gt;
1. Multi-level splits in the map plan.&lt;br/&gt;
2. Each split branch further progressing across a local-global rearrange.&lt;br/&gt;
3. Output of each of these finally merged via a UNION.&lt;/p&gt;

&lt;p&gt;MultiQuery optimizer throws the following error in such a case:&lt;br/&gt;
&quot;ERROR 2146: Internal Error. Inconsistency in key index found during optimization.&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12439392">PIG-1060</key>
            <summary>MultiQuery optimization throws error for multi-level splits</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rding">Richard Ding</assignee>
                                    <reporter username="ankur">Ankur</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Oct 2009 11:24:03 +0000</created>
                <updated>Wed, 24 Mar 2010 22:15:58 +0000</updated>
                            <resolved>Wed, 18 Nov 2009 19:02:00 +0000</resolved>
                                    <version>0.5.0</version>
                                    <fixVersion>0.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12771390" author="ankur" created="Thu, 29 Oct 2009 11:33:50 +0000"  >&lt;p&gt;Here&apos;s a sample script to illustrate the issue. Note that sample data isn&apos;t very important here since the optimization and execution fail. &lt;br/&gt;
=== test.pig ====&lt;/p&gt;

&lt;p&gt;data = LOAD &apos;dummy&apos; as (name:chararray, freq:int);&lt;/p&gt;

&lt;p&gt;filter1 = FILTER data BY freq &amp;lt; 5;&lt;br/&gt;
group1 = GROUP filter1 BY name;&lt;br/&gt;
proj1 = FOREACH group1 GENERATE FLATTEN(group), &apos;string1&apos;, SUM(filter1.freq);&lt;/p&gt;

&lt;p&gt;filter2 = FILTER data by freq &amp;gt; 5;&lt;br/&gt;
group2 = GROUP filter2 BY name;&lt;br/&gt;
proj2 = FOREACH group2 GENERATE FLATTEN(group), &apos;string2&apos;, SUM(filter2.freq);&lt;/p&gt;

&lt;p&gt;filter3 = FILTER filter2 by freq &amp;lt; 10;&lt;br/&gt;
group3 = GROUP filter3 By name;&lt;br/&gt;
proj3 = FOREACH group3 GENERATE FLATTEN(group), &apos;string3&apos;, SUM(filter3.freq);&lt;/p&gt;

&lt;p&gt;filter4 = FILTER filter3 by freq &amp;gt; 7;&lt;br/&gt;
group4 = GROUP filter4 By name;&lt;br/&gt;
proj4 = FOREACH group4 GENERATE FLATTEN(group), &apos;string4&apos;, SUM(filter4.freq);&lt;/p&gt;

&lt;p&gt;M1 = LIMIT proj1 10;&lt;br/&gt;
M2 = LIMIT proj2 10;&lt;br/&gt;
M3 = LIMIT proj3 10;&lt;br/&gt;
M4 = LIMIT proj4 10;&lt;/p&gt;

&lt;p&gt;U = UNION M1, M2, M3, M4;&lt;/p&gt;

&lt;p&gt;STORE U INTO &apos;res&apos; USING PigStorage();&lt;/p&gt;

&lt;p&gt;The dot output can dumped via command - &quot;explain -dot -script test.pig;&quot; to visualize the scenario.&lt;br/&gt;
A surprising observation is that despite turning MultiQuery off using -M, it seems that the MultiQuery optimizer is still runs and fails the script.&lt;/p&gt;

</comment>
                            <comment id="12771555" author="rding" created="Thu, 29 Oct 2009 18:51:18 +0000"  >&lt;p&gt;Hi Ankur, &lt;/p&gt;

&lt;p&gt;I can&apos;t reproduce the bug with the latest code in trunk. Can you please attach the log output in the bug?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
&amp;#8211; Richard&lt;/p&gt;</comment>
                            <comment id="12771636" author="rding" created="Thu, 29 Oct 2009 21:38:54 +0000"  >&lt;p&gt;Never mind, there is a typo in my script. Here is the stack trace:&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.pig.impl.plan.optimizer.OptimizerException: ERROR 2146: Internal Error. Inconsistency in key index found during optimization.&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MultiQueryOptimizer.addShiftedKeyInfoIndex(MultiQueryOptimizer.java:679)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MultiQueryOptimizer.addShiftedKeyInfoIndex(MultiQueryOptimizer.java:686)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MultiQueryOptimizer.mergeOneReducePlanWithIndex(MultiQueryOptimizer.java:584)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MultiQueryOptimizer.mergeAllMapReduceSplittees(MultiQueryOptimizer.java:903)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MultiQueryOptimizer.mergeMapReduceSplittees(MultiQueryOptimizer.java:371)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MultiQueryOptimizer.visitMROp(MultiQueryOptimizer.java:175)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceOper.visit(MapReduceOper.java:209)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceOper.visit(MapReduceOper.java:44)&lt;br/&gt;
        at org.apache.pig.impl.plan.ReverseDependencyOrderWalker.walk(ReverseDependencyOrderWalker.java:69)&lt;br/&gt;
        at org.apache.pig.impl.plan.PlanVisitor.visit(PlanVisitor.java:51)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MultiQueryOptimizer.visit(MultiQueryOptimizer.java:90)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher.compile(MapReduceLauncher.java:393)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher.launchPig(MapReduceLauncher.java:103)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.HExecutionEngine.execute(HExecutionEngine.java:265)&lt;/p&gt;</comment>
                            <comment id="12773744" author="viraj" created="Thu, 5 Nov 2009 02:00:46 +0000"  >&lt;p&gt;Hi Ankur and Richard,&lt;br/&gt;
 I have a script which demonstrates a similar problem, but can be solved by using the -M option. This script can reproduce the problem even without the UNION operator , but it has  properties 1 and 2 of the original problem description.&lt;/p&gt;

&lt;p&gt;Try commenting out the F alias. It works fine.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

ORGINALDATA = load &apos;/user/viraj/somedata.txt&apos; using PigStorage() as (col1, col2, col3, col4, col5, col6, col7, col8);



--Check data

A = foreach ORGINALDATA generate col1, col2, col3, col4, col5, col6;

B = group A all;

C = foreach B generate COUNT(A);

store C into &apos;/user/viraj/result1&apos;;



D = filter A by (col1 == col2) or (col1 == col3);

E = group D all;

F = foreach E generate COUNT(D);

--&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; commenting F
store F into &apos;/user/viraj/result2&apos;;



G = filter D by (col4 == col5) ;

H = group G all;

I = foreach H generate COUNT(G);

store I into &apos;/user/viraj/result3&apos;;



J = filter G by (((col6 == &apos;m&apos;) or (col6 == &apos;M&apos;)) and (col6 == 1)) or (((col6 == &apos;f&apos;) or (col6 == &apos;F&apos;)) and (col6 == 0)) or ((col6 == &apos;&apos;) and (col6 == -1));

K = group J all;

L = foreach K generate COUNT(J);

store L into &apos;/user/viraj/result4&apos;;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="12774005" author="rding" created="Thu, 5 Nov 2009 18:02:45 +0000"  >&lt;p&gt;This patch fixes the bug.&lt;/p&gt;</comment>
                            <comment id="12774021" author="hadoopqa" created="Thu, 5 Nov 2009 18:32:20 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12424143/PIG-1060.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12424143/PIG-1060.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 833102.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    -1 release audit.  The applied patch generated 319 release audit warnings (more than the trunk&apos;s current 318 warnings).&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/testReport/&lt;/a&gt;&lt;br/&gt;
Release audit warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/artifact/trunk/patchprocess/releaseAuditDiffWarnings.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/artifact/trunk/patchprocess/releaseAuditDiffWarnings.txt&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/40/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12774115" author="hadoopqa" created="Thu, 5 Nov 2009 22:35:35 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12424143/PIG-1060.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12424143/PIG-1060.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 833126.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    -1 release audit.  The applied patch generated 319 release audit warnings (more than the trunk&apos;s current 318 warnings).&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/testReport/&lt;/a&gt;&lt;br/&gt;
Release audit warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/artifact/trunk/patchprocess/releaseAuditDiffWarnings.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/artifact/trunk/patchprocess/releaseAuditDiffWarnings.txt&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/Pig-Patch-h8.grid.sp2.yahoo.net/41/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12777096" author="rding" created="Thu, 12 Nov 2009 18:24:42 +0000"  >&lt;p&gt;The release audit warnings are all from html files.&lt;/p&gt;</comment>
                            <comment id="12779595" author="daijy" created="Wed, 18 Nov 2009 18:57:28 +0000"  >&lt;p&gt;Patch looks good. Will commit to both trunk and 0.6 branch as it is.&lt;/p&gt;</comment>
                            <comment id="12779596" author="daijy" created="Wed, 18 Nov 2009 19:02:00 +0000"  >&lt;p&gt;Patch committed. Thanks Richard!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12424143" name="PIG-1060.patch" size="40572" author="rding" created="Thu, 5 Nov 2009 18:02:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 29 Oct 2009 18:51:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164588</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyam1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95884</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>