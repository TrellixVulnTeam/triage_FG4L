<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:50:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2209/PIG-2209.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2209] JsonMetadata fails to find schema for glob paths</title>
                <link>https://issues.apache.org/jira/browse/PIG-2209</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;JsonMetadata, used in PigStorage to work with serialized schemas, does not correctly interpret paths like &apos;/foo/bar/&lt;/p&gt;
{1,2,3}
&lt;p&gt;&apos; and throws an exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.apache.pig.impl.logicalLayer.FrontendException: ERROR 1131: Could not find schema file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file:&lt;span class=&quot;code-comment&quot;&gt;///foo/bar/{1,2}
&lt;/span&gt;	at org.apache.pig.builtin.JsonMetadata.nullOrException(JsonMetadata.java:217)
	at org.apache.pig.builtin.JsonMetadata.getSchema(JsonMetadata.java:186)
	at org.apache.pig.builtin.PigStorage.getSchema(PigStorage.java:438)
	at org.apache.pig.newplan.logical.relational.LOLoad.getSchemaFromMetaData(LOLoad.java:150)
	... 17 more
Caused by: java.io.IOException: Unable to read file:&lt;span class=&quot;code-comment&quot;&gt;///foo/bar/z/{1,2}
&lt;/span&gt;	at org.apache.pig.builtin.JsonMetadata.findMetaFile(JsonMetadata.java:106)
	at org.apache.pig.builtin.JsonMetadata.getSchema(JsonMetadata.java:183)
	... 19 more
Caused by: java.net.URISyntaxException: Illegal character in path at index 36: file:&lt;span class=&quot;code-comment&quot;&gt;///foo/bar/{1,2}
&lt;/span&gt;	at java.net.URI$Parser.fail(URI.java:2809)
	at java.net.URI$Parser.checkChars(URI.java:2982)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12518385">PIG-2209</key>
            <summary>JsonMetadata fails to find schema for glob paths</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="dvryaboy">Dmitriy V. Ryaboy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Aug 2011 00:47:06 +0100</created>
                <updated>Thu, 26 Apr 2012 21:33:02 +0100</updated>
                            <resolved>Sun, 13 Nov 2011 23:48:10 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13083378" author="dvryaboy" created="Thu, 11 Aug 2011 19:50:28 +0100"  >&lt;p&gt;Slight correction: this only happens when the items referred to in the glob are directories. It works fine when they are files or parts of file names.&lt;/p&gt;</comment>
                            <comment id="13086601" author="dvryaboy" created="Wed, 17 Aug 2011 22:15:31 +0100"  >&lt;p&gt;Upgraded to blocker, as this can break existing scripts. I&apos;ll work on this.&lt;/p&gt;</comment>
                            <comment id="13142725" author="olgan" created="Thu, 3 Nov 2011 00:30:50 +0000"  >&lt;p&gt;Dmitry are you planning to resolve this quickly? &lt;/p&gt;</comment>
                            <comment id="13142729" author="dvryaboy" created="Thu, 3 Nov 2011 00:39:29 +0000"  >&lt;p&gt;I can try but I am not sure I have the time at the moment.. it&apos;s my bad, though, so if no one can make time, I&apos;ll figure something out to unblock the release. &lt;/p&gt;</comment>
                            <comment id="13143424" author="daijy" created="Thu, 3 Nov 2011 18:36:52 +0000"  >&lt;p&gt;Hi, Dmitriy, I can make time, can I help on this?&lt;/p&gt;</comment>
                            <comment id="13143537" author="dvryaboy" created="Thu, 3 Nov 2011 21:18:23 +0000"  >&lt;p&gt;that would be fantastic.&lt;/p&gt;</comment>
                            <comment id="13143582" author="daijy" created="Thu, 3 Nov 2011 22:55:51 +0000"  >&lt;p&gt;I also see by default, PigStorage will search for schema files in input directory, is that intentional? That will add burden to namenode. Shall we flip it?&lt;/p&gt;</comment>
                            <comment id="13143586" author="olgan" created="Thu, 3 Nov 2011 23:03:20 +0000"  >&lt;p&gt;I don&apos;t think that&apos;s what we want. This could be costly and non-backward compatible&lt;/p&gt;</comment>
                            <comment id="13143603" author="dvryaboy" created="Thu, 3 Nov 2011 23:24:40 +0000"  >&lt;p&gt;I think the behavior we want is &lt;br/&gt;
1) if the schema exists, use it&lt;br/&gt;
2) if the schema does not exist, behave as it behaves currently.&lt;/p&gt;

&lt;p&gt;If we get rid of the per-file schema thing, and instead always only look for a .pig_schema file in the directory that contains the files, the cost should be relatively small.&lt;/p&gt;</comment>
                            <comment id="13143620" author="daijy" created="Thu, 3 Nov 2011 23:43:30 +0000"  >&lt;p&gt;That way we avoid globStatus, but still several existence check is needed. Provide most PigStorage use cases don&apos;t use schema I believe, it should disable by default. How about a global flag? &lt;/p&gt;</comment>
                            <comment id="13143628" author="dvryaboy" created="Thu, 3 Nov 2011 23:53:33 +0000"  >&lt;p&gt;Global flag works for me (in my case, most uses of pig storage &lt;b&gt;would&lt;/b&gt; use the schema).&lt;/p&gt;</comment>
                            <comment id="13143629" author="dvryaboy" created="Thu, 3 Nov 2011 23:56:28 +0000"  >&lt;p&gt;Actually, having given it 30 seconds more thought, I disagree with myself. It should be enabled by default. Otherwise most users won&apos;t get the benefit (because they won&apos;t know they can), and having this on by default is a huge usability benefit. The few users who are running clusters with heavy enough load that the extra NN call makes a difference can turn this off &amp;#8211; and we can call this out in release notes.  I think this is a case where the benefits are worth the cost. Every single file generated with PigStorage will have a schema associated with it, that&apos;ll be very useful.&lt;/p&gt;</comment>
                            <comment id="13143638" author="daijy" created="Fri, 4 Nov 2011 00:10:34 +0000"  >&lt;p&gt;You assume the input file is generated by PigStorage. But in many cases, it is not true.&lt;/p&gt;</comment>
                            <comment id="13143643" author="dvryaboy" created="Fri, 4 Nov 2011 00:14:21 +0000"  >&lt;p&gt;Not quite, I am saying there is huge benefit when it &lt;b&gt;is&lt;/b&gt; generated by Pig, and there is fairly little cost when it isn&apos;t. If it&apos;s an actual problem (and I doubt it would be), we should give a property to turn this behavior off. Prematurely optimizing by kneecapping the feature just seems like a good way to ensure most people (who, by and large, barely hit the NN) will never discover it.&lt;/p&gt;</comment>
                            <comment id="13144155" author="olgan" created="Fri, 4 Nov 2011 16:53:30 +0000"  >&lt;p&gt;My main concern is backward compatibility. In use cases at Yahoo, we trained users to provide name and type of the data during load time. Are we sure (and do we have enough use cases) that they will still see the names and types they requested?&lt;/p&gt;

&lt;p&gt;I think for 10, we should turn it off by default and see if it make sense to switch that down the road.&lt;/p&gt;</comment>
                            <comment id="13144225" author="alangates" created="Fri, 4 Nov 2011 18:10:50 +0000"  >&lt;p&gt;I agree with Dmitriy that this will be very useful to most users with pretty minimal cost.  My concern is in the glob case, where we&apos;re potentially doing thousands of stats on the NameNode.  I would suggest adding a cap on the number of directories it could read, and providing a variable users could set to up this if they need to.  For example, if a glob tried to access more than 100 directories, it would fail with a message like:&lt;/p&gt;

&lt;p&gt;Error:  PigStorage exceeded max number of input directories.  To avoid this, you can turn of auto schema detection by setting what.ever.the.variable.is to false or you can increase the maximum allowed directories by setting what.ever.that.variable.is (warning, this will increase the load on your NameNode).&lt;/p&gt;

&lt;p&gt;Olga, I don&apos;t understand your concern for backward compatibility.  If the user has both a schema and an as clause we try to massage the schema into the as clause.  The only issue will be if they store it with a schema and then give an as clause that is not compatible by our casting rules (e.g. the schema says a field is a long and they declare it as a string in the as clause).  Do you think that case is common?&lt;/p&gt;</comment>
                            <comment id="13144247" author="olgan" created="Fri, 4 Nov 2011 18:58:05 +0000"  >&lt;p&gt;My concern is that the data is generated by one set of users but used by another and I am not sure how well we have tested the code that messages the data since that was not a very common use case. &lt;/p&gt;

&lt;p&gt;I could howevere see that if the schema file is not there nothing changes which could be good enough. I do recommend that we at least add more test case for schema provided both in file and in load statement&lt;/p&gt;</comment>
                            <comment id="13144371" author="daijy" created="Fri, 4 Nov 2011 21:42:23 +0000"  >&lt;p&gt;I checked the code again, we don&apos;t do extensive globStatus. Only one globStatus will be called in the case of globbing. So if we agree we want to pay this price in trade of the benefit of schema file, the only thing left is just bug fix. TestPigStorage do have test cases cover basic schema/noschema, we do need to add some globbing tests.&lt;/p&gt;

&lt;p&gt;I will submit a patch shortly.&lt;/p&gt;</comment>
                            <comment id="13144392" author="dvryaboy" created="Fri, 4 Nov 2011 22:03:14 +0000"  >&lt;p&gt;Olga, we have a &quot;-noschema&quot; parameter that lets people ignore whatever&apos;s on disk w.r.t. schemas, so if a bug is tickled, it will be easy to work around it.&lt;/p&gt;</comment>
                            <comment id="13144432" author="olgan" created="Fri, 4 Nov 2011 22:56:28 +0000"  >&lt;p&gt;Our users especially production ones are not very keen on changing their processes.&lt;/p&gt;

&lt;p&gt;I think this probably an ok change since our users do not have schema files right now. I am worried that we have done such a major re-work of PigStorage which is one of the main ways to get the data and how much problem we will see as the result like the one we are seeing in the bug&lt;/p&gt;</comment>
                            <comment id="13144444" author="dvryaboy" created="Fri, 4 Nov 2011 23:16:28 +0000"  >&lt;p&gt;FWIW, the reason I filed this bug when I did was that I tried switching it out in production at Twitter. I will do that again as soon as we have a fix, before the 0.10 release; that should surface issues pretty quickly, if they exist.&lt;/p&gt;</comment>
                            <comment id="13147255" author="daijy" created="Wed, 9 Nov 2011 20:12:50 +0000"  >&lt;p&gt;The patch is ready for review. Dmitriy, are you able to take a look?&lt;/p&gt;</comment>
                            <comment id="13147276" author="dvryaboy" created="Wed, 9 Nov 2011 20:45:26 +0000"  >&lt;p&gt;yep looking at it today.&lt;/p&gt;</comment>
                            <comment id="13147313" author="daijy" created="Wed, 9 Nov 2011 21:38:28 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13148966" author="dvryaboy" created="Sat, 12 Nov 2011 03:02:36 +0000"  >&lt;p&gt;Looks good.&lt;/p&gt;

&lt;p&gt;I think we need to firm up schema resolution when dealing with globs, but that&apos;s a different ticket (loading foo/&lt;/p&gt;
{bar,baz}
&lt;p&gt; where the schema is under foo/bar/.pig_schema doesn&apos;t give you the schema)&lt;/p&gt;</comment>
                            <comment id="13149395" author="daijy" created="Sun, 13 Nov 2011 23:48:10 +0000"  >&lt;p&gt;Unit tests pass. test-patch:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; -1 overall.  &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 @author.  The patch does not contain any @author tags.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 tests included.  The patch appears to include 4 new or modified tests.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     -1 release audit.  The applied patch generated 473 release audit warnings (more than the trunk&apos;s current 466 warnings).&lt;/p&gt;

&lt;p&gt;Patch committed to trunk and 0.10 branch.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12539565">PIG-2489</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12502556" name="PIG-2209-1.patch" size="8243" author="daijy" created="Sat, 5 Nov 2011 00:22:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 3 Nov 2011 00:30:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41687</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy3tvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56166</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>