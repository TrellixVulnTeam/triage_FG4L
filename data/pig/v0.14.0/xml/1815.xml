<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:51:08 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1815/PIG-1815.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1815] pig task retains used instances of PhysicalPlan</title>
                <link>https://issues.apache.org/jira/browse/PIG-1815</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;map tasks of a pig query ran out of memory because there were too many (thousands)  instances of combiner PhysicalPlan in memory. Each physical plan (except the last?) was linked to older one as shown in the yourkit snapshot that I am attaching.&lt;/p&gt;

&lt;p&gt;This problem was noticed with 0.8 because of the split combination feature, that resulted in each map having larger inputs. The query also had large physical plan because of multi-query, it had 17 MR jobs merged into one during the multi-query optimization phase.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12496202">PIG-1815</key>
            <summary>pig task retains used instances of PhysicalPlan</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thejas">Thejas M Nair</assignee>
                                    <reporter username="thejas">Thejas M Nair</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Jan 2011 23:53:05 +0000</created>
                <updated>Mon, 25 Apr 2011 22:27:13 +0100</updated>
                            <resolved>Fri, 21 Jan 2011 21:10:21 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12984823" author="thejas" created="Fri, 21 Jan 2011 17:29:11 +0000"  >&lt;p&gt;I have tested the patch using the query that was running out of memory. Patch does not have any unit tests, as I can&apos;t think of a good/easy way to test the leak in unit test.&lt;br/&gt;
All unit tests except TestScriptLanguage passed. TestScriptLanguage is failing even without the patch.&lt;/p&gt;

&lt;p&gt;     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; -1 overall.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 @author.  The patch does not contain any @author tags.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;                         Please justify why no tests are needed for this patch.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;</comment>
                            <comment id="12984845" author="ashutoshc" created="Fri, 21 Jan 2011 18:21:15 +0000"  >&lt;p&gt;Great find.  &lt;br/&gt;
I couldn&apos;t follow when and what may cause this. If its easy enough for you, can you give a small pig query snippet which may result in this and why. And also how patch fixes the issue.&lt;/p&gt;</comment>
                            <comment id="12984884" author="thejas" created="Fri, 21 Jan 2011 19:27:57 +0000"  >&lt;p&gt;&#160;The references in the heap dump show that the POUserFunc a plan (except the oldest one?) has reference to Reducer$Context ( POUserFunc -&amp;gt; udf object -&amp;gt; ProgressableReporter -&amp;gt; Reducer$Context). But the Reducer$Context object has reference to PigCombiner$Combine which has reference to another (previously created?) PhysicalPlan. So any Combiner PhysicalPlan instance that has been created in the map task has a reference to it and can&apos;t be freed by GC .&lt;/p&gt;

&lt;p&gt;I haven&apos;t followed the exact call sequence that leads to it, but it looks like a PhysicalPlan instance is created with reference to a copy of the previous Reducer$Context, and since this is a inner class of PigCombiner$Combine (a subclass of Reducer) it has a reference (this$0) to it. And this older  PigCombiner$Combine  has references to the old physical plan. The old physical plan has references to the older Reducer$Context and so on. &lt;br/&gt;
To break this chain, in this patch I clean the references to the PhysicalPlan in PigCombiner$Combine when the cleanup method is called.&lt;/p&gt;

&lt;p&gt;I had a look at the hadoop mapreduce code that does the sort-and-spill of map output (org.apache.hadoop.mapred$MapOutputBuffer$SpillThread.sortAndSpill() ), and it looks like one combiner class instance is created for every partition (ie reducer). &lt;br/&gt;
In case of the query whose map tasks ran out of memory, mapred.reduce.tasks was set to 300, ie 300 instances of combiner class , and therefore 300 instances of physical plan will be created for every spill. The query in 0.8 also had several spills ( 10+) , which means that there will be more than 3000 instances of PhysicalPlan lying around.  The Physical plans in this case were also large because it was a &apos;multi-query&apos; , and 17 MR jobs were merged into 1.&lt;/p&gt;

&lt;p&gt;ie, The failure can happen in any query which uses combiner. There just needs to be large number of instances of physical plan , and number of physical plan instances = number-of-reducers * number-of-spills. If the PhysicalPlan is large, you need fewer instances of it for failure. &lt;/p&gt;</comment>
                            <comment id="12984895" author="ashutoshc" created="Fri, 21 Jan 2011 19:52:09 +0000"  >&lt;p&gt;Thanks for the description, Thejas. &lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="12984940" author="thejas" created="Fri, 21 Jan 2011 21:10:21 +0000"  >&lt;p&gt;Patch committed to 0.8 branch and trunk.&lt;/p&gt;</comment>
                            <comment id="12984949" author="scott_carey" created="Fri, 21 Jan 2011 21:28:03 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I haven&apos;t followed the exact call sequence that leads to it, but it looks like a PhysicalPlan instance is created with reference to a copy of the previous Reducer$Context, and since this is a inner class of PigCombiner$Combine (a subclass of Reducer) it has a reference (this$0) to it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t know if this is new info to anyone reading this, but there are two types of inner classes, those with the &apos;this&apos; reference to the enclosing class and those without it.   Those that don&apos;t hold references to their enclosing class are those marked &apos;static&apos;.    If this inner class can be made static, it would remove that reference (and make the object a little smaller).&lt;/p&gt;

&lt;p&gt;In general, you can help the GC and memory footprint by making sure inner classes are &apos;static&apos; whenever they don&apos;t need to have the implicit &apos;this&apos; reference.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12495438">PIG-1803</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12468991" name="PIG-1815.1.patch" size="1024" author="thejas" created="Fri, 21 Jan 2011 17:29:11 +0000"/>
                            <attachment id="12468925" name="yourkit_combiner_hprof.jpg" size="192345" author="thejas" created="Thu, 20 Jan 2011 23:55:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 21 Jan 2011 18:21:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>165204</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyatwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97155</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>