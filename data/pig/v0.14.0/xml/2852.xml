<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:52:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2852/PIG-2852.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2852] Old Hadoop API being used sometimes when running parellel in local mode</title>
                <link>https://issues.apache.org/jira/browse/PIG-2852</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;When I run parallel jobs in local mode, I sometimes/randomly see the following error:&lt;br/&gt;
java.lang.ClassCastException: org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigSplit cannot be cast to org.apache.hadoop.mapred.InputSplit&lt;br/&gt;
    at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:413)&lt;br/&gt;
    at org.apache.hadoop.mapred.MapTask.run(MapTask.java:373)&lt;br/&gt;
    at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:212)&lt;/p&gt;

&lt;p&gt;Note the method runOldMapper. Pig sets mapred.mapper.new-api to true in JobControlCompiler.java, so I&apos;m not sure why this can happen (sometimes)&lt;/p&gt;


&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;1) Create a 10 million line large file &apos;1.txt&apos;&lt;br/&gt;
fout = open(&apos;1.txt&apos;, &apos;w&apos;)&lt;br/&gt;
for i in range(1000 * 1000 * 10):&lt;br/&gt;
    fout.write(&apos;%s\n&apos; % (&apos;\t&apos;.join(str&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; for x in range(10))))&lt;br/&gt;
fout.close()&lt;/p&gt;

&lt;p&gt;2) Create pig source &apos;1.pig&apos;&lt;/p&gt;

&lt;p&gt;data = load &apos;1.txt&apos; as (a1:int, a2:int, a3:int, a4:int, a5:int, a6:int, a7:int, a8:int, a9:int, a10:int);&lt;br/&gt;
grouped = group data all;&lt;br/&gt;
stats = foreach grouped generate &apos;$METRIC&apos; as metric, MIN(data.$METRIC) as min_value, MAX(data.$METRIC) as max_value;&lt;br/&gt;
dump stats;&lt;/p&gt;

&lt;p&gt;3) Create python controller &apos;1.py&apos;&lt;/p&gt;

&lt;p&gt;from org.apache.pig.scripting import Pig&lt;/p&gt;

&lt;p&gt;def runMultiple():&lt;br/&gt;
    compiled = Pig.compileFromFile(&apos;1.pig&apos;)&lt;br/&gt;
    params = [&lt;/p&gt;
{&apos;METRIC&apos; : metric}
&lt;p&gt; for metric in &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;a3&amp;#39;, &amp;#39;a5&amp;#39;, &amp;#39;a7&amp;#39;&amp;#93;&lt;/span&gt;]&lt;br/&gt;
    bound = compiled.bind(params)&lt;br/&gt;
    results = bound.run()&lt;br/&gt;
    for result in results:&lt;br/&gt;
        if result.isSuccessful():&lt;br/&gt;
            itr = result.result(&apos;stats&apos;).iterator()&lt;br/&gt;
            print itr.next().getAll()&lt;br/&gt;
        else:&lt;br/&gt;
            print &apos;Failed&apos;&lt;/p&gt;

&lt;p&gt;if _&lt;em&gt;name&lt;/em&gt;_ == &quot;_&lt;em&gt;main&lt;/em&gt;_&quot;:&lt;br/&gt;
    runMultiple()&lt;/p&gt;

&lt;p&gt;4) pig -x local 1.py&lt;br/&gt;
You may need to run it a few times to get the error (it&apos;s only in stderr output, not even in pig logs). The occurrence seems to be random (sometimes the parallel jobs can succeed). Maybe caused by multi-threading complexities?&lt;/p&gt;

&lt;p&gt;I tried pseudo distributed mode but haven&apos;t seen this error in that mode.&lt;/p&gt;

&lt;p&gt;This has never happened in non-parallel job execution.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Hadoop 0.20.205.0&lt;/p&gt;</environment>
        <key id="12600911">PIG-2852</key>
            <summary>Old Hadoop API being used sometimes when running parellel in local mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="smalltalk80">Brian Tan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 Jul 2012 22:09:16 +0100</created>
                <updated>Fri, 21 Sep 2012 21:31:43 +0100</updated>
                            <resolved>Fri, 21 Sep 2012 21:31:43 +0100</resolved>
                                    <version>0.9.2</version>
                    <version>0.10.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13426133" author="smalltalk80" created="Tue, 31 Jul 2012 22:10:35 +0100"  >&lt;p&gt;The garbled Python line fout.write(&apos;%s\n&apos; % (&apos;\t&apos;.join(str for x in range(10))))&lt;br/&gt;
should be:&lt;br/&gt;
fout.write(&apos;%s\n&apos; % (&apos;\t&apos;.join(str( x ) for x in range(10))))&lt;/p&gt;</comment>
                            <comment id="13426137" author="smalltalk80" created="Tue, 31 Jul 2012 22:13:16 +0100"  >&lt;p&gt;I&apos;m uploading these files for your convenience&lt;/p&gt;</comment>
                            <comment id="13426229" author="rohini" created="Wed, 1 Aug 2012 01:11:59 +0100"  >&lt;p&gt;I have also seen unit tests randomly failing with PigSplit cannot be cast to org.apache.hadoop.mapred.InputSplit exception sometimes.&lt;/p&gt;</comment>
                            <comment id="13452429" author="cheolsoo" created="Mon, 10 Sep 2012 21:44:44 +0100"  >&lt;p&gt;I was able to narrow down the issue.&lt;/p&gt;

&lt;p&gt;When running parellel in local mode, not every job.xml is created. As a result, some jobs end up with the default value of the &quot;mapred.mapper.new-api&quot; property and fail with the error. For example, when running 4 threads, job.xml files in a successful run and a failed run look as follows:&lt;/p&gt;

&lt;p&gt;Successful run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cheolsoo@localhost:/tmp/hadoop-cheolsoo/mapred/local $ls -1 localRunner/
job_local_0001.xml
job_local_0002.xml
job_local_0003.xml
job_local_0004.xml
tmp
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Failed run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cheolsoo@localhost:/tmp/hadoop-cheolsoo/mapred/local $ls -1 localRunner/
job_local_0003.xml
tmp
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am not sure yet whether this is a hadoop LocalJobRunner issue or a pig issue.&lt;/p&gt;</comment>
                            <comment id="13452438" author="cheolsoo" created="Mon, 10 Sep 2012 21:56:42 +0100"  >&lt;p&gt;Actually, I found &lt;a href=&quot;https://issues.apache.org/jira/browse/MAPREDUCE-1367&quot; title=&quot;LocalJobRunner should support parallel mapper execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAPREDUCE-1367&quot;&gt;&lt;del&gt;MAPREDUCE-1367&lt;/del&gt;&lt;/a&gt;. So this is an expected behavior with hadoop 20 while it&apos;s fixed with hadoop 21 and onwards.&lt;/p&gt;</comment>
                            <comment id="13452453" author="cheolsoo" created="Mon, 10 Sep 2012 22:14:02 +0100"  >&lt;p&gt;I am going to mark this jira as &quot;won&apos;t fix&quot;. Please let me know if anyone has objections.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13453670" author="cheolsoo" created="Wed, 12 Sep 2012 04:23:22 +0100"  >&lt;p&gt;Attach is a patch that updates the doc regarding the problem with parallel execution in local mode.&lt;/p&gt;</comment>
                            <comment id="13460805" author="jcoveney" created="Fri, 21 Sep 2012 21:31:35 +0100"  >&lt;p&gt;Cheolsoo, thanks for updating the documentation. Committed, and setting this as a won&apos;t fix.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12538620" name="1.pig" size="262" author="smalltalk80" created="Tue, 31 Jul 2012 22:13:16 +0100"/>
                            <attachment id="12538621" name="1.py" size="791" author="smalltalk80" created="Tue, 31 Jul 2012 22:13:16 +0100"/>
                            <attachment id="12544762" name="PIG-2852.patch" size="1330" author="cheolsoo" created="Wed, 12 Sep 2012 04:23:22 +0100"/>
                            <attachment id="12538622" name="generate_1_txt.py" size="128" author="smalltalk80" created="Tue, 31 Jul 2012 22:13:16 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 1 Aug 2012 00:11:59 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256456</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyb0jb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98230</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>