<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:00:36 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-4227/PIG-4227.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-4227] Streaming Python UDF handles bag outputs incorrectly</title>
                <link>https://issues.apache.org/jira/browse/PIG-4227</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;I have a udf that generates different outputs when running as jython and streaming python.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;jython&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{([[BBC Worldwide]])}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;streaming python&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{(BC Worldwid)}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem is that streaming python encodes a bag output incorrectly. For this particular example, it serializes the output string as follows-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
|{_[[BBC Worldwide]]|}_
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where &apos;|&apos; and &apos;&amp;#95;&apos; wrap bag delimiters &apos;{&apos; and &apos;}&apos;. i.e. &apos;{&apos; =&amp;gt; &apos;|{&amp;#95;&apos; and &apos;}&apos; =&amp;gt; &apos;|}&amp;#95;&apos;.&lt;/p&gt;

&lt;p&gt;But this is wrong because bag must contain tuples not chararrays. i.e. the correct encoding is as follows-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
|{_|(_[[BBC Worldwide]]|)_|}_
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where &apos;|&apos; and &apos;_&apos; wrap tuple delimiters &apos;(&apos; and &apos;)&apos; as well as bag delimiters.&lt;/p&gt;

&lt;p&gt;This results in truncated outputs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12747171">PIG-4227</key>
            <summary>Streaming Python UDF handles bag outputs incorrectly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Oct 2014 02:06:54 +0100</created>
                <updated>Fri, 21 Nov 2014 05:59:10 +0000</updated>
                            <resolved>Thu, 16 Oct 2014 05:27:44 +0100</resolved>
                                                    <fixVersion>0.14.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14166119" author="cheolsoo" created="Fri, 10 Oct 2014 02:10:56 +0100"  >&lt;p&gt;Attaching a patch.&lt;/p&gt;</comment>
                            <comment id="14166477" author="daijy" created="Fri, 10 Oct 2014 07:59:49 +0100"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14168415" author="cheolsoo" created="Sun, 12 Oct 2014 01:04:08 +0100"  >&lt;p&gt;Committed to trunk. Thank you Daniel for reviewing the patch!&lt;/p&gt;</comment>
                            <comment id="14168485" author="rohini" created="Sun, 12 Oct 2014 04:00:06 +0100"  >&lt;p&gt;Wrong results is not good. Took the liberty of checking this into 0.14 branch as well.&lt;/p&gt;</comment>
                            <comment id="14171634" author="daijy" created="Tue, 14 Oct 2014 23:16:40 +0100"  >&lt;p&gt;Seems this breaks TestStreamingUDF. I am looking.&lt;/p&gt;</comment>
                            <comment id="14171649" author="daijy" created="Tue, 14 Oct 2014 23:36:56 +0100"  >&lt;p&gt;e2e tests StreamingPythonUDFs_5 and StreamingPythonUDFs_12 also fail due to this.&lt;/p&gt;</comment>
                            <comment id="14172107" author="daijy" created="Wed, 15 Oct 2014 08:42:20 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;, looked at scriptingudf.complexTypes, python udf return a list of tuples for the bag field. When serialize the output, bag adds |{_ and tuple adds |(_. So this part seems Ok. &lt;/p&gt;

&lt;p&gt;I don&apos;t totally understand the issue in the description, is that because jython adds tuple inside a list automatically but python does not?&lt;/p&gt;</comment>
                            <comment id="14172620" author="cheolsoo" created="Wed, 15 Oct 2014 18:17:13 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;, sorry for breaking unit tests.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I don&apos;t totally understand the issue in the description, is that because jython adds tuple inside a list automatically but python does not?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You&apos;re right that Jython udf usually doesn&apos;t return a list of Python tuples but just returns a list of Python objects. In that case, Pig converts it to a bag of tuples automatically by wrapping objects with tuples. However, Python streaming udf serializes it as a bag of non-tuples, and they&apos;re never wrapped with tuples. The problem is that outputSchema is defined as something like &lt;tt&gt;bag:{tuple:( chararray )&lt;/tt&gt;}, and now deserialization code skips bytes to skip tuple delimiters that do not exist. That results in truncating 3 chars at the beginning and the end.&lt;/p&gt;

&lt;p&gt;So the root cause is that Jython and Python streaming handles a Python list of non-tuples differently. This makes it not possible to run the same udf in the two modes. With my patch, I can run the same udf in the two modes and get the same result. For eg, here is the diff in one of udfs before and after my patch. This should clarify the difference-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
34c34
&amp;lt;                             output.append(recos[r][&apos;id&apos;])
---
&amp;gt;                             output.append(tuple([recos[r][&apos;id&apos;]]))
44c44
&amp;lt;                             output.append(recos[r][&apos;id&apos;])
---
&amp;gt;                             output.append(tuple([recos[r][&apos;id&apos;]]))
49c49
&amp;lt;                     output.append(items[i][&apos;id&apos;])
---
&amp;gt;                     output.append(tuple([items[i][&apos;id&apos;]]))
84c84
&amp;lt;                             output.append(recos[r][&apos;id&apos;])
---
&amp;gt;                             output.append(tuple([recos[r][&apos;id&apos;]]))
96c96
&amp;lt;                             output.append(recos[r][&apos;id&apos;])
---
&amp;gt;                             output.append(tuple([recos[r][&apos;id&apos;]]))
101c101
&amp;lt;                     output.append(items[i][&apos;id&apos;])
---
&amp;gt;                     output.append(tuple([items[i][&apos;id&apos;]]))
105c105
&amp;lt;                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; [-1]
---
&amp;gt;                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; [tuple([-1])]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14172634" author="daijy" created="Wed, 15 Oct 2014 18:27:27 +0100"  >&lt;p&gt;Shall we make python udf insert tuple automatically? Otherwise we break python udf which do insert tuples.&lt;/p&gt;</comment>
                            <comment id="14172658" author="cheolsoo" created="Wed, 15 Oct 2014 18:44:18 +0100"  >&lt;blockquote&gt;
&lt;p&gt;Otherwise we break python udf which do insert tuples.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;True, but I hardly see udfs that insert tuples because in Jython, you never had to do that. Since I deployed streaming udf in prod, few users have inserted tuples only because they had to. Now I deployed my patch to prod and haven&apos;t heard any complaints.&lt;/p&gt;

&lt;p&gt;But I do agree that if a udf returns a list of tuples, there will be an extra layer of tuple. That&apos;s a valid corner case, indeed.&lt;/p&gt;</comment>
                            <comment id="14172688" author="daijy" created="Wed, 15 Oct 2014 19:01:21 +0100"  >&lt;p&gt;This is a corner case if a tuple contains a single item, but if a tuple contains multiple items, wrapping it in a tuple seems the only way, right?&lt;/p&gt;</comment>
                            <comment id="14172704" author="cheolsoo" created="Wed, 15 Oct 2014 19:07:41 +0100"  >&lt;p&gt;Yes, you&apos;re right.&lt;/p&gt;</comment>
                            <comment id="14172794" author="daijy" created="Wed, 15 Oct 2014 20:08:55 +0100"  >&lt;p&gt;Attach a patch to add tuple automatically. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;, can you check if that works for you?&lt;/p&gt;</comment>
                            <comment id="14173238" author="cheolsoo" created="Thu, 16 Oct 2014 03:05:39 +0100"  >&lt;p&gt;Yes, it works! I haven&apos;t verified the broken tests, but if they all pass, please go ahead commit it.&lt;/p&gt;

&lt;p&gt;Thank you Daniel!&lt;/p&gt;</comment>
                            <comment id="14173348" author="daijy" created="Thu, 16 Oct 2014 05:27:44 +0100"  >&lt;p&gt;Yes, test pass.&lt;/p&gt;

&lt;p&gt;Committed to trunk and 0.14 branch. Thanks for verify, Cheolsoo!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12674076" name="PIG-4227-1.patch" size="729" author="cheolsoo" created="Fri, 10 Oct 2014 02:10:56 +0100"/>
                            <attachment id="12675086" name="PIG-4227-2.patch" size="1117" author="daijy" created="Wed, 15 Oct 2014 20:08:55 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 10 Oct 2014 06:59:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzuvmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>