<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:00:02 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2940/PIG-2940.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2940] HBaseStorage store fails in secure cluster</title>
                <link>https://issues.apache.org/jira/browse/PIG-2940</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;To reproduce ths issue, please do the following in secure hadoop/hbase cluster:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;On a gateway node, run kinit to obtain kerberos credentials and run a Pig script that includes a HBaseStorage load/store.&lt;/li&gt;
	&lt;li&gt;In the front-end, HBaseStorage obtains a delegation token from hbase server and adds it to the JobConf object.&lt;/li&gt;
	&lt;li&gt;In the back-end, mappers connect to hbase using the delegation token w/o kerberos credentials.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;While load-from-hbase works perfectly fine, store-to-hbase fails. This is because at step 3, mappers attempt to obtain a delegation token from hbase in the back-end.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;setStoreLocation()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Not setting a udf property and getting the hbase delegation token
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// only once like in setLocation as setStoreLocation gets different Job
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// objects &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; each call and the last Job passed is the one that is
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// launched. So we end up getting multiple hbase delegation tokens.
&lt;/span&gt;addHBaseDelegationToken(m_conf, job);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem is that mappers in the back-end don&apos;t have kerberos credentials, so the call to addHBaseDelegationToken() fails with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-09-30 14:33:42,310 ERROR [main] org.apache.hadoop.security.UserGroupInformation: PriviledgedActionException as:testuser (auth:SIMPLE) cause:org.apache.hadoop.hbase.security.AccessDeniedException: org.apache.hadoop.hbase.security.AccessDeniedException: Token generation only allowed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Kerberos authenticated clients
	at org.apache.hadoop.hbase.security.token.TokenProvider.getAuthenticationToken(TokenProvider.java:87)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is not an issue with load because a delegation token is only obtained in the front-end for the first time when HBASE_TOKEN_SET is not set.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;setLocation()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; delegationTokenSet = udfProps.getProperty(HBASE_TOKEN_SET);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (delegationTokenSet == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    addHBaseDelegationToken(m_conf, job);
    udfProps.setProperty(HBASE_TOKEN_SET, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The proposed fix is to modify addHBaseDelegationToken() so that tokens are obtained only if the current user has kerberos credentials, which is true in the front-end while false in the back-end.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12609847">PIG-2940</key>
            <summary>HBaseStorage store fails in secure cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                            <label>hbase</label>
                    </labels>
                <created>Tue, 2 Oct 2012 01:43:11 +0100</created>
                <updated>Sun, 6 Jan 2013 23:57:04 +0000</updated>
                            <resolved>Sun, 21 Oct 2012 01:07:28 +0100</resolved>
                                                    <fixVersion>0.11</fixVersion>
                    <fixVersion>0.10.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13467370" author="cheolsoo" created="Tue, 2 Oct 2012 01:48:36 +0100"  >&lt;p&gt;Attached is a patch that implements the proposed fix.&lt;/p&gt;

&lt;p&gt;I tested that both load/store with secure hbase and non-secure hbase.&lt;/p&gt;</comment>
                            <comment id="13467481" author="rohini" created="Tue, 2 Oct 2012 05:45:11 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;Cheolsoo Park&lt;/a&gt;,&lt;br/&gt;
   Are you sure it tries to get delegation token in the backend? Because the first check in the method is if it is front end.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void addHBaseDelegationToken(Configuration hbaseConf, Job job) {
 	
 	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!UDFContext.getUDFContext().isFrontend()) {
 	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
 	}
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;kerberos&quot;&lt;/span&gt;.equalsIgnoreCase(hbaseConf.get(HBASE_SECURITY_CONF_KEY))) {
 	..}

} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13467499" author="cheolsoo" created="Tue, 2 Oct 2012 06:39:53 +0100"  >&lt;p&gt;Hi Rohini,&lt;/p&gt;

&lt;p&gt;Thank you for chiming in. Yes, I am positive that this is happening in the back-end. Please see the attached screenshot.&lt;/p&gt;

&lt;p&gt;In fact, I didn&apos;t realize that addHBaseDelegationToken() checks whether it&apos;s the front-end. That is really strange.&lt;/p&gt;</comment>
                            <comment id="13467526" author="cheolsoo" created="Tue, 2 Oct 2012 07:16:51 +0100"  >&lt;p&gt;Given that this is not supposed to happen, I am canceling patch available for now.&lt;/p&gt;</comment>
                            <comment id="13467531" author="rohini" created="Tue, 2 Oct 2012 07:39:46 +0100"  >&lt;p&gt;I think I know the problem. I did not test it with hadoop 23.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFrontend() {
    	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.jconf == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || jconf.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.task.id&quot;&lt;/span&gt;) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;mapred.task.id most likely is not in hadoop 0.23/2.0 and UDFContext.isFrontend() method needs to be fixed for hadoop 2.x.  &lt;/p&gt;</comment>
                            <comment id="13467538" author="cheolsoo" created="Tue, 2 Oct 2012 07:58:12 +0100"  >&lt;p&gt;You&apos;re right. I ran into this problem only with MR2 and couldn&apos;t understand how that&apos;s possible. Now everything makes sense!&lt;/p&gt;

&lt;p&gt;Fixing  UDFContext.isFrontend() seems like the right thing to do here.&lt;/p&gt;

&lt;p&gt;Thanks! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13468231" author="cheolsoo" created="Wed, 3 Oct 2012 02:00:57 +0100"  >&lt;p&gt;Attaching a new patch that fixes UDFContext.isFrontend() and as a result, HBaseStorage store in MR2.&lt;/p&gt;

&lt;p&gt;For MR1, it checks &quot;mapred.task.id&quot;, and for MR2, it checks &quot;mapreduce.job.application.attempt.id&quot;.&lt;/p&gt;</comment>
                            <comment id="13468337" author="rohini" created="Wed, 3 Oct 2012 05:52:25 +0100"  >&lt;p&gt;+1 non-binding.&lt;/p&gt;</comment>
                            <comment id="13468342" author="rohini" created="Wed, 3 Oct 2012 06:03:44 +0100"  >&lt;p&gt;Requesting that this patch be applied to 0.10 branch too. Thanks.&lt;/p&gt;</comment>
                            <comment id="13480857" author="daijy" created="Sun, 21 Oct 2012 01:07:28 +0100"  >&lt;p&gt;Patch committed to trunk/0.11/0.10. Thanks Cheolsoo, Rohini!&lt;/p&gt;</comment>
                            <comment id="13480895" author="sms" created="Sun, 21 Oct 2012 06:05:26 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt; the patch did not have unit test cases!&lt;/p&gt;</comment>
                            <comment id="13480997" author="rohini" created="Sun, 21 Oct 2012 18:17:23 +0100"  >&lt;p&gt;Santosh,&lt;br/&gt;
   At the moment it is not possible to have a unit test for this because of security. Whole security code path in Hadoop itself does not have unit tests primarily becoz of Kerberos. To actually add unit test to this, need a way to first bring up secure mini Hadoop and hbase clusters.&lt;br/&gt;
   Also hbase unit tests in pig do not run in 23 now. All stack components - pig, hbase, etc are yet to publish jars in maven compiled with hadoop23. Need to do that for pig with 0.11.&lt;/p&gt;</comment>
                            <comment id="13481077" author="daijy" created="Sun, 21 Oct 2012 22:35:42 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sms&quot; class=&quot;user-hover&quot; rel=&quot;sms&quot;&gt;Santhosh Srinivasan&lt;/a&gt; The issue occurs in secure cluster only, there is no way to write a test right now. The patch itself looks pretty safe and I feel it is Ok to commit as per the criteria we adopted before.&lt;/p&gt;</comment>
                            <comment id="13481222" author="sms" created="Mon, 22 Oct 2012 07:54:36 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;: while the symptom was exhibited with HBaseStorage on a secure cluster, the actual fix was in the code that determined if the execution environment was the front end or the back end. IMHO, that part of the code should be unit tested independent of the HBaseStorage (secure or otherwise).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12599148">PIG-2821</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12547476" name="PIG-2940-2.patch" size="708" author="cheolsoo" created="Wed, 3 Oct 2012 02:00:57 +0100"/>
                            <attachment id="12547320" name="PIG-2940.patch" size="1871" author="cheolsoo" created="Tue, 2 Oct 2012 01:48:36 +0100"/>
                            <attachment id="12547345" name="container_log" size="212372" author="cheolsoo" created="Tue, 2 Oct 2012 06:36:00 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 2 Oct 2012 04:45:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242066</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hxwcyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>