<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:00:51 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-4043/PIG-4043.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-4043] JobClient.getMap/ReduceTaskReports() causes OOM for jobs with a large number of tasks</title>
                <link>https://issues.apache.org/jira/browse/PIG-4043</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;With Hadoop 2.4, I often see Pig client fails due to OOM when there are many tasks (~100K) with 1GB heap size.&lt;/p&gt;

&lt;p&gt;The heap dump (attached) shows that TaskReport[] occupies about 80% of heap space at the time of OOM.&lt;/p&gt;

&lt;p&gt;The problem is that JobClient.getMap/ReduceTaskReports() returns an array of TaskReport objects, which can be huge if the number of task is large.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12724271">PIG-4043</key>
            <summary>JobClient.getMap/ReduceTaskReports() causes OOM for jobs with a large number of tasks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Sat, 28 Jun 2014 03:24:00 +0100</created>
                <updated>Fri, 21 Nov 2014 05:59:24 +0000</updated>
                            <resolved>Mon, 30 Jun 2014 04:30:11 +0100</resolved>
                                                    <fixVersion>0.14.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14046701" author="cheolsoo" created="Sat, 28 Jun 2014 03:37:48 +0100"  >&lt;p&gt;One thing to note is that the size of TaskReport object seems to have increased significantly in Hadoop 2 as compared to Hadoop 1. The same job can run with no problem in Hadoop 1 using the same size of heap, but it fails in Hadoop 2.&lt;/p&gt;

&lt;p&gt;The attached patch introduces a new property &lt;tt&gt;pig.stats.noTaskReport&lt;/tt&gt; via which retrieving TaskReports can be disabled for large jobs. By default, it is set to false, so JobStats will still use TaskReports.&lt;/p&gt;

&lt;p&gt;I also documented this new property in &lt;tt&gt;pig.properties&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14046878" author="rohini" created="Sat, 28 Jun 2014 16:04:01 +0100"  >&lt;p&gt;Patch is good. Just one minor comment. Can you make pig.stats.noTaskReport configuration all lower case?&lt;/p&gt;

&lt;p&gt;But before having to try add an option to turn off taskreports, I would like to suggest trying another thing. HadoopShims.java getTaskReports() for Hadoop 2.x does the below&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.hadoop.mapreduce.TaskReport[] reports = mrJob.getTaskReports(type);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DowngradeHelper.downgradeTaskReports(reports); 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think the OOM is because there are two huge arrays during the same time unlike Hadoop 1.x HadoopShims. I would suggest getTaskReports return an iterator instead of array and for every .next() call do TaskReport.downgrade() for the TaskReport to be returned. That way there is only the initial big array and only one TaskReport at a time.&lt;/p&gt;</comment>
                            <comment id="14046993" author="cheolsoo" created="Sat, 28 Jun 2014 23:48:10 +0100"  >&lt;blockquote&gt;
&lt;p&gt;I think the OOM is because there are two huge arrays during the same time unlike Hadoop 1.x HadoopShims.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This isn&apos;t true. In fact, I am seeing OOM in 0.12 that doesn&apos;t include the code you&apos;re referring to (introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3913&quot; title=&quot;Pig should use job&amp;#39;s jobClient wherever possible (fixes local mode counters)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3913&quot;&gt;&lt;del&gt;PIG-3913&lt;/del&gt;&lt;/a&gt;). In 0.12, there are no two copies of TaskReport arrays. If you look at the heap dump, it is a single array object that is as big as 800MB.&lt;/p&gt;

&lt;p&gt;In addition, I see the same issue in Lipstick, for example, &lt;a href=&quot;https://github.com/Netflix/Lipstick/blob/master/lipstick-console/src/main/java/com/netflix/lipstick/pigtolipstick/BasicP2LClient.java#L414&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;. The Pig dies as soon as calling &lt;tt&gt;JobClient.getTaskMapReports()&lt;/tt&gt;. I&apos;ve been running several tests so far. It&apos;s clear that I cannot run my job (100K mappers) with any &lt;tt&gt;JobClient.getTaskMapReports()&lt;/tt&gt; call in both Pig and Lipstick in Hadoop 2.4.&lt;/p&gt;

&lt;p&gt;Unless &lt;tt&gt;JobClient.getTaskMapReports()&lt;/tt&gt; itself returns an iterator, we need a way of disabling it.&lt;/p&gt;</comment>
                            <comment id="14046996" author="cheolsoo" created="Sat, 28 Jun 2014 23:56:01 +0100"  >&lt;p&gt;Per Rohini, make the property name all lowercase.&lt;/p&gt;</comment>
                            <comment id="14047234" author="rohini" created="Sun, 29 Jun 2014 20:58:10 +0100"  >&lt;p&gt;In that case we can keep this property. In this patch, I only see shims/src/hadoop20 HadoopShims.java modified and not hadoop23. You seem to have missed including it in the patch. Can you also&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;modify one of the existing MiniCluster unit tests and pass this property?&lt;/li&gt;
	&lt;li&gt;log a message about not fetching task reports as it is turned off&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will create a separate jira later to avoid the two arrays created by &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3913&quot; title=&quot;Pig should use job&amp;#39;s jobClient wherever possible (fixes local mode counters)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3913&quot;&gt;&lt;del&gt;PIG-3913&lt;/del&gt;&lt;/a&gt;. The two arrays could cause more jobs to fail that were passing in 0.12 and we have to get rid of it. &lt;/p&gt;</comment>
                            <comment id="14047285" author="cheolsoo" created="Mon, 30 Jun 2014 00:54:55 +0100"  >&lt;p&gt;Thank you Rohini. Here is a new patch that incorporates all your comments.&lt;/p&gt;</comment>
                            <comment id="14047286" author="cheolsoo" created="Mon, 30 Jun 2014 00:57:56 +0100"  >&lt;p&gt;Ah, wait. I misread what you asked for MiniCluster unit tests. I thought you&apos;re asking to turn off task reports for all MiniCluster unit tests.&lt;/p&gt;

&lt;p&gt;Let me submit a new patch...&lt;/p&gt;</comment>
                            <comment id="14047287" author="rohini" created="Mon, 30 Jun 2014 00:59:58 +0100"  >&lt;p&gt;Sorry. Just realized you mistook my previous comment and changed MiniCluster itself. That would turn it off for all unit tests. What I meant was one of the unit tests using MiniCluster. Also noticed a small typo TaskRepors -&amp;gt;TaskReports.&lt;/p&gt;</comment>
                            <comment id="14047333" author="cheolsoo" created="Mon, 30 Jun 2014 04:11:32 +0100"  >&lt;p&gt;Okie, hopefully this is the last patch. I added a new test to TestMRJobStats using a mini cluster and revert my previous changes to MiniCluster classes. Thanks! &lt;/p&gt;</comment>
                            <comment id="14047334" author="rohini" created="Mon, 30 Jun 2014 04:15:55 +0100"  >&lt;p&gt;+1. &lt;/p&gt;

&lt;p&gt;Changing getAvgREduceTime() to getAvgReduceTime() breaks Oozie. So need to keep it as it is. Can you revert that part of the patch and check in. &lt;/p&gt;</comment>
                            <comment id="14047339" author="cheolsoo" created="Mon, 30 Jun 2014 04:29:56 +0100"  >&lt;p&gt;Sure, I took it out. Attaching the final patch for record.&lt;/p&gt;

&lt;p&gt;Committed to trunk. Thank you Ronihi for your review!&lt;/p&gt;</comment>
                            <comment id="14136742" author="rohini" created="Wed, 17 Sep 2014 05:04:50 +0100"  >&lt;blockquote&gt;&lt;p&gt;In 0.12, there are no two copies of TaskReport arrays&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  Actually. Even it has. The two arrays are inside JobClient.java in mapreduce though. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12725818">PIG-4050</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12652992" name="PIG-4043-1.patch" size="4087" author="cheolsoo" created="Sat, 28 Jun 2014 03:40:11 +0100"/>
                            <attachment id="12653028" name="PIG-4043-2.patch" size="4087" author="cheolsoo" created="Sat, 28 Jun 2014 23:56:01 +0100"/>
                            <attachment id="12653078" name="PIG-4043-3.patch" size="8002" author="cheolsoo" created="Mon, 30 Jun 2014 00:54:55 +0100"/>
                            <attachment id="12653085" name="PIG-4043-4.patch" size="12421" author="cheolsoo" created="Mon, 30 Jun 2014 04:11:32 +0100"/>
                            <attachment id="12653087" name="PIG-4043-5.patch" size="10176" author="cheolsoo" created="Mon, 30 Jun 2014 04:29:56 +0100"/>
                            <attachment id="12652990" name="heapdump.png" size="228320" author="cheolsoo" created="Sat, 28 Jun 2014 03:25:36 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 28 Jun 2014 15:04:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>402456</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzr4lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>402523</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>