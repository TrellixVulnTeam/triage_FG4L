<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:58:45 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1447/PIG-1447.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1447] Tune memory usage of InternalCachedBag</title>
                <link>https://issues.apache.org/jira/browse/PIG-1447</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;We need to find a better value for &quot;pig.cachedbag.memusage&quot;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12466779">PIG-1447</key>
            <summary>Tune memory usage of InternalCachedBag</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thejas">Thejas M Nair</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jun 2010 22:23:26 +0100</created>
                <updated>Fri, 17 Dec 2010 22:44:32 +0000</updated>
                            <resolved>Mon, 23 Aug 2010 21:48:22 +0100</resolved>
                                    <version>0.7.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12899216" author="thejas" created="Tue, 17 Aug 2010 01:44:44 +0100"  >&lt;p&gt;The quest for better value for a new default value for pig.cachedbag.memusage was prompted by changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1443&quot; title=&quot;DefaultTuple underestimate the memory footprint for string&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1443&quot;&gt;&lt;del&gt;PIG-1443&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1492&quot; title=&quot;DefaultTuple and DefaultMemory understimate their memory footprint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1492&quot;&gt;&lt;del&gt;PIG-1492&lt;/del&gt;&lt;/a&gt; . Before the changes made as part of those jiras, pig was underestimating the memory footprint of data.&lt;br/&gt;
In data of &apos;typical&apos; sizes  (chararray/bytearray with less than 20 chars), the new memory size estimates can be upto 2 times the old version without any changes (0.6.0).&lt;/p&gt;

&lt;p&gt;I tried running pig queries with max heap size setting for tasks as 1GB, and compared the use of 0.1f and 0.2f as values for pig.cachedbag.memusage. I ran pigmix v1  queries(L1-L12) ,  modified pigmix v1 that specifies types , and modified L15 query which has several distincts in a nested foreach statement.&lt;br/&gt;
Only queries L5, L7 and L15 had proactive spills. I see that the number of spills goes down with 0.2f as the value, but the total runtime is practically the same. &lt;/p&gt;

&lt;p&gt;(See &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1524&quot; title=&quot;&amp;#39;Proactive spill count&amp;#39; is misleading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1524&quot;&gt;&lt;del&gt;PIG-1524&lt;/del&gt;&lt;/a&gt; for more on spills currently reported )&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; query &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; spills with 0.1f &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; spills with 0.2f &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; L5 (original pigmix) &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 496k &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 0 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; L7 (original pigmix) &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 82k &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 0 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; L5 (with types) &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 609k &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 82k &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; L7 (with types) &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 128k &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 0 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; L15_modified (attached to jira) &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  501k &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 326k &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;



&lt;p&gt;Some other factors to consider while determining a new value for this property -&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;as a result of issue described in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1544&quot; title=&quot;proactive-spill bags should share the memory alloted for it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1544&quot;&gt;PIG-1544&lt;/a&gt;, all proactive-spill bags don&apos;t share the memory limit.&lt;/li&gt;
	&lt;li&gt;the default value should be low enough, so that queries work fine in most cases. Expert users can tweak this to improve performance&lt;/li&gt;
	&lt;li&gt;the value of 0.1f has been used for a long time (with old memory estimate formula), and seems to work for most cases.&lt;/li&gt;
	&lt;li&gt;during the above tests, no other queries were running, so the disks were relatively free.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I propose that we increase the default value to 0.15f accommodate for changes in memory size estimation so that the spill behavior is closer to what it has been with 0.6 and 0.7. &lt;/p&gt;</comment>
                            <comment id="12899576" author="thejas" created="Tue, 17 Aug 2010 21:48:42 +0100"  >&lt;p&gt;I ran L15_modified after applying patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1524&quot; title=&quot;&amp;#39;Proactive spill count&amp;#39; is misleading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1524&quot;&gt;&lt;del&gt;PIG-1524&lt;/del&gt;&lt;/a&gt;, which gives number of bags that spilled, and total number of records that spilled -&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;query &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; spills with 0.1f &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; spills with 0.2f &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; L15_modified &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1.2 million bags containing total of  5million records. in range of 500mb  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 413k bags containing 3 million records . in range of 300mb&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
</comment>
                            <comment id="12899581" author="olgan" created="Tue, 17 Aug 2010 21:55:23 +0100"  >&lt;p&gt;Did you see any perf improvement?&lt;/p&gt;</comment>
                            <comment id="12900332" author="thejas" created="Thu, 19 Aug 2010 17:13:27 +0100"  >&lt;blockquote&gt;&lt;p&gt;Did you see any perf improvement? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, the query is the same and the performance is the same, just that the number of records reported earlier were not correct. Infact there was also a mistake in the calculation, i have fixed that in updated patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1524&quot; title=&quot;&amp;#39;Proactive spill count&amp;#39; is misleading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1524&quot;&gt;&lt;del&gt;PIG-1524&lt;/del&gt;&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;I made further modifications to the L15_modified.pig to use larger columns - L15_modified2.pig (attached). With this query the number of records dumped are 17.5 million with 0.1f and 20 million  with 0.2f for pig.cachedbag.memusage . The records are also much larger in size . I see around 10% improvement with 0.2f .&lt;/p&gt;

&lt;p&gt;Considering the issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1544&quot; title=&quot;proactive-spill bags should share the memory alloted for it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1544&quot;&gt;PIG-1544&lt;/a&gt; and that multi-query optimized queries can have large number of bags, I think it is safer to leave the value at 10% for now. We can add documentation on adjusting the value of this property so that users can adjust it if they see lot of records being proactive-spilled .&lt;/p&gt;

&lt;p&gt;We should revisit this once &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1544&quot; title=&quot;proactive-spill bags should share the memory alloted for it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1544&quot;&gt;PIG-1544&lt;/a&gt; is fixed.&lt;/p&gt;</comment>
                            <comment id="12900435" author="thejas" created="Thu, 19 Aug 2010 21:25:09 +0100"  >&lt;p&gt;I am wrong about multi-query being a big cause for concern in raising this parameter value - the sub-plans for each query in multi-query are executed one at a time for a given tuple with large bags. So the number of large bags that can&apos;t be garbage collected would be similar to that of single query. 15% default value seems to be reasonably safe.&lt;/p&gt;
</comment>
                            <comment id="12900939" author="thejas" created="Sat, 21 Aug 2010 01:12:46 +0100"  >&lt;p&gt;Some more reasons why higher value would still be safe -&lt;br/&gt;
1. A lot of the memory attributed to the InternalDistinct/InternalSorted bags used from within nested-foreach will be shared with the InternalCacheBag in the input tuple because the pig does not create a copy of the column objects.&lt;br/&gt;
2. In a nested foreach,  at a time only one inner-plan will hold references to the Internal* bags . The internal* bags are eventually converted to DefaultDataBag by RelationToExpressionProject in these plans. In most common cases (say you are generating multiple-count distincts, order-bys on bags in nested foreach), that means only one Internal* bag created within nested foreach will be referenced at a time. I tried comparing the memory footprint with different number of distinct operations in a nested-foreach, and found them to be in same range.&lt;br/&gt;
I am planning to set the default at 20% for now. If we find the memory limits being hit as a result of this during the beta testing period, we can reduce the default.&lt;/p&gt;</comment>
                            <comment id="12901574" author="thejas" created="Mon, 23 Aug 2010 21:27:00 +0100"  >&lt;p&gt;Patch for increasing default value to 20%. &lt;br/&gt;
No new test cases as this only changes the memory limit default.&lt;br/&gt;
All core tests pass. Result of test-patch -&lt;/p&gt;

&lt;p&gt;     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; -1 overall.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 @author.  The patch does not contain any @author tags.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;                         Please justify why no tests are needed for this patch.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;</comment>
                            <comment id="12901576" author="olgan" created="Mon, 23 Aug 2010 21:30:59 +0100"  >&lt;p&gt;This is probably the smallest patch I have reviewed recently &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. +1&lt;/p&gt;</comment>
                            <comment id="12901582" author="thejas" created="Mon, 23 Aug 2010 21:48:22 +0100"  >&lt;p&gt;Patch committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12452236" name="L15_modified.pig" size="865" author="thejas" created="Tue, 17 Aug 2010 01:44:44 +0100"/>
                            <attachment id="12452413" name="L15_modified2.pig" size="945" author="thejas" created="Wed, 18 Aug 2010 17:21:12 +0100"/>
                            <attachment id="12452688" name="PIG-1447.1.patch" size="1774" author="thejas" created="Sat, 21 Aug 2010 01:13:49 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 17 Aug 2010 00:44:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164936</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyaqjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96611</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>