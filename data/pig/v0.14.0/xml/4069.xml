<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:55:36 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-4069/PIG-4069.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-4069] Limit reduce task should start as soon as one map task finishes</title>
                <link>https://issues.apache.org/jira/browse/PIG-4069</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;  Set very low values for ShuffleVertexManager.TEZ_AM_SHUFFLE_VERTEX_MANAGER_MIN_SRC_FRACTION and ShuffleVertexManager.TEZ_AM_SHUFFLE_VERTEX_MANAGER_MAX_SRC_FRACTION in case of LIMIT job not following an order by so that the reduce task starts as soon as 1 map task finishes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12729531">PIG-4069</key>
            <summary>Limit reduce task should start as soon as one map task finishes</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12704071">PIG-3839</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Jul 2014 19:42:25 +0100</created>
                <updated>Fri, 21 Nov 2014 05:58:19 +0000</updated>
                            <resolved>Mon, 10 Nov 2014 05:36:42 +0000</resolved>
                                                    <fixVersion>0.14.0</fixVersion>
                                    <component>tez</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14136298" author="rohini" created="Tue, 16 Sep 2014 22:43:21 +0100"  >&lt;p&gt;Initial patch. Does not show much performance improvement in local box. Investigating that. I guess most likely it is because the mappers still have to finish even though the reducer is done early. Will also run on bigger data on a cluster and see. &lt;/p&gt;</comment>
                            <comment id="14136710" author="rohini" created="Wed, 17 Sep 2014 04:23:28 +0100"  >&lt;p&gt;Had &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sseth&quot; class=&quot;user-hover&quot; rel=&quot;sseth&quot;&gt;Siddharth Seth&lt;/a&gt; investigate the job logs. His response to my mail as below&lt;/p&gt;

&lt;p&gt;For a job which does just load and limit, there are two vertices&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Load vertex (parallelism=27, vertex id=scope-3)&lt;/li&gt;
	&lt;li&gt;Limit vertex (parallelism=1, vertex id=scope-5)&lt;br/&gt;
I set tez.shuffle-vertex-manager.min-src-fraction and max fraction to 0.00001&lt;br/&gt;
for the limit vertex. The edge connecting them uses unordered output and input. &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Few issues:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The second vertex task was launched only after launching all first vertex tasks even if src fraction was set to such low value.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Sidd: Tasks for the second vertex will get scheduled the moment the specified fraction of tasks on the source vertex complete. However, all tasks on the previous vertex are already scheduled, and with a higher execution priority - so they will execute first.&lt;/p&gt;

&lt;p&gt;A couple of ways to get past this.&lt;br/&gt;
1) To control the way the tasks on the first vertex are scheduled via a custom plugin. Essentially - wait for feedback, and launch tasks only when they are required. This may be the easier approach.&lt;br/&gt;
2) Invert priorities (avoid DAGSchedulerNaturalOrder). This can get complicated really fast, especially, when multiple edges are involved, and has led to daedlocks in the past.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Even if second vertex completes, the DAG has to wait till the source tasks of first vertex complete.&lt;br/&gt;
Sidd: This is expected behaviour. A vertex does not complete till all it&apos;s tasks complete, and the DAG does not complete till all vertices complete. We&apos;ll have to introduce the ability to KILL tasks with state SUCCESS, or just mark unlaunched tasks as SUCCESSFUL for this to work. &lt;/li&gt;
	&lt;li&gt;Another thing I am seeing is that there are two attempts launched for first vertex. The second attempts are after the second vertex completes.&lt;br/&gt;
Sidd: This is a bug. The ShuffleManager is supposed to ignore all errors from the fetchers which it could not shutdown if the processor is complete. It&apos;s not doing this in certain circumstances. Should be fairly easy to fix.  &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My expectation was that once the destination vertex completes, src vertex will be terminated without issues and job will finish fast. But that is not the case. In fact it took more time because of the retry attempts.  Have attached the whole application log.&lt;/p&gt;

&lt;p&gt;Sidd: See notes above about expected behaviour - and the requirement to be able to mark a task as KILLED+SUCCEEDED. I&apos;d prefer avoiding special casing DAG completion on leaf vertex completion - since we don&apos;t really know much about what is being generated by the intermediate vertices. &lt;/p&gt;

&lt;p&gt;I will create jiras once one of you confirm the issues or clarify the expected behaviour.&lt;/p&gt;</comment>
                            <comment id="14136727" author="rohini" created="Wed, 17 Sep 2014 04:40:19 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt;,&lt;br/&gt;
   I would still like to checkin this patch with the   if (tezOp.isLimit()..) block commented out in TezDAGBuilder as I am planning to do &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4039&quot; title=&quot;New interface for resetting static variables for jvm reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4039&quot;&gt;&lt;del&gt;PIG-4039&lt;/del&gt;&lt;/a&gt; - package refactor of tez classes tomorrow, and do not want to spend time rebasing this patch later. Also this patch has more than the low src fraction. It cleans up TezOperator a bit and fixes an bug with Order by followed by filter or foreach and then Limit. Can you review it?&lt;/p&gt;

&lt;p&gt;I would love to keep the block uncommented if not for the fact that it reruns the tasks of first vertex (&lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-1590&quot; title=&quot;Fetchers should not report failures after the Processor on the task completes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-1590&quot;&gt;&lt;del&gt;TEZ-1590&lt;/del&gt;&lt;/a&gt;) when second vertex finishes before it. Otherwise the time taken would be same if LIMIT is the last statement and might improve performance if there are operations following the LIMIT. This issue coule be happening even now with LIMIT but this patch would increase the probability very much. Will uncomment the code once &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-1590&quot; title=&quot;Fetchers should not report failures after the Processor on the task completes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-1590&quot;&gt;&lt;del&gt;TEZ-1590&lt;/del&gt;&lt;/a&gt; is fixed. &lt;/p&gt;

&lt;p&gt;No time to work on the custom scheduler right now. Will create a separate jira to work on it next quarter or year as LIMIT is not very high priority for optimization and this would require features in Tez as well.  &lt;/p&gt;</comment>
                            <comment id="14138392" author="daijy" created="Thu, 18 Sep 2014 03:00:47 +0100"  >&lt;p&gt;Sounds good. Once &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-1590&quot; title=&quot;Fetchers should not report failures after the Processor on the task completes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-1590&quot;&gt;&lt;del&gt;TEZ-1590&lt;/del&gt;&lt;/a&gt; committed, we need to go back and see if performance improves. &lt;/p&gt;

&lt;p&gt;+1 for committing now. Thanks for the new limit test cases and feature vector clean up!&lt;/p&gt;</comment>
                            <comment id="14138985" author="rohini" created="Thu, 18 Sep 2014 15:16:05 +0100"  >&lt;p&gt;Minor fix to cleanup the leftover temporary file input in ReadScalarsTez. This was causing failure of new test due to different random number in generated path in golden file.&lt;/p&gt;</comment>
                            <comment id="14139179" author="rohini" created="Thu, 18 Sep 2014 18:07:20 +0100"  >&lt;p&gt;Committed to trunk (0.14). Will close this jira once a fix is available in tez and we can uncomment the block of code that sets src fraction to a low value.&lt;/p&gt;</comment>
                            <comment id="14204338" author="rohini" created="Mon, 10 Nov 2014 04:55:28 +0000"  >&lt;p&gt;Ran test-tez and test-tez-local and build was successful.&lt;/p&gt;
</comment>
                            <comment id="14204362" author="daijy" created="Mon, 10 Nov 2014 05:26:20 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14204377" author="rohini" created="Mon, 10 Nov 2014 05:36:42 +0000"  >&lt;p&gt;Committed the patch which removes the commented out code and enables this improvement with Tez 5.2 to branch-0.14 and trunk. Thanks Daniel for the review.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12742036">TEZ-1590</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12754025">PIG-4320</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12669230" name="PIG-4069-1.patch" size="35551" author="rohini" created="Tue, 16 Sep 2014 22:43:21 +0100"/>
                            <attachment id="12669483" name="PIG-4069-2.patch" size="35239" author="rohini" created="Wed, 17 Sep 2014 20:16:03 +0100"/>
                            <attachment id="12669736" name="PIG-4069-3.patch" size="35507" author="rohini" created="Thu, 18 Sep 2014 15:16:05 +0100"/>
                            <attachment id="12680528" name="PIG-4069-Tez_0_5_2.patch" size="2000" author="rohini" created="Mon, 10 Nov 2014 04:55:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 18 Sep 2014 02:00:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>407606</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzrzx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>407620</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>