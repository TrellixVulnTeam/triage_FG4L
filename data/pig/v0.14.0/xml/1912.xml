<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:01:28 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1912/PIG-1912.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1912] non-deterministic output when a file is loaded multiple times</title>
                <link>https://issues.apache.org/jira/browse/PIG-1912</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;I have a small demonstration script (actually, a directory with one main script and several other scripts that it calls) where the output (STOREd to a file) is not consistent between runs.  I will paste the files below this message, and I can also email the tarball to anybody who would like it; I wanted to just upload the tarball but I don&apos;t see a way to do that.&lt;/p&gt;

&lt;p&gt;The problem appears to be that when a dataset X gets LOADed twice, with things other than LOADs occurring between the loads (like a FOREACH GENERATE), a FOREACH GENERATE that is later performed on X doesn&apos;t always choose the correct columns.  The correctness of the output was highly variable on my computer, for one of my co-workers it &lt;b&gt;almost&lt;/b&gt; always failed, and for two other of my co-workers they didn&apos;t see any failures, so it&apos;s likely to be a race condition or something like that.&lt;/p&gt;


&lt;p&gt;&amp;#8211; FILES FOR REPLICATING THE PROBLEM&lt;br/&gt;
&amp;#8211; I will paste the name of the file as a comment, with the content of the file beneath it.&lt;br/&gt;
&amp;#8211; I will put the contents of the following files:&lt;br/&gt;
&amp;#8211; 1) The Pig scripts (main.pig, calc_x_W.pig, calc_x_Y.pig, and load_raw_data.pig)&lt;br/&gt;
&amp;#8211; 2) The input data file (data.csv)&lt;br/&gt;
&amp;#8211; 3) The correct output file (correct_output.csv)&lt;br/&gt;
&amp;#8211; 4) The shell script that runs the pig files and compares their output to what it should be&lt;br/&gt;
&amp;#8211; 5) README&lt;/p&gt;


&lt;p&gt;&amp;#8211; main.pig&lt;br/&gt;
RUN calc_x_W.pig;&lt;br/&gt;
RUN calc_x_Y.pig;&lt;br/&gt;
STORE x_W INTO &apos;output/W&apos; USING PigStorage(&apos;,&apos;);&lt;br/&gt;
STORE x_Y INTO &apos;output/Y&apos; USING PigStorage(&apos;,&apos;);  &amp;#8211; this is wrong sometimes&lt;/p&gt;

&lt;p&gt;&amp;#8211; calc_x_W.pig&lt;br/&gt;
RUN load_raw_data.pig;&lt;br/&gt;
x_W = FOREACH raw_data GENERATE x, w;&lt;/p&gt;

&lt;p&gt;&amp;#8211; calc_x_Y.pig&lt;br/&gt;
RUN load_raw_data.pig;&lt;br/&gt;
x_Y = FOREACH raw_data GENERATE x, y;&lt;/p&gt;

&lt;p&gt;&amp;#8211; load_raw_data.pig&lt;br/&gt;
raw_data = LOAD &apos;data.csv&apos; USING PigStorage(&apos;,&apos;)&lt;br/&gt;
AS (&lt;br/&gt;
  x,&lt;br/&gt;
  y,&lt;br/&gt;
  w&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;&amp;#8211; data.csv&lt;br/&gt;
x1,CORRECT  ANSWER,21148.59&lt;br/&gt;
x2,CORRECT  OUTPUT,27219.98&lt;br/&gt;
x3,RIGHT    ANSWER,10818.15&lt;/p&gt;

&lt;p&gt;&amp;#8211; correct_output.csv&lt;br/&gt;
x1,CORRECT  ANSWER&lt;br/&gt;
x2,CORRECT  OUTPUT&lt;br/&gt;
x3,RIGHT    ANSWER&lt;/p&gt;

&lt;p&gt;&amp;#8211; testmany.sh&lt;br/&gt;
typeset -a results&lt;br/&gt;
i=0&lt;br/&gt;
while (( i &amp;lt; 10 )); do&lt;br/&gt;
  rm -rf output/*&lt;br/&gt;
  pig -x local -d WARN -e &quot;set debug off;run main.pig&quot; || break&lt;br/&gt;
  diff correct_output.csv output/Y/part-m-00000 &amp;amp;&amp;amp; echo good&lt;br/&gt;
  results&lt;span class=&quot;error&quot;&gt;&amp;#91;$i&amp;#93;&lt;/span&gt;=$?&lt;br/&gt;
  i=$((i+1))&lt;br/&gt;
done;&lt;br/&gt;
echo $&lt;/p&gt;
{results[*]}

&lt;p&gt;&amp;#8211; README&lt;/p&gt;

&lt;p&gt;This directory is intended to show a non-deterministic bug in pig.&lt;br/&gt;
Non-deterministic in the sense that the output of the script is not&lt;br/&gt;
the same between different times it is run on the same input; usually&lt;br/&gt;
the input is right, but sometimes it&apos;s wrong for no apparent reason.&lt;/p&gt;

&lt;p&gt;The scripts and dataset included in this directory demonstrate the&lt;br/&gt;
issue.  The scripts load the file data.csv and write to the output&lt;br/&gt;
directory, but the file output/Y/part-m-00000 is sometimes different&lt;br/&gt;
between consecutive runs.  In particular, this file SHOULD just be&lt;br/&gt;
the first and third columns of data.csv, but it sometimes uses the&lt;br/&gt;
second column in place of the third.&lt;/p&gt;

&lt;p&gt;The root of the problem appears to be that there is an intermediate&lt;br/&gt;
LOAD of data.csv, after some relations have already been defined.&lt;br/&gt;
The following things will make the error stop:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;commenting out &quot;STORE x_W INTO &apos;output/W&apos; USING PigStorage(&apos;,&apos;);&quot; in main.pig&lt;/li&gt;
	&lt;li&gt;making a copy of data.csv called data2.csv, and a file load_daw_data2.pig&lt;br/&gt;
  that loads data2.csv and having having calc_x_W.pig use that instead.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It&apos;s possible that this isn&apos;t a bug and I&apos;m just mis-using Pig;&lt;br/&gt;
if that is the case I would greatly appreciate hearing about it.&lt;br/&gt;
I believe this issue was also discussed here:&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/pig-user/201102.mbox/%3CAANLkTi=2ZtkVGJevKLYSSzSH--KCcX38+Xaw2d2STNiS@mail.gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/pig-user/201102.mbox/%3CAANLkTi=2ZtkVGJevKLYSSzSH--KCcX38+Xaw2d2STNiS@mail.gmail.com%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have a shell script testmany.sh which runs my script multiple times&lt;br/&gt;
and reports for which runs the output agrreed with the file correct_output.csv.&lt;/p&gt;

&lt;p&gt;IMPORTANT NOTE: We have run this code on 4 different laptops, all running&lt;br/&gt;
pig 0.8.0.  On one laptop (the one I&apos;m using) the output of this script&lt;br/&gt;
was highly non-deterministic, generally giving both the wrong and the right&lt;br/&gt;
output several times each during 10 runs.  Another laptop consistently got&lt;br/&gt;
the wrong output up until the 28th run, when it finally gave the right output.&lt;br/&gt;
The other two computer never actually observed the wrong output.  We suspect&lt;br/&gt;
this is likely a race condition.&lt;/p&gt;


&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;USAGE&lt;br/&gt;
$ cd pigbug&lt;br/&gt;
$ bash testmany.sh&lt;br/&gt;
$ # the last line of output will be a sequence of 0s and 1s, with 1&lt;br/&gt;
$ # meaning that there was disagreement between the output and&lt;br/&gt;
$ # correct_output.csv&lt;/p&gt;

&lt;p&gt;Field Cady&lt;br/&gt;
field.cady@gmail.com&lt;br/&gt;
fcady@operasolutions.com&lt;br/&gt;
(360)621-4810&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 10.04&lt;/p&gt;</environment>
        <key id="12501622">PIG-1912</key>
            <summary>non-deterministic output when a file is loaded multiple times</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="field.cady">Field Cady</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Mar 2011 21:11:46 +0000</created>
                <updated>Thu, 2 May 2013 21:33:16 +0100</updated>
                            <resolved>Wed, 23 Mar 2011 00:50:59 +0000</resolved>
                                                    <fixVersion>0.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13007693" author="field.cady" created="Wed, 16 Mar 2011 21:12:36 +0000"  >&lt;p&gt;Again, I have a tarball with all the files.  Just email me if you want it.  Thanks!&lt;/p&gt;</comment>
                            <comment id="13008233" author="daijy" created="Fri, 18 Mar 2011 00:01:30 +0000"  >&lt;p&gt;I can reproduce. If we collapse all 4 scripts into one, it runs fine. This issue only occurs when we invoking scripts inside script. I will take a look.&lt;/p&gt;</comment>
                            <comment id="13008711" author="daijy" created="Sat, 19 Mar 2011 01:52:00 +0000"  >&lt;p&gt;I find the problem. Flatten the script:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
raw_data = LOAD &apos;data.csv&apos; USING PigStorage(&apos;,&apos;) AS (x, y, w);
x_W = FOREACH raw_data GENERATE x, w;
raw_data = LOAD &apos;data.csv&apos; USING PigStorage(&apos;,&apos;) AS (x, y, w);
x_Y = FOREACH raw_data GENERATE x, y;
STORE x_W INTO &apos;output/W&apos; USING PigStorage(&apos;,&apos;);
STORE x_Y INTO &apos;output/Y&apos; USING PigStorage(&apos;,&apos;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We have two loaders in the script. Internally, every loader has a signature, which consists of alias, input file, parameters. Pig keep track of status of each loader using signature. In this script, all three components are the same. Pig get confused which status belonging to which loader.&lt;/p&gt;

&lt;p&gt;There are two ways to get around, either change one load statement slightly, or use only one load statement, feeding it to multiple subsequent statements.&lt;/p&gt;

&lt;p&gt;I cannot find a quick way to make a more specific signature. In short turn, we can check conflicts of signature and fail out if it happens.&lt;/p&gt;</comment>
                            <comment id="13008721" author="field.cady" created="Sat, 19 Mar 2011 03:16:22 +0000"  >&lt;p&gt;Thank you for the help!  I think my company has figured out some good ways&lt;br/&gt;
to work around it - I mostly just wanted to make sure that the Pig&lt;br/&gt;
development community was aware of the issue.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Field&lt;/p&gt;






&lt;p&gt;&amp;#8211; &lt;br/&gt;
Field Cady&lt;br/&gt;
Department of Computer Science&lt;br/&gt;
Carnegie Mellon University&lt;br/&gt;
(360)621-4810&lt;br/&gt;
field.cady@gmail.com&lt;/p&gt;</comment>
                            <comment id="13008848" author="thejas" created="Sat, 19 Mar 2011 23:24:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;We have two loaders in the script. Internally, every loader has a signature, which consists of alias, input file, parameters. Pig keep track of status of each loader using signature. In this script, all three components are the same. Pig get confused which status belonging to which loader.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Does pig need to reconstruct the signature from the parts used to create the signature ? If not, I think pig can just generate a distinct signature each time. Maybe add an signature index to alias + file + params, so that the signature can still be easily to understand for debugging.&lt;/p&gt;</comment>
                            <comment id="13008999" author="daijy" created="Mon, 21 Mar 2011 01:12:39 +0000"  >&lt;p&gt;The best way is to add an index to the signature instead of fail out. I will post a patch.&lt;/p&gt;</comment>
                            <comment id="13009464" author="daijy" created="Mon, 21 Mar 2011 23:11:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1912&quot; title=&quot;non-deterministic output when a file is loaded multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1912&quot;&gt;&lt;del&gt;PIG-1912&lt;/del&gt;&lt;/a&gt;-2.patch fix findbug warnings.&lt;/p&gt;</comment>
                            <comment id="13009465" author="daijy" created="Mon, 21 Mar 2011 23:16:34 +0000"  >&lt;p&gt;Review notes: &lt;a href=&quot;https://reviews.apache.org/r/519/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/519/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13009884" author="daijy" created="Tue, 22 Mar 2011 22:41:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1912&quot; title=&quot;non-deterministic output when a file is loaded multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1912&quot;&gt;&lt;del&gt;PIG-1912&lt;/del&gt;&lt;/a&gt;-3.patch address Santhosh&apos;s review comments&lt;/p&gt;</comment>
                            <comment id="13009891" author="daijy" created="Tue, 22 Mar 2011 22:49:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1912&quot; title=&quot;non-deterministic output when a file is loaded multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1912&quot;&gt;&lt;del&gt;PIG-1912&lt;/del&gt;&lt;/a&gt;-3_0.8.patch is for 0.8 branch. There is slight difference between &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1912&quot; title=&quot;non-deterministic output when a file is loaded multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1912&quot;&gt;&lt;del&gt;PIG-1912&lt;/del&gt;&lt;/a&gt;-3.patch.&lt;/p&gt;</comment>
                            <comment id="13009932" author="daijy" created="Wed, 23 Mar 2011 00:46:53 +0000"  >&lt;p&gt;test-patch result:&lt;/p&gt;

&lt;p&gt;     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; +1 overall.  &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 @author.  The patch does not contain any @author tags.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 tests included.  The patch appears to include 3 new or modified tests.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;</comment>
                            <comment id="13009934" author="daijy" created="Wed, 23 Mar 2011 00:50:59 +0000"  >&lt;p&gt;Patch committed to both trunk and 0.8 branch.&lt;/p&gt;</comment>
                            <comment id="13644777" author="field.cady" created="Mon, 29 Apr 2013 20:32:32 +0100"  >&lt;p&gt;This completely shows the issue, including sample data and a shell script that runs pig in local mode to show the bug.&lt;/p&gt;</comment>
                            <comment id="13647866" author="daijy" created="Thu, 2 May 2013 21:33:16 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=field.cady&quot; class=&quot;user-hover&quot; rel=&quot;field.cady&quot;&gt;Field Cady&lt;/a&gt; Did you attach to the wrong Jira?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12474143" name="PIG-1912-1.patch" size="9587" author="daijy" created="Mon, 21 Mar 2011 01:18:05 +0000"/>
                            <attachment id="12474248" name="PIG-1912-2.patch" size="9594" author="daijy" created="Mon, 21 Mar 2011 23:11:02 +0000"/>
                            <attachment id="12474352" name="PIG-1912-3.patch" size="10095" author="daijy" created="Tue, 22 Mar 2011 22:41:45 +0000"/>
                            <attachment id="12474353" name="PIG-1912-3_0.8.patch" size="10234" author="daijy" created="Tue, 22 Mar 2011 22:49:23 +0000"/>
                            <attachment id="12581020" name="pigbug.zip" size="3619" author="field.cady" created="Mon, 29 Apr 2013 20:32:32 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 18 Mar 2011 00:01:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>165241</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyaugn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97246</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>non-deterministic, load, store</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>