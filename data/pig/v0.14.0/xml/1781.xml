<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:03:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1781/PIG-1781.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1781] Piggybank: ISOToDay disregards timezone (should use ISODateTimeFormat instead of DateTime to parse)</title>
                <link>https://issues.apache.org/jira/browse/PIG-1781</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;(Apologies if this is the wrong place to file Piggybank bugs)&lt;/p&gt;

&lt;p&gt;Bug in &lt;a href=&quot;http://svn.apache.org/viewvc/pig/trunk/contrib/piggybank/java/src/main/java/org/apache/pig/piggybank/evaluation/datetime/truncate/ISOToDay.java?view=markup&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/pig/trunk/contrib/piggybank/java/src/main/java/org/apache/pig/piggybank/evaluation/datetime/truncate/ISOToDay.java?view=markup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and other &lt;a href=&quot;http://svn.apache.org/viewvc/pig/trunk/contrib/piggybank/java/src/main/java/org/apache/pig/piggybank/evaluation/datetime/truncate/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc/pig/trunk/contrib/piggybank/java/src/main/java/org/apache/pig/piggybank/evaluation/datetime/truncate/&lt;/a&gt; classes that copy-paste the same code.&lt;/p&gt;

&lt;p&gt;These classes parse dates like so:&lt;br/&gt;
 	DateTimeZone.setDefault(DateTimeZone.UTC); 	&lt;br/&gt;
 	DateTime dt = new DateTime((String)input.get(0).toString()); &lt;/p&gt;

&lt;p&gt;This has two problems:&lt;br/&gt;
(1) It messes up JVM static state by changing the DateTimeZone default time zone.&lt;br/&gt;
(2) It ignore timezone information in the input string, so times like &quot;2009-12-09T23:59:59-0800&quot; get truncated to &quot;2009-12-10T00:00:00Z&quot;, which is the wrong day of year. &lt;/p&gt;

&lt;p&gt;Instead, they should use something like this, which respects the input timezone and does not modify any global state:&lt;/p&gt;

&lt;p&gt;  DateTime dt ISODateTimeFormat.dateTime().withOffsetParsed().parseDateTime(isoDateString);&lt;/p&gt;

&lt;p&gt;I have not provided a patch, because I&apos;m not really set up to hack on Piggybank locally.&lt;/p&gt;

&lt;p&gt;As a workaround, I am copy-pasting the classes into my own packages, and making the desired change.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12494005">PIG-1781</key>
            <summary>Piggybank: ISOToDay disregards timezone (should use ISODateTimeFormat instead of DateTime to parse)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="misterbeebee">Michael Brauwerman</assignee>
                                    <reporter username="misterbeebee">Michael Brauwerman</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Dec 2010 20:14:13 +0000</created>
                <updated>Thu, 20 Jan 2011 18:59:21 +0000</updated>
                            <resolved>Thu, 20 Jan 2011 18:59:21 +0000</resolved>
                                    <version>0.8.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12974743" author="misterbeebee" created="Thu, 23 Dec 2010 21:11:58 +0000"  >&lt;p&gt;This patch file was generated by &quot;cd contrib/piggybank/java &amp;amp;&amp;amp; svn diff&quot;. I do not know if that is the desired format.&lt;/p&gt;

&lt;p&gt;This is a patch against trunk.&lt;/p&gt;

&lt;p&gt;Notes on the code:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests included for logic change, new feature (non-UTC support), and new class&apos;s methods.&lt;/li&gt;
	&lt;li&gt;In addition to fixing the bug, I refactored a bit of common code into a new class ISOHelper.&lt;/li&gt;
	&lt;li&gt;Whitespace is a bit funky, because I made the changes in XCode, not Eclipse.&lt;/li&gt;
	&lt;li&gt;It might work well against 0.8.0 as well. At a glance, I didn&apos;t see code changes in the affected classes.&lt;/li&gt;
	&lt;li&gt;Example code (in the comments) was &lt;b&gt;not&lt;/b&gt; updated to include examples of non-UTC usage.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12974744" author="misterbeebee" created="Thu, 23 Dec 2010 21:13:30 +0000"  >&lt;p&gt;This is the patch I intended to submit along with my previous submissionn(the &quot;Submit Patch&quot; Workflow Action).&lt;/p&gt;</comment>
                            <comment id="12974770" author="misterbeebee" created="Thu, 23 Dec 2010 22:16:52 +0000"  >&lt;p&gt;(Cancelling patch, because I read &lt;a href=&quot;http://wiki.apache.org/pig/HowToContribute&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/pig/HowToContribute&lt;/a&gt; and saw that &quot;Submit Patch&quot; is for a more formal submission. I apologize.)&lt;/p&gt;</comment>
                            <comment id="12974771" author="misterbeebee" created="Thu, 23 Dec 2010 22:18:52 +0000"  >&lt;p&gt;Re-uploading patch with &quot;.patch&quot; extension.&lt;/p&gt;</comment>
                            <comment id="12974773" author="misterbeebee" created="Thu, 23 Dec 2010 22:20:49 +0000"  >&lt;p&gt;Re-Submitting Patch after re-uploading patch with proper filename.&lt;/p&gt;</comment>
                            <comment id="12974793" author="alangates" created="Thu, 23 Dec 2010 23:52:45 +0000"  >&lt;p&gt;One quick comment:  our coding conventions are to use spaces and not tabs.  See &lt;a href=&quot;http://wiki.apache.org/pig/HowToContribute&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/pig/HowToContribute&lt;/a&gt; where it talks about our coding conventions (search on Sun to find it).  &lt;/p&gt;

&lt;p&gt;FYI most of us are off for Christmas after today, so it may be after New Years before someone gets around to reviewing this.&lt;/p&gt;

&lt;p&gt;Russell, did you want to take a look at this since you did a lot of the original ISO work?&lt;/p&gt;</comment>
                            <comment id="12974850" author="misterbeebee" created="Fri, 24 Dec 2010 06:20:43 +0000"  >&lt;p&gt;Updated patch, created at trunk/contrib/piggybank.&lt;br/&gt;
&apos;ant test&apos; ran to BUILD SUCCESSFUL&lt;/p&gt;

&lt;p&gt;New Changes in this patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Re-indented all touched files to use 4-spaces instead of tabs.&lt;/li&gt;
	&lt;li&gt;Removed some stray System.out.println lines in some tests&lt;/li&gt;
	&lt;li&gt;Changed some assertTrue(foo.equals(bar)) to assertEquals(foo, bar) (for clearer output when tests fail.)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Changes between repo and this patch, that I forgot to mention earlier:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Changed some assertTrue(foo.equals(bar)) to assertEquals(foo, bar) (for clearer output when tests fail.)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Concerns:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;piggybank does not have a &apos;doc&apos; or &apos;test-patch&apos; target, so I could not run those. Particularly, I couldn&apos;t run the &quot;hudson auto-review&quot; locally.&lt;/li&gt;
	&lt;li&gt;I&apos;m not 100% on the interaction between core pig and piggybank in the build files, so I hope I did not break or overlook anything in that interaction.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I got Eclipse set up to develop on Pig, which is much nicer than Xcode. Yay.&lt;/p&gt;

&lt;p&gt;OK, I hope this is helpful! It would be swell if this change got merged the 0.8 branch also (if an 0.8.1 release is planned), but I&apos;m in no personal rush, since I have a local build that works for my project.&lt;/p&gt;

&lt;p&gt;Oh, and if this behavior change is undesired for some reason, no hard feelings. I don&apos;t know if anyone else is using Piggybank for bucketing-by-day analysis in non-UTC timezones, but I am, and so the truncate package is quite handy for me; I just need a version that works on US/Pacific-timezone dateTimes.&lt;/p&gt;

</comment>
                            <comment id="12974981" author="dvryaboy" created="Fri, 24 Dec 2010 22:41:12 +0000"  >&lt;p&gt;Michael, &lt;br/&gt;
Thanks a lot for contributing, I think this is a useful feature. &lt;/p&gt;

&lt;p&gt;We are not planning a 0.8.1 at the moment, but it&apos;s possible we will separate piggybank from Pig releases, so this would become available before 0.9.&lt;/p&gt;

&lt;p&gt;Overall the patch looks good, but I think that you still want to set the default time zone to be UTC, not whatever the system default is. So you will want to put the DateTimeZone.setDefault(DateTimeZone.UTC) call into the new helper class.&lt;/p&gt;

&lt;p&gt;Also, fyi, we generally generate patches, even for piggybank, from the top-level directory, the one that has contrib/ in it.&lt;/p&gt;

&lt;p&gt;No need to apologize for not getting the patch submission process quite right, we are not above helping with that part, and would much rather someone submit a useful patch that&apos;s not quite formatted right, than not get the contribution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="12975000" author="misterbeebee" created="Sat, 25 Dec 2010 04:34:32 +0000"  >&lt;p&gt;New patch &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1781&quot; title=&quot;Piggybank: ISOToDay disregards timezone (should use ISODateTimeFormat instead of DateTime to parse)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1781&quot;&gt;&lt;del&gt;PIG-1781&lt;/del&gt;&lt;/a&gt;.3.patch, supersedes &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1781&quot; title=&quot;Piggybank: ISOToDay disregards timezone (should use ISODateTimeFormat instead of DateTime to parse)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1781&quot;&gt;&lt;del&gt;PIG-1781&lt;/del&gt;&lt;/a&gt;.2.patch&lt;/p&gt;

&lt;p&gt;Changes between &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1781&quot; title=&quot;Piggybank: ISOToDay disregards timezone (should use ISODateTimeFormat instead of DateTime to parse)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1781&quot;&gt;&lt;del&gt;PIG-1781&lt;/del&gt;&lt;/a&gt;.2.patch and  &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1781&quot; title=&quot;Piggybank: ISOToDay disregards timezone (should use ISODateTimeFormat instead of DateTime to parse)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1781&quot;&gt;&lt;del&gt;PIG-1781&lt;/del&gt;&lt;/a&gt;.3.patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Changed ISOHelper&apos;s dateTime() to dateTimeParser(), which more closely matches the pre-patch behavior of accepting a date or time or dateTime.&lt;/li&gt;
	&lt;li&gt;Renamed parseDate() to parseDateTime(), and renamed corresponding tests.&lt;/li&gt;
	&lt;li&gt;Added a public constant ISOHelper#DEFAULT_DATE_TIME_ZONE to advertise the fact that ISOHelper has its own default time zone for parsing.&lt;/li&gt;
	&lt;li&gt;Added code to ISOHelper#parseDateTime to use UTC as default time zone for parsing ambiguous dates.&lt;/li&gt;
	&lt;li&gt;Added code to save/restore the System&apos;s default time zone. *&lt;b&gt;This is a change in behavior from the pre-patch code.&lt;/b&gt;**&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Added unit tests:
	&lt;ul&gt;
		&lt;li&gt;to illustrate various corner cases of date/time/dateTime and UTC/other-time-zone/no-time-zone parsing&lt;/li&gt;
		&lt;li&gt;to illustrate how default time zones are managed.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;ran &apos;svn diff&apos; at base of pig tree.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;ant clean test&quot; in contrib directory succeeded.&lt;/p&gt;


&lt;p&gt;I hope this version addresses everyone&apos;s concerns, but let me know if more changes are needed.&lt;/p&gt;

&lt;p&gt;Regarding the general issue of time zones. I see the options for behavior like so:&lt;br/&gt;
(A) Use the System default time zone;&lt;br/&gt;
(B) Use ISOHelper&apos;s preferred time zone (UTC) to parse ambiguous times, but don&apos;t touch System&apos;s default time zone;&lt;br/&gt;
(C) Use ISOHelper&apos;s preferred time zone (UTC) to parse ambiguous times, and mutate the System time zone to match.&lt;br/&gt;
(D) Let the Pig User set a time zone for parsing ambiguous dates, independently of the System default time zone, with a parser default to either UTC or System&apos;s default.&lt;/p&gt;

&lt;p&gt;The pre-patch 0.8.0 code behaves as option (C). This patch changes the behavior to be option (B) (with a tiny, unavoidable, race condition). (I think option (D) would be best, but that is more work that no one has requested yet.) &lt;/p&gt;

&lt;p&gt;Let me know if you disagree with my choice.&lt;/p&gt;

&lt;p&gt;(I think the best practice for Pig Users to assign timezones as early as possible in the data processing pipeline, and keep dates tagged with time zones throughout the pipeline.)&lt;/p&gt;</comment>
                            <comment id="12975076" author="misterbeebee" created="Sat, 25 Dec 2010 21:30:01 +0000"  >&lt;p&gt;This patch supersedes &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1781&quot; title=&quot;Piggybank: ISOToDay disregards timezone (should use ISODateTimeFormat instead of DateTime to parse)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1781&quot;&gt;&lt;del&gt;PIG-1781&lt;/del&gt;&lt;/a&gt;.3.patch&lt;/p&gt;

&lt;p&gt;I had an unsaved change in Eclipse, so the previous patch was missing some code.&lt;/p&gt;
</comment>
                            <comment id="12983897" author="alangates" created="Wed, 19 Jan 2011 22:00:59 +0000"  >&lt;p&gt;I ran the contrib tests (including the ones added in this patch) and they all pass.&lt;/p&gt;

&lt;p&gt;Dmitriy, Russell, any comments or concerns before I check this in?&lt;/p&gt;</comment>
                            <comment id="12983948" author="dvryaboy" created="Thu, 20 Jan 2011 00:17:38 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12984330" author="alangates" created="Thu, 20 Jan 2011 18:59:21 +0000"  >&lt;p&gt;Patch checked in.  Thank you Michael.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12466956" name="ASF.LICENSE.NOT.GRANTED--PIG-1781.3.patch" size="27690" author="misterbeebee" created="Sat, 25 Dec 2010 04:34:31 +0000"/>
                            <attachment id="12466963" name="ASF.LICENSE.NOT.GRANTED--PIG-1781.4.patch" size="27726" author="misterbeebee" created="Sat, 25 Dec 2010 21:30:01 +0000"/>
                            <attachment id="12466927" name="PIG-1781.2.patch" size="22201" author="misterbeebee" created="Fri, 24 Dec 2010 06:20:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 23 Dec 2010 23:52:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>165191</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyatp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97122</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>in UDFs in org.apache.pig.piggybank.test.evaluation.datetime.truncate, add support for non-UTC timezones in ISO 8601 datetime strings,&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>