<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:01:47 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2978/PIG-2978.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2978] TestLoadStoreFuncLifeCycle fails with hadoop-2.0.x</title>
                <link>https://issues.apache.org/jira/browse/PIG-2978</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;To reproduce, please run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant clean test -Dtestcase=TestLoadStoreFuncLifeCycle -Dhadoopversion=23
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This fails with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error during parsing. Job in state DEFINE instead of RUNNING
org.apache.pig.impl.logicalLayer.FrontendException: ERROR 1000: Error during parsing. Job in state DEFINE instead of RUNNING
    at org.apache.pig.PigServer$Graph.parseQuery(PigServer.java:1607)
    at org.apache.pig.PigServer$Graph.registerQuery(PigServer.java:1546)
    at org.apache.pig.PigServer.registerQuery(PigServer.java:516)
    at org.apache.pig.PigServer.registerQuery(PigServer.java:529)
    at org.apache.pig.TestLoadStoreFuncLifeCycle.testLoadStoreFunc(TestLoadStoreFuncLifeCycle.java:332)
Caused by: Failed to parse: Job in state DEFINE instead of RUNNING
    at org.apache.pig.parser.QueryParserDriver.parse(QueryParserDriver.java:193)
    at org.apache.pig.PigServer$Graph.parseQuery(PigServer.java:1599)
Caused by: java.lang.IllegalStateException: Job in state DEFINE instead of RUNNING
    at org.apache.hadoop.mapreduce.Job.ensureState(Job.java:292)
    at org.apache.hadoop.mapreduce.Job.toString(Job.java:456)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.java:2826)
    at org.apache.pig.TestLoadStoreFuncLifeCycle.logCaller(TestLoadStoreFuncLifeCycle.java:270)
    at org.apache.pig.TestLoadStoreFuncLifeCycle.access$000(TestLoadStoreFuncLifeCycle.java:41)
    at org.apache.pig.TestLoadStoreFuncLifeCycle$InstrumentedStorage.logCaller(TestLoadStoreFuncLifeCycle.java:54)
    at org.apache.pig.TestLoadStoreFuncLifeCycle$InstrumentedStorage.getSchema(TestLoadStoreFuncLifeCycle.java:115)
    at org.apache.pig.newplan.logical.relational.LOLoad.getSchemaFromMetaData(LOLoad.java:174)
    at org.apache.pig.newplan.logical.relational.LOLoad.&amp;lt;init&amp;gt;(LOLoad.java:88)
    at org.apache.pig.parser.LogicalPlanBuilder.buildLoadOp(LogicalPlanBuilder.java:839)
    at org.apache.pig.parser.LogicalPlanGenerator.load_clause(LogicalPlanGenerator.java:3236)
    at org.apache.pig.parser.LogicalPlanGenerator.op_clause(LogicalPlanGenerator.java:1315)
    at org.apache.pig.parser.LogicalPlanGenerator.general_statement(LogicalPlanGenerator.java:799)
    at org.apache.pig.parser.LogicalPlanGenerator.statement(LogicalPlanGenerator.java:517)
    at org.apache.pig.parser.LogicalPlanGenerator.query(LogicalPlanGenerator.java:392)
    at org.apache.pig.parser.QueryParserDriver.parse(QueryParserDriver.java:184)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12611915">PIG-2978</key>
            <summary>TestLoadStoreFuncLifeCycle fails with hadoop-2.0.x</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12611880">PIG-2972</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Oct 2012 22:31:40 +0100</created>
                <updated>Fri, 22 Feb 2013 04:54:15 +0000</updated>
                            <resolved>Wed, 28 Nov 2012 22:31:16 +0000</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13478462" author="cheolsoo" created="Wed, 17 Oct 2012 23:37:29 +0100"  >&lt;p&gt;The error is thrown because the Hadoop-2.0.x Job class overrides the toString() method, and it checks whether the JobState is running or not.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; toString() {
    ensureState(JobState.RUNNING);
    ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In hadoop-1.0.x, String.valueOf(&amp;lt;Job object&amp;gt;) is printed as something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.hadoop.mapreduce.Job@7ee49dcd
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So I replaced String.valueOf(&amp;lt;Job object&amp;gt;) with Job.class.getName().&lt;/p&gt;

&lt;p&gt;With this change, the test now runs with hadoop-2.0.x but fails because the no. of store func instances is 5, whereas it is 4 with hadoop-1.0.x. So I replaced the assertion as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Storer.count &amp;lt;= (Util.isHadoop2_0() ? 5 : 4)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It would be good if we could identify why it is different between hadoop-1.0.x and hadoop-2.0.x.&lt;/p&gt;</comment>
                            <comment id="13478709" author="cheolsoo" created="Thu, 18 Oct 2012 06:59:32 +0100"  >&lt;p&gt;Here is the difference between hadoop-1.0.x and 2.0.x:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;hadoop-1.0.x&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Storer[3].&amp;lt;init&amp;gt;()
Storer[3].setStoreFuncUDFContextSignature(A_1-1)
Storer[3].setStoreLocation(bar, org.apache.hadoop.mapreduce.Job)
Storer[3].getOutputFormat()
Storer[3].setStoreLocation(bar, org.apache.hadoop.mapreduce.Job)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;hadoop-2.0.x&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Storer[3].&amp;lt;init&amp;gt;()
Storer[3].setStoreFuncUDFContextSignature(A_1-1)
Storer[3].setStoreLocation(bar, org.apache.hadoop.mapreduce.Job)
Storer[3].getOutputFormat()
Storer[3].setStoreLocation(bar, org.apache.hadoop.mapreduce.Job)
Storer[4].&amp;lt;init&amp;gt;()
Storer[4].setStoreFuncUDFContextSignature(A_1-1)
Storer[4].setStoreLocation(bar, org.apache.hadoop.mapreduce.Job)
Storer[4].getOutputFormat()
Storer[4].setStoreLocation(bar, org.apache.hadoop.mapreduce.Job)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For whatever reason, getStoreFunc is repeated with hadoop-2.0.x. The call stack of the extra 4th instantiation is below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Storer[4].&amp;lt;init&amp;gt; called by 
org.apache.pig.impl.PigContext.instantiateFuncFromSpec(PigContext.java:577)
org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POStore.getStoreFunc(POStore.java:232)
org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputCommitter.getCommitters(PigOutputCommitter.java:85)
org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputCommitter.&amp;lt;init&amp;gt;(PigOutputCommitter.java:67)
org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigOutputFormat.getOutputCommitter(PigOutputFormat.java:279)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13500586" author="julienledem" created="Mon, 19 Nov 2012 19:59:03 +0000"  >&lt;p&gt;Thanks Cheolsoo for investigating this.&lt;br/&gt;
Yes the goal of this test is to avoid this kind of extra instance to creep in unnoticed.&lt;br/&gt;
It would be great to know why Pig gets a new POStore at that point.&lt;/p&gt;</comment>
                            <comment id="13500606" author="cheolsoo" created="Mon, 19 Nov 2012 20:14:40 +0000"  >&lt;p&gt;Thanks Julien for your comment. I will take a further look at this.&lt;/p&gt;</comment>
                            <comment id="13500762" author="rohini" created="Tue, 20 Nov 2012 01:06:36 +0000"  >&lt;p&gt;+1. &lt;a href=&quot;https://reviews.apache.org/r/8121/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/8121/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Checked that the additional call is fine. LocalJobRunner gets the outputcommitter to call setupJob (&lt;a href=&quot;https://issues.apache.org/jira/browse/MAPREDUCE-3563&quot; title=&quot;LocalJobRunner doesn&amp;#39;t handle Jobs using o.a.h.mapreduce.OutputCommitter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAPREDUCE-3563&quot;&gt;&lt;del&gt;MAPREDUCE-3563&lt;/del&gt;&lt;/a&gt;) which was not done in H20&apos;s LocalJobRunner. In a real mapreduce environment the StoreFunc would be called more than this as the commitJob would be happening in a separate task as opposed to LocalJobRunner. We should change the test to run in MiniCluster mode and count the instantiations in that case by creating side files to catch mapreduce framework changes. But still this test is useful in local mode to catch any unnecessary new instantiations in pig code itself.  &lt;/p&gt;</comment>
                            <comment id="13505978" author="cheolsoo" created="Wed, 28 Nov 2012 22:26:15 +0000"  >&lt;p&gt;Incorporated Rohini&apos;s comments in the RB.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Changed Job.class.getName() to getJobName()&lt;/li&gt;
	&lt;li&gt;Added comments regarding the difference between hadoop 1.0.x and 2.0.x in terms of the number of StoreFunc instances.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13505982" author="cheolsoo" created="Wed, 28 Nov 2012 22:31:16 +0000"  >&lt;p&gt;Committed to 0.11/trunk.&lt;/p&gt;

&lt;p&gt;Thanks Rohini for clarifying the difference in Hadoop 2.0.x.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12555253" name="PIG-2978-2.patch" size="2222" author="cheolsoo" created="Wed, 28 Nov 2012 22:26:15 +0000"/>
                            <attachment id="12549596" name="PIG-2978.patch" size="1632" author="cheolsoo" created="Wed, 17 Oct 2012 23:37:29 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 19 Nov 2012 19:59:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy3utz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56319</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>