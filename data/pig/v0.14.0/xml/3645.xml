<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:57:32 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3645/PIG-3645.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3645] Move FileLocalizer.setR() calls to unit tests</title>
                <link>https://issues.apache.org/jira/browse/PIG-3645</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Currently, temporary paths are generated by FileLocalizer using Random.nextInt(). To provide strong randomness, MapReduceLauncher resets the Random object every time when compiling physical plan to MR plan:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MRCompiler comp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MRCompiler(php, pc); 
comp.randomizeFileLocalizer(); &lt;span class=&quot;code-comment&quot;&gt;// This in turn calls FileLocalizer.setR(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random()).&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides, there are a couple of places calling FileLocalizer.setR() (e.g. MRCompiler) with some random seed.&lt;/p&gt;

&lt;p&gt;I think-&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Randomizing Random seed is unnecessary if we switch to UUID.&lt;/li&gt;
	&lt;li&gt;Setting Random objects in code like this is error-prone because it can be easily broken by having or missing a FileLocalizer.setR() somewhere else. See an example &lt;a href=&quot;http://search-hadoop.com/m/2nxTzQXfHw1&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So I propose that we remove all this &quot;randomizing Random seed&quot; code and use UUID instead in temporary paths.&lt;/p&gt;

&lt;p&gt;For unit tests that compare the results against gold files, we should still allow to set Random seed through FileLocalizer.setR(). But this method will be annotated as &quot;VisibleForTesting&quot; to ensure it is not used nowhere else other than in unit tests.&lt;/p&gt;

&lt;p&gt;Regarding the existing gold files, they can be easily regenerated by TestMRCompiler as follows-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FileOutputStream fos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(expectedFile + &lt;span class=&quot;code-quote&quot;&gt;&quot;_new&quot;&lt;/span&gt;);
PrintWriter pw = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrintWriter(fos);
pw.write(compiledPlan);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I assume there won&apos;t be any kind of regressions due to this change. But please let me know if I am wrong.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12686562">PIG-3645</key>
            <summary>Move FileLocalizer.setR() calls to unit tests</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cheolsoo">Cheolsoo Park</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Dec 2013 19:51:56 +0000</created>
                <updated>Mon, 7 Jul 2014 19:08:10 +0100</updated>
                            <resolved>Sun, 29 Dec 2013 23:00:59 +0000</resolved>
                                                    <fixVersion>0.13.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13857682" author="cheolsoo" created="Fri, 27 Dec 2013 19:55:07 +0000"  >&lt;p&gt;Attaching an initial patch that includes regenerated gold files.&lt;/p&gt;

&lt;p&gt;I will run the full suite of unit tests.&lt;/p&gt;</comment>
                            <comment id="13857691" author="rohini" created="Fri, 27 Dec 2013 20:11:16 +0000"  >&lt;p&gt;This change is not required.  Few reasons:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new Random() gives enough randomness as it takes into account System.nanoTime() and UUID is not going to add any advantage. Infact UUID uses Random internally. Differences are it uses SecureRandom (which we don&apos;t need) and does more bytes (which also we don&apos;t need as integer range itself is huge and is not going to repeat within a execution of a pig script) and uses clock sequence (System.nanoTime() in Random is good enough for us). And Random has been working fine in production for 7+ years without collision between users and I don&apos;t see any reason to change that.  If UUID were to give some advantage or fixes a real issue, I would certainly go for it.&lt;/li&gt;
	&lt;li&gt;UUID returns takes up 36 chars, while random we are only using 10 chars. Would prefer shorter filenames to take up less space in NN and prevent GCs.&lt;/li&gt;
	&lt;li&gt;Problem is not with randomness of Random but mix up in MRComplier code resetting the seed of Random to take care of tests.  What is been done in MR is that they set new Random(1331) in MRCompiler so tests get the same plan everytime. But they reset it to new Random() again when the script is actually run (in MapreduceLauncher) so that it does not write to the same file again and again. Simple change would be to move the new Random(1331) to TestMRCompiler and org.apache.pig.test.Util.buildMRPlan() as that should belong in the tests and not in the normal code path. If that is done, comp.randomizeFileLocalizer(); can be removed from MapreduceLauncher.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13857699" author="rohini" created="Fri, 27 Dec 2013 20:19:07 +0000"  >&lt;p&gt;&amp;gt; UUID returns takes up 36 chars, while random we are only using 10 chars. Would prefer shorter filenames to take up less space in NN and prevent GCs&lt;br/&gt;
  This is actually a bigger concern for me as intermediate jobs will create lot of temporary files under the temporary directory with MR when there are lot of maps/reduces. Since these will be short lived files and will be deleted soon will be a pressure on NN if they have long paths. We already have serious problems with NN performance on big clusters with heavy usage and hadoop team has been squeezing optimizations in cutting down on the number of calls MR framework makes. &lt;/p&gt;</comment>
                            <comment id="13857703" author="cheolsoo" created="Fri, 27 Dec 2013 20:23:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, thank you for the detailed explanation. My gaol is to simplify the current code rather than increase strongeness of random.&lt;/p&gt;

&lt;p&gt;Let&apos;s separate two things here-&lt;br/&gt;
1) Remove all the FileLocalizer.setR() in our code (except ones with fixed seeds in unit tests).&lt;br/&gt;
2) Replaced Random with UUID&lt;/p&gt;

&lt;p&gt;You and I agree on #1 but disagree on #2, correct? Only reason why I proposed #2 in addition to #1 because I didn&apos;t want to reduce randomness than the current form. Sounds like you&apos;re not worried about that. If that&apos;s the case, I can do #1 only.&lt;/p&gt;

&lt;p&gt;How does that sound to you?&lt;/p&gt;

</comment>
                            <comment id="13857727" author="rohini" created="Fri, 27 Dec 2013 21:00:34 +0000"  >&lt;p&gt;Sounds good. +1 on moving all FileLocalizer.setR() calls to test classes.&lt;/p&gt;</comment>
                            <comment id="13857770" author="cheolsoo" created="Fri, 27 Dec 2013 21:45:45 +0000"  >&lt;p&gt;Uploading a new patch as per discussion. The changes include-&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Annotate FileLocalizer.setR() as @VisibleForTesting.&lt;/li&gt;
	&lt;li&gt;Remove FileLocalizer.setR() calls from MRCompiler and MapReduceLauncher.&lt;/li&gt;
	&lt;li&gt;Add FileLocalizer.setR(new Random(1331L)) in TestMRCompiler.&lt;/li&gt;
	&lt;li&gt;Regenerate gold files for TestMRCompiler.&lt;/li&gt;
	&lt;li&gt;Enabled testSim4 in TestMRCompier. Looks like it was unintentionally not marked as @Test.&lt;/li&gt;
	&lt;li&gt;Remove FileLocalizer.setR(new Random()) in unit tests. Now FileLocalizer is randomized by default, so no need to do it again-
	&lt;ol&gt;
		&lt;li&gt;TestEvalPipeline.java&lt;/li&gt;
		&lt;li&gt;TestEvalPipeline2.java&lt;/li&gt;
		&lt;li&gt;TestEvalPipelineLocal.java&lt;/li&gt;
		&lt;li&gt;TestJoin.java&lt;/li&gt;
		&lt;li&gt;TestScriptUDF.java&lt;/li&gt;
		&lt;li&gt;TestSecondarySort.java&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13857779" author="cheolsoo" created="Fri, 27 Dec 2013 21:53:17 +0000"  >&lt;p&gt;Reset &quot;generate&quot; to false in TestMRCompiler in the new patch. Changes can be viewed &lt;a href=&quot;https://github.com/piaozhexiu/apache-pig/commit/f833c8f950dc158a711043721e8876d9de96fe78&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I am running full unit tests now.&lt;/p&gt;
</comment>
                            <comment id="13857790" author="rohini" created="Fri, 27 Dec 2013 22:06:01 +0000"  >&lt;p&gt;FileLocalizer.setR(new Random(1331L)); - If you do this in setup instead of setUpBeforeClass in TestMRCompiler, I think you will not need to regenerate the golden files. But if you still need to regenerate the golden files, is it possible for you to copy over what is done in TestTezCompiler setup() method. That makes each test&apos;s golden file independent of another and allows tests to be run in any order or just run individually from eclipse without having to run previous tests. Doing that in a separate jira is fine as well. Everything else looks good. Will do a +1 once you confirm full unit test suite passes.&lt;/p&gt;</comment>
                            <comment id="13857805" author="cheolsoo" created="Fri, 27 Dec 2013 22:35:03 +0000"  >&lt;p&gt;I tried PigServer.resetScope() and NodeIdGenerator.reset(&quot;&quot;), and FileLocalizer.setR(new Random(1331L)) in setup. But that doesn&apos;t seem to entirely fix it. In fact, temporary paths do not match while scope and node ids match.&lt;/p&gt;

&lt;p&gt;I am attaching the test log if you&apos;re interested.&lt;/p&gt;</comment>
                            <comment id="13857861" author="cheolsoo" created="Sat, 28 Dec 2013 00:15:58 +0000"  >&lt;p&gt;As per discussion with Rohini, moved FiliLocalizer.setR() to setup. This minimizes the number of gold files to be modified to 11. It seems inevitable to regenerate these 11 files because I am re-enabling testSim4 that used to be omitted, and that introduces some randomness.&lt;/p&gt;

&lt;p&gt;I will kick off unit tests again with this patch. Thanks!&lt;/p&gt;</comment>
                            <comment id="13858100" author="cheolsoo" created="Sat, 28 Dec 2013 19:13:10 +0000"  >&lt;p&gt;All unit tests pass except two known failures-&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;TestColumnAliasConversion &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3643&quot; title=&quot;Nested Foreach with UDF and bincond is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3643&quot;&gt;&lt;del&gt;PIG-3643&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;TestLogicalPlanGenerator &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3643&quot; title=&quot;Nested Foreach with UDF and bincond is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3643&quot;&gt;&lt;del&gt;PIG-3643&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13858410" author="rohini" created="Sun, 29 Dec 2013 19:39:07 +0000"  >&lt;p&gt;+1. Can you remove the FileLocalizer.getR() method while committing? You had done that in tez branch.&lt;/p&gt;</comment>
                            <comment id="13858468" author="cheolsoo" created="Sun, 29 Dec 2013 23:00:59 +0000"  >&lt;p&gt;Committed to trunk. I removed FiliLocalizer.getR().&lt;/p&gt;

&lt;p&gt;Thank you Rohini for all the help with this jira!&lt;/p&gt;</comment>
                            <comment id="13858477" author="cheolsoo" created="Sun, 29 Dec 2013 23:34:08 +0000"  >&lt;p&gt;I also merged trunk into tez branch, so the UUID stuff in tez branch is all overwritten now. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12620643" name="PIG-3645-1.patch" size="57930" author="cheolsoo" created="Fri, 27 Dec 2013 19:55:07 +0000"/>
                            <attachment id="12620661" name="PIG-3645-2.patch" size="54385" author="cheolsoo" created="Fri, 27 Dec 2013 21:45:45 +0000"/>
                            <attachment id="12620666" name="PIG-3645-3.patch" size="54171" author="cheolsoo" created="Fri, 27 Dec 2013 21:53:17 +0000"/>
                            <attachment id="12620682" name="PIG-3645-4.patch" size="36646" author="cheolsoo" created="Sat, 28 Dec 2013 00:15:58 +0000"/>
                            <attachment id="12620669" name="TEST-org.apache.pig.test.TestMRCompiler.txt" size="283799" author="cheolsoo" created="Fri, 27 Dec 2013 22:35:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 27 Dec 2013 20:11:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365553</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzkv1b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365861</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>