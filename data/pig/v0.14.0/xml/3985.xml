<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:09:56 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3985/PIG-3985.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3985] Multiquery execution of RANK with RANK BY causes NPE JobCreationException &quot;ERROR 2017: Internal error creating job configuration&quot;</title>
                <link>https://issues.apache.org/jira/browse/PIG-3985</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;A script with both RANK and RANK BY will crash with a Null Pointer Exception in JobControlCompiler.java when multiquery is enabled.&lt;/p&gt;

&lt;p&gt;The following script will work for any combination of the RANK BY operations; or if there is one RANK operation only (i.e. no other RANK or RANK BY operation). Non-BY-RANKS will perish together but succeed alone.&lt;/p&gt;

&lt;p&gt;Disabling multiquery execution makes everything work again.&lt;/p&gt;

&lt;p&gt;I am using Hadoop 2.4.0 with Pig Trunk (d24d06a48, after &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3739&quot; title=&quot;The Warning_4 e2e test is broken in trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3739&quot;&gt;&lt;del&gt;PIG-3739&lt;/del&gt;&lt;/a&gt;). The error occurs in local or mapreduce mode.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-- disable multiquery and you can rank all day &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;
-- SET opt.multiquery &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;

citypops = LOAD &apos;us_city_pops.tsv&apos; AS (city:chararray, state:chararray, pop_2011:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
citypops_o = ORDER citypops BY city;

--
-- &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you have one non-by RANK you may not have any other RANKs
--

citypops_nosort_inplace    = RANK citypops;
citypops_presorted_inplace = RANK citypops_o;
citypops_ties_cause_skips  = RANK citypops   BY city;
citypops_ties_no_skips     = RANK citypops   BY city  DENSE;
citypops_presorted_ranked  = RANK citypops_o BY city;

STORE citypops_nosort_inplace    INTO &apos;/tmp/citypops_nosort_inplace&apos;    USING PigStorage(&apos;\t&apos;, &apos;--overwrite &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;);
-- STORE citypops_presorted_inplace INTO &apos;/tmp/citypops_presorted_inplace&apos; USING PigStorage(&apos;\t&apos;, &apos;--overwrite &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;);

STORE citypops_ties_cause_skips  INTO &apos;/tmp/citypops_ties_cause_skips&apos;  USING PigStorage(&apos;\t&apos;, &apos;--overwrite &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;);
-- STORE citypops_ties_no_skips     INTO &apos;/tmp/citypops_ties_no_skips&apos;     USING PigStorage(&apos;\t&apos;, &apos;--overwrite &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;);
-- STORE citypops_presorted_ranked  INTO &apos;/tmp/citypops_presorted_ranked&apos;  USING PigStorage(&apos;\t&apos;, &apos;--overwrite &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Pig Stack Trace
---------------
ERROR 2017: Internal error creating job configuration.

org.apache.pig.backend.hadoop.executionengine.JobCreationException: ERROR 2017: Internal error creating job configuration.
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.getJob(JobControlCompiler.java:946)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.compile(JobControlCompiler.java:322)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher.launchPig(MapReduceLauncher.java:200)
     --- SNIP ----
Caused by: java.lang.NullPointerException
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.getJob(JobControlCompiler.java:886)
        ... 19 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The proximate offense seems to be that globalCounters.get(operationID) returns null:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(mro.isRankOperation()) {
                Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; operationIDs = mro.getRankOperationId().iterator();

                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(operationIDs.hasNext()) {
                    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; operationID = operationIDs.next();
                    Iterator&amp;lt;Pair&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt; itPairs = globalCounters.get(operationID).iterator();
                    Pair&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; pair = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(itPairs.hasNext()) {
                        pair = itPairs.next();
                        conf.setLong(pair.first, pair.second);
                    }
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;PORank.java line 184 seems to need a counter value, and so this part does need to happen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12718048">PIG-3985</key>
            <summary>Multiquery execution of RANK with RANK BY causes NPE JobCreationException &quot;ERROR 2017: Internal error creating job configuration&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="mrflip">Philip (flip) Kromer</reporter>
                        <labels>
                            <label>nullpointerexception</label>
                            <label>rank</label>
                            <label>udf</label>
                    </labels>
                <created>Tue, 3 Jun 2014 03:10:19 +0100</created>
                <updated>Fri, 21 Nov 2014 05:58:35 +0000</updated>
                            <resolved>Thu, 2 Oct 2014 18:15:21 +0100</resolved>
                                                    <fixVersion>0.14.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14016163" author="mrflip" created="Tue, 3 Jun 2014 03:51:36 +0100"  >&lt;p&gt;Added script and sample data.&lt;/p&gt;</comment>
                            <comment id="14155170" author="knoguchi" created="Wed, 1 Oct 2014 18:39:49 +0100"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.NullPointerException
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.getJob(JobControlCompiler.java:938)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;JobControlCompiler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 938                     Iterator&amp;lt;Pair&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt; itPairs = globalCounters.get(operationID).iterator();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This was due to globalCounters not containing operationID.&lt;br/&gt;
This itself was caused by saveCounters not being called due to mro.isCounterOperation incorrectly returning false.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;JobControlCompiler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 358                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!pigContext.inIllustrator &amp;amp;&amp;amp; mro.isCounterOperation())
 359                     saveCounters(job,mro.getOperationID());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was caused by  mro.isCounterOperation assuming that POCount is always placed at the leaf level.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;MapReduceOper.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
511     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isCounterOperation() {
512         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (getCounterOperation() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
513     }
...
525     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; POCounter getCounterOperation() {
526         PhysicalOperator &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;;
527         Iterator&amp;lt;PhysicalOperator&amp;gt; it =  &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.mapPlan.getLeaves().iterator();
528
529         &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(it.hasNext()) {
530             &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; = it.next();
531             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; POCounter)
532                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (POCounter) &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;;
533         }
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the sample pig test program given by Philip, mapreduce plan showed &quot;SPLIT&quot; as the only leaf.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;MapReduce node scope-34
Map Plan
Split - scope-69
|   |
|   Store(file:/tmp/temp465448860/tmp1018450824:org.apache.pig.impl.io.InterStorage) - scope-38
|   |
|   |---citypops_nosort_inplace: POCounter[tuple] - scope-14
|   |
|   citypops_ties_cause_skips: Local Rearrange[tuple]{chararray}(false) - scope-21
|   |   |
|   |   Project[chararray][0] - scope-22
|
|---citypops: New For Each(false,false,false)[bag] - scope-10
    |   |
    |   Cast[chararray] - scope-2
    |   |
    |   |---Project[bytearray][0] - scope-1
    |   |
    |   Cast[chararray] - scope-5
    |   |
    |   |---Project[bytearray][1] - scope-4
    |   |
    |   Cast[int] - scope-8
    |   |
    |   |---Project[bytearray][2] - scope-7
    |
    |---citypops: Load(file:///Users/knoguchi/git/pig/pig-3985/us_city_pops.tsv:org.apache.pig.builtin.PigStorage) - scope-0--------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I initially tried fixing MapReduceOper.getCounterOperation() so that it&apos;ll find the POCounter even if it&apos;s part of the split.  However, I soon learned that POCount requires different map-reduce class (PigMapReduceCounter.PigMapCounter.class and PigReduceCounter.class) and it currently doesn&apos;t work if they are mixed with other operations.&lt;/p&gt;

&lt;p&gt;Instead of rewriting Rank, for now made a change so that all POCount starts a new mapreduce job.&lt;/p&gt;</comment>
                            <comment id="14156670" author="rohini" created="Thu, 2 Oct 2014 16:35:47 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;Koji Noguchi&lt;/a&gt;,&lt;br/&gt;
     Creating a new job every time will impact performance. Fixed this in a different way by not merging the splits if it is a counter operation. Can you review the patch?&lt;/p&gt;</comment>
                            <comment id="14156714" author="knoguchi" created="Thu, 2 Oct 2014 17:26:10 +0100"  >&lt;blockquote&gt;&lt;p&gt;Creating a new job every time will impact performance. Fixed this in a different way by not merging the splits if it is a counter operation. Can you review the patch?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Looks good to me.  I should have spent time at MultiQueryOptimizer.java myself.  Thanks~.&lt;/p&gt;</comment>
                            <comment id="14156775" author="rohini" created="Thu, 2 Oct 2014 18:15:22 +0100"  >&lt;p&gt;Committed to branch-0.14 and trunk. Thanks Koji for the patch and the review. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12696256">PIG-3773</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12672563" name="PIG-3985-2.patch" size="8780" author="rohini" created="Thu, 2 Oct 2014 16:35:47 +0100"/>
                            <attachment id="12648058" name="many_ranks_much_sadness.pig" size="1127" author="mrflip" created="Tue, 3 Jun 2014 03:51:36 +0100"/>
                            <attachment id="12672363" name="pig-3985-v01.txt" size="2460" author="knoguchi" created="Wed, 1 Oct 2014 18:39:49 +0100"/>
                            <attachment id="12648059" name="us_city_pops.tsv" size="1541" author="mrflip" created="Tue, 3 Jun 2014 03:51:36 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 1 Oct 2014 17:39:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396250</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hzq2rr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396372</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Multiquery execution of RANK with RANK BY causes NPE</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>