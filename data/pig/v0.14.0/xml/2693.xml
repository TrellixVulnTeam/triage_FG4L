<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:49:52 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2693/PIG-2693.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2693] LoadFunc.setLocation should be called before LoadMetadata.getStatistics </title>
                <link>https://issues.apache.org/jira/browse/PIG-2693</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;We ran into a bug with Pig/HCatalog integration on the trunk. The issue is that &lt;tt&gt;JobControlCompiler&lt;/tt&gt; calls the &lt;tt&gt;adjustNumReducers&lt;/tt&gt; method just before it calls &lt;tt&gt;setLocation&lt;/tt&gt; on all of the &lt;tt&gt;LoadFuncs&lt;/tt&gt;. This causes problems, since some loaders (i.e.,  &lt;tt&gt;HCatLoader&lt;/tt&gt;) need &lt;tt&gt;setLocation&lt;/tt&gt; to be called before it can respond to &lt;tt&gt;getStatistics&lt;/tt&gt; with it&apos;s data size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12554832">PIG-2693</key>
            <summary>LoadFunc.setLocation should be called before LoadMetadata.getStatistics </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="billgraham">Bill Graham</assignee>
                                    <reporter username="billgraham">Bill Graham</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 May 2012 23:53:51 +0100</created>
                <updated>Fri, 22 Feb 2013 04:53:38 +0000</updated>
                            <resolved>Fri, 18 May 2012 22:21:09 +0100</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13272867" author="billgraham" created="Thu, 10 May 2012 23:55:06 +0100"  >&lt;p&gt;When &lt;tt&gt;HCatalog&lt;/tt&gt; blows up, the stack trace looks like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-05-05 00:43:09,684 [main] WARN  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler - Couldn&apos;t get statistics from LoadFunc: com.twitter.twadoop.dal.pig.DALPigLoader@2a2096d7
java.io.IOException: java.lang.NullPointerException
        at org.apache.hcatalog.pig.HCatLoader.getStatistics(HCatLoader.java:194)
        at com.twitter.twadoop.dal.pig.DALPigLoader.getStatistics(DALPigLoader.java:135)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.getInputSizeFromLoader(JobControlCompiler.java:866)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.getInputSize(JobControlCompiler.java:824)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.estimateNumberOfReducers(JobControlCompiler.java:805)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.adjustNumReducers(JobControlCompiler.java:745)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.getJob(JobControlCompiler.java:378)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler.compile(JobControlCompiler.java:264)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher.launchPig(MapReduceLauncher.java:149)
        at org.apache.pig.PigServer.launchPlan(PigServer.java:1265)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13272871" author="billgraham" created="Fri, 11 May 2012 00:00:48 +0100"  >&lt;p&gt;Attaching a patch that fixes the issue by calling setLocation before estimating the number of reducers. This passes unit tests and doesn&apos;t seem like it would have adverse effects, but please comment if you know a reason why it would.&lt;/p&gt;

&lt;p&gt;If this approach seems sound I can write up a unit test.&lt;/p&gt;</comment>
                            <comment id="13276206" author="traviscrawford" created="Tue, 15 May 2012 21:59:51 +0100"  >&lt;p&gt;Looking into this, I confirmed the reducer estimation worked as of &lt;a href=&quot;https://github.com/apache/pig/commit/826f4333a2546a72adebf93e5d045420d0413c69&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/pig/commit/826f4333a2546a72adebf93e5d045420d0413c69&lt;/a&gt; but throws the NPE on trunk.&lt;/p&gt;

&lt;p&gt;I&apos;m looking through the changes since to see what&apos;s changed. Since there&apos;s no contract between &lt;tt&gt;LoadFunc&lt;/tt&gt; and &lt;tt&gt;LoadMetadata&lt;/tt&gt; whatever&apos;s changed is not invalid per-se, but it may be worth restoring the old behavior.&lt;/p&gt;</comment>
                            <comment id="13276238" author="traviscrawford" created="Tue, 15 May 2012 22:31:29 +0100"  >&lt;p&gt;This patch is causing the issue: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/pig/commit/d49f903e0d041ce7d9e8e2d0a9066cd666f99da7&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/pig/commit/d49f903e0d041ce7d9e8e2d0a9066cd666f99da7&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Looking into what&apos;s changed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
commit d49f903e0d041ce7d9e8e2d0a9066cd666f99da7
Author: Dmitriy V. Ryaboy &amp;lt;dvryaboy@apache.org&amp;gt;
Date:   Fri Apr 27 23:34:03 2012 +0000

    PIG-2652:  Skew join and order by dont trigger reducer estimation (dvryaboy)
    
    git-svn-id: https:&lt;span class=&quot;code-comment&quot;&gt;//svn.apache.org/repos/asf/pig/trunk@1331637 13f79535-47bb-0310-9956-ffa450edef68&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13276251" author="billgraham" created="Tue, 15 May 2012 22:39:55 +0100"  >&lt;p&gt;Thanks Travis, that&apos;s great sleuthing work. The patch shows the issue in the &lt;tt&gt;JobControlCompiler&lt;/tt&gt;. The reducer estimation got moved up about 300 lines from around 600 to 380, which put that operation before the &lt;tt&gt;setLocation&lt;/tt&gt; calls. I think the proposed patch seems valid then, which is to move it back down a bit, below &lt;tt&gt;setLocation&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I aslo want to document this contract in &lt;tt&gt;LoadMetadata&lt;/tt&gt;, which is that &lt;tt&gt;setLocation&lt;/tt&gt; will be called first.&lt;/p&gt;</comment>
                            <comment id="13276260" author="traviscrawford" created="Tue, 15 May 2012 22:54:57 +0100"  >&lt;p&gt;Confirmed the patch above fixes this issue - thanks Bill! It didn&apos;t apply cleanly but is quite small and was easy to reproduce against trunk. After updating the patch I can test again with the final version.&lt;/p&gt;</comment>
                            <comment id="13276267" author="billgraham" created="Tue, 15 May 2012 22:58:35 +0100"  >&lt;p&gt;Here&apos;s a second patch generated against the current trunk. It also contains changes to the javadocs of LoadMetadata. Let me know if this one applies ok for you.&lt;/p&gt;</comment>
                            <comment id="13276273" author="traviscrawford" created="Tue, 15 May 2012 23:10:50 +0100"  >&lt;p&gt;+1 (nonbinding). Thanks Bill! I just tested with this patch against trunk and reducer estimation works correctly with HCatLoader.&lt;/p&gt;</comment>
                            <comment id="13277267" author="julienledem" created="Thu, 17 May 2012 00:39:39 +0100"  >&lt;p&gt;+1 this looks good to me.&lt;br/&gt;
Dmitriy said he will re run the check for the reducer estimator to make sure there&apos;s no unexpected side effect.&lt;/p&gt;</comment>
                            <comment id="13278319" author="julienledem" created="Thu, 17 May 2012 22:58:43 +0100"  >&lt;p&gt;Based on Dmitriy&apos;s patch the following tests should be run to check there is no regression:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;TestEvalPipeline2&lt;/li&gt;
	&lt;li&gt;TestJobSubmission&lt;/li&gt;
	&lt;li&gt;TestPigRunner&lt;/li&gt;
	&lt;li&gt;TestPigStats&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also the patch needs to be rebased&lt;/p&gt;</comment>
                            <comment id="13278323" author="billgraham" created="Thu, 17 May 2012 23:05:16 +0100"  >&lt;p&gt;I verified that all of test-commit passes.&lt;/p&gt;</comment>
                            <comment id="13278366" author="julienledem" created="Thu, 17 May 2012 23:48:46 +0100"  >&lt;p&gt;those tests are not part of it. That&apos;s why I&apos;m mentioning it.&lt;/p&gt;</comment>
                            <comment id="13279197" author="julienledem" created="Fri, 18 May 2012 22:18:51 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2693&quot; title=&quot;LoadFunc.setLocation should be called before LoadMetadata.getStatistics &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2693&quot;&gt;&lt;del&gt;PIG-2693&lt;/del&gt;&lt;/a&gt;.3.patch rebased patch&lt;br/&gt;
all 4 tests pass:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;TestEvalPipeline2&lt;/li&gt;
	&lt;li&gt;TestJobSubmission&lt;/li&gt;
	&lt;li&gt;TestPigRunner&lt;/li&gt;
	&lt;li&gt;TestPigStats&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12526443" name="PIG-2693.1.patch" size="1420" author="billgraham" created="Fri, 11 May 2012 00:00:48 +0100"/>
                            <attachment id="12527531" name="PIG-2693.2.patch" size="2264" author="billgraham" created="Tue, 15 May 2012 22:58:35 +0100"/>
                            <attachment id="12528160" name="PIG-2693.3.patch" size="1907" author="julienledem" created="Fri, 18 May 2012 22:18:51 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 15 May 2012 20:59:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>239085</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyayw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97964</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>