<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:57:40 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2779/PIG-2779.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2779] Refactoring the code for setting number of reducers</title>
                <link>https://issues.apache.org/jira/browse/PIG-2779</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2652&quot; title=&quot;Skew join and order by don&amp;#39;t trigger reducer estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2652&quot;&gt;&lt;del&gt;PIG-2652&lt;/del&gt;&lt;/a&gt; observed, currently the code for setting number of reducers is a little messy. MapReduceOper.requestedParallelism seems being misused in some plases, and now we support runtime estimation of #reducer which further complicates the problem.&lt;/p&gt;

&lt;p&gt;For example, if we specify parallel 1 for the order-by, the estimated #reducer will be used. If we specify parallel 2 while it estimates 4, order-by will fail due to &quot;Illegal partition for Null&quot;. If we specify parallel 4 while it estimates 2, then some reducers will have nothing to do. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12596346">PIG-2779</key>
            <summary>Refactoring the code for setting number of reducers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jay23jack">Jie Li</assignee>
                                    <reporter username="jay23jack">Jie Li</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Jun 2012 03:03:05 +0100</created>
                <updated>Fri, 22 Feb 2013 04:53:56 +0000</updated>
                            <resolved>Tue, 31 Jul 2012 18:36:26 +0100</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13404063" author="jay23jack" created="Fri, 29 Jun 2012 18:48:09 +0100"  >&lt;p&gt;For the order-by, we need to pass its &lt;b&gt;final&lt;/b&gt; #reducer (not the estimated one) to the sample job to generate the partition file, otherwise the partition file will be inconsistent and cause errors.&lt;/p&gt;

&lt;p&gt;The final #reducer is calculated based on the requested one and the estimated one, the latter of which is calculated based on the input data size. Luckily the sample job has the same input data with the order-by, thus it can calculate in advance the final #reducer of the order-by.&lt;/p&gt;</comment>
                            <comment id="13404560" author="billgraham" created="Sat, 30 Jun 2012 17:50:26 +0100"  >&lt;p&gt;Jie do you have a sample script with dummy input that illustrates this problem that you can attach?&lt;/p&gt;</comment>
                            <comment id="13404786" author="jay23jack" created="Sun, 1 Jul 2012 19:38:20 +0100"  >&lt;p&gt;Attached a unit test file. &lt;/p&gt;

&lt;p&gt;In testEstimate2Parallel1 Pig uses wrong #reducers for the order-by.&lt;/p&gt;

&lt;p&gt;In testEstimate2Default1 and testEstimate6Default2 queries fail due to inconsistent #reducers used by the sample and the order-by.&lt;/p&gt;

&lt;p&gt;In testEstimate2Parallel4, the test passes but actually two reducers have nothing to do.  &lt;/p&gt;</comment>
                            <comment id="13405150" author="jay23jack" created="Mon, 2 Jul 2012 18:31:44 +0100"  >&lt;p&gt;Update the unit test file as somehow we can&apos;t set &quot;order A by x parallel -1&quot;. (is that useful feature?)&lt;/p&gt;

&lt;p&gt;Now testEstimate2Default1 produces wrong #reducers instead of failure.&lt;/p&gt;</comment>
                            <comment id="13405233" author="jay23jack" created="Mon, 2 Jul 2012 19:47:09 +0100"  >&lt;p&gt;Maybe we can refactor like this: &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Merge default parallel&lt;/b&gt; &lt;br/&gt;
First, let&apos;s merge PigContext.default_parallel into LogicalRelationalOperator&apos;s requestedParallelism after the logical plan is built, so we don&apos;t need to worry about the default parallel later in Physical phase and MR phase.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Assignable only once&lt;/b&gt;&lt;br/&gt;
Then, let&apos;s make all requestedParallelism fields in Logical/Physical/MR operators &lt;b&gt;assignable only once&lt;/b&gt;, and add other fields if necessary (e.g. runtimeParallel introduced below), as we don&apos;t want to mess different semantics together. If we detect it&apos;s being reassigned, we can throw a runtime exception.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Synchronize sample&apos;s #partitions and order-by&apos;s #reducers&lt;/b&gt;&lt;br/&gt;
For the order-by, it&apos;s a little tricky: the sample job&apos;s requestedParallelism is set to 1 as it only needs one reducer, and it also needs the #partitions (which is the runtime #reducers of the order-by) to generate the partition file. &lt;/p&gt;

&lt;p&gt;Right now we set sample&apos;s #partitions twice (once in compilation-time and once in runtime), and we want to set only once at runtime. &lt;/p&gt;

&lt;p&gt;In order to prevent the sample job using a different #partition than the order-by&apos;s runtime #reducer, we can introduce another field &lt;b&gt;runtimeParallel&lt;/b&gt;. The sample job will estimate and calculate #partitions and set it to the order-by&apos;s runtimeParallel, which won&apos;t be re-calculated later. &lt;/p&gt;

&lt;p&gt;Any comment is appreciated.&lt;/p&gt;</comment>
                            <comment id="13405475" author="jay23jack" created="Tue, 3 Jul 2012 01:42:58 +0100"  >&lt;p&gt;This would be better solved with &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2784&quot; title=&quot;Framework for dynamic query optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2784&quot;&gt;PIG-2784&lt;/a&gt;, but maybe we also want a quick fix just in case?&lt;/p&gt;</comment>
                            <comment id="13406015" author="jay23jack" created="Tue, 3 Jul 2012 21:35:23 +0100"  >&lt;p&gt;Attached a patch that fixed the failed cases. The idea is that the sample job shouldn&apos;t determine the order-by&apos;s parallelism at compile-time, because we&apos;ll estimate and adjust it at run-time. &lt;/p&gt;

&lt;p&gt;A more elegant refactoring may be possible after &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2784&quot; title=&quot;Framework for dynamic query optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2784&quot;&gt;PIG-2784&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Note this patch is necessary for us to remove the sample job at runtime.&lt;/p&gt;</comment>
                            <comment id="13409200" author="billgraham" created="Mon, 9 Jul 2012 06:52:29 +0100"  >&lt;p&gt;+1 for the suggested refactor, as it would be good to clear up distinctions between default parallel, requested parallelism and runtime parallelism.&lt;/p&gt;

&lt;p&gt;Regarding the patch, you&apos;re changing logic that was added in the particularly nasty &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2652&quot; title=&quot;Skew join and order by don&amp;#39;t trigger reducer estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2652&quot;&gt;&lt;del&gt;PIG-2652&lt;/del&gt;&lt;/a&gt;. Do all the tests in the comments and final patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2652&quot; title=&quot;Skew join and order by don&amp;#39;t trigger reducer estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2652&quot;&gt;&lt;del&gt;PIG-2652&lt;/del&gt;&lt;/a&gt; pass? &lt;/p&gt;</comment>
                            <comment id="13409653" author="jay23jack" created="Mon, 9 Jul 2012 18:16:48 +0100"  >&lt;p&gt;Thanks Bill! Yeah this patch would break some tests and I&apos;m fixing them now&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13415503" author="jay23jack" created="Mon, 16 Jul 2012 19:41:14 +0100"  >&lt;p&gt;Currently Pig doesn&apos;t look at mapred.reduce.tasks when deciding #reducer. Shall we look at it after request_parallel and default_parallel, and before estimating parallel? It&apos;ll look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mro.requestedParallelism &amp;gt; 0) {
            jobParallelism = mro.requestedParallelism;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pigContext.defaultParallel &amp;gt; 0) {
            jobParallelism = pigContext.defaultParallel;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conf.getInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.reduce.tasks&quot;&lt;/span&gt;, -1) &amp;gt; 0) {
            jobParallelism = conf.getInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.reduce.tasks&quot;&lt;/span&gt;, -1);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            jobParallelism = estimatedParallelism;
        }  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;     </comment>
                            <comment id="13415740" author="jay23jack" created="Mon, 16 Jul 2012 23:41:00 +0100"  >&lt;p&gt;The latest &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2779&quot; title=&quot;Refactoring the code for setting number of reducers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2779&quot;&gt;&lt;del&gt;PIG-2779&lt;/del&gt;&lt;/a&gt;.1.patch introduces the notion of runtimeParallelism, which is set to the first positive number of parallel, default_parallel and estimated parallel.&lt;/p&gt;

&lt;p&gt;For sampler jobs, we used to set #partitions at compile-time and reset it at runtime; this patch will remove the compile-time setting and only keep the runtime setting. &lt;/p&gt;

&lt;p&gt;For the runtime setting of #partitions, we used to estimate based on the sampler&apos;s input; this patch will instead estimate based on the next job&apos;s input, as for skew-join they are different. &lt;/p&gt;

&lt;p&gt;For sampler&apos;s next job, e.g. order-by and skew join, we used to calculate their #reducers independently from the sampler; this patch will instead calculate them together with the sampler, so we can keep sampler&apos;s #partitions and the next job&apos;s #reducers synchronized.&lt;/p&gt;</comment>
                            <comment id="13415911" author="billgraham" created="Tue, 17 Jul 2012 06:34:22 +0100"  >&lt;p&gt;Jie, these changes make sense to me, assuming tests pass. Just a few questions and minor nits:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;MRCompiler&lt;/tt&gt;&lt;br/&gt;
1. You removed some logic which seems to now be in JCC. What about the removed call to &lt;tt&gt;eng.getJobConf().getNumReduceTasks()&lt;/tt&gt;? Is that still being picked up elsewhere? It appears like that check was dropped.&lt;br/&gt;
2. &lt;tt&gt;HExecutionEngine&lt;/tt&gt; inport no longer needed.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;JobControlCompiler&lt;/tt&gt;&lt;br/&gt;
3. Should &lt;tt&gt;ParallelConstantVisitor&lt;/tt&gt; be called with &lt;tt&gt;mro.reducePlan&lt;/tt&gt; or &lt;tt&gt;nextMro.reducePlan&lt;/tt&gt;?&lt;br/&gt;
4. &lt;tt&gt;calculateRuntimeReducers&lt;/tt&gt; doesn&apos;t need &lt;tt&gt;MROperPlan plan&lt;/tt&gt; in it&apos;s signature.&lt;br/&gt;
5. Line 804, if statements should have curly braces.&lt;br/&gt;
6. Line 819, should have space between &lt;tt&gt;else&lt;/tt&gt; and trailing curly bracket.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;test/smoke-tests&lt;/tt&gt;&lt;br/&gt;
7. Did you mean to include this in the patch?&lt;/p&gt;</comment>
                            <comment id="13415934" author="jay23jack" created="Tue, 17 Jul 2012 07:31:14 +0100"  >&lt;p&gt;Thanks Bill for the review! Attached &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2779&quot; title=&quot;Refactoring the code for setting number of reducers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2779&quot;&gt;&lt;del&gt;PIG-2779&lt;/del&gt;&lt;/a&gt;.2.patch with fixes.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;MRCompiler&lt;br/&gt;
1. You removed some logic which seems to now be in JCC. What about the removed call to eng.getJobConf().getNumReduceTasks()? Is that still being picked up elsewhere?&lt;/p&gt;

&lt;p&gt;It appears like that check was dropped.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah I purposely leave out the parameter &quot;mapred.reduce.tasks&quot;, as the runtime adjustment used to ignore it. &lt;/p&gt;

&lt;p&gt;I thought about including it as an option for setting #reducers, but the problem is its default value is 1 instead of -1, so we can&apos;t distinguish whether users set it to 1 or not. (this was one of bugs before). Hive supports this parameter by making it default to -1 and let users override it. We can also add this support if we want.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;2. HExecutionEngine inport no longer needed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nice catch. Removed.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;JobControlCompiler&lt;br/&gt;
3. Should ParallelConstantVisitor be called with mro.reducePlan or nextMro.reducePlan?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Should be mro, the sample job.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;4. calculateRuntimeReducers doesn&apos;t need MROperPlan plan in it&apos;s signature.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure. Removed.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;5. Line 804, if statements should have curly braces.&lt;br/&gt;
6. Line 819, should have space between else and trailing curly bracket.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nice catch. Btw do you use any syntax checking tool?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;test/smoke-tests&lt;br/&gt;
7. Did you mean to include this in the patch?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry for that. Removed.&lt;/p&gt;</comment>
                            <comment id="13422001" author="billgraham" created="Wed, 25 Jul 2012 05:55:15 +0100"  >&lt;p&gt;Jie, as part of this clean up it would be really useful to record the various parallelism values in the job conf for later analysis. I was thinking we capture defaultParallel, requestedParallelism and runtimeParallelism (which should == &lt;tt&gt;mapred.reduce.tasks&lt;/tt&gt;, right). That way we can see later which values were set and which was used. It would be great to know whether parallelism was determined by a &lt;tt&gt;PARALLEL&lt;/tt&gt; statement, via estimation, or via a default. This would be in addition to the following related params we currently capture:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;pig.exec.reducers.max
pig.exec.reducers.bytes.per.reducer
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you want to add this to this issue or do you think we should we do this in a separate JIRA? &lt;/p&gt;

&lt;p&gt;I use IntelliJ and I&apos;ve just set the syntax to match Apaches.&lt;/p&gt;</comment>
                            <comment id="13422459" author="jay23jack" created="Wed, 25 Jul 2012 18:56:54 +0100"  >&lt;p&gt;Great point Bill! Yeah I&apos;ll set defaultParallel and requestedParallelism into the jobconf in this patch. What could be good names for them?&lt;/p&gt;</comment>
                            <comment id="13422680" author="billgraham" created="Wed, 25 Jul 2012 23:20:01 +0100"  >&lt;p&gt;Great! We should probably set &lt;tt&gt;estimatedParallelism&lt;/tt&gt; too, in case that&apos;s what was used. If default parallel is used, it seems like that should show up already as &lt;tt&gt;default_parallel&lt;/tt&gt; actually, so we can omit that one. How about this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;pig.info.reducers.requested.parallel
pig.info.reducers.estimated.parallel
pig.info.reducers.runtime.parallel
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m prefixing with &apos;info&apos; to denote that these fields are not accepted as input. Instead they are produced as output for debugging and analysis. I&apos;ll send an email to pig-dev about the suggested syntax.&lt;/p&gt;
</comment>
                            <comment id="13422762" author="jay23jack" created="Thu, 26 Jul 2012 01:21:28 +0100"  >&lt;p&gt;estimatedParallelism is a good one to add and these names look good to me. Has default parallel already shown up in the job conf? For pig.info.reducers.runtime.parallel, it should be same as mapred.reduce.tasks, so do we still need it? &lt;/p&gt;</comment>
                            <comment id="13422915" author="billgraham" created="Thu, 26 Jul 2012 07:12:03 +0100"  >&lt;p&gt;I just checked and &lt;tt&gt;default_parallel&lt;/tt&gt; doesn&apos;t show up in the jobconf when set so we should add it in the same format:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;pig.info.reducers.default.parallel
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since &lt;tt&gt;pig.info.reducers.runtime.parallel&lt;/tt&gt; is what becomes &lt;tt&gt;mapred.reduce.tasks&lt;/tt&gt;, no we don&apos;t need that one.&lt;/p&gt;</comment>
                            <comment id="13423340" author="jay23jack" created="Thu, 26 Jul 2012 19:38:41 +0100"  >&lt;p&gt;Attached &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2779&quot; title=&quot;Refactoring the code for setting number of reducers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2779&quot;&gt;&lt;del&gt;PIG-2779&lt;/del&gt;&lt;/a&gt;.3.patch for setting various parallelism into job conf for later ananlysis, as suggested by Bill. Also add unit tests for testing them.&lt;/p&gt;</comment>
                            <comment id="13424070" author="billgraham" created="Fri, 27 Jul 2012 20:03:43 +0100"  >&lt;p&gt;Thanks Jie, I&apos;ve been running the test suite on our CI server and so far things look good. We&apos;re close. A few more comments though:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In &lt;tt&gt;JobControlCompiler&lt;/tt&gt; we should only call &lt;tt&gt;estimateNumberOfReducers&lt;/tt&gt; if we need to, since we don&apos;t need it if &lt;tt&gt;requestedParallelism&lt;/tt&gt; or &lt;tt&gt;defaultParallel&lt;/tt&gt; will govern and the call could be expensive. So we&apos;d have this:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;} else {
  mro.estimatedParallelism = estimateNumberOfReducers(conf, lds, nwJob);
  jobParallelism = mro.estimatedParallelism;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The semantics of &lt;tt&gt;pig.info.reducers.requested.parallel&lt;/tt&gt; is a bit misleading as implemented. I would expect that would be the value set via the &lt;tt&gt;PARALLEL&lt;/tt&gt; statement, but that&apos;s not the case, since &lt;tt&gt;requestedParallel&lt;/tt&gt; gets set to &lt;tt&gt;jobParallelism&lt;/tt&gt; on line 796 of JCC. Would you please add to the tests in &lt;tt&gt;TestJobSubmission&lt;/tt&gt; that each of the &lt;tt&gt;pig.info.reducers.*&lt;/tt&gt; fields are set as expected (or not set) after each of the scenarios. I suspect there are cases where &lt;tt&gt;pig.info.reducers.requested.parallel&lt;/tt&gt; is being set when &lt;tt&gt;PARALLEL&lt;/tt&gt; isn&apos;t used.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13424105" author="jay23jack" created="Fri, 27 Jul 2012 21:00:43 +0100"  >&lt;p&gt;Hi Bill, regarding the first comment, I agree we can avoid estimating and should be adjusted before. But now would you need it for later analysis in any way? (e.g. comparing estimated #reducer and PALALLEL keyword). If not I&apos;ll fix it then.&lt;/p&gt;

&lt;p&gt;Regarding the second comment, yes requestedParallel has been used for multiple purposes for a long time and adjusted across logical/physical/mr phases, and also set as the final number of reducers. Many unit tests also assume it as the final number of reducers. I&apos;m afraid cleaning it up can be another ticket? Or maybe an easier approach is to add another field just recording the PARALLEL keyword?&lt;/p&gt;</comment>
                            <comment id="13424117" author="billgraham" created="Fri, 27 Jul 2012 21:23:50 +0100"  >&lt;p&gt;Re #1, for later analysis it would be useful to know the estimated parallelism only if estimation was in-fact kicked in because it was needed. If it didn&apos;t kick in, that&apos;s also useful to know. Hence I think we should move that call into the &lt;tt&gt;else&lt;/tt&gt; block.&lt;/p&gt;

&lt;p&gt;Agreed that &lt;tt&gt;requestedParallel&lt;/tt&gt; is used all over and we shouldn&apos;t mess with that now. Let&apos;s instead set another field when &lt;tt&gt;PARALLEL&lt;/tt&gt; is passed. &lt;tt&gt;pig.info.reducers.keyword.parallel&lt;/tt&gt;? That said, do you still see value in setting &lt;tt&gt;pig.info.reducers.requested.parallel&lt;/tt&gt;, since it could be used for so many different things?&lt;/p&gt;</comment>
                            <comment id="13424224" author="jay23jack" created="Sat, 28 Jul 2012 01:00:58 +0100"  >&lt;p&gt;Agreed with #1. &lt;/p&gt;

&lt;p&gt;Re #2, according to &lt;a href=&quot;http://pig.apache.org/docs/r0.10.0/perf.html#parallel&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://pig.apache.org/docs/r0.10.0/perf.html#parallel&lt;/a&gt;, these operators support PARALLEL:&lt;/p&gt;

&lt;p&gt;COGROUP, CROSS, DISTINCT, GROUP, JOIN (inner), JOIN (outer), and ORDER BY.&lt;/p&gt;

&lt;p&gt;We need to make sure the PARALLEL associate with these operators remains same across logic/phycical/mr phases. Seems it suffers from the same complexity faced by requestedParallel, such as query transformation, multi-query optimization, etc. Seems it&apos;s not trivial?&lt;/p&gt;</comment>
                            <comment id="13424269" author="jay23jack" created="Sat, 28 Jul 2012 06:22:48 +0100"  >&lt;p&gt;Attached &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2779&quot; title=&quot;Refactoring the code for setting number of reducers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2779&quot;&gt;&lt;del&gt;PIG-2779&lt;/del&gt;&lt;/a&gt;.4.patch that incorporates #1 discussed above.&lt;/p&gt;

&lt;p&gt;For #2, we probably can do it later with the cleaning up of requestedParallel?&lt;/p&gt;</comment>
                            <comment id="13424625" author="billgraham" created="Sun, 29 Jul 2012 21:32:00 +0100"  >&lt;p&gt;I&apos;m going to take a look to see what it would take to implement &lt;tt&gt;pig.info.reducers.keyword.parallel&lt;/tt&gt; without refactoring &lt;tt&gt;requestedParallel&lt;/tt&gt;, since I&apos;m not sure we want to take that on.&lt;/p&gt;</comment>
                            <comment id="13425187" author="jay23jack" created="Mon, 30 Jul 2012 21:18:26 +0100"  >&lt;p&gt;The bugs addressed by this patch would block &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2772&quot; title=&quot;Convert the skew join to the normal join for small dataset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2772&quot;&gt;PIG-2772&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-483&quot; title=&quot;PERFORMANCE: different strategies for large and small order bys&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-483&quot;&gt;PIG-483&lt;/a&gt;, where we need the right number of reducers to remove small jobs at runtime. So I guess we can probably move new features into separate tickets?&lt;/p&gt;</comment>
                            <comment id="13425419" author="billgraham" created="Tue, 31 Jul 2012 01:24:58 +0100"  >&lt;p&gt;Agreed, let&apos;s hold off on feature creep. I&apos;ve made a few edits and updated the patch. A few things to note:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I added more assertions for all parallel values after each test in &lt;tt&gt;TestNumberOfReducers&lt;/tt&gt; and &lt;tt&gt;TestJobSubmission&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;I changed the contract of &lt;tt&gt;PigReducerEstimator&lt;/tt&gt; to return -1 if estimation can&apos;t be done (i.e. HBaseStorage), since returning 1 was misleading.&lt;/li&gt;
	&lt;li&gt;I refactored some common code in &lt;tt&gt;TestNumberOfReducers&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Take a look and let me know what you think Jie. I&apos;ll run the test suite with our CI server tonight.&lt;/p&gt;</comment>
                            <comment id="13425436" author="jay23jack" created="Tue, 31 Jul 2012 01:54:12 +0100"  >&lt;p&gt;Thanks Bill! These changes sound perfect to me. Let&apos;s see if any tests need to be fixed.&lt;/p&gt;</comment>
                            <comment id="13425948" author="billgraham" created="Tue, 31 Jul 2012 18:35:51 +0100"  >&lt;p&gt;There are a few tests that failed, but when run individually, they all pass so I think it&apos;s just flakeyness in the full CI test target. Attaching patch #6 that contains the ASF 2.0 license headers in &lt;tt&gt;TestNumberOfReducers.java&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="13425950" author="billgraham" created="Tue, 31 Jul 2012 18:36:26 +0100"  >&lt;p&gt;Committed, thanks Jie for seeing this one through!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12596185">PIG-2772</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12406112">PIG-483</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12550904">PIG-2652</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12596742">PIG-2784</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12534972" name="PIG-2779.0.patch" size="9305" author="jay23jack" created="Tue, 3 Jul 2012 21:35:23 +0100"/>
                            <attachment id="12536740" name="PIG-2779.1.patch" size="18473" author="jay23jack" created="Mon, 16 Jul 2012 23:41:00 +0100"/>
                            <attachment id="12536780" name="PIG-2779.2.patch" size="18603" author="jay23jack" created="Tue, 17 Jul 2012 07:31:14 +0100"/>
                            <attachment id="12538041" name="PIG-2779.3.patch" size="20600" author="jay23jack" created="Thu, 26 Jul 2012 19:38:41 +0100"/>
                            <attachment id="12538230" name="PIG-2779.4.patch" size="20614" author="jay23jack" created="Sat, 28 Jul 2012 06:22:48 +0100"/>
                            <attachment id="12538462" name="PIG-2779.5.patch" size="31809" author="billgraham" created="Tue, 31 Jul 2012 01:24:58 +0100"/>
                            <attachment id="12538578" name="PIG-2779.6.patch" size="31521" author="billgraham" created="Tue, 31 Jul 2012 18:35:51 +0100"/>
                            <attachment id="12534295" name="TestNumberOfReducers.java" size="4015" author="jay23jack" created="Mon, 2 Jul 2012 18:31:44 +0100"/>
                            <attachment id="12534168" name="TestNumberOfReducers.java" size="3968" author="jay23jack" created="Sun, 1 Jul 2012 19:38:20 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 30 Jun 2012 16:50:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256410</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyaztj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98114</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>