<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:49:41 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2968/PIG-2968.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2968] ColumnMapKeyPrune fails to prune a subtree inside foreach</title>
                <link>https://issues.apache.org/jira/browse/PIG-2968</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Sample code &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ cat test/foreach.pig 
daily = load &apos;nyse&apos; as (exchange, symbol);
grpd = group daily by exchange;
uniquecnt = foreach grpd {
        sym = daily.symbol;
        uniq_sym = distinct sym;
        generate group, uniq_sym;
};
another = FOREACH uniquecnt GENERATE group;
explain another;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This breaks when it tries to prune uniq_sym-&amp;gt;sym-&amp;gt;innerload_daily&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2012-10-12 14:54:11,031 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; ERROR org.apache.pig.tools.grunt.Grunt - ERROR 2000: Error processing rule ColumnMapKeyPrune. Try -t ColumnMapKeyPrune&lt;/p&gt;&lt;/blockquote&gt;
</description>
                <environment></environment>
        <key id="12611617">PIG-2968</key>
            <summary>ColumnMapKeyPrune fails to prune a subtree inside foreach</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Oct 2012 20:01:34 +0100</created>
                <updated>Fri, 22 Feb 2013 04:53:49 +0000</updated>
                            <resolved>Tue, 30 Oct 2012 17:56:57 +0000</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13475247" author="knoguchi" created="Fri, 12 Oct 2012 20:02:29 +0100"  >&lt;p&gt;Log showing&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ cat /Users/knoguchi/git/pig/pig_1350068049281.logPig Stack Trace
---------------
ERROR 2000: Error processing rule ColumnMapKeyPrune. Try -t ColumnMapKeyPrune

org.apache.pig.impl.logicalLayer.FrontendException: ERROR 1067: Unable to explain alias another        at org.apache.pig.PigServer.explain(PigServer.java:999)
        at org.apache.pig.tools.grunt.GruntParser.explainCurrentBatch(GruntParser.java:398)
        at org.apache.pig.tools.grunt.GruntParser.processExplain(GruntParser.java:330)
        at org.apache.pig.tools.grunt.GruntParser.processExplain(GruntParser.java:293)
        at org.apache.pig.tools.pigscript.parser.PigScriptParser.Explain(PigScriptParser.java:715)        at org.apache.pig.tools.pigscript.parser.PigScriptParser.parse(PigScriptParser.java:342)
        at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:193)        at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:169)
        at org.apache.pig.tools.grunt.Grunt.exec(Grunt.java:84)        at org.apache.pig.Main.run(Main.java:604)
        at org.apache.pig.Main.main(Main.java:154)
Caused by: org.apache.pig.impl.logicalLayer.FrontendException: ERROR 2000: Error processing rule ColumnMapKeyPrune. Try -t ColumnMapKeyPrune        at org.apache.pig.newplan.optimizer.PlanOptimizer.optimize(PlanOptimizer.java:122)
        at org.apache.pig.backend.hadoop.executionengine.HExecutionEngine.compile(HExecutionEngine.java:277)
        at org.apache.pig.PigServer.compilePp(PigServer.java:1322)        at org.apache.pig.PigServer.explain(PigServer.java:984)
        ... 10 more
Caused by: java.util.ConcurrentModificationException
        at java.util.AbstractList$Itr.checkForComodification(AbstractList.java:372)
        at java.util.AbstractList$Itr.next(AbstractList.java:343)
        at org.apache.pig.newplan.logical.rules.ColumnPruneVisitor.removeSubTree(ColumnPruneVisitor.java:451)
        at org.apache.pig.newplan.logical.rules.ColumnPruneVisitor.removeSubTree(ColumnPruneVisitor.java:452)
        at org.apache.pig.newplan.logical.rules.ColumnPruneVisitor.visit(ColumnPruneVisitor.java:431)
        at org.apache.pig.newplan.logical.relational.LOForEach.accept(LOForEach.java:76)
        at org.apache.pig.newplan.ReverseDependencyOrderWalker.walk(ReverseDependencyOrderWalker.java:70)
        at org.apache.pig.newplan.PlanVisitor.visit(PlanVisitor.java:52)
        at org.apache.pig.newplan.logical.rules.ColumnMapKeyPrune$ColumnMapKeyPruneTransformer.transform(ColumnMapKeyPrune.java:141)
        at org.apache.pig.newplan.optimizer.PlanOptimizer.optimize(PlanOptimizer.java:110)
        ... 13 more
================================================================================
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13475305" author="knoguchi" created="Fri, 12 Oct 2012 21:04:13 +0100"  >&lt;p&gt;ConcurrentModificationException is happening in ColumnPruneVisitor.removeSubTree&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;List&amp;lt;Operator&amp;gt; ll = p.getPredecessors(op);
if (ll != null) { 
    for(Operator pred: ll) { 
        removeSubTree((LogicalRelationalOperator)pred);
    } 
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;where List ll is updated within (recursive-)removeSubTree&lt;br/&gt;
while being traversed.&lt;/p&gt;

&lt;p&gt;Attaching a patch that creates a shallow copy of the list.&lt;/p&gt;

&lt;p&gt;For the test, attaching one that will fail with Exception.  But I couldn&apos;t come up with &lt;em&gt;expected&lt;/em&gt; raw query that matches the pruned result.&lt;/p&gt;</comment>
                            <comment id="13475950" author="rohini" created="Mon, 15 Oct 2012 04:55:17 +0100"  >&lt;p&gt;ll.toArray(new Operator&lt;span class=&quot;error&quot;&gt;&amp;#91;ll.size()&amp;#93;&lt;/span&gt;) can be done instead of ll.toArray(new Operator&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;) for little more efficiency. Looks good otherwise. &lt;/p&gt;</comment>
                            <comment id="13476122" author="knoguchi" created="Mon, 15 Oct 2012 14:01:07 +0100"  >&lt;blockquote&gt;&lt;p&gt;ll.toArray(new Operator&lt;span class=&quot;error&quot;&gt;&amp;#91;ll.size()&amp;#93;&lt;/span&gt;) can be done instead of ll.toArray(new Operator&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;) &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Uploading with the above change.&lt;/p&gt;</comment>
                            <comment id="13486001" author="knoguchi" created="Mon, 29 Oct 2012 13:09:54 +0000"  >&lt;p&gt;I&apos;d like to see this fixed in 0.11.&lt;/p&gt;</comment>
                            <comment id="13486329" author="cheolsoo" created="Mon, 29 Oct 2012 20:45:40 +0000"  >&lt;p&gt;+1.&lt;/p&gt;

&lt;p&gt;I will commit it after running tests. Thanks Koji!&lt;/p&gt;</comment>
                            <comment id="13486342" author="cheolsoo" created="Mon, 29 Oct 2012 20:53:44 +0000"  >&lt;p&gt;Actually, can you please fix the indentation of testPruneSubTreeForEach() using 4 spaces? We&apos;re trying to clean up white spaces in code base.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13486344" author="rohini" created="Mon, 29 Oct 2012 20:55:25 +0000"  >&lt;p&gt;Koji/Cheolsoo,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;But I couldn&apos;t come up with expected raw query that matches the pruned result.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;   I missed commenting on this in the initial review. Should we take a crack at this before committing this. Or at least some Assert? &lt;/p&gt;</comment>
                            <comment id="13486365" author="cheolsoo" created="Mon, 29 Oct 2012 21:10:54 +0000"  >&lt;p&gt;Hi Rohini, sure I can wait until your concern is addressed.&lt;/p&gt;

&lt;p&gt;If Koji can improve the test case, that will be of course great. But since I don&apos;t have a better suggestion, I won&apos;t insist.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13486498" author="knoguchi" created="Mon, 29 Oct 2012 23:33:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Actually, can you please fix the indentation of testPruneSubTreeForEach() using 4 spaces?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Changed. (Sorry, I recently learned it&apos;s 4 spaces instead of 2.)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Or at least some Assert? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added a catch and fail call.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Should we take a crack at this before committing this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I tried simply taking out the lines but nested foreach with pruned inputs were different from a simple foreach with just one output. (one extra foreach on former)&lt;/p&gt;</comment>
                            <comment id="13486932" author="rohini" created="Tue, 30 Oct 2012 15:14:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;I tried simply taking out the lines but nested foreach with pruned inputs were different from a simple foreach with just one output. (one extra foreach on former)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  Got it Koji. ColumnPruneVisitor.addForEachIfNecessary adds an additional foreach to prune columns for optimization even though the next statement from user does exactly the same. Don&apos;t think it is possible to have a equivalent query as the attached LOForEach is without an alias. I am good Cheolsoo. You can go ahead with the commit.&lt;/p&gt;</comment>
                            <comment id="13487068" author="cheolsoo" created="Tue, 30 Oct 2012 17:56:57 +0000"  >&lt;p&gt;Committed to 0.11/trunk. Thanks Koji!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548949" name="pig-2968-trunk_v01.txt" size="1865" author="knoguchi" created="Fri, 12 Oct 2012 21:04:13 +0100"/>
                            <attachment id="12549143" name="pig-2968-trunk_v02.txt" size="1873" author="knoguchi" created="Mon, 15 Oct 2012 14:01:07 +0100"/>
                            <attachment id="12551279" name="pig-2968-trunk_v03.txt" size="2055" author="knoguchi" created="Mon, 29 Oct 2012 23:33:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 15 Oct 2012 03:55:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248100</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hy3fzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>53907</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>