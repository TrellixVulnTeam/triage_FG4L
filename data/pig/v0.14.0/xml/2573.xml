<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:01:01 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-2573/PIG-2573.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-2573] Automagically setting parallelism based on input file size does not work with HCatalog</title>
                <link>https://issues.apache.org/jira/browse/PIG-2573</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2334&quot; title=&quot;Set default number of reducers for S3N filesystem&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2334&quot;&gt;&lt;del&gt;PIG-2334&lt;/del&gt;&lt;/a&gt; was helpful in understanding this issue. Short version is input file size is only computed if the path begins with a whitelisted prefix, currently:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;/&lt;/li&gt;
	&lt;li&gt;hdfs:&lt;/li&gt;
	&lt;li&gt;file:&lt;/li&gt;
	&lt;li&gt;s3n:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As HCatalog locations use the form &lt;tt&gt;dbname.tablename&lt;/tt&gt; the input file size is not computed, and the size-based parallelism optimization breaks.&lt;/p&gt;

&lt;p&gt;DETAILS:&lt;/p&gt;

&lt;p&gt;I discovered this issue comparing two runs on the same script, one loading regular HDFS paths, and one with HCatalog db.table names. I just happened to notice the &quot;Setting number of reducers&quot; line difference.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Loading HDFS files reducers is set to 99&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-03-08 01:33:56,522 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler - BytesPerReducer=1000000000 maxReducers=999 totalInputFileSize=98406674162
2012-03-08 01:33:56,522 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler - Neither PARALLEL nor &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; parallelism is set &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; job. Setting number of reducers to 99
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Loading with an HCatalog db.table name&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-03-08 01:06:02,283 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler - BytesPerReducer=1000000000 maxReducers=999 totalInputFileSize=0
2012-03-08 01:06:02,283 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.JobControlCompiler - Neither PARALLEL nor &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; parallelism is set &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; job. Setting number of reducers to 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Possible fix: Pig should just ask the loader for the size of its inputs rather than special-casing certain location types.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12545590">PIG-2573</key>
            <summary>Automagically setting parallelism based on input file size does not work with HCatalog</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="traviscrawford">Travis Crawford</assignee>
                                    <reporter username="traviscrawford">Travis Crawford</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Mar 2012 01:54:04 +0000</created>
                <updated>Fri, 22 Feb 2013 04:53:28 +0000</updated>
                            <resolved>Fri, 16 Mar 2012 22:11:01 +0000</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13224966" author="daijy" created="Thu, 8 Mar 2012 03:16:59 +0000"  >&lt;p&gt;Yes, we should put the logic into LoadFunc. There will also be a patch for HCatLoader in HCat side. Anyone is working on a patch?&lt;/p&gt;</comment>
                            <comment id="13224970" author="traviscrawford" created="Thu, 8 Mar 2012 03:26:51 +0000"  >&lt;p&gt;Yup, I&apos;m looking into this. After pig supports it I can also do the HCatLoader work, since it&apos;s what I&apos;m primarily interested in.&lt;/p&gt;</comment>
                            <comment id="13225508" author="traviscrawford" created="Thu, 8 Mar 2012 21:07:16 +0000"  >&lt;p&gt;The attached patch shows what moving the &quot;get size of input&quot; logic into &lt;tt&gt;LoadFunc&lt;/tt&gt; looks like.&lt;/p&gt;

&lt;p&gt;I have some concerns about how invasive this approach is. Specifically it requires loaders to implement a new &lt;tt&gt;getLocation&lt;/tt&gt; method for the optimization to work. While I can update the loaders shipped by pig, this breaks the optimization for all other loaders out there. Option: fall back to the current behavior if the loader returns null for getLocation (meaning its likely using the default implementation).&lt;/p&gt;

&lt;p&gt;If we like this general approach I can polish &amp;amp; update all the included loaders. If we don&apos;t like this approach - any suggestions?&lt;/p&gt;</comment>
                            <comment id="13225676" author="billgraham" created="Thu, 8 Mar 2012 23:32:47 +0000"  >&lt;p&gt;Another approach that would be backward compatible would be to introduce an new interface that a LoadFunc can implement to advertise that it supports load statistics, like input size. Something similar to how StoreFuncs include a number of optional interfaces.&lt;/p&gt;

&lt;p&gt;Also, should we think more broadly being able to return other info besides just total input bytes? Like we could instead return a new LoadStats object (or the InputStats class) that could encapsulate more than just the input size. Things like input size, records read, etc? It would be a move towards pushing stats collection into the loaders and store funcs.&lt;/p&gt;</comment>
                            <comment id="13225753" author="dvryaboy" created="Fri, 9 Mar 2012 01:02:27 +0000"  >&lt;p&gt;Bill, I know, let&apos;s call it LoadMetadata &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Discussed this with Travis, he&apos;ll just do instanceof LoadMetadata and go from there.&lt;/p&gt;</comment>
                            <comment id="13226993" author="traviscrawford" created="Sun, 11 Mar 2012 05:14:51 +0000"  >&lt;p&gt;Patch has been updated to get the size from loader-reported statistics, if possible. If not possible, the current behavior remains.&lt;/p&gt;</comment>
                            <comment id="13227280" author="dvryaboy" created="Mon, 12 Mar 2012 00:49:50 +0000"  >&lt;p&gt;Nice work, Travis.&lt;/p&gt;

&lt;p&gt;Tests pass.&lt;/p&gt;

&lt;p&gt;I think we might as well take PigStorageWithStatistics and move it into PigStorage. Might make sense to save a transient LRU map of location-&amp;gt;stats in case getStats gets called a few times, so we don&apos;t keep hitting the NN for file sizes over and over.&lt;/p&gt;

&lt;p&gt;It looks like the current behavior is that if you have multiple POLoads, and only a subset of them implement LoadMetadata and return non-0 size, FS is used. Meaning, if I have 2 loaders, and one of them reports size and the other does not, the first loader&apos;s reported size is ignored. That&apos;s ok (better than it is now!) but not ideal. Perhaps we can move the logic of checking metadata or the FS into the inner loop of getInputSizeFromLoadMetadata?  &lt;/p&gt;

&lt;p&gt;Also, just stylistically, lets rename that method to getInputSizeFromMetadata (more readable, and refers to the concept, not an interface).&lt;/p&gt;</comment>
                            <comment id="13227962" author="traviscrawford" created="Mon, 12 Mar 2012 21:59:50 +0000"  >&lt;p&gt;PIGSTORAGEWITHSTATISTICS COMMENT:&lt;/p&gt;

&lt;p&gt;Originally I did something similar to what you suggested, but after a bit more thought kept PigStorage unchanged, and used a test-specific loader. Since we fall back to the existing &quot;get size from supported filesystems&quot; lookup, PigStorage already has this feature for most users. JobControlCompiler and PigStorage would call the same utility method to report size, so I think the code is actually more complex by updating PigStorage.&lt;/p&gt;

&lt;p&gt;The goal here is letting a loader report the size of its input for non-filesystems (hcatalog db.table names, rows from hbase/vertica/mysql/...) , or when doing something fancy with files on a filesystem (indexed files where blocks/splits are pre-filtered). If you&apos;re doing something fancy you probably have a fancy loader too.&lt;/p&gt;

&lt;p&gt;PARTIAL SIZE REPORTING COMMENT:&lt;/p&gt;

&lt;p&gt;Having size be all-or-none was intentional. It seemed very confusion for pig to base a decision on one number (and log that input size) then have the MR job read a different amount of data. I think its best to keep the current behavior and only make this optimization if its based on the actual input size.&lt;/p&gt;

&lt;p&gt;METHOD NAME COMMENT:&lt;/p&gt;

&lt;p&gt;How does &lt;tt&gt;getInputSizeFromLoader&lt;/tt&gt; sound?&lt;/p&gt;</comment>
                            <comment id="13228046" author="traviscrawford" created="Mon, 12 Mar 2012 23:24:34 +0000"  >&lt;p&gt;Updated patch renamed method, and total size is reported as the size of inputs size is available for. Rereading the existing code this is how it currently behaves.&lt;/p&gt;</comment>
                            <comment id="13228517" author="julienledem" created="Tue, 13 Mar 2012 17:01:13 +0000"  >&lt;p&gt;Hey Travis,&lt;br/&gt;
Looks good to me.&lt;/p&gt;

&lt;p&gt;Some comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;in test/org/apache/pig/test/PigStorageWithStatistics.java
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; getInputmBytes() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
...
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; inputBytes / 1024;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I guess it should be / 1024 again to return mega bytes&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Let&apos;s add getByteSize() and setByteSize(size) to org.apache.pig.ResourceStatistics (with backward compatible implementations of getmBytes)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;in src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/JobControlCompiler.java, the following line seems unnecessary as long as the file system implementation returns a size. But we can open this as a separate issue.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (UriUtil.isHDFSFileOrLocalOrS3N(location)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13228597" author="traviscrawford" created="Tue, 13 Mar 2012 19:03:01 +0000"  >&lt;p&gt;Good comments Julien, thanks.&lt;/p&gt;

&lt;p&gt;Please see the comments for why we keep mbytes in ResourceStatistics - basically its public and changing could break things.&lt;/p&gt;</comment>
                            <comment id="13228804" author="traviscrawford" created="Tue, 13 Mar 2012 23:17:33 +0000"  >&lt;p&gt;Whoops, the previous diff missed a file. I ran test-commit with this one.&lt;/p&gt;</comment>
                            <comment id="13229901" author="julienledem" created="Thu, 15 Mar 2012 05:21:10 +0000"  >&lt;p&gt;ant test-patch&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; -1 overall.  &lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 @author.  The patch does not contain any @author tags.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 tests included.  The patch appears to include 5 new or modified tests.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt;     -1 release audit.  The applied patch generated 541 release audit warnings (more than the trunk&apos;s current 534 warnings).&lt;/p&gt;

&lt;p&gt;the new warnings are unrelated to this patch.&lt;/p&gt;

&lt;p&gt;+1 on my side &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517877" name="PIG-2573_get_size_from_stats_if_possible.diff" size="19802" author="traviscrawford" created="Sun, 11 Mar 2012 05:14:49 +0000"/>
                            <attachment id="12518118" name="PIG-2573_get_size_from_stats_if_possible_2.diff" size="20495" author="traviscrawford" created="Mon, 12 Mar 2012 23:24:34 +0000"/>
                            <attachment id="12518219" name="PIG-2573_get_size_from_stats_if_possible_3.diff" size="20945" author="traviscrawford" created="Tue, 13 Mar 2012 19:03:01 +0000"/>
                            <attachment id="12518267" name="PIG-2573_get_size_from_stats_if_possible_4.diff" size="22316" author="traviscrawford" created="Tue, 13 Mar 2012 23:17:33 +0000"/>
                            <attachment id="12517609" name="PIG-2573_move_getinputbytes_to_loadfunc.diff" size="11917" author="traviscrawford" created="Thu, 8 Mar 2012 21:07:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 8 Mar 2012 03:16:59 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230776</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyaxu7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97793</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>