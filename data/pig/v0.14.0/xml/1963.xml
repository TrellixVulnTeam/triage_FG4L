<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 04:50:05 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-1963/PIG-1963.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-1963] in nested foreach, accumutive udf taking input from order-by does not get results in order</title>
                <link>https://issues.apache.org/jira/browse/PIG-1963</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;This happens only when secondary sort is not being used for the order-by. &lt;br/&gt;
For example -&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
a1 = load &apos;fruits.txt&apos; as (f1:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,f2);
a2 = load &apos;fruits.txt&apos; as (f1:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,f2);

b = cogroup a1 by f1, a2 by f1;

d = foreach b {
   sort1 = order a1 by f2;
   sort2 = order a2 by f2; -- secondary sort not getting used here, MYCONCATBAG gets results in wrong order
   generate group, MYCONCATBAG(sort1.f1), MYCONCATBAG(sort2.f2);
}

-- explain d;
dump d;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12503350">PIG-1963</key>
            <summary>in nested foreach, accumutive udf taking input from order-by does not get results in order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thejas">Thejas M Nair</assignee>
                                    <reporter username="thejas">Thejas M Nair</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Apr 2011 23:18:24 +0100</created>
                <updated>Mon, 25 Apr 2011 22:27:04 +0100</updated>
                            <resolved>Fri, 8 Apr 2011 20:30:23 +0100</resolved>
                                    <version>0.8.0</version>
                    <version>0.9.0</version>
                                    <fixVersion>0.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13015661" author="thejas" created="Mon, 4 Apr 2011 23:22:28 +0100"  >&lt;p&gt;MYCONCATBAG udf in the query in description concatenates the entries in the bag, in the order it is recieved.&lt;br/&gt;
When the query run with the property - pig.accumulative.batchsize=2 , &lt;br/&gt;
and input -&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
100     apple
200     orange
300     strawberry
300     pear
100     apple
300     pear
400     apple
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;gives output -&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(100,(100)(100),(apple)(apple))
(200,(200),(orange))
(300,(300)(300)(300),(pear)(strawberry)(pear)) -- &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should be (300,(300)(300)(300),(pear)(pear)(strawberry))
(400,(400),(apple))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13015662" author="thejas" created="Mon, 4 Apr 2011 23:24:48 +0100"  >&lt;p&gt;attaching udf used in the example.&lt;/p&gt;</comment>
                            <comment id="13015665" author="thejas" created="Mon, 4 Apr 2011 23:34:24 +0100"  >&lt;p&gt;Note that the issue is seen only when there are more than 20000 in the bag used by the nested order-by statement, or the value of pig.accumulative.batchsize property if it is set.&lt;/p&gt;

&lt;p&gt;The is happening because in accumulative mode the nested relational operator is being passed a portion of the bag. That works fine in case of operations such as filter or limit. If secondary sort is used for the ordering, there is no POSort in the plan, so it works fine.&lt;/p&gt;

&lt;p&gt;This issue might exist in case of nested distinct as well, because it is also supposed to be a blocking operation.&lt;/p&gt;

&lt;p&gt;Another query which demonstrates this issue (when property pig.accumulative.batchsize=2 is set)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
a1 = load &apos;fruits.txt&apos; as (cid:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,fruit : chararray);

b = group a1 by cid;

d = foreach b {
  sort1 = order a1 by fruit ;
  sort2 = order a1 by fruit desc;
  generate group as cid, MYCONCATBAG(sort1.fruit), MYCONCATBAG(sort2.fruit); -- The second instance of the udf does not get sorted results
}

explain d;
 dump d;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To fix this, if such blocking relational operators exist in the plan after secondary-sort optimization, accumulative mode should be disabled by the optimizer.&lt;/p&gt;</comment>
                            <comment id="13017024" author="thejas" created="Thu, 7 Apr 2011 17:22:21 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1963&quot; title=&quot;in nested foreach, accumutive udf taking input from order-by does not get results in order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1963&quot;&gt;&lt;del&gt;PIG-1963&lt;/del&gt;&lt;/a&gt;.1.patch - unit tests, test-patch with 0.8 branch. Running them for trunk.&lt;/p&gt;</comment>
                            <comment id="13017339" author="daijy" created="Fri, 8 Apr 2011 09:17:37 +0100"  >&lt;p&gt;This prevent other nested relational operator, right? From the way checkUDFInput handles PORelationToExprProject, it seems the original code intend to prevent other relational operator (except foreach) as well, but miss the case POProject following PORelationToExprProject. +1 for the patch if this is the case.&lt;/p&gt;</comment>
                            <comment id="13017500" author="thejas" created="Fri, 8 Apr 2011 17:05:14 +0100"  >&lt;blockquote&gt;&lt;p&gt;This prevent other nested relational operator, right? From the way checkUDFInput handles PORelationToExprProject, it seems the original code intend to prevent other relational operator (except foreach) as well, but miss the case POProject following PORelationToExprProject. +1 for the patch if this is the case.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, the AccumulatorOptimizer code intends to turn off accumulative mode if it sees any relational operator other than POForEach and POSortedDistinct as input to accumulative udf. The case of POProject should have been handled like PORelationToExprProject. &lt;/p&gt;</comment>
                            <comment id="13017503" author="thejas" created="Fri, 8 Apr 2011 17:11:38 +0100"  >&lt;p&gt;The AccumulatorOptimizer should allow accumulative mode to be used if the input relation is a non-blocking relation like filter or limit. I have created &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1980&quot; title=&quot;support accumulative mode when nested non-blocking relations are present as input&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1980&quot;&gt;PIG-1980&lt;/a&gt; to address that.&lt;/p&gt;</comment>
                            <comment id="13017614" author="thejas" created="Fri, 8 Apr 2011 20:22:40 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1963&quot; title=&quot;in nested foreach, accumutive udf taking input from order-by does not get results in order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1963&quot;&gt;&lt;del&gt;PIG-1963&lt;/del&gt;&lt;/a&gt;.1.1.patch - patch to remove a test case added in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1911&quot; title=&quot;Infinite loop with accumulator function in nested foreach&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1911&quot;&gt;&lt;del&gt;PIG-1911&lt;/del&gt;&lt;/a&gt;, as that query will no longer run in accumulative mode.&lt;/p&gt;</comment>
                            <comment id="13017616" author="thejas" created="Fri, 8 Apr 2011 20:30:23 +0100"  >&lt;p&gt;Patch committed to trunk and 0.8 branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12475439" name="MYCONCATBAG.java" size="2252" author="thejas" created="Mon, 4 Apr 2011 23:24:48 +0100"/>
                            <attachment id="12475834" name="PIG-1963.1.1.patch" size="1825" author="thejas" created="Fri, 8 Apr 2011 20:22:40 +0100"/>
                            <attachment id="12475720" name="PIG-1963.1.patch" size="4084" author="thejas" created="Thu, 7 Apr 2011 17:22:21 +0100"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 8 Apr 2011 08:17:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>165251</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hyaurj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97295</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>